{
    "status": "Fix Released", 
    "last_updated": "2017-06-08 21:51:33.280066+00:00", 
    "description": "I have deployed a development DevStack OS environment with XenServer7.0 and then I did the below steps:\n\n1. Create an instance via Horizon or OpenStack CLI\n2. Delete the instance manually (using XenCenter or xe command)\n3. Stop nova-compute service and start nova-compute service again\n\nThen I cannot start nova-compute service anymore with errors:\n\n2017-05-24 05:54:09.373 DEBUG nova.compute.manager [req-97c683b3-cec8-46e6-bb04-d8f17a0b0be8 None None] [instance: 9d5ee1f9-ad88-48d1-b07e-730154ae8cfd] Checking state from (pid=24627) _get_power_state /opt/stack/nova/nova/compute/manager.py:1169\n2017-05-24 05:54:09.380 DEBUG oslo_messaging._drivers.amqpdriver [req-97c683b3-cec8-46e6-bb04-d8f17a0b0be8 None None] CAST unique_id: 499446a84a51459aad4314c2301e7d08 FANOUT topic 'scheduler' from (pid=24627) _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:478\n2017-05-24 05:54:09.383 ERROR oslo_service.service [req-97c683b3-cec8-46e6-bb04-d8f17a0b0be8 None None] Error starting thread.\n2017-05-24 05:54:09.383 TRACE oslo_service.service Traceback (most recent call last):\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/local/lib/python2.7/dist-packages/oslo_service/service.py\", line 721, in run_service\n2017-05-24 05:54:09.383 TRACE oslo_service.service service.start()\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/service.py\", line 143, in start\n2017-05-24 05:54:09.383 TRACE oslo_service.service self.manager.init_host()\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/compute/manager.py\", line 1148, in init_host\n2017-05-24 05:54:09.383 TRACE oslo_service.service self._init_instance(context, instance)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/compute/manager.py\", line 945, in _init_instance\n2017-05-24 05:54:09.383 TRACE oslo_service.service self.driver.plug_vifs(instance, net_info)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 309, in plug_vifs\n2017-05-24 05:54:09.383 TRACE oslo_service.service self._vmops.plug_vifs(instance, network_info)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 1961, in plug_vifs\n2017-05-24 05:54:09.383 TRACE oslo_service.service self.vif_driver.plug(instance, vif, device=device)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/virt/xenapi/vif.py\", line 251, in plug\n2017-05-24 05:54:09.383 TRACE oslo_service.service vif_ref = self._get_vif_ref(vif, vm_ref)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/virt/xenapi/vif.py\", line 43, in _get_vif_ref\n2017-05-24 05:54:09.383 TRACE oslo_service.service vif_refs = self._session.call_xenapi(\"VM.get_VIFs\", vm_ref)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/os-xenapi/os_xenapi/client/session.py\", line 200, in call_xenapi\n2017-05-24 05:54:09.383 TRACE oslo_service.service return session.xenapi_request(method, args)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/os-xenapi/os_xenapi/client/XenAPI.py\", line 130, in xenapi_request\n2017-05-24 05:54:09.383 TRACE oslo_service.service result = _parse_result(getattr(self, methodname)(*full_params))\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 1243, in _call_\n2017-05-24 05:54:09.383 TRACE oslo_service.service return self._send(self._name, args)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 1596, in __request\n2017-05-24 05:54:09.383 TRACE oslo_service.service allow_none=self.__allow_none)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 1094, in dumps\n2017-05-24 05:54:09.383 TRACE oslo_service.service data = m.dumps(params)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 638, in dumps\n2017-05-24 05:54:09.383 TRACE oslo_service.service dump(v, write)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 660, in __dump\n2017-05-24 05:54:09.383 TRACE oslo_service.service f(self, value, write)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 664, in dump_nil\n2017-05-24 05:54:09.383 TRACE oslo_service.service raise TypeError, \"cannot marshal None unless allow_none is enabled\"\n2017-05-24 05:54:09.383 TRACE oslo_service.service TypeError: cannot marshal None unless allow_none is enabled\n2017-05-24 05:54:09.383 TRACE oslo_service.service \n2017-05-24 05:54:09.495 DEBUG oslo_concurrency.lockutils [req-774ec28a-fdb4-4742-bcbe-f97a4769652a None None] Acquired semaphore \"singleton_lock\" from (pid=24627) lock /usr/local/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py:212\n\n\nNote:\nWhen I delete the VM manually, OpenStack didn't notice it which is fine, but this should not block nova-compute service, nova-compute service should be able to run and provide services although there are VMs which cannot initialized during its startup process", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1693147", 
    "owner": "https://api.launchpad.net/1.0/~bob-ball", 
    "id": 1693147, 
    "index": 6858, 
    "created": "2017-05-24 09:18:41.600232+00:00", 
    "title": "XenAPI: nova-compute cannot run when manually delete a VM", 
    "comments": [
        {
            "content": "I have deployed a development DevStack OS environment with XenServer7.0 and then I did the below steps:\n\n1. Create an instance via Horizon or OpenStack CLI\n2. Delete the instance manually (using XenCenter or xe command)\n3. Stop nova-compute service and start nova-compute service again\n\nThen I cannot start nova-compute service anymore with errors:\n\n2017-05-24 05:54:09.373 DEBUG nova.compute.manager [req-97c683b3-cec8-46e6-bb04-d8f17a0b0be8 None None] [instance: 9d5ee1f9-ad88-48d1-b07e-730154ae8cfd] Checking state from (pid=24627) _get_power_state /opt/stack/nova/nova/compute/manager.py:1169\n2017-05-24 05:54:09.380 DEBUG oslo_messaging._drivers.amqpdriver [req-97c683b3-cec8-46e6-bb04-d8f17a0b0be8 None None] CAST unique_id: 499446a84a51459aad4314c2301e7d08 FANOUT topic 'scheduler' from (pid=24627) _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:478\n2017-05-24 05:54:09.383 ERROR oslo_service.service [req-97c683b3-cec8-46e6-bb04-d8f17a0b0be8 None None] Error starting thread.\n2017-05-24 05:54:09.383 TRACE oslo_service.service Traceback (most recent call last):\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/local/lib/python2.7/dist-packages/oslo_service/service.py\", line 721, in run_service\n2017-05-24 05:54:09.383 TRACE oslo_service.service service.start()\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/service.py\", line 143, in start\n2017-05-24 05:54:09.383 TRACE oslo_service.service self.manager.init_host()\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/compute/manager.py\", line 1148, in init_host\n2017-05-24 05:54:09.383 TRACE oslo_service.service self._init_instance(context, instance)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/compute/manager.py\", line 945, in _init_instance\n2017-05-24 05:54:09.383 TRACE oslo_service.service self.driver.plug_vifs(instance, net_info)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 309, in plug_vifs\n2017-05-24 05:54:09.383 TRACE oslo_service.service self._vmops.plug_vifs(instance, network_info)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 1961, in plug_vifs\n2017-05-24 05:54:09.383 TRACE oslo_service.service self.vif_driver.plug(instance, vif, device=device)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/virt/xenapi/vif.py\", line 251, in plug\n2017-05-24 05:54:09.383 TRACE oslo_service.service vif_ref = self._get_vif_ref(vif, vm_ref)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/nova/nova/virt/xenapi/vif.py\", line 43, in _get_vif_ref\n2017-05-24 05:54:09.383 TRACE oslo_service.service vif_refs = self._session.call_xenapi(\"VM.get_VIFs\", vm_ref)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/os-xenapi/os_xenapi/client/session.py\", line 200, in call_xenapi\n2017-05-24 05:54:09.383 TRACE oslo_service.service return session.xenapi_request(method, args)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/opt/stack/os-xenapi/os_xenapi/client/XenAPI.py\", line 130, in xenapi_request\n2017-05-24 05:54:09.383 TRACE oslo_service.service result = _parse_result(getattr(self, methodname)(*full_params))\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 1243, in _call_\n2017-05-24 05:54:09.383 TRACE oslo_service.service return self._send(self._name, args)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 1596, in __request\n2017-05-24 05:54:09.383 TRACE oslo_service.service allow_none=self.__allow_none)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 1094, in dumps\n2017-05-24 05:54:09.383 TRACE oslo_service.service data = m.dumps(params)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 638, in dumps\n2017-05-24 05:54:09.383 TRACE oslo_service.service dump(v, write)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 660, in __dump\n2017-05-24 05:54:09.383 TRACE oslo_service.service f(self, value, write)\n2017-05-24 05:54:09.383 TRACE oslo_service.service File \"/usr/lib/python2.7/xmlrpclib.py\", line 664, in dump_nil\n2017-05-24 05:54:09.383 TRACE oslo_service.service raise TypeError, \"cannot marshal None unless allow_none is enabled\"\n2017-05-24 05:54:09.383 TRACE oslo_service.service TypeError: cannot marshal None unless allow_none is enabled\n2017-05-24 05:54:09.383 TRACE oslo_service.service \n2017-05-24 05:54:09.495 DEBUG oslo_concurrency.lockutils [req-774ec28a-fdb4-4742-bcbe-f97a4769652a None None] Acquired semaphore \"singleton_lock\" from (pid=24627) lock /usr/local/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py:212\n\n\nNote:\nWhen I delete the VM manually, OpenStack didn't notice it which is fine, but this should not block nova-compute service, nova-compute service should be able to run and provide services although there are VMs which cannot initialized during its startup process", 
            "date_created": "2017-05-24 09:18:41.600232+00:00", 
            "author": "https://api.launchpad.net/1.0/~huan-xie"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/467926", 
            "date_created": "2017-05-25 08:30:23.095845+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/467926\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=92d8103a196c25157295789100117946dcf67304\nSubmitter: Jenkins\nBranch:    master\n\ncommit 92d8103a196c25157295789100117946dcf67304\nAuthor: Huan Xie <email address hidden>\nDate:   Thu May 25 01:21:31 2017 -0700\n\n    XenAPI: nova-compute cannot restart after manually delete VM\n    \n    When a VM is deleted accidentally (e.g. hardware problem or manually\n    through the hypervisor rather than Nova), there is a mis-match of\n    information where the VM is still in nova DB but not the hypervisor.\n    If we start nova-compute service in this setup, it will fail due to an\n    untrapped exception when plugging VIFs.\n    \n    Return an expected exception when Nova cannot find VM via xapi.\n    \n    Closes-bug: #1693147\n    \n    Change-Id: I937f5c202c9a4892e8aa56f74fad125791809f8c\n", 
            "date_created": "2017-05-31 12:14:08.361275+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b2 development milestone.", 
            "date_created": "2017-06-08 21:51:32.856510+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}