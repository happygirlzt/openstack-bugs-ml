{
    "status": "Fix Released", 
    "last_updated": "2017-04-12 17:13:14.694570+00:00", 
    "description": "I performed the following steps in a functional test within Nova:\n\n1. Create a server and wait for it to be ACTIVE.\n2. Shelve the server (it's automatically offloaded from the compute host).\n3. Attach a volume to the shelved offloaded server (using microversion 2.20 or later).\n4. Wait for the volume to show up as attached to the server and be in 'in-use' state.\n5. Delete the server. This triggers a \"local delete\" in the API code since instance.host is None.\n\nExpected result:\n\nThe volume is detached from the server and in 'available' status again.\n\nActual result:\n\nThe volume status is still 'in-use' even though the server is deleted.\n\nThis is a regression in Ocata with the cells v2 code that was added in the local delete flow in the API:\n\nhttps://github.com/openstack/nova/blob/2a41eb8786fa1654bbecb50c2a15fdd96fdc4767/nova/compute/api.py#L1887\n\nThe problem is with cells v2 when the instance is mapped to a cell, and we do a local delete, we're destroying the instance in the cell but we aren't cleaning up the volumes like we would normally do in the old local delete flow where the instance.host is None but not mapped to a cell:\n\nhttps://github.com/openstack/nova/blob/2a41eb8786fa1654bbecb50c2a15fdd96fdc4767/nova/compute/api.py#L2207", 
    "tags": [
        "api", 
        "cells", 
        "in-stable-ocata", 
        "ocata-backport-potential", 
        "volumes"
    ], 
    "importance": "High", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1675570", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1675570, 
    "index": 2054, 
    "created": "2017-03-23 21:38:26.380224+00:00", 
    "title": "Volumes are not detached when deleting shelved offloaded servers", 
    "comments": [
        {
            "content": "I performed the following steps in a functional test within Nova:\n\n1. Create a server and wait for it to be ACTIVE.\n2. Shelve the server (it's automatically offloaded from the compute host).\n3. Attach a volume to the shelved offloaded server (using microversion 2.20 or later).\n4. Wait for the volume to show up as attached to the server and be in 'in-use' state.\n5. Delete the server. This triggers a \"local delete\" in the API code since instance.host is None.\n\nExpected result:\n\nThe volume is detached from the server and in 'available' status again.\n\nActual result:\n\nThe volume status is still 'in-use' even though the server is deleted.\n\nThis is a regression in Ocata with the cells v2 code that was added in the local delete flow in the API:\n\nhttps://github.com/openstack/nova/blob/2a41eb8786fa1654bbecb50c2a15fdd96fdc4767/nova/compute/api.py#L1887\n\nThe problem is with cells v2 when the instance is mapped to a cell, and we do a local delete, we're destroying the instance in the cell but we aren't cleaning up the volumes like we would normally do in the old local delete flow where the instance.host is None but not mapped to a cell:\n\nhttps://github.com/openstack/nova/blob/2a41eb8786fa1654bbecb50c2a15fdd96fdc4767/nova/compute/api.py#L2207", 
            "date_created": "2017-03-23 21:38:26.380224+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/449334", 
            "date_created": "2017-03-23 21:42:25.269754+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This was reported to me by Kevin Zheng earlier today.", 
            "date_created": "2017-03-23 21:55:15.087230+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "@Matt, I tested, and turns out the port also didn't got cleaned.", 
            "date_created": "2017-03-25 08:38:41.748596+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengzhenyu"
        }, 
        {
            "content": "root@SZX1000280461:/var/log/nova# nova list\n/usr/local/lib/python2.7/dist-packages/novaclient/client.py:278: UserWarning: The 'tenant_id' argument is deprecated in Ocata and its use may result in errors in future releases. As 'project_id' is provided, the 'tenant_id' argument will be ignored.\n  warnings.warn(msg)\n+--------------------------------------+------+--------+------------+-------------+-----------------+\n| ID                                   | Name | Status | Task State | Power State | Networks        |\n+--------------------------------------+------+--------+------------+-------------+-----------------+\n| c5cf093c-f223-44c3-8f41-aefe4a7012c2 | test | ERROR  | unshelving | Shutdown    | Kevin=10.0.0.75 |\n+--------------------------------------+------+--------+------------+-------------+-----------------+\nroot@SZX1000280461:/var/log/nova# neutron port-list\nneutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.\n+--------------------------------------+------+----------------------------------+-------------------+------------------------------------------------------------------------------------------------------------+\n| id                                   | name | tenant_id                        | mac_address       | fixed_ips                                                                                                  |\n+--------------------------------------+------+----------------------------------+-------------------+------------------------------------------------------------------------------------------------------------+\n| 41da3d46-26a9-4422-afad-88fef2e211dd |      | 4f705543436648abbacf5719d3397c0f | fa:16:3e:4d:8a:95 | {\"subnet_id\": \"30e611e7-3815-4e18-a26e-7c3532458c88\", \"ip_address\": \"10.0.0.76\"}                           |\n| 486416f2-189d-4904-a90f-28739e3338bf |      |                                  | fa:16:3e:a5:18:f3 | {\"subnet_id\": \"7ae788b2-7545-40e0-b478-4a3725a8b1ab\", \"ip_address\": \"172.24.4.10\"}                         |\n|                                      |      |                                  |                   | {\"subnet_id\": \"5f32aae0-c7c0-494f-9e84-314a266cb914\", \"ip_address\": \"2001:db8::b\"}                         |\n| 4b5d8268-9ef9-49f3-b16d-462c5af5502d |      | 4f705543436648abbacf5719d3397c0f | fa:16:3e:b2:f8:19 | {\"subnet_id\": \"30e611e7-3815-4e18-a26e-7c3532458c88\", \"ip_address\": \"10.0.0.66\"}                           |\n| 4cf9764d-84e8-43f9-8f49-d25b1bed67b5 |      | 2f8692b9912d48f5a56142359ab07aa6 | fa:16:3e:e1:49:3c | {\"subnet_id\": \"fba02ca5-3f48-4994-9289-25568c9d5256\", \"ip_address\": \"10.0.0.2\"}                            |\n|                                      |      |                                  |                   | {\"subnet_id\": \"1306f4cd-b95f-4e98-9dab-6df198e877cd\", \"ip_address\": \"fd31:6e59:2d0:0:f816:3eff:fee1:493c\"} |\n| 664c37f1-a118-4f15-bbd3-893e1ae384c1 |      | 4f705543436648abbacf5719d3397c0f | fa:16:3e:15:18:b0 | {\"subnet_id\": \"30e611e7-3815-4e18-a26e-7c3532458c88\", \"ip_address\": \"10.0.0.75\"}  <= THIS ONE                         |\n| 6b150472-c3ce-485b-8f9d-757f1ae7f416 |      |                                  | fa:16:3e:61:62:1c | {\"subnet_id\": \"7ae788b2-7545-40e0-b478-4a3725a8b1ab\", \"ip_address\": \"172.24.4.5\"}                          |\n|                                      |      |                                  |                   | {\"subnet_id\": \"5f32aae0-c7c0-494f-9e84-314a266cb914\", \"ip_address\": \"2001:db8::6\"}                         |\n| 98405b78-0a95-4f08-ab9e-3e05ab3a3d63 |      | 4f705543436648abbacf5719d3397c0f | fa:16:3e:a3:9c:d8 | {\"subnet_id\": \"30e611e7-3815-4e18-a26e-7c3532458c88\", \"ip_address\": \"10.0.0.65\"}                           |\n| b6671723-8b92-4197-945b-83316d9d790d |      |                                  | fa:16:3e:80:93:6e | {\"subnet_id\": \"7ae788b2-7545-40e0-b478-4a3725a8b1ab\", \"ip_address\": \"172.24.4.4\"}                          |\n|                                      |      |                                  |                   | {\"subnet_id\": \"5f32aae0-c7c0-494f-9e84-314a266cb914\", \"ip_address\": \"2001:db8::d\"}                         |\n| d3cdc560-4466-4638-9bcd-394066d3c52e |      | 2f8692b9912d48f5a56142359ab07aa6 | fa:16:3e:cf:a8:1d | {\"subnet_id\": \"fba02ca5-3f48-4994-9289-25568c9d5256\", \"ip_address\": \"10.0.0.1\"}                            |\n| fb3d61dd-8330-41c8-98e5-1817d7a3bb34 |      | 2f8692b9912d48f5a56142359ab07aa6 | fa:16:3e:75:34:a2 | {\"subnet_id\": \"1306f4cd-b95f-4e98-9dab-6df198e877cd\", \"ip_address\": \"fd31:6e59:2d0::1\"}                    |\n+--------------------------------------+------+----------------------------------+-------------------+------------------------------------------------------------------------------------------------------------+\nroot@SZX1000280461:/var/log/nova# nova delete test\n/usr/local/lib/python2.7/dist-packages/novaclient/client.py:278: UserWarning: The 'tenant_id' argument is deprecated in Ocata and its use may result in errors in future releases. As 'project_id' is provided, the 'tenant_id' argument will be ignored.\n  warnings.warn(msg)\nRequest to delete server test has been accepted.\nroot@SZX1000280461:/var/log/nova# neutron port-list\nneutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.\n+--------------------------------------+------+----------------------------------+-------------------+------------------------------------------------------------------------------------------------------------+\n| id                                   | name | tenant_id                        | mac_address       | fixed_ips                                                                                                  |\n+--------------------------------------+------+----------------------------------+-------------------+------------------------------------------------------------------------------------------------------------+\n| 41da3d46-26a9-4422-afad-88fef2e211dd |      | 4f705543436648abbacf5719d3397c0f | fa:16:3e:4d:8a:95 | {\"subnet_id\": \"30e611e7-3815-4e18-a26e-7c3532458c88\", \"ip_address\": \"10.0.0.76\"}                           |\n| 486416f2-189d-4904-a90f-28739e3338bf |      |                                  | fa:16:3e:a5:18:f3 | {\"subnet_id\": \"7ae788b2-7545-40e0-b478-4a3725a8b1ab\", \"ip_address\": \"172.24.4.10\"}                         |\n|                                      |      |                                  |                   | {\"subnet_id\": \"5f32aae0-c7c0-494f-9e84-314a266cb914\", \"ip_address\": \"2001:db8::b\"}                         |\n| 4b5d8268-9ef9-49f3-b16d-462c5af5502d |      | 4f705543436648abbacf5719d3397c0f | fa:16:3e:b2:f8:19 | {\"subnet_id\": \"30e611e7-3815-4e18-a26e-7c3532458c88\", \"ip_address\": \"10.0.0.66\"}                           |\n| 4cf9764d-84e8-43f9-8f49-d25b1bed67b5 |      | 2f8692b9912d48f5a56142359ab07aa6 | fa:16:3e:e1:49:3c | {\"subnet_id\": \"fba02ca5-3f48-4994-9289-25568c9d5256\", \"ip_address\": \"10.0.0.2\"}                            |\n|                                      |      |                                  |                   | {\"subnet_id\": \"1306f4cd-b95f-4e98-9dab-6df198e877cd\", \"ip_address\": \"fd31:6e59:2d0:0:f816:3eff:fee1:493c\"} |\n| 664c37f1-a118-4f15-bbd3-893e1ae384c1 |      | 4f705543436648abbacf5719d3397c0f | fa:16:3e:15:18:b0 | {\"subnet_id\": \"30e611e7-3815-4e18-a26e-7c3532458c88\", \"ip_address\": \"10.0.0.75\"}  <= STILL HERE                         |\n| 6b150472-c3ce-485b-8f9d-757f1ae7f416 |      |                                  | fa:16:3e:61:62:1c | {\"subnet_id\": \"7ae788b2-7545-40e0-b478-4a3725a8b1ab\", \"ip_address\": \"172.24.4.5\"}                          |\n|                                      |      |                                  |                   | {\"subnet_id\": \"5f32aae0-c7c0-494f-9e84-314a266cb914\", \"ip_address\": \"2001:db8::6\"}                         |\n| 98405b78-0a95-4f08-ab9e-3e05ab3a3d63 |      | 4f705543436648abbacf5719d3397c0f | fa:16:3e:a3:9c:d8 | {\"subnet_id\": \"30e611e7-3815-4e18-a26e-7c3532458c88\", \"ip_address\": \"10.0.0.65\"}                           |\n| b6671723-8b92-4197-945b-83316d9d790d |      |                                  | fa:16:3e:80:93:6e | {\"subnet_id\": \"7ae788b2-7545-40e0-b478-4a3725a8b1ab\", \"ip_address\": \"172.24.4.4\"}                          |\n|                                      |      |                                  |                   | {\"subnet_id\": \"5f32aae0-c7c0-494f-9e84-314a266cb914\", \"ip_address\": \"2001:db8::d\"}                         |\n| d3cdc560-4466-4638-9bcd-394066d3c52e |      | 2f8692b9912d48f5a56142359ab07aa6 | fa:16:3e:cf:a8:1d | {\"subnet_id\": \"fba02ca5-3f48-4994-9289-25568c9d5256\", \"ip_address\": \"10.0.0.1\"}                            |\n| fb3d61dd-8330-41c8-98e5-1817d7a3bb34 |      | 2f8692b9912d48f5a56142359ab07aa6 | fa:16:3e:75:34:a2 | {\"subnet_id\": \"1306f4cd-b95f-4e98-9dab-6df198e877cd\", \"ip_address\": \"fd31:6e59:2d0::1\"}                    |\n+--------------------------------------+------+----------------------------------+-------------------+------------------------------------------------------------------------------------------------------------+\n", 
            "date_created": "2017-03-25 08:44:00.682045+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengzhenyu"
        }, 
        {
            "content": "root@SZX1000280461:/var/log/nova# neutron port-show 664c37f1-a118-4f15-bbd3-893e1ae384c1\nneutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.\n+-----------------------+----------------------------------------------------------------------------------+\n| Field                 | Value                                                                            |\n+-----------------------+----------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                             |\n| allowed_address_pairs |                                                                                  |\n| binding:host_id       | SZX1000280461                                                                    |\n| binding:profile       | {}                                                                               |\n| binding:vif_details   | {\"port_filter\": true, \"ovs_hybrid_plug\": true}                                   |\n| binding:vif_type      | ovs                                                                              |\n| binding:vnic_type     | normal                                                                           |\n| created_at            | 2017-03-25T07:53:37Z                                                             |\n| description           |                                                                                  |\n| device_id             | c5cf093c-f223-44c3-8f41-aefe4a7012c2                                             |\n| device_owner          | compute:nova                                                                     |\n| extra_dhcp_opts       |                                                                                  |\n| fixed_ips             | {\"subnet_id\": \"30e611e7-3815-4e18-a26e-7c3532458c88\", \"ip_address\": \"10.0.0.75\"} |\n| id                    | 664c37f1-a118-4f15-bbd3-893e1ae384c1                                             |\n| mac_address           | fa:16:3e:15:18:b0                                                                |\n| name                  |                                                                                  |\n| network_id            | 0b0abf9b-d1ed-40f8-86b9-2143f950bee4                                             |\n| port_security_enabled | True                                                                             |\n| project_id            | 4f705543436648abbacf5719d3397c0f                                                 |\n| revision_number       | 10                                                                               |\n| security_groups       | 28d3e561-7cf6-4703-ac83-e364cdd4d684                                             |\n| status                | DOWN                                                                             |\n| tags                  |                                                                                  |\n| tenant_id             | 4f705543436648abbacf5719d3397c0f                                                 |\n| updated_at            | 2017-03-25T08:03:24Z                                                             |\n+-----------------------+----------------------------------------------------------------------------------+\n", 
            "date_created": "2017-03-25 08:45:20.298822+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengzhenyu"
        }, 
        {
            "content": "Yeah that's because we're not calling nova.compute.api.API._local_delete which deallocates networking:\n\nhttps://github.com/openstack/nova/blob/a3df985a6e966069b366c7fd170832422ccda33e/nova/compute/api.py#L2201\n\nAnd also cleans up the attached volumes:\n\nhttps://github.com/openstack/nova/blob/a3df985a6e966069b366c7fd170832422ccda33e/nova/compute/api.py#L2207", 
            "date_created": "2017-03-25 14:13:46.418830+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Just for the order of making changes, I'm going to fix bug 1678326 before this one since the changes are in the same spot in the code.", 
            "date_created": "2017-04-01 01:43:50.059922+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/449334\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3ae12fdc6f428fc500f5c234f03a8ffc8286e7ba\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3ae12fdc6f428fc500f5c234f03a8ffc8286e7ba\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu Mar 23 15:49:27 2017 -0400\n\n    Regression test for local delete with an attached volume\n    \n    Once an instance is in a cell and we do a local delete from\n    the API, we aren't actually detaching volumes and destroying\n    BDMs.\n    \n    Related-Bug: #1675570\n    \n    Change-Id: Ie3e2dfd4b0f1bb3dff4080f460bf8bb40d69f4f4\n", 
            "date_created": "2017-04-06 17:43:59.685793+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/454413", 
            "date_created": "2017-04-07 01:38:51.031846+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/454413\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=2b66c6780a9bb12afcbe59b2502e01258498032e\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit 2b66c6780a9bb12afcbe59b2502e01258498032e\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu Mar 23 15:49:27 2017 -0400\n\n    Regression test for local delete with an attached volume\n    \n    Once an instance is in a cell and we do a local delete from\n    the API, we aren't actually detaching volumes and destroying\n    BDMs.\n    \n    Related-Bug: #1675570\n    \n    Change-Id: Ie3e2dfd4b0f1bb3dff4080f460bf8bb40d69f4f4\n    (cherry picked from commit 3ae12fdc6f428fc500f5c234f03a8ffc8286e7ba)\n", 
            "date_created": "2017-04-10 13:31:09.150306+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I apparently mixed up the commit message and didn't put the correct bug in there, but this is fixed with this change:\n\nhttps://review.openstack.org/#/c/453859/\n\nand that's been merged in stable/ocata as well.", 
            "date_created": "2017-04-12 17:13:14.218379+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }
    ]
}