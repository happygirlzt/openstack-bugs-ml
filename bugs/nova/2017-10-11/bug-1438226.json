{
    "status": "Fix Released", 
    "last_updated": "2015-06-05 00:12:55.249716+00:00", 
    "description": "CPU pinning support was implemented as part of this blueprint:\n\n    http://specs.openstack.org/openstack/nova-specs/specs/juno/approved/virt-driver-cpu-pinning.html\n\nHowever, CPU pinning support is broken in some libvirt versions (summarized below), resulting in exceptions when attempting to schedule instances with the 'hw:cpu_policy' flavor key.\n\nWe should add a libvirt version test against known broken versions and use that to determine whether or not to support the flavor keys.\n\nThis is somewhat related to #1422775 (\"nova libvirt driver assumes qemu support for NUMA pinning\").\n\n---\n\n# Testing Configuration\n\nTesting was conducted in a container which provided a single-node, Fedora 21-based (3.17.8-300.fc21.x86_64) OpenStack instance (built with devstack). The yum-provided libvirt and its dependencies were removed and libvirt and libvirt-python were built and installed from source.\n\n# Results\n\nThe results are as follows:\n\n    versions  status\n    --------  ------\n    1.2.9     ok\n    1.2.9.1   ok\n    1.2.9.2   fail\n    1.2.10    fail\n    1.2.11    ok\n    1.2.12    ok\n\nv1.2.9.2 is broken by this (backported) patch:\n\n    https://www.redhat.com/archives/libvir-list/2014-November/msg00275.html\n\nThis can be seen as commit\n\n    e226772 (qemu: fix domain startup failing with 'strict' mode in numatune)\n\nv1.2.10 inherits is broken at checkout but can be fixed by applying these three patches (yes, one of these broke v1.2.9.2 - the irony is not lost on me):\n\n    [0/3] https://www.redhat.com/archives/libvir-list/2014-November/msg00274.html\n     - [1/3] https://www.redhat.com/archives/libvir-list/2014-November/msg00273.html\n     - [2/3] https://www.redhat.com/archives/libvir-list/2014-November/msg00276.html\n     - [3/3] https://www.redhat.com/archives/libvir-list/2014-November/msg00275.html\n\n# Error logs\n\nv1.2.9.2 produces the following exception:\n\n    Traceback (most recent call last):\n      File \"/opt/stack/nova/nova/compute/manager.py\", line 2301, in _build_resources\n        yield resources\n      File \"/opt/stack/nova/nova/compute/manager.py\", line 2171, in _build_and_run_instance\n        flavor=flavor)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2357, in spawn\n        block_device_info=block_device_info)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4376, in _create_domain_and_network\n        power_on=power_on)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4307, in _create_domain\n        LOG.error(err)\n      File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 82, in __exit__\n        six.reraise(self.type_, self.value, self.tb)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4297, in _create_domain\n        domain.createWithFlags(launch_flags)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n        result = proxy_call(self._autowrap, f, *args, **kwargs)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n        rv = execute(f, *args, **kwargs)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n        six.reraise(c, e, tb)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n        rv = meth(*args, **kwargs)\n      File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1029, in createWithFlags\n        if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\n    libvirtError: Failed to create controller cpu for group: No such file or directory\n\nv1.2.10 produces the following exception:\n\n    Traceback (most recent call last):\n      File \"/opt/stack/nova/nova/compute/manager.py\", line 2342, in _build_resources\n        yield resources\n      File \"/opt/stack/nova/nova/compute/manager.py\", line 2215, in _build_and_run_instance\n        block_device_info=block_device_info)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2356, in spawn\n        block_device_info=block_device_info)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4375, in _create_domain_and_network\n        power_on=power_on)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4306, in _create_domain\n        LOG.error(err)\n      File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n        six.reraise(self.type_, self.value, self.tb)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4296, in _create_domain\n        domain.createWithFlags(launch_flags)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n        result = proxy_call(self._autowrap, f, *args, **kwargs)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n        rv = execute(f, *args, **kwargs)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n        six.reraise(c, e, tb)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n        rv = meth(*args, **kwargs)\n      File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1037, in createWithFlags\n        if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\n    libvirtError: Unable to write to '/sys/fs/cgroup/cpuset/system.slice/docker.service/machine.slice/machine-qemu\\x2dinstance\\x2d0000000a.scope/cpuset.mems': Device or resource busy", 
    "tags": [
        "libvirt"
    ], 
    "importance": "High", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1438226", 
    "owner": "https://api.launchpad.net/1.0/~stephenfinucane", 
    "id": 1438226, 
    "index": 1706, 
    "created": "2015-03-30 14:22:57.933005+00:00", 
    "title": "nova libvirt driver assumes libvirt support for CPU pinning", 
    "comments": [
        {
            "content": "CPU pinning support was implemented as part of this blueprint:\n\n    http://specs.openstack.org/openstack/nova-specs/specs/juno/approved/virt-driver-cpu-pinning.html\n\nHowever, CPU pinning support is broken in some libvirt versions (summarized below), resulting in exceptions when attempting to schedule instances with the 'hw:cpu_policy' flavor key.\n\nWe should add a libvirt version test against known broken versions and use that to determine whether or not to support the flavor keys.\n\nThis is somewhat related to #1422775 (\"nova libvirt driver assumes qemu support for NUMA pinning\").\n\n---\n\n# Testing Configuration\n\nTesting was conducted in a container which provided a single-node, Fedora 21-based (3.17.8-300.fc21.x86_64) OpenStack instance (built with devstack). The yum-provided libvirt and its dependencies were removed and libvirt and libvirt-python were built and installed from source.\n\n# Results\n\nThe results are as follows:\n\n    versions  status\n    --------  ------\n    1.2.9     ok\n    1.2.9.1   ok\n    1.2.9.2   fail\n    1.2.10    fail\n    1.2.11    ok\n    1.2.12    ok\n\nv1.2.9.2 is broken by this (backported) patch:\n\n    https://www.redhat.com/archives/libvir-list/2014-November/msg00275.html\n\nThis can be seen as commit\n\n    e226772 (qemu: fix domain startup failing with 'strict' mode in numatune)\n\nv1.2.10 inherits is broken at checkout but can be fixed by applying these three patches (yes, one of these broke v1.2.9.2 - the irony is not lost on me):\n\n    [0/3] https://www.redhat.com/archives/libvir-list/2014-November/msg00274.html\n     - [1/3] https://www.redhat.com/archives/libvir-list/2014-November/msg00273.html\n     - [2/3] https://www.redhat.com/archives/libvir-list/2014-November/msg00276.html\n     - [3/3] https://www.redhat.com/archives/libvir-list/2014-November/msg00275.html\n\n# Error logs\n\nv1.2.9.2 produces the following exception:\n\n    Traceback (most recent call last):\n      File \"/opt/stack/nova/nova/compute/manager.py\", line 2301, in _build_resources\n        yield resources\n      File \"/opt/stack/nova/nova/compute/manager.py\", line 2171, in _build_and_run_instance\n        flavor=flavor)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2357, in spawn\n        block_device_info=block_device_info)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4376, in _create_domain_and_network\n        power_on=power_on)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4307, in _create_domain\n        LOG.error(err)\n      File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 82, in __exit__\n        six.reraise(self.type_, self.value, self.tb)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4297, in _create_domain\n        domain.createWithFlags(launch_flags)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n        result = proxy_call(self._autowrap, f, *args, **kwargs)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n        rv = execute(f, *args, **kwargs)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n        six.reraise(c, e, tb)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n        rv = meth(*args, **kwargs)\n      File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1029, in createWithFlags\n        if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\n    libvirtError: Failed to create controller cpu for group: No such file or directory\n\nv1.2.10 produces the following exception:\n\n    Traceback (most recent call last):\n      File \"/opt/stack/nova/nova/compute/manager.py\", line 2342, in _build_resources\n        yield resources\n      File \"/opt/stack/nova/nova/compute/manager.py\", line 2215, in _build_and_run_instance\n        block_device_info=block_device_info)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2356, in spawn\n        block_device_info=block_device_info)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4375, in _create_domain_and_network\n        power_on=power_on)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4306, in _create_domain\n        LOG.error(err)\n      File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n        six.reraise(self.type_, self.value, self.tb)\n      File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4296, in _create_domain\n        domain.createWithFlags(launch_flags)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n        result = proxy_call(self._autowrap, f, *args, **kwargs)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n        rv = execute(f, *args, **kwargs)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n        six.reraise(c, e, tb)\n      File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n        rv = meth(*args, **kwargs)\n      File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1037, in createWithFlags\n        if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\n    libvirtError: Unable to write to '/sys/fs/cgroup/cpuset/system.slice/docker.service/machine.slice/machine-qemu\\x2dinstance\\x2d0000000a.scope/cpuset.mems': Device or resource busy", 
            "date_created": "2015-03-30 14:22:57.933005+00:00", 
            "author": "https://api.launchpad.net/1.0/~stephenfinucane"
        }, 
        {
            "content": "Because this should *hopefully* be a small conditional fix, I think it should end up on the RC list.", 
            "date_created": "2015-03-31 12:48:30.270177+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Seems related to this patch: https://review.openstack.org/#/c/159106/", 
            "date_created": "2015-04-02 13:38:45.399375+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "Not marking as duplicate because this bug actually raises this problem wrt CPU pinning which is not directly mentioned by other bugs (but is addressed by the patch https://review.openstack.org/#/c/159106/), instead I will make sure the patch references this bug as well", 
            "date_created": "2015-04-02 14:26:12.164438+00:00", 
            "author": "https://api.launchpad.net/1.0/~ndipanov"
        }, 
        {
            "content": "Actually looking into this further - it seems that the proposed patch does not cover this. This bug refers to specific versions of libvirt that have been found to be broken.", 
            "date_created": "2015-04-02 14:42:30.756908+00:00", 
            "author": "https://api.launchpad.net/1.0/~ndipanov"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/170190", 
            "date_created": "2015-04-02 16:00:15.773219+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Apologies @radoslaw-smigielski for not assigning myself sooner.", 
            "date_created": "2015-04-02 16:14:42.120733+00:00", 
            "author": "https://api.launchpad.net/1.0/~stephenfinucane"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/170190\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c380987aa8844a46b2d50e55350e89e0791d76b6\nSubmitter: Jenkins\nBranch:    master\n\ncommit c380987aa8844a46b2d50e55350e89e0791d76b6\nAuthor: Stephen Finucane <email address hidden>\nDate:   Tue Mar 31 11:03:48 2015 +0100\n\n    libvirt: Add version check when pinning guest CPUs\n    \n    Ensure versions of libvirt with broken CPU pinning support are not used\n    for said feature. This requires the addition of a new Exception,\n    specific version check functionality and unit tests for same.\n    \n    Change-Id: I03b462c4985517ff8a4d94f0e1acae4fabdc5d39\n    Closes-Bug: #1438226\n", 
            "date_created": "2015-04-09 02:40:56.796830+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/178188\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7ca56106def7950aceecacf40b2ae8de7c846cb2\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7ca56106def7950aceecacf40b2ae8de7c846cb2\nAuthor: Stephen Finucane <email address hidden>\nDate:   Thu Apr 23 14:01:10 2015 +0100\n\n    libvirt: Disable NUMA for broken libvirt\n    \n    Ensure versions of libvirt with broken NUMA tuning support are not used\n    for said feature.\n    \n    Change-Id: I6de388f1ca98c1ae16f2968f59881e3b0dba5f8d\n    Closes-Bug: #1449028\n    Related-Bug: #1438226\n", 
            "date_created": "2015-06-05 00:12:54.336082+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}