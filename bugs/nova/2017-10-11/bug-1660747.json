{
    "status": "Fix Released", 
    "last_updated": "2017-02-03 19:08:20.042895+00:00", 
    "description": "Seen here:\n\nhttp://logs.openstack.org/59/424759/12/gate/gate-tempest-dsvm-cells-ubuntu-xenial/d7b1311/console.html#_2017-01-31_17_48_34_663273\n\n2017-01-31 17:48:34.663337 | Captured traceback:\n2017-01-31 17:48:34.663348 | ~~~~~~~~~~~~~~~~~~~\n2017-01-31 17:48:34.663363 |     Traceback (most recent call last):\n2017-01-31 17:48:34.663393 |       File \"tempest/api/compute/admin/test_servers.py\", line 59, in test_list_servers_filter_by_error_status\n2017-01-31 17:48:34.663414 |         self.assertIn(self.s1_id, map(lambda x: x['id'], servers))\n2017-01-31 17:48:34.663448 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 417, in assertIn\n2017-01-31 17:48:34.663468 |         self.assertThat(haystack, Contains(needle), message)\n2017-01-31 17:48:34.663502 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 498, in assertThat\n2017-01-31 17:48:34.663515 |         raise mismatch_error\n2017-01-31 17:48:34.663542 |     testtools.matchers._impl.MismatchError: u'108b4797-74fd-4a00-912a-b7fe0e142888' not in []\n\nThis test resets the state on a server to ERROR:\n\n2017-01-31 17:48:34.663649 |     2017-01-31 17:28:39,375 504 INFO     [tempest.lib.common.rest_client] Request (ServersAdminTestJSON:test_list_servers_filter_by_error_status): 202 POST http://10.23.154.32:8774/v2.1/servers/108b4797-74fd-4a00-912a-b7fe0e142888/action 0.142s\n2017-01-31 17:48:34.663695 |     2017-01-31 17:28:39,376 504 DEBUG    [tempest.lib.common.rest_client] Request - Headers: {'X-Auth-Token': '<omitted>', 'Accept': 'application/json', 'Content-Type': 'application/json'}\n2017-01-31 17:48:34.663714 |             Body: {\"os-resetState\": {\"state\": \"error\"}}\n\nThen tries to list servers by that status and expects to get that one back:\n\n2017-01-31 17:48:34.663883 |     2017-01-31 17:28:39,556 504 INFO     [tempest.lib.common.rest_client] Request (ServersAdminTestJSON:test_list_servers_filter_by_error_status): 200 GET http://10.23.154.32:8774/v2.1/servers?status=error 0.179s\n2017-01-31 17:48:34.663955 |     2017-01-31 17:28:39,556 504 DEBUG    [tempest.lib.common.rest_client] Request - Headers: {'X-Auth-Token': '<omitted>', 'Accept': 'application/json', 'Content-Type': 'application/json'}\n2017-01-31 17:48:34.663969 |             Body: None\n2017-01-31 17:48:34.664078 |         Response - Headers: {u'x-openstack-nova-api-version': '2.1', u'vary': 'X-OpenStack-Nova-API-Version', u'content-length': '15', 'status': '200', u'content-type': 'application/json', u'x-compute-request-id': 'req-91ef16ab-28c3-47c5-b823-6a321bde5c01', u'date': 'Tue, 31 Jan 2017 17:28:39 GMT', 'content-location': 'http://10.23.154.32:8774/v2.1/servers?status=error', u'openstack-api-version': 'compute 2.1', u'connection': 'close'}\n2017-01-31 17:48:34.664094 |             Body: {\"servers\": []}\n\nAnd the list is coming back empty, intermittently, with cells v1. So there is probably some vm_state change race between the state change in the child cell and reporting that back up to the parent API cell.\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22Body%3A%20%7B%5C%5C%5C%22servers%5C%5C%5C%22%3A%20%5B%5D%7D%5C%22%20AND%20tags%3A%5C%22console%5C%22%20AND%20build_name%3A%5C%22gate-tempest-dsvm-cells-ubuntu-xenial%5C%22&from=7d\n\n16 hits in 7 days, check and gate, all failures.", 
    "tags": [
        "cells"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1660747", 
    "owner": "https://api.launchpad.net/1.0/~melwitt", 
    "id": 1660747, 
    "index": 4744, 
    "created": "2017-01-31 19:04:16.428138+00:00", 
    "title": "test_list_servers_filter_by_error_status intermittently fails with MismatchError on no servers in response", 
    "comments": [
        {
            "content": "Seen here:\n\nhttp://logs.openstack.org/59/424759/12/gate/gate-tempest-dsvm-cells-ubuntu-xenial/d7b1311/console.html#_2017-01-31_17_48_34_663273\n\n2017-01-31 17:48:34.663337 | Captured traceback:\n2017-01-31 17:48:34.663348 | ~~~~~~~~~~~~~~~~~~~\n2017-01-31 17:48:34.663363 |     Traceback (most recent call last):\n2017-01-31 17:48:34.663393 |       File \"tempest/api/compute/admin/test_servers.py\", line 59, in test_list_servers_filter_by_error_status\n2017-01-31 17:48:34.663414 |         self.assertIn(self.s1_id, map(lambda x: x['id'], servers))\n2017-01-31 17:48:34.663448 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 417, in assertIn\n2017-01-31 17:48:34.663468 |         self.assertThat(haystack, Contains(needle), message)\n2017-01-31 17:48:34.663502 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 498, in assertThat\n2017-01-31 17:48:34.663515 |         raise mismatch_error\n2017-01-31 17:48:34.663542 |     testtools.matchers._impl.MismatchError: u'108b4797-74fd-4a00-912a-b7fe0e142888' not in []\n\nThis test resets the state on a server to ERROR:\n\n2017-01-31 17:48:34.663649 |     2017-01-31 17:28:39,375 504 INFO     [tempest.lib.common.rest_client] Request (ServersAdminTestJSON:test_list_servers_filter_by_error_status): 202 POST http://10.23.154.32:8774/v2.1/servers/108b4797-74fd-4a00-912a-b7fe0e142888/action 0.142s\n2017-01-31 17:48:34.663695 |     2017-01-31 17:28:39,376 504 DEBUG    [tempest.lib.common.rest_client] Request - Headers: {'X-Auth-Token': '<omitted>', 'Accept': 'application/json', 'Content-Type': 'application/json'}\n2017-01-31 17:48:34.663714 |             Body: {\"os-resetState\": {\"state\": \"error\"}}\n\nThen tries to list servers by that status and expects to get that one back:\n\n2017-01-31 17:48:34.663883 |     2017-01-31 17:28:39,556 504 INFO     [tempest.lib.common.rest_client] Request (ServersAdminTestJSON:test_list_servers_filter_by_error_status): 200 GET http://10.23.154.32:8774/v2.1/servers?status=error 0.179s\n2017-01-31 17:48:34.663955 |     2017-01-31 17:28:39,556 504 DEBUG    [tempest.lib.common.rest_client] Request - Headers: {'X-Auth-Token': '<omitted>', 'Accept': 'application/json', 'Content-Type': 'application/json'}\n2017-01-31 17:48:34.663969 |             Body: None\n2017-01-31 17:48:34.664078 |         Response - Headers: {u'x-openstack-nova-api-version': '2.1', u'vary': 'X-OpenStack-Nova-API-Version', u'content-length': '15', 'status': '200', u'content-type': 'application/json', u'x-compute-request-id': 'req-91ef16ab-28c3-47c5-b823-6a321bde5c01', u'date': 'Tue, 31 Jan 2017 17:28:39 GMT', 'content-location': 'http://10.23.154.32:8774/v2.1/servers?status=error', u'openstack-api-version': 'compute 2.1', u'connection': 'close'}\n2017-01-31 17:48:34.664094 |             Body: {\"servers\": []}\n\nAnd the list is coming back empty, intermittently, with cells v1. So there is probably some vm_state change race between the state change in the child cell and reporting that back up to the parent API cell.\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22Body%3A%20%7B%5C%5C%5C%22servers%5C%5C%5C%22%3A%20%5B%5D%7D%5C%22%20AND%20tags%3A%5C%22console%5C%22%20AND%20build_name%3A%5C%22gate-tempest-dsvm-cells-ubuntu-xenial%5C%22&from=7d\n\n16 hits in 7 days, check and gate, all failures.", 
            "date_created": "2017-01-31 19:04:16.428138+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This is potentially a Tempest bug since the os-resetState API in Nova returns a 202 response, so Tempest should probably be waiting for the server to go into error state before doing the GET query with the status filter.", 
            "date_created": "2017-01-31 19:14:42.633389+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "As mriedem pointed out in IRC, the reset-state API simply changes the vm_state and does an instance.save() immediately and returns. So we shouldn't need to wait for an error state. In cells v1, the instance.save() will trigger a sync to the child cell to update the vm_state. This should be fine since the API reads from the top/parent, but I think we have a bug in our compute/api get_all cells v2 code where we're reading instances from child cells instead of the top/parent cell. We have conditionals where \"if cells v1, read from the top\" and it looks like get_all was missed.", 
            "date_created": "2017-01-31 19:21:54.177761+00:00", 
            "author": "https://api.launchpad.net/1.0/~melwitt"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/427394", 
            "date_created": "2017-01-31 20:27:24.814524+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/427394\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=826df45a40599490dfa2f2209a2cd9586fbd6c89\nSubmitter: Jenkins\nBranch:    master\n\ncommit 826df45a40599490dfa2f2209a2cd9586fbd6c89\nAuthor: melanie witt <email address hidden>\nDate:   Tue Jan 31 20:20:17 2017 +0000\n\n    Read instances from API cell for cells v1\n    \n    Recent work on cells v2 has us reading instances from compute cells\n    via target_cell, but that breaks the existing behavior of cells v1\n    because of the syncing between API cell and compute cells. When\n    state changes are effected in the API cell, there is a slight delay\n    before they are reflected in the compute cell. So, reading from the\n    compute cell instead of the API cell results in behavior changes.\n    \n    This adds a conditional in compute/api get_all to read instances\n    from the API cell if cells v1 is enabled. We are already doing this\n    for compute/api get, and get_all was missed.\n    \n    Closes-Bug: #1660747\n    \n    Change-Id: I7df5c4616ef386216c7bd7efea2be68173c61be0\n", 
            "date_created": "2017-02-01 08:21:48.376864+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "As Matt said, HTTP 202 means just \"Accepted\" for a request. That doesn't mean the operation is completed already.\nHowever on cell-v1, the API behavior looks like \"the operation is completed already\" and Tempest is expecting it on the test.\nSo I guess Tempest side work is unnecessary now.", 
            "date_created": "2017-02-02 16:31:01.302223+00:00", 
            "author": "https://api.launchpad.net/1.0/~oomichi"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0rc1 release candidate.", 
            "date_created": "2017-02-03 19:08:19.176459+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}