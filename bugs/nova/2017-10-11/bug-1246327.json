{
    "status": "Fix Released", 
    "last_updated": "2015-03-17 12:03:57.066877+00:00", 
    "description": "After the changes in the block device mappings introduced for Havana, if we try to create an snapshot of a volume-backed instance the resulting image cannot be used to boot a new instance due to conflicts with the bootindex between the block_device_mapping stored in the image properties and the current image.\n\nThe steps to reproduce are:\n\n$ glance image-create --name f20 --disk-format qcow2 --container-format bare --min-disk 2 --is-public True --min-ram 512 --copy-from http://download.fedoraproject.org/pub/fedora/linux/releases/test/20-Alpha/Images/x86_64/Fedora-x86_64-20-Alpha-20130918-sda.qcow2\n\n$ cinder create --image-id <uuid of the new image> --display-name f20 2\n\n$ nova boot --boot-volume <uuid of the new volume> --flavor m1.tiny test-instance\n\n$ nova image-create test-instance test-snap\n\nThis will create an snapshot of the volume and an image in glance with a block_device_mapping containing the snapshot_id and all the other values from the original block_device_mapping (id, connection_info, instance_uuid, ...):\n\n| Property 'block_device_mapping' | [{\"instance_uuid\": \"989f03dc-2736-4884-ab66-97360102d804\", \"virtual_name\": null, \"no_device\": null, \"connection_info\": \"{\\\"driver_volume_type\\\": \\\"iscsi\\\", \\\"serial\\\": \\\"cb6d4406-1c66-4f9a-9fd8-7e246a3b93b7\\\", \\\"data\\\": {\\\"access_mode\\\": \\\"rw\\\", \\\"target_discovered\\\": false, \\\"encrypted\\\": false, \\\"qos_spec\\\": null, \\\"device_path\\\": \\\"/dev/disk/by-path/ip-192.168.122.2:3260-iscsi-iqn.2010-10.org.openstack:volume-cb6d4406-1c66-4f9a-9fd8-7e246a3b93b7-lun-1\\\", \\\"target_iqn\\\": \\\"iqn.2010-10.org.openstack:volume-cb6d4406-1c66-4f9a-9fd8-7e246a3b93b7\\\", \\\"target_portal\\\": \\\"192.168.122.2:3260\\\", \\\"volume_id\\\": \\\"cb6d4406-1c66-4f9a-9fd8-7e246a3b93b7\\\", \\\"target_lun\\\": 1, \\\"auth_password\\\": \\\"wh5bWkAjKv7Dy6Ptt4nY\\\", \\\"auth_username\\\": \\\"oPbN9FzbEPQ3iFpPhv5d\\\", \\\"auth_method\\\": \\\"CHAP\\\"}}\", \"created_at\": \"2013-10-30T13:18:57.000000\", \"snapshot_id\": \"f6a25cc2-b3af-400b-9ef9-519d28239920\", \"updated_at\": \"2013-10-30T13:19:08.000000\", \"device_name\": \"/dev/vda\", \"deleted\": 0, \"volume_size\": null, \"volume_id\": null, \"id\": 3, \"deleted_at\": null, \"delete_on_termination\": false}] |\n\nWhen we try latter to use this image to boot a new instance, the API won't let us because both, the device in the image bdm and the image (which is empty) are considered to be the boot device:\n\n$ nova boot --image test-snap --flavor m1.nano test-instance2\nERROR: Block Device Mapping is Invalid: Boot sequence for the instance and image/block device mapping combination is not valid. (HTTP 400) (Request-ID: req-3e502a29-9cd3-4c0c-8ddc-a28d315d21ea)\n\nIf we check the internal flow we can see that nova considers the image to be the boot device even thought the image itself doesn't define any local disk but only a block_device_mapping pointing to the snapshot.\n\nTo be able to generate proper images from volume-backed instances we should:\n 1. copy only the relevant keys from the original block_device_mapping to prevent duplicities in DB\n 2. prevent nova from adding a new block device for the image if this one doesn't define any local disk", 
    "tags": [], 
    "importance": "High", 
    "heat": 30, 
    "link": "https://bugs.launchpad.net/nova/+bug/1246327", 
    "owner": "None", 
    "id": 1246327, 
    "index": 1293, 
    "created": "2013-10-30 13:45:57.500768+00:00", 
    "title": "the snapshot of a volume-backed instance cannot be used to boot a new instance", 
    "comments": [
        {
            "content": "After the changes in the block device mappings introduced for Havana, if we try to create an snapshot of a volume-backed instance the resulting image cannot be used to boot a new instance due to conflicts with the bootindex between the block_device_mapping stored in the image properties and the current image.\n\nThe steps to reproduce are:\n\n$ glance image-create --name f20 --disk-format qcow2 --container-format bare --min-disk 2 --is-public True --min-ram 512 --copy-from http://download.fedoraproject.org/pub/fedora/linux/releases/test/20-Alpha/Images/x86_64/Fedora-x86_64-20-Alpha-20130918-sda.qcow2\n\n$ cinder create --image-id <uuid of the new image> --display-name f20 2\n\n$ nova boot --boot-volume <uuid of the new volume> --flavor m1.tiny test-instance\n\n$ nova image-create test-instance test-snap\n\nThis will create an snapshot of the volume and an image in glance with a block_device_mapping containing the snapshot_id and all the other values from the original block_device_mapping (id, connection_info, instance_uuid, ...):\n\n| Property 'block_device_mapping' | [{\"instance_uuid\": \"989f03dc-2736-4884-ab66-97360102d804\", \"virtual_name\": null, \"no_device\": null, \"connection_info\": \"{\\\"driver_volume_type\\\": \\\"iscsi\\\", \\\"serial\\\": \\\"cb6d4406-1c66-4f9a-9fd8-7e246a3b93b7\\\", \\\"data\\\": {\\\"access_mode\\\": \\\"rw\\\", \\\"target_discovered\\\": false, \\\"encrypted\\\": false, \\\"qos_spec\\\": null, \\\"device_path\\\": \\\"/dev/disk/by-path/ip-192.168.122.2:3260-iscsi-iqn.2010-10.org.openstack:volume-cb6d4406-1c66-4f9a-9fd8-7e246a3b93b7-lun-1\\\", \\\"target_iqn\\\": \\\"iqn.2010-10.org.openstack:volume-cb6d4406-1c66-4f9a-9fd8-7e246a3b93b7\\\", \\\"target_portal\\\": \\\"192.168.122.2:3260\\\", \\\"volume_id\\\": \\\"cb6d4406-1c66-4f9a-9fd8-7e246a3b93b7\\\", \\\"target_lun\\\": 1, \\\"auth_password\\\": \\\"wh5bWkAjKv7Dy6Ptt4nY\\\", \\\"auth_username\\\": \\\"oPbN9FzbEPQ3iFpPhv5d\\\", \\\"auth_method\\\": \\\"CHAP\\\"}}\", \"created_at\": \"2013-10-30T13:18:57.000000\", \"snapshot_id\": \"f6a25cc2-b3af-400b-9ef9-519d28239920\", \"updated_at\": \"2013-10-30T13:19:08.000000\", \"device_name\": \"/dev/vda\", \"deleted\": 0, \"volume_size\": null, \"volume_id\": null, \"id\": 3, \"deleted_at\": null, \"delete_on_termination\": false}] |\n\nWhen we try latter to use this image to boot a new instance, the API won't let us because both, the device in the image bdm and the image (which is empty) are considered to be the boot device:\n\n$ nova boot --image test-snap --flavor m1.nano test-instance2\nERROR: Block Device Mapping is Invalid: Boot sequence for the instance and image/block device mapping combination is not valid. (HTTP 400) (Request-ID: req-3e502a29-9cd3-4c0c-8ddc-a28d315d21ea)\n\nIf we check the internal flow we can see that nova considers the image to be the boot device even thought the image itself doesn't define any local disk but only a block_device_mapping pointing to the snapshot.\n\nTo be able to generate proper images from volume-backed instances we should:\n 1. copy only the relevant keys from the original block_device_mapping to prevent duplicities in DB\n 2. prevent nova from adding a new block device for the image if this one doesn't define any local disk", 
            "date_created": "2013-10-30 13:45:57.500768+00:00", 
            "author": "https://api.launchpad.net/1.0/~xqueralt-deactivatedaccount"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/54633", 
            "date_created": "2013-10-30 21:33:30.382235+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/54634", 
            "date_created": "2013-10-30 21:33:44.722233+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Raising importance because instance volume-backed snapshots are the only type of snapshots the EC2 API use.", 
            "date_created": "2013-10-31 09:45:46.184554+00:00", 
            "author": "https://api.launchpad.net/1.0/~xqueralt-deactivatedaccount"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/54633\nCommitted: http://github.com/openstack/nova/commit/eddd8a14cd2393ce7bdb0ec1c7366177371192b2\nSubmitter: Jenkins\nBranch:    master\n\ncommit eddd8a14cd2393ce7bdb0ec1c7366177371192b2\nAuthor: Xavier Queralt <email address hidden>\nDate:   Wed Oct 30 20:21:03 2013 +0100\n\n    Clean BDM when snapshoting volume-backed instances\n    \n    When snapshoting a volume-backed instance, its block device mapping is\n    copied entirely into the image properties of the resulting snapshot.\n    \n    This may lead to some errors when booting from that snapshot because the\n    fields 'id', 'insance_uuid' and 'connection_info' must be generated for\n    each instance instead of reusing the ones from the original instance.\n    For example, sharing the connection_info will cause the new instance to\n    try to connect to the original volume instead of creating a new one.\n    \n    This patch cleans all the database-specific plus the connection_info\n    fields from the block device mapping when creating the snapshot.\n    \n    Change-Id: I4190e9519d641c61b00b5d86c3885f2ae4fa86f3\n    Partial-Bug: #1246327\n", 
            "date_created": "2013-11-22 10:53:34.676836+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/54634\nCommitted: http://github.com/openstack/nova/commit/482dfeb113f1e0ff814aa1fc980d67e0c8b06d76\nSubmitter: Jenkins\nBranch:    master\n\ncommit 482dfeb113f1e0ff814aa1fc980d67e0c8b06d76\nAuthor: Xavier Queralt <email address hidden>\nDate:   Wed Oct 30 21:25:55 2013 +0100\n\n    Process image BDM earlier to avoid duplicates\n    \n    If the block device mapping from the image properties are not handled at\n    the same time as the ones defined from the API, we might make the false\n    assumption that the instance has no root and failing or, in the case\n    we're booting from an image that only defines a BDM and has no disk,\n    creating a local disk BDM as root and ending up with two root devices\n    which is forbidden.\n    \n    This patch moves the handling of the image block device mappings to the\n    same method were we check the ones provided throught the API. This\n    allows nova to decide wether the instance needs a local disk from an\n    image if no root device is defined in any of the block device mappings.\n    \n    Change-Id: Ide95357895ab4dd1338ab5ee3ec25294af1d010b\n    Closes-Bug: #1246327\n", 
            "date_created": "2013-11-22 10:54:21.138438+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/57890", 
            "date_created": "2013-11-22 10:57:32.009909+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/57891", 
            "date_created": "2013-11-22 10:57:46.510589+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/57890\nCommitted: http://github.com/openstack/nova/commit/cad49c3f2aac14b9934ee160a650d4a7b9809d66\nSubmitter: Jenkins\nBranch:    stable/havana\n\ncommit cad49c3f2aac14b9934ee160a650d4a7b9809d66\nAuthor: Xavier Queralt <email address hidden>\nDate:   Wed Oct 30 20:21:03 2013 +0100\n\n    Clean BDM when snapshoting volume-backed instances\n    \n    When snapshoting a volume-backed instance, its block device mapping is\n    copied entirely into the image properties of the resulting snapshot.\n    \n    This may lead to some errors when booting from that snapshot because the\n    fields 'id', 'insance_uuid' and 'connection_info' must be generated for\n    each instance instead of reusing the ones from the original instance.\n    For example, sharing the connection_info will cause the new instance to\n    try to connect to the original volume instead of creating a new one.\n    \n    This patch cleans all the database-specific plus the connection_info\n    fields from the block device mapping when creating the snapshot.\n    \n    Change-Id: I4190e9519d641c61b00b5d86c3885f2ae4fa86f3\n    Partial-Bug: #1246327\n    (cherry picked from commit eddd8a14cd2393ce7bdb0ec1c7366177371192b2)\n", 
            "date_created": "2013-12-07 10:23:45.771845+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/57891\nCommitted: http://github.com/openstack/nova/commit/1d2a0b8cc640efc858242f070f96449f679b343a\nSubmitter: Jenkins\nBranch:    stable/havana\n\ncommit 1d2a0b8cc640efc858242f070f96449f679b343a\nAuthor: Xavier Queralt <email address hidden>\nDate:   Wed Oct 30 21:25:55 2013 +0100\n\n    Process image BDM earlier to avoid duplicates\n    \n    If the block device mapping from the image properties are not handled at\n    the same time as the ones defined from the API, we might make the false\n    assumption that the instance has no root and failing or, in the case\n    we're booting from an image that only defines a BDM and has no disk,\n    creating a local disk BDM as root and ending up with two root devices\n    which is forbidden.\n    \n    This patch moves the handling of the image block device mappings to the\n    same method were we check the ones provided throught the API. This\n    allows nova to decide wether the instance needs a local disk from an\n    image if no root device is defined in any of the block device mappings.\n    \n    Change-Id: Ide95357895ab4dd1338ab5ee3ec25294af1d010b\n    Closes-Bug: #1246327\n    (cherry picked from commit 482dfeb113f1e0ff814aa1fc980d67e0c8b06d76)\n", 
            "date_created": "2013-12-09 18:24:18.254048+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This bug still affects me and i'm running openstack 1.0.1\n", 
            "date_created": "2015-03-17 12:03:56.531812+00:00", 
            "author": "https://api.launchpad.net/1.0/~brunomiguelqueiros"
        }
    ]
}