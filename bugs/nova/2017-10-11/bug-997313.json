{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:19:23.174956+00:00", 
    "description": "Just notices SmokeStack XenServer builds failing again....\n\nAs of this afternoon Nova Folsom fails on resize w/ the following error in nova-compute.log:\n\n find VM with name instance-00000002. Setting instance vm_state to ERROR\n2012-05-09 15:17:43 ERROR nova.rpc.amqp [req-846458ee-3fce-4a9c-add3-87b784a37c4b admin admin] Exception during message handling\n2012-05-09 15:17:43 TRACE nova.rpc.amqp Traceback (most recent call last):\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 263, in _process_data\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     rval = node_func(context=ctxt, **node_args)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 118, in wrapped\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     temp_level, payload)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     self.gen.next()\n\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 93, in wrapped\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     return f(*args, **kw)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 169, in decorated_function\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     function(self, context, instance_uuid, *args, **kwargs)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 193, in decorated_function\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     sys.exc_info())\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     self.gen.next()\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 187, in decorated_function\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     return function(self, context, instance_uuid, *args, **kwargs)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1345, in resize_instance\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     self._set_instance_error_state(context, instance_uuid)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     self.gen.next()\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1340, in resize_instance\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     instance_type_ref, self._legacy_nw_info(network_info))\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/connection.py\", line 245, in migrate_disk_and_power_off\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     dest, instance_type)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 803, in migrate_disk_and_power_off\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     destroy_kernel_ramdisk=False)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 1139, in _destroy\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     self._shutdown(instance, vm_ref)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 994, in _shutdown\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     state = self.get_info(instance)['state']\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 1365, in get_info\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     vm_ref = self._get_vm_opaque_ref(instance)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 582, in _get_vm_opaque_ref\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     instance['name'])\n2012-05-09 15:17:43 TRACE nova.rpc.amqp NotFound: Could not find VM with name instance-00000002", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/997313", 
    "owner": "https://api.launchpad.net/1.0/~dan-prince", 
    "id": 997313, 
    "index": 678, 
    "created": "2012-05-09 20:20:39.535638+00:00", 
    "title": "resize fails w/ Could not find VM with name instance-00000002", 
    "comments": [
        {
            "content": "Just notices SmokeStack XenServer builds failing again....\n\nAs of this afternoon Nova Folsom fails on resize w/ the following error in nova-compute.log:\n\n find VM with name instance-00000002. Setting instance vm_state to ERROR\n2012-05-09 15:17:43 ERROR nova.rpc.amqp [req-846458ee-3fce-4a9c-add3-87b784a37c4b admin admin] Exception during message handling\n2012-05-09 15:17:43 TRACE nova.rpc.amqp Traceback (most recent call last):\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 263, in _process_data\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     rval = node_func(context=ctxt, **node_args)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 118, in wrapped\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     temp_level, payload)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     self.gen.next()\n\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 93, in wrapped\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     return f(*args, **kw)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 169, in decorated_function\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     function(self, context, instance_uuid, *args, **kwargs)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 193, in decorated_function\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     sys.exc_info())\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     self.gen.next()\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 187, in decorated_function\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     return function(self, context, instance_uuid, *args, **kwargs)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1345, in resize_instance\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     self._set_instance_error_state(context, instance_uuid)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     self.gen.next()\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1340, in resize_instance\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     instance_type_ref, self._legacy_nw_info(network_info))\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/connection.py\", line 245, in migrate_disk_and_power_off\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     dest, instance_type)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 803, in migrate_disk_and_power_off\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     destroy_kernel_ramdisk=False)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 1139, in _destroy\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     self._shutdown(instance, vm_ref)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 994, in _shutdown\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     state = self.get_info(instance)['state']\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 1365, in get_info\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     vm_ref = self._get_vm_opaque_ref(instance)\n2012-05-09 15:17:43 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 582, in _get_vm_opaque_ref\n2012-05-09 15:17:43 TRACE nova.rpc.amqp     instance['name'])\n2012-05-09 15:17:43 TRACE nova.rpc.amqp NotFound: Could not find VM with name instance-00000002", 
            "date_created": "2012-05-09 20:20:39.535638+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Okay. I see the issue here. Since the instance is in resize... and I'm resizing to the same host (for testing) the _shutdown is now being called due to f539bf7d0522f4a83a212534ec0dac988c36c87a.\n\nInstead of calling get_info... we should just use the vm_ref we already have (avoiding the Xenapi instance lookup by name).", 
            "date_created": "2012-05-09 20:37:33.152087+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/7287", 
            "date_created": "2012-05-09 20:37:50.561398+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/7287\nCommitted: http://github.com/openstack/nova/commit/d879dc9e0d28aa203426729c6cfea48bdbfa3cfd\nSubmitter: Jenkins\nBranch:    master\n\ncommit d879dc9e0d28aa203426729c6cfea48bdbfa3cfd\nAuthor: Dan Prince <email address hidden>\nDate:   Wed May 9 16:33:57 2012 -0400\n\n    Avoid unnecessary inst lookup in vmops _shutdown.\n    \n    Updates the XenServer vmops.py _shutdown function so that it\n    avoids calling get_info/_get_vm_opaque_ref with the instance name.\n    Since _shutdown already has the vm_ref there is no need to make\n    this call.\n    \n    This fixes an issue where 'RESIZE' was broken when resizing to\n    the same host.\n    \n    Fixes LP Bug #997313.\n    \n    Change-Id: Ic5a1a0f92df9a2b809aef20a250843bf48402d75\n", 
            "date_created": "2012-05-09 21:00:06.691563+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}