{
    "status": "Fix Released", 
    "last_updated": "2017-03-13 18:41:52.314424+00:00", 
    "description": "Reproduction steps\uff1a\n1. Boot instance from image (create a new volume) , Instance spawned successfully.\ncli command:\nnova boot --flavor 1 --block-device id=b171c0ba-0532-4e38-be4d-05c291e88403,source=image,dest=volume,bootindex=0,size=20 --nic net-id=e499cc2e-c6bb-4d70-9fe8-616f5399bf49  vm1\n\nIn the cmd\uff0cb171c0ba-0532-4e38-be4d-05c291e88403 is an image.\n\n2. Migrate/Retype the volume which created by step 1.\ncli command:\ncinder migrate <volume-uuid> <dest-volume-host>\nOr cmd:\ncinder retype <volume-uuid> <another-type> on-demand\n\n3.The volume migrate/retype failed\n\n4.Get error infomation in nova-compute.log :\n\n\n2016-03-07 16:17:48.718 9817 WARNING nova.virt.libvirt.volume [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] ISCSI volume not yet found at: vda. Will rescan & retry.  Try number: 0\n2016-03-07 16:17:49.503 9817 ERROR nova.compute.manager [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] Failed to swap volume 333df485-406c-4c51-92d1-5ba0aebfeb0d for 241abd7b-31fb-4763-86e7-3eda59744f09\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] Traceback (most recent call last):\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5914, in _swap_volume\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]     resize_to)\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1238, in swap_volume\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]     driver_bdm = driver_block_device.DriverVolumeBlockDevice(bdm)\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 102, in __init__\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]     self._transform()\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 204, in _transform\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]     raise _InvalidType\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] _InvalidType\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]\n2016-03-07 16:17:49.771 9817 INFO nova.compute.manager [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] swap_volume: calling Cinder terminate_connection for 241abd7b-31fb-4763-86e7-3eda59744f09\n2016-03-07 16:17:50.775 9817 INFO nova.compute.manager [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] swap_volume:calling Cinder terminate_connection end for: 241abd7b-31fb-4763-86e7-3eda59744f09\n2016-03-07 16:17:51.239 9817 INFO nova.compute.manager [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] swap_volume: Cinder migrate_volume_completion returned: {u'save_volume_id': u'333df485-406c-4c51-92d1-5ba0aebfeb0d'}\n2016-03-07 16:17:51.392 9817 INFO nova.scheduler.client.report [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] Compute_service record updated for ('2C5_10_DELL05', '2C5_10_DELL05')\n2016-03-07 16:17:51.394 9817 ERROR oslo_messaging.rpc.dispatcher [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] Exception during message handling:\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 8708, in swap_volume\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     new_volume_id)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     payload)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 379, in decorated_function\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     LOG.warning(msg, e, instance_uuid=instance_uuid)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 350, in decorated_function\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 407, in decorated_function\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 395, in decorated_function\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5974, in swap_volume\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     new_volume_id)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5933, in _swap_volume\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     self.volume_api.unreserve_volume(context, new_volume_id)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5914, in _swap_volume\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     resize_to)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1238, in swap_volume\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     driver_bdm = driver_block_device.DriverVolumeBlockDevice(bdm)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 102, in __init__\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     self._transform()\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 204, in _transform\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     raise _InvalidType\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher _InvalidType\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1554859", 
    "owner": "https://api.launchpad.net/1.0/~gu-weiwei", 
    "id": 1554859, 
    "index": 4478, 
    "created": "2016-03-09 02:56:24.936001+00:00", 
    "title": "in-used volume can't be migrated for InvalidType", 
    "comments": [
        {
            "content": "1. boot instance from image (create a new volume) , Instance spawned successfully\n\n2. migrate the volume which instance is using\n\n3.the volume migrate failed\n\n4.check error infomation in nova-compute.log :\n\n2016-03-07 16:17:43.218 9817 INFO nova.virt.libvirt.iscsiscrub [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] scrub devices: by-path no residual devices\n2016-03-07 16:17:48.718 9817 WARNING nova.virt.libvirt.volume [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] ISCSI volume not yet found at: vda. Will rescan & retry.  Try number: 0\n2016-03-07 16:17:49.503 9817 ERROR nova.compute.manager [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] Failed to swap volume 333df485-406c-4c51-92d1-5ba0aebfeb0d for 241abd7b-31fb-4763-86e7-3eda59744f09\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] Traceback (most recent call last):\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5914, in _swap_volume\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]     resize_to)\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1238, in swap_volume\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]     driver_bdm = driver_block_device.DriverVolumeBlockDevice(bdm)\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 102, in __init__\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]     self._transform()\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 204, in _transform\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab]     raise _InvalidType\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] _InvalidType\n2016-03-07 16:17:49.503 9817 TRACE nova.compute.manager [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] \n2016-03-07 16:17:49.771 9817 INFO nova.compute.manager [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] swap_volume: calling Cinder terminate_connection for 241abd7b-31fb-4763-86e7-3eda59744f09\n2016-03-07 16:17:50.775 9817 INFO nova.compute.manager [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] swap_volume:calling Cinder terminate_connection end for: 241abd7b-31fb-4763-86e7-3eda59744f09\n2016-03-07 16:17:51.239 9817 INFO nova.compute.manager [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] [instance: 303abfcb-b78b-4891-848f-b1f490ac69ab] swap_volume: Cinder migrate_volume_completion returned: {u'save_volume_id': u'333df485-406c-4c51-92d1-5ba0aebfeb0d'}\n2016-03-07 16:17:51.392 9817 INFO nova.scheduler.client.report [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] Compute_service record updated for ('2C5_10_DELL05', '2C5_10_DELL05')\n2016-03-07 16:17:51.394 9817 ERROR oslo_messaging.rpc.dispatcher [req-8039f9e7-9d4d-48dc-9e2a-dd6073a954b0 8b34e1ab75024fcba0ea69a6fd0937c3 181a578bc97642f2b9e153bec622f130 - - -] Exception during message handling: \n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 8708, in swap_volume\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     new_volume_id)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     payload)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 379, in decorated_function\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     LOG.warning(msg, e, instance_uuid=instance_uuid)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 350, in decorated_function\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 407, in decorated_function\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 395, in decorated_function\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5974, in swap_volume\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     new_volume_id)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5933, in _swap_volume\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     self.volume_api.unreserve_volume(context, new_volume_id)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5914, in _swap_volume\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     resize_to)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1238, in swap_volume\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     driver_bdm = driver_block_device.DriverVolumeBlockDevice(bdm)\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 102, in __init__\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     self._transform()\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 204, in _transform\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher     raise _InvalidType\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher _InvalidType\n2016-03-07 16:17:51.394 9817 TRACE oslo_messaging.rpc.dispatcher", 
            "date_created": "2016-03-09 02:56:24.936001+00:00", 
            "author": "https://api.launchpad.net/1.0/~chen-xueying1"
        }, 
        {
            "content": "boot instance from image (create a new volume), and in the block_device_mapping table of nova db, the source_type is image, not volume.\nWhen migrating volume(in-use status), will checking whether the volume type is valid, the _valid_source is volume. but \n in the block_device_mapping table of nova db, the source_type is image. \n\n\n\n/nova/virt/block_device.py:\nclass DriverVolumeBlockDevice(DriverBlockDevice):\n    _legacy_fields = set(['connection_info', 'mount_device',\n                          'delete_on_termination'])\n    _new_fields = set(['guest_format', 'device_type',\n                       'disk_bus', 'boot_index'])\n    _fields = _legacy_fields | _new_fields\n\n    _valid_source = 'volume'\n    _valid_destination = 'volume'\n\n    _proxy_as_attr = set(['volume_size', 'volume_id'])\n    _update_on_save = {'disk_bus': None,\n                       'device_name': 'mount_device',\n                       'device_type': None}\n\n    def _transform(self):\n        if (not self._bdm_obj.source_type == self._valid_source\n                or not self._bdm_obj.destination_type ==\n                self._valid_destination):\n            LOG.info(_LI('%s,%s,%s,%s') % (self._bdm_obj.source_type,\n                          self._valid_source,self._bdm_obj.destination_type,self._valid_destination))\n            raise _InvalidType", 
            "date_created": "2016-03-09 03:13:55.968044+00:00", 
            "author": "https://api.launchpad.net/1.0/~gu-weiwei"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/314455", 
            "date_created": "2016-05-10 08:13:13.645144+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Weiwei Gu (<email address hidden>) on branch: master\nReview: https://review.openstack.org/314455\nReason: abandon", 
            "date_created": "2016-05-12 09:55:36.933256+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/315864", 
            "date_created": "2016-05-13 03:51:46.297981+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "@weiwei, thanks for update the bug, I reproduced it by:\n\nnova volume-update test_bdm  $(old_boot_volume_id) $(new_boot_volume_id)\n\nthis should be same logic with 'cinder migrate/retype'.\n\n2016-07-07 11:08:29.744 DEBUG oslo_messaging._drivers.amqpdriver [req-44373ed6-f6b2-4ff0-b6a3-59f0304f2b56 admin admin] CALL msg_id: f9dce7e1\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 197, in force_reraise\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 156, in decorated_function\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     return function(self, context, *args, **kwargs)\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 215, in decorated_function\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     kwargs['instance'], e, sys.exc_info())\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 221, in __exit__\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     self.force_reraise()\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 197, in force_reraise\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 203, in decorated_function\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     return function(self, context, *args, **kwargs)\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 4871, in swap_volume\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     resize_to)\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 4823, in _swap_volume\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     self.volume_api.unreserve_volume(context, new_volume_id)\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 221, in __exit__\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     self.force_reraise()\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 197, in force_reraise\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 4804, in _swap_volume\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     resize_to)\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1309, in swap_volume\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     driver_bdm = driver_block_device.DriverVolumeBlockDevice(bdm)\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/block_device.py\", line 127, in __init__\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     self._transform()\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/block_device.py\", line 229, in _transform\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server     raise _InvalidType\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server _InvalidType\n2016-07-07 11:08:29.795 TRACE oslo_messaging.rpc.server \n", 
            "date_created": "2016-07-07 03:12:02.273496+00:00", 
            "author": "https://api.launchpad.net/1.0/~taget-9"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/315864\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ab1d40149bba06f80dde8e8645ab3ab5f16abf02\nSubmitter: Jenkins\nBranch:    master\n\ncommit ab1d40149bba06f80dde8e8645ab3ab5f16abf02\nAuthor: weiweigu <email address hidden>\nDate:   Fri May 13 13:05:58 2016 +0800\n\n    migration volume failed for invalid type\n    \n    Boot an instance from image (create a new volume), then migrate this\n    volume. When migrating, source_type and destination_type will be\n    checked for validity at function\n    nova.virt.block_device.DriverVolumeBlockDevice._transform().\n    The valid source is volume. But source_type is\n    not volume, is image in the block_device_mapping table. It causes\n    migration failure.\n    Actually source_type may be image snapshot and volume. At\n    swap_volume, it should call the convert_volume, but not\n    DriverVolumeBlockDevice.\n    \n    Change-Id: I36b2e2aef3345f244c05ae94225c91938450a749\n    Closes-Bug: #1554859\n", 
            "date_created": "2016-07-11 19:41:59.725890+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b2 development milestone.", 
            "date_created": "2016-07-14 13:00:24.735879+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }, 
        {
            "content": "Fix proposed to branch: stable/mitaka\nReview: https://review.openstack.org/433791", 
            "date_created": "2017-02-14 17:07:12.029713+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Matt Riedemann (<email address hidden>) on branch: stable/mitaka\nReview: https://review.openstack.org/433791", 
            "date_created": "2017-03-13 18:41:50.889567+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}