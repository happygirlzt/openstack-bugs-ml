{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:48:21.123786+00:00", 
    "description": "Problem)\nThis is my multi_host configuration.\nHost: nova-1, nova-2\ninstnace: instance-1(10.0.149.4, nova-1), instance-2(10.0.149.6nova-2)\nbridge: br100(10.0.149.3, nova-1), br100(10.0.149.5, nova-2)\n\nwhen I try to ping instance-1 at nova-2. any reply didn't come.\nand also ping instance-2 at nova-1, result is same.\n\nbut, ping to bridge(10.0.149.3,nova-1) from nova-2 is ok.\nping to bridge(10.0.149.5,nova-2) from nova-1 is also ok.\n\nso, I check iptables.\nThis is rule of cause of problem.\n# iptables -L\n....\nChain nova-network-FORWARD (1 references)\ntarget     prot opt source               destination\nDROP       all  --  anywhere             anywhere\nDROP       all  --  anywhere             anywhere\n....\nso, I drop this rule, \n# iptables -D nova-network-FORWARD 2\n# iptables -D nova-network-FORWARD 1\n\nthen, \nany instance can ping and ssh to other instance.\n\nthis rule add when nova-network start or new instance become boot.\n\nthis is code of above rule.\n\nnova.network.linux_net.py\n 997         if gateway:\n 998             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n 999                                              '--in-interface %s -j ACCEPT' % \\\n1000                                              bridge)\n1001             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1002                                              '--out-interface %s -j ACCEPT' % \\\n1003                                              bridge)\n1004 #        else:\n1005 #            iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1006 #                                             '--in-interface %s -j DROP' % \\\n1007 #                                             bridge)\n1008 #            iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1009 #                                             '--out-interface %s -j DROP' % \\\n1010 #                                             bridge)\n1011 #\n\nI modified 1004 ~ 1010 lines. I commented out that else: routine and I restart nova-network module. \n\nthen, above rule didn't appears.\n\n# iptables -L\n...\nChain nova-network-FORWARD (1 references)\ntarget     prot opt source               destination\n...\n\nI think instance can connect any host in multi_host configuration. so that rule should be modified.", 
    "tags": [
        "in-stable-diablo", 
        "iptables"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/890195", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 890195, 
    "index": 521, 
    "created": "2011-11-14 12:39:00.880076+00:00", 
    "title": "iptables drops forward rules for hosts", 
    "comments": [
        {
            "content": "Problem)\nThis is my multi_host configuration.\nHost: nova-1, nova-2\ninstnace: instance-1(10.0.149.4, nova-1), instance-2(10.0.149.6nova-2)\nbridge: br100(10.0.149.3, nova-1), br100(10.0.149.5, nova-2)\n\nwhen I try to ping instance-1 at nova-2. any reply didn't come.\nand also ping instance-2 at nova-1, result is same.\n\nbut, ping to bridge(10.0.149.3,nova-1) from nova-2 is ok.\nping to bridge(10.0.149.5,nova-2) from nova-1 is also ok.\n\nso, I check iptables.\nThis is rule of cause of problem.\n# iptables -L\n....\nChain nova-network-FORWARD (1 references)\ntarget     prot opt source               destination\nDROP       all  --  anywhere             anywhere\nDROP       all  --  anywhere             anywhere\n....\nso, I drop this rule, \n# iptables -D nova-network-FORWARD 2\n# iptables -D nova-network-FORWARD 1\n\nthen, \nany instance can ping and ssh to other instance.\n\nthis rule add when nova-network start or new instance become boot.\n\nthis is code of above rule.\n\nnova.network.linux_net.py\n 997         if gateway:\n 998             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n 999                                              '--in-interface %s -j ACCEPT' % \\\n1000                                              bridge)\n1001             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1002                                              '--out-interface %s -j ACCEPT' % \\\n1003                                              bridge)\n1004 #        else:\n1005 #            iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1006 #                                             '--in-interface %s -j DROP' % \\\n1007 #                                             bridge)\n1008 #            iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1009 #                                             '--out-interface %s -j DROP' % \\\n1010 #                                             bridge)\n1011 #\n\nI modified 1004 ~ 1010 lines. I commented out that else: routine and I restart nova-network module. \n\nthen, above rule didn't appears.\n\n# iptables -L\n...\nChain nova-network-FORWARD (1 references)\ntarget     prot opt source               destination\n...\n\nI think instance can connect any host in multi_host configuration. so that rule should be modified.", 
            "date_created": "2011-11-14 12:39:00.880076+00:00", 
            "author": "https://api.launchpad.net/1.0/~hyangii"
        }, 
        {
            "content": "VMs aren't necessarily supposed to be pingable from hosts.  They should be pingable from the network host (or any host if using a --multi_host network) if the flag --allow_same_net_traffic is true.  Otherwise you need to specifically allow connections via security group rules.\n\n\nOn Nov 14, 2011, at 4:39 AM, jaesanglee wrote:\n\n> Public bug reported:\n> \n> Problem)\n> This is my multi_host configuration.\n> Host: nova-1, nova-2\n> instnace: instance-1(10.0.149.4, nova-1), instance-2(10.0.149.6nova-2)\n> bridge: br100(10.0.149.3, nova-1), br100(10.0.149.5, nova-2)\n> \n> when I try to ping instance-1 at nova-2. any reply didn't come.\n> and also ping instance-2 at nova-1, result is same.\n> \n> but, ping to bridge(10.0.149.3,nova-1) from nova-2 is ok.\n> ping to bridge(10.0.149.5,nova-2) from nova-1 is also ok.\n> \n> so, I check iptables.\n> This is rule of cause of problem.\n> # iptables -L\n> ....\n> Chain nova-network-FORWARD (1 references)\n> target     prot opt source               destination\n> DROP       all  --  anywhere             anywhere\n> DROP       all  --  anywhere             anywhere\n> ....\n> so, I drop this rule, \n> # iptables -D nova-network-FORWARD 2\n> # iptables -D nova-network-FORWARD 1\n> \n> then, \n> any instance can ping and ssh to other instance.\n> \n> this rule add when nova-network start or new instance become boot.\n> \n> this is code of above rule.\n> \n> nova.network.linux_net.py\n> 997         if gateway:\n> 998             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n> 999                                              '--in-interface %s -j ACCEPT' % \\\n> 1000                                              bridge)\n> 1001             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n> 1002                                              '--out-interface %s -j ACCEPT' % \\\n> 1003                                              bridge)\n> 1004 #        else:\n> 1005 #            iptables_manager.ipv4['filter'].add_rule('FORWARD',\n> 1006 #                                             '--in-interface %s -j DROP' % \\\n> 1007 #                                             bridge)\n> 1008 #            iptables_manager.ipv4['filter'].add_rule('FORWARD',\n> 1009 #                                             '--out-interface %s -j DROP' % \\\n> 1010 #                                             bridge)\n> 1011 #\n> \n> I modified 1004 ~ 1010 lines. I commented out that else: routine and I\n> restart nova-network module.\n> \n> then, above rule didn't appears.\n> \n> # iptables -L\n> ...\n> Chain nova-network-FORWARD (1 references)\n> target     prot opt source               destination\n> ...\n> \n> I think instance can connect any host in multi_host configuration. so\n> that rule should be modified.\n> \n> ** Affects: nova\n>     Importance: Undecided\n>         Status: New\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/890195\n> \n> Title:\n>  iptables problem: can't connect from other host to instance\n> \n> Status in OpenStack Compute (Nova):\n>  New\n> \n> Bug description:\n>  Problem)\n>  This is my multi_host configuration.\n>  Host: nova-1, nova-2\n>  instnace: instance-1(10.0.149.4, nova-1), instance-2(10.0.149.6nova-2)\n>  bridge: br100(10.0.149.3, nova-1), br100(10.0.149.5, nova-2)\n> \n>  when I try to ping instance-1 at nova-2. any reply didn't come.\n>  and also ping instance-2 at nova-1, result is same.\n> \n>  but, ping to bridge(10.0.149.3,nova-1) from nova-2 is ok.\n>  ping to bridge(10.0.149.5,nova-2) from nova-1 is also ok.\n> \n>  so, I check iptables.\n>  This is rule of cause of problem.\n>  # iptables -L\n>  ....\n>  Chain nova-network-FORWARD (1 references)\n>  target     prot opt source               destination\n>  DROP       all  --  anywhere             anywhere\n>  DROP       all  --  anywhere             anywhere\n>  ....\n>  so, I drop this rule, \n>  # iptables -D nova-network-FORWARD 2\n>  # iptables -D nova-network-FORWARD 1\n> \n>  then, \n>  any instance can ping and ssh to other instance.\n> \n>  this rule add when nova-network start or new instance become boot.\n> \n>  this is code of above rule.\n> \n>  nova.network.linux_net.py\n>   997         if gateway:\n>   998             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n>   999                                              '--in-interface %s -j ACCEPT' % \\\n>  1000                                              bridge)\n>  1001             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n>  1002                                              '--out-interface %s -j ACCEPT' % \\\n>  1003                                              bridge)\n>  1004 #        else:\n>  1005 #            iptables_manager.ipv4['filter'].add_rule('FORWARD',\n>  1006 #                                             '--in-interface %s -j DROP' % \\\n>  1007 #                                             bridge)\n>  1008 #            iptables_manager.ipv4['filter'].add_rule('FORWARD',\n>  1009 #                                             '--out-interface %s -j DROP' % \\\n>  1010 #                                             bridge)\n>  1011 #\n> \n>  I modified 1004 ~ 1010 lines. I commented out that else: routine and I\n>  restart nova-network module.\n> \n>  then, above rule didn't appears.\n> \n>  # iptables -L\n>  ...\n>  Chain nova-network-FORWARD (1 references)\n>  target     prot opt source               destination\n>  ...\n> \n>  I think instance can connect any host in multi_host configuration. so\n>  that rule should be modified.\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/890195/+subscriptions\n\n", 
            "date_created": "2011-11-15 23:53:02+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Ok, I have one more problem with above code.\nNow, \nwhen I start nova-network, iptables added this rule.\nChain nova-network-FORWARD (1 references)\ntarget prot opt source destination\nDROP all -- anywhere anywhere\nDROP all -- anywhere anywhere\n\nbecause In nova/network/linux_net.py,\n 995         # Don't forward traffic unless we were told to be a gateway\n 996         if gateway:\n 997             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n 998                                              '--in-interface %s -j ACCEPT' % \\\n 999                                              bridge)\n1000             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1001                                              '--out-interface %s -j ACCEPT' % \\\n1002                                              bridge)\n1003 \n1004         else:\n1005             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1006                                              '--in-interface %s -j DROP' % \\\n1007                                              bridge)\n1008             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1009                                              '--out-interface %s -j DROP' % \\\n1010                                              bridge)\n\nabove this code, gateway set 'None' and 'gateway = fields[1]'\n 967             gateway = None\n 968             out, err = _execute('route', '-n', run_as_root=True)\n 969             for line in out.split('\\n'):\n 970                 fields = line.split()\n 971                 if fields and fields[0] == '0.0.0.0' and \\\n 972                                 fields[-1] == interface:\n 973                     gateway = fields[1]\n 974                     _execute('route', 'del', 'default', 'gw', gateway,\n 975                              'dev', interface, check_exit_code=False,\n 976                              run_as_root=True)\n\n# route -n \n...\n0.0.0.0         192.168.0.1     0.0.0.0         UG    100    0        0 eth1\n\nbut, my nova.conf\n--public_interface=eth1\n--flat_interface=eth2\n\nso,\n fields[-1] = eth1\n interface = eth2\nfileds[-1] != interface, so gateway didn't set.\n\nfinally below rule run.\n1004         else:\n1005             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1006                                              '--in-interface %s -j DROP' % \\\n1007                                              bridge)\n1008             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n1009                                              '--out-interface %s -j DROP' % \\\n1010                                              bridge)\n\nAs a result, below rule added.\nChain nova-network-FORWARD (1 references)\ntarget prot opt source destination\nDROP all -- anywhere anywhere\nDROP all -- anywhere anywhere\n\nand, In a instance, I can't connect to any other site and host.\n\n# nova list\n+--------------------------------------+---------+--------+---------------------+\n|                  ID                  |   Name  | Status |       Networks      |\n+--------------------------------------+---------+--------+---------------------+\n| bbfa18ce-a21a-460c-8689-e746e0583939 | backend | ACTIVE | private=10.0.152.21 |\n+--------------------------------------+---------+--------+---------------------+\n# ssh -i nova.priv 10.0.152.21\n# ~~~ \n-in instance.\nubuntu # ping google.com \n~~~any reply didn't come-\nubuntu # apt-get update\n~~~can't update\n\nso, I drop above rule.\n# iptables -D nova-network-FORWARD 1\n# iptables -D nova-network-FORWARD 1\n\nthen, Instance can connect to other site and host.\n\n\nHow can I solve this problem with not fix code?\n", 
            "date_created": "2011-11-16 09:04:37.848857+00:00", 
            "author": "https://api.launchpad.net/1.0/~hyangii"
        }, 
        {
            "content": "That is definitely a bug.\n\nThe inner gateway is hiding the outer one.\n\nVish\n\nOn Nov 16, 2011, at 1:04 AM, jaesanglee wrote:\n\n> Ok, I have one more problem with above code.\n> Now, \n> when I start nova-network, iptables added this rule.\n> Chain nova-network-FORWARD (1 references)\n> target prot opt source destination\n> DROP all -- anywhere anywhere\n> DROP all -- anywhere anywhere\n> \n> because In nova/network/linux_net.py,\n> 995         # Don't forward traffic unless we were told to be a gateway\n> 996         if gateway:\n> 997             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n> 998                                              '--in-interface %s -j ACCEPT' % \\\n> 999                                              bridge)\n> 1000             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n> 1001                                              '--out-interface %s -j ACCEPT' % \\\n> 1002                                              bridge)\n> 1003 \n> 1004         else:\n> 1005             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n> 1006                                              '--in-interface %s -j DROP' % \\\n> 1007                                              bridge)\n> 1008             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n> 1009                                              '--out-interface %s -j DROP' % \\\n> 1010                                              bridge)\n> \n> above this code, gateway set 'None' and 'gateway = fields[1]'\n> 967             gateway = None\n> 968             out, err = _execute('route', '-n', run_as_root=True)\n> 969             for line in out.split('\\n'):\n> 970                 fields = line.split()\n> 971                 if fields and fields[0] == '0.0.0.0' and \\\n> 972                                 fields[-1] == interface:\n> 973                     gateway = fields[1]\n> 974                     _execute('route', 'del', 'default', 'gw', gateway,\n> 975                              'dev', interface, check_exit_code=False,\n> 976                              run_as_root=True)\n> \n> # route -n \n> ...\n> 0.0.0.0         192.168.0.1     0.0.0.0         UG    100    0        0 eth1\n> \n> but, my nova.conf\n> --public_interface=eth1\n> --flat_interface=eth2\n> \n> so,\n> fields[-1] = eth1\n> interface = eth2\n> fileds[-1] != interface, so gateway didn't set.\n> \n> finally below rule run.\n> 1004         else:\n> 1005             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n> 1006                                              '--in-interface %s -j DROP' % \\\n> 1007                                              bridge)\n> 1008             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n> 1009                                              '--out-interface %s -j DROP' % \\\n> 1010                                              bridge)\n> \n> As a result, below rule added.\n> Chain nova-network-FORWARD (1 references)\n> target prot opt source destination\n> DROP all -- anywhere anywhere\n> DROP all -- anywhere anywhere\n> \n> and, In a instance, I can't connect to any other site and host.\n> \n> # nova list\n> +--------------------------------------+---------+--------+---------------------+\n> |                  ID                  |   Name  | Status |       Networks      |\n> +--------------------------------------+---------+--------+---------------------+\n> | bbfa18ce-a21a-460c-8689-e746e0583939 | backend | ACTIVE | private=10.0.152.21 |\n> +--------------------------------------+---------+--------+---------------------+\n> # ssh -i nova.priv 10.0.152.21\n> # ~~~ \n> -in instance.\n> ubuntu # ping google.com \n> ~~~any reply didn't come-\n> ubuntu # apt-get update\n> ~~~can't update\n> \n> so, I drop above rule.\n> # iptables -D nova-network-FORWARD 1\n> # iptables -D nova-network-FORWARD 1\n> \n> then, Instance can connect to other site and host.\n> \n> \n> How can I solve this problem with not fix code?\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/890195\n> \n> Title:\n>  iptables problem: can't connect from other host to instance\n> \n> Status in OpenStack Compute (Nova):\n>  New\n> \n> Bug description:\n>  Problem)\n>  This is my multi_host configuration.\n>  Host: nova-1, nova-2\n>  instnace: instance-1(10.0.149.4, nova-1), instance-2(10.0.149.6nova-2)\n>  bridge: br100(10.0.149.3, nova-1), br100(10.0.149.5, nova-2)\n> \n>  when I try to ping instance-1 at nova-2. any reply didn't come.\n>  and also ping instance-2 at nova-1, result is same.\n> \n>  but, ping to bridge(10.0.149.3,nova-1) from nova-2 is ok.\n>  ping to bridge(10.0.149.5,nova-2) from nova-1 is also ok.\n> \n>  so, I check iptables.\n>  This is rule of cause of problem.\n>  # iptables -L\n>  ....\n>  Chain nova-network-FORWARD (1 references)\n>  target     prot opt source               destination\n>  DROP       all  --  anywhere             anywhere\n>  DROP       all  --  anywhere             anywhere\n>  ....\n>  so, I drop this rule, \n>  # iptables -D nova-network-FORWARD 2\n>  # iptables -D nova-network-FORWARD 1\n> \n>  then, \n>  any instance can ping and ssh to other instance.\n> \n>  this rule add when nova-network start or new instance become boot.\n> \n>  this is code of above rule.\n> \n>  nova.network.linux_net.py\n>   997         if gateway:\n>   998             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n>   999                                              '--in-interface %s -j ACCEPT' % \\\n>  1000                                              bridge)\n>  1001             iptables_manager.ipv4['filter'].add_rule('FORWARD',\n>  1002                                              '--out-interface %s -j ACCEPT' % \\\n>  1003                                              bridge)\n>  1004 #        else:\n>  1005 #            iptables_manager.ipv4['filter'].add_rule('FORWARD',\n>  1006 #                                             '--in-interface %s -j DROP' % \\\n>  1007 #                                             bridge)\n>  1008 #            iptables_manager.ipv4['filter'].add_rule('FORWARD',\n>  1009 #                                             '--out-interface %s -j DROP' % \\\n>  1010 #                                             bridge)\n>  1011 #\n> \n>  I modified 1004 ~ 1010 lines. I commented out that else: routine and I\n>  restart nova-network module.\n> \n>  then, above rule didn't appears.\n> \n>  # iptables -L\n>  ...\n>  Chain nova-network-FORWARD (1 references)\n>  target     prot opt source               destination\n>  ...\n> \n>  I think instance can connect any host in multi_host configuration. so\n>  that rule should be modified.\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/890195/+subscriptions\n\n", 
            "date_created": "2011-11-16 17:39:09+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/1694\nCommitted: http://github.com/openstack/nova/commit/41af372219793556e6ba335d765761fa277107df\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit 41af372219793556e6ba335d765761fa277107df\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Wed Nov 16 10:17:23 2011 -0800\n\n    Makes sure gateways forward properly\n    \n     * Fixes bug 890195\n     * Fixes missing context in dhcp call\n     * Adds test to verify call is correct\n    \n    Change-Id: Ic099082a18d9fd8f48c338e092cd4a2d227b927b\n", 
            "date_created": "2011-11-16 23:24:05+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2181\nCommitted: http://github.com/openstack/nova/commit/e9f427fc2e8014eeba3f46284c38414209fb0b7e\nSubmitter: Jenkins\nBranch:    stable/diablo\n\n tag in-stable-diablo\n done\n\ncommit e9f427fc2e8014eeba3f46284c38414209fb0b7e\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Wed Nov 16 10:17:23 2011 -0800\n\n    Makes sure gateways forward properly\n    \n     * Fixes bug 890195\n     * Fixes missing context in dhcp call\n     * Adds test to verify call is correct\n    \n    (cherry picked from commit 41af372219793556e6ba335d765761fa277107df)\n    \n    Change-Id: Ic099082a18d9fd8f48c338e092cd4a2d227b927b\n", 
            "date_created": "2011-12-08 17:01:07+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }
    ]
}