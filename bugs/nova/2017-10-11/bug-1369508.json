{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:55:57.932343+00:00", 
    "description": "This was reported by Michael Turek as he was testing this while the patches were still in flight See: https://review.openstack.org/#/c/114938/26/nova/virt/hardware.py\n\nAs described on there - the code there makes a bad assumption about the format in which it will get the data in the scheduler, which results in:\n\n2014-09-15 10:45:44.906 ERROR oslo.messaging.rpc.dispatcher [req-f29a469e-268d-49bf-abfa-0ccb228d768c admin admin] Exception during message handling: An object of type InstanceNUMACell is required here\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 134, in _dispatch_and_reply\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 177, in _dispatch\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 123, in _do_dispatch\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/server.py\", line 139, in inner\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     return func(*args, **kwargs)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/scheduler/manager.py\", line 175, in select_destinations\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     filter_properties)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/scheduler/filter_scheduler.py\", line 147, in select_destinations\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     filter_properties)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/scheduler/filter_scheduler.py\", line 300, in _schedule\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     chosen_host.obj.consume_from_instance(context, instance_properties)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/scheduler/host_manager.py\", line 252, in consume_from_instance\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     self, instance)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/hardware.py\", line 978, in get_host_numa_usage_from_instance\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     instance_numa_topology = instance_topology_from_instance(instance)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/hardware.py\", line 949, in instance_topology_from_instance\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     cells=cells)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/base.py\", line 242, in __init__\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     self[key] = kwargs[key]\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/base.py\", line 474, in __setitem__\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     setattr(self, name, value)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/base.py\", line 75, in setter\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     field_value = field.coerce(self, name, value)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/fields.py\", line 189, in coerce\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     return self._type.coerce(obj, attr, value)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/fields.py\", line 388, in coerce\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     obj, '%s[%i]' % (attr, index), element)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/fields.py\", line 189, in coerce\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     return self._type.coerce(obj, attr, value)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/fields.py\", line 474, in coerce\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     self._obj_name)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher ValueError: An object of type InstanceNUMACell is required here", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1369508", 
    "owner": "https://api.launchpad.net/1.0/~ndipanov", 
    "id": 1369508, 
    "index": 1609, 
    "created": "2014-09-15 10:47:53.230871+00:00", 
    "title": "Instance with NUMA topology causes exception in the scheduler", 
    "comments": [
        {
            "content": "This was reported by Michael Turek as he was testing this while the patches were still in flight See: https://review.openstack.org/#/c/114938/26/nova/virt/hardware.py\n\nAs described on there - the code there makes a bad assumption about the format in which it will get the data in the scheduler, which results in:\n\n2014-09-15 10:45:44.906 ERROR oslo.messaging.rpc.dispatcher [req-f29a469e-268d-49bf-abfa-0ccb228d768c admin admin] Exception during message handling: An object of type InstanceNUMACell is required here\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 134, in _dispatch_and_reply\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 177, in _dispatch\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 123, in _do_dispatch\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/server.py\", line 139, in inner\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     return func(*args, **kwargs)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/scheduler/manager.py\", line 175, in select_destinations\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     filter_properties)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/scheduler/filter_scheduler.py\", line 147, in select_destinations\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     filter_properties)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/scheduler/filter_scheduler.py\", line 300, in _schedule\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     chosen_host.obj.consume_from_instance(context, instance_properties)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/scheduler/host_manager.py\", line 252, in consume_from_instance\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     self, instance)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/hardware.py\", line 978, in get_host_numa_usage_from_instance\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     instance_numa_topology = instance_topology_from_instance(instance)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/hardware.py\", line 949, in instance_topology_from_instance\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     cells=cells)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/base.py\", line 242, in __init__\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     self[key] = kwargs[key]\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/base.py\", line 474, in __setitem__\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     setattr(self, name, value)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/base.py\", line 75, in setter\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     field_value = field.coerce(self, name, value)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/fields.py\", line 189, in coerce\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     return self._type.coerce(obj, attr, value)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/fields.py\", line 388, in coerce\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     obj, '%s[%i]' % (attr, index), element)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/fields.py\", line 189, in coerce\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     return self._type.coerce(obj, attr, value)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/objects/fields.py\", line 474, in coerce\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher     self._obj_name)\n2014-09-15 10:45:44.906 TRACE oslo.messaging.rpc.dispatcher ValueError: An object of type InstanceNUMACell is required here", 
            "date_created": "2014-09-15 10:47:53.230871+00:00", 
            "author": "https://api.launchpad.net/1.0/~ndipanov"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/121558", 
            "date_created": "2014-09-15 13:39:35.869511+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/121558\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=12b8b56807af7ce3bbe330d73864abc87cdadbf1\nSubmitter: Jenkins\nBranch:    master\n\ncommit 12b8b56807af7ce3bbe330d73864abc87cdadbf1\nAuthor: Nikola Dipanov <email address hidden>\nDate:   Mon Sep 15 15:32:56 2014 +0200\n\n    instance_topology_from_instance handles request_spec properly\n    \n    We special-case how we handle the instance that we extract from the\n    request_spec data blob in virt.hardware.instance_topology_from_instance,\n    however, we were making wrong assumptions about the data we get from it\n    in the scheduler.\n    \n    This patch fixes how it is handled and also updates the tests and\n    comments in the code to reflect it.\n    \n    Change-Id: I38d7078d670bc37ddb40fba82fd0f9cb74045047\n    Closes-bug: #1369508\n", 
            "date_created": "2014-09-17 02:19:35.600720+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}