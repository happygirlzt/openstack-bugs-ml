{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:38:47.064628+00:00", 
    "description": "Description of problem\n---------------------------\n\nLive migration fails.\nlibvirt says \"XML error: CPU feature `wdt' specified more than once\"\n\nVersion\n---------\n\nii  libvirt-bin                                         1.2.2-0ubuntu2                        amd64        programs for the libvirt library\nii  python-libvirt                                      1.2.2-0ubuntu1                        amd64        libvirt Python bindings\nii  nova-compute                                        1:2014.1~b3-0ubuntu2                  all          OpenStack Compute - compute node base\nii  nova-compute-kvm                                    1:2014.1~b3-0ubuntu2                  all          OpenStack Compute - compute node (KVM)\nii  nova-cert                                           1:2014.1~b3-0ubuntu2                  all          OpenStack Compute - certificate management\n\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=14.04\nDISTRIB_CODENAME=trusty\nDISTRIB_DESCRIPTION=\"Ubuntu Trusty Tahr (development branch)\"\nNAME=\"Ubuntu\"\nVERSION=\"14.04, Trusty Tahr\"\n\n\nTest env\n----------\n\nA two node openstack havana on ubuntu 14.04. Migrating a instance to other node.\n\n\nSteps to Reproduce\n------------------\n - Migrate the instance\n\n\nAnd observe /var/log/nova/compute.log and /var/log/libvirt.log\n\nActual results\n--------------\n\n/var/log/nova-conductor.log\n\n2014-04-04 13:42:17.128 3294 ERROR oslo.messaging._drivers.common [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\\n    incoming.message))\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/server.py\", line 139, in inner\\n    return func(*args, **kwargs)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/conductor/manager.py\", line 668, in migrate_server\\n    block_migration, disk_over_commit)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/conductor/manager.py\", line 769, in _live_migrate\\n    raise exception.MigrationError(reason=ex)\\n', 'MigrationError: Migration error: Remote error: libvirtError XML error: CPU feature `wdt\\' specified more than once\\n[u\\'Traceback (most recent call last):\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\\\\n    incoming.message))\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\\\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\\\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 88, in wrapped\\\\n    payload)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\\\n    six.reraise(self.type_, self.value, self.tb)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 71, in wrapped\\\\n    return f(self, context, *args, **kw)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 272, in decorated_function\\\\n    e, sys.exc_info())\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\\\n    six.reraise(self.type_, self.value, self.tb)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 259, in decorated_function\\\\n    return function(self, context, *args, **kwargs)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 4159, in check_can_live_migrate_destination\\\\n    block_migration, disk_over_commit)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4094, in check_can_live_migrate_destination\\\\n    self._compare_cpu(source_cpu_info)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4236, in _compare_cpu\\\\n    LOG.error(m, {\\\\\\'ret\\\\\\': ret, \\\\\\'u\\\\\\': u})\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\\\n    six.reraise(self.type_, self.value, self.tb)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4232, in _compare_cpu\\\\n    ret = self._conn.compareCPU(cpu.to_xml(), 0)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 179, in doit\\\\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 139, in proxy_call\\\\n    rv = execute(f,*args,**kwargs)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 77, in tworker\\\\n    rv = meth(*args,**kwargs)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 3191, in compareCPU\\\\n    if ret == -1: raise libvirtError (\\\\\\'virConnectCompareCPU() failed\\\\\\', conn=self)\\\\n\\', u\"libvirtError: XML error: CPU feature `wdt\\' specified more than once\\\\n\"].\\n']\n2014-04-04 13:52:18.161 3295 ERROR nova.conductor.manager [req-471d2933-354a-4417-af50-c48399e19663 42fab7a8b7434bfc8473767c01e8378d b1cf6337c229491c96ad6e0a96e82979] Migration of instance 47d1fe7d-b812-4588-85eb-aa813267fc82 to host c2 unexpectedly failed.\n\n\n/var/log/libvirtd.log\n\n2014-03-27 18:23:17.141+0000: 2659: info : libvirt version: 1.2.2\n2014-03-27 18:23:17.141+0000: 2659: error : virCPUDefParseXML:413 : XML error: CPU feature `wdt' specified more than once\n\n\nExpected results\n----------------\nSuccessful migration\n\n\nAdditional info\n----------------\n\nRelated with: https://bugs.launchpad.net/nova/+bug/1267191\n\nOn the file /usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py, the list info['features'] have the duplicate feature.", 
    "tags": [
        "compute", 
        "icehouse-backport-potential", 
        "in-stable-icehouse", 
        "libvirt", 
        "low-hanging-fruit"
    ], 
    "importance": "Medium", 
    "heat": 134, 
    "link": "https://bugs.launchpad.net/nova/+bug/1303536", 
    "owner": "https://api.launchpad.net/1.0/~vladik-romanovsky", 
    "id": 1303536, 
    "index": 3868, 
    "created": "2014-04-07 02:06:19.565904+00:00", 
    "title": "Live migration fails. XML error: CPU feature `wdt' specified more than once", 
    "comments": [
        {
            "content": "Description of problem\n---------------------------\n\nLive migration fails.\nlibvirt says \"XML error: CPU feature `wdt' specified more than once\"\n\nVersion\n---------\n\nii  libvirt-bin                                         1.2.2-0ubuntu2                        amd64        programs for the libvirt library\nii  python-libvirt                                      1.2.2-0ubuntu1                        amd64        libvirt Python bindings\nii  nova-compute                                        1:2014.1~b3-0ubuntu2                  all          OpenStack Compute - compute node base\nii  nova-compute-kvm                                    1:2014.1~b3-0ubuntu2                  all          OpenStack Compute - compute node (KVM)\nii  nova-cert                                           1:2014.1~b3-0ubuntu2                  all          OpenStack Compute - certificate management\n\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=14.04\nDISTRIB_CODENAME=trusty\nDISTRIB_DESCRIPTION=\"Ubuntu Trusty Tahr (development branch)\"\nNAME=\"Ubuntu\"\nVERSION=\"14.04, Trusty Tahr\"\n\n\nTest env\n----------\n\nA two node openstack havana on ubuntu 14.04. Migrating a instance to other node.\n\n\nSteps to Reproduce\n------------------\n - Migrate the instance\n\n\nAnd observe /var/log/nova/compute.log and /var/log/libvirt.log\n\nActual results\n--------------\n\n/var/log/nova-conductor.log\n\n2014-04-04 13:42:17.128 3294 ERROR oslo.messaging._drivers.common [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\\n    incoming.message))\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/server.py\", line 139, in inner\\n    return func(*args, **kwargs)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/conductor/manager.py\", line 668, in migrate_server\\n    block_migration, disk_over_commit)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/conductor/manager.py\", line 769, in _live_migrate\\n    raise exception.MigrationError(reason=ex)\\n', 'MigrationError: Migration error: Remote error: libvirtError XML error: CPU feature `wdt\\' specified more than once\\n[u\\'Traceback (most recent call last):\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\\\\n    incoming.message))\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\\\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\\\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 88, in wrapped\\\\n    payload)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\\\n    six.reraise(self.type_, self.value, self.tb)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 71, in wrapped\\\\n    return f(self, context, *args, **kw)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 272, in decorated_function\\\\n    e, sys.exc_info())\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\\\n    six.reraise(self.type_, self.value, self.tb)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 259, in decorated_function\\\\n    return function(self, context, *args, **kwargs)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 4159, in check_can_live_migrate_destination\\\\n    block_migration, disk_over_commit)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4094, in check_can_live_migrate_destination\\\\n    self._compare_cpu(source_cpu_info)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4236, in _compare_cpu\\\\n    LOG.error(m, {\\\\\\'ret\\\\\\': ret, \\\\\\'u\\\\\\': u})\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\\\n    six.reraise(self.type_, self.value, self.tb)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4232, in _compare_cpu\\\\n    ret = self._conn.compareCPU(cpu.to_xml(), 0)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 179, in doit\\\\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 139, in proxy_call\\\\n    rv = execute(f,*args,**kwargs)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 77, in tworker\\\\n    rv = meth(*args,**kwargs)\\\\n\\', u\\'  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 3191, in compareCPU\\\\n    if ret == -1: raise libvirtError (\\\\\\'virConnectCompareCPU() failed\\\\\\', conn=self)\\\\n\\', u\"libvirtError: XML error: CPU feature `wdt\\' specified more than once\\\\n\"].\\n']\n2014-04-04 13:52:18.161 3295 ERROR nova.conductor.manager [req-471d2933-354a-4417-af50-c48399e19663 42fab7a8b7434bfc8473767c01e8378d b1cf6337c229491c96ad6e0a96e82979] Migration of instance 47d1fe7d-b812-4588-85eb-aa813267fc82 to host c2 unexpectedly failed.\n\n\n/var/log/libvirtd.log\n\n2014-03-27 18:23:17.141+0000: 2659: info : libvirt version: 1.2.2\n2014-03-27 18:23:17.141+0000: 2659: error : virCPUDefParseXML:413 : XML error: CPU feature `wdt' specified more than once\n\n\nExpected results\n----------------\nSuccessful migration\n\n\nAdditional info\n----------------\n\nRelated with: https://bugs.launchpad.net/nova/+bug/1267191\n\nOn the file /usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py, the list info['features'] have the duplicate feature.", 
            "date_created": "2014-04-07 02:06:19.565904+00:00", 
            "author": "https://api.launchpad.net/1.0/~mosorio-0"
        }, 
        {
            "content": "", 
            "date_created": "2014-04-07 02:06:19.565904+00:00", 
            "author": "https://api.launchpad.net/1.0/~mosorio-0"
        }, 
        {
            "content": "I've hit a similar issue before.  We should coordinate with the libvirt team to try to get this solved on their end, but we should also have a check on our end for older libvirt versions.", 
            "date_created": "2014-04-08 16:05:06.924651+00:00", 
            "author": "https://api.launchpad.net/1.0/~sross-7"
        }, 
        {
            "content": "I think this problem should be resolved if we will backport the following patch to Havana:\nhttps://review.openstack.org/#/c/65360/\n", 
            "date_created": "2014-04-17 16:02:59.992549+00:00", 
            "author": "https://api.launchpad.net/1.0/~vladik-romanovsky"
        }, 
        {
            "content": "I'm not sure that this is a bug with libvirt.\n\nThis bug appears to come from `get_host_capabilities` in nova/virt/libvirt/driver.py\n\nWe `getCapabilities` from the libvirt connection, then parse this into our object.\nNext we call libvirt's `baselineCPU` with a XML representation of our CPU.\nThis returns an XML string that includes all the CPU features, including the ones we passed to it.  This, to me, sounds right according to libvirt documentation.\n\nFrom: http://libvirt.org/html/libvirt-libvirt.html#virConnectBaselineCPU\n\"Computes the most feature-rich CPU which is compatible with all given host CPUs.\nIf @flags includes VIR_CONNECT_BASELINE_CPU_EXPAND_FEATURES then libvirt will explicitly list all CPU features that are part of the host CPU, without this flag features that are part of the CPU model will not be listed.\"\n\nWe then parse all the features that are returned back into our object creating an XML document with duplicates.\n\nThen, we later use this XML in the `_compare_cpu` function in driver.py, in which libvirt returns an error because it has received the XML from Nova with a duplicate.\n\nIn contrast to the related bug, it appears that it was caused by an error in libvirt where the baselineCPU function would error before returning the XML to us.\n\n\nIf I'm not misinterpreting this issue I think we should ensure we don't place duplicate CPU features into our array.\n\nSomething like the attached patch would prevent duplicates from entering our list.", 
            "date_created": "2014-04-18 22:51:20.622419+00:00", 
            "author": "https://api.launchpad.net/1.0/~nakato"
        }, 
        {
            "content": "Patching All path above but the problem still there. This is my nova-compute log\n2014-04-19 01:41:22.842 4397 INFO nova.virt.libvirt.driver [req-1ee12afe-c0ec-4d82-a6a5-3280407ca8e1 67ac350f0a164433ac342b4960300341 a3ace7f03db4449db2b57f95fadc94ea] Instance launched has CPU info:\n{\"vendor\": \"Intel\", \"model\": \"core2duo\", \"arch\": \"x86_64\", \"features\": [\"lahf_lm\", \"rdtscp\", \"lahf_lm\", \"rdtscp\", \"lm\", \"nx\", \"syscall\", \"ssse3\", \"monitor\", \"pni\", \"sse2\", \"sse\", \"fxsr\", \"mmx\", \"clflush\", \"pse36\", \"pat\", \"cmov\", \"mca\", \"pge\", \"mtrr\", \"sep\", \"apic\", \"cx8\", \"mce\", \"pae\", \"msr\", \"tsc\", \"pse\", \"de\", \"vme\", \"fpu\"], \"topology\": {\"cores\": 1, \"threads\": 1, \"sockets\": 1}}\n2014-04-19 01:41:22.846 4397 ERROR nova.virt.libvirt.driver [req-1ee12afe-c0ec-4d82-a6a5-3280407ca8e1 67ac350f0a164433ac342b4960300341 a3ace7f03db4449db2b57f95fadc94ea] CPU doesn't have compatibility.\n\nXML error: CPU feature `lahf_lm' specified more than once\n\nRefer to http://libvirt.org/html/libvirt-libvirt.html#virCPUCompareResult\n2014-04-19 01:41:22.868 4397 ERROR oslo.messaging.rpc.dispatcher [-] Exception during message handling: XML error: CPU feature `lahf_lm' specified more than once\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 88, in wrapped\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     payload)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 71, in wrapped\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 309, in decorated_function\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     e, sys.exc_info())\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 296, in decorated_function\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 4418, in check_can_live_migrate_destination\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     block_migration, disk_over_commit)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4189, in check_can_live_migrate_destination\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     self._compare_cpu(source_cpu_info)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4331, in _compare_cpu\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     except libvirt.libvirtError as e:\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4327, in _compare_cpu\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     m = _(\"CPU doesn't have compatibility.\\n\\n%(ret)s\\n\\nRefer to %(u)s\")\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 179, in doit\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 139, in proxy_call\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     rv = execute(f,*args,**kwargs)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 77, in tworker\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     rv = meth(*args,**kwargs)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 3191, in compareCPU\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher     if ret == -1: raise libvirtError ('virConnectCompareCPU() failed', conn=self)\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher libvirtError: XML error: CPU feature `lahf_lm' specified more than once\n2014-04-19 01:41:22.868 4397 TRACE oslo.messaging.rpc.dispatcher \n2014-04-19 01:41:22.873 4397 ERROR oslo.messaging._drivers.common [-] Returning exception XML error: CPU feature `lahf_lm' specified more than once to caller\n2014-04-19 01:41:22.873 4397 ERROR oslo.messaging._drivers.common [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\\n    incoming.message))\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 88, in wrapped\\n    payload)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 71, in wrapped\\n    return f(self, context, *args, **kw)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 309, in decorated_function\\n    e, sys.exc_info())\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 296, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 4418, in check_can_live_migrate_destination\\n    block_migration, disk_over_commit)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4189, in check_can_live_migrate_destination\\n    self._compare_cpu(source_cpu_info)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4331, in _compare_cpu\\n    except libvirt.libvirtError as e:\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4327, in _compare_cpu\\n    m = _(\"CPU doesn\\'t have compatibility.\\\\n\\\\n%(ret)s\\\\n\\\\nRefer to %(u)s\")\\n', '  File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 179, in doit\\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\\n', '  File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 139, in proxy_call\\n    rv = execute(f,*args,**kwargs)\\n', '  File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 77, in tworker\\n    rv = meth(*args,**kwargs)\\n', '  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 3191, in compareCPU\\n    if ret == -1: raise libvirtError (\\'virConnectCompareCPU() failed\\', conn=self)\\n', \"libvirtError: XML error: CPU feature `lahf_lm' specified more than once\\n\"]", 
            "date_created": "2014-04-19 05:45:16.438869+00:00", 
            "author": "https://api.launchpad.net/1.0/~d0m0reg00dthing"
        }, 
        {
            "content": "Hi Jon,\n\nI can't duplicate this issue with my patch applied to the systems I have, it is successfully filtering out the duplicates on all 6 of my test systems.\n\nI've attached a small bit of code to test the point where I applied the patch.  This replicates a small section of the code from nova where it generates the list and causes the duplication I saw.\n\nIf this returns 1 and tells you it found a duplicate you'll need to verify the patch applied properly, then do some debugging.  The patch was generated against 2014.1.1.  For use in the cluster it will require all systems with nova-compute running to be patched.\n\nIf that returns clean but you still can't perform a live-migration you'll need dig a bit to figure out what's going on.  The first patch by Maximiliano should ensure that it filters the duplicate XML features no mater where they are generated.", 
            "date_created": "2014-04-24 18:57:44.407170+00:00", 
            "author": "https://api.launchpad.net/1.0/~nakato"
        }, 
        {
            "content": "Have you tried using https://review.openstack.org/#/c/65360/ ?\nThis should resolve the problem.", 
            "date_created": "2014-04-26 02:01:01.851377+00:00", 
            "author": "https://api.launchpad.net/1.0/~vladik-romanovsky"
        }, 
        {
            "content": "https://review.openstack.org/#/c/65360/ does not resolve this issue - The problem persists in Nova version 2014.1-0ubuntu1, which already includes this change.\n\nI can confirm that \"ensure_added_feature_is_unique.patch\" does fix the problem.", 
            "date_created": "2014-05-30 04:51:52.382943+00:00", 
            "author": "https://api.launchpad.net/1.0/~nerd65536"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/97782", 
            "date_created": "2014-06-04 13:13:31.129413+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/97782\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=60c899b9da8d64b4a5979b69c43c77ed9d5bf248\nSubmitter: Jenkins\nBranch:    master\n\ncommit 60c899b9da8d64b4a5979b69c43c77ed9d5bf248\nAuthor: Vladik Romanovsky <email address hidden>\nDate:   Tue Jun 3 14:58:06 2014 -0400\n\n    libvirt: convert cpu features attribute from list to a set\n    \n    Currently, the cpu features list which is being sent to libvirt,\n    when creating a domain or calling compareCPU, must contain only\n    unique entries. Multiple issues arise when we are updating the\n    features attribute in LibvirtConfigCPU class (for example during\n    migration).\n    \n    This change will change the features attribute from being a list\n    to a set. This make the LibvirtConfigCPU class keep only unique\n    features.\n    Adjusting the LibvirtConfigCPUFeature class to support set\n    operations by overriding the __eq__, __ne__ and __hash__\n    methods.\n    \n    Closes-Bug: #1303536\n    Change-Id: I6350fe0e827c860aea77cc4fe56f18f5c1483580\n", 
            "date_created": "2014-06-16 21:28:24.310586+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/100632", 
            "date_created": "2014-06-17 17:30:08.627977+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/100632\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=6b7cb1ae972da835cfdeaca6f3d5556cffe89ff3\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 6b7cb1ae972da835cfdeaca6f3d5556cffe89ff3\nAuthor: Vladik Romanovsky <email address hidden>\nDate:   Tue Jun 3 14:58:06 2014 -0400\n\n    libvirt: convert cpu features attribute from list to a set\n    \n    Currently, the cpu features list which is being sent to libvirt,\n    when creating a domain or calling compareCPU, must contain only\n    unique entries. Multiple issues arise when we are updating the\n    features attribute in LibvirtConfigCPU class (for example during\n    migration).\n    \n    This change will change the features attribute from being a list\n    to a set. This make the LibvirtConfigCPU class keep only unique\n    features.\n    Adjusting the LibvirtConfigCPUFeature class to support set\n    operations by overriding the __eq__, __ne__ and __hash__\n    methods.\n    \n    Closes-Bug: #1303536\n    Change-Id: I6350fe0e827c860aea77cc4fe56f18f5c1483580\n    Cherry-pick-x: 60c899b9da8d64b4a5979b69c43c77ed9d5bf248\n", 
            "date_created": "2014-08-19 20:07:04.612135+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}