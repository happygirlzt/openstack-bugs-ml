{
    "status": "Fix Released", 
    "last_updated": "2017-08-24 06:33:55.018854+00:00", 
    "description": "In my case, we had a chain of patches from https://review.openstack.org/#/q/topic:bug/1686116 backported to ocata downstream. Then, when detaching a ceph volume from a node, the following happens:\n\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] Traceback (most recent call last):\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 4835, in _driver_detach_volume\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] encryption=encryption)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1393, in detach_volume\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] live=live)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/guest.py\", line 413, in detach_device_with_retry\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] _try_detach_device(conf, persistent, live)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/guest.py\", line 407, in _try_detach_device\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] raise exception.DeviceNotFound(device=device)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in _exit_\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] self.force_reraise()\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] six.reraise(self.type_, self.value, self.tb)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/guest.py\", line 392, in _try_detach_device\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] self.detach_device(conf, persistent=persistent, live=live)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/guest.py\", line 449, in detach_device\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] self._domain.detachDeviceFlags(device_xml, flags=flags)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] result = proxy_call(self._autowrap, f, *args, **kwargs)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] rv = execute(f, *args, **kwargs)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] six.reraise(c, e, tb)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] rv = meth(*args, **kwargs)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 1190, in detachDeviceFlags\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] if ret == -1: raise libvirtError ('virDomainDetachDeviceFlags() failed', dom=self)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] libvirtError: XML error: Invalid PCI address 0000:00:00, at least one of domain, bus, or slot must be > 0\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604]\n\nHere is the instance xml bit for the volume:\n\n\u00a0\u00a0\u00a0\u00a0<disk type='network' device='disk'>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<driver name='qemu' type='raw' cache='none'/>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<auth username='volumes'>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<secret type='ceph' uuid='ce6d1549-4d63-476b-afb6-88f0b196414f'/>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0</auth>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<source protocol='rbd' name='volumes/volume-49bd8d30-96cb-455c-9b73-8dc67bf0e7fc'>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<host name='192.168.90.22' port='6789'/>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0</source>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<backingStore/>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<target dev='vdb' bus='virtio'/>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<serial>49bd8d30-96cb-455c-9b73-8dc67bf0e7fc</serial>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<alias name='virtio-disk1'/>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>\n\u00a0\u00a0\u00a0\u00a0</disk>\n\nAfter inserting some debug logs, the following xml gets passed to the libvirt's virDomainDetachDeviceFlags:\n\n    <disk type=\"network\" device=\"disk\">\n    \u00a0\u00a0<driver name=\"qemu\" type=\"raw\" cache=\"none\"/>\n    \u00a0\u00a0<source protocol=\"rbd\" name=\"volumes/volume-49bd8d30-96cb-455c-9b73-8dc67bf0e7fc\">\n\u00a0\u00a0\u00a0\u00a0    <host name=\"192.168.90.22\" port=\"6789\"/>\n    \u00a0\u00a0</source>\n    \u00a0\u00a0<target bus=\"virtio\" dev=\"vdb\"/>\n    \u00a0\u00a0<serial>49bd8d30-96cb-455c-9b73-8dc67bf0e7fc</serial>\n    \u00a0\u00a0<address type=\"pci\"/>\n    </disk>\n\nAfter introducing a proper format_dom method for LibvirtConfigGuestDeviceAddressPCI, things seem to be back to normal.", 
    "tags": [], 
    "importance": "High", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1709319", 
    "owner": "https://api.launchpad.net/1.0/~vdrok", 
    "id": 1709319, 
    "index": 2125, 
    "created": "2017-08-08 13:33:14.894803+00:00", 
    "title": "LibvirtConfigGuestDeviceAddressPCI missing format_dom method", 
    "comments": [
        {
            "content": "In my case, we had a chain of patches from https://review.openstack.org/#/q/topic:bug/1686116 backported to ocata downstream. Then, when detaching a ceph volume from a node, the following happens:\n\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] Traceback (most recent call last):\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 4835, in _driver_detach_volume\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] encryption=encryption)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1393, in detach_volume\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] live=live)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/guest.py\", line 413, in detach_device_with_retry\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] _try_detach_device(conf, persistent, live)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/guest.py\", line 407, in _try_detach_device\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] raise exception.DeviceNotFound(device=device)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in _exit_\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] self.force_reraise()\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] six.reraise(self.type_, self.value, self.tb)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/guest.py\", line 392, in _try_detach_device\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] self.detach_device(conf, persistent=persistent, live=live)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/guest.py\", line 449, in detach_device\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] self._domain.detachDeviceFlags(device_xml, flags=flags)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] result = proxy_call(self._autowrap, f, *args, **kwargs)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] rv = execute(f, *args, **kwargs)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] six.reraise(c, e, tb)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] rv = meth(*args, **kwargs)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 1190, in detachDeviceFlags\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] if ret == -1: raise libvirtError ('virDomainDetachDeviceFlags() failed', dom=self)\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604] libvirtError: XML error: Invalid PCI address 0000:00:00, at least one of domain, bus, or slot must be > 0\nnova/nova-compute.log.1:2017-07-31 00:21:24.261 341396 ERROR nova.compute.manager [instance: 43304a1b-bfcf-4e78-a9a0-eec1c6eff604]\n\nHere is the instance xml bit for the volume:\n\n    <disk type='network' device='disk'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <auth username='volumes'>\n        <secret type='ceph' uuid='ce6d1549-4d63-476b-afb6-88f0b196414f'/>\n      </auth>\n      <source protocol='rbd' name='volumes/volume-49bd8d30-96cb-455c-9b73-8dc67bf0e7fc'>\n        <host name='192.168.90.22' port='6789'/>\n      </source>\n      <backingStore/>\n      <target dev='vdb' bus='virtio'/>\n      <serial>49bd8d30-96cb-455c-9b73-8dc67bf0e7fc</serial>\n      <alias name='virtio-disk1'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>\n    </disk>\n\nAfter inserting some debug logs, the following xml gets passed to the libvirt:\n\n<disk type=\"network\" device=\"disk\">\n  <driver name=\"qemu\" type=\"raw\" cache=\"none\"/>\n  <source protocol=\"rbd\" name=\"volumes/volume-49bd8d30-96cb-455c-9b73-8dc67bf0e7fc\">\n    <host name=\"192.168.90.22\" port=\"6789\"/>\n  </source>\n  <target bus=\"virtio\" dev=\"vdb\"/>\n  <serial>49bd8d30-96cb-455c-9b73-8dc67bf0e7fc</serial>\n  <address type=\"pci\"/>\n</disk>\n\nAfter introducing a proper format_dom method for LibvirtConfigGuestDeviceAddressPCI, things seem to be back to normal.", 
            "date_created": "2017-08-08 13:33:14.894803+00:00", 
            "author": "https://api.launchpad.net/1.0/~vdrok"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/491822", 
            "date_created": "2017-08-08 14:21:19.430652+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/491822\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=376a902cabd548f1bcc7f7f7f8f98bd2dfa87c89\nSubmitter: Jenkins\nBranch:    master\n\ncommit 376a902cabd548f1bcc7f7f7f8f98bd2dfa87c89\nAuthor: Vladyslav Drok <email address hidden>\nDate:   Tue Aug 8 17:18:37 2017 +0300\n\n    Add format_dom for PCI device addresses\n    \n    In case of having a PCI device, its address can not be output\n    properly in the instance XML because of the missing format_dom\n    method. This change adds this method.\n    \n    Closes-Bug: #1709319\n    Change-Id: I1a8023ee6e8c85eed1c7c55a21f996371a0dd80a\n", 
            "date_created": "2017-08-10 18:25:39.537659+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0rc1 release candidate.", 
            "date_created": "2017-08-11 12:26:52.304136+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/495814", 
            "date_created": "2017-08-21 10:34:54.551223+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/495814\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=bcf110fe7ca2d989a956303313f413614e7a6548\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit bcf110fe7ca2d989a956303313f413614e7a6548\nAuthor: Vladyslav Drok <email address hidden>\nDate:   Tue Aug 8 17:18:37 2017 +0300\n\n    Add format_dom for PCI device addresses\n    \n    In case of having a PCI device, its address can not be output\n    properly in the instance XML because of the missing format_dom\n    method. This change adds this method.\n    \n    Closes-Bug: #1709319\n    Change-Id: I1a8023ee6e8c85eed1c7c55a21f996371a0dd80a\n    (cherry picked from commit 376a902cabd548f1bcc7f7f7f8f98bd2dfa87c89)\n", 
            "date_created": "2017-08-24 06:33:54.520774+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}