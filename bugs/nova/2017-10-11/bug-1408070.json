{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:18:33.145214+00:00", 
    "description": "The current version of Libvirt in the gate doesn't return mempages in numa\ncells. When requesting guest topology the instance is crashing with\nthe following:\n\n\n[instance: 730a2e16-c81c-44b6-b9b5-5c073feff9ce] Instance failed to spawn\nTraceback (most recent call last):\n  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2287, in _build_resources\n    yield resources\n  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2157, in _build_and_run_instance\n    flavor=flavor)\n  File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 2389, in spawn\n    flavor=flavor)\n  File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4063, in _get_guest_xml\n    context, flavor=flavor)\n  File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 3837, in _get_guest_config\n    instance.numa_topology, guest_numa_config.numatune)\n  File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 3782, in _get_guest_memory_backing_config\n    smallest = avail_pagesize[0]\nIndexError: list index out of range", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1408070", 
    "owner": "https://api.launchpad.net/1.0/~vladik-romanovsky", 
    "id": 1408070, 
    "index": 4124, 
    "created": "2015-01-06 19:22:33.833967+00:00", 
    "title": "Instance crashes when guest topology is being requested", 
    "comments": [
        {
            "content": "The current version of Libvirt in the gate doesn't return mempages in numa\ncells. When requesting guest topology the instance is crashing with\nthe following:\n\n\n[instance: 730a2e16-c81c-44b6-b9b5-5c073feff9ce] Instance failed to spawn\nTraceback (most recent call last):\n  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2287, in _build_resources\n    yield resources\n  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2157, in _build_and_run_instance\n    flavor=flavor)\n  File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 2389, in spawn\n    flavor=flavor)\n  File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4063, in _get_guest_xml\n    context, flavor=flavor)\n  File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 3837, in _get_guest_config\n    instance.numa_topology, guest_numa_config.numatune)\n  File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 3782, in _get_guest_memory_backing_config\n    smallest = avail_pagesize[0]\nIndexError: list index out of range", 
            "date_created": "2015-01-06 19:22:33.833967+00:00", 
            "author": "https://api.launchpad.net/1.0/~vladik-romanovsky"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/145312", 
            "date_created": "2015-01-06 19:35:59.251728+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The problem happens if running under a libvirt version less than 1.2.8", 
            "date_created": "2015-01-07 08:31:55.423839+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/145312\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3466e727546e0f7595378b8274254bed913f42ee\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3466e727546e0f7595378b8274254bed913f42ee\nAuthor: Vladik Romanovsky <email address hidden>\nDate:   Tue Jan 6 14:23:38 2015 -0500\n\n    libvirt: not setting membacking when mempages are empty host topology\n    \n    The current version of Libvirt in the gate doesn't return mempages in numa\n    cells. When requesting guest topology the instance is crashing.\n    Not setting the guest.membacking when libvirt version is less than the\n    required minimum\n    \n    Closes-Bug: #1408070\n    \n    Change-Id: Ib83062f413bf17e1fbfe2399348c3f5e1e703559\n", 
            "date_created": "2015-01-26 18:15:55.749866+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/159106", 
            "date_created": "2015-02-25 12:55:46.889358+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/159106\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=945ab28df04e22f3c1b8948972f538ee6b5e7410\nSubmitter: Jenkins\nBranch:    master\n\ncommit 945ab28df04e22f3c1b8948972f538ee6b5e7410\nAuthor: Daniel P. Berrange <email address hidden>\nDate:   Wed Feb 25 10:11:14 2015 +0000\n\n    libvirt: fix disablement of NUMA & hugepages on unsupported platforms\n    \n    Two previous commits updated the libvirt XML config generator so\n    that it would omit the config elements for huge pages and NUMA\n    placement when running on old libvirt:\n    \n      commit cf3a1262ecf12f4345326309c273722ebc26b466\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Wed Jan 28 00:54:26 2015 -0500\n    \n        libvirt: avoid setting the memnodes where when it's not a supported option\n    \n      commit 3466e727546e0f7595378b8274254bed913f42ee\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Tue Jan 6 14:23:38 2015 -0500\n    \n        libvirt: not setting membacking when mempages are empty host topology\n    \n    The problem arising from this is that the hosts are still reporting\n    to the schedular that they can support NUMA and huge pages if\n    libvirt >= 1.0.4, but we are silently discarding the guest config\n    if libvirt < 1.2.7 (numa) or 1.2.8 (huge pages).\n    \n    The result is that the schedular thinks the host can support the\n    requested feature and so places the guest there, but the actual\n    guest that is launched is missing the feature. So the user is not\n    getting what they requested.\n    \n    The correct approach is to update the \"_get_host_numa_topology\"\n    method so that it does not report any NUMA topology in the first\n    place, if the host is incapable of having guests configured in\n    the way Nova requires. Likewise if the host cannot support the\n    huge page configuration method required, it should not report\n    availability of huge pages.\n    \n    In summary, we are moving the version checks added by the two\n    commits above to the point at which host capability reporting\n    is done. We add a fatal error check in the guest XML config\n    generator methods, so that if there is some future schedular\n    bug causing it to not honour host capabilities, we see a\n    clear error instead of silently starting guests with the\n    wrong config.\n    \n    There is a further mistake in that a version number check alone\n    is insufficient. We must also check that the hypervisor is\n    either QEMU or KVM, to prevent the code paths running on Xen\n    or LXC.\n    \n    Closes-bug: #1425115\n    Related-bug: #1408070\n    Related-bug: #1415333\n    \n    Change-Id: I8326596696cbb030ae95d17f3dd430d05279081a\n", 
            "date_created": "2015-04-05 14:52:13.381878+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/159106\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=945ab28df04e22f3c1b8948972f538ee6b5e7410\nSubmitter: Jenkins\nBranch:    master\n\ncommit 945ab28df04e22f3c1b8948972f538ee6b5e7410\nAuthor: Daniel P. Berrange <email address hidden>\nDate:   Wed Feb 25 10:11:14 2015 +0000\n\n    libvirt: fix disablement of NUMA & hugepages on unsupported platforms\n    \n    Two previous commits updated the libvirt XML config generator so\n    that it would omit the config elements for huge pages and NUMA\n    placement when running on old libvirt:\n    \n      commit cf3a1262ecf12f4345326309c273722ebc26b466\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Wed Jan 28 00:54:26 2015 -0500\n    \n        libvirt: avoid setting the memnodes where when it's not a supported option\n    \n      commit 3466e727546e0f7595378b8274254bed913f42ee\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Tue Jan 6 14:23:38 2015 -0500\n    \n        libvirt: not setting membacking when mempages are empty host topology\n    \n    The problem arising from this is that the hosts are still reporting\n    to the schedular that they can support NUMA and huge pages if\n    libvirt >= 1.0.4, but we are silently discarding the guest config\n    if libvirt < 1.2.7 (numa) or 1.2.8 (huge pages).\n    \n    The result is that the schedular thinks the host can support the\n    requested feature and so places the guest there, but the actual\n    guest that is launched is missing the feature. So the user is not\n    getting what they requested.\n    \n    The correct approach is to update the \"_get_host_numa_topology\"\n    method so that it does not report any NUMA topology in the first\n    place, if the host is incapable of having guests configured in\n    the way Nova requires. Likewise if the host cannot support the\n    huge page configuration method required, it should not report\n    availability of huge pages.\n    \n    In summary, we are moving the version checks added by the two\n    commits above to the point at which host capability reporting\n    is done. We add a fatal error check in the guest XML config\n    generator methods, so that if there is some future schedular\n    bug causing it to not honour host capabilities, we see a\n    clear error instead of silently starting guests with the\n    wrong config.\n    \n    There is a further mistake in that a version number check alone\n    is insufficient. We must also check that the hypervisor is\n    either QEMU or KVM, to prevent the code paths running on Xen\n    or LXC.\n    \n    Closes-bug: #1425115\n    Related-bug: #1408070\n    Related-bug: #1415333\n    \n    Change-Id: I8326596696cbb030ae95d17f3dd430d05279081a\n", 
            "date_created": "2015-04-05 14:52:20.564159+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}