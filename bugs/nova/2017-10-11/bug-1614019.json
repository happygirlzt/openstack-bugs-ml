{
    "status": "Fix Released", 
    "last_updated": "2016-12-19 12:02:36.259468+00:00", 
    "description": "Instances lose its serial ports during soft-reboot if the instances experienced live-migration just before.\nTherefore we cannot access to the instance from serial console after soft-reboot.\n\nThat is because the method post_live_migration which defines the domain XML to libvirt on the destination host is calling the method get_guest_config instead of just retrieving the domain XML of the migrated and running guest.", 
    "tags": [
        "libvirt", 
        "live-migration"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1614019", 
    "owner": "https://api.launchpad.net/1.0/~sahid-ferdjaoui", 
    "id": 1614019, 
    "index": 1974, 
    "created": "2016-08-17 09:30:22.384303+00:00", 
    "title": "Instances lose its serial ports during soft-reboot after live-migration", 
    "comments": [
        {
            "content": "Instances lose its serial ports during soft-reboot if the instances experienced live-migration just before.\nTherefore we cannot access to the instance from serial console after soft-reboot.\n\nThat is because the method post_live_migration which defines the domain XML to libvirt on the destination host is calling the method get_guest_config instead of just retrieving the domain XML of the migrated and running guest.", 
            "date_created": "2016-08-17 09:30:22.384303+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/356335", 
            "date_created": "2016-08-17 09:35:07.158992+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/356335\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=dccaf9cb88705b2a635c5b54433c5e6187557849\nSubmitter: Jenkins\nBranch:    master\n\ncommit dccaf9cb88705b2a635c5b54433c5e6187557849\nAuthor: Sahid Orentino Ferdjaoui <email address hidden>\nDate:   Wed Aug 17 05:18:45 2016 -0400\n\n    libvirt: fix serial console not correctly defined after live-migration\n    \n    During post live migration the XML defined in libvirt does not contain\n    the definition of serial ports. That is because we call the method\n    get_guest_config_xml to retrieve the XML definition which is not going\n    to return a definition of serial ports because the instance already\n    define them. Actually calling this method to retrieve domain XML of an\n    instance is not good in every cases because the aim of that method is\n    to define a domain XML not to return a domain XML, for that purpose we\n    prefer to call XMLDesc(0).\n    \n    Also that commit is removing the process to write into a file the\n    domain XML which is not used anymore. libvirtd is storing the XML\n    definition of domains by itself (see: guest.write_instance_config())\n    \n    Closes-Bug: #1614019\n    Change-Id: I230031bba3926171a80ae773a98280ac5c61058b\n", 
            "date_created": "2016-10-14 14:55:40.334988+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/386676", 
            "date_created": "2016-10-14 16:06:48.196855+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I see issues when doing a nova reboot --hard of instance after live migration\n\n2016-10-28 07:55:21.733 94803 ERROR nova.compute.manager [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] [instance: 199c49e4-1855-470b-b7e3-39985eb26921] Cannot reboot instance: Unsupported VIF type binding_failed convert '_nova_to_osvif_vif_binding_failed'\n2016-10-28 07:55:21.738 94803 DEBUG oslo_messaging._drivers.amqpdriver [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] CALL msg_id: 2bcb98ba06d84b8cbc1926658710db3b exchange 'nova' topic 'conductor' _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:451\n2016-10-28 07:55:21.827 94803 DEBUG oslo_messaging._drivers.amqpdriver [-] received reply msg_id: 2bcb98ba06d84b8cbc1926658710db3b __call__ /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:299\n2016-10-28 07:55:21.831 94803 DEBUG oslo_messaging._drivers.amqpdriver [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] CALL msg_id: fd03581181e44657b838e1658441e798 exchange 'nova' topic 'conductor' _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:451\n2016-10-28 07:55:21.854 94803 DEBUG oslo_messaging._drivers.amqpdriver [-] received reply msg_id: fd03581181e44657b838e1658441e798 __call__ /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:299\n2016-10-28 07:55:21.856 94803 DEBUG oslo_messaging._drivers.amqpdriver [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] CALL msg_id: ba9b00cc1e90430681cbc0539c55a54a exchange 'nova' topic 'conductor' _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:451\n2016-10-28 07:55:21.875 94803 DEBUG oslo_messaging._drivers.amqpdriver [-] received reply msg_id: ba9b00cc1e90430681cbc0539c55a54a __call__ /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:299\n2016-10-28 07:55:21.883 94803 DEBUG oslo_messaging._drivers.amqpdriver [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] CALL msg_id: 1f8e09d179e04159b0d9c6fb78bb51b9 exchange 'nova' topic 'conductor' _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:451\n2016-10-28 07:55:21.993 94803 DEBUG oslo_messaging._drivers.amqpdriver [-] received reply msg_id: 1f8e09d179e04159b0d9c6fb78bb51b9 __call__ /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:299\n2016-10-28 07:55:22.000 94803 DEBUG oslo_concurrency.lockutils [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] Lock \"compute_resources\" acquired by \"nova.compute.resource_tracker.update_usage\" :: waited 0.000s inner /usr/local/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py:270\n2016-10-28 07:55:22.014 94803 DEBUG oslo_messaging._drivers.amqpdriver [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] CALL msg_id: f86891120b13448a9b56a71a8a9d77e7 exchange 'nova' topic 'conductor' _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:451\n2016-10-28 07:55:22.042 94803 DEBUG oslo_messaging._drivers.amqpdriver [-] received reply msg_id: f86891120b13448a9b56a71a8a9d77e7 __call__ /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:299\n2016-10-28 07:55:22.045 94803 DEBUG oslo_concurrency.lockutils [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] Lock \"compute_resources\" released by \"nova.compute.resource_tracker.update_usage\" :: held 0.046s inner /usr/local/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py:282\n2016-10-28 07:55:22.046 94803 INFO nova.compute.manager [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] [instance: 199c49e4-1855-470b-b7e3-39985eb26921] Successfully reverted task state from reboot_started_hard on failure for instance.\n2016-10-28 07:55:22.052 94803 DEBUG oslo_messaging._drivers.amqpdriver [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] CAST unique_id: e6f978a6a2d348a9a037b63ff30fad3f NOTIFY exchange 'nova' topic 'notifications.error' _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:435\n2016-10-28 07:55:22.076 94803 DEBUG oslo_messaging._drivers.amqpdriver [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] CAST unique_id: ad2abd67698a4062a0fa97987593af87 NOTIFY exchange 'nova' topic 'versioned_notifications.error' _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:435\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server [req-b4bb4ded-c569-4254-a761-af72da2729e1 admin admin] Exception during message handling\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server Traceback (most recent call last):\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 155, in _process_incoming\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     res = self.dispatcher.dispatch(message)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 225, in dispatch\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     return self._do_dispatch(endpoint, method, ctxt, args)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 195, in _do_dispatch\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     result = func(ctxt, **new_args)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/exception_wrapper.py\", line 75, in wrapped\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     function_name, call_dict, binary)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/exception_wrapper.py\", line 66, in wrapped\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     return f(self, context, *args, **kw)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/compute/manager.py\", line 188, in decorated_function\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     LOG.warning(msg, e, instance=instance)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/compute/manager.py\", line 157, in decorated_function\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     return function(self, context, *args, **kwargs)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/compute/utils.py\", line 664, in decorated_function\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     return function(self, context, *args, **kwargs)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/compute/manager.py\", line 216, in decorated_function\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     kwargs['instance'], e, sys.exc_info())\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/compute/manager.py\", line 204, in decorated_function\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     return function(self, context, *args, **kwargs)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/compute/manager.py\", line 2971, in reboot_instance\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     self._set_instance_obj_error_state(context, instance)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/compute/manager.py\", line 2952, in reboot_instance\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     bad_volumes_callback=bad_volumes_callback)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/virt/libvirt/driver.py\", line 2235, in reboot\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     block_device_info)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/virt/libvirt/driver.py\", line 2319, in _hard_reboot\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     block_device_info=block_device_info)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/virt/libvirt/driver.py\", line 4664, in _get_guest_xml\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     context)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/virt/libvirt/driver.py\", line 4498, in _get_guest_config\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     flavor, virt_type, self._host)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/virt/libvirt/vif.py\", line 507, in get_config\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     vif_obj = os_vif_util.nova_to_osvif_vif(vif)\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server   File \"/home/pcarlton/openstack/nova/nova/network/os_vif_util.py\", line 366, in nova_to_osvif_vif\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server     {'type': vif['type'], 'func': funcname})\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server NovaException: Unsupported VIF type binding_failed convert '_nova_to_osvif_vif_binding_failed'\n2016-10-28 07:55:22.090 94803 ERROR oslo_messaging.rpc.server \n", 
            "date_created": "2016-10-28 10:32:27.381589+00:00", 
            "author": "https://api.launchpad.net/1.0/~paul-carlton2"
        }, 
        {
            "content": "reverting this change fixes the issue", 
            "date_created": "2016-10-28 10:34:13.695185+00:00", 
            "author": "https://api.launchpad.net/1.0/~paul-carlton2"
        }, 
        {
            "content": "https://review.openstack.org/391418 to revert this change", 
            "date_created": "2016-10-28 10:51:36.620851+00:00", 
            "author": "https://api.launchpad.net/1.0/~paul-carlton2"
        }, 
        {
            "content": "cancel above, my bad it seems to work on a new xenial based devstack env.", 
            "date_created": "2016-11-03 10:00:59.722000+00:00", 
            "author": "https://api.launchpad.net/1.0/~paul-carlton2"
        }, 
        {
            "content": "Is this still an issue you can observe somewhere? If not, please mark it as invalid and please remove your -1 from https://review.openstack.org/#/c/386676/", 
            "date_created": "2016-11-04 10:03:33.602786+00:00", 
            "author": "https://api.launchpad.net/1.0/~pawel-koniszewski"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/386676\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=cbd2b8f0d590aaf2b736bc14a8a1d24d62d7a38f\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit cbd2b8f0d590aaf2b736bc14a8a1d24d62d7a38f\nAuthor: Sahid Orentino Ferdjaoui <email address hidden>\nDate:   Wed Aug 17 05:18:45 2016 -0400\n\n    libvirt: fix serial console not correctly defined after live-migration\n    \n    During post live migration the XML defined in libvirt does not contain\n    the definition of serial ports. That is because we call the method\n    get_guest_config_xml to retrieve the XML definition which is not going\n    to return a definition of serial ports because the instance already\n    define them. Actually calling this method to retrieve domain XML of an\n    instance is not good in every cases because the aim of that method is\n    to define a domain XML not to return a domain XML, for that purpose we\n    prefer to call XMLDesc(0).\n    \n    Also that commit is removing the process to write into a file the\n    domain XML which is not used anymore. libvirtd is storing the XML\n    definition of domains by itself (see: guest.write_instance_config())\n    \n    Closes-Bug: #1614019\n    Change-Id: I230031bba3926171a80ae773a98280ac5c61058b\n    (cherry picked from commit dccaf9cb88705b2a635c5b54433c5e6187557849)\n", 
            "date_created": "2016-11-11 22:24:22.433319+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b1 development milestone.", 
            "date_created": "2016-11-17 13:13:54.613699+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.3 release.", 
            "date_created": "2016-12-19 12:02:35.391999+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}