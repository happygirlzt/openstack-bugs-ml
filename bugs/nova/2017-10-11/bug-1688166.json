{
    "status": "Fix Released", 
    "last_updated": "2017-06-08 21:52:35.645715+00:00", 
    "description": "Description\n===========\n`cryptsetup` is not authorized to run with root permissions. The rootwrap filter for cryptsetup was recently removed from compute.filters [1], but it is still needed by dmcrypt [2].\n\nReferences:\n[1] https://github.com/openstack/nova/commit/9c23cdc247770830fa288f429ca7231eb431a3b2#diff-b01672c9be31a4fe1dd0921241a7ae15L234\n\n[2] https://github.com/openstack/nova/blob/master/nova/virt/libvirt/storage/dmcrypt.py\n\n\nSteps to reproduce\n==================\n\n1. Set up an LVM device:\nCreate a backing file:\n  $ truncate nova-lvm -s 2G\n\nMount the backing file on a loop device:\n  $ sudo losetup /dev/loop1 nova-lvm\n\nPrepare the device for LVM:\n  $ sudo pvcreate /dev/loop1\n\nCreate the LVM group on the loop device:\n  $ sudo vgcreate nova-lvm /dev/loop1\n\n2. Set up a devstack environment with ephemeral storage encryption enabled by adding the following lines to `lib/nova`:\n  iniset $NOVA_CONF ephemeral_storage_encryption enabled \"True\"\n  iniset $NOVA_CONF ephemeral_storage_encryption cipher \"aes-xts-plain64\"\n  iniset $NOVA_CONF ephemeral_storage_encryption key_size \"256\"\n  iniset $NOVA_CONF libvirt images_type \"lvm\"\n  iniset $NOVA_CONF libvirt images_volume_group \"nova-lvm\"\n\n3. Stack:\n  $ ./stack\n\n4. Use Nova to boot an instance:\n  $ nova boot --flavor 1 --image {image_id}\n\n---OR---\n\n4. Run Barbican Tempest tests:\n\n4a. Set up a Tempest environment:\n  $ pip install virtualenv\n  $ mkdir tempest-env\n  $ virtualenv tempest-env\n  $ cd tempest-env\n  $ source bin/activate\n\n4b. Install Tempest:\n  $ git clone http://git.openstack.org/openstack/tempest\n  $ bin/pip install tempest/\n\n4c. Install the Barbican Tempest plugin and oslotest:\n  $ git clone https://git.openstack.org/openstack/barbican-tempest-plugin\n  $ bin/pip install -e barbican-tempest-plugin/\n  $ bin/pip install oslotest\n\n4d. Run Barbican Tempest tests\n  $ testr run barbican_tempest_plugin\n\n\nExpected result\n===============\nInstance successfully boots.\n\n\nActual result\n=============\nInstance fails to boot.\n\nExample traceback (from `gate-barbican-simple-crypto-dsvm-tempest-ubuntu-xenial-nv` [1]):\n\n2017-04-30 16:17:41.576206 | Captured traceback:\n2017-04-30 16:17:41.576224 | ~~~~~~~~~~~~~~~~~~~\n2017-04-30 16:17:41.576246 |     Traceback (most recent call last):\n2017-04-30 16:17:41.576272 |       File \"tempest/test.py\", line 96, in wrapper\n2017-04-30 16:17:41.576298 |         return f(self, *func_args, **func_kwargs)\n2017-04-30 16:17:41.576362 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/barbican_tempest_plugin/tests/scenario/test_image_signing.py\", line 48, in test_signed_image_upload_and_boot\n2017-04-30 16:17:41.576382 |         wait_until='ACTIVE')\n2017-04-30 16:17:41.576437 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/barbican_tempest_plugin/tests/scenario/manager.py\", line 201, in create_server\n2017-04-30 16:17:41.576460 |         image_id=image_id, **kwargs)\n2017-04-30 16:17:41.576492 |       File \"tempest/common/compute.py\", line 206, in create_test_server\n2017-04-30 16:17:41.576510 |         server['id'])\n2017-04-30 16:17:41.576557 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-04-30 16:17:41.576577 |         self.force_reraise()\n2017-04-30 16:17:41.576626 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-04-30 16:17:41.576652 |         six.reraise(self.type_, self.value, self.tb)\n2017-04-30 16:17:41.576683 |       File \"tempest/common/compute.py\", line 188, in create_test_server\n2017-04-30 16:17:41.576711 |         clients.servers_client, server['id'], wait_until)\n2017-04-30 16:17:41.576742 |       File \"tempest/common/waiters.py\", line 76, in wait_for_server_status\n2017-04-30 16:17:41.576762 |         server_id=server_id)\n2017-04-30 16:17:41.576809 |     tempest.exceptions.BuildErrorException: Server b2fc6277-1f92-4466-a177-194fa7e8f0c3 failed to build and is in ERROR status\n2017-04-30 16:17:41.576926 |     Details: {u'message': u\"Build of instance b2fc6277-1f92-4466-a177-194fa7e8f0c3 aborted: Unexpected error while running command.\\nCommand: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup remove b2fc6277-1f92-4466-a177-194fa7e8f0c3_disk-dmcrypt\\nExit code: 99\\nStdout: u''\\nStder\", u'created': u'2017-04-30T16:16:50Z', u'code': 500}\n\n\n\nn-cpu log [2] indicates that cryptsetup is an unauthorized command:\n\n\n2017-04-30 16:16:43.530 19568 ERROR nova.virt.libvirt.storage.dmcrypt [req-2dcb6768-1edc-4ac7-b00d-7d081478abef tempest-ImageSigningTest-57730532 tempest-ImageSigningTest-57730532] Could not disconnect encrypted volume b2fc6277-1f92-4466-a177-194fa7e8f0c3_disk-dmcrypt. If dm-crypt device is still active it will have to be destroyed manually for cleanup to succeed.\n2017-04-30 16:16:43.532 19568 ERROR root [req-2dcb6768-1edc-4ac7-b00d-7d081478abef tempest-ImageSigningTest-57730532 tempest-ImageSigningTest-57730532] Original exception being dropped: ['Traceback (most recent call last):\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 745, in remove_volume_on_error\\n    yield\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 735, in create_image\\n    create_lvm_image(base, size)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py\", line 271, in inner\\n    return f(*args, **kwargs)\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 693, in create_lvm_image\\n    encrypt_lvm_image()\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 680, in encrypt_lvm_image\\n    key)\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/storage/dmcrypt.py\", line 64, in create_volume\\n    key = \\'\\'.join(map(lambda byte: \"%02x\" % byte, key))\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/storage/dmcrypt.py\", line 64, in <lambda>\\n    key = \\'\\'.join(map(lambda byte: \"%02x\" % byte, key))\\n', 'TypeError: %x format: a number is required, not str\\n']\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [req-2dcb6768-1edc-4ac7-b00d-7d081478abef tempest-ImageSigningTest-57730532 tempest-ImageSigningTest-57730532] [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Instance failed to spawn\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Traceback (most recent call last):\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2122, in _build_resources\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     yield resources\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1927, in _build_and_run_instance\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     block_device_info=block_device_info)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 2688, in spawn\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     block_device_info=block_device_info)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 3095, in _create_image\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     fallback_from_host)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 3211, in _create_and_inject_local_root\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     instance, size, fallback_from_host)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 6780, in _try_fetch_image_cache\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     size=size)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 227, in cache\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     *args, **kwargs)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 735, in create_image\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     create_lvm_image(base, size)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/usr/lib/python2.7/contextlib.py\", line 35, in __exit__\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     self.gen.throw(type, value, traceback)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 751, in remove_volume_on_error\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     dmcrypt.delete_volume(path.rpartition('/')[2])\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/storage/dmcrypt.py\", line 92, in delete_volume\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     \"cleanup to succeed.\"), {'volume': target})\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     self.force_reraise()\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     six.reraise(self.type_, self.value, self.tb)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/storage/dmcrypt.py\", line 79, in delete_volume\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     utils.execute('cryptsetup', 'remove', target, run_as_root=True)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/utils.py\", line 48, in execute\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     return utils.execute(*args, **kwargs)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/utils.py\", line 297, in execute\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     return RootwrapProcessHelper().execute(*cmd, **kwargs)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/utils.py\", line 180, in execute\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     return processutils.execute(*cmd, **kwargs)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\", line 400, in execute\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     cmd=sanitized_cmd)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] ProcessExecutionError: Unexpected error while running command.\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup remove b2fc6277-1f92-4466-a177-194fa7e8f0c3_disk-dmcrypt\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Exit code: 99\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Stdout: u''\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Stderr: u'/usr/local/bin/nova-rootwrap: Unauthorized command: cryptsetup remove b2fc6277-1f92-4466-a177-194fa7e8f0c3_disk-dmcrypt (no filter matched)\\n'\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]\n\n[1] http://logs.openstack.org/59/455459/17/check/gate-barbican-simple-crypto-dsvm-tempest-ubuntu-xenial-nv/26e8659/console.html#_2017-04-30_16_17_41_576206\n[2] http://logs.openstack.org/59/455459/17/check/gate-barbican-simple-crypto-dsvm-tempest-ubuntu-xenial-nv/26e8659/logs/screen-n-cpu.txt.gz#_2017-04-30_16_16_43_532\n\n\nEnvironment\n===========\nLatest `master` branch for all projects (including nova, castellan, and barbican), except for barbican-tempest-plugin (which has a patch [1] applied so that we can get past the error addressed by the patch).\n\n[1] https://review.openstack.org/#/c/446072/\n\n\nNotes\n=====\nYou will notice a TypeError in the n-cpu log output - I plan on reporting a separate bug for that.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1688166", 
    "owner": "https://api.launchpad.net/1.0/~jichenjc", 
    "id": 1688166, 
    "index": 4812, 
    "created": "2017-05-04 03:04:21.209480+00:00", 
    "title": "Missing rootwrap filter for cryptsetup", 
    "comments": [
        {
            "content": "Description\n===========\n`cryptsetup` is not authorized to run with root permissions. The rootwrap filter for cryptsetup was recently removed from compute.filters [1], but it is still needed by dmcrypt [2].\n\nReferences:\n[1] https://github.com/openstack/nova/commit/9c23cdc247770830fa288f429ca7231eb431a3b2#diff-b01672c9be31a4fe1dd0921241a7ae15L234\n\n[2] https://github.com/openstack/nova/blob/master/nova/virt/libvirt/storage/dmcrypt.py\n\n\nSteps to reproduce\n==================\n\n1. Set up an LVM device:\nCreate a backing file:\n  $ truncate nova-lvm -s 2G\n\nMount the backing file on a loop device:\n  $ sudo losetup /dev/loop1 nova-lvm\n\nPrepare the device for LVM:\n  $ sudo pvcreate /dev/loop1\n\nCreate the LVM group on the loop device:\n  $ sudo vgcreate nova-lvm /dev/loop1\n\n2. Set up a devstack environment with ephemeral storage encryption enabled by adding the following lines to `lib/nova`:\n  iniset $NOVA_CONF ephemeral_storage_encryption enabled \"True\"\n  iniset $NOVA_CONF ephemeral_storage_encryption cipher \"aes-xts-plain64\"\n  iniset $NOVA_CONF ephemeral_storage_encryption key_size \"256\"\n  iniset $NOVA_CONF libvirt images_type \"lvm\"\n  iniset $NOVA_CONF libvirt images_volume_group \"nova-lvm\"\n\n3. Stack:\n  $ ./stack\n\n4. Use Nova to boot an instance:\n  $ nova boot --flavor 1 --image {image_id}\n\n---OR---\n\n4. Run Barbican Tempest tests:\n\n4a. Set up a Tempest environment:\n  $ pip install virtualenv\n  $ mkdir tempest-env\n  $ virtualenv tempest-env\n  $ cd tempest-env\n  $ source bin/activate\n\n4b. Install Tempest:\n  $ git clone http://git.openstack.org/openstack/tempest\n  $ bin/pip install tempest/\n\n4c. Install the Barbican Tempest plugin and oslotest:\n  $ git clone https://git.openstack.org/openstack/barbican-tempest-plugin\n  $ bin/pip install -e barbican-tempest-plugin/\n  $ bin/pip install oslotest\n\n4d. Run Barbican Tempest tests\n  $ testr run barbican_tempest_plugin\n\n\nExpected result\n===============\nInstance successfully boots.\n\n\nActual result\n=============\nInstance fails to boot.\n\nExample traceback (from `gate-barbican-simple-crypto-dsvm-tempest-ubuntu-xenial-nv` [1]):\n\n2017-04-30 16:17:41.576206 | Captured traceback:\n2017-04-30 16:17:41.576224 | ~~~~~~~~~~~~~~~~~~~\n2017-04-30 16:17:41.576246 |     Traceback (most recent call last):\n2017-04-30 16:17:41.576272 |       File \"tempest/test.py\", line 96, in wrapper\n2017-04-30 16:17:41.576298 |         return f(self, *func_args, **func_kwargs)\n2017-04-30 16:17:41.576362 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/barbican_tempest_plugin/tests/scenario/test_image_signing.py\", line 48, in test_signed_image_upload_and_boot\n2017-04-30 16:17:41.576382 |         wait_until='ACTIVE')\n2017-04-30 16:17:41.576437 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/barbican_tempest_plugin/tests/scenario/manager.py\", line 201, in create_server\n2017-04-30 16:17:41.576460 |         image_id=image_id, **kwargs)\n2017-04-30 16:17:41.576492 |       File \"tempest/common/compute.py\", line 206, in create_test_server\n2017-04-30 16:17:41.576510 |         server['id'])\n2017-04-30 16:17:41.576557 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-04-30 16:17:41.576577 |         self.force_reraise()\n2017-04-30 16:17:41.576626 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-04-30 16:17:41.576652 |         six.reraise(self.type_, self.value, self.tb)\n2017-04-30 16:17:41.576683 |       File \"tempest/common/compute.py\", line 188, in create_test_server\n2017-04-30 16:17:41.576711 |         clients.servers_client, server['id'], wait_until)\n2017-04-30 16:17:41.576742 |       File \"tempest/common/waiters.py\", line 76, in wait_for_server_status\n2017-04-30 16:17:41.576762 |         server_id=server_id)\n2017-04-30 16:17:41.576809 |     tempest.exceptions.BuildErrorException: Server b2fc6277-1f92-4466-a177-194fa7e8f0c3 failed to build and is in ERROR status\n2017-04-30 16:17:41.576926 |     Details: {u'message': u\"Build of instance b2fc6277-1f92-4466-a177-194fa7e8f0c3 aborted: Unexpected error while running command.\\nCommand: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup remove b2fc6277-1f92-4466-a177-194fa7e8f0c3_disk-dmcrypt\\nExit code: 99\\nStdout: u''\\nStder\", u'created': u'2017-04-30T16:16:50Z', u'code': 500}\n\n\n\nn-cpu log [2] indicates that cryptsetup is an unauthorized command:\n\n\n2017-04-30 16:16:43.530 19568 ERROR nova.virt.libvirt.storage.dmcrypt [req-2dcb6768-1edc-4ac7-b00d-7d081478abef tempest-ImageSigningTest-57730532 tempest-ImageSigningTest-57730532] Could not disconnect encrypted volume b2fc6277-1f92-4466-a177-194fa7e8f0c3_disk-dmcrypt. If dm-crypt device is still active it will have to be destroyed manually for cleanup to succeed.\n2017-04-30 16:16:43.532 19568 ERROR root [req-2dcb6768-1edc-4ac7-b00d-7d081478abef tempest-ImageSigningTest-57730532 tempest-ImageSigningTest-57730532] Original exception being dropped: ['Traceback (most recent call last):\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 745, in remove_volume_on_error\\n    yield\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 735, in create_image\\n    create_lvm_image(base, size)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py\", line 271, in inner\\n    return f(*args, **kwargs)\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 693, in create_lvm_image\\n    encrypt_lvm_image()\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 680, in encrypt_lvm_image\\n    key)\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/storage/dmcrypt.py\", line 64, in create_volume\\n    key = \\'\\'.join(map(lambda byte: \"%02x\" % byte, key))\\n', '  File \"/opt/stack/new/nova/nova/virt/libvirt/storage/dmcrypt.py\", line 64, in <lambda>\\n    key = \\'\\'.join(map(lambda byte: \"%02x\" % byte, key))\\n', 'TypeError: %x format: a number is required, not str\\n']\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [req-2dcb6768-1edc-4ac7-b00d-7d081478abef tempest-ImageSigningTest-57730532 tempest-ImageSigningTest-57730532] [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Instance failed to spawn\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Traceback (most recent call last):\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2122, in _build_resources\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     yield resources\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1927, in _build_and_run_instance\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     block_device_info=block_device_info)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 2688, in spawn\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     block_device_info=block_device_info)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 3095, in _create_image\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     fallback_from_host)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 3211, in _create_and_inject_local_root\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     instance, size, fallback_from_host)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 6780, in _try_fetch_image_cache\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     size=size)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 227, in cache\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     *args, **kwargs)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 735, in create_image\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     create_lvm_image(base, size)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/usr/lib/python2.7/contextlib.py\", line 35, in __exit__\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     self.gen.throw(type, value, traceback)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/imagebackend.py\", line 751, in remove_volume_on_error\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     dmcrypt.delete_volume(path.rpartition('/')[2])\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/storage/dmcrypt.py\", line 92, in delete_volume\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     \"cleanup to succeed.\"), {'volume': target})\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     self.force_reraise()\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     six.reraise(self.type_, self.value, self.tb)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/storage/dmcrypt.py\", line 79, in delete_volume\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     utils.execute('cryptsetup', 'remove', target, run_as_root=True)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/virt/libvirt/utils.py\", line 48, in execute\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     return utils.execute(*args, **kwargs)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/utils.py\", line 297, in execute\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     return RootwrapProcessHelper().execute(*cmd, **kwargs)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/opt/stack/new/nova/nova/utils.py\", line 180, in execute\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     return processutils.execute(*cmd, **kwargs)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\", line 400, in execute\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]     cmd=sanitized_cmd)\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] ProcessExecutionError: Unexpected error while running command.\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup remove b2fc6277-1f92-4466-a177-194fa7e8f0c3_disk-dmcrypt\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Exit code: 99\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Stdout: u''\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3] Stderr: u'/usr/local/bin/nova-rootwrap: Unauthorized command: cryptsetup remove b2fc6277-1f92-4466-a177-194fa7e8f0c3_disk-dmcrypt (no filter matched)\\n'\n2017-04-30 16:16:43.532 19568 ERROR nova.compute.manager [instance: b2fc6277-1f92-4466-a177-194fa7e8f0c3]\n\n[1] http://logs.openstack.org/59/455459/17/check/gate-barbican-simple-crypto-dsvm-tempest-ubuntu-xenial-nv/26e8659/console.html#_2017-04-30_16_17_41_576206\n[2] http://logs.openstack.org/59/455459/17/check/gate-barbican-simple-crypto-dsvm-tempest-ubuntu-xenial-nv/26e8659/logs/screen-n-cpu.txt.gz#_2017-04-30_16_16_43_532\n\n\nEnvironment\n===========\nLatest `master` branch for all projects (including nova, castellan, and barbican), except for barbican-tempest-plugin (which has a patch [1] applied so that we can get past the error addressed by the patch).\n\n[1] https://review.openstack.org/#/c/446072/\n\n\nNotes\n=====\nYou will notice a TypeError in the n-cpu log output - I plan on reporting a separate bug for that.", 
            "date_created": "2017-05-04 03:04:21.209480+00:00", 
            "author": "https://api.launchpad.net/1.0/~jackie-truong"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/462348", 
            "date_created": "2017-05-04 03:18:45.163501+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/462348\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=a963aecb4ce91bbb2a2e1e6560e121bc295c36ff\nSubmitter: Jenkins\nBranch:    master\n\ncommit a963aecb4ce91bbb2a2e1e6560e121bc295c36ff\nAuthor: Jackie Truong <email address hidden>\nDate:   Wed May 3 23:11:32 2017 -0400\n\n    Add missing rootwrap filter for cryptsetup\n    \n    This change restores the rootwrap filter for cryptsetup that was\n    recently removed by I37ffc90c0bd57029fced251b5cfd7cd4318a0292 from\n    compute.filters, as it is still needed by dmcrypt.  Without the rootwrap\n    filter, `cryptsetup` is not authorized to run with root permissions.\n    \n    Change-Id: I5fe3e5d5e5a9694d0dbe5b59248e5eaf89858c62\n    Closes-Bug: #1688166\n", 
            "date_created": "2017-05-18 10:35:39.991899+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b2 development milestone.", 
            "date_created": "2017-06-08 21:52:35.422840+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}