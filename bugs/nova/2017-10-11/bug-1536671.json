{
    "status": "Fix Released", 
    "last_updated": "2016-03-03 16:20:12.025376+00:00", 
    "description": "I've started noticing a lot of these in the neutron job logs:\n\nhttp://logs.openstack.org/67/269867/4/check/gate-tempest-dsvm-neutron-src-os-brick/7617a9f/logs/screen-n-cpu.txt.gz#_2016-01-21_05_38_48_667\n\n2016-01-21 05:38:48.667 ERROR nova.virt.libvirt.driver [req-c8971f87-303e-460b-894b-7e2ccde9944f nova service] [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d] detaching network adapter failed.\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d] Traceback (most recent call last):\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 1354, in detach_interface\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     guest.detach_device(cfg, persistent=True, live=live)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/opt/stack/new/nova/nova/virt/libvirt/guest.py\", line 341, in detach_device\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     self._domain.detachDeviceFlags(conf.to_xml(), flags=flags)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     rv = execute(f, *args, **kwargs)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     six.reraise(c, e, tb)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     rv = meth(*args, **kwargs)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 985, in detachDeviceFlags\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     if ret == -1: raise libvirtError ('virDomainDetachDeviceFlags() failed', dom=self)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d] libvirtError: operation failed: no matching network device was found\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d] \n\nFollowing the request ID, it's coming from a neutron vif deleted event:\n\nhttp://logs.openstack.org/67/269867/4/check/gate-tempest-dsvm-neutron-src-os-brick/7617a9f/logs/screen-n-cpu.txt.gz#_2016-01-21_05_38_48_361\n\nIt looks like we should just handle and not log that network device not found as an error, but libvirt doesn't provide a specific error code for that case:\n\nhttp://libvirt.org/git/?p=libvirt.git;a=blob;f=src/qemu/qemu_driver.c;h=e04a32841807851fd1386ab8a7fd91672f114dce;hb=e8684eb541f01df9b45e87e0a8ce446c7bc90a17#l6764\n\nAnd the error message is translatable so we can't just parse the message either.\n\nIt seems there should be a way to verify that the network device exists before we try to detach it from the config so we can avoid this error which doesn't actually result in job failures (it's probably happening during an instance delete asynchronously where we're deleting the ports in neutron).\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22Caught%20error%3A%20%3Ctype%20'exceptions.AttributeError'%3E%20'module'%20object%20has%20no%20attribute%20'ServiceList'%5C%22%20AND%20tags%3A%5C%22screen-c-api.txt%5C%22&from=7d", 
    "tags": [
        "libvirt", 
        "network", 
        "neutron"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1536671", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1536671, 
    "index": 4432, 
    "created": "2016-01-21 15:00:50.383659+00:00", 
    "title": "libvirt detach_interface logs errors for network device not found after neutron network-vif-deleted event", 
    "comments": [
        {
            "content": "I've started noticing a lot of these in the neutron job logs:\n\nhttp://logs.openstack.org/67/269867/4/check/gate-tempest-dsvm-neutron-src-os-brick/7617a9f/logs/screen-n-cpu.txt.gz#_2016-01-21_05_38_48_667\n\n2016-01-21 05:38:48.667 ERROR nova.virt.libvirt.driver [req-c8971f87-303e-460b-894b-7e2ccde9944f nova service] [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d] detaching network adapter failed.\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d] Traceback (most recent call last):\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 1354, in detach_interface\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     guest.detach_device(cfg, persistent=True, live=live)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/opt/stack/new/nova/nova/virt/libvirt/guest.py\", line 341, in detach_device\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     self._domain.detachDeviceFlags(conf.to_xml(), flags=flags)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     rv = execute(f, *args, **kwargs)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     six.reraise(c, e, tb)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     rv = meth(*args, **kwargs)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]   File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 985, in detachDeviceFlags\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d]     if ret == -1: raise libvirtError ('virDomainDetachDeviceFlags() failed', dom=self)\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d] libvirtError: operation failed: no matching network device was found\n2016-01-21 05:38:48.667 12834 ERROR nova.virt.libvirt.driver [instance: d8d15c87-79cc-4b63-99bb-64dde4576b3d] \n\nFollowing the request ID, it's coming from a neutron vif deleted event:\n\nhttp://logs.openstack.org/67/269867/4/check/gate-tempest-dsvm-neutron-src-os-brick/7617a9f/logs/screen-n-cpu.txt.gz#_2016-01-21_05_38_48_361\n\nIt looks like we should just handle and not log that network device not found as an error, but libvirt doesn't provide a specific error code for that case:\n\nhttp://libvirt.org/git/?p=libvirt.git;a=blob;f=src/qemu/qemu_driver.c;h=e04a32841807851fd1386ab8a7fd91672f114dce;hb=e8684eb541f01df9b45e87e0a8ce446c7bc90a17#l6764\n\nAnd the error message is translatable so we can't just parse the message either.\n\nIt seems there should be a way to verify that the network device exists before we try to detach it from the config so we can avoid this error which doesn't actually result in job failures (it's probably happening during an instance delete asynchronously where we're deleting the ports in neutron).\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22Caught%20error%3A%20%3Ctype%20'exceptions.AttributeError'%3E%20'module'%20object%20has%20no%20attribute%20'ServiceList'%5C%22%20AND%20tags%3A%5C%22screen-c-api.txt%5C%22&from=7d", 
            "date_created": "2016-01-21 15:00:50.383659+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "> It seems there should be a way to verify that the network device exists \n\nYou can query the guest XML to see if it exists as that should reflect current state", 
            "date_created": "2016-01-21 15:03:57.395385+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }, 
        {
            "content": "I noticed that the device is deleted 4 seconds earlier:\n\nhttp://logs.openstack.org/67/269867/4/check/gate-tempest-dsvm-neutron-src-os-brick/7617a9f/logs/screen-n-cpu.txt.gz#_2016-01-21_05_38_44_455", 
            "date_created": "2016-01-21 15:05:05.314775+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/270891", 
            "date_created": "2016-01-21 16:19:31.130304+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/270981", 
            "date_created": "2016-01-21 18:59:24.026570+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/270981\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=6e6a8816083c0172988a26e70da027e6f9501db6\nSubmitter: Jenkins\nBranch:    master\n\ncommit 6e6a8816083c0172988a26e70da027e6f9501db6\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu Jan 21 10:53:06 2016 -0800\n\n    libvirt: implement LibvirtConfigGuestInterface.parse_dom\n    \n    This is needed by a follow on change that needs to find an\n    interface in the config by a given MAC address.\n    \n    Change-Id: I6b9ab20570e1db832cc2eec94cbf69dddf4ef3d6\n    Partial-Bug: #1536671\n", 
            "date_created": "2016-02-20 00:23:26.618350+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/270891\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b3624e00d0097dd7ccdf27e34d7351c0c97afea1\nSubmitter: Jenkins\nBranch:    master\n\ncommit b3624e00d0097dd7ccdf27e34d7351c0c97afea1\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu Jan 21 08:15:27 2016 -0800\n\n    libvirt: check for interface when detach_interface fails\n    \n    When using Neutron and deleting an instance, we race against\n    deleting the domain and Neutron sending a vif-deleted event\n    which triggers a call to detach_interface. If the network\n    device is not found when we go to detach it from the config,\n    libvirt raises an error like:\n    \n    libvirtError: operation failed: no matching network device was found\n    \n    Unfortunately libvirt does not have a unique error code for this\n    and the error message is translatable, so we can't key off of it\n    to check if the failure is just due to the device not being found.\n    \n    This change adds a method to the guest object to lookup the interface\n    device config by MAC address and if not found, we simply log a warning\n    rather than tracing an error for a case that we can expect when using\n    Neutron.\n    \n    Closes-Bug: #1536671\n    \n    Change-Id: I8ae352ff3eeb760c97d1a6fa9d7a59e881d7aea1\n", 
            "date_created": "2016-02-22 19:41:39.764118+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.0.0.0b3 development milestone.", 
            "date_created": "2016-03-03 16:20:11.243289+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }
    ]
}