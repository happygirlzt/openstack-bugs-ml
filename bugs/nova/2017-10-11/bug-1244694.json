{
    "status": "Invalid", 
    "last_updated": "2014-12-05 06:35:25.451595+00:00", 
    "description": "---- SRU Justification ---\n\n[Impact]\n\nIn a libvirt-based OpenStack deployment, Nova fails to snapshot instances, failing with error:\n\ninternal error: unable to execute QEMU command 'drive-mirror': Could not open '/var/lib/nova/instances/snapshots/tmp5DdrIO/236df3e170e64fabaeb3c7601e2d6c47.delta'\n\nI had originally discovered this bug using the Tempset test suite while verifying an unrelated OpenStack SRU, but other users are experiencing this in the wild.\n\n[Test Case]\n\nDeploy an OpenStack cloud based on Ubuntu Saucy and OpenStack Havana, then attempt to snapshot a running instance.  The Tempest integration test suite contains a snapshot test case: tempest.api.compute.images.test_images_oneserver.ImagesOneServerTestJSON.test_create_delete_image [1]\n\n[Regression Potential]\n\nThe proposed fix is isolated to the libvirt packaging and simply appends an additional directory exception to the packages apparmor configuration, so that libvirt has appropriate access to the directory used during the process of snapshotting an instance.\n\n\n[1]https://github.com/openstack/tempest/blob/master/tempest/api/compute/images/test_images_oneserver.py#L92\n\n\n\n--- Original Bug ---\n\n\nIn some cases (not for all instances, just for some) the following error prevents creating the snapshot:\n\n2013-10-25 14:49:30.724 22980 AUDIT nova.compute.manager [req-6e9326d7-64df-40f7-bc81-190ec5234de2 657f1aca48d24eaf9655e0b77b2bc6d9 35b2b08cc3f44a538cf3535043793a2a] [instance: db9c8a72-6ce2-41b7-8f7a-be0be8468667] instance snapshotting\n2013-10-25 14:49:30.944 22980 INFO nova.virt.libvirt.driver [req-6e9326d7-64df-40f7-bc81-190ec5234de2 657f1aca48d24eaf9655e0b77b2bc6d9 35b2b08cc3f44a538cf3535043793a2a] [instance: db9c8a72-6ce2-41b7-8f7a-be0be8468667] Beginning live snapshot process\n2013-10-25 14:49:32.006 22980 INFO nova.virt.libvirt.driver [req-6e9326d7-64df-40f7-bc81-190ec5234de2 657f1aca48d24eaf9655e0b77b2bc6d9 35b2b08cc3f44a538cf3535043793a2a] [instance: db9c8a72-6ce2-41b7-8f7a-be0be8468667] Snapshot extracted, beginning image upload\n2013-10-25 14:49:32.329 22980 ERROR nova.openstack.common.rpc.amqp [req-6e9326d7-64df-40f7-bc81-190ec5234de2 657f1aca48d24eaf9655e0b77b2bc6d9 35b2b08cc3f44a538cf3535043793a2a] Exception during message handling\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 353, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 90, in wrapped\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 73, in wrapped\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 243, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     pass\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 229, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 271, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 258, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 319, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     % image_id, instance=instance)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 309, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     *args, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2293, in snapshot_instance\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     task_states.IMAGE_SNAPSHOT)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2324, in _snapshot_instance\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     update_task_state)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1397, in snapshot\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     image_format)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1483, in _live_snapshot\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     libvirt.VIR_DOMAIN_BLOCK_REBASE_SHALLOW)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 179, in doit\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 139, in proxy_call\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     rv = execute(f,*args,**kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 77, in tworker\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     rv = meth(*args,**kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 646, in blockRebase\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     if ret == -1: raise libvirtError ('virDomainBlockRebase() failed', dom=self)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp libvirtError: internal error: unable to execute QEMU command 'drive-mirror': Could not open '/var/lib/nova/instances/snapshots/tmp5DdrIO/236df3e170e64fabaeb3c7601e2d6c47.delta'\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp\n\nThe directory /var/lib/nova/instances/snapshots/tmp5DdrIO does not exist immidiately after this error shows up.\nPermissions to the parent directory are nova:nova 755, I believe they are correct.\n\nPackage: nova-compute\nVersion: 1:2013.2-0ubuntu1~cloud0", 
    "tags": [
        "libvirt", 
        "verification-needed"
    ], 
    "importance": "Undecided", 
    "heat": 42, 
    "link": "https://bugs.launchpad.net/nova/+bug/1244694", 
    "owner": "None", 
    "id": 1244694, 
    "index": 4234, 
    "created": "2013-10-25 14:57:36.310446+00:00", 
    "title": "[SRU] Creating snapshot fails due to nonexistent temporary directory", 
    "comments": [
        {
            "content": "In some cases (not for all instances, just for some) the following error prevents creating the snapshot:\n\n2013-10-25 14:49:30.724 22980 AUDIT nova.compute.manager [req-6e9326d7-64df-40f7-bc81-190ec5234de2 657f1aca48d24eaf9655e0b77b2bc6d9 35b2b08cc3f44a538cf3535043793a2a] [instance: db9c8a72-6ce2-41b7-8f7a-be0be8468667] instance snapshotting\n2013-10-25 14:49:30.944 22980 INFO nova.virt.libvirt.driver [req-6e9326d7-64df-40f7-bc81-190ec5234de2 657f1aca48d24eaf9655e0b77b2bc6d9 35b2b08cc3f44a538cf3535043793a2a] [instance: db9c8a72-6ce2-41b7-8f7a-be0be8468667] Beginning live snapshot process\n2013-10-25 14:49:32.006 22980 INFO nova.virt.libvirt.driver [req-6e9326d7-64df-40f7-bc81-190ec5234de2 657f1aca48d24eaf9655e0b77b2bc6d9 35b2b08cc3f44a538cf3535043793a2a] [instance: db9c8a72-6ce2-41b7-8f7a-be0be8468667] Snapshot extracted, beginning image upload\n2013-10-25 14:49:32.329 22980 ERROR nova.openstack.common.rpc.amqp [req-6e9326d7-64df-40f7-bc81-190ec5234de2 657f1aca48d24eaf9655e0b77b2bc6d9 35b2b08cc3f44a538cf3535043793a2a] Exception during message handling\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 353, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 90, in wrapped\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 73, in wrapped\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 243, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     pass\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 229, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 271, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 258, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 319, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     % image_id, instance=instance)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 309, in decorated_function\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     *args, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2293, in snapshot_instance\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     task_states.IMAGE_SNAPSHOT)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2324, in _snapshot_instance\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     update_task_state)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1397, in snapshot\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     image_format)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1483, in _live_snapshot\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     libvirt.VIR_DOMAIN_BLOCK_REBASE_SHALLOW)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 179, in doit\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 139, in proxy_call\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     rv = execute(f,*args,**kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 77, in tworker\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     rv = meth(*args,**kwargs)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 646, in blockRebase\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp     if ret == -1: raise libvirtError ('virDomainBlockRebase() failed', dom=self)\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp libvirtError: internal error: unable to execute QEMU command 'drive-mirror': Could not open '/var/lib/nova/instances/snapshots/tmp5DdrIO/236df3e170e64fabaeb3c7601e2d6c47.delta'\n2013-10-25 14:49:32.329 22980 TRACE nova.openstack.common.rpc.amqp \n\n\nThe directory /var/lib/nova/instances/snapshots/tmp5DdrIO does not exist immidiately after this error shows up.\nPermissions to the parent directory are nova:nova 755, I believe they are correct.\n\nPackage: nova-compute \nVersion: 1:2013.2-0ubuntu1~cloud0", 
            "date_created": "2013-10-25 14:57:36.310446+00:00", 
            "author": "https://api.launchpad.net/1.0/~dasp"
        }, 
        {
            "content": "Creating a snapshot of the same instance on the same physical node when the instance is shut off works.", 
            "date_created": "2013-10-25 15:05:37.430451+00:00", 
            "author": "https://api.launchpad.net/1.0/~dasp"
        }, 
        {
            "content": "I'm having the same problem - I had a working Havana setup (with Ceph/rbd as the cinder storage) and within the last few days, whammo, this starts occuring. I had updated ubuntu 13.10 patches across parts of the cluster.\n\nnova-compute log from the node with the exception below\n\n2013-11-03 08:37:03.487 1796 ERROR nova.openstack.common.rpc.amqp [req-16923a1f-cf2b-43fb-bf81-3cdceb698fb0 f2b1d092d8144d\\\n17aa1c51eecfd067bb 305f4fa9adcc48b09b8d07df5b247df7] Exception during message handling\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/\\\ncommon/rpc/amqp.py\", line 461, in _process_data\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/\\\ncommon/rpc/dispatcher.py\", line 172, in dispatch\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/ma\\\nnager.py\", line 353, in decorated_function\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.\\\npy\", line 90, in wrapped\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.\\\npy\", line 73, in wrapped\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/ma\\\nnager.py\", line 243, in decorated_function\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     pass\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/ma\\\nnager.py\", line 229, in decorated_function\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/ma\\\nnager.py\", line 271, in decorated_function\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/ma\\\nnager.py\", line 258, in decorated_function\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/ma\\\nnager.py\", line 319, in decorated_function\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     % image_id, instance=instance)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/ma\\\nnager.py\", line 309, in decorated_function\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     *args, **kwargs)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/ma\\\nnager.py\", line 2293, in snapshot_instance\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     task_states.IMAGE_SNAPSHOT)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/ma\\\nnager.py\", line 2324, in _snapshot_instance\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     update_task_state)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvi\\\nrt/driver.py\", line 1397, in snapshot\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     image_format)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvi\\\nrt/driver.py\", line 1483, in _live_snapshot\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     libvirt.VIR_DOMAIN_BLOCK_REBASE_SHALLOW)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.\\\npy\", line 179, in doit\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     result = proxy_call(self._autowrap, f, *args, **kwar\\\ngs)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.\\\npy\", line 139, in proxy_call\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     rv = execute(f,*args,**kwargs)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.\\\npy\", line 77, in tworker\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     rv = meth(*args,**kwargs)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", li\\\nne 646, in blockRebase\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp     if ret == -1: raise libvirtError ('virDomainBlockReb\\\nase() failed', dom=self)\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp libvirtError: internal error: unable to execute QEMU com\\\nmand 'drive-mirror': Could not open '/var/lib/nova/instances/snapshots/tmpxjLiuV/e86ce8b372f14540baa109c5cda07f62.delta'\n2013-11-03 08:37:03.487 1796 TRACE nova.openstack.common.rpc.amqp\n", 
            "date_created": "2013-11-03 15:47:56.528423+00:00", 
            "author": "https://api.launchpad.net/1.0/~grunwald"
        }, 
        {
            "content": "Status changed to 'Confirmed' because the bug affects multiple users.", 
            "date_created": "2013-11-05 18:35:35.764469+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }, 
        {
            "content": "In my previous comment, I mentioned that this was a Havana install - that's incorrect. It's grizzley from Ubuntu 13.10.\n\nDaniel Speichert (dasp), did you check the contents of the snapshot that you were able to make when the system was shut off? I too was able to make a snapshot, but I had modified /etc/apt/sources.list prior to sync'ing and shutting the virtualized system. When I booted up the original server image, the changes to /etc/apt/sources.list were still in the virtualized system. But, when I shut it down, took a snapshot and booted from the snapshot, the contents had reverted to the original contents of /etc/apt/sources.list -- i.e. it appeared that the snapshot was using the underlying volume and not the modifications to the booted image.\n\nI have no idea why this occurs, but wanted to see if you had a similar experience with your setup?", 
            "date_created": "2013-11-05 18:40:09.509353+00:00", 
            "author": "https://api.launchpad.net/1.0/~grunwald"
        }, 
        {
            "content": "double checking indicates that this may be specific to e.g. /etc/apt/sources.list -- it might be that the image I'm using resets that. I created a file (/foobar/baz), snapped and booted from the snap. The /etc/apt/sources.list was reset to default mirror (http://nova.clouds.archive.ubuntu.com/ubuntu/) but the /foobar/baz directory was there & the package updates I had applied were also there.\n\nSo, it's just the issue of not being able to do a snap of a running system.", 
            "date_created": "2013-11-05 20:02:19.628306+00:00", 
            "author": "https://api.launchpad.net/1.0/~grunwald"
        }, 
        {
            "content": "Daniel Speichert (dasp) - were you using a ceph/RBD backend?\n\nWere you trying to snapshot a QCOW image? Try it with a RAW.\nOpenstack has issues snapping QCOW (I think there's a cinder bug filed on this).\n\nI can create a snapshow of RAW images and create a volume from that snapshot.\nI can not, however, boot directly from the snap-shotted image.", 
            "date_created": "2013-11-10 18:18:58.846435+00:00", 
            "author": "https://api.launchpad.net/1.0/~grunwald"
        }, 
        {
            "content": "Dirk,\nI am not using ceph, I'm using shared NFS storage at /var/lib/nova/instances only.\n\nAll the snapshots we do are of QCOW2 images. OpenStack by default converts all images to QCOW2 when you run an instance from them.\nWe had QCOW snapshots working perfectly in Grizzly, it only stopped working in Havana.\n\nAs a result of above, we can not create any snapshot so I don't know if we would have any problems to boot from them. We can boot properly from snapshots created before upgrade.", 
            "date_created": "2013-11-10 21:19:43.393458+00:00", 
            "author": "https://api.launchpad.net/1.0/~dasp"
        }, 
        {
            "content": "Hello, we have the same problem. I found logentries in syslog.\n\nfor example:\n\nkernel: [866752.543340] type=1400 audit(1384526598.408:216): apparmor=\"DENIED\" operation=\"open\" parent=28895 profile=\"/usr/lib/libvirt/virt-aa-helper\" name=\"/var/lib/nova/instances/snapshots/tmpCqBRJZ/ac7c0eb07b474579a02775ce9cd4301c.delta\" pid=17696 comm=\"virt-aa-helper\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=109\n\nMaybe the apparmor-profile /etc/apparmor.d/usr.lib.libvirt.virt-aa-helper should be extended, or how does this work at runtime !?\n\n/**.delta r, or something like that\n\n", 
            "date_created": "2013-11-15 15:12:18.410467+00:00", 
            "author": "https://api.launchpad.net/1.0/~tis-x"
        }, 
        {
            "content": "Another logentry points to the dynamic-profiles\n\n[868559.234898] type=1400 audit(1384528406.841:246): apparmor=\"DENIED\" operation=\"open\" parent=1 profile=\"libvirt-7aa8a408-8ca0-46b3-8ab8-e89b334082d2\" name=\"/var/lib/nova/instances/snapshots/tmpflKt2v/9f52ec7cb15d458488df1a1efad52d9c.delta\" pid=7957 comm=\"qemu-system-x86\" requested_mask=\"rw\" denied_mask=\"rw\" fsuid=110 ouid=110", 
            "date_created": "2013-11-15 15:15:24.136266+00:00", 
            "author": "https://api.launchpad.net/1.0/~tis-x"
        }, 
        {
            "content": "Disabling apparmor didn't help in our case. Did you try disabling it?", 
            "date_created": "2013-11-15 15:53:56.797514+00:00", 
            "author": "https://api.launchpad.net/1.0/~dasp"
        }, 
        {
            "content": "I set the dynamic profile \n\naa-complain libvirt-7aa8a408-8ca0-46b3-8ab8-e89b334082d2\n\nand shut-off and start the instance. After that i get an snapshot\n", 
            "date_created": "2013-11-15 18:53:54.450386+00:00", 
            "author": "https://api.launchpad.net/1.0/~tis-x"
        }, 
        {
            "content": "Ok. I can reproduce the problem. If i enforce the profile and restart the machine. The snapshot fails. The profile seems to be ok:\n\nBefore snapshot:\n# DO NOT EDIT THIS FILE DIRECTLY. IT IS MANAGED BY LIBVIRT.\n  \"/var/log/libvirt/**/instance-0000001e.log\" w,\n  \"/var/lib/libvirt/**/instance-0000001e.monitor\" rw,\n  \"/var/run/libvirt/**/instance-0000001e.pid\" rwk,\n  \"/run/libvirt/**/instance-0000001e.pid\" rwk,\n  \"/var/run/libvirt/**/*.tunnelmigrate.dest.instance-0000001e\" rw,\n  \"/run/libvirt/**/*.tunnelmigrate.dest.instance-0000001e\" rw,\n  \"/var/lib/nova/instances/7aa8a408-8ca0-46b3-8ab8-e89b334082d2/disk\" rw,\n  \"/var/lib/nova/instances/_base/50c5b15302a6962ee9f93d2e70ce27fedce888ed\" r,\n  # don't audit writes to readonly files\n  deny \"/var/lib/nova/instances/_base/50c5b15302a6962ee9f93d2e70ce27fedce888ed\" w,\n  \"/var/lib/nova/instances/7aa8a408-8ca0-46b3-8ab8-e89b334082d2/console.log\" rw,\n  \"/var/lib/nova/instances/7aa8a408-8ca0-46b3-8ab8-e89b334082d2/console.log\" rw,\n\nAfter snapshot:\n# DO NOT EDIT THIS FILE DIRECTLY. IT IS MANAGED BY LIBVIRT.\n  \"/var/log/libvirt/**/instance-0000001e.log\" w,\n  \"/var/lib/libvirt/**/instance-0000001e.monitor\" rw,\n  \"/var/run/libvirt/**/instance-0000001e.pid\" rwk,\n  \"/run/libvirt/**/instance-0000001e.pid\" rwk,\n  \"/var/run/libvirt/**/*.tunnelmigrate.dest.instance-0000001e\" rw,\n  \"/run/libvirt/**/*.tunnelmigrate.dest.instance-0000001e\" rw,\n  \"/var/lib/nova/instances/snapshots/tmpZzbTj8/9ce55aae608343b987a3b287da39cc59.delta\" rw,\n  \"/var/lib/nova/instances/7aa8a408-8ca0-46b3-8ab8-e89b334082d2/console.log\" rw,\n  \"/var/lib/nova/instances/7aa8a408-8ca0-46b3-8ab8-e89b334082d2/console.log\" rw,\n\nIs this an racecondition? Maybe the profile is replaced/reloaded to late in an parrallel task?", 
            "date_created": "2013-11-15 19:06:17.725778+00:00", 
            "author": "https://api.launchpad.net/1.0/~tis-x"
        }, 
        {
            "content": "I added the following line to abstractions/libvirt-qemu:\n\n/var/lib/nova/instances/snapshots/*/*.delta rw,\n\nThis is not very secure but at the moment it work. Keep in mind, i have to restart the kvm-process to apply the new/reloaded profile.", 
            "date_created": "2013-11-15 19:10:27.616083+00:00", 
            "author": "https://api.launchpad.net/1.0/~tis-x"
        }, 
        {
            "content": "I concur that the apparmor solution works. I haven't tried to figure out if it's a race or not.\n\nIs this an OpenStack issue or an Ubuntu issue? Sounds like OpenStack to me.", 
            "date_created": "2013-11-20 19:55:24.050432+00:00", 
            "author": "https://api.launchpad.net/1.0/~grunwald"
        }, 
        {
            "content": "I tried to repeatedly reproduce the error. I removed the rw-permission from abstractions/libvirt-qemu, reloaded the apparmor-profiles. I start an new intstance an try to get an snapshot.\n\nI have added some debug-output to the soruce code of /usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py to check if the directory exists or not.\n\n            disk_delta = out_path + '.delta'\n            ...\n            import os.path\n            disk_delta_exists = os.path.isfile(disk_delta)\n            LOG.debug(_(\"disk_delta_exists: %s\") % disk_delta_exists)\n\n            domain.blockRebase(disk_path, disk_delta, 0,\n                               libvirt.VIR_DOMAIN_BLOCK_REBASE_COPY |\n                               libvirt.VIR_DOMAIN_BLOCK_REBASE_REUSE_EXT |\n                               libvirt.VIR_DOMAIN_BLOCK_REBASE_SHALLOW)\n\n             LOG.debug(_(\"disk_delta_exists2: %s\") % disk_delta_exists)\n\n\nThis leads to this debug-log:\n\n2013-11-27 09:21:21.172 5568 DEBUG nova.virt.libvirt.driver [req-5bd8a420-2747-490f-a688-7468ffcd3c00 b6d2602f38914f20a0fec492fd1482e8 32c4869a7fee41ecb953cd00\nc3e71eac] disk_delta_exists: True _live_snapshot /usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py:1484\n2013-11-27 09:21:21.500 5568 INFO nova.virt.libvirt.driver [req-5bd8a420-2747-490f-a688-7468ffcd3c00 b6d2602f38914f20a0fec492fd1482e8 32c4869a7fee41ecb953cd00c\n3e71eac] [instance: df82e015-077c-48d7-8008-5b5f64efb6da] Snapshot extracted, beginning image upload\n2013-11-27 09:21:21.500 5568 DEBUG nova.compute.manager [req-5bd8a420-2747-490f-a688-7468ffcd3c00 b6d2602f38914f20a0fec492fd1482e8 32c4869a7fee41ecb953cd00c3e7\n1eac] [instance: df82e015-077c-48d7-8008-5b5f64efb6da] Cleaning up image a2074ffb-e556-4263-9843-698867e79dae decorated_function /usr/lib/python2.7/dist-packag\nes/nova/compute/manager.py:313\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da] Traceback (most recent call last):\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]   File \"/usr/lib/python2.7/dist-packages/nova/compute/\nmanager.py\", line 309, in decorated_function\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]     *args, **kwargs)\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]   File \"/usr/lib/python2.7/dist-packages/nova/compute/\nmanager.py\", line 2293, in snapshot_instance\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]     task_states.IMAGE_SNAPSHOT)\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]   File \"/usr/lib/python2.7/dist-packages/nova/compute/\nmanager.py\", line 2324, in _snapshot_instance\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]     update_task_state)\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]   File \"/usr/lib/python2.7/dist-packages/nova/virt/lib\nvirt/driver.py\", line 1400, in snapshot\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]     image_format)\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]   File \"/usr/lib/python2.7/dist-packages/nova/virt/lib\nvirt/driver.py\", line 1489, in _live_snapshot\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]     libvirt.VIR_DOMAIN_BLOCK_REBASE_SHALLOW)\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]   File \"/usr/lib/python2.7/dist-packages/eventlet/tpoo\nl.py\", line 179, in doit\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]     result = proxy_call(self._autowrap, f, *args, **kw\nargs)\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]   File \"/usr/lib/python2.7/dist-packages/eventlet/tpoo\nl.py\", line 139, in proxy_call\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]     rv = execute(f,*args,**kwargs)\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]   File \"/usr/lib/python2.7/dist-packages/eventlet/tpoo\nl.py\", line 77, in tworker\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]     rv = meth(*args,**kwargs)\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", \nline 646, in blockRebase\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da]     if ret == -1: raise libvirtError ('virDomainBlockR\nebase() failed', dom=self)\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da] libvirtError: internal error: unable to execute QEMU c\nommand 'drive-mirror': Could not open '/var/lib/nova/instances/snapshots/tmpT2Tjwy/808390b3031d4e93813293551ef63b12.delta'\n2013-11-27 09:21:21.500 5568 TRACE nova.compute.manager [instance: df82e015-077c-48d7-8008-5b5f64efb6da] \n2013-11-27 09:21:21.502 5568 DEBUG stevedore.extension [-] found extension EntryPoint.parse('file = nova.image.download.file') _load_plugins /usr/lib/python2.7\n/dist-packages/stevedore/extension.py:84\n2013-11-27 09:21:21.503 5568 DEBUG stevedore.extension [-] found extension EntryPoint.parse('file = nova.image.download.file') _load_plugins /usr/lib/python2.7\n/dist-packages/stevedore/extension.py:84\n\nI think the tmp-directory is create and removed with the root-wrapper and fileutils.ensure_tree(snapshot_directory) innova/virt/libvirt/driver.py .\nLike the debug-output shows, the directory exists before the original image ist rebased in /usr/lib/python2.7/dist-packages/libvirt.py.\n\nOk so far, i have to change my statement at #13, maybe the profile was yet in clomplain-mode, but now in enfoce-mode i get another apparmor-denied-log:\n\nNov 27 10:09:17 compute1 kernel: [1886126.137124] type=1400 audit(1385546957.245:20429): apparmor=\"STATUS\" operation=\"profile_replace\" parent=2173 profile=\"unconfined\" name=\"libvirt-fd3eeca4-ab20-4675-8d35-ba786f378893\" pid=2174 comm=\"apparmor_parser\"\nNov 27 10:09:17 compute1 kernel: [1886126.145251] type=1400 audit(1385546957.253:20430): apparmor=\"DENIED\" operation=\"file_perm\" parent=1 profile=\"libvirt-fd3eeca4-ab20-4675-8d35-ba786f378893\" name=\"/var/lib/nova/instances/fd3eeca4-ab20-4675-8d35-ba786f378893/disk\" pid=2063 comm=\"qemu-system-x86\" requested_mask=\"r\" denied_mask=\"r\" fsuid=110 ouid=110\n\nAs at #12 there is no entry for original disk(s) \"/var/lib/nova/instances/fd3eeca4-ab20-4675-8d35-ba786f378893/disk\" in the newly replaced profile:\n\n# DO NOT EDIT THIS FILE DIRECTLY. IT IS MANAGED BY LIBVIRT.\n  \"/var/log/libvirt/**/instance-00000038.log\" w,\n  \"/var/lib/libvirt/**/instance-00000038.monitor\" rw,\n  \"/var/run/libvirt/**/instance-00000038.pid\" rwk,\n  \"/run/libvirt/**/instance-00000038.pid\" rwk,\n  \"/var/run/libvirt/**/*.tunnelmigrate.dest.instance-00000038\" rw,\n  \"/run/libvirt/**/*.tunnelmigrate.dest.instance-00000038\" rw,\n  \"/var/lib/nova/instances/snapshots/tmp6O67qv/501781885d94440faa1709ffbe5710b3.delta\" rw,\n  \"/var/lib/nova/instances/fd3eeca4-ab20-4675-8d35-ba786f378893/console.log\" rw,\n  \"/var/lib/nova/instances/fd3eeca4-ab20-4675-8d35-ba786f378893/console.log\" rw,\n  \"/var/lib/nova/instances/snapshots/tmp6O67qv/501781885d94440faa1709ffbe5710b3.delta\" rw,\n\nI tried that with different instances and the latest nova-python and libvirt-bin packages. ", 
            "date_created": "2013-11-27 10:22:41.436807+00:00", 
            "author": "https://api.launchpad.net/1.0/~tis-x"
        }, 
        {
            "content": "This may be related to, if not actually a dup of, bug 1004606.", 
            "date_created": "2014-01-02 17:43:08.516977+00:00", 
            "author": "https://api.launchpad.net/1.0/~serge-hallyn"
        }, 
        {
            "content": "The existing virt-aa-helper profile only allows:\n\n/var/lib/nova/images/** r,\n  /var/lib/nova/instances/_base/** r,\n\nJudging by comment #8, it sounds like adding\n\n/var/lib/nova/instances/snapshots/** r,\n\nshould do the trick.  This should then allow virt-aa-helper to add the snapshot images to the domain's whitelist as well.\n\nCan someone test that?  If noone reports in the next few days whether thtat works or not, then I will optimistically add the rule to the trusty package.", 
            "date_created": "2014-01-03 18:25:09.417043+00:00", 
            "author": "https://api.launchpad.net/1.0/~serge-hallyn"
        }, 
        {
            "content": "I added that to virt-aa-helper but it's still broken. The libvirt/apparmor file is below as is the log output.\nI don't know if it matters, but I'm using CEPH for volume store.\n\nThe instance-specific apparmour file is \n\n# DO NOT EDIT THIS FILE DIRECTLY. IT IS MANAGED BY LIBVIRT.\n  \"/var/log/libvirt/**/instance-000000ea.log\" w,\n  \"/var/lib/libvirt/**/instance-000000ea.monitor\" rw,\n  \"/var/run/libvirt/**/instance-000000ea.pid\" rwk,\n  \"/run/libvirt/**/instance-000000ea.pid\" rwk,\n  \"/var/run/libvirt/**/*.tunnelmigrate.dest.instance-000000ea\" rw,\n  \"/run/libvirt/**/*.tunnelmigrate.dest.instance-000000ea\" rw,\n  \"/var/lib/nova/instances/snapshots/tmpJXEx_R/ca1ff017f53741eea3ee7532205ff7fe.delta\" rw,\n  \"/var/lib/nova/instances/e2b47b8a-19ae-40bd-8bea-fdb885b1e49b/console.log\" rw,\n  \"/var/lib/nova/instances/e2b47b8a-19ae-40bd-8bea-fdb885b1e49b/console.log\" rw,\n\n\n=========================\n\nThe log output is:\n\n2014-01-03 18:58:16.242 2255 INFO nova.compute.resource_tracker [-] Compute_service record updated for slab-07b:slab-07b\n2014-01-03 18:58:25.707 2255 AUDIT nova.compute.manager [req-b2f5930e-2235-4bdf-ad74-c15809b58aac e9bb2814b1364a738d7c313a37a18b60 305f4fa9adcc48b09b8d07d\\\nf5b247df7] [instance: e2b47b8a-19ae-40bd-8bea-fdb885b1e49b] instance snapshotting\n2014-01-03 18:58:25.927 2255 INFO nova.virt.libvirt.driver [req-b2f5930e-2235-4bdf-ad74-c15809b58aac e9bb2814b1364a738d7c313a37a18b60 305f4fa9adcc48b09b8d\\\n07df5b247df7] [instance: e2b47b8a-19ae-40bd-8bea-fdb885b1e49b] Beginning live snapshot process\n2014-01-03 18:58:26.987 2255 INFO nova.virt.libvirt.driver [req-b2f5930e-2235-4bdf-ad74-c15809b58aac e9bb2814b1364a738d7c313a37a18b60 305f4fa9adcc48b09b8d\\\n07df5b247df7] [instance: e2b47b8a-19ae-40bd-8bea-fdb885b1e49b] Snapshot extracted, beginning image upload\n2014-01-03 18:58:27.395 2255 ERROR nova.openstack.common.rpc.amqp [req-b2f5930e-2235-4bdf-ad74-c15809b58aac e9bb2814b1364a738d7c313a37a18b60 305f4fa9adcc4\\\n8b09b8d07df5b247df7] Exception during message handling\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 461, i\\\nn _process_data\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     **args)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line \\\n172, in dispatch\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 353, in decorate\\\nd_function\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 90, in wrapped\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     payload)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 73, in wrapped\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 243, in decorate\\\nd_function\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     pass\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 229, in decorate\\\nd_function\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 271, in decorate\\\nd_function\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 258, in decorate\\\nd_function\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 319, in decorate\\\nd_function\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     % image_id, instance=instance)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 309, in decorate\\\nd_function\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     *args, **kwargs)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2293, in snapsho\\\nt_instance\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     task_states.IMAGE_SNAPSHOT)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2324, in _snapsh\\\not_instance\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     update_task_state)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1397, in sna\\\npshot\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     image_format)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1483, in _li\\\nve_snapshot\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     libvirt.VIR_DOMAIN_BLOCK_REBASE_SHALLOW)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 179, in doit\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 139, in proxy_call\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     rv = execute(f,*args,**kwargs)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 77, in tworker\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     rv = meth(*args,**kwargs)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 646, in blockRebase\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp     if ret == -1: raise libvirtError ('virDomainBlockRebase() failed', dom=self)\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp libvirtError: internal error: unable to execute QEMU command 'drive-mirror': Could not o\\\npen '/var/lib/nova/instances/snapshots/tmpJXEx_R/ca1ff017f53741eea3ee7532205ff7fe.delta'\n2014-01-03 18:58:27.395 2255 TRACE nova.openstack.common.rpc.amqp\n", 
            "date_created": "2014-01-04 02:05:13.295863+00:00", 
            "author": "https://api.launchpad.net/1.0/~grunwald"
        }, 
        {
            "content": "Thanks, Dirk.  So is\n/var/lib/nova/instances/snapshots/tmpJXEx_R/ca1ff017f53741eea3ee7532205ff7fe.delta\nalso on ceph?  Where is ceph mounted?  Can you install the auditd\npackage, then retry this and attach the /var/log/audit/audit.log?\n", 
            "date_created": "2014-01-06 18:46:02+00:00", 
            "author": "https://api.launchpad.net/1.0/~serge-hallyn"
        }, 
        {
            "content": "\nI'm using RBD (their volume interface) and not a file system.\n\nHowever, it appears that this IS working -- I restarted the server rather than just the services\nand now I can correctly snapshot a running instance. \n\nThis is all on a 13.10 base system, so I must have forgotten to restart some service.\nIs this patch being pushed into the 13.10 releases? If not, I'll manually update the other\nservers in my (small) cluster.\n\nBtw, I looked through the AUDIT log for things that were DENIED and it looks like qemu-ifdown is not\nin the libvirt-qemu file -- is this something that should be added? I've included the log output below\n\nroot@zfs2:/var/log/audit# grep -i denied audit.log \ntype=AVC msg=audit(1389036336.913:4605): apparmor=\"DENIED\" operation=\"exec\" parent=6994 pro\\\nfile=\"libvirt-1f2b61f6-0cd1-4bc0-b3fe-4575e0478e0a\" name=\"/etc/qemu-ifdown\" pid=11733 comm=\\\n\"qemu-system-x86\" requested_mask=\"x\" denied_mask=\"x\" fsuid=110 ouid=0\ntype=AVC msg=audit(1389036373.338:4920): apparmor=\"DENIED\" operation=\"capable\" parent=1 pro\\\nfile=\"/usr/sbin/libvirtd\" pid=4173 comm=\"libvirtd\" pid=4173 comm=\"libvirtd\" capability=29  \\\ncapname=\"audit_write\"\ntype=AVC msg=audit(1389036968.075:7337): apparmor=\"DENIED\" operation=\"exec\" parent=12382 pr\\\nofile=\"libvirt-97be2846-7e24-4538-90bf-d3783fece0ef\" name=\"/etc/qemu-ifdown\" pid=15063 comm\\\n=\"qemu-system-x86\" requested_mask=\"x\" denied_mask=\"x\" fsuid=110 ouid=0\nroot@zfs2:/var/log/audit# \n", 
            "date_created": "2014-01-06 19:47:28.066178+00:00", 
            "author": "https://api.launchpad.net/1.0/~grunwald"
        }, 
        {
            "content": "This bug was fixed in the package libvirt - 1.2.0-0ubuntu3\n\n---------------\nlibvirt (1.2.0-0ubuntu3) trusty; urgency=medium\n\n  * debian/apparmor/usr.lib.libvirt.virt-aa-helper: add\n    /var/lib/nova/instances/snapshots/** r to allow virt-aa-helper to read\n    the snapshot directory to find images which VMs should be granted access\n    to.  (LP: #1244694)\n -- Serge Hallyn <email address hidden>   Thu, 09 Jan 2014 16:39:13 -0600", 
            "date_created": "2014-01-10 02:21:48.952627+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }, 
        {
            "content": "Hello Daniel, or anyone else affected,\n\nAccepted libvirt into saucy-proposed. The package will build now and be available at http://launchpad.net/ubuntu/+source/libvirt/1.1.1-0ubuntu8.3 in a few hours, and then in the -proposed repository.\n\nPlease help us by testing this new package.  See https://wiki.ubuntu.com/Testing/EnableProposed for documentation how to enable and use -proposed.  Your feedback will aid us getting this update out to other Ubuntu users.\n\nIf this package fixes the bug for you, please add a comment to this bug, mentioning the version of the package you tested, and change the tag from verification-needed to verification-done. If it does not fix the bug for you, please add a comment stating that, and change the tag to verification-failed.  In either case, details of your testing will help us make a better decision.\n\nFurther information regarding the verification process can be found at https://wiki.ubuntu.com/QATeam/PerformingSRUVerification .  Thank you in advance!", 
            "date_created": "2014-01-17 01:31:46.448250+00:00", 
            "author": "https://api.launchpad.net/1.0/~brian-murray"
        }, 
        {
            "content": "Having some trouble reproducing the original issue again using  the current package in saucy-updates (1.1.1-0ubuntu8.2)  Seems I was hitting this consistently last week but now I can no longer trigger the original issue.  \n\n@Dirk- I'm curious if you might revert some of the local changes you've made and see if the issue surfaces, and if you'd be willing to test the proposed package on your cluster?  The proposed update will be released to 13.10 once we can get it verified.", 
            "date_created": "2014-01-22 01:28:51.072232+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "Yes, I will revert changes & test this. Just did an update & see a large number of changes to openstack. I'll apply that, disable patch, verify failure an then apply proposed.\n", 
            "date_created": "2014-01-22 18:25:14.074937+00:00", 
            "author": "https://api.launchpad.net/1.0/~grunwald"
        }, 
        {
            "content": "Can someone please test this? I have a libvirt security update I need to push out, and if nobody verifies this, the update will supersede it...", 
            "date_created": "2014-01-27 18:10:27.476350+00:00", 
            "author": "https://api.launchpad.net/1.0/~mdeslaur"
        }, 
        {
            "content": "Does the 8.9 in -proposed still contain this fix?  I was able to run the failing tempest test that detected this in openstack against the version in -proposed:\n\ntempest.api.compute.images.test_images_oneserver.ImagesOneServerTestJSON\n    test_create_delete_image[gate,smoke]                              OK  42.70\nSlowest 1 tests took 42.70 secs:\ntempest.api.compute.images.test_images_oneserver.ImagesOneServerTestJSON\n    test_create_delete_image[gate,smoke]                                  42.70\n\nRan 1 test in 68.976s\n\nOK\nubuntu@james-page-bastion:~/openstack-charm-testing/tempest\u27eb juju run --unit nova-compute/0 \"apt-cache policy libvirt-bin\"                                      \nlibvirt-bin:\n  Installed: 1.1.1-0ubuntu8.9\n  Candidate: 1.1.1-0ubuntu8.9\n  Version table:\n *** 1.1.1-0ubuntu8.9 0\n        500 http://archive.ubuntu.com/ubuntu/ saucy-proposed/main amd64 Packages\n        100 /var/lib/dpkg/status\n     1.1.1-0ubuntu8.7 0\n        500 http://archive.ubuntu.com/ubuntu/ saucy-updates/main amd64 Packages\n     1.1.1-0ubuntu8.5 0\n        500 http://security.ubuntu.com/ubuntu/ saucy-security/main amd64 Packages\n     1.1.1-0ubuntu8 0\n        500 http://archive.ubuntu.com/ubuntu/ saucy/main amd64 Packages\n", 
            "date_created": "2014-04-04 08:47:58.281441+00:00", 
            "author": "https://api.launchpad.net/1.0/~james-page"
        }, 
        {
            "content": "Hmm - actually maybe not (this one from hardware rather than :\n\n2014-04-04 08:48:52.378 24424 TRACE nova.openstack.common.rpc.amqp libvirtError: internal error: unable to execute QEMU command 'drive-mirror': Could not open '/var/lib/nova/instances/snapshots/tmpBcAos9/2a76340dc56241b995ae734887bab851.delta'\n\nI'm having trouble getting a consistent result.", 
            "date_created": "2014-04-04 10:56:14.325739+00:00", 
            "author": "https://api.launchpad.net/1.0/~james-page"
        }, 
        {
            "content": "@james-page,\n\nno, that fix is not in 8.9", 
            "date_created": "2014-04-07 15:45:18.490043+00:00", 
            "author": "https://api.launchpad.net/1.0/~serge-hallyn"
        }, 
        {
            "content": "saucy has seen the end of its life and is no longer receiving any updates. Marking the saucy task for this ticket as \"Won't Fix\".", 
            "date_created": "2014-12-05 06:35:18.621416+00:00", 
            "author": "https://api.launchpad.net/1.0/~r0lf"
        }
    ]
}