{
    "status": "Invalid", 
    "last_updated": "2017-04-20 03:49:50.022983+00:00", 
    "description": "\nHow to reproduce this bug\n\n1. Enable AggregateInstanceExtraSpecsFilter in /etc/nova/nova.conf by adding only 'AggregateInstanceExtraSpecsFilter' to scheduler_default_filters variable\n2. Example: Specify compute hosts with the same vendor: Intel\n\n# create new host-aggregate\n$ nova aggregate-create fast-io nova\n\n# set metadata for new created host-aggregate\n$ nova aggregate-set-metadata <aggregate_id> aggregate_instance_extra_specs:cpu_info:vendor=Intel\n\n# check aggregate details\n$ nova aggregate-details <aggregate_id>\n\nhttp://paste.openstack.org/show/131393/\n\n# add a host to an aggregate\n$ nova aggregate-add-host <aggregate_id> <host_name>\n\n# list of all flavors\n$ nova flavor-list\n\n# set metadata for flavor m1.nano\n$ nova flavor-key m1.nano set aggregate_instance_extra_specs:cpu_info:vendor=Intel\n\n# show details of m1.nano flavor\n$ nova flavor-show m1.nano\n\nhttp://paste.openstack.org/show/131394/\n\n# try to launch instance - as a tip: m1.nano flavor id = 42 :)\n$ nova boot --flavor <flavor_id> --image <image_id> <instance_name>\n\n\nFor flavor we have metadata: \"aggregate_instance_extra_specs:cpu_info:vendor=Intel\"\n\nand \n\nFor aggregate we have metadata: \"aggregate_instance_extra_specs:cpu_info:vendor=Intel\"\n\nand as a result we get.... \"No valid host was found. There are not enough hosts available.\"\n\nWhat cases are good for 'AggregateInstanceExtraSpecsFilter' ?\n\na)\n\nflavor metadata: cpu_info:vendor=Intel\naggregate metadata: aggregate_instance_extra_specs:cpu_info:vendor=Intel\n\n(I think it is about backwards compatibility with extra specs?)\n\nb)\n\nflavor metadata: aggregate_instance_extra_specs:aggregate_instance_extra_specs:cpu_info:vendor=Intel\naggregate metadata: aggregate_instance_extra_specs:cpu_info:vendor=Intel\n\nWhat is the problem ?\n\nPlease take a look at the AggregateInstanceExtraSpecsFilter code (https://github.com/openstack/nova/blob/master/nova/scheduler/filters/aggregate_instance_extra_specs.py).\n\nThe filter is looking for that prefix but in extra specs of flavor, not aggregate!\nFilter is matching metadata from flavor with metadata from host aggregate. \nIn the metadata from flavor prefix (aggregate_instance_extra_specs) is removed (if exist). \nBut it isn\u2019t removed from aggregate metadata. \nSo if user doesn\u2019t specify metadata on flavor in the form of: aggregate_instance_extra_specs:aggregate_instance_extra_specs:cpu_info:vendor (because first prefix is stripped from extra spec), \nthen the filter wouldn\u2019t match any host.\n\nI'd like to disscuss about possible solution of this issue.\nOr maybe it is a feature and I didn't understand how AggregateInstanceExtraSpecsFilter should work ?", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1391101", 
    "owner": "None", 
    "id": 1391101, 
    "index": 5265, 
    "created": "2014-11-10 10:23:41.956179+00:00", 
    "title": "Illogical use of 'aggregate_instance_extra_specs'  prefix in nova AggregateInstanceExtraSpecsFilter ", 
    "comments": [
        {
            "content": "\nHow to reproduce this bug\n\n1. Enable AggregateInstanceExtraSpecsFilter in /etc/nova/nova.conf by adding only 'AggregateInstanceExtraSpecsFilter' to scheduler_default_filters variable\n2. Example: Specify compute hosts with the same vendor: Intel\n\n# create new host-aggregate\n$ nova aggregate-create fast-io nova\n\n# set metadata for new created host-aggregate\n$ nova aggregate-set-metadata <aggregate_id> aggregate_instance_extra_specs:cpu_info:vendor=Intel\n\n# check aggregate details\n$ nova aggregate-details <aggregate_id>\n\nhttp://paste.openstack.org/show/131393/\n\n# add a host to an aggregate\n$ nova aggregate-add-host <aggregate_id> <host_name>\n\n# list of all flavors\n$ nova flavor-list\n\n# set metadata for flavor m1.nano\n$ nova flavor-key m1.nano set aggregate_instance_extra_specs:cpu_info:vendor=Intel\n\n# show details of m1.nano flavor\n$ nova flavor-show m1.nano\n\nhttp://paste.openstack.org/show/131394/\n\n# try to launch instance - as a tip: m1.nano flavor id = 42 :)\n$ nova boot --flavor <flavor_id> --image <image_id> <instance_name>\n\n\nFor flavor we have metadata: \"aggregate_instance_extra_specs:cpu_info:vendor=Intel\"\n\nand \n\nFor aggregate we have metadata: \"aggregate_instance_extra_specs:cpu_info:vendor=Intel\"\n\nand as a result we get.... \"No valid host was found. There are not enough hosts available.\"\n\nWhat cases are good for 'AggregateInstanceExtraSpecsFilter' ?\n\na)\n\nflavor metadata: cpu_info:vendor=Intel\naggregate metadata: aggregate_instance_extra_specs:cpu_info:vendor=Intel\n\n(I think it is about backwards compatibility with extra specs?)\n\nb)\n\nflavor metadata: aggregate_instance_extra_specs:aggregate_instance_extra_specs:cpu_info:vendor=Intel\naggregate metadata: aggregate_instance_extra_specs:cpu_info:vendor=Intel\n\nWhat is the problem ?\n\nPlease take a look at the AggregateInstanceExtraSpecsFilter code (https://github.com/openstack/nova/blob/master/nova/scheduler/filters/aggregate_instance_extra_specs.py).\n\nThe filter is looking for that prefix but in extra specs of flavor, not aggregate!\nFilter is matching metadata from flavor with metadata from host aggregate. \nIn the metadata from flavor prefix (aggregate_instance_extra_specs) is removed (if exist). \nBut it isn\u2019t removed from aggregate metadata. \nSo if user doesn\u2019t specify metadata on flavor in the form of: aggregate_instance_extra_specs:aggregate_instance_extra_specs:cpu_info:vendor (because first prefix is stripped from extra spec), \nthen the filter wouldn\u2019t match any host.\n\nI'd like to disscuss about possible solution of this issue.\nOr maybe it is a feature and I didn't understand how AggregateInstanceExtraSpecsFilter should work ?", 
            "date_created": "2014-11-10 10:23:41.956179+00:00", 
            "author": "https://api.launchpad.net/1.0/~bartosz-fic"
        }, 
        {
            "content": "Hi Bartosz.\n\nWhen you add the metadata to the aggregate you don't need to add the prefix. The prefix is only set in the flavors, to specify its scope (i.e. that it should be matched against an aggregate).\n\nSo , when you did:\n\n    nova flavor-key m1.nano set aggregate_instance_extra_specs:cpu_info:vendor=Intel\n\nYou should have done:\n\n    nova flavor-key m1.nano set cpu_info:vendor=Intel", 
            "date_created": "2014-11-12 09:49:25.528702+00:00", 
            "author": "https://api.launchpad.net/1.0/~aloga"
        }, 
        {
            "content": "Hi Alvaro. \n\nThank you Alvaro for your explanation. Now I've understood ! :)\n\na) in aggregate there should be no prefix\nb) in flavor there should be prefix in order to match it with aggregate\n\nIn horizon when you add metadata for host aggregate, prefix is set as 'aggregate_instance_extra_specs' by default so I thought that it's eligible behaviour. After your comment I think that this behaviour in horizon is not appropriate and here is defect.\n\n", 
            "date_created": "2014-11-12 14:51:32.349471+00:00", 
            "author": "https://api.launchpad.net/1.0/~bartosz-fic"
        }, 
        {
            "content": "Respective usage has been mentioned here : https://docs.openstack.org/ocata/config-reference/compute/schedulers.html#host-aggregates", 
            "date_created": "2017-03-30 09:34:19.020207+00:00", 
            "author": "https://api.launchpad.net/1.0/~rsritesh"
        }
    ]
}