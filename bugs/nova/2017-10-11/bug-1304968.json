{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:27:41.573442+00:00", 
    "description": "The bulk of the stack traces in n-cpu is because emit_event is getting triggered on a VM delete, however by the time we get to emit_event the instance is deleted (we see this exception 183 times in this log - which means it's happening on *every* compute terminate) so when we try to look up the instance we hit the exception found here:\n\n    @base.remotable_classmethod\n    def get_by_instance_uuid(cls, context, instance_uuid):\n        db_obj = db.instance_info_cache_get(context, instance_uuid)\n        if not db_obj:\n            raise exception.InstanceInfoCacheNotFound(\n                    instance_uuid=instance_uuid)\n        return InstanceInfoCache._from_db_object(context, cls(), db_obj)\n\nA log trace of this interaction looks like this:\n\n\n2014-04-08 11:14:25.475 DEBUG nova.openstack.common.lockutils [req-fe9db989-416e-4da0-986c-e68336e3c602 TenantUsagesTestJSON-153098759 TenantUsagesTestJSON-953946497] Semaphore / lock released \"do_terminate_instance\" inner /opt/stack/new/nova/nova/openstack/common/lockutils.py:252\n2014-04-08 11:14:25.907 DEBUG nova.openstack.common.lockutils [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Got semaphore \"75da98d7-bbd5-42a2-ad6f-7a66e38977fa\" lock /opt/stack/new/nova/nova/openstack/common/lockutils.py:168\n2014-04-08 11:14:25.907 DEBUG nova.openstack.common.lockutils [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Got semaphore / lock \"do_terminate_instance\" inner /opt/stack/new/nova/nova/openstack/common/lockutils.py:248\n2014-04-08 11:14:25.907 DEBUG nova.openstack.common.lockutils [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Got semaphore \"<function _lock_name at 0x41635f0>\" lock /opt/stack/new/nova/nova/openstack/common/lockutils.py:168\n2014-04-08 11:14:25.908 DEBUG nova.openstack.common.lockutils [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Got semaphore / lock \"_clear_events\" inner /opt/stack/new/nova/nova/openstack/common/lockutils.py:248\n2014-04-08 11:14:25.908 DEBUG nova.openstack.common.lockutils [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Semaphore / lock released \"_clear_events\" inner /opt/stack/new/nova/nova/openstack/common/lockutils.py:252\n2014-04-08 11:14:25.928 AUDIT nova.compute.manager [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] [instance: 75da98d7-bbd5-42a2-ad6f-7a66e38977fa] Terminating instance\n2014-04-08 11:14:25.989 DEBUG nova.objects.instance [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Lazy-loading `system_metadata' on Instance uuid 75da98d7-bbd5-42a2-ad6f-7a66e38977fa obj_load_attr /opt/stack/new/nova/nova/objects/instance.py:519\n2014-04-08 11:14:26.209 DEBUG nova.network.api [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Updating cache with info: [VIF({'ovs_interfaceid': None, 'network': Network({'bridge': u'br100', 'subnets': [Subnet({'ips': [FixedIP({'meta': {}, 'version': 4, 'type': u'fixed', 'floating_ips': [], 'address': u'10.1.0.2'})], 'version': 4, 'meta': {u'dhcp_server': u'10.1.0.1'}, 'dns': [IP({'meta': {}, 'version': 4, 'type': u'dns', 'address': u'8.8.4.4'})], 'routes': [], 'cidr': u'10.1.0.0/24', 'gateway': IP({'meta': {}, 'version': 4, 'type': u'gateway', 'address': u'10.1.0.1'})}), Subnet({'ips': [], 'version': None, 'meta': {u'dhcp_server': None}, 'dns': [], 'routes': [], 'cidr': None, 'gateway': IP({'meta': {}, 'version': None, 'type': u'gateway', 'address': None})})], 'meta': {u'tenant_id': None, u'should_create_bridge': True, u'bridge_interface': u'eth0'}, 'id': u'9751787e-f41c-4299-be13-941c901f6d18', 'label': u'private'}), 'devname': None, 'qbh_params': None, 'meta': {}, 'details': {}, 'address': u'fa:16:3e:d8:87:38', 'active': False, 'type': u'bridge', 'id': u'db1ac48d-805a-45d3-9bb9-786bb5855673', 'qbg_params': None})] update_instance_cache_with_nw_info /opt/stack/new/nova/nova/network/api.py:74\n2014-04-08 11:14:27.661 2894 DEBUG nova.virt.driver [-] Emitting event <nova.virt.event.LifecycleEvent object at 0x4932e50> emit_event /opt/stack/new/nova/nova/virt/driver.py:1207\n2014-04-08 11:14:27.661 2894 INFO nova.compute.manager [-] Lifecycle event 1 on VM 75da98d7-bbd5-42a2-ad6f-7a66e38977fa\n2014-04-08 11:14:27.773 2894 ERROR nova.virt.driver [-] Exception dispatching event <nova.virt.event.LifecycleEvent object at 0x4932e50>: Info cache for instance 75da98d7-bbd5-42a2-ad6f-7a66e38977fa could not be found.\nTraceback (most recent call last):\n\n  File \"/opt/stack/new/nova/nova/conductor/manager.py\", line 597, in _object_dispatch\n    return getattr(target, method)(context, *args, **kwargs)\n\n  File \"/opt/stack/new/nova/nova/objects/base.py\", line 151, in wrapper\n    return fn(self, ctxt, *args, **kwargs)\n\n  File \"/opt/stack/new/nova/nova/objects/instance.py\", line 500, in refresh\n    self.info_cache.refresh()\n\n  File \"/opt/stack/new/nova/nova/objects/base.py\", line 151, in wrapper\n    return fn(self, ctxt, *args, **kwargs)\n\n  File \"/opt/stack/new/nova/nova/objects/instance_info_cache.py\", line 103, in refresh\n    self.instance_uuid)\n\n  File \"/opt/stack/new/nova/nova/objects/base.py\", line 112, in wrapper\n    result = fn(cls, context, *args, **kwargs)\n\n  File \"/opt/stack/new/nova/nova/objects/instance_info_cache.py\", line 70, in get_by_instance_uuid\n    instance_uuid=instance_uuid)\n\nInstanceInfoCacheNotFound: Info cache for instance 75da98d7-bbd5-42a2-ad6f-7a66e38977fa could not be found.\n\n2014-04-08 11:14:27.840 2894 INFO nova.virt.libvirt.driver [-] [instance: 75da98d7-bbd5-42a2-ad6f-7a66e38977fa] Instance destroyed successfully.\n\nRaw logs for a failure: http://logs.openstack.org/38/62038/14/check/check-tempest-dsvm-full/86cde16/logs/screen-n-cpu.txt.gz?level=TRACE\n\nSpecific failure point: http://logs.openstack.org/38/62038/14/check/check-tempest-dsvm-full/86cde16/logs/screen-n-cpu.txt.gz?level=DEBUG#_2014-04-08_11_14_25_928", 
    "tags": [
        "compute", 
        "in-stable-icehouse", 
        "libvirt"
    ], 
    "importance": "High", 
    "heat": 26, 
    "link": "https://bugs.launchpad.net/nova/+bug/1304968", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1304968, 
    "index": 1470, 
    "created": "2014-04-09 10:20:57.657279+00:00", 
    "title": "Nova cpu full of instance_info_cache stack traces due to attempting to send events about deleted instances", 
    "comments": [
        {
            "content": "The bulk of the stack traces in n-cpu is because emit_event is getting triggered on a VM delete, however by the time we get to emit_event the instance is deleted (we see this exception 183 times in this log - which means it's happening on *every* compute terminate) so when we try to look up the instance we hit the exception found here:\n\n    @base.remotable_classmethod\n    def get_by_instance_uuid(cls, context, instance_uuid):\n        db_obj = db.instance_info_cache_get(context, instance_uuid)\n        if not db_obj:\n            raise exception.InstanceInfoCacheNotFound(\n                    instance_uuid=instance_uuid)\n        return InstanceInfoCache._from_db_object(context, cls(), db_obj)\n\nA log trace of this interaction looks like this:\n\n\n2014-04-08 11:14:25.475 DEBUG nova.openstack.common.lockutils [req-fe9db989-416e-4da0-986c-e68336e3c602 TenantUsagesTestJSON-153098759 TenantUsagesTestJSON-953946497] Semaphore / lock released \"do_terminate_instance\" inner /opt/stack/new/nova/nova/openstack/common/lockutils.py:252\n2014-04-08 11:14:25.907 DEBUG nova.openstack.common.lockutils [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Got semaphore \"75da98d7-bbd5-42a2-ad6f-7a66e38977fa\" lock /opt/stack/new/nova/nova/openstack/common/lockutils.py:168\n2014-04-08 11:14:25.907 DEBUG nova.openstack.common.lockutils [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Got semaphore / lock \"do_terminate_instance\" inner /opt/stack/new/nova/nova/openstack/common/lockutils.py:248\n2014-04-08 11:14:25.907 DEBUG nova.openstack.common.lockutils [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Got semaphore \"<function _lock_name at 0x41635f0>\" lock /opt/stack/new/nova/nova/openstack/common/lockutils.py:168\n2014-04-08 11:14:25.908 DEBUG nova.openstack.common.lockutils [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Got semaphore / lock \"_clear_events\" inner /opt/stack/new/nova/nova/openstack/common/lockutils.py:248\n2014-04-08 11:14:25.908 DEBUG nova.openstack.common.lockutils [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Semaphore / lock released \"_clear_events\" inner /opt/stack/new/nova/nova/openstack/common/lockutils.py:252\n2014-04-08 11:14:25.928 AUDIT nova.compute.manager [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] [instance: 75da98d7-bbd5-42a2-ad6f-7a66e38977fa] Terminating instance\n2014-04-08 11:14:25.989 DEBUG nova.objects.instance [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Lazy-loading `system_metadata' on Instance uuid 75da98d7-bbd5-42a2-ad6f-7a66e38977fa obj_load_attr /opt/stack/new/nova/nova/objects/instance.py:519\n2014-04-08 11:14:26.209 DEBUG nova.network.api [req-687de0cf-67fc-434f-927f-4c37665ad5d8 FixedIPsTestJson-234831436 FixedIPsTestJson-1960919997] Updating cache with info: [VIF({'ovs_interfaceid': None, 'network': Network({'bridge': u'br100', 'subnets': [Subnet({'ips': [FixedIP({'meta': {}, 'version': 4, 'type': u'fixed', 'floating_ips': [], 'address': u'10.1.0.2'})], 'version': 4, 'meta': {u'dhcp_server': u'10.1.0.1'}, 'dns': [IP({'meta': {}, 'version': 4, 'type': u'dns', 'address': u'8.8.4.4'})], 'routes': [], 'cidr': u'10.1.0.0/24', 'gateway': IP({'meta': {}, 'version': 4, 'type': u'gateway', 'address': u'10.1.0.1'})}), Subnet({'ips': [], 'version': None, 'meta': {u'dhcp_server': None}, 'dns': [], 'routes': [], 'cidr': None, 'gateway': IP({'meta': {}, 'version': None, 'type': u'gateway', 'address': None})})], 'meta': {u'tenant_id': None, u'should_create_bridge': True, u'bridge_interface': u'eth0'}, 'id': u'9751787e-f41c-4299-be13-941c901f6d18', 'label': u'private'}), 'devname': None, 'qbh_params': None, 'meta': {}, 'details': {}, 'address': u'fa:16:3e:d8:87:38', 'active': False, 'type': u'bridge', 'id': u'db1ac48d-805a-45d3-9bb9-786bb5855673', 'qbg_params': None})] update_instance_cache_with_nw_info /opt/stack/new/nova/nova/network/api.py:74\n2014-04-08 11:14:27.661 2894 DEBUG nova.virt.driver [-] Emitting event <nova.virt.event.LifecycleEvent object at 0x4932e50> emit_event /opt/stack/new/nova/nova/virt/driver.py:1207\n2014-04-08 11:14:27.661 2894 INFO nova.compute.manager [-] Lifecycle event 1 on VM 75da98d7-bbd5-42a2-ad6f-7a66e38977fa\n2014-04-08 11:14:27.773 2894 ERROR nova.virt.driver [-] Exception dispatching event <nova.virt.event.LifecycleEvent object at 0x4932e50>: Info cache for instance 75da98d7-bbd5-42a2-ad6f-7a66e38977fa could not be found.\nTraceback (most recent call last):\n\n  File \"/opt/stack/new/nova/nova/conductor/manager.py\", line 597, in _object_dispatch\n    return getattr(target, method)(context, *args, **kwargs)\n\n  File \"/opt/stack/new/nova/nova/objects/base.py\", line 151, in wrapper\n    return fn(self, ctxt, *args, **kwargs)\n\n  File \"/opt/stack/new/nova/nova/objects/instance.py\", line 500, in refresh\n    self.info_cache.refresh()\n\n  File \"/opt/stack/new/nova/nova/objects/base.py\", line 151, in wrapper\n    return fn(self, ctxt, *args, **kwargs)\n\n  File \"/opt/stack/new/nova/nova/objects/instance_info_cache.py\", line 103, in refresh\n    self.instance_uuid)\n\n  File \"/opt/stack/new/nova/nova/objects/base.py\", line 112, in wrapper\n    result = fn(cls, context, *args, **kwargs)\n\n  File \"/opt/stack/new/nova/nova/objects/instance_info_cache.py\", line 70, in get_by_instance_uuid\n    instance_uuid=instance_uuid)\n\nInstanceInfoCacheNotFound: Info cache for instance 75da98d7-bbd5-42a2-ad6f-7a66e38977fa could not be found.\n\n2014-04-08 11:14:27.840 2894 INFO nova.virt.libvirt.driver [-] [instance: 75da98d7-bbd5-42a2-ad6f-7a66e38977fa] Instance destroyed successfully.\n\nRaw logs for a failure: http://logs.openstack.org/38/62038/14/check/check-tempest-dsvm-full/86cde16/logs/screen-n-cpu.txt.gz?level=TRACE\n\nSpecific failure point: http://logs.openstack.org/38/62038/14/check/check-tempest-dsvm-full/86cde16/logs/screen-n-cpu.txt.gz?level=DEBUG#_2014-04-08_11_14_25_928", 
            "date_created": "2014-04-09 10:20:57.657279+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "I'm raising this to high because it's hit in *every* instance terminate", 
            "date_created": "2014-04-09 10:21:23.820549+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Patch: https://review.openstack.org/#/c/86389/", 
            "date_created": "2014-04-09 16:45:02.776243+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/86389\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=53ad788af6ced83bd9d6e58a25196a325d60fc4e\nSubmitter: Jenkins\nBranch:    master\n\ncommit 53ad788af6ced83bd9d6e58a25196a325d60fc4e\nAuthor: Dan Smith <email address hidden>\nDate:   Wed Apr 9 09:29:09 2014 -0700\n\n    Read deleted instances during lifecycle events\n    \n    This prevents us from failing to find the associated instance if\n    the lifecycle event happens after the instance has been deleted,\n    as in the case of a ... delete.\n    \n    Change-Id: I819ddf8ff68edc407d7932bf43771c440f514f26\n    Closes-bug: #1304968\n", 
            "date_created": "2014-04-09 21:00:50.653491+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Dan Smith\n\nWill you cherry pick the code change to icehouse?", 
            "date_created": "2014-08-05 03:04:30.535508+00:00", 
            "author": "https://api.launchpad.net/1.0/~yanglyy"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/112520", 
            "date_created": "2014-08-07 08:58:23.912829+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "We still have ~235K hits on this in 7 days, 20K of those are in stable/icehouse runs alone, the rest on master might be related to grenade jobs.\n\nAfter the stable/icehouse backport is merged (approved now):\n\nhttps://review.openstack.org/#/c/112520/1\n\nWe should open a new bug to track new failures on master since the same issue can crop up elsewhere during an instance delete flow and we just have to handle them one by one.", 
            "date_created": "2014-08-14 21:34:26.823172+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/112520\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=4e1e217000f5cc2ad5c199793f3ed2aefc89ec46\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 4e1e217000f5cc2ad5c199793f3ed2aefc89ec46\nAuthor: Dan Smith <email address hidden>\nDate:   Wed Apr 9 09:29:09 2014 -0700\n\n    Read deleted instances during lifecycle events\n    \n    This prevents us from failing to find the associated instance if\n    the lifecycle event happens after the instance has been deleted,\n    as in the case of a ... delete.\n    \n    Change-Id: I819ddf8ff68edc407d7932bf43771c440f514f26\n    Closes-bug: #1304968\n    (cherry picked from commit 53ad788af6ced83bd9d6e58a25196a325d60fc4e)\n", 
            "date_created": "2014-08-15 16:38:25.960031+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This is the logstash query I'm using:\n\nmessage:\"Exception dispatching event\" AND message:\"Info cache for instance\" AND message:\"could not be found\" AND tags:\"screen-n-cpu.txt\"\n\nhttp://goo.gl/hHMGdO\n\nNow that the backport is merged we can see if this starts dropping off in stable/icehouse and grenade runs.\n\nIn a 4 hour logstash run it does drop off, so this is looking good.", 
            "date_created": "2014-08-15 19:07:06.519286+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "There are actually 0 hits in the last 1 hour, so this might be closed now.", 
            "date_created": "2014-08-15 19:08:22.726735+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }
    ]
}