{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:38:12.474506+00:00", 
    "description": "When I resize an instance and the 'migration' plugin fails, I see the following traceback in the logs and the instance sits in 'RESIZE' status (visible through OSAPI) indefinitely. We should handle this failure and set the instance to ERROR so it can be deleted.\n\n2011-11-03 10:04:08,049 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/exception.py\", line 113, in wrapped\n(nova.rpc): TRACE:     return f(*args, **kw)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 120, in decorated_function\n(nova.rpc): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 1074, in resize_instance\n(nova.rpc): TRACE:     context, instance_ref, migration_ref['dest_host'])\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi_conn.py\", line 250, in migrate_disk_and_power_off\n(nova.rpc): TRACE:     return self._vmops.migrate_disk_and_power_off(context, instance, dest)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 683, in migrate_disk_and_power_off\n(nova.rpc): TRACE:     self._migrate_vhd(instance, base_copy_uuid, dest, sr_path)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 623, in _migrate_vhd\n(nova.rpc): TRACE:     self._session.wait_for_task(task, instance_id)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi_conn.py\", line 510, in wait_for_task\n(nova.rpc): TRACE:     return done.wait()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/eventlet/event.py\", line 116, in wait\n(nova.rpc): TRACE:     return hubs.get_hub().switch()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n(nova.rpc): TRACE:     return self.greenlet.switch()\n(nova.rpc): TRACE: Failure: ['XENAPI_PLUGIN_EXCEPTION', 'transfer_vhd', 'Exception', 'Unexpected VHD transfer failure']\n(nova.rpc): TRACE:", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/885723", 
    "owner": "https://api.launchpad.net/1.0/~bcwaldon", 
    "id": 885723, 
    "index": 2366, 
    "created": "2011-11-03 15:09:04.203567+00:00", 
    "title": "Failure on resize should set instance to ERROR", 
    "comments": [
        {
            "content": "When I resize an instance and the 'migration' plugin fails, I see the following traceback in the logs and the instance sits in 'RESIZE' status (visible through OSAPI) indefinitely. We should handle this failure and set the instance to ERROR so it can be deleted.\n\n2011-11-03 10:04:08,049 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/exception.py\", line 113, in wrapped\n(nova.rpc): TRACE:     return f(*args, **kw)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 120, in decorated_function\n(nova.rpc): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 1074, in resize_instance\n(nova.rpc): TRACE:     context, instance_ref, migration_ref['dest_host'])\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi_conn.py\", line 250, in migrate_disk_and_power_off\n(nova.rpc): TRACE:     return self._vmops.migrate_disk_and_power_off(context, instance, dest)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 683, in migrate_disk_and_power_off\n(nova.rpc): TRACE:     self._migrate_vhd(instance, base_copy_uuid, dest, sr_path)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 623, in _migrate_vhd\n(nova.rpc): TRACE:     self._session.wait_for_task(task, instance_id)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi_conn.py\", line 510, in wait_for_task\n(nova.rpc): TRACE:     return done.wait()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/eventlet/event.py\", line 116, in wait\n(nova.rpc): TRACE:     return hubs.get_hub().switch()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.6/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n(nova.rpc): TRACE:     return self.greenlet.switch()\n(nova.rpc): TRACE: Failure: ['XENAPI_PLUGIN_EXCEPTION', 'transfer_vhd', 'Exception', 'Unexpected VHD transfer failure']\n(nova.rpc): TRACE:", 
            "date_created": "2011-11-03 15:09:04.203567+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/1297\nCommitted: http://github.com/openstack/nova/commit/ca6295e5dd238a88b731c3bf3e337007d12b6c1c\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit ca6295e5dd238a88b731c3bf3e337007d12b6c1c\nAuthor: Brian Waldon <email address hidden>\nDate:   Thu Nov 3 13:40:56 2011 -0400\n\n    Gracefully handle Xen resize failure\n    \n    Fixes bug 885723\n    \n    Change-Id: I8cd04a88f809f49141dc6aa5be7217811e0141e3\n", 
            "date_created": "2011-11-03 20:25:09+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }
    ]
}