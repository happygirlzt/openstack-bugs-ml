{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 09:00:34.984664+00:00", 
    "description": "2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging [req-1ce8e3f7-a14f-4687-891c-a1541dfdce41 3742 391232 - - -] Error processing message locally\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging Traceback (most recent call last):\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/cells/messaging.py\", line 200, in _process_locally\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     resp_value = self.msg_runner._process_message_locally(self)\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/cells/messaging.py\", line 1296, in _process_message_locally\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     return fn(message, **message.method_kwargs)\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/cells/messaging.py\", line 1078, in instance_destroy_at_top\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     instance=instance)\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 119, in __exit__\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     six.reraise(self.type_, self.value, self.tb)\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/cells/messaging.py\", line 1065, in instance_destroy_at_top\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     instance.destroy()\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/objects/base.py\", line 116, in wrapper\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     return fn(self, *args, **kwargs)\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/objects/instance.py\", line 651, in destroy\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     reason='already destroyed')\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging ObjectActionError: Object action destroy failed because: already destroyed\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging \n\nThe exception being raised is http://git.openstack.org/cgit/openstack/nova/tree/nova/objects/instance.py?id=a74f07a92356187d3455e5a9e2418fb1ea697f96#n614\n\nWhat's happening is that the instance does not exist in the cell so instance.destroy is being called with an instance object instantiated like \"objects.Instance(context=ctxt, uuid=instance.uuid)\" so instance.id is not set.  So we should probably try to look up the instance when this failure occurs in instance_destroy_at_top.", 
    "tags": [
        "cells"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1479941", 
    "owner": "https://api.launchpad.net/1.0/~alaski", 
    "id": 1479941, 
    "index": 529, 
    "created": "2015-07-30 19:15:04.994002+00:00", 
    "title": "cells: deleting an instance with cell_name set that doesn't exist in the cell fails", 
    "comments": [
        {
            "content": "2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging [req-1ce8e3f7-a14f-4687-891c-a1541dfdce41 3742 391232 - - -] Error processing message locally\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging Traceback (most recent call last):\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/cells/messaging.py\", line 200, in _process_locally\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     resp_value = self.msg_runner._process_message_locally(self)\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/cells/messaging.py\", line 1296, in _process_message_locally\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     return fn(message, **message.method_kwargs)\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/cells/messaging.py\", line 1078, in instance_destroy_at_top\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     instance=instance)\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 119, in __exit__\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     six.reraise(self.type_, self.value, self.tb)\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/cells/messaging.py\", line 1065, in instance_destroy_at_top\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     instance.destroy()\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/objects/base.py\", line 116, in wrapper\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     return fn(self, *args, **kwargs)\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging   File \"/opt/rackstack/rackstack.301.55/nova/lib/python2.7/site-packages/nova/objects/instance.py\", line 651, in destroy\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging     reason='already destroyed')\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging ObjectActionError: Object action destroy failed because: already destroyed\n2015-07-28 19:29:33.153 23754 ERROR nova.cells.messaging \n\nThe exception being raised is http://git.openstack.org/cgit/openstack/nova/tree/nova/objects/instance.py?id=a74f07a92356187d3455e5a9e2418fb1ea697f96#n614\n\nWhat's happening is that the instance does not exist in the cell so instance.destroy is being called with an instance object instantiated like \"objects.Instance(context=ctxt, uuid=instance.uuid)\" so instance.id is not set.  So we should probably try to look up the instance when this failure occurs in instance_destroy_at_top.", 
            "date_created": "2015-07-30 19:15:04.994002+00:00", 
            "author": "https://api.launchpad.net/1.0/~alaski"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/207587", 
            "date_created": "2015-07-30 19:33:07.137946+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/207587\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7ea699cd854c215f53e243b0de90bc040aa65d57\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7ea699cd854c215f53e243b0de90bc040aa65d57\nAuthor: Andrew Laski <email address hidden>\nDate:   Thu Jul 30 15:16:09 2015 -0400\n\n    Cells: Handle instance_destroy_at_top failure\n    \n    With cells an instance can occasionally get into a situation where a\n    cell_name is set for it in a parent cell but the instance does not exist\n    in a child cell.  It is okay for an instance to not exist in a child\n    cell but normally cell_name isn't set when that happens.  If cell_name\n    isn't set then a delete will broadcast to all cells, just in case, and\n    then handle the delete local to the parent cell.  When cell_name is set\n    but the instance doesn't exist in the child cell a series of exceptions\n    leads to a failure to delete in the parent cell and the instance is\n    essentially undeletable.\n    \n    The exception that occurs in the parent cell is due to the instance.id\n    not being set on the object sent up from the child cell.  Since the\n    instance doesn't exist in the child cell we can't prevent that behavior,\n    at least without sending fake data.  Instead this catches the exception\n    that's raised in the parent and tries to grab the instance from the\n    database there and then tries to delete it.\n    \n    Change-Id: I470dc1db78e58ca5deaf4234662c1e58f0007123\n    Closes-bug: 1479941\n", 
            "date_created": "2015-08-15 05:08:06.029432+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}