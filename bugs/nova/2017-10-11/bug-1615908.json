{
    "status": "Expired", 
    "last_updated": "2017-09-27 04:18:16.893821+00:00", 
    "description": "When attaching a volume, nova-api will initiate a rpc call to nova-compute to run reserve_block_device_name:\n\n    def _attach_volume(self, context, instance, volume_id, device,\n                       disk_bus, device_type):\n        \"\"\"Attach an existing volume to an existing instance.\n\n        This method is separated to make it possible for cells version\n        to override it.\n        \"\"\"\n        # NOTE(vish): This is done on the compute host because we want\n        #             to avoid a race where two devices are requested at\n        #             the same time. When db access is removed from\n        #             compute, the bdm will be created here and we will\n        #             have to make sure that they are assigned atomically.\n        volume_bdm = self.compute_rpcapi.reserve_block_device_name(\n            context, instance, device, volume_id, disk_bus=disk_bus,\n            device_type=device_type)\n        try:\n            volume = self.volume_api.get(context, volume_id)\n            self.volume_api.check_attach(context, volume, instance=instance)\n            self.volume_api.reserve_volume(context, volume_id)\n            self.compute_rpcapi.attach_volume(context, instance=instance,\n                    volume_id=volume_id, mountpoint=device, bdm=volume_bdm)\n        except Exception:\n            with excutils.save_and_reraise_exception():\n                volume_bdm.destroy()\n\n        return volume_bdm.device_name\n\n\nIf timeout occurs, a dummy BDM record is left in database. As a result, you will see an attached volume when run nova show, which is wrong.\n\nThe trace:\n---\n2016-08-03 10:29:29.929 4508 ERROR nova.api.openstack [req-9036ab02-c49e-408e-9914-1627175e9158 a3e789e51d6243e493483d12593757a6 597854e23bfe46abb6178f786af12391 - - -] Caught error: Timed out waiting for a reply to message ID ddf15f1d53764aa090920c64852e4fba\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack Traceback (most recent call last):\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/__init__.py\", line 125, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return req.get_response(self.application)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/request.py\", line 1296, in send\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     application, catch_exc_info=False)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/request.py\", line 1260, in call_application\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 144, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return resp(environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/keystonemiddleware/auth_token/__init__.py\", line 634, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return self._call_app(env, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/keystonemiddleware/auth_token/__init__.py\", line 554, in _call_app\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return self._app(env, _fake_start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 144, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return resp(environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 144, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return resp(environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/routes/middleware.py\", line 131, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 144, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return resp(environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 130, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 195, in call_func\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py\", line 756, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     content_type, body, accept)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py\", line 821, in _process_stack\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py\", line 911, in dispatch\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return method(req=request, **action_args)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/contrib/volumes.py\", line 305, in create\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     volume_id, device)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 230, in wrapped\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return func(self, context, target, *args, **kwargs)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 219, in inner\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return function(self, context, instance, *args, **kwargs)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 200, in inner\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return f(self, context, instance, *args, **kw)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 3147, in attach_volume\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     disk_bus, device_type)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 3119, in _attach_volume\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     device_type=device_type)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/rpcapi.py\", line 846, in reserve_block_device_name\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     volume_bdm = cctxt.call(ctxt, 'reserve_block_device_name', **kw)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/client.py\", line 156, in call\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     retry=self.retry)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/transport.py\", line 90, in _send\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     timeout=timeout, retry=retry)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 350, in send\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     retry=retry)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 339, in _send\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     result = self._waiter.wait(msg_id, timeout)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 243, in wait\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     message = self.waiters.get(msg_id, timeout=timeout)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 149, in get\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     'to message ID %s' % msg_id)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack MessagingTimeout: Timed out waiting for a reply to message ID ddf15f1d53764aa090920c64852e4fba\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack\n2016-08-03 10:29:29.932 4508 INFO nova.api.openstack [req-9036ab02-c49e-408e-9914-1627175e9158 a3e789e51d6243e493483d12593757a6 597854e23bfe46abb6178f786af12391 - - -] http://vip.haproxy.bcec.core:8774/v2/597854e23bfe46abb6178f786af12391/servers/34ed7a04-bd0a-4a65-b832-725319bf6847/os-volume_attachments returned with HTTP 500\n2016-08-03 10:29:29.933 4508 DEBUG nova.api.openstack.wsgi [req-9036ab02-c49e-408e-9914-1627175e9158 a3e789e51d6243e493483d12593757a6 597854e23bfe46abb6178f786af12391 - - -] Returning 500 to user: The server has either erred or is incapable of performing the requested operation. __call__ /usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py:1166\n2016-08-03 10:29:29.934 4508 INFO nova.osapi_compute.wsgi.server [req-9036ab02-c49e-408e-9914-1627175e9158 a3e789e51d6243e493483d12593757a6 597854e23bfe46abb6178f786af12391 - - -] Traceback (most recent call last):\n  File \"/usr/lib/python2.7/site-packages/eventlet/wsgi.py\", line 483, in handle_one_response\n    write(b''.join(towrite))\n  File \"/usr/lib/python2.7/site-packages/eventlet/wsgi.py\", line 426, in write\n    _writelines(towrite)\n  File \"/usr/lib64/python2.7/socket.py\", line 334, in writelines\n    self.flush()\n  File \"/usr/lib64/python2.7/socket.py\", line 303, in flush\n    self._sock.sendall(view[write_offset:write_offset+buffer_size])\n  File \"/usr/lib/python2.7/site-packages/eventlet/greenio/base.py\", line 376, in sendall\n    tail = self.send(data, flags)\n  File \"/usr/lib/python2.7/site-packages/eventlet/greenio/base.py\", line 359, in send\n    total_sent += fd.send(data[total_sent:], flags)\nerror: [Errno 104] Connection reset by peer\n2016-08-03 10:29:29.934 4508 INFO nova.osapi_compute.wsgi.server [req-9036ab02-c49e-408e-9914-1627175e9158 a3e789e51d6243e493483d12593757a6 597854e23bfe46abb6178f786af12391 - - -] 172.16.187.56,172.16.216.1 \"POST /v2/597854e23bfe46abb6178f786af12391/servers/34ed7a04-bd0a-4a65-b832-725319bf6847/os-volume_attachments HTTP/1.1\" status: 500 len: 0 time: 300.0823390\n---\n\nThe master branch has the same issue.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1615908", 
    "owner": "None", 
    "id": 1615908, 
    "index": 6388, 
    "created": "2016-08-23 03:45:36.449003+00:00", 
    "title": "dummy BDM record if reserve_block_device_name timeout", 
    "comments": [
        {
            "content": "When attaching a volume, nova-api will initiate a rpc call to nova-compute to run reserve_block_device_name:\n\n    def _attach_volume(self, context, instance, volume_id, device,\n                       disk_bus, device_type):\n        \"\"\"Attach an existing volume to an existing instance.\n\n        This method is separated to make it possible for cells version\n        to override it.\n        \"\"\"\n        # NOTE(vish): This is done on the compute host because we want\n        #             to avoid a race where two devices are requested at\n        #             the same time. When db access is removed from\n        #             compute, the bdm will be created here and we will\n        #             have to make sure that they are assigned atomically.\n        volume_bdm = self.compute_rpcapi.reserve_block_device_name(\n            context, instance, device, volume_id, disk_bus=disk_bus,\n            device_type=device_type)\n        try:\n            volume = self.volume_api.get(context, volume_id)\n            self.volume_api.check_attach(context, volume, instance=instance)\n            self.volume_api.reserve_volume(context, volume_id)\n            self.compute_rpcapi.attach_volume(context, instance=instance,\n                    volume_id=volume_id, mountpoint=device, bdm=volume_bdm)\n        except Exception:\n            with excutils.save_and_reraise_exception():\n                volume_bdm.destroy()\n\n        return volume_bdm.device_name\n\n\nIf timeout occurs, a dummy BDM record is left in database. As a result, you will see an attached volume when run nova show, which is wrong.\n\nThe trace:\n---\n2016-08-03 10:29:29.929 4508 ERROR nova.api.openstack [req-9036ab02-c49e-408e-9914-1627175e9158 a3e789e51d6243e493483d12593757a6 597854e23bfe46abb6178f786af12391 - - -] Caught error: Timed out waiting for a reply to message ID ddf15f1d53764aa090920c64852e4fba\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack Traceback (most recent call last):\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/__init__.py\", line 125, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return req.get_response(self.application)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/request.py\", line 1296, in send\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     application, catch_exc_info=False)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/request.py\", line 1260, in call_application\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 144, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return resp(environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/keystonemiddleware/auth_token/__init__.py\", line 634, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return self._call_app(env, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/keystonemiddleware/auth_token/__init__.py\", line 554, in _call_app\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return self._app(env, _fake_start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 144, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return resp(environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 144, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return resp(environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/routes/middleware.py\", line 131, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 144, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return resp(environ, start_response)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 130, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/webob/dec.py\", line 195, in call_func\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py\", line 756, in __call__\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     content_type, body, accept)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py\", line 821, in _process_stack\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py\", line 911, in dispatch\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return method(req=request, **action_args)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/contrib/volumes.py\", line 305, in create\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     volume_id, device)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 230, in wrapped\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return func(self, context, target, *args, **kwargs)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 219, in inner\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return function(self, context, instance, *args, **kwargs)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 200, in inner\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     return f(self, context, instance, *args, **kw)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 3147, in attach_volume\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     disk_bus, device_type)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 3119, in _attach_volume\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     device_type=device_type)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/rpcapi.py\", line 846, in reserve_block_device_name\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     volume_bdm = cctxt.call(ctxt, 'reserve_block_device_name', **kw)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/client.py\", line 156, in call\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     retry=self.retry)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/transport.py\", line 90, in _send\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     timeout=timeout, retry=retry)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 350, in send\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     retry=retry)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 339, in _send\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     result = self._waiter.wait(msg_id, timeout)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 243, in wait\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     message = self.waiters.get(msg_id, timeout=timeout)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 149, in get\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack     'to message ID %s' % msg_id)\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack MessagingTimeout: Timed out waiting for a reply to message ID ddf15f1d53764aa090920c64852e4fba\n2016-08-03 10:29:29.929 4508 TRACE nova.api.openstack\n2016-08-03 10:29:29.932 4508 INFO nova.api.openstack [req-9036ab02-c49e-408e-9914-1627175e9158 a3e789e51d6243e493483d12593757a6 597854e23bfe46abb6178f786af12391 - - -] http://vip.haproxy.bcec.core:8774/v2/597854e23bfe46abb6178f786af12391/servers/34ed7a04-bd0a-4a65-b832-725319bf6847/os-volume_attachments returned with HTTP 500\n2016-08-03 10:29:29.933 4508 DEBUG nova.api.openstack.wsgi [req-9036ab02-c49e-408e-9914-1627175e9158 a3e789e51d6243e493483d12593757a6 597854e23bfe46abb6178f786af12391 - - -] Returning 500 to user: The server has either erred or is incapable of performing the requested operation. __call__ /usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py:1166\n2016-08-03 10:29:29.934 4508 INFO nova.osapi_compute.wsgi.server [req-9036ab02-c49e-408e-9914-1627175e9158 a3e789e51d6243e493483d12593757a6 597854e23bfe46abb6178f786af12391 - - -] Traceback (most recent call last):\n  File \"/usr/lib/python2.7/site-packages/eventlet/wsgi.py\", line 483, in handle_one_response\n    write(b''.join(towrite))\n  File \"/usr/lib/python2.7/site-packages/eventlet/wsgi.py\", line 426, in write\n    _writelines(towrite)\n  File \"/usr/lib64/python2.7/socket.py\", line 334, in writelines\n    self.flush()\n  File \"/usr/lib64/python2.7/socket.py\", line 303, in flush\n    self._sock.sendall(view[write_offset:write_offset+buffer_size])\n  File \"/usr/lib/python2.7/site-packages/eventlet/greenio/base.py\", line 376, in sendall\n    tail = self.send(data, flags)\n  File \"/usr/lib/python2.7/site-packages/eventlet/greenio/base.py\", line 359, in send\n    total_sent += fd.send(data[total_sent:], flags)\nerror: [Errno 104] Connection reset by peer\n2016-08-03 10:29:29.934 4508 INFO nova.osapi_compute.wsgi.server [req-9036ab02-c49e-408e-9914-1627175e9158 a3e789e51d6243e493483d12593757a6 597854e23bfe46abb6178f786af12391 - - -] 172.16.187.56,172.16.216.1 \"POST /v2/597854e23bfe46abb6178f786af12391/servers/34ed7a04-bd0a-4a65-b832-725319bf6847/os-volume_attachments HTTP/1.1\" status: 500 len: 0 time: 300.0823390\n---\n\nThe master branch has the same issue.", 
            "date_created": "2016-08-23 03:45:36.449003+00:00", 
            "author": "https://api.launchpad.net/1.0/~felix23ma"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/358940", 
            "date_created": "2016-08-23 03:54:04.954876+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Another case:\n\nvolume 47567cf1-60d3-471d-997d-fad7e69ef95b is attached to two instances due to this bug:\n--\nMySQL [nova]> select device_name,volume_id, deleted, id, instance_uuid from block_device_mapping where volume_id='47567cf1-60d3-471d-997d-fad7e69ef95b';\n+-------------+--------------------------------------+---------+--------+--------------------------------------+\n| device_name | volume_id                            | deleted | id     | instance_uuid                        |\n+-------------+--------------------------------------+---------+--------+--------------------------------------+\n| /dev/vdc    | 47567cf1-60d3-471d-997d-fad7e69ef95b |  0 | 883886 | bb57d884-9fab-4196-b5c5-0c48c2aa7ba4 |\n| /dev/vdd    | 47567cf1-60d3-471d-997d-fad7e69ef95b |  0 | 883889 | bb57d884-9fab-4196-b5c5-0c48c2aa7ba4 |\n| /dev/vdc    | 47567cf1-60d3-471d-997d-fad7e69ef95b |  0 | 883892 | b339c763-e509-4303-ba11-4a26d131ddff |\n+-------------+--------------------------------------+---------+--------+--------------------------------------+\n3 rows in set (0.00 sec)\n--\n\nThe first two records are dummy. In fact, the volume is attached to instance b339c763-e509-4303-ba11-4a26d131ddff.\nWhen user wants to detach it from this instance, it fails because nova gets the first BDM record (id=883886) whose connection_info = NULL.\n\nThe trace:\n--\n2016-08-23 18:31:28.512 3374 ERROR oslo_messaging.rpc.dispatcher [req-f8d95ba1-97d3-4ee7-90e2-9bf935bc51cd e3514550876d4a278178e3115a8d9391 77b68e76671646b3ab1850a80f6856ec - - -] Exception during message handling: <type 'NoneType'> can't be decoded\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 6978, in detach_volume\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     return self.manager.detach_volume(ctxt, volume_id, instance=instance)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 453, in decorated_function\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     payload)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 333, in decorated_function\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     LOG.warning(msg, e, instance_uuid=instance_uuid)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 304, in decorated_function\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 361, in decorated_function\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 349, in decorated_function\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5037, in detach_volume\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     self._detach_volume(context, volume_id, instance)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5018, in _detach_volume\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     self._driver_detach_volume(context, instance, bdm)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4953, in _driver_detach_volume\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     connection_info = jsonutils.loads(bdm.connection_info)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_serialization/jsonutils.py\", line 215, in loads\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     return json.loads(encodeutils.safe_decode(s, encoding), **kwargs)\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/encodeutils.py\", line 33, in safe_decode\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher     raise TypeError(\"%s can't be decoded\" % type(text))\n2016-08-23 18:31:28.512 3374 TRACE oslo_messaging.rpc.dispatcher TypeError: <type 'NoneType'> can't be decoded\n--\n", 
            "date_created": "2016-08-24 01:15:16.762252+00:00", 
            "author": "https://api.launchpad.net/1.0/~felix23ma"
        }, 
        {
            "content": "Change abandoned by Sean Dague (<email address hidden>) on branch: master\nReview: https://review.openstack.org/358940\nReason: This review is > 6 weeks without comment, and failed Jenkins the last time it was checked. We are abandoning this for now. Feel free to reactivate the review by pressing the restore button and leaving a 'recheck' comment to get fresh test results.", 
            "date_created": "2016-12-09 21:08:04.365597+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "\nThere are no currently open reviews on this bug, changing\nthe status back to the previous state and unassigning. If\nthere are active reviews related to this bug, please include\nlinks in comments.\n", 
            "date_created": "2017-06-23 12:46:29.161319+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "I see the stack traces, could you build a reproduce here with the openstack client so that could try to replicate on master?", 
            "date_created": "2017-07-28 17:01:28.330120+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2017-09-27 04:18:13.594341+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ]
}