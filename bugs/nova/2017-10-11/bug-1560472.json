{
    "status": "Invalid", 
    "last_updated": "2016-06-02 19:00:18.968557+00:00", 
    "description": "Problem description:\nThe nova interface-attach command removes pre-existing neutron ports from the environment if it fails to attach to an instance _even_ where '--port-id' has been specified. This behaviour was introduced by fixing bug #1338551 [1].\n\nSteps to reproduce:\n1) create a new neutron port\n\u00a0\u00a0$ neutron port-create --name <port-name> <network-name>\n2) boot an instance (make sure to specify a keypair and check sec groups for ssh connectivity to the instance)\n\u00a0\u00a0$ nova boot ...\n3) [OPTIONAL] add/remove the port several times over to prove the funtionality is working OK.\n\u00a0\u00a0$ nova interface-attach --port-id <port-id> <instance-name>\n\u00a0\u00a0$ nova interface-detach <instance-name> <port-id>\n4) simulate a kernel crash on the instance, as this should cause a scenario where an interface attach will fail (ssh connectivity is assumed for this step)\n\u00a0\u00a0$ ssh <instance-ip> \"sudo kill -11 1\" # OR execute 'echo c > /proc/sysrq-trigger' while connected to the instance\n\u00a0\u00a04a. Verify the kernel has actually crashed\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0$ nova console-log <instance-name>\n5) try to attach the port while the instance is still crashed # **note** if the port hasn't been attached before (i.e. you skipped step 3, it may succeed initially then it will fail on subsequent attach attempts). Also, at this point it should not matter if the port is still attached to the instance.\n\u00a0\u00a0$ nova interface-attach --port-id <port-id> <instance-name>\n\nErrors observed:\n$ nova interface-attach --port-id <port-id> <instance-name>\nERROR: Failed to attach interface (HTTP 500) (Request-ID: req-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)\n\nExpected results:\nThe port should still exist after failure in this scenario.\n\nActual results:\n'neutron port-list' will no longer show the port. It has been removed.\nThe port is removed from the environment and therefore is no longer available.\n\nSnippet from /var/log/nova/nova-compute.log\n\n[instance: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx] attaching network adapter failed.\n\u00a0Traceback (most recent call last):\n\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1263, in attach_interface\n\u00a0\u00a0\u00a0\u00a0\u00a0virt_dom.attachDeviceFlags(cfg.to_xml(), flags)\n\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n\u00a0\u00a0\u00a0\u00a0\u00a0result = proxy_call(self._autowrap, f, *args, **kwargs)\n\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n\u00a0\u00a0\u00a0\u00a0\u00a0rv = execute(f, *args, **kwargs)\n\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n\u00a0\u00a0\u00a0\u00a0\u00a0six.reraise(c, e, tb)\n\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n\u00a0\u00a0\u00a0\u00a0\u00a0rv = meth(*args, **kwargs)\n\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 513, in attachDeviceFlags\n\u00a0\u00a0\u00a0\u00a0\u00a0if ret == -1: raise libvirtError ('virDomainAttachDeviceFlags() failed', dom=self)\n\u00a0libvirtError: Unable to create tap device tapxxxxxxxx-xx: Device or resource busy\n\u00a0attach interface failed , try to deallocate port xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx, reason: Failed to attach network adapter device to xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n\u00a0Exception during message handling: Failed to attach network adapter device to xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n\nFull error:\nhttp://pastebin.ubuntu.com/15471511/\n\n$ sudo apt-cache policy nova-compute\nnova-compute:\n\u00a0\u00a0Installed: 1:2015.1.2-0ubuntu2~cloud0\n\nUbuntu 14.04.4 LTS\n\nWhy does this matter:\nAs specified in [1], where a port has been attached using --net-id option it is automatically created before attaching to the VM. Therefore, it is the correct behaviour to cleanup after a failure to attach.\nWhere \"--port-id\" has been specified, it should not be assumed that it was auto created, it has been specifically created and therefore may have pre-existed the VM, this means the port should be re-usable if desired and therefore should not be cleaned up in the case of attach failure. When the port has been pre-created and '--port-id' is specified in the interface-attach command, if the action fails to attach it should be handled without being removed from the environment and exist for re-assignment to another instance or for retry to the original instance once it has recovered from it's failure.\n\nThis behaviour is confirmed on both Kilo and Liberty.\n\nRelated bugs:\n[1] https://bugs.launchpad.net/nova/+bug/1338551", 
    "tags": [
        "libvirt", 
        "neutron"
    ], 
    "importance": "Low", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1560472", 
    "owner": "https://api.launchpad.net/1.0/~sreenivas-pothukanoori", 
    "id": 1560472, 
    "index": 711, 
    "created": "2016-03-22 12:30:14.703360+00:00", 
    "title": "nova interface-attach command removes pre-existing neutron ports from the environment if it fails to attach to an instance _even_ where '--port-id' has been specified", 
    "comments": [
        {
            "content": "Problem description:\nThe nova interface-attach command removes pre-existing neutron ports from the environment if it fails to attach to an instance _even_ where '--port-id' has been specified. This behaviour was introduced by fixing bug #1338551 [1].\n\nSteps to reproduce:\n1) create a new neutron port\n  $ neutron port-create --name <port-name> <network-name>\n2) boot an instance (make sure to specify a keypair and check sec groups for ssh connectivity to the instance)\n  $ nova boot ...\n3) [OPTIONAL] add/remove the port several times over to prove the funtionality is working OK.\n  $ nova interface-attach --port-id <port-id> <instance-name>\n  $ nova interface-detach <instance-name> <port-id>\n4) simulate a kernel crash on the instance, as this should cause a scenario where an interface attach will fail (ssh connectivity is assumed for this step)\n  $ ssh <instance-ip> \"sudo kill -11 1\" # OR execute 'echo c > /proc/sysrq-trigger' while connected to the instance\n  4a. Verify the kernel has actually crashed\n      $ nova console-log <instance-name>\n5) try to attach the port while the instance is still crashed # **note** if the port hasn't been attached before (i.e. you skipped step 3, it may succeed initially then it will fail on subsequent attach attempts). Also, at this point it should not matter if the port is still attached to the instance.\n  $ nova interface-attach --port-id <port-id> <instance-name>\n\nErrors observed:\n$ nova interface-attach --port-id <port-id> <instance-name>\nERROR: Failed to attach interface (HTTP 500) (Request-ID: req-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)\n\nExpected results:\nThe port should still exist after failure in this scenario.\n\nActual results:\n'neutron port-list' will no longer show the port. It has been removed.\nThe port is removed from the environment and therefore is no longer available.\n\nSnippet from /var/log/nova/nova.log\n\n[instance: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx] attaching network adapter failed.\n Traceback (most recent call last):\n   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1263, in attach_interface\n     virt_dom.attachDeviceFlags(cfg.to_xml(), flags)\n   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n     result = proxy_call(self._autowrap, f, *args, **kwargs)\n   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n     rv = execute(f, *args, **kwargs)\n   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n     six.reraise(c, e, tb)\n   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n     rv = meth(*args, **kwargs)\n   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 513, in attachDeviceFlags\n     if ret == -1: raise libvirtError ('virDomainAttachDeviceFlags() failed', dom=self)\n libvirtError: Unable to create tap device tapxxxxxxxx-xx: Device or resource busy\n attach interface failed , try to deallocate port xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx, reason: Failed to attach network adapter device to xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n Exception during message handling: Failed to attach network adapter device to xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n\nFull error:\nhttp://pastebin.ubuntu.com/15471511/\n\n$ sudo apt-cache policy nova-compute\nnova-compute:\n  Installed: 1:2015.1.2-0ubuntu2~cloud0\n\nUbuntu 14.04.4 LTS\n\n\nWhy does this matter:\nAs specified in [1], where a port has been attached using --net-id option it is automatically created before attaching to the VM. Therefore, it is the correct behaviour to cleanup after a failure to attach.\nWhere \"--port-id\" has been specified, it should not be assumed that it was auto created, it has been specifically created and therefore may have pre-existed the VM, this means the port should be re-usable if desired and therefore should not be cleaned up in the case of attach failure. When the port has been pre-created and '--port-id' is specified in the interface-attach command, if the action fails to attach it should be handled without being removed from the environment and exist for re-assignment to another instance or for retry to the original instance once it has recovered from it's failure.\n\nThis behaviour is confirmed on both Kilo and Liberty.\n\nRelated bugs:\n[1] https://bugs.launchpad.net/nova/+bug/1338551", 
            "date_created": "2016-03-22 12:30:14.703360+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikee-cunningham"
        }, 
        {
            "content": "I tried to reproduce this issue on Kilo & Liberty versions, but I haven't observed the reported issue.\n\nI have followed the below steps:\n1. Logged in as admin user using \"source admin-openrc.sh\".\n\n2. Created network port using \"neutron port-create --name port-id net-name\"\n+--------------------------------------+-----------+-------------------+--------------------------------------------------------------------------------------+\n| id                                   | name      | mac_address       | fixed_ips                                                                            |\n+--------------------------------------+-----------+-------------------+--------------------------------------------------------------------------------------+\n| be34ff0c-ca67-4d41-9fd8-12eb9caa46c1 | demoPort2 | fa:16:3e:29:c0:09 | {\"subnet_id\": \"caed0666-05f3-414a-b5b7-4eceeb0ca5ae\", \"ip_address\": \"172.16.1.36\"}   |\n+--------------------------------------+-----------+-------------------+--------------------------------------------------------------------------------------+\n\n3. Created security group with the following details:\n+-------------+-----------+---------+-----------+--------------+\n| IP Protocol | From Port | To Port | IP Range  | Source Group |\n+-------------+-----------+---------+-----------+--------------+\n| icmp        | -1        | -1      | 0.0.0.0/0 |              |\n|             |           |         |           | default      |\n|             |           |         |           | default      |\n| tcp         | 22        | 22      | 0.0.0.0/0 |              |\n+-------------+-----------+---------+-----------+--------------+\n\n4.Launched the VM using \"nova boot --flavor m1.tiny --image cirros --nic net-id=network-id --security-group default --key-name mykey DemoVM\".\n\n5.Attached interface to the DemoVM and detached it. Performed this step twice using the below commands:\nnova interface-attach --port-id <port-id> <instance-name>\nnova interface-detach <instance-name> <port-id>\n\n6. connected to the VM instance console with VM IP using \"ip netns exec qdhcp-net_id ssh -i mykey cirros@172.16.1.37 \n7. Simulated kernel crash by executing \"echo c > /proc/sysrq-trigger\" on VM instance console and crashed the VM kernel.\n8. Opened console log using \"nova console-log <instance-name>\" and checked for the crash message(Kernel Panic).\n9. Now again tried to attach the port(demoPort2) by using \"nova interface-attach --port-id <port-id> <instance-name>\"\n\nAfter running the above command, I didn't get any confirmation/error message on console and interface is attached successfully.\nIn VM details(\"nova show <vm-name>\") I have seen the attached interface(i.e 172.16.1.36) and also the port information is not removed from the port-list( neutron port-list) . \n\n\nplease check the above steps and let me know if I missed any steps to reproduce the issue.", 
            "date_created": "2016-03-30 09:36:55.935789+00:00", 
            "author": "https://api.launchpad.net/1.0/~sreenivas-pothukanoori"
        }, 
        {
            "content": "Hi Michael,\n\nI have tried to reproduce the issue in my Kilo & Liberty versions but it is working as per the expected behavior.\nplease find the steps which I mentioned in comment #1 and let me know your inputs on this bug to move forward.", 
            "date_created": "2016-04-25 07:32:10.696015+00:00", 
            "author": "https://api.launchpad.net/1.0/~sreenivas-pothukanoori"
        }, 
        {
            "content": "This bug lacks the necessary information to effectively reproduce and fix it, therefore it has been closed. Feel free to reopen the bug by providing the requested information and set the bug status back to ''New'", 
            "date_created": "2016-06-02 19:00:01.486483+00:00", 
            "author": "https://api.launchpad.net/1.0/~siva-radhakrishnan"
        }
    ]
}