{
    "status": "Fix Released", 
    "last_updated": "2014-09-22 22:22:08.109444+00:00", 
    "description": "when using at least two compute nodes using KVM, and use NFS share_storage to test resize an instance.\nThe configuration of NFS used the introduction about live-migration using NFS in community doc.\n\nwhen executed command \"nova resize ae6f9472-3080-4e86-8a52-f8e642081d15\", can work well, and the instance's state will change to \"VERIFY_RESIZE',  Then I resize-confirm it, nova met the issue as follow:\n\n{u'message': u\"[Errno 39] Directory not empty: '/KVM/stack/data/nova/instances/ae6f9472-3080-4e86-8a52-f8e642081d15_resize'\", u'code': 500, u'details': u'  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 263, in decorated_function |\n|                                      |     return function(self, context, *args, **kwargs)                                                                                                                                                                                                               |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2700, in confirm_resize                                                                                                                                                                   |\n|                                      |     do_confirm_resize(context, instance, migration_id)                                                                                                                                                                                                            |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 246, in inner                                                                                                                                                                  |\n|                                      |     return f(*args, **kwargs)                                                                                                                                                                                                                                     |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2697, in do_confirm_resize                                                                                                                                                                |\n|                                      |     migration=migration)                                                                                                                                                                                                                                          |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2724, in _confirm_resize                                                                                                                                                                  |\n|                                      |     network_info)                                                                                                                                                                                                                                                 |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 4623, in confirm_migration                                                                                                                                                            |\n|                                      |     self._cleanup_resize(instance, network_info)                                                                                                                                                                                                                  |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1018, in _cleanup_resize                                                                                                                                                              |\n|                                      |     shutil.rmtree(target)                                                                                                                                                                                                                                         |\n|                                      |   File \"/usr/lib64/python2.6/shutil.py\", line 221, in rmtree                                                                                                                                                                                                      |\n|                                      |     onerror(os.rmdir, path, sys.exc_info())                                                                                                                                                                                                                       |\n|                                      |   File \"/usr/lib64/python2.6/shutil.py\", line 219, in rmtree                                                                                                                                                                                                      |\n|                                      |     os.rmdir(path)                                                                                                                                                                                                                                                |\n|                                      | ', u'created': u'2013-10-22T15:10:50Z'}\n\ncd /KVM/stack/data/nova/instances/be962096-a539-46c7-ae66-9ea383809e9b_resize\n[root@cc be962096-a539-46c7-ae66-9ea383809e9b_resize]# ls -al\ntotal 24340\ndrwxr-xr-x  2 nobody nobody     4096 Oct 18  2013 .\ndrwxrwxrwx 14 root   root       4096 Oct 18  2013 ..\n-rw-r--r--  1 nobody nobody 25034752 Oct 18  2013 .nfs000000000714002e00000001", 
    "tags": [
        "in-stable-havana"
    ], 
    "importance": "Undecided", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1248019", 
    "owner": "https://api.launchpad.net/1.0/~chenxiao", 
    "id": 1248019, 
    "index": 4261, 
    "created": "2013-11-05 03:04:57.824807+00:00", 
    "title": "OSError occours when try to resize-confirm an instance with status 'VERIFY_RESIZE' using NFS bankend (KVM)", 
    "comments": [
        {
            "content": "when using at least two compute nodes, and use NFS share_storage to test resize an instance.\nThe configuration of NFS used the introduction about live-migration using NFS in community doc.\n\nwhen executed command \"nova resize ae6f9472-3080-4e86-8a52-f8e642081d15\", can work well, and the instance's state will change to \"VERIFY_RESIZE',  Then I resize-confirm it, nova met the issue as follow:\n\n{u'message': u\"[Errno 39] Directory not empty: '/KVM/stack/data/nova/instances/ae6f9472-3080-4e86-8a52-f8e642081d15_resize'\", u'code': 500, u'details': u'  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 263, in decorated_function |\n|                                      |     return function(self, context, *args, **kwargs)                                                                                                                                                                                                               |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2700, in confirm_resize                                                                                                                                                                   |\n|                                      |     do_confirm_resize(context, instance, migration_id)                                                                                                                                                                                                            |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 246, in inner                                                                                                                                                                  |\n|                                      |     return f(*args, **kwargs)                                                                                                                                                                                                                                     |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2697, in do_confirm_resize                                                                                                                                                                |\n|                                      |     migration=migration)                                                                                                                                                                                                                                          |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2724, in _confirm_resize                                                                                                                                                                  |\n|                                      |     network_info)                                                                                                                                                                                                                                                 |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 4623, in confirm_migration                                                                                                                                                            |\n|                                      |     self._cleanup_resize(instance, network_info)                                                                                                                                                                                                                  |\n|                                      |   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1018, in _cleanup_resize                                                                                                                                                              |\n|                                      |     shutil.rmtree(target)                                                                                                                                                                                                                                         |\n|                                      |   File \"/usr/lib64/python2.6/shutil.py\", line 221, in rmtree                                                                                                                                                                                                      |\n|                                      |     onerror(os.rmdir, path, sys.exc_info())                                                                                                                                                                                                                       |\n|                                      |   File \"/usr/lib64/python2.6/shutil.py\", line 219, in rmtree                                                                                                                                                                                                      |\n|                                      |     os.rmdir(path)                                                                                                                                                                                                                                                |\n|                                      | ', u'created': u'2013-10-22T15:10:50Z'}", 
            "date_created": "2013-11-05 03:04:57.824807+00:00", 
            "author": "https://api.launchpad.net/1.0/~chenxiao"
        }, 
        {
            "content": "Sorry, I do not explain the detail \nwhen executed command \"nova resize ae6f9472-3080-4e86-8a52-f8e642081d15\", can work well, and the instance's state will change to \"VERIFY_RESIZE', Then I resize-confirm it,  OpenStack will try to delete a directory which contains instance files (Debug to shutil.rmtree(target)), but in NFS , the directory will be accessed by qemu-kvm,  according NFS working mechanism, it will create .nfsxxxx in the directory,  then show the error \"\"[Errno 39] Directory not empty:\".\n\nThese .nfs files are apparently created when you delete a directory that is accessed by a process.\nhttp://librelist.com/browser//libgit2/2012/4/3/file-locking-in-libgit2/#7a19b8c37c5235ddfd60ff8a137c94ef\n\nI see one discuss about NFS said, according to kernel nfs-client code, NFS will rename opening files to .nfsxxx, but every file it is about to unlink. Files that are not held open just then disappear so fast that it normally does not matter and you do not see the renamed file. Maybe in our case the files are not actually open, but the nfs just takes a while to send back an ack for the rpc call. \nso use 'retry' to delete the useless files\n", 
            "date_created": "2013-11-14 15:56:08.214650+00:00", 
            "author": "https://api.launchpad.net/1.0/~chenxiao"
        }, 
        {
            "content": "https://review.openstack.org/#/c/55250/", 
            "date_created": "2013-12-05 03:42:18.670956+00:00", 
            "author": "https://api.launchpad.net/1.0/~chenxiao"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/55250\nCommitted: http://github.com/openstack/nova/commit/17d131661740e452e9729d9ac8881e6fede23dd7\nSubmitter: Jenkins\nBranch:    master\n\ncommit 17d131661740e452e9729d9ac8881e6fede23dd7\nAuthor: chenxiao <email address hidden>\nDate:   Tue Nov 5 18:04:42 2013 +0800\n\n    Libvirt:Instance resize confirm issue against NFS\n    \n    when I test resize-confirm on NFS (KVM) using at least two\n    compute nodes, OSError will occur when try to cleanup the\n    backup instance directory and will make instance status\n    \"Error\".\n    \n    One way to cleanup resize is using delay_on_retry and\n    maximum attempts setting. Replace rmtree() because\n    execute() have more parameters choices.\n    \n    Closes-Bug: #1248019\n    \n    Change-Id: Ifb9a500bbba805af0317307c2e7d6903dcd02ad1\n", 
            "date_created": "2013-12-10 14:35:23.527659+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/61764", 
            "date_created": "2013-12-12 15:08:02.251345+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/74245", 
            "date_created": "2014-02-18 03:35:51.627559+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/74245\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=384c5487a53aab41110668f5ae4564514248fd26\nSubmitter: Jenkins\nBranch:    stable/havana\n\ncommit 384c5487a53aab41110668f5ae4564514248fd26\nAuthor: chenxiao <email address hidden>\nDate:   Tue Nov 5 18:04:42 2013 +0800\n\n    Libvirt:Instance resize confirm issue against NFS\n    \n    when I test resize-confirm on NFS (KVM) using at least two\n    compute nodes, OSError will occur when try to cleanup the\n    backup instance directory and will make instance status\n    \"Error\".\n    \n    One way to cleanup resize is using delay_on_retry and\n    maximum attempts setting. Replace rmtree() because\n    execute() have more parameters choices.\n    \n    Closes-Bug: #1248019\n    \n    Change-Id: Ifb9a500bbba805af0317307c2e7d6903dcd02ad1\n    (cherry picked from commit 17d131661740e452e9729d9ac8881e6fede23dd7)\n", 
            "date_created": "2014-08-02 21:32:43.121865+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}