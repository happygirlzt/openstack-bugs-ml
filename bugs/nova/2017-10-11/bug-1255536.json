{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:11:28.988683+00:00", 
    "description": "We are using Havana with Ubuntu distribution with the following version,\n\n       nova-compute                      1:2013.2-0ubuntu1~cloud0\n\nIt seems that nova booting from image by using ceph/rbd as the image backend store is not functioning if the cephx auth user is not admin. Please see the log attached at the end of this report.\n\nLooking at the code at https://github.com/openstack/nova/blob/master/nova/virt/libvirt/utils.py, it seems that two rbd functions are implemented with default ceph/rbd admin user only and rbd_user parameter in nova.conf is not honored,\n\n       list_rbd_volumes(pool)\n       remove_rbd_volumes(pool, *names):\n\n---------------------------------------------------------------------\n2013-11-27 11:01:17.374 9105 DEBUG nova.block_device [req-c25a18df-8365-4804-8009-09eafc647c16 b893a14998d44dd1be27117ed47954ac e5ba1977bc1849179c7e7430be7496d2] block_device_list [] volume_in_mapping /usr/lib/python2.7/dist-packages/nova/block_device.py:496\n2013-11-27 11:01:17.375 9105 INFO nova.virt.libvirt.driver [req-c25a18df-8365-4804-8009-09eafc647c16 b893a14998d44dd1be27117ed47954ac e5ba1977bc1849179c7e7430be7496d2] [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Creating image\n2013-11-27 11:01:17.376 9105 DEBUG nova.openstack.common.processutils [req-c25a18df-8365-4804-8009-09eafc647c16 b893a14998d44dd1be27117ed47954ac e5ba1977bc1849179c7e7430be7496d2] Running cmd (subprocess): rbd -p svl-stack-mgmt-openstack-volumes ls execute /usr/lib/python2.7/dist-packages/nova/openstack/common/processutils.py:147\n2013-11-27 11:01:17.399 9105 DEBUG nova.openstack.common.processutils [req-c25a18df-8365-4804-8009-09eafc647c16 b893a14998d44dd1be27117ed47954ac e5ba1977bc1849179c7e7430be7496d2] Result was 1 execute /usr/lib/python2.7/dist-packages/nova/openstack/common/processutils.py:172\n2013-11-27 11:01:17.401 9105 ERROR nova.compute.manager [req-c25a18df-8365-4804-8009-09eafc647c16 b893a14998d44dd1be27117ed47954ac e5ba1977bc1849179c7e7430be7496d2] [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Instance failed to spawn\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Traceback (most recent call last):\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1407, in _spawn\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     block_device_info)\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2063, in spawn\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     admin_pass=admin_password)\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2353, in _create_image\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     project_id=instance['project_id'])\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/imagebackend.py\", line 172, in cache\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     if not self.check_image_exists() or not os.path.exists(base):\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/imagebackend.py\", line 499, in check_image_exists\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     rbd_volumes = libvirt_utils.list_rbd_volumes(self.pool)\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/utils.py\", line 270, in list_rbd_volumes\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     out, err = utils.execute('rbd', '-p', pool, 'ls')\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 177, in execute\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     return processutils.execute(*cmd, **kwargs)\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Command: rbd -p svl-stack-mgmt-openstack-volumes ls\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Exit code: 1\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Stdout: ''\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Stderr: \"2013-11-27 11:01:17.397471 7fd488fd2780 -1 monclient(hunting): authenticate NOTE: no keyring found; disabled cephx authentication\\n2013-11-27 11:01:17.397490 7fd488fd2780  0 librados: client.admin authentication error (95) Operation not supported\\nrbd: couldn't connect to the cluster!\\n\"\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] \n\n--------------------------\n\nI have the following in nova.conf on nova compute node,\n\n         # storage configuration for default nova boot \n         libvirt_images_type=rbd\n         libvirt_images_rbd_pool=svl-stack-mgmt-openstack-volumes\n         libvirt_images_rbd_ceph_conf=/etc/ceph/ceph.conf\n         rbd_user=svl-stack-mgmt-openstack-volumes\n         rbd_secret_uuid=e7724cad-32f8-d4ce-6c68-5f40491b15dd\n\nI have the following in /etc/ceph/\n\n      -rw-r--r--  1 root root  266 Nov 27 01:09 ceph.client.svl-stack-mgmt-openstack-volumes.keyring\n      -rw-r--r--  1 root root  494 Nov 25 23:28 ceph.conf\n\nFor virsh secrets, I have \n\n> root@svl-cc-nova1-002:/var/log/nova# virsh secret-list\n      UUID                                 Usage\n      -----------------------------------------------------------\n      e7724cad-32f8-d4ce-6c68-5f40491b15dd Unused\n\n> root@svl-cc-nova1-002:/var/log/nova# virsh secret-get-value e7724cad-32f8-d4ce-6c68-5f40491b15dd\n          AQDSQZBR6CDwLhAAt99+BdfsdffMQw63dBId7A==\n\nI am able to execute the following command without error on the nova compute node,\n\n> rbd ls -p svl-stack-mgmt-openstack-volumes --id svl-stack-mgmt-openstack-volumes", 
    "tags": [
        "ceph", 
        "rbd"
    ], 
    "importance": "Undecided", 
    "heat": 28, 
    "link": "https://bugs.launchpad.net/nova/+bug/1255536", 
    "owner": "https://api.launchpad.net/1.0/~haomai", 
    "id": 1255536, 
    "index": 4335, 
    "created": "2013-11-27 13:35:11.422101+00:00", 
    "title": "Havana-ephemeral-rbd not working for non-admin ceph user", 
    "comments": [
        {
            "content": "We are using Havana with Ubuntu distribution with the following version,\n\n       nova-compute                      1:2013.2-0ubuntu1~cloud0\n\nIt seems that nova booting from image by using ceph/rbd as the image backend store is not functioning if the cephx auth user is not admin. Please see the log attached at the end of this report.\n\nLooking at the code at https://github.com/openstack/nova/blob/master/nova/virt/libvirt/utils.py, it seems that two rbd functions are implemented with default ceph/rbd admin user only and rbd_user parameter in nova.conf is not honored,\n\n       list_rbd_volumes(pool)\n       remove_rbd_volumes(pool, *names):\n\n---------------------------------------------------------------------\n2013-11-27 11:01:17.374 9105 DEBUG nova.block_device [req-c25a18df-8365-4804-8009-09eafc647c16 b893a14998d44dd1be27117ed47954ac e5ba1977bc1849179c7e7430be7496d2] block_device_list [] volume_in_mapping /usr/lib/python2.7/dist-packages/nova/block_device.py:496\n2013-11-27 11:01:17.375 9105 INFO nova.virt.libvirt.driver [req-c25a18df-8365-4804-8009-09eafc647c16 b893a14998d44dd1be27117ed47954ac e5ba1977bc1849179c7e7430be7496d2] [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Creating image\n2013-11-27 11:01:17.376 9105 DEBUG nova.openstack.common.processutils [req-c25a18df-8365-4804-8009-09eafc647c16 b893a14998d44dd1be27117ed47954ac e5ba1977bc1849179c7e7430be7496d2] Running cmd (subprocess): rbd -p svl-stack-mgmt-openstack-volumes ls execute /usr/lib/python2.7/dist-packages/nova/openstack/common/processutils.py:147\n2013-11-27 11:01:17.399 9105 DEBUG nova.openstack.common.processutils [req-c25a18df-8365-4804-8009-09eafc647c16 b893a14998d44dd1be27117ed47954ac e5ba1977bc1849179c7e7430be7496d2] Result was 1 execute /usr/lib/python2.7/dist-packages/nova/openstack/common/processutils.py:172\n2013-11-27 11:01:17.401 9105 ERROR nova.compute.manager [req-c25a18df-8365-4804-8009-09eafc647c16 b893a14998d44dd1be27117ed47954ac e5ba1977bc1849179c7e7430be7496d2] [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Instance failed to spawn\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Traceback (most recent call last):\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1407, in _spawn\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     block_device_info)\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2063, in spawn\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     admin_pass=admin_password)\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2353, in _create_image\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     project_id=instance['project_id'])\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/imagebackend.py\", line 172, in cache\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     if not self.check_image_exists() or not os.path.exists(base):\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/imagebackend.py\", line 499, in check_image_exists\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     rbd_volumes = libvirt_utils.list_rbd_volumes(self.pool)\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/utils.py\", line 270, in list_rbd_volumes\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     out, err = utils.execute('rbd', '-p', pool, 'ls')\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 177, in execute\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0]     return processutils.execute(*cmd, **kwargs)\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Command: rbd -p svl-stack-mgmt-openstack-volumes ls\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Exit code: 1\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Stdout: ''\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] Stderr: \"2013-11-27 11:01:17.397471 7fd488fd2780 -1 monclient(hunting): authenticate NOTE: no keyring found; disabled cephx authentication\\n2013-11-27 11:01:17.397490 7fd488fd2780  0 librados: client.admin authentication error (95) Operation not supported\\nrbd: couldn't connect to the cluster!\\n\"\n2013-11-27 11:01:17.401 9105 TRACE nova.compute.manager [instance: bf9351c7-5cb6-41e7-bd82-6d89f703dda0] \n\n--------------------------\n\nI have the following in nova.conf on nova compute node,\n\n         # storage configuration for default nova boot \n         libvirt_images_type=rbd\n         libvirt_images_rbd_pool=svl-stack-mgmt-openstack-volumes\n         libvirt_images_rbd_ceph_conf=/etc/ceph/ceph.conf\n         rbd_user=svl-stack-mgmt-openstack-volumes\n         rbd_secret_uuid=e7724cad-32f8-d4ce-6c68-5f40491b15dd\n\nI have the following in /etc/ceph/\n\n      -rw-r--r--  1 root root  266 Nov 27 01:09 ceph.client.svl-stack-mgmt-openstack-volumes.keyring\n      -rw-r--r--  1 root root  494 Nov 25 23:28 ceph.conf\n\nFor virsh secrets, I have \n\n> root@svl-cc-nova1-002:/var/log/nova# virsh secret-list\n      UUID                                 Usage\n      -----------------------------------------------------------\n      e7724cad-32f8-d4ce-6c68-5f40491b15dd Unused\n\n> root@svl-cc-nova1-002:/var/log/nova# virsh secret-get-value e7724cad-32f8-d4ce-6c68-5f40491b15dd\n          AQDSQZBR6CDwLhAAt99+BdfsdffMQw63dBId7A==\n\nI am able to execute the following command without error on the nova compute node,\n\n> rbd ls -p svl-stack-mgmt-openstack-volumes --id svl-stack-mgmt-openstack-volumes", 
            "date_created": "2013-11-27 13:35:11.422101+00:00", 
            "author": "https://api.launchpad.net/1.0/~wsun2"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/58910", 
            "date_created": "2013-11-28 02:53:59.502094+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/58910\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7104a6d8b1885f04d3012d621ec14f4be5145994\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7104a6d8b1885f04d3012d621ec14f4be5145994\nAuthor: Haomai Wang <email address hidden>\nDate:   Thu Nov 28 10:49:40 2013 +0800\n\n    Fix rbd backend not working for none admin ceph user\n    \n    The 'rbd_user' option allows nova administrators to override the default user\n    account used for RBD operations, with one that has potentially lower\n    privileges.  Not all parts of the Nova code honoured the 'rbd_user' option,\n    which resulted in failures when attempting to use a lesser privileged user for\n    RBD. This fix ensures the '--id' and '--config' parameters are passed to the\n    RBD command line tools in all cases.\n    \n    Change-Id: Id99aa303791143360ad78074184583048e4878f0\n    Close-bug: 1255536\n", 
            "date_created": "2014-01-22 15:46:21.190461+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/72552", 
            "date_created": "2014-02-11 04:08:20.837583+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}