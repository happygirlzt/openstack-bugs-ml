{
    "status": "Fix Released", 
    "last_updated": "2016-09-02 01:13:53.173137+00:00", 
    "description": "The 'require' policy is supposed to restrict instances to hosts that support hardware threads, e.g. HyperThreading. However, this filtering is done as part of the NUMATopologyFilter. If this filter is disabled, the host boots just fine. This should not be the case and needs to be fixed. Findings below.\n\n---\n\nTesting was conducted on a single-node, Fedora 23-based (4.3.5-300.fc23.x86_64)\nOpenStack instance (built with devstack). The system is a dual-socket, ten core,\nHT-enabled system (2 sockets * 10 cores * 2 threads = 40 \"pCPUs\".\n0-9,20-29 = node0, 10-19,30-39 = node1).\n\nCommit '8bafc9' of Nova was used.\n\n# Steps\n\n## Create flavors\n\n    $ openstack flavor create pinned.require \\\n        --id 102 --ram 2048 --disk 0 --vcpus 4\n    $ openstack flavor set pinned.require \\\n        --property \"hw:cpu_policy=dedicated\" \\\n        --property \"hw:cpu_thread_policy=require\"\n\n## Validate a HT-enabled node\n\nThe 'require' case is a stricter version of the `prefer` case, in that it\nshould fail if we have HyperThreading disabled, do not have enough free\nsibling sets, or have no HyperThreading support at all. However, since we're\nnot hitting any of these conditions on this host, things should function just\nlike they do for the `prefer` case. Therefore, the guest should see a two\nsockets with one core per socket and two threads per core.\n\n    $ openstack server create --flavor=pinned.require \\\n        --image=cirros-0.3.4-x86_64-uec --wait test1\n\n    $ sudo virsh list\n     Id    Name                           State\n    ----------------------------------------------------\n     2     instance-00000002              running\n\n    $ sudo virsh dumpxml 2\n    <domain type='kvm' id='2'>\n      <name>instance-00000002</name>\n      ...\n      <vcpu placement='static'>4</vcpu>\n      <cputune>\n        <shares>4096</shares>\n        <vcpupin vcpu='0' cpuset='1'/>\n        <vcpupin vcpu='1' cpuset='21'/>\n        <vcpupin vcpu='2' cpuset='0'/>\n        <vcpupin vcpu='3' cpuset='20'/>\n        <emulatorpin cpuset='0-1,20-21'/>\n      </cputune>\n      <numatune>\n        <memory mode='strict' nodeset='0'/>\n        <memnode cellid='0' mode='strict' nodeset='0'/>\n      </numatune>\n      ...\n      <cpu>\n        <topology sockets='2' cores='1' threads='2'/>\n        <numa>\n          <cell id='0' cpus='0-3' memory='2097152' unit='KiB'/>\n        </numa>\n      </cpu>\n      ...\n    </domain>\n\n    $ openstack server delete test1\n\nNo issues here.\n\n## Validate a HT-disabled node\n\nThis policy \"requires\" HyperThreading or similar on the host, so it shouldn't\nwork here.\n\n    $ openstack server create --flavor=pinned.require \\\n        --image=cirros-0.3.4-x86_64-uec --wait test1\n\n    $ sudo virsh list\n     Id    Name                           State\n    ----------------------------------------------------\n     2     instance-00000002              running\n\n    $ sudo virsh dumpxml 2\n    <domain type='kvm' id='2'>\n      <name>instance-00000002</name>\n      ...\n      <vcpu placement='static'>4</vcpu>\n      <cputune>\n        <shares>4096</shares>\n        <vcpupin vcpu='0' cpuset='0'/>\n        <vcpupin vcpu='1' cpuset='1'/>\n        <vcpupin vcpu='2' cpuset='2'/>\n        <vcpupin vcpu='3' cpuset='3'/>\n        <emulatorpin cpuset='0-3'/>\n      </cputune>\n      <numatune>\n        <memory mode='strict' nodeset='0'/>\n        <memnode cellid='0' mode='strict' nodeset='0'/>\n      </numatune>\n      ...\n      <cpu>\n        <topology sockets='2' cores='1' threads='2'/>\n        <numa>\n          <cell id='0' cpus='0-3' memory='2097152' unit='KiB'/>\n        </numa>\n      </cpu>\n      ...\n    </domain>\n\n    $ openstack server delete test1\n\nThis is a problem, but we do not currently have the filter activated:\n\n    $ cat /etc/nova/nova.conf | grep scheduler_default_filters\n    scheduler_default_filters = RetryFilter,AvailabilityZoneFilter,RamFilter,\\\n    DiskFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,\\\n    ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,SameHostFilter,\\\n    DifferentHostFilter\n\nLet's activate this:\n\n    $ cat /etc/nova/nova.conf | grep scheduler_default_filters\n    scheduler_default_filters = RetryFilter,AvailabilityZoneFilter,RamFilter,\\\n    DiskFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,\\\n    ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,SameHostFilter,\\\n    DifferentHostFilter,NUMATopologyFilter\n\nAnd try again:\n\n    $ openstack server create --flavor=pinned.require \\\n        --image=cirros-0.3.4-x86_64-uec --wait test1\n    Error creating server: test1\n\n    Error creating server\n\nThat's more like it, but it shouldn't be necessary.", 
    "tags": [
        "mitaka-backport-potential"
    ], 
    "importance": "Undecided", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1550269", 
    "owner": "https://api.launchpad.net/1.0/~stephenfinucane", 
    "id": 1550269, 
    "index": 6061, 
    "created": "2016-02-26 10:37:23.376930+00:00", 
    "title": "'hw:cpu_thread_policy=require' does not function correctly if NUMATopologyFilter is disabled", 
    "comments": [
        {
            "content": "The 'require' policy is supposed to restrict instances to hosts that support hardware threads, e.g. HyperThreading. However, this filtering is done as part of the NUMATopologyFilter. If this filter is disabled, the host boots just fine. This should not be the case and needs to be fixed. Findings below.\n\n---\n\nTesting was conducted on a single-node, Fedora 23-based (4.3.5-300.fc23.x86_64)\nOpenStack instance (built with devstack). The system is a dual-socket, ten core,\nHT-enabled system (2 sockets * 10 cores * 2 threads = 40 \"pCPUs\".\n0-9,20-29 = node0, 10-19,30-39 = node1).\n\nCommit '8bafc9' of Nova was used.\n\n# Steps\n\n## Create flavors\n\n    $ openstack flavor create pinned.require \\\n        --id 102 --ram 2048 --disk 0 --vcpus 4\n    $ openstack flavor set pinned.require \\\n        --property \"hw:cpu_policy=dedicated\" \\\n        --property \"hw:cpu_thread_policy=require\"\n\n## Validate a HT-enabled node\n\nThe 'require' case is a stricter version of the `prefer` case, in that it\nshould fail if we have HyperThreading disabled, do not have enough free\nsibling sets, or have no HyperThreading support at all. However, since we're\nnot hitting any of these conditions on this host, things should function just\nlike they do for the `prefer` case. Therefore, the guest should see a two\nsockets with one core per socket and two threads per core.\n\n    $ openstack server create --flavor=pinned.require \\\n        --image=cirros-0.3.4-x86_64-uec --wait test1\n\n    $ sudo virsh list\n     Id    Name                           State\n    ----------------------------------------------------\n     2     instance-00000002              running\n\n    $ sudo virsh dumpxml 2\n    <domain type='kvm' id='2'>\n      <name>instance-00000002</name>\n      ...\n      <vcpu placement='static'>4</vcpu>\n      <cputune>\n        <shares>4096</shares>\n        <vcpupin vcpu='0' cpuset='1'/>\n        <vcpupin vcpu='1' cpuset='21'/>\n        <vcpupin vcpu='2' cpuset='0'/>\n        <vcpupin vcpu='3' cpuset='20'/>\n        <emulatorpin cpuset='0-1,20-21'/>\n      </cputune>\n      <numatune>\n        <memory mode='strict' nodeset='0'/>\n        <memnode cellid='0' mode='strict' nodeset='0'/>\n      </numatune>\n      ...\n      <cpu>\n        <topology sockets='2' cores='1' threads='2'/>\n        <numa>\n          <cell id='0' cpus='0-3' memory='2097152' unit='KiB'/>\n        </numa>\n      </cpu>\n      ...\n    </domain>\n\n    $ openstack server delete test1\n\nNo issues here.\n\n## Validate a HT-disabled node\n\nThis policy \"requires\" HyperThreading or similar on the host, so it shouldn't\nwork here.\n\n    $ openstack server create --flavor=pinned.require \\\n        --image=cirros-0.3.4-x86_64-uec --wait test1\n\n    $ sudo virsh list\n     Id    Name                           State\n    ----------------------------------------------------\n     2     instance-00000002              running\n\n    $ sudo virsh dumpxml 2\n    <domain type='kvm' id='2'>\n      <name>instance-00000002</name>\n      ...\n      <vcpu placement='static'>4</vcpu>\n      <cputune>\n        <shares>4096</shares>\n        <vcpupin vcpu='0' cpuset='0'/>\n        <vcpupin vcpu='1' cpuset='1'/>\n        <vcpupin vcpu='2' cpuset='2'/>\n        <vcpupin vcpu='3' cpuset='3'/>\n        <emulatorpin cpuset='0-3'/>\n      </cputune>\n      <numatune>\n        <memory mode='strict' nodeset='0'/>\n        <memnode cellid='0' mode='strict' nodeset='0'/>\n      </numatune>\n      ...\n      <cpu>\n        <topology sockets='2' cores='1' threads='2'/>\n        <numa>\n          <cell id='0' cpus='0-3' memory='2097152' unit='KiB'/>\n        </numa>\n      </cpu>\n      ...\n    </domain>\n\n    $ openstack server delete test1\n\nThis is a problem, but we do not currently have the filter activated:\n\n    $ cat /etc/nova/nova.conf | grep scheduler_default_filters\n    scheduler_default_filters = RetryFilter,AvailabilityZoneFilter,RamFilter,\\\n    DiskFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,\\\n    ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,SameHostFilter,\\\n    DifferentHostFilter\n\nLet's activate this:\n\n    $ cat /etc/nova/nova.conf | grep scheduler_default_filters\n    scheduler_default_filters = RetryFilter,AvailabilityZoneFilter,RamFilter,\\\n    DiskFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,\\\n    ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,SameHostFilter,\\\n    DifferentHostFilter,NUMATopologyFilter\n\nAnd try again:\n\n    $ openstack server create --flavor=pinned.require \\\n        --image=cirros-0.3.4-x86_64-uec --wait test1\n    Error creating server: test1\n\n    Error creating server\n\nThat's more like it, but it shouldn't be necessary.", 
            "date_created": "2016-02-26 10:37:23.376930+00:00", 
            "author": "https://api.launchpad.net/1.0/~stephenfinucane"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/285232", 
            "date_created": "2016-02-26 11:14:52.591040+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/285232\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ad0047e97b2847412ee28bad6a3bfb48395add35\nSubmitter: Jenkins\nBranch:    master\n\ncommit ad0047e97b2847412ee28bad6a3bfb48395add35\nAuthor: Stephen Finucane <email address hidden>\nDate:   Fri Feb 26 10:55:55 2016 +0000\n\n    virt/hardware: Check for threads when \"required\"\n    \n    The 'require' case \"requires\" the presence of hardware threads on a\n    host. At present, this check is done using the NUMATopology filter.\n    Unfortunately, this means that if this filter is disabled then\n    instances can be scheduled on invalid hosts. Resolve this by adding a\n    new check to be run when hosts are actually scheduling.\n    \n    Change-Id: Ia9e4784e02ca9ce7a3d81c962b95bee100f6db42\n    Closes-bug: #1550269\n", 
            "date_created": "2016-08-10 02:39:59.059751+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b3 development milestone.", 
            "date_created": "2016-09-02 01:13:52.331214+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}