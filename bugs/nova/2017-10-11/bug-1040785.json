{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:44:30.163078+00:00", 
    "description": "PowerVM gets call to update instance lists at startup. This is causing an error under Crypto.Random, see trace below\n\nThis is preventing the forked child  that will run nova compute from starting. \n\nMy environment:\n\nUbuntu 12.04 with latest Paramiko and Crypto there. Nova clone from 8/17/2012\n\nObservations:\n\nThis started happening when forking was introduced.\nI can work around this issue by not have the ssh connection established in the virt.powervm.operator.BaseOperator constructor. I established connection during the first call of a command in that class.\n\nfor example:\n\ndef __init__(self, connection):\n        \"\"\"Constructor.\n\n        :param connection: common.Connection object with the\n                           information to connect to the remote\n                           ssh.\n        \"\"\"\n        self._connection = None #common.ssh_connect(connection)\n        self.connection_data = connection\n\ndef __set_connection(self):\n        LOG.debug(_(\"In base Set Connection\"))\n        LOG.debug(_(self.connection_data))\n        if self.__connection is None:\n            LOG.debug(_(\"Connection will be established\"))\n            self.__connection = ssh_connect(self.connection_data)\n\ndef run_command_as_root(self, command, check_exit_code=True):\n        \"\"\"Run a remote command as root using an active ssh connection.\n\n        :param command: List of commands.\n        \"\"\"\n        self.__set_connection()\n        stdout, stderr = common.ssh_command_as_root(\n            self._connection, command, check_exit_code=check_exit_code)\n        return stdout.read().splitlines()\n\nStack trace\nUnhandled exception\n2012-08-23 13:12:04 TRACE nova.service Traceback (most recent call last):\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/service.py\", line 292, in _start_child\n2012-08-23 13:12:04 TRACE nova.service     self._child_process(wrap.server)\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/service.py\", line 268, in _child_process\n2012-08-23 13:12:04 TRACE nova.service     launcher.run_server(server)\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/service.py\", line 133, in run_server\n2012-08-23 13:12:04 TRACE nova.service     server.start()\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/service.py\", line 400, in start\n2012-08-23 13:12:04 TRACE nova.service     self.manager.init_host()\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/compute/manager.py\", line 301, in init_host\n2012-08-23 13:12:04 TRACE nova.service     self.driver.init_host(host=self.host)\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/virt/powervm/driver.py\", line 78, in init_host\n2012-08-23 13:12:04 TRACE nova.service     powervm_instances = self.list_instances()\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/virt/powervm/driver.py\", line 102, in list_instances\n2012-08-23 13:12:04 TRACE nova.service     return self._powervm.list_instances()\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/virt/powervm/operator.py\", line 101, in list_instances\n2012-08-23 13:12:04 TRACE nova.service     lpar_instances = self._operator.list_lpar_instances()\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/virt/powervm/operator.py\", line 317, in list_lpar_instances\n2012-08-23 13:12:04 TRACE nova.service     lpar_names = self.run_command(self.command.lssyscfg('-r lpar -F name'))\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/virt/powervm/operator.py\", line 610, in run_command\n2012-08-23 13:12:04 TRACE nova.service     check_exit_code=check_exit_code)\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/utils.py\", line 256, in ssh_execute\n2012-08-23 13:12:04 TRACE nova.service     stdin_stream, stdout_stream, stderr_stream = ssh.exec_command(cmd)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/client.py\", line 363, in exec_command\n2012-08-23 13:12:04 TRACE nova.service     chan = self._transport.open_session()\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/transport.py\", line 658, in open_session\n2012-08-23 13:12:04 TRACE nova.service     return self.open_channel('session')\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/transport.py\", line 739, in open_channel\n2012-08-23 13:12:04 TRACE nova.service     self._send_user_message(m)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/transport.py\", line 1426, in _send_user_message\n2012-08-23 13:12:04 TRACE nova.service     self._send_message(data)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/transport.py\", line 1406, in _send_message\n2012-08-23 13:12:04 TRACE nova.service     self.packetizer.send_message(data)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/packet.py\", line 302, in send_message\n2012-08-23 13:12:04 TRACE nova.service     packet = self._build_packet(data)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/packet.py\", line 486, in _build_packet\n2012-08-23 13:12:04 TRACE nova.service     packet += rng.read(padding)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/lib/python2.7/dist-packages/Crypto/Random/_UserFriendlyRNG.py\", line 187, in read\n2012-08-23 13:12:04 TRACE nova.service     return self._singleton.read(bytes)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/lib/python2.7/dist-packages/Crypto/Random/_UserFriendlyRNG.py\", line 163, in read\n2012-08-23 13:12:04 TRACE nova.service     return _UserFriendlyRNG.read(self, bytes)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/lib/python2.7/dist-packages/Crypto/Random/_UserFriendlyRNG.py\", line 122, in read\n2012-08-23 13:12:04 TRACE nova.service     self._check_pid()\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/lib/python2.7/dist-packages/Crypto/Random/_UserFriendlyRNG.py\", line 138, in _check_pid\n2012-08-23 13:12:04 TRACE nova.service     raise AssertionError(\"PID check failed. RNG must be re-initialized after fork(). Hint: Try Random.atfork()\")\n2012-08-23 13:12:04 TRACE nova.service AssertionError: PID check failed. RNG must be re-initialized after fork(). Hint: Try Random.atfork()\n2012-08-23 13:12:04 TRACE nova.service \n2012-08-23 13:12:04 INFO nova.service [-] Child 12730 exited with status 2", 
    "tags": [
        "powervm"
    ], 
    "importance": "Medium", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1040785", 
    "owner": "https://api.launchpad.net/1.0/~ttx", 
    "id": 1040785, 
    "index": 3022, 
    "created": "2012-08-23 17:26:32.984594+00:00", 
    "title": "PowerVM compute driver fail to start with pid check failure from Crypto.Random", 
    "comments": [
        {
            "content": "PowerVM gets call to update instance lists at startup. This is causing an error under Crypto.Random, see trace below\n\nThis is preventing the forked child  that will run nova compute from starting. \n\nMy environment:\n\nUbuntu 12.04 with latest Paramiko and Crypto there. Nova clone from 8/17/2012\n\nObservations:\n\nThis started happening when forking was introduced.\nI can work around this issue by not have the ssh connection established in the virt.powervm.operator.BaseOperator constructor. I established connection during the first call of a command in that class.\n\nfor example:\n\ndef __init__(self, connection):\n        \"\"\"Constructor.\n\n        :param connection: common.Connection object with the\n                           information to connect to the remote\n                           ssh.\n        \"\"\"\n        self._connection = None #common.ssh_connect(connection)\n        self.connection_data = connection\n\ndef __set_connection(self):\n        LOG.debug(_(\"In base Set Connection\"))\n        LOG.debug(_(self.connection_data))\n        if self.__connection is None:\n            LOG.debug(_(\"Connection will be established\"))\n            self.__connection = ssh_connect(self.connection_data)\n\ndef run_command_as_root(self, command, check_exit_code=True):\n        \"\"\"Run a remote command as root using an active ssh connection.\n\n        :param command: List of commands.\n        \"\"\"\n        self.__set_connection()\n        stdout, stderr = common.ssh_command_as_root(\n            self._connection, command, check_exit_code=check_exit_code)\n        return stdout.read().splitlines()\n\nStack trace\nUnhandled exception\n2012-08-23 13:12:04 TRACE nova.service Traceback (most recent call last):\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/service.py\", line 292, in _start_child\n2012-08-23 13:12:04 TRACE nova.service     self._child_process(wrap.server)\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/service.py\", line 268, in _child_process\n2012-08-23 13:12:04 TRACE nova.service     launcher.run_server(server)\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/service.py\", line 133, in run_server\n2012-08-23 13:12:04 TRACE nova.service     server.start()\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/service.py\", line 400, in start\n2012-08-23 13:12:04 TRACE nova.service     self.manager.init_host()\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/compute/manager.py\", line 301, in init_host\n2012-08-23 13:12:04 TRACE nova.service     self.driver.init_host(host=self.host)\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/virt/powervm/driver.py\", line 78, in init_host\n2012-08-23 13:12:04 TRACE nova.service     powervm_instances = self.list_instances()\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/virt/powervm/driver.py\", line 102, in list_instances\n2012-08-23 13:12:04 TRACE nova.service     return self._powervm.list_instances()\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/virt/powervm/operator.py\", line 101, in list_instances\n2012-08-23 13:12:04 TRACE nova.service     lpar_instances = self._operator.list_lpar_instances()\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/virt/powervm/operator.py\", line 317, in list_lpar_instances\n2012-08-23 13:12:04 TRACE nova.service     lpar_names = self.run_command(self.command.lssyscfg('-r lpar -F name'))\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/virt/powervm/operator.py\", line 610, in run_command\n2012-08-23 13:12:04 TRACE nova.service     check_exit_code=check_exit_code)\n2012-08-23 13:12:04 TRACE nova.service   File \"/home/dperaza/workspace/openstack/nova/nova/utils.py\", line 256, in ssh_execute\n2012-08-23 13:12:04 TRACE nova.service     stdin_stream, stdout_stream, stderr_stream = ssh.exec_command(cmd)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/client.py\", line 363, in exec_command\n2012-08-23 13:12:04 TRACE nova.service     chan = self._transport.open_session()\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/transport.py\", line 658, in open_session\n2012-08-23 13:12:04 TRACE nova.service     return self.open_channel('session')\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/transport.py\", line 739, in open_channel\n2012-08-23 13:12:04 TRACE nova.service     self._send_user_message(m)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/transport.py\", line 1426, in _send_user_message\n2012-08-23 13:12:04 TRACE nova.service     self._send_message(data)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/transport.py\", line 1406, in _send_message\n2012-08-23 13:12:04 TRACE nova.service     self.packetizer.send_message(data)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/packet.py\", line 302, in send_message\n2012-08-23 13:12:04 TRACE nova.service     packet = self._build_packet(data)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/local/lib/python2.7/dist-packages/paramiko/packet.py\", line 486, in _build_packet\n2012-08-23 13:12:04 TRACE nova.service     packet += rng.read(padding)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/lib/python2.7/dist-packages/Crypto/Random/_UserFriendlyRNG.py\", line 187, in read\n2012-08-23 13:12:04 TRACE nova.service     return self._singleton.read(bytes)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/lib/python2.7/dist-packages/Crypto/Random/_UserFriendlyRNG.py\", line 163, in read\n2012-08-23 13:12:04 TRACE nova.service     return _UserFriendlyRNG.read(self, bytes)\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/lib/python2.7/dist-packages/Crypto/Random/_UserFriendlyRNG.py\", line 122, in read\n2012-08-23 13:12:04 TRACE nova.service     self._check_pid()\n2012-08-23 13:12:04 TRACE nova.service   File \"/usr/lib/python2.7/dist-packages/Crypto/Random/_UserFriendlyRNG.py\", line 138, in _check_pid\n2012-08-23 13:12:04 TRACE nova.service     raise AssertionError(\"PID check failed. RNG must be re-initialized after fork(). Hint: Try Random.atfork()\")\n2012-08-23 13:12:04 TRACE nova.service AssertionError: PID check failed. RNG must be re-initialized after fork(). Hint: Try Random.atfork()\n2012-08-23 13:12:04 TRACE nova.service \n2012-08-23 13:12:04 INFO nova.service [-] Child 12730 exited with status 2", 
            "date_created": "2012-08-23 17:26:32.984594+00:00", 
            "author": "https://api.launchpad.net/1.0/~dperaza"
        }, 
        {
            "content": "To recreate this problem I did not have to do much, simply start the Nova-Compute service. I got nova from github on August 17.\nOthers I have talked to do not see this issue, but the difference is that they are running on the same network where PowerVM systems run, so the ssh connection timing is off, I'm running across multiple states (Miami FL - Rochester MN) and going through VPN. That might give you some clues on how to recreate by simulating network latency.", 
            "date_created": "2012-09-06 17:01:32.945963+00:00", 
            "author": "https://api.launchpad.net/1.0/~dperaza"
        }, 
        {
            "content": "Looks like a known Paramiko issue:\nhttps://bugs.launchpad.net/paramiko/+bug/649158\nhttps://github.com/fabric/fabric/issues/214\nhttps://github.com/newsapps/beeswithmachineguns/issues/17\n\nYou could try to apply attached patch to paramiko/transport.py", 
            "date_created": "2012-09-10 12:43:33.238617+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "I can recreate this issue and meet the same error message as David mentioned. My openstack server is in China Beijing, and the IVM is located in Rochester MN. And after apply the workround from David, the issue is gone.", 
            "date_created": "2012-09-12 07:36:48.377533+00:00", 
            "author": "https://api.launchpad.net/1.0/~flwang"
        }, 
        {
            "content": "Alternatively since the proposed patch works around it, it might be simpler to just apply it.\nTiago: thoughts ?", 
            "date_created": "2012-09-12 12:27:38.264912+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/12872", 
            "date_created": "2012-09-12 12:36:17.365808+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "See proposed patch at https://review.openstack.org/12872", 
            "date_created": "2012-09-12 12:37:39.846976+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/12872\nCommitted: http://github.com/openstack/nova/commit/3c79641a1310853b9f73a5ec5b6459ac88578ab8\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3c79641a1310853b9f73a5ec5b6459ac88578ab8\nAuthor: Thierry Carrez <email address hidden>\nDate:   Wed Sep 12 14:33:34 2012 +0200\n\n    PowerVM: Establish SSH connection at use time\n    \n    Establish SSH connection at use time in PowerVM compute driver, in order\n    to work around a paramiko error on slow networks. Patch based on a\n    proposal by David Peraza.\n    \n    Fixes bug 1040785.\n    \n    Change-Id: I1a656981fae2f384c748c077d608018a0aafb681\n", 
            "date_created": "2012-09-12 16:28:49.166588+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}