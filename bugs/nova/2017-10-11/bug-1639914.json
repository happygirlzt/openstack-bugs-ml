{
    "status": "Won't Fix", 
    "last_updated": "2017-03-14 00:01:27.227371+00:00", 
    "description": "When snapshot is created and immediately deleting the instance seems to cause race condition. I was able to re-create it on latest devstack on installed on 8th november\n\nThis can be created with following commands.\n\n1. nova boot --flavor m1.large --image 6d4259ce-5873-42cb-8cbe-9873f069c149 testinstance\n\nid                                   | bef22f9b-ade4-48a1-86c4-b9a007897eb3\n\n2. nova image-create bef22f9b-ade4-48a1-86c4-b9a007897eb3 testinstance-snap ; nova delete bef22f9b-ade4-48a1-86c4-b9a007897eb3\nRequest to delete server bef22f9b-ade4-48a1-86c4-b9a007897eb3 has been accepted.\n3. nova image-list doesn't show the snapshot\n\n4. nova list doesn't show the instance\n\nNova compute log indicates a race condition while executing CLI commands in 2 above\n\n<182>1 2016-10-28T14:46:41.830208+00:00 hyper1 nova-compute 30056 - [40521 levelname=\"INFO\" component=\"nova-compute\" funcname=\"nova.compute.manager\" request_id=\"req-e9e4e899-e2a7-4bf8-bdf1-c26f5634cfda\" user=\"51fa0172fbdf495e89132f7f4574e750\" tenant=\"00ead348c5f9475f8940ab29cd767c5e\" instance=\"[instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3] \" lineno=\"/usr/lib/python2.7/site-packages/nova/compute/manager.py:2249\"] nova.compute.manager Terminating instance\n<183>1 2016-10-28T14:46:42.057653+00:00 hyper1 nova-compute 30056 - [40521 levelname=\"DEBUG\" component=\"nova-compute\" funcname=\"nova.compute.manager\" request_id=\"req-1c4cf749-a6a8-46af-b331-f70dc1e9f364\" user=\"51fa0172fbdf495e89132f7f4574e750\" tenant=\"00ead348c5f9475f8940ab29cd767c5e\" instance=\"[instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3] \" lineno=\"/usr/lib/python2.7/site-packages/nova/compute/manager.py:420\"] nova.compute.manager Cleaning up image ae9ebf4b-7dd6-4615-816f-c2f3c7c08530 decorated_function /usr/lib/python2.7/site-packages/nova/compute/manager.py:420\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3] Traceback (most recent call last):\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 416, in decorated_function\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     *args, **kwargs)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 3038, in snapshot_instance\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     task_states.IMAGE_SNAPSHOT)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 3068, in _snapshot_instance\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     update_task_state)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1447, in snapshot\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     guest.save_memory_state()\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/guest.py\", line 363, in save_memory_state\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     self._domain.managedSave(0)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     rv = execute(f, *args, **kwargs)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     six.reraise(c, e, tb)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     rv = meth(*args, **kwargs)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1397, in managedSave\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     if ret == -1: raise libvirtError ('virDomainManagedSave() failed', dom=self)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3] libvirtError: operation failed: domain is no longer running\n\nNova compute should make sure the save is completed before attempting to delete the domain.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1639914", 
    "owner": "None", 
    "id": 1639914, 
    "index": 6515, 
    "created": "2016-11-07 19:38:24.842078+00:00", 
    "title": "Race condition in nova compute during snapshot", 
    "comments": [
        {
            "content": "On Liberty nova with Ceph storage, when snapshot is created and immediately deleting the instance seems to cause race condition.\n\nThis can be created with following commands.\n\n1. nova boot --flavor m1.large --image 6d4259ce-5873-42cb-8cbe-9873f069c149 testinstance\n\nid                                   | bef22f9b-ade4-48a1-86c4-b9a007897eb3   \n\n2. nova image-create bef22f9b-ade4-48a1-86c4-b9a007897eb3 testinstance-snap ; nova delete bef22f9b-ade4-48a1-86c4-b9a007897eb3\nRequest to delete server bef22f9b-ade4-48a1-86c4-b9a007897eb3 has been accepted.\n3. nova image-list doesn't show the snapshot\n\n4. nova list doesn't show the instance\n\nNova compute log indicates a race condition while executing CLI commands in 2 above\n\n<182>1 2016-10-28T14:46:41.830208+00:00 hyper1 nova-compute 30056 - [40521 levelname=\"INFO\" component=\"nova-compute\" funcname=\"nova.compute.manager\" request_id=\"req-e9e4e899-e2a7-4bf8-bdf1-c26f5634cfda\" user=\"51fa0172fbdf495e89132f7f4574e750\" tenant=\"00ead348c5f9475f8940ab29cd767c5e\" instance=\"[instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3] \" lineno=\"/usr/lib/python2.7/site-packages/nova/compute/manager.py:2249\"] nova.compute.manager Terminating instance\n<183>1 2016-10-28T14:46:42.057653+00:00 hyper1 nova-compute 30056 - [40521 levelname=\"DEBUG\" component=\"nova-compute\" funcname=\"nova.compute.manager\" request_id=\"req-1c4cf749-a6a8-46af-b331-f70dc1e9f364\" user=\"51fa0172fbdf495e89132f7f4574e750\" tenant=\"00ead348c5f9475f8940ab29cd767c5e\" instance=\"[instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3] \" lineno=\"/usr/lib/python2.7/site-packages/nova/compute/manager.py:420\"] nova.compute.manager Cleaning up image ae9ebf4b-7dd6-4615-816f-c2f3c7c08530 decorated_function /usr/lib/python2.7/site-packages/nova/compute/manager.py:420\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3] Traceback (most recent call last):\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 416, in decorated_function\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     *args, **kwargs)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 3038, in snapshot_instance\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     task_states.IMAGE_SNAPSHOT)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 3068, in _snapshot_instance\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     update_task_state)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1447, in snapshot\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     guest.save_memory_state()\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/guest.py\", line 363, in save_memory_state\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     self._domain.managedSave(0)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     rv = execute(f, *args, **kwargs)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     six.reraise(c, e, tb)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     rv = meth(*args, **kwargs)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]   File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1397, in managedSave\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3]     if ret == -1: raise libvirtError ('virDomainManagedSave() failed', dom=self)\n!!!NL!!! 30056 TRACE nova.compute.manager [instance: bef22f9b-ade4-48a1-86c4-b9a007897eb3] libvirtError: operation failed: domain is no longer running\n\nNova compute should make sure the save is completed before attempting to delete the domain.", 
            "date_created": "2016-11-07 19:38:24.842078+00:00", 
            "author": "https://api.launchpad.net/1.0/~srinivas-sakhamuri"
        }, 
        {
            "content": "Stack trace from devstack\n\n2016-11-08 11:02:45.770 ^[[01;31mERROR root [^[[01;36mreq-a0f277d3-487d-44b2-99be-8bbe45b5fc4a ^[[00;36mdemo demo^[[01;31m] ^[[01;35m^[[01;31mOriginal exception being dropped: ['Traceback (most recent call last):\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 137, in launch\\n    return self._domain.createWithFlags(flags)\\n', '  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 186, in doit\\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\\n', '  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 144, in proxy_call\\n    rv = execute(f, *args, **kwargs)\\n', '  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 125, in execute\\n    six.reraise(c, e, tb)\\n', '  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 83, in tworker\\n    rv = meth(*args, **kwargs)\\n', '  File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1065, in createWithFlags\\n    if ret == -1: raise libvirtError (\\'virDomainCreateWithFlags() failed\\', dom=self)\\n', \"libvirtError: Domain not found: no domain with matching uuid '1cf5f735-b97d-40f6-8cef-2af3e3056442' (instance-00000002)\\n\"]^[[00m\n2016-11-08 11:02:45.940 ^[[00;32mDEBUG nova.compute.manager [^[[01;36mreq-a0f277d3-487d-44b2-99be-8bbe45b5fc4a ^[[00;36mdemo demo^[[00;32m] ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00;32mCleaning up image 0d345c39-131e-4bee-a4d2-9ff66a867b2a^[[00m ^[[00;33mfrom (pid=7272) decorated_function /opt/stack/nova/nova/compute/manager.py:236^[[00m\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00mTraceback (most recent call last):\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 232, in decorated_function\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    *args, **kwargs)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 3051, in snapshot_instance\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    task_states.IMAGE_SNAPSHOT)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 3080, in _snapshot_instance\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    update_task_state)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1548, in snapshot\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    state, instance)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1586, in _snapshot_domain\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    guest = self._create_domain(domain=virt_dom)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4795, in _create_domain\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    guest.launch(pause=pause)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 142, in launch\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    self._encoded_xml, errors='ignore')\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 111, in _encoded_xml\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    return encodeutils.safe_decode(self._domain.XMLDesc(0))\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 186, in doit\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    result = proxy_call(self._autowrap, f, *args, **kwargs)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 144, in proxy_call\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    rv = execute(f, *args, **kwargs)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 125, in execute\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    six.reraise(c, e, tb)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 83, in tworker\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    rv = meth(*args, **kwargs)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m  File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 492, in XMLDesc\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m    if ret is None: raise libvirtError ('virDomainGetXMLDesc() failed', dom=self)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00mlibvirtError: Domain not found: no domain with matching uuid '1cf5f735-b97d-40f6-8cef-2af3e3056442' (instance-00000002)\n^[[00;32m2016-11-08 11:02:45.940 TRACE nova.compute.manager ^[[01;35m[instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] ^[[00m", 
            "date_created": "2016-11-08 16:28:16.933399+00:00", 
            "author": "https://api.launchpad.net/1.0/~srinivas-sakhamuri"
        }, 
        {
            "content": "2016-11-08 11:02:45.770 ERROR root [req-a0f277d3-487d-44b2-99be-8bbe45b5fc4a demo demo] Original exception being dropped: ['Traceback (most recent call last):\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 137, in launch\\n    return self._domain.createWithFlags(flags)\\n', '  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 186, in doit\\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\\n', '  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 144, in proxy_call\\n    rv = execute(f, *args, **kwargs)\\n', '  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 125, in execute\\n    six.reraise(c, e, tb)\\n', '  File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 83, in tworker\\n    rv = meth(*args, **kwargs)\\n', '  File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1065, in createWithFlags\\n    if ret == -1: raise libvirtError (\\'virDomainCreateWithFlags() failed\\', dom=self)\\n', \"libvirtError: Domain not found: no domain with matching uuid '1cf5f735-b97d-40f6-8cef-2af3e3056442' (instance-00000002)\\n\"]\n2016-11-08 11:02:45.940 DEBUG nova.compute.manager [req-a0f277d3-487d-44b2-99be-8bbe45b5fc4a demo demo] [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] Cleaning up image 0d345c39-131e-4bee-a4d2-9ff66a867b2a from (pid=7272) decorated_function /opt/stack/nova/nova/compute/manager.py:236\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] Traceback (most recent call last):\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/opt/stack/nova/nova/compute/manager.py\", line 232, in decorated_function\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     *args, **kwargs)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/opt/stack/nova/nova/compute/manager.py\", line 3051, in snapshot_instance\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     task_states.IMAGE_SNAPSHOT)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/opt/stack/nova/nova/compute/manager.py\", line 3080, in _snapshot_instance\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     update_task_state)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1548, in snapshot\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     state, instance)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1586, in _snapshot_domain\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     guest = self._create_domain(domain=virt_dom)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4795, in _create_domain\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     guest.launch(pause=pause)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 142, in launch\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     self._encoded_xml, errors='ignore')\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 111, in _encoded_xml\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     return encodeutils.safe_decode(self._domain.XMLDesc(0))\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 186, in doit\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 144, in proxy_call\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     rv = execute(f, *args, **kwargs)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 125, in execute\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     six.reraise(c, e, tb)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 83, in tworker\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     rv = meth(*args, **kwargs)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]   File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 492, in XMLDesc\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]     if ret is None: raise libvirtError ('virDomainGetXMLDesc() failed', dom=self)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442] libvirtError: Domain not found: no domain with matching uuid '1cf5f735-b97d-40f6-8cef-2af3e3056442' (instance-00000002)\n2016-11-08 11:02:45.940 TRACE nova.compute.manager [instance: 1cf5f735-b97d-40f6-8cef-2af3e3056442]", 
            "date_created": "2016-11-08 16:36:07.097828+00:00", 
            "author": "https://api.launchpad.net/1.0/~srinivas-sakhamuri"
        }, 
        {
            "content": "What package version are these?  \n\nAnd more importantly, are you able to reproduce this with latest upstream release, Newton?\n\nAlso, please see this for reference: https://wiki.openstack.org/wiki/BugFilingRecommendations", 
            "date_created": "2016-11-09 11:27:59.357035+00:00", 
            "author": "https://api.launchpad.net/1.0/~kashyapc"
        }, 
        {
            "content": "Err, I scrolled too fast, and missed your \"able to re-create it on latest devstack on installed on 8th november\" comment.  Disregard comment #3  (Sorry for the noise, there)", 
            "date_created": "2016-11-09 11:36:02.081078+00:00", 
            "author": "https://api.launchpad.net/1.0/~kashyapc"
        }, 
        {
            "content": "I couldn't reproduce the issue by following mentioned steps.\n\nIn my case, the image was in active state and the instance was deleted successfully.\n\nSince it is a race condition, it would be difficult to reproduce.", 
            "date_created": "2016-11-22 06:33:48.428914+00:00", 
            "author": "https://api.launchpad.net/1.0/~ratailor"
        }, 
        {
            "content": "I believe that it's expected behavior. In nova code there is a special case if something happens during snapshot image will be deleted.\n\nhttps://github.com/openstack/nova/blob/lm_claims/nova/compute/api.py#L2730", 
            "date_created": "2017-03-01 11:16:31.089566+00:00", 
            "author": "https://api.launchpad.net/1.0/~avolkov"
        }, 
        {
            "content": "Yes the something happening is due to the delete of server via API after confirmation that image is created, but in fact nova-compute is still working on snapshot creation while it receives the delete request, hence it deletes the server and aborts the snapshot creates. This scenario uncovered while testing with rally (rally uses nova API)\n\nhttps://github.com/openstack/rally/blob/master/rally/plugins/openstack/scenarios/nova/servers.py#L281-L282\n\nSo I don't think it is a invalid test case, there need to be some guard in compute to handle these conflicting operations.\n", 
            "date_created": "2017-03-08 15:40:30.833934+00:00", 
            "author": "https://api.launchpad.net/1.0/~srinivas-sakhamuri"
        }, 
        {
            "content": "Srinivas - the compute API never blocks a delete request, unless the server is locked. So by design you can attempt to delete a server in any case where it's unlocked (if you're an admin you can bypass the locked state too). So we aren't going to put a conditional on the delete API such that you can't delete the server while it's being snapshot.\n\nAt this point I'm not sure what you're looking for as far as a bug or fix. As noted by Andrey, the compute manager will cleanup the snapshot image in glance if the server was deleted during the snapshot:\n\nhttps://github.com/openstack/nova/blame/15.0.0/nova/compute/manager.py#L3141\n\nhttps://github.com/openstack/nova/blob/15.0.0/nova/compute/manager.py#L222", 
            "date_created": "2017-03-14 00:01:12.233362+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }
    ]
}