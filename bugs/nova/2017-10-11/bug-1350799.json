{
    "status": "Won't Fix", 
    "last_updated": "2014-08-02 07:36:48.093623+00:00", 
    "description": "test env:\n havana version  nova(2013.2.3)\n\nlibvirt-client-0.10.2-19.el6.x86_64\nlibvirt-python-0.10.2-19.el6.x86_64\nlibvirt-0.10.2-19.el6.x86_64\nlibguestfs-1.20.11-2\npython-libguestfs-1.20.11-2\nlibguestfs-tools-c-1.20.11-2\n\n\nafter  setting option  libvirt_inject_password = true and libvirt_inject_partition=-1\n\nFind warning in compute.log:\n2014-07-31 14:38:44.041 5455 INFO nova.virt.libvirt.driver [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] [instance: e9747c77-f1a7-41ce-8934-b4d1270ac90f] Injecting admin_pass into image 9c5b600b-b108-4fdb-a7b4-e707ac4436a5\n2014-07-31 14:38:44.042 5455 DEBUG nova.virt.disk.api [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Inject data image=/var/lib/nova/instances/e9747c77-f1a7-41ce-8934-b4d1270ac90f/disk key=None net=None metadata=[] admin_password=<SANITIZED> files=[] partition=-1 use_cow=True inject_data /usr/lib/python2.6/site-packages/nova/virt/disk/api.py:321\n2014-07-31 14:38:44.043 5455 DEBUG nova.virt.disk.vfs.api [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Instance for image imgfile=/var/lib/nova/instances/e9747c77-f1a7-41ce-8934-b4d1270ac90f/disk imgfmt=qcow2 partition=-1 instance_for_image /usr/lib/python2.6/site-packages/nova/virt/disk/vfs/api.py:31\n2014-07-31 14:38:44.044 5455 DEBUG nova.virt.disk.vfs.api [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Trying to import guestfs instance_for_image /usr/lib/python2.6/site-packages/nova/virt/disk/vfs/api.py:34\n2014-07-31 14:38:44.045 5455 DEBUG nova.virt.disk.vfs.api [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Using primary VFSGuestFS instance_for_image /usr/lib/python2.6/site-packages/nova/virt/disk/vfs/api.py:41\n2014-07-31 14:38:44.046 5455 DEBUG nova.virt.disk.vfs.guestfs [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Setting up appliance for /var/lib/nova/instances/e9747c77-f1a7-41ce-8934-b4d1270ac90f/disk qcow2 setup /usr/lib/python2.6/site-packages/nova/virt/disk/vfs/guestfs.py:111\n2014-07-31 14:38:48.262 5455 DEBUG nova.virt.disk.vfs.guestfs [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Tearing down appliance teardown /usr/lib/python2.6/site-packages/nova/virt/disk/vfs/guestfs.py:140\n2014-07-31 14:38:48.264 5455 WARNING nova.virt.disk.vfs.guestfs [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Failed to close augeas aug_close: call launch before using this function\\n(in guestfish, don't forget to use the 'run' command)\n2014-07-31 14:38:48.277 5455 WARNING nova.virt.disk.api [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Ignoring error injecting data into image (Error mounting /var/lib/nova/instances/e9747c77-f1a7-41ce-8934-b4d1270ac90f/disk with libguestfs (guestfs_launch failed.\nSee http://libguestfs.org/guestfs-faq.1.html#debugging-libguestfs\nand/or run 'libguestfs-test-tool'.))", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1350799", 
    "owner": "None", 
    "id": 1350799, 
    "index": 5039, 
    "created": "2014-07-31 11:13:58.549777+00:00", 
    "title": "libvirt:  inject password  failure due to libguestfs can't write/read image disk located in XFS file system(havana)", 
    "comments": [
        {
            "content": "test env:\n havana version  nova(2013.2.3)\n\nlibvirt-client-0.10.2-19.el6.x86_64\nlibvirt-python-0.10.2-19.el6.x86_64\nlibvirt-0.10.2-19.el6.x86_64\nlibguestfs-1.20.11-2\npython-libguestfs-1.20.11-2\nlibguestfs-tools-c-1.20.11-2\n\n\nafter  setting option  libvirt_inject_password = true and libvirt_inject_partition=-1\n\nFind warning in compute.log:\n2014-07-31 14:38:44.041 5455 INFO nova.virt.libvirt.driver [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] [instance: e9747c77-f1a7-41ce-8934-b4d1270ac90f] Injecting admin_pass into image 9c5b600b-b108-4fdb-a7b4-e707ac4436a5\n2014-07-31 14:38:44.042 5455 DEBUG nova.virt.disk.api [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Inject data image=/var/lib/nova/instances/e9747c77-f1a7-41ce-8934-b4d1270ac90f/disk key=None net=None metadata=[] admin_password=<SANITIZED> files=[] partition=-1 use_cow=True inject_data /usr/lib/python2.6/site-packages/nova/virt/disk/api.py:321\n2014-07-31 14:38:44.043 5455 DEBUG nova.virt.disk.vfs.api [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Instance for image imgfile=/var/lib/nova/instances/e9747c77-f1a7-41ce-8934-b4d1270ac90f/disk imgfmt=qcow2 partition=-1 instance_for_image /usr/lib/python2.6/site-packages/nova/virt/disk/vfs/api.py:31\n2014-07-31 14:38:44.044 5455 DEBUG nova.virt.disk.vfs.api [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Trying to import guestfs instance_for_image /usr/lib/python2.6/site-packages/nova/virt/disk/vfs/api.py:34\n2014-07-31 14:38:44.045 5455 DEBUG nova.virt.disk.vfs.api [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Using primary VFSGuestFS instance_for_image /usr/lib/python2.6/site-packages/nova/virt/disk/vfs/api.py:41\n2014-07-31 14:38:44.046 5455 DEBUG nova.virt.disk.vfs.guestfs [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Setting up appliance for /var/lib/nova/instances/e9747c77-f1a7-41ce-8934-b4d1270ac90f/disk qcow2 setup /usr/lib/python2.6/site-packages/nova/virt/disk/vfs/guestfs.py:111\n2014-07-31 14:38:48.262 5455 DEBUG nova.virt.disk.vfs.guestfs [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Tearing down appliance teardown /usr/lib/python2.6/site-packages/nova/virt/disk/vfs/guestfs.py:140\n2014-07-31 14:38:48.264 5455 WARNING nova.virt.disk.vfs.guestfs [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Failed to close augeas aug_close: call launch before using this function\\n(in guestfish, don't forget to use the 'run' command)\n2014-07-31 14:38:48.277 5455 WARNING nova.virt.disk.api [req-c80fec35-6558-4327-baed-3f8a4ec00ad5 5e6036480fc3493697188fae7a27804e 1a35053493894082917315de2d5571db] Ignoring error injecting data into image (Error mounting /var/lib/nova/instances/e9747c77-f1a7-41ce-8934-b4d1270ac90f/disk with libguestfs (guestfs_launch failed.\nSee http://libguestfs.org/guestfs-faq.1.html#debugging-libguestfs\nand/or run 'libguestfs-test-tool'.))", 
            "date_created": "2014-07-31 11:13:58.549777+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "it seemed libguestfs can't mount the instance's image:\nError mounting /var/lib/nova/instances/e9747c77-f1a7-41ce-8934-b4d1270ac90f/disk ", 
            "date_created": "2014-07-31 11:16:28.527559+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "More information:\n\n[root@node-6 4d004b57-a918-4fc1-87b1-18f512b6fe99]# pwd\n/var/lib/nova/instances/4d004b57-a918-4fc1-87b1-18f512b6fe99\n[root@node-6 4d004b57-a918-4fc1-87b1-18f512b6fe99]# ls -al\ntotal 795404\ndrwxr-xr-x  2 nova nova        69 Jul 30 16:21 .\ndrwxr-xr-x 12 nova nova      4096 Jul 29 18:26 ..\n-rw-rw----  1 qemu qemu     32217 Jul 30 18:57 console.log\n-rw-r--r--  1 qemu qemu 814415872 Jul 31 20:28 disk\n-rw-r--r--  1 nova nova        79 Jul 29 14:07 disk.info\n-rw-r--r--  1 nova nova      1759 Jul 29 14:07 libvirt.xml\n[root@node-6 4d004b57-a918-4fc1-87b1-18f512b6fe99]# export LIBGUESTFS_DEBUG=1\n[root@node-6 4d004b57-a918-4fc1-87b1-18f512b6fe99]# export LIBGUESTFS_TRACE=1\n[root@node-6 4d004b57-a918-4fc1-87b1-18f512b6fe99]#  sudo -u qemu guestfish --rw -i -a disk\nlibguestfs: error: /usr/bin/qemu-kvm exited with error status 1.\nTo see full error messages you may need to enable debugging.\nSee http://libguestfs.org/guestfs-faq.1.html#debugging-libguestfs\nlibguestfs: error: guestfs_launch failed.\nSee http://libguestfs.org/guestfs-faq.1.html#debugging-libguestfs\nand/or run 'libguestfs-test-tool'.\n[root@node-6 4d004b57-a918-4fc1-87b1-18f512b6fe99]#  sudo -u qemu export LIBGUESTFS_DEBUG=1\nsudo: export: command not found\n[root@node-6 4d004b57-a918-4fc1-87b1-18f512b6fe99]# guestfish --rw -i -a disk\nlibguestfs: trace: set_verbose true\nlibguestfs: trace: set_verbose = 0\nlibguestfs: create: flags = 0, handle = 0x1378210\nlibguestfs: trace: set_pgroup true\nlibguestfs: trace: set_pgroup = 0\nlibguestfs: trace: add_drive \"disk\"\nlibguestfs: trace: add_drive = 0\nlibguestfs: trace: is_config\nlibguestfs: trace: is_config = 1\nlibguestfs: trace: launch\nlibguestfs: trace: get_tmpdir\nlibguestfs: trace: get_tmpdir = \"/tmp\"\nlibguestfs: launch: attach-method=appliance\nlibguestfs: launch: tmpdir=/tmp/libguestfsFgt5rx\nlibguestfs: launch: umask=0022\nlibguestfs: launch: euid=0\nlibguestfs: command: run: febootstrap-supermin-helper\nlibguestfs: command: run: \\ --verbose\nlibguestfs: command: run: \\ -f checksum\nlibguestfs: command: run: \\ /usr/lib64/guestfs/supermin.d\nlibguestfs: command: run: \\ x86_64\nsupermin helper [00000ms] whitelist = (not specified), host_cpu = x86_64, kernel = (null), initrd = (null), appliance = (null)\nsupermin helper [00000ms] inputs[0] = /usr/lib64/guestfs/supermin.d\nchecking modpath /lib/modules/2.6.32-358.123.3.openstack.el6.x86_64 is a directory\npicked vmlinuz-2.6.32-358.123.3.openstack.el6.x86_64 because modpath /lib/modules/2.6.32-358.123.3.openstack.el6.x86_64 exists\nsupermin helper [00000ms] finished creating kernel\nsupermin helper [00000ms] visiting /usr/lib64/guestfs/supermin.d\nsupermin helper [00000ms] visiting /usr/lib64/guestfs/supermin.d/base.img\nsupermin helper [00000ms] visiting /usr/lib64/guestfs/supermin.d/daemon.img\nsupermin helper [00000ms] visiting /usr/lib64/guestfs/supermin.d/hostfiles\nsupermin helper [00009ms] visiting /usr/lib64/guestfs/supermin.d/init.img\nsupermin helper [00009ms] visiting /usr/lib64/guestfs/supermin.d/udev-rules.img\nsupermin helper [00009ms] adding kernel modules\nsupermin helper [00025ms] finished creating appliance\nlibguestfs: checksum of existing appliance: 7c67b6b9e214d30ed039c302ea52cca5dfb864f41bc344b69e9b0caa26a05d6c\nlibguestfs: trace: get_cachedir\nlibguestfs: trace: get_cachedir = \"/var/tmp\"\nlibguestfs: [00026ms] begin testing qemu features\nlibguestfs: command: run: /usr/bin/qemu-kvm\nlibguestfs: command: run: \\ -nographic\nlibguestfs: command: run: \\ -help\nlibguestfs: command: run: /usr/bin/qemu-kvm\nlibguestfs: command: run: \\ -nographic\nlibguestfs: command: run: \\ -version\nlibguestfs: qemu version 1.2\nlibguestfs: command: run: /usr/bin/qemu-kvm\nlibguestfs: command: run: \\ -nographic\nlibguestfs: command: run: \\ -machine accel=kvm:tcg\nlibguestfs: command: run: \\ -device ?\nlibguestfs: [00057ms] finished testing qemu features\nlibguestfs: accept_from_daemon: 0x1378210 g->state = 1\n[00058ms] /usr/bin/qemu-kvm \\\n    -global virtio-blk-pci.scsi=off \\\n    -nodefconfig \\\n    -nodefaults \\\n    -nographic \\\n    -machine accel=kvm:tcg \\\n    -cpu host,+kvmclock \\\n    -m 500 \\\n    -no-reboot \\\n    -no-hpet \\\n    -kernel /var/tmp/.guestfs-0/kernel.8504 \\\n    -initrd /var/tmp/.guestfs-0/initrd.8504 \\\n    -device virtio-scsi-pci,id=scsi \\\n    -drive file=disk,cache=none,id=hd0,if=none \\\n    -device scsi-hd,drive=hd0 \\\n    -drive file=/var/tmp/.guestfs-0/root.8504,snapshot=on,id=appliance,if=none,cache=unsafe \\\n    -device scsi-hd,drive=appliance \\\n    -device virtio-serial \\\n    -serial stdio \\\n    -device sga \\\n    -chardev socket,path=/tmp/libguestfsFgt5rx/guestfsd.sock,id=channel0 \\\n    -device virtserialport,chardev=channel0,name=org.libguestfs.channel.0 \\\n    -append 'panic=1 console=ttyS0 udevtimeout=600 no_timer_check acpi=off printk.time=1 cgroup_disable=memory root=/dev/sdb selinux=0 guestfs_verbose=1 TERM=xterm-256color'\nqemu-kvm: -drive file=disk,cache=none,id=hd0,if=none: could not open disk image disk: Invalid argument\n-------------------above is there errror------------------------------------------------------------------------------------------------ \nlibguestfs: child_cleanup: 0x1378210: child process died\nlibguestfs: sending SIGTERM to process 8513\nlibguestfs: error: /usr/bin/qemu-kvm exited with error status 1, see debug messages above\nlibguestfs: error: guestfs_launch failed, see earlier error messages\nlibguestfs: trace: launch = -1 (error)\nlibguestfs: trace: close\nlibguestfs: closing guestfs handle 0x1378210 (state 0)\nlibguestfs: command: run: rm\nlibguestfs: command: run: \\ -rf /tmp/libguestfsFgt5rx\n[root@node-6 4d004b57-a918-4fc1-87b1-18f512b6fe99]# pwd\n", 
            "date_created": "2014-07-31 12:30:02.799563+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "but command 'guestfish --ro -i -a disk' returns succes\n\n..................................\nlibguestfs: trace: inspect_get_product_name \"/dev/sda1\"\nlibguestfs: trace: inspect_get_product_name = \"Fedora release 20 (Heisenbug)\"\nOperating system: Fedora release 20 (Heisenbug)\nlibguestfs: trace: inspect_get_mountpoints \"/dev/sda1\"\nlibguestfs: trace: inspect_get_mountpoints = [\"/\", \"/dev/sda1\"]\nlibguestfs: trace: canonical_device_name \"/dev/sda1\"\nlibguestfs: trace: canonical_device_name = \"/dev/sda1\"\n/dev/sda1 mounted on /\n\n><fs> \n\nthe only difference is  readonly . ", 
            "date_created": "2014-07-31 12:46:08.193081+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "I copy the instanck disk file to  root directory  then execute the same command \nguestfish\nadd disk\nrun\neverything works well\n\nIn /var/lib/nova/instances/{instancec-UUID}\nI can\nguestfish\nadd-ro disk\nrun\nbut  add disk can't work,\n I copy the disk to diffeerent directory  like /var/lib/nova/instances/,/var/lib/nova, both don't work with \"add disk\"\nbut in /var/lib, it works with \"add disk\"\nthis is the output of ls\n[root@node-7 lib]# pwd\n/var/lib\n[root@node-7 lib]# ls -al nova\ntotal 12\ndrwxr-xr-x.  9 nova nova   96 Jul 17 19:22 .\ndrwxr-xr-x. 30 root root 4096 Aug  1 11:01 ..\ndrwxr-xr-x   2 nova nova    6 Apr  4 21:57 buckets\ndrwxr-xr-x   2 nova nova    6 Apr  4 21:57 images\ndrwxr-xr-x  17 nova nova 4096 Aug  1 11:26 instances\ndrwxr-xr-x   2 nova nova    6 Apr  4 21:57 keys\ndrwxr-xr-x   2 nova nova 4096 Jul 28 16:33 networks\ndrwx------   2 nova nova   71 Jul 17 19:22 .ssh\ndrwxr-xr-x   2 nova nova  139 Jul 28 18:25 tmp\n[root@node-7 lib]#  ls -al |grep nova\ndrwxr-xr-x.  9 nova       nova          96 Jul 17 19:22 nova\n\n", 
            "date_created": "2014-08-01 03:38:14.601377+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "Chang Bo, I am using Juno code now. The root password can be injected into cirros disk. What image file are you using?\n\n", 
            "date_created": "2014-08-01 07:06:53.170479+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhaoqin"
        }, 
        {
            "content": "Hi Zhao Qin, thanks for your information\n\nThe root cause  is  I put mount  /var/lib/nova   with XFS  filesystem ,    it seems  guestfs can't  write/read  image disk in file system XFS. I unmount the  /var/lib/nova  and mout  with ext4 file system , it works well.", 
            "date_created": "2014-08-01 09:05:20.980337+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "guestfs certainly can read disk images that are located on XFS.\n\nIt looks to me like the real problem is a simple Unix permissions problem.  Try the following command:\n\n# sudo -u qemu LIBGUESTFS_DEBUG=1 LIBGUESTFS_TRACE=1 guestfish --rw -i -a disk\n", 
            "date_created": "2014-08-01 11:03:49.403273+00:00", 
            "author": "https://api.launchpad.net/1.0/~rjones-redhat"
        }, 
        {
            "content": "I'll take back part of comment 7.  Very old versions of libguestfs had trouble with XFS.  See https://bugzilla.redhat.com/show_bug.cgi?id=1044762 .  However this is fixed upstream.  Running the guestfish command that I suggested above will answer the question.", 
            "date_created": "2014-08-01 16:01:27.801947+00:00", 
            "author": "https://api.launchpad.net/1.0/~rjones-redhat"
        }, 
        {
            "content": "Thanks Richard,\n\nthe output error is :\n\nqemu-kvm: -drive file=disk,cache=none,id=hd0,if=none: could not open disk image disk: Invalid argument\n\n[root@node-6 nova]# xfs_info /var/lib/nova\nmeta-data=/dev/mapper/vm-nova    isize=256    agcount=16, agsize=8060928 blks\n         =                       sectsz=4096  attr=2, projid32bit=0\ndata     =                       bsize=4096   blocks=128974848, imaxpct=25\n         =                       sunit=0      swidth=0 blks\nnaming   =version 2              bsize=4096   ascii-ci=0\nlog      =internal               bsize=4096   blocks=62976, version=2\n         =                       sectsz=4096  sunit=1 blks, lazy-count=1\nrealtime =none                   extsz=4096   blocks=0, rtextents=0\n\nI think I hit the bug  https://bugzilla.redhat.com/show_bug.cgi?id=1044762 ,\nThe bug is fixed in libguestfs 1.24  , was it backported to  any other version  ? \nI can only find 1.20 for EL6 .\n\n\n\n", 
            "date_created": "2014-08-02 06:22:41.239539+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "No it was only backported as far as 1.22 because the change is quite invasive.", 
            "date_created": "2014-08-02 06:46:08.617101+00:00", 
            "author": "https://api.launchpad.net/1.0/~rjones-redhat"
        }, 
        {
            "content": "or  I  format the xfs with  mkfs.xfs -f -s size=512 , that works well for me ,\nthis is not a openstack bug , will close the bug soon.", 
            "date_created": "2014-08-02 07:36:11.217617+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }
    ]
}