{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 09:03:30.554050+00:00", 
    "description": "If an image has settings for the same device in both 'mappings' and 'block_device_mapping' properties, the last one should be used for instance launch. But currently 'mappings' takes precedence.\n\n=============\nSteps to reproduce:\n\n1 Create a flavor with ephemeral disk.\nopenstack flavor create m1.nano-ephemeral --id 142 --ram 64 --ephemeral 1\n\n2 Set mapping property in an image:\nopenstack image set --property mappings='[{\"device\": \"vdb\", \"virtual\": \"ephemeral0\"}]' cirros-0.3.4-x86_64-uec\n\n3 Check expected mappings:\neuca-describe-images\nIMAGE        ami-00000001        ...\nBLOCKDEVICEMAPPING        /dev/vdb\n\n3 Create a volume:\nopenstack volume create empty --size 1\n\n4 Create a snapshot:\nopenstack snapshot create empty --name empty\n| Field               | Value                                |\n| id                  | af84c37e-3521-435f-9976-e45aaf7fa2c7 |\n\n5 Set bdm property in the image with the snapshot id and the same device name:\nopenstack image set --property block_device_mapping='[{\"device_name\": \"/dev/vdb\", \"boot_index\": -1, \"source_type\": \"snapshot\", \"destination_type\": \"volume\", \"volume_size\": 1, \"delete_on_termination\": true, \"snapshot_id\": \"af84c37e-3521-435f-9976-e45aaf7fa2c7\"}]' --property bdm_v2=true cirros-0.3.4-x86_64-uec\n\n6 Check expected mappings:\neuca-describe-images\nIMAGE        ami-00000001        ...\nBLOCKDEVICEMAPPING        /dev/vdb        snap-00000001        1        true\n\nHere we see that bdm overloads mappings.\n\n7 Boot an instance with the image:\nnova boot --flavor m1.nano-ephemeral --image cirros-0.3.4-x86_64-uec inst\n\n8 Wait active state of the instance and view its volumes:\nnova show inst\n| Property                             | Value                                                          |\n| os-extended-volumes:volumes_attached | []                                                             |\n\n=============\nActual result: no volume is attached to the instance.\nExpected result: an id of an attached volume.\n\n=============\nSince Nova EC2 has not been changed for a long time, it still processes these properties in right order. So these steps use EC2 API to display expected results.\nAlso see _setUpImageSet in test_cloud.py.  Pay  attention to mapping1, block_device_mapping1, _expected_bdms1 vars. Tests ensures that bdm overloads mappings for showing images.\n\nThe behavior is broken by https://review.openstack.org/#/c/83805\nSee there in L636 of api.py:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if image_mapping:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0image_defined_bdms += self._prepare_image_mapping(\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0instance_type, image_mapping)\n\nCompare with left side's L1163:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for mapping in (image_mapping, block_device_mapping):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if not mapping:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0continue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self._update_block_device_mapping(context,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0instance_type, instance_uuid, mapping)\n\nI think it's safe to restore the old behavior.", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1485059", 
    "owner": "https://api.launchpad.net/1.0/~ftersin", 
    "id": 1485059, 
    "index": 1794, 
    "created": "2015-08-14 17:12:37.187058+00:00", 
    "title": "bdm image property should overload 'mappings' one for instance launch", 
    "comments": [
        {
            "content": "If an image has settings for the same device in both 'mappings' and 'block_device_mapping' properties, the last one should be used for instance launch. But currently 'mappings' takes precedence.\n\n=============\nSteps to reproduce:\n\n1 Create a flavor with ephemeral disk.\nopenstack flavor create m1.nano-ephemeral --id 142 --ram 64 --ephemeral 1\n\n2 Set mapping property in an image:\nopenstack image set --property mappings='[{\"device\": \"vdb\", \"virtual\": \"ephemeral0\"}]' cirros-0.3.4-x86_64-uec\n\n3 Check expected mappings:\neuca-describe-images\nIMAGE        ami-00000001        ...\nBLOCKDEVICEMAPPING        /dev/vdb\n\n3 Create a volume:\nopenstack volume create empty --size 1\n\n4 Create a snapshot:\nopenstack snapshot create empty --name empty\n+---------------------+--------------------------------------+\n| Field               | Value                                |\n+---------------------+--------------------------------------+\n| id                  | af84c37e-3521-435f-9976-e45aaf7fa2c7 |\n\n5 Set bdm property in the image with the snapshot id and the same device name:\nopenstack image set --property block_device_mapping='[{\"device_name\": \"/dev/vdb\", \"boot_index\": -1, \"source_type\": \"snapshot\", \"destination_type\": \"volume\", \"volume_size\": 1, \"delete_on_termination\": true, \"snapshot_id\": \"af84c37e-3521-435f-9976-e45aaf7fa2c7\"}]' --property bdm_v2=true cirros-0.3.4-x86_64-uec\n\n6 Check expected mappings:\neuca-describe-images\nIMAGE        ami-00000001        ...\nBLOCKDEVICEMAPPING        /dev/vdb        snap-00000001        1        true\n\nHere we see that bdm overloads mappings.\n\n7 Boot an instance with the image:\nnova boot --flavor m1.nano --image cirros-0.3.4-x86_64-uec inst\n\n8 Wait active state of the instance and view its volumes:\nnova show inst\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| os-extended-volumes:volumes_attached | []                                                             |\n\n=============\nActual result: no volume is attached to the instance.\nExpected result: an id of an attached volume.\n\n=============\nSince Nova EC2 has not been changed for a long time, it still processes these properties in right order. So these steps use EC2 API to display expected results.\nAlso see _setUpImageSet in test_cloud.py.  Pay  attention to mapping1, block_device_mapping1, _expected_bdms1 vars. Tests ensures that bdm overloads mappings for showing images.\n\nThe behavior is broken by https://review.openstack.org/#/c/83805\nSee there in L636 of api.py:\n        if image_mapping:\n            image_defined_bdms += self._prepare_image_mapping(\n                instance_type, image_mapping)\n\nCompare with left side's L1163:\n        for mapping in (image_mapping, block_device_mapping):\t\t\n            if not mapping:\t\t\n                continue\t\t\n            self._update_block_device_mapping(context,\t\t\n                    instance_type, instance_uuid, mapping)\n\nI think it's safe to restore the old behavior.", 
            "date_created": "2015-08-14 17:12:37.187058+00:00", 
            "author": "https://api.launchpad.net/1.0/~ftersin"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/213624", 
            "date_created": "2015-08-17 07:53:05.701989+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/213624\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=4eb800da95a9537407e0e972522606155f90ab63\nSubmitter: Jenkins\nBranch:    master\n\ncommit 4eb800da95a9537407e0e972522606155f90ab63\nAuthor: Feodor Tersin <email address hidden>\nDate:   Mon Aug 17 10:44:07 2015 +0300\n\n    Fix precedence of image bdms over image mappings\n    \n    If both image bdm and image mapping contain a device with the same\n    device name, the bdm definition should be used to boot an instance. See\n    bug 1485059 for details.\n    \n    Currently it is broken by Ida0ddb6efcb0014890762df000eaea679f9b1d7b.\n    \n    This patch restores initial behavior, which was implicitly based on that\n    _create_block_device_mapping overrides bdms by device name. So later\n    occurences of bdms in bdms list take precedence over early occurences.\n    \n    Closes-Bug: #1485059\n    Change-Id: I56769e4a6b1770d66ef320eb557ec695de9c74d1\n", 
            "date_created": "2015-09-18 17:13:13.816339+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}