{
    "status": "Fix Released", 
    "last_updated": "2014-03-21 11:11:10.582706+00:00", 
    "description": "The current code for soft_reboot in libvirt will only fall back to a hard reboot if the soft reboot returns a value of False.  However there are some cases where an exception in  soft reboot can be cleared by a hard reboot - for example if the image file is missing soft reboot will raise an exception, whereas a hard reboot (because it rebuilds the domain) will re-collect the image from Glance.\n\nThe code in libvirt/reboot should wrap the soft reboot attempt in a try block, and attempt a hard reboot is the soft reboot raises an libvirtError exception.\n\n\nSteps to reproduce in Devstack:\n\nCreate an instance\n $ nova boot --image aebde4c5-10d3-4d76-90ab-28be2c891047 --flavor 1 phil \n $ nova list \n $ nova list\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | ID                                   | Name | Status | Task State | Power State | Networks         |\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | 2b9451fe-3d23-4e4a-b12c-9633f0467156 | phil | ACTIVE | None       | Running     | private=10.0.0.3 |\n +--------------------------------------+------+--------+------------+-------------+------------------+\n\nFind and remove the base image backing file\n  $ cd /opt/stack/data/nova/instances\n  $ file 2b9451fe-3d23-4e4a-b12c-9633f0467156/disk\n     2b9451fe-3d23-4e4a-b12c-9633f0467156/disk: QEMU QCOW Image (v2), has backing file (path \n        /opt/stack/data/nova/instances/_base/552f54f49b488dcb1c787bd87b), 1073741824 bytes\n(Note file name may be truncated)\n   $ rm /opt/stack/data/nova/instances/_base/552f54f49b488dcb1c787bd87b2294272048874c \n \nReboot the instance\n $ nova reboot 2b9451fe-3d23-4e4a-b12c-9633f0467156\n $ nova list\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | ID                                   | Name | Status | Task State | Power State | Networks         | \n +--------------------------------------+------+--------+------------+-------------+------------------+\n | 2b9451fe-3d23-4e4a-b12c-9633f0467156 | phil | REBOOT | rebooting  | Running     | private=10.0.0.3 |\n +--------------------------------------+------+--------+------------+-------------+------------------+\n\n $ nova list\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | ID                                   | Name | Status | Task State | Power State | Networks         | \n +--------------------------------------+------+--------+------------+-------------+------------------+\n | 2b9451fe-3d23-4e4a-b12c-9633f0467156 | phil | ERROR  | None       | Running     | private=10.0.0.3 |\n +--------------------------------------+------+--------+------------+-------------+------------------+\n\nHard reboot the instance\n $ nova reboot --hard 2b9451fe-3d23-4e4a-b12c-9633f0467156\n $ nova list\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | ID                                   | Name | Status | Task State | Power State | Networks         |\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | 2b9451fe-3d23-4e4a-b12c-9633f0467156 | phil | ACTIVE | None       | Running     | private=10.0.0.3 | \n +--------------------------------------+------+--------+------------+-------------+------------------+", 
    "tags": [
        "libvirt"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1202974", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1202974, 
    "index": 3858, 
    "created": "2013-07-19 08:36:42.021683+00:00", 
    "title": "Exceptions during soft reboot should result in a hard reboot", 
    "comments": [
        {
            "content": "The current code for soft_reboot in libvirt will only fall back to a hard reboot if the soft reboot returns a value of False.  However there are some cases where an exception in  soft reboot can be cleared by a hard reboot - for example if the image file is missing soft reboot will raise an exception, whereas a hard reboot (because it rebuilds the domain) will re-collect the image from Glance.\n\nThe code in libvirt/reboot should wrap the soft reboot attempt in a try block, and attempt a hard reboot is the soft reboot raises an libvirtError exception.\n\n\nSteps to reproduce in Devstack:\n\nCreate an instance\n $ nova boot --image aebde4c5-10d3-4d76-90ab-28be2c891047 --flavor 1 phil \n $ nova list \n $ nova list\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | ID                                   | Name | Status | Task State | Power State | Networks         |\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | 2b9451fe-3d23-4e4a-b12c-9633f0467156 | phil | ACTIVE | None       | Running     | private=10.0.0.3 |\n +--------------------------------------+------+--------+------------+-------------+------------------+\n\nFind and remove the base image backing file\n  $ cd /opt/stack/data/nova/instances\n  $ file 2b9451fe-3d23-4e4a-b12c-9633f0467156/disk\n     2b9451fe-3d23-4e4a-b12c-9633f0467156/disk: QEMU QCOW Image (v2), has backing file (path \n        /opt/stack/data/nova/instances/_base/552f54f49b488dcb1c787bd87b), 1073741824 bytes\n(Note file name may be truncated)\n   $ rm /opt/stack/data/nova/instances/_base/552f54f49b488dcb1c787bd87b2294272048874c \n \nReboot the instance\n $ nova reboot 2b9451fe-3d23-4e4a-b12c-9633f0467156\n $ nova list\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | ID                                   | Name | Status | Task State | Power State | Networks         | \n +--------------------------------------+------+--------+------------+-------------+------------------+\n | 2b9451fe-3d23-4e4a-b12c-9633f0467156 | phil | REBOOT | rebooting  | Running     | private=10.0.0.3 |\n +--------------------------------------+------+--------+------------+-------------+------------------+\n\n $ nova list\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | ID                                   | Name | Status | Task State | Power State | Networks         | \n +--------------------------------------+------+--------+------------+-------------+------------------+\n | 2b9451fe-3d23-4e4a-b12c-9633f0467156 | phil | ERROR  | None       | Running     | private=10.0.0.3 |\n +--------------------------------------+------+--------+------------+-------------+------------------+\n\nHard reboot the instance\n $ nova reboot --hard 2b9451fe-3d23-4e4a-b12c-9633f0467156\n $ nova list\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | ID                                   | Name | Status | Task State | Power State | Networks         |\n +--------------------------------------+------+--------+------------+-------------+------------------+\n | 2b9451fe-3d23-4e4a-b12c-9633f0467156 | phil | ACTIVE | None       | Running     | private=10.0.0.3 | \n +--------------------------------------+------+--------+------------+-------------+------------------+", 
            "date_created": "2013-07-19 08:36:42.021683+00:00", 
            "author": "https://api.launchpad.net/1.0/~philip-day"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/38085", 
            "date_created": "2013-07-21 19:43:41.677202+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/38085\nCommitted: http://github.com/openstack/nova/commit/9925c9f1b353240ebb1eccde50574055ce271313\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9925c9f1b353240ebb1eccde50574055ce271313\nAuthor: Matt Riedemann <email address hidden>\nDate:   Sun Jul 21 12:15:14 2013 -0700\n\n    Performs hard reboot if libvirt soft reboot raises libvirtError\n    \n    Currently the libvirt driver will only attempt a hard reboot if a soft\n    reboot fails and returns False. If a libvirt exception is raised,\n    however, the hard reboot is not attempted. This patch wraps the soft\n    reboot in a try block to continue with the hard reboot attempt if a\n    libvirtError is raised.\n    \n    Fixes bug 1202974\n    \n    Change-Id: Ifaff75b33b5123cdd3293e8f263ccb4f72ae726a\n", 
            "date_created": "2013-08-04 13:20:41.862133+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/grizzly\nReview: https://review.openstack.org/48415", 
            "date_created": "2013-09-26 09:42:39.374573+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/48415\nCommitted: http://github.com/openstack/nova/commit/5e679a3911ccaf12f8f18256c22f0822a5dee378\nSubmitter: Jenkins\nBranch:    stable/grizzly\n\ncommit 5e679a3911ccaf12f8f18256c22f0822a5dee378\nAuthor: Matt Riedemann <email address hidden>\nDate:   Sun Jul 21 12:15:14 2013 -0700\n\n    Performs hard reboot if libvirt soft reboot raises libvirtError\n    \n    Currently the libvirt driver will only attempt a hard reboot if a soft\n    reboot fails and returns False. If a libvirt exception is raised,\n    however, the hard reboot is not attempted. This patch wraps the soft\n    reboot in a try block to continue with the hard reboot attempt if a\n    libvirtError is raised.\n    \n    Fixes bug 1202974\n    \n    (cherry picked from commit 9925c9f1b353240ebb1eccde50574055ce271313)\n    \n    Conflicts:\n    \tnova/tests/test_libvirt.py\n    \n    Change-Id: Ifaff75b33b5123cdd3293e8f263ccb4f72ae726a\n", 
            "date_created": "2013-10-08 22:06:51.853762+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}