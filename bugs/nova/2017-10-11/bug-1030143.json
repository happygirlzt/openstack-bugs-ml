{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:43:52.057737+00:00", 
    "description": "When deleting an active instance, the following traceback was observed:\n\n    2012-07-27 19:17:12 ERROR nova.openstack.common.rpc.amqp [-] Exception during message handling\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/openstack/common/rpc/amqp.py\", line 275, in _process_data\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/exception.py\", line 117, in wrapped\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/contextlib.py\", line 23, in __exit__\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/exception.py\", line 92, in wrapped\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 187, in decorated_function\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     function(self, context, instance_uuid, *args, **kwargs)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 211, in decorated_function\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     sys.exc_info())\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/contextlib.py\", line 23, in __exit__\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 205, in decorated_function\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     return function(self, context, instance_uuid, *args, **kwargs)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 914, in terminate_instance\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     do_terminate_instance()\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/utils.py\", line 680, in inner\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     retval = f(*args, **kwargs)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 907, in do_terminate_instance\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self._delete_instance(context, instance)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 884, in _delete_instance\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self._shutdown_instance(context, instance)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 849, in _shutdown_instance\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     block_device_info)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/driver.py\", line 218, in destroy\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self._vmops.destroy(instance, network_info, block_device_info)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 1005, in destroy\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     block_device_info=block_device_info)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 1025, in _destroy\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self._destroy_vdis(instance, vm_ref, block_device_info)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 923, in _destroy_vdis\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     nodestroy.append(bdm['connection_info']['data']['vdi_uuid'])\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp KeyError: 'vdi_uuid'", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1030143", 
    "owner": "https://api.launchpad.net/1.0/~renukaapte", 
    "id": 1030143, 
    "index": 2986, 
    "created": "2012-07-27 21:26:04.956135+00:00", 
    "title": "Xenserver: If a VDI is missing, an active instance cannot be deleted", 
    "comments": [
        {
            "content": "When deleting an active instance, the following traceback was observed:\n\n    2012-07-27 19:17:12 ERROR nova.openstack.common.rpc.amqp [-] Exception during message handling\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/openstack/common/rpc/amqp.py\", line 275, in _process_data\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/exception.py\", line 117, in wrapped\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/contextlib.py\", line 23, in __exit__\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/exception.py\", line 92, in wrapped\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 187, in decorated_function\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     function(self, context, instance_uuid, *args, **kwargs)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 211, in decorated_function\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     sys.exc_info())\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/contextlib.py\", line 23, in __exit__\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 205, in decorated_function\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     return function(self, context, instance_uuid, *args, **kwargs)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 914, in terminate_instance\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     do_terminate_instance()\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/utils.py\", line 680, in inner\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     retval = f(*args, **kwargs)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 907, in do_terminate_instance\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self._delete_instance(context, instance)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 884, in _delete_instance\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self._shutdown_instance(context, instance)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 849, in _shutdown_instance\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     block_device_info)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/driver.py\", line 218, in destroy\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self._vmops.destroy(instance, network_info, block_device_info)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 1005, in destroy\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     block_device_info=block_device_info)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 1025, in _destroy\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     self._destroy_vdis(instance, vm_ref, block_device_info)\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 923, in _destroy_vdis\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp     nodestroy.append(bdm['connection_info']['data']['vdi_uuid'])\n    2012-07-27 19:17:12 TRACE nova.openstack.common.rpc.amqp KeyError: 'vdi_uuid'", 
            "date_created": "2012-07-27 21:26:04.956135+00:00", 
            "author": "https://api.launchpad.net/1.0/~klmitch"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/10436", 
            "date_created": "2012-07-27 21:27:10.625112+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/10436\nCommitted: http://github.com/openstack/nova/commit/3f315000755732c4780dae03ef65f67d3f87e8f7\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3f315000755732c4780dae03ef65f67d3f87e8f7\nAuthor: Kevin L. Mitchell <email address hidden>\nDate:   Fri Jul 27 16:26:24 2012 -0500\n\n    Allow _destroy_vdis if a mapping has no VDI\n    \n    In _destroy_vdis() in the xenapi vmops.py, a list of VDIs to not\n    destroy is collected.  If one of the block device mappings does\n    not have a corresponding VDI, however, _destroy_vdis() fails\n    (KeyError('vdi_uuid') is raised).  This interferes with\n    instance deletion.  The problem is corrected by skipping mappings\n    for which the connection_info data does not contain 'vdi_uuid'.\n    \n    Fixes bug 1030143.\n    \n    Change-Id: I5125d557ab799fcf572f665523cd07a893ad3b90\n", 
            "date_created": "2012-07-27 21:55:22.796680+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/10574", 
            "date_created": "2012-07-30 22:48:42.596494+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/10574\nCommitted: http://github.com/openstack/nova/commit/cf8b2a2026cf8606de0f9474bd2e1563d662b4ab\nSubmitter: Jenkins\nBranch:    master\n\ncommit cf8b2a2026cf8606de0f9474bd2e1563d662b4ab\nAuthor: Renuka Apte <email address hidden>\nDate:   Mon Jul 30 14:56:24 2012 -0700\n\n    xenapi: Tag nova volumes during attach_volume\n    \n    1. Set other_config:'osvol':'True' on VBD during attach.\n    2. Use this (instead of nodestroys list) to determine which volumes\n    should not be destroyed on instance terminate.\n    3. Ensure that the SRs for the attached volumes are forgotten when\n    instance is terminated.\n    \n    In the virt/xenapi layer, there is no way to determine which of the\n    VDIs are nova volumes. This information is required when terminating\n    and instance, to ensure the volumes are kept intact, as well as other\n    operations like migrate.\n    \n    Fixes bug 1030143.\n    \n    Change-Id: Id1717e64bc29092ce9ffe13b7c254a3867fe8342\n", 
            "date_created": "2012-08-22 21:10:48.767602+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}