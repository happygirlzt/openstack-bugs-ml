{
    "status": "Fix Released", 
    "last_updated": "2015-03-13 00:52:44.514223+00:00", 
    "description": "Several methods in nova.db.sqlalchemy.api are decorated with @_retry_on_deadlock.  service_update() is not currently one of them, but it should be based on the following backtrace:\n\n4-09-15 15:40:22.574 34384 ERROR nova.servicegroup.drivers.db [-] model\nserver went away\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db Traceback\n(most recent call last):\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/servicegroup/drivers/db.py\", line\n95, in _report_state\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nservice.service_ref, state_catalog)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/conductor/api.py\", line 218, in\nservice_update\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreturn self._manager.service_update(context, service, values)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/utils.py\", line 967, in wrapper\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreturn func(*args, **kwargs)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/server.py\", line 139,\nin inner\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreturn func(*args, **kwargs)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 491, in\nservice_update\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db     svc =\nself.db.service_update(context, service['id'], values)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/db/api.py\", line 148, in\nservice_update\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreturn IMPL.service_update(context, service_id, values)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 146, in\nwrapper\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreturn f(*args, **kwargs)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 533, in\nservice_update\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nservice_ref.update(values)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/session.py\", line 447,\nin __exit__\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself.rollback()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/util/langhelpers.py\", line\n58, in __exit__\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\ncompat.reraise(exc_type, exc_value, exc_tb)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/session.py\", line 444,\nin __exit__\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself.commit()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/session.py\", line 358,\nin commit\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nt[1].commit()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1195,\nin commit\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself._do_commit()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1226,\nin _do_commit\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself.connection._commit_impl()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 491,\nin _commit_impl\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself._handle_dbapi_exception(e, None, None, None, None)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1024,\nin _handle_dbapi_exception\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nexc_info\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/util/compat.py\", line 196,\nin raise_from_cause\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreraise(type(exception), exception, tb=exc_tb)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 488,\nin _commit_impl\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself.engine.dialect.do_commit(self.connection)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/dialects/mysql/base.py\",\nline 2030, in do_commit\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\ndbapi_connection.commit()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nOperationalError: (OperationalError) (1213, 'Deadlock found when trying to\nget lock; try restarting transaction') None None", 
    "tags": [
        "in-stable-icehouse"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1370191", 
    "owner": "https://api.launchpad.net/1.0/~russellb", 
    "id": 1370191, 
    "index": 4041, 
    "created": "2014-09-16 18:09:33.554332+00:00", 
    "title": "db deadlock on service_update()", 
    "comments": [
        {
            "content": "Several methods in nova.db.sqlalchemy.api are decorated with @_retry_on_deadlock.  service_update() is not currently one of them, but it should be based on the following backtrace:\n\n4-09-15 15:40:22.574 34384 ERROR nova.servicegroup.drivers.db [-] model\nserver went away\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db Traceback\n(most recent call last):\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/servicegroup/drivers/db.py\", line\n95, in _report_state\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nservice.service_ref, state_catalog)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/conductor/api.py\", line 218, in\nservice_update\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreturn self._manager.service_update(context, service, values)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/utils.py\", line 967, in wrapper\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreturn func(*args, **kwargs)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/server.py\", line 139,\nin inner\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreturn func(*args, **kwargs)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 491, in\nservice_update\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db     svc =\nself.db.service_update(context, service['id'], values)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/db/api.py\", line 148, in\nservice_update\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreturn IMPL.service_update(context, service_id, values)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 146, in\nwrapper\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreturn f(*args, **kwargs)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 533, in\nservice_update\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nservice_ref.update(values)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/session.py\", line 447,\nin __exit__\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself.rollback()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/util/langhelpers.py\", line\n58, in __exit__\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\ncompat.reraise(exc_type, exc_value, exc_tb)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/session.py\", line 444,\nin __exit__\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself.commit()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/session.py\", line 358,\nin commit\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nt[1].commit()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1195,\nin commit\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself._do_commit()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1226,\nin _do_commit\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself.connection._commit_impl()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 491,\nin _commit_impl\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself._handle_dbapi_exception(e, None, None, None, None)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1024,\nin _handle_dbapi_exception\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nexc_info\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/util/compat.py\", line 196,\nin raise_from_cause\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nreraise(type(exception), exception, tb=exc_tb)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 488,\nin _commit_impl\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nself.engine.dialect.do_commit(self.connection)\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db   File\n\"/usr/lib64/python2.7/site-packages/sqlalchemy/dialects/mysql/base.py\",\nline 2030, in do_commit\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\ndbapi_connection.commit()\n2014-09-15 15:40:22.574 34384 TRACE nova.servicegroup.drivers.db\nOperationalError: (OperationalError) (1213, 'Deadlock found when trying to\nget lock; try restarting transaction') None None", 
            "date_created": "2014-09-16 18:09:33.554332+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/121940", 
            "date_created": "2014-09-16 18:13:22.495042+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Probably not release critical, but we should fix it.", 
            "date_created": "2014-09-17 00:43:27.865167+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/121940\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=61d54f2652424279af81c4084e87651044fac4bd\nSubmitter: Jenkins\nBranch:    master\n\ncommit 61d54f2652424279af81c4084e87651044fac4bd\nAuthor: Russell Bryant <email address hidden>\nDate:   Tue Sep 16 18:10:47 2014 +0000\n\n    db: Add @_retry_on_deadlock to service_update()\n    \n    Add the _retry_on_deadlock decorator to the service_update() method of\n    nova's sqlalchemy API.  This decorator is scattered throughout the\n    sqlalchemy API for other methods that may encounter this error.  The\n    referenced bug report shows a trace from where it occurred on this\n    method.\n    \n    Change-Id: I93b370d6457d2e85493be01a62a76404d228a6fa\n    Closes-bug: #1370191\n", 
            "date_created": "2014-09-17 10:31:43.533959+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/122146", 
            "date_created": "2014-09-17 13:20:22.048677+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/122147", 
            "date_created": "2014-09-17 13:20:50.314843+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/122147\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=a35a9fd9122b1a2972e032b2f77a73c81e8c47bc\nSubmitter: Jenkins\nBranch:    stable/havana\n\ncommit a35a9fd9122b1a2972e032b2f77a73c81e8c47bc\nAuthor: Russell Bryant <email address hidden>\nDate:   Tue Sep 16 18:10:47 2014 +0000\n\n    db: Add @_retry_on_deadlock to service_update()\n    \n    Add the _retry_on_deadlock decorator to the service_update() method of\n    nova's sqlalchemy API.  This decorator is scattered throughout the\n    sqlalchemy API for other methods that may encounter this error.  The\n    referenced bug report shows a trace from where it occurred on this\n    method.\n    \n    Change-Id: I93b370d6457d2e85493be01a62a76404d228a6fa\n    Closes-bug: #1370191\n    (cherry picked from commit 61d54f2652424279af81c4084e87651044fac4bd)\n", 
            "date_created": "2014-09-18 23:45:48.144871+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/122146\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=5d5970a77a79a11864363d8e3e4fd66862157d19\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 5d5970a77a79a11864363d8e3e4fd66862157d19\nAuthor: Russell Bryant <email address hidden>\nDate:   Tue Sep 16 18:10:47 2014 +0000\n\n    db: Add @_retry_on_deadlock to service_update()\n    \n    Add the _retry_on_deadlock decorator to the service_update() method of\n    nova's sqlalchemy API.  This decorator is scattered throughout the\n    sqlalchemy API for other methods that may encounter this error.  The\n    referenced bug report shows a trace from where it occurred on this\n    method.\n    \n    Change-Id: I93b370d6457d2e85493be01a62a76404d228a6fa\n    Closes-bug: #1370191\n    (cherry picked from commit 61d54f2652424279af81c4084e87651044fac4bd)\n", 
            "date_created": "2014-09-18 23:59:50.291852+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I've submitted https://review.openstack.org/#/c/123248/ to also add wrapping to session.commit().   the stacktrace here otherwise won't be caught using the oslo-incubator version of the code.", 
            "date_created": "2014-09-23 16:42:22.328899+00:00", 
            "author": "https://api.launchpad.net/1.0/~zzzeek"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/124112", 
            "date_created": "2014-09-25 16:54:31.660606+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Michael Bayer (<email address hidden>) on branch: stable/icehouse\nReview: https://review.openstack.org/123248\nReason: merged to the same change-id at https://review.openstack.org/#/c/124112/", 
            "date_created": "2014-09-25 16:55:20.060885+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "we're still open here.  there's another path to commit(), patch is coming", 
            "date_created": "2014-09-26 21:20:00.005221+00:00", 
            "author": "https://api.launchpad.net/1.0/~zzzeek"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/124515", 
            "date_created": "2014-09-26 21:28:33.085728+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/124112\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3371ad81ba7f2e8b1a9391dae3f0844d3dba916f\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 3371ad81ba7f2e8b1a9391dae3f0844d3dba916f\nAuthor: Mike Bayer <email address hidden>\nDate:   Mon Sep 22 16:53:55 2014 -0400\n\n    Add _wrap_db_error() support to Session.commit()\n    \n    This patch adds _wrap_db_error() to session.commit(),\n    which has been observed to be a common point of failure for\n    deadlock exceptions.   In order to achieve this, the\n    _wrap_db_error() decorator itself also needed to propagate an\n    existing DBError, as it is the case that SQLAlchemy's\n    session.commit() calls into the session.flush() method.\n    Tests are added to exercise both the nesting of _wrap_db_error()\n    when a flush() inside commit() raises an exception, as well\n    as when commit() alone raises an exception that the error\n    is wrapped as expected.\n    \n    Tests are omitted here as we are relying upon the tests\n    that were added to the corresponding oslo-incubator code.\n    \n    Closes-bug: #1370191\n    Change-Id: I91510a2b864f0c1b73cfae18f271e94334714dce\n", 
            "date_created": "2014-09-27 03:51:43.551728+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/124515\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=cac6472fd2ad495d22fe6fad89a9485cf025c437\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit cac6472fd2ad495d22fe6fad89a9485cf025c437\nAuthor: Mike Bayer <email address hidden>\nDate:   Fri Sep 26 17:27:53 2014 -0400\n\n    Add _wrap_db_error() support to SessionTransaction.commit()\n    \n    This patch adds _wrap_db_error() to the commit()\n    and rollback() methods of sqlalchemy.orm.session.SessionTransaction,\n    which is the object that is dealt with when one invokes\n    code of the form \"with session.begin():\".  The context manager\n    form does not invoke the commit() method on the\n    SQLAlchemy Session directly, and instead calls the one\n    local to the SessionTransaction.\n    \n    In order to intercept this, we must build a subclass\n    of SessionTransaction with the appropriate wrapping, and\n    then patch it into the object that is returned by\n    Session.begin(), ensuring that it is compatible with\n    _wrap_db_error().\n    \n    This whole approach is legacy; newer oslo.db versions\n    intercept errors at the point at which they occur\n    via engine events.\n    \n    Tests are omitted here as we are relying upon the tests\n    that were added to the corresponding oslo-incubator code.\n    \n    Closes-bug: #1370191\n    \n    Change-Id: Ie0456e6daa86c99cf6fbe56ca5dfd8a618f14232\n", 
            "date_created": "2014-11-08 11:38:23.279589+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The above 2 patches have  not been backported stable/havana.\nIs Havana end of life?", 
            "date_created": "2014-12-23 03:07:16.779311+00:00", 
            "author": "https://api.launchpad.net/1.0/~wenjianhn"
        }
    ]
}