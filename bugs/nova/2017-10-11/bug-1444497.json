{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:50:47.660916+00:00", 
    "description": "When instance is migrated to another compute node, it's dhcp lease is not removed from the first compute node even after instance termination.\nIf a new instance got the same IP which was present in the previous instance created on the the first compute node where dhcp lease for this IP remains, then the dnsmasq refuse DHCP request of the IP address for a new instance with different MAC.\n\nSteps to reproduce:\n        Scenario:\n            1. Create cluster (CentOS, nova-network with Flat-DHCP , Ceph for images and volumes)\n            2. Add 1 node with controller and ceph OSD roles\n            3. Add 2 node with compute and ceph OSD roles\n            4. Deploy the cluster\n\n            5. Create a VM\n            6. Wait until the VM got IP address via DHCP (in VM console log)\n            7. Migrate the VM to another compute node.\n            8. Terminate the VM.\n\n            9. Repeat stages from 5 to 8 several times (in my case - 4..6 times was enough) until a new instance stops receiving IP address via DHCP.\n            10. Check dnsmasq-dhcp.log (/var/log/daemon.log on the compute node) for messages like :\n=============================================\n2014-11-09T20:28:29.671344+00:00 warning: not using configured address 10.0.0.2 because it is leased to fa:16:3e:65:70:be\n\nThis means that:\n   I. An instance was created on the compute node-1 and got a dhcp lease:\n==== nova-dhcpbridge.log\n2014-11-09 20:12:03.811 27360 DEBUG nova.dhcpbridge [-] Called 'add' for mac 'fa:16:3e:65:70:be' with ip '10.0.0.2' main /usr/lib/python2.6/site-packages/nova/cmd/dhcpbridge.py:135\n\n  II. When the instance was migrating from compute node-1 to node-3, 'dhcp_release' was not performed on compute node-1, please check the time range in the logs : 2014-11-09 20:14:36-37\n==== Running.log (node-1)\n2014-11-09T20:14:36.647588+00:00 debug: cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf conntrack -D -r 10.0.0.2\n### But there is missing a command like: sudo nova-rootwrap /etc/nova/rootwrap.conf dhcp_release br100 10.0.0.2 fa:16:3e:65:70:be\n\n  III. On the compute node-3, DHCP lease was added and it was successfully removed when the instance was terminated:\n==== Running.log (node-3)\n2014-11-09T20:15:17.250243+00:00 debug: cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf dhcp_release br100 10.0.0.2 fa:16:3e:65:70:be\n\n  IV. When an another instance got the same address '10.0.0.2' and was created on node-1, it didn't get IP address via DHCP:\n==== Running.log (node-1)\n2014-11-09T20:28:29.671344+00:00 warning: not using configured address 10.0.0.2 because it is leased to fa:16:3e:65:70:be", 
    "tags": [
        "in-stable-kilo", 
        "kilo-backport-potential", 
        "live-migration", 
        "nova-network"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1444497", 
    "owner": "https://api.launchpad.net/1.0/~tdurakov", 
    "id": 1444497, 
    "index": 4218, 
    "created": "2015-04-15 14:06:12.100642+00:00", 
    "title": "Instance doesn't get an address via DHCP (nova-network) because of issue with live migration", 
    "comments": [
        {
            "content": "When instance is migrated to another compute node, it's dhcp lease is not removed from the first compute node even after instance termination.\nIf a new instance got the same IP which was present in the previous instance created on the the first compute node where dhcp lease for this IP remains, then the dnsmasq refuse DHCP request of the IP address for a new instance with different MAC.\n\nSteps to reproduce:\n        Scenario:\n            1. Create cluster (CentOS, nova-network with Flat-DHCP , Ceph for images and volumes)\n            2. Add 1 node with controller and ceph OSD roles\n            3. Add 2 node with compute and ceph OSD roles\n            4. Deploy the cluster\n\n            5. Create a VM\n            6. Wait until the VM got IP address via DHCP (in VM console log)\n            7. Migrate the VM to another compute node.\n            8. Terminate the VM.\n\n            9. Repeat stages from 5 to 8 several times (in my case - 4..6 times was enough) until a new instance stops receiving IP address via DHCP.\n            10. Check dnsmasq-dhcp.log (/var/log/daemon.log on the compute node) for messages like :\n=============================================\n2014-11-09T20:28:29.671344+00:00 warning: not using configured address 10.0.0.2 because it is leased to fa:16:3e:65:70:be\n\nThis means that:\n   I. An instance was created on the compute node-1 and got a dhcp lease:\n==== nova-dhcpbridge.log\n2014-11-09 20:12:03.811 27360 DEBUG nova.dhcpbridge [-] Called 'add' for mac 'fa:16:3e:65:70:be' with ip '10.0.0.2' main /usr/lib/python2.6/site-packages/nova/cmd/dhcpbridge.py:135\n\n  II. When the instance was migrating from compute node-1 to node-3, 'dhcp_release' was not performed on compute node-1, please check the time range in the logs : 2014-11-09 20:14:36-37\n==== Running.log (node-1)\n2014-11-09T20:14:36.647588+00:00 debug: cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf conntrack -D -r 10.0.0.2\n### But there is missing a command like: sudo nova-rootwrap /etc/nova/rootwrap.conf dhcp_release br100 10.0.0.2 fa:16:3e:65:70:be\n\n  III. On the compute node-3, DHCP lease was added and it was successfully removed when the instance was terminated:\n==== Running.log (node-3)\n2014-11-09T20:15:17.250243+00:00 debug: cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf dhcp_release br100 10.0.0.2 fa:16:3e:65:70:be\n\n  IV. When an another instance got the same address '10.0.0.2' and was created on node-1, it didn't get IP address via DHCP:\n==== Running.log (node-1)\n2014-11-09T20:28:29.671344+00:00 warning: not using configured address 10.0.0.2 because it is leased to fa:16:3e:65:70:be", 
            "date_created": "2015-04-15 14:06:12.100642+00:00", 
            "author": "https://api.launchpad.net/1.0/~tdurakov"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/173913", 
            "date_created": "2015-04-15 14:43:57.046249+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/173913\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d15c57a499fd7e87b3752ab007f344e055714f05\nSubmitter: Jenkins\nBranch:    master\n\ncommit d15c57a499fd7e87b3752ab007f344e055714f05\nAuthor: Timofey Durakov <email address hidden>\nDate:   Wed Apr 15 17:29:00 2015 +0300\n\n    Fixed nova-network dhcp-hostsfile update during live-migration\n    \n    During live migration _post_live_migration and\n    post_live_migration_at_destination_method are executed\n    simultaneously, because second one is called over rpc.cast\n    In _post_live_migration method there was setup_network_on_host\n    call with teardown=True, which expects new host in instances\n    table db field. This update could be happened later, as it\n    executes on destination node in second method. To guarantee\n    execution order  setup_network_on_host call, which cleans\n    dhcp-hostfile is moved to destination node.\n    Closes-Bug: #1444497\n    \n    Change-Id: I55f0c0148c937601e78f0beecc21b30a1164a690\n", 
            "date_created": "2015-04-23 20:19:03.651177+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/198340", 
            "date_created": "2015-07-03 13:01:19.458352+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/198340\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0cf44ff628cc9ed1e3092ac1c7746b696ac3b6aa\nSubmitter: Jenkins\nBranch:    stable/kilo\n\ncommit 0cf44ff628cc9ed1e3092ac1c7746b696ac3b6aa\nAuthor: Timofey Durakov <email address hidden>\nDate:   Wed Apr 15 17:29:00 2015 +0300\n\n    Fixed nova-network dhcp-hostsfile update during live-migration\n    \n    During live migration _post_live_migration and\n    post_live_migration_at_destination_method are executed\n    simultaneously, because second one is called over rpc.cast\n    In _post_live_migration method there was setup_network_on_host\n    call with teardown=True, which expects new host in instances\n    table db field. This update could be happened later, as it\n    executes on destination node in second method. To guarantee\n    execution order  setup_network_on_host call, which cleans\n    dhcp-hostfile is moved to destination node.\n    Closes-Bug: #1444497\n    \n    (cherry picked from commit d15c57a499fd7e87b3752ab007f344e055714f05)\n    \n    Change-Id: I55f0c0148c937601e78f0beecc21b30a1164a690\n", 
            "date_created": "2015-07-23 07:06:58.969407+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}