{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:34:26.050208+00:00", 
    "description": "Environment:\n- Ubuntu Server 11.04\n- OpenStack Diablo release (2011.3)\n\nSteps to reproduce:\n- create an image with qcow2 disk\n- upload an image:\n  glance-upload --disk-format=aki --container-format=aki --type=kernel ...\n  glance-upload --disk-format=ari --container-format=ari --type=ramdisk ...\n  glance-upload --disk-format=ami --container-format=ami --type=machine ...\n- start instance of the uploaded image\n- try to create a snaphot with 'nova image-create' command\n\nProblem:\nError occured during nova-image create command, here is a fragment of nova-api.log:\n\n2011-10-13 10:41:07,611 AUDIT nova.compute.manager [a92a2892-b9ad-464b-b261-38f9d8e709a6 cloudroot sandbox] instance 7: snapshotting\n2011-10-13 10:41:25,504 DEBUG nova.utils [-] Running cmd (subprocess): qemu-img convert -f qcow2 -O ami -s c8b77874aacb40018955f96935e850d1 /var/lib/nova/instances/instance-00000007/disk /tmp/tmp1KtwHx/c8b77874aacb40018955f96935e850d1 from (pid=29030) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-10-13 10:41:25,559 DEBUG nova.utils [-] Result was 1 from (pid=29030) execute /usr/lib/python2.7/dist-packages/nova/utils.py:180\n2011-10-13 10:41:25,560 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 98, in wrapped\n(nova.exception): TRACE: return f(*args, **kw)\n(nova.exception): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 459, in snapshot\n(nova.exception): TRACE: utils.execute(*qemu_img_cmd)\n(nova.exception): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 188, in execute\n(nova.exception): TRACE: cmd=' '.join(cmd))\n(nova.exception): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova.exception): TRACE: Command: qemu-img convert -f qcow2 -O ami -s c8b77874aacb40018955f96935e850d1 /var/lib/nova/instances/instance-00000007/disk /tmp/tmp1KtwHx/c8b77874aacb40018955f96935e850d1\n(nova.exception): TRACE: Exit code: 1\n(nova.exception): TRACE: Stdout: ''\n(nova.exception): TRACE: Stderr: \"qemu-img: Unknown file format 'ami'\\n\"\n(nova.exception): TRACE:\n2011-10-13 10:41:25,566 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE: rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 98, in wrapped\n(nova.rpc): TRACE: return f(*args, **kw)\n(nova.rpc): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 655, in snapshot_instance\n(nova.rpc): TRACE: self.driver.snapshot(context, instance_ref, image_id)\n(nova.rpc): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 129, in wrapped\n(nova.rpc): TRACE: raise Error(str(e))\n(nova.rpc): TRACE: Error: Unexpected error while running command.\n(nova.rpc): TRACE: Command: qemu-img convert -f qcow2 -O ami -s c8b77874aacb40018955f96935e850d1 /var/lib/nova/instances/instance-00000007/disk /tmp/tmp1KtwHx/c8b77874aacb40018955f96935e850d1\n(nova.rpc): TRACE: Exit code: 1\n(nova.rpc): TRACE: Stdout: ''\n(nova.rpc): TRACE: Stderr: \"qemu-img: Unknown file format 'ami'\\n\"\n(nova.rpc): TRACE:\n2011-10-13 10:41:53,455 INFO nova.compute.manager [-] Updating host status\n\nOriginal image description (glance show):\n\nPublic: Yes\nName: ttylinux-uec-i386-11.2_2.6.35-16_1\nStatus: active\nSize: 15663104\nDisk format: ami\nContainer format: ami\nMinimum Ram Required (MB): 0\nMinimum Disk Required (GB): 0\nProperty 'kernel_id': 22\nProperty 'ramdisk_id': 23\nProperty 'type': machine\n\nWorkaroung:\nEdit /usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\nChange destination format in ''qemu_img_cmd' in function 'def snapshot'. I've made the following:\n\n        # Export the snapshot to a raw image\n        temp_dir = tempfile.mkdtemp()\n        out_path = os.path.join(temp_dir, snapshot_name)\n        qemu_img_cmd = ('qemu-img',\n                        'convert',\n                        '-f',\n                        source_format,\n                        '-O',\n                        #>>>> image_format, \n                        source_format,\n                        '-s',\n                        snapshot_name,\n                        disk_path,\n                        out_path)\n        utils.execute(*qemu_img_cmd)", 
    "tags": [
        "verification-needed"
    ], 
    "importance": "Medium", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/873156", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 873156, 
    "index": 2593, 
    "created": "2011-10-13 04:49:32.294915+00:00", 
    "title": "Unhandled exception during 'nova image-create' caused by wrong destination format in qemu-img create", 
    "comments": [
        {
            "content": "Environment:\n- Ubuntu Server 11.04\n- OpenStack Diablo release (2011.3)\n\nSteps to reproduce:\n- create an image with qcow2 disk\n- upload an image:\n  glance-upload --disk-format=aki --container-format=aki --type=kernel ...\n  glance-upload --disk-format=ari --container-format=ari --type=ramdisk ...\n  glance-upload --disk-format=ami --container-format=ami --type=machine ...\n- start instance of the uploaded image\n- try to create a snaphot with 'nova image-create' command\n\nProblem:\nError occured during nova-image create command, here is a fragment of nova-api.log:\n\n2011-10-13 10:41:07,611 AUDIT nova.compute.manager [a92a2892-b9ad-464b-b261-38f9d8e709a6 cloudroot sandbox] instance 7: snapshotting\n2011-10-13 10:41:25,504 DEBUG nova.utils [-] Running cmd (subprocess): qemu-img convert -f qcow2 -O ami -s c8b77874aacb40018955f96935e850d1 /var/lib/nova/instances/instance-00000007/disk /tmp/tmp1KtwHx/c8b77874aacb40018955f96935e850d1 from (pid=29030) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-10-13 10:41:25,559 DEBUG nova.utils [-] Result was 1 from (pid=29030) execute /usr/lib/python2.7/dist-packages/nova/utils.py:180\n2011-10-13 10:41:25,560 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 98, in wrapped\n(nova.exception): TRACE: return f(*args, **kw)\n(nova.exception): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 459, in snapshot\n(nova.exception): TRACE: utils.execute(*qemu_img_cmd)\n(nova.exception): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 188, in execute\n(nova.exception): TRACE: cmd=' '.join(cmd))\n(nova.exception): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova.exception): TRACE: Command: qemu-img convert -f qcow2 -O ami -s c8b77874aacb40018955f96935e850d1 /var/lib/nova/instances/instance-00000007/disk /tmp/tmp1KtwHx/c8b77874aacb40018955f96935e850d1\n(nova.exception): TRACE: Exit code: 1\n(nova.exception): TRACE: Stdout: ''\n(nova.exception): TRACE: Stderr: \"qemu-img: Unknown file format 'ami'\\n\"\n(nova.exception): TRACE:\n2011-10-13 10:41:25,566 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE: rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 98, in wrapped\n(nova.rpc): TRACE: return f(*args, **kw)\n(nova.rpc): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 655, in snapshot_instance\n(nova.rpc): TRACE: self.driver.snapshot(context, instance_ref, image_id)\n(nova.rpc): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 129, in wrapped\n(nova.rpc): TRACE: raise Error(str(e))\n(nova.rpc): TRACE: Error: Unexpected error while running command.\n(nova.rpc): TRACE: Command: qemu-img convert -f qcow2 -O ami -s c8b77874aacb40018955f96935e850d1 /var/lib/nova/instances/instance-00000007/disk /tmp/tmp1KtwHx/c8b77874aacb40018955f96935e850d1\n(nova.rpc): TRACE: Exit code: 1\n(nova.rpc): TRACE: Stdout: ''\n(nova.rpc): TRACE: Stderr: \"qemu-img: Unknown file format 'ami'\\n\"\n(nova.rpc): TRACE:\n2011-10-13 10:41:53,455 INFO nova.compute.manager [-] Updating host status\n\nOriginal image description (glance show):\n\nPublic: Yes\nName: ttylinux-uec-i386-11.2_2.6.35-16_1\nStatus: active\nSize: 15663104\nDisk format: ami\nContainer format: ami\nMinimum Ram Required (MB): 0\nMinimum Disk Required (GB): 0\nProperty 'kernel_id': 22\nProperty 'ramdisk_id': 23\nProperty 'type': machine\n\nWorkaroung:\nEdit /usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\nChange destination format in ''qemu_img_cmd' in function 'def snapshot'. I've made the following:\n\n        # Export the snapshot to a raw image\n        temp_dir = tempfile.mkdtemp()\n        out_path = os.path.join(temp_dir, snapshot_name)\n        qemu_img_cmd = ('qemu-img',\n                        'convert',\n                        '-f',\n                        source_format,\n                        '-O',\n                        #>>>> image_format, \n                        source_format,\n                        '-s',\n                        snapshot_name,\n                        disk_path,\n                        out_path)\n        utils.execute(*qemu_img_cmd)", 
            "date_created": "2011-10-13 04:49:32.294915+00:00", 
            "author": "https://api.launchpad.net/1.0/~vvbelavin"
        }, 
        {
            "content": "Proposed a fix for this.  Really, glance should not force disk format of 'ami' images to be 'ami'.  I think container format is enough, then you could have a qcow2 ami for example.", 
            "date_created": "2011-10-14 17:08:39.771379+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I had the same issue. I've tried the workaround proposed by Valery, but it doesn't work for me using Diablo release, \n\nnova version  2011.3 (2011.3-nova-milestone-tarball:tarmac-20110922115702-k9nkvxqzhj130av2)\nglance version 2011.3\n\nIn my case, the problemas appears after doing the next steps:\n\n 1) First, I've uploaded the images using euca-upload-bundle. Below is my image metadata, displayed by glance:\n\nId: 3\nPublic: No\nName: None\nStatus: active\nSize: 5370494976\nDisk format: ami\nContainer format: ami\nMinimum Ram Required (MB): 0\nMinimum Disk Required (GB): 0\nProperty 'image_location': mybucket/ubuntu-10.10-jeos-0.1rev14.img.manifest.xml\nProperty 'image_state': available\nProperty 'project_id': CloudZEN\nProperty 'architecture': x86_64\n\n2)  Then, I create a new instance based on this image, and do some changes.\n\n3) After that I tried to capture a new image with \"nova image-create\" command\". Below the nova-comput.log optput:\n\n2011-10-17 16:49:43,765 DEBUG nova.compute.manager [-] Checking state of instance-00000003 from (pid=622) _get_power_state /usr/lib/python2.7/dist-packages/nova/compute/manager.py:188\n2011-10-17 16:49:44,640 AUDIT nova.compute.manager [fcb49d9e-ef04-41f0-a2aa-c2e509a29853 sensei CloudZEN] instance 3: snapshotting\n2011-10-17 16:51:28,499 DEBUG nova.utils [-] Running cmd (subprocess): qemu-img convert -f qcow2 -O qcow2 -s 0f5fa0a9eaad4665a910c5e6f5b839d6 /var/lib/nova/instances/instance-00000003/disk /tmp/tmp8tsZ4f/0f5fa0a9eaad4665a910c5e6f5b839d6 from (pid=622) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-10-17 16:51:28,548 INFO nova.compute.manager [-] Updating host status\n2011-10-17 16:52:31,843 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 98, in wrapped\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 466, in snapshot\n(nova.exception): TRACE:     image_file)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/image/glance.py\", line 287, in update\n(nova.exception): TRACE:     image_meta = client.update_image(image_id, image_meta, data)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/glance/client.py\", line 157, in update_image\n(nova.exception): TRACE:     res = self.do_request(\"PUT\", \"/images/%s\" % image_id, body, headers)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/glance/common/client.py\", line 140, in do_request\n(nova.exception): TRACE:     method, action, body=body, headers=headers, params=params)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/glance/common/client.py\", line 230, in _do_request\n(nova.exception): TRACE:     raise exception.Invalid(res.read())\n(nova.exception): TRACE: Invalid: 400 Bad Request\n(nova.exception): TRACE: \n(nova.exception): TRACE: The server could not comply with the request since it is either malformed or otherwise incorrect.\n(nova.exception): TRACE: \n(nova.exception): TRACE:  Failed to update image metadata. Got error: 400 Bad Request  The server could not comply with the request since it is either malformed or otherwise incorrect.   Failed to update image metadata. Got error: Invalid mix of disk and container formats. When setting a disk or container format to one of 'ami', 'ari', or 'ami', the container and disk formats must match.    \n(nova.exception): TRACE: \n2011-10-17 16:52:31,956 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 98, in wrapped\n(nova.rpc): TRACE:     return f(*args, **kw)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 655, in snapshot_instance\n(nova.rpc): TRACE:     self.driver.snapshot(context, instance_ref, image_id)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 129, in wrapped\n(nova.rpc): TRACE:     raise Error(str(e))\n(nova.rpc): TRACE: Error: 400 Bad Request\n(nova.rpc): TRACE: \n(nova.rpc): TRACE: The server could not comply with the request since it is either malformed or otherwise incorrect.\n(nova.rpc): TRACE: \n(nova.rpc): TRACE:  Failed to update image metadata. Got error: 400 Bad Request  The server could not comply with the request since it is either malformed or otherwise incorrect.   Failed to update image metadata. Got error: Invalid mix of disk and container formats. When setting a disk or container format to one of 'ami', 'ari', or 'ami', the container and disk formats must match.   \n\n4) I've tried modifying the image metdata in glance, using the flag snapshot_image_format (tried \"qcow2\" and \"raw\" , or the domain settings with virsh, but the problem persist.\n", 
            "date_created": "2011-10-17 18:04:26.201933+00:00", 
            "author": "https://api.launchpad.net/1.0/~juanpm"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/889\nCommitted: http://github.com/openstack/nova/commit/b931d51ce47203ee6a4433dc7577e0779ab94710\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit b931d51ce47203ee6a4433dc7577e0779ab94710\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Fri Oct 14 10:06:00 2011 -0700\n\n    Makes snapshots work for amis. Fixes bug 873156\n    \n    Change-Id: I6ceb714f31afaf59c28c5ab3b2ab85409dbe89c6\n", 
            "date_created": "2011-10-17 19:38:34+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "I've applied the fix and it works for me! Thank you very much.\n\nTh nova-compute.log ouput now, shows:\n\n2011-10-18 20:25:29,968 DEBUG nova.compute.manager [-] Checking state of instance-00000003 from (pid=32205) _get_power_state /usr/lib/python2.7/dist-packages/nova/compute/manager.py:188\n2011-10-18 20:25:31,080 AUDIT nova.compute.manager [f3aa092a-2d16-46ba-813b-30a1f16098a9 user PROJECT] instance 3: snapshotting\n2011-10-18 20:28:10,897 DEBUG nova.utils [-] Running cmd (subprocess): qemu-img convert -f qcow2 -O raw -s cd6e87433a3441b09e4e2f5bf244721f /var/lib/nova/instances/instance-00000003/disk /tmp/tmpXSA77w/cd6e87433a3441b09e4e2f5bf244721f from (pid=32205) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-10-18 20:28:10,926 INFO nova.compute.manager [-] Updating host status\n ", 
            "date_created": "2011-10-18 20:33:24.058990+00:00", 
            "author": "https://api.launchpad.net/1.0/~juanpm"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/996\nCommitted: http://github.com/openstack/nova/commit/d46f6e095b43fc00099d87f73b098a137830b167\nSubmitter: Jenkins\nBranch:    stable/diablo\n\n status fixcommitted\n done\n\ncommit d46f6e095b43fc00099d87f73b098a137830b167\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Fri Oct 14 10:06:00 2011 -0700\n\n    Makes snapshots work for amis. Fixes bug 873156\n    \n    (cherry picked from commit b931d51ce47203ee6a4433dc7577e0779ab94710)\n    \n    Change-Id: I3adee5aed8a500602fb938f27fa5096ec376cbe2\n", 
            "date_created": "2011-10-26 17:05:45+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "Hello Valeriy, or anyone else affected,\n\nAccepted nova into oneiric-proposed, the package will build now and be available in a few hours. Please test and give feedback here. See https://wiki.ubuntu.com/Testing/EnableProposed for documentation how to enable and use -proposed. Thank you in advance!", 
            "date_created": "2011-12-19 14:59:07.630122+00:00", 
            "author": "https://api.launchpad.net/1.0/~pitti"
        }
    ]
}