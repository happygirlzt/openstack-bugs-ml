{
    "status": "Fix Released", 
    "last_updated": "2017-03-22 10:13:37.335453+00:00", 
    "description": "Description\n===========\nWhen live migration is finished it's possible that keystone auth token is already expired,\nthat causes for post_step to fail\n\nSteps to reproduce\n==================\nthere are 2 options to reproduce this issue:\n1. run live-migration of heavy loaded instance, wait for token to expire, and after that try to execute live-migration-force-complete\n2. set a breakpoint in _post_live_migration method of compute manager, once breakpoint is reached,\ndo openstack token revoke, continue nova execution normally\n\nExpected result\n===============\nlive-migration to be finished sucessfully\n\nActual result\n=============\npost step is failed, overall migration is also failed\n\nEnvironment\n===========\n1. I've tested this case on Newton version, but the issue should be valid for master branch too.\n\n2. Libvirt + kvm\n\n2. Ceph\n\n3. Neutron vxlan", 
    "tags": [
        "live-migration"
    ], 
    "importance": "Medium", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1647451", 
    "owner": "https://api.launchpad.net/1.0/~tdurakov", 
    "id": 1647451, 
    "index": 4697, 
    "created": "2016-12-05 19:07:46.482136+00:00", 
    "title": "Post live migration step could fail due to auth errors", 
    "comments": [
        {
            "content": "Description\n===========\nWhen live migration is finished it's possible that keystone auth token is already expired,\nthat causes for post_step to fail\n\nSteps to reproduce\n==================\nthere are 2 options to reproduce this issue:\n1. run live-migration of heavy loaded instance, wait for token to expire, and after that try to execute live-migration-force-complete\n2. set a breakpoint in _post_live_migration method of compute manager, once breakpoint is reached,\ndo openstack token revoke, continue nova execution normally\n\nExpected result\n===============\nlive-migration to be finished sucessfully\n\nActual result\n=============\npost step is failed, overall migration is also failed\n\nEnvironment\n===========\n1. I've tested this case on Newton version, but the issue should be valid for master branch too.\n\n2. Libvirt + kvm\n\n2. Ceph\n\n3. Neutron vxlan", 
            "date_created": "2016-12-05 19:07:46.482136+00:00", 
            "author": "https://api.launchpad.net/1.0/~tdurakov"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/407147", 
            "date_created": "2016-12-05 19:14:56.976522+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Tracebacks for the bug:\n\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/dist-packages/eventlet/queue.py\", line 118, in switch\n    self.greenlet.switch(value)\n  File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 1182, in context_wrapper\n    func(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 5354, in dispatch_live_migration\n    self._do_live_migration(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 5333, in _do_live_migration\n    self._set_migration_status(migration, 'error')\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 5326, in _do_live_migration\n    block_migration, migrate_data)\n  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 5856, in live_migration\n    migrate_data)\n  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 6573, in _live_migration                                                                                                 [0/416]\n    dom, finish_event, disk_paths)\n  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 6491, in _live_migration_monitor\n    migrate_data)\n  File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 110, in wrapped\n    payload)\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 89, in wrapped\n    return f(self, context, *args, **kw)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 387, in decorated_function\n    kwargs['instance'], e, sys.exc_info())\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 375, in decorated_function\n    return function(self, context, *args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 5493, in _post_live_migration\n    network_info = self.network_api.get_instance_nw_info(ctxt, instance)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/base_api.py\", line 253, in get_instance_nw_info\n    result = self._get_instance_nw_info(context, instance, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 934, in _get_instance_nw_info\n    preexisting_port_ids)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 1737, in _build_network_info_model\n    context, instance, networks, port_ids)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 957, in _gather_port_ids_and_networks\n    net_ids)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 201, in _get_available_networks\n    nets = neutron.list_networks(**search_opts).get('networks', [])\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 97, in with_params\n    ret = self.function(instance, *args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 671, in list_networks\n    **_params)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 373, in list\n    for r in self._pagination(collection, path, **params):\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 388, in _pagination\n    res = self.get(path, params=params)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 358, in get\n    headers=headers, params=params)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 335, in retry_request\n    headers=headers, params=params)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 298, in do_request\n    self._handle_fault_response(status_code, replybody, resp)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 273, in _handle_fault_response\n    exception_handler_v20(status_code, error_body)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 84, in exception_handler_v20\n    request_ids=request_ids)\nUnauthorized: Authentication required\nNeutron server returns request_ids: ['req-893f2c0e-ce92-4e73-908d-0fab3be7c2a7']\n\n\n\n\n\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/dist-packages/eventlet/queue.py\", line 118, in switch\n    self.greenlet.switch(value)\n  File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 1182, in context_wrapper\n    func(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 5354, in dispatch_live_migration\n    self._do_live_migration(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 5333, in _do_live_migration\n    self._set_migration_status(migration, 'error')\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 5326, in _do_live_migration\n    block_migration, migrate_data)\n  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 5856, in live_migration\n    migrate_data)\n  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 6573, in _live_migration\n    dom, finish_event, disk_paths)\n  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 6491, in _live_migration_monitor\n    migrate_data)\n  File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 110, in wrapped\n    payload)\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 89, in wrapped\n    return f(self, context, *args, **kw)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 375, in decorated_function\n    return function(self, context, *args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 375, in decorated_function\n    return function(self, context, *args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 5493, in _post_live_migration\n    network_info = self.network_api.get_instance_nw_info(ctxt, instance)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/base_api.py\", line 253, in get_instance_nw_info\n    result = self._get_instance_nw_info(context, instance, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 934, in _get_instance_nw_info\n    preexisting_port_ids)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 1762, in _build_network_info_model\n    network_IPs)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 1620, in _nw_info_get_subnets\n    subnets = self._get_subnets_from_port(context, port)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 1821, in _get_subnets_from_port\n    data = get_client(context).list_ports(**search_opts)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 97, in with_params\n    ret = self.function(instance, *args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 644, in list_ports\n    **_params)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 373, in list\n    for r in self._pagination(collection, path, **params):\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 388, in _pagination\n    res = self.get(path, params=params)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 358, in get\n    headers=headers, params=params)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 335, in retry_request\n    headers=headers, params=params)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 298, in do_request\n    self._handle_fault_response(status_code, replybody, resp)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 273, in _handle_fault_response\n    exception_handler_v20(status_code, error_body)\n  File \"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\", line 84, in exception_handler_v20\n    request_ids=request_ids)\nUnauthorized: Authentication required\nNeutron server returns request_ids: ['req-e3afbabf-22df-42a2-9a11-564710528dc2']\n\n", 
            "date_created": "2016-12-06 09:52:42.966290+00:00", 
            "author": "https://api.launchpad.net/1.0/~tdurakov"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/407147\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=4a5ecf1e29c3bdbb022f98a5fba41d4e7df56d88\nSubmitter: Jenkins\nBranch:    master\n\ncommit 4a5ecf1e29c3bdbb022f98a5fba41d4e7df56d88\nAuthor: Timofey Durakov <email address hidden>\nDate:   Thu Dec 1 19:03:24 2016 +0300\n\n    fix for auth during live-migration\n    \n    Post step could fail due to auth token expiration.\n    get_instance_nw_info fails with authentication required,\n    because there are several calls to neutron api, some of them\n    are admin context, while others try to use token from request\n    context. This patch ensure that if admin context is initially used,\n    all subsequent calls will use the same initialized client\n    \n    Closes-Bug: #1647451\n    \n    Change-Id: I8962a9cd472cbbb5b9b67c5b164ff29fd8f5558a\n", 
            "date_created": "2016-12-13 23:04:00.877524+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/410618", 
            "date_created": "2016-12-14 09:08:38.997969+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b2 development milestone.", 
            "date_created": "2016-12-15 17:34:12.650325+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/410618\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8e097039e73663689b4c630589ab2dd5a569b5de\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 8e097039e73663689b4c630589ab2dd5a569b5de\nAuthor: Timofey Durakov <email address hidden>\nDate:   Thu Dec 1 19:03:24 2016 +0300\n\n    fix for auth during live-migration\n    \n    Post step could fail due to auth token expiration.\n    get_instance_nw_info fails with authentication required,\n    because there are several calls to neutron api, some of them\n    are admin context, while others try to use token from request\n    context. This patch ensure that if admin context is initially used,\n    all subsequent calls will use the same initialized client\n    \n    Closes-Bug: #1647451\n    \n    Change-Id: I8962a9cd472cbbb5b9b67c5b164ff29fd8f5558a\n    (cherry picked from commit 4a5ecf1e29c3bdbb022f98a5fba41d4e7df56d88)\n", 
            "date_created": "2017-03-08 06:27:04.347576+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.5 release.", 
            "date_created": "2017-03-22 10:13:36.683015+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}