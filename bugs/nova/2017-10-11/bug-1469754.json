{
    "status": "Won't Fix", 
    "last_updated": "2016-02-20 15:10:22.862794+00:00", 
    "description": "http://logs.openstack.org/23/193223/3/check/check-tempest-dsvm-nova-v21-full/5f73178/console.html.gz#_2015-06-26_23_49_24_797\n\n2015-06-26 23:49:24.797 | tempest.thirdparty.boto.test_ec2_instance_run.InstanceRunTest.test_compute_with_volumes[id-ab836c29-737b-4101-9fb9-87045eaf89e9]\n2015-06-26 23:49:24.797 | --------------------------------------------------------------------------------------------------------------------------------\n2015-06-26 23:49:24.797 | \n2015-06-26 23:49:24.798 | Captured traceback:\n2015-06-26 23:49:24.798 | ~~~~~~~~~~~~~~~~~~~\n2015-06-26 23:49:24.798 |     Traceback (most recent call last):\n2015-06-26 23:49:24.798 |       File \"tempest/thirdparty/boto/test_ec2_instance_run.py\", line 338, in test_compute_with_volumes\n2015-06-26 23:49:24.798 |         wait.state_wait(_part_state, 'INCREASE')\n2015-06-26 23:49:24.798 |       File \"tempest/thirdparty/boto/utils/wait.py\", line 36, in state_wait\n2015-06-26 23:49:24.798 |         old_status = status = lfunction()\n2015-06-26 23:49:24.799 |       File \"tempest/thirdparty/boto/test_ec2_instance_run.py\", line 330, in _part_state\n2015-06-26 23:49:24.799 |         current = ssh.get_partitions().split('\\n')\n2015-06-26 23:49:24.799 |       File \"tempest/common/utils/linux/remote_client.py\", line 82, in get_partitions\n2015-06-26 23:49:24.799 |         output = self.exec_command(command)\n2015-06-26 23:49:24.799 |       File \"tempest/common/utils/linux/remote_client.py\", line 56, in exec_command\n2015-06-26 23:49:24.799 |         return self.ssh_client.exec_command(cmd)\n2015-06-26 23:49:24.800 |       File \"/opt/stack/new/tempest/.tox/full/local/lib/python2.7/site-packages/tempest_lib/common/ssh.py\", line 111, in exec_command\n2015-06-26 23:49:24.800 |         ssh = self._get_ssh_connection()\n2015-06-26 23:49:24.800 |       File \"/opt/stack/new/tempest/.tox/full/local/lib/python2.7/site-packages/tempest_lib/common/ssh.py\", line 87, in _get_ssh_connection\n2015-06-26 23:49:24.800 |         password=self.password)\n2015-06-26 23:49:24.800 |     tempest_lib.exceptions.SSHTimeout: Connection to the 172.24.5.1 via SSH timed out.\n2015-06-26 23:49:24.800 |     User: cirros, Password: None\n\nThis is a job with nova-network and in tracing through the calls we definitely need some more debug logging in this path to see that we have security groups associated with the instance to refresh the sg rules.\n\nnw_info and instance uuid for the instance:\n\n2015-06-26 23:49:24.883 |     === network info ===\n2015-06-26 23:49:24.883 |     if-info: lo,up,127.0.0.1,8,::1\n2015-06-26 23:49:24.883 |     if-info: eth0,up,10.1.0.2,20,fe80::f816:3eff:fefd:78bd\n2015-06-26 23:49:24.883 |     ip-route:default via 10.1.0.1 dev eth0 \n2015-06-26 23:49:24.883 |     ip-route:10.1.0.0/20 dev eth0  src 10.1.0.2 \n2015-06-26 23:49:24.883 |     === datasource: configdrive local ===\n2015-06-26 23:49:24.884 |     instance-id: 7377fb75-089e-4a7f-aa13-42073ca4d981\n2015-06-26 23:49:24.884 |     name: Server 7377fb75-089e-4a7f-aa13-42073ca4d981\n2015-06-26 23:49:24.884 |     availability-zone: test_az-1643222956\n2015-06-26 23:49:24.884 |     local-hostname: server-7377fb75-089e-4a7f-aa13-42073ca4d981.novalocal\n2015-06-26 23:49:24.884 |     launch-index: 0\n\nWe see that the fixed IP is associated with the instance here:\n\nhttp://logs.openstack.org/23/193223/3/check/check-tempest-dsvm-nova-v21-full/5f73178/logs/screen-n-net.txt.gz#_2015-06-26_23_41_39_500\n\nThe request ID is req-3b037057-5783-4160-a320-248eb4f2e724.\n\nWe see it refresh security groups and there are several messages about skipping duplicate iptables rule additions:\n\n2015-06-26 23:41:39.685 DEBUG nova.network.linux_net [req-3b037057-5783-4160-a320-248eb4f2e724 InstanceRunTest-1951055199 InstanceRunTest-702105106] Skipping duplicate iptables rule addition. [0:0] -A nova-network-snat -s 10.1.0.0/20 -d 0.0.0.0/0 -j SNAT --to-source 10.0.4.130 -o br100 already in [[0:0] -A PREROUTING -j nova-network-PREROUTING, [0:0] -A OUTPUT -j nova-network-OUTPUT, [0:0] -A POSTROUTING -j nova-network-POSTROUTING, [0:0] -A POSTROUTING -j nova-postrouting-bottom, [0:0] -A nova-postrouting-bottom -j nova-network-snat, [0:0] -A nova-network-snat -j nova-network-float-snat, [0:0] -A nova-network-PREROUTING -s 0.0.0.0/0 -d 169.254.169.254/32 -p tcp -m tcp --dport 80 -j DNAT --to-destination 10.0.4.130:8775, [0:0] -A nova-network-snat -s 10.1.0.0/20 -d 0.0.0.0/0 -j SNAT --to-source 10.0.4.130 -o br100, [0:0] -A nova-network-POSTROUTING -s 10.1.0.0/20 -d 10.0.4.130/32 -j ACCEPT, [0:0] -A nova-network-POSTROUTING -s 10.1.0.0/20 -d 10.1.0.0/20 -m conntrack ! --ctstate DNAT -j ACCEPT] add_rule /opt/stack/new/nova/nova/network/linux_net.py:285\n\n2015-06-26 23:41:39.685 DEBUG nova.network.linux_net [req-3b037057-5783-4160-a320-248eb4f2e724 InstanceRunTest-1951055199 InstanceRunTest-702105106] Skipping apply due to lack of new rules apply /opt/stack/new/nova/nova/network/linux_net.py:444\n\nI'm sure this is probably a duplicate, maybe of bug 1355573, but that bug is targeted at the test_volume_boot_pattern test and this is a different test - although it's related to volumes so maybe related.", 
    "tags": [
        "boto", 
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1469754", 
    "owner": "None", 
    "id": 1469754, 
    "index": 5625, 
    "created": "2015-06-29 15:02:35.561389+00:00", 
    "title": "tempest.thirdparty.boto.test_ec2_instance_run.InstanceRunTest.test_compute_with_volumes fails with SSHTimeout", 
    "comments": [
        {
            "content": "http://logs.openstack.org/23/193223/3/check/check-tempest-dsvm-nova-v21-full/5f73178/console.html.gz#_2015-06-26_23_49_24_797\n\n2015-06-26 23:49:24.797 | tempest.thirdparty.boto.test_ec2_instance_run.InstanceRunTest.test_compute_with_volumes[id-ab836c29-737b-4101-9fb9-87045eaf89e9]\n2015-06-26 23:49:24.797 | --------------------------------------------------------------------------------------------------------------------------------\n2015-06-26 23:49:24.797 | \n2015-06-26 23:49:24.798 | Captured traceback:\n2015-06-26 23:49:24.798 | ~~~~~~~~~~~~~~~~~~~\n2015-06-26 23:49:24.798 |     Traceback (most recent call last):\n2015-06-26 23:49:24.798 |       File \"tempest/thirdparty/boto/test_ec2_instance_run.py\", line 338, in test_compute_with_volumes\n2015-06-26 23:49:24.798 |         wait.state_wait(_part_state, 'INCREASE')\n2015-06-26 23:49:24.798 |       File \"tempest/thirdparty/boto/utils/wait.py\", line 36, in state_wait\n2015-06-26 23:49:24.798 |         old_status = status = lfunction()\n2015-06-26 23:49:24.799 |       File \"tempest/thirdparty/boto/test_ec2_instance_run.py\", line 330, in _part_state\n2015-06-26 23:49:24.799 |         current = ssh.get_partitions().split('\\n')\n2015-06-26 23:49:24.799 |       File \"tempest/common/utils/linux/remote_client.py\", line 82, in get_partitions\n2015-06-26 23:49:24.799 |         output = self.exec_command(command)\n2015-06-26 23:49:24.799 |       File \"tempest/common/utils/linux/remote_client.py\", line 56, in exec_command\n2015-06-26 23:49:24.799 |         return self.ssh_client.exec_command(cmd)\n2015-06-26 23:49:24.800 |       File \"/opt/stack/new/tempest/.tox/full/local/lib/python2.7/site-packages/tempest_lib/common/ssh.py\", line 111, in exec_command\n2015-06-26 23:49:24.800 |         ssh = self._get_ssh_connection()\n2015-06-26 23:49:24.800 |       File \"/opt/stack/new/tempest/.tox/full/local/lib/python2.7/site-packages/tempest_lib/common/ssh.py\", line 87, in _get_ssh_connection\n2015-06-26 23:49:24.800 |         password=self.password)\n2015-06-26 23:49:24.800 |     tempest_lib.exceptions.SSHTimeout: Connection to the 172.24.5.1 via SSH timed out.\n2015-06-26 23:49:24.800 |     User: cirros, Password: None\n\nThis is a job with nova-network and in tracing through the calls we definitely need some more debug logging in this path to see that we have security groups associated with the instance to refresh the sg rules.\n\nnw_info and instance uuid for the instance:\n\n2015-06-26 23:49:24.883 |     === network info ===\n2015-06-26 23:49:24.883 |     if-info: lo,up,127.0.0.1,8,::1\n2015-06-26 23:49:24.883 |     if-info: eth0,up,10.1.0.2,20,fe80::f816:3eff:fefd:78bd\n2015-06-26 23:49:24.883 |     ip-route:default via 10.1.0.1 dev eth0 \n2015-06-26 23:49:24.883 |     ip-route:10.1.0.0/20 dev eth0  src 10.1.0.2 \n2015-06-26 23:49:24.883 |     === datasource: configdrive local ===\n2015-06-26 23:49:24.884 |     instance-id: 7377fb75-089e-4a7f-aa13-42073ca4d981\n2015-06-26 23:49:24.884 |     name: Server 7377fb75-089e-4a7f-aa13-42073ca4d981\n2015-06-26 23:49:24.884 |     availability-zone: test_az-1643222956\n2015-06-26 23:49:24.884 |     local-hostname: server-7377fb75-089e-4a7f-aa13-42073ca4d981.novalocal\n2015-06-26 23:49:24.884 |     launch-index: 0\n\nWe see that the fixed IP is associated with the instance here:\n\nhttp://logs.openstack.org/23/193223/3/check/check-tempest-dsvm-nova-v21-full/5f73178/logs/screen-n-net.txt.gz#_2015-06-26_23_41_39_500\n\nThe request ID is req-3b037057-5783-4160-a320-248eb4f2e724.\n\nWe see it refresh security groups and there are several messages about skipping duplicate iptables rule additions:\n\n2015-06-26 23:41:39.685 DEBUG nova.network.linux_net [req-3b037057-5783-4160-a320-248eb4f2e724 InstanceRunTest-1951055199 InstanceRunTest-702105106] Skipping duplicate iptables rule addition. [0:0] -A nova-network-snat -s 10.1.0.0/20 -d 0.0.0.0/0 -j SNAT --to-source 10.0.4.130 -o br100 already in [[0:0] -A PREROUTING -j nova-network-PREROUTING, [0:0] -A OUTPUT -j nova-network-OUTPUT, [0:0] -A POSTROUTING -j nova-network-POSTROUTING, [0:0] -A POSTROUTING -j nova-postrouting-bottom, [0:0] -A nova-postrouting-bottom -j nova-network-snat, [0:0] -A nova-network-snat -j nova-network-float-snat, [0:0] -A nova-network-PREROUTING -s 0.0.0.0/0 -d 169.254.169.254/32 -p tcp -m tcp --dport 80 -j DNAT --to-destination 10.0.4.130:8775, [0:0] -A nova-network-snat -s 10.1.0.0/20 -d 0.0.0.0/0 -j SNAT --to-source 10.0.4.130 -o br100, [0:0] -A nova-network-POSTROUTING -s 10.1.0.0/20 -d 10.0.4.130/32 -j ACCEPT, [0:0] -A nova-network-POSTROUTING -s 10.1.0.0/20 -d 10.1.0.0/20 -m conntrack ! --ctstate DNAT -j ACCEPT] add_rule /opt/stack/new/nova/nova/network/linux_net.py:285\n\n2015-06-26 23:41:39.685 DEBUG nova.network.linux_net [req-3b037057-5783-4160-a320-248eb4f2e724 InstanceRunTest-1951055199 InstanceRunTest-702105106] Skipping apply due to lack of new rules apply /opt/stack/new/nova/nova/network/linux_net.py:444\n\nI'm sure this is probably a duplicate, maybe of bug 1355573, but that bug is targeted at the test_volume_boot_pattern test and this is a different test - although it's related to volumes so maybe related.", 
            "date_created": "2015-06-29 15:02:35.561389+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "In the n-cpu logs this is where the firewall rules are getting refreshed during spawn:\n\nhttp://logs.openstack.org/23/193223/3/check/check-tempest-dsvm-nova-v21-full/5f73178/logs/screen-n-cpu.txt.gz#_2015-06-26_23_41_42_951\n\n2015-06-26 23:41:42.951 DEBUG nova.virt.firewall [req-3b037057-5783-4160-a320-248eb4f2e724 InstanceRunTest-1951055199 InstanceRunTest-702105106] [instance: 7377fb75-089e-4a7f-aa13-42073ca4d981] Security Groups SecurityGroupList(objects=[SecurityGroup(98)]) translated to ipv4: ['-m state --state INVALID -j DROP', '-m state --state ESTABLISHED,RELATED -j ACCEPT', '-j $provider', u'-s 10.1.0.1 -p udp --sport 67 --dport 68 -j ACCEPT', u'-s 10.1.0.0/20 -j ACCEPT', u'-j ACCEPT -p icmp -s 0.0.0.0/0', u'-j ACCEPT -p tcp --dport 22 -s 0.0.0.0/0', '-j $sg-fallback'], ipv6: ['-m state --state INVALID -j DROP', '-m state --state ESTABLISHED,RELATED -j ACCEPT', '-j $provider', '-j $sg-fallback'] instance_rules /opt/stack/new/nova/nova/virt/firewall.py:419\n\n2015-06-26 23:41:42.952 DEBUG nova.virt.firewall [req-3b037057-5783-4160-a320-248eb4f2e724 InstanceRunTest-1951055199 InstanceRunTest-702105106] [instance: 7377fb75-089e-4a7f-aa13-42073ca4d981] Filters added to instance: 96 prepare_instance_filter /opt/stack/new/nova/nova/virt/firewall.py:182", 
            "date_created": "2015-06-29 15:24:11.087369+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This should actually not a duplicate of bug 1355573 since the volume attach stuff in the boto tests is going through the boto client, not cinder.\n\nFrom the tempest console logs, we see that we're able to successfully write some text to the console and then list the partitions, and attach a volume to the instance but after that when we try to list the partitions again it fails due to the ssh timeout:\n\n2015-06-26 23:49:24.886 |     2015-06-26 23:42:06,825 4131 DEBUG    [tempest.common.utils.linux.remote_client] Remote command: set -eu -o pipefail; PATH=$PATH:/sbin; cat /proc/partitions\n2015-06-26 23:49:24.886 |     2015-06-26 23:42:06,825 4131 INFO     [tempest_lib.common.ssh] Creating ssh connection to '172.24.5.1' as 'cirros' with public key authentication\n2015-06-26 23:49:24.886 |     2015-06-26 23:42:06,831 4131 INFO     [paramiko.transport] Connected (version 2.0, client dropbear_2012.55)\n2015-06-26 23:49:24.886 |     2015-06-26 23:42:07,801 4131 INFO     [paramiko.transport] Authentication (publickey) successful!\n2015-06-26 23:49:24.887 |     2015-06-26 23:42:07,802 4131 INFO     [tempest_lib.common.ssh] ssh connection to cirros@172.24.5.1 successfuly created\n2015-06-26 23:49:24.887 |     2015-06-26 23:42:09,910 4131 DEBUG    [tempest.thirdparty.boto.test_ec2_instance_run] Volume vol-00000004 is in status: in-use, attach_status: attaching\n2015-06-26 23:49:24.887 |     2015-06-26 23:42:11,691 4131 DEBUG    [tempest.thirdparty.boto.test_ec2_instance_run] Volume vol-00000004 is in status: in-use, attach_status: attaching\n2015-06-26 23:49:24.887 |     2015-06-26 23:42:13,431 4131 DEBUG    [tempest.thirdparty.boto.test_ec2_instance_run] Volume vol-00000004 is in status: in-use, attach_status: attaching\n2015-06-26 23:49:24.887 |     2015-06-26 23:42:15,273 4131 DEBUG    [tempest.thirdparty.boto.test_ec2_instance_run] Volume vol-00000004 is in status: in-use, attach_status: attached\n2015-06-26 23:49:24.887 |     2015-06-26 23:42:15,274 4131 INFO     [tempest.thirdparty.boto.utils.wait] Pattern \"in-use\" found in 6 second in \"in-use\"\n2015-06-26 23:49:24.887 |     2015-06-26 23:42:15,274 4131 DEBUG    [tempest.common.utils.linux.remote_client] Remote command: set -eu -o pipefail; PATH=$PATH:/sbin; cat /proc/partitions\n2015-06-26 23:49:24.888 |     2015-06-26 23:42:15,274 4131 INFO     [tempest_lib.common.ssh] Creating ssh connection to '172.24.5.1' as 'cirros' with public key authentication\n2015-06-26 23:49:24.888 |     2015-06-26 23:43:15,318 4131 WARNING  [tempest_lib.common.ssh] Failed to establish authenticated ssh connection to cirros@172.24.5.1 (timed out). Number attempts: 1. Retry after 2 seconds.\n\n", 
            "date_created": "2015-06-29 16:30:54.551565+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "In the n-api code, I see the instance go to 'running' state here:\n\nhttp://logs.openstack.org/23/193223/3/check/check-tempest-dsvm-nova-v21-full/5f73178/logs/screen-n-api.txt.gz#_2015-06-26_23_41_45_799\n\nThe instance info cache (nw_info) is updated here, 4 seconds later:\n\nhttp://logs.openstack.org/23/193223/3/check/check-tempest-dsvm-nova-v21-full/5f73178/logs/screen-n-api.txt.gz#_2015-06-26_23_41_49_644\n\n2015-06-26 23:41:49.644 DEBUG nova.network.base_api [req-3fb5d665-95ce-4b00-bf35-24ff34649588 InstanceRunTest-1951055199 InstanceRunTest-702105106] [instance: 7377fb75-089e-4a7f-aa13-42073ca4d981] Updating instance_info_cache with network_info: [VIF({'profile': None, 'ovs_interfaceid': None, 'preserve_on_delete': False, 'network': Network({'bridge': u'br100', 'subnets': [Subnet({'ips': [FixedIP({'meta': {}, 'version': 4, 'type': u'fixed', 'floating_ips': [IP({'meta': {}, 'version': 4, 'type': u'floating', 'address': u'172.24.5.1'})], 'address': u'10.1.0.2'})], 'version': 4, 'meta': {u'dhcp_server': u'10.1.0.1'}, 'dns': [IP({'meta': {}, 'version': 4, 'type': u'dns', 'address': u'8.8.4.4'})], 'routes': [], 'cidr': u'10.1.0.0/20', 'gateway': IP({'meta': {}, 'version': 4, 'type': u'gateway', 'address': u'10.1.0.1'})}), Subnet({'ips': [], 'version': None, 'meta': {u'dhcp_server': None}, 'dns': [], 'routes': [], 'cidr': None, 'gateway': IP({'meta': {}, 'version': None, 'type': u'gateway', 'address': None})})], 'meta': {u'tenant_id': None, u'should_create_bridge': True, u'bridge_interface': u'eth0'}, 'id': u'6ac4482b-6d94-4c2d-8ffc-916b86703518', 'label': u'private'}), 'devname': None, 'vnic_type': u'normal', 'qbh_params': None, 'meta': {}, 'details': {}, 'address': u'fa:16:3e:fd:78:bd', 'active': False, 'type': u'bridge', 'id': u'dd2614b5-7e2a-44f1-84db-b215f2dfd586', 'qbg_params': None})] update_instance_cache_with_nw_info /opt/stack/new/nova/nova/network/base_api.py:43\n\nHere is where the volume is attached:\n\nhttp://logs.openstack.org/23/193223/3/check/check-tempest-dsvm-nova-v21-full/5f73178/logs/screen-n-api.txt.gz#_2015-06-26_23_42_15_272\n\nAfter that I lose track of the instance and it looks like a new instance is being created with the same information, which is really odd.", 
            "date_created": "2015-06-29 16:49:01.805106+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Apparently this doesn't happen very often:\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJtZXNzYWdlOlwiX3BhcnRfc3RhdGVcIiBBTkQgdGFnczpcImNvbnNvbGVcIiIsImZpZWxkcyI6W10sIm9mZnNldCI6MCwidGltZWZyYW1lIjoiNjA0ODAwIiwiZ3JhcGhtb2RlIjoiY291bnQiLCJ0aW1lIjp7InVzZXJfaW50ZXJ2YWwiOjB9LCJzdGFtcCI6MTQzNTU5NzMzNjYyNH0=", 
            "date_created": "2015-06-29 17:05:12.915335+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }
    ]
}