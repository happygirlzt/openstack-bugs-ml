{
    "status": "Invalid", 
    "last_updated": "2015-02-15 23:33:15.558950+00:00", 
    "description": "When attaching volumes to instances, if the volume attachment fails, it is still noted as successful by the system in some cases.\nThis is the information reflected when requesting the details of a servers volume attachments\nhttp://developer.openstack.org/api-ref-compute-v2-ext.html\n/v2/\u200b{tenant_id}\u200b/servers/\u200b{server_id}\u200b/os-volume_attachments\nShow volume attachment details\n\nIn the example, I have 2 test servers and 1 test volume.\nI attach the volume to test_server1 and it is successful (though please see: https://bugs.launchpad.net/cinder/+bug/1398583)\nNext, I try to attach the same volume to test_server2.\nThis call fails as expected, but the mountpoint / attachment is still registered.\n\nTo demonstrate, I repeat the previous call.  It fails again, but this time due to the requested mountpoint being in-use vs. the volume being attached.\n\nI next make a call to list the volume attachments for test_server2.  It lists volume attachments even though there are none and the Cinder api server does not register this.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1398588", 
    "owner": "None", 
    "id": 1398588, 
    "index": 5302, 
    "created": "2014-12-02 21:58:17.481688+00:00", 
    "title": "volume_attach action registers volume attachment even on failure", 
    "comments": [
        {
            "content": "When attaching volumes to instances, if the volume attachment fails, it is still noted as successful by the system in some cases.\nThis is the information reflected when requesting the details of a specific volume attachment:\nhttp://developer.openstack.org/api-ref-compute-v2-ext.html\n/v2/\u200b{tenant_id}\u200b/servers/\u200b{server_id}\u200b/os-volume_attachments/\u200b{attachment_id}\u200b\nShow volume attachment details\n\nShows details for the specified volume attachment. \n\nIn the example, I have 2 test servers and 1 test volume.\nI attach the volume to test_server1 and it is successful (though please see: https://bugs.launchpad.net/cinder/+bug/1398583)\nNext, I try to attach the same volume to test_server2.\nThis call fails as expected, but the mountpoint / attachment is still registered.\n\nTo demonstrate, I repeat the previous call.  It fails again, but this time due to the requested mountpoint being in-use vs. the volume being attached.\n\nI next make a call to list the volume attachments for test_server2.  It lists volume attachments even though there are none and the Cinder api server does not register this.", 
            "date_created": "2014-12-02 21:58:17.481688+00:00", 
            "author": "https://api.launchpad.net/1.0/~patrick-crews"
        }, 
        {
            "content": "# Listing our test servers\n nova --os-auth-url=http://192.168.0.5:5000/v2.0 list\n+--------------------------------------+--------------+--------+------------+-------------+------------------+\n| ID                                   | Name         | Status | Task State | Power State | Networks         |\n+--------------------------------------+--------------+--------+------------+-------------+------------------+\n| 9991ead8-8a88-45c3-83d0-a2ac5e7fb232 | test_server1 | ACTIVE | -          | Running     | private=10.0.0.2 |\n| 44d13e4b-a218-46b8-a714-c96e9cff2066 | test_server2 | ACTIVE | -          | Running     | private=10.0.0.3 |\n+--------------------------------------+--------------+--------+------------+-------------+------------------+\n\n# Listing our test volume\npcrews@erlking-dev:~/git/rannsaka$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+----------+-------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable | Attached to |\n+--------------------------------------+-----------+--------------+------+-------------+----------+-------------+\n| 41dcbd0b-ac6b-477e-84f9-bbe62da29a6a | available | test_volume1 |  1   | lvmdriver-1 |  false   |             |\n+--------------------------------------+-----------+--------------+------+-------------+----------+-------------+\n\n# Attaching volume to test_server1 on /dev/vdc\npcrews@erlking-dev:~/git/rannsaka$ nova --os-auth-url=http://192.168.0.5:5000/v2.0 volume-attach 9991ead8-8a88-45c3-83d0-a2ac5e7fb232 41dcbd0b-ac6b-477e-84f9-bbe62da29a6a /dev/vdc\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdc                             |\n| id       | 41dcbd0b-ac6b-477e-84f9-bbe62da29a6a |\n| serverId | 9991ead8-8a88-45c3-83d0-a2ac5e7fb232 |\n| volumeId | 41dcbd0b-ac6b-477e-84f9-bbe62da29a6a |\n+----------+--------------------------------------+\n\n# Attaching same volume to test_server2 on /dev/vdb\npcrews@erlking-dev:~/git/rannsaka$ nova --os-auth-url=http://192.168.0.5:5000/v2.0 volume-attach 44d13e4b-a218-46b8-a714-c96e9cff2066 41dcbd0b-ac6b-477e-84f9-bbe62da29a6a /dev/vdb\nERROR (BadRequest): Invalid volume: status must be 'available' (HTTP 400) (Request-ID: req-0eed3b96-e920-425d-9c7a-e1b6b78b3eea)\n\n# Second request repeating the previous one - NOTE the device path is now in-use:\npcrews@erlking-dev:~/git/rannsaka$ nova --os-auth-url=http://192.168.0.5:5000/v2.0 volume-attach 44d13e4b-a218-46b8-a714-c96e9cff2066 41dcbd0b-ac6b-477e-84f9-bbe62da29a6a /dev/vdb\nERROR (Conflict): The supplied device path (/dev/vdb) is in use. (HTTP 409) (Request-ID: req-708dcc24-5fa8-4f3d-8880-ea399aecbfd1)\n\n# Making a curl call to get detail volume attachments for test_server2 to demonstrate that the system now considers the volume to be mounted, even though cinder does not track the same information\npcrews@erlking-dev:~/git/rannsaka$ curl -i 'http://192.168.0.5:8774/v2/c8d54cca25a9496ab264be0c2d96e567/servers/44d13e4b-a218-46b8-a714-c96e9cff2066/os-volume_attachments' -X GET -H \"Accept: application/json\" -H \"User-Agent: python-novaclient\" -H \"X-Auth-Project-Id: d\" -H \"X-Auth-Token: NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN\"\nHTTP/1.1 200 OK\nContent-Type: application/json\nContent-Length: 197\nX-Compute-Request-Id: req-69d8fc33-35c1-4b93-ba05-9b48b7b602e0\nDate: Tue, 02 Dec 2014 21:49:15 GMT\n\n{\"volumeAttachments\": [{\"device\": \"/dev/vdb\", \"serverId\": \"44d13e4b-a218-46b8-a714-c96e9cff2066\", \"id\": \"41dcbd0b-ac6b-477e-84f9-bbe62da29a6a\", \"volumeId\": \"41dcbd0b-ac6b-477e-84f9-bbe62da29a6a\"}]}\n\n# cinder list to show that the system notes the volume is attached to test_server1 and not test_server2\npcrews@erlking-dev:~/git/rannsaka$ cinder list\n+--------------------------------------+--------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  | Status | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+--------+--------------+------+-------------+----------+--------------------------------------+\n| 41dcbd0b-ac6b-477e-84f9-bbe62da29a6a | in-use | test_volume1 |  1   | lvmdriver-1 |  false   | 9991ead8-8a88-45c3-83d0-a2ac5e7fb232 |\n+--------------------------------------+--------+--------------+------+-------------+----------+--------------------------------------+\n", 
            "date_created": "2014-12-02 21:58:25.154033+00:00", 
            "author": "https://api.launchpad.net/1.0/~patrick-crews"
        }, 
        {
            "content": "hi , could you please let me know which version are you using? I am having a env setup about 1 month before \nI tried but can't reproduce the issue you are having \n\n\n+--------------------------------------+---------+---------+------------+-------------+-------------------+\n| ID                                   | Name    | Status  | Task State | Power State | Networks          |\n+--------------------------------------+---------+---------+------------+-------------+-------------------+\n| 7a2242e6-95f6-481c-927c-c944d9b7e02c | j5      | ACTIVE  | -          | Shutdown    | private=10.0.0.14 |\n| 36d101fd-6f43-4ad6-840f-e1208c0dfc7c | jichen4 | ACTIVE  | -          | Running     | private=10.0.0.13 |\n+--------------------------------------+---------+---------+------------+-------------+-------------------+\n\n\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n| 33327b41-7f89-4c33-a80d-4fd345bf8901 | available | None |  1   | lvmdriver-1 |  false   |                                      |\n\n\n\n[jichen@compute1 ~]$ nova volume-attach 7a2242e6-95f6-481c-927c-c944d9b7e02c 33327b41-7f89-4c33-a80d-4fd345bf8901 /dev/vdc\nERROR (Conflict): The supplied device path (/dev/vdc) is in use. (HTTP 409) (Request-ID: req-6cbd65d8-90fa-4dd7-a410-a0d8ee805a22)\n[jichen@compute1 ~]$ nova volume-attach 7a2242e6-95f6-481c-927c-c944d9b7e02c 33327b41-7f89-4c33-a80d-4fd345bf8901 /dev/vdd\nERROR (BadRequest): Invalid volume: status must be 'available' (HTTP 400) (Request-ID: req-95482b33-51d6-4bc3-9479-c8825b047ed9)\n[jichen@compute1 ~]$ nova volume-attach 7a2242e6-95f6-481c-927c-c944d9b7e02c 33327b41-7f89-4c33-a80d-4fd345bf8901 /dev/vdd\nERROR (BadRequest): Invalid volume: status must be 'available' (HTTP 400) (Request-ID: req-369dccca-ecb3-4dc6-84e7-a10a6292f909)", 
            "date_created": "2014-12-23 07:02:04.443776+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "I would say that you did hit the bug otherwise how do you explain this output:\n[jichen@compute1 ~]$ nova volume-attach 7a2242e6-95f6-481c-927c-c944d9b7e02c 33327b41-7f89-4c33-a80d-4fd345bf8901 /dev/vdc\nERROR (Conflict): The supplied device path (/dev/vdc) is in use. (HTTP 409) (Request-ID: req-6cbd65d8-90fa-4dd7-a410-a0d8ee805a22)\n[jichen@compute1 ~]$ nova volume-attach 7a2242e6-95f6-481c-927c-c944d9b7e02c 33327b41-7f89-4c33-a80d-4fd345bf8901 /dev/vdd\nERROR (BadRequest): Invalid volume: status must be 'available' (HTTP 400) (Request-ID: req-95482b33-51d6-4bc3-9479-c8825b047ed9)\n\nThe first request failed, the second request failed due to the volume not being 'available', yet how did the volume become unavailable on a failed attach request?\n\nAdditionally, you should list the volume attachments for the server with id: 7a2242e6-95f6-481c-927c-c944d9b7e02c.  The issue is that while Cinder does not register the volume attachment, the volume is still listed in the output from this call:\nhttp://developer.openstack.org/api-ref-compute-v2-ext.html\n/v2/\u200b{tenant_id}\u200b/servers/\u200b{server_id}\u200b/os-volume_attachments\nList volume attachments\n\nLists the volume attachments for a specified server. ", 
            "date_created": "2014-12-23 16:27:47.406441+00:00", 
            "author": "https://api.launchpad.net/1.0/~patrick-crews"
        }, 
        {
            "content": "Reporter didn't provide a version. Using the latest from master, I was not able to reproduce this issue (see below). Since the reporter mentioned that Cinder does not know about this false attachment, but Nova does, I would bet something is being set on the Nova side.\n\nubuntu@mount-issue:~/devstack$ nova list\nc+--------------------------------------+---------+--------+------------+-------------+------------------+\n| ID                                   | Name    | Status | Task State | Power State | Networks         |\n+--------------------------------------+---------+--------+------------+-------------+------------------+\n| 57304c45-101d-4ce0-8f4b-6b7ad853d135 | server1 | ACTIVE | -          | Running     | private=10.0.0.2 |\n| 1cb270bd-2131-42fa-9f99-ed95cd077cde | server2 | ACTIVE | -          | Running     | private=10.0.0.3 |\n+--------------------------------------+---------+--------+------------+-------------+------------------+\niubuntu@mount-issue:~/devstack$ cinder list\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable | Attached to |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+\n| 2a57f161-0828-4b68-8f93-cd4493ff725b | available | None |  1   | lvmdriver-1 |  false   |             |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+\nubuntu@mount-issue:~/devstack$ nova volume-attach server1 2a57f161-0828-4b68-8f93-cd4493ff725b\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdb                             |\n| id       | 2a57f161-0828-4b68-8f93-cd4493ff725b |\n| serverId | 57304c45-101d-4ce0-8f4b-6b7ad853d135 |\n| volumeId | 2a57f161-0828-4b68-8f93-cd4493ff725b |\n+----------+--------------------------------------+\nubuntu@mount-issue:~/devstack$ nova volume-attach server2 2a57f161-0828-4b68-8f93-cd4493ff725b\nERROR (BadRequest): Invalid volume: volume '2a57f161-0828-4b68-8f93-cd4493ff725b' status must be 'available'. Currently in 'in-use' (HTTP 400) (Request-ID: req-bfa40f00-56f9-4535-a4d1-23a8cb69b908)\nubuntu@mount-issue:~/devstack$ nova volume-attach server2 2a57f161-0828-4b68-8f93-cd4493ff725b\nERROR (BadRequest): Invalid volume: volume '2a57f161-0828-4b68-8f93-cd4493ff725b' status must be 'available'. Currently in 'in-use' (HTTP 400) (Request-ID: req-83736950-ff20-4d93-b512-ab7ffc25c7bc)\nubuntu@mount-issue:~/devstack$ cinder list\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n|                  ID                  | Status | Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n| 2a57f161-0828-4b68-8f93-cd4493ff725b | in-use | None |  1   | lvmdriver-1 |  false   | 57304c45-101d-4ce0-8f4b-6b7ad853d135 |\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\nubuntu@mount-issue:~/devstack$ http http://localhost:8774/v2/b9903b32e6e94a5ab2ee40e217be0fab/servers/1cb270bd-2131-42fa-9f99-ed95cd077cde/os-volume_attachments X-Auth-Token:'e08bc40fd5f148cf817f99c1133da8aa'\nHTTP/1.1 200 OK\nContent-Length: 25\nContent-Type: application/json\nDate: Fri, 02 Jan 2015 18:37:27 GMT\nX-Compute-Request-Id: req-5d213be2-60af-450a-b521-8f979d5a80e6\n\n{\n    \"volumeAttachments\": []\n}", 
            "date_created": "2015-01-02 18:45:46.478460+00:00", 
            "author": "https://api.launchpad.net/1.0/~thingee"
        }, 
        {
            "content": "Can confirm that this can no longer be triggered with the latest from master.\nAlso, ++ on the notion that this is tied to nova vs. cinder, I simply filed it under Cinder in haste.", 
            "date_created": "2015-01-06 17:25:03.593560+00:00", 
            "author": "https://api.launchpad.net/1.0/~patrick-crews"
        }, 
        {
            "content": "Sorry, can someone please explain what is broken or needs to be fixed on the Nova side?", 
            "date_created": "2015-02-01 01:49:55.782826+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "As previously noted, I was unable to duplicate this with the latest cinder / nova / etc the last time I tested for this.\nWill attempt to re-test next week, but I suspect this is no longer an issue.", 
            "date_created": "2015-02-01 02:00:57.254815+00:00", 
            "author": "https://api.launchpad.net/1.0/~patrick-crews"
        }, 
        {
            "content": "Closing (its two weeks later and Patrick hasn't reported reproduction). Please re-open if it is in fact still an issue.", 
            "date_created": "2015-02-15 23:32:47.965840+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }
    ]
}