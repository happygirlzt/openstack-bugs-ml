{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:47:31.343679+00:00", 
    "description": "On havana master, running with this setup:\n\n[root@ngp02-hv1 ~]# nova host-list\n+-----------------------------+-------------+----------+\n| host_name                   | service     | zone     |\n+-----------------------------+-------------+----------+\n| CN10                        | compute     | nova     |\n| cn12                        | compute     | nova     |\n| cn4                         | compute     | nova     |\n| cn6                         | compute     | nova     |\n| cn8                         | compute     | nova     |\n| ngp02-hv1.private.cloud.com | cells       | internal |\n| ngp02-hv1.private.cloud.com | cert        | internal |\n| ngp02-hv1.private.cloud.com | compute     | nova     |\n| ngp02-hv1.private.cloud.com | conductor   | internal |\n| ngp02-hv1.private.cloud.com | console     | internal |\n| ngp02-hv1.private.cloud.com | consoleauth | internal |\n| ngp02-hv1.private.cloud.com | scheduler   | internal |\n+-----------------------------+-------------+----------+\n\nThe compute nodes are all running the hyper-v driver.\n\n1. Boot an instance to CN10:\n\nnova boot --image quantal-server-cloudimg-amd64-disk1 --flavor 2 --availability-zone nova:CN10 --user-data /home/testscripts/myuserdata.txt --config-drive true Ivt_July2_9\n\n2. Then stop it:\n\n[root@ngp02-hv1 testscripts]# nova stop Ivt_July2_9\n[root@ngp02-hv1 testscripts]# nova show Ivt_July2_9\n+-------------------------------------+----------------------------------------------------------------------------+\n| Property                            | Value                                                                      |\n+-------------------------------------+----------------------------------------------------------------------------+\n| status                              | SHUTOFF                                                                    |\n| updated                             | 2013-07-02T17:21:36Z                                                       |\n| OS-EXT-STS:task_state               | None                                                                       |\n| OS-EXT-SRV-ATTR:host                | CN10                                                                       |\n| key_name                            | None                                                                       |\n| image                               | quantal-server-cloudimg-amd64-disk1 (8495ff12-ee3c-4fe4-b46b-7b3b10641c87) |\n| network1 network                    | 10.0.1.49                                                                  |\n| hostId                              | 114d3be3249df7d93321ac50d4672be322989685e6f99d4cd8f87fb1                   |\n| OS-EXT-STS:vm_state                 | stopped                                                                    |\n| OS-EXT-SRV-ATTR:instance_name       | instance-00000090                                                          |\n| OS-SRV-USG:launched_at              | 2013-07-02T16:59:30.310000                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | CN10                                                                       |\n| flavor                              | m1.small (2)                                                               |\n| id                                  | 6c9a28c8-c52c-4046-ad83-00e12ee0994d                                       |\n| security_groups                     | [{u'name': u'default'}]                                                    |\n| OS-SRV-USG:terminated_at            | None                                                                       |\n| user_id                             | b25a17a8fcfa44098e45e0cfe5ae4fee                                           |\n| name                                | Ivt_July2_9                                                                |\n| created                             | 2013-07-02T16:59:00Z                                                       |\n| tenant_id                           | 066c47e2d09b440aad1845fcea9959ba                                           |\n| OS-DCF:diskConfig                   | MANUAL                                                                     |\n| metadata                            | {}                                                                         |\n| accessIPv4                          |                                                                            |\n| accessIPv6                          |                                                                            |\n| OS-EXT-STS:power_state              | 4                                                                          |\n| OS-EXT-AZ:availability_zone         | nova                                                                       |\n| config_drive                        | 1                                                                          |\n+-------------------------------------+----------------------------------------------------------------------------+\n\n3. Then migrate it (moves from CN10 to cn4):\n\n[root@ngp02-hv1 testscripts]# nova migrate Ivt_July2_9\n[root@ngp02-hv1 testscripts]# nova show Ivt_July2_9\n[root@ngp02-hv1 testscripts]# nova show Ivt_July2_9\n+-------------------------------------+----------------------------------------------------------------------------+\n| Property                            | Value                                                                      |\n+-------------------------------------+----------------------------------------------------------------------------+\n| status                              | VERIFY_RESIZE                                                              |\n| updated                             | 2013-07-02T17:22:27Z                                                       |\n| OS-EXT-STS:task_state               | None                                                                       |\n| OS-EXT-SRV-ATTR:host                | cn4                                                                        |\n| key_name                            | None                                                                       |\n| image                               | quantal-server-cloudimg-amd64-disk1 (8495ff12-ee3c-4fe4-b46b-7b3b10641c87) |\n| network1 network                    | 10.0.1.49                                                                  |\n| hostId                              | aec601f205a7665ea600c0fed93cf50e9bb779c2d7625e4f7da23944                   |\n| OS-EXT-STS:vm_state                 | resized                                                                    |\n| OS-EXT-SRV-ATTR:instance_name       | instance-00000090                                                          |\n| OS-SRV-USG:launched_at              | 2013-07-02T17:22:34.143000                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | cn4                                                                        |\n| flavor                              | m1.small (2)                                                               |\n| id                                  | 6c9a28c8-c52c-4046-ad83-00e12ee0994d                                       |\n| security_groups                     | [{u'name': u'default'}]                                                    |\n| OS-SRV-USG:terminated_at            | None                                                                       |\n| user_id                             | b25a17a8fcfa44098e45e0cfe5ae4fee                                           |\n| name                                | Ivt_July2_9                                                                |\n| created                             | 2013-07-02T16:59:00Z                                                       |\n| tenant_id                           | 066c47e2d09b440aad1845fcea9959ba                                           |\n| OS-DCF:diskConfig                   | MANUAL                                                                     |\n| metadata                            | {}                                                                         |\n| accessIPv4                          |                                                                            |\n| accessIPv6                          |                                                                            |\n| progress                            | 0                                                                          |\n| OS-EXT-STS:power_state              | 4                                                                          |\n| OS-EXT-AZ:availability_zone         | nova                                                                       |\n| config_drive                        | 1                                                                          |\n+-------------------------------------+----------------------------------------------------------------------------+\n\n4. Then confirm the migration.  This is where the problem happens - the vm_state goes to ACTIVE even though the power_state is 4 (SHUTOFF):\n\n[root@ngp02-hv1 testscripts]# nova show Ivt_July2_9\n+-------------------------------------+----------------------------------------------------------------------------+\n| Property                            | Value                                                                      |\n+-------------------------------------+----------------------------------------------------------------------------+\n| status                              | ACTIVE                                                                     |\n| updated                             | 2013-07-02T17:23:03Z                                                       |\n| OS-EXT-STS:task_state               | None                                                                       |\n| OS-EXT-SRV-ATTR:host                | cn4                                                                        |\n| key_name                            | None                                                                       |\n| image                               | quantal-server-cloudimg-amd64-disk1 (8495ff12-ee3c-4fe4-b46b-7b3b10641c87) |\n| network1 network                    | 10.0.1.49                                                                  |\n| hostId                              | aec601f205a7665ea600c0fed93cf50e9bb779c2d7625e4f7da23944                   |\n| OS-EXT-STS:vm_state                 | active                                                                     |\n| OS-EXT-SRV-ATTR:instance_name       | instance-00000090                                                          |\n| OS-SRV-USG:launched_at              | 2013-07-02T17:22:34.143000                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | cn4                                                                        |\n| flavor                              | m1.small (2)                                                               |\n| id                                  | 6c9a28c8-c52c-4046-ad83-00e12ee0994d                                       |\n| security_groups                     | [{u'name': u'default'}]                                                    |\n| OS-SRV-USG:terminated_at            | None                                                                       |\n| user_id                             | b25a17a8fcfa44098e45e0cfe5ae4fee                                           |\n| name                                | Ivt_July2_9                                                                |\n| created                             | 2013-07-02T16:59:00Z                                                       |\n| tenant_id                           | 066c47e2d09b440aad1845fcea9959ba                                           |\n| OS-DCF:diskConfig                   | MANUAL                                                                     |\n| metadata                            | {}                                                                         |\n| accessIPv4                          |                                                                            |\n| accessIPv6                          |                                                                            |\n| progress                            | 0                                                                          |\n| OS-EXT-STS:power_state              | 4                                                                          |\n| OS-EXT-AZ:availability_zone         | nova                                                                       |\n| config_drive                        | 1                                                                          |\n+-------------------------------------+----------------------------------------------------------------------------+\n\nI checked the compute logs for CN10 and cn4 and on the source host CN10 I found an exception for an InstanceNotFound coming from the nova.virt.hyperv.vmops.get_info method (which is actually detailed in bug 1197506).\n\nFor some history here, change I19fa61d467edd5a7572040d084824972569ef65a fixed bug 1177811 where a user could resize/migrate an instance from a stopped state and it would go back to ACTIVE state after the resize/migrate was confirmed/rejected.  As part of that change, we check the power_state when confirming the migration/resize to see if the user powered on the instance to confirm the resize (if they had resized/migrated from stopped state):\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L2300\n\nNow for this bug, it looks like if the instance was migrated, when we check the power_state on the instance, the old host is being asked to get the state but the instance has migrated and we get the InstanceNotFound (which is swallowed here):\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L698", 
    "tags": [
        "compute"
    ], 
    "importance": "High", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1197514", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1197514, 
    "index": 1150, 
    "created": "2013-07-03 19:36:39.506877+00:00", 
    "title": "migrate from stopped goes back to ACTIVE state after resize-confirm", 
    "comments": [
        {
            "content": "On havana master, running with this setup:\n\n[root@ngp02-hv1 ~]# nova host-list\n+-----------------------------+-------------+----------+\n| host_name                   | service     | zone     |\n+-----------------------------+-------------+----------+\n| CN10                        | compute     | nova     |\n| cn12                        | compute     | nova     |\n| cn4                         | compute     | nova     |\n| cn6                         | compute     | nova     |\n| cn8                         | compute     | nova     |\n| ngp02-hv1.private.cloud.com | cells       | internal |\n| ngp02-hv1.private.cloud.com | cert        | internal |\n| ngp02-hv1.private.cloud.com | compute     | nova     |\n| ngp02-hv1.private.cloud.com | conductor   | internal |\n| ngp02-hv1.private.cloud.com | console     | internal |\n| ngp02-hv1.private.cloud.com | consoleauth | internal |\n| ngp02-hv1.private.cloud.com | scheduler   | internal |\n+-----------------------------+-------------+----------+\n\nThe compute nodes are all running the hyper-v driver.\n\n1. Boot an instance to CN10:\n\nnova boot --image quantal-server-cloudimg-amd64-disk1 --flavor 2 --availability-zone nova:CN10 --user-data /home/testscripts/myuserdata.txt --config-drive true Ivt_July2_9\n\n2. Then stop it:\n\n[root@ngp02-hv1 testscripts]# nova stop Ivt_July2_9\n[root@ngp02-hv1 testscripts]# nova show Ivt_July2_9\n+-------------------------------------+----------------------------------------------------------------------------+\n| Property                            | Value                                                                      |\n+-------------------------------------+----------------------------------------------------------------------------+\n| status                              | SHUTOFF                                                                    |\n| updated                             | 2013-07-02T17:21:36Z                                                       |\n| OS-EXT-STS:task_state               | None                                                                       |\n| OS-EXT-SRV-ATTR:host                | CN10                                                                       |\n| key_name                            | None                                                                       |\n| image                               | quantal-server-cloudimg-amd64-disk1 (8495ff12-ee3c-4fe4-b46b-7b3b10641c87) |\n| network1 network                    | 10.0.1.49                                                                  |\n| hostId                              | 114d3be3249df7d93321ac50d4672be322989685e6f99d4cd8f87fb1                   |\n| OS-EXT-STS:vm_state                 | stopped                                                                    |\n| OS-EXT-SRV-ATTR:instance_name       | instance-00000090                                                          |\n| OS-SRV-USG:launched_at              | 2013-07-02T16:59:30.310000                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | CN10                                                                       |\n| flavor                              | m1.small (2)                                                               |\n| id                                  | 6c9a28c8-c52c-4046-ad83-00e12ee0994d                                       |\n| security_groups                     | [{u'name': u'default'}]                                                    |\n| OS-SRV-USG:terminated_at            | None                                                                       |\n| user_id                             | b25a17a8fcfa44098e45e0cfe5ae4fee                                           |\n| name                                | Ivt_July2_9                                                                |\n| created                             | 2013-07-02T16:59:00Z                                                       |\n| tenant_id                           | 066c47e2d09b440aad1845fcea9959ba                                           |\n| OS-DCF:diskConfig                   | MANUAL                                                                     |\n| metadata                            | {}                                                                         |\n| accessIPv4                          |                                                                            |\n| accessIPv6                          |                                                                            |\n| OS-EXT-STS:power_state              | 4                                                                          |\n| OS-EXT-AZ:availability_zone         | nova                                                                       |\n| config_drive                        | 1                                                                          |\n+-------------------------------------+----------------------------------------------------------------------------+\n\n3. Then migrate it (moves from CN10 to cn4):\n\n[root@ngp02-hv1 testscripts]# nova migrate Ivt_July2_9\n[root@ngp02-hv1 testscripts]# nova show Ivt_July2_9\n[root@ngp02-hv1 testscripts]# nova show Ivt_July2_9\n+-------------------------------------+----------------------------------------------------------------------------+\n| Property                            | Value                                                                      |\n+-------------------------------------+----------------------------------------------------------------------------+\n| status                              | VERIFY_RESIZE                                                              |\n| updated                             | 2013-07-02T17:22:27Z                                                       |\n| OS-EXT-STS:task_state               | None                                                                       |\n| OS-EXT-SRV-ATTR:host                | cn4                                                                        |\n| key_name                            | None                                                                       |\n| image                               | quantal-server-cloudimg-amd64-disk1 (8495ff12-ee3c-4fe4-b46b-7b3b10641c87) |\n| network1 network                    | 10.0.1.49                                                                  |\n| hostId                              | aec601f205a7665ea600c0fed93cf50e9bb779c2d7625e4f7da23944                   |\n| OS-EXT-STS:vm_state                 | resized                                                                    |\n| OS-EXT-SRV-ATTR:instance_name       | instance-00000090                                                          |\n| OS-SRV-USG:launched_at              | 2013-07-02T17:22:34.143000                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | cn4                                                                        |\n| flavor                              | m1.small (2)                                                               |\n| id                                  | 6c9a28c8-c52c-4046-ad83-00e12ee0994d                                       |\n| security_groups                     | [{u'name': u'default'}]                                                    |\n| OS-SRV-USG:terminated_at            | None                                                                       |\n| user_id                             | b25a17a8fcfa44098e45e0cfe5ae4fee                                           |\n| name                                | Ivt_July2_9                                                                |\n| created                             | 2013-07-02T16:59:00Z                                                       |\n| tenant_id                           | 066c47e2d09b440aad1845fcea9959ba                                           |\n| OS-DCF:diskConfig                   | MANUAL                                                                     |\n| metadata                            | {}                                                                         |\n| accessIPv4                          |                                                                            |\n| accessIPv6                          |                                                                            |\n| progress                            | 0                                                                          |\n| OS-EXT-STS:power_state              | 4                                                                          |\n| OS-EXT-AZ:availability_zone         | nova                                                                       |\n| config_drive                        | 1                                                                          |\n+-------------------------------------+----------------------------------------------------------------------------+\n\n4. Then confirm the migration.  This is where the problem happens - the vm_state goes to ACTIVE even though the power_state is 4 (SHUTOFF):\n\n[root@ngp02-hv1 testscripts]# nova show Ivt_July2_9\n+-------------------------------------+----------------------------------------------------------------------------+\n| Property                            | Value                                                                      |\n+-------------------------------------+----------------------------------------------------------------------------+\n| status                              | ACTIVE                                                                     |\n| updated                             | 2013-07-02T17:23:03Z                                                       |\n| OS-EXT-STS:task_state               | None                                                                       |\n| OS-EXT-SRV-ATTR:host                | cn4                                                                        |\n| key_name                            | None                                                                       |\n| image                               | quantal-server-cloudimg-amd64-disk1 (8495ff12-ee3c-4fe4-b46b-7b3b10641c87) |\n| network1 network                    | 10.0.1.49                                                                  |\n| hostId                              | aec601f205a7665ea600c0fed93cf50e9bb779c2d7625e4f7da23944                   |\n| OS-EXT-STS:vm_state                 | active                                                                     |\n| OS-EXT-SRV-ATTR:instance_name       | instance-00000090                                                          |\n| OS-SRV-USG:launched_at              | 2013-07-02T17:22:34.143000                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | cn4                                                                        |\n| flavor                              | m1.small (2)                                                               |\n| id                                  | 6c9a28c8-c52c-4046-ad83-00e12ee0994d                                       |\n| security_groups                     | [{u'name': u'default'}]                                                    |\n| OS-SRV-USG:terminated_at            | None                                                                       |\n| user_id                             | b25a17a8fcfa44098e45e0cfe5ae4fee                                           |\n| name                                | Ivt_July2_9                                                                |\n| created                             | 2013-07-02T16:59:00Z                                                       |\n| tenant_id                           | 066c47e2d09b440aad1845fcea9959ba                                           |\n| OS-DCF:diskConfig                   | MANUAL                                                                     |\n| metadata                            | {}                                                                         |\n| accessIPv4                          |                                                                            |\n| accessIPv6                          |                                                                            |\n| progress                            | 0                                                                          |\n| OS-EXT-STS:power_state              | 4                                                                          |\n| OS-EXT-AZ:availability_zone         | nova                                                                       |\n| config_drive                        | 1                                                                          |\n+-------------------------------------+----------------------------------------------------------------------------+\n\nI checked the compute logs for CN10 and cn4 and on the source host CN10 I found an exception for an InstanceNotFound coming from the nova.virt.hyperv.vmops.get_info method (which is actually detailed in bug 1197506).\n\nFor some history here, change I19fa61d467edd5a7572040d084824972569ef65a fixed bug 1177811 where a user could resize/migrate an instance from a stopped state and it would go back to ACTIVE state after the resize/migrate was confirmed/rejected.  As part of that change, we check the power_state when confirming the migration/resize to see if the user powered on the instance to confirm the resize (if they had resized/migrated from stopped state):\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L2300\n\nNow for this bug, it looks like if the instance was migrated, when we check the power_state on the instance, the old host is being asked to get the state but the instance has migrated and we get the InstanceNotFound (which is swallowed here):\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L698", 
            "date_created": "2013-07-03 19:36:39.506877+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "[root@ngp02-hv1 ~]# nova availability-zone-list\n+--------------------------------+----------------------------------------+\n| Name                           | Status                                 |\n+--------------------------------+----------------------------------------+\n| internal                       | available                              |\n| |- ngp02-hv1.private.cloud.com |                                        |\n| | |- nova-cert                 | enabled :-) 2013-07-03T19:39:24.152893 |\n| | |- nova-conductor            | enabled :-) 2013-07-03T19:39:16.801537 |\n| | |- nova-consoleauth          | enabled :-) 2013-07-03T19:39:18.054133 |\n| | |- nova-scheduler            | enabled :-) 2013-07-03T19:39:17.842316 |\n| | |- nova-console              | enabled :-) 2013-07-03T19:39:24.467889 |\n| | |- nova-cells                | enabled :-) 2013-07-03T19:39:18.174124 |\n| nova                           | available                              |\n| |- cn6                         |                                        |\n| | |- nova-compute              | enabled :-) 2013-07-03T19:39:20.555113 |\n| |- ngp02-hv1.private.cloud.com |                                        |\n| | |- nova-compute              | enabled :-) 2013-07-03T19:39:20.805885 |\n| |- cn4                         |                                        |\n| | |- nova-compute              | enabled :-) 2013-07-03T19:39:22.751993 |\n| |- cn8                         |                                        |\n| | |- nova-compute              | enabled :-) 2013-07-03T19:39:17.992623 |\n| |- CN10                        |                                        |\n| | |- nova-compute              | enabled :-) 2013-07-03T19:39:19.901133 |\n| |- cn12                        |                                        |\n| | |- nova-compute              | enabled :-) 2013-07-03T19:39:18.504939 |\n+--------------------------------+----------------------------------------+\n", 
            "date_created": "2013-07-03 19:39:34.987854+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This is where the compute API is picking the source host to service the resize-confirm request:\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/api.py#L1970", 
            "date_created": "2013-07-03 20:02:45.443248+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Talked about this in IRC today and consensus is we should never be supporting the case that the user stopped the instance, migrated it, powered it on via the hypervisor (below openstack), and then confirmed it and then we have to figure out what the current power state is in the hypervisor.  This makes fixing the bug pretty easy because I can just get the power_state from the database rather than the hypervisor.  I'll post a fix shortly.", 
            "date_created": "2013-07-03 21:15:34.358896+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/35554", 
            "date_created": "2013-07-03 21:39:49.071490+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/35554\nCommitted: http://github.com/openstack/nova/commit/fbe792902476fe7f508204c810050157dcc99c0d\nSubmitter: Jenkins\nBranch:    master\n\ncommit fbe792902476fe7f508204c810050157dcc99c0d\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Jul 3 14:39:13 2013 -0700\n\n    Fix power_state lookup in confirm_resize\n    \n    Previously the compute manager's confirm_resize method was trying to get\n    the current power_state of the resized/migrated instance from the\n    hypervisor layer to account for a case where the user migrated from a\n    stopped instance and then powered it on via the hypervisor (below\n    openstack) to test it before confirming the migration.  This doesn't\n    work in the migrate case because the confirm_resize request is serviced\n    on the source compute node, and the instance no longer lives there so\n    _get_power_state results in an InstanceNotFound.  The vm_state would\n    then be set to ACTIVE even though the instance's power_state is still\n    SHUTDOWN.\n    \n    This patch fixes this problem by just getting the instance power_state\n    from the database since the scenario of powering on the migrated\n    instance outside of openstack is not supported.\n    \n    Fixes bug 1197514\n    \n    Change-Id: If2ea83cd317aa8897b7b6bd6b43a2067e1074e33\n", 
            "date_created": "2013-07-16 22:02:18.001131+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}