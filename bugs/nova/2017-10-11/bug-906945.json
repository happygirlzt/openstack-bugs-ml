{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:00:55.021275+00:00", 
    "description": "Using nova Essex master...\n\nI'm getting the following error when trying to delete a server in 'BUILD' state:\n\n\n2011-12-17 02:34:52,012 ERROR nova.api.openstack.v2 [00f8bb84-6a79-49f7-8e4f-0b871eff6b4d 31ebeac7428443ae920ba5a0f593df46 706cdbb728a341d79ce94ad08613a25f] Caught error: Instance 26366adc-7d89-4301-a1c3-530f3911775c in vm_state building. Cannot wrapped_f while the instance is in this state.\n(nova.api.openstack.v2): TRACE: Traceback (most recent call last):\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/__init__.py\", line 62, in __call__\n(nova.api.openstack.v2): TRACE:     return req.get_response(self.application)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1053, in get_response\n(nova.api.openstack.v2): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1022, in call_application\n(nova.api.openstack.v2): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 316, in __call__\n(nova.api.openstack.v2): TRACE:     return self._forward_request(env, start_response, proxy_headers)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 499, in _forward_request\n(nova.api.openstack.v2): TRACE:     return self.app(env, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack.v2): TRACE:     return resp(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack.v2): TRACE:     return resp(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 147, in __call__\n(nova.api.openstack.v2): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 208, in call_func\n(nova.api.openstack.v2): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 499, in __call__\n(nova.api.openstack.v2): TRACE:     response = req.get_response(self.application)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1053, in get_response\n(nova.api.openstack.v2): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1022, in call_application\n(nova.api.openstack.v2): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n\n(nova.api.openstack.v2): TRACE:     return resp(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/pymodules/python2.7/routes/middleware.py\", line 131, in __call__\n(nova.api.openstack.v2): TRACE:     response = self.app(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack.v2): TRACE:     return resp(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 147, in __call__\n(nova.api.openstack.v2): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 208, in call_func\n(nova.api.openstack.v2): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 567, in __call__\n(nova.api.openstack.v2): TRACE:     action_result = self.dispatch(request, action, args)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 599, in dispatch\n(nova.api.openstack.v2): TRACE:     return controller_method(req=request, **action_args)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 43, in new_f\n(nova.api.openstack.v2): TRACE:     ret = f(*args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/scheduler/api.py\", line 400, in new_f\n(nova.api.openstack.v2): TRACE:     return f(*args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/servers.py\", line 701, in delete\n(nova.api.openstack.v2): TRACE:     self._delete(req.environ['nova.context'], id)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/servers.py\", line 472, in _delete\n(nova.api.openstack.v2): TRACE:     self.compute_api.delete(context, instance)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/api.py\", line 75, in inner\n(nova.api.openstack.v2): TRACE:     method=f.__name__)\n(nova.api.openstack.v2): TRACE: InstanceInvalidState: Instance 26366adc-7d89-4301-a1c3-530f3911775c in vm_state building. Cannot wrapped_f while the instance is in this state.\n\n---\n\nLooks like we re-worked the instance state checks in commit 0514bc9d5e92ed0eb6671349e8ff37d7f58aab85.\n\nThe nested wrapping seems like its causing the problem here:\n\n    @check_instance_state(vm_state=[vm_states.ACTIVE, vm_states.ERROR,\n                                    vm_states.RESCUED, vm_states.STOPPED])\n    @scheduler_api.reroute_compute(\"delete\")\n\nI see two problems with the implementation of this. First is that 'wrapped_f' should say the name of the calling function and it doesn't. Second do we really need to spew a full exception trace to the log file when these types of errors occur. Seems like we need to rework our error handling when instance state type exceptions occur.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/906945", 
    "owner": "https://api.launchpad.net/1.0/~dan-prince", 
    "id": 906945, 
    "index": 2691, 
    "created": "2011-12-20 16:04:20.846091+00:00", 
    "title": "Cannot wrapped_f while the instance is in this state", 
    "comments": [
        {
            "content": "Using nova Essex master...\n\nI'm getting the following error when trying to delete a server in 'BUILD' state:\n\n\n2011-12-17 02:34:52,012 ERROR nova.api.openstack.v2 [00f8bb84-6a79-49f7-8e4f-0b871eff6b4d 31ebeac7428443ae920ba5a0f593df46 706cdbb728a341d79ce94ad08613a25f] Caught error: Instance 26366adc-7d89-4301-a1c3-530f3911775c in vm_state building. Cannot wrapped_f while the instance is in this state.\n(nova.api.openstack.v2): TRACE: Traceback (most recent call last):\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/__init__.py\", line 62, in __call__\n(nova.api.openstack.v2): TRACE:     return req.get_response(self.application)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1053, in get_response\n(nova.api.openstack.v2): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1022, in call_application\n(nova.api.openstack.v2): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 316, in __call__\n(nova.api.openstack.v2): TRACE:     return self._forward_request(env, start_response, proxy_headers)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 499, in _forward_request\n(nova.api.openstack.v2): TRACE:     return self.app(env, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack.v2): TRACE:     return resp(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack.v2): TRACE:     return resp(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 147, in __call__\n(nova.api.openstack.v2): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 208, in call_func\n(nova.api.openstack.v2): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 499, in __call__\n(nova.api.openstack.v2): TRACE:     response = req.get_response(self.application)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1053, in get_response\n(nova.api.openstack.v2): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1022, in call_application\n(nova.api.openstack.v2): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n\n(nova.api.openstack.v2): TRACE:     return resp(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/pymodules/python2.7/routes/middleware.py\", line 131, in __call__\n(nova.api.openstack.v2): TRACE:     response = self.app(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack.v2): TRACE:     return resp(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 147, in __call__\n(nova.api.openstack.v2): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 208, in call_func\n(nova.api.openstack.v2): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 567, in __call__\n(nova.api.openstack.v2): TRACE:     action_result = self.dispatch(request, action, args)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 599, in dispatch\n(nova.api.openstack.v2): TRACE:     return controller_method(req=request, **action_args)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 43, in new_f\n(nova.api.openstack.v2): TRACE:     ret = f(*args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/scheduler/api.py\", line 400, in new_f\n(nova.api.openstack.v2): TRACE:     return f(*args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/servers.py\", line 701, in delete\n(nova.api.openstack.v2): TRACE:     self._delete(req.environ['nova.context'], id)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/servers.py\", line 472, in _delete\n(nova.api.openstack.v2): TRACE:     self.compute_api.delete(context, instance)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/api.py\", line 75, in inner\n(nova.api.openstack.v2): TRACE:     method=f.__name__)\n(nova.api.openstack.v2): TRACE: InstanceInvalidState: Instance 26366adc-7d89-4301-a1c3-530f3911775c in vm_state building. Cannot wrapped_f while the instance is in this state.\n\n---\n\nLooks like we re-worked the instance state checks in commit 0514bc9d5e92ed0eb6671349e8ff37d7f58aab85.\n\nThe nested wrapping seems like its causing the problem here:\n\n    @check_instance_state(vm_state=[vm_states.ACTIVE, vm_states.ERROR,\n                                    vm_states.RESCUED, vm_states.STOPPED])\n    @scheduler_api.reroute_compute(\"delete\")\n\nI see two problems with the implementation of this. First is that 'wrapped_f' should say the name of the calling function and it doesn't. Second do we really need to spew a full exception trace to the log file when these types of errors occur. Seems like we need to rework our error handling when instance state type exceptions occur.", 
            "date_created": "2011-12-20 16:04:20.846091+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/2521", 
            "date_created": "2011-12-21 18:48:01.993614+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2521\nCommitted: http://github.com/openstack/nova/commit/f0b54c7b343a752f3577dafc80e3eb5a9ae0754d\nSubmitter: Jenkins\nBranch:    master\n\ncommit f0b54c7b343a752f3577dafc80e3eb5a9ae0754d\nAuthor: Dan Prince <email address hidden>\nDate:   Wed Dec 21 13:42:40 2011 -0500\n\n    Make reroute_compute use functools.wraps. Fixes LP bug #906945.\n    \n    Change-Id: I043b6543e79f9cc6c7a32c9952113ee009b31377\n", 
            "date_created": "2011-12-21 19:45:22.018430+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}