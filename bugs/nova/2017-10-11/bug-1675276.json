{
    "status": "Won't Fix", 
    "last_updated": "2017-07-28 12:24:24.057144+00:00", 
    "description": "Nova supported to attach and detach volumes to/from shelved instances\nsince microversion 2.20.\n\nWhen we attach a volume to an instance and\nthen unshelve the instance the cinder side doesn't include the\ndevice_name information.\n\nHow to re-produce:\n\n#1 shelve an instance\n\nstack@SZX1000280461:/opt/devstack$ nova list\n---+-------+--------+------------+-------------+------------------------------+\n| ID                                   | Name  | Status | Task State | Power State | Networks                     |\n+--------------------------------------+-------+--------+------------+-------------+------------------------------+\n| bd09421c-90b2-411c-99d0-fcf07338c542 | test2 | ACTIVE | -          | Running     | Kevin=10.0.0.76, 172.24.4.10 |\n+--------------------------------------+-------+--------+------------+-------------+------------------------------+\n\nstack@SZX1000280461:/opt/devstack$ nova shelve bd09421c-90b2-411c-99d0-fcf07338c542\n\nstack@SZX1000280461:/opt/devstack$ nova list\n+--------------------------------------+-------+-------------------+------------+-------------+------------------------------+\n| ID                                   | Name  | Status            | Task State | Power State | Networks                     |\n+--------------------------------------+-------+-------------------+------------+-------------+------------------------------+\n| bd09421c-90b2-411c-99d0-fcf07338c542 | test2 | SHELVED_OFFLOADED | -          | Shutdown    | Kevin=10.0.0.76, 172.24.4.10 |\n+--------------------------------------+-------+-------------------+------------+-------------+------------------------------+\n\n# 2 attach a cinder volume to the shelved insntace:\n\nstack@SZX1000280461:/opt/devstack$ cinder list\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+\n| ID                                   | Status    | Name  | Size | Volume Type | Bootable | Attached to |\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+\n| a72f9642-ca8f-4c2e-bfe0-362c6220d498 | available | test1 | 1    | lvmdriver-1 | false    |             |\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+\n\nstack@SZX1000280461:/opt/devstack$ nova volume-attach bd09421c-90b2-411c-99d0-fcf07338c542 a72f9642-ca8f-4c2e-bfe0-362c6220d498\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | -                                    |\n| id       | a72f9642-ca8f-4c2e-bfe0-362c6220d498 |\n| serverId | bd09421c-90b2-411c-99d0-fcf07338c542 |\n| volumeId | a72f9642-ca8f-4c2e-bfe0-362c6220d498 |\n+----------+--------------------------------------+\n\nstack@SZX1000280461:/opt/devstack$ cinder list\n+--------------------------------------+--------+-------+------+-------------+----------+--------------------------------------+\n| ID                                   | Status | Name  | Size | Volume Type | Bootable | Attached to                          |\n+--------------------------------------+--------+-------+------+-------------+----------+--------------------------------------+\n| a72f9642-ca8f-4c2e-bfe0-362c6220d498 | in-use | test1 | 1    | lvmdriver-1 | false    | bd09421c-90b2-411c-99d0-fcf07338c542 |\n+--------------------------------------+--------+-------+------+-------------+----------+--------------------------------------+\n\nstack@SZX1000280461:/opt/devstack$ nova show test2\n+--------------------------------------+----------------------------------------------------------------------------------+\n| Property                             | Value                                                                            |\n+--------------------------------------+----------------------------------------------------------------------------------+\n| Kevin network                        | 10.0.0.76, 172.24.4.10                                                           |\n| OS-DCF:diskConfig                    | MANUAL                                                                           |\n| OS-EXT-AZ:availability_zone          |                                                                                  |\n| OS-EXT-SRV-ATTR:host                 | -                                                                                |\n| OS-EXT-SRV-ATTR:hostname             | test2                                                                            |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                                                |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000004                                                                |\n| OS-EXT-SRV-ATTR:kernel_id            |                                                                                  |\n| OS-EXT-SRV-ATTR:launch_index         | 0                                                                                |\n| OS-EXT-SRV-ATTR:ramdisk_id           |                                                                                  |\n| OS-EXT-SRV-ATTR:reservation_id       | r-z869pf5v                                                                       |\n| OS-EXT-SRV-ATTR:root_device_name     | /dev/vda                                                                         |\n| OS-EXT-SRV-ATTR:user_data            | -                                                                                |\n| OS-EXT-STS:power_state               | 4                                                                                |\n| OS-EXT-STS:task_state                | -                                                                                |\n| OS-EXT-STS:vm_state                  | shelved_offloaded                                                                |\n| OS-SRV-USG:launched_at               | 2017-03-23T02:34:04.000000                                                       |\n| OS-SRV-USG:terminated_at             | -                                                                                |\n| accessIPv4                           |                                                                                  |\n| accessIPv6                           |                                                                                  |\n| config_drive                         |                                                                                  |\n| created                              | 2017-03-23T02:33:19Z                                                             |\n| description                          | -                                                                                |\n| flavor                               | ds1G (d2)                                                                        |\n| hostId                               |                                                                                  |\n| host_status                          |                                                                                  |\n| id                                   | bd09421c-90b2-411c-99d0-fcf07338c542                                             |\n| image                                | CentOS (d826a98b-4ab5-4ce1-93f4-394193abaa51)                                    |\n| key_name                             | kevin_322                                                                        |\n| locked                               | False                                                                            |\n| metadata                             | {}                                                                               |\n| name                                 | test2                                                                            |\n| os-extended-volumes:volumes_attached | [{\"id\": \"a72f9642-ca8f-4c2e-bfe0-362c6220d498\", \"delete_on_termination\": false}] |\n| security_groups                      | default                                                                          |\n| status                               | SHELVED_OFFLOADED                                                                |\n| tags                                 | []                                                                               |\n| tenant_id                            | 4f705543436648abbacf5719d3397c0f                                                 |\n| updated                              | 2017-03-23T02:57:54Z                                                             |\n| user_id                              | 46a372c04e38463b898dc71626d8846a                                                 |\n+--------------------------------------+----------------------------------------------------------------------------------+\n\n#3 Unshelve the instance:\n\nstack@SZX1000280461:/opt/devstack$ nova unshelve bd09421c-90b2-411c-99d0-fcf07338c542\n\nstack@SZX1000280461:/opt/devstack$ nova list\n+--------------------------------------+-------+--------+------------+-------------+------------------------------+\n| ID                                   | Name  | Status | Task State | Power State | Networks                     |\n+--------------------------------------+-------+--------+------------+-------------+------------------------------+\n| bd09421c-90b2-411c-99d0-fcf07338c542 | test2 | ACTIVE | -          | Running     | Kevin=10.0.0.76, 172.24.4.10 |\n+--------------------------------------+-------+--------+------------+-------------+------------------------------+\n\n#4 Check details in cinder:\nroot@SZX1000280461:~# cinder show a72f9642-ca8f-4c2e-bfe0-362c6220d498\n+--------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Property                       | Value                                                                                                                                                                                                                                                                                               |\n+--------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| attachments                    | [{'server_id': 'bd09421c-90b2-411c-99d0-fcf07338c542', 'attachment_id': '16e65459-23e9-4af9-8481-c75366d4f51b', 'attached_at': '2017-03-23T06:11:26.000000', 'host_name': None, 'volume_id': 'a72f9642-ca8f-4c2e-bfe0-362c6220d498', 'device': None, 'id': 'a72f9642-ca8f-4c2e-bfe0-362c6220d498'}] |\n| availability_zone              | nova                                                                                                                                                                                                                                                                                                |\n| bootable                       | false                                                                                                                                                                                                                                                                                               |\n| consistencygroup_id            | None                                                                                                                                                                                                                                                                                                |\n| created_at                     | 2017-03-23T02:49:07.000000                                                                                                                                                                                                                                                                          |\n| description                    |                                                                                                                                                                                                                                                                                                     |\n| encrypted                      | False                                                                                                                                                                                                                                                                                               |\n| id                             | a72f9642-ca8f-4c2e-bfe0-362c6220d498                                                                                                                                                                                                                                                                |\n| metadata                       | {'attached_mode': 'rw'}                                                                                                                                                                                                                                                                             |\n| migration_status               | None                                                                                                                                                                                                                                                                                                |\n| multiattach                    | False                                                                                                                                                                                                                                                                                               |\n| name                           | test1                                                                                                                                                                                                                                                                                               |\n| os-vol-host-attr:host          | SZX1000280461@lvmdriver-1#lvmdriver-1                                                                                                                                                                                                                                                               |\n| os-vol-mig-status-attr:migstat | None                                                                                                                                                                                                                                                                                                |\n| os-vol-mig-status-attr:name_id | None                                                                                                                                                                                                                                                                                                |\n| os-vol-tenant-attr:tenant_id   | 4f705543436648abbacf5719d3397c0f                                                                                                                                                                                                                                                                    |\n| replication_status             | None                                                                                                                                                                                                                                                                                                |\n| size                           | 1                                                                                                                                                                                                                                                                                                   |\n| snapshot_id                    | None                                                                                                                                                                                                                                                                                                |\n| source_volid                   | None                                                                                                                                                                                                                                                                                                |\n| status                         | in-use                                                                                                                                                                                                                                                                                              |\n| updated_at                     | 2017-03-23T06:11:58.000000                                                                                                                                                                                                                                                                          |\n| user_id                        | 46a372c04e38463b898dc71626d8846a                                                                                                                                                                                                                                                                    |\n| volume_type                    | lvmdriver-1                                                                                                                                                                                                                                                                                         |\n+--------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\nAfter studied more, I discovered that this is because _attach_volume_shelved_offloaded uses _create_volume_bdm with param: _is_local_createion=True and it just create an bdm in DB and then call cinder to modify its DB. When the instance is unshelved, the actual attach operation will take place and there will be no updates in cinder DB.\n\nThis causes TWO problems,\n1. nova volume-attach can be used with user provided device_name, in general case this name will be checked or ignored. In the shelved case, it will pass directly to Cinder thus Cinder will have wrong device_name [1], for example, I provide /dev/vda, when I do cinder show, it will show /dev/vda:\n[1] http://git.openstack.org/cgit/openstack/nova/tree/nova/compute/api.py#n3719\n\nroot@SZX1000280461:/var/log/nova# nova volume-attach bd09421c-90b2-411c-99d0-fcf07338c542 a72f9642-ca8f-4c2e-bfe0-362c6220d498 /dev/vda\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | -                                    |\n| id       | a72f9642-ca8f-4c2e-bfe0-362c6220d498 |\n| serverId | bd09421c-90b2-411c-99d0-fcf07338c542 |\n| volumeId | a72f9642-ca8f-4c2e-bfe0-362c6220d498 |\n+----------+--------------------------------------+\n\nroot@SZX1000280461:/var/log/nova# cinder show a72f9642-ca8f-4c2e-bfe0-362c6220d498\n+--------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Property                       | Value                                                                                                                                                                                                                                                                                                     |\n+--------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| attachments                    | [{'server_id': 'bd09421c-90b2-411c-99d0-fcf07338c542', 'attachment_id': '46dc8d6a-9148-4e91-bc28-c1947c618ebb', 'attached_at': '2017-03-23T08:00:37.000000', 'host_name': None, 'volume_id': 'a72f9642-ca8f-4c2e-bfe0-362c6220d498', 'device': '/dev/vda', 'id': 'a72f9642-ca8f-4c2e-bfe0-362c6220d498'}] |\n| availability_zone              | nova                                                                                                                                                                                                                                                                                                      |\n| bootable                       | false                                                                                                                                                                                                                                                                                                     |\n| consistencygroup_id            | None                                                                                                                                                                                                                                                                                                      |\n| created_at                     | 2017-03-23T02:49:07.000000                                                                                                                                                                                                                                                                                |\n| description                    |                                                                                                                                                                                                                                                                                                           |\n| encrypted                      | False                                                                                                                                                                                                                                                                                                     |\n| id                             | a72f9642-ca8f-4c2e-bfe0-362c6220d498                                                                                                                                                                                                                                                                      |\n| metadata                       | {'attached_mode': 'rw'}                                                                                                                                                                                                                                                                                   |\n| migration_status               | None                                                                                                                                                                                                                                                                                                      |\n| multiattach                    | False                                                                                                                                                                                                                                                                                                     |\n| name                           | test1                                                                                                                                                                                                                                                                                                     |\n| os-vol-host-attr:host          | SZX1000280461@lvmdriver-1#lvmdriver-1                                                                                                                                                                                                                                                                     |\n| os-vol-mig-status-attr:migstat | None                                                                                                                                                                                                                                                                                                      |\n| os-vol-mig-status-attr:name_id | None                                                                                                                                                                                                                                                                                                      |\n| os-vol-tenant-attr:tenant_id   | 4f705543436648abbacf5719d3397c0f                                                                                                                                                                                                                                                                          |\n| replication_status             | None                                                                                                                                                                                                                                                                                                      |\n| size                           | 1                                                                                                                                                                                                                                                                                                         |\n| snapshot_id                    | None                                                                                                                                                                                                                                                                                                      |\n| source_volid                   | None                                                                                                                                                                                                                                                                                                      |\n| status                         | in-use                                                                                                                                                                                                                                                                                                    |\n| updated_at                     | 2017-03-23T08:00:37.000000                                                                                                                                                                                                                                                                                |\n| user_id                        | 46a372c04e38463b898dc71626d8846a                                                                                                                                                                                                                                                                          |\n| volume_type                    | lvmdriver-1                                                                                                                                                                                                                                                                                               |\n+--------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\nroot@SZX1000280461:/var/log/nova# nova volume-attachments bd09421c-90b2-411c-99d0-fcf07338c542\n+--------------------------------------+----------+--------------------------------------+--------------------------------------+\n| ID                                   | DEVICE   | SERVER ID                            | VOLUME ID                            |\n+--------------------------------------+----------+--------------------------------------+--------------------------------------+\n| a72f9642-ca8f-4c2e-bfe0-362c6220d498 | /dev/vdc | bd09421c-90b2-411c-99d0-fcf07338c542 | a72f9642-ca8f-4c2e-bfe0-362c6220d498 |\n+--------------------------------------+----------+--------------------------------------+--------------------------------------+\n\n2. if user don't provide device_name, the Cinder side device_name will always be None.", 
    "tags": [
        "shelve"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1675276", 
    "owner": "None", 
    "id": 1675276, 
    "index": 2053, 
    "created": "2017-03-23 06:28:16.891894+00:00", 
    "title": "Volumes attached to shelved instance may contain incorrect device_name", 
    "comments": [
        {
            "content": "TBA", 
            "date_created": "2017-03-23 06:28:16.891894+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengzhenyu"
        }, 
        {
            "content": "This is mostly working as designed.\n\nWhen attaching a volume to a shelved offloaded instance, there is no host for the instance so we can't call to the compute manager to reserve the device like we do for a normal attach here:\n\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/compute/api.py#n3687\n\nSo we create the BDM in the API and don't set a device name, because we can't say it's going to be the device name when we unshelve the instance:\n\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/compute/api.py#n3678\n\nWe've long talked about just removing the device_name option from the volume attach API because we can't guarantee that what the user requests is what's going to be in the guest, the hypervisor controls that, not nova. The libvirt driver completely ignores the user-requested device name.\n\nSo I think we want a spec to microversion the device_name field out of the volume attach request since it's just confusing and we can't honor it.\n\nThe thing we need to check is it the os-attach API in Cinder requires the mountpoint (which is the device name in the nova BDM).", 
            "date_created": "2017-03-23 15:14:49.300680+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "It looks like cinder's os-attach API does require the mountpoint parameter:\n\nhttps://github.com/openstack/cinder/blob/504f129714c60eb2d24192462113db971a798b1a/cinder/api/contrib/volume_actions.py#L62\n\nIn fact, it looks like a request would fail with a 500 error if the mountpoint is not provided since it doesn't check and would raise a KeyError if not provided.", 
            "date_created": "2017-03-23 16:33:21.468075+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Cinder bug 1575675 is for the 500 error in the os-attach API when mountpoint is not provided.", 
            "date_created": "2017-03-23 16:43:46.721757+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "\nThere are no currently open reviews on this bug, changing\nthe status back to the previous state and unassigning. If\nthere are active reviews related to this bug, please include\nlinks in comments.\n", 
            "date_created": "2017-06-23 12:54:31.562996+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Working as design, device_name is since removed from the API.", 
            "date_created": "2017-07-28 12:24:23.649451+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}