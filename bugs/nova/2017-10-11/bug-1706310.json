{
    "status": "Incomplete", 
    "last_updated": "2017-09-15 19:59:20.493953+00:00", 
    "description": "OpenStack version: Ocata\n\nDescription\n===========\nIf you delete an instance while booting (i.e. vm_state=building, task_state=scheduling), such instance is not listed anymore by the \"nova list\" but the quota usage is not updated (i.e. it should be decreased by the flavor size).\n\nSteps to reproduce\n==================\n1) edit /etc/nova/nova-api.conf\n\n$ cat /etc/nova/nova-api.conf\n[conductor]\ntopic=my_topic\n\nand restart nova-api service\n# systemctl restart openstack-nova-api.service\n\n2) check the project usage (project_id=\"01ab8de5387547d093aa8ae6b85bd8b1\")\n\nMariaDB [nova]> select * from quota_usages where project_id=\"01ab8de5387547d093aa8ae6b85bd8b1\";\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  1 | 01ab8de5387547d093aa8ae6b85bd8b1 | instances       |      0 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  2 | 01ab8de5387547d093aa8ae6b85bd8b1 | ram             |      0 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  3 | 01ab8de5387547d093aa8ae6b85bd8b1 | cores           |      0 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 13:21:26 | 2017-05-23 13:21:26 | NULL       |  4 | 01ab8de5387547d093aa8ae6b85bd8b1 | security_groups |      0 |        0 |             0 |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n4 rows in set (0,00 sec)\n\n3) create a new instance (the task_state will be \"scheduling\" and vm_state = \"building\")\n\n$ openstack server create --flavor m1.tiny --image cirros --nic net-id=admin_net --security-group default test\n+-------------------------------------+------------------------------------------------+\n| Field                               | Value                                          |\n+-------------------------------------+------------------------------------------------+\n| OS-DCF:diskConfig                   | MANUAL                                         |\n| OS-EXT-AZ:availability_zone         |                                                |\n| OS-EXT-SRV-ATTR:host                | None                                           |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | None                                           |\n| OS-EXT-SRV-ATTR:instance_name       |                                                |\n| OS-EXT-STS:power_state              | NOSTATE                                        |\n| OS-EXT-STS:task_state               | scheduling                                     |\n| OS-EXT-STS:vm_state                 | building                                       |\n| OS-SRV-USG:launched_at              | None                                           |\n| OS-SRV-USG:terminated_at            | None                                           |\n| accessIPv4                          |                                                |\n| accessIPv6                          |                                                |\n| addresses                           |                                                |\n| adminPass                           | 4i8zTGZZ3u9w                                   |\n| config_drive                        |                                                |\n| created                             | 2017-07-25T10:18:21Z                           |\n| flavor                              | m1.tiny (5cdecdda-111d-4659-acc3-506609e5fadc) |\n| hostId                              |                                                |\n| id                                  | aab25cc8-9df6-4f3b-9585-3cf099bb1adb           |\n| image                               | cirros (03d54ef8-f0ac-4ad2-92a0-95835d77d2b5)  |\n| key_name                            | None                                           |\n| name                                | test                                           |\n| progress                            | 0                                              |\n| project_id                          | 01ab8de5387547d093aa8ae6b85bd8b1               |\n| properties                          |                                                |\n| security_groups                     | name='default'                                 |\n| status                              | BUILD                                          |\n| updated                             | 2017-07-25T10:18:23Z                           |\n| user_id                             | 4469ff06d1e247e0bbfc23668e92bd66               |\n| volumes_attached                    |                                                |\n+-------------------------------------+------------------------------------------------+\n\n$ openstack server show aab25cc8-9df6-4f3b-9585-3cf099bb1adb\n+-------------------------------------+------------------------------------------------+\n| Field                               | Value                                          |\n+-------------------------------------+------------------------------------------------+\n| OS-DCF:diskConfig                   | MANUAL                                         |\n| OS-EXT-AZ:availability_zone         |                                                |\n| OS-EXT-SRV-ATTR:host                | None                                           |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | None                                           |\n| OS-EXT-SRV-ATTR:instance_name       |                                                |\n| OS-EXT-STS:power_state              | NOSTATE                                        |\n| OS-EXT-STS:task_state               | scheduling                                     |\n| OS-EXT-STS:vm_state                 | building                                       |\n| OS-SRV-USG:launched_at              | None                                           |\n| OS-SRV-USG:terminated_at            | None                                           |\n| accessIPv4                          |                                                |\n| accessIPv6                          |                                                |\n| addresses                           |                                                |\n| config_drive                        |                                                |\n| created                             | 2017-07-25T10:18:21Z                           |\n| flavor                              | m1.tiny (5cdecdda-111d-4659-acc3-506609e5fadc) |\n| hostId                              |                                                |\n| id                                  | aab25cc8-9df6-4f3b-9585-3cf099bb1adb           |\n| image                               | cirros (03d54ef8-f0ac-4ad2-92a0-95835d77d2b5)  |\n| key_name                            | None                                           |\n| name                                | test                                           |\n| progress                            | 0                                              |\n| project_id                          | 01ab8de5387547d093aa8ae6b85bd8b1               |\n| properties                          |                                                |\n| status                              | BUILD                                          |\n| updated                             | 2017-07-25T10:19:25Z                           |\n| user_id                             | 4469ff06d1e247e0bbfc23668e92bd66               |\n| volumes_attached                    |                                                |\n+-------------------------------------+------------------------------------------------+\n\n4) check the quota usage for project_id=\"01ab8de5387547d093aa8ae6b85bd8b1\"\n\nMariaDB [nova]> select * from quota_usages where project_id=\"01ab8de5387547d093aa8ae6b85bd8b1\";\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  1 | 01ab8de5387547d093aa8ae6b85bd8b1 | instances       |      1 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  2 | 01ab8de5387547d093aa8ae6b85bd8b1 | ram             |    512 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  3 | 01ab8de5387547d093aa8ae6b85bd8b1 | cores           |      1 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 13:21:26 | 2017-05-23 13:21:26 | NULL       |  4 | 01ab8de5387547d093aa8ae6b85bd8b1 | security_groups |      0 |        0 |             0 |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n4 rows in set (0,00 sec)\n\n5) delete the instance\n\n$ openstack server delete aab25cc8-9df6-4f3b-9585-3cf099bb1adb\n$ openstack server show aab25cc8-9df6-4f3b-9585-3cf099bb1adb\nNo server with a name or ID of 'aab25cc8-9df6-4f3b-9585-3cf099bb1adb' exists.\n\n6) check again the quota usage\nMariaDB [nova]> select * from quota_usages where project_id=\"01ab8de5387547d093aa8ae6b85bd8b1\";\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  1 | 01ab8de5387547d093aa8ae6b85bd8b1 | instances       |      1 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  2 | 01ab8de5387547d093aa8ae6b85bd8b1 | ram             |    512 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  3 | 01ab8de5387547d093aa8ae6b85bd8b1 | cores           |      1 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 13:21:26 | 2017-05-23 13:21:26 | NULL       |  4 | 01ab8de5387547d093aa8ae6b85bd8b1 | security_groups |      0 |        0 |             0 |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n4 rows in set (0,00 sec)\n\nExpected result\n===============\nThe quota usage should be decreased", 
    "tags": [
        "needs.openstack-version"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1706310", 
    "owner": "None", 
    "id": 1706310, 
    "index": 6958, 
    "created": "2017-07-25 10:39:12.883330+00:00", 
    "title": "Quota usage is not updated if an instance is deleted while booting", 
    "comments": [
        {
            "content": "Description\n===========\nIf you delete an instance while booting (i.e. vm_state=building, task_state=scheduling), such instance is not listed anymore by the \"nova list\" but the quota usage is not updated (i.e. it should be decreased by the flavor size).\n\nSteps to reproduce\n==================\n1) edit /etc/nova/nova-api.conf\n\n$ cat /etc/nova/nova-api.conf \n[conductor]\ntopic=my_topic\n\nand restart nova-api service\n# systemctl restart openstack-nova-api.service\n\n\n2) check the project usage (project_id=\"01ab8de5387547d093aa8ae6b85bd8b1\")\n\nMariaDB [nova]> select * from quota_usages where project_id=\"01ab8de5387547d093aa8ae6b85bd8b1\";\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  1 | 01ab8de5387547d093aa8ae6b85bd8b1 | instances       |      0 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  2 | 01ab8de5387547d093aa8ae6b85bd8b1 | ram             |      0 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  3 | 01ab8de5387547d093aa8ae6b85bd8b1 | cores           |      0 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 13:21:26 | 2017-05-23 13:21:26 | NULL       |  4 | 01ab8de5387547d093aa8ae6b85bd8b1 | security_groups |      0 |        0 |             0 |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n4 rows in set (0,00 sec)\n\n\n3) create a new instance (the task_state will be \"scheduling\" and vm_state = \"building\")\n  \n$ openstack server create --flavor m1.tiny --image cirros --nic net-id=admin_net --security-group default test\n+-------------------------------------+------------------------------------------------+\n| Field                               | Value                                          |\n+-------------------------------------+------------------------------------------------+\n| OS-DCF:diskConfig                   | MANUAL                                         |\n| OS-EXT-AZ:availability_zone         |                                                |\n| OS-EXT-SRV-ATTR:host                | None                                           |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | None                                           |\n| OS-EXT-SRV-ATTR:instance_name       |                                                |\n| OS-EXT-STS:power_state              | NOSTATE                                        |\n| OS-EXT-STS:task_state               | scheduling                                     |\n| OS-EXT-STS:vm_state                 | building                                       |\n| OS-SRV-USG:launched_at              | None                                           |\n| OS-SRV-USG:terminated_at            | None                                           |\n| accessIPv4                          |                                                |\n| accessIPv6                          |                                                |\n| addresses                           |                                                |\n| adminPass                           | 4i8zTGZZ3u9w                                   |\n| config_drive                        |                                                |\n| created                             | 2017-07-25T10:18:21Z                           |\n| flavor                              | m1.tiny (5cdecdda-111d-4659-acc3-506609e5fadc) |\n| hostId                              |                                                |\n| id                                  | aab25cc8-9df6-4f3b-9585-3cf099bb1adb           |\n| image                               | cirros (03d54ef8-f0ac-4ad2-92a0-95835d77d2b5)  |\n| key_name                            | None                                           |\n| name                                | test                                           |\n| progress                            | 0                                              |\n| project_id                          | 01ab8de5387547d093aa8ae6b85bd8b1               |\n| properties                          |                                                |\n| security_groups                     | name='default'                                 |\n| status                              | BUILD                                          |\n| updated                             | 2017-07-25T10:18:23Z                           |\n| user_id                             | 4469ff06d1e247e0bbfc23668e92bd66               |\n| volumes_attached                    |                                                |\n+-------------------------------------+------------------------------------------------+\n\n$ openstack server show aab25cc8-9df6-4f3b-9585-3cf099bb1adb\n+-------------------------------------+------------------------------------------------+\n| Field                               | Value                                          |\n+-------------------------------------+------------------------------------------------+\n| OS-DCF:diskConfig                   | MANUAL                                         |\n| OS-EXT-AZ:availability_zone         |                                                |\n| OS-EXT-SRV-ATTR:host                | None                                           |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | None                                           |\n| OS-EXT-SRV-ATTR:instance_name       |                                                |\n| OS-EXT-STS:power_state              | NOSTATE                                        |\n| OS-EXT-STS:task_state               | scheduling                                     |\n| OS-EXT-STS:vm_state                 | building                                       |\n| OS-SRV-USG:launched_at              | None                                           |\n| OS-SRV-USG:terminated_at            | None                                           |\n| accessIPv4                          |                                                |\n| accessIPv6                          |                                                |\n| addresses                           |                                                |\n| config_drive                        |                                                |\n| created                             | 2017-07-25T10:18:21Z                           |\n| flavor                              | m1.tiny (5cdecdda-111d-4659-acc3-506609e5fadc) |\n| hostId                              |                                                |\n| id                                  | aab25cc8-9df6-4f3b-9585-3cf099bb1adb           |\n| image                               | cirros (03d54ef8-f0ac-4ad2-92a0-95835d77d2b5)  |\n| key_name                            | None                                           |\n| name                                | test                                           |\n| progress                            | 0                                              |\n| project_id                          | 01ab8de5387547d093aa8ae6b85bd8b1               |\n| properties                          |                                                |\n| status                              | BUILD                                          |\n| updated                             | 2017-07-25T10:19:25Z                           |\n| user_id                             | 4469ff06d1e247e0bbfc23668e92bd66               |\n| volumes_attached                    |                                                |\n+-------------------------------------+------------------------------------------------+\n\n\n4) check the quota usage for project_id=\"01ab8de5387547d093aa8ae6b85bd8b1\"\n\nMariaDB [nova]> select * from quota_usages where project_id=\"01ab8de5387547d093aa8ae6b85bd8b1\";\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  1 | 01ab8de5387547d093aa8ae6b85bd8b1 | instances       |      1 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  2 | 01ab8de5387547d093aa8ae6b85bd8b1 | ram             |    512 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  3 | 01ab8de5387547d093aa8ae6b85bd8b1 | cores           |      1 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 13:21:26 | 2017-05-23 13:21:26 | NULL       |  4 | 01ab8de5387547d093aa8ae6b85bd8b1 | security_groups |      0 |        0 |             0 |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n4 rows in set (0,00 sec)\n\n\n5) delete the instance\n\n$ openstack server delete aab25cc8-9df6-4f3b-9585-3cf099bb1adb\n$ openstack server show aab25cc8-9df6-4f3b-9585-3cf099bb1adb\nNo server with a name or ID of 'aab25cc8-9df6-4f3b-9585-3cf099bb1adb' exists.\n\n\n6) check again the quota usage\nMariaDB [nova]> select * from quota_usages where project_id=\"01ab8de5387547d093aa8ae6b85bd8b1\";\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  1 | 01ab8de5387547d093aa8ae6b85bd8b1 | instances       |      1 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  2 | 01ab8de5387547d093aa8ae6b85bd8b1 | ram             |    512 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 09:42:02 | 2017-07-25 10:18:22 | NULL       |  3 | 01ab8de5387547d093aa8ae6b85bd8b1 | cores           |      1 |        0 |          NULL |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n| 2017-05-23 13:21:26 | 2017-05-23 13:21:26 | NULL       |  4 | 01ab8de5387547d093aa8ae6b85bd8b1 | security_groups |      0 |        0 |             0 |       0 | 4469ff06d1e247e0bbfc23668e92bd66 |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n4 rows in set (0,00 sec)\n\n\nExpected result\n===============\nThe quota usage should be decreased", 
            "date_created": "2017-07-25 10:39:12.883330+00:00", 
            "author": "https://api.launchpad.net/1.0/~lisa-zangrando"
        }, 
        {
            "content": "I feel like this might have been addressed with melanie's new quota work", 
            "date_created": "2017-07-25 13:53:08.429089+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Can you reproduce this with debug logging enabled and then see if you can find anything in the logs related to the instance when it gets deleted? At the point that you deleted the instance, it didn't have a host set, so it wasn't done building on a compute node.\n\nBut things get tricky with delete while booting because the instance may or may not have existed in a cell at that point, and if it didn't exist in a cell yet, then we're really deleting the build request (in the API DB build_requests table) rather than the instance. But this \"local delete\" code should be handling it:\n\nhttps://github.com/openstack/nova/blob/stable/ocata/nova/compute/api.py#L1785-L1841\n\nThere were some bugs in this area when Ocata 15.0.0 was released, but it's not clear what version of Nova you're running. Please provide the version and/or git hash for the nova-api service?\n\nhttps://docs.openstack.org/releasenotes/nova/ocata.html\n\nFor example: https://bugs.launchpad.net/nova/+bug/1670627", 
            "date_created": "2017-07-25 13:58:06.910250+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/487104", 
            "date_created": "2017-07-25 14:24:25.774949+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi Matt,\n\nI'm referring to the Ocata version 15.0.0.4.\nI know you have fixed a similar bug in https://github.com/openstack/nova/blob/stable/ocata/nova/compute/api.py#L1785-L1841\n\nI debugged the issue and the problem occurs in\nhttps://github.com/openstack/nova/blob/stable/ocata/nova/compute/api.py#L1788\n\n if self._delete_while_booting(context, instance):\n     return\n\nif True, the function exits without decreasing the quota usage.\nI committed my fix, it seems to work fine. Please take e look.\n", 
            "date_created": "2017-07-25 14:25:46.508913+00:00", 
            "author": "https://api.launchpad.net/1.0/~lisa-zangrando"
        }, 
        {
            "content": "Change abandoned by Lee Yarwood (<email address hidden>) on branch: stable/ocata\nReview: https://review.openstack.org/487104\nReason: Abandoning this review after 5 weeks without any updates from the owner, please feel free to reopen if you're still working on this.", 
            "date_created": "2017-09-15 19:59:19.915251+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}