{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:09:20.852014+00:00", 
    "description": "Boot an instance with the libvirt driver, and then use 'virsh destroy [instancename]' to kill it off behind Nova's back.\n\nNow wait a while (upto 10 minutes) for the '_sync_db_power_states' periodic task to run in nova-compute. When it does run it will generate the following exception\n\n2013-02-12 16:25:52.509 ERROR nova.compute [-] No db access allowed in nova-compute:   File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 192, in main\n    result = function(*args, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/utils.py\", line 630, in _inner\n    idle = self.f(*self.args, **self.kw)\n  File \"/home/berrange/src/cloud/nova/nova/service.py\", line 571, in periodic_tasks\n    return self.manager.periodic_tasks(ctxt, raise_on_error=raise_on_error)\n  File \"/home/berrange/src/cloud/nova/nova/manager.py\", line 229, in periodic_tasks\n    task(self, context)\n  File \"/home/berrange/src/cloud/nova/nova/compute/manager.py\", line 3425, in _sync_power_states\n    vm_power_state)\n  File \"/home/berrange/src/cloud/nova/nova/compute/manager.py\", line 3492, in _sync_instance_power_state\n    self.compute_api.stop(context, db_instance)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 158, in wrapped\n    return func(self, context, target, *args, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 148, in inner\n    return function(self, context, instance, *args, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 139, in wrapped\n    return function(self, context, instance, *args, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 129, in inner\n    return f(self, context, instance, *args, **kw)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 1236, in stop\n    progress=0)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 158, in wrapped\n    return func(self, context, target, *args, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 950, in update\n    _, updated = self._update(context, instance, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 957, in _update\n    context, instance['uuid'], kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/db/api.py\", line 697, in instance_update_and_get_original\n    rv = IMPL.instance_update_and_get_original(context, instance_uuid, values)\n  File \"/home/berrange/src/cloud/nova/bin/nova-compute\", line 65, in __call__\n    stacktrace = \"\".join(traceback.format_stack())", 
    "tags": [], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1123219", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1123219, 
    "index": 962, 
    "created": "2013-02-12 16:27:07.542542+00:00", 
    "title": "Illegal DB access in nova-compute _sync_db_power_states method", 
    "comments": [
        {
            "content": "Boot an instance with the libvirt driver, and then use 'virsh destroy [instancename]' to kill it off behind Nova's back.\n\nNow wait a while (upto 10 minutes) for the '_sync_db_power_states' periodic task to run in nova-compute. When it does run it will generate the following exception\n\n2013-02-12 16:25:52.509 ERROR nova.compute [-] No db access allowed in nova-compute:   File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 192, in main\n    result = function(*args, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/utils.py\", line 630, in _inner\n    idle = self.f(*self.args, **self.kw)\n  File \"/home/berrange/src/cloud/nova/nova/service.py\", line 571, in periodic_tasks\n    return self.manager.periodic_tasks(ctxt, raise_on_error=raise_on_error)\n  File \"/home/berrange/src/cloud/nova/nova/manager.py\", line 229, in periodic_tasks\n    task(self, context)\n  File \"/home/berrange/src/cloud/nova/nova/compute/manager.py\", line 3425, in _sync_power_states\n    vm_power_state)\n  File \"/home/berrange/src/cloud/nova/nova/compute/manager.py\", line 3492, in _sync_instance_power_state\n    self.compute_api.stop(context, db_instance)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 158, in wrapped\n    return func(self, context, target, *args, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 148, in inner\n    return function(self, context, instance, *args, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 139, in wrapped\n    return function(self, context, instance, *args, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 129, in inner\n    return f(self, context, instance, *args, **kw)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 1236, in stop\n    progress=0)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 158, in wrapped\n    return func(self, context, target, *args, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 950, in update\n    _, updated = self._update(context, instance, **kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/compute/api.py\", line 957, in _update\n    context, instance['uuid'], kwargs)\n  File \"/home/berrange/src/cloud/nova/nova/db/api.py\", line 697, in instance_update_and_get_original\n    rv = IMPL.instance_update_and_get_original(context, instance_uuid, values)\n  File \"/home/berrange/src/cloud/nova/bin/nova-compute\", line 65, in __call__\n    stacktrace = \"\".join(traceback.format_stack())", 
            "date_created": "2013-02-12 16:27:07.542542+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/21797", 
            "date_created": "2013-02-12 17:36:18.034845+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/21797\nCommitted: http://github.com/openstack/nova/commit/959e65f320093a6b17945f52ad160da5aa042ff6\nSubmitter: Jenkins\nBranch:    master\n\ncommit 959e65f320093a6b17945f52ad160da5aa042ff6\nAuthor: Dan Smith <email address hidden>\nDate:   Tue Feb 12 12:34:39 2013 -0500\n\n    Make compute manager use conductor for stopping instances\n    \n    During _sync_power_states, the manager will call to compute_api to\n    stop instances as necessary. This takes a database hit, which isn't\n    allowed. This directs that call through conductor, following the\n    pattern of late.\n    \n    Fixes bug 1123219\n    \n    Change-Id: I5d789dd73390cb1c41a245f6594b1c3aecf7efde\n", 
            "date_created": "2013-02-13 17:36:34.518618+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}