{
    "status": "Expired", 
    "last_updated": "2016-07-05 09:47:36.059096+00:00", 
    "description": "# nova-manage db archive_deleted_rows 100000 fails with postgresql, when I do not have at least 100000 rows for archive.\n\n \n# nova delete 27d7de76-3d41-4b37-8980-2a783f8296ac\n# nova list\n+--------------------------------------+--------+--------+------------+-------------+------------------+\n| ID                                   | Name   | Status | Task State | Power State | Networks         |\n+--------------------------------------+--------+--------+------------+-------------+------------------+\n| 526d13d4-420d-4b5c-b469-bd997ef4da99 | server | ACTIVE | -          | Running     | private=10.1.0.4 |\n| d01ce4e4-a33d-4583-96a4-b9a942d08dd8 | server | ACTIVE | -          | Running     | private=10.1.0.6 |\n+--------------------------------------+--------+--------+------------+-------------+------------------+\n# /usr/bin/nova-manage db archive_deleted_rows 1 #### SUCESSS ####\n# nova delete  526d13d4-420d-4b5c-b469-bd997ef4da99\n# nova delete d01ce4e4-a33d-4583-96a4-b9a942d08dd8\n# nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n# /usr/bin/nova-manage db archive_deleted_rows 3 ##### FAILURE ####\nCommand failed, please check log for more info\n2014-04-10 13:40:06.716 CRITICAL nova [req-43b1f10f-9ece-4aae-8812-cd77f6556d38 None None] ProgrammingError: (ProgrammingError) column \"locked_by\" is of type shadow_instances0locked_by but expression is of type instances0locked_by\nLINE 1: ...ces.cell_name, instances.node, instances.deleted, instances....\n                                                             ^\nHINT:  You will need to rewrite or cast the expression.\n 'INSERT INTO shadow_instances SELECT instances.created_at, instances.updated_at, instances.deleted_at, instances.id, instances.internal_id, instances.user_id, instances.project_id, instances.image_ref, instances.kernel_id, instances.ramdisk_id, instances.launch_index, instances.key_name, instances.key_data, instances.power_state, instances.vm_state, instances.memory_mb, instances.vcpus, instances.hostname, instances.host, instances.user_data, instances.reservation_id, instances.scheduled_at, instances.launched_at, instances.terminated_at, instances.display_name, instances.display_description, instances.availability_zone, instances.locked, instances.os_type, instances.launched_on, instances.instance_type_id, instances.vm_mode, instances.uuid, instances.architecture, instances.root_device_name, instances.access_ip_v4, instances.access_ip_v6, instances.config_drive, instances.task_state, instances.default_ephemeral_device, instances.default_swap_device, instances.progress, instances.auto_disk_config, instances.shutdown_terminate, instances.disable_terminate, instances.root_gb, instances.ephemeral_gb, instances.cell_name, instances.node, instances.deleted, instances.locked_by, instances.cleaned, instances.ephemeral_key_uuid \\nFROM instances \\nWHERE instances.deleted != %(deleted_1)s ORDER BY instances.id \\n LIMIT %(param_1)s' {'param_1': 1, 'deleted_1': 0}\n2014-04-10 13:40:06.716 14789 TRACE nova Traceback (most recent call last):\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n2014-04-10 13:40:06.716 14789 TRACE nova     sys.exit(main())\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/cmd/manage.py\", line 1376, in main\n2014-04-10 13:40:06.716 14789 TRACE nova     ret = fn(*fn_args, **fn_kwargs)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/cmd/manage.py\", line 902, in archive_deleted_rows\n2014-04-10 13:40:06.716 14789 TRACE nova     db.archive_deleted_rows(admin_context, max_rows)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/db/api.py\", line 1915, in archive_deleted_rows\n2014-04-10 13:40:06.716 14789 TRACE nova     return IMPL.archive_deleted_rows(context, max_rows=max_rows)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 146, in wrapper\n2014-04-10 13:40:06.716 14789 TRACE nova     return f(*args, **kwargs)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 5647, in archive_deleted_rows\n2014-04-10 13:40:06.716 14789 TRACE nova     max_rows=max_rows - rows_archived)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 146, in wrapper\n2014-04-10 13:40:06.716 14789 TRACE nova     return f(*args, **kwargs)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 5617, in archive_deleted_rows_for_table\n2014-04-10 13:40:06.716 14789 TRACE nova     result_insert = conn.execute(insert_statement)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 662, in execute\n2014-04-10 13:40:06.716 14789 TRACE nova     params)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 761, in _execute_clauseelement\n2014-04-10 13:40:06.716 14789 TRACE nova     compiled_sql, distilled_params\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 874, in _execute_context\n2014-04-10 13:40:06.716 14789 TRACE nova     context)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1024, in _handle_dbapi_exception\n2014-04-10 13:40:06.716 14789 TRACE nova     exc_info\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/util/compat.py\", line 196, in raise_from_cause\n2014-04-10 13:40:06.716 14789 TRACE nova     reraise(type(exception), exception, tb=exc_tb)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 867, in _execute_context\n2014-04-10 13:40:06.716 14789 TRACE nova     context)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/default.py\", line 324, in do_execute\n2014-04-10 13:40:06.716 14789 TRACE nova     cursor.execute(statement, parameters)\n2014-04-10 13:40:06.716 14789 TRACE nova ProgrammingError: (ProgrammingError) column \"locked_by\" is of type shadow_instances0locked_by but expression is of type instances0locked_by\n2014-04-10 13:40:06.716 14789 TRACE nova LINE 1: ...ces.cell_name, instances.node, instances.deleted, instances....\n2014-04-10 13:40:06.716 14789 TRACE nova                                                              ^\n2014-04-10 13:40:06.716 14789 TRACE nova HINT:  You will need to rewrite or cast the expression.\n2014-04-10 13:40:06.716 14789 TRACE nova  'INSERT INTO shadow_instances SELECT instances.created_at, instances.updated_at, instances.deleted_at, instances.id, instances.internal_id, instances.user_id, instances.project_id, instances.image_ref, instances.kernel_id, instances.ramdisk_id, instances.launch_index, instances.key_name, instances.key_data, instances.power_state, instances.vm_state, instances.memory_mb, instances.vcpus, instances.hostname, instances.host, instances.user_data, instances.reservation_id, instances.scheduled_at, instances.launched_at, instances.terminated_at, instances.display_name, instances.display_description, instances.availability_zone, instances.locked, instances.os_type, instances.launched_on, instances.instance_type_id, instances.vm_mode, instances.uuid, instances.architecture, instances.root_device_name, instances.access_ip_v4, instances.access_ip_v6, instances.config_drive, instances.task_state, instances.default_ephemeral_device, instances.default_swap_device, instances.progress, instances.auto_disk_config, instances.shutdown_terminate, instances.disable_terminate, instances.root_gb, instances.ephemeral_gb, instances.cell_name, instances.node, instances.deleted, instances.locked_by, instances.cleaned, instances.ephemeral_key_uuid \\nFROM instances \\nWHERE instances.deleted != %(deleted_1)s ORDER BY instances.id \\n LIMIT %(param_1)s' {'param_1': 1, 'deleted_1': 0}\n2014-04-10 13:40:06.716 14789 TRACE nova\n\nRelevant package versions:\npostgresql-server-9.3.4-1.fc20.x86_64\npostgresql-9.3.4-1.fc20.x86_64\npostgresql-libs-9.3.4-1.fc20.x86_64\npostgresql-devel-9.3.4-1.fc20.x86_64\npython-sqlalchemy-0.8.5-1.fc20.x86_64\npython-psycopg2-2.5.1-2.fc20.x86_64", 
    "tags": [
        "db", 
        "needs-functional-test"
    ], 
    "importance": "Undecided", 
    "heat": 20, 
    "link": "https://bugs.launchpad.net/nova/+bug/1305892", 
    "owner": "None", 
    "id": 1305892, 
    "index": 4734, 
    "created": "2014-04-10 13:48:02.795155+00:00", 
    "title": "nova-manage db archive_deleted_rows fails with pgsql  on low row count", 
    "comments": [
        {
            "content": "# nova-manage db archive_deleted_rows 100000 fails with postgresql, when I do not have at least 100000 rows for archive.\n\n \n# nova delete 27d7de76-3d41-4b37-8980-2a783f8296ac\n# nova list\n+--------------------------------------+--------+--------+------------+-------------+------------------+\n| ID                                   | Name   | Status | Task State | Power State | Networks         |\n+--------------------------------------+--------+--------+------------+-------------+------------------+\n| 526d13d4-420d-4b5c-b469-bd997ef4da99 | server | ACTIVE | -          | Running     | private=10.1.0.4 |\n| d01ce4e4-a33d-4583-96a4-b9a942d08dd8 | server | ACTIVE | -          | Running     | private=10.1.0.6 |\n+--------------------------------------+--------+--------+------------+-------------+------------------+\n# /usr/bin/nova-manage db archive_deleted_rows 1 #### SUCESSS ####\n# nova delete  526d13d4-420d-4b5c-b469-bd997ef4da99\n# nova delete d01ce4e4-a33d-4583-96a4-b9a942d08dd8\n# nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n# /usr/bin/nova-manage db archive_deleted_rows 3 ##### FAILURE ####\nCommand failed, please check log for more info\n2014-04-10 13:40:06.716 CRITICAL nova [req-43b1f10f-9ece-4aae-8812-cd77f6556d38 None None] ProgrammingError: (ProgrammingError) column \"locked_by\" is of type shadow_instances0locked_by but expression is of type instances0locked_by\nLINE 1: ...ces.cell_name, instances.node, instances.deleted, instances....\n                                                             ^\nHINT:  You will need to rewrite or cast the expression.\n 'INSERT INTO shadow_instances SELECT instances.created_at, instances.updated_at, instances.deleted_at, instances.id, instances.internal_id, instances.user_id, instances.project_id, instances.image_ref, instances.kernel_id, instances.ramdisk_id, instances.launch_index, instances.key_name, instances.key_data, instances.power_state, instances.vm_state, instances.memory_mb, instances.vcpus, instances.hostname, instances.host, instances.user_data, instances.reservation_id, instances.scheduled_at, instances.launched_at, instances.terminated_at, instances.display_name, instances.display_description, instances.availability_zone, instances.locked, instances.os_type, instances.launched_on, instances.instance_type_id, instances.vm_mode, instances.uuid, instances.architecture, instances.root_device_name, instances.access_ip_v4, instances.access_ip_v6, instances.config_drive, instances.task_state, instances.default_ephemeral_device, instances.default_swap_device, instances.progress, instances.auto_disk_config, instances.shutdown_terminate, instances.disable_terminate, instances.root_gb, instances.ephemeral_gb, instances.cell_name, instances.node, instances.deleted, instances.locked_by, instances.cleaned, instances.ephemeral_key_uuid \\nFROM instances \\nWHERE instances.deleted != %(deleted_1)s ORDER BY instances.id \\n LIMIT %(param_1)s' {'param_1': 1, 'deleted_1': 0}\n2014-04-10 13:40:06.716 14789 TRACE nova Traceback (most recent call last):\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n2014-04-10 13:40:06.716 14789 TRACE nova     sys.exit(main())\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/cmd/manage.py\", line 1376, in main\n2014-04-10 13:40:06.716 14789 TRACE nova     ret = fn(*fn_args, **fn_kwargs)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/cmd/manage.py\", line 902, in archive_deleted_rows\n2014-04-10 13:40:06.716 14789 TRACE nova     db.archive_deleted_rows(admin_context, max_rows)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/db/api.py\", line 1915, in archive_deleted_rows\n2014-04-10 13:40:06.716 14789 TRACE nova     return IMPL.archive_deleted_rows(context, max_rows=max_rows)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 146, in wrapper\n2014-04-10 13:40:06.716 14789 TRACE nova     return f(*args, **kwargs)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 5647, in archive_deleted_rows\n2014-04-10 13:40:06.716 14789 TRACE nova     max_rows=max_rows - rows_archived)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 146, in wrapper\n2014-04-10 13:40:06.716 14789 TRACE nova     return f(*args, **kwargs)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 5617, in archive_deleted_rows_for_table\n2014-04-10 13:40:06.716 14789 TRACE nova     result_insert = conn.execute(insert_statement)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 662, in execute\n2014-04-10 13:40:06.716 14789 TRACE nova     params)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 761, in _execute_clauseelement\n2014-04-10 13:40:06.716 14789 TRACE nova     compiled_sql, distilled_params\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 874, in _execute_context\n2014-04-10 13:40:06.716 14789 TRACE nova     context)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1024, in _handle_dbapi_exception\n2014-04-10 13:40:06.716 14789 TRACE nova     exc_info\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/util/compat.py\", line 196, in raise_from_cause\n2014-04-10 13:40:06.716 14789 TRACE nova     reraise(type(exception), exception, tb=exc_tb)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 867, in _execute_context\n2014-04-10 13:40:06.716 14789 TRACE nova     context)\n2014-04-10 13:40:06.716 14789 TRACE nova   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/default.py\", line 324, in do_execute\n2014-04-10 13:40:06.716 14789 TRACE nova     cursor.execute(statement, parameters)\n2014-04-10 13:40:06.716 14789 TRACE nova ProgrammingError: (ProgrammingError) column \"locked_by\" is of type shadow_instances0locked_by but expression is of type instances0locked_by\n2014-04-10 13:40:06.716 14789 TRACE nova LINE 1: ...ces.cell_name, instances.node, instances.deleted, instances....\n2014-04-10 13:40:06.716 14789 TRACE nova                                                              ^\n2014-04-10 13:40:06.716 14789 TRACE nova HINT:  You will need to rewrite or cast the expression.\n2014-04-10 13:40:06.716 14789 TRACE nova  'INSERT INTO shadow_instances SELECT instances.created_at, instances.updated_at, instances.deleted_at, instances.id, instances.internal_id, instances.user_id, instances.project_id, instances.image_ref, instances.kernel_id, instances.ramdisk_id, instances.launch_index, instances.key_name, instances.key_data, instances.power_state, instances.vm_state, instances.memory_mb, instances.vcpus, instances.hostname, instances.host, instances.user_data, instances.reservation_id, instances.scheduled_at, instances.launched_at, instances.terminated_at, instances.display_name, instances.display_description, instances.availability_zone, instances.locked, instances.os_type, instances.launched_on, instances.instance_type_id, instances.vm_mode, instances.uuid, instances.architecture, instances.root_device_name, instances.access_ip_v4, instances.access_ip_v6, instances.config_drive, instances.task_state, instances.default_ephemeral_device, instances.default_swap_device, instances.progress, instances.auto_disk_config, instances.shutdown_terminate, instances.disable_terminate, instances.root_gb, instances.ephemeral_gb, instances.cell_name, instances.node, instances.deleted, instances.locked_by, instances.cleaned, instances.ephemeral_key_uuid \\nFROM instances \\nWHERE instances.deleted != %(deleted_1)s ORDER BY instances.id \\n LIMIT %(param_1)s' {'param_1': 1, 'deleted_1': 0}\n2014-04-10 13:40:06.716 14789 TRACE nova\n\nRelevant package versions:\npostgresql-server-9.3.4-1.fc20.x86_64\npostgresql-9.3.4-1.fc20.x86_64\npostgresql-libs-9.3.4-1.fc20.x86_64\npostgresql-devel-9.3.4-1.fc20.x86_64\npython-sqlalchemy-0.8.5-1.fc20.x86_64\npython-psycopg2-2.5.1-2.fc20.x86_64", 
            "date_created": "2014-04-10 13:48:02.795155+00:00", 
            "author": "https://api.launchpad.net/1.0/~afazekas"
        }, 
        {
            "content": "It is delayed-action bomb, if the test cases order changes or we add new test case it could cause high gate failure rate.\n\nThe issue reproduced here:\nhttps://review.openstack.org/#/c/100183/1", 
            "date_created": "2014-06-16 10:38:51.687714+00:00", 
            "author": "https://api.launchpad.net/1.0/~afazekas"
        }, 
        {
            "content": "message: \"RemoteError: Remote error\\: DBDeadlock (OperationalError)\" AND tags:\"screen-n-cpu.txt\"\n\nLooks like my demo change also triggered a mysql issue in the icehouse jobs:\nhttp://logs.openstack.org/83/100183/1/check/check-tempest-dsvm-full-icehouse/dd311fb/logs/screen-n-cpu.txt.gz#_2014-06-16_08_57_54_538", 
            "date_created": "2014-06-16 11:30:33.013776+00:00", 
            "author": "https://api.launchpad.net/1.0/~afazekas"
        }, 
        {
            "content": "This bug is triggered very frequently on neutron-full-pg and neutron-full-pg-2 jobs", 
            "date_created": "2014-08-18 07:19:32.491542+00:00", 
            "author": "https://api.launchpad.net/1.0/~salvatore-orlando"
        }, 
        {
            "content": "\nThis is an automated cleanup. This bug report has been closed because it\nis older than 18 months and there is no open code change to fix this.\nAfter this time it is unlikely that the circumstances which lead to\nthe observed issue can be reproduced.\n\nIf you can reproduce the bug, please:\n* reopen the bug report (set to status \"New\")\n* AND add the detailed steps to reproduce the issue (if applicable)\n* AND leave a comment \"CONFIRMED FOR: <RELEASE_NAME>\"\n  Only still supported release names are valid (LIBERTY, MITAKA, OCATA, NEWTON).\n  Valid example: CONFIRMED FOR: LIBERTY\n", 
            "date_created": "2016-07-05 09:47:35.496354+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }
    ]
}