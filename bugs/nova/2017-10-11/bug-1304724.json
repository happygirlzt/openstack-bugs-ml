{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:19:22.635632+00:00", 
    "description": "Steps to reproduce:\n- Setup a devstack from scratch using nova-network\n- delete the default network\n  # nova-manage network delete 10.0.0.0/24\n- change nova.conf to use VlanManager:\nnetwork_manager = nova.network.manager.VlanManager\n- restart nova-network\n- create a new network with a vlan id:\nnova-manage network create --label=network --fixed_range_v4 10.0.1.0/24 --vlan 42\n- boot a vm on the cirros image:\nnova --debug boot --flavor 1 --image 0b969819-2d85-4f7f-af76-125c5bb5789f test\n\nExpected behavior: The new VM goes to Active state\n\nActual behavior: The new VM goes to Error state, also nova-network log has this exception:\na7-abaf-78db50a4b62c] network allocations from (pid=13676) allocate_for_instance /opt/stack/nova/nova/network/manager.py:494\n2014-04-07 15:32:02.137 ERROR nova.network [req-87a65a9e-9196-4203-9de2-f6911d2aef4b admin demo] No db access allowed in nova-network: File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    result = function(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 128, in <lambda>\n    yield lambda: self._dispatch_and_reply(incoming)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n    incoming.message))\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n    return self._do_dispatch(endpoint, method, ctxt, args)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n    result = getattr(endpoint, method)(ctxt, **new_args)\n  File \"/opt/stack/nova/nova/network/floating_ips.py\", line 119, in allocate_for_instance\n    **kwargs)\n  File \"/opt/stack/nova/nova/network/manager.py\", line 497, in allocate_for_instance\n    requested_networks=requested_networks)\n  File \"/opt/stack/nova/nova/network/manager.py\", line 1837, in _get_networks_for_instance\n    networks = self.db.project_get_networks(context, project_id)\n  File \"/opt/stack/nova/nova/db/api.py\", line 1370, in project_get_networks\n    return IMPL.project_get_networks(context, project_id, associate)\n  File \"/opt/stack/nova/nova/cmd/network.py\", line 47, in __call__\n    stacktrace = \"\".join(traceback.format_stack())\n\nI think the exception was introduced by this patch that disables direct database access from nova-network: https://review.openstack.org/#/c/79716/\nHowever, VlanManager still relies on database access for the given scenario, and there are 3 other places in manager.py that rely on direct db access:\ndevuser@ubuntu:/opt/stack/nova$ grep self.db nova/network/manager.py -n\n1389: vifs = self.db.virtual_interface_get_by_instance(context,\n1446: vif = self.db.virtual_interface_get_by_address(context,\n1837: networks = self.db.project_get_networks(context, project_id)\n1914: not self.db.network_in_use_on_host(context, network['id'],\nTherefore, I cannot currently use conductor with nova-network VlanManager, which is a regression from Havana.\n\n===\n\ndevstack defaults the network_manager to FlatDHCPManager so we don't test VlanManager in the gate.", 
    "tags": [
        "network"
    ], 
    "importance": "High", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1304724", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1304724, 
    "index": 1469, 
    "created": "2014-04-08 23:43:09.611165+00:00", 
    "title": "DBNotAllowed raised if trying to create network with VlanManager from nova-manage network create", 
    "comments": [
        {
            "content": "Steps to reproduce:\n- Setup a devstack from scratch using nova-network\n- delete the default network\n  # nova-manage network delete 10.0.0.0/24\n- change nova.conf to use VlanManager:\nnetwork_manager = nova.network.manager.VlanManager\n- restart nova-network\n- create a new network with a vlan id:\nnova-manage network create --label=network --fixed_range_v4 10.0.1.0/24 --vlan 42\n- boot a vm on the cirros image:\nnova --debug boot --flavor 1 --image 0b969819-2d85-4f7f-af76-125c5bb5789f test\n\nExpected behavior: The new VM goes to Active state\n\nActual behavior: The new VM goes to Error state, also nova-network log has this exception:\na7-abaf-78db50a4b62c] network allocations from (pid=13676) allocate_for_instance /opt/stack/nova/nova/network/manager.py:494\n2014-04-07 15:32:02.137 ERROR nova.network [req-87a65a9e-9196-4203-9de2-f6911d2aef4b admin demo] No db access allowed in nova-network: File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    result = function(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 128, in <lambda>\n    yield lambda: self._dispatch_and_reply(incoming)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n    incoming.message))\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n    return self._do_dispatch(endpoint, method, ctxt, args)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n    result = getattr(endpoint, method)(ctxt, **new_args)\n  File \"/opt/stack/nova/nova/network/floating_ips.py\", line 119, in allocate_for_instance\n    **kwargs)\n  File \"/opt/stack/nova/nova/network/manager.py\", line 497, in allocate_for_instance\n    requested_networks=requested_networks)\n  File \"/opt/stack/nova/nova/network/manager.py\", line 1837, in _get_networks_for_instance\n    networks = self.db.project_get_networks(context, project_id)\n  File \"/opt/stack/nova/nova/db/api.py\", line 1370, in project_get_networks\n    return IMPL.project_get_networks(context, project_id, associate)\n  File \"/opt/stack/nova/nova/cmd/network.py\", line 47, in __call__\n    stacktrace = \"\".join(traceback.format_stack())\n\nI think the exception was introduced by this patch that disables direct database access from nova-network: https://review.openstack.org/#/c/79716/\nHowever, VlanManager still relies on database access for the given scenario, and there are 3 other places in manager.py that rely on direct db access:\ndevuser@ubuntu:/opt/stack/nova$ grep self.db nova/network/manager.py -n\n1389: vifs = self.db.virtual_interface_get_by_instance(context,\n1446: vif = self.db.virtual_interface_get_by_address(context,\n1837: networks = self.db.project_get_networks(context, project_id)\n1914: not self.db.network_in_use_on_host(context, network['id'],\nTherefore, I cannot currently use conductor with nova-network VlanManager, which is a regression from Havana.\n\n===\n\ndevstack defaults the network_manager to FlatDHCPManager so we don't test VlanManager in the gate.", 
            "date_created": "2014-04-08 23:43:09.611165+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Patch is here: https://review.openstack.org/#/c/86190/", 
            "date_created": "2014-04-09 00:09:28.002963+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: milestone-proposed\nReview: https://review.openstack.org/86194", 
            "date_created": "2014-04-09 00:22:35.345173+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/86190\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=275a165cf0e74112d7ec9addacb1f84d703977c8\nSubmitter: Jenkins\nBranch:    master\n\ncommit 275a165cf0e74112d7ec9addacb1f84d703977c8\nAuthor: Dan Smith <email address hidden>\nDate:   Tue Apr 8 16:55:43 2014 -0700\n\n    Fix straggling uses of direct-to-database queries in nova-network\n    \n    There were a few remaining calls directly to the database module\n    left in nova-network. These would fail because of the wedge we\n    put in place specifically to catch this case. However, we don't\n    test VlanManager in the gate, which means we didn't catch them\n    until now.\n    \n    This required adding two more methods, one each to Network and\n    NetworkList, but they are both extremely simple.\n    \n    Change-Id: Iecc382074f060da1bd6f740d7bde0b20a0be2fcf\n    Closes-bug: #1304724\n", 
            "date_created": "2014-04-09 02:33:43.858021+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/86194\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=51992642c09cf09cef7ea0efe8a9ed6fbdfdf02d\nSubmitter: Jenkins\nBranch:    milestone-proposed\n\ncommit 51992642c09cf09cef7ea0efe8a9ed6fbdfdf02d\nAuthor: Dan Smith <email address hidden>\nDate:   Tue Apr 8 16:55:43 2014 -0700\n\n    Fix straggling uses of direct-to-database queries in nova-network\n    \n    There were a few remaining calls directly to the database module\n    left in nova-network. These would fail because of the wedge we\n    put in place specifically to catch this case. However, we don't\n    test VlanManager in the gate, which means we didn't catch them\n    until now.\n    \n    This required adding two more methods, one each to Network and\n    NetworkList, but they are both extremely simple.\n    \n    Change-Id: Iecc382074f060da1bd6f740d7bde0b20a0be2fcf\n    Closes-bug: #1304724\n    (cherry picked from commit 275a165cf0e74112d7ec9addacb1f84d703977c8)\n", 
            "date_created": "2014-04-09 08:52:56.334396+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}