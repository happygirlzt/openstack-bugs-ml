{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:40:42.320952+00:00", 
    "description": "After evacuate a host with one instance to a target host it still report there is an instance in that hypervisor\n\nPre evacuate report:\n\n$ nova hypervisor-stats\n+----------------------+-------+\n| Property             | Value |\n+----------------------+-------+\n| count                | 2     |\n| current_workload     | 0     |\n| disk_available_least | 22    |\n| free_disk_gb         | 50    |\n| free_ram_mb          | 3860  |\n| local_gb             | 50    |\n| local_gb_used        | 0     |\n| memory_mb            | 4948  |\n| memory_mb_used       | 1088  |\n| running_vms          | 1     |\n| vcpus                | 3     |\n| vcpus_used           | 1     |\n+----------------------+-------+\n\n$ nova hypervisor-list\n+----+---------------------+\n| ID | Hypervisor hostname |\n+----+---------------------+\n| 1  | jmolle-Controller   |\n| 2  | jmolle-Node1        |\n+----+---------------------+\n\n$ nova hypervisor-show jmolle-Controller\n+---------------------------+-------------------------------------------------------+\n| Property                  | Value                                                 |\n+---------------------------+-------------------------------------------------------+\n| cpu_info_arch             | x86_64                                                |\n| cpu_info_features         | [\"rdtscp\", \"hypervisor\", \"x2apic\", \"ss\", \"ds\", \"vme\"] |\n| cpu_info_model            | Westmere                                              |\n| cpu_info_topology_cores   | 1                                                     |\n| cpu_info_topology_sockets | 2                                                     |\n| cpu_info_topology_threads | 1                                                     |\n| cpu_info_vendor           | Intel                                                 |\n| current_workload          | 0                                                     |\n| disk_available_least      | 10                                                    |\n| free_disk_gb              | 25                                                    |\n| free_ram_mb               | 3378                                                  |\n| host_ip                   | 192.168.41.101                                        |\n| hypervisor_hostname       | jmolle-Controller                                     |\n| hypervisor_type           | QEMU                                                  |\n| hypervisor_version        | 1000000                                               |\n| id                        | 1                                                     |\n| local_gb                  | 25                                                    |\n| local_gb_used             | 0                                                     |\n| memory_mb                 | 3954                                                  |\n| memory_mb_used            | 576                                                   |\n| running_vms               | 1                                                     |\n| service_host              | jmolle-Controller                                     |\n| service_id                | 4                                                     |\n| vcpus                     | 2                                                     |\n| vcpus_used                | 1                                                     |\n+---------------------------+-------------------------------------------------------+\n\n$ nova hypervisor-servers jmolle-Controller\n+--------------------------------------+-------------------+---------------+---------------------+\n| ID                                   | Name              | Hypervisor ID | Hypervisor Hostname |\n+--------------------------------------+-------------------+---------------+---------------------+\n| a3c291e5-05b0-43fc-b16b-121bf36f30c0 | instance-00000001 | 1             | jmolle-Controller   |\n+--------------------------------------+-------------------+---------------+---------------------+\n\n\nBut after evacuate the instanse we get:\n\n$ nova hypervisor-stats\n+----------------------+-------+\n| Property             | Value |\n+----------------------+-------+\n| count                | 2     |\n| current_workload     | 1     |\n| disk_available_least | 22    |\n| free_disk_gb         | 50    |\n| free_ram_mb          | 3796  |\n| local_gb             | 50    |\n| local_gb_used        | 0     |\n| memory_mb            | 4948  |\n| memory_mb_used       | 1152  |\n| running_vms          | 2     |\n| vcpus                | 3     |\n| vcpus_used           | 2     |\n+----------------------+-------+\n\nhere we see that now there are 2 running instances instead of one\nand if we use show command we get:\n\n$ nova hypervisor-show jmolle-Controller\n+---------------------------+-------------------------------------------------------+\n| Property                  | Value                                                 |\n+---------------------------+-------------------------------------------------------+\n| cpu_info_arch             | x86_64                                                |\n| cpu_info_features         | [\"rdtscp\", \"hypervisor\", \"x2apic\", \"ss\", \"ds\", \"vme\"] |\n| cpu_info_model            | Westmere                                              |\n| cpu_info_topology_cores   | 1                                                     |\n| cpu_info_topology_sockets | 2                                                     |\n| cpu_info_topology_threads | 1                                                     |\n| cpu_info_vendor           | Intel                                                 |\n| current_workload          | 0                                                     |\n| disk_available_least      | 10                                                    |\n| free_disk_gb              | 25                                                    |\n| free_ram_mb               | 3378                                                  |\n| host_ip                   | 192.168.41.101                                        |\n| hypervisor_hostname       | jmolle-Controller                                     |\n| hypervisor_type           | QEMU                                                  |\n| hypervisor_version        | 1000000                                               |\n| id                        | 1                                                     |\n| local_gb                  | 25                                                    |\n| local_gb_used             | 0                                                     |\n| memory_mb                 | 3954                                                  |\n| memory_mb_used            | 576                                                   |\n| running_vms               | 1                                                     |\n| service_host              | jmolle-Controller                                     |\n| service_id                | 4                                                     |\n| vcpus                     | 2                                                     |\n| vcpus_used                | 1                                                     |\n+---------------------------+-------------------------------------------------------+\n\nwe also see 1 running instance\nbut if we list servers we get 0\n\n$ nova hypervisor-servers jmolle-Controller\n+----+------+---------------+---------------------+\n| ID | Name | Hypervisor ID | Hypervisor Hostname |\n+----+------+---------------+---------------------+\n+----+------+---------------+---------------------+\n\nand the instance was evacuate to the other host correctly\n\n$ nova hypervisor-servers jmolle-Node1\n+--------------------------------------+-------------------+---------------+---------------------+\n| ID                                   | Name              | Hypervisor ID | Hypervisor Hostname |\n+--------------------------------------+-------------------+---------------+---------------------+\n| a3c291e5-05b0-43fc-b16b-121bf36f30c0 | instance-00000001 | 2             | jmolle-Node1        |\n+--------------------------------------+-------------------+---------------+---------------------+\n\nI think this is a nova bug due to the inconcistency of hypervisor-show and hypervisor-servers nova commands", 
    "tags": [
        "api", 
        "compute"
    ], 
    "importance": "Low", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1285259", 
    "owner": "https://api.launchpad.net/1.0/~yunhong-jiang", 
    "id": 1285259, 
    "index": 6070, 
    "created": "2014-02-26 17:07:16.919728+00:00", 
    "title": "After evacuate origin host still report a runing vm", 
    "comments": [
        {
            "content": "After evacuate a host with one instance to a target host it still report there is an instance in that hypervisor\n\nPre evacuate report:\n\n$ nova hypervisor-stats\n+----------------------+-------+\n| Property             | Value |\n+----------------------+-------+\n| count                | 2     |\n| current_workload     | 0     |\n| disk_available_least | 22    |\n| free_disk_gb         | 50    |\n| free_ram_mb          | 3860  |\n| local_gb             | 50    |\n| local_gb_used        | 0     |\n| memory_mb            | 4948  |\n| memory_mb_used       | 1088  |\n| running_vms          | 1     |\n| vcpus                | 3     |\n| vcpus_used           | 1     |\n+----------------------+-------+\n\n$ nova hypervisor-list\n+----+---------------------+\n| ID | Hypervisor hostname |\n+----+---------------------+\n| 1  | jmolle-Controller   |\n| 2  | jmolle-Node1        |\n+----+---------------------+\n\n$ nova hypervisor-show jmolle-Controller\n+---------------------------+-------------------------------------------------------+\n| Property                  | Value                                                 |\n+---------------------------+-------------------------------------------------------+\n| cpu_info_arch             | x86_64                                                |\n| cpu_info_features         | [\"rdtscp\", \"hypervisor\", \"x2apic\", \"ss\", \"ds\", \"vme\"] |\n| cpu_info_model            | Westmere                                              |\n| cpu_info_topology_cores   | 1                                                     |\n| cpu_info_topology_sockets | 2                                                     |\n| cpu_info_topology_threads | 1                                                     |\n| cpu_info_vendor           | Intel                                                 |\n| current_workload          | 0                                                     |\n| disk_available_least      | 10                                                    |\n| free_disk_gb              | 25                                                    |\n| free_ram_mb               | 3378                                                  |\n| host_ip                   | 192.168.41.101                                        |\n| hypervisor_hostname       | jmolle-Controller                                     |\n| hypervisor_type           | QEMU                                                  |\n| hypervisor_version        | 1000000                                               |\n| id                        | 1                                                     |\n| local_gb                  | 25                                                    |\n| local_gb_used             | 0                                                     |\n| memory_mb                 | 3954                                                  |\n| memory_mb_used            | 576                                                   |\n| running_vms               | 1                                                     |\n| service_host              | jmolle-Controller                                     |\n| service_id                | 4                                                     |\n| vcpus                     | 2                                                     |\n| vcpus_used                | 1                                                     |\n+---------------------------+-------------------------------------------------------+\n\n$ nova hypervisor-servers jmolle-Controller\n+--------------------------------------+-------------------+---------------+---------------------+\n| ID                                   | Name              | Hypervisor ID | Hypervisor Hostname |\n+--------------------------------------+-------------------+---------------+---------------------+\n| a3c291e5-05b0-43fc-b16b-121bf36f30c0 | instance-00000001 | 1             | jmolle-Controller   |\n+--------------------------------------+-------------------+---------------+---------------------+\n\n\nBut after evacuate the instanse we get:\n\n$ nova hypervisor-stats\n+----------------------+-------+\n| Property             | Value |\n+----------------------+-------+\n| count                | 2     |\n| current_workload     | 1     |\n| disk_available_least | 22    |\n| free_disk_gb         | 50    |\n| free_ram_mb          | 3796  |\n| local_gb             | 50    |\n| local_gb_used        | 0     |\n| memory_mb            | 4948  |\n| memory_mb_used       | 1152  |\n| running_vms          | 2     |\n| vcpus                | 3     |\n| vcpus_used           | 2     |\n+----------------------+-------+\n\nhere we see that now there are 2 running instances instead of one\nand if we use show command we get:\n\n$ nova hypervisor-show jmolle-Controller\n+---------------------------+-------------------------------------------------------+\n| Property                  | Value                                                 |\n+---------------------------+-------------------------------------------------------+\n| cpu_info_arch             | x86_64                                                |\n| cpu_info_features         | [\"rdtscp\", \"hypervisor\", \"x2apic\", \"ss\", \"ds\", \"vme\"] |\n| cpu_info_model            | Westmere                                              |\n| cpu_info_topology_cores   | 1                                                     |\n| cpu_info_topology_sockets | 2                                                     |\n| cpu_info_topology_threads | 1                                                     |\n| cpu_info_vendor           | Intel                                                 |\n| current_workload          | 0                                                     |\n| disk_available_least      | 10                                                    |\n| free_disk_gb              | 25                                                    |\n| free_ram_mb               | 3378                                                  |\n| host_ip                   | 192.168.41.101                                        |\n| hypervisor_hostname       | jmolle-Controller                                     |\n| hypervisor_type           | QEMU                                                  |\n| hypervisor_version        | 1000000                                               |\n| id                        | 1                                                     |\n| local_gb                  | 25                                                    |\n| local_gb_used             | 0                                                     |\n| memory_mb                 | 3954                                                  |\n| memory_mb_used            | 576                                                   |\n| running_vms               | 1                                                     |\n| service_host              | jmolle-Controller                                     |\n| service_id                | 4                                                     |\n| vcpus                     | 2                                                     |\n| vcpus_used                | 1                                                     |\n+---------------------------+-------------------------------------------------------+\n\nwe also see 1 running instance\nbut if we list servers we get 0\n\n$ nova hypervisor-servers jmolle-Controller\n+----+------+---------------+---------------------+\n| ID | Name | Hypervisor ID | Hypervisor Hostname |\n+----+------+---------------+---------------------+\n+----+------+---------------+---------------------+\n\nand the instance was evacuate to the other host correctly\n\n$ nova hypervisor-servers jmolle-Node1\n+--------------------------------------+-------------------+---------------+---------------------+\n| ID                                   | Name              | Hypervisor ID | Hypervisor Hostname |\n+--------------------------------------+-------------------+---------------+---------------------+\n| a3c291e5-05b0-43fc-b16b-121bf36f30c0 | instance-00000001 | 2             | jmolle-Node1        |\n+--------------------------------------+-------------------+---------------+---------------------+\n\nI think this is a nova bug due to the inconcistency of hypervisor-show and hypervisor-servers nova commands", 
            "date_created": "2014-02-26 17:07:16.919728+00:00", 
            "author": "https://api.launchpad.net/1.0/~juan-m-olle"
        }, 
        {
            "content": "Additional info.\n\nafter evacuate the database query \n\nselect hypervisor_hostname,running_vms from compute_nodes;\n\nreport \n\n+---------------------+-------------+\n| hypervisor_hostname | running_vms |\n+---------------------+-------------+\n| jmolle-Controller   |           1 |\n| jmolle-Node1        |           1 |\n+---------------------+-------------+\n\nbut as soon as the compute node goes up, it update the database reportin running_vm = 0\n\nshould the evacuate command if it is succesful update the compute node to report that no instance is running?\n", 
            "date_created": "2014-02-28 15:33:03.770365+00:00", 
            "author": "https://api.launchpad.net/1.0/~juan-m-olle"
        }, 
        {
            "content": "I think there are in fact two things in this bug:\n\na) When \"nova hypervisor-stats\", we should not return the caculation for compute nodes that the corresponding compute service is disabled already.\n\nb) when \"nova hypervisor-show\", it will be better to return the state of the compute node. But I'm not very sure if that needed because user can still get such information by \"nova service-list\", but I think return the state will be helpful.\n\nI don't think we can catch change b) for I release, so I will firstly try to cook a patch for item a).\n\nThanks\n--jyh", 
            "date_created": "2014-03-11 21:52:00.372491+00:00", 
            "author": "https://api.launchpad.net/1.0/~yunhong-jiang"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/80707", 
            "date_created": "2014-03-14 21:43:43.604690+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/80708", 
            "date_created": "2014-03-14 21:43:57.529784+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/80708\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8cd2b890710ba6e53884f43b5d6ce095672732a4\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8cd2b890710ba6e53884f43b5d6ce095672732a4\nAuthor: Yunhong Jiang <email address hidden>\nDate:   Thu Mar 13 16:29:26 2014 -0700\n\n    Not count disabled compute node for statistics\n    \n    No server will be scheduled to disabled compute service, thus we\n    should not count the corresponding compute node information.\n    \n    It's arguable if we should count for 'down' service, since service\n    may be marked down because of communication error. If we do want to\n    exclude the down service, we need passing the information from caller\n    because the up/down state is not kepts in database, and it means compute\n    and cell api changes.\n    \n    Closes-Bug: #1285259\n    \n    Change-Id: I5e3e71ef30683c5eb5cc4462f58fa5f29d7c3f4b\n", 
            "date_created": "2014-07-15 00:06:53.894945+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/80707\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7d8a78a29128debe7ed49bea394f952f37cee498\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7d8a78a29128debe7ed49bea394f952f37cee498\nAuthor: Yunhong Jiang <email address hidden>\nDate:   Thu Mar 13 15:09:34 2014 -0700\n\n    Return status for compute node\n    \n    Currently when return compute node information, there is no status returned.\n    \n    When the corresponding service is disabled or down and users try to\n    do 'hypervisor-list' or 'hypervisor-show', they will have no idea of it.\n    \n    Implements: blueprint return-status-for-hypervisor-node\n    Closes-Bug: #1285259\n    \n    DocImpact\n    \n    Change-Id: I17c53b454ccef023f298f1b8875daef965d2325d\n", 
            "date_created": "2014-07-22 21:01:20.702195+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}