{
    "status": "Invalid", 
    "last_updated": "2017-09-28 06:57:23.281103+00:00", 
    "description": "Dear colleagues,\n\nwhen I change port admin state to DOWN, this is not reflected accordingly on VM's side:\n\n$ openstack port set --disable n1-lan\n$ openstack port show n1-lan\n[ ... ]\n+-----------------------+------------+\n| Field                 | Value      |\n+-----------------------+------------+\n| admin_state_up        | DOWN       |\n[ ... ]\n+-----------------------+------------+\n\nroot@n1:~# ip a\n[ ... ]\n3: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000\n\nBUT when using \"virsh domif-setlink --domain <domID> --interface <MAC> --state down\" I'm getting correct \"NO-CARRIER\" signaling on the port:\n\n3: eth0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1450 qdisc pfifo_fast state DOWN group default qlen 1000\n\nPossibly, Nova misses messages from Neutron about port admin state change. Is it bug or feature and can this be fixed?\n\nMy environment:\n\nOpenstack version: Pike\nHost OS: Ubuntu 16.04.3\nNova: 16.0.0-0ubuntu1~cloud0\nNeutron: 11.0.0-0ubuntu1~cloud0\nNetworking: Openvswitch 2.8.0-0ubuntu1~cloud0\nHypevisor: Libvirt+KVM\nStorage: CEPH 12.2.0-0ubuntu1~cloud0\n\nThank you.", 
    "tags": [
        "neutron", 
        "openstack-version.pike"
    ], 
    "importance": "Wishlist", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1719261", 
    "owner": "None", 
    "id": 1719261, 
    "index": 1887, 
    "created": "2017-09-25 08:02:23.726984+00:00", 
    "title": "VM port state don't match Neutron's port admin state", 
    "comments": [
        {
            "content": "Dear colleagues,\n\nwhen I change port admin state to DOWN, this is not reflected accordingly on VM's side:\n\n$ openstack port set --disable n1-lan\n$ openstack port show n1-lan\n[ ... ]\n+-----------------------+------------+\n| Field                 | Value      |\n+-----------------------+------------+\n| admin_state_up        | DOWN       |\n[ ... ]\n+-----------------------+------------+\n\nroot@n1:~# ip a\n[ ... ]\n3: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000\n\nBUT when using \"virsh domif-setlink --domain <domID> --interface <MAC> --state down\" I'm getting correct \"NO-CARRIER\" signaling on the port:\n\n3: eth0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1450 qdisc pfifo_fast state DOWN group default qlen 1000\n\nPossibly, Nova misses messages from Neutron about port admin state change. Is it bug or feature and can this be fixed?\n\nMy environment:\n\nOpenstack version: Pike\nHost OS: Ubuntu 16.04.3\nNova: 16.0.0-0ubuntu1~cloud0\nNeutron: 11.0.0-0ubuntu1~cloud0\nNetworking: Openvswitch 2.8.0-0ubuntu1~cloud0\nHypevisor: Libvirt+KVM\nStorage: CEPH 12.2.0-0ubuntu1~cloud0\n\nThank you.", 
            "date_created": "2017-09-25 08:02:23.726984+00:00", 
            "author": "https://api.launchpad.net/1.0/~doka.ua"
        }, 
        {
            "content": "There is a config option in neutron.conf that makes Neutron sending callbacks to Nova when a port state is changed, namely [DEFAULT]/notify_nova_on_port_status_changes\n\nBy default, this is True so that should mean Neutron should send the events, but can you please make sure that is still valid for your deployment ?\n\nAlso, Neutron uses a specific admin-only Nova REST API resource for sending those callbacks. See https://developer.openstack.org/api-ref/compute/#create-external-events-os-server-external-events\n\nIf I were you, I'd look at the nova API logs to see if I'm able to see calls from Neutron, in particular if you check the n-api logs at the same time you issue the Neutron command.\n\nPlease come back to us and tell us if you're able to see those logs, and if so, what Nova provides as a response code.", 
            "date_created": "2017-09-25 13:29:16.542503+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "Dear Sylvain,\n\n1) configuration in neutron.conf (on all my hosts) contains the \nfollowing entries:\nnotify_nova_on_port_status_changes = true\nnotify_nova_on_port_data_changes = true\n\n2) I issue \"openstack port set --disable jex-vpn-lan\" on host \n\"lagavulin\", guest VM resides on host \"bowmore\" and logs show me the \nfollowing:\n\n*Host \"**l**agavulin\"**, nova-api.log**:*\n2017-09-26 09:25:55.199 2674 INFO \nnova.api.openstack.compute.server_external_events \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] Creating event \nnetwork-changed:32a3b619-d75c-46ce-8187-3d2eba77404f for instance \n05d155a2-1d8a-4327-8625-a94628767939 on *bowmore*\n2017-09-26 09:25:55.205 2674 INFO nova.osapi_compute.wsgi.server \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] 10.0.10.10 \"POST /v2.1/os-server-external-events \nHTTP/1.1\" status: 200 len: 554 time: 0.1836071\n========================\n\n*Host \"bowmore\", nova-compute.log :*\n2017-09-26 09:25:55.211 16766 DEBUG nova.compute.manager \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] [instance: 05d155a2-1d8a-4327-8625-a94628767939] \nReceived event network-changed-32a3b619-d75c-46ce-8187-3d2eba77404f \nexternal_instance_event \n/usr/lib/python2.7/dist-packages/nova/compute/manager.py:6957\n2017-09-26 09:25:55.212 16766 DEBUG oslo_concurrency.lockutils \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] Acquired semaphore \n\"refresh_cache-05d155a2-1d8a-4327-8625-a94628767939\" lock \n/usr/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py:215\n2017-09-26 09:25:55.213 16766 DEBUG nova.network.neutronv2.api \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] [instance: 05d155a2-1d8a-4327-8625-a94628767939] \n_get_instance_nw_info() _get_instance_nw_info \n/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py:1302\n2017-09-26 09:25:55.699 16766 DEBUG nova.network.base_api \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] [instance: 05d155a2-1d8a-4327-8625-a94628767939] \nUpdating instance_info_cache with network_info: [{\"profile\": {}, \n\"ovs_interfaceid\": \"b983f7d0-37a5-42de-9d2f-feb27f219c75\", \n\"preserve_on_delete\": true, \"network\": {\"bridge\": \"br-int\", \"subnets\": \n[{\"ips\": [{\"meta\": {}, \"version\": 4, \"type\": \"fixed\", \"floating_ips\": \n[], \"address\": \"51.255.0.249\"}], \"version\": 4, \"meta\": {\"dhcp_server\": \n\"51.255.0.250\"}, \"dns\": [{\"meta\": {}, \"version\": 4, \"type\": \"dns\", \n\"address\": \"8.8.8.8\"}], \"routes\": [], \"cidr\": \"51.255.0.240/28\", \n\"gateway\": {\"meta\": {}, \"version\": 4, \"type\": \"gateway\", \"address\": \n\"51.255.0.254\"}}], \"meta\": {\"injected\": false, \"tenant_id\": \n\"795504a0e45346d7ba0a016de877e725\", \"mtu\": 1500}, \"id\": \n\"00f47a44-8f85-482b-b2a9-aeeff8dfd29d\", \"label\": \"e-net\"}, \"devname\": \n\"tapb983f7d0-37\", \"vnic_type\": \"normal\", \"qbh_params\": null, \"meta\": {}, \n\"details\": {\"port_filter\": true, \"datapath_type\": \"system\", \n\"ovs_hybrid_plug\": false}, \"address\": \"d0:1c:a0:e3:01:e2\", \"active\": \ntrue, \"type\": \"ovs\", \"id\": \"b983f7d0-37a5-42de-9d2f-feb27f219c75\", \n\"qbg_params\": null}, {\"profile\": {}, \"ovs_interfaceid\": \n\"32a3b619-d75c-46ce-8187-3d2eba77404f\", \"preserve_on_delete\": true, \n\"network\": {\"bridge\": \"br-int\", \"subnets\": [{\"ips\": [{\"meta\": {}, \n\"version\": 4, \"type\": \"fixed\", \"floating_ips\": [], \"address\": \n\"1.1.1.2\"}], \"version\": 4, \"meta\": {\"dhcp_server\": \"1.1.1.9\"}, \"dns\": \n[{\"meta\": {}, \"version\": 4, \"type\": \"dns\", \"address\": \"8.8.4.4\"}], \n\"routes\": [{\"interface\": null, \"cidr\": \"1.1.2.0/24\", \"meta\": {}, \n\"gateway\": {\"meta\": {}, \"version\": 4, \"type\": \"gateway\", \"address\": \n\"1.1.1.2\"}}, {\"interface\": null, \"cidr\": \"1.1.3.0/24\", \"meta\": {}, \n\"gateway\": {\"meta\": {}, \"version\": 4, \"type\": \"gateway\", \"address\": \n\"1.1.1.2\"}}], \"cidr\": \"1.1.1.0/24\", \"gateway\": {\"meta\": {}, \"version\": \n4, \"type\": \"gateway\", \"address\": \"1.1.1.1\"}}], \"meta\": {\"injected\": \nfalse, \"tenant_id\": \"d8051a3ff3ad4c4bb380f828992b8178\", \"mtu\": 1450}, \n\"id\": \"4e6c23c1-e501-4fac-82a5-e8c66c439eba\", \"label\": \"jex-net\"}, \n\"devname\": \"tap32a3b619-d7\", \"vnic_type\": \"normal\", \"qbh_params\": null, \n\"meta\": {}, \"details\": {\"port_filter\": true, \"datapath_type\": \"system\", \n\"ovs_hybrid_plug\": false}, \"address\": \"d0:1c:a0:84:85:f1\", \"active\": \ntrue, \"type\": \"ovs\", \"id\": \"32a3b619-d75c-46ce-8187-3d2eba77404f\", \n\"qbg_params\": null}] update_instance_cache_with_nw_info \n/usr/lib/python2.7/dist-packages/nova/network/base_api.py:48\n2017-09-26 09:25:55.717 16766 DEBUG oslo_concurrency.lockutils \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] Releasing semaphore \n\"refresh_cache-05d155a2-1d8a-4327-8625-a94628767939\" lock \n/usr/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py:228\n==================\n\nSo, it's clear that event is generated and received on corresponding \ncompute node. Please, give next steps for narrowing the problem.\n\nThank you.\n\nOn 9/25/17 4:29 PM, Sylvain Bauza wrote:\n> There is a config option in neutron.conf that makes Neutron sending\n> callbacks to Nova when a port state is changed, namely\n> [DEFAULT]/notify_nova_on_port_status_changes\n>\n> By default, this is True so that should mean Neutron should send the\n> events, but can you please make sure that is still valid for your\n> deployment ?\n>\n> Also, Neutron uses a specific admin-only Nova REST API resource for\n> sending those callbacks. See https://developer.openstack.org/api-\n> ref/compute/#create-external-events-os-server-external-events\n>\n> If I were you, I'd look at the nova API logs to see if I'm able to see\n> calls from Neutron, in particular if you check the n-api logs at the\n> same time you issue the Neutron command.\n>\n> Please come back to us and tell us if you're able to see those logs, and\n> if so, what Nova provides as a response code.\n>\n> ** Tags added: openstack-version.pike\n>\n> ** Tags added: neutron\n>\n\n-- \nVolodymyr Litovka\n   \"Vision without Execution is Hallucination.\" -- Thomas Edison\n\n", 
            "date_created": "2017-09-26 10:03:56+00:00", 
            "author": "https://api.launchpad.net/1.0/~doka.ua"
        }, 
        {
            "content": "And in case if it can be required -\n\n$ openstack port show jex-vpn-lan\n+-----------------------+------------------------------------------------------------------------+\n| Field\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | Value |\n+-----------------------+------------------------------------------------------------------------+\n| admin_state_up\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | UP |\n| allowed_address_pairs | |\n| binding_host_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | bowmore |\n| binding_profile | |\n| binding_vif_details\u00a0\u00a0 | datapath_type='system', \novs_hybrid_plug='False', port_filter='True'\u00a0\u00a0\u00a0 |\n| binding_vif_type\u00a0\u00a0\u00a0\u00a0\u00a0 | ovs |\n| binding_vnic_type\u00a0\u00a0\u00a0\u00a0 | normal |\n| created_at\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | 2017-09-26T10:38:36Z |\n| data_plane_status\u00a0\u00a0\u00a0\u00a0 | None |\n| description | |\n| device_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | a97c3560-c3ed-40a9-a74f-9f54a3a02efe |\n| device_owner\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | compute:nova |\n| dns_assignment\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| dns_name\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| extra_dhcp_opts | |\n| fixed_ips\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | ip_address='1.1.1.2', \nsubnet_id='35321920-9ebe-43e5-b653-d4e010357016' |\n| id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | 5dd6c55f-e31d-4ee4-a3a4-4cca85932c58 |\n| ip_address\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| mac_address\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | d0:1c:a0:27:96:29 |\n| name\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | jex-vpn-lan |\n| network_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | a6889483-ee1b-46b6-a770-8db453be4195 |\n| option_name\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| option_value\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| port_security_enabled | False |\n| project_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | d8051a3ff3ad4c4bb380f828992b8178 |\n| qos_policy_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| revision_number\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | 6 |\n| security_group_ids | |\n| status\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | ACTIVE |\n| subnet_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| tags | |\n| trunk_details\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| updated_at\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | 2017-09-26T10:38:46Z |\n+-----------------------+------------------------------------------------------------------------+\n\nOn 9/26/17 1:03 PM, Volodymyr Litovka wrote:\n> Dear Sylvain,\n>\n> 1) configuration in neutron.conf (on all my hosts) contains the \n> following entries:\n> notify_nova_on_port_status_changes = true\n> notify_nova_on_port_data_changes = true\n>\n> 2) I issue \"openstack port set --disable jex-vpn-lan\" on host \n> \"lagavulin\", guest VM resides on host \"bowmore\" and logs show me the \n> following:\n>\n> *Host \"**l**agavulin\"**, nova-api.log**:*\n> 2017-09-26 09:25:55.199 2674 INFO \n> nova.api.openstack.compute.server_external_events \n> [req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n> 5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \n> default default] Creating event \n> network-changed:32a3b619-d75c-46ce-8187-3d2eba77404f for instance \n> 05d155a2-1d8a-4327-8625-a94628767939 on *bowmore*\n> 2017-09-26 09:25:55.205 2674 INFO nova.osapi_compute.wsgi.server \n> [req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n> 5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \n> default default] 10.0.10.10 \"POST /v2.1/os-server-external-events \n> HTTP/1.1\" status: 200 len: 554 time: 0.1836071\n> ========================\n>\n> *Host \"bowmore\", nova-compute.log :*\n> 2017-09-26 09:25:55.211 16766 DEBUG nova.compute.manager \n> [req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n> 5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \n> default default] [instance: 05d155a2-1d8a-4327-8625-a94628767939] \n> Received event network-changed-32a3b619-d75c-46ce-8187-3d2eba77404f \n> external_instance_event \n> /usr/lib/python2.7/dist-packages/nova/compute/manager.py:6957\n> 2017-09-26 09:25:55.212 16766 DEBUG oslo_concurrency.lockutils \n> [req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n> 5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \n> default default] Acquired semaphore \n> \"refresh_cache-05d155a2-1d8a-4327-8625-a94628767939\" lock \n> /usr/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py:215\n> 2017-09-26 09:25:55.213 16766 DEBUG nova.network.neutronv2.api \n> [req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n> 5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \n> default default] [instance: 05d155a2-1d8a-4327-8625-a94628767939] \n> _get_instance_nw_info() _get_instance_nw_info \n> /usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py:1302\n> 2017-09-26 09:25:55.699 16766 DEBUG nova.network.base_api \n> [req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n> 5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \n> default default] [instance: 05d155a2-1d8a-4327-8625-a94628767939] \n> Updating instance_info_cache with network_info: [{\"profile\": {}, \n> \"ovs_interfaceid\": \"b983f7d0-37a5-42de-9d2f-feb27f219c75\", \n> \"preserve_on_delete\": true, \"network\": {\"bridge\": \"br-int\", \"subnets\": \n> [{\"ips\": [{\"meta\": {}, \"version\": 4, \"type\": \"fixed\", \"floating_ips\": \n> [], \"address\": \"51.255.0.249\"}], \"version\": 4, \"meta\": {\"dhcp_server\": \n> \"51.255.0.250\"}, \"dns\": [{\"meta\": {}, \"version\": 4, \"type\": \"dns\", \n> \"address\": \"8.8.8.8\"}], \"routes\": [], \"cidr\": \"51.255.0.240/28\", \n> \"gateway\": {\"meta\": {}, \"version\": 4, \"type\": \"gateway\", \"address\": \n> \"51.255.0.254\"}}], \"meta\": {\"injected\": false, \"tenant_id\": \n> \"795504a0e45346d7ba0a016de877e725\", \"mtu\": 1500}, \"id\": \n> \"00f47a44-8f85-482b-b2a9-aeeff8dfd29d\", \"label\": \"e-net\"}, \"devname\": \n> \"tapb983f7d0-37\", \"vnic_type\": \"normal\", \"qbh_params\": null, \"meta\": \n> {}, \"details\": {\"port_filter\": true, \"datapath_type\": \"system\", \n> \"ovs_hybrid_plug\": false}, \"address\": \"d0:1c:a0:e3:01:e2\", \"active\": \n> true, \"type\": \"ovs\", \"id\": \"b983f7d0-37a5-42de-9d2f-feb27f219c75\", \n> \"qbg_params\": null}, {\"profile\": {}, \"ovs_interfaceid\": \n> \"32a3b619-d75c-46ce-8187-3d2eba77404f\", \"preserve_on_delete\": true, \n> \"network\": {\"bridge\": \"br-int\", \"subnets\": [{\"ips\": [{\"meta\": {}, \n> \"version\": 4, \"type\": \"fixed\", \"floating_ips\": [], \"address\": \n> \"1.1.1.2\"}], \"version\": 4, \"meta\": {\"dhcp_server\": \"1.1.1.9\"}, \"dns\": \n> [{\"meta\": {}, \"version\": 4, \"type\": \"dns\", \"address\": \"8.8.4.4\"}], \n> \"routes\": [{\"interface\": null, \"cidr\": \"1.1.2.0/24\", \"meta\": {}, \n> \"gateway\": {\"meta\": {}, \"version\": 4, \"type\": \"gateway\", \"address\": \n> \"1.1.1.2\"}}, {\"interface\": null, \"cidr\": \"1.1.3.0/24\", \"meta\": {}, \n> \"gateway\": {\"meta\": {}, \"version\": 4, \"type\": \"gateway\", \"address\": \n> \"1.1.1.2\"}}], \"cidr\": \"1.1.1.0/24\", \"gateway\": {\"meta\": {}, \"version\": \n> 4, \"type\": \"gateway\", \"address\": \"1.1.1.1\"}}], \"meta\": {\"injected\": \n> false, \"tenant_id\": \"d8051a3ff3ad4c4bb380f828992b8178\", \"mtu\": 1450}, \n> \"id\": \"4e6c23c1-e501-4fac-82a5-e8c66c439eba\", \"label\": \"jex-net\"}, \n> \"devname\": \"tap32a3b619-d7\", \"vnic_type\": \"normal\", \"qbh_params\": \n> null, \"meta\": {}, \"details\": {\"port_filter\": true, \"datapath_type\": \n> \"system\", \"ovs_hybrid_plug\": false}, \"address\": \"d0:1c:a0:84:85:f1\", \n> \"active\": true, \"type\": \"ovs\", \"id\": \n> \"32a3b619-d75c-46ce-8187-3d2eba77404f\", \"qbg_params\": null}] \n> update_instance_cache_with_nw_info \n> /usr/lib/python2.7/dist-packages/nova/network/base_api.py:48\n> 2017-09-26 09:25:55.717 16766 DEBUG oslo_concurrency.lockutils \n> [req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n> 5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \n> default default] Releasing semaphore \n> \"refresh_cache-05d155a2-1d8a-4327-8625-a94628767939\" lock \n> /usr/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py:228\n> ==================\n>\n> So, it's clear that event is generated and received on corresponding \n> compute node. Please, give next steps for narrowing the problem.\n>\n> Thank you.\n>\n> On 9/25/17 4:29 PM, Sylvain Bauza wrote:\n>> There is a config option in neutron.conf that makes Neutron sending\n>> callbacks to Nova when a port state is changed, namely\n>> [DEFAULT]/notify_nova_on_port_status_changes\n>>\n>> By default, this is True so that should mean Neutron should send the\n>> events, but can you please make sure that is still valid for your\n>> deployment ?\n>>\n>> Also, Neutron uses a specific admin-only Nova REST API resource for\n>> sending those callbacks. Seehttps://developer.openstack.org/api-\n>> ref/compute/#create-external-events-os-server-external-events\n>>\n>> If I were you, I'd look at the nova API logs to see if I'm able to see\n>> calls from Neutron, in particular if you check the n-api logs at the\n>> same time you issue the Neutron command.\n>>\n>> Please come back to us and tell us if you're able to see those logs, and\n>> if so, what Nova provides as a response code.\n>>\n>> ** Tags added: openstack-version.pike\n>>\n>> ** Tags added: neutron\n>>\n>\n> -- \n> Volodymyr Litovka\n>    \"Vision without Execution is Hallucination.\" -- Thomas Edison\n\n-- \nVolodymyr Litovka\n   \"Vision without Execution is Hallucination.\" -- Thomas Edison\n\n", 
            "date_created": "2017-09-26 10:41:39+00:00", 
            "author": "https://api.launchpad.net/1.0/~doka.ua"
        }, 
        {
            "content": "Dear Sylvain,\n\n1) configuration in neutron.conf (on all my hosts) contains the \nfollowing entries:\nnotify_nova_on_port_status_changes = true\nnotify_nova_on_port_data_changes = true\n\n2) I issue \"openstack port set --disable jex-vpn-lan\" on host \n\"lagavulin\", guest VM resides on host \"bowmore\" and logs show me the \nfollowing:\n\n*Host \"**l**agavulin\"**, nova-api.log**:*\n2017-09-26 09:25:55.199 2674 INFO \nnova.api.openstack.compute.server_external_events \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] Creating event \nnetwork-changed:32a3b619-d75c-46ce-8187-3d2eba77404f for instance \n05d155a2-1d8a-4327-8625-a94628767939 on *bowmore*\n2017-09-26 09:25:55.205 2674 INFO nova.osapi_compute.wsgi.server \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] 10.0.10.10 \"POST /v2.1/os-server-external-events \nHTTP/1.1\" status: 200 len: 554 time: 0.1836071\n========================\n\n*Host \"bowmore\", nova-compute.log :*\n2017-09-26 09:25:55.211 16766 DEBUG nova.compute.manager \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] [instance: 05d155a2-1d8a-4327-8625-a94628767939] \nReceived event network-changed-32a3b619-d75c-46ce-8187-3d2eba77404f \nexternal_instance_event \n/usr/lib/python2.7/dist-packages/nova/compute/manager.py:6957\n2017-09-26 09:25:55.212 16766 DEBUG oslo_concurrency.lockutils \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] Acquired semaphore \n\"refresh_cache-05d155a2-1d8a-4327-8625-a94628767939\" lock \n/usr/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py:215\n2017-09-26 09:25:55.213 16766 DEBUG nova.network.neutronv2.api \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] [instance: 05d155a2-1d8a-4327-8625-a94628767939] \n_get_instance_nw_info() _get_instance_nw_info \n/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py:1302\n2017-09-26 09:25:55.699 16766 DEBUG nova.network.base_api \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] [instance: 05d155a2-1d8a-4327-8625-a94628767939] \nUpdating instance_info_cache with network_info: [{\"profile\": {}, \n\"ovs_interfaceid\": \"b983f7d0-37a5-42de-9d2f-feb27f219c75\", \n\"preserve_on_delete\": true, \"network\": {\"bridge\": \"br-int\", \"subnets\": \n[{\"ips\": [{\"meta\": {}, \"version\": 4, \"type\": \"fixed\", \"floating_ips\": \n[], \"address\": \"x.x.x.249\"}], \"version\": 4, \"meta\": {\"dhcp_server\": \n\"x.x.x.250\"}, \"dns\": [{\"meta\": {}, \"version\": 4, \"type\": \"dns\", \n\"address\": \"8.8.8.8\"}], \"routes\": [], \"cidr\": \"x.x.x.240/28\", \"gateway\": \n{\"meta\": {}, \"version\": 4, \"type\": \"gateway\", \"address\": \"x.x.x.254\"}}], \n\"meta\": {\"injected\": false, \"tenant_id\": \n\"795504a0e45346d7ba0a016de877e725\", \"mtu\": 1500}, \"id\": \n\"00f47a44-8f85-482b-b2a9-aeeff8dfd29d\", \"label\": \"e-net\"}, \"devname\": \n\"tapb983f7d0-37\", \"vnic_type\": \"normal\", \"qbh_params\": null, \"meta\": {}, \n\"details\": {\"port_filter\": true, \"datapath_type\": \"system\", \n\"ovs_hybrid_plug\": false}, \"address\": \"d0:1c:a0:e3:01:e2\", \"active\": \ntrue, \"type\": \"ovs\", \"id\": \"b983f7d0-37a5-42de-9d2f-feb27f219c75\", \n\"qbg_params\": null}, {\"profile\": {}, \"ovs_interfaceid\": \n\"32a3b619-d75c-46ce-8187-3d2eba77404f\", \"preserve_on_delete\": true, \n\"network\": {\"bridge\": \"br-int\", \"subnets\": [{\"ips\": [{\"meta\": {}, \n\"version\": 4, \"type\": \"fixed\", \"floating_ips\": [], \"address\": \n\"1.1.1.2\"}], \"version\": 4, \"meta\": {\"dhcp_server\": \"1.1.1.9\"}, \"dns\": \n[{\"meta\": {}, \"version\": 4, \"type\": \"dns\", \"address\": \"8.8.4.4\"}], \n\"routes\": [{\"interface\": null, \"cidr\": \"1.1.2.0/24\", \"meta\": {}, \n\"gateway\": {\"meta\": {}, \"version\": 4, \"type\": \"gateway\", \"address\": \n\"1.1.1.2\"}}, {\"interface\": null, \"cidr\": \"1.1.3.0/24\", \"meta\": {}, \n\"gateway\": {\"meta\": {}, \"version\": 4, \"type\": \"gateway\", \"address\": \n\"1.1.1.2\"}}], \"cidr\": \"1.1.1.0/24\", \"gateway\": {\"meta\": {}, \"version\": \n4, \"type\": \"gateway\", \"address\": \"1.1.1.1\"}}], \"meta\": {\"injected\": \nfalse, \"tenant_id\": \"d8051a3ff3ad4c4bb380f828992b8178\", \"mtu\": 1450}, \n\"id\": \"4e6c23c1-e501-4fac-82a5-e8c66c439eba\", \"label\": \"jex-net\"}, \n\"devname\": \"tap32a3b619-d7\", \"vnic_type\": \"normal\", \"qbh_params\": null, \n\"meta\": {}, \"details\": {\"port_filter\": true, \"datapath_type\": \"system\", \n\"ovs_hybrid_plug\": false}, \"address\": \"d0:1c:a0:84:85:f1\", \"active\": \ntrue, \"type\": \"ovs\", \"id\": \"32a3b619-d75c-46ce-8187-3d2eba77404f\", \n\"qbg_params\": null}] update_instance_cache_with_nw_info \n/usr/lib/python2.7/dist-packages/nova/network/base_api.py:48\n2017-09-26 09:25:55.717 16766 DEBUG oslo_concurrency.lockutils \n[req-fc5907a8-b19f-4383-80c5-bc146aab96e9 \n5e2256fdc8f74fd6a0a9ef51b89f0bd6 1e96bb9d794f4588adcd6f32ee3fbaa8 - \ndefault default] Releasing semaphore \n\"refresh_cache-05d155a2-1d8a-4327-8625-a94628767939\" lock \n/usr/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py:228\n==================\n\nSo, it's clear that event is generated and received on corresponding \ncompute node. Please, give next steps for narrowing the problem.\n\nAnd in case if it can be required -\n\n$ openstack port show jex-vpn-lan\n+-----------------------+------------------------------------------------------------------------+\n| Field\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | Value |\n+-----------------------+------------------------------------------------------------------------+\n| admin_state_up\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | UP |\n| allowed_address_pairs | |\n| binding_host_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | bowmore |\n| binding_profile | |\n| binding_vif_details\u00a0\u00a0 | datapath_type='system', \novs_hybrid_plug='False', port_filter='True'\u00a0\u00a0\u00a0 |\n| binding_vif_type\u00a0\u00a0\u00a0\u00a0\u00a0 | ovs |\n| binding_vnic_type\u00a0\u00a0\u00a0\u00a0 | normal |\n| created_at\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | 2017-09-26T10:38:36Z |\n| data_plane_status\u00a0\u00a0\u00a0\u00a0 | None |\n| description | |\n| device_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | a97c3560-c3ed-40a9-a74f-9f54a3a02efe |\n| device_owner\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | compute:nova |\n| dns_assignment\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| dns_name\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| extra_dhcp_opts | |\n| fixed_ips\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | ip_address='1.1.1.2', \nsubnet_id='35321920-9ebe-43e5-b653-d4e010357016' |\n| id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | 5dd6c55f-e31d-4ee4-a3a4-4cca85932c58 |\n| ip_address\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| mac_address\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | d0:1c:a0:27:96:29 |\n| name\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | jex-vpn-lan |\n| network_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | a6889483-ee1b-46b6-a770-8db453be4195 |\n| option_name\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| option_value\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| port_security_enabled | False |\n| project_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | d8051a3ff3ad4c4bb380f828992b8178 |\n| qos_policy_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| revision_number\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | 6 |\n| security_group_ids | |\n| status\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | ACTIVE |\n| subnet_id\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| tags | |\n| trunk_details\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | None |\n| updated_at\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 | 2017-09-26T10:38:46Z |\n+-----------------------+------------------------------------------------------------------------+\n\n\nThank you.\n\nOn 9/25/17 4:29 PM, Sylvain Bauza wrote:\n> There is a config option in neutron.conf that makes Neutron sending\n> callbacks to Nova when a port state is changed, namely\n> [DEFAULT]/notify_nova_on_port_status_changes\n>\n> By default, this is True so that should mean Neutron should send the\n> events, but can you please make sure that is still valid for your\n> deployment ?\n>\n> Also, Neutron uses a specific admin-only Nova REST API resource for\n> sending those callbacks. Seehttps://developer.openstack.org/api-\n> ref/compute/#create-external-events-os-server-external-events\n>\n> If I were you, I'd look at the nova API logs to see if I'm able to see\n> calls from Neutron, in particular if you check the n-api logs at the\n> same time you issue the Neutron command.\n>\n> Please come back to us and tell us if you're able to see those logs, and\n> if so, what Nova provides as a response code.\n>\n> ** Tags added: openstack-version.pike\n>\n> ** Tags added: neutron\n>\n\n-- \nVolodymyr Litovka\n   \"Vision without Execution is Hallucination.\" -- Thomas Edison\n\n", 
            "date_created": "2017-09-26 13:54:44+00:00", 
            "author": "https://api.launchpad.net/1.0/~doka.ua"
        }, 
        {
            "content": "You traced the event correctly. It comes to the compute service here:\n\nhttps://github.com/openstack/nova/blob/16.0.0/nova/compute/manager.py#L6958\n\nAll that does, however, is refresh the internal newtork info cache for the instance in the instances_info_caches table.\n\nIt doesn't do anything in the guest. Is that what you expected?", 
            "date_created": "2017-09-27 21:08:59.693626+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Hi Matt,\n\nit isn't. I expect that:\n- upon setting admin_state DOWN in Openstack the corresponding network \ninterface inside VM will show NO-CARRIER state like it happens when I \nuse \"virsh domif-setlink [ ... ] --state down\" command\n- vice versa upon admin_state UP back\n- and, when creating VM, check for port state and put network interface \nin corresponding state.\n\nThank you!\n\nOn 9/28/17 12:08 AM, Matt Riedemann wrote:\n> You traced the event correctly. It comes to the compute service here:\n>\n> https://github.com/openstack/nova/blob/16.0.0/nova/compute/manager.py#L6958\n>\n> All that does, however, is refresh the internal newtork info cache for\n> the instance in the instances_info_caches table.\n>\n> It doesn't do anything in the guest. Is that what you expected?\n>\n> ** Changed in: nova\n>         Status: New => Invalid\n>\n> ** Changed in: nova\n>     Importance: Undecided => Wishlist\n>\n\n-- \nVolodymyr Litovka\n   \"Vision without Execution is Hallucination.\" -- Thomas Edison\n\n", 
            "date_created": "2017-09-28 06:57:09+00:00", 
            "author": "https://api.launchpad.net/1.0/~doka.ua"
        }
    ]
}