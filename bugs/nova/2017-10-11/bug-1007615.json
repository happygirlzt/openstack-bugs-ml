{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:39:28.344452+00:00", 
    "description": "2012-05-16 18:50:48 INFO nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 check_instance_lock: decorating: |<function terminate_instance at 0x279b410>| \n2012-05-16 18:50:48 INFO nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x7f823ec60a90>| |<nova.rpc.amqp.RpcContext object at 0x4304750>| |dab0682a-24fc-4b43-82e0-d10d28b7f29a| \n2012-05-16 18:50:48 DEBUG nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 instance dab0682a-24fc-4b43-82e0-d10d28b7f29a: getting locked state from (pid=16089) get_lock /usr/lib/python2.7/dist-packages/nova/compute/manager.py:1596 \n2012-05-16 18:50:48 INFO nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 check_instance_lock: locked: |False| \n2012-05-16 18:50:48 INFO nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 check_instance_lock: admin: |True| \n2012-05-16 18:50:48 INFO nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 check_instance_lock: executing: |<function terminate_instance at 0x279b410>| \n2012-05-16 18:50:48 DEBUG nova.utils req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Attempting to grab semaphore \"dab0682a-24fc-4b43-82e0-d10d28b7f29a\" for method \"do_terminate_instance\"... from (pid=16089) inner /usr/lib/python2.7/dist-packages/nova/utils.py:927 \n2012-05-16 18:50:48 DEBUG nova.utils req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Got semaphore \"dab0682a-24fc-4b43-82e0-d10d28b7f29a\" for method \"do_terminate_instance\"... from (pid=16089) inner /usr/lib/python2.7/dist-packages/nova/utils.py:931 \n2012-05-16 18:50:48 AUDIT nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 instance: dab0682a-24fc-4b43-82e0-d10d28b7f29a Terminating instance \n2012-05-16 18:50:48 DEBUG nova.rpc.amqp req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Making asynchronous call on network ... from (pid=16089) multicall /usr/lib/python2.7/dist-packages/nova/rpc/amqp.py:321 \n2012-05-16 18:50:48 DEBUG nova.rpc.amqp req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 MSG_ID is fe45f206c2e1491e91135fc4935aea06 from (pid=16089) multicall /usr/lib/python2.7/dist-packages/nova/rpc/amqp.py:324 \n2012-05-16 18:50:48 ERROR nova.rpc.common req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Failed to declare consumer for topic 'fe45f206c2e1491e91135fc4935aea06': Errno 32 Broken pipe \n2012-05-16 18:50:48 INFO nova.rpc.common req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Reconnecting to AMQP server on 172.17.0.20:5672 \n2012-05-16 18:50:48 INFO nova.rpc.common req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Connected to AMQP server on 172.17.0.20:5672 \n2012-05-16 18:50:49 DEBUG nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 instance: dab0682a-24fc-4b43-82e0-d10d28b7f29a Deallocating network for instance from (pid=16089) _deallocate_network /usr/lib/python2.7/dist-packages/nova/compute/manager.py:616 \n2012-05-16 18:50:49 DEBUG nova.rpc.amqp req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Making asynchronous cast on network... from (pid=16089) cast /usr/lib/python2.7/dist-packages/nova/rpc/amqp.py:346 \n2012-05-16 18:50:49 ERROR nova.rpc.amqp req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Exception during message handling \n(nova.rpc.amqp): TRACE: Traceback (most recent call last): \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 252, in _process_data \n(nova.rpc.amqp): TRACE: rval = node_func(context=ctxt, **node_args) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 114, in wrapped \n(nova.rpc.amqp): TRACE: return f(*args, **kw) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 153, in decorated_function \n(nova.rpc.amqp): TRACE: function(self, context, instance_uuid, *args, **kwargs) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 177, in decorated_function \n(nova.rpc.amqp): TRACE: sys.exc_info()) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_ \n(nova.rpc.amqp): TRACE: self.gen.next() \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 171, in decorated_function \n(nova.rpc.amqp): TRACE: return function(self, context, instance_uuid, *args, **kwargs) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 747, in terminate_instance \n(nova.rpc.amqp): TRACE: do_terminate_instance() \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 945, in inner \n(nova.rpc.amqp): TRACE: retval = f(*args, **kwargs) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 740, in do_terminate_instance \n(nova.rpc.amqp): TRACE: self._delete_instance(context, instance) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 718, in _delete_instance \n(nova.rpc.amqp): TRACE: self._shutdown_instance(context, instance, 'Terminating') \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 685, in _shutdown_instance \n(nova.rpc.amqp): TRACE: context, instance_id) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 637, in _get_instance_volume_block_device_info \n(nova.rpc.amqp): TRACE: cinfo = utils.loads(bdm'connection_info') \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 830, in loads \n(nova.rpc.amqp): TRACE: return json.loads(s) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/json/_init_.py\", line 326, in loads \n(nova.rpc.amqp): TRACE: return _default_decoder.decode(s) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/json/decoder.py\", line 366, in decode \n(nova.rpc.amqp): TRACE: obj, end = self.raw_decode(s, idx=_w(s, 0).end()) \n(nova.rpc.amqp): TRACE: TypeError: expected string or buffer \n(nova.rpc.amqp): TRACE:\n\nAdditional debugging into the example found that the values returned from nova/compute/manager.py in _get_instance_volume_bdms(context, instance_id) (line 640, essex release) sometimes included the value \"None\" in the key \"connection_info\" which caused this exception.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1007615", 
    "owner": "https://api.launchpad.net/1.0/~heckj", 
    "id": 1007615, 
    "index": 2854, 
    "created": "2012-06-01 21:38:33.645904+00:00", 
    "title": "block device mappings sometimes returns None, causing traceback and failure to terminate errored VM", 
    "comments": [
        {
            "content": "2012-05-16 18:50:48 INFO nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 check_instance_lock: decorating: |<function terminate_instance at 0x279b410>| \n2012-05-16 18:50:48 INFO nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x7f823ec60a90>| |<nova.rpc.amqp.RpcContext object at 0x4304750>| |dab0682a-24fc-4b43-82e0-d10d28b7f29a| \n2012-05-16 18:50:48 DEBUG nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 instance dab0682a-24fc-4b43-82e0-d10d28b7f29a: getting locked state from (pid=16089) get_lock /usr/lib/python2.7/dist-packages/nova/compute/manager.py:1596 \n2012-05-16 18:50:48 INFO nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 check_instance_lock: locked: |False| \n2012-05-16 18:50:48 INFO nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 check_instance_lock: admin: |True| \n2012-05-16 18:50:48 INFO nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 check_instance_lock: executing: |<function terminate_instance at 0x279b410>| \n2012-05-16 18:50:48 DEBUG nova.utils req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Attempting to grab semaphore \"dab0682a-24fc-4b43-82e0-d10d28b7f29a\" for method \"do_terminate_instance\"... from (pid=16089) inner /usr/lib/python2.7/dist-packages/nova/utils.py:927 \n2012-05-16 18:50:48 DEBUG nova.utils req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Got semaphore \"dab0682a-24fc-4b43-82e0-d10d28b7f29a\" for method \"do_terminate_instance\"... from (pid=16089) inner /usr/lib/python2.7/dist-packages/nova/utils.py:931 \n2012-05-16 18:50:48 AUDIT nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 instance: dab0682a-24fc-4b43-82e0-d10d28b7f29a Terminating instance \n2012-05-16 18:50:48 DEBUG nova.rpc.amqp req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Making asynchronous call on network ... from (pid=16089) multicall /usr/lib/python2.7/dist-packages/nova/rpc/amqp.py:321 \n2012-05-16 18:50:48 DEBUG nova.rpc.amqp req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 MSG_ID is fe45f206c2e1491e91135fc4935aea06 from (pid=16089) multicall /usr/lib/python2.7/dist-packages/nova/rpc/amqp.py:324 \n2012-05-16 18:50:48 ERROR nova.rpc.common req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Failed to declare consumer for topic 'fe45f206c2e1491e91135fc4935aea06': Errno 32 Broken pipe \n2012-05-16 18:50:48 INFO nova.rpc.common req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Reconnecting to AMQP server on 172.17.0.20:5672 \n2012-05-16 18:50:48 INFO nova.rpc.common req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Connected to AMQP server on 172.17.0.20:5672 \n2012-05-16 18:50:49 DEBUG nova.compute.manager req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 instance: dab0682a-24fc-4b43-82e0-d10d28b7f29a Deallocating network for instance from (pid=16089) _deallocate_network /usr/lib/python2.7/dist-packages/nova/compute/manager.py:616 \n2012-05-16 18:50:49 DEBUG nova.rpc.amqp req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Making asynchronous cast on network... from (pid=16089) cast /usr/lib/python2.7/dist-packages/nova/rpc/amqp.py:346 \n2012-05-16 18:50:49 ERROR nova.rpc.amqp req-698b792f-1353-4059-ad29-da18c9134277 0893d6d44cac49d8acc7b9af5022029f c53d34cee83d4394b0bd4496db8cd243 Exception during message handling \n(nova.rpc.amqp): TRACE: Traceback (most recent call last): \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 252, in _process_data \n(nova.rpc.amqp): TRACE: rval = node_func(context=ctxt, **node_args) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 114, in wrapped \n(nova.rpc.amqp): TRACE: return f(*args, **kw) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 153, in decorated_function \n(nova.rpc.amqp): TRACE: function(self, context, instance_uuid, *args, **kwargs) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 177, in decorated_function \n(nova.rpc.amqp): TRACE: sys.exc_info()) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_ \n(nova.rpc.amqp): TRACE: self.gen.next() \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 171, in decorated_function \n(nova.rpc.amqp): TRACE: return function(self, context, instance_uuid, *args, **kwargs) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 747, in terminate_instance \n(nova.rpc.amqp): TRACE: do_terminate_instance() \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 945, in inner \n(nova.rpc.amqp): TRACE: retval = f(*args, **kwargs) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 740, in do_terminate_instance \n(nova.rpc.amqp): TRACE: self._delete_instance(context, instance) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 718, in _delete_instance \n(nova.rpc.amqp): TRACE: self._shutdown_instance(context, instance, 'Terminating') \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 685, in _shutdown_instance \n(nova.rpc.amqp): TRACE: context, instance_id) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 637, in _get_instance_volume_block_device_info \n(nova.rpc.amqp): TRACE: cinfo = utils.loads(bdm'connection_info') \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 830, in loads \n(nova.rpc.amqp): TRACE: return json.loads(s) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/json/_init_.py\", line 326, in loads \n(nova.rpc.amqp): TRACE: return _default_decoder.decode(s) \n(nova.rpc.amqp): TRACE: File \"/usr/lib/python2.7/json/decoder.py\", line 366, in decode \n(nova.rpc.amqp): TRACE: obj, end = self.raw_decode(s, idx=_w(s, 0).end()) \n(nova.rpc.amqp): TRACE: TypeError: expected string or buffer \n(nova.rpc.amqp): TRACE:\n\nAdditional debugging into the example found that the values returned from nova/compute/manager.py in _get_instance_volume_bdms(context, instance_id) (line 640, essex release) sometimes included the value \"None\" in the key \"connection_info\" which caused this exception.", 
            "date_created": "2012-06-01 21:38:33.645904+00:00", 
            "author": "https://api.launchpad.net/1.0/~heckj"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/8062", 
            "date_created": "2012-06-01 21:52:24.833152+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I wasn't entirely sure about the root database call and if a None value was a legitimate return value, so I created a patch to at least solve the case when it does happen (defensive) so that it doesn't throw a stack trace and fail to terminate the instance.", 
            "date_created": "2012-06-01 21:54:47.092358+00:00", 
            "author": "https://api.launchpad.net/1.0/~heckj"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/8062\nCommitted: http://github.com/openstack/nova/commit/7d57cc16a6ab3b286e4fd3a479e5b40160980304\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7d57cc16a6ab3b286e4fd3a479e5b40160980304\nAuthor: Joe Heck <email address hidden>\nDate:   Fri Jun 1 21:51:48 2012 +0000\n\n    defensive coding against None inside bdm\n    resolves bug 1007615\n    \n    Change-Id: If7afa4fb030b3c53a0b80737ff792e42cc4d3101\n", 
            "date_created": "2012-06-04 17:56:23.035377+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/essex\nReview: https://review.openstack.org/10224", 
            "date_created": "2012-07-24 15:34:48.222686+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}