{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:03:36.131204+00:00", 
    "description": "Icehouse introduced a state called image_snapshot_pending which havana nodes do not understand. If they call save with expected_task_state=\"image_snapshot\" they will crash on the new state.\n\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 2341, in _snapshot_instance\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     update_task_state)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1386, in snapshot\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     update_task_state(task_state=task_states.IMAGE_PENDING_UPLOAD)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 2338, in update_task_state\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     instance.save(expected_task_state=expected_state)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/objects/base.py\", line 139, in wrapper\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     ctxt, self, fn.__name__, args, kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/conductor/rpcapi.py\", line 497, in object_action\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     objmethod=objmethod, args=args, kwargs=kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/rpcclient.py\", line 85, in call\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return self._invoke(self.proxy.call, ctxt, method, **kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/rpcclient.py\", line 63, in _invoke\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return cast_or_call(ctxt, msg, **self.kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/openstack/common/rpc/proxy.py\", line 126, in call\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     result = rpc.call(context, real_topic, msg, timeout)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/openstack/common/rpc/__init__.py\", line 139, in call\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return _get_impl().call(CONF, context, topic, msg, timeout)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/openstack/common/rpc/impl_kombu.py\", line 816, in call\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     rpc_amqp.get_connection_pool(conf, Connection))\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py\", line 574, in call\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     rv = list(rv)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py\", line 539, in __iter__\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     raise result\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp UnexpectedTaskStateError_Remote: Unexpected task state: expecting (u'image_snapshot',) but the actual state is image_snapshot_pending\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/conductor/manager.py\", line 576, in _object_dispatch\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return getattr(target, method)(context, *args, **kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/objects/base.py\", line 152, in wrapper\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return fn(self, ctxt, *args, **kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/objects/instance.py\", line 459, in save\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     columns_to_join=_expected_cols(expected_attrs))\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/db/api.py\", line 735, in instance_update_and_get_original\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     columns_to_join=columns_to_join)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/db/sqlalchemy/api.py\", line 130, in wrapper\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/db/sqlalchemy/api.py\", line 2200, in instance_update_and_get_original\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     columns_to_join=columns_to_join)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/db/sqlalchemy/api.py\", line 2251, in _instance_update\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     actual=actual_state, expected=expected)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp UnexpectedTaskStateError: Unexpected task state: expecting (u'image_snapshot',) but the actual state is image_snapshot_pending\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1265618", 
    "owner": "None", 
    "id": 1265618, 
    "index": 4426, 
    "created": "2014-01-02 20:12:17.065740+00:00", 
    "title": "image_snapshot_pending state breaks havana nodes", 
    "comments": [
        {
            "content": "Icehouse introduced a state called image_snapshot_pending which havana nodes do not understand. If they call save with expected_task_state=\"image_snapshot\" they will crash on the new state.\n\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 2341, in _snapshot_instance\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     update_task_state)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1386, in snapshot\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     update_task_state(task_state=task_states.IMAGE_PENDING_UPLOAD)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 2338, in update_task_state\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     instance.save(expected_task_state=expected_state)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/objects/base.py\", line 139, in wrapper\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     ctxt, self, fn.__name__, args, kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/conductor/rpcapi.py\", line 497, in object_action\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     objmethod=objmethod, args=args, kwargs=kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/rpcclient.py\", line 85, in call\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return self._invoke(self.proxy.call, ctxt, method, **kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/rpcclient.py\", line 63, in _invoke\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return cast_or_call(ctxt, msg, **self.kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/openstack/common/rpc/proxy.py\", line 126, in call\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     result = rpc.call(context, real_topic, msg, timeout)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/openstack/common/rpc/__init__.py\", line 139, in call\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return _get_impl().call(CONF, context, topic, msg, timeout)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/openstack/common/rpc/impl_kombu.py\", line 816, in call\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     rpc_amqp.get_connection_pool(conf, Connection))\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py\", line 574, in call\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     rv = list(rv)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova-havana/local/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py\", line 539, in __iter__\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     raise result\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp UnexpectedTaskStateError_Remote: Unexpected task state: expecting (u'image_snapshot',) but the actual state is image_snapshot_pending\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/conductor/manager.py\", line 576, in _object_dispatch\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return getattr(target, method)(context, *args, **kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/objects/base.py\", line 152, in wrapper\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return fn(self, ctxt, *args, **kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/objects/instance.py\", line 459, in save\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     columns_to_join=_expected_cols(expected_attrs))\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/db/api.py\", line 735, in instance_update_and_get_original\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     columns_to_join=columns_to_join)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/db/sqlalchemy/api.py\", line 130, in wrapper\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kwargs)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/db/sqlalchemy/api.py\", line 2200, in instance_update_and_get_original\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     columns_to_join=columns_to_join)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp   File \"/opt/upstack/nova/nova/db/sqlalchemy/api.py\", line 2251, in _instance_update\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp     actual=actual_state, expected=expected)\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp UnexpectedTaskStateError: Unexpected task state: expecting (u'image_snapshot',) but the actual state is image_snapshot_pending\n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp \n2014-01-02 11:58:46.766 TRACE nova.openstack.common.rpc.amqp", 
            "date_created": "2014-01-02 20:12:17.065740+00:00", 
            "author": "https://api.launchpad.net/1.0/~danms"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/64722\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=579301d0d35bc8fc971dc27a71b9bc13f9cd1850\nSubmitter: Jenkins\nBranch:    master\n\ncommit 579301d0d35bc8fc971dc27a71b9bc13f9cd1850\nAuthor: Dan Smith <email address hidden>\nDate:   Thu Jan 2 11:33:42 2014 -0800\n\n    Translate the snapshot_pending state for old instances\n    \n    Icehouse introduced an image_snapshot_pending state which Havana\n    compute nodes do not understand. This adds a translation for that\n    state when we are handling save() for a havana-era Instance object.\n    \n    Closes-bug: #1265618\n    Change-Id: I36028defc3591cc6e31c7ba763a5c7f076832179\n", 
            "date_created": "2014-01-09 22:10:42.039271+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}