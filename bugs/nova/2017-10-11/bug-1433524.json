{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:28:03.224379+00:00", 
    "description": "based on this change - https://github.com/openstack/nova/commit/1153a46738fc3ffff98a1df9d94b5a55fdd58777\n\nIf I boot instance with preexisting port and delete this instance then port remains.\nBut If I boot instance with preexisting port and attach one more port then first port is deleted while I delete the instance.\n\n\n1) Create port with neutron \n| 81c98edb-06ac-4286-ad7a-2edeb901474b |      | fa:16:3e:5b:1d:c6 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.4\"} |\n2) Run instance with this port\n(0):~/devstack$ nova boot ttt --flavor 42 --image aab2d892-636d-4bde-8636-71f8ffd3c51d --nic port-id=81c98edb-06ac-4286-ad7a-2edeb901474b\n\nport list - \n~/devstack$ neutron port-list\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| id                                   | name | mac_address       | fixed_ips                                                                         |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| 81c98edb-06ac-4286-ad7a-2edeb901474b |      | fa:16:3e:5b:1d:c6 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.4\"} |\n| a92337de-d3f2-4a5c-beb4-54bd48ec043f |      | fa:16:3e:41:b9:00 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.1\"}   |\n| e59d3841-215a-4352-a212-d5cac5cb7bbe |      | fa:16:3e:06:4b:27 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.2\"}   |\n| fa67a224-907e-4c11-bcae-9d919330c6b8 |      | fa:16:3e:5e:2d:a7 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.2\"} |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n\n3) Create another port\n(0):~/devstack$ neutron port-create public\n| fixed_ips             | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.8\"} |\n| id                    | a26c8bc0-ea94-4abb-9ffc-752a594e08e7                                              |\n\n4) attach port to the instance\n(0):~/devstack$ nova interface-attach --port-id a26c8bc0-ea94-4abb-9ffc-752a594e08e7 ttt\n\n5) check instance ports -\n(0):~/devstack$ nova interface-list ttt\n+------------+--------------------------------------+--------------------------------------+--------------+-------------------+\n| Port State | Port ID                              | Net ID                               | IP addresses | MAC Addr          |\n+------------+--------------------------------------+--------------------------------------+--------------+-------------------+\n| DOWN       | 81c98edb-06ac-4286-ad7a-2edeb901474b | 1e629e00-28b6-4a67-9940-dee2660a23a8 | 172.24.4.4   | fa:16:3e:5b:1d:c6 |\n| DOWN       | a26c8bc0-ea94-4abb-9ffc-752a594e08e7 | 1e629e00-28b6-4a67-9940-dee2660a23a8 | 172.24.4.8   | fa:16:3e:a1:74:eb |\n+------------+--------------------------------------+--------------------------------------+--------------+-------------------+\n(0):~/devstack$ neutron port-list\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| id                                   | name | mac_address       | fixed_ips                                                                         |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| 81c98edb-06ac-4286-ad7a-2edeb901474b |      | fa:16:3e:5b:1d:c6 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.4\"} |\n| a26c8bc0-ea94-4abb-9ffc-752a594e08e7 |      | fa:16:3e:a1:74:eb | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.8\"} |\n| a92337de-d3f2-4a5c-beb4-54bd48ec043f |      | fa:16:3e:41:b9:00 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.1\"}   |\n| e59d3841-215a-4352-a212-d5cac5cb7bbe |      | fa:16:3e:06:4b:27 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.2\"}   |\n| fa67a224-907e-4c11-bcae-9d919330c6b8 |      | fa:16:3e:5e:2d:a7 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.2\"} |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n\n6) delete instance and check ports in neutron -\n\n(0):~/devstack$ neutron port-list\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| id                                   | name | mac_address       | fixed_ips                                                                         |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| a26c8bc0-ea94-4abb-9ffc-752a594e08e7 |      | fa:16:3e:a1:74:eb | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.8\"} |\n| a92337de-d3f2-4a5c-beb4-54bd48ec043f |      | fa:16:3e:41:b9:00 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.1\"}   |\n| e59d3841-215a-4352-a212-d5cac5cb7bbe |      | fa:16:3e:06:4b:27 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.2\"}   |\n| fa67a224-907e-4c11-bcae-9d919330c6b8 |      | fa:16:3e:5e:2d:a7 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.2\"} |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n\n\nExpected result - all preexisting ports remain in my system after instance deletion.", 
    "tags": [
        "network", 
        "neutron"
    ], 
    "importance": "Medium", 
    "heat": 20, 
    "link": "https://bugs.launchpad.net/nova/+bug/1433524", 
    "owner": "https://api.launchpad.net/1.0/~dims-v", 
    "id": 1433524, 
    "index": 4180, 
    "created": "2015-03-18 10:23:55.892390+00:00", 
    "title": "Nova deletes first preexisting port if second was attached to instance", 
    "comments": [
        {
            "content": "based on this change - https://github.com/openstack/nova/commit/1153a46738fc3ffff98a1df9d94b5a55fdd58777\n\nIf I boot instance with preexisting port and delete this instance then port remains.\nBut If I boot instance with preexisting port and attach one more port then first port is deleted while I delete the instance.\n\n\n1) Create port with neutron \n| 81c98edb-06ac-4286-ad7a-2edeb901474b |      | fa:16:3e:5b:1d:c6 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.4\"} |\n2) Run instance with this port\n(0):~/devstack$ nova boot ttt --flavor 42 --image aab2d892-636d-4bde-8636-71f8ffd3c51d --nic port-id=81c98edb-06ac-4286-ad7a-2edeb901474b\n\nport list - \n~/devstack$ neutron port-list\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| id                                   | name | mac_address       | fixed_ips                                                                         |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| 81c98edb-06ac-4286-ad7a-2edeb901474b |      | fa:16:3e:5b:1d:c6 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.4\"} |\n| a92337de-d3f2-4a5c-beb4-54bd48ec043f |      | fa:16:3e:41:b9:00 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.1\"}   |\n| e59d3841-215a-4352-a212-d5cac5cb7bbe |      | fa:16:3e:06:4b:27 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.2\"}   |\n| fa67a224-907e-4c11-bcae-9d919330c6b8 |      | fa:16:3e:5e:2d:a7 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.2\"} |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n\n3) Create another port\n(0):~/devstack$ neutron port-create public\n| fixed_ips             | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.8\"} |\n| id                    | a26c8bc0-ea94-4abb-9ffc-752a594e08e7                                              |\n\n4) attach port to the instance\n(0):~/devstack$ nova interface-attach --port-id a26c8bc0-ea94-4abb-9ffc-752a594e08e7 ttt\n\n5) check instance ports -\n(0):~/devstack$ nova interface-list ttt\n+------------+--------------------------------------+--------------------------------------+--------------+-------------------+\n| Port State | Port ID                              | Net ID                               | IP addresses | MAC Addr          |\n+------------+--------------------------------------+--------------------------------------+--------------+-------------------+\n| DOWN       | 81c98edb-06ac-4286-ad7a-2edeb901474b | 1e629e00-28b6-4a67-9940-dee2660a23a8 | 172.24.4.4   | fa:16:3e:5b:1d:c6 |\n| DOWN       | a26c8bc0-ea94-4abb-9ffc-752a594e08e7 | 1e629e00-28b6-4a67-9940-dee2660a23a8 | 172.24.4.8   | fa:16:3e:a1:74:eb |\n+------------+--------------------------------------+--------------------------------------+--------------+-------------------+\n(0):~/devstack$ neutron port-list\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| id                                   | name | mac_address       | fixed_ips                                                                         |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| 81c98edb-06ac-4286-ad7a-2edeb901474b |      | fa:16:3e:5b:1d:c6 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.4\"} |\n| a26c8bc0-ea94-4abb-9ffc-752a594e08e7 |      | fa:16:3e:a1:74:eb | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.8\"} |\n| a92337de-d3f2-4a5c-beb4-54bd48ec043f |      | fa:16:3e:41:b9:00 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.1\"}   |\n| e59d3841-215a-4352-a212-d5cac5cb7bbe |      | fa:16:3e:06:4b:27 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.2\"}   |\n| fa67a224-907e-4c11-bcae-9d919330c6b8 |      | fa:16:3e:5e:2d:a7 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.2\"} |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n\n6) delete instance and check ports in neutron -\n\n(0):~/devstack$ neutron port-list\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| id                                   | name | mac_address       | fixed_ips                                                                         |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n| a26c8bc0-ea94-4abb-9ffc-752a594e08e7 |      | fa:16:3e:a1:74:eb | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.8\"} |\n| a92337de-d3f2-4a5c-beb4-54bd48ec043f |      | fa:16:3e:41:b9:00 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.1\"}   |\n| e59d3841-215a-4352-a212-d5cac5cb7bbe |      | fa:16:3e:06:4b:27 | {\"subnet_id\": \"134b9bd5-da87-4b8f-880d-72e24206a721\", \"ip_address\": \"10.0.0.2\"}   |\n| fa67a224-907e-4c11-bcae-9d919330c6b8 |      | fa:16:3e:5e:2d:a7 | {\"subnet_id\": \"71b456c2-4805-4905-a8d8-9293e162f917\", \"ip_address\": \"172.24.4.2\"} |\n+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------+\n\n\nExpected result - all preexisting ports remain in my system after instance deletion.", 
            "date_created": "2015-03-18 10:23:55.892390+00:00", 
            "author": "https://api.launchpad.net/1.0/~apavlov-e"
        }, 
        {
            "content": "Andrey,\n\nCan you please try to see if this patch works for you?\nhttps://review.openstack.org/#/c/165608/\n\nthanks,\ndims", 
            "date_created": "2015-03-19 01:26:41.381943+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Davanum, \nYes, this patch fixes this case and it works for me now.", 
            "date_created": "2015-03-19 08:56:10.713197+00:00", 
            "author": "https://api.launchpad.net/1.0/~apavlov-e"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/165608\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=58295fa8121f76729201135b660041cbe716981b\nSubmitter: Jenkins\nBranch:    master\n\ncommit 58295fa8121f76729201135b660041cbe716981b\nAuthor: Davanum Srinivas <email address hidden>\nDate:   Wed Mar 18 17:17:55 2015 -0400\n\n    Fix for deletes first preexisting port if second was attached to instance\n    \n    In Ia5367cf064d40690670ffeac3c1f16998464c234, we added a capability\n    to preserve preexisting ports on server delete. There was one scenario\n    that broken as a result as reported in the bug.\n    \"If I boot instance with preexisting port and attach one more port\n    then first port is deleted while I delete the instance.\"\n    \n    Essentially we have to lookup get_preexisting_port_ids during\n    boot as well as when we are attaching an interface.\n    \n    Closes-Bug: #1433524\n    Change-Id: I3d557dd95f442106c495249a5ef1d2ac36e6a2ea\n", 
            "date_created": "2015-03-24 01:59:27.740804+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}