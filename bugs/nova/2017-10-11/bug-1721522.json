{
    "status": "New", 
    "last_updated": "2017-10-05 11:33:20.014106+00:00", 
    "description": "Hi,\n\nI followed the guide here - https://docs.openstack.org/cinder/pike/configuration/block-storage/volume-encryption.html\n\nI also use Barbican and for that I added [barbican] auth_endpoint = http://controller:5000 to cinder.conf and nova.conf\n\nCreation of LUKS disks is successful. I also created normal disks and could easily attach them to an instance.\n\nCinder disks are on LVM\n\nAttaching LUKS disks fails with the following trace:\n\n017-10-05 11:44:57.445 1 INFO nova.compute.manager [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Attaching volume 5c03f92f-470a-4f15-aaca-49d9232512a8 to /dev/vdc\n2017-10-05 11:44:57.835 1 INFO oslo.privsep.daemon [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] Running privsep helper: ['sudo', 'nova-rootwrap', '/etc/nova/rootwrap.conf', 'privsep-helper', '--config-file', '/etc/nova/nova.conf', '--privsep_context', 'os_brick.privileged.default', '--privsep_sock_path', '/tmp/tmpKwgHpn/privsep.sock']\n2017-10-05 11:44:58.598 1 INFO oslo.privsep.daemon [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] Spawned new privsep daemon via rootwrap\n2017-10-05 11:44:58.548 80 INFO oslo.privsep.daemon [-] privsep daemon starting\n2017-10-05 11:44:58.553 80 INFO oslo.privsep.daemon [-] privsep process running with uid/gid: 0/0\n2017-10-05 11:44:58.558 80 INFO oslo.privsep.daemon [-] privsep process running with capabilities (eff/prm/inh): CAP_SYS_ADMIN/CAP_SYS_ADMIN/none\n2017-10-05 11:44:58.558 80 INFO oslo.privsep.daemon [-] privsep daemon running as pid 80\n2017-10-05 11:45:01.468 1 INFO os_brick.initiator.connectors.iscsi [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] Trying to connect to iSCSI portal 10.10.245.211:3260\n2017-10-05 11:45:05.762 1 WARNING os_brick.encryptors [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] Use of the in tree encryptor class nova.volume.encryptors.luks.LuksEncryptor by directly referencing the implementation class will be blocked in the Queens release of os-brick.\n2017-10-05 11:45:07.431 1 WARNING os_brick.encryptors.luks [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] isLuks exited abnormally (status 1): Device /dev/sdb is not a valid LUKS device.\nCommand failed with code 22: Invalid argument\n: ProcessExecutionError: Unexpected error while running command.\nCommand: cryptsetup isLuks --verbose /dev/sdb\nExit code: 1\nStdout: u''\nStderr: u'Device /dev/sdb is not a valid LUKS device.\\nCommand failed with code 22: Invalid argument\\n'\n2017-10-05 11:45:07.432 1 INFO os_brick.encryptors.luks [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] /dev/sdb is not a valid LUKS device; formatting device for first use\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Failed to attach volume at mountpoint: /dev/vdc: ProcessExecutionError: Unexpected error while running command.\nCommand: cryptsetup --batch-mode luksFormat --key-file=- --cipher aes-xts-plain64 --key-size 256 /dev/sdb\nExit code: 5\nStdout: u''\nStderr: u'Cannot format device /dev/sdb which is still in use.\\n'\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Traceback (most recent call last):\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1250, in attach_volume\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     encryptor.attach_volume(context, **encryption)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/os_brick/encryptors/luks.py\", line 160, in attach_volume\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     self._format_volume(passphrase, **kwargs)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/os_brick/encryptors/luks.py\", line 87, in _format_volume\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     attempts=3)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/os_brick/executor.py\", line 52, in _execute\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     result = self.__execute(*args, **kwargs)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/os_brick/privileged/rootwrap.py\", line 169, in execute\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     return execute_root(*cmd, **kwargs)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_privsep/priv_context.py\", line 205, in _wrap\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     return self.channel.remote_call(name, args, kwargs)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_privsep/daemon.py\", line 202, in remote_call\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     raise exc_type(*result[2])\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] ProcessExecutionError: Unexpected error while running command.\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Command: cryptsetup --batch-mode luksFormat --key-file=- --cipher aes-xts-plain64 --key-size 256 /dev/sdb\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Exit code: 5\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Stdout: u''\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Stderr: u'Cannot format device /dev/sdb which is still in use.\\n'\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]\n2017-10-05 11:45:19.027 1 ERROR nova.virt.block_device [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Driver failed to attach volume 5c03f92f-470a-4f15-aaca-49d9232512a8 at /dev/vdc: ProcessExecutionError: Unexpected error while running command.\nCommand: cryptsetup --batch-mode luksFormat --key-file=- --cipher aes-xts-plain64 --key-size 256 /dev/sdb\nExit code: 5\nStdout: u''\nStderr: u'Cannot format device /dev/sdb which is still in use.\\n'\n\nI have checked that /dev/sdb appears for short time (/dev/sda is unencrypted drive attached to an instance on the same host) and running cryptsetup luksFormat gives 'cannot format device...still in use'\n\n(nova-compute)[root@compute5 /]# pip freeze | grep nova\nnova==13.0.0.0rc4.dev8314\npython-novaclient==9.1.0\n\n(nova-compute)[root@compute5 /]# pip freeze | grep oslo\noslo.cache==1.25.0\noslo.concurrency==3.21.0\noslo.config==4.11.0\noslo.context==2.17.0\noslo.db==4.25.0\noslo.i18n==3.17.0\noslo.log==3.30.0\noslo.messaging==5.30.0\noslo.middleware==3.30.0\noslo.policy==1.25.1\noslo.privsep==1.22.0\noslo.reports==1.22.0\noslo.rootwrap==5.9.0\noslo.serialization==2.20.0\noslo.service==1.25.0\noslo.utils==3.28.0\noslo.versionedobjects==1.26.0\noslo.vmware==2.24.0\n\n(nova-compute)[root@compute5 /]# pip freeze | grep barbican\npython-barbicanclient==4.5.2\n\n(nova-compute)[root@compute5 /]# rpm -qa | grep crypt\nlibgcrypt-devel-1.5.3-14.el7.x86_64\nlibgcrypt-1.5.3-14.el7.x86_64\ncryptsetup-1.7.4-3.el7.x86_64\ncryptsetup-libs-1.7.4-3.el7.x86_64", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1721522", 
    "owner": "None", 
    "id": 1721522, 
    "index": 7065, 
    "created": "2017-10-05 11:31:00.116629+00:00", 
    "title": "encrypted volumes: Cannot format device /dev/sdb which is still in use", 
    "comments": [
        {
            "content": "Hi, \n\nI followed the guide here - https://docs.openstack.org/cinder/pike/configuration/block-storage/volume-encryption.html\n\nI also use Barbican and for that I added [barbican] auth_endpoint = controlnode:5000 to cinder.conf and nova.conf\n\nCreation of LUKS disks is successful. I also created normal disks and could easily attach them to an instance. \n\nCinder disks are on LVM\n\nAttaching LUKS disks fails with the following trace:\n\n017-10-05 11:44:57.445 1 INFO nova.compute.manager [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Attaching volume 5c03f92f-470a-4f15-aaca-49d9232512a8 to /dev/vdc\n2017-10-05 11:44:57.835 1 INFO oslo.privsep.daemon [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] Running privsep helper: ['sudo', 'nova-rootwrap', '/etc/nova/rootwrap.conf', 'privsep-helper', '--config-file', '/etc/nova/nova.conf', '--privsep_context', 'os_brick.privileged.default', '--privsep_sock_path', '/tmp/tmpKwgHpn/privsep.sock']\n2017-10-05 11:44:58.598 1 INFO oslo.privsep.daemon [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] Spawned new privsep daemon via rootwrap\n2017-10-05 11:44:58.548 80 INFO oslo.privsep.daemon [-] privsep daemon starting\n2017-10-05 11:44:58.553 80 INFO oslo.privsep.daemon [-] privsep process running with uid/gid: 0/0\n2017-10-05 11:44:58.558 80 INFO oslo.privsep.daemon [-] privsep process running with capabilities (eff/prm/inh): CAP_SYS_ADMIN/CAP_SYS_ADMIN/none\n2017-10-05 11:44:58.558 80 INFO oslo.privsep.daemon [-] privsep daemon running as pid 80\n2017-10-05 11:45:01.468 1 INFO os_brick.initiator.connectors.iscsi [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] Trying to connect to iSCSI portal 10.10.245.211:3260\n2017-10-05 11:45:05.762 1 WARNING os_brick.encryptors [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] Use of the in tree encryptor class nova.volume.encryptors.luks.LuksEncryptor by directly referencing the implementation class will be blocked in the Queens release of os-brick.\n2017-10-05 11:45:07.431 1 WARNING os_brick.encryptors.luks [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] isLuks exited abnormally (status 1): Device /dev/sdb is not a valid LUKS device.\nCommand failed with code 22: Invalid argument\n: ProcessExecutionError: Unexpected error while running command.\nCommand: cryptsetup isLuks --verbose /dev/sdb\nExit code: 1\nStdout: u''\nStderr: u'Device /dev/sdb is not a valid LUKS device.\\nCommand failed with code 22: Invalid argument\\n'\n2017-10-05 11:45:07.432 1 INFO os_brick.encryptors.luks [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] /dev/sdb is not a valid LUKS device; formatting device for first use\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Failed to attach volume at mountpoint: /dev/vdc: ProcessExecutionError: Unexpected error while running command.\nCommand: cryptsetup --batch-mode luksFormat --key-file=- --cipher aes-xts-plain64 --key-size 256 /dev/sdb\nExit code: 5\nStdout: u''\nStderr: u'Cannot format device /dev/sdb which is still in use.\\n'\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Traceback (most recent call last):\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1250, in attach_volume\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     encryptor.attach_volume(context, **encryption)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/os_brick/encryptors/luks.py\", line 160, in attach_volume\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     self._format_volume(passphrase, **kwargs)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/os_brick/encryptors/luks.py\", line 87, in _format_volume\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     attempts=3)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/os_brick/executor.py\", line 52, in _execute\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     result = self.__execute(*args, **kwargs)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/os_brick/privileged/rootwrap.py\", line 169, in execute\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     return execute_root(*cmd, **kwargs)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_privsep/priv_context.py\", line 205, in _wrap\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     return self.channel.remote_call(name, args, kwargs)\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]   File \"/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_privsep/daemon.py\", line 202, in remote_call\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d]     raise exc_type(*result[2])\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] ProcessExecutionError: Unexpected error while running command.\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Command: cryptsetup --batch-mode luksFormat --key-file=- --cipher aes-xts-plain64 --key-size 256 /dev/sdb\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Exit code: 5\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Stdout: u''\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Stderr: u'Cannot format device /dev/sdb which is still in use.\\n'\n2017-10-05 11:45:18.848 1 ERROR nova.virt.libvirt.driver [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] \n2017-10-05 11:45:19.027 1 ERROR nova.virt.block_device [req-4780adcc-161e-4223-b53c-56b27a984ca1 f20698e1d05a4e2582e023778bfa5693 6a4c6d8b18714579a6e448e754d8838f - default default] [instance: 90376ab6-d553-477a-bda6-eeed8e70cc8d] Driver failed to attach volume 5c03f92f-470a-4f15-aaca-49d9232512a8 at /dev/vdc: ProcessExecutionError: Unexpected error while running command.\nCommand: cryptsetup --batch-mode luksFormat --key-file=- --cipher aes-xts-plain64 --key-size 256 /dev/sdb\nExit code: 5\nStdout: u''\nStderr: u'Cannot format device /dev/sdb which is still in use.\\n'\n\n\nI have checked that /dev/sdb appears for short time (/dev/sda is unencrypted drive attached to an instance on the same host) and running cryptsetup luksFormat gives 'cannot format device...still in use'\n\n\n(nova-compute)[root@compute5 /]# pip freeze | grep nova\nnova==13.0.0.0rc4.dev8314\npython-novaclient==9.1.0\n\n(nova-compute)[root@compute5 /]# pip freeze | grep oslo\noslo.cache==1.25.0\noslo.concurrency==3.21.0\noslo.config==4.11.0\noslo.context==2.17.0\noslo.db==4.25.0\noslo.i18n==3.17.0\noslo.log==3.30.0\noslo.messaging==5.30.0\noslo.middleware==3.30.0\noslo.policy==1.25.1\noslo.privsep==1.22.0\noslo.reports==1.22.0\noslo.rootwrap==5.9.0\noslo.serialization==2.20.0\noslo.service==1.25.0\noslo.utils==3.28.0\noslo.versionedobjects==1.26.0\noslo.vmware==2.24.0\n\n(nova-compute)[root@compute5 /]# pip freeze | grep barbican\npython-barbicanclient==4.5.2\n\n(nova-compute)[root@compute5 /]# rpm -qa | grep crypt      \nlibgcrypt-devel-1.5.3-14.el7.x86_64\nlibgcrypt-1.5.3-14.el7.x86_64\ncryptsetup-1.7.4-3.el7.x86_64\ncryptsetup-libs-1.7.4-3.el7.x86_64", 
            "date_created": "2017-10-05 11:31:00.116629+00:00", 
            "author": "https://api.launchpad.net/1.0/~vlad-belogrudov"
        }
    ]
}