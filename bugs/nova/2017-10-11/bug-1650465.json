{
    "status": "Opinion", 
    "last_updated": "2017-01-05 15:43:17.244886+00:00", 
    "description": "Scenario:\nNormally Universal umask(022) is used in testing environment , i was using privacy umask(027) as it is  production environment. \n\nIn this scenario root have 022 umask in provisioning stage and other users in will get 027 as umask in deployment stage,\n\nSo, umask is handled by pam umask so 027 become 007\n\nSo nova user in compute have 007 umask and directory which will create by nova user have 770 permission\n\nDuring Migration / Resize to other host it having permission issue as instance directory need to be access by libvirt-qemu which have 770 permission.\n\n\nConsideration:\n1. privacy umask for openstack users \n2. compute01 have VM to migrate/resize \n3. VM will get migrate from compute01 to compute02\n4. Hypervisor : KVM\n5. Openstack version: KILO, MITAKA, NEWTON\n\n\nSteps to reproduce:\n1. Install ubuntu 14.04 and after installation change the pam umask value from 022 to 027(which needed for production).\n2. Deploy the openstack components , here for compute nova user and libvirt-qemu will be created with pam umask of 007.\n\nroot@compute01:/var/lib/nova/instances# umask\n0002\nnova@compute01:/var/lib/nova$ umask\n0007\n\n3. Create a host aggregate and include compute01 & compute02 to it.\n4. Spin a VM in compute01 , here VM is is -> 09aab3a8-3df8-474c-a8a9-a4f666f851a0\nroot@compute01:/var/lib/nova/instances# ls -l\ntotal 12\ndrwxr-xr-x 2 nova nova  111 Dec  12 21:33 09aab3a8-3df8-474c-a8a9-a4f666f851a0\ndrwxr-xr-x 2 nova nova 4096 Dec  12 01:48 _base\n-rw-r--r-- 1 nova nova   52 Dec  15 13:16 compute_nodes\ndrwxr-xr-x 2 nova nova 4096 Dec  12 01:48 locks\n\n5. Test the umask for nova in compute01 and compute02\nnova@compute01:/tmp$ mkdir nova_umask_test\nnova@compute01:/tmp$ ls -ld  nova_umask_test\ndrwxr-x--- 2 nova nova     4096 Dec  12 13:55 nova_umask_test\n\nnova@compute02:/tmp$ mkdir nova_umask_test\nnova@compute02:/tmp$ ls -ld  nova_umask_test\ndrwxr-x--- 2 nova nova     4096 Dec  12 13:58 nova_umask_test\n\n6. Validate the permission of VM directory in compute01 \nroot@compute01:/var/lib/nova/instances# ls -l 09aab3a8-3df8-474c-a8a9-a4f666f851a0\ntotal 172944\n-rw-rw---- 1 libvirt-qemu libvirt-qemu     26280 Dec 12 21:35 console.log\n-rw-r--r-- 1 libvirt-qemu libvirt-qemu 176488448 Dec 12 16:57 disk\n-rw-r--r-- 1 libvirt-qemu libvirt-qemu    432128 Dec 12 21:33 disk.config\n-rw-r--r-- 1 nova         nova               162 Dec 12 21:33 disk.info\n\n7. Do the resize from m1.small  to m1.medium  and end up with following error.\nError message : Error: Failed to perform requested operation on instance \"test\", the instance has an error status: Please try again later\n[Error: Cannot access storage file '/var/lib/nova/instances/09aab3a8-3df8-474c-a8a9-a4f666f851a0/disk' (as uid:108, gid:117): Permission denied].\n\n\nActual result:\nPermission issue occurred during migrate/resize to different host.\n\nExpected result:\nResize/migrate will be successful.\n\nNote : With universal umask migration/resize works good in the same environment.", 
    "tags": [], 
    "importance": "Wishlist", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1650465", 
    "owner": "https://api.launchpad.net/1.0/~prabhuraj", 
    "id": 1650465, 
    "index": 1847, 
    "created": "2016-12-16 07:19:36.131025+00:00", 
    "title": "Permission Issue during Migration and resize when we have privacy umask", 
    "comments": [
        {
            "content": "Scenario:\nNormally Universal umask(022) is used in testing environment , i was using privacy umask(027) as it is  production environment. \n\nIn this scenario root have 022 umask in provisioning stage and other users in will get 027 as umask in deployment stage,\n\nSo, umask is handled by pam umask so 027 become 007\n\nSo nova user in compute have 007 umask and directory which will create by nova user have 770 permission\n\nDuring Migration / Resize to other host it having permission issue as instance directory need to be access by libvirt-qemu which have 770 permission.\n\n\nConsideration:\n1. privacy umask for openstack users \n2. compute01 have VM to migrate/resize \n3. VM will get migrate from compute01 to compute02\n4. Hypervisor : KVM\n5. Openstack version: KILO, MITAKA, NEWTON\n\n\nSteps to reproduce:\n1. Install ubuntu 14.04 and after installation change the pam umask value from 022 to 027(which needed for production).\n2. Deploy the openstack components , here for compute nova user and libvirt-qemu will be created with pam umask of 007.\n\nroot@compute01:/var/lib/nova/instances# umask\n0002\nnova@compute01:/var/lib/nova$ umask\n0007\n\n3. Create a host aggregate and include compute01 & compute02 to it.\n4. Spin a VM in compute01 , here VM is is -> 09aab3a8-3df8-474c-a8a9-a4f666f851a0\nroot@compute01:/var/lib/nova/instances# ls -l\ntotal 12\ndrwxr-xr-x 2 nova nova  111 Dec  12 21:33 09aab3a8-3df8-474c-a8a9-a4f666f851a0\ndrwxr-xr-x 2 nova nova 4096 Dec  12 01:48 _base\n-rw-r--r-- 1 nova nova   52 Dec  15 13:16 compute_nodes\ndrwxr-xr-x 2 nova nova 4096 Dec  12 01:48 locks\n\n5. Test the umask for nova in compute01 and compute02\nnova@compute01:/tmp$ mkdir nova_umask_test\nnova@compute01:/tmp$ ls -ld  nova_umask_test\ndrwxr-x--- 2 nova nova     4096 Dec  12 13:55 nova_umask_test\n\nnova@compute02:/tmp$ mkdir nova_umask_test\nnova@compute02:/tmp$ ls -ld  nova_umask_test\ndrwxr-x--- 2 nova nova     4096 Dec  12 13:58 nova_umask_test\n\n6. Validate the permission of VM directory in compute01 \nroot@compute01:/var/lib/nova/instances# ls -l 09aab3a8-3df8-474c-a8a9-a4f666f851a0\ntotal 172944\n-rw-rw---- 1 libvirt-qemu libvirt-qemu     26280 Dec 12 21:35 console.log\n-rw-r--r-- 1 libvirt-qemu libvirt-qemu 176488448 Dec 12 16:57 disk\n-rw-r--r-- 1 libvirt-qemu libvirt-qemu    432128 Dec 12 21:33 disk.config\n-rw-r--r-- 1 nova         nova               162 Dec 12 21:33 disk.info\n\n7. Do the resize from m1.small  to m1.medium  and end up with following error.\nError message : Error: Failed to perform requested operation on instance \"test\", the instance has an error status: Please try again later\n[Error: Cannot access storage file '/var/lib/nova/instances/09aab3a8-3df8-474c-a8a9-a4f666f851a0/disk' (as uid:108, gid:117): Permission denied].\n\n\nActual result:\nPermission issue occurred during migrate/resize to different host.\n\nExpected result:\nResize/migrate will be successful.\n\nNote : With universal umask migration/resize works good in the same environment.", 
            "date_created": "2016-12-16 07:19:36.131025+00:00", 
            "author": "https://api.launchpad.net/1.0/~prabhuraj"
        }, 
        {
            "content": "This is a bit of a deeper architecture change around permissions and live migration. Probably should be discussed as a spec.", 
            "date_created": "2017-01-05 15:43:16.137904+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}