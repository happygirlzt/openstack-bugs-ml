{
    "status": "Fix Released", 
    "last_updated": "2012-08-21 09:29:15.522924+00:00", 
    "description": "Description of problem:\n\nWhen resizing/migrating an instance with qcow2 image:\n\n1) nova is converting the image to raw (in order to unite it with the backing file )\n\n2012-07-16 14:06:41 DEBUG nova.utils [req-58761caf-98ab-4bea-9719-8f9472d86205 29af43364ced4611bf6e093a04d4c144 3f1e394b238d4f26b742e9685a9a1a57] Running cmd (subprocess): qemu-\nimg convert -f qcow2 -O raw /var/lib/nova/instances/instance-00000154_resize/disk /var/lib/nova/instances/instance-00000154_resize/disk_rbase from (pid=26760) execute /usr/lib/p\nython2.6/site-packages/nova/utils.py:220\n2012-07-16 14:07:00 DEBUG nova.utils [req-58761caf-98ab-4bea-9719-8f9472d86205 29af43364ced4611bf6e093a04d4c144 3f1e394b238d4f26b742e9685a9a1a57] Running cmd (subprocess): scp /\nvar/lib/nova/instances/instance-00000154_resize/disk_rbase 10.35.77.4:/var/lib/nova/instances/instance-00000154/disk from (pid=26760) execute /usr/lib/python2.6/site-packages/no\nva/utils.py:220\n\n~20 seconds\n\n2) scp copies the converted image to destination host\n\nqemu-img info:\n# qemu-img info david.disk\nimage: david.disk\nfile format: raw\nvirtual size: 10G (10737418240 bytes)\ndisk size: 947M\n\nresult: 10G of data is being copied instead of 947M.\n\n# scp david.disk root@camel-vdsb:/tmp/david.disk.copy\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0100%   10GB  41.1MB/s   04:09\n\n04:09 minutes\n\n3) afterwards in order to be able to create snapshots on this image its being converted again to qcow2 on destenation host\n\n2012-07-16 14:10:39 DEBUG nova.utils [req-58761caf-98ab-4bea-9719-8f9472d86205 29af43364ced4611bf6e093a04d4c144 3f1e394b238d4f26b742e9685a9a1a57] Running cmd (subprocess): qemu-img convert -f raw -O qcow2 /var/lib/nova/instances/instance-00000154/disk /var/lib/nova/instances/instance-00000154/disk_qcow from (pid=17788) execute /usr/lib/python2.6/site-packages/nova/utils.py:220\n\n2012-07-16 14:13:12 DEBUG nova.utils [req-58761caf-98ab-4bea-9719-8f9472d86205 29af43364ced4611bf6e093a04d4c144 3f1e394b238d4f26b742e9685a9a1a57] Running cmd (subprocess): mv /var/lib/nova/instances/instance-00000154/disk_qcow /var/lib/nova/instances/instance-00000154/disk from (pid=17788) execute /usr/lib/python2.6/site-packages/nova/utils.py:220\n\n~02:33 minutes\n\nTested alternative:\n1) convert the image from qcow2 to qcow2 (in order to unite it with the backing file )\n\n2) rsync --sparce the file to the destination\n\n# qemu-img info david.qcow.disk\nimage: david.qcow.disk\nfile format: qcow2\nvirtual size: 10G (10737418240 bytes)\ndisk size: 953M\ncluster_size: 65536\n\n# time rsync -S -v david.qcow.disk root@camel-vdsb:/tmp/david.disk.rsync-copy\ndavid.qcow.disk\n\nsent 999218356 bytes  received 31 bytes  39185034.78 bytes/sec\ntotal size is 999096320  speedup is 1.00\n\nreal\t0m24.797s\nuser\t0m20.237s\nsys\t0m4.998s\n\nExpected results:\nin this case 24 seconds instead of 4:09 minutes.\nconversion avoided after copy. (less 02:33 minutes)", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1025259", 
    "owner": "https://api.launchpad.net/1.0/~p-draigbrady", 
    "id": 1025259, 
    "index": 2946, 
    "created": "2012-07-16 13:25:00.597615+00:00", 
    "title": "[nova][resize/migrate][performance] the whole virtual size of vm's disk is being copied instead of the actual size.", 
    "comments": [
        {
            "content": "Description of problem:\n\nWhen resizing/migrating an instance with qcow2 image:\n\n1) nova is converting the image to raw (in order to unite it with the backing file )\n\n2012-07-16 14:06:41 DEBUG nova.utils [req-58761caf-98ab-4bea-9719-8f9472d86205 29af43364ced4611bf6e093a04d4c144 3f1e394b238d4f26b742e9685a9a1a57] Running cmd (subprocess): qemu-\nimg convert -f qcow2 -O raw /var/lib/nova/instances/instance-00000154_resize/disk /var/lib/nova/instances/instance-00000154_resize/disk_rbase from (pid=26760) execute /usr/lib/p\nython2.6/site-packages/nova/utils.py:220\n2012-07-16 14:07:00 DEBUG nova.utils [req-58761caf-98ab-4bea-9719-8f9472d86205 29af43364ced4611bf6e093a04d4c144 3f1e394b238d4f26b742e9685a9a1a57] Running cmd (subprocess): scp /\nvar/lib/nova/instances/instance-00000154_resize/disk_rbase 10.35.77.4:/var/lib/nova/instances/instance-00000154/disk from (pid=26760) execute /usr/lib/python2.6/site-packages/no\nva/utils.py:220\n\n~20 seconds\n\n2) scp copies the converted image to destination host\n\nqemu-img info:\n# qemu-img info david.disk\nimage: david.disk\nfile format: raw\nvirtual size: 10G (10737418240 bytes)\ndisk size: 947M\n\nresult: 10G of data is being copied instead of 947M.\n\n# scp david.disk <email address hidden>:/tmp/david.disk.copy\n                                                                                                                                   100%   10GB  41.1MB/s   04:09   \n\n04:09 minutes\n\n3) afterwards in order to be able to create snapshots on this image its being converted again to qcow2 on destenation host\n\n2012-07-16 14:10:39 DEBUG nova.utils [req-58761caf-98ab-4bea-9719-8f9472d86205 29af43364ced4611bf6e093a04d4c144 3f1e394b238d4f26b742e9685a9a1a57] Running cmd (subprocess): qemu-img convert -f raw -O qcow2 /var/lib/nova/instances/instance-00000154/disk /var/lib/nova/instances/instance-00000154/disk_qcow from (pid=17788) execute /usr/lib/python2.6/site-packages/nova/utils.py:220\n\n2012-07-16 14:13:12 DEBUG nova.utils [req-58761caf-98ab-4bea-9719-8f9472d86205 29af43364ced4611bf6e093a04d4c144 3f1e394b238d4f26b742e9685a9a1a57] Running cmd (subprocess): mv /var/lib/nova/instances/instance-00000154/disk_qcow /var/lib/nova/instances/instance-00000154/disk from (pid=17788) execute /usr/lib/python2.6/site-packages/nova/utils.py:220\n\n\n~02:33 minutes\n\nTested alternative:\n1) convert the image from qcow2 to qcow2 (in order to unite it with the backing file )\n\n2) rsync --sparce the file to the destination\n\n# qemu-img info david.qcow.disk \nimage: david.qcow.disk\nfile format: qcow2\nvirtual size: 10G (10737418240 bytes)\ndisk size: 953M\ncluster_size: 65536\n\n# time rsync -S -v david.qcow.disk <email address hidden>:/tmp/david.disk.rsync-copy\n<email address hidden>'s password: \ndavid.qcow.disk\n\nsent 999218356 bytes  received 31 bytes  39185034.78 bytes/sec\ntotal size is 999096320  speedup is 1.00\n\nreal\t0m24.797s\nuser\t0m20.237s\nsys\t0m4.998s\n\n\nExpected results:\nin this case 24 seconds instead of 4:09 minutes.\nconversion avoided after copy. (less 02:33 minutes)", 
            "date_created": "2012-07-16 13:25:00.597615+00:00", 
            "author": "https://api.launchpad.net/1.0/~davidnaori3"
        }, 
        {
            "content": "Oops this bug was logged after the code was added\r\nhttps://github.com/openstack/nova/commit/3a3ad54", 
            "date_created": "2012-08-21 09:29:11.742304+00:00", 
            "author": "https://api.launchpad.net/1.0/~p-draigbrady"
        }
    ]
}