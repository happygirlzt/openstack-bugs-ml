{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:17:37.256718+00:00", 
    "description": "The following change has been getting random failures in the py27 test job where it would time out after 50 minutes.\n\nhttps://review.openstack.org/#/c/140725/\n\neg this test run:\n\nhttp://logs.openstack.org/25/140725/11/gate/gate-nova-python27/0dabb50/\n\nStrangely other stuff going into the gate was not affected, and there's no obvious sign of what in this change would cause such a hang probem. \n\nRunning all the changed tests in isolation never showed a hang. Only when the entire nova test suite was run would it hang, so it seems like some kind of race condition is hiding there. Probably the fact that this change deletes some tests in one file and adds tests in another file makes the race more likely to occurr.\n\nReproducing the hang locally and then attaching to the procss with GDB shows the following trace that ends the in oslo.messaging fake driver\n\n(gdb) py-bt\n#3 Frame 0x8b71dd0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/oslo/messaging/_drivers/impl_fake.py, line 149, in get_exchange (self=<FakeExchangeManager(_exchanges_lock=<Semaphore(counter=0, _waiters=set([])) at remote 0x954c1d0>, _exchanges={'nova': <FakeExchange(_server_queues={('fake', 'foo'): []}, _topic_queues={('fake', None): []}, _queues_lock=<_RLock(_Verbose__verbose=False, _RLock__owner=None, _RLock__block=<Semaphore(counter=1, _waiters=set([])) at remote 0x7667f10>, _RLock__count=0) at remote 0x7667a10>, name='nova') at remote 0x7667910>}, _default_exchange='nova') at remote 0x954c850>, name='nova')\n    return self._exchanges.setdefault(name, FakeExchange(name))\n#6 Frame 0xf2281d0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/oslo/messaging/_drivers/impl_fake.py, line 63, in poll (self=<FakeListener(_pool=None, _targets=[<Target(version=None, exchange='nova', namespace=None, server='foo', topic='fake', fanout=None) at remote 0x7667cd0>, <Target(version=None, exchange='nova', namespace=None, server=None, topic='fake', fanout=None) at remote 0x7667790>], driver=<FakeDriver(_allowed_remote_exmods=['nova.exception', 'nova.test'], _exchange_manager=<FakeExchangeManager(_exchanges_lock=<Semaphore(counter=0, _waiters=set([])) at remote 0x954c1d0>, _exchanges={'nova': <FakeExchange(_server_queues={('fake', 'foo'): []}, _topic_queues={('fake', None): []}, _queues_lock=<_RLock(_Verbose__verbose=False, _RLock__owner=None, _RLock__block=<Semaphore(counter=1, _waiters=set([])) at remote 0x7667f10>, _RLock__count=0) at remote 0x7667a10>, name='nova') at remote 0x7667910>}, _default_exchange='nova') at remote 0x954c850>, _url=<TransportURL(hosts=[], _tr...(truncated)\n    exchange = self._exchange_manager.get_exchange(target.exchange)\n#10 Frame 0x710e9d0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/oslo/messaging/_executors/impl_eventlet.py, line 88, in _executor_thread (incoming=None)\n    incoming = self.listener.poll(timeout=base.POLL_TIMEOUT)\n#15 Frame 0x8204da0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/oslo_utils/excutils.py, line 92, in inner_func (args=(), kwargs={}, last_log_time=1421749084, last_exc_message=u'', exc_count=0, exc=<TimeoutException at remote 0x10824a50>, this_exc_message=u'', cur_time=1421749084)\n    return infunc(*args, **kwargs)\n#20 Frame 0x102669a0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/eventlet/greenthread.py, line 214, in main (self=<GreenThread(_exit_funcs=<collections.deque at remote 0x10608050>, _exit_event=<Event(_result=<NOT_USED() at remote 0x23f6c20>, _waiters=set([]), _exc=None) at remote 0x7667150>, _resolving_links=False) at remote 0xe1d6eb0>, function=<function at remote 0xe47f8c0>, args=(), kwargs={})\n    result = function(*args, **kwargs)\n#31 Frame 0x84deca0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/eventlet/hubs/timer.py, line 58, in __call__ (self=<Timer(seconds=<float at remote 0xbf93860>, tpl=(<built-in method switch of GreenThread object at remote 0xe1d6eb0>, (), {}), called=True) at remote 0xcedeb90>, args=(...), cb=<built-in method switch of GreenThread object at remote 0xe1d6eb0>, kw={...})\n    cb(*args, **kw)\n#41 Frame 0xf1e5ff0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/eventlet/hubs/hub.py, line 457, in fire_timers (self=<Hub(next_timers=[], clock=<built-in function time>, debug_exceptions=True, debug_blocking_resolution=1, modify=<built-in method modify of select.epoll object at remote 0xe80eca8>, running=True, debug_blocking=False, listeners={'read': {11: <FdListener(fileno=11, cb=<built-in method switch of GreenThread object at remote 0xe1d6c30>, spent=False, greenlet=<GreenThread(_exit_funcs=<collections.deque at remote 0xe1a5210>, _exit_event=<Event(_result=<NOT_USED() at remote 0x23f6c20>, _waiters=set([]), _exc=None) at remote 0x10938950>, _resolving_links=False) at remote 0xe1d6c30>, evtype='read', mark_as_closed=<instancemethod at remote 0xdde30a0>, tb=<built-in method throw of GreenThread object at remote 0xe1d6c30>) at remote 0x10938cd0>, 13: <FdListener(fileno=13, cb=<built-in method switch of GreenThread object at remote 0xef42c30>, spent=False, greenlet=<GreenThread(_...(truncated)\n    timer()\n#44 Frame 0xd7d4970, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/eventlet/hubs/hub.py, line 336, in run (self=<Hub(next_timers=[], clock=<built-in function time>, debug_exceptions=True, debug_blocking_resolution=1, modify=<built-in method modify of select.epoll object at remote 0xe80eca8>, running=True, debug_blocking=False, listeners={'read': {11: <FdListener(fileno=11, cb=<built-in method switch of GreenThread object at remote 0xe1d6c30>, spent=False, greenlet=<GreenThread(_exit_funcs=<collections.deque at remote 0xe1a5210>, _exit_event=<Event(_result=<NOT_USED() at remote 0x23f6c20>, _waiters=set([]), _exc=None) at remote 0x10938950>, _resolving_links=False) at remote 0xe1d6c30>, evtype='read', mark_as_closed=<instancemethod at remote 0xdde30a0>, tb=<built-in method throw of GreenThread object at remote 0xe1d6c30>) at remote 0x10938cd0>, 13: <FdListener(fileno=13, cb=<built-in method switch of GreenThread object at remote 0xef42c30>, spent=False, greenlet=<GreenThread(_exit_fun...(truncated)\n    self.fire_timers(self.clock())\n\n\nUpon Ctrl-C'ing the hung test suite it shows it was trying to run this test case at the time:\n\n^C{1} nova.tests.unit.virt.libvirt.test_volume.LibvirtVolumeTestCase.test_libvirt_kvm_iser_volume_with_multipath_getmpdev [] ... inprogress\nTraceback (most recent call last):\n  File \"/home/berrange/src/cloud/nova/.tox/py27/bin/subunit-trace\", line 11, in <module>\n    sys.exit(main())\n  File \"/home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/tempest_lib/cmd/subunit_trace.py\", line 257, in main\n    stream.run(result)\n  File \"/home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/subunit/v2.py\", line 270, in run\n    content = self.source.read(1)\nKeyboardInterrupt\nERROR: KEYBOARDINTERRUPT\ninterrupted\nERROR: keyboardinterrupt\n\n\nAgain, running that test case in isolation never fails.\n\n\nSeeing this recent commit\n\ncommit 2809fab96c4b48f2a979965b3f4788dfb1379977\nAuthor: Sean Dague <email address hidden>\nDate:   Fri Jan 16 14:41:24 2015 -0500\n\n    increase fake rpc POLL_TIMEOUT to 0.1s\n    \n    The 0.001s POLL_TIMEOUT appeared related to an intermitent race\n    issue. The polling loop in the fake driver in oslo.messaging is 0.05s,\n    so increase to 0.1 total time out to make sure we get at least one\n    full polling cycle on waits.\n    \n    Change-Id: I24a83638df0c8f3f84bb528333a91491a98016a3\n\nsuggests to me that the problem could be related to the fact that the nova.tests.unit.virt.libvirt.test_volume.LibvirtVolumeTestCase.test_libvirt_kvm_iser_volume_with_multipath_getmpdev  test stubs out  time.sleep to be a no-op", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1412742", 
    "owner": "https://api.launchpad.net/1.0/~berrange", 
    "id": 1412742, 
    "index": 1671, 
    "created": "2015-01-20 11:00:23.521346+00:00", 
    "title": "tests randomly hang in oslo.messaging fake driver", 
    "comments": [
        {
            "content": "The following change has been getting random failures in the py27 test job where it would time out after 50 minutes.\n\nhttps://review.openstack.org/#/c/140725/\n\neg this test run:\n\nhttp://logs.openstack.org/25/140725/11/gate/gate-nova-python27/0dabb50/\n\nStrangely other stuff going into the gate was not affected, and there's no obvious sign of what in this change would cause such a hang probem. \n\nRunning all the changed tests in isolation never showed a hang. Only when the entire nova test suite was run would it hang, so it seems like some kind of race condition is hiding there. Probably the fact that this change deletes some tests in one file and adds tests in another file makes the race more likely to occurr.\n\nReproducing the hang locally and then attaching to the procss with GDB shows the following trace that ends the in oslo.messaging fake driver\n\n(gdb) py-bt\n#3 Frame 0x8b71dd0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/oslo/messaging/_drivers/impl_fake.py, line 149, in get_exchange (self=<FakeExchangeManager(_exchanges_lock=<Semaphore(counter=0, _waiters=set([])) at remote 0x954c1d0>, _exchanges={'nova': <FakeExchange(_server_queues={('fake', 'foo'): []}, _topic_queues={('fake', None): []}, _queues_lock=<_RLock(_Verbose__verbose=False, _RLock__owner=None, _RLock__block=<Semaphore(counter=1, _waiters=set([])) at remote 0x7667f10>, _RLock__count=0) at remote 0x7667a10>, name='nova') at remote 0x7667910>}, _default_exchange='nova') at remote 0x954c850>, name='nova')\n    return self._exchanges.setdefault(name, FakeExchange(name))\n#6 Frame 0xf2281d0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/oslo/messaging/_drivers/impl_fake.py, line 63, in poll (self=<FakeListener(_pool=None, _targets=[<Target(version=None, exchange='nova', namespace=None, server='foo', topic='fake', fanout=None) at remote 0x7667cd0>, <Target(version=None, exchange='nova', namespace=None, server=None, topic='fake', fanout=None) at remote 0x7667790>], driver=<FakeDriver(_allowed_remote_exmods=['nova.exception', 'nova.test'], _exchange_manager=<FakeExchangeManager(_exchanges_lock=<Semaphore(counter=0, _waiters=set([])) at remote 0x954c1d0>, _exchanges={'nova': <FakeExchange(_server_queues={('fake', 'foo'): []}, _topic_queues={('fake', None): []}, _queues_lock=<_RLock(_Verbose__verbose=False, _RLock__owner=None, _RLock__block=<Semaphore(counter=1, _waiters=set([])) at remote 0x7667f10>, _RLock__count=0) at remote 0x7667a10>, name='nova') at remote 0x7667910>}, _default_exchange='nova') at remote 0x954c850>, _url=<TransportURL(hosts=[], _tr...(truncated)\n    exchange = self._exchange_manager.get_exchange(target.exchange)\n#10 Frame 0x710e9d0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/oslo/messaging/_executors/impl_eventlet.py, line 88, in _executor_thread (incoming=None)\n    incoming = self.listener.poll(timeout=base.POLL_TIMEOUT)\n#15 Frame 0x8204da0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/oslo_utils/excutils.py, line 92, in inner_func (args=(), kwargs={}, last_log_time=1421749084, last_exc_message=u'', exc_count=0, exc=<TimeoutException at remote 0x10824a50>, this_exc_message=u'', cur_time=1421749084)\n    return infunc(*args, **kwargs)\n#20 Frame 0x102669a0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/eventlet/greenthread.py, line 214, in main (self=<GreenThread(_exit_funcs=<collections.deque at remote 0x10608050>, _exit_event=<Event(_result=<NOT_USED() at remote 0x23f6c20>, _waiters=set([]), _exc=None) at remote 0x7667150>, _resolving_links=False) at remote 0xe1d6eb0>, function=<function at remote 0xe47f8c0>, args=(), kwargs={})\n    result = function(*args, **kwargs)\n#31 Frame 0x84deca0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/eventlet/hubs/timer.py, line 58, in __call__ (self=<Timer(seconds=<float at remote 0xbf93860>, tpl=(<built-in method switch of GreenThread object at remote 0xe1d6eb0>, (), {}), called=True) at remote 0xcedeb90>, args=(...), cb=<built-in method switch of GreenThread object at remote 0xe1d6eb0>, kw={...})\n    cb(*args, **kw)\n#41 Frame 0xf1e5ff0, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/eventlet/hubs/hub.py, line 457, in fire_timers (self=<Hub(next_timers=[], clock=<built-in function time>, debug_exceptions=True, debug_blocking_resolution=1, modify=<built-in method modify of select.epoll object at remote 0xe80eca8>, running=True, debug_blocking=False, listeners={'read': {11: <FdListener(fileno=11, cb=<built-in method switch of GreenThread object at remote 0xe1d6c30>, spent=False, greenlet=<GreenThread(_exit_funcs=<collections.deque at remote 0xe1a5210>, _exit_event=<Event(_result=<NOT_USED() at remote 0x23f6c20>, _waiters=set([]), _exc=None) at remote 0x10938950>, _resolving_links=False) at remote 0xe1d6c30>, evtype='read', mark_as_closed=<instancemethod at remote 0xdde30a0>, tb=<built-in method throw of GreenThread object at remote 0xe1d6c30>) at remote 0x10938cd0>, 13: <FdListener(fileno=13, cb=<built-in method switch of GreenThread object at remote 0xef42c30>, spent=False, greenlet=<GreenThread(_...(truncated)\n    timer()\n#44 Frame 0xd7d4970, for file /home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/eventlet/hubs/hub.py, line 336, in run (self=<Hub(next_timers=[], clock=<built-in function time>, debug_exceptions=True, debug_blocking_resolution=1, modify=<built-in method modify of select.epoll object at remote 0xe80eca8>, running=True, debug_blocking=False, listeners={'read': {11: <FdListener(fileno=11, cb=<built-in method switch of GreenThread object at remote 0xe1d6c30>, spent=False, greenlet=<GreenThread(_exit_funcs=<collections.deque at remote 0xe1a5210>, _exit_event=<Event(_result=<NOT_USED() at remote 0x23f6c20>, _waiters=set([]), _exc=None) at remote 0x10938950>, _resolving_links=False) at remote 0xe1d6c30>, evtype='read', mark_as_closed=<instancemethod at remote 0xdde30a0>, tb=<built-in method throw of GreenThread object at remote 0xe1d6c30>) at remote 0x10938cd0>, 13: <FdListener(fileno=13, cb=<built-in method switch of GreenThread object at remote 0xef42c30>, spent=False, greenlet=<GreenThread(_exit_fun...(truncated)\n    self.fire_timers(self.clock())\n\n\nUpon Ctrl-C'ing the hung test suite it shows it was trying to run this test case at the time:\n\n^C{1} nova.tests.unit.virt.libvirt.test_volume.LibvirtVolumeTestCase.test_libvirt_kvm_iser_volume_with_multipath_getmpdev [] ... inprogress\nTraceback (most recent call last):\n  File \"/home/berrange/src/cloud/nova/.tox/py27/bin/subunit-trace\", line 11, in <module>\n    sys.exit(main())\n  File \"/home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/tempest_lib/cmd/subunit_trace.py\", line 257, in main\n    stream.run(result)\n  File \"/home/berrange/src/cloud/nova/.tox/py27/lib/python2.7/site-packages/subunit/v2.py\", line 270, in run\n    content = self.source.read(1)\nKeyboardInterrupt\nERROR: KEYBOARDINTERRUPT\ninterrupted\nERROR: keyboardinterrupt\n\n\nAgain, running that test case in isolation never fails.\n\n\nSeeing this recent commit\n\ncommit 2809fab96c4b48f2a979965b3f4788dfb1379977\nAuthor: Sean Dague <email address hidden>\nDate:   Fri Jan 16 14:41:24 2015 -0500\n\n    increase fake rpc POLL_TIMEOUT to 0.1s\n    \n    The 0.001s POLL_TIMEOUT appeared related to an intermitent race\n    issue. The polling loop in the fake driver in oslo.messaging is 0.05s,\n    so increase to 0.1 total time out to make sure we get at least one\n    full polling cycle on waits.\n    \n    Change-Id: I24a83638df0c8f3f84bb528333a91491a98016a3\n\nsuggests to me that the problem could be related to the fact that the nova.tests.unit.virt.libvirt.test_volume.LibvirtVolumeTestCase.test_libvirt_kvm_iser_volume_with_multipath_getmpdev  test stubs out  time.sleep to be a no-op", 
            "date_created": "2015-01-20 11:00:23.521346+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/148510", 
            "date_created": "2015-01-20 11:59:48.664708+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "So some further analysis on why the problem happens.\n\nIn ./oslo/messaging/_drivers/impl_fake.py the FakeListener has a loop looking for messages and this loop calls time.sleep() on each iteration\n\nIn Nova, we monkeypatch time.sleep with eventlet.sleep, so any code which calls time.sleep allows eventlet to re-schedule another thread.\n\nIn Nova test.py we register a RPCFixture which results in the oslo messaging fake driver being activated as a background green thread.\n\nIn the test_volume.py test cases touched in this patch the time.sleep call is mocked out to be a no-op. Critically this *removes* the eventlet monkey patching.\n\nDuring the execution of the test, something causes eventlet to activate the oslo messaging green thread for the fake driver. Since time.sleep is no a no-op, this green thread will *never* trigger the eventlet schedula again.\n\nWe're stuck in the oslo messaging thread forever.\n\nSo the take away from this is that monkey patching time.sleep into a no-op is *always* wrong, regardless of this oslo.messaging scenario. It is a bug just waiting to strike because we've removed eventlets monkey patching and so prevent scheduling\n\nAny time you monkey patch time.sleep you *must* call either eventlet.sleep or eventlet.yield to allow it to reschedule normally.", 
            "date_created": "2015-01-21 12:25:56.771914+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/148510\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=cf9d5f371c0c02bfc38a9479898d64c7f234f787\nSubmitter: Jenkins\nBranch:    master\n\ncommit cf9d5f371c0c02bfc38a9479898d64c7f234f787\nAuthor: Daniel P. Berrange <email address hidden>\nDate:   Tue Jan 20 11:48:33 2015 +0000\n\n    libvirt: don't turn time.sleep into a no-op in tests\n    \n    Turning time.sleep into a complete no-op causes non-deterministic\n    hangs in the oslo.messaging fake driver, which causes the tox test\n    run to timeout randomly. Take inspiration from\n    \n      commit 2809fab96c4b48f2a979965b3f4788dfb1379977\n      Author: Sean Dague <email address hidden>\n      Date:   Fri Jan 16 14:41:24 2015 -0500\n    \n        increase fake rpc POLL_TIMEOUT to 0.1s\n    \n    and have it sleep for 0.1 seconds instead of being a no-op.\n    \n    Closes-bug: #1412742\n    Change-Id: I45707cd11a101efd181654b5dd483cdd9168bb84\n", 
            "date_created": "2015-01-22 04:15:34.300407+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/156584", 
            "date_created": "2015-02-17 13:35:23.259107+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/156584\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0ef6f1532995093c2bae2904801a6efe520bd896\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0ef6f1532995093c2bae2904801a6efe520bd896\nAuthor: Matthew Gilliard <email address hidden>\nDate:   Tue Feb 17 13:31:21 2015 +0000\n\n    Don't mock time.sleep with None\n    \n    Patching time.sleep with 'None' is always the wrong\n    thing to do, because it removes the ability for the\n    thread scheduler to do anything useful, changes the\n    semantics of the system-under-test and may lead to\n    deadlocks. Patch with eventlet.sleep(0) instead.\n    \n    See Dan Berrange's analysis in comment #2 at\n    https://bugs.launchpad.net/nova/+bug/1412742\n    \n    Change-Id: Iad6cb63cb579bb9e0d8ef0c6e626c80053468157\n    related-bug: #1412742\n", 
            "date_created": "2015-02-17 19:52:15.147558+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}