{
    "status": "Won't Fix", 
    "last_updated": "2013-03-11 19:48:32.368961+00:00", 
    "description": "openstack-nova version: Essex\n\nI saw that if I terminated an instance with several 'Terminate Instance' operations on horizon, and if the first operation was blocked by and reason such as Host is too busy to delete the instance's disk&dir quickly enough, because the first operation will get the instance lock, so the the rest of operations will wait for it at here:\n        @utils.synchronized(instance_uuid)\n        def do_terminate_instance():\nwhen the first operation was done successfully, the rest of operations will go ahead to delete the 'deleted instance' by 'do_terminate_instance', when they searched this instance from db by 'instance = self.db.instance_get_by_uuid(elevated, instance_uuid)', the InstanceNotFound exception will be raised:\n2012-09-05 16:59:33 ERROR nova.rpc.amqp [req-f50e5c63-dc90-4852-8327-31382ba17262 4969d06c67034c148be51e0147f28b10 844dc9fb4ad9499ea97b07c7b6cee137] Exception during message handling\n2012-09-05 16:59:33 TRACE nova.rpc.amqp Traceback (most recent call last):\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 253, in _process_data\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     rval = node_func(context=ctxt, **node_args)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 114, in wrapped\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     return f(*args, **kw)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 159, in decorated_function\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     function(self, context, instance_uuid, *args, **kwargs)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 177, in decorated_function\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     return function(self, context, instance_uuid, *args, **kwargs)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 759, in terminate_instance\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     do_terminate_instance()\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 945, in inner\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     retval = f(*args, **kwargs)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 749, in do_terminate_instance\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     instance = self.db.instance_get_by_uuid(elevated, instance_uuid)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 535, in instance_get_by_uuid\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     return IMPL.instance_get_by_uuid(context, uuid)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 120, in wrapper\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     return f(*args, **kwargs)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 1327, in instance_get_by_uuid\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     raise exception.InstanceNotFound(instance_id=uuid)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp InstanceNotFound: Instance 71f0107d-f3aa-4bb8-acd2-2b623dfd42a7 could not be found.\n2012-09-05 16:59:33 TRACE nova.rpc.amqp\n\nI think this is a race problem, and should NOT be raised as an error, may be we should catch this exception and just LOG an warning for this. what guys think about this?", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1046685", 
    "owner": "None", 
    "id": 1046685, 
    "index": 3081, 
    "created": "2012-09-06 06:55:19.515901+00:00", 
    "title": "InstanceNotFound exception was raised when more than one 'terminate_instance' operation was implemented if the first operation was blocked a period of time.", 
    "comments": [
        {
            "content": "openstack-nova version: Essex\n\nI saw that if I terminated an instance with several 'Terminate Instance' operations on horizon, and if the first operation was blocked by and reason such as Host is too busy to delete the instance's disk&dir quickly enough, because the first operation will get the instance lock, so the the rest of operations will wait for it at here:\n        @utils.synchronized(instance_uuid)\n        def do_terminate_instance():\nwhen the first operation was done successfully, the rest of operations will go ahead to delete the 'deleted instance' by 'do_terminate_instance', when they searched this instance from db by 'instance = self.db.instance_get_by_uuid(elevated, instance_uuid)', the InstanceNotFound exception will be raised:\n2012-09-05 16:59:33 ERROR nova.rpc.amqp [req-f50e5c63-dc90-4852-8327-31382ba17262 4969d06c67034c148be51e0147f28b10 844dc9fb4ad9499ea97b07c7b6cee137] Exception during message handling\n2012-09-05 16:59:33 TRACE nova.rpc.amqp Traceback (most recent call last):\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 253, in _process_data\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     rval = node_func(context=ctxt, **node_args)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 114, in wrapped\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     return f(*args, **kw)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 159, in decorated_function\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     function(self, context, instance_uuid, *args, **kwargs)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 177, in decorated_function\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     return function(self, context, instance_uuid, *args, **kwargs)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 759, in terminate_instance\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     do_terminate_instance()\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 945, in inner\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     retval = f(*args, **kwargs)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 749, in do_terminate_instance\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     instance = self.db.instance_get_by_uuid(elevated, instance_uuid)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 535, in instance_get_by_uuid\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     return IMPL.instance_get_by_uuid(context, uuid)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 120, in wrapper\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     return f(*args, **kwargs)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 1327, in instance_get_by_uuid\n2012-09-05 16:59:33 TRACE nova.rpc.amqp     raise exception.InstanceNotFound(instance_id=uuid)\n2012-09-05 16:59:33 TRACE nova.rpc.amqp InstanceNotFound: Instance 71f0107d-f3aa-4bb8-acd2-2b623dfd42a7 could not be found.\n2012-09-05 16:59:33 TRACE nova.rpc.amqp\n\nI think this is a race problem, and should NOT be raised as an error, may be we should catch this exception and just LOG an warning for this. what guys think about this?", 
            "date_created": "2012-09-06 06:55:19.515901+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Makes sense. I expect this doesn't affect folsom, but someone should verify.", 
            "date_created": "2012-09-10 19:49:21.363915+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "My reading of the code is that this bug does not exist in grizzly or folsom and essex only gets security fixes now.", 
            "date_created": "2013-03-11 19:47:45.248556+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }
    ]
}