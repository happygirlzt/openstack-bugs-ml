{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:15:23.148976+00:00", 
    "description": "I can reproduce this bug in master and stable havana.\n\nthis bug is similar to https://bugs.launchpad.net/nova/+bug/1158897\nbut this bug is cause by _reserve_quota_delta() method, which will need to access DB if quota delta is not empty,\nthe trace log is:\n2013-12-19 01:39:40.879 ERROR nova.compute [-] No db access allowed in nova-compute:\nFile \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n\u00a0\u00a0\u00a0\u00a0result = function(*args, **kwargs)\n\u00a0\u00a0File \"/opt/stack/nova/nova/openstack/common/loopingcall.py\", line 125, in _inner\n\u00a0\u00a0\u00a0\u00a0idle = self.f(*self.args, **self.kw)\n\u00a0\u00a0File \"/opt/stack/nova/nova/service.py\", line 314, in periodic_tasks\n\u00a0\u00a0\u00a0\u00a0return self.manager.periodic_tasks(ctxt, raise_on_error=raise_on_error)\n\u00a0\u00a0File \"/opt/stack/nova/nova/manager.py\", line 101, in periodic_tasks\n\u00a0\u00a0\u00a0\u00a0return self.run_periodic_tasks(context, raise_on_error=raise_on_error)\n\u00a0\u00a0File \"/opt/stack/nova/nova/openstack/common/periodic_task.py\", line 180, in run_periodic_tasks\n\u00a0\u00a0\u00a0\u00a0task(self, context)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 4535, in _poll_unconfirmed_resizes\n\u00a0\u00a0\u00a0\u00a0migration=migration)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/api.py\", line 199, in wrapped\n\u00a0\u00a0\u00a0\u00a0return func(self, context, target, *args, **kwargs)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/api.py\", line 189, in inner\n\u00a0\u00a0\u00a0\u00a0return function(self, context, instance, *args, **kwargs)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/api.py\", line 216, in _wrapped\n\u00a0\u00a0\u00a0\u00a0return fn(self, context, instance, *args, **kwargs)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/api.py\", line 170, in inner\n\u00a0\u00a0\u00a0\u00a0return f(self, context, instance, *args, **kw)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/api.py\", line 2158, in confirm_resize\n\u00a0\u00a0\u00a0\u00a0reservations = self._reserve_quota_delta(context, deltas)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/api.py\", line 2238, in _reserve_quota_delta\n\u00a0\u00a0\u00a0\u00a0return QUOTAS.reserve(context, project_id=project_id, **deltas)\n\u00a0\u00a0File \"/opt/stack/nova/nova/quota.py\", line 1272, in reserve\n\u00a0\u00a0\u00a0\u00a0user_id=user_id)\n\u00a0\u00a0File \"/opt/stack/nova/nova/quota.py\", line 487, in reserve\n\u00a0\u00a0\u00a0\u00a0has_sync=True, project_id=project_id)\n\u00a0\u00a0File \"/opt/stack/nova/nova/quota.py\", line 354, in _get_quotas\n\u00a0\u00a0\u00a0\u00a0usages=False)\n\u00a0\u00a0File \"/opt/stack/nova/nova/quota.py\", line 264, in get_project_quotas\n\u00a0\u00a0\u00a0\u00a0project_quotas = db.quota_get_all_by_project(context, project_id)\n\u00a0\u00a0File \"/opt/stack/nova/nova/db/api.py\", line 1023, in quota_get_all_by_project\n\u00a0\u00a0\u00a0\u00a0return IMPL.quota_get_all_by_project(context, project_id)\n\u00a0\u00a0File \"/opt/stack/nova/nova/cmd/compute.py\", line 48, in __call__\n\u00a0\u00a0\u00a0\u00a0stacktrace = \"\".join(traceback.format_stack())\n\n2013-12-19 01:39:40.879 ERROR nova.compute.manager [-] [instance: 4ffaabaf-a480-421f-a7a7-efd148d7c956] Error auto-confirming resize: nova-compute. Will retry later.", 
    "tags": [
        "havana-backport-potential", 
        "icehouse-rc-potential"
    ], 
    "importance": "Medium", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1262461", 
    "owner": "https://api.launchpad.net/1.0/~hzwangpan", 
    "id": 1262461, 
    "index": 3748, 
    "created": "2013-12-19 01:55:40.901521+00:00", 
    "title": "resize auto-confirmation failed with nova-conductor because of db access in nova-compute", 
    "comments": [
        {
            "content": "this bug is similar to https://bugs.launchpad.net/nova/+bug/1158897\nbut this bug is cause by _reserve_quota_delta() method, which will need to access DB if quota delta is not empty,\nthe trace log is:\n2013-12-19 01:39:40.879 ERROR nova.compute [-] No db access allowed in nova-compute:   \nFile \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/openstack/common/loopingcall.py\", line 125, in _inner\n    idle = self.f(*self.args, **self.kw)\n  File \"/opt/stack/nova/nova/service.py\", line 314, in periodic_tasks\n    return self.manager.periodic_tasks(ctxt, raise_on_error=raise_on_error)\n  File \"/opt/stack/nova/nova/manager.py\", line 101, in periodic_tasks\n    return self.run_periodic_tasks(context, raise_on_error=raise_on_error)\n  File \"/opt/stack/nova/nova/openstack/common/periodic_task.py\", line 180, in run_periodic_tasks\n    task(self, context)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 4535, in _poll_unconfirmed_resizes\n    migration=migration)\n  File \"/opt/stack/nova/nova/compute/api.py\", line 199, in wrapped\n    return func(self, context, target, *args, **kwargs)\n  File \"/opt/stack/nova/nova/compute/api.py\", line 189, in inner\n    return function(self, context, instance, *args, **kwargs)\n  File \"/opt/stack/nova/nova/compute/api.py\", line 216, in _wrapped\n    return fn(self, context, instance, *args, **kwargs)\n  File \"/opt/stack/nova/nova/compute/api.py\", line 170, in inner\n    return f(self, context, instance, *args, **kw)\n  File \"/opt/stack/nova/nova/compute/api.py\", line 2158, in confirm_resize\n    reservations = self._reserve_quota_delta(context, deltas)\n  File \"/opt/stack/nova/nova/compute/api.py\", line 2238, in _reserve_quota_delta\n    return QUOTAS.reserve(context, project_id=project_id, **deltas)\n  File \"/opt/stack/nova/nova/quota.py\", line 1272, in reserve\n    user_id=user_id)\n  File \"/opt/stack/nova/nova/quota.py\", line 487, in reserve\n    has_sync=True, project_id=project_id)\n  File \"/opt/stack/nova/nova/quota.py\", line 354, in _get_quotas\n    usages=False)\n  File \"/opt/stack/nova/nova/quota.py\", line 264, in get_project_quotas\n    project_quotas = db.quota_get_all_by_project(context, project_id)\n  File \"/opt/stack/nova/nova/db/api.py\", line 1023, in quota_get_all_by_project\n    return IMPL.quota_get_all_by_project(context, project_id)\n  File \"/opt/stack/nova/nova/cmd/compute.py\", line 48, in __call__\n    stacktrace = \"\".join(traceback.format_stack())\n\n2013-12-19 01:39:40.879 ERROR nova.compute.manager [-] [instance: 4ffaabaf-a480-421f-a7a7-efd148d7c956] Error auto-confirming resize: nova-compute. Will retry later.", 
            "date_created": "2013-12-19 01:55:40.901521+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/63305", 
            "date_created": "2013-12-20 04:13:09.655312+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "there also has a bug of quota reservation and usage in auto confirmation process, even the db access is allowed.\nthe reservation in db is like below(project_id and user_id is NULL):\n| created_at          | updated_at | deleted_at          | id | uuid                                 | usage_id | project_id                       | resource  | delta | expire              | deleted | user_id\n| 2013-12-20 03:39:01 | NULL       | 2013-12-20 03:39:12 | 26 | 1fda83bf-0cdf-47f2-b88e-78527444d070 |        8 | NULL                             | ram       |  -448 | 2013-12-21 03:39:01 |      26 | NULL\n\nit will be commited to NULL project after confirmation, not the instance's project:\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource  | in_use | reserved | until_refresh | deleted | user_id\n| 2013-12-20 03:39:01 | 2013-12-20 03:39:12 | NULL       |  8 | NULL                             | ram       |   -448 |        0 |          NULL |       0 | NULL\n\nthis is because the context is generated in nova-compute(in the periodic task process),\nso the project_id and user_id are all None, but the qutoa reserve method need them(project_id at least).", 
            "date_created": "2013-12-20 07:26:54.661631+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/81099\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=5ebc60c48d4a8b6c7bac96d923626df9ae67a2b2\nSubmitter: Jenkins\nBranch:    master\n\ncommit 5ebc60c48d4a8b6c7bac96d923626df9ae67a2b2\nAuthor: Matt Riedemann <email address hidden>\nDate:   Mon Mar 17 05:14:10 2014 -0700\n\n    Make compute API resize methods use Quotas objects\n    \n    The compute API's various resize methods are using the old-style quota\n    class to reserve and commit quota changes directly to the database. This\n    change uses quotas objects to do the reserve and commit instead so those\n    operations go through conductor for the database access.\n    \n    Note that the long-term goal is to pass the quota object over RPC\n    rather than the reservations list, but that's a larger patch which\n    is not necessary for the bug fix.\n    \n    Closes-Bug: #1262461\n    \n    Change-Id: Id18357f449193d25287f32bb8ffbf26ee2194a22\n", 
            "date_created": "2014-03-20 15:52:42.402956+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}