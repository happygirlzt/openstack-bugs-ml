{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:59:43.548800+00:00", 
    "description": "Right now, when booting an instance from an image a new BDM (origin=image, destination=local) is created for the image. The entry in the database for this BDM is not marked as deleted when destroying the instance:\n\n$ nova boot --flavor m1.nano --image cirros-0.3.1-x86_64-uec server\n$ nova list\n+--------------------------------------+-------+---------+------------+-------------+---------------------+\n| ID                                   | Name  | Status | Task State | Power State | Networks            |\n+--------------------------------------+-------+---------+------------+-------------+---------------------+\n| 955d08de-dea7-44e8-b04a-f9993072ceec | server | ACTIVE | None       | Running     | private=172.30.42.2 |\n+--------------------------------------+-------+---------+------------+-------------+---------------------+\n\nmysql> select source_type, destination_type, image_id, instance_uuid, deleted from block_device_mapping where instance_uuid = '955d08de-dea7-44e8-b04a-f9993072ceec';\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+\n| source_type | destination_type | image_id                             | instance_uuid                        | deleted |\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+\n| image       | local            | 7ee18238-5e5c-4778-af28-c649acdb0256 | 955d08de-dea7-44e8-b04a-f9993072ceec |       0 |\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+\n1 row in set (0.00 sec)\n\n$ nova delete server\n\nmysql> select source_type, destination_type, image_id, instance_uuid, deleted from block_device_mapping where instance_uuid = '955d08de-dea7-44e8-b04a-f9993072ceec';\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+\n| source_type | destination_type | image_id                             | instance_uuid                        | deleted |\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+\n| image       | local            | 7ee18238-5e5c-4778-af28-c649acdb0256 | 955d08de-dea7-44e8-b04a-f9993072ceec |       0 |\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1206890", 
    "owner": "https://api.launchpad.net/1.0/~ndipanov", 
    "id": 1206890, 
    "index": 3903, 
    "created": "2013-07-31 11:49:03.044975+00:00", 
    "title": "Deleting an instance should clean all the BDMs from the database too", 
    "comments": [
        {
            "content": "Right now, when booting an instance from an image a new BDM (origin=image, destination=local) is created for the image. The entry in the database for this BDM is not marked as deleted when destroying the instance:\n\n$ nova boot --flavor m1.nano --image cirros-0.3.1-x86_64-uec server\n$ nova list\n+--------------------------------------+-------+---------+------------+-------------+---------------------+\n| ID                                   | Name  | Status | Task State | Power State | Networks            |\n+--------------------------------------+-------+---------+------------+-------------+---------------------+\n| 955d08de-dea7-44e8-b04a-f9993072ceec | server | ACTIVE | None       | Running     | private=172.30.42.2 |\n+--------------------------------------+-------+---------+------------+-------------+---------------------+\n\nmysql> select source_type, destination_type, image_id, instance_uuid, deleted from block_device_mapping where instance_uuid = '955d08de-dea7-44e8-b04a-f9993072ceec';\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+\n| source_type | destination_type | image_id                             | instance_uuid                        | deleted |\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+\n| image       | local            | 7ee18238-5e5c-4778-af28-c649acdb0256 | 955d08de-dea7-44e8-b04a-f9993072ceec |       0 |\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+\n1 row in set (0.00 sec)\n\n$ nova delete server\n\nmysql> select source_type, destination_type, image_id, instance_uuid, deleted from block_device_mapping where instance_uuid = '955d08de-dea7-44e8-b04a-f9993072ceec';\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+\n| source_type | destination_type | image_id                             | instance_uuid                        | deleted |\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+\n| image       | local            | 7ee18238-5e5c-4778-af28-c649acdb0256 | 955d08de-dea7-44e8-b04a-f9993072ceec |       0 |\n+-------------+------------------+--------------------------------------+--------------------------------------+---------+", 
            "date_created": "2013-07-31 11:49:03.044975+00:00", 
            "author": "https://api.launchpad.net/1.0/~xqueralt-deactivatedaccount"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/39531", 
            "date_created": "2013-07-31 17:23:04.060189+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/39531\nCommitted: http://github.com/openstack/nova/commit/d9ce3394086de476c1aaef3b7e72a73d2ef28f25\nSubmitter: Jenkins\nBranch:    master\n\ncommit d9ce3394086de476c1aaef3b7e72a73d2ef28f25\nAuthor: Nikola Dipanov <email address hidden>\nDate:   Wed Jul 31 19:18:19 2013 +0200\n\n    Fix leaking of image BDMs\n    \n    Patch Ia89d531be71c460f1f82fcfce34b270639a23061 introduce creating an\n    image block device for every instance, to comply with the new block\n    device format being introduced currently.\n    \n    However, due to a mistake during rebase the needed code to delete those\n    once the instance was being deleted was broken (even though comments\n    suggest otherwise).\n    \n    This patch now fixes this issue, by adding a proper flag to the\n    conductor call when getting BDMs in compute manager's _complete_deletion\n    method.\n    \n    Fixes bug: #1206890\n    \n    Change-Id: I6a9673758b0762f99f27860b8f88a16127da7399\n", 
            "date_created": "2013-08-13 09:55:15.692049+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}