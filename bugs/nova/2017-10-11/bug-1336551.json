{
    "status": "Opinion", 
    "last_updated": "2014-09-12 00:34:32.815772+00:00", 
    "description": "I'm trying to use nova-network to forward my blade's eth0 to the instance's eth0, and my blade's eth1 to my instances eth1.\nI've struggled quite a bit and posed this question: https://ask.openstack.org/en/question/33421/how-to-bridge-2-ethernet-interfaces-from-host-blade-to-guest-vm/\n\nI'm debugging now, and finding something is not correct.\n nova boot test2 --flavor m1.tiny --image cirros-0.3.2-x86_64-uec\n\nnova network-create iscsi_a --fixed-range-v4=172.16.12.241/29 --bridge=br_iscsi_a --bridge-interface=eth1 --multi-host=T\n\nThe ERROR's are my modification to the code (I tagged select log messages with my name). \nThe point to notice is the frequent mention of eth0 in the below log messages.\nHowever, the bridge-interface is eth1.\n\nNo wonder it's not working. \n\nI will dig deeper, but wanted to submit a bug first.\n\nThis is on icehouse stable.\n\n2014-07-01 14:26:30.600 ERROR nova.network.linux_net [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] R\nAMY Starting Bridge br_iscsi_a\n2014-07-01 14:26:30.601 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf brctl addbr br_iscsi_a from (\npid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:30.664 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:30.665 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf brctl setfd br_iscsi_a 0 from\n (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:30.732 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:30.734 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf brctl stp br_iscsi_a off from\n (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:30.796 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:30.797 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf ip link set br_iscsi_a up fro\nm (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:30.862 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:30.863 ERROR nova.network.linux_net [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Ramy Adding interface eth0 to bridge br_iscsi_a\n2014-07-01 14:26:30.864 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf brctl addif br_iscsi_a eth0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:30.931 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Result was 1 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:30.932 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf ip link set eth0 up from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:31.011 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:31.012 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Running cmd (subprocess): ip route show dev eth0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:31.017 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:31.018 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Running cmd (subprocess): ip addr show dev eth0 scope global from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:31.026 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:31.026 ERROR nova.network.linux_net [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Ramy filtering is True\n2014-07-01 14:26:31.027 ERROR nova.network.linux_net [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] RAMY adding gateway rule\n2014-07-01 14:26:31.027 ERROR nova.network.linux_net [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] RAMY adding gateway rule", 
    "tags": [
        "network"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1336551", 
    "owner": "None", 
    "id": 1336551, 
    "index": 4963, 
    "created": "2014-07-01 21:37:02.361444+00:00", 
    "title": "multi network create not correctly setting up bridge", 
    "comments": [
        {
            "content": "I'm trying to use nova-network to forward my blade's eth0 to the instance's eth0, and my blade's eth1 to my instances eth1.\nI've struggled quite a bit and posed this question: https://ask.openstack.org/en/question/33421/how-to-bridge-2-ethernet-interfaces-from-host-blade-to-guest-vm/\n\nI'm debugging now, and finding something is not correct.\n nova boot test2 --flavor m1.tiny --image cirros-0.3.2-x86_64-uec\n\nnova network-create iscsi_a --fixed-range-v4=172.16.12.241/29 --bridge=br_iscsi_a --bridge-interface=eth1 --multi-host=T\n\nThe ERROR's are my modification to the code (I tagged select log messages with my name). \nThe point to notice is the frequent mention of eth0 in the below log messages.\nHowever, the bridge-interface is eth1.\n\nNo wonder it's not working. \n\nI will dig deeper, but wanted to submit a bug first.\n\nThis is on icehouse stable.\n\n2014-07-01 14:26:30.600 ERROR nova.network.linux_net [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] R\nAMY Starting Bridge br_iscsi_a\n2014-07-01 14:26:30.601 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf brctl addbr br_iscsi_a from (\npid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:30.664 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:30.665 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf brctl setfd br_iscsi_a 0 from\n (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:30.732 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:30.734 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf brctl stp br_iscsi_a off from\n (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:30.796 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:30.797 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf ip link set br_iscsi_a up fro\nm (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:30.862 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d ad\nmin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:30.863 ERROR nova.network.linux_net [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Ramy Adding interface eth0 to bridge br_iscsi_a\n2014-07-01 14:26:30.864 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf brctl addif br_iscsi_a eth0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:30.931 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Result was 1 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:30.932 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf ip link set eth0 up from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:31.011 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:31.012 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Running cmd (subprocess): ip route show dev eth0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:31.017 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:31.018 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Running cmd (subprocess): ip addr show dev eth0 scope global from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:154\n2014-07-01 14:26:31.026 DEBUG nova.openstack.common.processutils [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Result was 0 from (pid=15595) execute /opt/stack/nova/nova/openstack/common/processutils.py:187\n2014-07-01 14:26:31.026 ERROR nova.network.linux_net [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] Ramy filtering is True\n2014-07-01 14:26:31.027 ERROR nova.network.linux_net [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] RAMY adding gateway rule\n2014-07-01 14:26:31.027 ERROR nova.network.linux_net [req-9aa8fb03-4cfb-456e-89de-7c9e98397b6d admin admin] RAMY adding gateway rule", 
            "date_created": "2014-07-01 21:37:02.361444+00:00", 
            "author": "https://api.launchpad.net/1.0/~ramy-asselin"
        }, 
        {
            "content": "I traced it back to here:\n/opt/stack/nova/nova/network/linux_net.py\n\n1408 class LinuxBridgeInterfaceDriver(LinuxNetInterfaceDriver):\n\n1422             LOG.error(\"plug %s %s\" % (CONF.flat_interface, network['bridge_interface']))\n1423             iface = CONF.flat_interface or network['bridge_interface']\n1424             LinuxBridgeInterfaceDriver.ensure_bridge(\n1425                           network['bridge'],\n1426                           iface,\n1427                           network, gateway)\n\n2014-07-01 14:49:30.341 ERROR nova.network.linux_net [req-14494e4f-1706-420e-9d78-ed45659831c5 None None] plug eth0 eth1\n\n\nShouldn't the network['bridge_interface'] take precedence over CONF.flat_interface?\n\nSwapping the order seems to fix the log files.\n1423             iface = network['bridge_interface'] or CONF.flat_interface\n\n2014-07-01 14:52:32.215 ERROR nova.network.linux_net [req-19375d8f-0f9a-44e5-9b24-089af533a438 None None] Ramy Adding interface eth1 to bridge br_iscsi_a\n\nand the desired result:\nstack@csimbe08-b01:/opt/stack/nova$ brctl show\nbridge name     bridge id               STP enabled     interfaces\nbr100           8000.9cb65486dc68       no              eth0\n                                                        vnet0\n                                                        vnet1\nbr_iscsi_a              8000.9cb65486dc6c       no              eth1\n                                                        vnet2\nvirbr0          8000.000000000000       yes\n", 
            "date_created": "2014-07-01 21:53:46.811684+00:00", 
            "author": "https://api.launchpad.net/1.0/~ramy-asselin"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/104008", 
            "date_created": "2014-07-01 22:15:51.165403+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "My proposed fix is causing tempest test cases to fail....so either the tests are wrong, or I'm wrong. I'm guessing it's me. Is there an alternative configuration I'm supposed to (not) use?\n\nHere's my current config:\n\n\nFLOATING_RANGE=10.50.209.17/28\nFIXED_RANGE=10.1.0.0/24\nFIXED_NETWORK_SIZE=30\nFLAT_INTERFACE=eth0\nFLAT_INJECTED=true\nFLAT_NETWORK_BRIDGE=br100\nPUBLIC_INTERFACE=eth0\n", 
            "date_created": "2014-07-02 00:30:58.074971+00:00", 
            "author": "https://api.launchpad.net/1.0/~ramy-asselin"
        }, 
        {
            "content": "Seems this is done explicitly:\n\n    def test_flat_override(self):\n        \"\"\"Makes sure flat_interface flag overrides network bridge_interface.\n\n        Allows heterogeneous networks a la bug 833426\n\n    def test_vlan_override(self):\n\n        \"\"\"Makes sure vlan_interface flag overrides network bridge_interface.\n\n        Allows heterogeneous networks a la bug 833426\n        \"\"\"", 
            "date_created": "2014-07-02 16:56:41.212649+00:00", 
            "author": "https://api.launchpad.net/1.0/~ramy-asselin"
        }, 
        {
            "content": "More investigation:\n\nIn devstack's lib/nova:\n\n# If you are running on a single node and don't need to access the VMs from\n# devices other than that node, you can set ``FLAT_INTERFACE=``\n# This will stop nova from bridging any interfaces into ``FLAT_NETWORK_BRIDGE``.\nFLAT_INTERFACE=${FLAT_INTERFACE:-$GUEST_INTERFACE_DEFAULT}\n\n\nI set my local.conf to have the following line:\nFLAT_INTERFACE=\n\nBut the value still got set:\n2014-07-02 20:58:47.380 | + create_nova_conf_nova_network\n2014-07-02 20:58:47.380 | + iniset /etc/nova/nova.conf DEFAULT network_manager nova.network.manager.FlatDHCPManager\n2014-07-02 20:58:47.396 | + iniset /etc/nova/nova.conf DEFAULT public_interface eth0\n2014-07-02 20:58:47.411 | + iniset /etc/nova/nova.conf DEFAULT vlan_interface eth0\n2014-07-02 20:58:47.427 | + iniset /etc/nova/nova.conf DEFAULT flat_network_bridge br100\n2014-07-02 20:58:47.442 | + '[' -n eth0 ']'\n2014-07-02 20:58:47.442 | + iniset /etc/nova/nova.conf DEFAULT flat_interface eth0\n\nI deleted the line from /etc/nova.conf file and restarted nova-network\nnova network-create iscsi_a --fixed-range-v4=172.16.12.241/29 --bridge=br_iscsi_a --bridge-interface=eth1 --multi-host=T\nnova boot test2 --flavor m1.large --image \"Ubuntu 12.04 Server Glance Image (Precise)\" --key-name devstack\n\nand the bridge is correctly created:\nbr_iscsi_a              8000.9cb6548730ec       no              eth1\n                                                        vnet2\n\n2014-07-02 14:19:15.947 DEBUG nova.network.linux_net [req-1c955688-6db0-48fe-9b4e-0fb3df31c6d7 admin admin] Adding interface eth1 to bridge br_iscsi_a from (pid=18280) ensure_bridge /opt/stack/nova/nova/network/linux_net.py:1531\n\n\nSo, while the decision to use the configuration file as priority over what the network specified to use as the bridge-interface  is unintuitive, this is more likely a devstack/documentation bug.", 
            "date_created": "2014-07-02 21:25:48.625796+00:00", 
            "author": "https://api.launchpad.net/1.0/~ramy-asselin"
        }, 
        {
            "content": "Change abandoned by Ramy Asselin (<email address hidden>) on branch: stable/icehouse\nReview: https://review.openstack.org/104008\nReason: Based on unit test results, a different fix/workaround would be needed.", 
            "date_created": "2014-07-02 22:20:29.340861+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Ramy Asselin (<email address hidden>) on branch: master\nReview: https://review.openstack.org/104025\nReason: Based on unit test results, a different fix/workaround would be needed.", 
            "date_created": "2014-07-02 22:20:43.592426+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}