{
    "status": "Fix Released", 
    "last_updated": "2016-11-17 13:14:15.398103+00:00", 
    "description": "Richard Theis reported the regression here:\n\nhttps://review.openstack.org/#/c/370681/9/nova/virt/libvirt/vif.py\n\nShown here:\n\nhttp://logs.openstack.org/75/371175/1/check/gate-tempest-dsvm-networking-ovn/7e52927/logs/screen-n-cpu.txt.gz?level=TRACE#_2016-09-16_11_20_39_627\n\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [req-78de89a8-2053-42d9-899f-04aa2b8f25c7 tempest-FloatingIPsTestJSON-1913520192 tempest-FloatingIPsTestJSON-1913520192] [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Instance failed to spawn\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Traceback (most recent call last):\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2078, in _build_resources\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     yield resources\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1920, in _build_and_run_instance\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     block_device_info=block_device_info)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 2583, in spawn\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     post_xml_callback=gen_confdrive)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4814, in _create_domain_and_network\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     self.plug_vifs(instance, network_info)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 684, in plug_vifs\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     self.vif_driver.plug(instance, vif)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/virt/libvirt/vif.py\", line 817, in plug\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     self._plug_os_vif(instance, vif_obj, vif)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/virt/libvirt/vif.py\", line 799, in _plug_os_vif\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     linux_net._set_device_mtu(veth, mtu)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/network/linux_net.py\", line 1237, in _set_device_mtu\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     check_exit_code=[0, 2, 254])\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/utils.py\", line 295, in execute\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     return RootwrapProcessHelper().execute(*cmd, **kwargs)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/utils.py\", line 178, in execute\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     return processutils.execute(*cmd, **kwargs)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\", line 389, in execute\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     cmd=sanitized_cmd)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] ProcessExecutionError: Unexpected error while running command.\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf ip link set qvb00b6a38f-60 mtu 1442\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Exit code: 1\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Stdout: u''\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Stderr: u'Cannot find device \"qvb00b6a38f-60\"\\n'\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] \n\nThe nova team isn't sure if ovn should have those devices or not by the time we've plugged the vif, or if ovn is a special case and those just won't exist.\n\nWe're going to add device exists checks around that code to be safe and get that into newton-rc2 and move forward unless someone more that knows more about OVN can tell us otherwise.", 
    "tags": [
        "in-stable-newton", 
        "libvirt", 
        "neutron", 
        "newton-rc-potential", 
        "ovn"
    ], 
    "importance": "High", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1624383", 
    "owner": "https://api.launchpad.net/1.0/~johngarbutt", 
    "id": 1624383, 
    "index": 1990, 
    "created": "2016-09-16 13:08:36.592861+00:00", 
    "title": "vif plugging fails with ovn when trying to set mtu on qvb device that does not exist", 
    "comments": [
        {
            "content": "Richard Theis reported the regression here:\n\nhttps://review.openstack.org/#/c/370681/9/nova/virt/libvirt/vif.py\n\nShown here:\n\nhttp://logs.openstack.org/75/371175/1/check/gate-tempest-dsvm-networking-ovn/7e52927/logs/screen-n-cpu.txt.gz?level=TRACE#_2016-09-16_11_20_39_627\n\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [req-78de89a8-2053-42d9-899f-04aa2b8f25c7 tempest-FloatingIPsTestJSON-1913520192 tempest-FloatingIPsTestJSON-1913520192] [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Instance failed to spawn\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Traceback (most recent call last):\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2078, in _build_resources\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     yield resources\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1920, in _build_and_run_instance\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     block_device_info=block_device_info)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 2583, in spawn\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     post_xml_callback=gen_confdrive)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4814, in _create_domain_and_network\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     self.plug_vifs(instance, network_info)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 684, in plug_vifs\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     self.vif_driver.plug(instance, vif)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/virt/libvirt/vif.py\", line 817, in plug\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     self._plug_os_vif(instance, vif_obj, vif)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/virt/libvirt/vif.py\", line 799, in _plug_os_vif\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     linux_net._set_device_mtu(veth, mtu)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/network/linux_net.py\", line 1237, in _set_device_mtu\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     check_exit_code=[0, 2, 254])\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/utils.py\", line 295, in execute\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     return RootwrapProcessHelper().execute(*cmd, **kwargs)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/opt/stack/new/nova/nova/utils.py\", line 178, in execute\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     return processutils.execute(*cmd, **kwargs)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\", line 389, in execute\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221]     cmd=sanitized_cmd)\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] ProcessExecutionError: Unexpected error while running command.\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf ip link set qvb00b6a38f-60 mtu 1442\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Exit code: 1\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Stdout: u''\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] Stderr: u'Cannot find device \"qvb00b6a38f-60\"\\n'\n2016-09-16 11:21:29.140 15810 ERROR nova.compute.manager [instance: fa58495c-1f29-4149-9efb-2bbf7624d221] \n\nThe nova team isn't sure if ovn should have those devices or not by the time we've plugged the vif, or if ovn is a special case and those just won't exist.\n\nWe're going to add device exists checks around that code to be safe and get that into newton-rc2 and move forward unless someone more that knows more about OVN can tell us otherwise.", 
            "date_created": "2016-09-16 13:08:36.592861+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "The nova call to set_device_mtu is protected by this condition:\n\n        if (isinstance(vif, os_vif.objects.vif.VIFBridge) and\n            hasattr(vif, \"port_profile\") and\n\n\nThe 'vif' object here comes from nova.network.os_vif_util.nova_to_osvif_vif().\n\nnova_to_osvif_vif() calls one of two methods:\n\n_nova_to_osvif_vif_bridge\n_nova_to_osvif_vif_ovs\n\nOnly the _nova_to_osvif_vif_ovs() method sets the port_profile attribute AFAICS, and that always sets the plugin=ovs.\n\nThe vif_plug_ovs impl will call either _plug_bridge or _plug_bridge_windows().  _plug_bridge() will always create the veth pair, but _plugin_bridge_windows() will not.\n\nSo, AFAICT, the only way we should get that Nova error is if we are running on windows ?!?!?", 
            "date_created": "2016-09-16 13:14:37.085099+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }, 
        {
            "content": "http://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22mtu%201442%5C%22%20AND%20message%3A%5C%22_set_device_mtu%5C%22%20AND%20tags%3A%5C%22screen-n-cpu.txt%5C%22&from=7d", 
            "date_created": "2016-09-16 13:23:00.795034+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Actually I spot the mistake - this check:\n\n        if (isinstance(vif, os_vif.objects.vif.VIFBridge) and\n\nis wrong because  'VIFOpenVSwitch' is a subclass of VIFBridge. So this was not filtering out the VIFOpenVSwitch scenario correctly. We need an exact class match here against VIFBridge, not merely an instance check", 
            "date_created": "2016-09-16 13:27:03.523426+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/371543", 
            "date_created": "2016-09-16 13:35:05.815366+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "OVN does not create those devices.", 
            "date_created": "2016-09-16 14:06:35.946611+00:00", 
            "author": "https://api.launchpad.net/1.0/~rtheis"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/371543\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=fc0e281743917dbda25fb1911500439abed192ca\nSubmitter: Jenkins\nBranch:    master\n\ncommit fc0e281743917dbda25fb1911500439abed192ca\nAuthor: John Garbutt <email address hidden>\nDate:   Fri Sep 16 14:51:10 2016 +0100\n\n    Stop ovn networking failing on mtu\n    \n    The type check needed to be more specific. There are some subclasses\n    that don't create the devices we were trying to set the mtu on.\n    \n    Change-Id: Icc628a2dbde137d320fb78ad45b2ee0f7b5775fa\n    Closes-Bug: #1624383\n", 
            "date_created": "2016-09-16 23:24:47.204639+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/371836", 
            "date_created": "2016-09-16 23:32:45.958540+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/371836\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=dbca6efcc47930bff37579493e2429cbd52bcd42\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit dbca6efcc47930bff37579493e2429cbd52bcd42\nAuthor: John Garbutt <email address hidden>\nDate:   Fri Sep 16 14:51:10 2016 +0100\n\n    Stop ovn networking failing on mtu\n    \n    The type check needed to be more specific. There are some subclasses\n    that don't create the devices we were trying to set the mtu on.\n    \n    Change-Id: Icc628a2dbde137d320fb78ad45b2ee0f7b5775fa\n    Closes-Bug: #1624383\n    (cherry picked from commit fc0e281743917dbda25fb1911500439abed192ca)\n", 
            "date_created": "2016-09-20 13:28:51.019731+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0rc2 release candidate.", 
            "date_created": "2016-09-29 21:22:04.245141+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b1 development milestone.", 
            "date_created": "2016-11-17 13:14:13.966005+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}