{
    "status": "Fix Released", 
    "last_updated": "2016-11-17 13:12:55.812353+00:00", 
    "description": "Steps to reproduce\n\n1) nova image-create test test-img & nova delete test\n\nwhere test is the name of the instance\n\nI get the following message \n\n[stack@localhost compute]$ nova image-create test test-img & nova delete test\n[1] 2506\nERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.UnexpectedDeletingTaskStateError'> (HTTP 500) (Request-ID: req-f699c746-0b29-4d84-b258-c8233d5b7a42)\nRequest to delete server test has been accepted.\n[1]+  Exit 1                  nova image-create test test-img\n\nIn the nova api logs i can see the following stacktrace\n\n'c59f52ce-b51f-433e-81b0-099e3b65b0a3', '89ba4861-99e2-4376-8015-3f5ac02538d0']^[[00m ^[[00;33mfrom (pid=12399) reserve /opt/stack/nova/nova/quota.py:1345^[[00m\n2016-03-09 02:04:25.304 ^[[01;31mERROR nova.api.openstack.extensions [^[[01;36mreq-f699c746-0b29-4d84-b258-c8233d5b7a42 ^[[00;36madmin admin^[[01;31m] ^[[01;35m^[[01;31mUnexpected exception in API method^[[00m\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00mTraceback (most recent call last):\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/api/openstack/common.py\", line 391, in inner\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/api/validation/__init__.py\", line 73, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return func(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/api/validation/__init__.py\", line 73, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return func(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/api/openstack/compute/servers.py\", line 1113, in _action_create_image\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    extra_properties=metadata)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/api.py\", line 169, in wrapped\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return func(self, context, target, *args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/api.py\", line 186, in _wrapped\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return fn(self, context, instance, *args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/api.py\", line 139, in inner\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(self, context, instance, *args, **kw)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/api.py\", line 2238, in snapshot\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    instance.save(expected_task_state=[None])\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 223, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return fn(self, *args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/objects/instance.py\", line 694, in save\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    columns_to_join=_expected_cols(expected_attrs))\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/db/api.py\", line 805, in instance_update_and_get_original\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    expected=expected)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 229, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/usr/lib/python2.7/site-packages/oslo_db/api.py\", line 148, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    ectxt.value = e.inner_exc\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    self.force_reraise()\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    six.reraise(self.type_, self.value, self.tb)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/usr/lib/python2.7/site-packages/oslo_db/api.py\", line 138, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 300, in wrapped\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(context, *args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 2707, in instance_update_and_get_original\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    context, instance_uuid, values, expected, original=instance_ref))\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 2843, in _instance_update\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    raise exc(**exc_props)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00mUnexpectedDeletingTaskStateError: Conflict updating instance 74940cbc-3947-434c-93ce-9489faa78073. Expected: {'task_state': [None]}. Actual: {'task_state': u'deleting'}\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m\n2016-03-09 02:04:25.311 ^[[00;36mINFO nova.api.openstack.wsgi [^[[01;36mreq-f699c746-0b29-4d84-b258-c8233d5b7a42 ^[[00;36madmin admin^[[00;36m] ^[[01;35m^[[00;36mHTTP exception thrown: Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.UnexpectedDeletingTaskStateError'>^[[00m", 
    "tags": [
        "api", 
        "compute"
    ], 
    "importance": "Low", 
    "heat": 40, 
    "link": "https://bugs.launchpad.net/nova/+bug/1555065", 
    "owner": "https://api.launchpad.net/1.0/~parora", 
    "id": 1555065, 
    "index": 704, 
    "created": "2016-03-09 12:33:51.054356+00:00", 
    "title": "Image goes to saving state when we delete instance just after taking snapshot and remain the state forever", 
    "comments": [
        {
            "content": "Steps to reproduce\n\n1) nova image-create test test-img & nova delete test\n\nwhere test is the name of the instance\n\nI get the following message \n\n[stack@localhost compute]$ nova image-create test test-img & nova delete test\n[1] 2506\nERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.UnexpectedDeletingTaskStateError'> (HTTP 500) (Request-ID: req-f699c746-0b29-4d84-b258-c8233d5b7a42)\nRequest to delete server test has been accepted.\n[1]+  Exit 1                  nova image-create test test-img\n\nIn the nova api logs i can see the following stacktrace\n\n'c59f52ce-b51f-433e-81b0-099e3b65b0a3', '89ba4861-99e2-4376-8015-3f5ac02538d0']^[[00m ^[[00;33mfrom (pid=12399) reserve /opt/stack/nova/nova/quota.py:1345^[[00m\n2016-03-09 02:04:25.304 ^[[01;31mERROR nova.api.openstack.extensions [^[[01;36mreq-f699c746-0b29-4d84-b258-c8233d5b7a42 ^[[00;36madmin admin^[[01;31m] ^[[01;35m^[[01;31mUnexpected exception in API method^[[00m\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00mTraceback (most recent call last):\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/api/openstack/common.py\", line 391, in inner\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/api/validation/__init__.py\", line 73, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return func(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/api/validation/__init__.py\", line 73, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return func(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/api/openstack/compute/servers.py\", line 1113, in _action_create_image\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    extra_properties=metadata)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/api.py\", line 169, in wrapped\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return func(self, context, target, *args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/api.py\", line 186, in _wrapped\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return fn(self, context, instance, *args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/api.py\", line 139, in inner\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(self, context, instance, *args, **kw)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/api.py\", line 2238, in snapshot\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    instance.save(expected_task_state=[None])\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 223, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return fn(self, *args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/objects/instance.py\", line 694, in save\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    columns_to_join=_expected_cols(expected_attrs))\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/db/api.py\", line 805, in instance_update_and_get_original\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    expected=expected)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 229, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/usr/lib/python2.7/site-packages/oslo_db/api.py\", line 148, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    ectxt.value = e.inner_exc\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    self.force_reraise()\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    six.reraise(self.type_, self.value, self.tb)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/usr/lib/python2.7/site-packages/oslo_db/api.py\", line 138, in wrapper\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(*args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 300, in wrapped\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    return f(context, *args, **kwargs)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 2707, in instance_update_and_get_original\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    context, instance_uuid, values, expected, original=instance_ref))\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 2843, in _instance_update\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m    raise exc(**exc_props)\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00mUnexpectedDeletingTaskStateError: Conflict updating instance 74940cbc-3947-434c-93ce-9489faa78073. Expected: {'task_state': [None]}. Actual: {'task_state': u'deleting'}\n^[[01;31m2016-03-09 02:04:25.304 TRACE nova.api.openstack.extensions ^[[01;35m^[[00m\n2016-03-09 02:04:25.311 ^[[00;36mINFO nova.api.openstack.wsgi [^[[01;36mreq-f699c746-0b29-4d84-b258-c8233d5b7a42 ^[[00;36madmin admin^[[00;36m] ^[[01;35m^[[00;36mHTTP exception thrown: Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.UnexpectedDeletingTaskStateError'>^[[00m", 
            "date_created": "2016-03-09 12:33:51.054356+00:00", 
            "author": "https://api.launchpad.net/1.0/~parora"
        }, 
        {
            "content": "Adding \"api\" tag because of HTTP status code 500.\nAdding \"compute\" as I think this is the layer which should handle\nthe \"UnexpectedDeletingTaskStateError\" raised from the db layer.", 
            "date_created": "2016-03-10 09:55:00.900814+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/294513", 
            "date_created": "2016-03-18 11:02:55.995518+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Matt Riedemann (<email address hidden>) on branch: master\nReview: https://review.openstack.org/294513", 
            "date_created": "2016-08-04 18:21:12.926436+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/294513\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d8e695cb900ad71996e6cf970894bc2e3f2df8b4\nSubmitter: Jenkins\nBranch:    master\n\ncommit d8e695cb900ad71996e6cf970894bc2e3f2df8b4\nAuthor: Prateek Arora <email address hidden>\nDate:   Fri Mar 18 06:46:43 2016 -0400\n\n    Delete traces of in-progress snapshot on VM being deleted\n    \n    When user tries to create snapshot of instance and at the same time\n    if another request tries to delete the instance, at that time image\n    goes in saving status for forever because of race  between instance\n    delete and snapshot requests.\n    \n    Caught exceptions(InstanceNotFound and UnexpectedDeletingTaskStateError)\n    in except block and deleting the image which got stuck in saving state.\n    \n    Closes-Bug: #1555065\n    Change-Id: If0b918dc951030e6b6ffba147443225e0e4a370a\n", 
            "date_created": "2016-10-07 11:38:52.976480+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/384353", 
            "date_created": "2016-10-10 08:34:28.860573+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Chuck Short (<email address hidden>) on branch: stable/newton\nReview: https://review.openstack.org/384353", 
            "date_created": "2016-10-14 11:38:50.962082+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b1 development milestone.", 
            "date_created": "2016-11-17 13:12:55.081316+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}