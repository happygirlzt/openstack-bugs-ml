{
    "status": "Fix Released", 
    "last_updated": "2011-09-22 13:12:41.139061+00:00", 
    "description": "The test_004_can_access_metadata_over_public_ip fails intermittently (1 out of 4 times) when run on a set of freshly configured servers. When it fails we get the following error:\n\nTraceback (most recent call last):\n  File \"/usr/lib/python2.6/unittest.py\", line 279, in run\n    testMethod()\n  File \"/root/nova_source/smoketests/test_netadmin.py\", line 157, in test_004_can_access_metadata_over_public_ip\n    while not self.__public_instance_is_accessible():\n  File \"/root/nova_source/smoketests/test_netadmin.py\", line 118, in __public_instance_is_accessible\n    raise Exception(\"Wrong instance id\")\nException: Wrong instance id", 
    "tags": [], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/821242", 
    "owner": "https://api.launchpad.net/1.0/~dan-prince", 
    "id": 821242, 
    "index": 5136, 
    "created": "2011-08-05 02:58:02.402658+00:00", 
    "title": "test_004_can_access_metadata_over_public_ip fails intermittently", 
    "comments": [
        {
            "content": "The test_004_can_access_metadata_over_public_ip fails intermittently (1 out of 4 times) when run on a set of freshly configured servers. When it fails we get the following error:\n\nTraceback (most recent call last):\n  File \"/usr/lib/python2.6/unittest.py\", line 279, in run\n    testMethod()\n  File \"/root/nova_source/smoketests/test_netadmin.py\", line 157, in test_004_can_access_metadata_over_public_ip\n    while not self.__public_instance_is_accessible():\n  File \"/root/nova_source/smoketests/test_netadmin.py\", line 118, in __public_instance_is_accessible\n    raise Exception(\"Wrong instance id\")\nException: Wrong instance id", 
            "date_created": "2011-08-05 02:58:02.402658+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "It would be useful to know what it is getting for the instance id.  Is it getting another id, meaning that the metadata server is somehow not getting the ip correctly, or is it just failing to get a valid response from the metadata server.  It would be great if we could change it to log what it actually got via the request.  It may be a timing issue where there is a moment during the association where it is not working, or there is some intermittent state where the metadata server is failing.  For example the occassional error we have been seeing regarding lazy load of networks.  Can you try putting some more logging in there for what the actual response is, and also see if there is any error logged in nova-api?\n\nVish\n\nOn Aug 4, 2011, at 7:58 PM, Dan Prince wrote:\n\n> Public bug reported:\n> \n> The test_004_can_access_metadata_over_public_ip fails intermittently (1\n> out of 4 times) when run on a set of freshly configured servers. When it\n> fails we get the following error:\n> \n> Traceback (most recent call last):\n>  File \"/usr/lib/python2.6/unittest.py\", line 279, in run\n>    testMethod()\n>  File \"/root/nova_source/smoketests/test_netadmin.py\", line 157, in test_004_can_access_metadata_over_public_ip\n>    while not self.__public_instance_is_accessible():\n>  File \"/root/nova_source/smoketests/test_netadmin.py\", line 118, in __public_instance_is_accessible\n>    raise Exception(\"Wrong instance id\")\n> Exception: Wrong instance id\n> \n> ** Affects: nova\n>     Importance: Undecided\n>         Status: New\n> \n> -- \n> You received this bug notification because you are a member of Nova Bug\n> Team, which is subscribed to OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/821242\n> \n> Title:\n>  test_004_can_access_metadata_over_public_ip fails intermittently\n> \n> Status in OpenStack Compute (Nova):\n>  New\n> \n> Bug description:\n>  The test_004_can_access_metadata_over_public_ip fails intermittently\n>  (1 out of 4 times) when run on a set of freshly configured servers.\n>  When it fails we get the following error:\n> \n>  Traceback (most recent call last):\n>    File \"/usr/lib/python2.6/unittest.py\", line 279, in run\n>      testMethod()\n>    File \"/root/nova_source/smoketests/test_netadmin.py\", line 157, in test_004_can_access_metadata_over_public_ip\n>      while not self.__public_instance_is_accessible():\n>    File \"/root/nova_source/smoketests/test_netadmin.py\", line 118, in __public_instance_is_accessible\n>      raise Exception(\"Wrong instance id\")\n>  Exception: Wrong instance id\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/821242/+subscriptions\n\n", 
            "date_created": "2011-08-05 06:10:41+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Hey Vish. Just pushed a branch to add some extra logging for the failure. I can't get it to happen for me locally. It seems to happen more often in our CI jobs up on Jenkins. Here is a job log that contains the failure along with some extra API logs.\n\nhttps://jenkins.openstack.org/job/nova-vpc/163/testReport/junit/smoketests/test_netadmin/SecurityGroupTests_test_004_can_access_metadata_over_public_ip/\n\nNothing jumped out at me but maybe this logging will tell us something.", 
            "date_created": "2011-08-05 15:22:50.982758+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Hmm, are there multiple builds at once going on in CI on jenkins?  If the ip is used by multiple machines in multiple builds it could cause issues.\n\nVish\n\nOn Aug 5, 2011, at 8:22 AM, Dan Prince wrote:\n\n> Hey Vish. Just pushed a branch to add some extra logging for the\n> failure. I can't get it to happen for me locally. It seems to happen\n> more often in our CI jobs up on Jenkins. Here is a job log that contains\n> the failure along with some extra API logs.\n> \n> https://jenkins.openstack.org/job/nova-\n> vpc/163/testReport/junit/smoketests/test_netadmin/SecurityGroupTests_test_004_can_access_metadata_over_public_ip/\n> \n> Nothing jumped out at me but maybe this logging will tell us something.\n> \n> ** Branch linked: lp:~rackspace-titan/nova/test_004_metadata_logging\n> \n> -- \n> You received this bug notification because you are a member of Nova Bug\n> Team, which is subscribed to OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/821242\n> \n> Title:\n>  test_004_can_access_metadata_over_public_ip fails intermittently\n> \n> Status in OpenStack Compute (Nova):\n>  In Progress\n> \n> Bug description:\n>  The test_004_can_access_metadata_over_public_ip fails intermittently\n>  (1 out of 4 times) when run on a set of freshly configured servers.\n>  When it fails we get the following error:\n> \n>  Traceback (most recent call last):\n>    File \"/usr/lib/python2.6/unittest.py\", line 279, in run\n>      testMethod()\n>    File \"/root/nova_source/smoketests/test_netadmin.py\", line 157, in test_004_can_access_metadata_over_public_ip\n>      while not self.__public_instance_is_accessible():\n>    File \"/root/nova_source/smoketests/test_netadmin.py\", line 118, in __public_instance_is_accessible\n>      raise Exception(\"Wrong instance id\")\n>  Exception: Wrong instance id\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/821242/+subscriptions\n\n", 
            "date_created": "2011-08-05 17:36:48+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Hey Vish,\n\nThe failures I'm seeing occur in isolated dev clouds. I don't think multiple simultaneous builds is the issue here.\n\n--\n\nAfter the logging fix went in we got the following failure in Jenkins this afternoon:\n\nException: Wrong instance id. Expected: i-00000004, Got: <!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>404 Not Found</title>\n</head><body>\n<h1>Not Found</h1>\n<p>The requested URL /latest/meta-data/instance-id was not found on this server.</p>\n<hr>\n<address>Apache/2.2.16 (Ubuntu) Server at 172.20.0.0 Port 80</address>\n</body></html>\n--\n\nHere is a link to the test failure.\n\nhttps://jenkins.openstack.org/job/nova-vpc/171/testReport/smoketests/test_netadmin/SecurityGroupTests_test_004_can_access_metadata_over_public_ip/\n\n\nI'm looking at how we make use of __public_instance_is_accessible in the test_004_can_access_metadata_over_public_ip... Instead of raising an exception when the instance IDs don't match perhaps we should just return false? This would at least give us a chance to reach the timeout (and try multiple times).", 
            "date_created": "2011-08-05 23:33:51.223000+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }
    ]
}