{
    "status": "Fix Released", 
    "last_updated": "2016-12-07 10:45:40.509386+00:00", 
    "description": "Description\n===========\nIn Mitaka, Nova-compute raise exception when vcpu_pin_set is set to None or\"\".And nova-compute fails to start.\n\nSteps to reproduce\n==================\nEdit vcpu_pin_set=None or vcpu_pin_set=\"\"\nthen restart nova-compute service\n\nExpected result\n===============\nGet_vcpu_total returns total_pcpus, and nova-compute service starts successfully.\n\nActual result\n=============\nWhen set vcpu_pin_set to None, raise following exception and nova-compute service fails to start:\n2016-05-10 09:00:02.835 TRACE nova.compute.manager Traceback (most recent call last):\n2016-05-10 09:00:02.835 TRACE nova.compute.manager   File  \"/opt/stack/nova/nova/compute/manager.py\", line 6460, in update_available_resource\n2016-05-10 09:00:02.835 TRACE nova.compute.manager     rt.update_available_resource(context)\n2016-05-10 09:00:02.835 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/resource_tracker.py\", line 500, in update_available_resource\n2016-05-10 09:00:02.835 TRACE nova.compute.manager     resources = self.driver.get_available_resource(self.nodename)\n2016-05-10 09:00:02.835 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5363, in get_available_resource\n2016-05-10 09:00:02.835 TRACE nova.compute.manager     data[\"vcpus\"] = self._get_vcpu_total()\n2016-05-10 09:00:02.835 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4958, in _get_vcpu_total\n2016-05-10 09:00:02.835 TRACE nova.compute.manager     available_ids = hardware.get_vcpu_pin_set()\n2016-05-10 09:00:02.835 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/virt/hardware.py\", line 50, in get_vcpu_pin_set\n2016-05-10 09:00:02.835 TRACE nova.compute.manager     cpuset_ids = parse_cpu_spec(CONF.vcpu_pin_set)\n2016-05-10 09:00:02.835 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/virt/hardware.py\", line 113, in parse_cpu_spec\n2016-05-10 09:00:02.835 TRACE nova.compute.manager     \"expression %r\") % rule)\n2016-05-10 09:00:02.835 TRACE nova.compute.manager Invalid: Invalid inclusion expression 'None'\n\nWhen set vcpu_pin_set to \"\", raise following exception and nova-compute service fails to start:\n2016-05-10 08:55:18.558 TRACE nova.compute.manager Traceback (most recent call last):\n2016-05-10 08:55:18.558 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 6460, in update_available_resource\n2016-05-10 08:55:18.558 TRACE nova.compute.manager     rt.update_available_resource(context)\n2016-05-10 08:55:18.558 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/resource_tracker.py\", line 500, in update_available_resource\n2016-05-10 08:55:18.558 TRACE nova.compute.manager     resources = self.driver.get_available_resource(self.nodename)\n2016-05-10 08:55:18.558 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5363, in get_available_resource\n2016-05-10 08:55:18.558 TRACE nova.compute.manager     data[\"vcpus\"] = self._get_vcpu_total()\n2016-05-10 08:55:18.558 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4971, in _get_vcpu_total\n2016-05-10 08:55:18.558 TRACE nova.compute.manager     if not (available_ids <= online_pcpus):\n2016-05-10 08:55:18.558 TRACE nova.compute.manager TypeError: can only compare to a set\n\nEnvironment\n===========\nMitaka version and KVM driver", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1579664", 
    "owner": "https://api.launchpad.net/1.0/~dims-v", 
    "id": 1579664, 
    "index": 4524, 
    "created": "2016-05-09 08:47:36.044710+00:00", 
    "title": "Nova-compute raise exception when vcpu_pin_set is set to None or''.", 
    "comments": [
        {
            "content": "Description\n===========\nIn Mitaka, Nova-compute raise exception when vcpu_pin_set is set to None or\"\".And nova-compute fails to start.\n\nSteps to reproduce\n==================\nEdit vcpu_pin_set=None or vcpu_pin_set=\"\"\nthen restart nova-compute service\n\nExpected result\n===============\nGet_vcpu_total returns total_pcpus, and nova-compute service starts successfully.\n\nActual result\n=============\nWhen set vcpu_pin_set to None, raise following exception and nova-compute service fails to start:\n2016-05-09 16:38:51.517 18221 ERROR nova.openstack.common.threadgroup [req-e17708cc-1c77-47cc-9182-2ed072a638a4 - - - - -] Invalid inclusion expression 'None'\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup Traceback (most recent call last):\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/threadgroup.py\", line 145, in wait\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     x.wait()\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/threadgroup.py\", line 47, in wait\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     return self.thread.wait()\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 175, in wait\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     return self._exit_event.wait()\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/event.py\", line 121, in wait\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     return hubs.get_hub().switch()\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/hubs/hub.py\", line 294, in switch\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     return self.greenlet.switch()\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 214, in main\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     result = function(*args, **kwargs)\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/service.py\", line 502, in run_service\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     service.start()\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/service.py\", line 201, in start\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     self.manager.pre_start_hook()\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 1575, in pre_start_hook\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     self.update_available_resource(nova.context.get_admin_context())\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 7489, in update_available_resource\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     rt.update_available_resource(context)\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/compute/resource_tracker.py\", line 521, in update_available_resource\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     resources = self.driver.get_available_resource(self.nodename)\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 5518, in get_available_resource\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     data[\"vcpus\"] = self._get_vcpu_total()\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 5064, in _get_vcpu_total\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     available_ids = hardware.get_vcpu_pin_set()\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/hardware.py\", line 62, in get_vcpu_pin_set\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     cpuset_ids = parse_cpu_spec(CONF.vcpu_pin_set)\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/hardware.py\", line 117, in parse_cpu_spec\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup     \"expression %r\") % rule)\n2016-05-09 16:38:51.517 18221 TRACE nova.openstack.common.threadgroup Invalid: Invalid inclusion expression 'None'\n\n\n\n\nWhen set vcpu_pin_set to \"\", raise following exception and nova-compute service fails to start:\n2016-05-09 16:19:47.915 22146 ERROR nova.openstack.common.threadgroup [req-f02e4e70-dfd5-4f26-ae8b-519bd8464adc - - - - -] 'NoneType' object is not iterable\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup Traceback (most recent call last):\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/threadgroup.py\", line 145, in wait\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     x.wait()\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/threadgroup.py\", line 47, in wait\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     return self.thread.wait()\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 175, in wait\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     return self._exit_event.wait()\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/event.py\", line 121, in wait\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     return hubs.get_hub().switch()\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/hubs/hub.py\", line 294, in switch\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     return self.greenlet.switch()\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 214, in main\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     result = function(*args, **kwargs)\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/service.py\", line 502, in run_service\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     service.start()\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/service.py\", line 201, in start\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     self.manager.pre_start_hook()\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 1575, in pre_start_hook\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     self.update_available_resource(nova.context.get_admin_context())\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 7489, in update_available_resource\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     rt.update_available_resource(context)\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/compute/resource_tracker.py\", line 521, in update_available_resource\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     resources = self.driver.get_available_resource(self.nodename)\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 5518, in get_available_resource\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     data[\"vcpus\"] = self._get_vcpu_total()\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 5066, in _get_vcpu_total\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup     if sorted(available_ids)[-1] >= total_pcpus:\n2016-05-09 16:19:47.915 22146 TRACE nova.openstack.common.threadgroup TypeError: 'NoneType' object is not iterable\n\nEnvironment\n===========\nMitaka version and KVM driver", 
            "date_created": "2016-05-09 08:47:36.044710+00:00", 
            "author": "https://api.launchpad.net/1.0/~liu-lixiu"
        }, 
        {
            "content": "liuxiuli, I can only recreate the problem with vcpu_pin_set is set to \"\". when vcpu_pin_set is set to None it works fine. I'll upload a review, please try that and let me know.\n\nThanks,\nDims", 
            "date_created": "2016-05-09 12:26:56.512112+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/314076", 
            "date_created": "2016-05-09 12:27:36.180152+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Sorry,it is my mistake, I do a new test in following version and have update the exception in the bug description.\n[stack@SBCJSlot5Rack2Centos7 devstack]$ git log -1\ncommit 603fc0c6ec58a0fec060a1030e58b5f7e56794d4\nAuthor: Mark Vanderwiel <email address hidden>\nDate:   Thu Mar 17 12:19:16 2016 -0500", 
            "date_created": "2016-05-10 01:38:42.618530+00:00", 
            "author": "https://api.launchpad.net/1.0/~liu-lixiu"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/314076\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8b199c6dff4c61169a9eb916511b716d8f20c015\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8b199c6dff4c61169a9eb916511b716d8f20c015\nAuthor: Davanum Srinivas <email address hidden>\nDate:   Mon May 9 08:23:25 2016 -0400\n\n    Fix exception when vcpu_pin_set is set to \"\"\n    \n    We should treat vcpu_pin_set=\"\", same as vcpu_pin_set=None and\n    avoid the problem mentioned in the bug report.\n    \n    Closes-Bug: #1579664\n    Change-Id: Ifa2b960aa74072ba668c9d028df108af6156fe40\n", 
            "date_created": "2016-10-14 13:23:54.914481+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/386675", 
            "date_created": "2016-10-14 16:05:35.038927+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/386675\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=104f8cc4c41c77bd07503329710e622f27e11372\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 104f8cc4c41c77bd07503329710e622f27e11372\nAuthor: Davanum Srinivas <email address hidden>\nDate:   Mon May 9 08:23:25 2016 -0400\n\n    Fix exception when vcpu_pin_set is set to \"\"\n    \n    We should treat vcpu_pin_set=\"\", same as vcpu_pin_set=None and\n    avoid the problem mentioned in the bug report.\n    \n    Closes-Bug: #1579664\n    Change-Id: Ifa2b960aa74072ba668c9d028df108af6156fe40\n    (cherry picked from commit 8b199c6dff4c61169a9eb916511b716d8f20c015)\n", 
            "date_created": "2016-10-16 01:31:40.056608+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.2 release.", 
            "date_created": "2016-11-07 04:59:41.945540+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.2 release.", 
            "date_created": "2016-11-10 02:34:07.685314+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b1 development milestone.", 
            "date_created": "2016-11-17 13:14:56.561156+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.2 release.", 
            "date_created": "2016-12-07 10:45:39.796612+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}