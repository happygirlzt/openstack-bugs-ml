{
    "status": "Invalid", 
    "last_updated": "2013-05-29 10:25:28.904647+00:00", 
    "description": "glance           2011.3~rc~20110908.r1005-0ubuntu1\nnova-objectstore 2011.3~rc~20110909.r1155-0ubuntu1\nswift            1.4.3-0ubuntu1\n\nI am using nova-objectstore + glance + swift with the EC2 api.\n\nWhen running 'euca-delete-images' to delete an image that I have uploaded, only the nova-objectstore bucket is removed and the image is not removed from glance/swift.\n\nI expect that the images that I delete will be deleted from glance/swift.\n\nPreviously I was using nova-objectstore + glance + filesystem store + EC2 api and I don't believe that this was an issue.\n\n= Steps to reproduce  =\n\n1.  Download an image tarball\n\nagy@remote:~$ wget http://uec-images.ubuntu.com/oneiric/current/oneiric-server-cloudimg-amd64.tar.gz\n\n2. Publish the tarball\n\nagy@remote:~$ $ cloud-publish-tarball oneiric-server-cloudimg-amd64.tar.gz agytestbucket amd64\nWed Sep 21 15:55:48 BST 2011: ====== extracting image ======\nWarning: no ramdisk found, assuming '--ramdisk none'\nkernel : oneiric-server-cloudimg-amd64-vmlinuz-virtual\nramdisk: none\nimage  : oneiric-server-cloudimg-amd64.img\nWed Sep 21 15:56:06 BST 2011: ====== bundle/upload kernel ======\nWed Sep 21 15:56:08 BST 2011: ====== bundle/upload image ======\nWed Sep 21 15:57:42 BST 2011: ====== done ======\nemi=\"ami-00000096\"; eri=\"none\"; eki=\"aki-00000095\";\n\n3. Check on the server's S3 bucket - looks correct\n\nagy@nova:~$ ls -la /var/lib/nova/buckets/agytestbucket/ | wc -l\n25\n\n4. Check glance/swift - looks correct\n\nagy@nova:~$ glance show $((0x96))\nURI: http://0.0.0.0/images/150\nId: 150\nPublic: No\nName: None\nStatus: active\nSize: 0\nLocation: swift+https://glance:glance:XXXXXXXXXXXXXXXX@127.0.0.1/auth/v1.0//glance/150\nDisk format: ami\nContainer format: ami\nProperty 'kernel_id': 149\nProperty 'image_location': agytestbucket/oneiric-server-cloudimg-amd64.img.manifest.xml\nProperty 'image_state': available\nProperty 'project_id': canonistack_project\nProperty 'architecture': x86_64\n\n5. For both images - correct for both images (apart from LP#845788)\n\nagy@nova:~$ glance show $((0x95))\nURI: http://0.0.0.0/images/149\nId: 149\nPublic: No\nName: None\nStatus: active\nSize: 0\nLocation: swift+https://glance:glance:XXXXXXXXXXXXXXXX@127.0.0.1/auth/v1.0//glance/149\nDisk format: aki\nContainer format: aki\nProperty 'image_location': agytestbucket/oneiric-server-cloudimg-amd64-vmlinuz-virtual.manifest.xml\nProperty 'image_state': available\nProperty 'project_id': canonistack_project\nProperty 'architecture': x86_64\n\n6. Check what euca-describe-images says - looks correct\n\nagy@remote:~$ euca-describe-images ami-00000096 aki-00000095\nIMAGE   ami-00000096    agytestbucket/oneiric-server-cloudimg-amd64.img.manifest.xml            available       private         x86_64 machine  aki-00000095            instance-store\nIMAGE   aki-00000095    agytestbucket/oneiric-server-cloudimg-amd64-vmlinuz-virtual.manifest.xml                available       privatex86_64   kernel                  instance-store\n\n7. Delete the bucket and the contents\n\nagy@remote:~$ euca-delete-bundle -b agytestbucket --clear\nNeither manifestpath nor prefix was specified.\nAll manifest data in bucket will be deleted.\n\n8. Check that the S3 bucket is missing - all good so far\nagy@nova:~$ ls -la /var/lib/nova/buckets/agytestbucket/ | wc -l\nls: cannot access /var/lib/nova/buckets/agytestbucket/: No such file or directory\n0\n\n9. Check glance/swift - the image is still there\n\nagy@nova:~$ glance show $((0x95))\nURI: http://0.0.0.0/images/149\nId: 149\nPublic: No\nName: None\nStatus: active\nSize: 0\nLocation: swift+https://glance:glance:XXXXXXXXXXXXXXXX@127.0.0.1/auth/v1.0//glance/149\nDisk format: aki\nContainer format: aki\nProperty 'image_location': agytestbucket/oneiric-server-cloudimg-amd64-vmlinuz-virtual.manifest.xml\nProperty 'image_state': available\nProperty 'project_id': canonistack_project\nProperty 'architecture': x86_64\n\n10. For both images - this one too\n\nagy@nova:~$ glance show $((0x96))\nURI: http://0.0.0.0/images/150\nId: 150\nPublic: No\nName: None\nStatus: active\nSize: 0\nLocation: swift+https://glance:glance:XXXXXXXXXXXXXXXX@127.0.0.1/auth/v1.0//glance/150\nDisk format: ami\nContainer format: ami\nProperty 'kernel_id': 149\nProperty 'image_location': agytestbucket/oneiric-server-cloudimg-amd64.img.manifest.xml\nProperty 'image_state': available\nProperty 'project_id': canonistack_project\nProperty 'architecture': x86_64\n\n11. Check what euca-describe-images says - yup, still there\n\nagy@remote:~$ euca-describe-images ami-00000096 aki-00000095\nIMAGE   ami-00000096    agytestbucket/oneiric-server-cloudimg-amd64.img.manifest.xml            available       private         x86_64 machine  aki-00000095            instance-store\nIMAGE   aki-00000095    agytestbucket/oneiric-server-cloudimg-amd64-vmlinuz-virtual.manifest.xml                available       privatex86_64   kernel                  instance-store\n\n12. Delete the images manually from glance/swift\n\nagy@nova:~$ glance delete $((0x96))\nDelete image 150? [y/N] y\nDeleted image 150\n\nagy@dziban:~$ glance delete $((0x95))\nDelete image 149? [y/N] y\nDeleted image 149\n\n13. Check what euca-describe-images says - now they are gone\n\nagy@remote:~$ euca-describe-images ami-00000096 aki-00000095\nImageNotFound: Image ami-00000096 could not be found.\n\nagy@remote:~$ euca-describe-images aki-00000095\nImageNotFound: Image aki-00000095 could not be found.", 
    "tags": [
        "canonistack", 
        "ec2"
    ], 
    "importance": "Medium", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/855663", 
    "owner": "None", 
    "id": 855663, 
    "index": 2571, 
    "created": "2011-09-21 15:45:20.594575+00:00", 
    "title": "euca-delete-bundle doesn't delete the images", 
    "comments": [
        {
            "content": "glance           2011.3~rc~20110908.r1005-0ubuntu1\nnova-objectstore 2011.3~rc~20110909.r1155-0ubuntu1\nswift            1.4.3-0ubuntu1\n\nI am using nova-objectstore + glance + swift with the EC2 api.\n\nWhen running 'euca-delete-images' to delete an image that I have uploaded, only the nova-objectstore bucket is removed and the image is not removed from glance/swift.\n\nI expect that the images that I delete will be deleted from glance/swift.\n\nPreviously I was using nova-objectstore + glance + filesystem store + EC2 api and I don't believe that this was an issue.\n\n= Steps to reproduce  =\n\n1.  Download an image tarball\n\nagy@remote:~$ wget http://uec-images.ubuntu.com/oneiric/current/oneiric-server-cloudimg-amd64.tar.gz\n\n2. Publish the tarball\n\nagy@remote:~$ $ cloud-publish-tarball oneiric-server-cloudimg-amd64.tar.gz agytestbucket amd64\nWed Sep 21 15:55:48 BST 2011: ====== extracting image ======\nWarning: no ramdisk found, assuming '--ramdisk none'\nkernel : oneiric-server-cloudimg-amd64-vmlinuz-virtual\nramdisk: none\nimage  : oneiric-server-cloudimg-amd64.img\nWed Sep 21 15:56:06 BST 2011: ====== bundle/upload kernel ======\nWed Sep 21 15:56:08 BST 2011: ====== bundle/upload image ======\nWed Sep 21 15:57:42 BST 2011: ====== done ======\nemi=\"ami-00000096\"; eri=\"none\"; eki=\"aki-00000095\";\n\n3. Check on the server's S3 bucket - looks correct\n\nagy@nova:~$ ls -la /var/lib/nova/buckets/agytestbucket/ | wc -l\n25\n\n4. Check glance/swift - looks correct\n\nagy@nova:~$ glance show $((0x96))\nURI: http://0.0.0.0/images/150\nId: 150\nPublic: No\nName: None\nStatus: active\nSize: 0\nLocation: swift+https://glance:glance:XXXXXXXXXXXXXXXX@127.0.0.1/auth/v1.0//glance/150\nDisk format: ami\nContainer format: ami\nProperty 'kernel_id': 149\nProperty 'image_location': agytestbucket/oneiric-server-cloudimg-amd64.img.manifest.xml\nProperty 'image_state': available\nProperty 'project_id': canonistack_project\nProperty 'architecture': x86_64\n\n5. For both images - correct for both images (apart from LP#845788)\n\nagy@nova:~$ glance show $((0x95))\nURI: http://0.0.0.0/images/149\nId: 149\nPublic: No\nName: None\nStatus: active\nSize: 0\nLocation: swift+https://glance:glance:XXXXXXXXXXXXXXXX@127.0.0.1/auth/v1.0//glance/149\nDisk format: aki\nContainer format: aki\nProperty 'image_location': agytestbucket/oneiric-server-cloudimg-amd64-vmlinuz-virtual.manifest.xml\nProperty 'image_state': available\nProperty 'project_id': canonistack_project\nProperty 'architecture': x86_64\n\n6. Check what euca-describe-images says - looks correct\n\nagy@remote:~$ euca-describe-images ami-00000096 aki-00000095\nIMAGE   ami-00000096    agytestbucket/oneiric-server-cloudimg-amd64.img.manifest.xml            available       private         x86_64 machine  aki-00000095            instance-store\nIMAGE   aki-00000095    agytestbucket/oneiric-server-cloudimg-amd64-vmlinuz-virtual.manifest.xml                available       privatex86_64   kernel                  instance-store\n\n7. Delete the bucket and the contents\n\nagy@remote:~$ euca-delete-bundle -b agytestbucket --clear\nNeither manifestpath nor prefix was specified.\nAll manifest data in bucket will be deleted.\n\n8. Check that the S3 bucket is missing - all good so far\nagy@nova:~$ ls -la /var/lib/nova/buckets/agytestbucket/ | wc -l\nls: cannot access /var/lib/nova/buckets/agytestbucket/: No such file or directory\n0\n\n9. Check glance/swift - the image is still there\n\nagy@nova:~$ glance show $((0x95))\nURI: http://0.0.0.0/images/149\nId: 149\nPublic: No\nName: None\nStatus: active\nSize: 0\nLocation: swift+https://glance:glance:XXXXXXXXXXXXXXXX@127.0.0.1/auth/v1.0//glance/149\nDisk format: aki\nContainer format: aki\nProperty 'image_location': agytestbucket/oneiric-server-cloudimg-amd64-vmlinuz-virtual.manifest.xml\nProperty 'image_state': available\nProperty 'project_id': canonistack_project\nProperty 'architecture': x86_64\n\n10. For both images - this one too\n\nagy@nova:~$ glance show $((0x96))\nURI: http://0.0.0.0/images/150\nId: 150\nPublic: No\nName: None\nStatus: active\nSize: 0\nLocation: swift+https://glance:glance:XXXXXXXXXXXXXXXX@127.0.0.1/auth/v1.0//glance/150\nDisk format: ami\nContainer format: ami\nProperty 'kernel_id': 149\nProperty 'image_location': agytestbucket/oneiric-server-cloudimg-amd64.img.manifest.xml\nProperty 'image_state': available\nProperty 'project_id': canonistack_project\nProperty 'architecture': x86_64\n\n11. Check what euca-describe-images says - yup, still there\n\nagy@remote:~$ euca-describe-images ami-00000096 aki-00000095\nIMAGE   ami-00000096    agytestbucket/oneiric-server-cloudimg-amd64.img.manifest.xml            available       private         x86_64 machine  aki-00000095            instance-store\nIMAGE   aki-00000095    agytestbucket/oneiric-server-cloudimg-amd64-vmlinuz-virtual.manifest.xml                available       privatex86_64   kernel                  instance-store\n\n12. Delete the images manually from glance/swift\n\nagy@nova:~$ glance delete $((0x96))\nDelete image 150? [y/N] y\nDeleted image 150\n\nagy@dziban:~$ glance delete $((0x95))\nDelete image 149? [y/N] y\nDeleted image 149\n\n13. Check what euca-describe-images says - now they are gone\n\nagy@remote:~$ euca-describe-images ami-00000096 aki-00000095\nImageNotFound: Image ami-00000096 could not be found.\n\nagy@remote:~$ euca-describe-images aki-00000095\nImageNotFound: Image aki-00000095 could not be found.", 
            "date_created": "2011-09-21 15:45:20.594575+00:00", 
            "author": "https://api.launchpad.net/1.0/~aglenyoung"
        }, 
        {
            "content": "The problem here seems to be an asymmetry in client tools. \n\nCloud-publish-tarball calls cloud-publish-image[1] which uploads the image, then calls euca-register to register the uploaded image. Nova registers the image with glance in nova.api.ec2.cloud.CloudController.register_image. \n\nEuca-delete-bundle[2] removes the bucket, manifest and image parts by contacting the S3 endpoint. It does not contact the EC2 endpoint to call deregister_image. \n\nI dont think this is a bug in euca-delete-bundle, as the official api docs [3] say the command removes a bundle from S3, not that it removes a bundle and deregisters it. I haven't used EC2, so I'm not sure if the official implementation does deregister an image when it is removed from S3. \n\nThe could be a cloud-unpublish script that calls  euca-deregister,  then euca-delete-bundle which would then be the inverse of cloud-publish tarball.\n\nWhile I can confirm the behaviour is as explained in the initial comment, my assessment is that this is not a bug. \n\n[1] http://bazaar.launchpad.net/~cloud-utils-dev/cloud-utils/trunk/view/head:/bin/cloud-publish-image#L507\n[2] http://bazaar.launchpad.net/~eucalyptus-maintainers/euca2ools/euca2ools-main/view/head:/euca2ools/commands/euca/deletebundle.py#L177\n[3] http://docs.aws.amazon.com/AWSEC2/latest/CommandLineReference/CLTRG-ami-delete-bundle.html", 
            "date_created": "2013-05-09 13:04:28.548232+00:00", 
            "author": "https://api.launchpad.net/1.0/~hughsaunders"
        }, 
        {
            "content": "Closed as invalid as there has been no further discussion. ", 
            "date_created": "2013-05-29 10:25:28.178805+00:00", 
            "author": "https://api.launchpad.net/1.0/~hughsaunders"
        }
    ]
}