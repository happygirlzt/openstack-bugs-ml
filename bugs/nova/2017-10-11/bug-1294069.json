{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:14:37.072999+00:00", 
    "description": "https://review.openstack.org/#/c/78194/ changed tempest to clear image_ref for some BFV tests - in particular the test_volume_boot_pattern\n\nThis now results in a \"KeyError: 'disk_format'\" exception from Nova when using the XenAPI driver.\n\nhttp://paste.openstack.org/show/73733/ is a nicer format of the below - but might disappear!\n\n2014-03-18 11:20:07.475 ERROR nova.compute.manager [req-82096fe0-921a-4bc1-9c41-d0aafad4c923 TestVolumeBootPattern-581093620 TestVolumeBootPattern-1800543246] [instance: 2b047f24-675c-4921-8cf3-85584097f106] Error: 'disk_format'\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106] Traceback (most recent call last):\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1306, in _build_instance\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     set_access_ip=set_access_ip)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/compute/manager.py\", line 394, in decorated_function\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     return function(self, context, *args, **kwargs)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1708, in _spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     LOG.exception(_('Instance failed to spawn'), instance=instance)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     six.reraise(self.type_, self.value, self.tb)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1705, in _spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     block_device_info)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 236, in spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     admin_password, network_info, block_device_info)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 357, in spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     network_info, block_device_info, name_label, rescue)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 526, in _spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     undo_mgr.rollback_and_reraise(msg=msg, instance=instance)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/utils.py\", line 812, in rollback_and_reraise\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     self._rollback()\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     six.reraise(self.type_, self.value, self.tb)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 501, in _spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     disk_image_type = determine_disk_image_type_step(undo_mgr)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 146, in inner\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     rv = f(*args, **kwargs)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 414, in determine_disk_image_type_step\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     return vm_utils.determine_disk_image_type(image_meta)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vm_utils.py\", line 1647, in determine_disk_image_type\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     disk_format = image_meta['disk_format']\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106] KeyError: 'disk_format'\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]\n\nI've confirmed that running without https://review.openstack.org/#/c/78194/ passes the tests (although there is a race condition, which is why test_volume_boot_pattern is disabled in the XenServer CI system) but will always fail with https://review.openstack.org/#/c/78194/ applied.", 
    "tags": [
        "xenserver"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1294069", 
    "owner": "https://api.launchpad.net/1.0/~johngarbutt", 
    "id": 1294069, 
    "index": 1438, 
    "created": "2014-03-18 11:40:31.671059+00:00", 
    "title": "XenAPI: Boot from volume without image_ref broken", 
    "comments": [
        {
            "content": "https://review.openstack.org/#/c/78194/ changed tempest to clear image_ref for some BFV tests\n\nThis now results in a \"KeyError: 'disk_format'\" exception from Nova when using the XenAPI driver.\n\n\n2014-03-18 11:20:07.475 ERROR nova.compute.manager [req-82096fe0-921a-4bc1-9c41-d0aafad4c923 TestVolumeBootPattern-581093620 TestVolumeBootPattern-1800543246] [instance: 2b047f24-675c-4921-8cf3-85584097f106] Error: 'disk_format'\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106] Traceback (most recent call last):\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1306, in _build_instance\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     set_access_ip=set_access_ip)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/compute/manager.py\", line 394, in decorated_function\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     return function(self, context, *args, **kwargs)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1708, in _spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     LOG.exception(_('Instance failed to spawn'), instance=instance)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     six.reraise(self.type_, self.value, self.tb)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1705, in _spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     block_device_info)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 236, in spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     admin_password, network_info, block_device_info)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 357, in spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     network_info, block_device_info, name_label, rescue)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 526, in _spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     undo_mgr.rollback_and_reraise(msg=msg, instance=instance)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/utils.py\", line 812, in rollback_and_reraise\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     self._rollback()\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     six.reraise(self.type_, self.value, self.tb)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 501, in _spawn\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     disk_image_type = determine_disk_image_type_step(undo_mgr)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 146, in inner\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     rv = f(*args, **kwargs)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 414, in determine_disk_image_type_step\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     return vm_utils.determine_disk_image_type(image_meta)\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]   File \"/opt/stack/nova/nova/virt/xenapi/vm_utils.py\", line 1647, in determine_disk_image_type\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]     disk_format = image_meta['disk_format']\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106] KeyError: 'disk_format'\n2014-03-18 11:20:07.475 TRACE nova.compute.manager [instance: 2b047f24-675c-4921-8cf3-85584097f106]", 
            "date_created": "2014-03-18 11:40:31.671059+00:00", 
            "author": "https://api.launchpad.net/1.0/~bob-ball"
        }, 
        {
            "content": "Not sure this ever worked, so its not really blocking RC1", 
            "date_created": "2014-03-18 11:42:02.292027+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/81252", 
            "date_created": "2014-03-18 12:55:35.491303+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/81252\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=1b2570877846598d3545a9c9f31680f2a995491f\nSubmitter: Jenkins\nBranch:    master\n\ncommit 1b2570877846598d3545a9c9f31680f2a995491f\nAuthor: John Garbutt <email address hidden>\nDate:   Tue Mar 18 12:53:12 2014 +0000\n\n    xenapi: boot from volume without image_ref\n    \n    Currently xenapi does not deal well with image_meta that does not\n    contain \"disk_format\". This happens when we get image_meta from an\n    associated volume, rather than from glance.\n    \n    Change-Id: Id673158442fde27e8d468ca412c9bd557a886e6b\n    Closes-Bug: #1294069\n", 
            "date_created": "2014-03-21 17:22:22.700388+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/81497\nCommitted: https://git.openstack.org/cgit/openstack-dev/devstack/commit/?id=f1a2dbffe8ba369b0a8a125e975864a5d88f3e87\nSubmitter: Jenkins\nBranch:    master\n\ncommit f1a2dbffe8ba369b0a8a125e975864a5d88f3e87\nAuthor: Bob Ball <email address hidden>\nDate:   Wed Mar 19 11:08:54 2014 +0000\n\n    XenAPI: Cirros images must always boot as PV.\n    \n    The default for VHD disk-types is PV, which is why booting from a\n    server works.  However, creating a volume from the image needs to\n    pass this parameter on to the volume.  Note that\n    Id673158442fde27e8d468ca412c9bd557a886e6b is also required to fix\n    bug 1294069\n    \n    Change-Id: I7ea1d85d6082787ac4551f78300a04bf59074261\n    Partial-Bug: 1294069\n", 
            "date_created": "2014-03-24 17:17:49.978266+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}