{
    "status": "Invalid", 
    "last_updated": "2017-09-28 10:29:36.418632+00:00", 
    "description": "Description\n===========\nDuring resize operation the migrate task nova\\conductor\\tasks\\migrate.py tries to setup the\ninstance group in the request spec via following call -\nscheduler_utils.setup_instance_group(self.context, self.request_spec)\n\nThe setup_instance_group tries to get the group details\nIf there are instance groups available following code gets executed - \n    group_info = _get_group_details(context, instance_uuid, group_hosts)\n    if group_info is not None and request_spec.instance_group is not None:\n        request_spec.instance_group.hosts = list(group_info.hosts)\n        request_spec.instance_group.policies = group_info.policies\n        request_spec.instance_group.members = group_info.members\n\nIf the group info is not None, then the call fails as the request_spec.instance_group is None.\n\nSteps to reproduce\n==================\n- create an instance group.\n- Add an instance as a member for that instance group.\n- Resize the instance.\n- The resize operation fails with following error - \nUnexpected exception in API method: AttributeError: 'NoneType' object has no attribute 'hosts'\nTraceback (most recent call last):\n\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/server.py\", line 160, in _process_incoming\n    res = self.dispatcher.dispatch(message)\n\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 213, in dispatch\n    return self._do_dispatch(endpoint, method, ctxt, args)\n\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 183, in _do_dispatch\n    result = func(ctxt, **new_args)\n\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/server.py\", line 232, in inner\n    return func(*args, **kwargs)\n\n  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 83, in wrapper\n    return fn(self, context, *args, **kwargs)\n\n  File \"/usr/lib/python2.7/site-packages/nova/compute/utils.py\", line 953, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 282, in migrate_server\n    reservations, clean_shutdown, request_spec)\n\n  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 345, in _cold_migrate\n    updates, ex, legacy_spec)\n\n  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n\n  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n\n  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 314, in _cold_migrate\n    task.execute()\n\nExpected result\n===============\nExpect to successfully resize the instance.\n\nActual result\n=============\nResize fails with above error.\n\nEnvironment\n===========\n\n1. Openstack Pike \nopenstack-nova-api-16.0.0-201709220608.ibm.el7.60.noarch\nopenstack-nova-16.0.0-201709220608.ibm.el7.60.noarch\n\n2. Which hypervisor did you use?\n  Not relevant here as error is in API/conductor layer itself.\n\n2. Which storage type did you use?\n   SAN\n\n3. Which networking type did you use?\nNot relevant\n\nLogs & Configs\n==============\nThe above exception trace should give a good understanding of where the issue is occurring.", 
    "tags": [
        "resize"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1719859", 
    "owner": "None", 
    "id": 1719859, 
    "index": 7057, 
    "created": "2017-09-27 11:55:47.719280+00:00", 
    "title": "Resize failure due to instance group being None in request spec", 
    "comments": [
        {
            "content": "Description\n===========\nDuring resize operation the migrate task nova\\conductor\\tasks\\migrate.py tries to setup the\ninstance group in the request spec via following call -\nscheduler_utils.setup_instance_group(self.context, self.request_spec)\n\nThe setup_instance_group tries to get the group details\nIf there are instance groups available following code gets executed - \n    group_info = _get_group_details(context, instance_uuid, group_hosts)\n    if group_info is not None and request_spec.instance_group is not None:\n        request_spec.instance_group.hosts = list(group_info.hosts)\n        request_spec.instance_group.policies = group_info.policies\n        request_spec.instance_group.members = group_info.members\n\nIf the group info is not None, then the call fails as the request_spec.instance_group is None.\n\nSteps to reproduce\n==================\n- create an instance group.\n- Add an instance as a member for that instance group.\n- Resize the instance.\n- The resize operation fails with following error - \nUnexpected exception in API method: AttributeError: 'NoneType' object has no attribute 'hosts'\nTraceback (most recent call last):\n\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/server.py\", line 160, in _process_incoming\n    res = self.dispatcher.dispatch(message)\n\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 213, in dispatch\n    return self._do_dispatch(endpoint, method, ctxt, args)\n\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 183, in _do_dispatch\n    result = func(ctxt, **new_args)\n\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/server.py\", line 232, in inner\n    return func(*args, **kwargs)\n\n  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 83, in wrapper\n    return fn(self, context, *args, **kwargs)\n\n  File \"/usr/lib/python2.7/site-packages/nova/compute/utils.py\", line 953, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 282, in migrate_server\n    reservations, clean_shutdown, request_spec)\n\n  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 345, in _cold_migrate\n    updates, ex, legacy_spec)\n\n  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n\n  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n\n  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 314, in _cold_migrate\n    task.execute()\n\nExpected result\n===============\nExpect to successfully resize the instance.\n\nActual result\n=============\nResize fails with above error.\n\nEnvironment\n===========\n\n1. Openstack Pike \nopenstack-nova-api-16.0.0-201709220608.ibm.el7.60.noarch\nopenstack-nova-16.0.0-201709220608.ibm.el7.60.noarch\n\n2. Which hypervisor did you use?\n  Not relevant here as error is in API/conductor layer itself.\n\n2. Which storage type did you use?\n   SAN\n\n3. Which networking type did you use?\nNot relevant\n\nLogs & Configs\n==============\nThe above exception trace should give a good understanding of where the issue is occurring.", 
            "date_created": "2017-09-27 11:55:47.719280+00:00", 
            "author": "https://api.launchpad.net/1.0/~manas-mandlekar"
        }, 
        {
            "content": "So, we pass the original RequestSpec when we resize, and that ReqSpec object should include the instance group information if the instance associated with that ReqSpec was created by being specified that it should be in group X.\n\nThe above bug implies that there are discrepancies between what we got from the ReqSpec and what we get from the DB when we lookup the direct InstanceGroup object attached to that instance.\n\nI mean, say req_spec.instance_group is None, then the internal variable named 'group_hosts' should be set to None :\nhttps://github.com/openstack/nova/blob/99f0387b946ed44f412801feaa8b957d4f3c8a94/nova/scheduler/utils.py#L562\n\nLater, when calling _get_group_details(), we lookup the InstanceGroup record by \nhttps://github.com/openstack/nova/blob/99f0387b946ed44f412801feaa8b957d4f3c8a94/nova/scheduler/utils.py#L520-L521\n\nIn the ca", 
            "date_created": "2017-09-27 13:45:10.659003+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "Sorry, I did cut my comment, following up.\n\nIn the case of a discrepancy, I'm assuming that\n\nhttps://github.com/openstack/nova/blob/99f0387b946ed44f412801feaa8b957d4f3c8a94/nova/scheduler/utils.py#L520-L521\n\nreturns an InstanceGroup object and not None. If there was no discrepancy, it should return None.\n\nIf the 'group' variable is set, then we should return a NamedTuple object (namely GroupDetails) that would contain the hosts attribute that would be set and equal to the hosts we got from the InstanceGroup.hosts field.\n\nIn that case, I get why you get the NoneType. But I still don't understand how we can have such discrepancy, because the original RequestSpec record should include that specific group information (since you can only attach an instance to a group by the nova boot call).\n\nAre we missing something which is not persisted ? Hard to trace.\n", 
            "date_created": "2017-09-27 13:51:17.879018+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "Thanks for taking a look Sylvain.\n\nInvestigating what is causing the discrepancy. Will get back on this.", 
            "date_created": "2017-09-27 16:37:44.898066+00:00", 
            "author": "https://api.launchpad.net/1.0/~manas-mandlekar"
        }
    ]
}