{
    "status": "Invalid", 
    "last_updated": "2013-01-22 10:56:23.476765+00:00", 
    "description": "The upgrade from Precise+Essex to Precise+Folsom using the ubuntu-cloud archive fails while running the 092_add_instance_system_metadata migration. The migration fails while creating the `instance_system_metadata` table (see below).\n\nThe '1005' MySQL error indicates that a foreign key is failing to apply. After changing the table definition in the table to include `mysql_charset='utf8'` the migration succeeds (see attached bug). This is a similar bug that the `dns_domains` table had previously.\n\n\nError message received during package upgrade:\n\n2012-10-04 10:59:55 INFO sqlalchemy.engine.base.Engine [-] SHOW CREATE TABLE `instances`\n2012-10-04 10:59:55 INFO sqlalchemy.engine.base.Engine [-] ()\n2012-10-04 10:59:55 DEBUG sqlalchemy.engine.base.Engine [-] Col ('Table', 'Create Table') from (pid=24755) __init__ /usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py:2789\n2012-10-04 10:59:55 DEBUG sqlalchemy.engine.base.Engine [-] Row ('instances', 'CREATE TABLE `instances` (\\n  `created_at` datetime DEFAULT NULL,\\n  `updated_at` datetime DEFAULT NULL,\\n  `deleted_at` datetime DEFAULT NULL,\\n  `deleted` tinyint(1) DEFAULT NULL,\\n  `id` int(11) NOT NULL AUTO_INCREMENT,\\n  `internal_id` int(11) DEFAULT NULL,\\n`user_id` varchar(255) DEFAULT NULL,\\n  `project_id` varchar(255) DEFAULT NULL,\\n  `image_ref` varchar(255) DEFAULT NULL,\\n  `kernel_id` varchar(255) DEFAULT NULL,\\n  `ramdisk_id` varchar(255) DEFAULT NULL,\\n  `server_name` varchar(255) DEFAULT NULL,\\n  `launch_index` int(11) DEFAULT NULL,\\n  `key_name` varchar(255) DEFAULT NULL,\\n  `key_data` mediumtext,\\n  `power_state` int(11) DEFAULT NULL,\\n  `vm_state` varchar(255) DEFAULT NULL,\\n  `memory_mb` int(11) DEFAULT NULL,\\n  `vcpus` int(11) DEFAULT NULL,\\n  `hostname` varchar(255) DEFAULT NULL,\\n  `host` varchar(255) DEFAULT NULL,\\n  `user_data` mediumtext,\\n  `reservation_id` varchar(255) DEFAULT NULL,\\n  `scheduled_at` datetime DEFAULT NULL,\\n  `launched_at` datetime DEFAULT NULL,\\n  `terminated_at` datetime DEFAULT NULL,\\n  `display_name` varchar(255) DEFAULT NULL,\\n  `display_description` varchar(255) DEFAULT NULL,\\n  `availability_zone` varchar(255) DEFAULT NULL,\\n  `locked` tinyint(1) DEFAULT NULL,\\n  `os_type` varchar(255) DEFAULT NULL,\\n  `launched_on` ediumtext,\\n  `instance_type_id` int(11) DEFAULT NULL,\\n  `vm_mode` varchar(255) DEFAULT NULL,\\n  `uuid` varchar(36) DEFAULT NULL,\\n  `architecture` varchar(255) DEFAULT NULL,\\n  `root_device_name` varchar(255) DEFAULT NULL,\\n access_ip_v4` varchar(255) DEFAULT NULL,\\n  `access_ip_v6` varchar(255) DEFAULT NULL,\\n  `config_drive` varchar(255) DEFAULT NULL,\\n  `task_state` varchar(255) DEFAULT NULL,\\n  `default_ephemeral_device` varchar(255) DEFAULT NULL,\\n  `default_swap_device` varchar(255) DEFAULT NULL,\\n  `progress` int(11) DEFAULT NULL,\\n  `auto_disk_config` tinyint(1) DEFAULT NULL,\\n  `shutdown_terminate` tinyint(1) DEFAULT NULL,\\n  `disable_terminate` tinyint(1) DEFAULT NULL,\\n  `root_gb` int(11) DEFAULT NULL,\\n  `ephemeral_gb` int(11) DEFAULT NULL,\\n  `cell_name` varchar(255) DEFAULT NULL,\\n  PRIMARY KEY (`id`),\\n  UNIQUE KEY `uuid` (`uuid`),\\n  KEY `project_id` (`project_id`)\\n) ENGINE=InnoDB AUTO_INCREMENT=17623 DEFAULT CHARSET=utf8') from (pid=24755) process_rows /usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py:3194\n2012-10-04 10:59:55 DEBUG sqlalchemy.pool.QueuePool [-] Connection <_mysql.connection open to '10.55.58.1' at 28b0ed0> being returned to pool from (pid=24755) _finalize_fairy /usr/lib/python2.7/dist-packages/sqlalchemy/pool.py:3\n64\n2012-10-04 10:59:55 DEBUG sqlalchemy.pool.QueuePool [-] Connection <_mysql.connection open to '10.55.58.1' at 28b0ed0> checked out from pool from (pid=24755) __init__ /usr/lib/python2.7/dist-packages/sqlalchemy/pool.py:401\n2012-10-04 10:59:55 INFO sqlalchemy.engine.base.Engine [-]\nCREATE TABLE instance_system_metadata (\n        created_at DATETIME,\n        updated_at DATETIME,\n        deleted_at DATETIME,\n        deleted BOOL,\n        id INTEGER NOT NULL AUTO_INCREMENT,\n        instance_uuid VARCHAR(36) NOT NULL,\n        `key` VARCHAR(255) NOT NULL,\n        value VARCHAR(255),\n        PRIMARY KEY (id),\n        CHECK (deleted IN (0, 1)),\n        FOREIGN KEY(instance_uuid) REFERENCES instances (uuid)\n)ENGINE=InnoDB\n\n\n2012-10-04 10:59:55 INFO sqlalchemy.engine.base.Engine [-] ()\n2012-10-04 10:59:55 INFO sqlalchemy.engine.base.Engine [-] ROLLBACK\n2012-10-04 10:59:55 DEBUG sqlalchemy.pool.QueuePool [-] Connection <_mysql.connection open to '10.55.58.1' at 28b0ed0> being returned to pool from (pid=24755) _finalize_fairy /usr/lib/python2.7/dist-packages/sqlalchemy/pool.py:364\nNo handlers could be found for logger \"092_add_instance_system_metadata\"\nCommand failed, please check log for more info\n2012-10-04 10:59:55 CRITICAL nova [-] (OperationalError) (1005, \"Can't create table 'nova.instance_system_metadata' (errno: 150)\") '\\nCREATE TABLE instance_system_metadata (\\n\\tcreated_at DATETIME, \\n\\tupdated_at DATETIME, \\n\\tdeleted_at DATETIME, \\n\\tdeleted BOOL, \\n\\tid INTEGER NOT NULL AUTO_INCREMENT, \\n\\tinstance_uuid VARCHAR(36) NOT NULL, \\n\\t`key` VARCHAR(255) NOT NULL, \\n\\tvalue VARCHAR(255), \\n\\tPRIMARY KEY (id), \\n\\tCHECK (deleted IN (0, 1)), \\n\\tFOREIGN KEY(instance_uuid) REFERENCES instances (uuid)\\n)ENGINE=InnoDB\\n\\n' ()\n\nSystem information:\n\n$ cat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=12.04\nDISTRIB_CODENAME=precise\nDISTRIB_DESCRIPTION=\"Ubuntu 12.04.1 LTS\"\n\n$ dpkg -l | grep nova\nii  nova-api                         2012.2-0ubuntu3~cloud0                        OpenStack Compute - API frontend\nii  nova-cert                        2012.2-0ubuntu3~cloud0                        OpenStack Compute - certificate management\nii  nova-common                      2012.2-0ubuntu3~cloud0                        OpenStack Compute - common files\nii  nova-doc                         2012.2-0ubuntu3~cloud0                        OpenStack Compute - documentation\nii  nova-network                     2012.2-0ubuntu3~cloud0                        OpenStack Compute - Network manager\nii  nova-objectstore                 2012.2-0ubuntu3~cloud0                        OpenStack Compute - object store\nii  nova-scheduler                   2012.2-0ubuntu3~cloud0                        OpenStack Compute - virtual machine scheduler\nii  python-nova                      2012.2-0ubuntu3~cloud0                        OpenStack Compute Python libraries\nii  python-novaclient                1:2.9.0-0ubuntu1~cloud0                       client library for OpenStack Compute API", 
    "tags": [
        "canonistack", 
        "openstack-ubuntu-upgrade", 
        "patch"
    ], 
    "importance": "Critical", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1062277", 
    "owner": "https://api.launchpad.net/1.0/~sorrison", 
    "id": 1062277, 
    "index": 91, 
    "created": "2012-10-05 13:16:53.603020+00:00", 
    "title": "092_add_instance_system_metadata migration fails when upgrading", 
    "comments": [
        {
            "content": "The upgrade from Precise+Essex to Precise+Folsom using the ubuntu-cloud archive fails while running the 092_add_instance_system_metadata migration. The migration fails while creating the `instance_system_metadata` table (see below).\n\nThe '1005' MySQL error indicates that a foreign key is failing to apply. After changing the table definition in the table to include `mysql_charset='utf8'` the migration succeeds (see attached bug). This is a similar bug that the `dns_domains` table had previously.\n\n\nError message received during package upgrade:\n\n2012-10-04 10:59:55 INFO sqlalchemy.engine.base.Engine [-] SHOW CREATE TABLE `instances`\n2012-10-04 10:59:55 INFO sqlalchemy.engine.base.Engine [-] ()\n2012-10-04 10:59:55 DEBUG sqlalchemy.engine.base.Engine [-] Col ('Table', 'Create Table') from (pid=24755) __init__ /usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py:2789\n2012-10-04 10:59:55 DEBUG sqlalchemy.engine.base.Engine [-] Row ('instances', 'CREATE TABLE `instances` (\\n  `created_at` datetime DEFAULT NULL,\\n  `updated_at` datetime DEFAULT NULL,\\n  `deleted_at` datetime DEFAULT NULL,\\n  `deleted` tinyint(1) DEFAULT NULL,\\n  `id` int(11) NOT NULL AUTO_INCREMENT,\\n  `internal_id` int(11) DEFAULT NULL,\\n`user_id` varchar(255) DEFAULT NULL,\\n  `project_id` varchar(255) DEFAULT NULL,\\n  `image_ref` varchar(255) DEFAULT NULL,\\n  `kernel_id` varchar(255) DEFAULT NULL,\\n  `ramdisk_id` varchar(255) DEFAULT NULL,\\n  `server_name` varchar(255) DEFAULT NULL,\\n  `launch_index` int(11) DEFAULT NULL,\\n  `key_name` varchar(255) DEFAULT NULL,\\n  `key_data` mediumtext,\\n  `power_state` int(11) DEFAULT NULL,\\n  `vm_state` varchar(255) DEFAULT NULL,\\n  `memory_mb` int(11) DEFAULT NULL,\\n  `vcpus` int(11) DEFAULT NULL,\\n  `hostname` varchar(255) DEFAULT NULL,\\n  `host` varchar(255) DEFAULT NULL,\\n  `user_data` mediumtext,\\n  `reservation_id` varchar(255) DEFAULT NULL,\\n  `scheduled_at` datetime DEFAULT NULL,\\n  `launched_at` datetime DEFAULT NULL,\\n  `terminated_at` datetime DEFAULT NULL,\\n  `display_name` varchar(255) DEFAULT NULL,\\n  `display_description` varchar(255) DEFAULT NULL,\\n  `availability_zone` varchar(255) DEFAULT NULL,\\n  `locked` tinyint(1) DEFAULT NULL,\\n  `os_type` varchar(255) DEFAULT NULL,\\n  `launched_on` ediumtext,\\n  `instance_type_id` int(11) DEFAULT NULL,\\n  `vm_mode` varchar(255) DEFAULT NULL,\\n  `uuid` varchar(36) DEFAULT NULL,\\n  `architecture` varchar(255) DEFAULT NULL,\\n  `root_device_name` varchar(255) DEFAULT NULL,\\n access_ip_v4` varchar(255) DEFAULT NULL,\\n  `access_ip_v6` varchar(255) DEFAULT NULL,\\n  `config_drive` varchar(255) DEFAULT NULL,\\n  `task_state` varchar(255) DEFAULT NULL,\\n  `default_ephemeral_device` varchar(255) DEFAULT NULL,\\n  `default_swap_device` varchar(255) DEFAULT NULL,\\n  `progress` int(11) DEFAULT NULL,\\n  `auto_disk_config` tinyint(1) DEFAULT NULL,\\n  `shutdown_terminate` tinyint(1) DEFAULT NULL,\\n  `disable_terminate` tinyint(1) DEFAULT NULL,\\n  `root_gb` int(11) DEFAULT NULL,\\n  `ephemeral_gb` int(11) DEFAULT NULL,\\n  `cell_name` varchar(255) DEFAULT NULL,\\n  PRIMARY KEY (`id`),\\n  UNIQUE KEY `uuid` (`uuid`),\\n  KEY `project_id` (`project_id`)\\n) ENGINE=InnoDB AUTO_INCREMENT=17623 DEFAULT CHARSET=utf8') from (pid=24755) process_rows /usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py:3194\n2012-10-04 10:59:55 DEBUG sqlalchemy.pool.QueuePool [-] Connection <_mysql.connection open to '10.55.58.1' at 28b0ed0> being returned to pool from (pid=24755) _finalize_fairy /usr/lib/python2.7/dist-packages/sqlalchemy/pool.py:3\n64\n2012-10-04 10:59:55 DEBUG sqlalchemy.pool.QueuePool [-] Connection <_mysql.connection open to '10.55.58.1' at 28b0ed0> checked out from pool from (pid=24755) __init__ /usr/lib/python2.7/dist-packages/sqlalchemy/pool.py:401\n2012-10-04 10:59:55 INFO sqlalchemy.engine.base.Engine [-]\nCREATE TABLE instance_system_metadata (\n        created_at DATETIME,\n        updated_at DATETIME,\n        deleted_at DATETIME,\n        deleted BOOL,\n        id INTEGER NOT NULL AUTO_INCREMENT,\n        instance_uuid VARCHAR(36) NOT NULL,\n        `key` VARCHAR(255) NOT NULL,\n        value VARCHAR(255),\n        PRIMARY KEY (id),\n        CHECK (deleted IN (0, 1)),\n        FOREIGN KEY(instance_uuid) REFERENCES instances (uuid)\n)ENGINE=InnoDB\n\n\n2012-10-04 10:59:55 INFO sqlalchemy.engine.base.Engine [-] ()\n2012-10-04 10:59:55 INFO sqlalchemy.engine.base.Engine [-] ROLLBACK\n2012-10-04 10:59:55 DEBUG sqlalchemy.pool.QueuePool [-] Connection <_mysql.connection open to '10.55.58.1' at 28b0ed0> being returned to pool from (pid=24755) _finalize_fairy /usr/lib/python2.7/dist-packages/sqlalchemy/pool.py:364\nNo handlers could be found for logger \"092_add_instance_system_metadata\"\nCommand failed, please check log for more info\n2012-10-04 10:59:55 CRITICAL nova [-] (OperationalError) (1005, \"Can't create table 'nova.instance_system_metadata' (errno: 150)\") '\\nCREATE TABLE instance_system_metadata (\\n\\tcreated_at DATETIME, \\n\\tupdated_at DATETIME, \\n\\tdeleted_at DATETIME, \\n\\tdeleted BOOL, \\n\\tid INTEGER NOT NULL AUTO_INCREMENT, \\n\\tinstance_uuid VARCHAR(36) NOT NULL, \\n\\t`key` VARCHAR(255) NOT NULL, \\n\\tvalue VARCHAR(255), \\n\\tPRIMARY KEY (id), \\n\\tCHECK (deleted IN (0, 1)), \\n\\tFOREIGN KEY(instance_uuid) REFERENCES instances (uuid)\\n)ENGINE=InnoDB\\n\\n' ()\n\nSystem information:\n\n$ cat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=12.04\nDISTRIB_CODENAME=precise\nDISTRIB_DESCRIPTION=\"Ubuntu 12.04.1 LTS\"\n\n$ dpkg -l | grep nova\nii  nova-api                         2012.2-0ubuntu3~cloud0                        OpenStack Compute - API frontend\nii  nova-cert                        2012.2-0ubuntu3~cloud0                        OpenStack Compute - certificate management\nii  nova-common                      2012.2-0ubuntu3~cloud0                        OpenStack Compute - common files\nii  nova-doc                         2012.2-0ubuntu3~cloud0                        OpenStack Compute - documentation\nii  nova-network                     2012.2-0ubuntu3~cloud0                        OpenStack Compute - Network manager\nii  nova-objectstore                 2012.2-0ubuntu3~cloud0                        OpenStack Compute - object store\nii  nova-scheduler                   2012.2-0ubuntu3~cloud0                        OpenStack Compute - virtual machine scheduler\nii  python-nova                      2012.2-0ubuntu3~cloud0                        OpenStack Compute Python libraries\nii  python-novaclient                1:2.9.0-0ubuntu1~cloud0                       client library for OpenStack Compute API", 
            "date_created": "2012-10-05 13:16:53.603020+00:00", 
            "author": "https://api.launchpad.net/1.0/~aglenyoung"
        }, 
        {
            "content": "", 
            "date_created": "2012-10-05 13:16:53.603020+00:00", 
            "author": "https://api.launchpad.net/1.0/~aglenyoung"
        }, 
        {
            "content": "The attachment \"092_add_instance_system_metadata.patch\" of this bug report has been identified as being a patch.  The ubuntu-reviewers team has been subscribed to the bug report so that they can review the patch.  In the event that this is in fact not a patch you can resolve this situation by removing the tag 'patch' from the bug report and editing the attachment so that it is not flagged as a patch.  Additionally, if you are member of the ubuntu-reviewers team please also unsubscribe the team from this bug report.\n\n[This is an automated message performed by a Launchpad user owned by Brian Murray.  Please contact him regarding any issues with the action taken in this bug report.]", 
            "date_created": "2012-10-05 16:22:45.366096+00:00", 
            "author": "https://api.launchpad.net/1.0/~crichton"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/14617", 
            "date_created": "2012-10-22 20:51:39.228817+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I'm curious as to why this is happening. When running the initial Essex/Folsom migrations we explicitly set the default DB schema to use the UTF8 charset.\n\nWhat do you see from the output of this query:\n\nSELECT default_character_set_name FROM information_schema.SCHEMATA S WHERE schema_name = \"nova\";", 
            "date_created": "2012-10-23 18:02:30.149381+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "@Dan\n\nThe default_character_set_name is set to 'latin1'. This system has been upgraded through various lifecycles of Openstack which may explain it (a more recent installation that I looked at is set to 'utf8').\n\nI would argue that setting the character set explicitly on table creation is the correct and prevents these sorts of issues.", 
            "date_created": "2012-10-23 19:39:56.268123+00:00", 
            "author": "https://api.launchpad.net/1.0/~aglenyoung"
        }, 
        {
            "content": "OK I've figured it out. \n\nWe had a DB issue in Essex to do with the projects table. I had to do a mysqldump and then reimport. This would've then had the DB at Essex but with character set for the database set to the default in mysql which is latin1. Thus missing the 077 migration which sets the database character set to utf-8.\n\nI agree with Andrew on this one, setting it explicitly on DB creation should prevent something like this.", 
            "date_created": "2012-10-23 22:37:07.453241+00:00", 
            "author": "https://api.launchpad.net/1.0/~sorrison"
        }, 
        {
            "content": "in a conclusion. this is caused by human operation. not a  code bug.", 
            "date_created": "2012-12-11 15:02:40.673169+00:00", 
            "author": "https://api.launchpad.net/1.0/~heut2008"
        }
    ]
}