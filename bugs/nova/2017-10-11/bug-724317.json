{
    "status": "Fix Released", 
    "last_updated": "2011-11-25 13:12:03.223997+00:00", 
    "description": "The command line \"nova-manage project zipfile ...\" generates an exception and returns the following message:\nUnexpected error while running command.\nCommand: openssl ca -batch -out /tmp/tmpIYutU2/outbound.csr -config ./openssl.cnf -infiles /tmp/tmpIYutU2/inbound.csr\nExit code: 1\nStdout: ''\nStderr: \"Using configuration from ./openssl.cnf\\nCheck that the request matches the signature\\nSignature ok\\nThe Subject's Distinguished Name is as follows\\ncountryName           :PRINTABLE:'US'\\nstateOrProvinceName   :ASN.1 12:'California'\\nlocalityName          :ASN.1 12:'MountainView'\\norganizationName      :ASN.1 12:'AnsoLabs'\\norganizationalUnitName:ASN.1 12:'NovaDev'\\ncommonName            :ASN.1 12:'admin-admin-2011-02-24T13:46:26Z'\\nThe stateOrProvinceName field needed to be the same in the\\nCA certificate (California) and the request (California)\\n\"\nThe above error may show that the certificate db has not been created.\nPlease create a database by running a nova-api server on this host.\n\nBy running the openssl command from the CA directory of OpenStack, I've the same error:\n[root]# openssl ca -config openssl.cnf -infiles ../inboud.csr \nUsing configuration from openssl.cnf\nCheck that the request matches the signature\nSignature ok\nThe Subject's Distinguished Name is as follows\ncountryName           :PRINTABLE:'US'\nstateOrProvinceName   :ASN.1 12:'California'\nlocalityName          :ASN.1 12:'MountainView'\norganizationName      :ASN.1 12:'AnsoLabs'\norganizationalUnitName:ASN.1 12:'NovaDev'\ncommonName            :ASN.1 12:'admin-admin-2011-02-24T13:05:13Z'\nThe stateOrProvinceName field needed to be the same in the\nCA certificate (California) and the request (California)\n\nThe problem comes from the openssl.cnf template file provided by OpenStack which contains:\n    countryName = match\n    stateOrProvinceName = match\n\nThis policy is too restrictive and generates the previous error.\n\nBy replacing this policy by:\n    countryName = supplied\n    stateOrProvinceName = optional\nin the openssl.cnf file, then the \"nova-manage project zipfile ...\" command line is OK.\nSo I suggest to specifiy these values in the openssl.cnf.tmpl file.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 36, 
    "link": "https://bugs.launchpad.net/nova/+bug/724317", 
    "owner": "https://api.launchpad.net/1.0/~dan-prince", 
    "id": 724317, 
    "index": 2291, 
    "created": "2011-02-24 13:45:29.147755+00:00", 
    "title": "openssl error due to openssl.cnf.tmpl file provided by OpenStack", 
    "comments": [
        {
            "content": "The command line \"nova-manage project zipfile ...\" generates an exception and returns the following message:\nUnexpected error while running command.\nCommand: openssl ca -batch -out /tmp/tmpIYutU2/outbound.csr -config ./openssl.cnf -infiles /tmp/tmpIYutU2/inbound.csr\nExit code: 1\nStdout: ''\nStderr: \"Using configuration from ./openssl.cnf\\nCheck that the request matches the signature\\nSignature ok\\nThe Subject's Distinguished Name is as follows\\ncountryName           :PRINTABLE:'US'\\nstateOrProvinceName   :ASN.1 12:'California'\\nlocalityName          :ASN.1 12:'MountainView'\\norganizationName      :ASN.1 12:'AnsoLabs'\\norganizationalUnitName:ASN.1 12:'NovaDev'\\ncommonName            :ASN.1 12:'admin-admin-2011-02-24T13:46:26Z'\\nThe stateOrProvinceName field needed to be the same in the\\nCA certificate (California) and the request (California)\\n\"\nThe above error may show that the certificate db has not been created.\nPlease create a database by running a nova-api server on this host.\n\nBy running the openssl command from the CA directory of OpenStack, I've the same error:\n[root]# openssl ca -config openssl.cnf -infiles ../inboud.csr \nUsing configuration from openssl.cnf\nCheck that the request matches the signature\nSignature ok\nThe Subject's Distinguished Name is as follows\ncountryName           :PRINTABLE:'US'\nstateOrProvinceName   :ASN.1 12:'California'\nlocalityName          :ASN.1 12:'MountainView'\norganizationName      :ASN.1 12:'AnsoLabs'\norganizationalUnitName:ASN.1 12:'NovaDev'\ncommonName            :ASN.1 12:'admin-admin-2011-02-24T13:05:13Z'\nThe stateOrProvinceName field needed to be the same in the\nCA certificate (California) and the request (California)\n\nThe problem comes from the openssl.cnf template file provided by OpenStack which contains:\n    countryName = match\n    stateOrProvinceName = match\n\nThis policy is too restrictive and generates the previous error.\n\nBy replacing this policy by:\n    countryName = supplied\n    stateOrProvinceName = optional\nin the openssl.cnf file, then the \"nova-manage project zipfile ...\" command line is OK.\nSo I suggest to specifiy these values in the openssl.cnf.tmpl file.", 
            "date_created": "2011-02-24 13:45:29.147755+00:00", 
            "author": "https://api.launchpad.net/1.0/~philippe-berthault-deactivatedaccount"
        }, 
        {
            "content": "This is only an issue in the new version of openssl, it would be nice to figure out why California doesn't match California (perhaps one is unicode), although it makes sense to put in this workaround in the meantime.\n\nVish\n\nOn Feb 24, 2011, at 5:45 AM, Philippe Berthault wrote:\n\n> Public bug reported:\n> \n> The command line \"nova-manage project zipfile ...\" generates an exception and returns the following message:\n> Unexpected error while running command.\n> Command: openssl ca -batch -out /tmp/tmpIYutU2/outbound.csr -config ./openssl.cnf -infiles /tmp/tmpIYutU2/inbound.csr\n> Exit code: 1\n> Stdout: ''\n> Stderr: \"Using configuration from ./openssl.cnf\\nCheck that the request matches the signature\\nSignature ok\\nThe Subject's Distinguished Name is as follows\\ncountryName           :PRINTABLE:'US'\\nstateOrProvinceName   :ASN.1 12:'California'\\nlocalityName          :ASN.1 12:'MountainView'\\norganizationName      :ASN.1 12:'AnsoLabs'\\norganizationalUnitName:ASN.1 12:'NovaDev'\\ncommonName            :ASN.1 12:'admin-admin-2011-02-24T13:46:26Z'\\nThe stateOrProvinceName field needed to be the same in the\\nCA certificate (California) and the request (California)\\n\"\n> The above error may show that the certificate db has not been created.\n> Please create a database by running a nova-api server on this host.\n> \n> By running the openssl command from the CA directory of OpenStack, I've the same error:\n> [root]# openssl ca -config openssl.cnf -infiles ../inboud.csr \n> Using configuration from openssl.cnf\n> Check that the request matches the signature\n> Signature ok\n> The Subject's Distinguished Name is as follows\n> countryName           :PRINTABLE:'US'\n> stateOrProvinceName   :ASN.1 12:'California'\n> localityName          :ASN.1 12:'MountainView'\n> organizationName      :ASN.1 12:'AnsoLabs'\n> organizationalUnitName:ASN.1 12:'NovaDev'\n> commonName            :ASN.1 12:'admin-admin-2011-02-24T13:05:13Z'\n> The stateOrProvinceName field needed to be the same in the\n> CA certificate (California) and the request (California)\n> \n> The problem comes from the openssl.cnf template file provided by OpenStack which contains:\n>    countryName = match\n>    stateOrProvinceName = match\n> \n> This policy is too restrictive and generates the previous error.\n> \n> By replacing this policy by:\n>    countryName = supplied\n>    stateOrProvinceName = optional\n> in the openssl.cnf file, then the \"nova-manage project zipfile ...\" command line is OK.\n> So I suggest to specifiy these values in the openssl.cnf.tmpl file.\n> \n> ** Affects: nova\n>     Importance: Undecided\n>         Status: New\n> \n> -- \n> You received this bug notification because you are a member of Nova Bug\n> Team, which is subscribed to OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/724317\n> \n> Title:\n>  openssl error due to openssl.cnf.tmpl file provided by OpenStack\n> \n> Status in OpenStack Compute (Nova):\n>  New\n> \n> Bug description:\n>  The command line \"nova-manage project zipfile ...\" generates an exception and returns the following message:\n>  Unexpected error while running command.\n>  Command: openssl ca -batch -out /tmp/tmpIYutU2/outbound.csr -config ./openssl.cnf -infiles /tmp/tmpIYutU2/inbound.csr\n>  Exit code: 1\n>  Stdout: ''\n>  Stderr: \"Using configuration from ./openssl.cnf\\nCheck that the request matches the signature\\nSignature ok\\nThe Subject's Distinguished Name is as follows\\ncountryName           :PRINTABLE:'US'\\nstateOrProvinceName   :ASN.1 12:'California'\\nlocalityName          :ASN.1 12:'MountainView'\\norganizationName      :ASN.1 12:'AnsoLabs'\\norganizationalUnitName:ASN.1 12:'NovaDev'\\ncommonName            :ASN.1 12:'admin-admin-2011-02-24T13:46:26Z'\\nThe stateOrProvinceName field needed to be the same in the\\nCA certificate (California) and the request (California)\\n\"\n>  The above error may show that the certificate db has not been created.\n>  Please create a database by running a nova-api server on this host.\n> \n>  By running the openssl command from the CA directory of OpenStack, I've the same error:\n>  [root]# openssl ca -config openssl.cnf -infiles ../inboud.csr \n>  Using configuration from openssl.cnf\n>  Check that the request matches the signature\n>  Signature ok\n>  The Subject's Distinguished Name is as follows\n>  countryName           :PRINTABLE:'US'\n>  stateOrProvinceName   :ASN.1 12:'California'\n>  localityName          :ASN.1 12:'MountainView'\n>  organizationName      :ASN.1 12:'AnsoLabs'\n>  organizationalUnitName:ASN.1 12:'NovaDev'\n>  commonName            :ASN.1 12:'admin-admin-2011-02-24T13:05:13Z'\n>  The stateOrProvinceName field needed to be the same in the\n>  CA certificate (California) and the request (California)\n> \n>  The problem comes from the openssl.cnf template file provided by OpenStack which contains:\n>      countryName = match\n>      stateOrProvinceName = match\n> \n>  This policy is too restrictive and generates the previous error.\n> \n>  By replacing this policy by:\n>      countryName = supplied\n>      stateOrProvinceName = optional\n>  in the openssl.cnf file, then the \"nova-manage project zipfile ...\" command line is OK.\n>  So I suggest to specifiy these values in the openssl.cnf.tmpl file.\n\n", 
            "date_created": "2011-02-24 18:52:47+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Seems to be an interoperability issue:\r\nhttp://rt.openssl.org/Ticket/Display.html?id=2378&user=guest&pass=guest\r\n\r\nJust to make sure, Philippe could you confirm what version of OpenSSL you're using and post the output of:\r\nopenssl x509 -noout -subject -nameopt show_type,sep_multiline -in FILE | grep ST\r\nfor FILE=/var/lib/nova/CA/cacert.pem and FILE=your.csr ?", 
            "date_created": "2011-03-03 14:39:05.415686+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "@Philippe: any chance you could provide the requested information ? We can't really make progress on this without your input.", 
            "date_created": "2011-03-16 11:02:32.779323+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Just my $0.0.2: I have that problem with openssl-1.0.0-4.el6.x86_64 in RHEL6.\n\nHere is my workaround for Nova: https://github.com/abrindeyev/openstack-nova-rhel6/blob/master/SOURCES/openstack-nova-openssl-relaxed-policy.patch\n\n", 
            "date_created": "2011-03-21 10:21:37.376165+00:00", 
            "author": "https://api.launchpad.net/1.0/~abrindeyev"
        }, 
        {
            "content": "That link might help:\nhttp://old.nabble.com/utf8string-vs-printablestring-mismatch-in-certificate-checking-td27232471.html", 
            "date_created": "2011-04-07 07:59:57.771078+00:00", 
            "author": "https://api.launchpad.net/1.0/~abrindeyev"
        }, 
        {
            "content": "I was able to reproduce this on my Fedora 14 workstation using 'run_tests.sh -N test_auth'.\n\n[dan.prince@dovetail CA]$ openssl ca -batch -out /tmp/tmpYM2x64/outbound.csr -config ./openssl.cnf -infiles /tmp/tmpYM2x64/inbound.csr\nUsing configuration from ./openssl.cnf\nCheck that the request matches the signature\nSignature ok\nThe Subject's Distinguished Name is as follows\ncountryName           :PRINTABLE:'US'\nstateOrProvinceName   :ASN.1 12:'California'\nlocalityName          :ASN.1 12:'MountainView'\norganizationName      :ASN.1 12:'AnsoLabs'\norganizationalUnitName:ASN.1 12:'NovaDev'\ncommonName            :ASN.1 12:'testproj-test1-2011-04-08T16:28:00Z'\nThe stateOrProvinceName field needed to be the same in the\nCA certificate (California) and the request (California)\n---\n\nHere is the output for the certificate and the request:\n\n[dan.prince@dovetail CA]$ openssl x509 -noout -subject -nameopt show_type,sep_multiline -in cacert.pem\nsubject= \n    O=PRINTABLESTRING:NOVA ROOT\n    L=PRINTABLESTRING:Mountain View\n    ST=PRINTABLESTRING:California\n    C=PRINTABLESTRING:US\n\n[dan.prince@dovetail CA]$ openssl req -noout -subject -nameopt show_type,sep_multiline -in /tmp/tmpYM2x64/inbound.csr\nsubject=\n    C=PRINTABLESTRING:US\n    ST=UTF8STRING:California\n    L=UTF8STRING:MountainView\n    O=UTF8STRING:AnsoLabs\n    OU=UTF8STRING:NovaDev\n    CN=UTF8STRING:testproj-test1-2011-04-08T16:28:00Z\n\n\nThe auth tests which generate x509 certificates both failed.\n\nSetting the stateOrProvinceName = 'supplied' resolved the issue and allows both tests to pass. I'm not sure we have a better way of working around this issue in nova for now. The proposed fix seems safe enough for now. I'll push a branch with the fix with a note about this issue in the openssl template file as well.\n\n", 
            "date_created": "2011-04-08 16:31:34.983243+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }
    ]
}