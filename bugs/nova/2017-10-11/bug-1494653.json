{
    "status": "Fix Released", 
    "last_updated": "2016-01-21 23:18:40.819229+00:00", 
    "description": "In patch [1] 'context' parameter was removed from quota-related remotable method signatures.\nIn patch [2] use of 'context' parameter was removed from quota-related remotable method calls.\n\nStill there are some occurrances where 'context' parameter is passed to quotas.reserve method which is leading to error \"ValueError: Circular reference detected\".\n\nFor eg: while restarting nova-compute if there are any instance\nwhose vm_state is 'DELETED' but that instance is not marked as deleted in db. In that case, while calling _init_instance method it raises below error.\n\n2015-09-08 00:36:34.133 ERROR nova.compute.manager [req-3222b8a4-0542-48cf-a2e1-c92e5fd91e5e None None] [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] Failed to complete a deletion\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] Traceback (most recent call last):\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/opt/stack/nova/nova/compute/manager.py\", line 952, in _init_instance\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] self._complete_partial_deletion(context, instance)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/opt/stack/nova/nova/compute/manager.py\", line 879, in _complete_partial_d\neletion\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] bdms = objects.BlockDeviceMappingList.get_by_instance_uuid(\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", lin\ne 197, in wrapper\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] ctxt, self, fn.__name__, args, kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 246, in object_action\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] objmethod=objmethod, args=args, kwargs=kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 158, in call\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] retry=self.retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] timeout=timeout, retry=retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 431, in send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] retry=retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 399, in _send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] msg = rpc_common.serialize_msg(msg)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/common.py\", line 286, in serialize_msg\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] _MESSAGE_KEY: jsonutils.dumps(raw_msg)}\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_serialization/jsonutils.py\", line 185, in dumps\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] return json.dumps(obj, default=default, **kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/lib/python2.7/json/__init__.py\", line 250, in dumps\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] sort_keys=sort_keys, **kw).encode(obj)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/lib/python2.7/json/encoder.py\", line 207, in encode\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] chunks = self.iterencode(o, _one_shot=True)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/lib/python2.7/json/encoder.py\", line 270, in iterencode\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] return _iterencode(o, 0)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] ValueError: Circular reference detected\n\n[1] https://review.openstack.org/#/c/164268/\n[2] https://review.openstack.org/#/c/160499/", 
    "tags": [
        "in-stable-kilo"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1494653", 
    "owner": "https://api.launchpad.net/1.0/~rajesh-tailor", 
    "id": 1494653, 
    "index": 576, 
    "created": "2015-09-11 08:50:27.667247+00:00", 
    "title": "Remove unnecessary 'context' parameter from quotas reserve method call", 
    "comments": [
        {
            "content": "In patch [1] 'context' parameter was removed from quota-related remotable method signatures.\nIn patch [2] use of 'context' parameter was removed from quota-related remotable method calls.\n\nStill there are some occurrances where 'context' parameter is passed to quotas.reserve method which is leading to erorr \"ValueError: Circular reference detected\".\n\n2015-09-08 00:36:34.133 ERROR nova.compute.manager [req-3222b8a4-0542-48cf-a2e1-c92e5fd91e5e None None] [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] Failed to complete a deletion\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] Traceback (most recent call last):\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/opt/stack/nova/nova/compute/manager.py\", line 952, in _init_instance\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] self._complete_partial_deletion(context, instance)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/opt/stack/nova/nova/compute/manager.py\", line 879, in _complete_partial_d\neletion\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] bdms = objects.BlockDeviceMappingList.get_by_instance_uuid(\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", lin\ne 197, in wrapper\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] ctxt, self, fn.__name__, args, kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 246, in object_action\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] objmethod=objmethod, args=args, kwargs=kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 158, in call\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] retry=self.retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] timeout=timeout, retry=retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 431, in send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] retry=retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 399, in _send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] msg = rpc_common.serialize_msg(msg)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/common.py\", line 286, in serialize_msg\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] _MESSAGE_KEY: jsonutils.dumps(raw_msg)}\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/local/lib/python2.7/dist-packages/oslo_serialization/jsonutils.py\", line 185, in dumps\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] return json.dumps(obj, default=default, **kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/lib/python2.7/json/__init__.py\", line 250, in dumps\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] sort_keys=sort_keys, **kw).encode(obj)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/lib/python2.7/json/encoder.py\", line 207, in encode\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] chunks = self.iterencode(o, _one_shot=True)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] File \"/usr/lib/python2.7/json/encoder.py\", line 270, in iterencode\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] return _iterencode(o, 0)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] ValueError: Circular reference detected\n\n\n[1] https://review.openstack.org/#/c/164268/\n[2] https://review.openstack.org/#/c/160499/", 
            "date_created": "2015-09-11 08:50:27.667247+00:00", 
            "author": "https://api.launchpad.net/1.0/~rajesh-tailor"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/222972", 
            "date_created": "2015-09-14 06:20:53.250539+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/222972\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=4031272fe93d1046cff4c0cc788c8e78db944419\nSubmitter: Jenkins\nBranch:    master\n\ncommit 4031272fe93d1046cff4c0cc788c8e78db944419\nAuthor: Rajesh Tailor <email address hidden>\nDate:   Thu Sep 10 23:15:46 2015 -0700\n\n    Remove unnecessary 'context' param from quotas reserve method call\n    \n    context' parameter was removed from quota-related method signatures in patch [1].\n    In patch [2] use of 'context' parameter was removed from quota-related method calls.\n    \n    Still at some places 'context' parameter was passed to quota reserve method call.\n    \n    Removed use of 'context' parameter from those places and passed 'context' as kwargs\n    while creating object of nova.objects.Quotas type.\n    \n    [1] https://review.openstack.org/#/c/164268/\n    [2] https://review.openstack.org/#/c/160499/\n    \n    Change-Id: I20ea77bd20f093ce1be7169c0647cdc7ff62117c\n    Closes-Bug: 1494653\n", 
            "date_created": "2015-09-14 21:04:05.349985+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/223968", 
            "date_created": "2015-09-16 08:41:43.788427+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/223968\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=2e731ebc9dd4890b6bfa57ceaaa6dadba2e4b1c2\nSubmitter: Jenkins\nBranch:    stable/kilo\n\ncommit 2e731ebc9dd4890b6bfa57ceaaa6dadba2e4b1c2\nAuthor: Rajesh Tailor <email address hidden>\nDate:   Thu Sep 10 23:15:46 2015 -0700\n\n    Remove unnecessary 'context' param from quotas reserve method call\n    \n    'context' parameter was removed from quota-related method signatures in patch [1].\n    In patch [2] use of 'context' parameter was removed from quota-related method calls.\n    \n    Still at some places 'context' parameter was passed to quota reserve method call.\n    \n    Removed use of 'context' parameter from those places and passed 'context' as kwargs\n    while creating object of nova.objects.Quotas type.\n    \n    [1] https://review.openstack.org/#/c/164268/\n    [2] https://review.openstack.org/#/c/160499/\n    \n    Backport notice:\n    On restart of nova-compute if there is instance with vm_state as\n    'DELETED' but that instance is not marked as deleted in database. In that case,\n    while calling _complete_partial_deletion method from _init_instance method\n    it raises \" ValueError: Circular reference detected\" error.\n    \n    Removing 'context' parameter from quotas.reserve method call in\n    _complete_partial_deletion method addresses this issue as well.\n    \n    Change-Id: I20ea77bd20f093ce1be7169c0647cdc7ff62117c\n    Closes-Bug: 1494653\n    (cherry picked from commit 4031272fe93d1046cff4c0cc788c8e78db944419)\n", 
            "date_created": "2015-09-29 16:54:43.072020+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}