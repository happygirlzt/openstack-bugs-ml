{
    "status": "Invalid", 
    "last_updated": "2013-10-09 07:15:30.372177+00:00", 
    "description": "Setting of cputune.quota has changed in libvirt from version 0.10.0. So the\ncputune.quota parameter of cpu qos which is writed into the libvirt xml should\nbe set differently under different version of libvirt.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1230050", 
    "owner": "https://api.launchpad.net/1.0/~hzguanqiang", 
    "id": 1230050, 
    "index": 4117, 
    "created": "2013-09-25 03:40:17.232740+00:00", 
    "title": "setting of cputune.quota need to recoginse libvirt version", 
    "comments": [
        {
            "content": "Setting of cputune.quota has changed in libvirt from version 0.10.0. So the\ncputune.quota parameter of cpu qos which is writed into the libvirt xml should\nbe set differently under different version of libvirt.", 
            "date_created": "2013-09-25 03:40:17.232740+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzguanqiang"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/48177", 
            "date_created": "2013-09-25 03:53:53.725576+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The guest.cpu_quota value will be written into libvirt xml which is finally writen into cpu cgroup by libvirt. Before libvirt of version 0.10.0, libvirt will multiply this value by vcpu number and then write into cgroup. But from version 0.10.0, the value is directly written into cgroup by libvirt.", 
            "date_created": "2013-09-25 06:14:27.702713+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzguanqiang"
        }, 
        {
            "content": "I don't believe this is correct.\n\nIn libvirt < 0.10.0 we created a single cgroup\n\n$ROOT/libvirt/qemu/$GUESTNAME\n\nand set the 'quota * nvcpus' value at that level\n\nIn libvirt >= 0.10.0 we create one cgroup per vCPU\n\n$ROOT/libvirt/qemu/$GUESTNAME/{vcpu0,vcpu1,....}\n\nand set the 'quota' value at the vcpuN level.\n\nThe end result is the same in both cases - you get 'quota * nvcpus' worth of time allowed.", 
            "date_created": "2013-10-08 09:58:53.508855+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }, 
        {
            "content": "Well, Daniel. If the thing is as you said, I'm wrong.\r\nBut The fact is with the same cputune xml configure under different version\r\nof libvirt, It will lead to different results in cgroup.\r\n\r\nDetails are as following:\r\nhzguanqiang@debian1:~$ sudo virsh version\r\nCompiled against library: libvir 0.9.12\r\nUsing library: libvir 0.9.12\r\nUsing API: QEMU 0.9.12\r\nRunning hypervisor: QEMU 1.1.2\r\nhzguanqiang@debian1:/data/nova/instances/instance-00000053$ cat libvirt.xml \r\n<domain type=\"kvm\">\r\n  <uuid>2bc80c41-ed34-4a7e-8645-e9af789b29cb</uuid>\r\n  <name>instance-00000053</name>\r\n  <memory>8388608</memory>\r\n  <vcpu cpuset=\"4-63\">8</vcpu>\r\n  <os>\r\n    <type>hvm</type>\r\n    <boot dev=\"hd\"/>\r\n  </os>\r\n  <features>\r\n    <acpi/>\r\n  </features>\r\n  <cputune>\r\n    <shares>32768</shares>\r\n    <quota>100000</quota>\r\n    <period>100000</period>\r\n  </cputune>\r\n  <clock offset=\"utc\">\r\n    <timer name=\"pit\" tickpolicy=\"delay\"/>\r\n    <timer name=\"rtc\" tickpolicy=\"catchup\"/>\r\n  </clock>\r\n  <cpu mode=\"host-model\" match=\"exact\"/>\r\n  <devices>\r\n    <disk type=\"file\" device=\"disk\">\r\n      <driver name=\"qemu\" type=\"qcow2\" cache=\"none\"/>\r\n      <source file=\"/data/nova/instances/instance-00000053/disk\"/>\r\n      <target bus=\"virtio\" dev=\"vda\"/>\r\n    </disk>\r\n    <disk type=\"file\" device=\"disk\">\r\n      <driver name=\"qemu\" type=\"qcow2\" cache=\"none\"/>\r\n      <source file=\"/data/nova/instances/instance-00000053/disk.local\"/>\r\n      <target bus=\"virtio\" dev=\"vdb\"/>\r\n    </disk>\r\n    <interface type=\"bridge\">\r\n      <mac address=\"fa:16:3e:79:04:5c\"/>\r\n      <model type=\"virtio\"/>\r\n      <source bridge=\"br100\"/>\r\n      <filterref filter=\"nova-instance-instance-00000053-fa163e79045c\">\r\n        <parameter name=\"IP\" value=\"10.160.161.21\"/>\r\n        <parameter name=\"DHCPSERVER\" value=\"10.160.160.11\"/>\r\n      </filterref>\r\n    </interface>\r\n    <serial type=\"file\">\r\n      <source path=\"/data/nova/instances/instance-00000053/console.log\"/>\r\n    </serial>\r\n    <serial type=\"pty\"/>\r\n    <input type=\"tablet\" bus=\"usb\"/>\r\n    <graphics type=\"vnc\" autoport=\"yes\" keymap=\"en-us\" listen=\"127.0.0.1\"/>\r\n  </devices>\r\n</domain>\r\nhzguanqiang@debian1:/data/nova/instances/instance-00000053$ cat /sys/fs/cgroup/cpu/libvirt/qemu/instance-00000053/cpu.cfs_quota_us \r\n800000\r\n\r\n\r\nhzguanqiang@debian2:~$ vir version\r\nCompiled against library: libvirt 1.1.2\r\nUsing library: libvirt 1.1.2\r\nUsing API: LXC 1.1.2\r\nRunning hypervisor: LXC 3.9.6\r\n\r\nhzguanqiang@debian2:~$ vir dumpxml instance-0000006c\r\n<domain type='lxc' id='10303'>\r\n  <name>instance-0000006c</name>\r\n  <uuid>ab43db36-ee30-4223-92e8-7652255cffb7</uuid>\r\n  <memory unit='KiB'>1048576</memory>\r\n  <currentMemory unit='KiB'>1048576</currentMemory>\r\n  <vcpu placement='static' cpuset='4-23'>3</vcpu>\r\n  <cputune>\r\n    <shares>6144</shares>\r\n    <period>100000</period>\r\n    <quota>57499</quota>\r\n  </cputune>\r\n  <resource>\r\n    <partition>/machine</partition>\r\n  </resource>\r\n  <os>\r\n    <type arch='x86_64'>exe</type>\r\n    <init>/sbin/init</init>\r\n    <cmdline>console=tty0 console=ttyS0</cmdline>\r\n  </os>\r\n  <clock offset='utc'/>\r\n  <on_poweroff>destroy</on_poweroff>\r\n  <on_reboot>restart</on_reboot>\r\n  <on_crash>destroy</on_crash>\r\n  <devices>\r\n    <emulator>/usr/libexec/libvirt_lxc</emulator>\r\n    <filesystem type='mount' accessmode='passthrough'>\r\n      <source dir='/opt/stack/data/nova/instances/ab43db36-ee30-4223-92e8-7652255cffb7/rootfs'/>\r\n      <target dir='/'/>\r\n    </filesystem>\r\n    <interface type='bridge'>\r\n      <mac address='fa:16:3e:16:41:47'/>\r\n      <source bridge='br100'/>\r\n      <target dev='veth0'/>\r\n      <filterref filter='nova-instance-instance-0000006c-fa163e164147'/>\r\n    </interface>\r\n    <console type='pty' tty='/dev/pts/0'>\r\n      <source path='/dev/pts/0'/>\r\n      <target type='lxc' port='0'/>\r\n      <alias name='console0'/>\r\n    </console>\r\n  </devices>\r\n  <seclabel type='none'/>\r\n</domain>\r\nhzguanqiang@debian2:~$ cat /sys/fs/cgroup/cpu/machine/instance-0000006c.libvirt-lxc/cpu.cfs_quota_us \r\n57499\r\n\r\nFrom the above, you can see with libvirt version of 0.9.12, the 'cpu.cfs_quota_us' parameter of \r\ninstance cgroup is the value of cputune.period multiplied by vcpu numbers.\r\nAnd with libvirt version of 1.1.2, they are equal.\r\n\r\nOn 2013-10-08 17:58 , Daniel Berrange wrote:\r\nI don't believe this is correct.\r\n\r\nIn libvirt < 0.10.0 we created a single cgroup\r\n\r\n$ROOT/libvirt/qemu/$GUESTNAME\r\n\r\nand set the 'quota * nvcpus' value at that level\r\n\r\nIn libvirt >= 0.10.0 we create one cgroup per vCPU\r\n\r\n$ROOT/libvirt/qemu/$GUESTNAME/{vcpu0,vcpu1,....}\r\n\r\nand set the 'quota' value at the vcpuN level.\r\n\r\nThe end result is the same in both cases - you get 'quota * nvcpus'\r\nworth of time allowed.\r\n\r\n-- \r\nYou received this bug notification because you are subscribed to the bug\r\nreport.\r\nhttps://bugs.launchpad.net/bugs/1230050\r\n\r\nTitle:\r\n  setting of cputune.quota need to recoginse libvirt version\r\n\r\nStatus in OpenStack Compute (Nova):\r\n  In Progress\r\n\r\nBug description:\r\n  Setting of cputune.quota has changed in libvirt from version 0.10.0. So the\r\n  cputune.quota parameter of cpu qos which is writed into the libvirt xml should\r\n  be set differently under different version of libvirt.\r\n\r\nTo manage notifications about this bug go to:\r\nhttps://bugs.launchpad.net/nova/+bug/1230050/+subscriptions\r\n\r\n\r\n------------------     \r\nBest regards!\r\nGuanQiang\r\n19:04:26", 
            "date_created": "2013-10-08 11:14:38+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzguanqiang"
        }, 
        {
            "content": "Sorry guys, Daniel is right. I mixed cputune setting of kvm up with that of lxc.\r\n\r\nOn 2013-10-08 19:14 , <email address hidden> wrote:\r\nWell, Daniel. If the thing is as you said, I'm wrong.\r\nBut The fact is with the same cputune xml configure under different version\r\nof libvirt, It will lead to different results in cgroup.\r\n\r\nDetails are as following:\r\nhzguanqiang@debian1:~$ sudo virsh version\r\nCompiled against library: libvir 0.9.12\r\nUsing library: libvir 0.9.12\r\nUsing API: QEMU 0.9.12\r\nRunning hypervisor: QEMU 1.1.2\r\nhzguanqiang@debian1:/data/nova/instances/instance-00000053$ cat libvirt.xml \r\n<domain type=\"kvm\">\r\n  <uuid>2bc80c41-ed34-4a7e-8645-e9af789b29cb</uuid>\r\n  <name>instance-00000053</name>\r\n  <memory>8388608</memory>\r\n  <vcpu cpuset=\"4-63\">8</vcpu>\r\n  <os>\r\n    <type>hvm</type>\r\n    <boot dev=\"hd\"/>\r\n  </os>\r\n  <features>\r\n    <acpi/>\r\n  </features>\r\n  <cputune>\r\n    <shares>32768</shares>\r\n    <quota>100000</quota>\r\n    <period>100000</period>\r\n  </cputune>\r\n  <clock offset=\"utc\">\r\n    <timer name=\"pit\" tickpolicy=\"delay\"/>\r\n    <timer name=\"rtc\" tickpolicy=\"catchup\"/>\r\n  </clock>\r\n  <cpu mode=\"host-model\" match=\"exact\"/>\r\n  <devices>\r\n    <disk type=\"file\" device=\"disk\">\r\n      <driver name=\"qemu\" type=\"qcow2\" cache=\"none\"/>\r\n      <source file=\"/data/nova/instances/instance-00000053/disk\"/>\r\n      <target bus=\"virtio\" dev=\"vda\"/>\r\n    </disk>\r\n    <disk type=\"file\" device=\"disk\">\r\n      <driver name=\"qemu\" type=\"qcow2\" cache=\"none\"/>\r\n      <source file=\"/data/nova/instances/instance-00000053/disk.local\"/>\r\n      <target bus=\"virtio\" dev=\"vdb\"/>\r\n    </disk>\r\n    <interface type=\"bridge\">\r\n      <mac address=\"fa:16:3e:79:04:5c\"/>\r\n      <model type=\"virtio\"/>\r\n      <source bridge=\"br100\"/>\r\n      <filterref filter=\"nova-instance-instance-00000053-fa163e79045c\">\r\n        <parameter name=\"IP\" value=\"10.160.161.21\"/>\r\n        <parameter name=\"DHCPSERVER\" value=\"10.160.160.11\"/>\r\n      </filterref>\r\n    </interface>\r\n    <serial type=\"file\">\r\n      <source path=\"/data/nova/instances/instance-00000053/console.log\"/>\r\n    </serial>\r\n    <serial type=\"pty\"/>\r\n    <input type=\"tablet\" bus=\"usb\"/>\r\n    <graphics type=\"vnc\" autoport=\"yes\" keymap=\"en-us\" listen=\"127.0.0.1\"/>\r\n  </devices>\r\n</domain>\r\nhzguanqiang@debian1:/data/nova/instances/instance-00000053$ cat /sys/fs/cgroup/cpu/libvirt/qemu/instance-00000053/cpu.cfs_quota_us \r\n800000\r\n\r\n\r\nhzguanqiang@debian2:~$ vir version\r\nCompiled against library: libvirt 1.1.2\r\nUsing library: libvirt 1.1.2\r\nUsing API: LXC 1.1.2\r\nRunning hypervisor: LXC 3.9.6\r\n\r\nhzguanqiang@debian2:~$ vir dumpxml instance-0000006c\r\n<domain type='lxc' id='10303'>\r\n  <name>instance-0000006c</name>\r\n  <uuid>ab43db36-ee30-4223-92e8-7652255cffb7</uuid>\r\n  <memory unit='KiB'>1048576</memory>\r\n  <currentMemory unit='KiB'>1048576</currentMemory>\r\n  <vcpu placement='static' cpuset='4-23'>3</vcpu>\r\n  <cputune>\r\n    <shares>6144</shares>\r\n    <period>100000</period>\r\n    <quota>57499</quota>\r\n  </cputune>\r\n  <resource>\r\n    <partition>/machine</partition>\r\n  </resource>\r\n  <os>\r\n    <type arch='x86_64'>exe</type>\r\n    <init>/sbin/init</init>\r\n    <cmdline>console=tty0 console=ttyS0</cmdline>\r\n  </os>\r\n  <clock offset='utc'/>\r\n  <on_poweroff>destroy</on_poweroff>\r\n  <on_reboot>restart</on_reboot>\r\n  <on_crash>destroy</on_crash>\r\n  <devices>\r\n    <emulator>/usr/libexec/libvirt_lxc</emulator>\r\n    <filesystem type='mount' accessmode='passthrough'>\r\n      <source dir='/opt/stack/data/nova/instances/ab43db36-ee30-4223-92e8-7652255cffb7/rootfs'/>\r\n      <target dir='/'/>\r\n    </filesystem>\r\n    <interface type='bridge'>\r\n      <mac address='fa:16:3e:16:41:47'/>\r\n      <source bridge='br100'/>\r\n      <target dev='veth0'/>\r\n      <filterref filter='nova-instance-instance-0000006c-fa163e164147'/>\r\n    </interface>\r\n    <console type='pty' tty='/dev/pts/0'>\r\n      <source path='/dev/pts/0'/>\r\n      <target type='lxc' port='0'/>\r\n      <alias name='console0'/>\r\n    </console>\r\n  </devices>\r\n  <seclabel type='none'/>\r\n</domain>\r\nhzguanqiang@debian2:~$ cat /sys/fs/cgroup/cpu/machine/instance-0000006c.libvirt-lxc/cpu.cfs_quota_us \r\n57499\r\n\r\nFrom the above, you can see with libvirt version of 0.9.12, the 'cpu.cfs_quota_us' parameter of \r\ninstance cgroup is the value of cputune.period multiplied by vcpu numbers.\r\nAnd with libvirt version of 1.1.2, they are equal.\r\n\r\nOn 2013-10-08 17:58 , Daniel Berrange wrote:\r\nI don't believe this is correct.\r\n\r\nIn libvirt < 0.10.0 we created a single cgroup\r\n\r\n$ROOT/libvirt/qemu/$GUESTNAME\r\n\r\nand set the 'quota * nvcpus' value at that level\r\n\r\nIn libvirt >= 0.10.0 we create one cgroup per vCPU\r\n\r\n$ROOT/libvirt/qemu/$GUESTNAME/{vcpu0,vcpu1,....}\r\n\r\nand set the 'quota' value at the vcpuN level.\r\n\r\nThe end result is the same in both cases - you get 'quota * nvcpus'\r\nworth of time allowed.\r\n\r\n-- \r\nYou received this bug notification because you are subscribed to the bug\r\nreport.\r\nhttps://bugs.launchpad.net/bugs/1230050\r\n\r\nTitle:\r\n  setting of cputune.quota need to recoginse libvirt version\r\n\r\nStatus in OpenStack Compute (Nova):\r\n  In Progress\r\n\r\nBug description:\r\n  Setting of cputune.quota has changed in libvirt from version 0.10.0. So the\r\n  cputune.quota parameter of cpu qos which is writed into the libvirt xml should\r\n  be set differently under different version of libvirt.\r\n\r\nTo manage notifications about this bug go to:\r\nhttps://bugs.launchpad.net/nova/+bug/1230050/+subscriptions\r\n\r\n\r\n------------------     \r\nBest regards!\r\nGuanQiang\r\n19:04:26\r\n\r\n\r\n------------------     \r\nBest regards!\r\nGuanQiang\r\n15:12:33", 
            "date_created": "2013-10-09 07:13:28+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzguanqiang"
        }
    ]
}