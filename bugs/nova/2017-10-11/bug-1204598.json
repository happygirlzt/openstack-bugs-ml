{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:56:44.969643+00:00", 
    "description": "The aggregate list api call will return a 404 not found if an aggregate is removed while \n\nThe tempest testr run hit this by running the JSON and XML tests in different processes so that an aggregate created for a JSON test was deleted from underneath the list command in an XML test while it was looping over the list of aggregates. Which led to this stack trace:\n\nTRACE nova.api.openstack Traceback (most recent call last):\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/__init__.py\", line 110, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return req.get_response(self.application)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     application, catch_exc_info=False)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/python-keystoneclient/keystoneclient/middleware/auth_token.py\", line 461, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return self.app(env, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 903, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     content_type, body, accept)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 962, in _process_stack\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 1043, in dispatch\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return method(req=request, **action_args)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/compute/contrib/aggregates.py\", line 53, in index\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     aggregates = self.api.get_aggregate_list(context)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/compute/api.py\", line 2924, in get_aggregate_list\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return [self._get_aggregate_info(context, a) for a in aggregates]\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/compute/api.py\", line 3022, in _get_aggregate_info\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     metadata = self.db.aggregate_metadata_get(context, aggregate['id'])\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/db/api.py\", line 1663, in aggregate_metadata_get\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return IMPL.aggregate_metadata_get(context, aggregate_id)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 103, in wrapper\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return f(*args, **kwargs)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 148, in wrapper\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     aggregate_get(context, aggregate_id)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 103, in wrapper\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return f(*args, **kwargs)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 4651, in aggregate_get\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     raise exception.AggregateNotFound(aggregate_id=aggregate_id)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack AggregateNotFound: Aggregate 21 could not be found.\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack \n\nLogs from this run can be found here:\nhttp://logs.openstack.org/79/38379/2/check/gate-tempest-devstack-vm-testr-full/1408/", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1204598", 
    "owner": "https://api.launchpad.net/1.0/~treinish", 
    "id": 1204598, 
    "index": 1165, 
    "created": "2013-07-24 17:36:17.023959+00:00", 
    "title": "Race condition in aggregates list when an aggregate is deleted", 
    "comments": [
        {
            "content": "The aggregate list api call will return a 404 not found if an aggregate is removed while \n\nThe tempest testr run hit this by running the JSON and XML tests in different processes so that an aggregate created for a JSON test was deleted from underneath the list command in an XML test while it was looping over the list of aggregates. Which led to this stack trace:\n\nTRACE nova.api.openstack Traceback (most recent call last):\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/__init__.py\", line 110, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return req.get_response(self.application)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     application, catch_exc_info=False)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/python-keystoneclient/keystoneclient/middleware/auth_token.py\", line 461, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return self.app(env, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 903, in __call__\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     content_type, body, accept)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 962, in _process_stack\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 1043, in dispatch\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return method(req=request, **action_args)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/compute/contrib/aggregates.py\", line 53, in index\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     aggregates = self.api.get_aggregate_list(context)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/compute/api.py\", line 2924, in get_aggregate_list\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return [self._get_aggregate_info(context, a) for a in aggregates]\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/compute/api.py\", line 3022, in _get_aggregate_info\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     metadata = self.db.aggregate_metadata_get(context, aggregate['id'])\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/db/api.py\", line 1663, in aggregate_metadata_get\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return IMPL.aggregate_metadata_get(context, aggregate_id)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 103, in wrapper\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return f(*args, **kwargs)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 148, in wrapper\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     aggregate_get(context, aggregate_id)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 103, in wrapper\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     return f(*args, **kwargs)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 4651, in aggregate_get\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack     raise exception.AggregateNotFound(aggregate_id=aggregate_id)\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack AggregateNotFound: Aggregate 21 could not be found.\n2013-07-24 14:18:01.389 20700 TRACE nova.api.openstack \n\nLogs from this run can be found here:\nhttp://logs.openstack.org/79/38379/2/check/gate-tempest-devstack-vm-testr-full/1408/", 
            "date_created": "2013-07-24 17:36:17.023959+00:00", 
            "author": "https://api.launchpad.net/1.0/~treinish"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/38526", 
            "date_created": "2013-07-24 19:55:50.625502+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/38526\nCommitted: http://github.com/openstack/nova/commit/149254194ee941352a1d1c46b8c4a64d241fdc55\nSubmitter: Jenkins\nBranch:    master\n\ncommit 149254194ee941352a1d1c46b8c4a64d241fdc55\nAuthor: Matthew Treinish <email address hidden>\nDate:   Fri Jul 26 23:11:09 2013 -0400\n\n    Fix race between aggregate list and delete\n    \n    Previously, during get_aggregate_list() if an aggregate was deleted\n    after the list of aggregates is initially read from the database\n    with db.get_aggregate_all() then the list method would raise an\n    AggregateNotFound when it called _get_aggregates_info(), which makes\n    additional db queries for each aggregate. This would result in the api\n    request receiving a 404 response. However db.get_aggregate_all()\n    already contained all the required information for the aggregate\n    list.\n    \n    This commit changes renames _get_aggregate_info() to\n    _reformat_aggregate_info() which just correctly parse the response of\n    db.get_aggregate_get() and formats its response in the same way as\n    _get_aggregates_info() would return with the extra database queries.\n    This fixes the race condition not only in list but potentially in\n    other calls by only making one database read for any get operation.\n    \n    Also, the unit tests added in this commit are to fill a coverage gap\n    with get_aggregate_list() and to ensure that we don't change the\n    behavior of list while fixing the race condition. The race condition\n    is not directly testable in unit tests because it requires a\n    multithreaded environment to send a delete immediately after a list\n    call. It was uncovered by running tempest in parallel with testr.\n    \n    Fixes bug 1204598\n    \n    Change-Id: I5f872c7ac89334fc3914906831ed8f2a58881543\n", 
            "date_created": "2013-07-30 20:49:23.617324+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}