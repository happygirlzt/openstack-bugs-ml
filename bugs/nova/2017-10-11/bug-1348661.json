{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:46:30.366125+00:00", 
    "description": "This was being masked by bug 1311778 due to the MessagingTimeout failure, but there are more specific errors.\n\nhttp://logs.openstack.org/79/108879/1/gate/gate-nova-python26/283e967/console.html#_2014-07-24_08_14_12_631\n\n2014-07-24 08:14:12.631 | FAIL: nova.tests.api.ec2.test_cloud.CloudTestCase.test_terminate_instances_two_instances\n2014-07-24 08:14:12.631 | tags: worker-4\n2014-07-24 08:14:12.631 | ----------------------------------------------------------------------\n2014-07-24 08:14:12.631 | Empty attachments:\n2014-07-24 08:14:12.631 |   pythonlogging:'boto'\n2014-07-24 08:14:12.631 |   stderr\n2014-07-24 08:14:12.631 |   stdout\n2014-07-24 08:14:12.631 | \n2014-07-24 08:14:12.631 | pythonlogging:'': {{{\n2014-07-24 08:14:12.631 | INFO [nova.network.driver] Loading network driver 'nova.network.linux_net'\n2014-07-24 08:14:12.632 | AUDIT [nova.service] Starting conductor node (version 2014.2)\n2014-07-24 08:14:12.632 | INFO [nova.virt.driver] Loading compute driver 'nova.virt.fake.FakeDriver'\n2014-07-24 08:14:12.632 | AUDIT [nova.service] Starting compute node (version 2014.2)\n2014-07-24 08:14:12.632 | AUDIT [nova.compute.resource_tracker] Auditing locally available compute resources\n2014-07-24 08:14:12.632 | AUDIT [nova.compute.resource_tracker] Free ram (MB): 7680\n2014-07-24 08:14:12.632 | AUDIT [nova.compute.resource_tracker] Free disk (GB): 1028\n2014-07-24 08:14:12.632 | AUDIT [nova.compute.resource_tracker] Free VCPUS: 1\n2014-07-24 08:14:12.632 | AUDIT [nova.compute.resource_tracker] PCI stats: []\n2014-07-24 08:14:12.632 | INFO [nova.compute.resource_tracker] Compute_service record created for 093d0c3802bf440db8f3f839963027c4:fake-mini\n2014-07-24 08:14:12.632 | AUDIT [nova.service] Starting scheduler node (version 2014.2)\n2014-07-24 08:14:12.632 | INFO [nova.network.driver] Loading network driver 'nova.network.linux_net'\n2014-07-24 08:14:12.633 | AUDIT [nova.service] Starting network node (version 2014.2)\n2014-07-24 08:14:12.633 | AUDIT [nova.service] Starting consoleauth node (version 2014.2)\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.manager] Starting instance...\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Attempting claim: memory 2048 MB, disk 20 GB\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Total memory: 8192 MB, used: 512.00 MB\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] memory limit not specified, defaulting to unlimited\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Total disk: 1028 GB, used: 0.00 GB\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] disk limit not specified, defaulting to unlimited\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Claim successful\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.manager] Starting instance...\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Attempting claim: memory 2048 MB, disk 20 GB\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Total memory: 8192 MB, used: 2560.00 MB\n2014-07-24 08:14:12.634 | AUDIT [nova.compute.claims] memory limit not specified, defaulting to unlimited\n2014-07-24 08:14:12.634 | AUDIT [nova.compute.claims] Total disk: 1028 GB, used: 20.00 GB\n2014-07-24 08:14:12.634 | AUDIT [nova.compute.claims] disk limit not specified, defaulting to unlimited\n2014-07-24 08:14:12.634 | AUDIT [nova.compute.claims] Claim successful\n2014-07-24 08:14:12.634 | WARNING [nova.compute.manager] Instance is not stopped. Calling the stop API.\n2014-07-24 08:14:12.634 | ERROR [nova.compute.manager] error during stop() in sync_power_state.\n2014-07-24 08:14:12.634 | Traceback (most recent call last):\n2014-07-24 08:14:12.634 |   File \"nova/compute/manager.py\", line 5551, in _sync_instance_power_state\n2014-07-24 08:14:12.634 |     self.compute_api.force_stop(context, db_instance)\n2014-07-24 08:14:12.634 |   File \"nova/compute/api.py\", line 1767, in force_stop\n2014-07-24 08:14:12.634 |     self.compute_rpcapi.stop_instance(context, instance, do_cast=do_cast)\n2014-07-24 08:14:12.635 |   File \"nova/compute/rpcapi.py\", line 908, in stop_instance\n2014-07-24 08:14:12.635 |     return rpc_method(ctxt, 'stop_instance', instance=instance)\n2014-07-24 08:14:12.635 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/client.py\", line 150, in call\n2014-07-24 08:14:12.635 |     wait_for_reply=True, timeout=timeout)\n2014-07-24 08:14:12.635 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-07-24 08:14:12.635 |     timeout=timeout)\n2014-07-24 08:14:12.635 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/_drivers/impl_fake.py\", line 166, in send\n2014-07-24 08:14:12.635 |     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2014-07-24 08:14:12.635 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/_drivers/impl_fake.py\", line 161, in _send\n2014-07-24 08:14:12.635 |     'No reply on topic %s' % target.topic)\n2014-07-24 08:14:12.635 | MessagingTimeout: No reply on topic compute\n2014-07-24 08:14:12.635 | AUDIT [nova.compute.manager] Terminating instance\n2014-07-24 08:14:12.636 | INFO [nova.compute.manager] Task possibly preempted: Unexpected task state: expecting ('powering-off',) but the actual state is deleting\n2014-07-24 08:14:12.636 | ERROR [oslo.messaging.rpc.dispatcher] Exception during message handling: Unexpected task state: expecting ('powering-off',) but the actual state is deleting\n2014-07-24 08:14:12.636 | Traceback (most recent call last):\n2014-07-24 08:14:12.636 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-07-24 08:14:12.636 |     incoming.message))\n2014-07-24 08:14:12.636 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-07-24 08:14:12.636 |     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-07-24 08:14:12.636 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-07-24 08:14:12.636 |     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-07-24 08:14:12.636 |   File \"nova/exception.py\", line 88, in wrapped\n2014-07-24 08:14:12.636 |     payload)\n2014-07-24 08:14:12.636 |   File \"nova/openstack/common/excutils.py\", line 82, in __exit__\n2014-07-24 08:14:12.637 |     six.reraise(self.type_, self.value, self.tb)\n2014-07-24 08:14:12.637 |   File \"nova/exception.py\", line 71, in wrapped\n2014-07-24 08:14:12.637 |     return f(self, context, *args, **kw)\n2014-07-24 08:14:12.637 |   File \"nova/compute/manager.py\", line 283, in decorated_function\n2014-07-24 08:14:12.637 |     LOG.info(_(\"Task possibly preempted: %s\") % e.format_message())\n2014-07-24 08:14:12.637 |   File \"nova/openstack/common/excutils.py\", line 82, in __exit__\n2014-07-24 08:14:12.637 |     six.reraise(self.type_, self.value, self.tb)\n2014-07-24 08:14:12.637 |   File \"nova/compute/manager.py\", line 277, in decorated_function\n2014-07-24 08:14:12.637 |     return function(self, context, *args, **kwargs)\n2014-07-24 08:14:12.637 |   File \"nova/compute/manager.py\", line 341, in decorated_function\n2014-07-24 08:14:12.637 |     return function(self, context, *args, **kwargs)\n2014-07-24 08:14:12.637 |   File \"nova/compute/manager.py\", line 319, in decorated_function\n2014-07-24 08:14:12.638 |     kwargs['instance'], e, sys.exc_info())\n2014-07-24 08:14:12.638 |   File \"nova/openstack/common/excutils.py\", line 82, in __exit__\n2014-07-24 08:14:12.638 |     six.reraise(self.type_, self.value, self.tb)\n2014-07-24 08:14:12.638 |   File \"nova/compute/manager.py\", line 307, in decorated_function\n2014-07-24 08:14:12.638 |     return function(self, context, *args, **kwargs)\n2014-07-24 08:14:12.638 |   File \"nova/compute/manager.py\", line 2388, in stop_instance\n2014-07-24 08:14:12.638 |     do_stop_instance()\n2014-07-24 08:14:12.638 |   File \"nova/openstack/common/lockutils.py\", line 325, in inner\n2014-07-24 08:14:12.638 |     return f(*args, **kwargs)\n2014-07-24 08:14:12.638 |   File \"nova/compute/manager.py\", line 2384, in do_stop_instance\n2014-07-24 08:14:12.638 |     instance.save(expected_task_state=task_states.POWERING_OFF)\n2014-07-24 08:14:12.638 |   File \"nova/objects/base.py\", line 196, in wrapper\n2014-07-24 08:14:12.639 |     return fn(self, ctxt, *args, **kwargs)\n2014-07-24 08:14:12.639 |   File \"nova/objects/instance.py\", line 469, in save\n2014-07-24 08:14:12.639 |     columns_to_join=_expected_cols(expected_attrs))\n2014-07-24 08:14:12.639 |   File \"nova/db/api.py\", line 780, in instance_update_and_get_original\n2014-07-24 08:14:12.639 |     columns_to_join=columns_to_join)\n2014-07-24 08:14:12.639 |   File \"nova/db/sqlalchemy/api.py\", line 167, in wrapper\n2014-07-24 08:14:12.639 |     return f(*args, **kwargs)\n2014-07-24 08:14:12.639 |   File \"nova/db/sqlalchemy/api.py\", line 2238, in instance_update_and_get_original\n2014-07-24 08:14:12.640 |     columns_to_join=columns_to_join)\n2014-07-24 08:14:12.640 |   File \"nova/db/sqlalchemy/api.py\", line 2286, in _instance_update\n2014-07-24 08:14:12.640 |     actual=actual_state, expected=expected)\n2014-07-24 08:14:12.640 | UnexpectedDeletingTaskStateError: Unexpected task state: expecting ('powering-off',) but the actual state is deleting\n\nAnd this:\n\n2014-07-24 08:14:12.643 | ERROR [oslo.messaging.rpc.dispatcher] Exception during message handling: Object action obj_load_attr failed because: attribute id not lazy-loadable\n2014-07-24 08:14:12.643 | Traceback (most recent call last):\n2014-07-24 08:14:12.643 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-07-24 08:14:12.643 |     incoming.message))\n2014-07-24 08:14:12.643 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-07-24 08:14:12.643 |     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-07-24 08:14:12.643 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-07-24 08:14:12.643 |     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-07-24 08:14:12.644 |   File \"nova/exception.py\", line 88, in wrapped\n2014-07-24 08:14:12.644 |     payload)\n2014-07-24 08:14:12.644 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/notify/notifier.py\", line 232, in error\n2014-07-24 08:14:12.644 |     self._notify(ctxt, event_type, payload, 'ERROR')\n2014-07-24 08:14:12.644 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/notify/notifier.py\", line 278, in _notify\n2014-07-24 08:14:12.644 |     super(_SubNotifier, self)._notify(ctxt, event_type, payload, priority)\n2014-07-24 08:14:12.644 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/notify/notifier.py\", line 151, in _notify\n2014-07-24 08:14:12.644 |     payload = self._serializer.serialize_entity(ctxt, payload)\n2014-07-24 08:14:12.644 |   File \"nova/rpc.py\", line 106, in serialize_entity\n2014-07-24 08:14:12.644 |     return self._base.serialize_entity(context, entity)\n2014-07-24 08:14:12.644 |   File \"nova/rpc.py\", line 95, in serialize_entity\n2014-07-24 08:14:12.645 |     return jsonutils.to_primitive(entity, convert_instances=True)\n2014-07-24 08:14:12.645 |   File \"nova/openstack/common/jsonutils.py\", line 133, in to_primitive\n2014-07-24 08:14:12.645 |     return dict((k, recursive(v)) for k, v in six.iteritems(value))\n2014-07-24 08:14:12.645 |   File \"nova/openstack/common/jsonutils.py\", line 133, in <genexpr>\n2014-07-24 08:14:12.645 |     return dict((k, recursive(v)) for k, v in six.iteritems(value))\n2014-07-24 08:14:12.645 |   File \"nova/openstack/common/jsonutils.py\", line 133, in to_primitive\n2014-07-24 08:14:12.645 |     return dict((k, recursive(v)) for k, v in six.iteritems(value))\n2014-07-24 08:14:12.645 |   File \"nova/openstack/common/jsonutils.py\", line 133, in <genexpr>\n2014-07-24 08:14:12.645 |     return dict((k, recursive(v)) for k, v in six.iteritems(value))\n2014-07-24 08:14:12.645 |   File \"nova/openstack/common/jsonutils.py\", line 148, in to_primitive\n2014-07-24 08:14:12.645 |     return recursive(dict(value.iteritems()), level=level + 1)\n2014-07-24 08:14:12.646 |   File \"nova/objects/base.py\", line 438, in iteritems\n2014-07-24 08:14:12.646 |     yield name, getattr(self, name)\n2014-07-24 08:14:12.646 |   File \"nova/objects/instance.py\", line 229, in name\n2014-07-24 08:14:12.646 |     base_name = CONF.instance_name_template % self.id\n2014-07-24 08:14:12.646 |   File \"nova/objects/base.py\", line 67, in getter\n2014-07-24 08:14:12.646 |     self.obj_load_attr(name)\n2014-07-24 08:14:12.646 |   File \"nova/objects/instance.py\", line 507, in obj_load_attr\n2014-07-24 08:14:12.646 |     reason='attribute %s not lazy-loadable' % attrname)\n2014-07-24 08:14:12.646 | ObjectActionError: Object action obj_load_attr failed because: attribute id not lazy-loadable\n2014-07-24 08:14:12.646 | }}}", 
    "tags": [
        "compute", 
        "ec2", 
        "testing"
    ], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1348661", 
    "owner": "https://api.launchpad.net/1.0/~jogo", 
    "id": 1348661, 
    "index": 1546, 
    "created": "2014-07-25 14:03:39.828760+00:00", 
    "title": "nova.tests.api.ec2.test_cloud.CloudTestCase.test_terminate_instances_two_instances race fails with UnexpectedDeletingTaskStateError", 
    "comments": [
        {
            "content": "This was being masked by bug 1311778 due to the MessagingTimeout failure, but there are more specific errors.\n\nhttp://logs.openstack.org/79/108879/1/gate/gate-nova-python26/283e967/console.html#_2014-07-24_08_14_12_631\n\n2014-07-24 08:14:12.631 | FAIL: nova.tests.api.ec2.test_cloud.CloudTestCase.test_terminate_instances_two_instances\n2014-07-24 08:14:12.631 | tags: worker-4\n2014-07-24 08:14:12.631 | ----------------------------------------------------------------------\n2014-07-24 08:14:12.631 | Empty attachments:\n2014-07-24 08:14:12.631 |   pythonlogging:'boto'\n2014-07-24 08:14:12.631 |   stderr\n2014-07-24 08:14:12.631 |   stdout\n2014-07-24 08:14:12.631 | \n2014-07-24 08:14:12.631 | pythonlogging:'': {{{\n2014-07-24 08:14:12.631 | INFO [nova.network.driver] Loading network driver 'nova.network.linux_net'\n2014-07-24 08:14:12.632 | AUDIT [nova.service] Starting conductor node (version 2014.2)\n2014-07-24 08:14:12.632 | INFO [nova.virt.driver] Loading compute driver 'nova.virt.fake.FakeDriver'\n2014-07-24 08:14:12.632 | AUDIT [nova.service] Starting compute node (version 2014.2)\n2014-07-24 08:14:12.632 | AUDIT [nova.compute.resource_tracker] Auditing locally available compute resources\n2014-07-24 08:14:12.632 | AUDIT [nova.compute.resource_tracker] Free ram (MB): 7680\n2014-07-24 08:14:12.632 | AUDIT [nova.compute.resource_tracker] Free disk (GB): 1028\n2014-07-24 08:14:12.632 | AUDIT [nova.compute.resource_tracker] Free VCPUS: 1\n2014-07-24 08:14:12.632 | AUDIT [nova.compute.resource_tracker] PCI stats: []\n2014-07-24 08:14:12.632 | INFO [nova.compute.resource_tracker] Compute_service record created for 093d0c3802bf440db8f3f839963027c4:fake-mini\n2014-07-24 08:14:12.632 | AUDIT [nova.service] Starting scheduler node (version 2014.2)\n2014-07-24 08:14:12.632 | INFO [nova.network.driver] Loading network driver 'nova.network.linux_net'\n2014-07-24 08:14:12.633 | AUDIT [nova.service] Starting network node (version 2014.2)\n2014-07-24 08:14:12.633 | AUDIT [nova.service] Starting consoleauth node (version 2014.2)\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.manager] Starting instance...\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Attempting claim: memory 2048 MB, disk 20 GB\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Total memory: 8192 MB, used: 512.00 MB\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] memory limit not specified, defaulting to unlimited\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Total disk: 1028 GB, used: 0.00 GB\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] disk limit not specified, defaulting to unlimited\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Claim successful\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.manager] Starting instance...\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Attempting claim: memory 2048 MB, disk 20 GB\n2014-07-24 08:14:12.633 | AUDIT [nova.compute.claims] Total memory: 8192 MB, used: 2560.00 MB\n2014-07-24 08:14:12.634 | AUDIT [nova.compute.claims] memory limit not specified, defaulting to unlimited\n2014-07-24 08:14:12.634 | AUDIT [nova.compute.claims] Total disk: 1028 GB, used: 20.00 GB\n2014-07-24 08:14:12.634 | AUDIT [nova.compute.claims] disk limit not specified, defaulting to unlimited\n2014-07-24 08:14:12.634 | AUDIT [nova.compute.claims] Claim successful\n2014-07-24 08:14:12.634 | WARNING [nova.compute.manager] Instance is not stopped. Calling the stop API.\n2014-07-24 08:14:12.634 | ERROR [nova.compute.manager] error during stop() in sync_power_state.\n2014-07-24 08:14:12.634 | Traceback (most recent call last):\n2014-07-24 08:14:12.634 |   File \"nova/compute/manager.py\", line 5551, in _sync_instance_power_state\n2014-07-24 08:14:12.634 |     self.compute_api.force_stop(context, db_instance)\n2014-07-24 08:14:12.634 |   File \"nova/compute/api.py\", line 1767, in force_stop\n2014-07-24 08:14:12.634 |     self.compute_rpcapi.stop_instance(context, instance, do_cast=do_cast)\n2014-07-24 08:14:12.635 |   File \"nova/compute/rpcapi.py\", line 908, in stop_instance\n2014-07-24 08:14:12.635 |     return rpc_method(ctxt, 'stop_instance', instance=instance)\n2014-07-24 08:14:12.635 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/client.py\", line 150, in call\n2014-07-24 08:14:12.635 |     wait_for_reply=True, timeout=timeout)\n2014-07-24 08:14:12.635 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-07-24 08:14:12.635 |     timeout=timeout)\n2014-07-24 08:14:12.635 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/_drivers/impl_fake.py\", line 166, in send\n2014-07-24 08:14:12.635 |     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2014-07-24 08:14:12.635 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/_drivers/impl_fake.py\", line 161, in _send\n2014-07-24 08:14:12.635 |     'No reply on topic %s' % target.topic)\n2014-07-24 08:14:12.635 | MessagingTimeout: No reply on topic compute\n2014-07-24 08:14:12.635 | AUDIT [nova.compute.manager] Terminating instance\n2014-07-24 08:14:12.636 | INFO [nova.compute.manager] Task possibly preempted: Unexpected task state: expecting ('powering-off',) but the actual state is deleting\n2014-07-24 08:14:12.636 | ERROR [oslo.messaging.rpc.dispatcher] Exception during message handling: Unexpected task state: expecting ('powering-off',) but the actual state is deleting\n2014-07-24 08:14:12.636 | Traceback (most recent call last):\n2014-07-24 08:14:12.636 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-07-24 08:14:12.636 |     incoming.message))\n2014-07-24 08:14:12.636 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-07-24 08:14:12.636 |     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-07-24 08:14:12.636 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-07-24 08:14:12.636 |     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-07-24 08:14:12.636 |   File \"nova/exception.py\", line 88, in wrapped\n2014-07-24 08:14:12.636 |     payload)\n2014-07-24 08:14:12.636 |   File \"nova/openstack/common/excutils.py\", line 82, in __exit__\n2014-07-24 08:14:12.637 |     six.reraise(self.type_, self.value, self.tb)\n2014-07-24 08:14:12.637 |   File \"nova/exception.py\", line 71, in wrapped\n2014-07-24 08:14:12.637 |     return f(self, context, *args, **kw)\n2014-07-24 08:14:12.637 |   File \"nova/compute/manager.py\", line 283, in decorated_function\n2014-07-24 08:14:12.637 |     LOG.info(_(\"Task possibly preempted: %s\") % e.format_message())\n2014-07-24 08:14:12.637 |   File \"nova/openstack/common/excutils.py\", line 82, in __exit__\n2014-07-24 08:14:12.637 |     six.reraise(self.type_, self.value, self.tb)\n2014-07-24 08:14:12.637 |   File \"nova/compute/manager.py\", line 277, in decorated_function\n2014-07-24 08:14:12.637 |     return function(self, context, *args, **kwargs)\n2014-07-24 08:14:12.637 |   File \"nova/compute/manager.py\", line 341, in decorated_function\n2014-07-24 08:14:12.637 |     return function(self, context, *args, **kwargs)\n2014-07-24 08:14:12.637 |   File \"nova/compute/manager.py\", line 319, in decorated_function\n2014-07-24 08:14:12.638 |     kwargs['instance'], e, sys.exc_info())\n2014-07-24 08:14:12.638 |   File \"nova/openstack/common/excutils.py\", line 82, in __exit__\n2014-07-24 08:14:12.638 |     six.reraise(self.type_, self.value, self.tb)\n2014-07-24 08:14:12.638 |   File \"nova/compute/manager.py\", line 307, in decorated_function\n2014-07-24 08:14:12.638 |     return function(self, context, *args, **kwargs)\n2014-07-24 08:14:12.638 |   File \"nova/compute/manager.py\", line 2388, in stop_instance\n2014-07-24 08:14:12.638 |     do_stop_instance()\n2014-07-24 08:14:12.638 |   File \"nova/openstack/common/lockutils.py\", line 325, in inner\n2014-07-24 08:14:12.638 |     return f(*args, **kwargs)\n2014-07-24 08:14:12.638 |   File \"nova/compute/manager.py\", line 2384, in do_stop_instance\n2014-07-24 08:14:12.638 |     instance.save(expected_task_state=task_states.POWERING_OFF)\n2014-07-24 08:14:12.638 |   File \"nova/objects/base.py\", line 196, in wrapper\n2014-07-24 08:14:12.639 |     return fn(self, ctxt, *args, **kwargs)\n2014-07-24 08:14:12.639 |   File \"nova/objects/instance.py\", line 469, in save\n2014-07-24 08:14:12.639 |     columns_to_join=_expected_cols(expected_attrs))\n2014-07-24 08:14:12.639 |   File \"nova/db/api.py\", line 780, in instance_update_and_get_original\n2014-07-24 08:14:12.639 |     columns_to_join=columns_to_join)\n2014-07-24 08:14:12.639 |   File \"nova/db/sqlalchemy/api.py\", line 167, in wrapper\n2014-07-24 08:14:12.639 |     return f(*args, **kwargs)\n2014-07-24 08:14:12.639 |   File \"nova/db/sqlalchemy/api.py\", line 2238, in instance_update_and_get_original\n2014-07-24 08:14:12.640 |     columns_to_join=columns_to_join)\n2014-07-24 08:14:12.640 |   File \"nova/db/sqlalchemy/api.py\", line 2286, in _instance_update\n2014-07-24 08:14:12.640 |     actual=actual_state, expected=expected)\n2014-07-24 08:14:12.640 | UnexpectedDeletingTaskStateError: Unexpected task state: expecting ('powering-off',) but the actual state is deleting\n\nAnd this:\n\n2014-07-24 08:14:12.643 | ERROR [oslo.messaging.rpc.dispatcher] Exception during message handling: Object action obj_load_attr failed because: attribute id not lazy-loadable\n2014-07-24 08:14:12.643 | Traceback (most recent call last):\n2014-07-24 08:14:12.643 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-07-24 08:14:12.643 |     incoming.message))\n2014-07-24 08:14:12.643 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-07-24 08:14:12.643 |     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-07-24 08:14:12.643 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-07-24 08:14:12.643 |     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-07-24 08:14:12.644 |   File \"nova/exception.py\", line 88, in wrapped\n2014-07-24 08:14:12.644 |     payload)\n2014-07-24 08:14:12.644 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/notify/notifier.py\", line 232, in error\n2014-07-24 08:14:12.644 |     self._notify(ctxt, event_type, payload, 'ERROR')\n2014-07-24 08:14:12.644 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/notify/notifier.py\", line 278, in _notify\n2014-07-24 08:14:12.644 |     super(_SubNotifier, self)._notify(ctxt, event_type, payload, priority)\n2014-07-24 08:14:12.644 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/notify/notifier.py\", line 151, in _notify\n2014-07-24 08:14:12.644 |     payload = self._serializer.serialize_entity(ctxt, payload)\n2014-07-24 08:14:12.644 |   File \"nova/rpc.py\", line 106, in serialize_entity\n2014-07-24 08:14:12.644 |     return self._base.serialize_entity(context, entity)\n2014-07-24 08:14:12.644 |   File \"nova/rpc.py\", line 95, in serialize_entity\n2014-07-24 08:14:12.645 |     return jsonutils.to_primitive(entity, convert_instances=True)\n2014-07-24 08:14:12.645 |   File \"nova/openstack/common/jsonutils.py\", line 133, in to_primitive\n2014-07-24 08:14:12.645 |     return dict((k, recursive(v)) for k, v in six.iteritems(value))\n2014-07-24 08:14:12.645 |   File \"nova/openstack/common/jsonutils.py\", line 133, in <genexpr>\n2014-07-24 08:14:12.645 |     return dict((k, recursive(v)) for k, v in six.iteritems(value))\n2014-07-24 08:14:12.645 |   File \"nova/openstack/common/jsonutils.py\", line 133, in to_primitive\n2014-07-24 08:14:12.645 |     return dict((k, recursive(v)) for k, v in six.iteritems(value))\n2014-07-24 08:14:12.645 |   File \"nova/openstack/common/jsonutils.py\", line 133, in <genexpr>\n2014-07-24 08:14:12.645 |     return dict((k, recursive(v)) for k, v in six.iteritems(value))\n2014-07-24 08:14:12.645 |   File \"nova/openstack/common/jsonutils.py\", line 148, in to_primitive\n2014-07-24 08:14:12.645 |     return recursive(dict(value.iteritems()), level=level + 1)\n2014-07-24 08:14:12.646 |   File \"nova/objects/base.py\", line 438, in iteritems\n2014-07-24 08:14:12.646 |     yield name, getattr(self, name)\n2014-07-24 08:14:12.646 |   File \"nova/objects/instance.py\", line 229, in name\n2014-07-24 08:14:12.646 |     base_name = CONF.instance_name_template % self.id\n2014-07-24 08:14:12.646 |   File \"nova/objects/base.py\", line 67, in getter\n2014-07-24 08:14:12.646 |     self.obj_load_attr(name)\n2014-07-24 08:14:12.646 |   File \"nova/objects/instance.py\", line 507, in obj_load_attr\n2014-07-24 08:14:12.646 |     reason='attribute %s not lazy-loadable' % attrname)\n2014-07-24 08:14:12.646 | ObjectActionError: Object action obj_load_attr failed because: attribute id not lazy-loadable\n2014-07-24 08:14:12.646 | }}}", 
            "date_created": "2014-07-25 14:03:39.828760+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This might be a dupe of bug 1339235.", 
            "date_created": "2014-07-25 14:04:09.609284+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Looking at when this fails in logstash, there are at least 3 different ec2 compute tests that fail with the unexpected task state error like this:\n\n2014-07-23 14:49:05.554 | WARNING [nova.compute.manager] Instance is not stopped. Calling the stop API.\n2014-07-23 14:49:05.554 | ERROR [nova.compute.manager] error during stop() in sync_power_state.\n\nIf the sync_instance_power_state periodic task is causing the race, then this should help fix that:\n\nhttps://review.openstack.org/#/c/108837/\n\nThis shows up in all of the failures as a result of I think how the exception notification is being handled in the compute manager:\n\nObjectActionError: Object action obj_load_attr failed because: attribute id not lazy-loadable\n\n", 
            "date_created": "2014-07-25 14:15:34.562395+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "For this part:\n\nObjectActionError: Object action obj_load_attr failed because: attribute id not lazy-loadable\n\nThe nova ec2 compute unit tests are going through the compute manager code like the nova.tests.compute.test_compute tests are, but they aren't stubbing out the notifier to use the fake notifier, that's why they are actually trying to serialize the instance and blowing up, so that's a side effect we can clean up.", 
            "date_created": "2014-07-25 14:50:42.815729+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "e-r query: https://review.openstack.org/#/c/109615/", 
            "date_created": "2014-07-25 14:58:38.957943+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/109641", 
            "date_created": "2014-07-25 15:58:12.224822+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/109641\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7bbf7ca4938ee01b86faee1e8eceb1f6700e67e4\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7bbf7ca4938ee01b86faee1e8eceb1f6700e67e4\nAuthor: Matt Riedemann <email address hidden>\nDate:   Fri Jul 25 08:56:13 2014 -0700\n\n    Stub out rpc notifications in ec2 cloud unit tests\n    \n    The ec2 cloud unit tests are running through the compute\n    manager and if something fails and is wrapped with the\n    wrap_exception decorator, we can get big ugly stack traces\n    in the log. We should be using the fake_notifier in these\n    tests like we do in the nova.tests.compute.test_compute\n    setup.\n    \n    This also changes the test_ec2_validate test to use\n    local conductor like the other cloud tests that are going\n    through conductor.\n    \n    Change-Id: I59bed0903aeef4086872c10d93a06f34b072dce3\n    Partial-Bug: #1348661\n", 
            "date_created": "2014-07-25 19:18:00.509987+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "anything left to do on this?  all reviews have merged", 
            "date_created": "2014-07-28 20:06:45.846686+00:00", 
            "author": "https://api.launchpad.net/1.0/~tjones-i"
        }, 
        {
            "content": "This change from Joe appears to have fixed the issue:\n\nhttps://github.com/openstack/nova/commit/f3f07f4401ff8be25598493c088e4e100b387fe4\n\nLooking at the query in logstash, the hits drop off on 7/24 and that's when Joe's change to turn off periodic tasks in unit tests was merged, and the trace in the failures is when the periodic task is syncing power state while the compute manager is running and we blow up on stop_instance.", 
            "date_created": "2014-07-29 13:09:16.420256+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }
    ]
}