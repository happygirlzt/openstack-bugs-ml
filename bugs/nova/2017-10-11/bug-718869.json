{
    "status": "Fix Released", 
    "last_updated": "2011-06-14 18:16:30.829864+00:00", 
    "description": "I restarted rabbitmq server and afterwards several services are not reconnecting to the server (nova-compute, nova-api).\n\nnova-scheduler reconnects successfully:\n2011-02-14 16:54:46,144 ERROR nova.rpc [-] Reconnected to queue\n\nbut other services (I checked nova-compute and nova-api) aren't reconnecting.\n\ni tried spawning a new instance without success (only getting an unknown error..):\n# euca-run-instances ami-3x776h8w -t m1.tiny\nUnknownError: An unknown error has occurred. Please try your request again.\n\nnova-api, nova-scheduler are not reconnecting:\n2011-02-14 16:54:40,786 ERROR nova.rpc [-] Failed to fetch message from queue\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 117, in fetch\n(nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n(nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n(nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n(nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n(nova.rpc): TRACE:     self.channel_id, allowed_methods)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n(nova.rpc): TRACE:     self.wait()\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n(nova.rpc): TRACE:     return amqp_method(self, args)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 365, in _close\n(nova.rpc): TRACE:     self._x_close_ok()\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 384, in _x_close_ok\n(nova.rpc): TRACE:     self._send_method((10, 61))\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 70, in _send_method\n(nova.rpc): TRACE:     method_sig, args, content)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/method_framing.py\", line 233, in write_method\n(nova.rpc): TRACE:     self.dest.write_frame(1, channel, payload)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/transport.py\", line 125, in write_frame\n(nova.rpc): TRACE:     frame_type, channel, size, payload, 0xce))\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/eventlet/greenio.py\", line 273, in sendall\n(nova.rpc): TRACE:     tail = self.send(data, flags)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/eventlet/greenio.py\", line 259, in send\n(nova.rpc): TRACE:     total_sent += fd.send(data[total_sent:], flags)\n(nova.rpc): TRACE: error: [Errno 32] Broken pipe\n(nova.rpc): TRACE:", 
    "tags": [], 
    "importance": "High", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/718869", 
    "owner": "https://api.launchpad.net/1.0/~sandy-walsh", 
    "id": 718869, 
    "index": 356, 
    "created": "2011-02-14 17:01:56.812082+00:00", 
    "title": "nova-compute: can't spawn new instances after restarting RabbitMQ", 
    "comments": [
        {
            "content": "I restarted rabbitmq server and afterwards several services are not reconnecting to the server (nova-compute, nova-api).\n\nnova-scheduler reconnects successfully:\n2011-02-14 16:54:46,144 ERROR nova.rpc [-] Reconnected to queue\n\nbut other services (I checked nova-compute and nova-api) aren't reconnecting.\n\ni tried spawning a new instance without success (only getting an unknown error..):\n# euca-run-instances ami-3x776h8w -t m1.tiny\nUnknownError: An unknown error has occurred. Please try your request again.\n\nnova-api, nova-scheduler are not reconnecting:\n2011-02-14 16:54:40,786 ERROR nova.rpc [-] Failed to fetch message from queue\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 117, in fetch\n(nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n(nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n(nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n(nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n(nova.rpc): TRACE:     self.channel_id, allowed_methods)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n(nova.rpc): TRACE:     self.wait()\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n(nova.rpc): TRACE:     return amqp_method(self, args)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 365, in _close\n(nova.rpc): TRACE:     self._x_close_ok()\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 384, in _x_close_ok\n(nova.rpc): TRACE:     self._send_method((10, 61))\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 70, in _send_method\n(nova.rpc): TRACE:     method_sig, args, content)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/method_framing.py\", line 233, in write_method\n(nova.rpc): TRACE:     self.dest.write_frame(1, channel, payload)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/transport.py\", line 125, in write_frame\n(nova.rpc): TRACE:     frame_type, channel, size, payload, 0xce))\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/eventlet/greenio.py\", line 273, in sendall\n(nova.rpc): TRACE:     tail = self.send(data, flags)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/eventlet/greenio.py\", line 259, in send\n(nova.rpc): TRACE:     total_sent += fd.send(data[total_sent:], flags)\n(nova.rpc): TRACE: error: [Errno 32] Broken pipe\n(nova.rpc): TRACE:", 
            "date_created": "2011-02-14 17:01:56.812082+00:00", 
            "author": "https://api.launchpad.net/1.0/~berendt"
        }, 
        {
            "content": "after restarting nova-compute and nova-api i can spawn new instances, but i think they should reconnect to the queue automatically...\n\n# euca-run-instances ami-3x776h8w -t m1.tiny\nRESERVATION     r-7x789omn      testing default\nINSTANCE        i-0000000d      ami-3x776h8w                    scheduling      None (testing, None)    2011-02-14 17:03:07     None    None\n", 
            "date_created": "2011-02-14 17:04:12.892004+00:00", 
            "author": "https://api.launchpad.net/1.0/~berendt"
        }, 
        {
            "content": "or not.. now i have this error in /var/log/nova/scheduler.log...\n\n2011-02-14 17:05:16,922 ERROR nova.root [-] Exception during message handling\n(nova.root): TRACE: Traceback (most recent call last):\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 192, in receive\n(nova.root): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/scheduler/manager.py\", line 68, in _schedule\n(nova.root): TRACE:     \"args\": kwargs})\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 350, in cast\n(nova.root): TRACE:     publisher = TopicPublisher(connection=conn, topic=topic)\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 210, in __init__\n(nova.root): TRACE:     super(TopicPublisher, self).__init__(connection=connection)\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 657, in __init__\n(nova.root): TRACE:     self.declare()\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 669, in declare\n(nova.root): TRACE:     auto_delete=self.auto_delete)\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 253, in exchange_declare\n(nova.root): TRACE:     return self.channel.exchange_declare(exchange=exchange,\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 188, in channel\n(nova.root): TRACE:     self._channel_ref = weakref.ref(connection.channel())\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 230, in channel\n(nova.root): TRACE:     return Channel(self, channel_id)\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 82, in __init__\n(nova.root): TRACE:     self._x_open()\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 471, in _x_open\n(nova.root): TRACE:     (20, 11),    # Channel.open_ok\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n(nova.root): TRACE:     self.channel_id, allowed_methods)\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 198, in _wait_method\n(nova.root): TRACE:     self.method_reader.read_method()\n(nova.root): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/method_framing.py\", line 215, in read_method\n(nova.root): TRACE:     raise m\n(nova.root): TRACE: RuntimeError: Second simultaneous read on fileno 10 detected.  Unless you really know what you're doing, make sure that only one greenthread can read any particular socket.  Consider using a pools.Pool. If you do know what you're doing and want to disable this error, call eventlet.debug.hub_multiple_reader_prevention(False)\n(nova.root): TRACE:\n", 
            "date_created": "2011-02-14 17:06:18.831513+00:00", 
            "author": "https://api.launchpad.net/1.0/~berendt"
        }, 
        {
            "content": "This was supposed to be fixed in bug 661472, apparently it's not really retrying ?", 
            "date_created": "2011-02-23 13:38:44.877127+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "tried it again.. restarted rabbitmq-server..\n\ntried to spawn 2 new instances a few seconds after the start of rabbitmq-server:\n\n---snip---\nares:~ # euca-describe-instances \nRESERVATION\tr-n6jwk5yj\ttesting\tdefault\nINSTANCE\ti-00000107\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t0 \tm1.tiny \t2011-02-23T13:52:56Z \tunknown zone\nINSTANCE\ti-00000108\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t1 \tm1.tiny \t2011-02-23T13:52:56Z \tunknown zone\n---snap---\n\n---snip---\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 120, in fetch\n(nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n(nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n(nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n(nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n(nova.rpc): TRACE:     self.channel_id, allowed_methods)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n(nova.rpc): TRACE:     self.wait()\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n(nova.rpc): TRACE:     return amqp_method(self, args)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 367, in _close\n(nova.rpc): TRACE:     raise AMQPConnectionException(reply_code, reply_text, (class_id, method_id))\n(nova.rpc): TRACE: AMQPConnectionException: (320, u\"CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'\", (0, 0), '')\n(nova.rpc): TRACE:\n2011-02-23 14:52:46,720 ERROR nova.rpc [-] Failed to fetch message from queue\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 120, in fetch\n(nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n(nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n(nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n(nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n(nova.rpc): TRACE:     self.channel_id, allowed_methods)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n(nova.rpc): TRACE:     self.wait()\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n(nova.rpc): TRACE:     return amqp_method(self, args)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 365, in _close\n(nova.rpc): TRACE:     self._x_close_ok()\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 384, in _x_close_ok\n(nova.rpc): TRACE:     self._send_method((10, 61))\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 70, in _send_method\n(nova.rpc): TRACE:     method_sig, args, content)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/method_framing.py\", line 233, in write_method\n(nova.rpc): TRACE:     self.dest.write_frame(1, channel, payload)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/transport.py\", line 125, in write_frame\n(nova.rpc): TRACE:     frame_type, channel, size, payload, 0xce))\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/eventlet/greenio.py\", line 283, in sendall\n(nova.rpc): TRACE:     tail = self.send(data, flags)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/eventlet/greenio.py\", line 269, in send\n(nova.rpc): TRACE:     total_sent += fd.send(data[total_sent:], flags)\n(nova.rpc): TRACE: error: [Errno 32] Broken pipe\n(nova.rpc): TRACE:\n---snap---\n\ntried it again a few minutes after starting rabbitmq-server i can still not spawn new instances (but i got no new errors in the logfiles)\n\n---snip---\nares:~ # euca-describe-instances \nRESERVATION\tr-n6jwk5yj\ttesting\tdefault\nINSTANCE\ti-00000107\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t0 \tm1.tiny \t2011-02-23T13:52:56Z \tunknown zone\nINSTANCE\ti-00000108\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t1 \tm1.tiny \t2011-02-23T13:52:56Z \tunknown zone\nRESERVATION\tr-4aulwrb9\ttesting\tdefault\nINSTANCE\ti-00000109\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t0 \tm1.tiny \t2011-02-23T13:57:46Z \tunknown zone\nINSTANCE\ti-0000010a\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t1 \tm1.tiny \t2011-02-23T13:57:46Z \tunknown zone\n---snap---\n\n\nnow i restarted all nova services and restarted rabbitmq-server afterwards again\n\nafter a few minutes i tried to spawn 2 instances... still not working... got the following error in the logs:\n\n---snip---\n2011-02-23 15:02:12,761 ERROR nova.rpc [-] Failed to fetch message from queue\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 120, in fetch\n(nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n(nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n(nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n(nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n(nova.rpc): TRACE:     self.channel_id, allowed_methods)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n(nova.rpc): TRACE:     self.wait()\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n(nova.rpc): TRACE:     return amqp_method(self, args)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 367, in _close\n(nova.rpc): TRACE:     raise AMQPConnectionException(reply_code, reply_text, (class_id, method_id))\n(nova.rpc): TRACE: AMQPConnectionException: (320, u\"CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'\", (0, 0), '')\n(nova.rpc): TRACE:\n2011-02-23 15:02:12,768 ERROR nova.rpc [-] Failed to fetch message from queue\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 120, in fetch\n(nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n(nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n(nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n(nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n(nova.rpc): TRACE:     self.channel_id, allowed_methods)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n(nova.rpc): TRACE:     self.wait()\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n(nova.rpc): TRACE:     return amqp_method(self, args)\n(nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 367, in _close\n(nova.rpc): TRACE:     raise AMQPConnectionException(reply_code, reply_text, (class_id, method_id))\n(nova.rpc): TRACE: AMQPConnectionException: (320, u\"CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'\", (0, 0), '')\n(nova.rpc): TRACE:\n---snap---", 
            "date_created": "2011-02-23 14:05:31.972642+00:00", 
            "author": "https://api.launchpad.net/1.0/~berendt"
        }, 
        {
            "content": "I've also noticed that restarting rabbit breaks things.  Apparently our fix was not complete, or it broke again with soren's threadpool addition.\n\nVish\n\nOn Feb 23, 2011, at 6:05 AM, Christian Berendt wrote:\n\n> tried it again.. restarted rabbitmq-server..\n> \n> tried to spawn 2 new instances a few seconds after the start of\n> rabbitmq-server:\n> \n> ---snip---\n> ares:~ # euca-describe-instances \n> RESERVATION\tr-n6jwk5yj\ttesting\tdefault\n> INSTANCE\ti-00000107\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t0 \tm1.tiny \t2011-02-23T13:52:56Z \tunknown zone\n> INSTANCE\ti-00000108\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t1 \tm1.tiny \t2011-02-23T13:52:56Z \tunknown zone\n> ---snap---\n> \n> ---snip---\n> (nova.rpc): TRACE: Traceback (most recent call last):\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 120, in fetch\n> (nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n> (nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n> (nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n> (nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n> (nova.rpc): TRACE:     self.channel_id, allowed_methods)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n> (nova.rpc): TRACE:     self.wait()\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n> (nova.rpc): TRACE:     return amqp_method(self, args)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 367, in _close\n> (nova.rpc): TRACE:     raise AMQPConnectionException(reply_code, reply_text, (class_id, method_id))\n> (nova.rpc): TRACE: AMQPConnectionException: (320, u\"CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'\", (0, 0), '')\n> (nova.rpc): TRACE:\n> 2011-02-23 14:52:46,720 ERROR nova.rpc [-] Failed to fetch message from queue\n> (nova.rpc): TRACE: Traceback (most recent call last):\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 120, in fetch\n> (nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n> (nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n> (nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n> (nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n> (nova.rpc): TRACE:     self.channel_id, allowed_methods)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n> (nova.rpc): TRACE:     self.wait()\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n> (nova.rpc): TRACE:     return amqp_method(self, args)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 365, in _close\n> (nova.rpc): TRACE:     self._x_close_ok()\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 384, in _x_close_ok\n> (nova.rpc): TRACE:     self._send_method((10, 61))\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 70, in _send_method\n> (nova.rpc): TRACE:     method_sig, args, content)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/method_framing.py\", line 233, in write_method\n> (nova.rpc): TRACE:     self.dest.write_frame(1, channel, payload)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/transport.py\", line 125, in write_frame\n> (nova.rpc): TRACE:     frame_type, channel, size, payload, 0xce))\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/eventlet/greenio.py\", line 283, in sendall\n> (nova.rpc): TRACE:     tail = self.send(data, flags)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/eventlet/greenio.py\", line 269, in send\n> (nova.rpc): TRACE:     total_sent += fd.send(data[total_sent:], flags)\n> (nova.rpc): TRACE: error: [Errno 32] Broken pipe\n> (nova.rpc): TRACE:\n> ---snap---\n> \n> tried it again a few minutes after starting rabbitmq-server i can still\n> not spawn new instances (but i got no new errors in the logfiles)\n> \n> ---snip---\n> ares:~ # euca-describe-instances \n> RESERVATION\tr-n6jwk5yj\ttesting\tdefault\n> INSTANCE\ti-00000107\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t0 \tm1.tiny \t2011-02-23T13:52:56Z \tunknown zone\n> INSTANCE\ti-00000108\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t1 \tm1.tiny \t2011-02-23T13:52:56Z \tunknown zone\n> RESERVATION\tr-4aulwrb9\ttesting\tdefault\n> INSTANCE\ti-00000109\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t0 \tm1.tiny \t2011-02-23T13:57:46Z \tunknown zone\n> INSTANCE\ti-0000010a\tami-2a1izx00\t\t\tscheduling \tfoobar (testing, None) \t1 \tm1.tiny \t2011-02-23T13:57:46Z \tunknown zone\n> ---snap---\n> \n> \n> now i restarted all nova services and restarted rabbitmq-server afterwards again\n> \n> after a few minutes i tried to spawn 2 instances... still not working...\n> got the following error in the logs:\n> \n> ---snip---\n> 2011-02-23 15:02:12,761 ERROR nova.rpc [-] Failed to fetch message from queue\n> (nova.rpc): TRACE: Traceback (most recent call last):\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 120, in fetch\n> (nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n> (nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n> (nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n> (nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n> (nova.rpc): TRACE:     self.channel_id, allowed_methods)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n> (nova.rpc): TRACE:     self.wait()\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n> (nova.rpc): TRACE:     return amqp_method(self, args)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 367, in _close\n> (nova.rpc): TRACE:     raise AMQPConnectionException(reply_code, reply_text, (class_id, method_id))\n> (nova.rpc): TRACE: AMQPConnectionException: (320, u\"CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'\", (0, 0), '')\n> (nova.rpc): TRACE:\n> 2011-02-23 15:02:12,768 ERROR nova.rpc [-] Failed to fetch message from queue\n> (nova.rpc): TRACE: Traceback (most recent call last):\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 120, in fetch\n> (nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n> (nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n> (nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n> (nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n> (nova.rpc): TRACE:     self.channel_id, allowed_methods)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n> (nova.rpc): TRACE:     self.wait()\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n> (nova.rpc): TRACE:     return amqp_method(self, args)\n> (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 367, in _close\n> (nova.rpc): TRACE:     raise AMQPConnectionException(reply_code, reply_text, (class_id, method_id))\n> (nova.rpc): TRACE: AMQPConnectionException: (320, u\"CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'\", (0, 0), '')\n> (nova.rpc): TRACE:\n> ---snap---\n> \n> -- \n> You received this bug notification because you are a member of Nova Bug\n> Team, which is subscribed to OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/718869\n> \n> Title:\n>  nova-compute: can't spawn new instances after restarting RabbitMQ\n> \n> Status in OpenStack Compute (Nova):\n>  Confirmed\n> \n> Bug description:\n>  I restarted rabbitmq server and afterwards several services are not\n>  reconnecting to the server (nova-compute, nova-api).\n> \n>  nova-scheduler reconnects successfully:\n>  2011-02-14 16:54:46,144 ERROR nova.rpc [-] Reconnected to queue\n> \n>  but other services (I checked nova-compute and nova-api) aren't\n>  reconnecting.\n> \n>  i tried spawning a new instance without success (only getting an unknown error..):\n>  # euca-run-instances ami-3x776h8w -t m1.tiny\n>  UnknownError: An unknown error has occurred. Please try your request again.\n> \n>  nova-api, nova-scheduler are not reconnecting:\n>  2011-02-14 16:54:40,786 ERROR nova.rpc [-] Failed to fetch message from queue\n>  (nova.rpc): TRACE: Traceback (most recent call last):\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 117, in fetch\n>  (nova.rpc): TRACE:     super(Consumer, self).fetch(no_ack, auto_ack, enable_callbacks)\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/messaging.py\", line 307, in fetch\n>  (nova.rpc): TRACE:     message = self.backend.get(self.queue, no_ack=no_ack)\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/carrot/backends/pyamqplib.py\", line 277, in get\n>  (nova.rpc): TRACE:     raw_message = self.channel.basic_get(queue, no_ack=no_ack)\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/channel.py\", line 2032, in basic_get\n>  (nova.rpc): TRACE:     (60, 72),    # Channel.basic_get_empty\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n>  (nova.rpc): TRACE:     self.channel_id, allowed_methods)\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n>  (nova.rpc): TRACE:     self.wait()\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n>  (nova.rpc): TRACE:     return amqp_method(self, args)\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 365, in _close\n>  (nova.rpc): TRACE:     self._x_close_ok()\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/connection.py\", line 384, in _x_close_ok\n>  (nova.rpc): TRACE:     self._send_method((10, 61))\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/abstract_channel.py\", line 70, in _send_method\n>  (nova.rpc): TRACE:     method_sig, args, content)\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/method_framing.py\", line 233, in write_method\n>  (nova.rpc): TRACE:     self.dest.write_frame(1, channel, payload)\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/amqplib/client_0_8/transport.py\", line 125, in write_frame\n>  (nova.rpc): TRACE:     frame_type, channel, size, payload, 0xce))\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/eventlet/greenio.py\", line 273, in sendall\n>  (nova.rpc): TRACE:     tail = self.send(data, flags)\n>  (nova.rpc): TRACE:   File \"/usr/lib64/python2.6/site-packages/eventlet/greenio.py\", line 259, in send\n>  (nova.rpc): TRACE:     total_sent += fd.send(data[total_sent:], flags)\n>  (nova.rpc): TRACE: error: [Errno 32] Broken pipe\n>  (nova.rpc): TRACE:\n\n", 
            "date_created": "2011-02-23 20:13:58+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Yeah, I'm seeing this as well: http://paste.openstack.org/show/1033/\n\nOn it ...", 
            "date_created": "2011-03-30 13:29:52.752984+00:00", 
            "author": "https://api.launchpad.net/1.0/~sandy-walsh"
        }, 
        {
            "content": "Seems my previous fix will result in excessive logging on a failure. Will put another branch in against it.", 
            "date_created": "2011-03-31 19:25:55.682372+00:00", 
            "author": "https://api.launchpad.net/1.0/~sandy-walsh"
        }
    ]
}