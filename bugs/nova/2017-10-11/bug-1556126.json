{
    "status": "Fix Released", 
    "last_updated": "2016-03-21 14:45:28.245087+00:00", 
    "description": "I have an environment consisting of three nodes:\n\nController Mitaka, commit id: 59a07f00ad3c527e3b39712220cf9de1e68cd16f\nCompute Mitaka, commit id: 59a07f00ad3c527e3b39712220cf9de1e68cd16f\nCompute Stable/Liberty, commit id: 184e2552490ecfded61db3cc9ba1cd8d6aac1644\n\nI am able to live migrate VMs from Liberty to Mitaka using this CLI command:\n\nnova --os-compute-api-version 2.24 live-migrate --block-migrate instance\n\nBut when I want to move VM from Mitaka to Liberty I'm ending up with an error:\n\nERROR nova.virt.libvirt.driver [req-aea14ab8-204d-4e7f-a591-e81a5b5fde4b admin demo] [instance: d509c4af-2003-4075-9c2f-2c4fbce727ea] Live Migration failure: internal error:\n process exited while connecting to monitor: 2016-03-11T13:36:33.803180Z qemu-system-x86_64: -vnc None:0: Failed to start VNC server on `(null)': address resolution failed for None:5900: Temporary\nfailure in name resolution\n\nTraceback:\n\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 457, in fire_timers\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 58, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 168, in _do_send\n    waiter.switch(result)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/utils.py\", line 1145, in context_wrapper\n    return func(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 6059, in _live_migration_operation\n    instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 6027, in _live_migration_operation\n    CONF.libvirt.live_migration_bandwidth)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 1825, in migrateToURI2\n    if ret == -1: raise libvirtError ('virDomainMigrateToURI2() failed', dom=self)\nlibvirtError: internal error: process exited while connecting to monitor: 2016-03-11T13:20:07.165053Z qemu-system-x86_64: -vnc None:0: Failed to start VNC server on `(null)': address resolution failed for None:5900: Temporary failure in name resolution\n\nSame happens when VM is volume-backed or on shared storage.\n\nThis happens because pre_live_migration, that is executed on destination (Liberty), returns dict that looks like:\n\n{u'volume': {}, u'serial_listen_addr': u'127.0.0.1', u'graphics_listen_addrs': {u'vnc': u'10.0.0.3', u'spice': u'127.0.0.1'}}\n\nWhen it comes back to rpc api of new compute node here: https://github.com/openstack/nova/blob/a3cf38a3ec0fd57679320688bd815225c2bf053f/nova/compute/rpcapi.py#L680\n\nWe just pass this data to .from_legacy_dict() migrate_data object method, but  it does expect that all this data will be nested under 'pre_live_migration_result' key: https://github.com/openstack/nova/blob/7832f6ea816b1b79251d06abbf38772894e74e2f/nova/objects/migrate_data.py#L195\n\nBecause of this we don't really convert data coming from pre_live_migration phase and pass migrate_data object with Nones that are needed for setting up VNC.", 
    "tags": [
        "live-migration"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1556126", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1556126, 
    "index": 1898, 
    "created": "2016-03-11 14:26:06.111385+00:00", 
    "title": "Live migrations from Mitaka to Liberty are broken", 
    "comments": [
        {
            "content": "I have an environment consisting of three nodes:\n\nController Mitaka, commit id: 59a07f00ad3c527e3b39712220cf9de1e68cd16f\nCompute Mitaka, commit id: 59a07f00ad3c527e3b39712220cf9de1e68cd16f\nCompute Stable/Liberty, commit id: 184e2552490ecfded61db3cc9ba1cd8d6aac1644\n\nI am able to live migrate VMs from Liberty to Mitaka using this CLI command:\n\nnova --os-compute-api-version 2.24 live-migrate --block-migrate instance\n\nBut when I want to move VM from Mitaka to Liberty I'm ending up with an error:\n\nERROR nova.virt.libvirt.driver [req-aea14ab8-204d-4e7f-a591-e81a5b5fde4b admin demo] [instance: d509c4af-2003-4075-9c2f-2c4fbce727ea] Live Migration failure: internal error:\n process exited while connecting to monitor: 2016-03-11T13:36:33.803180Z qemu-system-x86_64: -vnc None:0: Failed to start VNC server on `(null)': address resolution failed for None:5900: Temporary\nfailure in name resolution\n\nTraceback:\n\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 457, in fire_timers\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 58, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 168, in _do_send\n    waiter.switch(result)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/utils.py\", line 1145, in context_wrapper\n    return func(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 6059, in _live_migration_operation\n    instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 6027, in _live_migration_operation\n    CONF.libvirt.live_migration_bandwidth)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 1825, in migrateToURI2\n    if ret == -1: raise libvirtError ('virDomainMigrateToURI2() failed', dom=self)\nlibvirtError: internal error: process exited while connecting to monitor: 2016-03-11T13:20:07.165053Z qemu-system-x86_64: -vnc None:0: Failed to start VNC server on `(null)': address resolution failed for None:5900: Temporary failure in name resolution\n\nSame happens when VM is volume-backed or on shared storage.\n\nThis happens because pre_live_migration, that is executed on destination (Liberty), returns dict that looks like:\n\n{u'volume': {}, u'serial_listen_addr': u'127.0.0.1', u'graphics_listen_addrs': {u'vnc': u'10.0.0.3', u'spice': u'127.0.0.1'}}\n\nWhen it comes back to rpc api of new compute node here: https://github.com/openstack/nova/blob/a3cf38a3ec0fd57679320688bd815225c2bf053f/nova/compute/rpcapi.py#L680\n\nWe just pass this data to .from_legacy_dict() migrate_data object method, but  it does expect that all this data will be nested under 'pre_live_migration_result' key: https://github.com/openstack/nova/blob/7832f6ea816b1b79251d06abbf38772894e74e2f/nova/objects/migrate_data.py#L195\n\nBecause of this we don't really convert data coming from pre_live_migration phase and pass migrate_data object with Nones that are needed for setting up VNC.", 
            "date_created": "2016-03-11 14:26:06.111385+00:00", 
            "author": "https://api.launchpad.net/1.0/~pawel-koniszewski"
        }, 
        {
            "content": "Forgot to mention that I have applied these upgrade levels on controller and computes:\n\ncompute=4.5\nnetwork=1.15", 
            "date_created": "2016-03-11 14:45:30.166440+00:00", 
            "author": "https://api.launchpad.net/1.0/~pawel-koniszewski"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/291759", 
            "date_created": "2016-03-11 15:18:59.090316+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/291759\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=fb6f37f7f91c47aced8b19e527e2771743911d0a\nSubmitter: Jenkins\nBranch:    master\n\ncommit fb6f37f7f91c47aced8b19e527e2771743911d0a\nAuthor: Dan Smith <email address hidden>\nDate:   Fri Mar 11 07:15:38 2016 -0800\n\n    Fix pre_live_migration result processing from legacy computes\n    \n    The objectification of the live migration data ended up with a bug in\n    the compatibility path for the pre_live_migration result where we\n    convert a legacy dict response back to an object. The legacy dict\n    processing looks for 'pre_live_migration_result' in the input to\n    trigger handling of those keys, but we weren't properly wrapping the\n    result like that so it was never digesting those keys.\n    \n    Change-Id: I5142e1cb9d526c92529fc24ee0441b5730931160\n    Closes-Bug: #1556126\n", 
            "date_created": "2016-03-11 17:46:09.189274+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.0.0.0rc1 release candidate.", 
            "date_created": "2016-03-16 18:00:11.214709+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }
    ]
}