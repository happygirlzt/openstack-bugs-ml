{
    "status": "Fix Released", 
    "last_updated": "2017-06-16 17:42:22.536657+00:00", 
    "description": "There can be at most 15 virtual disk attached on an SCSi controller, so if the limitation is reached, a new controller should be automatically created.\n\nBut I met an error when trying to attach the 15th volume to an instance.\n\nIt is reported as \n\"VMwareDriverException: Invalid configuration for device '0'\"", 
    "tags": [
        "in-stable-mitaka", 
        "vmware", 
        "volumes"
    ], 
    "importance": "Medium", 
    "heat": 20, 
    "link": "https://bugs.launchpad.net/nova/+bug/1522232", 
    "owner": "https://api.launchpad.net/1.0/~yanfengxi", 
    "id": 1522232, 
    "index": 4395, 
    "created": "2015-12-03 02:54:15.483705+00:00", 
    "title": "failed automatically creating new SCSI controllers", 
    "comments": [
        {
            "content": "There can be at most 15 virtual disk attached on an SCSi controller, so if the limitation is reached, a new controller should be automatically created.\n\nIn nova/virt/vmwareapi/vm_util.py:\n\ndef allocate_controller_key_and_unit_number(client_factory, devices,\n                                            adapter_type):\n    \"\"\"This function inspects the current set of hardware devices and returns\n    controller_key and unit_number that can be used for attaching a new virtual\n    disk to adapter with the given adapter_type.\n    \"\"\"\n    if devices.__class__.__name__ == \"ArrayOfVirtualDevice\":\n        devices = devices.VirtualDevice\n\n    taken = _find_allocated_slots(devices)\n\n    ret = None\n    if adapter_type == 'ide':\n        ide_keys = [dev.key for dev in devices if _is_ide_controller(dev)]\n        ret = _find_controller_slot(ide_keys, taken, 2)\n    elif adapter_type in ['lsiLogic', 'lsiLogicsas', 'busLogic','paraVirtual']:\n        scsi_keys = [dev.key for dev in devices if _is_scsi_controller(dev)]\n        ret = _find_controller_slot(scsi_keys, taken, 16)\n    if ret:\n        return ret[0], ret[1], None\n\n    # create new controller with the specified type and return its spec\n    controller_key = -101\n    controller_spec = create_controller_spec(client_factory, controller_key,\n                                             adapter_type)\n    return controller_key, 0, controller_spec\n\nHere we can see, if 'ret' is None, a 'create_controller_spec' is generated for the creation of a new controller.\nI tested this function, and I check the value of 'vmdk_attach_config_spec.deviceChange'\n[(VirtualDeviceConfigSpec){\n   dynamicType = None\n   dynamicProperty[] = <empty>\n   operation = \"add\"\n   fileOperation = \"create\"\n   device =\n      (VirtualDisk){\n         dynamicType = None\n         dynamicProperty[] = <empty>\n         key = -100\n         deviceInfo =\n            (Description){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               label = None\n               summary = None\n            }\n         backing =\n            (VirtualDiskRawDiskMappingVer1BackingInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               fileName = \"\"\n               datastore =\n                  (ManagedObjectReference){\n                     value = None\n                     _type = \"\"\n                  }\n               backingObjectId = None\n               lunUuid = None\n               deviceName = \"/vmfs/devices/disks/t10.IET_____001000010000000000000000000000000000000000000000\"\n               compatibilityMode = \"physicalMode\"\n               diskMode = \"independent_persistent\"\n               uuid = None\n               contentId = None\n               changeId = None\n               parent =\n                  (VirtualDiskRawDiskMappingVer1BackingInfo){\n                     dynamicType = None\n                     dynamicProperty[] = <empty>\n                     fileName = None\n                     datastore =\n                        (ManagedObjectReference){\n                           value = None\n                           _type = \"\"\n                        }\n                     backingObjectId = None\n                     lunUuid = None\n                     deviceName = None\n                     compatibilityMode = None\n                     diskMode = None\n                     uuid = None\n                     contentId = None\n                     changeId = None\n                  }\n            }\n         connectable =\n            (VirtualDeviceConnectInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               startConnected = True\n               allowGuestControl = False\n               connected = True\n               status = None\n            }\n         slotInfo =\n            (VirtualDeviceBusSlotInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n            }\n         controllerKey = -101\n         unitNumber = 0\n         capacityInKB = 0\n         capacityInBytes = None\n         shares =\n            (SharesInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               shares = None\n               level =\n                  (SharesLevel){\n                     value = None\n                  }\n            }\n         storageIOAllocation =\n            (StorageIOAllocationInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               limit = None\n               shares =\n                  (SharesInfo){\n                     dynamicType = None\n                     dynamicProperty[] = <empty>\n                     shares = None\n                     level =\n                        (SharesLevel){\n                           value = None\n                        }\n                  }\n               reservation = None\n            }\n         diskObjectId = None\n         vFlashCacheConfigInfo =\n            (VirtualDiskVFlashCacheConfigInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               vFlashModule = None\n               reservationInMB = None\n               cacheConsistencyType = None\n               cacheMode = None\n               blockSizeInKB = None\n            }\n      }\n   profile[] = <empty>\n }, (VirtualDeviceConfigSpec){\n   dynamicType = None\n   dynamicProperty[] = <empty>\n   operation = \"add\"\n   fileOperation =\n      (VirtualDeviceConfigSpecFileOperation){\n         value = None\n      }\n   device =\n      (ParaVirtualSCSIController){\n         dynamicType = None\n         dynamicProperty[] = <empty>\n         key = -101\n         deviceInfo =\n            (Description){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               label = None\n               summary = None\n            }\n         backing =\n            (VirtualDeviceBackingInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n            }\n         connectable =\n            (VirtualDeviceConnectInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               startConnected = None\n               allowGuestControl = None\n               connected = None\n               status = None\n            }\n         slotInfo =\n            (VirtualDeviceBusSlotInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n            }\n         controllerKey = None\n         unitNumber = None\n         busNumber = 0\n         device[] = <empty>\n         hotAddRemove = None\n         sharedBus = \"noSharing\"\n         scsiCtlrUnitNumber = None\n      }\n   profile[] = <empty>\n }]\n\nIt really seems a request for creating a new controller, and then attach the virtual disk to it.\n\nBut I met errors after this.\nIn an icehouse environment, it is reported as \"VMwareDriverException: Cannot modify existing SCSI device\"\nIn a kilo environment, it is reported as \"VMwareDriverException: Number of virtual devices exceeds the maximum for a given controller.\"\n(their controller types are different, I don't know if this is the reason of the difference of the error messages)\n\nSo, is this a bug?", 
            "date_created": "2015-12-03 02:54:15.483705+00:00", 
            "author": "https://api.launchpad.net/1.0/~zzbj"
        }, 
        {
            "content": "Volume vmdk is attached to the instance in the Nova driver.", 
            "date_created": "2015-12-03 08:19:27.355069+00:00", 
            "author": "https://api.launchpad.net/1.0/~vbala"
        }, 
        {
            "content": "in a conclusion, my questions are:\n1.\nIs it designed to create a new controller when all existing controllers all reach their limits?\n2.\nIf the answer of question 1 is yes, is this function tested to work?\n3.\nIf the answers of question 1 and 2 are both yes, is my situation can be regarded as a bug?", 
            "date_created": "2015-12-08 09:11:18.028173+00:00", 
            "author": "https://api.launchpad.net/1.0/~zzbj"
        }, 
        {
            "content": "Here is the controller spec used for creating a new controller.\n\ncontroller_spec : (VirtualDeviceConfigSpec){\n   dynamicType = None\n   dynamicProperty[] = <empty>\n   operation = \"add\"\n   fileOperation = \n      (VirtualDeviceConfigSpecFileOperation){\n         value = None\n      }\n   device = \n      (VirtualLsiLogicController){\n         dynamicType = None\n         dynamicProperty[] = <empty>\n         key = -101\n         deviceInfo = \n            (Description){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               label = None\n               summary = None\n            }\n         backing = \n            (VirtualDeviceBackingInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n            }\n         connectable = \n            (VirtualDeviceConnectInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               startConnected = None\n               allowGuestControl = None\n               connected = None\n               status = None\n            }\n         slotInfo = \n            (VirtualDeviceBusSlotInfo){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n            }\n         controllerKey = None\n         unitNumber = None\n         busNumber = 0\n         device[] = <empty>\n         hotAddRemove = None\n         sharedBus = \"noSharing\"\n         scsiCtlrUnitNumber = None\n      }\n   profile[] = <empty>\n } ;", 
            "date_created": "2016-01-04 06:24:18.513818+00:00", 
            "author": "https://api.launchpad.net/1.0/~zzbj"
        }, 
        {
            "content": "Here is the vmdk_attach_config_spec.deviceChange before appending the controller spec above.\n\n   deviceChange[] = \n      (VirtualDeviceConfigSpec){\n         dynamicType = None\n         dynamicProperty[] = <empty>\n         operation = \"add\"\n         fileOperation = \n            (VirtualDeviceConfigSpecFileOperation){\n               value = None\n            }\n         device = \n            (VirtualDisk){\n               dynamicType = None\n               dynamicProperty[] = <empty>\n               key = -100\n               deviceInfo = \n                  (Description){\n                     dynamicType = None\n                     dynamicProperty[] = <empty>\n                     label = None\n                     summary = None\n                  }\n               backing = \n                  (VirtualDiskFlatVer2BackingInfo){\n                     dynamicType = None\n                     dynamicProperty[] = <empty>\n                     fileName = \"[Silver_VA10-Development-07_SVC-C11_003] volume-876b285b-3969-40e6-b353-4f7c08da7827/volume-876b285b-3969-40e6-b353-4f7c08da7827.vmdk\"\n                     datastore = \n                        (ManagedObjectReference){\n                           value = None\n                           _type = \"\"\n                        }\n                     backingObjectId = None\n                     diskMode = \"persistent\"\n                     split = None\n                     writeThrough = None\n                     thinProvisioned = True\n                     eagerlyScrub = None\n                     uuid = None\n                     contentId = None\n                     changeId = None\n                     parent = \n                        (VirtualDiskFlatVer2BackingInfo){\n                           dynamicType = None\n                           dynamicProperty[] = <empty>\n                           fileName = None\n                           datastore = \n                              (ManagedObjectReference){\n                                 value = None\n                                 _type = \"\"\n                              }\n                           backingObjectId = None\n                           diskMode = None\n                           split = None\n                           writeThrough = None\n                           thinProvisioned = None\n                           eagerlyScrub = None\n                           uuid = None\n                           contentId = None\n                           changeId = None\n                           deltaDiskFormat = None\n                           digestEnabled = None\n                           deltaGrainSize = None\n                        }\n                     deltaDiskFormat = None\n                     digestEnabled = None\n                     deltaGrainSize = None\n                  }\n               connectable = \n                  (VirtualDeviceConnectInfo){\n                     dynamicType = None\n                     dynamicProperty[] = <empty>\n                     startConnected = True\n                     allowGuestControl = False\n                     connected = True\n                     status = None\n                  }\n               slotInfo = \n                  (VirtualDeviceBusSlotInfo){\n                     dynamicType = None\n                     dynamicProperty[] = <empty>\n                  }\n               controllerKey = -101\n               unitNumber = 0\n               capacityInKB = 0\n               capacityInBytes = None\n               shares = \n                  (SharesInfo){\n                     dynamicType = None\n                     dynamicProperty[] = <empty>\n                     shares = None\n                     level = \n                        (SharesLevel){\n                           value = None\n                        }\n                  }\n               storageIOAllocation = \n                  (StorageIOAllocationInfo){\n                     dynamicType = None\n                     dynamicProperty[] = <empty>\n                     limit = None\n                     shares = \n                        (SharesInfo){\n                           dynamicType = None\n                           dynamicProperty[] = <empty>\n                           shares = None\n                           level = \n                              (SharesLevel){\n                                 value = None\n                              }\n                        }\n                     reservation = None\n                  }\n               diskObjectId = None\n               vFlashCacheConfigInfo = \n                  (VirtualDiskVFlashCacheConfigInfo){\n                     dynamicType = None\n                     dynamicProperty[] = <empty>\n                     vFlashModule = None\n                     reservationInMB = None\n                     cacheConsistencyType = None\n                     cacheMode = None\n                     blockSizeInKB = None\n                  }\n            }\n         profile[] = <empty>", 
            "date_created": "2016-01-04 06:25:07.333161+00:00", 
            "author": "https://api.launchpad.net/1.0/~zzbj"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/272414", 
            "date_created": "2016-01-26 07:37:54.315546+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/272414\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b36da5dd037219ceb71c4c6ea6925d2eba6cd59b\nSubmitter: Jenkins\nBranch:    master\n\ncommit b36da5dd037219ceb71c4c6ea6925d2eba6cd59b\nAuthor: Feng Xi Yan <email address hidden>\nDate:   Tue Jan 26 15:13:36 2016 +0800\n\n    <VMWare> Allocate free bus for new SCSI controller\n    \n    There are at most 16 virtual disks that can be attached onto a SCSI\n    controller, while if the limitation is reached, error occurs\n    with message \"VMwareDriverException: Invalid configuration for\n    device '0'\".\n    \n    The reason is that when the controller's quota is used up, a new\n    controller will be created automatically, but the newly-created\n    one will try to use bus number 0, which is already used my existing\n    controller.\n    \n    This change will allocate a new free bus number for the newly-created\n    controller.\n    \n    Co-Authored-By: Qiaowei Ren <email address hidden>\n    \n    Closes bug: #1522232\n    \n    Change-Id: I2ced1358e682cda979d1d5bddb6359253699280b\n", 
            "date_created": "2016-03-29 14:58:50.922313+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/liberty\nReview: https://review.openstack.org/299089", 
            "date_created": "2016-03-30 02:09:39.418601+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/mitaka\nReview: https://review.openstack.org/303995", 
            "date_created": "2016-04-11 09:57:19.170054+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/303995\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=be033eef7296d132c8f7eb5e42203f5a3a947de6\nSubmitter: Jenkins\nBranch:    stable/mitaka\n\ncommit be033eef7296d132c8f7eb5e42203f5a3a947de6\nAuthor: Feng Xi Yan <email address hidden>\nDate:   Tue Jan 26 15:13:36 2016 +0800\n\n    <VMWare> Allocate free bus for new SCSI controller\n    \n    There are at most 16 virtual disks that can be attached onto a SCSI\n    controller, while if the limitation is reached, error occurs\n    with message \"VMwareDriverException: Invalid configuration for\n    device '0'\".\n    \n    The reason is that when the controller's quota is used up, a new\n    controller will be created automatically, but the newly-created\n    one will try to use bus number 0, which is already used my existing\n    controller.\n    \n    This change will allocate a new free bus number for the newly-created\n    controller.\n    \n    Co-Authored-By: Qiaowei Ren <email address hidden>\n    \n    Closes bug: #1522232\n    \n    Change-Id: I2ced1358e682cda979d1d5bddb6359253699280b\n    (cherry picked from commit b36da5dd037219ceb71c4c6ea6925d2eba6cd59b)\n", 
            "date_created": "2016-04-21 15:04:31.617358+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/299089\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=f593d90f7d0c02726fdfce24b29e163f1f55b707\nSubmitter: Jenkins\nBranch:    stable/liberty\n\ncommit f593d90f7d0c02726fdfce24b29e163f1f55b707\nAuthor: Feng Xi Yan <email address hidden>\nDate:   Tue Jan 26 15:13:36 2016 +0800\n\n    <VMWare> Allocate free bus for new SCSI controller\n    \n    There are at most 16 virtual disks that can be attached onto a SCSI\n    controller, while if the limitation is reached, error occurs\n    with message \"VMwareDriverException: Invalid configuration for\n    device '0'\".\n    \n    The reason is that when the controller's quota is used up, a new\n    controller will be created automatically, but the newly-created\n    one will try to use bus number 0, which is already used my existing\n    controller.\n    \n    This change will allocate a new free bus number for the newly-created\n    controller.\n    \n    Co-Authored-By: Qiaowei Ren <email address hidden>\n    \n    Closes bug: #1522232\n    \n    Change-Id: I2ced1358e682cda979d1d5bddb6359253699280b\n    (cherry picked from commit b36da5dd037219ceb71c4c6ea6925d2eba6cd59b)\n", 
            "date_created": "2016-05-11 20:15:56.721799+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b1 development milestone.", 
            "date_created": "2016-06-02 19:35:20.020299+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 12.0.4 release.", 
            "date_created": "2016-06-08 21:35:50.002457+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.1.0 release.", 
            "date_created": "2016-06-14 15:42:15.694499+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }
    ]
}