{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:53:22.461827+00:00", 
    "description": "When I'm tracking stuff through the volume logs, sometimes the request_id, user_id and project_id are missing:\n\n2012-02-28 14:33:14 DEBUG nova.rpc.common [-] received {u'_context_roles': [u'Admin', u'Admin', u'admin'], u'_context_request_id': u'req-38167a3a-c4d2-4e02-b\n023-4f0f4636ec25', u'_context_read_deleted': u'no', u'args': {u'snapshot_id': None, u'volume_id': 26}, u'_context_auth_token': u'999888777666', u'_context_st\nrategy': u'keystone', u'_context_is_admin': True, u'_context_project_id': u'12345', u'_context_timestamp': u'2012-02-28T19:33:14.361743', u'_context_user_id'\n: u'0747b73bf9404bfaae6c810837241d8e', u'method': u'create_volume', u'_context_remote_address': u'10.6.60.211'} from (pid=3934) _safe_log /usr/lib/python2.6/\ndist-packages/nova/rpc/common.py:144\n2012-02-28 14:33:14 DEBUG nova.rpc.common [req-38167a3a-c4d2-4e02-b023-4f0f4636ec25 0747b73bf9404bfaae6c810837241d8e 12345] unpacked context: {'request_id': \nu'req-38167a3a-c4d2-4e02-b023-4f0f4636ec25', 'user_id': u'0747b73bf9404bfaae6c810837241d8e', 'roles': [u'Admin', u'Admin', u'admin'], 'timestamp': '2012-02-2\n8T19:33:14.361743', 'is_admin': True, 'auth_token': u'999888777666', 'project_id': u'12345', 'remote_address': u'10.6.60.211', 'read_deleted': u'no', 'strate\ngy': u'keystone'} from (pid=3934) unpack_context /usr/lib/python2.6/dist-packages/nova/rpc/amqp.py:186\n2012-02-28 14:33:14 INFO nova.volume.manager [-] volume volume-0000001a: creating\n2012-02-28 14:33:14 DEBUG nova.volume.manager [-] volume volume-0000001a: creating lv of size 10G from (pid=3934) create_volume /usr/lib/python2.6/dist-packa\nges/nova/volume/manager.py:120\n2012-02-28 14:33:14 DEBUG nova.volume.manager [-] volume volume-0000001a: creating export from (pid=3934) create_volume /usr/lib/python2.6/dist-packages/nova\n/volume/manager.py:131\n2012-02-28 14:33:14 DEBUG nova.volume.manager [-] volume volume-0000001a: created successfully from (pid=3934) create_volume /usr/lib/python2.6/dist-packages\n/nova/volume/manager.py:145\n\n\nYou can see the [req_id user_id project_id] in the rpc.common \"unpacked context\" line - but the subsequent \"nova.volume.manager\" log lines just say [-].\n\nThis makes it really hard to troubleshoot when lots of stuff is going on...", 
    "tags": [
        "volumes"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/942918", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 942918, 
    "index": 599, 
    "created": "2012-02-28 22:05:22.624035+00:00", 
    "title": "logs in greenthreads don't log request_id", 
    "comments": [
        {
            "content": "When I'm tracking stuff through the volume logs, sometimes the request_id, user_id and project_id are missing:\n\n2012-02-28 14:33:14 DEBUG nova.rpc.common [-] received {u'_context_roles': [u'Admin', u'Admin', u'admin'], u'_context_request_id': u'req-38167a3a-c4d2-4e02-b\n023-4f0f4636ec25', u'_context_read_deleted': u'no', u'args': {u'snapshot_id': None, u'volume_id': 26}, u'_context_auth_token': u'999888777666', u'_context_st\nrategy': u'keystone', u'_context_is_admin': True, u'_context_project_id': u'12345', u'_context_timestamp': u'2012-02-28T19:33:14.361743', u'_context_user_id'\n: u'0747b73bf9404bfaae6c810837241d8e', u'method': u'create_volume', u'_context_remote_address': u'10.6.60.211'} from (pid=3934) _safe_log /usr/lib/python2.6/\ndist-packages/nova/rpc/common.py:144\n2012-02-28 14:33:14 DEBUG nova.rpc.common [req-38167a3a-c4d2-4e02-b023-4f0f4636ec25 0747b73bf9404bfaae6c810837241d8e 12345] unpacked context: {'request_id': \nu'req-38167a3a-c4d2-4e02-b023-4f0f4636ec25', 'user_id': u'0747b73bf9404bfaae6c810837241d8e', 'roles': [u'Admin', u'Admin', u'admin'], 'timestamp': '2012-02-2\n8T19:33:14.361743', 'is_admin': True, 'auth_token': u'999888777666', 'project_id': u'12345', 'remote_address': u'10.6.60.211', 'read_deleted': u'no', 'strate\ngy': u'keystone'} from (pid=3934) unpack_context /usr/lib/python2.6/dist-packages/nova/rpc/amqp.py:186\n2012-02-28 14:33:14 INFO nova.volume.manager [-] volume volume-0000001a: creating\n2012-02-28 14:33:14 DEBUG nova.volume.manager [-] volume volume-0000001a: creating lv of size 10G from (pid=3934) create_volume /usr/lib/python2.6/dist-packa\nges/nova/volume/manager.py:120\n2012-02-28 14:33:14 DEBUG nova.volume.manager [-] volume volume-0000001a: creating export from (pid=3934) create_volume /usr/lib/python2.6/dist-packages/nova\n/volume/manager.py:131\n2012-02-28 14:33:14 DEBUG nova.volume.manager [-] volume volume-0000001a: created successfully from (pid=3934) create_volume /usr/lib/python2.6/dist-packages\n/nova/volume/manager.py:145\n\n\nYou can see the [req_id user_id project_id] in the rpc.common \"unpacked context\" line - but the subsequent \"nova.volume.manager\" log lines just say [-].\n\nThis makes it really hard to troubleshoot when lots of stuff is going on...", 
            "date_created": "2012-02-28 22:05:22.624035+00:00", 
            "author": "https://api.launchpad.net/1.0/~clay-gerrard"
        }, 
        {
            "content": "is this fairly current code? There was an issue where elevated() was overwriting the context that we fixed a while ago.", 
            "date_created": "2012-02-28 22:19:49.196251+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Fairly recent, yeah.\n\nI pulled down master and looked at some of the log lines in volume/manager.py\n\nand it seems like they're missing a kwarg for context:\n\n        LOG.info(_(\"volume %s: creating\"), volume_ref['name'])\n\nwhere as in compute/manager.py you see:\n\n        LOG.audit(_('Attaching volume %(volume_id)s to %(mountpoint)s'),\n                  locals(), context=context, instance=instance_ref)\n\n", 
            "date_created": "2012-02-29 03:11:13.105262+00:00", 
            "author": "https://api.launchpad.net/1.0/~clay-gerrard"
        }, 
        {
            "content": "We have a local greenthread storage for the current context.  It should be pulling the context object out of there if it isn't passed in.\nNot sure what is going on here.\n\nVish\n\nOn Feb 28, 2012, at 7:11 PM, clayg wrote:\n\n> Fairly recent, yeah.\n> \n> I pulled down master and looked at some of the log lines in\n> volume/manager.py\n> \n> and it seems like they're missing a kwarg for context:\n> \n>        LOG.info(_(\"volume %s: creating\"), volume_ref['name'])\n> \n> where as in compute/manager.py you see:\n> \n>        LOG.audit(_('Attaching volume %(volume_id)s to %(mountpoint)s'),\n>                  locals(), context=context, instance=instance_ref)\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/942918\n> \n> Title:\n>  nova-volume doesn't log request_id\n> \n> Status in OpenStack Compute (Nova):\n>  New\n> \n> Bug description:\n>  When I'm tracking stuff through the volume logs, sometimes the\n>  request_id, user_id and project_id are missing:\n> \n>  2012-02-28 14:33:14 DEBUG nova.rpc.common [-] received {u'_context_roles': [u'Admin', u'Admin', u'admin'], u'_context_request_id': u'req-38167a3a-c4d2-4e02-b\n>  023-4f0f4636ec25', u'_context_read_deleted': u'no', u'args': {u'snapshot_id': None, u'volume_id': 26}, u'_context_auth_token': u'999888777666', u'_context_st\n>  rategy': u'keystone', u'_context_is_admin': True, u'_context_project_id': u'12345', u'_context_timestamp': u'2012-02-28T19:33:14.361743', u'_context_user_id'\n>  : u'0747b73bf9404bfaae6c810837241d8e', u'method': u'create_volume', u'_context_remote_address': u'10.6.60.211'} from (pid=3934) _safe_log /usr/lib/python2.6/\n>  dist-packages/nova/rpc/common.py:144\n>  2012-02-28 14:33:14 DEBUG nova.rpc.common [req-38167a3a-c4d2-4e02-b023-4f0f4636ec25 0747b73bf9404bfaae6c810837241d8e 12345] unpacked context: {'request_id': \n>  u'req-38167a3a-c4d2-4e02-b023-4f0f4636ec25', 'user_id': u'0747b73bf9404bfaae6c810837241d8e', 'roles': [u'Admin', u'Admin', u'admin'], 'timestamp': '2012-02-2\n>  8T19:33:14.361743', 'is_admin': True, 'auth_token': u'999888777666', 'project_id': u'12345', 'remote_address': u'10.6.60.211', 'read_deleted': u'no', 'strate\n>  gy': u'keystone'} from (pid=3934) unpack_context /usr/lib/python2.6/dist-packages/nova/rpc/amqp.py:186\n>  2012-02-28 14:33:14 INFO nova.volume.manager [-] volume volume-0000001a: creating\n>  2012-02-28 14:33:14 DEBUG nova.volume.manager [-] volume volume-0000001a: creating lv of size 10G from (pid=3934) create_volume /usr/lib/python2.6/dist-packa\n>  ges/nova/volume/manager.py:120\n>  2012-02-28 14:33:14 DEBUG nova.volume.manager [-] volume volume-0000001a: creating export from (pid=3934) create_volume /usr/lib/python2.6/dist-packages/nova\n>  /volume/manager.py:131\n>  2012-02-28 14:33:14 DEBUG nova.volume.manager [-] volume volume-0000001a: created successfully from (pid=3934) create_volume /usr/lib/python2.6/dist-packages\n>  /nova/volume/manager.py:145\n> \n> \n>  You can see the [req_id user_id project_id] in the rpc.common \"unpacked context\" line - but the subsequent \"nova.volume.manager\" log lines just say [-].\n> \n>  This makes it really hard to troubleshoot when lots of stuff is going\n>  on...\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/942918/+subscriptions\n\n", 
            "date_created": "2012-02-29 04:59:01+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Hmm... yeah ok, thanks - I see that now.  Looks legit.\n\nI'll double check I can duplicate the issue against master - thanks for pointing me in the right direction.", 
            "date_created": "2012-02-29 15:51:46.616678+00:00", 
            "author": "https://api.launchpad.net/1.0/~clay-gerrard"
        }, 
        {
            "content": "Theirry,  Thanks for reminding me that this is still an issue:\n\n\n2012-03-15 14:09:12 DEBUG nova.rpc.amqp [-] received {u'_context_roles': [u'admin'], u'_context_request_id': u'req-c4d4f382-5a8d-4be9-b633-21c20981973a', u'_context_read_deleted': u'no', u'args': {u'snapshot_id': None, u'volume_id': 1}, u'_context_auth_token': None, u'_context_is_admin': True, u'_context_project_id': u'dev1', u'_context_timestamp': u'2012-03-15T19:09:12.667410', u'_context_user_id': u'admin', u'method': u'create_volume', u'_context_remote_address': u'127.0.0.1'} from (pid=3947) _safe_log /opt/nova/nova/rpc/common.py:144\n2012-03-15 14:09:12 DEBUG nova.rpc.amqp [req-c4d4f382-5a8d-4be9-b633-21c20981973a admin dev1] unpacked context: {'request_id': u'req-c4d4f382-5a8d-4be9-b633-21c20981973a', 'user_id': u'admin', 'roles': [u'admin'], 'timestamp': '2012-03-15T19:09:12.667410', 'is_admin': True, 'auth_token': None, 'project_id': u'dev1', 'remote_address': u'127.0.0.1', 'read_deleted': u'no'} from (pid=3947) unpack_context /opt/nova/nova/rpc/amqp.py:188\n2012-03-15 14:09:12 INFO nova.volume.manager [-] volume volume-00000001: creating\n2012-03-15 14:09:12 DEBUG nova.volume.manager [-] volume volume-00000001: creating lv of size 1G from (pid=3947) create_volume /opt/nova/nova/volume/manager.py:120\n2012-03-15 14:09:13 DEBUG nova.volume.manager [-] volume volume-00000001: creating export from (pid=3947) create_volume /opt/nova/nova/volume/manager.py:131\n2012-03-15 14:09:13 DEBUG nova.volume.manager [-] volume volume-00000001: created successfully from (pid=3947) create_volume /opt/nova/nova/volume/manager.py:145\n\n\nI'll dig into it a bit more and try to figure out why the context thread local stuff isn't cutting it - I may be able to point someone in the right direction - but I was really hoping a nova dev with some experience would be able to pitch in cause this bug is real pain.", 
            "date_created": "2012-03-15 19:11:19.547976+00:00", 
            "author": "https://api.launchpad.net/1.0/~clay-gerrard"
        }, 
        {
            "content": "This is up to date trunk at time of writing - commit 97eb92880e0886a3f257f32a88ba9e55b8ec8a90\n\nPlease do let me know if this is not something that others are able to duplicate?", 
            "date_created": "2012-03-15 19:12:30.403581+00:00", 
            "author": "https://api.launchpad.net/1.0/~clay-gerrard"
        }, 
        {
            "content": "Oh ok, it wasn't so bad.\n\nThe RequestContext class sets the local when it's created (in rpc when it's unpacking it off the bus) - then the rpc passes off to it's \"proxy\" by spawning a greenthread to run _process_data.\n\nSo either _process_data needs to reset the local - or it can just want to RpcContext.from_dict until after it's spanwned?", 
            "date_created": "2012-03-15 19:43:31.530239+00:00", 
            "author": "https://api.launchpad.net/1.0/~clay-gerrard"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/5412", 
            "date_created": "2012-03-15 20:05:43.326635+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/5412\nCommitted: http://github.com/openstack/nova/commit/4012a3f792ca5958616b31f7594f200d18665d71\nSubmitter: Jenkins\nBranch:    master\n\ncommit 4012a3f792ca5958616b31f7594f200d18665d71\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Thu Mar 15 13:02:07 2012 -0700\n\n    Keep context for logging intact in greenthreads\n    \n     * fixes bug 942918\n    \n    Change-Id: Ia0fcf459c53b95a8675472adcfbba08014e34e5b\n", 
            "date_created": "2012-03-15 20:50:22.054235+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}