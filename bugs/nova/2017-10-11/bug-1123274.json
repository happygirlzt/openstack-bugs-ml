{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:16:33.665112+00:00", 
    "description": "I am using openstack-ubuntu-testing-grizzly and I have this problem when booting from volumes, this was working well before but seems to have broken in the last 72 hours.\n\nbooting from local storage works fine but when trying to boot from volume, libvirt complains that the instance-xxxxxxxx directory does not exist:\n\n2013-02-12 12:36:05.860 ERROR nova.compute.manager [req-808284f5-5641-4fd6-b8fd-733f243e49da 8636766bc6b342539a9c1b0e3e0c24cc 24e6c25ee7bf4f5bbcd19c53bbe84f37] [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94] Instance failed to spawn\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94] Traceback (most recent call last):\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 985, in _spawn\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     block_device_info)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1200, in spawn\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     block_device_info)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2082, in _create_domain_and_network\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     domain = self._create_domain(xml, instance=instance)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2043, in _create_domain\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     domain.createWithFlags(launch_flags)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 187, in doit\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 147, in proxy_call\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     rv = execute(f,*args,**kwargs)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 76, in tworker\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     rv = meth(*args,**kwargs)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 650, in createWithFlags\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94] libvirtError: Unable to pre-create chardev file '/var/lib/nova/instances/instance-00000122/console.log': No such file or directory\n\n\nAgain, this is only when booting from volume.\n\nBoris", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1123274", 
    "owner": "https://api.launchpad.net/1.0/~ndipanov", 
    "id": 1123274, 
    "index": 963, 
    "created": "2013-02-12 17:40:02.802032+00:00", 
    "title": "Unable to pre-create chardev file when booting from volume", 
    "comments": [
        {
            "content": "I am using openstack-ubuntu-testing-grizzly and I have this problem when booting from volumes, this was working well before but seems to have broken in the last 72 hours.\n\nbooting from local storage works fine but when trying to boot from volume, libvirt complains that the instance-xxxxxxxx directory does not exist:\n\n2013-02-12 12:36:05.860 ERROR nova.compute.manager [req-808284f5-5641-4fd6-b8fd-733f243e49da 8636766bc6b342539a9c1b0e3e0c24cc 24e6c25ee7bf4f5bbcd19c53bbe84f37] [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94] Instance failed to spawn\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94] Traceback (most recent call last):\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 985, in _spawn\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     block_device_info)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1200, in spawn\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     block_device_info)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2082, in _create_domain_and_network\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     domain = self._create_domain(xml, instance=instance)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2043, in _create_domain\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     domain.createWithFlags(launch_flags)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 187, in doit\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 147, in proxy_call\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     rv = execute(f,*args,**kwargs)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/eventlet/tpool.py\", line 76, in tworker\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     rv = meth(*args,**kwargs)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 650, in createWithFlags\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94]     if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\n2013-02-12 12:36:05.860 23382 TRACE nova.compute.manager [instance: 0d17dae7-66e8-491d-8727-77ba163dfb94] libvirtError: Unable to pre-create chardev file '/var/lib/nova/instances/instance-00000122/console.log': No such file or directory\n\n\nAgain, this is only when booting from volume.\n\nBoris", 
            "date_created": "2013-02-12 17:40:02.802032+00:00", 
            "author": "https://api.launchpad.net/1.0/~boris-michel-deschenes"
        }, 
        {
            "content": "is https://bugs.launchpad.net/nova/+bug/984996 related to this?", 
            "date_created": "2013-02-12 19:25:19.401894+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "could very well be the same thing, this is with KVM and libvirt as well", 
            "date_created": "2013-02-13 13:10:34.230968+00:00", 
            "author": "https://api.launchpad.net/1.0/~boris-michel-deschenes"
        }, 
        {
            "content": "Can you attach your libvirt log file when this happens?", 
            "date_created": "2013-02-14 14:56:21.702112+00:00", 
            "author": "https://api.launchpad.net/1.0/~zulcss"
        }, 
        {
            "content": "I'm sorry, I don't have much logs in libvirt...\n\nI temporarily fixed this problem by adding a manual (additional) directory creation in the spawn function of nova/virt/libvrti/driver.py (around line 1200), so my guess is that the problem is the workflow does not create the directory soon enough...\n\n\n\n    def spawn(self, context, instance, image_meta, injected_files,\n              admin_password, network_info=None, block_device_info=None):\n        disk_info = blockinfo.get_disk_info(CONF.libvirt_type,\n                                            instance,\n                                            block_device_info,\n                                            image_meta)\n        xml = self.to_xml(instance, network_info,\n                          disk_info, image_meta,\n                          block_device_info=block_device_info)\n        if image_meta:\n            self._create_image(context, instance, xml,\n                               disk_info['mapping'],\n                               network_info=network_info,\n                               block_device_info=block_device_info,\n                               files=injected_files,\n                               admin_pass=admin_password)\n        #\n        # MANUAL DIRECTORY CREATION\n        #\n        instance_dir = libvirt_utils.get_instance_path(instance)\n        if not os.path.exists(instance_dir):\n            os.mkdir(instance_dir)\n        #\n        # END", 
            "date_created": "2013-02-14 16:09:12.821045+00:00", 
            "author": "https://api.launchpad.net/1.0/~boris-michel-deschenes"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/23818", 
            "date_created": "2013-03-07 15:15:36.177380+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/23818\nCommitted: http://github.com/openstack/nova/commit/3133096f2bf2c8de04c70c3f3209d727a4c8cfb3\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3133096f2bf2c8de04c70c3f3209d727a4c8cfb3\nAuthor: Nikola Dipanov <email address hidden>\nDate:   Thu Mar 7 15:54:07 2013 +0100\n\n    Libvirt driver create images even without meta\n    \n    This patch allows the libvirt driver to call _create_image and\n    create instance directory and other needed images even when there is no\n    image metadata specified.\n    \n    As an added bonus, this patch refactors the code of _create_image\n    method a bit to make it more clear to the reader when some of the images\n    will and will not be created, especially with regard to booting from\n    volume.\n    \n    Fixes bug: 1124441\n    Fixes bug: 1131913\n    Fixes bug: 1123274\n    \n    blueprint: improve-boot-from-volume\n    \n    Change-Id: I5a028dc0585876d35be4fb86df3a423d89e054ee\n", 
            "date_created": "2013-03-11 17:34:58.568321+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}