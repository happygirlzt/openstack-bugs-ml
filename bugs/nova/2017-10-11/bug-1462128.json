{
    "status": "Fix Released", 
    "last_updated": "2016-01-21 23:18:01.637179+00:00", 
    "description": "In cells, when a delete request comes in before an instance has been scheduled, cells will broadcast a \"delete everywhere\" to delete the instance in all cells. During the delete code path in compute, instance.save() attempts to save some state along the way before instance.destroy(). If there isn't an instance record in the child database, the FK constraint to save state (for example, flavor), will fail and DBReference error will be raised by oslo.db. In cells, InstanceNotFound is caught and handled for these scenarios. Since a FK constraint failure does mean the instance doesn't exist, it would make sense to raise InstanceNotFound for DBReferenceError.\n\nLogstash query:\n\nmessage:\"DBReferenceError\" AND build_name:\"check-tempest-dsvm-cells\"\n\nExample trace:\n\nhttp://logs.openstack.org/49/188249/2/check/check-tempest-dsvm-cells/a74468a/logs/screen-n-cell-child.txt.gz#_2015-06-04_07_22_45_806\n\n2015-06-04 07:22:45.806 ERROR nova.cells.messaging [req-388635a4-8e75-4986-af34-99e6eca82f3b ServersNegativeTestJSON-34383368 ServersNegativeTestJSON-350156579] Error processing message locally\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging Traceback (most recent call last):\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/cells/messaging.py\", line 201, in _process_locally\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     resp_value = self.msg_runner._process_message_locally(self)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/cells/messaging.py\", line 1277, in _process_message_locally\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return fn(message, **message.method_kwargs)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/cells/messaging.py\", line 1090, in instance_delete_everywhere\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     self.compute_api.delete(message.ctxt, instance)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 227, in wrapped\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return func(self, context, target, *args, **kwargs)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 216, in inner\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return function(self, context, instance, *args, **kwargs)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 244, in _wrapped\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return fn(self, context, instance, *args, **kwargs)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 197, in inner\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return f(self, context, instance, *args, **kw)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1820, in delete\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     self._delete_instance(context, instance)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1810, in _delete_instance\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     task_state=task_states.DELETING)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1622, in _delete\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     quotas.rollback()\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 119, in __exit__\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     six.reraise(self.type_, self.value, self.tb)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1538, in _delete\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     instance.save()\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/objects/base.py\", line 205, in wrapper\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return fn(self, *args, **kwargs)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 826, in save\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     getattr(self, '_save_%s' % field)(context)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 716, in _save_flavor\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     {'flavor': jsonutils.dumps(flavor_info)})\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/db/api.py\", line 919, in instance_extra_update_by_uuid\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     updates)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 2643, in instance_extra_update_by_uuid\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     _instance_extra_create(context, create_values)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 2631, in _instance_extra_create\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     inst_extra_ref.save()\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/db/sqlalchemy/models.py\", line 82, in save\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     super(NovaBase, self).save(session=session)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/models.py\", line 48, in save\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     session.flush()\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1985, in flush\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     self._flush(objects)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 2103, in _flush\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     transaction.rollback(_capture_exception=True)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/langhelpers.py\", line 60, in __exit__\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     compat.reraise(exc_type, exc_value, exc_tb)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 2067, in _flush\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     flush_context.execute()\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/unitofwork.py\", line 372, in execute\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     rec.execute(self)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/unitofwork.py\", line 526, in execute\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     uow\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 65, in save_obj\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     mapper, table, insert)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 602, in _emit_insert_statements\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     execute(statement, params)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 841, in execute\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return meth(self, multiparams, params)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py\", line 322, in _execute_on_connection\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return connection._execute_clauseelement(self, multiparams, params)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 938, in _execute_clauseelement\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     compiled_sql, distilled_params\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1070, in _execute_context\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     context)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/compat/handle_error.py\", line 155, in _handle_dbapi_exception\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     e, statement, parameters, cursor, context)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1267, in _handle_dbapi_exception\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     util.raise_from_cause(newraise, exc_info)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 199, in raise_from_cause\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     reraise(type(exception), exception, tb=exc_tb)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1063, in _execute_context\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     context)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 442, in do_execute\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     cursor.execute(statement, parameters)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/MySQLdb/cursors.py\", line 174, in execute\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     self.errorhandler(self, exc, value)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     raise errorclass, errorvalue\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging DBReferenceError: (IntegrityError) (1452, 'Cannot add or update a child row: a foreign key constraint fails (`nova_cell`.`instance_extra`, CONSTRAINT `instance_extra_instance_uuid_fkey` FOREIGN KEY (`instance_uuid`) REFERENCES `instances` (`uuid`))') 'INSERT INTO instance_extra (created_at, updated_at, deleted_at, deleted, instance_uuid, numa_topology, pci_requests, flavor, vcpu_model) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)' (datetime.datetime(2015, 6, 4, 7, 22, 45, 797823), None, None, 0, '29f21049-ae1d-492f-a7f4-616b57abc755', None, None, '{\"new\": null, \"old\": null, \"cur\": {\"nova_object.version\": \"1.1\", \"nova_object.name\": \"Flavor\", \"nova_object.data\": {\"disabled\": false, \"root_gb\": 0, \"name\": \"m1.nano\", \"flavorid\": \"42\", \"deleted\": false, \"created_at\": \"2015-06-04T07:19:00Z\", \"ephemeral_gb\": 0, \"updated_at\": null, \"memory_mb\": 64, \"vcpus\": 1, \"extra_specs\": {}, \"swap\": 0, \"rxtx_factor\": 1.0, \"is_public\": true, \"deleted_at\": null, \"vcpu_weight\": 0, \"id\": 6}, \"nova_object.namespace\": \"nova\"}}', None)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging", 
    "tags": [
        "cells"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1462128", 
    "owner": "https://api.launchpad.net/1.0/~melwitt", 
    "id": 1462128, 
    "index": 486, 
    "created": "2015-06-04 22:07:00.187720+00:00", 
    "title": "Cells: DBReferenceError possible deleting unscheduled instance", 
    "comments": [
        {
            "content": "In cells, when a delete request comes in before an instance has been scheduled, cells will broadcast a \"delete everywhere\" to delete the instance in all cells. During the delete code path in compute, instance.save() attempts to save some state along the way before instance.destroy(). If there isn't an instance record in the child database, the FK constraint to save state (for example, flavor), will fail and DBReference error will be raised by oslo.db. In cells, InstanceNotFound is caught and handled for these scenarios. Since a FK constraint failure does mean the instance doesn't exist, it would make sense to raise InstanceNotFound for DBReferenceError.\n\nLogstash query:\n\nmessage:\"DBReferenceError\" AND build_name:\"check-tempest-dsvm-cells\"\n\nExample trace:\n\nhttp://logs.openstack.org/49/188249/2/check/check-tempest-dsvm-cells/a74468a/logs/screen-n-cell-child.txt.gz#_2015-06-04_07_22_45_806\n\n2015-06-04 07:22:45.806 ERROR nova.cells.messaging [req-388635a4-8e75-4986-af34-99e6eca82f3b ServersNegativeTestJSON-34383368 ServersNegativeTestJSON-350156579] Error processing message locally\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging Traceback (most recent call last):\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/cells/messaging.py\", line 201, in _process_locally\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     resp_value = self.msg_runner._process_message_locally(self)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/cells/messaging.py\", line 1277, in _process_message_locally\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return fn(message, **message.method_kwargs)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/cells/messaging.py\", line 1090, in instance_delete_everywhere\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     self.compute_api.delete(message.ctxt, instance)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 227, in wrapped\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return func(self, context, target, *args, **kwargs)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 216, in inner\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return function(self, context, instance, *args, **kwargs)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 244, in _wrapped\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return fn(self, context, instance, *args, **kwargs)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 197, in inner\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return f(self, context, instance, *args, **kw)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1820, in delete\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     self._delete_instance(context, instance)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1810, in _delete_instance\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     task_state=task_states.DELETING)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1622, in _delete\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     quotas.rollback()\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 119, in __exit__\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     six.reraise(self.type_, self.value, self.tb)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1538, in _delete\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     instance.save()\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/objects/base.py\", line 205, in wrapper\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return fn(self, *args, **kwargs)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 826, in save\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     getattr(self, '_save_%s' % field)(context)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 716, in _save_flavor\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     {'flavor': jsonutils.dumps(flavor_info)})\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/db/api.py\", line 919, in instance_extra_update_by_uuid\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     updates)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 2643, in instance_extra_update_by_uuid\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     _instance_extra_create(context, create_values)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 2631, in _instance_extra_create\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     inst_extra_ref.save()\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/opt/stack/new/nova/nova/db/sqlalchemy/models.py\", line 82, in save\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     super(NovaBase, self).save(session=session)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/models.py\", line 48, in save\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     session.flush()\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1985, in flush\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     self._flush(objects)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 2103, in _flush\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     transaction.rollback(_capture_exception=True)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/langhelpers.py\", line 60, in __exit__\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     compat.reraise(exc_type, exc_value, exc_tb)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 2067, in _flush\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     flush_context.execute()\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/unitofwork.py\", line 372, in execute\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     rec.execute(self)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/unitofwork.py\", line 526, in execute\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     uow\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 65, in save_obj\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     mapper, table, insert)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 602, in _emit_insert_statements\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     execute(statement, params)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 841, in execute\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return meth(self, multiparams, params)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py\", line 322, in _execute_on_connection\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     return connection._execute_clauseelement(self, multiparams, params)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 938, in _execute_clauseelement\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     compiled_sql, distilled_params\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1070, in _execute_context\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     context)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/compat/handle_error.py\", line 155, in _handle_dbapi_exception\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     e, statement, parameters, cursor, context)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1267, in _handle_dbapi_exception\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     util.raise_from_cause(newraise, exc_info)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 199, in raise_from_cause\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     reraise(type(exception), exception, tb=exc_tb)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1063, in _execute_context\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     context)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 442, in do_execute\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     cursor.execute(statement, parameters)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/MySQLdb/cursors.py\", line 174, in execute\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     self.errorhandler(self, exc, value)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging     raise errorclass, errorvalue\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging DBReferenceError: (IntegrityError) (1452, 'Cannot add or update a child row: a foreign key constraint fails (`nova_cell`.`instance_extra`, CONSTRAINT `instance_extra_instance_uuid_fkey` FOREIGN KEY (`instance_uuid`) REFERENCES `instances` (`uuid`))') 'INSERT INTO instance_extra (created_at, updated_at, deleted_at, deleted, instance_uuid, numa_topology, pci_requests, flavor, vcpu_model) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)' (datetime.datetime(2015, 6, 4, 7, 22, 45, 797823), None, None, 0, '29f21049-ae1d-492f-a7f4-616b57abc755', None, None, '{\"new\": null, \"old\": null, \"cur\": {\"nova_object.version\": \"1.1\", \"nova_object.name\": \"Flavor\", \"nova_object.data\": {\"disabled\": false, \"root_gb\": 0, \"name\": \"m1.nano\", \"flavorid\": \"42\", \"deleted\": false, \"created_at\": \"2015-06-04T07:19:00Z\", \"ephemeral_gb\": 0, \"updated_at\": null, \"memory_mb\": 64, \"vcpus\": 1, \"extra_specs\": {}, \"swap\": 0, \"rxtx_factor\": 1.0, \"is_public\": true, \"deleted_at\": null, \"vcpu_weight\": 0, \"id\": 6}, \"nova_object.namespace\": \"nova\"}}', None)\n2015-06-04 07:22:45.806 16038 ERROR nova.cells.messaging", 
            "date_created": "2015-06-04 22:07:00.187720+00:00", 
            "author": "https://api.launchpad.net/1.0/~melwitt"
        }, 
        {
            "content": "Review at https://review.openstack.org/#/c/188261/", 
            "date_created": "2015-06-04 22:17:23.452596+00:00", 
            "author": "https://api.launchpad.net/1.0/~melwitt"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/188261\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=5f869d0c04271d4fa058843eebe56e0bd524b12b\nSubmitter: Jenkins\nBranch:    master\n\ncommit 5f869d0c04271d4fa058843eebe56e0bd524b12b\nAuthor: melanie witt <email address hidden>\nDate:   Thu Jun 4 02:38:13 2015 +0000\n\n    Raise InstanceNotFound when save FK constraint fails\n    \n    Currently, in the Instance.save method, if an ObjectField is dirty,\n    it will be updated in the db before the instance record is updated\n    (separate transaction). If the instance does not have a row, the\n    foreign key constraint fails and DBReferenceError is raised from\n    oslo.db. This scenario can happen in cells if an instance delete\n    request comes in before it's scheduled, during the broadcast to\n    delete in all cells. This is expected and InstanceNotFound is\n    caught and handled.\n    \n    This change catches DBReferenceError and raises InstanceNotFound.\n    \n    Closes-Bug: #1462128\n    \n    Change-Id: I821f8c121760e0fb74d7ae5c680bd0c361f92128\n", 
            "date_created": "2015-06-05 03:24:25.260491+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/227451", 
            "date_created": "2015-09-24 18:24:52.283943+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/228660", 
            "date_created": "2015-09-28 23:13:13.619411+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/227451\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d864603c9df0552441312243ecc4452ed0c96272\nSubmitter: Jenkins\nBranch:    stable/kilo\n\ncommit d864603c9df0552441312243ecc4452ed0c96272\nAuthor: melanie witt <email address hidden>\nDate:   Thu Jun 4 02:38:13 2015 +0000\n\n    Raise InstanceNotFound when save FK constraint fails\n    \n    Currently, in the Instance.save method, if an ObjectField is dirty,\n    it will be updated in the db before the instance record is updated\n    (separate transaction). If the instance does not have a row, the\n    foreign key constraint fails and DBReferenceError is raised from\n    oslo.db. This scenario can happen in cells if an instance delete\n    request comes in before it's scheduled, during the broadcast to\n    delete in all cells. This is expected and InstanceNotFound is\n    caught and handled.\n    \n    This change catches DBReferenceError and raises InstanceNotFound.\n    \n    Conflicts:\n            nova/tests/unit/objects/test_instance.py\n    \n    NOTE(mriedem): The test conflict is because we don't have commit\n    6d6fdeeff880cc5fe8edcc24ef94d3bc4ca924e2 in stable/kilo and that's\n    not needed for this bug fix.\n    \n    Closes-Bug: #1462128\n    \n    Change-Id: I821f8c121760e0fb74d7ae5c680bd0c361f92128\n    (cherry picked from commit 5f869d0c04271d4fa058843eebe56e0bd524b12b)\n", 
            "date_created": "2015-09-30 21:58:56.587378+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/228660\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=881488c5d5d9d52cf0b38c35cb929cffa0bcd70d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 881488c5d5d9d52cf0b38c35cb929cffa0bcd70d\nAuthor: melanie witt <email address hidden>\nDate:   Mon Sep 28 20:22:37 2015 +0000\n\n    Check DBReferenceError foreign key in Instance.save\n    \n    In commit 5f869d0c04271d4fa058843eebe56e0bd524b12b handling of\n    DBReferenceError from oslo.db was added to raise InstanceNotFound.\n    However, if the target row has foreign key constraints to other\n    tables, the DBReferenceError raised doesn't necessarily imply that\n    the instance row is missing.\n    \n    This change adds a check on the key attribute in the DBReferenceError\n    exception object and raises InstanceNotFound only if the key is\n    'instance_uuid' -- otherwise, it reraises DBReferenceError.\n    \n    Related-Bug: #1462128\n    Related-Bug: #1497076\n    \n    Change-Id: I131dbc27639626e89735ac0591dc266f35e6ac80\n", 
            "date_created": "2015-10-06 00:27:56.612041+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}