{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:10:58.261734+00:00", 
    "description": "The call to get_instance_nw_info fails with an error if a network is deleted during the deallocation. Networks are not supposed to be able to be deleted if they have fixed ips in use, but there is a race where a network can be deleted while an allocation is still in process. This is make many times worse by the fact that get_instance_nw_info makes 3*networks + 1 (db + rpc) calls. This should be converted to a) get everything in a single db request, b) handle networks not existing gracefully.\n\nThe traceback from get_nw_info failing can look like:\n\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 242, in deallocate_fixed_ip\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     address, instance=instance)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 931, in deallocate_fixed_ip\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     instance_uuid)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 395, in _do_trigger_security_group_members_refresh_for_instance\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     None, None)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/server.py\", line 139, in inner\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     return func(*args, **kwargs)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 602, in get_instance_nw_info\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     rxtx_factor, host)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 625, in build_network_info_model\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     instance_host)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 701, in _get_subnets_from_network\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     network['project_id'], network['uuid'], vif.uuid)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/nova_ipam_lib.py\", line 46, in get_subnets_by_net_id\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     n = network_obj.Network.get_by_uuid(context.elevated(), net_id)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/objects/base.py\", line 110, in wrapper\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     args, kwargs)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/conductor/rpcapi.py\", line 425, in object_class_action\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     objver=objver, args=args, kwargs=kwargs)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 150, in call\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     wait_for_reply=True, timeout=timeout)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     timeout=timeout)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 412, in send\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 405, in _send\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     raise result\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher NetworkNotFoundForUUID_Remote: Network could not be found for uuid 3af0a6e6-59f8-4d7e-90ec-b5b866f578f8\n\nor:\n\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 242, in deallocate_fixed_ip\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     address, instance=instance)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 931, in deallocate_fixed_ip\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     instance_uuid)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 395, in _do_trigger_security_group_members_refresh_for_instance\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     None, None)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/server.py\", line 139, in inner\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     return func(*args, **kwargs)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 598, in get_instance_nw_info\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     network = self._get_network_by_id(context, vif.network_id)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1445, in _get_network_by_id\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     project_only='allow_none')\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/objects/base.py\", line 110, in wrapper\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     args, kwargs)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/conductor/rpcapi.py\", line 425, in object_class_action\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     objver=objver, args=args, kwargs=kwargs)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 150, in call\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     wait_for_reply=True, timeout=timeout)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     timeout=timeout)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 412, in send\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 405, in _send\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     raise result\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher NetworkNotFound_Remote: Network 23 could not be found.\n\ndepending on where in the call stack the race occurs.", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1365606", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 1365606, 
    "index": 1593, 
    "created": "2014-09-04 17:27:25.192602+00:00", 
    "title": "Network deallocation can fail if a network has been deleted", 
    "comments": [
        {
            "content": "The call to get_instance_nw_info fails with an error if a network is deleted during the deallocation. Networks are not supposed to be able to be deleted if they have fixed ips in use, but there is a race where a network can be deleted while an allocation is still in process. This is make many times worse by the fact that get_instance_nw_info makes 3*networks + 1 (db + rpc) calls. This should be converted to a) get everything in a single db request, b) handle networks not existing gracefully.\n\nThe traceback from get_nw_info failing can look like:\n\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 242, in deallocate_fixed_ip\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     address, instance=instance)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 931, in deallocate_fixed_ip\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     instance_uuid)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 395, in _do_trigger_security_group_members_refresh_for_instance\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     None, None)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/server.py\", line 139, in inner\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     return func(*args, **kwargs)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 602, in get_instance_nw_info\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     rxtx_factor, host)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 625, in build_network_info_model\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     instance_host)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 701, in _get_subnets_from_network\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     network['project_id'], network['uuid'], vif.uuid)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/nova_ipam_lib.py\", line 46, in get_subnets_by_net_id\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     n = network_obj.Network.get_by_uuid(context.elevated(), net_id)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/objects/base.py\", line 110, in wrapper\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     args, kwargs)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/conductor/rpcapi.py\", line 425, in object_class_action\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     objver=objver, args=args, kwargs=kwargs)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 150, in call\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     wait_for_reply=True, timeout=timeout)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     timeout=timeout)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 412, in send\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 405, in _send\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher     raise result\n2014-09-03 23:45:03.060 10725 TRACE oslo.messaging.rpc.dispatcher NetworkNotFoundForUUID_Remote: Network could not be found for uuid 3af0a6e6-59f8-4d7e-90ec-b5b866f578f8\n\nor:\n\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 242, in deallocate_fixed_ip\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     address, instance=instance)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 931, in deallocate_fixed_ip\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     instance_uuid)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 395, in _do_trigger_security_group_members_refresh_for_instance\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     None, None)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/server.py\", line 139, in inner\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     return func(*args, **kwargs)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 598, in get_instance_nw_info\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     network = self._get_network_by_id(context, vif.network_id)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1445, in _get_network_by_id\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     project_only='allow_none')\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/objects/base.py\", line 110, in wrapper\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     args, kwargs)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/conductor/rpcapi.py\", line 425, in object_class_action\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     objver=objver, args=args, kwargs=kwargs)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 150, in call\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     wait_for_reply=True, timeout=timeout)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     timeout=timeout)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 412, in send\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 405, in _send\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher     raise result\n2014-09-03 23:57:39.153 10725 TRACE oslo.messaging.rpc.dispatcher NetworkNotFound_Remote: Network 23 could not be found.\n\ndepending on where in the call stack the race occurs.", 
            "date_created": "2014-09-04 17:27:25.192602+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "make that 4*networks + 1 (db + rpc) calls:\n\nget all vifs (1):\nfor each vif: (there is 1 vif per network)\n  get network (1 * networks)\n  get network AGAIN (1 * networks)\n  get vif AGAIN ( 1 * networks)\n  get fixed_ip (1 * networks)", 
            "date_created": "2014-09-04 17:32:56.963128+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I've always been a huge advocate of one get call per network_info blob. My first OpenStack talk was about that actually. I can't wait.", 
            "date_created": "2014-09-04 20:43:51.327615+00:00", 
            "author": "https://api.launchpad.net/1.0/~tr3buchet"
        }, 
        {
            "content": "Hi Vish, a while ago I worked on a fix for a) to reduce the number of db calls but for some reason never got to the point where I submitted anything. I have rebased and submitted it as a series of wip patches, at https://review.openstack.org/119237 that you can look at.\n\nBtw. I think it is even worse. There are calls to get floating ips as well.", 
            "date_created": "2014-09-04 22:58:08.663081+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanlind"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/119521", 
            "date_created": "2014-09-06 02:11:55.588540+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/119522", 
            "date_created": "2014-09-06 02:12:05.419714+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/119523", 
            "date_created": "2014-09-06 02:12:15.550382+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hans, I just saw your patches. My version is up for review now as well. I based them on top of some other object changes I have under review I will look through your changes to see if I missed anything.", 
            "date_created": "2014-09-06 02:15:05.663717+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "your code looks very similar although I took it a step further and joined the vif and network as well. This gets the whole thing down to a single request.", 
            "date_created": "2014-09-06 02:36:03.244628+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/119521\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=31b0961c856339bc4844977790a3c17606e3281b\nSubmitter: Jenkins\nBranch:    master\n\ncommit 31b0961c856339bc4844977790a3c17606e3281b\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Thu Sep 4 23:25:32 2014 -0700\n\n    Use database joins for fixed ips to other objects\n    \n    Many of the fixed ip related calls are extremely inefficient. This\n    joins a couple of calls so that we can optimize queries that use\n    them.\n    \n    Change-Id: Ifa2e4c6ac517286f7ae952052d29801b45a6b6b2\n    Partial-bug: #1365606\n", 
            "date_created": "2014-10-11 19:30:19.397575+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/119522\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=2a38de9408ff1259d5d11f25e6ca4bbe3d72fad3\nSubmitter: Jenkins\nBranch:    master\n\ncommit 2a38de9408ff1259d5d11f25e6ca4bbe3d72fad3\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Fri Sep 5 00:32:32 2014 -0700\n\n    Convert migrate reqeusts to use joins\n    \n    The modifications to add joins for fixed_ip_requests allows us to\n    condense three network calls into one for both start and finish\n    migration.\n    \n    Change-Id: I61ca03661f722c6406d39021b79a648f4374dfcd\n    Partial-bug: #1365606\n", 
            "date_created": "2014-10-11 19:30:45.895831+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/119523\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=44c648f205941d5491a527cef47113a963ad69ca\nSubmitter: Jenkins\nBranch:    master\n\ncommit 44c648f205941d5491a527cef47113a963ad69ca\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Fri Sep 5 02:46:44 2014 -0700\n\n    Optimize get_instance_nw_info and remove ipam\n    \n    The get network info was making 4 * num_networks + 1 rpc and db\n    queries. The network info is recalculated quite often, so we use\n    the new joins to turn this into a single query. In the process we\n    remove nova_ipam_lib which was initially created as part of a very\n    old neutron proxy and only added an unnecessary layer of abstraction.\n    \n    Change-Id: I34ca575fb33b43ab8780357990b73df837da71c2\n    Closes-Bug: #1365606\n", 
            "date_created": "2014-10-16 05:53:50.974785+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}