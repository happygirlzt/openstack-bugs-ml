{
    "status": "Fix Released", 
    "last_updated": "2014-12-03 09:20:02.136495+00:00", 
    "description": "Running one controller and one compute, using nova-network version 2011.3~rc~20110909.r1155-0ub  on Oneiric . Repeating the following:\n\nCreate four instances, terminate them.\n\nThis mostly works but one in every three or four times, one of the vms does not come up and I see this error in the nova-network log. This can occur both in the controller node (also running compute) or the compute node.  (contents of nova.conf follows)\n\n2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab semaphore \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:672\n2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab file lock \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:677\n2011-09-20 13:22:59,296 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t filter from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-20 13:22:59,311 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-20 13:22:59,350 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t nat from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-20 13:22:59,366 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-20 13:22:59,424 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\n(nova.rpc): TRACE:     ctxt.reply(None, None)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\n(nova.rpc): TRACE:     msg_reply(self.msg_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\n(nova.rpc): TRACE:     conn.direct_send(msg_id, msg)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\n(nova.rpc): TRACE:     self._done()\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\n(nova.rpc): TRACE:     self.connection.reset()\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\n(nova.rpc): TRACE:     self.channel.close()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\n(nova.rpc): TRACE:     (20, 41),    # Channel.close_ok\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\n(nova.rpc): TRACE:     return self.dispatch_method(method_sig, args, content)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\n(nova.rpc): TRACE:     return amqp_method(self, args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\n(nova.rpc): TRACE:     (class_id, method_id))\n(nova.rpc): TRACE: AMQPChannelException: (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish')\n(nova.rpc): TRACE: \n2011-09-20 13:22:59,451 ERROR nova.rpc [-] Returning exception (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish') to caller\n2011-09-20 13:22:59,452 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\\n    ctxt.reply(None, None)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\\n    msg_reply(self.msg_id, *args, **kwargs)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\\n    conn.direct_send(msg_id, msg)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\\n    self._done()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\\n    self.connection.reset()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\\n    self.channel.close()\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\\n    (20, 41),    # Channel.close_ok\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\\n    return self.dispatch_method(method_sig, args, content)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\\n    return amqp_method(self, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\\n    (class_id, method_id))\\n', 'AMQPChannelException: (404, u\"NOT_FOUND - no exchange \\'3ff1ba7e274a4ec2a2b0a217d7532c70\\' in vhost \\'/\\'\", (60, 40), \\'Channel.basic_publish\\')\\n']\n\n\nI also see this at the same time in the rabbitmq log:\n\n=ERROR REPORT==== 20-Sep-2011::13:22:59 ===\nconnection <0.1061.0>, channel 1 - error:\n{amqp_error,not_found,\n            \"no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\",\n            'basic.publish'}\n\n\n\n\n--flagfile=/etc/nova/nova-compute.conf\n--use_deprecated_auth\n--dhcpbridge_flagfile=/etc/nova/nova.conf\n--dhcpbridge=/usr/bin/nova-dhcpbridge\n--sql_connection=mysql://nova:notnova@172.18.0.141/nova\n--s3_host=172.18.0.141\n--rabbit_host=172.18.0.141\n--glance_api_servers=172.18.0.141:9292\n--logdir=/var/log/nova\n--state_path=/var/lib/nova\n--lock_path=/var/lock/nova\n--verbose\n--ec2_url=http://172.18.0.141:8773/services/Cloud\n--dmz_cidr=172.18.0.141/32\n--fixed_range=172.18.77.0/27\n--network_size=8\n--flat_network_dhcp_start=172.18.7.6\n--image_service=nova.image.glance.GlanceImageService\n--bridge_interface=eth1\n--flat_network_bridge=br100\n--network_manager=nova.network.manager.FlatDHCPManager\n--public_interface=eth0\n--multi_host\n--osapi_host=172.18.0.141", 
    "tags": [
        "in-stable-diablo"
    ], 
    "importance": "Critical", 
    "heat": 20, 
    "link": "https://bugs.launchpad.net/nova/+bug/855030", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 855030, 
    "index": 34, 
    "created": "2011-09-20 20:03:44.298823+00:00", 
    "title": "Encountering sporadic AMQPChannelException", 
    "comments": [
        {
            "content": "Running one controller and one compute, using nova-network version 2011.3~rc~20110909.r1155-0ub  on Oneiric . Repeating the following:\n\nCreate four instances, terminate them.\n\nThis mostly works but one in every three or four times, one of the vms does not come up and I see this error in the nova-network log. This can occur both in the controller node (also running compute) or the compute node.  (contents of nova.conf follows)\n\n2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab semaphore \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:672\n2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab file lock \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:677\n2011-09-20 13:22:59,296 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t filter from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-20 13:22:59,311 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-20 13:22:59,350 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t nat from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-20 13:22:59,366 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-20 13:22:59,424 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\n(nova.rpc): TRACE:     ctxt.reply(None, None)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\n(nova.rpc): TRACE:     msg_reply(self.msg_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\n(nova.rpc): TRACE:     conn.direct_send(msg_id, msg)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\n(nova.rpc): TRACE:     self._done()\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\n(nova.rpc): TRACE:     self.connection.reset()\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\n(nova.rpc): TRACE:     self.channel.close()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\n(nova.rpc): TRACE:     (20, 41),    # Channel.close_ok\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\n(nova.rpc): TRACE:     return self.dispatch_method(method_sig, args, content)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\n(nova.rpc): TRACE:     return amqp_method(self, args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\n(nova.rpc): TRACE:     (class_id, method_id))\n(nova.rpc): TRACE: AMQPChannelException: (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish')\n(nova.rpc): TRACE: \n2011-09-20 13:22:59,451 ERROR nova.rpc [-] Returning exception (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish') to caller\n2011-09-20 13:22:59,452 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\\n    ctxt.reply(None, None)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\\n    msg_reply(self.msg_id, *args, **kwargs)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\\n    conn.direct_send(msg_id, msg)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\\n    self._done()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\\n    self.connection.reset()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\\n    self.channel.close()\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\\n    (20, 41),    # Channel.close_ok\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\\n    return self.dispatch_method(method_sig, args, content)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\\n    return amqp_method(self, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\\n    (class_id, method_id))\\n', 'AMQPChannelException: (404, u\"NOT_FOUND - no exchange \\'3ff1ba7e274a4ec2a2b0a217d7532c70\\' in vhost \\'/\\'\", (60, 40), \\'Channel.basic_publish\\')\\n']\n\n\nI also see this at the same time in the rabbitmq log:\n\n=ERROR REPORT==== 20-Sep-2011::13:22:59 ===\nconnection <0.1061.0>, channel 1 - error:\n{amqp_error,not_found,\n            \"no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\",\n            'basic.publish'}\n\n\n\n\n--flagfile=/etc/nova/nova-compute.conf\n--use_deprecated_auth\n--dhcpbridge_flagfile=/etc/nova/nova.conf\n--dhcpbridge=/usr/bin/nova-dhcpbridge\n--sql_connection=mysql://nova:notnova@172.18.0.141/nova\n--s3_host=172.18.0.141\n--rabbit_host=172.18.0.141\n--glance_api_servers=172.18.0.141:9292\n--logdir=/var/log/nova\n--state_path=/var/lib/nova\n--lock_path=/var/lock/nova\n--verbose\n--ec2_url=http://172.18.0.141:8773/services/Cloud\n--dmz_cidr=172.18.0.141/32\n--fixed_range=172.18.77.0/27\n--network_size=8\n--flat_network_dhcp_start=172.18.7.6\n--image_service=nova.image.glance.GlanceImageService\n--bridge_interface=eth1\n--flat_network_bridge=br100\n--network_manager=nova.network.manager.FlatDHCPManager\n--public_interface=eth0\n--multi_host\n--osapi_host=172.18.0.141", 
            "date_created": "2011-09-20 20:03:44.298823+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Pretty interesting.  This has to be from an rpc.call.  The caller creates a queue for the response from the worker.  It appears the worker is not finding this queue when it goes to 'msg_reply'.\n\nThe only reasons I can think of how this could happen:\n\n1) After the caller publishes a request for a worker.... it is getting an exception during waiting for the response.  That would cause the queue to disappear.  (Seems unlikely)\n2) After the caller publishes a request for a worker... it gets disconnected from rabbit, which causes the queue to be deleted momentarily before it reconnects and re-declares it... and the worker tries to respond in the middle of this.  (Seems unlikely)\n3) rabbit is returning an ACK to the caller (amqplib) before it is actually finished creating the queue...  and there's a race condition where the worker tries to reply before the queue is created.  (Seems unlikely)\n4) kombu+amqplib randomly doesn't send a declare_queue() ?  Seems unlikely without an exception thrown.  And an exception would abort the publish to the worker. \n\nI wonder what I'm missing.  What version of kombu and what version of rabbit?   Have you tried falling back to carrot?  You can specify:  'rpc_backend=nova.rpc.impl_carrot' to try it.\n\n\n", 
            "date_created": "2011-09-20 20:46:20.773462+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "ii  python-kombu                 1.0.4-2                      AMQP Messaging Framework for Python\nii  rabbitmq-server              2.5.0-1ubuntu2               An AMQP server written in Erlang\n\nI added the carrot suggestion to nova.conf and it still fails about the same 1 in 20 or so vms not coming up but with a different error. I would be happy to help diagnose this if you have any other suggestions.\n\n\n\n\n2011-09-21 09:17:24,546 DEBUG nova.network.manager [db549763-93f2-444f-bdd8-d4931b2fa6c7 6deb27e2-4b73-4d73-8196-6ccdbcee6859 kranzproje\nct] network allocations for instance 108 from (pid=1096) allocate_for_instance /usr/lib/pymodules/python2.7/nova/network/manager.py:431\n2011-09-21 09:17:24,705 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_carrot.py\", line 285, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/network/manager.py\", line 216, in allocate_for_instance\n(nova.rpc): TRACE:     ips = super(FloatingIP, self).allocate_for_instance(context, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/network/manager.py\", line 438, in allocate_for_instance\n(nova.rpc): TRACE:     requested_networks=requested_networks)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/network/manager.py\", line 166, in _allocate_fixed_ips\n(nova.rpc): TRACE:     vpn=vpn, address=address)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/network/manager.py\", line 609, in allocate_fixed_ip\n(nova.rpc): TRACE:     instance_id)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/db/api.py\", line 343, in fixed_ip_associate_pool\n(nova.rpc): TRACE:     instance_id, host)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/db/sqlalchemy/api.py\", line 101, in wrapper\n(nova.rpc): TRACE:     return f(*args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/db/sqlalchemy/api.py\", line 720, in fixed_ip_associate_pool\n(nova.rpc): TRACE:     raise exception.NoMoreFixedIps()\n(nova.rpc): TRACE: NoMoreFixedIps: None\n(nova.rpc): TRACE: \n2011-09-21 09:17:24,739 ERROR nova.rpc [-] Returning exception None to caller\n2011-09-21 09:17:24,739 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_", 
            "date_created": "2011-09-21 13:22:39.831954+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "My apologies. The carrot test was not valid. The last error was caused by the fact that I was running out of fixed ip addresses. My guess is that when the instances that fail to come up are terminated, their IP addresses are not returned. I will continue to investigate on a clean install.", 
            "date_created": "2011-09-21 14:01:58.545395+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "I tried again on freshly reinstalled OS and the behavior is repeatable. I also saw one case where there was a slightly different AMPQ error that happened during instance termination:\n\nheadline:  AMQPConnectionException: (503, u\"COMMAND_INVALID - second 'channel.open' seen\", (20, 10), 'Channel.open')\n\n2011-09-21 11:33:05,739 DEBUG nova.utils [-] Attempting to grab semaphore \"get_dhcp\" for method \"_get_dhcp_ip\"... from (pid=1094) inner /usr/lib/pymodules/python2.7/nova/utils.py:672\n2011-09-21 11:33:05,746 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 626, in _process_data\n(nova.rpc): TRACE:     ctxt.reply(rval, None)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\n(nova.rpc): TRACE:     msg_reply(self.msg_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\n(nova.rpc): TRACE:     conn.direct_send(msg_id, msg)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\n(nova.rpc): TRACE:     self._done()\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\n(nova.rpc): TRACE:     self.connection.reset()\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 383, in reset\n(nova.rpc): TRACE:     self.channel = self.connection.channel()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/connection.py\", line 99, in channel\n(nova.rpc): TRACE:     return self.transport.create_channel(self.connection)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 197, in create_channel\n(nova.rpc): TRACE:     return connection.channel()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 130, in channel\n(nova.rpc): TRACE:     return Channel(self, channel_id)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 82, in __init__\n(nova.rpc): TRACE:     self._x_open()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 471, in _x_open\n(nova.rpc): TRACE:     (20, 11),    # Channel.open_ok\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 95, in wait\n(nova.rpc): TRACE:     self.channel_id, allowed_methods)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/connection.py\", line 231, in _wait_method\n(nova.rpc): TRACE:     self.wait()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\n(nova.rpc): TRACE:     return self.dispatch_method(method_sig, args, content)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\n(nova.rpc): TRACE:     return amqp_method(self, args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/connection.py\", line 380, in _close\n(nova.rpc): TRACE:     raise AMQPConnectionException(reply_code, reply_text, (class_id, method_id))\n(nova.rpc): TRACE: AMQPConnectionException: (503, u\"COMMAND_INVALID - second 'channel.open' seen\", (20, 10), 'Channel.open')\n(nova.rpc): TRACE:\n2011-09-21 11:33:05,780 ERROR nova.rpc [-] Returning exception (503, u\"COMMAND_INVALID - second 'channel.open' seen\", (20, 10), 'Channel.open') to caller\n2011-09-21 11:33:05,780 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 626, in _process_data\\n    ctxt.reply(rval, None)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\\n    msg_reply(self.msg_id, *args, **kwargs)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_\\\nkombu.py\", line 781, in msg_reply\\n    conn.direct_send(msg_id, msg)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\\n    self._done()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\\n    self.connection.reset()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 383, in reset\\n    self.ch\\\nannel = self.connection.channel()\\n', '  File \"/usr/lib/python2.7/dist-packages/kombu/connection.py\", line 99, in channel\\n    return self.transport.create_channel(self.connection)\\n', '  File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 197, in create_channel\\n    return connection.channel()\\n', '  File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqpli\\\nb.py\", line 130, in channel\\n    return Channel(self, channel_id)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 82, in __init__\\n    self._x_open()\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 471, in _x_open\\n    (20, 11),    # Channel.open_ok\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abst\\\nract_channel.py\", line 95, in wait\\n    self.channel_id, allowed_methods)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/connection.py\", line 231, in _wait_method\\n    self.wait()\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\\n    return self.dispatch_method(method_sig, args, content)\\n', '  File \"/usr/lib/pytho\\\nn2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\\n    return amqp_method(self, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/connection.py\", line 380, in _close\\n    raise AMQPConnectionException(reply_code, reply_text, (class_id, method_id))\\n', 'AMQPConnectionException: (503, u\"COMMAND_INVALID - second \\'channel.open\\' s\\\neen\", (20, 10), \\'Channel.open\\')\\n']\n", 
            "date_created": "2011-09-21 15:41:34.976879+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Looks likeyou are running out of ips.   Maybe you are running /27 which only has 32 addresses?\n\nOn Sep 21, 2011, at 6:22 AM, David Kranz wrote:\n\n> ii  python-kombu                 1.0.4-2                      AMQP Messaging Framework for Python\n> ii  rabbitmq-server              2.5.0-1ubuntu2               An AMQP server written in Erlang\n> \n> I added the carrot suggestion to nova.conf and it still fails about the\n> same 1 in 20 or so vms not coming up but with a different error. I would\n> be happy to help diagnose this if you have any other suggestions.\n> \n> \n> \n> 2011-09-21 09:17:24,546 DEBUG nova.network.manager [db549763-93f2-444f-bdd8-d4931b2fa6c7 6deb27e2-4b73-4d73-8196-6ccdbcee6859 kranzproje\n> ct] network allocations for instance 108 from (pid=1096) allocate_for_instance /usr/lib/pymodules/python2.7/nova/network/manager.py:431\n> 2011-09-21 09:17:24,705 ERROR nova.rpc [-] Exception during message handling\n> (nova.rpc): TRACE: Traceback (most recent call last):\n> (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_carrot.py\", line 285, in _process_data\n> (nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n> (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/network/manager.py\", line 216, in allocate_for_instance\n> (nova.rpc): TRACE:     ips = super(FloatingIP, self).allocate_for_instance(context, **kwargs)\n> (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/network/manager.py\", line 438, in allocate_for_instance\n> (nova.rpc): TRACE:     requested_networks=requested_networks)\n> (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/network/manager.py\", line 166, in _allocate_fixed_ips\n> (nova.rpc): TRACE:     vpn=vpn, address=address)\n> (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/network/manager.py\", line 609, in allocate_fixed_ip\n> (nova.rpc): TRACE:     instance_id)\n> (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/db/api.py\", line 343, in fixed_ip_associate_pool\n> (nova.rpc): TRACE:     instance_id, host)\n> (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/db/sqlalchemy/api.py\", line 101, in wrapper\n> (nova.rpc): TRACE:     return f(*args, **kwargs)\n> (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/db/sqlalchemy/api.py\", line 720, in fixed_ip_associate_pool\n> (nova.rpc): TRACE:     raise exception.NoMoreFixedIps()\n> (nova.rpc): TRACE: NoMoreFixedIps: None\n> (nova.rpc): TRACE: \n> 2011-09-21 09:17:24,739 ERROR nova.rpc [-] Returning exception None to caller\n> 2011-09-21 09:17:24,739 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_\n> \n> -- \n> You received this bug notification because you are a member of Nova Bug\n> Team, which is subscribed to OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/855030\n> \n> Title:\n>  Encountering sporadic AMQPChannelException\n> \n> Status in OpenStack Compute (Nova):\n>  New\n> \n> Bug description:\n>  Running one controller and one compute, using nova-network version\n>  2011.3~rc~20110909.r1155-0ub  on Oneiric . Repeating the following:\n> \n>  Create four instances, terminate them.\n> \n>  This mostly works but one in every three or four times, one of the vms\n>  does not come up and I see this error in the nova-network log. This\n>  can occur both in the controller node (also running compute) or the\n>  compute node.  (contents of nova.conf follows)\n> \n>  2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab semaphore \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:672\n>  2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab file lock \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:677\n>  2011-09-20 13:22:59,296 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t filter from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,311 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,350 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t nat from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,366 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,424 ERROR nova.rpc [-] Exception during message handling\n>  (nova.rpc): TRACE: Traceback (most recent call last):\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\n>  (nova.rpc): TRACE:     ctxt.reply(None, None)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\n>  (nova.rpc): TRACE:     msg_reply(self.msg_id, *args, **kwargs)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\n>  (nova.rpc): TRACE:     conn.direct_send(msg_id, msg)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\n>  (nova.rpc): TRACE:     self._done()\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\n>  (nova.rpc): TRACE:     self.connection.reset()\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\n>  (nova.rpc): TRACE:     self.channel.close()\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\n>  (nova.rpc): TRACE:     (20, 41),    # Channel.close_ok\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\n>  (nova.rpc): TRACE:     return self.dispatch_method(method_sig, args, content)\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\n>  (nova.rpc): TRACE:     return amqp_method(self, args)\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\n>  (nova.rpc): TRACE:     (class_id, method_id))\n>  (nova.rpc): TRACE: AMQPChannelException: (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish')\n>  (nova.rpc): TRACE: \n>  2011-09-20 13:22:59,451 ERROR nova.rpc [-] Returning exception (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish') to caller\n>  2011-09-20 13:22:59,452 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\\n    ctxt.reply(None, None)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\\n    msg_reply(self.msg_id, *args, **kwargs)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\\n    conn.direct_send(msg_id, msg)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\\n    self._done()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\\n    self.connection.reset()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\\n    self.channel.close()\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\\n    (20, 41),    # Channel.close_ok\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\\n    return self.dispatch_method(method_sig, args, content)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\\n    return amqp_method(self, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\\n    (class_id, method_id))\\n', 'AMQPChannelException: (404, u\"NOT_FOUND - no exchange \\'3ff1ba7e274a4ec2a2b0a217d7532c70\\' in vhost \\'/\\'\", (60, 40), \\'Channel.basic_publish\\')\\n']\n> \n> \n>  I also see this at the same time in the rabbitmq log:\n> \n>  =ERROR REPORT==== 20-Sep-2011::13:22:59 ===\n>  connection <0.1061.0>, channel 1 - error:\n>  {amqp_error,not_found,\n>              \"no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\",\n>              'basic.publish'}\n> \n> \n> \n>  --flagfile=/etc/nova/nova-compute.conf\n>  --use_deprecated_auth\n>  --dhcpbridge_flagfile=/etc/nova/nova.conf\n>  --dhcpbridge=/usr/bin/nova-dhcpbridge\n>  --sql_connection=mysql://nova:notnova@172.18.0.141/nova\n>  --s3_host=172.18.0.141\n>  --rabbit_host=172.18.0.141\n>  --glance_api_servers=172.18.0.141:9292\n>  --logdir=/var/log/nova\n>  --state_path=/var/lib/nova\n>  --lock_path=/var/lock/nova\n>  --verbose\n>  --ec2_url=http://172.18.0.141:8773/services/Cloud\n>  --dmz_cidr=172.18.0.141/32\n>  --fixed_range=172.18.77.0/27\n>  --network_size=8\n>  --flat_network_dhcp_start=172.18.7.6\n>  --image_service=nova.image.glance.GlanceImageService\n>  --bridge_interface=eth1\n>  --flat_network_bridge=br100\n>  --network_manager=nova.network.manager.FlatDHCPManager\n>  --public_interface=eth0\n>  --multi_host\n>  --osapi_host=172.18.0.141\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/855030/+subscriptions\n\n", 
            "date_created": "2011-09-21 16:00:05+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Yes, I am. I did not realize that the DHCP leases were not immediately marked as reusable when an instance is terminated. It seems that the default time is 2min and when I was doing rapid testing of this problem I exceeded 32 available. Anyway, I replaced kombu with carrot and was able to start up many, many instances without problems. I then switched back to kombu and the problem happened on the first shot after that. Not sure what more I can offer at this point...", 
            "date_created": "2011-09-21 17:36:02.449856+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Hmm..  Does this happen under load?   Is it just 4 instances one after another? \n\nAnother thing to check:  amqplib version:\n\n>>>\n>>> from amqplib.client_0_8 import connection\n>>> connection.LIBRARY_PROPERTIES\n{'library': 'Python amqplib', 'library_version': '1.0.0'}                       \u0001\n\nIt's possible carrot works with an older version, but kombu wants a newer version...", 
            "date_created": "2011-09-21 21:46:47.194785+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "Oh, and I was going to also suggest trying to remove the current kombu version and do a 'pip install kombu', which will grab the latest from pypi... and see if the issue goes away.  kombu is up to 1.3.* or something now.", 
            "date_created": "2011-09-21 21:48:29.324592+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "I'm kind of at a loss here. The ampqlib version is the same as you said. I used pip to uninstall kombu and upgrade to 1.3.5. That was the latest version this morning though the latest seems to be 1.4.0 right how. Anyway it made no difference. I am no expert on the mess that is the relationship between python package versions between pip and dpkg so it is possible nova was still using the old kombu after my upgrade. I don't think so because just invoking python from the command line showed the new version of kombu when I imported it. \n\nThis does happen under load in the sense that I used the euca command to create 4 instances at once. Has any one else done something like this with Oneiric?  On the one hand it is hard to see how I am having this problem if others are not, but I don't see what I could be doing wrong either given that everything works for instance creations where this does not happen.", 
            "date_created": "2011-09-22 18:11:10.675431+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Hmm,\n\nOne further question.  Are you using mysql or sqlite?  Sqlite doesn't really support concurrency well, so you could be getting db locking errors that are bubbling up to the messaging layer.  If you are using sqlite, could you see if you get the same error with mysql?\n\nOn Sep 22, 2011, at 11:11 AM, David Kranz wrote:\n\n> I'm kind of at a loss here. The ampqlib version is the same as you said.\n> I used pip to uninstall kombu and upgrade to 1.3.5. That was the latest\n> version this morning though the latest seems to be 1.4.0 right how.\n> Anyway it made no difference. I am no expert on the mess that is the\n> relationship between python package versions between pip and dpkg so it\n> is possible nova was still using the old kombu after my upgrade. I don't\n> think so because just invoking python from the command line showed the\n> new version of kombu when I imported it.\n> \n> This does happen under load in the sense that I used the euca command to\n> create 4 instances at once. Has any one else done something like this\n> with Oneiric?  On the one hand it is hard to see how I am having this\n> problem if others are not, but I don't see what I could be doing wrong\n> either given that everything works for instance creations where this\n> does not happen.\n> \n> -- \n> You received this bug notification because you are a member of Nova Bug\n> Team, which is subscribed to OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/855030\n> \n> Title:\n>  Encountering sporadic AMQPChannelException\n> \n> Status in OpenStack Compute (Nova):\n>  New\n> \n> Bug description:\n>  Running one controller and one compute, using nova-network version\n>  2011.3~rc~20110909.r1155-0ub  on Oneiric . Repeating the following:\n> \n>  Create four instances, terminate them.\n> \n>  This mostly works but one in every three or four times, one of the vms\n>  does not come up and I see this error in the nova-network log. This\n>  can occur both in the controller node (also running compute) or the\n>  compute node.  (contents of nova.conf follows)\n> \n>  2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab semaphore \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:672\n>  2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab file lock \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:677\n>  2011-09-20 13:22:59,296 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t filter from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,311 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,350 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t nat from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,366 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,424 ERROR nova.rpc [-] Exception during message handling\n>  (nova.rpc): TRACE: Traceback (most recent call last):\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\n>  (nova.rpc): TRACE:     ctxt.reply(None, None)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\n>  (nova.rpc): TRACE:     msg_reply(self.msg_id, *args, **kwargs)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\n>  (nova.rpc): TRACE:     conn.direct_send(msg_id, msg)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\n>  (nova.rpc): TRACE:     self._done()\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\n>  (nova.rpc): TRACE:     self.connection.reset()\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\n>  (nova.rpc): TRACE:     self.channel.close()\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\n>  (nova.rpc): TRACE:     (20, 41),    # Channel.close_ok\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\n>  (nova.rpc): TRACE:     return self.dispatch_method(method_sig, args, content)\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\n>  (nova.rpc): TRACE:     return amqp_method(self, args)\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\n>  (nova.rpc): TRACE:     (class_id, method_id))\n>  (nova.rpc): TRACE: AMQPChannelException: (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish')\n>  (nova.rpc): TRACE: \n>  2011-09-20 13:22:59,451 ERROR nova.rpc [-] Returning exception (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish') to caller\n>  2011-09-20 13:22:59,452 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\\n    ctxt.reply(None, None)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\\n    msg_reply(self.msg_id, *args, **kwargs)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\\n    conn.direct_send(msg_id, msg)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\\n    self._done()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\\n    self.connection.reset()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\\n    self.channel.close()\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\\n    (20, 41),    # Channel.close_ok\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\\n    return self.dispatch_method(method_sig, args, content)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\\n    return amqp_method(self, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\\n    (class_id, method_id))\\n', 'AMQPChannelException: (404, u\"NOT_FOUND - no exchange \\'3ff1ba7e274a4ec2a2b0a217d7532c70\\' in vhost \\'/\\'\", (60, 40), \\'Channel.basic_publish\\')\\n']\n> \n> \n>  I also see this at the same time in the rabbitmq log:\n> \n>  =ERROR REPORT==== 20-Sep-2011::13:22:59 ===\n>  connection <0.1061.0>, channel 1 - error:\n>  {amqp_error,not_found,\n>              \"no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\",\n>              'basic.publish'}\n> \n> \n> \n>  --flagfile=/etc/nova/nova-compute.conf\n>  --use_deprecated_auth\n>  --dhcpbridge_flagfile=/etc/nova/nova.conf\n>  --dhcpbridge=/usr/bin/nova-dhcpbridge\n>  --sql_connection=mysql://nova:notnova@172.18.0.141/nova\n>  --s3_host=172.18.0.141\n>  --rabbit_host=172.18.0.141\n>  --glance_api_servers=172.18.0.141:9292\n>  --logdir=/var/log/nova\n>  --state_path=/var/lib/nova\n>  --lock_path=/var/lock/nova\n>  --verbose\n>  --ec2_url=http://172.18.0.141:8773/services/Cloud\n>  --dmz_cidr=172.18.0.141/32\n>  --fixed_range=172.18.77.0/27\n>  --network_size=8\n>  --flat_network_dhcp_start=172.18.7.6\n>  --image_service=nova.image.glance.GlanceImageService\n>  --bridge_interface=eth1\n>  --flat_network_bridge=br100\n>  --network_manager=nova.network.manager.FlatDHCPManager\n>  --public_interface=eth0\n>  --multi_host\n>  --osapi_host=172.18.0.141\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/855030/+subscriptions\n\n", 
            "date_created": "2011-09-23 06:16:17+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I am using mysql. In case it matters I am running nova-network on both nodes and also nova-api on both nodes as suggested by you here http://osdir.com/ml/openstack-cloud-computing/2011-09/msg00283.html\n\nI did a fresh install using lucid and the same thing happens with one exception. On oneiric, the AMQP trace showing in the log is always associated with a vm never transitioning from pending to running. On lucid, I still sometimes see the error in the log but the VM does come up. \n\n\n\nThere must be some kind of race condition. Is there currently a test for nova that\n\n1. Deploys a multinode configuration\n2. Starts and terminates groups of vms for a long time, making sure they all end up running\n3. Also fails if any error is written to a log file\n\nAlso, I did the latest install using ppa:openstack-release/2011.3 but I sometimes see things like this in the log. I find these messages in bug tickets that seem like they were fixed for diablo so I am not sure why I see them:\n\nDBError: exceptions must be old-style classes or derived from BaseException, not NoneType\n\n", 
            "date_created": "2011-09-23 15:01:42.940549+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Hm.  I haven't used the multi host network stuff, myself, so I can't comment much on the above right now.\n\nThere _is_ a bug filed for the DBError above.  Unclear exactly what it is, but sqlalchemy is catching an exception, doing transaction cleanup, and then doing a re-raise via a bare raise.  Somewhere in sqlalchemy's transaction cleanup, the original exception is getting eaten, so the bare raise does a raise of NoneType.\n\nBTW, there is 1 case I can think of that could happen in the real world where the queue doesn't exist when doing a reply.  This can happen if a service makes an rpc.call that results in a long-running transaction.... and the original service is restarted before the long-running transaction completes.  I know this probably isn't what is happening in your case, but we probably should catch the AMQPChannelException for this case... \n\n", 
            "date_created": "2011-09-23 18:57:56.350602+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "381     def cursor(self, *args, **kwargs):\n382         try:\n383             c = self.connection.cursor(*args, **kwargs)\n384             return _CursorFairy(self, c)\n385         except Exception, e:\n386             self.invalidate(e=e)\n387             raise\n\nI expect the bare raise is here (sqlalchemy/pool.py).  Pretty sure self.invalidate is making socket connections, so the exception is getting eaten by eventlet.  I'm trying to investigate if there is a way to make eventlet not clear exception info.  This could be especially dangerous if the higher level code is trying to catch a specific type of exception.  Might be worth it to try one of the following things:\n\n1) Try to make eventlet stop eating exception info:\n\ndiff -r f30a2fa65f30 eventlet/hubs/hub.py\n--- a/eventlet/hubs/hub.py\tWed Jun 08 23:47:26 2011 -0700\n+++ b/eventlet/hubs/hub.py\tSat Sep 24 05:04:30 2011 -0700\n@@ -173,7 +173,7 @@\n                 cur.parent = self.greenlet\n         except ValueError:\n             pass  # gets raised if there is a greenlet parent cycle\n-        clear_sys_exc_info()\n+        #clear_sys_exc_info()\n         return self.greenlet.switch()\n \n     def squelch_exception(self, fileno, exc_info):\n\nor 2) modify the above code to reraise the exception\n\ndiff --git a/Library/Python/2.7/site-packages/sqlalchemy/pool.py b/pool.py\nindex 632d955..21e7055 100644\n--- a/Library/Python/2.7/site-packages/sqlalchemy/pool.py\n+++ b/pool.py\n@@ -383,8 +383,10 @@ class _ConnectionFairy(object):\n             c = self.connection.cursor(*args, **kwargs)\n             return _CursorFairy(self, c)\n         except Exception, e:\n+            import sys\n+            exc = sys.exc_info()\n             self.invalidate(e=e)\n-            raise\n+            raise exc\n \n     def __getattr__(self, key):\n         return getattr(self.connection, key)\n\nI will do some more investigation into this when I can.  We need a clear repro case for this.\n", 
            "date_created": "2011-09-24 12:09:46.656379+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I created a small script that calls euca-create-instance four times, creating one instance each time, and then waits for them all to be running. It then terminates them and tries again. I started running this against a single nova node running all services and after a few times through got this error in nova-network:\n\n ResourceClosedError: This result object does not return rows. It has been closed automatically.\n\nI see that there is a recent bug 857714  about that error. At this point I am forced to conclude that either I have no idea what I am doing (I am pretty new to Nova) , or there are some serious issues with Diablo. I think what I am doing is the most elementary thing one could do as part of testing  Nova so I don't know what to make of this. Has this kind of rudimentary stress test been successfully run by any one?", 
            "date_created": "2011-09-26 13:23:28.851873+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Give this a try now.  This was marked a duplicate of lp:838581  and a fix was merged earlier.", 
            "date_created": "2011-09-27 19:44:29.316889+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "I will, but I have been installing from oneiric packages. How do I know when an updated package is available?", 
            "date_created": "2011-09-27 20:10:16.667551+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "I built and installed packages from 2012.1~e1~20110909.1546-0ubuntu1 and now I just get these errors about some bad SQL syntax:\n\n2011-09-30 13:36:59,829 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 317, in get_floating_ips_by_fixed_address\n(nova.rpc): TRACE:     fixed_address)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 295, in floating_ip_get_by_fixed_address\n(nova.rpc): TRACE:     return IMPL.floating_ip_get_by_fixed_address(context, fixed_address)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 120, in wrapper\n(nova.rpc): TRACE:     return f(*args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 668, in floating_ip_get_by_fixed_address\n(nova.rpc): TRACE:     fixed_ip = fixed_ip_get_by_address(context, fixed_address, session)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 120, in wrapper\n(nova.rpc): TRACE:     return f(*args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 838, in fixed_ip_get_by_address\n(nova.rpc): TRACE:     options(joinedload('instance')).\\\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 1652, in first\n(nova.rpc): TRACE:     ret = list(self[0:1])\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 1560, in __getitem__\n(nova.rpc): TRACE:     return list(res)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 1721, in __iter__\n(nova.rpc): TRACE:     return self._execute_and_instances(context)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 1726, in _execute_and_instances\n(nova.rpc): TRACE:     mapper=self._mapper_zero_or_none())\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 724, in execute\n(nova.rpc): TRACE:     clause, params or {})\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1191, in execute\n(nova.rpc): TRACE:     params)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1271, in _execute_clauseelement\n(nova.rpc): TRACE:     return self.__execute_context(context)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1302, in __execute_context\n(nova.rpc): TRACE:     context.parameters[0], context=context)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1401, in _cursor_execute\n(nova.rpc): TRACE:     context)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1394, in _cursor_execute\n(nova.rpc): TRACE:     context)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 299, in do_execute\n(nova.rpc): TRACE:     cursor.execute(statement, parameters)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/MySQLdb/cursors.py\", line 174, in execute\n(nova.rpc): TRACE:     self.errorhandler(self, exc, value)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n(nova.rpc): TRACE:     raise errorclass, errorvalue\n(nova.rpc): TRACE: ProgrammingError: (ProgrammingError) (1064, \"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ') AND fixed_ips.deleted = 0 \\n LIMIT 0, 1) AS anon_1 LEFT OUTER JOIN networks AS ' at line 4\") 'SELECT anon_1.fixed_ips_created_at AS anon_1_fixed_ips_created_at, anon_1.fixed_ips_updated_at AS anon_1_fixed_ips_updated_at, anon_1.fixed_ips_deleted_at AS anon_1_fixed_ips_deleted_at, anon_1.fixed_ips_deleted AS anon_1_fixed_ips_deleted, anon_1.fixed_ips_id AS anon_1_fixed_ips_id, anon_1.fixed_ips_address AS anon_1_fixed_ips_address, anon_1.fixed_ips_network_id AS anon_1_fixed_ips_network_id, anon_1.fixed_ips_virtual_interface_id AS anon_1_fixed_ips_virtual_interface_id, anon_1.fixed_ips_instance_id AS anon_1_fixed_ips_instance_id, anon_1.fixed_ips_allocated AS anon_1_fixed_ips_allocated, anon_1.fixed_ips_leased AS anon_1_fixed_ips_leased, anon_1.fixed_ips_reserved AS anon_1_fixed_ips_reserved, anon_1.fixed_ips_host AS anon_1_fixed_ips_host, networks_1.created_at AS networks_1_created_at, networks_1.updated_at AS networks_1_updated_at, networks_1.deleted_at AS networks_1_deleted_at, networks_1.deleted AS networks_1_deleted, networks_1.id AS networks_1_id, networks_1.label AS networks_1_label, networks_1.injected AS networks_1_injected, networks_1.cidr AS networks_1_cidr, networks_1.cidr_v6 AS networks_1_cidr_v6, networks_1.multi_host AS networks_1_multi_host, networks_1.gateway_v6 AS networks_1_gateway_v6, networks_1.netmask_v6 AS networks_1_netmask_v6, networks_1.netmask AS networks_1_netmask, networks_1.bridge AS networks_1_bridge, networks_1.bridge_interface AS networks_1_bridge_interface, networks_1.gateway AS networks_1_gateway, networks_1.broadcast AS networks_1_broadcast, networks_1.dns1 AS networks_1_dns1, networks_1.dns2 AS networks_1_dns2, networks_1.vlan AS networks_1_vlan, networks_1.vpn_public_address AS networks_1_vpn_public_address, networks_1.vpn_public_port AS networks_1_vpn_public_port, networks_1.vpn_private_address AS networks_1_vpn_private_address, networks_1.dhcp_start AS networks_1_dhcp_start, networks_1.project_id AS networks_1_project_id, networks_1.priority AS networks_1_priority, networks_1.host AS networks_1_host, networks_1.uuid AS networks_1_uuid, instances_1.created_at AS instances_1_created_at, instances_1.updated_at AS instances_1_updated_at, instances_1.deleted_at AS instances_1_deleted_at, instances_1.deleted AS instances_1_deleted, instances_1.id AS instances_1_id, instances_1.user_id AS instances_1_user_id, instances_1.project_id AS instances_1_project_id, instances_1.image_ref AS instances_1_image_ref, instances_1.kernel_id AS instances_1_kernel_id, instances_1.ramdisk_id AS instances_1_ramdisk_id, instances_1.server_name AS instances_1_server_name, instances_1.launch_index AS instances_1_launch_index, instances_1.key_name AS instances_1_key_name, instances_1.key_data AS instances_1_key_data, instances_1.power_state AS instances_1_power_state, instances_1.vm_state AS instances_1_vm_state, instances_1.task_state AS instances_1_task_state, instances_1.memory_mb AS instances_1_memory_mb, instances_1.vcpus AS instances_1_vcpus, instances_1.local_gb AS instances_1_local_gb, instances_1.hostname AS instances_1_hostname, instances_1.host AS instances_1_host, instances_1.instance_type_id AS instances_1_instance_type_id, instances_1.user_data AS instances_1_user_data, instances_1.reservation_id AS instances_1_reservation_id, instances_1.scheduled_at AS instances_1_scheduled_at, instances_1.launched_at AS instances_1_launched_at, instances_1.terminated_at AS instances_1_terminated_at, instances_1.availability_zone AS instances_1_availability_zone, instances_1.display_name AS instances_1_display_name, instances_1.display_description AS instances_1_display_description, instances_1.launched_on AS instances_1_launched_on, instances_1.locked AS instances_1_locked, instances_1.os_type AS instances_1_os_type, instances_1.architecture AS instances_1_architecture, instances_1.vm_mode AS instances_1_vm_mode, instances_1.uuid AS instances_1_uuid, instances_1.root_device_name AS instances_1_root_device_name, instances_1.default_local_device AS instances_1_default_local_device, instances_1.default_swap_device AS instances_1_default_swap_device, instances_1.config_drive AS instances_1_config_drive, instances_1.access_ip_v4 AS instances_1_access_ip_v4, instances_1.access_ip_v6 AS instances_1_access_ip_v6, instances_1.managed_disk AS instances_1_managed_disk, instances_1.progress AS instances_1_progress, floating_ips_1.created_at AS floating_ips_1_created_at, floating_ips_1.updated_at AS floating_ips_1_updated_at, floating_ips_1.deleted_at AS floating_ips_1_deleted_at, floating_ips_1.deleted AS floating_ips_1_deleted, floating_ips_1.id AS floating_ips_1_id, floating_ips_1.address AS floating_ips_1_address, floating_ips_1.fixed_ip_id AS floating_ips_1_fixed_ip_id, floating_ips_1.project_id AS floating_ips_1_project_id, floating_ips_1.host AS floating_ips_1_host, floating_ips_1.auto_assigned AS floating_ips_1_auto_assigned \\nFROM (SELECT fixed_ips.created_at AS fixed_ips_created_at, fixed_ips.updated_at AS fixed_ips_updated_at, fixed_ips.deleted_at AS fixed_ips_deleted_at, fixed_ips.deleted AS fixed_ips_deleted, fixed_ips.id AS fixed_ips_id, fixed_ips.address AS fixed_ips_address, fixed_ips.network_id AS fixed_ips_network_id, fixed_ips.virtual_interface_id AS fixed_ips_virtual_interface_id, fixed_ips.instance_id AS fixed_ips_instance_id, fixed_ips.allocated AS fixed_ips_allocated, fixed_ips.leased AS fixed_ips_leased, fixed_ips.reserved AS fixed_ips_reserved, fixed_ips.host AS fixed_ips_host \\nFROM fixed_ips \\nWHERE fixed_ips.address = %s AND fixed_ips.deleted = %s \\n LIMIT 0, 1) AS anon_1 LEFT OUTER JOIN networks AS networks_1 ON networks_1.id = anon_1.fixed_ips_network_id LEFT OUTER JOIN instances AS instances_1 ON anon_1.fixed_ips_instance_id = instances_1.id AND anon_1.fixed_ips_deleted = %s LEFT OUTER JOIN floating_ips AS floating_ips_1 ON floating_ips_1.fixed_ip_id = anon_1.fixed_ips_id AND floating_ips_1.deleted = %s' ([u'172.18.77.2'], 0, 0, 0)\n", 
            "date_created": "2011-09-30 17:40:31.079675+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "I tested again using the devstack install to create two nodes (after verifying that the fix for bug 838581 is in session.py) and still see the problem, but less frequently. It is not quite the same because this is running from source rather than packages, and using 'nova boot' instead of euca-run-instances. I don't know how to get euca-run-instances to work when using keystone to manage users. 'nova boot' doesn't seem to allow multiple instances to be created in one call but I changed the min_count default in the source to 8 for this test.\n\ndiff --git a/novaclient/v1_1/shell.py b/novaclient/v1_1/shell.py\nindex 6b83292..21ee0c9 100644\n--- a/novaclient/v1_1/shell.py\n+++ b/novaclient/v1_1/shell.py\n@@ -33,7 +33,7 @@ AUTO_KEY = object()\n def _boot(cs, args, reservation_id=None, min_count=None, max_count=None):\n     \"\"\"Boot a new server.\"\"\"\n     if min_count is None:\n-        min_count = 1\n+        min_count = 8\n     if max_count is None:\n         max_count = min_count\n     if min_count > max_count:\n\n\nThis bug really needs to be reopened but I am not sure how to do that.", 
            "date_created": "2011-10-13 21:00:18.659498+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "My nova.conf for the last test:\n\n--logdir=/var/log/nova\n--verbose\n--nodaemon\n--scheduler_driver=nova.scheduler.simple.SimpleScheduler\n--dhcpbridge_flagfile=/opt/stack/nova/bin/nova.conf\n--network_manager=nova.network.manager.FlatDHCPManager\n--my_ip=172.18.0.141\n--public_interface=eth0\n--vlan_interface=eth0\n--sql_connection=mysql://root:mysql@172.18.0.141/nova\n--libvirt_type=kvm\n--osapi_extensions_path=/opt/stack/openstackx/extensions\n--vncproxy_url=http://172.18.0.141:6080\n--vncproxy_wwwroot=/opt/stack/noVNC/\n--api_paste_config=/opt/stack/keystone/examples/paste/nova-api-paste.ini\n--image_service=nova.image.glance.GlanceImageService\n--ec2_dmz_host=172.18.0.141\n--rabbit_host=172.18.0.141\n--rabbit_password=rabbit\n--glance_api_servers=172.18.0.141:9292\n--flat_network_bridge=br100\n--flat_interface=eth1\n--multi_host=1\n", 
            "date_created": "2011-10-13 21:10:29.222097+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Per David's comments, I've removed the 'duplicate' flag for this bug.", 
            "date_created": "2011-10-18 15:59:51.896069+00:00", 
            "author": "https://api.launchpad.net/1.0/~smoser"
        }, 
        {
            "content": "David,\n  I talked some with Vish in IRC today.  It seems like we're in need of some more data to diagnose. I was unable to reproduce this issue in a little \"all in one\" nova.sh install that I did and Vish hasn't seen anything like it.\n  We're assuming that the bug history and traces pasted represents different failures.\n\n  Since you're able to reproduce with devstack, could you set up one on ubuntu either Natty or Oneiric, recreate and report:\n * git commit tip\n * nova.conf (as you have above)\n * traces that you see in the logs when the issue occurs\n\n I think you've addressed it, but make sure you're not just running out of IP addresses.\n\n  Thanks in advance.\n\n[1] http://eavesdrop.openstack.org/irclogs/%23openstack-dev/%23openstack-dev.2011-10-19.log", 
            "date_created": "2011-10-19 19:40:27.944494+00:00", 
            "author": "https://api.launchpad.net/1.0/~smoser"
        }, 
        {
            "content": "OK. I just did it again. I am not sure what \"git commit tip\" means. The running out of addresses was a one-time issue I had before understanding that the leased IP addresses for the vms are not returned immediately when the vms are terminated.\nI am assuming that this kind of error and stacktrace in the log would be considered a bug even if it does not cause any obvious misbehavior immediately.\n\n I used the current version of devstack  but with a modified stack.sh from last week. I modified it to log to files in /var/log/nova instead of stdout so you have to create that directory before running. I used one compute node running api,network,compute and one controller node running everything. After running the modified stack.sh I exported the shell variables in exercise.sh, modified the min count in nova client to create 10 vms, and did\n\nnova boot --flavor 1 --image 3 testvms  \n\nIn this case the vms seen to have started but there is the AMQP error stacktrace in the log. When this happens, sometimes all the vms come up and sometimes not. I have attached:\n\n1. nova-network log with stacktrace\n2. modified stack.sh\n3. localrc for both controller and compute\n4. nova.conf (even though it is generated)\n\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 628, in _process_data\n(nova.rpc): TRACE:     ctxt.reply(None, None)\n(nova.rpc): TRACE:   File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 673, in reply\n(nova.rpc): TRACE:     msg_reply(self.msg_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 781, in msg_reply\n(nova.rpc): TRACE:     conn.direct_send(msg_id, msg)\n(nova.rpc): TRACE:   File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 562, in __exit__\n(nova.rpc): TRACE:     self._done()\n(nova.rpc): TRACE:   File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 547, in _done\n(nova.rpc): TRACE:     self.connection.reset()\n(nova.rpc): TRACE:   File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 382, in reset\n(nova.rpc): TRACE:     self.channel.close()\n(nova.rpc): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 201, in close\n(nova.rpc): TRACE:     super(Channel, self).close()\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\n(nova.rpc): TRACE:     (20, 41),    # Channel.close_ok\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\n(nova.rpc): TRACE:     return self.dispatch_method(method_sig, args, content)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\n(nova.rpc): TRACE:     return amqp_method(self, args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\n(nova.rpc): TRACE:     (class_id, method_id))\n(nova.rpc): TRACE: AMQPChannelException: (404, u\"NOT_FOUND - no exchange '5b9a19d1b5e849d7ba749fada648a375' in vhost '/'\", (60, 40), 'Channel.basic_publish')\n(nova.rpc): TRACE: \n2011-10-20 10:45:24,724 ERROR nova.rpc [-] Returning exception (404, u\"NOT_FOUND - no exchange '5b9a19d1b5e849d7ba749fada648a375' in vhost '/'\", (60, 40), 'Channel.basic_publish') to caller\n2011-10-20 10:45:24,724 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 628, in _process_data\\n    ctxt.reply(None, None)\\n', '  File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 673, in reply\\n    msg_reply(self.msg_id, *args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 781, in msg_reply\\n    conn.direct_send(msg_id, msg)\\n', '  File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 562, in __exit__\\n    self._done()\\n', '  File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 547, in _done\\n    self.connection.reset()\\n', '  File \"/opt/stack/nova/nova/rpc/impl_kombu.py\", line 382, in reset\\n    self.channel.close()\\n', '  File \"/usr/local/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 201, in close\\n    super(Channel, self).close()\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\\n    (20, 41),    # Channel.close_ok\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\\n    return self.dispatch_method(method_sig, args, content)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\\n    return amqp_method(self, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\\n    (class_id, method_id))\\n', 'AMQPChannelException: (404, u\"NOT_FOUND - no exchange \\'5b9a19d1b5e849d7ba749fada648a375\\' in vhost \\'/\\'\", (60, 40), \\'Channel.basic_publish\\')\\n']\n", 
            "date_created": "2011-10-20 15:12:31.446453+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "", 
            "date_created": "2011-10-20 15:13:05.577013+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "", 
            "date_created": "2011-10-20 15:13:39.776215+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "", 
            "date_created": "2011-10-20 15:14:00.631486+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "", 
            "date_created": "2011-10-20 15:14:21.417048+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "", 
            "date_created": "2011-10-20 15:15:06.781557+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "One more thing. Since this seems to be some kind of race condition issue, it might be relevant that I was using two real Ubuntu 11.10 machines with the OS reinstalled prior to running this experiment. I left these machines as is so if there is any other state of the machines that is of interest I can provide it. ", 
            "date_created": "2011-10-20 15:22:03.620946+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "By the way, I saw a similar exception today when disassociating a floating IP with diablo https://bugzilla.redhat.com/747568", 
            "date_created": "2011-10-20 15:42:31.356792+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "Thank you for the extensive report.  This should help us debug.  If it is easy for you to reproduce I'm very curious if you get the same exception using the carrot driver instead of kombu.\n\n--rpc_backend=nova.rpc.impl_carrot\n\n", 
            "date_created": "2011-10-20 23:02:18+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I tried this before and didn't see the problem as you can see in comment #6. However, given the randomness of when this bug happens and not I can't be sure it is definitive. I can try it again tomorrow.", 
            "date_created": "2011-10-21 00:41:33.257417+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "I tried creating 10 vms 5 times with carrot and all was well. Back to kombu, it failed the second time.", 
            "date_created": "2011-10-21 13:30:12.628488+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Hey,\n\nAre you using eventlet with both kombu and carrot?\n\nThe difference then would be that Kombu synchronized *_declare calls by delegating them to another greenthread\nand having the current thread wait for that thread to finish (kombu.syn.blocking)\nSo in a sense it *should* be safer than carrot, why it wouldn't be I'm not sure.\nAlso are you declaring entities both when publishing the request *and* when publishing the reply?", 
            "date_created": "2011-10-21 13:49:22.024650+00:00", 
            "author": "https://api.launchpad.net/1.0/~asksol"
        }, 
        {
            "content": "s/synchronized/synchronizes/", 
            "date_created": "2011-10-21 13:50:03.801871+00:00", 
            "author": "https://api.launchpad.net/1.0/~asksol"
        }, 
        {
            "content": "Ask:  Hm.   I implemented the code in nova that uses kombu.  There's probably something funny about what I did, because I probably didn't use what one would call the 'common interfaces'. :)   No offense, but the default interfaces didn't provide great enough flexibility.\n\nHere's a summary of how things work:\n\nTo create a consumer, I'm essentially doing this:\n\nexchange = entity.Exchange()\nqueue = entity.Queue(...., exchange=exchange)\nqueue.declare().\nqueue.consume() ***\n\n*** In some cases we declare multiple queues on the same channel.   But, what I don't do is use messaging.Consumer().  What did not appear to be supported in kombu was the ability to specify a different callback for each of those queues if I were to pass them all to the same Consumer().   If I did that, Comsumer.consume() would always call the same callback (the ones provided to Consumer()).  I think carrot actually supported that, in a way, via ConsumerSet().  But anyway...   point is here.. I'm not using Consumer() at all.   To consume, I'm essentially calling queue.consume() similar to what Consumer.consume() does... except each Queue has its own callback.  (I keep a list of the queues that are declared on a channel and loop through them).  I can't find anything wrong with this... as I'm essentially just doing the same work that Consumer() does.\n\nFor publishing:\n\nexchange = entity.Exchange()\nproducer = entity.Producer(..., exchange=exchange)\nproducer.publish()\n\nThere was also some sort of issue i ran into with the reconnecting code within kombu, so all of this stuff is wrapped by our own classes that handle re-creating the appropriate kombu instances.\n\nNow.. back to the bug.  If you're not familiar with nova RPC... what's happening in this bug report is:\n\n1) generate a unique uuid to use as exchange and queue names.  call queue.declare() which declares the exchange and the queue and binds them.  This queue will be used to get a response from remote worker.\n2) Using the same connection, publish a message into some other queue for the remote service to pick up.  Put the unique uuid in the message so it knows what exchange/queue to respond to.\n3) Using the same connection, start consuming on the previously declared queue\n4) the remote worker does some work... and tries to respond into the queue we created in #1.  The above Exception is reported...  sometimes and apparently very rarely for most people.    I've never seen the above exception at all... nor have any of the people I work with closely.  However, David seems to see it quite easily.\n\n#4 can actually happen before #3... which is fine.  The queue was declared in #1, so it certainly should exist, should it not?\n\nAny other ideas?", 
            "date_created": "2011-10-21 21:55:09.861368+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "Have the same issue when using live migration. Change rpc to the \"carrot\" fix this.", 
            "date_created": "2011-10-25 08:08:39.152519+00:00", 
            "author": "https://api.launchpad.net/1.0/~v-v-biriukov"
        }, 
        {
            "content": "I've been trying very hard to reproduce this bug.  On my test system with oneiric (which has kombu 1.4.3), I cannot get it to fail.  I can run 6 instances simultaneously with euca (works on current devstack) and change max_count to 6 and do a nova boot successfully.  I've also tested with current trunk and I don't get any issue there either.", 
            "date_created": "2011-11-04 02:27:14.528128+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "OK, I will try it again but will be on a trip next week. Unfortunately the fix for the db pool bug was removed from ubuntu6.2 when it was released so I cannot easily do this at the moment because our automated testing is based on packages. This is another reason why it would be good for the automated build process to produce ppas for both trunk and diablo stable.", 
            "date_created": "2011-11-04 13:24:12.392372+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Is it possible to use the oneiric packages?    They are roughly based on diablo stable.\n\nOn Nov 4, 2011, at 6:24 AM, David Kranz wrote:\n\n> OK, I will try it again but will be on a trip next week. Unfortunately\n> the fix for the db pool bug was removed from ubuntu6.2 when it was\n> released so I cannot easily do this at the moment because our automated\n> testing is based on packages. This is another reason why it would be\n> good for the automated build process to produce ppas for both trunk and\n> diablo stable.\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/855030\n> \n> Title:\n>  Encountering sporadic AMQPChannelException\n> \n> Status in OpenStack Compute (Nova):\n>  Incomplete\n> \n> Bug description:\n>  Running one controller and one compute, using nova-network version\n>  2011.3~rc~20110909.r1155-0ub  on Oneiric . Repeating the following:\n> \n>  Create four instances, terminate them.\n> \n>  This mostly works but one in every three or four times, one of the vms\n>  does not come up and I see this error in the nova-network log. This\n>  can occur both in the controller node (also running compute) or the\n>  compute node.  (contents of nova.conf follows)\n> \n>  2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab semaphore \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:672\n>  2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab file lock \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:677\n>  2011-09-20 13:22:59,296 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t filter from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,311 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,350 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t nat from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,366 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,424 ERROR nova.rpc [-] Exception during message handling\n>  (nova.rpc): TRACE: Traceback (most recent call last):\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\n>  (nova.rpc): TRACE:     ctxt.reply(None, None)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\n>  (nova.rpc): TRACE:     msg_reply(self.msg_id, *args, **kwargs)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\n>  (nova.rpc): TRACE:     conn.direct_send(msg_id, msg)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\n>  (nova.rpc): TRACE:     self._done()\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\n>  (nova.rpc): TRACE:     self.connection.reset()\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\n>  (nova.rpc): TRACE:     self.channel.close()\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\n>  (nova.rpc): TRACE:     (20, 41),    # Channel.close_ok\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\n>  (nova.rpc): TRACE:     return self.dispatch_method(method_sig, args, content)\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\n>  (nova.rpc): TRACE:     return amqp_method(self, args)\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\n>  (nova.rpc): TRACE:     (class_id, method_id))\n>  (nova.rpc): TRACE: AMQPChannelException: (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish')\n>  (nova.rpc): TRACE: \n>  2011-09-20 13:22:59,451 ERROR nova.rpc [-] Returning exception (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish') to caller\n>  2011-09-20 13:22:59,452 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\\n    ctxt.reply(None, None)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\\n    msg_reply(self.msg_id, *args, **kwargs)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\\n    conn.direct_send(msg_id, msg)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\\n    self._done()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\\n    self.connection.reset()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\\n    self.channel.close()\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\\n    (20, 41),    # Channel.close_ok\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\\n    return self.dispatch_method(method_sig, args, content)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\\n    return amqp_method(self, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\\n    (class_id, method_id))\\n', 'AMQPChannelException: (404, u\"NOT_FOUND - no exchange \\'3ff1ba7e274a4ec2a2b0a217d7532c70\\' in vhost \\'/\\'\", (60, 40), \\'Channel.basic_publish\\')\\n']\n> \n> \n>  I also see this at the same time in the rabbitmq log:\n> \n>  =ERROR REPORT==== 20-Sep-2011::13:22:59 ===\n>  connection <0.1061.0>, channel 1 - error:\n>  {amqp_error,not_found,\n>              \"no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\",\n>              'basic.publish'}\n> \n> \n> \n>  --flagfile=/etc/nova/nova-compute.conf\n>  --use_deprecated_auth\n>  --dhcpbridge_flagfile=/etc/nova/nova.conf\n>  --dhcpbridge=/usr/bin/nova-dhcpbridge\n>  --sql_connection=mysql://nova:notnova@172.18.0.141/nova\n>  --s3_host=172.18.0.141\n>  --rabbit_host=172.18.0.141\n>  --glance_api_servers=172.18.0.141:9292\n>  --logdir=/var/log/nova\n>  --state_path=/var/lib/nova\n>  --lock_path=/var/lock/nova\n>  --verbose\n>  --ec2_url=http://172.18.0.141:8773/services/Cloud\n>  --dmz_cidr=172.18.0.141/32\n>  --fixed_range=172.18.77.0/27\n>  --network_size=8\n>  --flat_network_dhcp_start=172.18.7.6\n>  --image_service=nova.image.glance.GlanceImageService\n>  --bridge_interface=eth1\n>  --flat_network_bridge=br100\n>  --network_manager=nova.network.manager.FlatDHCPManager\n>  --public_interface=eth0\n>  --multi_host\n>  --osapi_host=172.18.0.141\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/855030/+subscriptions\n\n", 
            "date_created": "2011-11-04 17:53:09+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "As far as I can see, the current oneiric packages are based on a security update that does not have any of the diablo fixes. Please correct me if I am wrong. In any event we just built our own packages based on diable/stable and I am installing now.", 
            "date_created": "2011-11-04 18:04:09.423101+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "OK, I tried this with packages generated from diablo stable and do not see the problem any more. I think this ticket could be closed for now. It would be a lot of work to figure out exactly which source change made the difference and there are more important things to do. I am working on a more general torture test that will trigger this if it still exists.", 
            "date_created": "2011-11-04 18:57:41.076115+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "I am sorry but I was a dork and forgot to remove the carrot directive from nova.conf. When I remove that, the same problem easily happens. I really don't know what to suggest at this point but this is a real bug still there. I was again using two nodes, both running compute, with euca-run-instances creating 16 at a time. ", 
            "date_created": "2011-11-04 19:38:21.516084+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Ok good to know.  Perhaps this only occurs on multiple machines.  Are you running just one nova-network?\n\nIf I can reproduce this I'm going to turn on amqplib debug logging and see if I can track down what is happening.\n\nVish\n\nOn Nov 4, 2011, at 11:04 AM, David Kranz wrote:\n\n> As far as I can see, the current oneiric packages are based on a\n> security update that does not have any of the diablo fixes. Please\n> correct me if I am wrong. In any event we just built our own packages\n> based on diable/stable and I am installing now.\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/855030\n> \n> Title:\n>  Encountering sporadic AMQPChannelException\n> \n> Status in OpenStack Compute (Nova):\n>  Incomplete\n> \n> Bug description:\n>  Running one controller and one compute, using nova-network version\n>  2011.3~rc~20110909.r1155-0ub  on Oneiric . Repeating the following:\n> \n>  Create four instances, terminate them.\n> \n>  This mostly works but one in every three or four times, one of the vms\n>  does not come up and I see this error in the nova-network log. This\n>  can occur both in the controller node (also running compute) or the\n>  compute node.  (contents of nova.conf follows)\n> \n>  2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab semaphore \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:672\n>  2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab file lock \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:677\n>  2011-09-20 13:22:59,296 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t filter from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,311 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,350 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t nat from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,366 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,424 ERROR nova.rpc [-] Exception during message handling\n>  (nova.rpc): TRACE: Traceback (most recent call last):\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\n>  (nova.rpc): TRACE:     ctxt.reply(None, None)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\n>  (nova.rpc): TRACE:     msg_reply(self.msg_id, *args, **kwargs)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\n>  (nova.rpc): TRACE:     conn.direct_send(msg_id, msg)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\n>  (nova.rpc): TRACE:     self._done()\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\n>  (nova.rpc): TRACE:     self.connection.reset()\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\n>  (nova.rpc): TRACE:     self.channel.close()\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\n>  (nova.rpc): TRACE:     (20, 41),    # Channel.close_ok\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\n>  (nova.rpc): TRACE:     return self.dispatch_method(method_sig, args, content)\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\n>  (nova.rpc): TRACE:     return amqp_method(self, args)\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\n>  (nova.rpc): TRACE:     (class_id, method_id))\n>  (nova.rpc): TRACE: AMQPChannelException: (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish')\n>  (nova.rpc): TRACE: \n>  2011-09-20 13:22:59,451 ERROR nova.rpc [-] Returning exception (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish') to caller\n>  2011-09-20 13:22:59,452 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\\n    ctxt.reply(None, None)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\\n    msg_reply(self.msg_id, *args, **kwargs)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\\n    conn.direct_send(msg_id, msg)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\\n    self._done()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\\n    self.connection.reset()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\\n    self.channel.close()\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\\n    (20, 41),    # Channel.close_ok\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\\n    return self.dispatch_method(method_sig, args, content)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\\n    return amqp_method(self, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\\n    (class_id, method_id))\\n', 'AMQPChannelException: (404, u\"NOT_FOUND - no exchange \\'3ff1ba7e274a4ec2a2b0a217d7532c70\\' in vhost \\'/\\'\", (60, 40), \\'Channel.basic_publish\\')\\n']\n> \n> \n>  I also see this at the same time in the rabbitmq log:\n> \n>  =ERROR REPORT==== 20-Sep-2011::13:22:59 ===\n>  connection <0.1061.0>, channel 1 - error:\n>  {amqp_error,not_found,\n>              \"no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\",\n>              'basic.publish'}\n> \n> \n> \n>  --flagfile=/etc/nova/nova-compute.conf\n>  --use_deprecated_auth\n>  --dhcpbridge_flagfile=/etc/nova/nova.conf\n>  --dhcpbridge=/usr/bin/nova-dhcpbridge\n>  --sql_connection=mysql://nova:notnova@172.18.0.141/nova\n>  --s3_host=172.18.0.141\n>  --rabbit_host=172.18.0.141\n>  --glance_api_servers=172.18.0.141:9292\n>  --logdir=/var/log/nova\n>  --state_path=/var/lib/nova\n>  --lock_path=/var/lock/nova\n>  --verbose\n>  --ec2_url=http://172.18.0.141:8773/services/Cloud\n>  --dmz_cidr=172.18.0.141/32\n>  --fixed_range=172.18.77.0/27\n>  --network_size=8\n>  --flat_network_dhcp_start=172.18.7.6\n>  --image_service=nova.image.glance.GlanceImageService\n>  --bridge_interface=eth1\n>  --flat_network_bridge=br100\n>  --network_manager=nova.network.manager.FlatDHCPManager\n>  --public_interface=eth0\n>  --multi_host\n>  --osapi_host=172.18.0.141\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/855030/+subscriptions\n\n", 
            "date_created": "2011-11-04 20:23:25+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I am running two nodes, both running network, api, and compute as documented for ha mode.", 
            "date_created": "2011-11-04 20:48:26.651219+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "ok, I have seen a few error messges, although I'm having a hard time getting it to fail consistently.  Turning on logging seems to make the problem go away so i suspect a tricky race condition.  Here is a log of 10 instances going with no failures.", 
            "date_created": "2011-11-09 06:33:17.107362+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "It appears that carrot works a little bit differently, opening multiple channels as needed. (greenthread ids are logged as well).", 
            "date_created": "2011-11-09 06:57:45.527888+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Here is the kombu version with greenthread ids logged (note that it always uses channel 1)", 
            "date_created": "2011-11-09 06:58:32.353344+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "David:\n\nTaking a shot in the dark here... but could you try applying the following patch to impl_kombu.py:\n\nhttp://paste.openstack.org/show/3207/\n\nAnd see if the problem goes away?\n", 
            "date_created": "2011-11-09 07:54:44.226676+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "I could do this but am out of the office until Monday. Since Vish can now reproduce this he could give it a try. I will do it on Monday if nothing else ha happened.", 
            "date_created": "2011-11-09 14:17:43.089734+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "I will try it, although my errors are extremely inconsistent.  I've managed to start and stop 20 vms regularly without errors, so I'm not sure how many i would have to do to consider it fixed.\n\nVish\n\nOn Nov 9, 2011, at 6:17 AM, David Kranz wrote:\n\n> I could do this but am out of the office until Monday. Since Vish can\n> now reproduce this he could give it a try. I will do it on Monday if\n> nothing else ha happened.\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/855030\n> \n> Title:\n>  Encountering sporadic AMQPChannelException\n> \n> Status in OpenStack Compute (Nova):\n>  Incomplete\n> \n> Bug description:\n>  Running one controller and one compute, using nova-network version\n>  2011.3~rc~20110909.r1155-0ub  on Oneiric . Repeating the following:\n> \n>  Create four instances, terminate them.\n> \n>  This mostly works but one in every three or four times, one of the vms\n>  does not come up and I see this error in the nova-network log. This\n>  can occur both in the controller node (also running compute) or the\n>  compute node.  (contents of nova.conf follows)\n> \n>  2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab semaphore \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:672\n>  2011-09-20 13:22:59,295 DEBUG nova.utils [-] Attempting to grab file lock \"iptables\" for method \"apply\"... from (pid=1082) inner /usr/lib/pymodules/python2.7/nova/utils.py:677\n>  2011-09-20 13:22:59,296 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t filter from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,311 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,350 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-save -t nat from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,366 DEBUG nova.utils [-] Running cmd (subprocess): sudo iptables-restore from (pid=1082) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n>  2011-09-20 13:22:59,424 ERROR nova.rpc [-] Exception during message handling\n>  (nova.rpc): TRACE: Traceback (most recent call last):\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\n>  (nova.rpc): TRACE:     ctxt.reply(None, None)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\n>  (nova.rpc): TRACE:     msg_reply(self.msg_id, *args, **kwargs)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\n>  (nova.rpc): TRACE:     conn.direct_send(msg_id, msg)\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\n>  (nova.rpc): TRACE:     self._done()\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\n>  (nova.rpc): TRACE:     self.connection.reset()\n>  (nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\n>  (nova.rpc): TRACE:     self.channel.close()\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\n>  (nova.rpc): TRACE:     (20, 41),    # Channel.close_ok\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\n>  (nova.rpc): TRACE:     return self.dispatch_method(method_sig, args, content)\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\n>  (nova.rpc): TRACE:     return amqp_method(self, args)\n>  (nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\n>  (nova.rpc): TRACE:     (class_id, method_id))\n>  (nova.rpc): TRACE: AMQPChannelException: (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish')\n>  (nova.rpc): TRACE: \n>  2011-09-20 13:22:59,451 ERROR nova.rpc [-] Returning exception (404, u\"NOT_FOUND - no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\", (60, 40), 'Channel.basic_publish') to caller\n>  2011-09-20 13:22:59,452 ERROR nova.rpc [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 628, in _process_data\\n    ctxt.reply(None, None)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 673, in reply\\n    msg_reply(self.msg_id, *args, **kwargs)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 781, in msg_reply\\n    conn.direct_send(msg_id, msg)\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 562, in __exit__\\n    self._done()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 547, in _done\\n    self.connection.reset()\\n', '  File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 382, in reset\\n    self.channel.close()\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 194, in close\\n    (20, 41),    # Channel.close_ok\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 97, in wait\\n    return self.dispatch_method(method_sig, args, content)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/abstract_channel.py\", line 115, in dispatch_method\\n    return amqp_method(self, args)\\n', '  File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/channel.py\", line 273, in _close\\n    (class_id, method_id))\\n', 'AMQPChannelException: (404, u\"NOT_FOUND - no exchange \\'3ff1ba7e274a4ec2a2b0a217d7532c70\\' in vhost \\'/\\'\", (60, 40), \\'Channel.basic_publish\\')\\n']\n> \n> \n>  I also see this at the same time in the rabbitmq log:\n> \n>  =ERROR REPORT==== 20-Sep-2011::13:22:59 ===\n>  connection <0.1061.0>, channel 1 - error:\n>  {amqp_error,not_found,\n>              \"no exchange '3ff1ba7e274a4ec2a2b0a217d7532c70' in vhost '/'\",\n>              'basic.publish'}\n> \n> \n> \n>  --flagfile=/etc/nova/nova-compute.conf\n>  --use_deprecated_auth\n>  --dhcpbridge_flagfile=/etc/nova/nova.conf\n>  --dhcpbridge=/usr/bin/nova-dhcpbridge\n>  --sql_connection=mysql://nova:notnova@172.18.0.141/nova\n>  --s3_host=172.18.0.141\n>  --rabbit_host=172.18.0.141\n>  --glance_api_servers=172.18.0.141:9292\n>  --logdir=/var/log/nova\n>  --state_path=/var/lib/nova\n>  --lock_path=/var/lock/nova\n>  --verbose\n>  --ec2_url=http://172.18.0.141:8773/services/Cloud\n>  --dmz_cidr=172.18.0.141/32\n>  --fixed_range=172.18.77.0/27\n>  --network_size=8\n>  --flat_network_dhcp_start=172.18.7.6\n>  --image_service=nova.image.glance.GlanceImageService\n>  --bridge_interface=eth1\n>  --flat_network_bridge=br100\n>  --network_manager=nova.network.manager.FlatDHCPManager\n>  --public_interface=eth0\n>  --multi_host\n>  --osapi_host=172.18.0.141\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/855030/+subscriptions\n\n", 
            "date_created": "2011-11-09 18:07:41+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "OK, I tried this patch and it made no difference. Note that I found it even easier to see this problem by starting 16 vms with euca-run-instances. BTW, though it probably not matter, the vm image I am using is \n\nhttps://uec-images.ubuntu.com/server/oneiric/current/oneiric-server-cloudimg-amd64.tar.gz\n\nas m1.small", 
            "date_created": "2011-11-15 14:08:09.985105+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Hi, this issue happend to me too, when I added my first compute-node to a devstack-install. There was no way to spin up a vm, with random disconnects/errors from rabbit and glance. Turned out I just exceeded the quota for RAM set in horizon, perhaps some meaningful error-message should be created ;-)", 
            "date_created": "2011-11-25 10:10:35.598201+00:00", 
            "author": "https://api.launchpad.net/1.0/~otaku"
        }, 
        {
            "content": "We finally tracked down the cause of this.  Complicated issue regarding the way that we return from rpc calls.  If an rpc call was returning None, then it was closing the connection early on the receiving end.  This is because we use None to signify the final return in a series of returned values via multicall.\n\nComstud is working on a fix for multicall so that None is a legal return.  In the meantime I found the method that was erroneously returning None and will be submitting a merge (and backport request) right away.\n\nIf you want to try out the fix right away, it is pretty simple:\n\ndiff --git a/nova/network/manager.py b/nova/network/manager.py\nindex 96d6dee..955cca0 100644\n--- a/nova/network/manager.py\n+++ b/nova/network/manager.py\n@@ -180,7 +180,7 @@ class RPCAllocateFixedIP(object):\n         perform network lookup on the far side of rpc.\n         \"\"\"\n         network = self.db.network_get(context, network_id)\n-        self.allocate_fixed_ip(context, instance_id, network, **kwargs)\n+        return self.allocate_fixed_ip(context, instance_id, network, **kwargs)", 
            "date_created": "2011-11-28 22:42:07.706943+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/1929\nCommitted: http://github.com/openstack/nova/commit/cabdc3b1f64b7f022a1c62a4cebce54a2deba807\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit cabdc3b1f64b7f022a1c62a4cebce54a2deba807\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Mon Nov 28 14:42:38 2011 -0800\n\n    Makes rpc_allocate_fixed_ip return properly\n    \n     * Fixes bug 855030\n     * Includes test\n    \n    Change-Id: If5b874fb0e4abd567445e67141d61942866cc5ec\n", 
            "date_created": "2011-11-28 23:41:21+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/1930\nCommitted: http://github.com/openstack/nova/commit/1e3b88ba20b9f9ab925ecd1238845adbc0157cb1\nSubmitter: Jenkins\nBranch:    stable/diablo\n\n tag in-stable-diablo\n done\n\ncommit 1e3b88ba20b9f9ab925ecd1238845adbc0157cb1\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Mon Nov 28 14:42:38 2011 -0800\n\n    Makes rpc_allocate_fixed_ip return properly\n    \n     * Fixes bug 855030\n     * Includes test\n    \n    Change-Id: If5b874fb0e4abd567445e67141d61942866cc5ec\n", 
            "date_created": "2011-11-29 06:41:15+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "This is fixed in precise.", 
            "date_created": "2011-12-07 16:38:01.699886+00:00", 
            "author": "https://api.launchpad.net/1.0/~zulcss"
        }, 
        {
            "content": "Could this be pushed to oneiric too Chuck?", 
            "date_created": "2012-03-09 16:25:15.354394+00:00", 
            "author": "https://api.launchpad.net/1.0/~tellis"
        }, 
        {
            "content": "oneiric has seen the end of its life and is no longer receiving any updates. Marking the oneiric task for this ticket as \"Won't Fix\".", 
            "date_created": "2014-12-03 09:19:55.088850+00:00", 
            "author": "https://api.launchpad.net/1.0/~r0lf"
        }
    ]
}