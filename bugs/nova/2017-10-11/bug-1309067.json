{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:34:30.030366+00:00", 
    "description": "On a compute restart sometimes the following error occurs and the compute fails to start:\n\n2014-04-17 03:36:09.527 26115 ERROR nova.openstack.common.threadgroup [-] 'dict' object has no attribute 'task_state'\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup Traceback (most recent call last):\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/openstack/common/threadgroup.py\", line 117, in wait\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     x.wait()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/openstack/common/threadgroup.py\", line 49, in wait\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     return self.thread.wait()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/eventlet/greenthread.py\", line 168, in wait\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     return self._exit_event.wait()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/eventlet/event.py\", line 116, in wait\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     return hubs.get_hub().switch()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/eventlet/hubs/hub.py\", line 187, in switch\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     return self.greenlet.switch()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/eventlet/greenthread.py\", line 194, in main\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     result = function(*args, **kwargs)\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/openstack/common/service.py\", line 480, in run_service\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     service.start()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/service.py\", line 177, in start\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     self.manager.init_host()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/compute/manager.py\", line 871, in init_host\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     self._init_instance(context, instance)\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/compute/manager.py\", line 731, in _init_instance\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     if instance.task_state == task_states.DELETING:\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup AttributeError: 'dict' object has no attribute 'task_state'\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup\n2014-04-17 04:01:15.145 27377 DEBUG nova.servicegroup.api [-] ServiceGroup driver defined as an instance of db __new__ /opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/servicegroup/api.py:62\n\nThe issue appears to lie with the line immediately above which performs an instance update and overwrites the instance object with a dict.\ninstance = self._instance_update(context, instance.uuid, task_state=None)", 
    "tags": [], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1309067", 
    "owner": "https://api.launchpad.net/1.0/~alaski", 
    "id": 1309067, 
    "index": 6138, 
    "created": "2014-04-17 15:27:28.296555+00:00", 
    "title": "Compute _init_instance changes instance from object to dict causing an AttributeError", 
    "comments": [
        {
            "content": "On a compute restart sometimes the following error occurs and the compute fails to start:\n\n2014-04-17 03:36:09.527 26115 ERROR nova.openstack.common.threadgroup [-] 'dict' object has no attribute 'task_state'\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup Traceback (most recent call last):\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/openstack/common/threadgroup.py\", line 117, in wait\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     x.wait()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/openstack/common/threadgroup.py\", line 49, in wait\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     return self.thread.wait()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/eventlet/greenthread.py\", line 168, in wait\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     return self._exit_event.wait()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/eventlet/event.py\", line 116, in wait\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     return hubs.get_hub().switch()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/eventlet/hubs/hub.py\", line 187, in switch\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     return self.greenlet.switch()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/eventlet/greenthread.py\", line 194, in main\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     result = function(*args, **kwargs)\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/openstack/common/service.py\", line 480, in run_service\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     service.start()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/service.py\", line 177, in start\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     self.manager.init_host()\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/compute/manager.py\", line 871, in init_host\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     self._init_instance(context, instance)\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup   File \"/opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/compute/manager.py\", line 731, in _init_instance\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup     if instance.task_state == task_states.DELETING:\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup AttributeError: 'dict' object has no attribute 'task_state'\n2014-04-17 03:36:09.527 26115 TRACE nova.openstack.common.threadgroup\n2014-04-17 04:01:15.145 27377 DEBUG nova.servicegroup.api [-] ServiceGroup driver defined as an instance of db __new__ /opt/rackstack/615.9/nova/lib/python2.6/site-packages/nova/servicegroup/api.py:62\n\nThe issue appears to lie with the line immediately above which performs an instance update and overwrites the instance object with a dict.\ninstance = self._instance_update(context, instance.uuid, task_state=None)", 
            "date_created": "2014-04-17 15:27:28.296555+00:00", 
            "author": "https://api.launchpad.net/1.0/~alaski"
        }, 
        {
            "content": "After the instance update the next compute start will succeed because it doesn't enter the same if block.", 
            "date_created": "2014-04-17 15:28:37.785015+00:00", 
            "author": "https://api.launchpad.net/1.0/~alaski"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/88400", 
            "date_created": "2014-04-17 18:58:38.598076+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "This was a regression in Icehouse: https://review.openstack.org/#/c/57967/", 
            "date_created": "2014-04-17 20:20:25.485315+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/88400\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b4b5254a56d808f2582784897364de1adafeb43a\nSubmitter: Jenkins\nBranch:    master\n\ncommit b4b5254a56d808f2582784897364de1adafeb43a\nAuthor: Andrew Laski <email address hidden>\nDate:   Thu Apr 17 14:51:06 2014 -0400\n\n    Don't overwrite instance object with dict in _init_instance()\n    \n    If a compute service is started while it has an instance in task_state\n    REBOOT_STARTED or REBOOT_STARTED_HARD it will trigger an instance update\n    which will overwrite the instance object with an instance dict.  This\n    causes an AttributeError on the next line when instance.task_state is\n    referenced.  This seems like a simple oversight and should be switched\n    to using the instance.save method.\n    \n    Change-Id: I44c3eab2c8821b66b0b9ef4696e56bd577ae8fed\n    Closes-Bug: 1309067\n", 
            "date_created": "2014-04-18 20:15:50.620815+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/88697", 
            "date_created": "2014-04-18 21:31:33.159368+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/88697\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7f9f3efc45a2b458e37ba391dbad763a02fca0f6\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 7f9f3efc45a2b458e37ba391dbad763a02fca0f6\nAuthor: Andrew Laski <email address hidden>\nDate:   Thu Apr 17 14:51:06 2014 -0400\n\n    Don't overwrite instance object with dict in _init_instance()\n    \n    If a compute service is started while it has an instance in task_state\n    REBOOT_STARTED or REBOOT_STARTED_HARD it will trigger an instance update\n    which will overwrite the instance object with an instance dict.  This\n    causes an AttributeError on the next line when instance.task_state is\n    referenced.  This seems like a simple oversight and should be switched\n    to using the instance.save method.\n    \n    Change-Id: I44c3eab2c8821b66b0b9ef4696e56bd577ae8fed\n    Closes-Bug: 1309067\n    (cherry picked from commit b4b5254a56d808f2582784897364de1adafeb43a)\n", 
            "date_created": "2014-04-22 00:32:45.257438+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }
    ]
}