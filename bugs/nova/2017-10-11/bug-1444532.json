{
    "status": "Invalid", 
    "last_updated": "2016-11-18 19:12:29.375587+00:00", 
    "description": "In Juno release (ubuntu packages), when you start nova-scheduler but database is down, the service never reconnects, the stacktrace is as follow :\n\n\nAUDIT nova.service [-] Starting scheduler node (version 2014.2.2)\nERROR nova.openstack.common.threadgroup [-] (OperationalError) (2003, \"Can't connect to MySQL server on '10.128.30.11' (111)\") None None\nTRACE nova.openstack.common.threadgroup Traceback (most recent call last):\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/threadgroup.py\", line 125, in wait\nTRACE nova.openstack.common.threadgroup     x.wait()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/threadgroup.py\", line 47, in wait\nTRACE nova.openstack.common.threadgroup     return self.thread.wait()\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 173, in wait\nTRACE nova.openstack.common.threadgroup     return self._exit_event.wait()\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 121, in wait\nTRACE nova.openstack.common.threadgroup     return hubs.get_hub().switch()\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 293, in switch\nTRACE nova.openstack.common.threadgroup     return self.greenlet.switch()\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 212, in main\nTRACE nova.openstack.common.threadgroup     result = function(*args, **kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/service.py\", line 490, in run_service\nTRACE nova.openstack.common.threadgroup     service.start()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 169, in start\nTRACE nova.openstack.common.threadgroup     self.host, self.binary)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/conductor/api.py\", line 161, in service_get_by_args\nTRACE nova.openstack.common.threadgroup     binary=binary, topic=None)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 949, in wrapper\nTRACE nova.openstack.common.threadgroup     return func(*args, **kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/server.py\", line 139, in inner\nTRACE nova.openstack.common.threadgroup     return func(*args, **kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/conductor/manager.py\", line 279, in service_get_all_by\nTRACE nova.openstack.common.threadgroup     result = self.db.service_get_by_args(context, host, binary)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 136, in service_get_by_args\nTRACE nova.openstack.common.threadgroup     return IMPL.service_get_by_args(context, host, binary)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 125, in wrapper\nTRACE nova.openstack.common.threadgroup     return f(*args, **kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 490, in service_get_by_args\nTRACE nova.openstack.common.threadgroup     result = model_query(context, models.Service).\\\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 213, in model_query\nTRACE nova.openstack.common.threadgroup     session = kwargs.get('session') or get_session(use_slave=use_slave)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 101, in get_session\nTRACE nova.openstack.common.threadgroup     facade = _create_facade_lazily()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 91, in _create_facade_lazily\nTRACE nova.openstack.common.threadgroup     _ENGINE_FACADE = db_session.EngineFacade.from_config(CONF)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py\", line 795, in from_config\nTRACE nova.openstack.common.threadgroup     retry_interval=conf.database.retry_interval)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py\", line 711, in __init__\nTRACE nova.openstack.common.threadgroup     **engine_kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py\", line 386, in create_engine\nTRACE nova.openstack.common.threadgroup     connection_trace=connection_trace\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/utils.py\", line 890, in __call__\nTRACE nova.openstack.common.threadgroup     self._url_from_target(target), target, arg, kw)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/utils.py\", line 927, in _dispatch_on\nTRACE nova.openstack.common.threadgroup     return self._dispatch_on_db_driver(dbname, driver, arg, kw)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/utils.py\", line 981, in _dispatch_on_db_driver\nTRACE nova.openstack.common.threadgroup     if self._invoke_fn(fn, arg, kw) is not None:\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/utils.py\", line 930, in _invoke_fn\nTRACE nova.openstack.common.threadgroup     return fn(*arg, **kw)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py\", line 456, in _init_events\nTRACE nova.openstack.common.threadgroup     realmode = engine.execute(\"SHOW VARIABLES LIKE 'sql_mode'\").fetchone()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1751, in execute\nTRACE nova.openstack.common.threadgroup     connection = self.contextual_connect(close_with_result=True)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1799, in contextual_connect\nTRACE nova.openstack.common.threadgroup     self.pool.connect(),\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 338, in connect\nTRACE nova.openstack.common.threadgroup     return _ConnectionFairy._checkout(self)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 641, in _checkout\nTRACE nova.openstack.common.threadgroup     fairy = _ConnectionRecord.checkout(pool)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 440, in checkout\nTRACE nova.openstack.common.threadgroup     rec = pool._do_get()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 961, in _do_get\nTRACE nova.openstack.common.threadgroup     return self._create_connection()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 285, in _create_connection\nTRACE nova.openstack.common.threadgroup     return _ConnectionRecord(self)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 411, in __init__\nTRACE nova.openstack.common.threadgroup     self.connection = self.__connect()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 537, in __connect\nTRACE nova.openstack.common.threadgroup     connection = self.__pool._creator()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/strategies.py\", line 96, in connect\nTRACE nova.openstack.common.threadgroup     connection_invalidated=invalidated\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 199, in raise_from_cause\nTRACE nova.openstack.common.threadgroup     reraise(type(exception), exception, tb=exc_tb)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/strategies.py\", line 90, in connect\nTRACE nova.openstack.common.threadgroup     return dialect.connect(*cargs, **cparams)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 377, in connect\nTRACE nova.openstack.common.threadgroup     return self.dbapi.connect(*cargs, **cparams)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/MySQLdb/__init__.py\", line 81, in Connect\nTRACE nova.openstack.common.threadgroup     return Connection(*args, **kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 187, in __init__\nTRACE nova.openstack.common.threadgroup     super(Connection, self).__init__(*args, **kwargs2)\nTRACE nova.openstack.common.threadgroup OperationalError: (OperationalError) (2003, \"Can't connect to MySQL server on '10.128.30.11' (111)\") None None\nTRACE nova.openstack.common.threadgroup \n\nThat doesnt happen once nova-scheduler connects, and database is gone, after the database is up again IT DOES reconnects, but the calls are from different part of the code ( nova.servicegroup.drivers.db ) and when it doesnt work its called from ( nova.openstack.common.threadgroup ), the stack when it works is as follow:\n\n\nERROR nova.servicegroup.drivers.db [-] model server went away\nTRACE nova.servicegroup.drivers.db Traceback (most recent call last):\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/servicegroup/drivers/db.py\", line 99, in _report_state\nTRACE nova.servicegroup.drivers.db     service.service_ref, state_catalog)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/conductor/api.py\", line 180, in service_update\nTRACE nova.servicegroup.drivers.db     return self._manager.service_update(context, service, values)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 949, in wrapper\nTRACE nova.servicegroup.drivers.db     return func(*args, **kwargs)\nTRACE nova.servicegroup.drivers.db   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/server.py\", line 139, in inner\nTRACE nova.servicegroup.drivers.db     return func(*args, **kwargs)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/conductor/manager.py\", line 320, in service_update\nTRACE nova.servicegroup.drivers.db     svc = self.db.service_update(context, service['id'], values)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 150, in service_update\nTRACE nova.servicegroup.drivers.db     return IMPL.service_update(context, service_id, values)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 125, in wrapper\nTRACE nova.servicegroup.drivers.db     return f(*args, **kwargs)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 181, in wrapped\nTRACE nova.servicegroup.drivers.db     return f(*args, **kwargs)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 524, in service_update\nTRACE nova.servicegroup.drivers.db     with_compute_node=False, session=session)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 424, in _service_get\nTRACE nova.servicegroup.drivers.db     result = query.first()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2341, in first\nTRACE nova.servicegroup.drivers.db     ret = list(self[0:1])\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2208, in __getitem__\nTRACE nova.servicegroup.drivers.db     return list(res)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2412, in __iter__\nTRACE nova.servicegroup.drivers.db     return self._execute_and_instances(context)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2425, in _execute_and_instances\nTRACE nova.servicegroup.drivers.db     close_with_result=True)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2416, in _connection_from_session\nTRACE nova.servicegroup.drivers.db     **kw)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 854, in connection\nTRACE nova.servicegroup.drivers.db     close_with_result=close_with_result)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 858, in _connection_for_bind\nTRACE nova.servicegroup.drivers.db     return self.transaction._connection_for_bind(engine)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 329, in _connection_for_bind\nTRACE nova.servicegroup.drivers.db     transaction = conn.begin()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 420, in begin\nTRACE nova.servicegroup.drivers.db     self.__transaction = RootTransaction(self)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1357, in __init__\nTRACE nova.servicegroup.drivers.db     self.connection._begin_impl(self)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 490, in _begin_impl\nTRACE nova.servicegroup.drivers.db     self.dispatch.begin(self)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/event/attr.py\", line 260, in __call__\nTRACE nova.servicegroup.drivers.db     fn(*args, **kw)\nTRACE nova.servicegroup.drivers.db   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py\", line 331, in _begin_ping_listener\nTRACE nova.servicegroup.drivers.db     connection.scalar(select([1]))\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 659, in scalar\nTRACE nova.servicegroup.drivers.db     return self.execute(object, *multiparams, **params).scalar()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 729, in execute\nTRACE nova.servicegroup.drivers.db     return meth(self, multiparams, params)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py\", line 321, in _execute_on_connection\nTRACE nova.servicegroup.drivers.db     return connection._execute_clauseelement(self, multiparams, params)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 826, in _execute_clauseelement\nTRACE nova.servicegroup.drivers.db     compiled_sql, distilled_params\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 893, in _execute_context\nTRACE nova.servicegroup.drivers.db     None, None)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1169, in _handle_dbapi_exception\nTRACE nova.servicegroup.drivers.db     dbapi_conn_wrapper = self.connection\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 236, in connection\nTRACE nova.servicegroup.drivers.db     return self._revalidate_connection()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 244, in _revalidate_connection\nTRACE nova.servicegroup.drivers.db     self.__connection = self.engine.raw_connection()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1848, in raw_connection\nTRACE nova.servicegroup.drivers.db     return self.pool.unique_connection()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 280, in unique_connection\nTRACE nova.servicegroup.drivers.db     return _ConnectionFairy._checkout(self)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 641, in _checkout\nTRACE nova.servicegroup.drivers.db     fairy = _ConnectionRecord.checkout(pool)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 442, in checkout\nTRACE nova.servicegroup.drivers.db     dbapi_connection = rec.get_connection()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 505, in get_connection\nTRACE nova.servicegroup.drivers.db     self.connection = self.__connect()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 537, in __connect\nTRACE nova.servicegroup.drivers.db     connection = self.__pool._creator()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/strategies.py\", line 96, in connect\nTRACE nova.servicegroup.drivers.db     connection_invalidated=invalidated\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 199, in raise_from_cause\nTRACE nova.servicegroup.drivers.db     reraise(type(exception), exception, tb=exc_tb)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/strategies.py\", line 90, in connect\nTRACE nova.servicegroup.drivers.db     return dialect.connect(*cargs, **cparams)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 377, in connect\nTRACE nova.servicegroup.drivers.db     return self.dbapi.connect(*cargs, **cparams)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/MySQLdb/__init__.py\", line 81, in Connect\nTRACE nova.servicegroup.drivers.db     return Connection(*args, **kwargs)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 187, in __init__\nTRACE nova.servicegroup.drivers.db     super(Connection, self).__init__(*args, **kwargs2)\nTRACE nova.servicegroup.drivers.db OperationalError: (OperationalError) (2003, \"Can't connect to MySQL server on '10.128.30.11' (111)\") None None\nTRACE nova.servicegroup.drivers.db", 
    "tags": [
        "juno", 
        "nova", 
        "nova-scheduler"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1444532", 
    "owner": "None", 
    "id": 1444532, 
    "index": 5507, 
    "created": "2015-04-15 15:20:55.670482+00:00", 
    "title": "nova-scheduler doesnt reconnect to databases when started and database is down", 
    "comments": [
        {
            "content": "In Juno release (ubuntu packages), when you start nova-scheduler but database is down, the service never reconnects, the stacktrace is as follow :\n\n\nAUDIT nova.service [-] Starting scheduler node (version 2014.2.2)\nERROR nova.openstack.common.threadgroup [-] (OperationalError) (2003, \"Can't connect to MySQL server on '10.128.30.11' (111)\") None None\nTRACE nova.openstack.common.threadgroup Traceback (most recent call last):\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/threadgroup.py\", line 125, in wait\nTRACE nova.openstack.common.threadgroup     x.wait()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/threadgroup.py\", line 47, in wait\nTRACE nova.openstack.common.threadgroup     return self.thread.wait()\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 173, in wait\nTRACE nova.openstack.common.threadgroup     return self._exit_event.wait()\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 121, in wait\nTRACE nova.openstack.common.threadgroup     return hubs.get_hub().switch()\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 293, in switch\nTRACE nova.openstack.common.threadgroup     return self.greenlet.switch()\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 212, in main\nTRACE nova.openstack.common.threadgroup     result = function(*args, **kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/service.py\", line 490, in run_service\nTRACE nova.openstack.common.threadgroup     service.start()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 169, in start\nTRACE nova.openstack.common.threadgroup     self.host, self.binary)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/conductor/api.py\", line 161, in service_get_by_args\nTRACE nova.openstack.common.threadgroup     binary=binary, topic=None)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 949, in wrapper\nTRACE nova.openstack.common.threadgroup     return func(*args, **kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/server.py\", line 139, in inner\nTRACE nova.openstack.common.threadgroup     return func(*args, **kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/conductor/manager.py\", line 279, in service_get_all_by\nTRACE nova.openstack.common.threadgroup     result = self.db.service_get_by_args(context, host, binary)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 136, in service_get_by_args\nTRACE nova.openstack.common.threadgroup     return IMPL.service_get_by_args(context, host, binary)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 125, in wrapper\nTRACE nova.openstack.common.threadgroup     return f(*args, **kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 490, in service_get_by_args\nTRACE nova.openstack.common.threadgroup     result = model_query(context, models.Service).\\\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 213, in model_query\nTRACE nova.openstack.common.threadgroup     session = kwargs.get('session') or get_session(use_slave=use_slave)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 101, in get_session\nTRACE nova.openstack.common.threadgroup     facade = _create_facade_lazily()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 91, in _create_facade_lazily\nTRACE nova.openstack.common.threadgroup     _ENGINE_FACADE = db_session.EngineFacade.from_config(CONF)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py\", line 795, in from_config\nTRACE nova.openstack.common.threadgroup     retry_interval=conf.database.retry_interval)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py\", line 711, in __init__\nTRACE nova.openstack.common.threadgroup     **engine_kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py\", line 386, in create_engine\nTRACE nova.openstack.common.threadgroup     connection_trace=connection_trace\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/utils.py\", line 890, in __call__\nTRACE nova.openstack.common.threadgroup     self._url_from_target(target), target, arg, kw)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/utils.py\", line 927, in _dispatch_on\nTRACE nova.openstack.common.threadgroup     return self._dispatch_on_db_driver(dbname, driver, arg, kw)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/utils.py\", line 981, in _dispatch_on_db_driver\nTRACE nova.openstack.common.threadgroup     if self._invoke_fn(fn, arg, kw) is not None:\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/utils.py\", line 930, in _invoke_fn\nTRACE nova.openstack.common.threadgroup     return fn(*arg, **kw)\nTRACE nova.openstack.common.threadgroup   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py\", line 456, in _init_events\nTRACE nova.openstack.common.threadgroup     realmode = engine.execute(\"SHOW VARIABLES LIKE 'sql_mode'\").fetchone()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1751, in execute\nTRACE nova.openstack.common.threadgroup     connection = self.contextual_connect(close_with_result=True)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1799, in contextual_connect\nTRACE nova.openstack.common.threadgroup     self.pool.connect(),\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 338, in connect\nTRACE nova.openstack.common.threadgroup     return _ConnectionFairy._checkout(self)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 641, in _checkout\nTRACE nova.openstack.common.threadgroup     fairy = _ConnectionRecord.checkout(pool)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 440, in checkout\nTRACE nova.openstack.common.threadgroup     rec = pool._do_get()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 961, in _do_get\nTRACE nova.openstack.common.threadgroup     return self._create_connection()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 285, in _create_connection\nTRACE nova.openstack.common.threadgroup     return _ConnectionRecord(self)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 411, in __init__\nTRACE nova.openstack.common.threadgroup     self.connection = self.__connect()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 537, in __connect\nTRACE nova.openstack.common.threadgroup     connection = self.__pool._creator()\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/strategies.py\", line 96, in connect\nTRACE nova.openstack.common.threadgroup     connection_invalidated=invalidated\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 199, in raise_from_cause\nTRACE nova.openstack.common.threadgroup     reraise(type(exception), exception, tb=exc_tb)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/strategies.py\", line 90, in connect\nTRACE nova.openstack.common.threadgroup     return dialect.connect(*cargs, **cparams)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 377, in connect\nTRACE nova.openstack.common.threadgroup     return self.dbapi.connect(*cargs, **cparams)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/MySQLdb/__init__.py\", line 81, in Connect\nTRACE nova.openstack.common.threadgroup     return Connection(*args, **kwargs)\nTRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 187, in __init__\nTRACE nova.openstack.common.threadgroup     super(Connection, self).__init__(*args, **kwargs2)\nTRACE nova.openstack.common.threadgroup OperationalError: (OperationalError) (2003, \"Can't connect to MySQL server on '10.128.30.11' (111)\") None None\nTRACE nova.openstack.common.threadgroup \n\nThat doesnt happen once nova-scheduler connects, and database is gone, after the database is up again IT DOES reconnects, but the calls are from different part of the code ( nova.servicegroup.drivers.db ) and when it doesnt work its called from ( nova.openstack.common.threadgroup ), the stack when it works is as follow:\n\n\nERROR nova.servicegroup.drivers.db [-] model server went away\nTRACE nova.servicegroup.drivers.db Traceback (most recent call last):\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/servicegroup/drivers/db.py\", line 99, in _report_state\nTRACE nova.servicegroup.drivers.db     service.service_ref, state_catalog)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/conductor/api.py\", line 180, in service_update\nTRACE nova.servicegroup.drivers.db     return self._manager.service_update(context, service, values)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 949, in wrapper\nTRACE nova.servicegroup.drivers.db     return func(*args, **kwargs)\nTRACE nova.servicegroup.drivers.db   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/server.py\", line 139, in inner\nTRACE nova.servicegroup.drivers.db     return func(*args, **kwargs)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/conductor/manager.py\", line 320, in service_update\nTRACE nova.servicegroup.drivers.db     svc = self.db.service_update(context, service['id'], values)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 150, in service_update\nTRACE nova.servicegroup.drivers.db     return IMPL.service_update(context, service_id, values)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 125, in wrapper\nTRACE nova.servicegroup.drivers.db     return f(*args, **kwargs)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 181, in wrapped\nTRACE nova.servicegroup.drivers.db     return f(*args, **kwargs)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 524, in service_update\nTRACE nova.servicegroup.drivers.db     with_compute_node=False, session=session)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 424, in _service_get\nTRACE nova.servicegroup.drivers.db     result = query.first()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2341, in first\nTRACE nova.servicegroup.drivers.db     ret = list(self[0:1])\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2208, in __getitem__\nTRACE nova.servicegroup.drivers.db     return list(res)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2412, in __iter__\nTRACE nova.servicegroup.drivers.db     return self._execute_and_instances(context)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2425, in _execute_and_instances\nTRACE nova.servicegroup.drivers.db     close_with_result=True)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2416, in _connection_from_session\nTRACE nova.servicegroup.drivers.db     **kw)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 854, in connection\nTRACE nova.servicegroup.drivers.db     close_with_result=close_with_result)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 858, in _connection_for_bind\nTRACE nova.servicegroup.drivers.db     return self.transaction._connection_for_bind(engine)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 329, in _connection_for_bind\nTRACE nova.servicegroup.drivers.db     transaction = conn.begin()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 420, in begin\nTRACE nova.servicegroup.drivers.db     self.__transaction = RootTransaction(self)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1357, in __init__\nTRACE nova.servicegroup.drivers.db     self.connection._begin_impl(self)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 490, in _begin_impl\nTRACE nova.servicegroup.drivers.db     self.dispatch.begin(self)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/event/attr.py\", line 260, in __call__\nTRACE nova.servicegroup.drivers.db     fn(*args, **kw)\nTRACE nova.servicegroup.drivers.db   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py\", line 331, in _begin_ping_listener\nTRACE nova.servicegroup.drivers.db     connection.scalar(select([1]))\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 659, in scalar\nTRACE nova.servicegroup.drivers.db     return self.execute(object, *multiparams, **params).scalar()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 729, in execute\nTRACE nova.servicegroup.drivers.db     return meth(self, multiparams, params)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py\", line 321, in _execute_on_connection\nTRACE nova.servicegroup.drivers.db     return connection._execute_clauseelement(self, multiparams, params)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 826, in _execute_clauseelement\nTRACE nova.servicegroup.drivers.db     compiled_sql, distilled_params\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 893, in _execute_context\nTRACE nova.servicegroup.drivers.db     None, None)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1169, in _handle_dbapi_exception\nTRACE nova.servicegroup.drivers.db     dbapi_conn_wrapper = self.connection\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 236, in connection\nTRACE nova.servicegroup.drivers.db     return self._revalidate_connection()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 244, in _revalidate_connection\nTRACE nova.servicegroup.drivers.db     self.__connection = self.engine.raw_connection()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1848, in raw_connection\nTRACE nova.servicegroup.drivers.db     return self.pool.unique_connection()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 280, in unique_connection\nTRACE nova.servicegroup.drivers.db     return _ConnectionFairy._checkout(self)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 641, in _checkout\nTRACE nova.servicegroup.drivers.db     fairy = _ConnectionRecord.checkout(pool)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 442, in checkout\nTRACE nova.servicegroup.drivers.db     dbapi_connection = rec.get_connection()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 505, in get_connection\nTRACE nova.servicegroup.drivers.db     self.connection = self.__connect()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/pool.py\", line 537, in __connect\nTRACE nova.servicegroup.drivers.db     connection = self.__pool._creator()\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/strategies.py\", line 96, in connect\nTRACE nova.servicegroup.drivers.db     connection_invalidated=invalidated\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 199, in raise_from_cause\nTRACE nova.servicegroup.drivers.db     reraise(type(exception), exception, tb=exc_tb)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/strategies.py\", line 90, in connect\nTRACE nova.servicegroup.drivers.db     return dialect.connect(*cargs, **cparams)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 377, in connect\nTRACE nova.servicegroup.drivers.db     return self.dbapi.connect(*cargs, **cparams)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/MySQLdb/__init__.py\", line 81, in Connect\nTRACE nova.servicegroup.drivers.db     return Connection(*args, **kwargs)\nTRACE nova.servicegroup.drivers.db   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 187, in __init__\nTRACE nova.servicegroup.drivers.db     super(Connection, self).__init__(*args, **kwargs2)\nTRACE nova.servicegroup.drivers.db OperationalError: (OperationalError) (2003, \"Can't connect to MySQL server on '10.128.30.11' (111)\") None None\nTRACE nova.servicegroup.drivers.db", 
            "date_created": "2015-04-15 15:20:55.670482+00:00", 
            "author": "https://api.launchpad.net/1.0/~alejandro-f"
        }, 
        {
            "content": "I can not repro the err you mentioned.Could you give more env about it?\nI tried to repro it. I didn't see the server never reconnect mysql.", 
            "date_created": "2015-04-21 07:36:21.387010+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhaobo6"
        }, 
        {
            "content": "thanks for the reply!\nbasically what i do, is to shutdown the databa se, and restart nova-scheduler.\nyou get the scheduler logs not able to connect to database, then start the database and try to launch a vm, youll get the scheduler saying it cant connect to an already up database.\n\ntell me if you can reproduce it.", 
            "date_created": "2015-04-21 12:39:36.194672+00:00", 
            "author": "https://api.launchpad.net/1.0/~alejandro-f"
        }, 
        {
            "content": "Not sure it's Nova related, since the connection is managed by MySQLdb here.\nThat's all due to the configuration done on SQLA like said in http://docs.sqlalchemy.org/en/rel_1_0/core/engines.html\n\nPlease check your \"connection\" option for the nova.conf file as this is how it's called.", 
            "date_created": "2015-05-05 20:55:03.609984+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }
    ]
}