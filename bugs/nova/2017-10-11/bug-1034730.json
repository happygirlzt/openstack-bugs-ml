{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:44:03.920618+00:00", 
    "description": "Hi! \nI'm using devstack and I created the follow an instance associated with a 5gb volume, both of them created successfully (I have the logs if needed).\nThen I tried to create a snapshot of my instance but this snapshot got queued 'forever' (it's still queued btw). Checking the logs, I found on nova-cpu log the follow trace (which I already reproduced 3 times following the steps above):\n\n2012-08-08 20:28:31 AUDIT nova.compute.manager [req-7b1bb5b3-e70e-4088-b6d1-0946c24e6445 admin demo] [instance: 9cdf4843-54d1-497e-bd70-3f3157e8ca03] instance snapshotting\ninstance snapshotting\n2012-08-08 20:28:38 DEBUG nova.manager [-] Running periodic task ComputeManager._poll_unconfirmed_resizes from (pid=31416) periodic_tasks /opt/stack/nova/nova/manager.py:170\nRunning periodic task ComputeManager._poll_unconfirmed_resizes\n2012-08-08 20:28:40 DEBUG nova.utils [req-7b1bb5b3-e70e-4088-b6d1-0946c24e6445 admin demo] Running cmd (subprocess): sudo /usr/local/bin/nova-rootwrap /etc/nova/rootwrap.conf qemu\n-img snapshot -c 1479c0152ae1453e96018275fc3c9197 None from (pid=31416) execute /opt/stack/nova/nova/utils.py:178\nRunning cmd (subprocess): sudo /usr/local/bin/nova-rootwrap /etc/nova/rootwrap.conf qemu-img snapshot -c 1479c0152ae1453e96018275fc3c9197 None\n2012-08-08 20:28:40 DEBUG nova.utils [req-7b1bb5b3-e70e-4088-b6d1-0946c24e6445 admin demo] Result was 1 from (pid=31416) execute /opt/stack/nova/nova/utils.py:194\nResult was 1\n2012-08-08 20:28:40 ERROR nova.openstack.common.rpc.amqp [-] Exception during message handling\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 275, in _process_data\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 210, in decorated_function\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     instance_uuid, e, sys.exc_info())\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 199, in decorated_function\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 1118, in snapshot_instance\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.driver.snapshot(context, instance, image_id)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 798, in snapshot\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     libvirt_utils.create_snapshot(disk_path, snapshot_name)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 308, in create_snapshot\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     execute(*qemu_img_cmd, run_as_root=True)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 54, in execute\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return utils.execute(*args, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/utils.py\", line 201, in execute\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     cmd=' '.join(cmd))\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp ProcessExecutionError: Unexpected error while running command.\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Command: sudo /usr/local/bin/nova-rootwrap /etc/nova/rootwrap.conf qemu-img snapshot -c 1479c0152ae1453e96018275fc3c9197 None\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Exit code: 1\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Stdout: ''\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Stderr: \"qemu-img: Could not open 'None': No such file or directory\\n\"\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp \nException during message handling\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 275, in _process_data\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 210, in decorated_function\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     instance_uuid, e, sys.exc_info())\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 199, in decorated_function\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 1118, in snapshot_instance\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.driver.snapshot(context, instance, image_id)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 798, in snapshot\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     libvirt_utils.create_snapshot(disk_path, snapshot_name)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 308, in create_snapshot\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     execute(*qemu_img_cmd, run_as_root=True)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 54, in execute\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return utils.execute(*args, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/utils.py\", line 201, in execute\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     cmd=' '.join(cmd))\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp ProcessExecutionError: Unexpected error while running command.\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Command: sudo /usr/local/bin/nova-rootwrap /etc/nova/rootwrap.conf qemu-img snapshot -c 1479c0152ae1453e96018275fc3c9197 None\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Exit code: 1\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Stdout: ''\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Stderr: \"qemu-img: Could not open 'None': No such file or directory\\n\"\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp \n\nIt's clear in the logs that  the image id to be snapshoted was lost somehow, I'm trying to figure out where, but it's late and more heads are better than one.\n\nRegards,\n\nMauro Rodrigues", 
    "tags": [
        "snapshot"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1034730", 
    "owner": "https://api.launchpad.net/1.0/~eglynn", 
    "id": 1034730, 
    "index": 3001, 
    "created": "2012-08-09 04:02:33.113152+00:00", 
    "title": "qemu-img receives  'None' as source image to snapshot", 
    "comments": [
        {
            "content": "Hi! \nI'm using devstack and I created the follow an instance associated with a 5gb volume, both of them created successfully (I have the logs if needed).\nThen I tried to create a snapshot of my instance but this snapshot got queued 'forever' (it's still queued btw). Checking the logs, I found on nova-cpu log the follow trace (which I already reproduced 3 times following the steps above):\n\n2012-08-08 20:28:31 AUDIT nova.compute.manager [req-7b1bb5b3-e70e-4088-b6d1-0946c24e6445 admin demo] [instance: 9cdf4843-54d1-497e-bd70-3f3157e8ca03] instance snapshotting\ninstance snapshotting\n2012-08-08 20:28:38 DEBUG nova.manager [-] Running periodic task ComputeManager._poll_unconfirmed_resizes from (pid=31416) periodic_tasks /opt/stack/nova/nova/manager.py:170\nRunning periodic task ComputeManager._poll_unconfirmed_resizes\n2012-08-08 20:28:40 DEBUG nova.utils [req-7b1bb5b3-e70e-4088-b6d1-0946c24e6445 admin demo] Running cmd (subprocess): sudo /usr/local/bin/nova-rootwrap /etc/nova/rootwrap.conf qemu\n-img snapshot -c 1479c0152ae1453e96018275fc3c9197 None from (pid=31416) execute /opt/stack/nova/nova/utils.py:178\nRunning cmd (subprocess): sudo /usr/local/bin/nova-rootwrap /etc/nova/rootwrap.conf qemu-img snapshot -c 1479c0152ae1453e96018275fc3c9197 None\n2012-08-08 20:28:40 DEBUG nova.utils [req-7b1bb5b3-e70e-4088-b6d1-0946c24e6445 admin demo] Result was 1 from (pid=31416) execute /opt/stack/nova/nova/utils.py:194\nResult was 1\n2012-08-08 20:28:40 ERROR nova.openstack.common.rpc.amqp [-] Exception during message handling\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 275, in _process_data\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 210, in decorated_function\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     instance_uuid, e, sys.exc_info())\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 199, in decorated_function\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 1118, in snapshot_instance\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.driver.snapshot(context, instance, image_id)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 798, in snapshot\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     libvirt_utils.create_snapshot(disk_path, snapshot_name)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 308, in create_snapshot\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     execute(*qemu_img_cmd, run_as_root=True)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 54, in execute\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return utils.execute(*args, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/utils.py\", line 201, in execute\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     cmd=' '.join(cmd))\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp ProcessExecutionError: Unexpected error while running command.\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Command: sudo /usr/local/bin/nova-rootwrap /etc/nova/rootwrap.conf qemu-img snapshot -c 1479c0152ae1453e96018275fc3c9197 None\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Exit code: 1\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Stdout: ''\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Stderr: \"qemu-img: Could not open 'None': No such file or directory\\n\"\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp \nException during message handling\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 275, in _process_data\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 210, in decorated_function\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     instance_uuid, e, sys.exc_info())\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 199, in decorated_function\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 1118, in snapshot_instance\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.driver.snapshot(context, instance, image_id)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 798, in snapshot\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     libvirt_utils.create_snapshot(disk_path, snapshot_name)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 308, in create_snapshot\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     execute(*qemu_img_cmd, run_as_root=True)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 54, in execute\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     return utils.execute(*args, **kwargs)\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/utils.py\", line 201, in execute\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp     cmd=' '.join(cmd))\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp ProcessExecutionError: Unexpected error while running command.\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Command: sudo /usr/local/bin/nova-rootwrap /etc/nova/rootwrap.conf qemu-img snapshot -c 1479c0152ae1453e96018275fc3c9197 None\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Exit code: 1\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Stdout: ''\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp Stderr: \"qemu-img: Could not open 'None': No such file or directory\\n\"\n2012-08-08 20:28:40 TRACE nova.openstack.common.rpc.amqp \n\nIt's clear in the logs that  the image id to be snapshoted was lost somehow, I'm trying to figure out where, but it's late and more heads are better than one.\n\nRegards,\n\nMauro Rodrigues", 
            "date_created": "2012-08-09 04:02:33.113152+00:00", 
            "author": "https://api.launchpad.net/1.0/~maurosr"
        }, 
        {
            "content": "", 
            "date_created": "2012-08-09 04:02:33.113152+00:00", 
            "author": "https://api.launchpad.net/1.0/~maurosr"
        }, 
        {
            "content": "Investigating for a little while I realized that the problem just happens with instances with a volume attached. \n\nSpecifically the snapshot of an instance waits for the disk's file source (you can find that in /opt/stack/nova/nova/virt/libvirt/driver.py\", line 787: source = domain.find('devices/disk/source') and then looking for source.get('file')).\n\nThis information is gathered from a xml in /opt/stack/nova/instances/instance-<number>/libvirt.xml\n\nWhen you don't attach a volume to instance during its creation the xml has the follow disk information:\n\n     <disk type=\"file\" device=\"disk\">\n       <driver name=\"qemu\" type=\"qcow2\" cache=\"none\"/>\n       <source file=\"/opt/stack/nova/instances/instance-0000000a/disk\"/>\n       <target bus=\"virtio\" dev=\"vda\"/>\n     </disk>\n\nThe file attribute is present.\n\nAlthough when attach the volume during instance creation: \n\n    <disk type='block' device='disk'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <source dev='/dev/disk/by-path/ip-9.114.219.72:3260-iscsi-iqn.2010-10.org.openstack:volume-64d0a0e0-1732-44a0-84fa-132461fddc7e-lun-1s'/>\n      <target dev='vda' bus='virtio'/>\n      <alias name='virtio-disk0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </disk>\n\nThe reference to the source now is dev=<value>, so the snapshot crashes when look for the file key on this xml.\n", 
            "date_created": "2012-08-10 06:15:29.685650+00:00", 
            "author": "https://api.launchpad.net/1.0/~maurosr"
        }, 
        {
            "content": "Hi Mauro,\n\nPresumably by \"attach the volume during instance creation\", you mean a booted-from-volume instance?", 
            "date_created": "2012-09-07 11:20:09.199695+00:00", 
            "author": "https://api.launchpad.net/1.0/~eglynn"
        }, 
        {
            "content": "exactly Eoghan! ", 
            "date_created": "2012-09-07 16:20:14.247658+00:00", 
            "author": "https://api.launchpad.net/1.0/~maurosr"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/12583", 
            "date_created": "2012-09-07 16:56:36.647689+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/12583\nCommitted: http://github.com/openstack/nova/commit/c3476b5ca7ab5237d3cb8a84fcb7a3292237b764\nSubmitter: Jenkins\nBranch:    master\n\ncommit c3476b5ca7ab5237d3cb8a84fcb7a3292237b764\nAuthor: Eoghan Glynn <email address hidden>\nDate:   Fri Sep 7 12:45:27 2012 +0000\n\n    Create image of volume-backed instance via native API\n    \n    Fixes bug 1034730.\n    \n    Avoids 'qemu-img snapshot' failure when native API create_image action\n    is applied to a volume-backed instance.\n    \n    Applies the same logic as is used to create a placeholder image from\n    a volume-backed instance via the EC2 API CreateImage operation, with\n    the now-common code refactored into the ComputeAPI class.\n    \n    Change-Id: I624584ae9adbf30629f0e814d340da6b9e6e59bd\n", 
            "date_created": "2012-09-09 13:11:24.042546+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}