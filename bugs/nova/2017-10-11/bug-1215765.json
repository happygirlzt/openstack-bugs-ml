{
    "status": "Fix Released", 
    "last_updated": "2014-03-21 11:08:30.683389+00:00", 
    "description": "My test environment is use IBM storwize storage, but I think all of volume drive will have this bug when attach volume with hyper-V compute node instance.\n\nAfter create one volume in cinder volume node and one instance in hyper-V compute node. When attach this volume, from cinder/api.log. I got the following error message:\n\n2013-08-19 13:30:38.427 8899 ERROR cinder.openstack.common.rpc.common [req-65226e05-392e-437d-ad72-49e1406c370d 911c0704817d4eb7b79d2e5e42061d67 44804665fbab4368bb306d97de7e6171] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/amqp.py\", line 433, in _process_data\\n    **args)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/dispatcher.py\", line 148, in dispatch\\n    return getattr(proxyobj, method)(ctxt, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/volume/manager.py\", line 520, in initialize_connection\\n    return self.driver.initialize_connection(volume_ref, connector)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/volume/drivers/storwize_svc.py\", line 697, in initialize_connection\\n    host_name = connector[\\'host\\']\\n', \"KeyError: 'host'\\n\"]\n2013-08-19 13:30:40.529 8899 ERROR cinder.openstack.common.rpc.amqp [req-051dbe31-a889-4a21-a03a-a7d5bea0acd8 911c0704817d4eb7b79d2e5e42061d67 44804665fbab4368bb306d97de7e6171] Exception during message handling\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/amqp.py\", line 433, in _process_data\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp     **args)\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/dispatcher.py\", line 148, in dispatch\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/cinder/volume/manager.py\", line 520, in initialize_connection\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp     return self.driver.initialize_connection(volume_ref, connector)\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/cinder/volume/drivers/storwize_svc.py\", line 697, in initialize_connection\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp     host_name = connector['host']\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp KeyError: 'host'\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp\n2013-08-19 13:30:40.530 8899 ERROR cinder.openstack.common.rpc.common [req-051dbe31-a889-4a21-a03a-a7d5bea0acd8 911c0704817d4eb7b79d2e5e42061d67 44804665fbab4368bb306d97de7e6171] Returning exception 'host' to caller\n2013-08-19 13:30:40.531 8899 ERROR cinder.openstack.common.rpc.common [req-051dbe31-a889-4a21-a03a-a7d5bea0acd8 911c0704817d4eb7b79d2e5e42061d67 44804665fbab4368bb306d97de7e6171] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/amqp.py\", line 433, in _process_data\\n    **args)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/dispatcher.py\", line 148, in dispatch\\n    return getattr(proxyobj, method)(ctxt, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/volume/manager.py\", line 520, in initialize_connection\\n    return self.driver.initialize_connection(volume_ref, connector)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/volume/drivers/storwize_svc.py\", line 697, in initialize_connection\\n    host_name = connector[\\'host\\']\\n', \"KeyError: 'host'\\n\"] \n\n\nAfter investigated, I found the root cause of this bug is from nova.  I found in hyperV compute node,  nova/compute.py will call \"get_volume_connector\" method to get volume connector, and it just return 'ip' and 'initiator' info in this connector, do not contain 'host' info in this connector, so in cinder part, it need to check \"host\", it will throws  KeyError: host problem.", 
    "tags": [
        "hyper-v"
    ], 
    "importance": "Undecided", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1215765", 
    "owner": "https://api.launchpad.net/1.0/~alexpilotti", 
    "id": 1215765, 
    "index": 4007, 
    "created": "2013-08-23 06:34:40.258244+00:00", 
    "title": "Attach volume failed with hyper-v compute node instance", 
    "comments": [
        {
            "content": "My test environment is use IBM storwize storage, but I think all of volume drive will have this bug when attach volume with hyper-V compute node instance.\n\nAfter create one volume in cinder volume node and one instance in hyper-V compute node. When attach this volume, from cinder/api.log. I got the following error message:\n\n2013-08-19 13:30:38.427 8899 ERROR cinder.openstack.common.rpc.common [req-65226e05-392e-437d-ad72-49e1406c370d 911c0704817d4eb7b79d2e5e42061d67 44804665fbab4368bb306d97de7e6171] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/amqp.py\", line 433, in _process_data\\n    **args)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/dispatcher.py\", line 148, in dispatch\\n    return getattr(proxyobj, method)(ctxt, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/volume/manager.py\", line 520, in initialize_connection\\n    return self.driver.initialize_connection(volume_ref, connector)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/volume/drivers/storwize_svc.py\", line 697, in initialize_connection\\n    host_name = connector[\\'host\\']\\n', \"KeyError: 'host'\\n\"]\n2013-08-19 13:30:40.529 8899 ERROR cinder.openstack.common.rpc.amqp [req-051dbe31-a889-4a21-a03a-a7d5bea0acd8 911c0704817d4eb7b79d2e5e42061d67 44804665fbab4368bb306d97de7e6171] Exception during message handling\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/amqp.py\", line 433, in _process_data\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp     **args)\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/dispatcher.py\", line 148, in dispatch\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/cinder/volume/manager.py\", line 520, in initialize_connection\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp     return self.driver.initialize_connection(volume_ref, connector)\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/cinder/volume/drivers/storwize_svc.py\", line 697, in initialize_connection\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp     host_name = connector['host']\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp KeyError: 'host'\n2013-08-19 13:30:40.529 8899 TRACE cinder.openstack.common.rpc.amqp\n2013-08-19 13:30:40.530 8899 ERROR cinder.openstack.common.rpc.common [req-051dbe31-a889-4a21-a03a-a7d5bea0acd8 911c0704817d4eb7b79d2e5e42061d67 44804665fbab4368bb306d97de7e6171] Returning exception 'host' to caller\n2013-08-19 13:30:40.531 8899 ERROR cinder.openstack.common.rpc.common [req-051dbe31-a889-4a21-a03a-a7d5bea0acd8 911c0704817d4eb7b79d2e5e42061d67 44804665fbab4368bb306d97de7e6171] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/amqp.py\", line 433, in _process_data\\n    **args)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/openstack/common/rpc/dispatcher.py\", line 148, in dispatch\\n    return getattr(proxyobj, method)(ctxt, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/volume/manager.py\", line 520, in initialize_connection\\n    return self.driver.initialize_connection(volume_ref, connector)\\n', '  File \"/usr/lib/python2.6/site-packages/cinder/volume/drivers/storwize_svc.py\", line 697, in initialize_connection\\n    host_name = connector[\\'host\\']\\n', \"KeyError: 'host'\\n\"] \n\n\nAfter investigated, I found the root cause of this bug is from nova.  I found in hyperV compute node,  nova/compute.py will call \"get_volume_connector\" method to get volume connector, and it just return 'ip' and 'initiator' info in this connector, do not contain 'host' info in this connector, so in cinder part, it need to check \"host\", it will throws  KeyError: host problem.", 
            "date_created": "2013-08-23 06:34:40.258244+00:00", 
            "author": "https://api.launchpad.net/1.0/~dzyu"
        }, 
        {
            "content": "Looks like the missing host key is the issue, the base driver class even lists it in the docstring:\n\nhttps://github.com/openstack/nova/blob/master/nova/virt/driver.py#L927\n\nI looked at the other virt drivers that support attach/detach volume and they return host in the volume connector dict also.", 
            "date_created": "2013-08-24 18:24:15.580273+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Hi, what version of Nova are you using? \n\n", 
            "date_created": "2013-08-24 18:32:50.574942+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }, 
        {
            "content": "Does this patch fix your problem?", 
            "date_created": "2013-08-24 18:35:18.991385+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Alex, this is probably master havana since the originator is IBM.  Assuming the cinderclient is 1.0.5 and the cinder API is v1.  I'll be posting a patch to Gerrit shortly.", 
            "date_created": "2013-08-24 18:37:35.825890+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "https://github.com/openstack/nova/blob/master/nova/virt/hyperv/volumeops.py#L178\n\nBy comparison, the libvirt driver adds a \"host\" key:\n\nhttps://github.com/openstack/nova/blob/master/nova/virt/libvirt/driver.py#L964\n\nAs Matt noted, it's just a matter of adding the \"host\" key to the returned set. Interestingly, this error never showed up with other Cinder storage drivers. \n", 
            "date_created": "2013-08-24 18:38:51.526227+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/43592", 
            "date_created": "2013-08-24 18:47:40.758252+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi Matt, looks like you posted the patch here while I was sending a fix for review.\n\nI preferred to use the CONF.host option for consistency with libvirt.\nPlease let me know what do you think.\n \nThanks,\n\nAlessandro", 
            "date_created": "2013-08-24 18:50:30.318734+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/43592\nCommitted: http://github.com/openstack/nova/commit/02ce8504184d3f61a5fb3d80c5a517c337685cde\nSubmitter: Jenkins\nBranch:    master\n\ncommit 02ce8504184d3f61a5fb3d80c5a517c337685cde\nAuthor: Alessandro Pilotti <email address hidden>\nDate:   Sat Aug 24 21:42:24 2013 +0300\n\n    Fixes missing host in Hyper-V get_volume_connector\n    \n    Fixes bug: #1215765\n    \n    The Hyper-V driver is not returning the host in the\n    \"get_volume_connector\" method.\n    \n    This commit fixes the issue by adding the \"host\" key to the dictionary\n    returned by the method.\n    \n    Adds also a unit test for get_volume_connector.\n    \n    Change-Id: Ic74882e54994f957bf6d2bb75bbd53c6a346042e\n", 
            "date_created": "2013-09-01 10:02:02.246120+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}