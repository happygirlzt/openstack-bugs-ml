{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:43:45.080480+00:00", 
    "description": "Steps to reproduce:\n1. use a kvm host that is running as a vm on an esx host with 2048 Megs of RAM\n2. on the controller do \"nova boot --flavor 1 --image <valid-image-id> vm1\n3. do the same nova boot command to create a vm2, vm3, vm4,.....\n4. at some point, the nova boot command will fail because there won't be enough memory.  You will see a message about ram filter in the nova-scheduler: \n\n2012-04-03 12:37:20 DEBUG nova.scheduler.host_manager [req-49ea5605-9e31-4db6-955c-8acd59cf0f82 baaa0b3c108b4626a083007a72d37b01 4eabbf34471d469a91234b769b5b2af3] Host filter function <bound method RamFilter.host_passes of <nova.scheduler.filters.ram_filter.RamFilter object at 0x4217150>> failed for mymachine-host from (pid=4567) passes_filters /home/myuser/openstack/nova/app/nova/scheduler/host_manager.py:160\n\n2012-04-03 12:37:20 WARNING nova.scheduler.manager [req-49ea5605-9e31-4db6-955c-8acd59cf0f82 baaa0b3c108b4626a083007a72d37b01 4eabbf34471d469a91234b769b5b2af3] Failed to schedule_run_instance: No valid host was found.\n\n5. do a \"nova show <vm name that failed>\" and notice that there is no \"fault\" line in the output.\n\nThe fault line should show why a vm was not created.  The nova show command will show a fault line if the fault_instances table has data in it.  So the last \"nova boot\" command failed to create the vm.  When that happened the OpenStack code should have added an entry to the fault_instances table with information about why the vm was not created.  \n\nTo see a fault created correctly, do this:\n1. set auto_assign_floating_ip to true in /etc/nova/nova/conf on either the controller or the kvm host (I am not sure which one it the right one)\n2. make sure you do NOT have any floating ip pool configured\n3. do \"nova boot --flavor 1 --image <valid-image-id> <vm-name>\"\n4. do \"nova show <vm-name>\"\nnotice that there is a \"fault\" line in the output that will include a message about why the vm was not created.\n\nThe same thing should happen in all cases where a vm is not created.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1019017", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 1019017, 
    "index": 2957, 
    "created": "2012-06-28 20:48:41.345590+00:00", 
    "title": "When KVM Host does not have enough ram, 'nova show ' does not show a fault message", 
    "comments": [
        {
            "content": "Steps to reproduce:\n1. use a kvm host that is running as a vm on an esx host with 2048 Megs of RAM\n2. on the controller do \"nova boot --flavor 1 --image <valid-image-id> vm1\n3. do the same nova boot command to create a vm2, vm3, vm4,.....\n4. at some point, the nova boot command will fail because there won't be enough memory.  You will see a message about ram filter in the nova-scheduler: \n\n2012-04-03 12:37:20 DEBUG nova.scheduler.host_manager [req-49ea5605-9e31-4db6-955c-8acd59cf0f82 baaa0b3c108b4626a083007a72d37b01 4eabbf34471d469a91234b769b5b2af3] Host filter function <bound method RamFilter.host_passes of <nova.scheduler.filters.ram_filter.RamFilter object at 0x4217150>> failed for mymachine-host from (pid=4567) passes_filters /home/myuser/openstack/nova/app/nova/scheduler/host_manager.py:160\n\n2012-04-03 12:37:20 WARNING nova.scheduler.manager [req-49ea5605-9e31-4db6-955c-8acd59cf0f82 baaa0b3c108b4626a083007a72d37b01 4eabbf34471d469a91234b769b5b2af3] Failed to schedule_run_instance: No valid host was found.\n\n5. do a \"nova show <vm name that failed>\" and notice that there is no \"fault\" line in the output.\n\nThe fault line should show why a vm was not created.  The nova show command will show a fault line if the fault_instances table has data in it.  So the last \"nova boot\" command failed to create the vm.  When that happened the OpenStack code should have added an entry to the fault_instances table with information about why the vm was not created.  \n\nTo see a fault created correctly, do this:\n1. set auto_assign_floating_ip to true in /etc/nova/nova/conf on either the controller or the kvm host (I am not sure which one it the right one)\n2. make sure you do NOT have any floating ip pool configured\n3. do \"nova boot --flavor 1 --image <valid-image-id> <vm-name>\"\n4. do \"nova show <vm-name>\"\nnotice that there is a \"fault\" line in the output that will include a message about why the vm was not created.\n\nThe same thing should happen in all cases where a vm is not created.", 
            "date_created": "2012-06-28 20:48:41.345590+00:00", 
            "author": "https://api.launchpad.net/1.0/~jon-mccormick2"
        }, 
        {
            "content": "Looks right to me.  It looks like compute/manager.py is the only place where instance faults are recorded.  If the instance fails to be scheduled, it won't make it to the compute manager at all.", 
            "date_created": "2012-09-07 20:50:59.133235+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "A patch just came up that should fix this: https://review.openstack.org/#/c/13159/", 
            "date_created": "2012-09-17 22:14:59.883890+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/13159\nCommitted: http://github.com/openstack/nova/commit/91734bad9139555294fe088d2c2d77a9712652ab\nSubmitter: Jenkins\nBranch:    master\n\ncommit 91734bad9139555294fe088d2c2d77a9712652ab\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Mon Sep 17 16:02:06 2012 -0700\n\n    Fixes error handling during schedule_run_instance\n    \n    If there are not enough hosts available during a multi-instance launch,\n    every failing instance should be updated to error state, instead of\n    just the first instance. Currently only the first instance is set\n    to Error and the rest stay in building.\n    \n    This patch makes a number of fixes to error handling during scheduling.\n    \n     * Moves instance faults into compute utils so they can be created\n       from the scheduler.\n     * Moves error handling into the driver so that each instance can be\n       updated separately.\n     * Sets an instance fault for failed scheduling\n     * Sets task state back to none if there is a scheduling failure\n     * Modifies chance scheduler to stop returning a list of instances\n       as it is not used.\n     * Modifies tests to check for these states.\n    \n    In addition to the included tests, the code was manually verified on\n    a devstack install\n    \n    Fixes bug 1051066\n    Fixes bug 1019017\n    \n    Change-Id: I49267ce4a21e2f7cc7a996fb2ed5d625f6794730\n", 
            "date_created": "2012-09-18 07:55:11.863408+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}