{
    "status": "Invalid", 
    "last_updated": "2017-03-30 18:29:22.067416+00:00", 
    "description": "When you attempt to 'nova volume-update' a stopped instance, the block device mapping connection_info is corrupted (it points to the new volume despite the failure).\n\n  1. create an instance (instance-1)\n  2. create two volumes (vol-1 & vol-2)\n  3. attach volume: nova volume-attach instance-1 <vol-1-uuid>\n  4. nova stop instance-1\n  5. swap volume: nova volume-update instance-1 <vol-1-uuid> <vol-2-uuid>\n  6. swap will fail, but the connection info points to vol-2 now\n\nExample notes using stable/newton devstack:\n\n   http://paste.openstack.org/show/586715/\n\nA similar downstream bug report:\n\n  Can't re-start a stopped instance after trying to volume-update on it \n  https://bugzilla.redhat.com/show_bug.cgi?id=1373318", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1635657", 
    "owner": "https://api.launchpad.net/1.0/~steve-noyes", 
    "id": 1635657, 
    "index": 6494, 
    "created": "2016-10-21 15:31:10.580964+00:00", 
    "title": "'nova volume-update' corrupts BDM connection_info when guest is stopped", 
    "comments": [
        {
            "content": "When you attempt to 'nova volume-update' a stopped instance, the block device mapping connection_info is corrupted (it points to the new volume despite the failure).\n\n  1. create an instance (instance-1)\n  2. create two volumes (vol-1 & vol-2)\n  3. attach volume: nova volume-attach instance-1 <vol-1-uuid>\n  4. nova stop instance-1\n  5. swap volume: nova volume-update instance-1 <vol-1-uuid> <vol-2-uuid>\n  6. swap will fail, but the connection info points to vol-2 now\n\nExample notes using stable/newton devstack:\n\n   http://paste.openstack.org/show/586715/\n\nA similar downstream bug report:\n\n  Can't re-start a stopped instance after trying to volume-update on it \n  https://bugzilla.redhat.com/show_bug.cgi?id=1373318", 
            "date_created": "2016-10-21 15:31:10.580964+00:00", 
            "author": "https://api.launchpad.net/1.0/~diana-clarke"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/389798", 
            "date_created": "2016-10-21 17:04:58.042087+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "A related problem is the fact that swap on a stopped or suspended server fails silently:\n\nhttps://bugs.launchpad.net/bugs/1673090", 
            "date_created": "2017-03-17 14:12:50.194716+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-noyes"
        }, 
        {
            "content": "This bdm corruption is a more generic problem than just trying to swap on a stopped or suspended instance. \n\nI happened to try a swap volume when an earlier block copy was still in progress. The swap failed and the bdm was corrupted identically to the way it gets corrupted when you try to swap on a stopped or suspended instance.\n\nThis was the block copy exception:\n\n2017-03-17 16:58:02.328 ERROR oslo_messaging.rpc.server [^[[01;36mreq-abf906eb-2dd0-4456-8c3d-41360eda30e0 ^[[00;36madmin demo] ^[[01;35mException during message handling^[[00m\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00mTraceback (most recent call last):\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 155, in _process_incoming\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    res = self.dispatcher.dispatch(message)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 222, in dispatch\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    return self._do_dispatch(endpoint, method, ctxt, args)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 192, in _do_dispatch\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    result = func(ctxt, **new_args)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/exception_wrapper.py\", line 75, in wrapped\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    function_name, call_dict, binary)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    self.force_reraise()\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    six.reraise(self.type_, self.value, self.tb)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/exception_wrapper.py\", line 66, in wrapped\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    return f(self, context, *args, **kw)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 188, in decorated_function\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    LOG.warning(msg, e, instance=instance)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    self.force_reraise()\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    six.reraise(self.type_, self.value, self.tb)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 157, in decorated_function\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    return function(self, context, *args, **kwargs)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 216, in decorated_function\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    kwargs['instance'], e, sys.exc_info())\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    self.force_reraise()\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    six.reraise(self.type_, self.value, self.tb)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 204, in decorated_function\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    return function(self, context, *args, **kwargs)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 5046, in swap_volume\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    resize_to)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 4992, in _swap_volume\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    self.volume_api.unreserve_volume(context, new_volume_id)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    self.force_reraise()\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    six.reraise(self.type_, self.value, self.tb)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 4970, in _swap_volume\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    resize_to)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1291, in swap_volume\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    self._swap_volume(guest, disk_dev, conf.source_path, resize_to)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1261, in _swap_volume\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    self._host.write_instance_config(xml)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/host.py\", line 835, in write_instance_config\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    domain = self.get_connection().defineXML(xml)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    result = proxy_call(self._autowrap, f, *args, **kwargs)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    rv = execute(f, *args, **kwargs)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    six.reraise(c, e, tb)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    rv = meth(*args, **kwargs)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m  File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 3650, in defineXML\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00m    if ret is None:raise libvirtError('virDomainDefineXML() failed', conn=self)\n2017-03-17 16:58:02.328 TRACE oslo_messaging.rpc.server ^[[01;35m^[[00mlibvirtError: block copy still active: domain has active block job\n", 
            "date_created": "2017-03-17 21:08:46.497660+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-noyes"
        }, 
        {
            "content": "I went back to see what happens when you swap on a paused instance. I first got a baseline of swapping on a running instance and found that the serial field in the bdm is not updated either. So this corruption is not related to the state of the instance or any exceptions that occur during swap. It happens on any swap initiated by nova.\n\nThe is the block_device_mapping in the db after a successful swap on a running instance. Note that the 'serial' field still has the old disk id (271a2b40-c952-44cb-911a-86bac413b71e).\n\nmysql> select * from block_device_mapping\\G\n...\nconnection_info: {\"driver_volume_type\": \"iscsi\", \"connector\": {\"platform\": \"x86_64\", \"host\": \"ub16-desk-base\", \"do_local_attach\": false, \"ip\": \"192.168.0.111\", \"os_type\": \"linux2\", \"multipath\": false, \"initiator\": \"iqn.1993-08.org.debian:01:b8b7178f92dd\"}, \n\n==== former disk id ====> \"serial\": \"271a2b40-c952-44cb-911a-86bac413b71e\", \n\n\"data\": {\"access_mode\": \"rw\", \"target_discovered\": false, \"encrypted\": false, \"qos_specs\": null, \n\"target_iqn\": \"iqn.2010-10.org.openstack:volume-b829dd38-f2fa-416d-a8e3-3c39e0239d8b\", \"target_portal\": \"192.168.0.111:3260\", \n\"volume_id\": \"b829dd38-f2fa-416d-a8e3-3c39e0239d8b\", \"target_lun\": 1, \n\"device_path\": \"/dev/disk/by-path/ip-192.168.0.111:3260-iscsi-iqn.2010-10.org.openstack:volume-b829dd38-f2fa-416d-a8e3-3c39e0239d8b-lun-1\", \"auth_password\": \"Uj3pQyDKNTDESgf6\", \"auth_username\": \"jGuFTg4uYyaAZt4Z8SXn\", \"auth_method\": \"CHAP\"}}\n...", 
            "date_created": "2017-03-17 22:23:24.545769+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-noyes"
        }, 
        {
            "content": "I just realized I was running with an older version. I will re-check this with latest...", 
            "date_created": "2017-03-20 14:56:14.255794+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-noyes"
        }, 
        {
            "content": "I updated to:\n\ncommit a3df985a6e966069b366c7fd170832422ccda33e\nMerge: 4613b33 8ab4b7a\nAuthor: Jenkins <email address hidden>\nDate:   Fri Mar 24 20:23:16 2017 +0000\n\n    Merge \"[placement] add api-ref for GET /resource_providers\"\n\n\nI no longer see any problems. The 'serial' vol_id now correctly reflects the attached disk, after a successful or unsuccessful swap. I did a swap with the vm running, paused, and stopped, and each time the connection info was correct and consistent.", 
            "date_created": "2017-03-27 17:52:22.336370+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-noyes"
        }, 
        {
            "content": "This bug should be able to be closed. But I haven't closed a bug before and I'm sure if this should be closed as fixed (don't know exactly when) or invalid (as it's no longer a bug).", 
            "date_created": "2017-03-27 18:04:34.112433+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-noyes"
        }, 
        {
            "content": "setting status to invalid since I am not seeing the problem anymore. The review that was associated with this bug (https://review.openstack.org/#/c/389798/) is now associated with bug 1673090.", 
            "date_created": "2017-03-30 18:29:20.722662+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-noyes"
        }
    ]
}