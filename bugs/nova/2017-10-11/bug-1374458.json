{
    "status": "Fix Released", 
    "last_updated": "2015-03-13 00:53:42.334532+00:00", 
    "description": "http://logs.openstack.org/98/124198/3/check/check-grenade-dsvm-icehouse/c89f18f/console.html#_2014-09-26_03_38_56_940\n\n2014-09-26 03:38:57.259 |     Traceback (most recent call last):\n2014-09-26 03:38:57.259 |       File \"tempest/scenario/manager.py\", line 142, in delete_wrapper\n2014-09-26 03:38:57.259 |         delete_thing(*args, **kwargs)\n2014-09-26 03:38:57.259 |       File \"tempest/services/volume/json/volumes_client.py\", line 108, in delete_volume\n2014-09-26 03:38:57.259 |         resp, body = self.delete(\"volumes/%s\" % str(volume_id))\n2014-09-26 03:38:57.259 |       File \"tempest/common/rest_client.py\", line 225, in delete\n2014-09-26 03:38:57.259 |         return self.request('DELETE', url, extra_headers, headers, body)\n2014-09-26 03:38:57.259 |       File \"tempest/common/rest_client.py\", line 435, in request\n2014-09-26 03:38:57.259 |         resp, resp_body)\n2014-09-26 03:38:57.259 |       File \"tempest/common/rest_client.py\", line 484, in _error_checker\n2014-09-26 03:38:57.259 |         raise exceptions.BadRequest(resp_body)\n2014-09-26 03:38:57.259 |     BadRequest: Bad request\n2014-09-26 03:38:57.260 |     Details: {u'message': u'Invalid volume: Volume status must be available or error, but current status is: in-use', u'code': 400}\n2014-09-26 03:38:57.260 |     }}}\n2014-09-26 03:38:57.260 |     \n2014-09-26 03:38:57.260 |     traceback-2: {{{\n2014-09-26 03:38:57.260 |     Traceback (most recent call last):\n2014-09-26 03:38:57.260 |       File \"tempest/common/rest_client.py\", line 561, in wait_for_resource_deletion\n2014-09-26 03:38:57.260 |         raise exceptions.TimeoutException(message)\n2014-09-26 03:38:57.260 |     TimeoutException: Request timed out\n2014-09-26 03:38:57.260 |     Details: (TestEncryptedCinderVolumes:_run_cleanups) Failed to delete resource 704461b6-3421-4959-8113-a011e6410ede within the required time (196 s).\n2014-09-26 03:38:57.260 |     }}}\n2014-09-26 03:38:57.260 |     \n2014-09-26 03:38:57.261 |     traceback-3: {{{\n2014-09-26 03:38:57.261 |     Traceback (most recent call last):\n2014-09-26 03:38:57.261 |       File \"tempest/services/volume/json/admin/volume_types_client.py\", line 97, in delete_volume_type\n2014-09-26 03:38:57.261 |         resp, body = self.delete(\"types/%s\" % str(volume_id))\n2014-09-26 03:38:57.261 |       File \"tempest/common/rest_client.py\", line 225, in delete\n2014-09-26 03:38:57.261 |         return self.request('DELETE', url, extra_headers, headers, body)\n2014-09-26 03:38:57.261 |       File \"tempest/common/rest_client.py\", line 435, in request\n2014-09-26 03:38:57.261 |         resp, resp_body)\n2014-09-26 03:38:57.261 |       File \"tempest/common/rest_client.py\", line 484, in _error_checker\n2014-09-26 03:38:57.261 |         raise exceptions.BadRequest(resp_body)\n2014-09-26 03:38:57.261 |     BadRequest: Bad request\n2014-09-26 03:38:57.261 |     Details: {u'message': u'Target volume type is still in use.', u'code': 400}\n2014-09-26 03:38:57.262 |     }}}\n2014-09-26 03:38:57.262 |     \n2014-09-26 03:38:57.262 |     Traceback (most recent call last):\n2014-09-26 03:38:57.262 |       File \"tempest/test.py\", line 142, in wrapper\n2014-09-26 03:38:57.262 |         return f(self, *func_args, **func_kwargs)\n2014-09-26 03:38:57.262 |       File \"tempest/scenario/test_encrypted_cinder_volumes.py\", line 56, in test_encrypted_cinder_volumes_luks\n2014-09-26 03:38:57.262 |         self.attach_detach_volume()\n2014-09-26 03:38:57.262 |       File \"tempest/scenario/test_encrypted_cinder_volumes.py\", line 49, in attach_detach_volume\n2014-09-26 03:38:57.262 |         self.nova_volume_detach()\n2014-09-26 03:38:57.262 |       File \"tempest/scenario/manager.py\", line 439, in nova_volume_detach\n2014-09-26 03:38:57.262 |         'available')\n2014-09-26 03:38:57.262 |       File \"tempest/services/volume/json/volumes_client.py\", line 181, in wait_for_volume_status\n2014-09-26 03:38:57.263 |         raise exceptions.TimeoutException(message)\n2014-09-26 03:38:57.263 |     TimeoutException: Request timed out\n2014-09-26 03:38:57.263 |     Details: Volume 704461b6-3421-4959-8113-a011e6410ede failed to reach available status within the required time (196 s).\n\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJtZXNzYWdlOlwiRGV0YWlsczogKFRlc3RFbmNyeXB0ZWRDaW5kZXJWb2x1bWVzOl9ydW5fY2xlYW51cHMpIEZhaWxlZCB0byBkZWxldGUgcmVzb3VyY2VcIiBBTkQgbWVzc2FnZTpcIndpdGhpbiB0aGUgcmVxdWlyZWQgdGltZVwiIEFORCB0YWdzOlwiY29uc29sZVwiIiwiZmllbGRzIjpbXSwib2Zmc2V0IjowLCJ0aW1lZnJhbWUiOiI2MDQ4MDAiLCJncmFwaG1vZGUiOiJjb3VudCIsInRpbWUiOnsidXNlcl9pbnRlcnZhbCI6MH0sInN0YW1wIjoxNDExNzM4OTc0MTMwfQ==\n\n130 hits in 7 days, check and gate, all failures.", 
    "tags": [
        "icehouse-backport-potential", 
        "in-stable-icehouse", 
        "volumes"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1374458", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1374458, 
    "index": 1628, 
    "created": "2014-09-26 13:45:10.859274+00:00", 
    "title": "test_encrypted_cinder_volumes_luks fails to detach encrypted volume", 
    "comments": [
        {
            "content": "http://logs.openstack.org/98/124198/3/check/check-grenade-dsvm-icehouse/c89f18f/console.html#_2014-09-26_03_38_56_940\n\n2014-09-26 03:38:57.259 |     Traceback (most recent call last):\n2014-09-26 03:38:57.259 |       File \"tempest/scenario/manager.py\", line 142, in delete_wrapper\n2014-09-26 03:38:57.259 |         delete_thing(*args, **kwargs)\n2014-09-26 03:38:57.259 |       File \"tempest/services/volume/json/volumes_client.py\", line 108, in delete_volume\n2014-09-26 03:38:57.259 |         resp, body = self.delete(\"volumes/%s\" % str(volume_id))\n2014-09-26 03:38:57.259 |       File \"tempest/common/rest_client.py\", line 225, in delete\n2014-09-26 03:38:57.259 |         return self.request('DELETE', url, extra_headers, headers, body)\n2014-09-26 03:38:57.259 |       File \"tempest/common/rest_client.py\", line 435, in request\n2014-09-26 03:38:57.259 |         resp, resp_body)\n2014-09-26 03:38:57.259 |       File \"tempest/common/rest_client.py\", line 484, in _error_checker\n2014-09-26 03:38:57.259 |         raise exceptions.BadRequest(resp_body)\n2014-09-26 03:38:57.259 |     BadRequest: Bad request\n2014-09-26 03:38:57.260 |     Details: {u'message': u'Invalid volume: Volume status must be available or error, but current status is: in-use', u'code': 400}\n2014-09-26 03:38:57.260 |     }}}\n2014-09-26 03:38:57.260 |     \n2014-09-26 03:38:57.260 |     traceback-2: {{{\n2014-09-26 03:38:57.260 |     Traceback (most recent call last):\n2014-09-26 03:38:57.260 |       File \"tempest/common/rest_client.py\", line 561, in wait_for_resource_deletion\n2014-09-26 03:38:57.260 |         raise exceptions.TimeoutException(message)\n2014-09-26 03:38:57.260 |     TimeoutException: Request timed out\n2014-09-26 03:38:57.260 |     Details: (TestEncryptedCinderVolumes:_run_cleanups) Failed to delete resource 704461b6-3421-4959-8113-a011e6410ede within the required time (196 s).\n2014-09-26 03:38:57.260 |     }}}\n2014-09-26 03:38:57.260 |     \n2014-09-26 03:38:57.261 |     traceback-3: {{{\n2014-09-26 03:38:57.261 |     Traceback (most recent call last):\n2014-09-26 03:38:57.261 |       File \"tempest/services/volume/json/admin/volume_types_client.py\", line 97, in delete_volume_type\n2014-09-26 03:38:57.261 |         resp, body = self.delete(\"types/%s\" % str(volume_id))\n2014-09-26 03:38:57.261 |       File \"tempest/common/rest_client.py\", line 225, in delete\n2014-09-26 03:38:57.261 |         return self.request('DELETE', url, extra_headers, headers, body)\n2014-09-26 03:38:57.261 |       File \"tempest/common/rest_client.py\", line 435, in request\n2014-09-26 03:38:57.261 |         resp, resp_body)\n2014-09-26 03:38:57.261 |       File \"tempest/common/rest_client.py\", line 484, in _error_checker\n2014-09-26 03:38:57.261 |         raise exceptions.BadRequest(resp_body)\n2014-09-26 03:38:57.261 |     BadRequest: Bad request\n2014-09-26 03:38:57.261 |     Details: {u'message': u'Target volume type is still in use.', u'code': 400}\n2014-09-26 03:38:57.262 |     }}}\n2014-09-26 03:38:57.262 |     \n2014-09-26 03:38:57.262 |     Traceback (most recent call last):\n2014-09-26 03:38:57.262 |       File \"tempest/test.py\", line 142, in wrapper\n2014-09-26 03:38:57.262 |         return f(self, *func_args, **func_kwargs)\n2014-09-26 03:38:57.262 |       File \"tempest/scenario/test_encrypted_cinder_volumes.py\", line 56, in test_encrypted_cinder_volumes_luks\n2014-09-26 03:38:57.262 |         self.attach_detach_volume()\n2014-09-26 03:38:57.262 |       File \"tempest/scenario/test_encrypted_cinder_volumes.py\", line 49, in attach_detach_volume\n2014-09-26 03:38:57.262 |         self.nova_volume_detach()\n2014-09-26 03:38:57.262 |       File \"tempest/scenario/manager.py\", line 439, in nova_volume_detach\n2014-09-26 03:38:57.262 |         'available')\n2014-09-26 03:38:57.262 |       File \"tempest/services/volume/json/volumes_client.py\", line 181, in wait_for_volume_status\n2014-09-26 03:38:57.263 |         raise exceptions.TimeoutException(message)\n2014-09-26 03:38:57.263 |     TimeoutException: Request timed out\n2014-09-26 03:38:57.263 |     Details: Volume 704461b6-3421-4959-8113-a011e6410ede failed to reach available status within the required time (196 s).\n\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJtZXNzYWdlOlwiRGV0YWlsczogKFRlc3RFbmNyeXB0ZWRDaW5kZXJWb2x1bWVzOl9ydW5fY2xlYW51cHMpIEZhaWxlZCB0byBkZWxldGUgcmVzb3VyY2VcIiBBTkQgbWVzc2FnZTpcIndpdGhpbiB0aGUgcmVxdWlyZWQgdGltZVwiIEFORCB0YWdzOlwiY29uc29sZVwiIiwiZmllbGRzIjpbXSwib2Zmc2V0IjowLCJ0aW1lZnJhbWUiOiI2MDQ4MDAiLCJncmFwaG1vZGUiOiJjb3VudCIsInRpbWUiOnsidXNlcl9pbnRlcnZhbCI6MH0sInN0YW1wIjoxNDExNzM4OTc0MTMwfQ==\n\n130 hits in 7 days, check and gate, all failures.", 
            "date_created": "2014-09-26 13:45:10.859274+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "e-r query: https://review.openstack.org/#/c/124407/", 
            "date_created": "2014-09-26 13:57:34.877708+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "The delete of the volume starts here:\n\nhttp://logs.openstack.org/98/124198/3/check/check-grenade-dsvm-icehouse/c89f18f/logs/new/screen-c-vol.txt.gz#_2014-09-26_03_38_53_037\n\nI see some volume detach messages after that.\n\nThere is an error in the n-cpu logs:\n\nhttp://logs.openstack.org/98/124198/3/check/check-grenade-dsvm-icehouse/c89f18f/logs/new/screen-n-cpu.txt.gz?level=TRACE#_2014-09-26_03_32_17_403\n\nIt fails to detach the volume which is why cinder can't delete it (because it's in-use), so we timeout on the delete of the volume.", 
            "date_created": "2014-09-26 14:03:14.685977+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "2014-09-26 03:32:17.403 ERROR nova.compute.manager [req-89e6d1c1-822a-4387-8af1-93c3e007bec6 TestEncryptedCinderVolumes-1122192554 TestEncryptedCinderVolumes-1697943167] [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8] Failed to detach volume 704461b6-3421-4959-8113-a011e6410ede from /dev/vdb\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8] Traceback (most recent call last):\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 4216, in _detach_volume\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]     encryption=encryption)\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 1384, in detach_volume\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]     encryptor.detach_volume(**encryption)\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]   File \"/opt/stack/new/nova/nova/volume/encryptors/cryptsetup.py\", line 101, in detach_volume\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]     self._close_volume(**kwargs)\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]   File \"/opt/stack/new/nova/nova/volume/encryptors/luks.py\", line 106, in _close_volume\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]     run_as_root=True, check_exit_code=True)\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]   File \"/opt/stack/new/nova/nova/utils.py\", line 165, in execute\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]     return processutils.execute(*cmd, **kwargs)\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]   File \"/opt/stack/new/nova/nova/openstack/common/processutils.py\", line 193, in execute\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8]     cmd=' '.join(cmd))\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8] ProcessExecutionError: Unexpected error while running command.\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup luksClose ip-127.0.0.1:3260-iscsi-iqn.2010-10.org.openstack:volume-704461b6-3421-4959-8113-a011e6410ede-lun-1\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8] Exit code: 5\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8] Stdout: ''\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8] Stderr: 'Device ip-127.0.0.1:3260-iscsi-iqn.2010-10.org.openstack:volume-704461b6-3421-4959-8113-a011e6410ede-lun-1 is busy.\\n'\n2014-09-26 03:32:17.403 22504 TRACE nova.compute.manager [instance: 4374ceb4-1ac1-48dc-8c87-70d7118fc8c8] ", 
            "date_created": "2014-09-26 14:05:23.629146+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Bug 1348204 is a race failure on the attach side of encrypted volumes.", 
            "date_created": "2014-09-26 14:10:26.501473+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Exit code 5 from \"cryptsetup luksClose\" means the device is busy:\n\nhttps://code.google.com/p/cryptsetup/issues/detail?id=100\n\nSo we should just retry on that until it detaches or we timeout.", 
            "date_created": "2014-09-26 14:17:03.330477+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "The code doesn't do any kind of retry right now, so adding that should help:\n\n    def _close_volume(self, **kwargs):\n        \"\"\"Closes the device (effectively removes the dm-crypt mapping).\"\"\"\n        LOG.debug(\"closing encrypted volume %s\", self.dev_path)\n        utils.execute('cryptsetup', 'luksClose', self.dev_name,\n                      run_as_root=True, check_exit_code=True)", 
            "date_created": "2014-09-26 14:20:12.703586+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/124418", 
            "date_created": "2014-09-26 14:37:57.453988+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/124418\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=eef97cdf4bb7f426d7feb394ef54510db8b1656b\nSubmitter: Jenkins\nBranch:    master\n\ncommit eef97cdf4bb7f426d7feb394ef54510db8b1656b\nAuthor: Matt Riedemann <email address hidden>\nDate:   Fri Sep 26 07:31:49 2014 -0700\n\n    Retry on closing of luks encrypted volume in case device is busy\n    \n    We're seeing races in the gate on detach of an encrypted volume where\n    the device is busy so the detach fails, which causes the delete of the\n    volume on the cinder side to fail because the volume is still in use and\n    then Tempest times out waiting for the volume to be deleted.\n    \n    This simply adds a retry to close the encryption device.  I use\n    attempts=3 since that's what we use for lvremove.\n    \n    Closes-Bug: #1374458\n    \n    Change-Id: Ia0667da7dee247ba8c3338b296244b2a71d1045d\n", 
            "date_created": "2014-09-26 22:03:01.976959+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/130727", 
            "date_created": "2014-10-24 09:57:11.629516+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/130727\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0695e144f7469ba98247e625fadc9a979a87af91\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 0695e144f7469ba98247e625fadc9a979a87af91\nAuthor: Matt Riedemann <email address hidden>\nDate:   Fri Sep 26 07:31:49 2014 -0700\n\n    Retry on closing of luks encrypted volume in case device is busy\n    \n    We're seeing races in the gate on detach of an encrypted volume where\n    the device is busy so the detach fails, which causes the delete of the\n    volume on the cinder side to fail because the volume is still in use and\n    then Tempest times out waiting for the volume to be deleted.\n    \n    This simply adds a retry to close the encryption device.  I use\n    attempts=3 since that's what we use for lvremove.\n    \n    Closes-Bug: #1374458\n    \n    Change-Id: Ia0667da7dee247ba8c3338b296244b2a71d1045d\n    (cherry picked from commit eef97cdf4bb7f426d7feb394ef54510db8b1656b)\n", 
            "date_created": "2014-10-24 17:56:40.605304+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}