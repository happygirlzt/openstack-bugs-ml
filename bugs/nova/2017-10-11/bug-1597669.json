{
    "status": "Fix Released", 
    "last_updated": "2016-12-19 12:02:17.701625+00:00", 
    "description": "Description\n===========\n\nI931421ea688641e2ceb212c6dc099639c53433f2 introduced a callback to _create_configdrive from _create_domain that recreates the config disk of an instance during a rescue. \n\nHowever neither the original or this recreated config disk are used by the instance during the resulting rescue.\n\nSteps to reproduce\n==================\n\n$ nova boot --image cirros-0.3.4-x86_64-uec --flavor 1 test-config-rescue\n[..]\n$ nova rescue test-config-rescue\n[..]\n$ nova list\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n| ID                                   | Name               | Status | Task State | Power State | Networks         |\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n| 5ef76bd4-4e4f-46dd-88f6-dcd212e54802 | test-config-rescue | RESCUE | -          | Running     | private=10.0.0.2 |\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n$ ll ../data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/\ntotal 28556\n-rw-------. 1 qemu  qemu        16939 Jun 30 04:39 console.log\n-rw-r--r--. 1 qemu  qemu     10682368 Jun 30 04:39 disk\n-rw-rw-r--. 1 qemu  qemu       432128 Jun 30 04:38 disk.config\n-rw-rw-r--. 1 stack libvirtd   432128 Jun 30 04:39 disk.config.rescue\n-rw-r--r--. 1 stack libvirtd      534 Jun 30 04:39 disk.info\n-rw-r--r--. 1 qemu  qemu       197120 Jun 30 04:39 disk.rescue\n-rw-rw-r--. 1 qemu  qemu      4979632 Jun 30 04:38 kernel\n-rw-rw-r--. 1 qemu  qemu      4979632 Jun 30 04:39 kernel.rescue\n-rw-rw-r--. 1 stack libvirtd     3146 Jun 30 04:39 libvirt.xml\n-rw-rw-r--. 1 qemu  qemu      3740163 Jun 30 04:38 ramdisk\n-rw-rw-r--. 1 qemu  qemu      3740163 Jun 30 04:39 ramdisk.rescue\n-rw-rw-r--. 1 stack libvirtd     4569 Jun 30 04:39 unrescue.xml\n$ grep config ../data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/libvirt.xml \n      <nova:name>test-config-rescue</nova:name>\n$ sudo virsh domblklist 5ef76bd4-4e4f-46dd-88f6-dcd212e54802\nTarget     Source\n------------------------------------------------\nvda        /opt/stack/data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/disk.rescue\nvdb        /opt/stack/data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/disk\n\n\n$ nova unrescue test-config-rescue\n$ nova list\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n| ID                                   | Name               | Status | Task State | Power State | Networks         |\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n| 5ef76bd4-4e4f-46dd-88f6-dcd212e54802 | test-config-rescue | ACTIVE | -          | Running     | private=10.0.0.2 |\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n$ ll ../data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/\ntotal 19604\n-rw-------. 1 qemu  qemu        20403 Jun 30 04:48 console.log\n-rw-r--r--. 1 qemu  qemu     10878976 Jun 30 04:47 disk\n-rw-rw-r--. 1 qemu  qemu       432128 Jun 30 04:38 disk.config\n-rw-r--r--. 1 stack libvirtd      534 Jun 30 04:39 disk.info\n-rw-rw-r--. 1 qemu  qemu      4979632 Jun 30 04:38 kernel\n-rw-rw-r--. 1 stack libvirtd     4569 Jun 30 04:47 libvirt.xml\n-rw-rw-r--. 1 qemu  qemu      3740163 Jun 30 04:38 ramdisk\n$ grep config ../data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/libvirt.xml \n      <nova:name>test-config-rescue</nova:name>\n      <source file='/opt/stack/data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/disk.config'/>\n$ sudo virsh domblklist 5ef76bd4-4e4f-46dd-88f6-dcd212e54802\nTarget     Source\n------------------------------------------------\nvda        /opt/stack/data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/disk\nhdd        /opt/stack/data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/disk.config\n\n\nExpected result\n===============\ndisk.config.rescue attached to the rescued instance.\n\nActual result\n=============\nNo config disks are attached to the rescued instance. Only the rescue disk and original root disk are attached.\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n   list for all releases: http://docs.openstack.org/releases/\n\n   $ pwd\n   /opt/stack/nova\n   $ git rev-parse HEAD\n   23153952a979c93a414705744b0f8ba4bde18f75\n\n2. Which hypervisor did you use?\n   libvirt + kvm\n\n2. Which storage type did you use?\n   (For example: Ceph, LVM, GPFS, ...)\n   What's the version of that?\n   N/A\n\n3. Which networking type did you use?\n   (For example: nova-network, Neutron with OpenVSwitch, ...)\n   N/A\n\nLogs & Configs\n==============", 
    "tags": [
        "libvirt", 
        "newton-backport-potential"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1597669", 
    "owner": "https://api.launchpad.net/1.0/~lyarwood", 
    "id": 1597669, 
    "index": 4564, 
    "created": "2016-06-30 08:51:07.755081+00:00", 
    "title": "[libvirt] disk.config.rescue is not used when rescuing an instance", 
    "comments": [
        {
            "content": "Description\n===========\n\nI931421ea688641e2ceb212c6dc099639c53433f2 introduced a callback to _create_configdrive from _create_domain that recreates the config disk of an instance during a rescue. \n\nHowever neither the original or this recreated config disk are used by the instance during the resulting rescue.\n\nSteps to reproduce\n==================\n\n$ nova boot --image cirros-0.3.4-x86_64-uec --flavor 1 test-config-rescue\n[..]\n$ nova rescue test-config-rescue\n[..]\n$ nova list\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n| ID                                   | Name               | Status | Task State | Power State | Networks         |\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n| 5ef76bd4-4e4f-46dd-88f6-dcd212e54802 | test-config-rescue | RESCUE | -          | Running     | private=10.0.0.2 |\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n$ ll ../data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/\ntotal 28556\n-rw-------. 1 qemu  qemu        16939 Jun 30 04:39 console.log\n-rw-r--r--. 1 qemu  qemu     10682368 Jun 30 04:39 disk\n-rw-rw-r--. 1 qemu  qemu       432128 Jun 30 04:38 disk.config\n-rw-rw-r--. 1 stack libvirtd   432128 Jun 30 04:39 disk.config.rescue\n-rw-r--r--. 1 stack libvirtd      534 Jun 30 04:39 disk.info\n-rw-r--r--. 1 qemu  qemu       197120 Jun 30 04:39 disk.rescue\n-rw-rw-r--. 1 qemu  qemu      4979632 Jun 30 04:38 kernel\n-rw-rw-r--. 1 qemu  qemu      4979632 Jun 30 04:39 kernel.rescue\n-rw-rw-r--. 1 stack libvirtd     3146 Jun 30 04:39 libvirt.xml\n-rw-rw-r--. 1 qemu  qemu      3740163 Jun 30 04:38 ramdisk\n-rw-rw-r--. 1 qemu  qemu      3740163 Jun 30 04:39 ramdisk.rescue\n-rw-rw-r--. 1 stack libvirtd     4569 Jun 30 04:39 unrescue.xml\n$ grep config ../data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/libvirt.xml \n      <nova:name>test-config-rescue</nova:name>\n$ sudo virsh domblklist 5ef76bd4-4e4f-46dd-88f6-dcd212e54802\nTarget     Source\n------------------------------------------------\nvda        /opt/stack/data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/disk.rescue\nvdb        /opt/stack/data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/disk\n\n\n$ nova unrescue test-config-rescue\n$ nova list\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n| ID                                   | Name               | Status | Task State | Power State | Networks         |\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n| 5ef76bd4-4e4f-46dd-88f6-dcd212e54802 | test-config-rescue | ACTIVE | -          | Running     | private=10.0.0.2 |\n+--------------------------------------+--------------------+--------+------------+-------------+------------------+\n$ ll ../data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/\ntotal 19604\n-rw-------. 1 qemu  qemu        20403 Jun 30 04:48 console.log\n-rw-r--r--. 1 qemu  qemu     10878976 Jun 30 04:47 disk\n-rw-rw-r--. 1 qemu  qemu       432128 Jun 30 04:38 disk.config\n-rw-r--r--. 1 stack libvirtd      534 Jun 30 04:39 disk.info\n-rw-rw-r--. 1 qemu  qemu      4979632 Jun 30 04:38 kernel\n-rw-rw-r--. 1 stack libvirtd     4569 Jun 30 04:47 libvirt.xml\n-rw-rw-r--. 1 qemu  qemu      3740163 Jun 30 04:38 ramdisk\n$ grep config ../data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/libvirt.xml \n      <nova:name>test-config-rescue</nova:name>\n      <source file='/opt/stack/data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/disk.config'/>\n$ sudo virsh domblklist 5ef76bd4-4e4f-46dd-88f6-dcd212e54802\nTarget     Source\n------------------------------------------------\nvda        /opt/stack/data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/disk\nhdd        /opt/stack/data/nova/instances/5ef76bd4-4e4f-46dd-88f6-dcd212e54802/disk.config\n\n\nExpected result\n===============\ndisk.config.rescue attached to the rescued instance.\n\nActual result\n=============\nNo config disks are attached to the rescued instance. Only the rescue disk and original root disk are attached.\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n   list for all releases: http://docs.openstack.org/releases/\n\n   $ pwd\n   /opt/stack/nova\n   $ git rev-parse HEAD\n   23153952a979c93a414705744b0f8ba4bde18f75\n\n2. Which hypervisor did you use?\n   libvirt + kvm\n\n2. Which storage type did you use?\n   (For example: Ceph, LVM, GPFS, ...)\n   What's the version of that?\n   N/A\n\n3. Which networking type did you use?\n   (For example: nova-network, Neutron with OpenVSwitch, ...)\n   N/A\n\nLogs & Configs\n==============", 
            "date_created": "2016-06-30 08:51:07.755081+00:00", 
            "author": "https://api.launchpad.net/1.0/~lyarwood"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/335884", 
            "date_created": "2016-06-30 09:34:22.922468+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/335966", 
            "date_created": "2016-06-30 11:42:51.810059+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I've updated the test change this relies on.", 
            "date_created": "2016-09-13 16:28:49.086775+00:00", 
            "author": "https://api.launchpad.net/1.0/~mbooth-9"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/335966\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d9c1d8b2cb2350b2c66c1001071f4d460eda62e5\nSubmitter: Jenkins\nBranch:    master\n\ncommit d9c1d8b2cb2350b2c66c1001071f4d460eda62e5\nAuthor: Matthew Booth <email address hidden>\nDate:   Thu Jun 30 12:31:44 2016 +0100\n\n    libvirt: Rewrite test_rescue and test_rescue_config_drive\n    \n    This rewrite was primarily motivated by bug 1597669. We were testing\n    that we were creating disks, but not that they were being added to the\n    resulting domain.\n    \n    Related-bug: #1597669\n    Change-Id: Ibe739b1811bdacad08a7fc499d26e4bed834eec9\n", 
            "date_created": "2016-09-15 05:40:19.073801+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The wording on this bug really makes it sound like a regression in newton, which it's not, it's really just a latent bug and the callback change doesn't really have anything to do with it.", 
            "date_created": "2016-09-15 16:04:46.830406+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/335884\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8795b206247fe2ca57f32c437d72c51492637649\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8795b206247fe2ca57f32c437d72c51492637649\nAuthor: Lee Yarwood <email address hidden>\nDate:   Thu Jun 30 10:22:28 2016 +0100\n\n    libvirt: Use the recreated disk.config.rescue during a rescue\n    \n    I931421ea introduced a callback to _create_configdrive from\n    _create_domain during a rescue that recreates the config disk of an\n    instance with an additional .rescue suffix. However due to a latent bug\n    neither the original or this recreated config disk are mapped to the\n    instance during the resulting rescue.\n    \n    To correct this disk.config.rescue is now added to the disk_mapping for\n    the instance if a config disk is required during a rescue.\n    \n    Closes-bug: #1597669\n    Change-Id: I46cebd0612f50ff7373f677c4a002d444a877972\n", 
            "date_created": "2016-09-28 23:15:59.699607+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/379041", 
            "date_created": "2016-09-29 00:25:49.101320+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b1 development milestone.", 
            "date_created": "2016-11-17 13:14:08.925974+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/379041\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=528430d78159a3ec6a6f3d76237c944b8384ed7c\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 528430d78159a3ec6a6f3d76237c944b8384ed7c\nAuthor: Lee Yarwood <email address hidden>\nDate:   Thu Jun 30 10:22:28 2016 +0100\n\n    libvirt: Use the recreated disk.config.rescue during a rescue\n    \n    I931421ea introduced a callback to _create_configdrive from\n    _create_domain during a rescue that recreates the config disk of an\n    instance with an additional .rescue suffix. However due to a latent bug\n    neither the original or this recreated config disk are mapped to the\n    instance during the resulting rescue.\n    \n    To correct this disk.config.rescue is now added to the disk_mapping for\n    the instance if a config disk is required during a rescue.\n    \n    Closes-bug: #1597669\n    Change-Id: I46cebd0612f50ff7373f677c4a002d444a877972\n    (cherry picked from commit 8795b206247fe2ca57f32c437d72c51492637649)\n", 
            "date_created": "2016-12-15 12:21:55.809743+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.3 release.", 
            "date_created": "2016-12-19 12:02:16.848151+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}