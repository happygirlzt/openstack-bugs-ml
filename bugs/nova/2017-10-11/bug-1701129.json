{
    "status": "Fix Released", 
    "last_updated": "2017-07-28 07:41:21.032340+00:00", 
    "description": "Noticed this on a test run on an unrelated patch I uploaded, functional test failure with trace:\n\n2017-06-28 22:16:50,659 INFO [nova.api.openstack.placement.requestlog] 127.0.0.1 \"PUT /allocations/f0bd6e91-2486-418c-bea2-bb2392568171\" status: 400 len: 2220 microversion: 1.0\n2017-06-28 22:16:50,659 INFO [nova.placement.wsgi.server] 127.0.0.1 \"PUT /allocations/f0bd6e91-2486-418c-bea2-bb2392568171 HTTP/1.1\" status: 400 len: 2504 time: 0.0040810\n2017-06-28 22:16:50,660 WARNING [nova.scheduler.client.report] Unable to submit allocation for instance f0bd6e91-2486-418c-bea2-bb2392568171 (400 <html>\n <head>\n  <title>400 Bad Request</title>\n </head>\n <body>\n  <h1>400 Bad Request</h1>\n  The server could not comply with the request since it is either malformed or otherwise incorrect.<br /><br />\nJSON does not validate: Additional properties are not allowed (u'project_id', u'user_id' were unexpected)\n\nFailed validating 'additionalProperties' in schema:\n    {'additionalProperties': False,\n     'properties': {'allocations': {'items': {'additionalProperties': False,\n                                              'properties': {'resource_provider': {'additionalProperties': False,\n                                                                                   'properties': {'uuid': {'format': 'uuid',\n                                                                                                           'type': 'string'}},\n                                                                                   'required': ['uuid'],\n                                                                                   'type': 'object'},\n                                                             'resources': {'additionalProperties': False,\n                                                                           'patternProperties': {'^[0-9A-Z_]+$': {'minimum': 1,\n                                                                                                                  'type': 'integer'}},\n                                                                           'type': 'object'}},\n                                              'required': ['resource_provider',\n                                                           'resources'],\n                                              'type': 'object'},\n                                    'type': 'array'}},\n     'required': ['allocations'],\n     'type': 'object'}\n\nOn instance:\n    {u'allocations': [{u'resource_provider': {u'uuid': u'29000c79-94bf-4326-9630-281d2ef67071'},\n                       u'resources': {u'DISK_GB': 20,\n                                      u'MEMORY_MB': 2048,\n                                      u'VCPU': 1}}],\n     u'project_id': u'6f70656e737461636b20342065766572',\n     u'user_id': u'fake'}\n\n\n </body>\n</html>)\n\nThe problem is that microversion 1.0 is being requested with parameters only available in microversion >= 1.8. This is because the PlacementFixture's _fake_put() method ignores the version keyword argument and doesn't pass it along to placement.", 
    "tags": [
        "placement", 
        "testing"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1701129", 
    "owner": "https://api.launchpad.net/1.0/~melwitt", 
    "id": 1701129, 
    "index": 936, 
    "created": "2017-06-28 23:36:51.756891+00:00", 
    "title": "Functional tests fail intermittently with 400 Bad Request from placement", 
    "comments": [
        {
            "content": "Noticed this on a test run on an unrelated patch I uploaded, functional test failure with trace:\n\n2017-06-28 22:16:50,659 INFO [nova.api.openstack.placement.requestlog] 127.0.0.1 \"PUT /allocations/f0bd6e91-2486-418c-bea2-bb2392568171\" status: 400 len: 2220 microversion: 1.0\n2017-06-28 22:16:50,659 INFO [nova.placement.wsgi.server] 127.0.0.1 \"PUT /allocations/f0bd6e91-2486-418c-bea2-bb2392568171 HTTP/1.1\" status: 400 len: 2504 time: 0.0040810\n2017-06-28 22:16:50,660 WARNING [nova.scheduler.client.report] Unable to submit allocation for instance f0bd6e91-2486-418c-bea2-bb2392568171 (400 <html>\n <head>\n  <title>400 Bad Request</title>\n </head>\n <body>\n  <h1>400 Bad Request</h1>\n  The server could not comply with the request since it is either malformed or otherwise incorrect.<br /><br />\nJSON does not validate: Additional properties are not allowed (u'project_id', u'user_id' were unexpected)\n\nFailed validating 'additionalProperties' in schema:\n    {'additionalProperties': False,\n     'properties': {'allocations': {'items': {'additionalProperties': False,\n                                              'properties': {'resource_provider': {'additionalProperties': False,\n                                                                                   'properties': {'uuid': {'format': 'uuid',\n                                                                                                           'type': 'string'}},\n                                                                                   'required': ['uuid'],\n                                                                                   'type': 'object'},\n                                                             'resources': {'additionalProperties': False,\n                                                                           'patternProperties': {'^[0-9A-Z_]+$': {'minimum': 1,\n                                                                                                                  'type': 'integer'}},\n                                                                           'type': 'object'}},\n                                              'required': ['resource_provider',\n                                                           'resources'],\n                                              'type': 'object'},\n                                    'type': 'array'}},\n     'required': ['allocations'],\n     'type': 'object'}\n\nOn instance:\n    {u'allocations': [{u'resource_provider': {u'uuid': u'29000c79-94bf-4326-9630-281d2ef67071'},\n                       u'resources': {u'DISK_GB': 20,\n                                      u'MEMORY_MB': 2048,\n                                      u'VCPU': 1}}],\n     u'project_id': u'6f70656e737461636b20342065766572',\n     u'user_id': u'fake'}\n\n\n </body>\n</html>)\n\nThe problem is that microversion 1.0 is being requested with parameters only available in microversion >= 1.8. This is because the PlacementFixture's _fake_put() method ignores the version keyword argument and doesn't pass it along to placement.", 
            "date_created": "2017-06-28 23:36:51.756891+00:00", 
            "author": "https://api.launchpad.net/1.0/~melwitt"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/478683", 
            "date_created": "2017-06-29 00:01:09.302435+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/478683\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=1d74a7ab3da2a04e133347bd59cb1e37e1c8e322\nSubmitter: Jenkins\nBranch:    master\n\ncommit 1d74a7ab3da2a04e133347bd59cb1e37e1c8e322\nAuthor: melanie witt <email address hidden>\nDate:   Wed Jun 28 23:50:53 2017 +0000\n\n    Handle version for PUT and POST in PlacementFixture\n    \n    The SchedulerReportClient allows a \"version\" keyword argument to be\n    specified for its get/put/post methods and several functions pass a\n    version because they are sending data supported only in specific\n    microversions of the placement API.\n    \n    The PlacementFixture has to mock the SchedulerReportClient\n    get/put/post/delete methods to swap in a Keystone session with\n    auth=None. The fake methods for PUT and POST are missing handling of\n    the \"version\" keyword argument, causing intermittent \"400 Bad Request\"\n    failures in the functional test jobs when unexpected parameters are\n    passed to placement microversion 1.0 instead of the intended\n    microversion.\n    \n    Closes-Bug: #1701129\n    \n    Change-Id: I681712ac37f732c7803c68f6c7d1eae9f2877d3d\n", 
            "date_created": "2017-06-29 22:08:15.082802+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b3 development milestone.", 
            "date_created": "2017-07-28 07:41:20.449369+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}