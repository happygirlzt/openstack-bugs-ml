{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:32:45.272550+00:00", 
    "description": "When a VM with an attached iSCSI disk fails to migrate,  the rollback methods does not detach the disk from target host. What happens is _lookup_by_name() fails, since the VM does not exist on the target host.  In detach_volume(), it is supposed to print a warning based on the correct error code being returned, instead of throwing the exception. However,  this is not happening, because _lookup_by_name() throws an InstanceNotFound exception, rather than a libvirt.libvirtError exception. So we also need to catch InstanceNotFound exception, so that detach_volume() can continue to execute as expected.\n\nHere's the exception log that I have:\n\n2014-05-16 16:30:22.328 41419 WARNING nova.compute.manager [req-3db28fed-c287-4b41-ac95-9a37a619c75c 0 4be9915c10c8426cbfe948940f7c8af1] [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c] Detaching volume from unknown instance\n2014-05-16 16:30:22.331 41419 ERROR nova.compute.manager [req-3db28fed-c287-4b41-ac95-9a37a619c75c 0 4be9915c10c8426cbfe948940f7c8af1] [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c] Failed to detach volume 98a940e5-051f-4d0f-a8c7-859a5079d95e from /dev/vdb\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c] Traceback (most recent call last):\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4218, in _detach_volume\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]     encryption=encryption)\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1356, in detach_volume\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]     virt_dom = self._lookup_by_name(instance_name)\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 3477, in _lookup_by_name\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]     raise exception.InstanceNotFound(instance_id=instance_name)\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c] InstanceNotFound: Instance rhel65_113-3e1d0d56-00000002 could not be found.\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]", 
    "tags": [
        "icehouse-backport-potential", 
        "libvirt", 
        "volumes"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1321082", 
    "owner": "https://api.launchpad.net/1.0/~zhaoqin", 
    "id": 1321082, 
    "index": 3905, 
    "created": "2014-05-20 03:58:42.945551+00:00", 
    "title": "libvirt driver detach_volume fails after migration failure", 
    "comments": [
        {
            "content": "When a VM with an attached iSCSI disk fails to migrate,  the rollback methods does not detach the disk from target host. What happens is _lookup_by_name() fails, since the VM does not exist on the target host.  In detach_volume(), it is supposed to print a warning based on the correct error code being returned, instead of throwing the exception. However,  this is not happening, because _lookup_by_name() throws an InstanceNotFound exception, rather than a libvirt.libvirtError exception. So we also need to catch InstanceNotFound exception, so that detach_volume() can continue to execute as expected.\n\nHere's the exception log that I have:\n\n2014-05-16 16:30:22.328 41419 WARNING nova.compute.manager [req-3db28fed-c287-4b41-ac95-9a37a619c75c 0 4be9915c10c8426cbfe948940f7c8af1] [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c] Detaching volume from unknown instance\n2014-05-16 16:30:22.331 41419 ERROR nova.compute.manager [req-3db28fed-c287-4b41-ac95-9a37a619c75c 0 4be9915c10c8426cbfe948940f7c8af1] [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c] Failed to detach volume 98a940e5-051f-4d0f-a8c7-859a5079d95e from /dev/vdb\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c] Traceback (most recent call last):\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4218, in _detach_volume\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]     encryption=encryption)\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1356, in detach_volume\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]     virt_dom = self._lookup_by_name(instance_name)\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 3477, in _lookup_by_name\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]     raise exception.InstanceNotFound(instance_id=instance_name)\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c] InstanceNotFound: Instance rhel65_113-3e1d0d56-00000002 could not be found.\n2014-05-16 16:30:22.331 41419 TRACE nova.compute.manager [instance: 3e1d0d56-3370-4d05-8210-0485fa31757c]", 
            "date_created": "2014-05-20 03:58:42.945551+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhaoqin"
        }, 
        {
            "content": "Patch is here: https://review.openstack.org/#/c/94317/", 
            "date_created": "2014-05-20 13:46:34.350284+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/94945", 
            "date_created": "2014-05-22 17:33:05.082828+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/94317\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=52b57e82c7ef972508777a8bd3c7b937a3673d2d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 52b57e82c7ef972508777a8bd3c7b937a3673d2d\nAuthor: <email address hidden> <email address hidden>\nDate:   Tue May 20 13:13:26 2014 +0800\n\n    Catch InstanceNotFound exception if migration fails\n    \n    When a VM with an attached iSCSI disk fails to migrate, the rollback methods\n    does not detach the disk from target host. What happens is _lookup_by_name()\n    fails, since the VM does not exist on the target host. In detach_volume(), it\n    is supposed to print a warning based on the correct error code being returned,\n    instead of throwing the exception. However, this is not happening, because\n    _lookup_by_name() throws an InstanceNotFound exception, rather than a\n    libvirt.libvirtError exception. So we also need to catch InstanceNotFound\n    exception, so that detach_volume() can continue to execute as expected.\n    \n    Change-Id: I396c23d8137bf1e2834769c5483d2494506949ad\n    Closes-Bug: #1321082\n", 
            "date_created": "2014-05-23 07:08:05.684973+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/94945\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=1a45944105ecbab6870fcc4634502dd1f582d795\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 1a45944105ecbab6870fcc4634502dd1f582d795\nAuthor: <email address hidden> <email address hidden>\nDate:   Tue May 20 13:13:26 2014 +0800\n\n    Catch InstanceNotFound exception if migration fails\n    \n    When a VM with an attached iSCSI disk fails to migrate, the rollback methods\n    does not detach the disk from target host. What happens is _lookup_by_name()\n    fails, since the VM does not exist on the target host. In detach_volume(), it\n    is supposed to print a warning based on the correct error code being returned,\n    instead of throwing the exception. However, this is not happening, because\n    _lookup_by_name() throws an InstanceNotFound exception, rather than a\n    libvirt.libvirtError exception. So we also need to catch InstanceNotFound\n    exception, so that detach_volume() can continue to execute as expected.\n    \n    Change-Id: I396c23d8137bf1e2834769c5483d2494506949ad\n    Closes-Bug: #1321082\n    (cherry picked from commit 52b57e82c7ef972508777a8bd3c7b937a3673d2d)\n", 
            "date_created": "2014-05-30 08:07:03.005590+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}