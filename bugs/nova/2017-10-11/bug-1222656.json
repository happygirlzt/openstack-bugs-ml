{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:11:00.920223+00:00", 
    "description": "If the blockrebase(swap volume) fails, the status of the attached volume remains of detaching.\n\nTried Commit ID:b037993984229bb698050f20e8719b8c06ff2be3\n\n1.Before Swap Volume\n$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n| 66230802-aed6-4a90-9dec-42fec910d13d |   in-use  |    vol01     |  1   |     None    |  False   | 86d8d79c-be27-43c4-b148-b5637c435899 |\n| c3d51a52-764a-4007-976a-136b544c561b | available |    vol02     |  1   |     None    |  False   |                                      |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n\n2.Swap volume running\n$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n| 66230802-aed6-4a90-9dec-42fec910d13d | detaching |    vol01     |  1   |     None    |  False   | 86d8d79c-be27-43c4-b148-b5637c435899 |\n| c3d51a52-764a-4007-976a-136b544c561b | attaching |    vol02     |  1   |     None    |  False   |                                      |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n\n3.An error occurs\u3000in swap volume\nFor example, cancel a blockrebase job.\nlibvirtError: virDomainGetBlockJobInfo() failed\n\n4.After an error occurs\n$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n| 66230802-aed6-4a90-9dec-42fec910d13d | detaching |    vol01     |  1   |     None    |  False   | 86d8d79c-be27-43c4-b148-b5637c435899 |\n| c3d51a52-764a-4007-976a-136b544c561b | available |    vol02     |  1   |     None    |  False   |                                      |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+", 
    "tags": [
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 32, 
    "link": "https://bugs.launchpad.net/nova/+bug/1222656", 
    "owner": "https://api.launchpad.net/1.0/~vladik-romanovsky", 
    "id": 1222656, 
    "index": 4054, 
    "created": "2013-09-09 06:12:07.947194+00:00", 
    "title": "Forget to change volume's status when an error occurs in swap volume", 
    "comments": [
        {
            "content": "If the blockrebase(swap volume) fails, the status of the attached volume remains of detaching.\n\nTried Commit ID:b037993984229bb698050f20e8719b8c06ff2be3\n\n1.Before Swap Volume\n$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n| 66230802-aed6-4a90-9dec-42fec910d13d |   in-use  |    vol01     |  1   |     None    |  False   | 86d8d79c-be27-43c4-b148-b5637c435899 |\n| c3d51a52-764a-4007-976a-136b544c561b | available |    vol02     |  1   |     None    |  False   |                                      |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n\n2.Swap volume running\n$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n| 66230802-aed6-4a90-9dec-42fec910d13d | detaching |    vol01     |  1   |     None    |  False   | 86d8d79c-be27-43c4-b148-b5637c435899 |\n| c3d51a52-764a-4007-976a-136b544c561b | attaching |    vol02     |  1   |     None    |  False   |                                      |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n\n3.An error occurs\u3000in swap volume\nFor example, cancel a blockrebase job.\nlibvirtError: virDomainGetBlockJobInfo() failed\n\n4.After an error occurs\n$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n| 66230802-aed6-4a90-9dec-42fec910d13d | detaching |    vol01     |  1   |     None    |  False   | 86d8d79c-be27-43c4-b148-b5637c435899 |\n| c3d51a52-764a-4007-976a-136b544c561b | available |    vol02     |  1   |     None    |  False   |                                      |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+", 
            "date_created": "2013-09-09 06:12:07.947194+00:00", 
            "author": "https://api.launchpad.net/1.0/~y-jitsukawa"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/49395", 
            "date_created": "2013-10-02 16:14:47.824902+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "In this patch,  status of volume is still 'detaching', however nova can handle exception of Libvirt.\n\nNow, when nova swap volume, nova-api calls cinder API which change status of volume to 'detaching'.\n  nova-api swap_volume()\n   self.volume_api.begin_detaching(context, old_volume['id'])\n\nWhen Libvirt raise exception, nova-compute doesn't revert status of source swap volume, however nova-compute kicks Cinder API which change status of migrate.\nAt terminate_connection() of Cinder, status of dest swap volume back to 'available'.\n  nova-compute swap_volume()\n   self.volume_api.terminate_connection(context, new_volume_id, connector)\n   self.volume_api.migrate_volume_completion(context, old_volume_id, new_volume_id, error=True)\n\nIMO, not only status of migrate, but also nova should revert status of source swap volume to 'in-use'.\nTo be concrete, when Libvirt raise exception, Nova needs to kick roll_detaching() of Cinder.", 
            "date_created": "2013-10-15 05:10:16.397901+00:00", 
            "author": "https://api.launchpad.net/1.0/~y-jitsukawa"
        }, 
        {
            "content": "Hi, \n\nroll_detaching is being called in nova.compute.api.swap_volume() on exception, since\n\nself.volume_api.terminate_connection() in compute.manager.swap_volume, \nis being called in context of: \n            with excutils.save_and_reraise_exception()\n\nHowever, you are right, the problem still exist.  \nThe obvious problem is being caused by compute.rpcapi.swap_volume sending case instead of call, not waiting for the answer.\nI will send a tested patch soon today.\n\nUnfortunately, there is another problem that I see that is not related to libvirt exception handling, (also, blockinfo --abort doesn't produce a libvirt error.)\n\nThe problem is that domain.blockJobInfo may return an empty status in some cases in _wait_for_block_job()\nand will always return False, because of \n\n        try:\n            cur = status.get('cur', 0)\n            end = status.get('end', 0)\n        except Exception:\n            return False\n\nmaking driver._swap_volume stuck forever on \n\nwhile self._wait_for_block_job(domain, disk_path):\n                time.sleep(0.5)\n\n\nI was concerned with something else in my patch, but I think that its not valid.\n\nThanks,\nVladik", 
            "date_created": "2013-10-16 15:44:05.643944+00:00", 
            "author": "https://api.launchpad.net/1.0/~vladik-romanovsky"
        }, 
        {
            "content": "[vladikr@localhost devstack]$ nova list\n+--------------------------------------+-----------+--------+------------+-------------+-------------------+\n| ID                                   | Name      | Status | Task State | Power State | Networks          |\n+--------------------------------------+-----------+--------+------------+-------------+-------------------+\n| 5da0f8be-c6d8-4992-a6c6-bbf2da3aefa9 | nhljkdsf  | ACTIVE | deleting   | Running     | private=10.0.0.31 |\n| bd3912c8-6c7f-4297-84b3-3fde73a51297 | test_swap | ACTIVE | None       | Running     | private=10.0.0.45 |\n+--------------------------------------+-----------+--------+------------+-------------+-------------------+\n[vladikr@localhost devstack]$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n| 21f0808c-53f0-4eaf-805f-1fef5d4d3f89 |   in-use  |              |  2   |     None    |   True   | bd3912c8-6c7f-4297-84b3-3fde73a51297 |\n| b30af6f7-d957-437e-be9d-e7e70e9426d1 | available |              |  2   |     None    |   True   |                                      |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n\n\nFrom the log:\n\n2013-10-16 11:13:16.409 ERROR nova.api.openstack [req-86547e4f-789d-47d7-b22e-84a10c8f55d9 admin admin] Caught error: Volumes swap failed\nTraceback (most recent call last):\n\n  File \"/home/vladikr/devel/openstack/nova/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n    **args)\n\n  File \"/home/vladikr/devel/openstack/nova/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n    result = getattr(proxyobj, method)(ctxt, **kwargs)\n\n  File \"/home/vladikr/devel/openstack/nova/nova/exception.py\", line 90, in wrapped\n    payload)\n\n  File \"/home/vladikr/devel/openstack/nova/nova/exception.py\", line 73, in wrapped\n    return f(self, context, *args, **kw)\n\n  File \"/home/vladikr/devel/openstack/nova/nova/compute/manager.py\", line 244, in decorated_function\n    pass\n\n  File \"/home/vladikr/devel/openstack/nova/nova/compute/manager.py\", line 230, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/home/vladikr/devel/openstack/nova/nova/compute/manager.py\", line 272, in decorated_function\n    e, sys.exc_info())\n\n  File \"/home/vladikr/devel/openstack/nova/nova/compute/manager.py\", line 259, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/home/vladikr/devel/openstack/nova/nova/compute/manager.py\", line 3835, in swap_volume\n    error=True)\n\n  File \"/home/vladikr/devel/openstack/nova/nova/compute/manager.py\", line 3820, in swap_volume\n    self.driver.swap_volume(old_cinfo, new_cinfo, instance, mountpoint)\n\n  File \"/home/vladikr/devel/openstack/nova/nova/virt/libvirt/driver.py\", line 1174, in swap_volume\n    self._swap_volume(virt_dom, disk_dev, conf.source_path)\n\n  File \"/home/vladikr/devel/openstack/nova/nova/virt/libvirt/driver.py\", line 1149, in _swap_volume\n    raise exception.NovaException(msg)\n\nNovaException: Volumes swap failed\n\n\n\n\n[vladikr@localhost devstack]$ nova volume-update test_swap 21f0808c-53f0-4eaf-805f-1fef5d4d3f89 b30af6f7-d957-437e-be9d-e7e70e9426d1\nERROR: The server has either erred or is incapable of performing the requested operation. (HTTP 500) (Request-ID: req-86547e4f-789d-47d7-b22e-84a10c8f55d9)\n[vladikr@localhost devstack]$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n| 21f0808c-53f0-4eaf-805f-1fef5d4d3f89 |   in-use  |              |  2   |     None    |   True   | bd3912c8-6c7f-4297-84b3-3fde73a51297 |\n| b30af6f7-d957-437e-be9d-e7e70e9426d1 | available |              |  2   |     None    |   True   |                                      |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+", 
            "date_created": "2013-10-16 19:26:49.357821+00:00", 
            "author": "https://api.launchpad.net/1.0/~vladik-romanovsky"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/49395\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=724493d21fdfcbb4c095b54975c0c1d612f0a856\nSubmitter: Jenkins\nBranch:    master\n\ncommit 724493d21fdfcbb4c095b54975c0c1d612f0a856\nAuthor: Vladik Romanovsky <email address hidden>\nDate:   Mon Sep 30 13:47:58 2013 -0400\n\n    Clean swap_volume rollback, on libvirt exception.\n    \n    Handling swap_volume command's rollback on the manager side\n    instead of the API, to allow clean rollback.\n    \n    Change-Id: I7d5c1e66bf01fd12fcaa783c1c3c90d92b009aea\n    Closes-Bug: #1222656\n", 
            "date_created": "2014-02-06 15:51:32.770335+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}