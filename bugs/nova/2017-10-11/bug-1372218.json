{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:59:36.841195+00:00", 
    "description": "I'm trying to list servers by filtering on system_metadata or metadata.\n\nI should be able to do something like (looking into the code)\n\nnclient.servers.list(search_opts={'system_metadata': {\"some_value\": \"some_key\"}, 'all_tenants': 1})\n\nBut this dictionary gets turned into a unicode string. I get a 500 back from nova with the below stack trace in nova-api.\n\nThe offending code is in exact_filter in the db api. It is expecting a list of dicts or a single dict when using system_metadata or metadata key when searching. It looks like this used to work but now somewhere higher up is ensuring this is a string.\n\n\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack Traceback (most recent call last):\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/__init__.py\", line 125, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return req.get_response(self.application)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1320, in send\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     application, catch_exc_info=False)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1284, in call_application\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return resp(environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/keystoneclient/middleware/auth_token.py\", line 582, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return self.app(env, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return resp(environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return resp(environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return resp(environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/wsgi.py\", line 917, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     content_type, body, accept)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/wsgi.py\", line 983, in _process_stack\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/wsgi.py\", line 1070, in dispatch\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return method(req=request, **action_args)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/compute/servers.py\", line 520, in detail\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     servers = self._get_servers(req, is_detail=True)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/compute/servers.py\", line 603, in _get_servers\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     want_objects=True)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/compute/api.py\", line 1887, in get_all\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     expected_attrs=expected_attrs)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/compute/cells_api.py\", line 224, in _get_instances_by_filters\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     limit=limit, marker=marker, expected_attrs=fields)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/objects/base.py\", line 112, in wrapper\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     result = fn(cls, context, *args, **kwargs)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/objects/instance.py\", line 629, in get_by_filters\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     use_slave=use_slave)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/db/api.py\", line 665, in instance_get_all_by_filters\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     use_slave=use_slave)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/db/sqlalchemy/api.py\", line 164, in wrapper\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return f(*args, **kwargs)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/db/sqlalchemy/api.py\", line 2008, in instance_get_all_by_filters\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     filters, exact_match_filter_names)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/db/sqlalchemy/api.py\", line 388, in exact_filter\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     for k, v in value.iteritems():\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack AttributeError: 'unicode' object has no attribute 'iteritems'", 
    "tags": [
        "api"
    ], 
    "importance": "Medium", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1372218", 
    "owner": "https://api.launchpad.net/1.0/~cyeoh-0", 
    "id": 1372218, 
    "index": 4054, 
    "created": "2014-09-22 01:38:09.038987+00:00", 
    "title": "servers.list, filtering on metadata doesn't work. unicode error", 
    "comments": [
        {
            "content": "I'm trying to list servers by filtering on system_metadata or metadata.\n\nI should be able to do something like (looking into the code)\n\nnclient.servers.list(search_opts={'system_metadata': {\"some_value\": \"some_key\"}, 'all_tenants': 1})\n\nBut this dictionary gets turned into a unicode string. I get a 500 back from nova with the below stack trace in nova-api.\n\nThe offending code is in exact_filter in the db api. It is expecting a list of dicts or a single dict when using system_metadata or metadata key when searching. It looks like this used to work but now somewhere higher up is ensuring this is a string.\n\n\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack Traceback (most recent call last):\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/__init__.py\", line 125, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return req.get_response(self.application)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1320, in send\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     application, catch_exc_info=False)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1284, in call_application\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return resp(environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/keystoneclient/middleware/auth_token.py\", line 582, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return self.app(env, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return resp(environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return resp(environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return resp(environ, start_response)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/wsgi.py\", line 917, in __call__\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     content_type, body, accept)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/wsgi.py\", line 983, in _process_stack\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/wsgi.py\", line 1070, in dispatch\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return method(req=request, **action_args)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/compute/servers.py\", line 520, in detail\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     servers = self._get_servers(req, is_detail=True)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/api/openstack/compute/servers.py\", line 603, in _get_servers\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     want_objects=True)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/compute/api.py\", line 1887, in get_all\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     expected_attrs=expected_attrs)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/compute/cells_api.py\", line 224, in _get_instances_by_filters\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     limit=limit, marker=marker, expected_attrs=fields)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/objects/base.py\", line 112, in wrapper\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     result = fn(cls, context, *args, **kwargs)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/objects/instance.py\", line 629, in get_by_filters\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     use_slave=use_slave)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/db/api.py\", line 665, in instance_get_all_by_filters\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     use_slave=use_slave)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/db/sqlalchemy/api.py\", line 164, in wrapper\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     return f(*args, **kwargs)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/db/sqlalchemy/api.py\", line 2008, in instance_get_all_by_filters\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     filters, exact_match_filter_names)\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack   File \"/opt/nova/nova/db/sqlalchemy/api.py\", line 388, in exact_filter\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack     for k, v in value.iteritems():\n2014-09-22 11:31:28.916 20196 TRACE nova.api.openstack AttributeError: 'unicode' object has no attribute 'iteritems'", 
            "date_created": "2014-09-22 01:38:09.038987+00:00", 
            "author": "https://api.launchpad.net/1.0/~sorrison"
        }, 
        {
            "content": "The conversion to unicode occurs during the request to the Nova API as the filter needs to be converted to url parameter request. Nova however does not convert it back to a dict. Need to fix this in compute/api.py", 
            "date_created": "2014-09-22 04:44:56.414730+00:00", 
            "author": "https://api.launchpad.net/1.0/~cyeoh-0"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/123059", 
            "date_created": "2014-09-22 07:12:28.364882+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/123059\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ba15ddbf9ba2db3bf4768a91b51d1ca10d2d2833\nSubmitter: Jenkins\nBranch:    master\n\ncommit ba15ddbf9ba2db3bf4768a91b51d1ca10d2d2833\nAuthor: Chris Yeoh <email address hidden>\nDate:   Mon Sep 22 16:40:41 2014 +0930\n\n    Fixes server list filtering on metadata\n    \n    In order to specify filtering of returned servers based on\n    metadata or system metadata a key/value pair string is passed to\n    the API. However, the string is never converted to a separate\n    key/value dictionary. This results in the db failing to filter\n    correctly and causes a stack trace.\n    \n    This change correctly converts the string values for system\n    metadata and metadata to dictionaries and fixes the compute api\n    unittests which previously erroneously assumed that the compute\n    api layer would be passed search opts in dict format when\n    required.\n    \n    Change-Id: I886d5e770fe16fc2194b33c563a131b550f13f59\n    Closes-Bug: 1372218\n", 
            "date_created": "2014-09-25 04:57:59.555950+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}