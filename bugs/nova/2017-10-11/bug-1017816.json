{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:24:02.065262+00:00", 
    "description": "The mapping code for snapshots and volumes are setting project_only in the model query improperly. The code is working because we happen to have an elevated context, but if you make the call without an elevated context you get an error:\n\nvagrant@precise:~/devstack$ euca-create-volume -z nova -s 1\nVOLUME  vol-00000002    1       nova    creating        2012-06-26T05:42:07.785Z\nvagrant@precise:~/devstack$ euca-describe-volumes\nVOLUME  vol-00000002     1              nova    available       2012-06-26T05:42:07.000Z\nvagrant@precise:~/devstack$ nova-manage sh py\nPython 2.7.3 (default, Apr 20 2012, 22:39:59) \n[GCC 4.6.3] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n(InteractiveConsole)\n>>> from nova import context\n>>> ctxt = context.RequestContext('foo', 'bar', False)\n>>> from nova import db\n>>> db.get_volume_uuid_by_ec2_id(ctxt, 1)       \n2012-06-26 05:43:55 DEBUG nova.utils [req-a21f5393-7346-4675-9534-853621ea9321 None None] backend <module 'nova.db.sqlalchemy.api' from '/opt/stack/nova/nova/db/sqlalchemy/api.pyc'> from (pid=16963) __get_backend /opt/stack/nova/nova/utils.py:489\nTraceback (most recent call last):\n  File \"<console>\", line 1, in <module>\n  File \"/opt/stack/nova/nova/db/api.py\", line 1143, in get_volume_uuid_by_ec2_id\n    return IMPL.get_volume_uuid_by_ec2_id(context, ec2_id)\n  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 132, in wrapper\n    return f(*args, **kwargs)\n  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 3044, in get_volume_uuid_by_ec2_id\n    project_only=True).\\\n  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 132, in wrapper\n    return f(*args, **kwargs)\n  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 2933, in _ec2_volume_get_query\n    project_only=project_only)\n  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 218, in model_query\n    query = query.filter_by(project_id=context.project_id)\n  File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 1098, in filter_by\n    for key, value in kwargs.iteritems()]\n  File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/util.py\", line 568, in _entity_descriptor\n    (entity, key)\nInvalidRequestError: Entity '<class 'nova.db.sqlalchemy.models.VolumeIdMapping'>' has no property 'project_id'", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1017816", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 1017816, 
    "index": 2952, 
    "created": "2012-06-26 05:44:20.043757+00:00", 
    "title": "volume and snapshot mapping are using improper project_only context", 
    "comments": [
        {
            "content": "The mapping code for snapshots and volumes are setting project_only in the model query improperly. The code is working because we happen to have an elevated context, but if you make the call without an elevated context you get an error:\n\nvagrant@precise:~/devstack$ euca-create-volume -z nova -s 1\nVOLUME  vol-00000002    1       nova    creating        2012-06-26T05:42:07.785Z\nvagrant@precise:~/devstack$ euca-describe-volumes\nVOLUME  vol-00000002     1              nova    available       2012-06-26T05:42:07.000Z\nvagrant@precise:~/devstack$ nova-manage sh py\nPython 2.7.3 (default, Apr 20 2012, 22:39:59) \n[GCC 4.6.3] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n(InteractiveConsole)\n>>> from nova import context\n>>> ctxt = context.RequestContext('foo', 'bar', False)\n>>> from nova import db\n>>> db.get_volume_uuid_by_ec2_id(ctxt, 1)       \n2012-06-26 05:43:55 DEBUG nova.utils [req-a21f5393-7346-4675-9534-853621ea9321 None None] backend <module 'nova.db.sqlalchemy.api' from '/opt/stack/nova/nova/db/sqlalchemy/api.pyc'> from (pid=16963) __get_backend /opt/stack/nova/nova/utils.py:489\nTraceback (most recent call last):\n  File \"<console>\", line 1, in <module>\n  File \"/opt/stack/nova/nova/db/api.py\", line 1143, in get_volume_uuid_by_ec2_id\n    return IMPL.get_volume_uuid_by_ec2_id(context, ec2_id)\n  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 132, in wrapper\n    return f(*args, **kwargs)\n  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 3044, in get_volume_uuid_by_ec2_id\n    project_only=True).\\\n  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 132, in wrapper\n    return f(*args, **kwargs)\n  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 2933, in _ec2_volume_get_query\n    project_only=project_only)\n  File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 218, in model_query\n    query = query.filter_by(project_id=context.project_id)\n  File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 1098, in filter_by\n    for key, value in kwargs.iteritems()]\n  File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/util.py\", line 568, in _entity_descriptor\n    (entity, key)\nInvalidRequestError: Entity '<class 'nova.db.sqlalchemy.models.VolumeIdMapping'>' has no property 'project_id'", 
            "date_created": "2012-06-26 05:44:20.043757+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/8993", 
            "date_created": "2012-06-26 06:02:02.409976+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/8993\nCommitted: http://github.com/openstack/nova/commit/d69adf946caeea1202a52fa9229b7c636c12a81d\nSubmitter: Jenkins\nBranch:    master\n\ncommit d69adf946caeea1202a52fa9229b7c636c12a81d\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Mon Jun 25 22:59:31 2012 -0700\n\n    Fix db calls for snaphsot and volume mapping\n    \n     * Fix misuse of project_only\n     * Includes failing tests\n     * Adds missing call to db/api.py\n     * Fixes bug 1017816\n    \n    Change-Id: I993089ba031a05e7ab0ea91c279a2ac47593eda3\n", 
            "date_created": "2012-06-27 20:27:35.648899+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}