{
    "status": "Fix Released", 
    "last_updated": "2016-05-09 09:37:11.569071+00:00", 
    "description": "Use rally for cinder boot from voume test, after test completed, found a lot of VMs were deleted failed with error status, manual retry a few times to delete VM, but can't work.\n[root@abba-n04 home]#  nova list --all-tenants\n+--------------------------------------+-----------------------------------+----------------------------------+--------+------------+-------------+----------+\n| ID                                   | Name                              | Tenant ID                        | Status | Task State | Power State | Networks |\n+--------------------------------------+-----------------------------------+----------------------------------+--------+------------+-------------+----------+\n| 335f2ca0-a86d-45a5-b4a6-4d4ea1930e89 | rally_novaserver_aftvfqejftusyflf | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 888aa512-07f0-42ad-ae5e-255bbca6fe34 | rally_novaserver_ajqhjxjxnjojelgm | 7e05339543e743c3b023cee8128bbbbe | ERROR  | -          | NOSTATE     |          |\n| 84b32483-2997-4a2a-8d75-236395b4ef2f | rally_novaserver_arycquunqovvyxnl | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 535f1ce1-63fe-4681-b215-e21d38f77fbb | rally_novaserver_arzjesynagiqfjgt | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 6ef3fa37-e5a9-4a21-8996-d291070c246a | rally_novaserver_aufevkgzvynumwwo | d37e8219a3de4e5b985828a0b959f1d6 | ERROR  | -          | NOSTATE     |          |\n| e5d2dc5f-6e86-43e2-8f1f-1a3f6d4951bc | rally_novaserver_ayzjeqcplouwcaht | d37e8219a3de4e5b985828a0b959f1d6 | ERROR  | -          | NOSTATE     |          |\n| 2dcb294a-e2cc-4989-9e87-74081f1567db | rally_novaserver_bbphsjrexkcgcjtt | 7e05339543e743c3b023cee8128bbbbe | ERROR  | -          | NOSTATE     |          |\n| 88053991-2fab-4442-86c7-7825ed47ff0a | rally_novaserver_beveqwdokixwdbgi | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 1e109862-34ea-4686-a099-28f5840244cf | rally_novaserver_bimlwsfkndjbrczv | d37e8219a3de4e5b985828a0b959f1d6 | ERROR  | -          | NOSTATE     |          |\n| 6143bbb2-d3eb-4635-9554-85b30fbb5aa5 | rally_novaserver_bmycsptyoicymdmb | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 5e9308ae-9736-485f-92b7-e6783c613ba1 | rally_novaserver_bsvcnsqeyawcnbgp | d37e8219a3de4e5b985828a0b959f1d6 | ERROR  | -          | NOSTATE     |          |\n| 13fb2413-15b6-41a3-a8a0-a0b775747261 | rally_novaserver_bvfyfnnixwgisbkk | d37e8219a3de4e5b985828a0b959f1d6 | ERROR  | -          | NOSTATE     |          |\n| d5ce6fa3-99b5-4d61-ac7c-4b5bc13d1c27 | rally_novaserver_cpbevhulxylepvql | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 23ce9007-ab43-4b57-8686-4aa1ce336f09 | rally_novaserver_cswudaopawepnmms | 7e05339543e743c3b023cee8128bbbbe | ERROR  | -          | NOSTATE     |          |\n\n[root@abba-n04 home]# nova delete 335f2ca0-a86d-45a5-b4a6-4d4ea1930e89\nRequest to delete server 335f2ca0-a86d-45a5-b4a6-4d4ea1930e89 has been accepted.\n[root@abba-n04 home]# nova  list --all | grep  335f2ca0-a86d-45a5-b4a6-4d4ea1930e89\n| 335f2ca0-a86d-45a5-b4a6-4d4ea1930e89 | rally_novaserver_aftvfqejftusyflf | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n[root@abba-n04 home]#\n\nThe system is using local LVM volumes attached via iSCSI.  It appears that something is going wrong when the attempt to detach the volume is being made:\n\n2015-04-29 07:26:02.680 21775 DEBUG oslo_concurrency.processutils [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Running cmd (subprocess): sudo cinder-rootwrap /etc/cinder/rootwrap.conf cinder-rtstool delete-initiator iqn.2010-10.org.openstack:volume-a2907017-dda6-4243-bc50-85fe2164f05f iqn.1994-05.com.redhat:734fb33285d0 execute /usr/lib/python2.7/site-packages/oslo_concurrency/processutils.py:199\n2015-04-29 07:26:02.813 21775 DEBUG oslo_concurrency.processutils [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] CMD \"sudo cinder-rootwrap /etc/cinder/rootwrap.conf cinder-rtstool delete-initiator iqn.2010-10.org.openstack:volume-a2907017-dda6-4243-bc50-85fe2164f05f iqn.1994-05.com.redhat:734fb33285d0\" returned: 1 in 0.133s execute /usr/lib/python2.7/site-packages/oslo_concurrency/processutils.py:225\n2015-04-29 07:26:02.814 21775 DEBUG oslo_concurrency.processutils [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] u'sudo cinder-rootwrap /etc/cinder/rootwrap.conf cinder-rtstool delete-initiator iqn.2010-10.org.openstack:volume-a2907017-dda6-4243-bc50-85fe2164f05f iqn.1994-05.com.redhat:734fb33285d0' failed. Not Retrying. execute /usr/lib/python2.7/site-packages/oslo_concurrency/processutils.py:258\n2015-04-29 07:26:02.815 21775 ERROR cinder.volume.targets.lio [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Failed to delete initiator iqn iqn.1994-05.com.redhat:734fb33285d0 to target.\n2015-04-29 07:26:02.816 21775 ERROR cinder.volume.manager [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Unable to terminate volume connection: Failed to detach iSCSI target for volume a2907017-dda6-4243-bc50-85fe2164f05f.\n2015-04-29 07:26:02.817 21775 ERROR oslo_messaging.rpc.dispatcher [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Exception during message handling: Bad or unexpected response from the storage volume backend API: Unable to terminate volume connection: Failed to detach iSCSI target for volume a2907017-dda6-4243-bc50-85fe2164f05f.\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/osprofiler/profiler.py\", line 105, in wrapper\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher     return f(*args, **kwargs)\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinder/volume/manager.py\", line 1168, in terminate_connection\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher     raise exception.VolumeBackendAPIException(data=err_msg)\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher VolumeBackendAPIException: Bad or unexpected response from the storage volume backend API: Unable to terminate volume connection: Failed to detach iSCSI target for volume a2907017-dda6-4243-bc50-85fe2164f05f.\n\nThis in turn causes issues for Nova:\n\n2015-04-29 07:26:03.455 18637 INFO nova.scheduler.client.report [req-c0ca7f2a-d2ff-4e6d-8841-06c860781c55 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Compute_service record updated for ('abba-n04.private.cloud.com', 'abba-n04.private.cloud.com')\n2015-04-29 07:26:03.462 18637 ERROR oslo_messaging.rpc.dispatcher [req-c0ca7f2a-d2ff-4e6d-8841-06c860781c55 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Exception during message handling: Internal Server Error (HTTP 500) (Request-ID: req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 6853, in terminate_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     reservations=reservations)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     payload)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 328, in decorated_function\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     LOG.warning(msg, e, instance_uuid=instance_uuid)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 299, in decorated_function\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 378, in decorated_function\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 356, in decorated_function\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 344, in decorated_function\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2792, in terminate_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     do_terminate_instance(instance, bdms)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_concurrency/lockutils.py\", line 445, in inner\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return f(*args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2790, in do_terminate_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     self._set_instance_error_state(context, instance)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2780, in do_terminate_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     self._delete_instance(context, instance, bdms, quotas)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/hooks.py\", line 149, in inner\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     rv = f(*args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2749, in _delete_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     quotas.rollback()\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2719, in _delete_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     self._shutdown_instance(context, instance, bdms)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2658, in _shutdown_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     connector)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/volume/cinder.py\", line 214, in wrapper\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     res = method(self, ctx, volume_id, *args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/volume/cinder.py\", line 375, in terminate_connection\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     connector)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinderclient/v2/volumes.py\", line 384, in terminate_connection\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     {'connector': connector})\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinderclient/v2/volumes.py\", line 311, in _action\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return self.api.client.post(url, body=body)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 91, in post\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return self._cs_request(url, 'POST', **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 85, in _cs_request\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return self.request(url, method, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 80, in request\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return super(SessionClient, self).request(*args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/keystoneclient/adapter.py\", line 200, in request\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     resp = super(LegacyJsonAdapter, self).request(*args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/keystoneclient/adapter.py\", line 89, in request\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return self.session.request(url, method, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/keystoneclient/utils.py\", line 318, in inner\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return func(*args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/keystoneclient/session.py\", line 390, in request\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     raise exceptions.from_response(resp, method, url)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher InternalServerError: Internal Server Error (HTTP 500) (Request-ID: req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher\n\nIt looks to me like the following code in nova/compute/manager.py  _shutdown_instance() might need to be expanded:\n\n        for bdm in vol_bdms:\n            try:\n                # NOTE(vish): actual driver detach done in driver.destroy, so\n                #             just tell cinder that we are done with it.\n                connector = self.driver.get_volume_connector(instance)\n                self.volume_api.terminate_connection(context,\n                                                     bdm.volume_id,\n                                                     connector)\n                self.volume_api.detach(context, bdm.volume_id)\n            except exception.DiskNotFound as exc:\n                LOG.debug('Ignoring DiskNotFound: %s', exc,\n                          instance=instance)\n            except exception.VolumeNotFound as exc:\n                LOG.debug('Ignoring VolumeNotFound: %s', exc,\n                          instance=instance)\n            except (cinder_exception.EndpointNotFound,\n                    keystone_exception.EndpointNotFound) as exc:\n                LOG.warning(_LW('Ignoring EndpointNotFound: %s'), exc,\n                            instance=instance)\n\nIt looks to me like things are going wrong because it is getting the VolumeBackendAPIException and things fall apart from there.  It would make more sense to me, in the case of a volume exception, to log a warning and then keep cleaning up so we don't have a bunch of orphaned instances left around.", 
    "tags": [
        "compute", 
        "volumes"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1450658", 
    "owner": "https://api.launchpad.net/1.0/~jichenjc", 
    "id": 1450658, 
    "index": 448, 
    "created": "2015-04-30 22:25:37.679007+00:00", 
    "title": "VolumeBackendAPIException during _shutdown_instance are not handled", 
    "comments": [
        {
            "content": "Use rally for cinder boot from voume test, after test completed, found a lot of VMs were deleted failed with error status, manual retry a few times to delete VM, but can't work.\n[root@abba-n04 home]#  nova list --all-tenants\n+--------------------------------------+-----------------------------------+----------------------------------+--------+------------+-------------+----------+\n| ID                                   | Name                              | Tenant ID                        | Status | Task State | Power State | Networks |\n+--------------------------------------+-----------------------------------+----------------------------------+--------+------------+-------------+----------+\n| 335f2ca0-a86d-45a5-b4a6-4d4ea1930e89 | rally_novaserver_aftvfqejftusyflf | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 888aa512-07f0-42ad-ae5e-255bbca6fe34 | rally_novaserver_ajqhjxjxnjojelgm | 7e05339543e743c3b023cee8128bbbbe | ERROR  | -          | NOSTATE     |          |\n| 84b32483-2997-4a2a-8d75-236395b4ef2f | rally_novaserver_arycquunqovvyxnl | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 535f1ce1-63fe-4681-b215-e21d38f77fbb | rally_novaserver_arzjesynagiqfjgt | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 6ef3fa37-e5a9-4a21-8996-d291070c246a | rally_novaserver_aufevkgzvynumwwo | d37e8219a3de4e5b985828a0b959f1d6 | ERROR  | -          | NOSTATE     |          |\n| e5d2dc5f-6e86-43e2-8f1f-1a3f6d4951bc | rally_novaserver_ayzjeqcplouwcaht | d37e8219a3de4e5b985828a0b959f1d6 | ERROR  | -          | NOSTATE     |          |\n| 2dcb294a-e2cc-4989-9e87-74081f1567db | rally_novaserver_bbphsjrexkcgcjtt | 7e05339543e743c3b023cee8128bbbbe | ERROR  | -          | NOSTATE     |          |\n| 88053991-2fab-4442-86c7-7825ed47ff0a | rally_novaserver_beveqwdokixwdbgi | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 1e109862-34ea-4686-a099-28f5840244cf | rally_novaserver_bimlwsfkndjbrczv | d37e8219a3de4e5b985828a0b959f1d6 | ERROR  | -          | NOSTATE     |          |\n| 6143bbb2-d3eb-4635-9554-85b30fbb5aa5 | rally_novaserver_bmycsptyoicymdmb | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 5e9308ae-9736-485f-92b7-e6783c613ba1 | rally_novaserver_bsvcnsqeyawcnbgp | d37e8219a3de4e5b985828a0b959f1d6 | ERROR  | -          | NOSTATE     |          |\n| 13fb2413-15b6-41a3-a8a0-a0b775747261 | rally_novaserver_bvfyfnnixwgisbkk | d37e8219a3de4e5b985828a0b959f1d6 | ERROR  | -          | NOSTATE     |          |\n| d5ce6fa3-99b5-4d61-ac7c-4b5bc13d1c27 | rally_novaserver_cpbevhulxylepvql | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n| 23ce9007-ab43-4b57-8686-4aa1ce336f09 | rally_novaserver_cswudaopawepnmms | 7e05339543e743c3b023cee8128bbbbe | ERROR  | -          | NOSTATE     |          |\n\n[root@abba-n04 home]# nova delete 335f2ca0-a86d-45a5-b4a6-4d4ea1930e89\nRequest to delete server 335f2ca0-a86d-45a5-b4a6-4d4ea1930e89 has been accepted.\n[root@abba-n04 home]# nova  list --all | grep  335f2ca0-a86d-45a5-b4a6-4d4ea1930e89\n| 335f2ca0-a86d-45a5-b4a6-4d4ea1930e89 | rally_novaserver_aftvfqejftusyflf | 3e87ac6d12264286a10ac68eb913dacb | ERROR  | -          | NOSTATE     |          |\n[root@abba-n04 home]#\n\nThe system is using local LVM volumes attached via iSCSI.  It appears that something is going wrong when the attempt to detach the volume is being made:\n\n2015-04-29 07:26:02.680 21775 DEBUG oslo_concurrency.processutils [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Running cmd (subprocess): sudo cinder-rootwrap /etc/cinder/rootwrap.conf cinder-rtstool delete-initiator iqn.2010-10.org.openstack:volume-a2907017-dda6-4243-bc50-85fe2164f05f iqn.1994-05.com.redhat:734fb33285d0 execute /usr/lib/python2.7/site-packages/oslo_concurrency/processutils.py:199\n2015-04-29 07:26:02.813 21775 DEBUG oslo_concurrency.processutils [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] CMD \"sudo cinder-rootwrap /etc/cinder/rootwrap.conf cinder-rtstool delete-initiator iqn.2010-10.org.openstack:volume-a2907017-dda6-4243-bc50-85fe2164f05f iqn.1994-05.com.redhat:734fb33285d0\" returned: 1 in 0.133s execute /usr/lib/python2.7/site-packages/oslo_concurrency/processutils.py:225\n2015-04-29 07:26:02.814 21775 DEBUG oslo_concurrency.processutils [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] u'sudo cinder-rootwrap /etc/cinder/rootwrap.conf cinder-rtstool delete-initiator iqn.2010-10.org.openstack:volume-a2907017-dda6-4243-bc50-85fe2164f05f iqn.1994-05.com.redhat:734fb33285d0' failed. Not Retrying. execute /usr/lib/python2.7/site-packages/oslo_concurrency/processutils.py:258\n2015-04-29 07:26:02.815 21775 ERROR cinder.volume.targets.lio [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Failed to delete initiator iqn iqn.1994-05.com.redhat:734fb33285d0 to target.\n2015-04-29 07:26:02.816 21775 ERROR cinder.volume.manager [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Unable to terminate volume connection: Failed to detach iSCSI target for volume a2907017-dda6-4243-bc50-85fe2164f05f.\n2015-04-29 07:26:02.817 21775 ERROR oslo_messaging.rpc.dispatcher [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Exception during message handling: Bad or unexpected response from the storage volume backend API: Unable to terminate volume connection: Failed to detach iSCSI target for volume a2907017-dda6-4243-bc50-85fe2164f05f.\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/osprofiler/profiler.py\", line 105, in wrapper\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher     return f(*args, **kwargs)\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinder/volume/manager.py\", line 1168, in terminate_connection\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher     raise exception.VolumeBackendAPIException(data=err_msg)\n2015-04-29 07:26:02.817 21775 TRACE oslo_messaging.rpc.dispatcher VolumeBackendAPIException: Bad or unexpected response from the storage volume backend API: Unable to terminate volume connection: Failed to detach iSCSI target for volume a2907017-dda6-4243-bc50-85fe2164f05f.\n\nThis in turn causes issues for Nova:\n\n2015-04-29 07:26:03.455 18637 INFO nova.scheduler.client.report [req-c0ca7f2a-d2ff-4e6d-8841-06c860781c55 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Compute_service record updated for ('abba-n04.private.cloud.com', 'abba-n04.private.cloud.com')\n2015-04-29 07:26:03.462 18637 ERROR oslo_messaging.rpc.dispatcher [req-c0ca7f2a-d2ff-4e6d-8841-06c860781c55 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Exception during message handling: Internal Server Error (HTTP 500) (Request-ID: req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 6853, in terminate_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     reservations=reservations)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     payload)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 328, in decorated_function\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     LOG.warning(msg, e, instance_uuid=instance_uuid)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 299, in decorated_function\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 378, in decorated_function\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 356, in decorated_function\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 344, in decorated_function\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2792, in terminate_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     do_terminate_instance(instance, bdms)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_concurrency/lockutils.py\", line 445, in inner\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return f(*args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2790, in do_terminate_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     self._set_instance_error_state(context, instance)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2780, in do_terminate_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     self._delete_instance(context, instance, bdms, quotas)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/hooks.py\", line 149, in inner\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     rv = f(*args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2749, in _delete_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     quotas.rollback()\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2719, in _delete_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     self._shutdown_instance(context, instance, bdms)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2658, in _shutdown_instance\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     connector)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/volume/cinder.py\", line 214, in wrapper\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     res = method(self, ctx, volume_id, *args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/volume/cinder.py\", line 375, in terminate_connection\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     connector)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinderclient/v2/volumes.py\", line 384, in terminate_connection\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     {'connector': connector})\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinderclient/v2/volumes.py\", line 311, in _action\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return self.api.client.post(url, body=body)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 91, in post\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return self._cs_request(url, 'POST', **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 85, in _cs_request\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return self.request(url, method, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 80, in request\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return super(SessionClient, self).request(*args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/keystoneclient/adapter.py\", line 200, in request\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     resp = super(LegacyJsonAdapter, self).request(*args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/keystoneclient/adapter.py\", line 89, in request\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return self.session.request(url, method, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/keystoneclient/utils.py\", line 318, in inner\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     return func(*args, **kwargs)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/keystoneclient/session.py\", line 390, in request\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher     raise exceptions.from_response(resp, method, url)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher InternalServerError: Internal Server Error (HTTP 500) (Request-ID: req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2)\n2015-04-29 07:26:03.462 18637 TRACE oslo_messaging.rpc.dispatcher\n\nIt looks to me like the following code in nova/compute/manager.py  _shutdown_instance() might need to be expanded:\n\n        for bdm in vol_bdms:\n            try:\n                # NOTE(vish): actual driver detach done in driver.destroy, so\n                #             just tell cinder that we are done with it.\n                connector = self.driver.get_volume_connector(instance)\n                self.volume_api.terminate_connection(context,\n                                                     bdm.volume_id,\n                                                     connector)\n                self.volume_api.detach(context, bdm.volume_id)\n            except exception.DiskNotFound as exc:\n                LOG.debug('Ignoring DiskNotFound: %s', exc,\n                          instance=instance)\n            except exception.VolumeNotFound as exc:\n                LOG.debug('Ignoring VolumeNotFound: %s', exc,\n                          instance=instance)\n            except (cinder_exception.EndpointNotFound,\n                    keystone_exception.EndpointNotFound) as exc:\n                LOG.warning(_LW('Ignoring EndpointNotFound: %s'), exc,\n                            instance=instance)\n\nIt looks to me like things are going wrong because it is getting the VolumeBackendAPIException and things fall apart from there.  It would make more sense to me, in the case of a volume exception, to log a warning and then keep cleaning up so we don't have a bunch of orphaned instances left around.", 
            "date_created": "2015-04-30 22:25:37.679007+00:00", 
            "author": "https://api.launchpad.net/1.0/~jsbryant"
        }, 
        {
            "content": "um.. seems cinder client don't have the exception yet\nmaybe a new exception is needed to be added so nova can catch it ?", 
            "date_created": "2015-05-04 15:10:21.255559+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "For one thing, the cinder code isn't logging the reason for the failure here:\n\n2015-04-29 07:26:02.815 21775 ERROR cinder.volume.targets.lio [req-fec5ff89-5465-4e76-b573-6a5afc0d4ee2 a9d0160b91f2412d84972a615b7547dc 828348052e494d76a401f669f85829f3 - - -] Failed to delete initiator iqn iqn.1994-05.com.redhat:734fb33285d0 to target.\n\nThat's catching a ProcessExecutionError but not logging stdout/stderr information so it's going to be hard to debug.\n\nThat raises ISCSITargetDetachFailed which is just wrapped into the generic VolumeBackendAPIException in volume manager terminate_connection which raises it up to the API which returns a 500 in the response, which isn't helpful.\n\nSo a few things you have to unwind if you want a more specific error, and that starts with why the detach fails down in cinder.volume.targets.lio, translate that to a specific error, raise that up and eventually get that information out in the cinderclient to raise a more specific error to nova.\n\nBut as Jay says, maybe nova should just handle the 500 from cinder and continue.", 
            "date_created": "2015-05-07 20:27:59.406970+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Cinder patch for logging the ProcessExecutionError when this fails:\n\nhttps://review.openstack.org/#/c/181157/", 
            "date_created": "2015-05-07 21:36:25.920420+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/181454", 
            "date_created": "2015-05-08 16:36:17.974000+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/181454\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=e6d700b0d26c3ede357331add58f2037cb565a0f\nSubmitter: Jenkins\nBranch:    master\n\ncommit e6d700b0d26c3ede357331add58f2037cb565a0f\nAuthor: jichenjc <email address hidden>\nDate:   Wed May 6 19:57:29 2015 +0800\n\n    Ignore Cinder error when shutdown instance\n    \n    Ignore cinder errors when doing shutdown, thus we will continue\n    the cleanup even if some exceptions there, so we won't get\n    a couple of instance which can't be deleted\n    \n    Change-Id: I3c7202524857e2205b2442bbbcce9468cb2172c3\n    Closes-Bug: 1450658\n", 
            "date_created": "2015-07-30 00:02:58.878478+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/256239", 
            "date_created": "2015-12-11 06:35:18.475967+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Dave Walker (<email address hidden>) on branch: stable/kilo\nReview: https://review.openstack.org/256239\nReason: \nstable/kilo closed for 2015.1.4\n\nThis release is now pending its final release and no freeze exception has\nbeen seen for this changeset.  Therefore, I am now abandoning this change.\n\nIf this is not correct, please urgently raise a thread on openstack-dev.\n\nMore details at: https://wiki.openstack.org/wiki/StableBranch\n", 
            "date_created": "2016-05-09 09:37:10.367137+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}