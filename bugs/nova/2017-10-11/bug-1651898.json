{
    "status": "Confirmed", 
    "last_updated": "2017-06-27 15:57:18.505993+00:00", 
    "description": "Description\n===========\nWith the move to Castellan, Nova's key manager configuration is no longer backward compatible. Furthermore, looks like it hasn't been tested with grenade gate either. Otherwise, it would've easily break theory #1: New code should work with old configs.\n\nThe old config only have the [keymgr] section, not the [key_manager] section. However, this line of code adds a default key manager in [key_manager] section, which basically ignores the old config.\n\nhttps://github.com/openstack/nova/blob/stable/newton/nova/keymgr/__init__.py#L29\n\nIn other words, the NoSucoOptError would've never raised.\n\nhttps://github.com/openstack/nova/blob/stable/newton/nova/keymgr/__init__.py#L37\n\n\nSteps to reproduce\n==================\n\n1. Install devstack with Barbican plugin enabled. i.e.\n\ncat local.conf\n[[local|localrc]]\nenable_plugin barbican https://git.openstack.org/openstack/barbican stable/newton\n\n2. After devstack is installed, revert back to the old config for key manager and enable ephemeral storage encryption in nova.conf. i.e.\n\n[keymgr]\napi_class = nova.keymgr.barbican.BarbicanKeyManager\n\n[barbican]\nendpoint_template = http://localhost:9311/v1\nos_region_name = RegionOne\n\n[libvirt]\nimages_type = lvm\nimages_volume_group = vg-comp\n\n[ephemeral_storage_encryption]\nkey_size = 256\ncipher = aes-xts-plain64\nenabled = True\n\n3. try to restart nova-api and it will fail with a traceback that look similar to this\n\n2016-12-21 14:54:05.406 CRITICAL nova [req-04e1b733-5b50-41ae-aa98-1a6b4f550cd7 None None] ValueError: keymgr.fixed_key not defined\n\n2016-12-21 14:54:05.406 TRACE nova Traceback (most recent call last):\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/bin/nova-api\", line 10, in <module>\n2016-12-21 14:54:05.406 TRACE nova     sys.exit(main())\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/cmd/api.py\", line 60, in main\n2016-12-21 14:54:05.406 TRACE nova     server = service.WSGIService(api, use_ssl=should_use_ssl)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/service.py\", line 288, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.app = self.loader.load_app(name)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/wsgi.py\", line 497, in load_app\n2016-12-21 14:54:05.406 TRACE nova     return deploy.loadapp(\"config:%s\" % self.config_path, name=name)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 247, in loadapp\n2016-12-21 14:54:05.406 TRACE nova     return loadobj(APP, uri, name=name, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 272, in loadobj\n2016-12-21 14:54:05.406 TRACE nova     return context.create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 144, in invoke\n2016-12-21 14:54:05.406 TRACE nova     **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/urlmap.py\", line 160, in urlmap_factory\n2016-12-21 14:54:05.406 TRACE nova     app = loader.get_app(app_name, global_conf=global_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 350, in get_app\n2016-12-21 14:54:05.406 TRACE nova     name=name, global_conf=global_conf).create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 144, in invoke\n2016-12-21 14:54:05.406 TRACE nova     **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/auth.py\", line 58, in pipeline_factory_v21\n2016-12-21 14:54:05.406 TRACE nova     return _load_pipeline(loader, local_conf[CONF.auth_strategy].split())\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/auth.py\", line 39, in _load_pipeline\n2016-12-21 14:54:05.406 TRACE nova     app = loader.get_app(pipeline[-1])\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 350, in get_app\n2016-12-21 14:54:05.406 TRACE nova     name=name, global_conf=global_conf).create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 146, in invoke\n2016-12-21 14:54:05.406 TRACE nova     return fix_call(context.object, context.global_conf, **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 219, in factory\n2016-12-21 14:54:05.406 TRACE nova     return cls()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/__init__.py\", line 35, in __init__\n2016-12-21 14:54:05.406 TRACE nova     super(APIRouterV21, self).__init__(init_only)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 244, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self._register_resources_check_inherits(mapper)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 260, in _register_resources_check_inherits\n2016-12-21 14:54:05.406 TRACE nova     for resource in ext.obj.get_resources():\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/remote_consoles.py\", line 207, in get_resources\n2016-12-21 14:54:05.406 TRACE nova     'remote-consoles', RemoteConsolesController(), parent=parent,\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/remote_consoles.py\", line 32, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.compute_api = compute.API()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/compute/__init__.py\", line 39, in API\n2016-12-21 14:54:05.406 TRACE nova     return importutils.import_object(class_name, *args, **kwargs)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/importutils.py\", line 44, in import_object\n2016-12-21 14:54:05.406 TRACE nova     return import_class(import_str)(*args, **kwargs)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/compute/api.py\", line 211, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.key_manager = keymgr.API()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/keymgr/__init__.py\", line 75, in API\n2016-12-21 14:54:05.406 TRACE nova     return cls(conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/keymgr/conf_key_mgr.py\", line 67, in __init__\n2016-12-21 14:54:05.406 TRACE nova     raise ValueError(_('keymgr.fixed_key not defined'))\n2016-12-21 14:54:05.406 TRACE nova ValueError: keymgr.fixed_key not defined\n\n\n\nExpected result\n===============\nserver should start correctly with an old config\n\nActual result\n=============\nserver failed to start with the following traceback\n\n2016-12-21 14:54:05.406 CRITICAL nova [req-04e1b733-5b50-41ae-aa98-1a6b4f550cd7 None None] ValueError: keymgr.fixed_key not defined\n\n2016-12-21 14:54:05.406 TRACE nova Traceback (most recent call last):\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/bin/nova-api\", line 10, in <module>\n2016-12-21 14:54:05.406 TRACE nova     sys.exit(main())\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/cmd/api.py\", line 60, in main\n2016-12-21 14:54:05.406 TRACE nova     server = service.WSGIService(api, use_ssl=should_use_ssl)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/service.py\", line 288, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.app = self.loader.load_app(name)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/wsgi.py\", line 497, in load_app\n2016-12-21 14:54:05.406 TRACE nova     return deploy.loadapp(\"config:%s\" % self.config_path, name=name)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 247, in loadapp\n2016-12-21 14:54:05.406 TRACE nova     return loadobj(APP, uri, name=name, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 272, in loadobj\n2016-12-21 14:54:05.406 TRACE nova     return context.create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 144, in invoke\n2016-12-21 14:54:05.406 TRACE nova     **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/urlmap.py\", line 160, in urlmap_factory\n2016-12-21 14:54:05.406 TRACE nova     app = loader.get_app(app_name, global_conf=global_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 350, in get_app\n2016-12-21 14:54:05.406 TRACE nova     name=name, global_conf=global_conf).create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 144, in invoke\n2016-12-21 14:54:05.406 TRACE nova     **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/auth.py\", line 58, in pipeline_factory_v21\n2016-12-21 14:54:05.406 TRACE nova     return _load_pipeline(loader, local_conf[CONF.auth_strategy].split())\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/auth.py\", line 39, in _load_pipeline\n2016-12-21 14:54:05.406 TRACE nova     app = loader.get_app(pipeline[-1])\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 350, in get_app\n2016-12-21 14:54:05.406 TRACE nova     name=name, global_conf=global_conf).create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 146, in invoke\n2016-12-21 14:54:05.406 TRACE nova     return fix_call(context.object, context.global_conf, **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 219, in factory\n2016-12-21 14:54:05.406 TRACE nova     return cls()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/__init__.py\", line 35, in __init__\n2016-12-21 14:54:05.406 TRACE nova     super(APIRouterV21, self).__init__(init_only)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 244, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self._register_resources_check_inherits(mapper)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 260, in _register_resources_check_inherits\n2016-12-21 14:54:05.406 TRACE nova     for resource in ext.obj.get_resources():\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/remote_consoles.py\", line 207, in get_resources\n2016-12-21 14:54:05.406 TRACE nova     'remote-consoles', RemoteConsolesController(), parent=parent,\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/remote_consoles.py\", line 32, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.compute_api = compute.API()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/compute/__init__.py\", line 39, in API\n2016-12-21 14:54:05.406 TRACE nova     return importutils.import_object(class_name, *args, **kwargs)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/importutils.py\", line 44, in import_object\n2016-12-21 14:54:05.406 TRACE nova     return import_class(import_str)(*args, **kwargs)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/compute/api.py\", line 211, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.key_manager = keymgr.API()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/keymgr/__init__.py\", line 75, in API\n2016-12-21 14:54:05.406 TRACE nova     return cls(conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/keymgr/conf_key_mgr.py\", line 67, in __init__\n2016-12-21 14:54:05.406 TRACE nova     raise ValueError(_('keymgr.fixed_key not defined'))\n2016-12-21 14:54:05.406 TRACE nova ValueError: keymgr.fixed_key not defined\n\n\nEnvironment\n===========\n1. Ubuntu 16.04\n\ncat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=16.04\nDISTRIB_CODENAME=xenial\nDISTRIB_DESCRIPTION=\"Ubuntu 16.04.1 LTS\"\n\n2. Devstack + Barbican plugin, both on stable/newton", 
    "tags": [
        "openstack-version.newton"
    ], 
    "importance": "High", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1651898", 
    "owner": "None", 
    "id": 1651898, 
    "index": 2015, 
    "created": "2016-12-21 23:08:16.453730+00:00", 
    "title": "Key manager configuration for ephemeral storage encryption is not backward compatible", 
    "comments": [
        {
            "content": "Description\n===========\nWith the move to Castellan, Nova's key manager configuration is no longer backward compatible. Furthermore, looks like it hasn't been tested with grenade gate either. Otherwise, it would've easily break theory #1: New code should work with old configs.\n\nThe old config only have the [keymgr] section, not the [key_manager] section. However, this line of code adds a default key manager in [key_manager] section, which basically ignores the old config.\n\nhttps://github.com/openstack/nova/blob/stable/newton/nova/keymgr/__init__.py#L29\n\nIn other words, the NoSucoOptError would've never raised.\n\nhttps://github.com/openstack/nova/blob/stable/newton/nova/keymgr/__init__.py#L37\n\n\nSteps to reproduce\n==================\n\n1. Install devstack with Barbican plugin enabled. i.e.\n\ncat local.conf\n[[local|localrc]]\nenable_plugin barbican https://git.openstack.org/openstack/barbican stable/newton\n\n2. After devstack is installed, revert back to the old config for key manager and enable ephemeral storage encryption in nova.conf. i.e.\n\n[keymgr]\napi_class = nova.keymgr.barbican.BarbicanKeyManager\n\n[barbican]\nendpoint_template = http://localhost:9311/v1\nos_region_name = RegionOne\n\n[libvirt]\nimages_type = lvm\nimages_volume_group = vg-comp\n\n[ephemeral_storage_encryption]\nkey_size = 256\ncipher = aes-xts-plain64\nenabled = True\n\n3. try to restart nova-api and it will fail with a traceback that look similar to this\n\n2016-12-21 14:54:05.406 CRITICAL nova [req-04e1b733-5b50-41ae-aa98-1a6b4f550cd7 None None] ValueError: keymgr.fixed_key not defined\n\n2016-12-21 14:54:05.406 TRACE nova Traceback (most recent call last):\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/bin/nova-api\", line 10, in <module>\n2016-12-21 14:54:05.406 TRACE nova     sys.exit(main())\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/cmd/api.py\", line 60, in main\n2016-12-21 14:54:05.406 TRACE nova     server = service.WSGIService(api, use_ssl=should_use_ssl)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/service.py\", line 288, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.app = self.loader.load_app(name)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/wsgi.py\", line 497, in load_app\n2016-12-21 14:54:05.406 TRACE nova     return deploy.loadapp(\"config:%s\" % self.config_path, name=name)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 247, in loadapp\n2016-12-21 14:54:05.406 TRACE nova     return loadobj(APP, uri, name=name, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 272, in loadobj\n2016-12-21 14:54:05.406 TRACE nova     return context.create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 144, in invoke\n2016-12-21 14:54:05.406 TRACE nova     **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/urlmap.py\", line 160, in urlmap_factory\n2016-12-21 14:54:05.406 TRACE nova     app = loader.get_app(app_name, global_conf=global_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 350, in get_app\n2016-12-21 14:54:05.406 TRACE nova     name=name, global_conf=global_conf).create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 144, in invoke\n2016-12-21 14:54:05.406 TRACE nova     **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/auth.py\", line 58, in pipeline_factory_v21\n2016-12-21 14:54:05.406 TRACE nova     return _load_pipeline(loader, local_conf[CONF.auth_strategy].split())\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/auth.py\", line 39, in _load_pipeline\n2016-12-21 14:54:05.406 TRACE nova     app = loader.get_app(pipeline[-1])\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 350, in get_app\n2016-12-21 14:54:05.406 TRACE nova     name=name, global_conf=global_conf).create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 146, in invoke\n2016-12-21 14:54:05.406 TRACE nova     return fix_call(context.object, context.global_conf, **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 219, in factory\n2016-12-21 14:54:05.406 TRACE nova     return cls()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/__init__.py\", line 35, in __init__\n2016-12-21 14:54:05.406 TRACE nova     super(APIRouterV21, self).__init__(init_only)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 244, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self._register_resources_check_inherits(mapper)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 260, in _register_resources_check_inherits\n2016-12-21 14:54:05.406 TRACE nova     for resource in ext.obj.get_resources():\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/remote_consoles.py\", line 207, in get_resources\n2016-12-21 14:54:05.406 TRACE nova     'remote-consoles', RemoteConsolesController(), parent=parent,\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/remote_consoles.py\", line 32, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.compute_api = compute.API()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/compute/__init__.py\", line 39, in API\n2016-12-21 14:54:05.406 TRACE nova     return importutils.import_object(class_name, *args, **kwargs)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/importutils.py\", line 44, in import_object\n2016-12-21 14:54:05.406 TRACE nova     return import_class(import_str)(*args, **kwargs)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/compute/api.py\", line 211, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.key_manager = keymgr.API()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/keymgr/__init__.py\", line 75, in API\n2016-12-21 14:54:05.406 TRACE nova     return cls(conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/keymgr/conf_key_mgr.py\", line 67, in __init__\n2016-12-21 14:54:05.406 TRACE nova     raise ValueError(_('keymgr.fixed_key not defined'))\n2016-12-21 14:54:05.406 TRACE nova ValueError: keymgr.fixed_key not defined\n\n\n\nExpected result\n===============\nserver should start correctly with an old config\n\nActual result\n=============\nserver failed to start with the following traceback\n\n2016-12-21 14:54:05.406 CRITICAL nova [req-04e1b733-5b50-41ae-aa98-1a6b4f550cd7 None None] ValueError: keymgr.fixed_key not defined\n\n2016-12-21 14:54:05.406 TRACE nova Traceback (most recent call last):\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/bin/nova-api\", line 10, in <module>\n2016-12-21 14:54:05.406 TRACE nova     sys.exit(main())\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/cmd/api.py\", line 60, in main\n2016-12-21 14:54:05.406 TRACE nova     server = service.WSGIService(api, use_ssl=should_use_ssl)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/service.py\", line 288, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.app = self.loader.load_app(name)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/wsgi.py\", line 497, in load_app\n2016-12-21 14:54:05.406 TRACE nova     return deploy.loadapp(\"config:%s\" % self.config_path, name=name)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 247, in loadapp\n2016-12-21 14:54:05.406 TRACE nova     return loadobj(APP, uri, name=name, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 272, in loadobj\n2016-12-21 14:54:05.406 TRACE nova     return context.create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 144, in invoke\n2016-12-21 14:54:05.406 TRACE nova     **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/urlmap.py\", line 160, in urlmap_factory\n2016-12-21 14:54:05.406 TRACE nova     app = loader.get_app(app_name, global_conf=global_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 350, in get_app\n2016-12-21 14:54:05.406 TRACE nova     name=name, global_conf=global_conf).create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 144, in invoke\n2016-12-21 14:54:05.406 TRACE nova     **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/auth.py\", line 58, in pipeline_factory_v21\n2016-12-21 14:54:05.406 TRACE nova     return _load_pipeline(loader, local_conf[CONF.auth_strategy].split())\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/auth.py\", line 39, in _load_pipeline\n2016-12-21 14:54:05.406 TRACE nova     app = loader.get_app(pipeline[-1])\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 350, in get_app\n2016-12-21 14:54:05.406 TRACE nova     name=name, global_conf=global_conf).create()\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 710, in create\n2016-12-21 14:54:05.406 TRACE nova     return self.object_type.invoke(self)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/loadwsgi.py\", line 146, in invoke\n2016-12-21 14:54:05.406 TRACE nova     return fix_call(context.object, context.global_conf, **context.local_conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/paste/deploy/util.py\", line 55, in fix_call\n2016-12-21 14:54:05.406 TRACE nova     val = callable(*args, **kw)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 219, in factory\n2016-12-21 14:54:05.406 TRACE nova     return cls()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/__init__.py\", line 35, in __init__\n2016-12-21 14:54:05.406 TRACE nova     super(APIRouterV21, self).__init__(init_only)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 244, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self._register_resources_check_inherits(mapper)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/__init__.py\", line 260, in _register_resources_check_inherits\n2016-12-21 14:54:05.406 TRACE nova     for resource in ext.obj.get_resources():\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/remote_consoles.py\", line 207, in get_resources\n2016-12-21 14:54:05.406 TRACE nova     'remote-consoles', RemoteConsolesController(), parent=parent,\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/api/openstack/compute/remote_consoles.py\", line 32, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.compute_api = compute.API()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/compute/__init__.py\", line 39, in API\n2016-12-21 14:54:05.406 TRACE nova     return importutils.import_object(class_name, *args, **kwargs)\n2016-12-21 14:54:05.406 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/importutils.py\", line 44, in import_object\n2016-12-21 14:54:05.406 TRACE nova     return import_class(import_str)(*args, **kwargs)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/compute/api.py\", line 211, in __init__\n2016-12-21 14:54:05.406 TRACE nova     self.key_manager = keymgr.API()\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/keymgr/__init__.py\", line 75, in API\n2016-12-21 14:54:05.406 TRACE nova     return cls(conf)\n2016-12-21 14:54:05.406 TRACE nova   File \"/opt/stack/nova/nova/keymgr/conf_key_mgr.py\", line 67, in __init__\n2016-12-21 14:54:05.406 TRACE nova     raise ValueError(_('keymgr.fixed_key not defined'))\n2016-12-21 14:54:05.406 TRACE nova ValueError: keymgr.fixed_key not defined\n\n\nEnvironment\n===========\n1. Ubuntu 16.04\n\ncat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=16.04\nDISTRIB_CODENAME=xenial\nDISTRIB_DESCRIPTION=\"Ubuntu 16.04.1 LTS\"\n\n2. Devstack + Barbican plugin, both on stable/newton", 
            "date_created": "2016-12-21 23:08:16.453730+00:00", 
            "author": "https://api.launchpad.net/1.0/~guang-yee"
        }, 
        {
            "content": "I guess 'cfg.NoSuchOptError' will raise when the [key_manager] section is not found in nova conf, then we will fallback to old version. I really don't know why the author set this default value:\n\n\n# NOTE(kfarr): This line can be removed when a value is assigned in DevStack\nCONF.set_default('api_class', 'nova.keymgr.conf_key_mgr.ConfKeyManager',\n                 group='key_manager')\n\nI'm not sure if this is a bug, just waiting for other confirm.", 
            "date_created": "2016-12-22 17:16:28.828435+00:00", 
            "author": "https://api.launchpad.net/1.0/~int32bit"
        }, 
        {
            "content": "That set_default value is because nova's keymgr default value is ConfKeyManager, but Castellan's is BarbicanKeyManager.  I was aiming for backwards compatibility.  This set_default value covers the case where the user left [keymgr] api_class blank and set a fixed_key, which was the old behavior.  But you're right, it doesn't handle the case where the user set [keymgr] api_class to be barbican.", 
            "date_created": "2017-03-09 15:57:04.493641+00:00", 
            "author": "https://api.launchpad.net/1.0/~kaitlin-farr"
        }, 
        {
            "content": "Are we so far past this break that we don't care any more? Or is this something we should be fixing?", 
            "date_created": "2017-04-17 12:52:00.253440+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Automatically discovered version newton in description. If this is incorrect, please update the description to include 'nova version: ...'", 
            "date_created": "2017-06-27 15:57:17.957866+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}