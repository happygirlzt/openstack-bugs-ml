{
    "status": "Fix Released", 
    "last_updated": "2017-06-16 17:41:26.133330+00:00", 
    "description": "Just the not deleted members needs to be selected, an instance group can gather many-many deleted instances during on his lifetime.\n\nThe selecting query contains a condition for omitting the deleted records:\n\nSELECT instance_groups.created_at AS instance_groups_created_at, instance_groups.updated_at AS instance_groups_updated_at, instance_groups.deleted_at AS instance_groups_deleted_at, instance_groups.deleted AS instance_groups_deleted, instance_groups.id AS instance_groups_id, instance_groups.user_id AS instance_groups_user_id, instance_groups.project_id AS instance_groups_project_id, instance_groups.uuid AS instance_groups_uuid, instance_groups.name AS instance_groups_name, instance_group_policy_1.created_at AS instance_group_policy_1_created_at, instance_group_policy_1.updated_at AS instance_group_policy_1_updated_at, instance_group_policy_1.deleted_at AS instance_group_policy_1_deleted_at, instance_group_policy_1.deleted AS instance_group_policy_1_deleted, instance_group_policy_1.id AS instance_group_policy_1_id, instance_group_policy_1.policy AS instance_group_policy_1_policy, instance_group_policy_1.group_id AS instance_group_policy_1_group_id, instance_group_member_1.created_at AS instance_group_member_1_created_at, instance_group_member_1.updated_at AS instance_group_member_1_updated_at, instance_group_member_1.deleted_at AS instance_group_member_1_deleted_at, instance_group_member_1.deleted AS instance_group_member_1_deleted, instance_group_member_1.id AS instance_group_member_1_id, instance_group_member_1.instance_id AS instance_group_member_1_instance_id, instance_group_member_1.group_id AS instance_group_member_1_group_id  FROM instance_groups LEFT OUTER JOIN instance_group_policy AS instance_group_policy_1 ON instance_groups.id = instance_group_policy_1.group_id AND instance_group_policy_1.deleted = 0 AND instance_groups.deleted = 0 LEFT OUTER JOIN instance_group_member AS instance_group_member_1 ON instance_groups.id = instance_group_member_1.group_id AND instance_group_member_1.deleted = 0 AND instance_groups.deleted = 0  WHERE instance_groups.deleted = 0 AND instance_groups.project_id = '6da55626d6a04f4c99980dc17d34235f';\n\n(Captured at $nova server-group-list)\n\nBut actually nova fetches the deleted records because the `deleted` field is 0,\neven if the instance already deleted.\n\nFor figuring out the instance  is actually deleted the nova API issues other otherwise  not needed queries.\n\nThe instance_group_member records actually set to deleted only when instance_group deleted.\n\nshow create table instance_group_member;\n\nCREATE TABLE `instance_group_member` (\n  `created_at` datetime DEFAULT NULL,\n  `updated_at` datetime DEFAULT NULL,\n  `deleted_at` datetime DEFAULT NULL,\n  `deleted` int(11) DEFAULT NULL,\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `instance_id` varchar(255) DEFAULT NULL,\n  `group_id` int(11) NOT NULL,\n  PRIMARY KEY (`id`),\n  KEY `group_id` (`group_id`),\n  KEY `instance_group_member_instance_idx` (`instance_id`),\n  CONSTRAINT `instance_group_member_ibfk_1` FOREIGN KEY (`group_id`) REFERENCES `instance_groups` (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8\n\n1, Please  delete the instance_group_member  records when the instance gets deleted.\n2, Please add (`deleted`,`group_id`) BTREE index  as combined index, in this way it will be  usable in other situations as well, for example  when only a single group's members is needed.", 
    "tags": [
        "db", 
        "server-groups"
    ], 
    "importance": "High", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1442098", 
    "owner": "https://api.launchpad.net/1.0/~hanrong", 
    "id": 1442098, 
    "index": 1720, 
    "created": "2015-04-09 11:15:59.370453+00:00", 
    "title": "instance_group_member entries not deleted when the instance deleted", 
    "comments": [
        {
            "content": "Just the not deleted members needs to be selected, an instance group can gather many-many deleted instances during on his lifetime.\n\nThe selecting query contains a condition for omitting the deleted records:\n\nSELECT instance_groups.created_at AS instance_groups_created_at, instance_groups.updated_at AS instance_groups_updated_at, instance_groups.deleted_at AS instance_groups_deleted_at, instance_groups.deleted AS instance_groups_deleted, instance_groups.id AS instance_groups_id, instance_groups.user_id AS instance_groups_user_id, instance_groups.project_id AS instance_groups_project_id, instance_groups.uuid AS instance_groups_uuid, instance_groups.name AS instance_groups_name, instance_group_policy_1.created_at AS instance_group_policy_1_created_at, instance_group_policy_1.updated_at AS instance_group_policy_1_updated_at, instance_group_policy_1.deleted_at AS instance_group_policy_1_deleted_at, instance_group_policy_1.deleted AS instance_group_policy_1_deleted, instance_group_policy_1.id AS instance_group_policy_1_id, instance_group_policy_1.policy AS instance_group_policy_1_policy, instance_group_policy_1.group_id AS instance_group_policy_1_group_id, instance_group_member_1.created_at AS instance_group_member_1_created_at, instance_group_member_1.updated_at AS instance_group_member_1_updated_at, instance_group_member_1.deleted_at AS instance_group_member_1_deleted_at, instance_group_member_1.deleted AS instance_group_member_1_deleted, instance_group_member_1.id AS instance_group_member_1_id, instance_group_member_1.instance_id AS instance_group_member_1_instance_id, instance_group_member_1.group_id AS instance_group_member_1_group_id  FROM instance_groups LEFT OUTER JOIN instance_group_policy AS instance_group_policy_1 ON instance_groups.id = instance_group_policy_1.group_id AND instance_group_policy_1.deleted = 0 AND instance_groups.deleted = 0 LEFT OUTER JOIN instance_group_member AS instance_group_member_1 ON instance_groups.id = instance_group_member_1.group_id AND instance_group_member_1.deleted = 0 AND instance_groups.deleted = 0  WHERE instance_groups.deleted = 0 AND instance_groups.project_id = '6da55626d6a04f4c99980dc17d34235f';\n\n(Captured at $nova server-group-list)\n\nBut actually nova fetches the deleted records because the `deleted` field is 0,\neven if the instance already deleted.\n\nFor figuring out the instance  is actually deleted the nova API issues other otherwise  not needed queries.\n\nThe instance_group_member records actually set to deleted only when instance_group deleted.\n\nshow create table instance_group_member;\n\nCREATE TABLE `instance_group_member` (\n  `created_at` datetime DEFAULT NULL,\n  `updated_at` datetime DEFAULT NULL,\n  `deleted_at` datetime DEFAULT NULL,\n  `deleted` int(11) DEFAULT NULL,\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `instance_id` varchar(255) DEFAULT NULL,\n  `group_id` int(11) NOT NULL,\n  PRIMARY KEY (`id`),\n  KEY `group_id` (`group_id`),\n  KEY `instance_group_member_instance_idx` (`instance_id`),\n  CONSTRAINT `instance_group_member_ibfk_1` FOREIGN KEY (`group_id`) REFERENCES `instance_groups` (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8\n\n1, Please  delete the instance_group_member  records when the instance gets deleted.\n2, Please add (`deleted`,`group_id`) BTREE index  as combined index, in this way it will be  usable in other situations as well, for example  when only a single group's members is needed.", 
            "date_created": "2015-04-09 11:15:59.370453+00:00", 
            "author": "https://api.launchpad.net/1.0/~afazekas"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/173664", 
            "date_created": "2015-04-15 03:18:06.614312+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Alex Xu (<email address hidden>) on branch: master\nReview: https://review.openstack.org/173664\nReason: I didn't have time working on this, abandon it, leave other people free to pick it.", 
            "date_created": "2015-10-15 05:04:01.250995+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The bug  is reproduced.\n\nIt's correct for using RESTFUL API.\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n| Id                                   | Name              | Policies           | Members                                                                            | Metadata |\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n| 211a62d0-de78-4311-8250-c014fed46f0e | antiaffinitygroup | [u'anti-affinity'] | [u'5c37820b-d9e5-49b6-ad3c-9845f1667224', u'd1da3837-a5c5-45a4-8b2b-bc53559fcc8e'] | {}       |\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n[tecs@tecs nova(keystone_admin)]$ \n[tecs@tecs nova(keystone_admin)]$ \n[tecs@tecs nova(keystone_admin)]$ \n[tecs@tecs nova(keystone_admin)]$ nova list\n+--------------------------------------+-------+--------+------------+-------------+----------+\n| ID                                   | Name  | Status | Task State | Power State | Networks |\n+--------------------------------------+-------+--------+------------+-------------+----------+\n| 7c32f761-3f49-46b5-86c6-1cbfe8a4e0d5 | test  | ERROR  | -          | NOSTATE     |          |\n| 1964dae7-89bb-45d4-af90-ddba48c135a7 | test2 | ERROR  | -          | NOSTATE     |          |\n| 5c37820b-d9e5-49b6-ad3c-9845f1667224 | test2 | ERROR  | -          | NOSTATE     |          |\n| d1da3837-a5c5-45a4-8b2b-bc53559fcc8e | test2 | ERROR  | -          | NOSTATE     |          |\n+--------------------------------------+-------+--------+------------+-------------+----------+\n[tecs@tecs nova(keystone_admin)]$ \n[tecs@tecs nova(keystone_admin)]$ \n[tecs@tecs nova(keystone_admin)]$ \n[tecs@tecs nova(keystone_admin)]$ nova delete 7c32f761-3f49-46b5-86c6-1cbfe8a4e0d5\nRequest to delete server 7c32f761-3f49-46b5-86c6-1cbfe8a4e0d5 has been accepted.\n[tecs@tecs nova(keystone_admin)]$ nova delete 1964dae7-89bb-45d4-af90-ddba48c135a7\nRequest to delete server 1964dae7-89bb-45d4-af90-ddba48c135a7 has been accepted.\n[tecs@tecs nova(keystone_admin)]$ \n[tecs@tecs nova(keystone_admin)]$ \n[tecs@tecs nova(keystone_admin)]$ nova list\n+--------------------------------------+-------+--------+------------+-------------+----------+\n| ID                                   | Name  | Status | Task State | Power State | Networks |\n+--------------------------------------+-------+--------+------------+-------------+----------+\n| 5c37820b-d9e5-49b6-ad3c-9845f1667224 | test2 | ERROR  | -          | NOSTATE     |          |\n| d1da3837-a5c5-45a4-8b2b-bc53559fcc8e | test2 | ERROR  | -          | NOSTATE     |          |\n+--------------------------------------+-------+--------+------------+-------------+----------+\n[tecs@tecs nova(keystone_admin)]$ \n[tecs@tecs nova(keystone_admin)]$ \n[tecs@tecs nova(keystone_admin)]$ nova server-group-list\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n| Id                                   | Name              | Policies           | Members                                                                            | Metadata |\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n| 211a62d0-de78-4311-8250-c014fed46f0e | antiaffinitygroup | [u'anti-affinity'] | [u'5c37820b-d9e5-49b6-ad3c-9845f1667224', u'd1da3837-a5c5-45a4-8b2b-bc53559fcc8e'] | {}       |\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n\nBut  the instance is not deleted in ins--------------+--------------------------------------+----------------------------------+\n| instance_groups_created_at | instance_groups_updated_at | instance_groups_deleted_at | instance_groups_deleted | instance_groups_id | instance_groups_user_id          | instance_groups_project_id       | instance_groups_uuid                 | instance_groups_name | instance_group_policy_1_created_at | instance_group_policy_1_updated_at | instance_group_policy_1_deleted_at | instance_group_policy_1_deleted | instance_group_policy_1_id | instance_group_policy_1_policy | instance_group_policy_1_group_id | instance_group_member_1_created_at | instance_group_member_1_updated_at | instance_group_member_1_deleted_at | instance_group_member_1_deleted | instance_group_member_1_id | instance_group_member_1_instance_id  | instance_group_member_1_group_id |\n+----------------------------+----------------------------+----------------------------+-------------------------+--------------------+----------------------------------+----------------------------------+--------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+---------------------------------+----------------------------+--------------------------------+----------------------------------+------------------------------------+------------------------------------+------------------------------------+---------------------------------+----------------------------+--------------------------------------+----------------------------------+\n| 2016-03-07 03:59:48        | NULL                       | NULL                       |                       0 |                  1 | 9dea1e0c8b36490f976d4164f5b1d4d2 | 83db410d8acb493eb460c06944e5d030 | 211a62d0-de78-4311-8250-c014fed46f0e | antiaffinitygroup    | 2016-03-07 03:59:48                | NULL                               | NULL                               |                               0 |                          1 | anti-affinity                  |                                1 | 2016-03-07 06:10:59                | NULL                               | NULL                               |                               0 |                          1 | 7c32f761-3f49-46b5-86c6-1cbfe8a4e0d5 |                                1 |\n| 2016-03-07 03:59:48        | NULL                       | NULL                       |                       0 |                  1 | 9dea1e0c8b36490f976d4164f5b1d4d2 | 83db410d8acb493eb460c06944e5d030 | 211a62d0-de78-4311-8250-c014fed46f0e | antiaffinitygroup    | 2016-03-07 03:59:48                | NULL                               | NULL                               |                               0 |                          1 | anti-affinity                  |                                1 | 2016-03-07 06:11:38                | NULL                               | NULL                               |                               0 |                          2 | 1964dae7-89bb-45d4-af90-ddba48c135a7 |                                1 |\n| 2016-03-07 03:59:48        | NULL                       | NULL                       |                       0 |                  1 | 9dea1e0c8b36490f976d4164f5b1d4d2 | 83db410d8acb493eb460c06944e5d030 | 211a62d0-de78-4311-8250-c014fed46f0e | antiaffinitygroup    | 2016-03-07 03:59:48                | NULL                               | NULL                               |                               0 |                          1 | anti-affinity                  |                                1 | 2016-03-07 06:20:02                | NULL                               | NULL                               |                               0 |                          3 | d1da3837-a5c5-45a4-8b2b-bc53559fcc8e |                                1 |\n| 2016-03-07 03:59:48        | NULL                       | NULL                       |                       0 |                  1 | 9dea1e0c8b36490f976d4164f5b1d4d2 | 83db410d8acb493eb460c06944e5d030 | 211a62d0-de78-4311-8250-c014fed46f0e | antiaffinitygroup    | 2016-03-07 03:59:48                | NULL                               | NULL                               |                               0 |                          1 | anti-affinity                  |                                1 | 2016-03-07 06:20:17                | NULL                               | NULL                               |                               0 |                          4 | 5c37820b-d9e5-49b6-ad3c-9845f1667224 |                                1 |\n+----------------------------+----------------------------+----------------------------+-------------------------+--------------------+----------------------------------+----------------------------------+--------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+---------------------------------+----------------------------+--------------------------------+----------------------------------+------------------------------------+------------------------------------+------------------------------------+---------------------------------+----------------------------+--------------------------------------+----------------------------------+\n4 rows in set (0.00 sec)\n\nmysql> tance_group_member table.\n\n", 
            "date_created": "2016-03-07 06:44:15.173308+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/289392", 
            "date_created": "2016-03-07 15:23:25.837441+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/289392\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=e2f4370b04598833939f2b869e7bac11c02a4921\nSubmitter: Jenkins\nBranch:    master\n\ncommit e2f4370b04598833939f2b869e7bac11c02a4921\nAuthor: zte-hanrong <email address hidden>\nDate:   Mon Mar 7 23:21:32 2016 +0800\n\n    Soft delete instance group member when delete instance\n    \n    Currently after instance deleted, the instance is still as member\n    of instance group. This patch make sure the instance will removed\n    from instance group when execute instance_destroy db call.\n    \n    Closes-Bug: #1442098\n    \n    Change-Id: I8cae3e5c317f0797944ecf3bea21c571ff24d9cf\n", 
            "date_created": "2016-04-05 03:31:43.736032+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/mitaka\nReview: https://review.openstack.org/308490", 
            "date_created": "2016-04-20 17:33:16.769017+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/308490\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ef1c5dbcf3451c081356b45633220ad3969d5b70\nSubmitter: Jenkins\nBranch:    stable/mitaka\n\ncommit ef1c5dbcf3451c081356b45633220ad3969d5b70\nAuthor: zte-hanrong <email address hidden>\nDate:   Mon Mar 7 23:21:32 2016 +0800\n\n    Soft delete instance group member when delete instance\n    \n    Currently after instance deleted, the instance is still as member\n    of instance group. This patch make sure the instance will removed\n    from instance group when execute instance_destroy db call.\n    \n    Closes-Bug: #1442098\n    \n    Change-Id: I8cae3e5c317f0797944ecf3bea21c571ff24d9cf\n    (cherry picked from commit e2f4370b04598833939f2b869e7bac11c02a4921)\n", 
            "date_created": "2016-05-04 01:23:31.545912+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b1 development milestone.", 
            "date_created": "2016-06-02 19:35:32.599888+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.1.0 release.", 
            "date_created": "2016-06-14 15:42:06.392732+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }
    ]
}