{
    "status": "Fix Released", 
    "last_updated": "2016-07-04 08:22:07.784919+00:00", 
    "description": "here, two scenes may cause that a volume leaves over   when  we delete instance whose task_state is   block_device_mapping .The first scene is that using the boot volume created by image  creates instance; The other scene is that using image create instance  with a volume created  through a image.\n\nThrough analyzing, we find that the volume id is not update to  block_device_mapping table in DB until a volume created by  an image through setting parameters in Blocking Device Mapping v2 is attached to an instance completely.If we delete the instance before the volume id is not update to the block_device_mapping table, the problem mentioned above will occur\n\nTwo examples  to reproduce the problem on latest  icehousce:\n1. the first scene\n(1)root@devstack:~# nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n(2)root@devstack:~# nova boot --flavor m1.tiny --block-device id=61ebee75-5883-49a3-bf85-ad6f6c29fc1b,source=image,dest=volume,device=vda,size=1,shutdown=removed,bootindex=0 --nic net-id=354ba9ac-e6a7-4fd6-a49f-6ae18a815e95 tralon_test\nroot@devstack:~# nova list\n+--------------------------------------+-------------+--------+----------------------+-------------+-------------------+\n| ID                                   | Name        | Status | Task State           | Power State | Networks          |\n+--------------------------------------+-------------+--------+----------------------+-------------+-------------------+\n| 57cbb39d-c93f-44eb-afda-9ce00110950d | tralon_test | BUILD  | block_device_mapping | NOSTATE     | private=10.0.0.20 |\n+--------------------------------------+-------------+--------+----------------------+-------------+-------------------+\n(3)root@devstack:~# nova delete tralon_test\nroot@devstack:~# nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n(4) root@devstack:~# cinder list\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n| 3e5579a9-5aac-42b6-9885-441e861f6cc0 | available | None |  1   |     None    |  false   |                                      |\n| a4121322-529b-4223-ac26-0f569dc7821e | available |      |  1   |     None    |   true   |                                      |\n| a7ad846b-8638-40c1-be42-f2816638a917 |   in-use  |      |  1   |     None    |   true   | 57cbb39d-c93f-44eb-afda-9ce00110950d |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\nwe can see that the instance  57cbb39d-c93f-44eb-afda-9ce00110950d was deleted while the volume still exists with the \"in-use\" status\n\n2. the scend scene\n\u00a0(1)root@devstack:~# nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n\uff082\uff09root@devstack:~# nova boot --flavor m1.tiny --image 61ebee75-5883-49a3-bf85-ad6f6c29fc1b --nic net-id=354ba9ac-e6a7-4fd6-a49f-6ae18a815e95  --block-device id=61ebee75-5883-49a3-bf85-ad6f6c29fc1b,source=image,dest=volume,device=vdb,size=1,shutdown=removed tralon_image_instance\nroot@devstack:~# nova list\n+--------------------------------------+-----------------------+--------+----------------------+-------------+-------------------+\n| ID                                   | Name                  | Status | Task State           | Power State | Networks          |\n+--------------------------------------+-----------------------+--------+----------------------+-------------+-------------------+\n| 25bcfe84-0c3f-40d3-a917-4791e092fa06 | tralon_image_instance | BUILD  | block_device_mapping | NOSTATE     | private=10.0.0.26 |\n+--------------------------------------+-----------------------+--------+----------------------+-------------+-------------------+\n\uff083\uff09root@devstack:~# nova delete 25bcfe84-0c3f-40d3-a917-4791e092fa06\n\u00a0\u00a0( 4 ) root@devstack:~# nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n\u00a0(5) root@devstack:~# cinder list\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n| 3e5579a9-5aac-42b6-9885-441e861f6cc0 | available | None |  1   |     None    |  false   |                                      |\n| a7ad846b-8638-40c1-be42-f2816638a917 |   in-use  |      |  1   |     None    |   true   | 57cbb39d-c93f-44eb-afda-9ce00110950d |\n| f3df0f15-6c9d-4084-8fb5-dc2826bf3eb0 |   in-use  |      |  1   |     None    |   true   | 25bcfe84-0c3f-40d3-a917-4791e092fa06 |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\nso, the instance  25bcfe84-0c3f-40d3-a917-4791e092fa06 was deleted while the volume   f3df0f15-6c9d-4084-8fb5-dc2826bf3eb0 still exists with the \"in-use\" status", 
    "tags": [
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1348509", 
    "owner": "https://api.launchpad.net/1.0/~oss-xzdong", 
    "id": 1348509, 
    "index": 5028, 
    "created": "2014-07-25 07:00:30.424803+00:00", 
    "title": "the volume may leave over when  we delete instance whose task_state is   block_device_mapping", 
    "comments": [
        {
            "content": "here, two scenes may cause that a volume is  legacy   when  we delete instance whose task_state is   block_device_mapping .The first scene is that using the boot volume created by image  creates instance; The other scene is that using image create instance  with a volume created  through a image.\n\n two examples  to reproduce the problem on latest  icehousce:\n1. the first scene\n(1)root@devstack:~# nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n(2)root@devstack:~# nova boot --flavor m1.tiny --block-device id=61ebee75-5883-49a3-bf85-ad6f6c29fc1b,source=image,dest=volume,device=vda,size=1,shutdown=removed,bootindex=0 --nic net-id=354ba9ac-e6a7-4fd6-a49f-6ae18a815e95 tralon_test\nroot@devstack:~# nova list\n+--------------------------------------+-------------+--------+----------------------+-------------+-------------------+\n| ID                                   | Name        | Status | Task State           | Power State | Networks          |\n+--------------------------------------+-------------+--------+----------------------+-------------+-------------------+\n| 57cbb39d-c93f-44eb-afda-9ce00110950d | tralon_test | BUILD  | block_device_mapping | NOSTATE     | private=10.0.0.20 |\n+--------------------------------------+-------------+--------+----------------------+-------------+-------------------+\n(3)root@devstack:~# nova delete tralon_test\nroot@devstack:~# nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n(4) root@devstack:~# cinder list\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n| 3e5579a9-5aac-42b6-9885-441e861f6cc0 | available | None |  1   |     None    |  false   |                                      |\n| a4121322-529b-4223-ac26-0f569dc7821e | available |      |  1   |     None    |   true   |                                      |\n| a7ad846b-8638-40c1-be42-f2816638a917 |   in-use  |      |  1   |     None    |   true   | 57cbb39d-c93f-44eb-afda-9ce00110950d |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\nwe can see that the instance  57cbb39d-c93f-44eb-afda-9ce00110950d was deleted while the volume still exists with the \"in-use\" status\n\n2. the scend scene\n (1)root@devstack:~# nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n\uff082\uff09root@devstack:~# nova boot --flavor m1.tiny --image 61ebee75-5883-49a3-bf85-ad6f6c29fc1b --nic net-id=354ba9ac-e6a7-4fd6-a49f-6ae18a815e95  --block-device id=61ebee75-5883-49a3-bf85-ad6f6c29fc1b,source=image,dest=volume,device=vdb,size=1,shutdown=removed tralon_image_instance\nroot@devstack:~# nova list\n+--------------------------------------+-----------------------+--------+----------------------+-------------+-------------------+\n| ID                                   | Name                  | Status | Task State           | Power State | Networks          |\n+--------------------------------------+-----------------------+--------+----------------------+-------------+-------------------+\n| 25bcfe84-0c3f-40d3-a917-4791e092fa06 | tralon_image_instance | BUILD  | block_device_mapping | NOSTATE     | private=10.0.0.26 |\n+--------------------------------------+-----------------------+--------+----------------------+-------------+-------------------+\n\uff083\uff09root@devstack:~# nova delete 25bcfe84-0c3f-40d3-a917-4791e092fa06\n  ( 4 ) root@devstack:~# nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n (5) root@devstack:~# cinder list\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n| 3e5579a9-5aac-42b6-9885-441e861f6cc0 | available | None |  1   |     None    |  false   |                                      |\n| a7ad846b-8638-40c1-be42-f2816638a917 |   in-use  |      |  1   |     None    |   true   | 57cbb39d-c93f-44eb-afda-9ce00110950d |\n| f3df0f15-6c9d-4084-8fb5-dc2826bf3eb0 |   in-use  |      |  1   |     None    |   true   | 25bcfe84-0c3f-40d3-a917-4791e092fa06 |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\nso, the instance  25bcfe84-0c3f-40d3-a917-4791e092fa06 was deleted while the volume   f3df0f15-6c9d-4084-8fb5-dc2826bf3eb0 still exists with the \"in-use\" status", 
            "date_created": "2014-07-25 07:00:30.424803+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhangchunlong1"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/117937", 
            "date_created": "2014-08-30 07:28:21.527278+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by zhangtralon (<email address hidden>) on branch: master\nReview: https://review.openstack.org/117937\nReason: this bug does'n depend on the headroom infomation is incomplete,I will upload again", 
            "date_created": "2014-08-30 07:32:37.743123+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Sean Dague (<email address hidden>) on branch: master\nReview: https://review.openstack.org/117937\nReason: This review is > 4 weeks without comment, and failed Jenkins the last time it was checked. We are abandoning this for now. Feel free to reactivate the review by pressing the restore button and leaving a 'recheck' comment to get fresh test results.", 
            "date_created": "2014-11-20 15:23:36.175046+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Removing \"In Progress\" status and assignee as change is abandoned.", 
            "date_created": "2015-02-12 16:40:03.851395+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Its been 1 year since this bug was assigned. And no patch was submitted.\n\nMoving it to Unassigned. ", 
            "date_created": "2016-04-18 16:43:43.608026+00:00", 
            "author": "https://api.launchpad.net/1.0/~sujitha-neti"
        }, 
        {
            "content": "This bug can't be reproduced in the latest master branch. This probably is fixed by the resource tracker lock for the instance action. Propose to close this bug.", 
            "date_created": "2016-07-04 08:19:20.038278+00:00", 
            "author": "https://api.launchpad.net/1.0/~oss-xzdong"
        }
    ]
}