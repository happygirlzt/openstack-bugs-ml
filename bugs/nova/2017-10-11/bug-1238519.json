{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 08:53:59.946237+00:00", 
    "description": "The flavor API supports the \"?marker=ID\" option to return the flavor list starting from a specific point.    ID in this case  has to be the DB id value, not the \"flavorid\"   which is an arbitrary string (a uuid be default).\n\nThe api/compute/flavors.py does not catch the MarkerNotFound exception raised by the DB layer when the specified flavor does not exist, resulting in a 404 error and an error in the API logs:\n\n\nNote that the DB ID of flavors is not returned as part of the flavor API, so its hard to see how anyone can really make use of this feature as it stands.  In addition to handling the exception (to avoid an error being logged, and give a better error message to the user)  perhaps the DB query should match on \">=\"  rather than \"==\", given that the user can never knwo what IDs are valid.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1238519", 
    "owner": "https://api.launchpad.net/1.0/~dims-v", 
    "id": 1238519, 
    "index": 3644, 
    "created": "2013-10-11 08:15:41.889609+00:00", 
    "title": "flavor list doesn't handle MarkerNotFound ", 
    "comments": [
        {
            "content": "The flavor API supports the \"?marker=ID\" option to return the flavor list starting from a specific point.    ID in this case  has to be the DB id value, not the \"flavorid\"   which is an arbitrary string (a uuid be default).\n\nThe api/compute/flavors.py does not catch the MarkerNotFound exception raised by the DB layer when the specified flavor does not exist, resulting in a 404 error and an error in the API logs:\n\n\nNote that the DB ID of flavors is not returned as part of the flavor API, so its hard to see how anyone can really make use of this feature as it stands.  In addition to handling the exception (to avoid an error being logged, and give a better error message to the user)  perhaps the DB query should match on \">=\"  rather than \"==\", given that the user can never knwo what IDs are valid.", 
            "date_created": "2013-10-11 08:15:41.889609+00:00", 
            "author": "https://api.launchpad.net/1.0/~philip-day"
        }, 
        {
            "content": "API Log Showing Stack Trace:\n\n2013-10-09 12:22:10.426 34648 DEBUG nova.api.openstack.wsgi [req-062b4763-5651-485c-ab87-48ccc55d0fd6 10171523426685 10329695373991] Calling method <bound method Controller.detail of <nova.api.openstack.compute.flavors.Controller object at 0x4d21f50>> _process_stack /usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py:936\n2013-10-09 12:22:10.435 34648 ERROR nova.exception [req-062b4763-5651-485c-ab87-48ccc55d0fd6 10171523426685 10329695373991] Exception in string format operation\n2013-10-09 12:22:10.435 34648 TRACE nova.exception Traceback (most recent call last):\n2013-10-09 12:22:10.435 34648 TRACE nova.exception File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 119, in _init_\n2013-10-09 12:22:10.435 34648 TRACE nova.exception message = self.msg_fmt % kwargs\n2013-10-09 12:22:10.435 34648 TRACE nova.exception File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/gettextutils.py\", line 226, in _mod_\n2013-10-09 12:22:10.435 34648 TRACE nova.exception self.data % other\n2013-10-09 12:22:10.435 34648 TRACE nova.exception KeyError: u'marker'\n2013-10-09 12:22:10.435 34648 TRACE nova.exception\n2013-10-09 12:22:10.436 34648 ERROR nova.exception [req-062b4763-5651-485c-ab87-48ccc55d0fd6 10171523426685 10329695373991] code: 404\n2013-10-09 12:22:10.436 34648 ERROR nova.api.openstack [req-062b4763-5651-485c-ab87-48ccc55d0fd6 10171523426685 10329695373991] Caught error: Marker %(marker)s could not be found.\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack Traceback (most recent call last):\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/_init.py\", line 119, in __call_\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack return req.get_response(self.application)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack application, catch_exc_info=False)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack app_iter = application(self.environ, start_response)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in _call_\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack return resp(environ, start_response)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/hp/middleware/cs_auth_token.py\", line 160, in _call_\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack return super(CsAuthProtocol, self)._call_(env, start_response)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/keystoneclient/middleware/auth_token.py\", line 543, in _call_\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack return self.app(env, start_response)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in _call_\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack return resp(environ, start_response)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in _call_\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack return resp(environ, start_response)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in _call_\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack response = self.app(environ, start_response)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in _call_\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack return resp(environ, start_response)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in _call_\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack resp = self.call_func(req, *args, **self.kwargs)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack return self.func(req, *args, **kwargs)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 912, in _call_\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack content_type, body, accept)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 971, in _process_stack\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack action_result = self.dispatch(meth, request, action_args)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 1052, in dispatch\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack return method(req=request, **action_args)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/flavors.py\", line 81, in detail\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack limited_flavors = self._get_flavors(req)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/flavors.py\", line 145, in _get_flavors\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack limit=limit, marker=marker)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/nova/compute/flavors.py\", line 202, in get_all_flavors_sorted_list\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack sort_dir=sort_dir, limit=limit, marker=marker)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 1408, in flavor_get_all\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack sort_dir=sort_dir, limit=limit, marker=marker)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 126, in wrapper\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack return f(*args, **kwargs)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 4227, in flavor_get_all\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack raise exception.MarkerNotFound(marker)\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack MarkerNotFound: Marker %(marker)s could not be found.\n2013-10-09 12:22:10.436 34648 TRACE nova.api.openstack", 
            "date_created": "2013-10-11 08:16:23.287675+00:00", 
            "author": "https://api.launchpad.net/1.0/~philip-day"
        }, 
        {
            "content": "To Reproduce:\n\ncurl -k -i https://compute.systestb.hpcloud.net/v2/34837751408416/flavors/detail?marker=9999999 -X GET -H \"X-Auth-Project-Id: Demo\" -H \"User-Agent: python-novaclient\" -H \"Accept: application/json\" -H \"X-Auth-Token: XXXXXXXXX\"\n\nHTTP/1.1 404 Not Found\nnnCoection: close\nContent-Length: 78\nContent-Type: application/json; charset=UTF-8\nDate: Fri, 11 Oct 2013 07:58:17 GMT\nX-Compute-Request-Id: req-9d9ca8c0-b50b-49e1-935b-3a442fb28a4b\n\n{\"itemNotFound\": {\"message\": \"The resource could not be found.\", \"code\": 404}}", 
            "date_created": "2013-10-11 08:17:44.462863+00:00", 
            "author": "https://api.launchpad.net/1.0/~philip-day"
        }, 
        {
            "content": "Phil, i've added a review for just the exception handling here - https://review.openstack.org/51194. ", 
            "date_created": "2013-10-11 11:59:52.957859+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/51194\nCommitted: http://github.com/openstack/nova/commit/73e337b17d7909a8cd538cb7562de870eab2ee8e\nSubmitter: Jenkins\nBranch:    master\n\ncommit 73e337b17d7909a8cd538cb7562de870eab2ee8e\nAuthor: Davanum Srinivas <email address hidden>\nDate:   Fri Oct 11 07:52:57 2013 -0400\n\n    Handle MarkerNotFound better in Flavor API\n    \n    When the specified marker is not found, we should catch the\n    MarkerNotFound exception and respond with a HTTP 400 Bad\n    Request with sufficient information back to the user. This\n    will avoid spilling unwanted tracebacks in the logs as well.\n    \n    Change-Id: I90a658384f8814096271a193a0f3abd028062b5d\n    Partial-Bug: 1238519\n", 
            "date_created": "2013-10-16 03:01:33.871537+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}