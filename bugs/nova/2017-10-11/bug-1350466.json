{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 09:15:29.138871+00:00", 
    "description": "http://logs.openstack.org/54/105554/4/check/gate-tempest-dsvm-neutron-large-ops/45501af/logs/screen-n-sch.txt.gz?level=TRACE#_2014-07-30_16_26_20_158\n\n\n2014-07-30 16:26:20.158 17209 ERROR nova.openstack.common.periodic_task [-] Error during SchedulerManager._expire_reservations: (OperationalError) (1213, 'Deadlock found when trying to get lock; try restarting transaction') 'UPDATE reservations SET updated_at=updated_at, deleted_at=%s, deleted=id WHERE reservations.deleted = %s AND reservations.expire < %s' (datetime.datetime(2014, 7, 30, 16, 26, 20, 152098), 0, datetime.datetime(2014, 7, 30, 16, 26, 20, 149665))\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task Traceback (most recent call last):\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/openstack/common/periodic_task.py\", line 198, in run_periodic_tasks\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     task(self, context)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/scheduler/manager.py\", line 157, in _expire_reservations\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     QUOTAS.expire(context)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/quota.py\", line 1401, in expire\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     self._driver.expire(context)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/quota.py\", line 651, in expire\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     db.reservation_expire(context)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/db/api.py\", line 1173, in reservation_expire\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     return IMPL.reservation_expire(context)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 149, in wrapper\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     return f(*args, **kwargs)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 3394, in reservation_expire\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     reservation_query.soft_delete(synchronize_session=False)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/openstack/common/db/sqlalchemy/session.py\", line 694, in soft_delete\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     synchronize_session=synchronize_session)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2690, in update\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     update_op.exec_()\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 816, in exec_\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     self._do_exec()\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 913, in _do_exec\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     update_stmt, params=self.query._params)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/openstack/common/db/sqlalchemy/session.py\", line 444, in _wrap\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     _raise_if_deadlock_error(e, self.bind.dialect.name)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/openstack/common/db/sqlalchemy/session.py\", line 427, in _raise_if_deadlock_error\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     raise exception.DBDeadlock(operational_error)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task DBDeadlock: (OperationalError) (1213, 'Deadlock found when trying to get lock; try restarting transaction') 'UPDATE reservations SET updated_at=updated_at, deleted_at=%s, deleted=id WHERE reservations.deleted = %s AND reservations.expire < %s' (datetime.datetime(2014, 7, 30, 16, 26, 20, 152098), 0, datetime.datetime(2014, 7, 30, 16, 26, 20, 149665))\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task \n\n\nmessage:\"nova.openstack.common.periodic_task\" AND message:\"Deadlock found\" AND NOT tags:\"console\" AND tags:\"screen-n-sch.txt\"", 
    "tags": [
        "db", 
        "in-stable-icehouse"
    ], 
    "importance": "High", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1350466", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 1350466, 
    "index": 1552, 
    "created": "2014-07-30 17:37:44.271739+00:00", 
    "title": "deadlock in scheduler expire reservation periodic task", 
    "comments": [
        {
            "content": "http://logs.openstack.org/54/105554/4/check/gate-tempest-dsvm-neutron-large-ops/45501af/logs/screen-n-sch.txt.gz?level=TRACE#_2014-07-30_16_26_20_158\n\n\n2014-07-30 16:26:20.158 17209 ERROR nova.openstack.common.periodic_task [-] Error during SchedulerManager._expire_reservations: (OperationalError) (1213, 'Deadlock found when trying to get lock; try restarting transaction') 'UPDATE reservations SET updated_at=updated_at, deleted_at=%s, deleted=id WHERE reservations.deleted = %s AND reservations.expire < %s' (datetime.datetime(2014, 7, 30, 16, 26, 20, 152098), 0, datetime.datetime(2014, 7, 30, 16, 26, 20, 149665))\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task Traceback (most recent call last):\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/openstack/common/periodic_task.py\", line 198, in run_periodic_tasks\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     task(self, context)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/scheduler/manager.py\", line 157, in _expire_reservations\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     QUOTAS.expire(context)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/quota.py\", line 1401, in expire\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     self._driver.expire(context)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/quota.py\", line 651, in expire\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     db.reservation_expire(context)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/db/api.py\", line 1173, in reservation_expire\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     return IMPL.reservation_expire(context)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 149, in wrapper\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     return f(*args, **kwargs)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 3394, in reservation_expire\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     reservation_query.soft_delete(synchronize_session=False)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/openstack/common/db/sqlalchemy/session.py\", line 694, in soft_delete\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     synchronize_session=synchronize_session)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2690, in update\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     update_op.exec_()\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 816, in exec_\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     self._do_exec()\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 913, in _do_exec\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     update_stmt, params=self.query._params)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/openstack/common/db/sqlalchemy/session.py\", line 444, in _wrap\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     _raise_if_deadlock_error(e, self.bind.dialect.name)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/new/nova/nova/openstack/common/db/sqlalchemy/session.py\", line 427, in _raise_if_deadlock_error\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task     raise exception.DBDeadlock(operational_error)\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task DBDeadlock: (OperationalError) (1213, 'Deadlock found when trying to get lock; try restarting transaction') 'UPDATE reservations SET updated_at=updated_at, deleted_at=%s, deleted=id WHERE reservations.deleted = %s AND reservations.expire < %s' (datetime.datetime(2014, 7, 30, 16, 26, 20, 152098), 0, datetime.datetime(2014, 7, 30, 16, 26, 20, 149665))\n2014-07-30 16:26:20.158 17209 TRACE nova.openstack.common.periodic_task \n\n\nmessage:\"nova.openstack.common.periodic_task\" AND message:\"Deadlock found\" AND NOT tags:\"console\" AND tags:\"screen-n-sch.txt\"", 
            "date_created": "2014-07-30 17:37:44.271739+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Something that did change recently is indexes got added to some of these columns, which might be making the deletes / updates take longer... thus deadlocking.", 
            "date_created": "2014-07-30 17:45:22.236391+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Looks like https://review.openstack.org/#/c/109660 fit the bill", 
            "date_created": "2014-07-30 18:17:51.251280+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Yeah it must be the reservations change for the migrations...the failure started on 7/30:\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJtZXNzYWdlOlwiRGVhZGxvY2sgZm91bmRcIiBBTkQgdGFnczpcInNjcmVlbi1uLXNjaC50eHRcIiAgQU5EIG1vZHVsZTpcIm5vdmEub3BlbnN0YWNrLmNvbW1vbi5wZXJpb2RpY190YXNrXCIiLCJmaWVsZHMiOltdLCJvZmZzZXQiOjAsInRpbWVmcmFtZSI6IjYwNDgwMCIsImdyYXBobW9kZSI6ImNvdW50IiwidGltZSI6eyJ1c2VyX2ludGVydmFsIjowfSwic3RhbXAiOjE0MDY3NDUxMzU3NzYsIm1vZGUiOiIiLCJhbmFseXplX2ZpZWxkIjoiIn0=\n\nI didn't see this fail while that was going through, but we could have hit and rechecked on other things and missed this.", 
            "date_created": "2014-07-30 18:33:41.677668+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "So my read of this is that the old slow version of the code was less likely to hit a race with delete but now that it is optimised it goes quiclkly enought to race with reservation deleted. I think we need to add a retry_on_deadlock decorator to the expiration\n", 
            "date_created": "2014-07-31 20:59:33.846653+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/111084", 
            "date_created": "2014-07-31 21:03:31.357473+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Also showing up in the conductor logs:\n\nhttp://logs.openstack.org/26/109626/1/gate/gate-tempest-dsvm-full/6b1b6c2/logs/screen-n-cond.txt.gz#_2014-08-01_09_38_05_447\n\n2014-08-01 09:38:05.447 25490 TRACE nova.quota OperationalError: (OperationalError) (1213, 'Deadlock found when trying to get lock; try restarting transaction') 'SELECT reservations.created_at AS reservations_created_at, reservations.updated_at AS reservations_updated_at, reservations.deleted_at AS reservations_deleted_at, reservations.deleted AS reservations_deleted, reservations.id AS reservations_id, reservations.uuid AS reservations_uuid, reservations.usage_id AS reservations_usage_id, reservations.project_id AS reservations_project_id, reservations.user_id AS reservations_user_id, reservations.resource AS reservations_resource, reservations.delta AS reservations_delta, reservations.expire AS reservations_expire \\nFROM reservations \\nWHERE reservations.deleted = %s AND reservations.uuid IN (%s, %s, %s) FOR UPDATE' (0, '23e6e41f-4267-484b-91d3-3db30f01df8c', '89015f24-fc2d-4ddb-8e6e-a5bfb9bfc413', '416317c4-8b0b-460e-8ead-48f1496db695')\n2014-08-01 09:38:05.447 25490 TRACE nova.quota ", 
            "date_created": "2014-08-01 17:52:21.331495+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/111084\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3619c1914e9925e18c062bc11bc3e708137f8322\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3619c1914e9925e18c062bc11bc3e708137f8322\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Thu Jul 31 14:00:54 2014 -0700\n\n    Add a retry_on_deadlock to reservations_expire\n    \n    Now that we have an index for the reservations_expire query, we\n    have uncovered a race with quota usage updates due to the foreign\n    key on the table, so just retry if there is a deadlock. This is\n    a fix to unblock the gate while we try to remove the deadlocks\n    completely.\n    \n    Change-Id: I1993c3bd1f81facf1d98a4e29f9e8df4858a7d66\n    Partial-bug: #1350466\n", 
            "date_created": "2014-08-01 19:08:11.385332+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/111410", 
            "date_created": "2014-08-01 23:16:40.347389+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/112109", 
            "date_created": "2014-08-05 18:37:51.659452+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/112418", 
            "date_created": "2014-08-06 21:29:08.012525+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/111410\nCommitted: https://git.openstack.org/cgit/openstack/cinder/commit/?id=201adf31a57ea4d456ef5daf1eca2ed3b64fca85\nSubmitter: Jenkins\nBranch:    master\n\ncommit 201adf31a57ea4d456ef5daf1eca2ed3b64fca85\nAuthor: John Griffith <email address hidden>\nDate:   Fri Aug 1 17:10:55 2014 -0600\n\n    Add retry_on_deadlock to db update methods\n    \n    There's some known races that have been addressed in\n    Nova via a retry_on_deadlock deocrator.  Some known\n    cases in Cinder exist as well when dealing with updates\n    to quotas and reservations_expire.\n    \n    This patch introduces the decorator to Cinder and hits\n    the methods known to be susceptible to deadlock as well\n    as some others that seem as though they'd fall into the\n    same category.\n    \n    Leverages work that's already been done in Nova\n    \n    Co-Authored-By: Vish Ishaya <email address hidden>\n    \n    Change-Id: Ic807f4f8a333e4d5477f86e41eea40191637087c\n    Partial-bug: #1350466\n", 
            "date_created": "2014-08-06 23:49:00.910808+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/112109\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d8b9ba5ef77ec4af7a8b67ef380d5cd2947de51f\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit d8b9ba5ef77ec4af7a8b67ef380d5cd2947de51f\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Thu Jul 31 14:00:54 2014 -0700\n\n    Add a retry_on_deadlock to reservations_expire\n    \n    Now that we have an index for the reservations_expire query, we\n    have uncovered a race with quota usage updates due to the foreign\n    key on the table, so just retry if there is a deadlock. This is\n    a fix to unblock the gate while we try to remove the deadlocks\n    completely.\n    \n    Change-Id: I1993c3bd1f81facf1d98a4e29f9e8df4858a7d66\n    Partial-bug: #1350466\n    (cherry picked from commit 3619c1914e9925e18c062bc11bc3e708137f8322)\n", 
            "date_created": "2014-09-13 13:06:32.477679+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "https://review.openstack.org/#/c/111084/ for Nova is already merged. marking accordingly", 
            "date_created": "2014-09-16 01:38:52.397589+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/112418\nCommitted: https://git.openstack.org/cgit/openstack/cinder/commit/?id=69ade1064c15f63b66906e97e95122926d6e4775\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 69ade1064c15f63b66906e97e95122926d6e4775\nAuthor: John Griffith <email address hidden>\nDate:   Fri Aug 1 17:10:55 2014 -0600\n\n    Add retry_on_deadlock to db update methods\n    \n    There's some known races that have been addressed in\n    Nova via a retry_on_deadlock deocrator.  Some known\n    cases in Cinder exist as well when dealing with updates\n    to quotas and reservations_expire.\n    \n    This patch introduces the decorator to Cinder and hits\n    the methods known to be susceptible to deadlock as well\n    as some others that seem as though they'd fall into the\n    same category.\n    \n    Leverages work that's already been done in Nova\n    \n    Co-Authored-By: Vish Ishaya <email address hidden>\n    \n    Change-Id: Ic807f4f8a333e4d5477f86e41eea40191637087c\n    Partial-bug: #1350466\n    (cherry picked from commit 201adf31a57ea4d456ef5daf1eca2ed3b64fca85)\n", 
            "date_created": "2014-09-16 07:52:48.557518+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}