{
    "status": "Invalid", 
    "last_updated": "2014-06-25 14:11:10.469172+00:00", 
    "description": "through the nova API - while trying to inject a file into a VM, the nova compute throws the following ERROR:\n\n2013-09-04 18:00:20.942 ERROR nova.virt.libvirt.driver [req-f39fd530-764c-4601-9954-dbdb2d4c6e8b 973093ddd3db4b7a8dcaf670b32b7b41 616e857a78f24206ad13b4e84652c997] [instance: e562b310-d5db-4833-992a-3647a4808bb2] Error injecting data into image 9924e399-d53f-495f-a640-ad5c1734fe8e (Error mounting /var/lib/nova/instances/e562b310-d5db-4833-992a-3647a4808bb2/disk with libguestfs (could not parse /etc/fstab or empty file))\n2013-09-04 18:00:20.943 ERROR nova.compute.manager [req-f39fd530-764c-4601-9954-dbdb2d4c6e8b 973093ddd3db4b7a8dcaf670b32b7b41 616e857a78f24206ad13b4e84652c997] [instance: e562b310-d5db-4833-992a-3647a4808bb2] Instance failed to spawn\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2] Traceback (most recent call last):\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1121, in _spawn\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     block_device_info)\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1531, in spawn\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     admin_pass=admin_password)\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1930, in _create_image\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     instance=instance)\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     self.gen.next()\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1925, in _create_image\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     mandatory=('files',))\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/virt/disk/api.py\", line 294, in inject_data\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     fs.setup()\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/virt/disk/vfs/guestfs.py\", line 117, in setup\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     {'imgfile': self.imgfile, 'e': e})\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2] NovaException: Error mounting /var/lib/nova/instances/e562b310-d5db-4833-992a-3647a4808bb2/disk with libguestfs (could not parse /etc/fstab or empty file)\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]\n2013-09-04 18:00:25.238 3634 ERROR nova.virt.libvirt.driver [-] [instance: e562b310-d5db-4833-992a-3647a4808bb2] During wait destroy, instance disappeared.\n\n\n----\n\nI noticed in /usr/lib/python2.6/site-packages/nova/virt/disk/api.py at line 300, the code raises an exception/error if there are any files to inject:\n\n296 :       # If a mandatory item is passed to this function,\n297:        # then reraise the exception to indicate the error.\n298:        for inject in mandatory:\n299:            inject_val = locals()[inject]\n300:            if inject_val:\n301:                raise\n302:        LOG.warn(_('Ignoring error injecting data into image '\n303:                   '(%(e)s)') % locals())\n304:        return False\n\n\nI believe line 300 should be:\n300:            if not inject_val:\n\nwhere it should only raise an exception/error only if the inject_val is nil\n\nPlease verify.", 
    "tags": [
        "libvirt"
    ], 
    "importance": "High", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1221985", 
    "owner": "https://api.launchpad.net/1.0/~mikal", 
    "id": 1221985, 
    "index": 1214, 
    "created": "2013-09-07 00:34:37.817642+00:00", 
    "title": "passing files to inject into compute node failes", 
    "comments": [
        {
            "content": "through the nova API - while trying to inject a file into a VM, the nova compute throws the following ERROR:\n\n2013-09-04 18:00:20.942 ERROR nova.virt.libvirt.driver [req-f39fd530-764c-4601-9954-dbdb2d4c6e8b 973093ddd3db4b7a8dcaf670b32b7b41 616e857a78f24206ad13b4e84652c997] [instance: e562b310-d5db-4833-992a-3647a4808bb2] Error injecting data into image 9924e399-d53f-495f-a640-ad5c1734fe8e (Error mounting /var/lib/nova/instances/e562b310-d5db-4833-992a-3647a4808bb2/disk with libguestfs (could not parse /etc/fstab or empty file))\n2013-09-04 18:00:20.943 ERROR nova.compute.manager [req-f39fd530-764c-4601-9954-dbdb2d4c6e8b 973093ddd3db4b7a8dcaf670b32b7b41 616e857a78f24206ad13b4e84652c997] [instance: e562b310-d5db-4833-992a-3647a4808bb2] Instance failed to spawn\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2] Traceback (most recent call last):\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1121, in _spawn\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     block_device_info)\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1531, in spawn\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     admin_pass=admin_password)\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1930, in _create_image\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     instance=instance)\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     self.gen.next()\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1925, in _create_image\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     mandatory=('files',))\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/virt/disk/api.py\", line 294, in inject_data\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     fs.setup()\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]   File \"/usr/lib/python2.6/site-packages/nova/virt/disk/vfs/guestfs.py\", line 117, in setup\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]     {'imgfile': self.imgfile, 'e': e})\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2] NovaException: Error mounting /var/lib/nova/instances/e562b310-d5db-4833-992a-3647a4808bb2/disk with libguestfs (could not parse /etc/fstab or empty file)\n2013-09-04 18:00:20.943 3634 TRACE nova.compute.manager [instance: e562b310-d5db-4833-992a-3647a4808bb2]\n2013-09-04 18:00:25.238 3634 ERROR nova.virt.libvirt.driver [-] [instance: e562b310-d5db-4833-992a-3647a4808bb2] During wait destroy, instance disappeared.\n\n\n----\n\nI noticed in /usr/lib/python2.6/site-packages/nova/virt/disk/api.py at line 300, the code raises an exception/error if there are any files to inject:\n\n296 :       # If a mandatory item is passed to this function,\n297:        # then reraise the exception to indicate the error.\n298:        for inject in mandatory:\n299:            inject_val = locals()[inject]\n300:            if inject_val:\n301:                raise\n302:        LOG.warn(_('Ignoring error injecting data into image '\n303:                   '(%(e)s)') % locals())\n304:        return False\n\n\nI believe line 300 should be:\n300:            if not inject_val:\n\nwhere it should only raise an exception/error only if the inject_val is nil\n\nPlease verify.", 
            "date_created": "2013-09-07 00:34:37.817642+00:00", 
            "author": "https://api.launchpad.net/1.0/~stmuraka"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/46867", 
            "date_created": "2013-09-17 03:30:47.449958+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "fyi, This issue is hitting the CFv2/BOSH community as well - \nhttp://grokbase.com/t/cloudfoundry.org/bosh-users/137qyw8mtd/bosh-on-openstack-grizzly", 
            "date_created": "2013-10-04 20:49:34.567433+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "update... \nso we found that this defect seems to be based on the case where /etc/fstab is empty in the image, causing libguestfs to fail with \"(could not parse /etc/fstab or empty file)\"\nThis case also is based off the fact that libvirt_inject_partition = -1 [which is set in nova.conf -- the default value in nova.conf]\n\nit seems that my proposal may be wrong (to add in the 'not').... however, after further investigation, if libvirt_inject_partition = -1 [which means to inspect the filesystem] and fails, potentially it should try again, with a partition number, e.g. the actual default of '1' which is the first partition on disk.  or iterate through and do some \"smart guessing\" to find the right partition.\n\n\n\n", 
            "date_created": "2013-10-04 22:20:04.836866+00:00", 
            "author": "https://api.launchpad.net/1.0/~stmuraka"
        }, 
        {
            "content": "Ping. Triaging bugs here.  \n\nWhat's the status of this bug?  There hasn't been an update here for  around eight months. The review request had a couple of comments NACKing the patch, but they weren't addressed yet.", 
            "date_created": "2014-06-03 11:39:07.673976+00:00", 
            "author": "https://api.launchpad.net/1.0/~kashyapc"
        }, 
        {
            "content": "In summary this is libguestfs specific and hits when the instance has an empty /etc/fstab\nWorkarounds are to populate /etc/fstab appropriately in the guest,\nset libvirt_inject_partition=1 (albeit that would impact all guests)\nor update libguestfs to try unpartitioned, or partition 1 in this case\n\nHence closing this for nova", 
            "date_created": "2014-06-25 13:39:29.136541+00:00", 
            "author": "https://api.launchpad.net/1.0/~p-draigbrady"
        }, 
        {
            "content": "Padraig, thanks for CC-ing me on this bug.\n\nThe bug is:\n\nNovaException: Error mounting /var/lib/nova/instances/.../disk with libguestfs (could not parse /etc/fstab or empty file)\n\nThis happens because libguestfs has been asked to inspect the guest to find an operating system (see http://libguestfs.org/guestfs.3.html#inspection ) and it gets stuck when /etc/fstab is either not parsable or completely empty.\n\nThe more fundamental problem here is there is only one global knob to control how libguestfs deals with every disk image, ie. libvirt_inject_partition.  Really it should be settable per disk image.  (IIRC there is another bug open about that)", 
            "date_created": "2014-06-25 13:51:32.883214+00:00", 
            "author": "https://api.launchpad.net/1.0/~rjones-redhat"
        }, 
        {
            "content": "I have filed a bug about the empty /etc/fstab problem.  Apparently ArchLinux guests have empty fstab by default so we shouldn't break on this.\n\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1113156\n\nAlso:\n\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1113153", 
            "date_created": "2014-06-25 14:11:08.739930+00:00", 
            "author": "https://api.launchpad.net/1.0/~rjones-redhat"
        }
    ]
}