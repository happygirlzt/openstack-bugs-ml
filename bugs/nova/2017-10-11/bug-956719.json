{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:54:43.105509+00:00", 
    "description": "I can reproduce a situation where instances do not fully terminate.  In this situation, instance backing files are deleted, but the domain still exists in libvirt.  Then, due to this bug: https://bugs.launchpad.net/bugs/955788 nova-compute will crash on startup.\n\nSteps to reproduce:\n\n> (run devstack)\n> cd exercises\n> # the following script launches 2 instances in quick succession, and then terminates after 10 seconds\n> curl https://raw.github.com/gist/2048763/898a7dc2348bf994eb4f4a93c299f1096522a824/gistfile1.txt > test.sh\n> chmod 755 test.sh\n\nAnd then:\n\n> ./test.sh\n\nRepeat this command 4-8 times.  Then:\n\n> sudo virsh list\n\nExpected:\n\nNo domains\n\nActual:\n\n$ sudo virsh list\n\u00a0Id Name                 State\n----------------------------------\n\u00a019 instance-00000002    running\n\u00a029 instance-0000000c    running\n\nThen, nova-compute starts spitting this error:\n\n2012-03-15 23:10:09 ERROR nova.manager [-] Error during ComputeManager.update_available_resource: Unexpected error while running command.Command: qemu-img info /opt/stack/nova/instances/instance-00000002/diskExit code: 1Stdout: ''Stderr: \"qemu-img: Could not open '/opt/stack/nova/instances/instance-00000002/disk': No such file or directory\\n\"(nova.manager): TRACE: Traceback (most recent call last):(nova.manager): TRACE:   File \"/opt/stack/nova/nova/manager.py\", line 155, in periodic_tasks(nova.manager): TRACE:     task(self, context)(nova.manager): TRACE:   File \"/opt/stack/nova/nova/compute/manager.py\", line 2386, in update_available_resource(nova.manager): TRACE:     self.driver.update_available_resource(context, self.host)(nova.manager): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 1805, in update_available_resource(nova.manager): TRACE:     'disk_available_least': self.get_disk_available_least()}(nova.manager): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 2156, in get_disk_available_least(nova.manager): TRACE:     disk_infos = utils.loads(self.get_instance_disk_info(i_name))(nova.manager): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 2115, in get_instance_disk_info(nova.manager): TRACE:     out, err = utils.execute('qemu-img', 'info', path)(nova.manager): TRACE:   File \"/opt/stack/nova/nova/utils.py\", line 240, in execute(nova.manager): TRACE:     cmd=' '.join(cmd))(nova.manager): TRACE: ProcessExecutionError: Unexpected error while running command.(nova.manager): TRACE: Command: qemu-img info /opt/stack/nova/instances/instance-00000002/disk(nova.manager): TRACE: Exit code: 1(nova.manager): TRACE: Stdout: ''(nova.manager): TRACE: Stderr: \"qemu-img: Could not open '/opt/stack/nova/instances/instance-00000002/disk': No such file or directory\\n\"(nova.manager): TRACE:\n\nAnd upon next restart, the process crashes", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/956719", 
    "owner": "https://api.launchpad.net/1.0/~sleepsonthefloor", 
    "id": 956719, 
    "index": 634, 
    "created": "2012-03-16 06:25:24.472299+00:00", 
    "title": "Instance sometimes do not fully terminate, causes crash", 
    "comments": [
        {
            "content": "I can reproduce a situation where instances do not fully terminate.  In this situation, instance backing files are deleted, but the domain still exists in libvirt.  Then, due to this bug: https://bugs.launchpad.net/bugs/955788 nova-compute will crash on startup.\n\nSteps to reproduce:\n\n> (run devstack)\n> cd exercises\n> # the following script launches 2 instances in quick succession, and then terminates after 10 seconds\n> curl https://raw.github.com/gist/2048763/898a7dc2348bf994eb4f4a93c299f1096522a824/gistfile1.txt > test.sh\n> chmod 755 test.sh\n\nRepeat the above 4-8 times.  Then:\n\n> sudo virsh list\n\nExpected:\n\nNo domains\n\nActual:\n\n$ sudo virsh list \n Id Name                 State\n----------------------------------\n 19 instance-00000002    running\n 29 instance-0000000c    running\n\n\nThen, nova-compute starts spitting this error:\n\n2012-03-15 23:10:09 ERROR nova.manager [-] Error during ComputeManager.update_available_resource: Unexpected error while running command.Command: qemu-img info /opt/stack/nova/instances/instance-00000002/diskExit code: 1Stdout: ''Stderr: \"qemu-img: Could not open '/opt/stack/nova/instances/instance-00000002/disk': No such file or directory\\n\"(nova.manager): TRACE: Traceback (most recent call last):(nova.manager): TRACE:   File \"/opt/stack/nova/nova/manager.py\", line 155, in periodic_tasks(nova.manager): TRACE:     task(self, context)(nova.manager): TRACE:   File \"/opt/stack/nova/nova/compute/manager.py\", line 2386, in update_available_resource(nova.manager): TRACE:     self.driver.update_available_resource(context, self.host)(nova.manager): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 1805, in update_available_resource(nova.manager): TRACE:     'disk_available_least': self.get_disk_available_least()}(nova.manager): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 2156, in get_disk_available_least(nova.manager): TRACE:     disk_infos = utils.loads(self.get_instance_disk_info(i_name))(nova.manager): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 2115, in get_instance_disk_info(nova.manager): TRACE:     out, err = utils.execute('qemu-img', 'info', path)(nova.manager): TRACE:   File \"/opt/stack/nova/nova/utils.py\", line 240, in execute(nova.manager): TRACE:     cmd=' '.join(cmd))(nova.manager): TRACE: ProcessExecutionError: Unexpected error while running command.(nova.manager): TRACE: Command: qemu-img info /opt/stack/nova/instances/instance-00000002/disk(nova.manager): TRACE: Exit code: 1(nova.manager): TRACE: Stdout: ''(nova.manager): TRACE: Stderr: \"qemu-img: Could not open '/opt/stack/nova/instances/instance-00000002/disk': No such file or directory\\n\"(nova.manager): TRACE:\n\nAnd upon next restart, the process crashes", 
            "date_created": "2012-03-16 06:25:24.472299+00:00", 
            "author": "https://api.launchpad.net/1.0/~sleepsonthefloor"
        }, 
        {
            "content": "I'm not sure if https://bugs.launchpad.net/nova/+bug/957110 is exactly the same issue,\nbut the symptom is the same.\n\nThe patch provided there only mitigates the symptom,\nallowing the compute service to start (and logging an error about the missing disk file)", 
            "date_created": "2012-03-16 16:31:56.029545+00:00", 
            "author": "https://api.launchpad.net/1.0/~p-draigbrady"
        }, 
        {
            "content": "anthony has a fix for this which involves synchronizing launch/terminate/start/stop\n\nHe's just putting in some tests and we should see a review soon.", 
            "date_created": "2012-03-16 21:56:57.116446+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/5476", 
            "date_created": "2012-03-16 23:55:24.470520+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/5476\nCommitted: http://github.com/openstack/nova/commit/fe7055a5bd25bef33fe10f4fee858ad8cd30a6ea\nSubmitter: Jenkins\nBranch:    master\n\ncommit fe7055a5bd25bef33fe10f4fee858ad8cd30a6ea\nAuthor: Anthony Young <email address hidden>\nDate:   Fri Mar 16 16:51:03 2012 -0700\n\n    Fix run/terminate race conditions.\n    \n     * synchronize run,terminate,stop,start on instance_uuid\n     * don't surpress error when unfiltering instance, which\n       can result in a zombified instance.\n     * Fixes bug 956719\n     * Remove debug raise\n    \n    Change-Id: I8b2eaffdabfd5c1a9414adb1b5ed11e4c48711fc\n", 
            "date_created": "2012-03-17 18:55:57.476832+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}