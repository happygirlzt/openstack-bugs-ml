{
    "status": "Won't Fix", 
    "last_updated": "2013-01-22 16:06:56.514492+00:00", 
    "description": "It seems image registration via ec2 no longer functions when using deprecated auth.   Reproducible using Essex or deploying devstack, changing it to use deprecated auth (in both nova and glance), creating project/user/zipfile via nova-manage and running:\n\nubuntu@ip-10-252-35-183:~$ truncate -s 1M testimg.img\nubuntu@ip-10-252-35-183:~$ cloud-publish-image x86_64 testimg.img testbucket -vv\nTue Apr 10 06:49:01 UTC 2012: using testbucket/testimg.img for --name\n[image ] testimg.img => testbucket/testimg.img \nTue Apr 10 06:49:01 UTC 2012: checking for existing registered image at testbucket/testimg.img.manifest.xml\nTue Apr 10 06:49:02 UTC 2012: bundling image testimg.img\nTue Apr 10 06:49:03 UTC 2012: upload testbucket/testimg.img.manifest.xml\nTue Apr 10 06:49:03 UTC 2012: register testbucket/testimg.img.manifest.xml\nTue Apr 10 06:49:04 UTC 2012: registered at testbucket/testimg.img.manifest.xml as ami-0000000a\nTue Apr 10 06:49:04 UTC 2012: ami-0000000a testbucket/testimg.img.manifest.xml\nami-0000000a\ttestbucket/testimg.img.manifest.xml\nubuntu@ip-10-252-35-183:~$ euca-describe-images ami-0000000a\nImageNotFound: Image ami-0000000a could not be found.\n\nIn nova-api.log, after the intial upload appears to have completed,:\n\n2012-04-10 06:49:04 INFO nova.api.ec2 [req-0ee2216b-15c5-4e2b-b0d3-e605ccf4b505 admin test] 0.175827s 10.252.35.183 POST /services/Cloud/ CloudController:RegisterImage 200 [Boto/2.2.2 (linux2)] application/x-www-form-urlencoded text/xml\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/poll.py\", line 97, in wait\n    readers.get(fileno, noop).cb(fileno)\n  File \"/opt/stack/nova/nova/image/s3.py\", line 290, in delayed_create\n    self.service.update(context, image_uuid, metadata)\n  File \"/opt/stack/nova/nova/image/glance.py\", line 300, in update\n    self.show(context, image_id)\n  File \"/opt/stack/nova/nova/image/glance.py\", line 244, in show\n    raise exception.ImageNotFound(image_id=image_id)\nImageNotFound: Image c4e23453-0473-40e7-b2d6-8f485500b8da could not be found.\nRemoving descriptor: 7\n\n\nThe exception is coming from nova.image.glance._is_image_available()  It appears the request never embeds the required data in the image properties during upload into glance to satisfy a call to _is_image_available() for the deprecated auth case, specifically user_id/project_id.  The metadata prior to being sent to glance looks like:\n\n{'container_format': 'ami',\n 'disk_format': 'ami',\n 'is_public': False,\n 'name': u'testbucket/testimg.img',\n 'properties': {'architecture': 'x86_64',\n                'image_location': u'testbucket/testimg.img.manifest.xml',\n                'image_state': 'pending'},\n 'status': 'queued'}\n\n\nAdding this information into the metadata for the deprecated_auth case as follows  http://paste.ubuntu.com/922918/ seems to get the job done, though I'm not sure this is expected to happen elsewhere.", 
    "tags": [
        "in-stable-essex", 
        "ubuntu-openstack-upgrade"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/977765", 
    "owner": "None", 
    "id": 977765, 
    "index": 2764, 
    "created": "2012-04-10 06:55:31.772302+00:00", 
    "title": "Image registration (ec2) is broken using deprecated auth", 
    "comments": [
        {
            "content": "It seems image registration via ec2 no longer functions when using deprecated auth.   Reproducible using Essex or deploying devstack, changing it to use deprecated auth (in both nova and glance), creating project/user/zipfile via nova-manage and running:\n\nubuntu@ip-10-252-35-183:~$ truncate -s 1M testimg.img\nubuntu@ip-10-252-35-183:~$ cloud-publish-image x86_64 testimg.img testbucket -vv\nTue Apr 10 06:49:01 UTC 2012: using testbucket/testimg.img for --name\n[image ] testimg.img => testbucket/testimg.img \nTue Apr 10 06:49:01 UTC 2012: checking for existing registered image at testbucket/testimg.img.manifest.xml\nTue Apr 10 06:49:02 UTC 2012: bundling image testimg.img\nTue Apr 10 06:49:03 UTC 2012: upload testbucket/testimg.img.manifest.xml\nTue Apr 10 06:49:03 UTC 2012: register testbucket/testimg.img.manifest.xml\nTue Apr 10 06:49:04 UTC 2012: registered at testbucket/testimg.img.manifest.xml as ami-0000000a\nTue Apr 10 06:49:04 UTC 2012: ami-0000000a testbucket/testimg.img.manifest.xml\nami-0000000a\ttestbucket/testimg.img.manifest.xml\nubuntu@ip-10-252-35-183:~$ euca-describe-images ami-0000000a\nImageNotFound: Image ami-0000000a could not be found.\n\nIn nova-api.log, after the intial upload appears to have completed,:\n\n2012-04-10 06:49:04 INFO nova.api.ec2 [req-0ee2216b-15c5-4e2b-b0d3-e605ccf4b505 admin test] 0.175827s 10.252.35.183 POST /services/Cloud/ CloudController:RegisterImage 200 [Boto/2.2.2 (linux2)] application/x-www-form-urlencoded text/xml\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/poll.py\", line 97, in wait\n    readers.get(fileno, noop).cb(fileno)\n  File \"/opt/stack/nova/nova/image/s3.py\", line 290, in delayed_create\n    self.service.update(context, image_uuid, metadata)\n  File \"/opt/stack/nova/nova/image/glance.py\", line 300, in update\n    self.show(context, image_id)\n  File \"/opt/stack/nova/nova/image/glance.py\", line 244, in show\n    raise exception.ImageNotFound(image_id=image_id)\nImageNotFound: Image c4e23453-0473-40e7-b2d6-8f485500b8da could not be found.\nRemoving descriptor: 7\n\n\nThe exception is coming from nova.image.glance._is_image_available()  It appears the request never embeds the required data in the image properties during upload into glance to satisfy a call to _is_image_available() for the deprecated auth case, specifically user_id/project_id.  The metadata prior to being sent to glance looks like:\n\n{'container_format': 'ami',\n 'disk_format': 'ami',\n 'is_public': False,\n 'name': u'testbucket/testimg.img',\n 'properties': {'architecture': 'x86_64',\n                'image_location': u'testbucket/testimg.img.manifest.xml',\n                'image_state': 'pending'},\n 'status': 'queued'}\n\n\nAdding this information into the metadata for the deprecated_auth case as follows  http://paste.ubuntu.com/922918/ seems to get the job done, though I'm not sure this is expected to happen elsewhere.", 
            "date_created": "2012-04-10 06:55:31.772302+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "Adam,\n  Thanks, I'm wondering what regressed this.  just looking at git logs on nova/image/s3.py nova/image/glance.py (from the trace) and api/ec2/cloud.py (from your patch, nothing jumped out at me).", 
            "date_created": "2012-04-10 12:16:39.652694+00:00", 
            "author": "https://api.launchpad.net/1.0/~smoser"
        }, 
        {
            "content": "Here was the commit: a6ac8af69351cb39aa07f53e3327ff29b90383bc\n\nWe only left deprecated auth in essex for the purpose of migration, so running a production system of deprecatd auth is definitely not supported.  That said, it is probably a pretty easy fix.\n\nAdd back in the project_id on register and default the ImageOwner field to properties.project_id", 
            "date_created": "2012-04-10 17:12:45.140034+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Fix proposed to branch: stable/essex\nReview: https://review.openstack.org/6431", 
            "date_created": "2012-04-10 23:57:45.799834+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/6431\nCommitted: http://github.com/openstack/nova/commit/6e988ed75c5ba507d79818bc24a1bd2f8250ce2b\nSubmitter: Jenkins\nBranch:    stable/essex\n\ncommit 6e988ed75c5ba507d79818bc24a1bd2f8250ce2b\nAuthor: Adam Gandelman <email address hidden>\nDate:   Tue Apr 10 16:44:27 2012 -0700\n\n    Populate image properties with project_id again\n    \n    This allows ec2 image publishing to function on Essex for users\n    who are still using deprecated auth.  This isn't targetted toward\n    master and is proposed to stable/essex for the sake of aiding\n    users transition to Keystone during upgrades from diablo +\n    deprecated_auth.\n    \n    Fixes bug 977765\n    \n    Change-Id: I809b669e88fe25234569d0c744d14aff6bbd4713\n", 
            "date_created": "2012-04-11 00:42:10.004300+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This bug was fixed in the package nova - 2012.1-0ubuntu2\n\n---------------\nnova (2012.1-0ubuntu2) precise; urgency=low\n\n  [ Adam Gandelman ]\n  * debian/rules: Properly create empty doc/build/man dir for builds that\n    skip doc building\n  * debian/control: Set 'Conflicts: nova-compute-hypervisor' for the various\n    nova-compute-$type packages. (LP: #975616)\n  * debian/control: Set 'Breaks: nova-api' for the various nova-api-$service\n    sub-packages. (LP: #966115)\n\n  [ Chuck Short ]\n  * Resynchronize with stable/essex:\n    - b1d11b8 Use project_id in ec2.cloud._format_image()\n    - 6e988ed Fixes image publication using deprecated auth. (LP: #977765)\n    - 6e988ed Populate image properties with project_id again\n    - 3b14c74 Fixed bug 962840, added a test case.\n    - d4e96fe Allow unprivileged RADOS users to access rbd volumes.\n    - 4acfab6 Stop libvirt test from deleting instances dir\n    - 155c7b2 fix bug where nova ignores glance host in imageref\n  * debian/nova.conf: Enabled ec2_private_dns_show_ip so that juju can\n    connect to openstack instances.\n  * debian/patches/fix-docs-build-without-network.patch: Fix docs build\n    when there is no network access.\n -- Chuck Short <email address hidden>   Thu, 12 Apr 2012 14:14:29 -0400", 
            "date_created": "2012-04-12 23:01:47.249366+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ]
}