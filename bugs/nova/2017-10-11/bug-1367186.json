{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:25:38.522112+00:00", 
    "description": "Instances stuck with task_state of unshelving after RPC call between nova-conductor and nova-scheduler fails(because of, for example, timeout) in the operation of unshelve.\n\nThe environment:\nUbuntu 14.04 LTS(64bit)\nstable/icehouse(2014.1.2)\n(I could also reproduce it with master(commit:a1fa42f2ad11258f8b9482353e078adcf73ee9c2).)\n\nHow to reproduce:\n1. create a VM instance\n2. shelve the VM instance\n3. stop nova-scheduler process\n4. unshelve the VM instance\n(The nova-conductor calls the nova-scheduler, but the RPC call times out.)\n\nThen the VM instance stucks with task_state of unshelving(See the following).\nThe VM instance still remains stuck even after nova-scheduler process starts again.\n\nstack@devstack-icehouse:/opt/devstack$ nova list\n+--------------------------------------+---------+-------------------+------------+-------------+-------------------+\n| ID                                   | Name    | Status            | Task State | Power State | Networks          |\n+--------------------------------------+---------+-------------------+------------+-------------+-------------------+\n| 12e488e8-1df1-479d-866e-51c3117e384b | server1 | SHELVED_OFFLOADED | unshelving | Shutdown    | public=10.0.2.194 |\n+--------------------------------------+---------+-------------------+------------+-------------+-------------------+\n\nnova-conductor.log:\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n2014-09-09 18:18:13.263 13087 ERROR oslo.messaging.rpc.dispatcher [-] Exception during message handling: Timed out waiting for a reply to message ID 934be80a9798443597f355d60fa08e56\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 134, in _dispatch_and_reply\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 177, in _dispatch\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 123, in _do_dispatch\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/conductor/manager.py\", line 849, in unshelve_instance\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     instance)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/conductor/manager.py\", line 816, in _schedule_instances\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     request_spec, filter_properties)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/scheduler/rpcapi.py\", line 103, in select_destinations\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     request_spec=request_spec, filter_properties=filter_properties)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 152, in call\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     retry=self.retry)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     timeout=timeout, retry=retry)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 404, in send\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     retry=retry)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 393, in _send\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     result = self._waiter.wait(msg_id, timeout)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 281, in wait\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     reply, ending = self._poll_connection(msg_id, timeout)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 231, in _poll_connection\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     % msg_id)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher MessagingTimeout: Timed out waiting for a reply to message ID 934be80a9798443597f355d60fa08e56\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher \n2014-09-09 18:18:13.274 13087 ERROR oslo.messaging._drivers.common [-] Returning exception Timed out waiting for a reply to message ID 934be80a9798443597f355d60fa08e56 to caller\n2014-09-09 18:18:13.275 13087 ERROR oslo.messaging._drivers.common [-] ['Traceback (most recent call last):\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 134, in _dispatch_and_reply\\n    incoming.message))\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 177, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 123, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n', '  File \"/opt/stack/nova/nova/conductor/manager.py\", line 849, in unshelve_instance\\n    instance)\\n', '  File \"/opt/stack/nova/nova/conductor/manager.py\", line 816, in _schedule_instances\\n    request_spec, filter_properties)\\n', '  File \"/opt/stack/nova/nova/scheduler/rpcapi.py\", line 103, in select_destinations\\n    request_spec=request_spec, filter_properties=filter_properties)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 152, in call\\n    retry=self.retry)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\\n    timeout=timeout, retry=retry)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 404, in send\\n    retry=retry)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 393, in _send\\n    result = self._waiter.wait(msg_id, timeout)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 281, in wait\\n    reply, ending = self._poll_connection(msg_id, timeout)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 231, in _poll_connection\\n    % msg_id)\\n', 'MessagingTimeout: Timed out waiting for a reply to message ID 934be80a9798443597f355d60fa08e56\\n']\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------", 
    "tags": [
        "in-stable-juno", 
        "juno-backport-potential"
    ], 
    "importance": "Undecided", 
    "heat": 30, 
    "link": "https://bugs.launchpad.net/nova/+bug/1367186", 
    "owner": "https://api.launchpad.net/1.0/~natsume-takashi", 
    "id": 1367186, 
    "index": 5143, 
    "created": "2014-09-09 09:38:33.418238+00:00", 
    "title": "Instances stuck with task_state of unshelving after RPC call timeout.", 
    "comments": [
        {
            "content": "Instances stuck with task_state of unshelving after RPC call between nova-conductor and nova-scheduler fails(because of, for example, timeout) in the operation of unshelve.\n\nThe environment:\nUbuntu 14.04 LTS(64bit)\nstable/icehouse(2014.1.2)\n(I could also reproduce it with master(commit:a1fa42f2ad11258f8b9482353e078adcf73ee9c2).)\n\nHow to reproduce:\n1. create a VM instance\n2. shelve the VM instance\n3. stop nova-scheduler process\n4. unshelve the VM instance\n(The nova-conductor calls the nova-scheduler, but the RPC call times out.)\n\nThen the VM instance stucks with task_state of unshelving(See the following).\nThe VM instance still remains stuck even after nova-scheduler process starts again.\n\nstack@devstack-icehouse:/opt/devstack$ nova list\n+--------------------------------------+---------+-------------------+------------+-------------+-------------------+\n| ID                                   | Name    | Status            | Task State | Power State | Networks          |\n+--------------------------------------+---------+-------------------+------------+-------------+-------------------+\n| 12e488e8-1df1-479d-866e-51c3117e384b | server1 | SHELVED_OFFLOADED | unshelving | Shutdown    | public=10.0.2.194 |\n+--------------------------------------+---------+-------------------+------------+-------------+-------------------+\n\nnova-conductor.log:\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n2014-09-09 18:18:13.263 13087 ERROR oslo.messaging.rpc.dispatcher [-] Exception during message handling: Timed out waiting for a reply to message ID 934be80a9798443597f355d60fa08e56\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 134, in _dispatch_and_reply\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 177, in _dispatch\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 123, in _do_dispatch\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/conductor/manager.py\", line 849, in unshelve_instance\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     instance)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/conductor/manager.py\", line 816, in _schedule_instances\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     request_spec, filter_properties)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/scheduler/rpcapi.py\", line 103, in select_destinations\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     request_spec=request_spec, filter_properties=filter_properties)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 152, in call\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     retry=self.retry)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     timeout=timeout, retry=retry)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 404, in send\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     retry=retry)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 393, in _send\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     result = self._waiter.wait(msg_id, timeout)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 281, in wait\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     reply, ending = self._poll_connection(msg_id, timeout)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 231, in _poll_connection\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher     % msg_id)\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher MessagingTimeout: Timed out waiting for a reply to message ID 934be80a9798443597f355d60fa08e56\n2014-09-09 18:18:13.263 13087 TRACE oslo.messaging.rpc.dispatcher \n2014-09-09 18:18:13.274 13087 ERROR oslo.messaging._drivers.common [-] Returning exception Timed out waiting for a reply to message ID 934be80a9798443597f355d60fa08e56 to caller\n2014-09-09 18:18:13.275 13087 ERROR oslo.messaging._drivers.common [-] ['Traceback (most recent call last):\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 134, in _dispatch_and_reply\\n    incoming.message))\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 177, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 123, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n', '  File \"/opt/stack/nova/nova/conductor/manager.py\", line 849, in unshelve_instance\\n    instance)\\n', '  File \"/opt/stack/nova/nova/conductor/manager.py\", line 816, in _schedule_instances\\n    request_spec, filter_properties)\\n', '  File \"/opt/stack/nova/nova/scheduler/rpcapi.py\", line 103, in select_destinations\\n    request_spec=request_spec, filter_properties=filter_properties)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 152, in call\\n    retry=self.retry)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\\n    timeout=timeout, retry=retry)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 404, in send\\n    retry=retry)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 393, in _send\\n    result = self._waiter.wait(msg_id, timeout)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 281, in wait\\n    reply, ending = self._poll_connection(msg_id, timeout)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 231, in _poll_connection\\n    % msg_id)\\n', 'MessagingTimeout: Timed out waiting for a reply to message ID 934be80a9798443597f355d60fa08e56\\n']\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------", 
            "date_created": "2014-09-09 09:38:33.418238+00:00", 
            "author": "https://api.launchpad.net/1.0/~natsume-takashi"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/120347", 
            "date_created": "2014-09-10 08:58:30.452330+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Sean Dague (<email address hidden>) on branch: master\nReview: https://review.openstack.org/120347\nReason: This review is > 4 weeks without comment, and failed Jenkins the last time it was checked. We are abandoning this for now. Feel free to reactivate the review by pressing the restore button and leaving a 'recheck' comment to get fresh test results.", 
            "date_created": "2014-11-20 15:21:29.805756+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "patch is not in progress anymore", 
            "date_created": "2014-12-03 15:15:12.932948+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/155654", 
            "date_created": "2015-02-13 06:10:13.323738+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/155654\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=a84be486c80da690b627d99644a5ed656757097c\nSubmitter: Jenkins\nBranch:    master\n\ncommit a84be486c80da690b627d99644a5ed656757097c\nAuthor: Takashi NATSUME <email address hidden>\nDate:   Fri Feb 13 14:33:11 2015 +0900\n\n    Handle MessagingException in unshelving instance\n    \n    Add Handling MessagingException in nova-conductor\n    when unshelving instance\n    \n    Change-Id: I4dd95ee08e9618b8fd51f043c0f89f4ddcf1cb35\n    Closes-Bug: #1367186\n", 
            "date_created": "2015-02-17 19:46:49.902957+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/157285", 
            "date_created": "2015-02-19 07:47:06.196017+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/158159", 
            "date_created": "2015-02-23 01:35:09.799939+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Takashi NATSUME (<email address hidden>) on branch: stable/juno\nReview: https://review.openstack.org/157285\nReason: This patch is abandoned because the new one is pushed.\n\nhttps://review.openstack.org/#/c/158159/", 
            "date_created": "2015-02-23 01:39:36.708173+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/158159\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=33dcffcc42e8c0d52727458f536eaf28ac1748ae\nSubmitter: Jenkins\nBranch:    stable/juno\n\ncommit 33dcffcc42e8c0d52727458f536eaf28ac1748ae\nAuthor: Takashi NATSUME <email address hidden>\nDate:   Fri Feb 13 14:33:11 2015 +0900\n\n    Handle MessagingException in unshelving instance\n    \n    Add Handling MessagingException in nova-conductor\n    when unshelving instance\n    \n    Change-Id: I4dd95ee08e9618b8fd51f043c0f89f4ddcf1cb35\n    Closes-Bug: #1367186\n    (cherry-pick from commit a84be486c80da690b627d99644a5ed656757097c)\n", 
            "date_created": "2015-04-02 00:41:14.002795+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}