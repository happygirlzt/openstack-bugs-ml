{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:54:23.243599+00:00", 
    "description": "Back in July 20, there was a 'non_inheritable_image_properties' flag added which filtered out a couple of image metadata properties when the XenAPI driver uploaded images to glance.\n\ncommit ae7adbb92babf2dfc928daa76474aaba8e325d9c\nAuthor: Rick Harris <email address hidden>\nDate:   Fri Jul 20 22:35:10 2012 +0000\n\n    Adds non_inheritable_image_properties flag.\n    \n    Some image-properties should not be inherited from the instance when\n    taking a snapshot because we want that functionality to only available\n    for the base-image, not subsequent snapshots.\n    \n    As an example, we would like 'cache_in_nova' fast-cloning to be\n    available just for base-images and not customer snapshots created off a\n    base-image.\n    \n    This patch adds a new configuration which allows operators to, at\n    runtime, select which image-properties should not be inherited by newly\n    created snapshots.\n    \n    Change-Id: I8d7781b05ffd71a59ba69fb7c3df4616cba94cce\n\n\n\nAlthough these properties were only really relevant to XenAPI, the logic was then moved into the compute manager api code for creating snapshots\n\n\n\ncommit 1c68e733ca0e536ea95ac982d1b4b43ed143b3e2\nAuthor: Kevin L. Mitchell <email address hidden>\nDate:   Thu Oct 4 16:23:14 2012 -0500\n\n    Move snapshot image property inheritance\n    \n    The xenapi snapshotting code had support for inheriting properties\n    from the base image of the snapshot (by way of the system metadata\n    set on the snapshotted instance).  The problem, however, came in the\n    fact that some image properties were set in nova.compute.api, but\n    those properties were not excluded from this inheritance logic\n    except through a configuration option called\n    \"non_inheritable_image_properties\".  I had previously updated the\n    default setting for this option to work around the bugs introduced\n    by setting image properties in two different locations, but now it\n    is time for the real fix.\n    \n    This change moves the inheritance logic into\n    nova.compute.api:API._create_image.  Note that two properties are\n    still set through the xenapi snapshotting logic: the \"os_type\" and\n    the \"auto_disk_config\" properties, which are presumed to be xenapi\n    specific.  The change also alters the inheritance logic to ensure\n    that the work-around listing of image properties in\n    non_inheritable_image_properties is no longer necessary; the\n    default for this configuration option is updated accordingly.\n    \n    (Note: It will not harm anything to have these image properties\n    still listed in non_inheritable_image_properties, so configurations\n    that override this option do not need to be altered.)\n    \n    Change-Id: I3514da432cc10c75418e1de9752f60640d579136\n\n\nNext up in\n\n\ncommit 8e575be75c80ea71a6ad8fb73e6ace1ed708938f\nAuthor: Xavier Queralt <email address hidden>\nDate:   Mon Aug 26 22:53:03 2013 +0200\n\n    Add methods to get image metadata from instance\n    \n    This patch adds a couple of utility functions that enclose all the logic\n    for getting and parsing the image metadata stored in the instance's\n    system metadata.\n    \n    First, this will try to fetch the metadata from the real image and will\n    prevent it from failing if it is not available. It will be then merged\n    with the image metadata stored during the instance creation.\n    \n    Related to bug #1039662\n    \n    Change-Id: I2130caf19858585571b1199e27f0a98ad5f08701\n\n\nThe nova.utils.get_image_from_system_metadata() method added in this commit includes the logic from the compute api create_image method to drop image metadata properties listed in CONF.non_inheritable_image_properties. \n\nFinally many areas of the codebase are updated to use nova.utils.get_image_from_system_metadata (or nova.compute.utils.get_image_metadata) in this commit:\n\ncommit 4389f2292a0177c8eedc0a398ceb3c5535a9ef82\nAuthor: Xavier Queralt <email address hidden>\nDate:   Mon Aug 26 22:55:46 2013 +0200\n\n    Avoid errors on some actions when image not usable\n    \n    Using the metadata saved on instance creation, we can now get all the\n    image related metadata we need from the instance itself.\n    \n    This patch replace the logic for getting the image metadata on some\n    actions that shouldn't fail when the image is not accessible (create\n    an snapshot, resize, migrate, rescue an instance or attach an\n    interface).\n    \n    Fixes bug 1039662\n    \n    Change-Id: Id8c2f13ca96908317d271a84fd685104b64f87e9\n\n\n\nThis is a mistake, because the CONF.non_inheritable_image_properties config property was *only* intended to filter out image properties when uploading snapshot images. It is now filtering out properties in a great many non-snapshot related code paths. For example, when hot-plugging a network interface to a running guest, it filters out image properties that might be needed.", 
    "tags": [
        "compute", 
        "xenserver"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1459760", 
    "owner": "https://api.launchpad.net/1.0/~berrange", 
    "id": 1459760, 
    "index": 5567, 
    "created": "2015-05-28 17:36:20.975397+00:00", 
    "title": "Incorrect dropping of image meta properties not wanted for snapshotting", 
    "comments": [
        {
            "content": "Back in July 20, there was a 'non_inheritable_image_properties' flag added which filtered out a couple of image metadata properties when the XenAPI driver uploaded images to glance.\n\ncommit ae7adbb92babf2dfc928daa76474aaba8e325d9c\nAuthor: Rick Harris <email address hidden>\nDate:   Fri Jul 20 22:35:10 2012 +0000\n\n    Adds non_inheritable_image_properties flag.\n    \n    Some image-properties should not be inherited from the instance when\n    taking a snapshot because we want that functionality to only available\n    for the base-image, not subsequent snapshots.\n    \n    As an example, we would like 'cache_in_nova' fast-cloning to be\n    available just for base-images and not customer snapshots created off a\n    base-image.\n    \n    This patch adds a new configuration which allows operators to, at\n    runtime, select which image-properties should not be inherited by newly\n    created snapshots.\n    \n    Change-Id: I8d7781b05ffd71a59ba69fb7c3df4616cba94cce\n\n\n\nAlthough these properties were only really relevant to XenAPI, the logic was then moved into the compute manager api code for creating snapshots\n\n\n\ncommit 1c68e733ca0e536ea95ac982d1b4b43ed143b3e2\nAuthor: Kevin L. Mitchell <email address hidden>\nDate:   Thu Oct 4 16:23:14 2012 -0500\n\n    Move snapshot image property inheritance\n    \n    The xenapi snapshotting code had support for inheriting properties\n    from the base image of the snapshot (by way of the system metadata\n    set on the snapshotted instance).  The problem, however, came in the\n    fact that some image properties were set in nova.compute.api, but\n    those properties were not excluded from this inheritance logic\n    except through a configuration option called\n    \"non_inheritable_image_properties\".  I had previously updated the\n    default setting for this option to work around the bugs introduced\n    by setting image properties in two different locations, but now it\n    is time for the real fix.\n    \n    This change moves the inheritance logic into\n    nova.compute.api:API._create_image.  Note that two properties are\n    still set through the xenapi snapshotting logic: the \"os_type\" and\n    the \"auto_disk_config\" properties, which are presumed to be xenapi\n    specific.  The change also alters the inheritance logic to ensure\n    that the work-around listing of image properties in\n    non_inheritable_image_properties is no longer necessary; the\n    default for this configuration option is updated accordingly.\n    \n    (Note: It will not harm anything to have these image properties\n    still listed in non_inheritable_image_properties, so configurations\n    that override this option do not need to be altered.)\n    \n    Change-Id: I3514da432cc10c75418e1de9752f60640d579136\n\n\nNext up in\n\n\ncommit 8e575be75c80ea71a6ad8fb73e6ace1ed708938f\nAuthor: Xavier Queralt <email address hidden>\nDate:   Mon Aug 26 22:53:03 2013 +0200\n\n    Add methods to get image metadata from instance\n    \n    This patch adds a couple of utility functions that enclose all the logic\n    for getting and parsing the image metadata stored in the instance's\n    system metadata.\n    \n    First, this will try to fetch the metadata from the real image and will\n    prevent it from failing if it is not available. It will be then merged\n    with the image metadata stored during the instance creation.\n    \n    Related to bug #1039662\n    \n    Change-Id: I2130caf19858585571b1199e27f0a98ad5f08701\n\n\nThe nova.utils.get_image_from_system_metadata() method added in this commit includes the logic from the compute api create_image method to drop image metadata properties listed in CONF.non_inheritable_image_properties. \n\nFinally many areas of the codebase are updated to use nova.utils.get_image_from_system_metadata (or nova.compute.utils.get_image_metadata) in this commit:\n\ncommit 4389f2292a0177c8eedc0a398ceb3c5535a9ef82\nAuthor: Xavier Queralt <email address hidden>\nDate:   Mon Aug 26 22:55:46 2013 +0200\n\n    Avoid errors on some actions when image not usable\n    \n    Using the metadata saved on instance creation, we can now get all the\n    image related metadata we need from the instance itself.\n    \n    This patch replace the logic for getting the image metadata on some\n    actions that shouldn't fail when the image is not accessible (create\n    an snapshot, resize, migrate, rescue an instance or attach an\n    interface).\n    \n    Fixes bug 1039662\n    \n    Change-Id: Id8c2f13ca96908317d271a84fd685104b64f87e9\n\n\n\nThis is a mistake, because the CONF.non_inheritable_image_properties config property was *only* intended to filter out image properties when uploading snapshot images. It is now filtering out properties in a great many non-snapshot related code paths. For example, when hot-plugging a network interface to a running guest, it filters out image properties that might be needed.", 
            "date_created": "2015-05-28 17:36:20.975397+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/187250", 
            "date_created": "2015-06-01 16:38:00.146373+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/187250\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=9fc47e63466f7e7e0e60edaca22e4118bf6a83af\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9fc47e63466f7e7e0e60edaca22e4118bf6a83af\nAuthor: Daniel P. Berrange <email address hidden>\nDate:   Fri May 29 11:03:02 2015 +0100\n\n    compute: only use non_inheritable_image_properties if snapshotting\n    \n    The CONF.non_inheritable_image_properties parameter lists a set of\n    image metadata properties that should be discarded when uploading\n    an image to glance during the snapshotting process.\n    \n    This property is currently applied in the nova.utils method\n    get_image_from_system_metadata(), which causes the properties in\n    question to be discarded in a wide variety of non-snapshotting\n    related operations.\n    \n    This is a regression caused by two commits:\n    \n      commit 8e575be75c80ea71a6ad8fb73e6ace1ed708938f\n      Author: Xavier Queralt <email address hidden>\n      Date: Mon Aug 26 22:53:03 2013 +0200\n    \n        Add methods to get image metadata from instance\n    \n      commit 4389f2292a0177c8eedc0a398ceb3c5535a9ef82\n      Author: Xavier Queralt <email address hidden>\n      Date: Mon Aug 26 22:55:46 2013 +0200\n    \n        Avoid errors on some actions when image not usable\n    \n    Which moved handling of CONF.non_inheritable_image_properties out\n    of the compute API _create_image() method, and into nova.utils.\n    \n    Fix this by moving the handing back into the compute API in its\n    original location.\n    \n    Closes-bug: #1459760\n    Change-Id: Id630fe68678c4aa469ddbfdb3c757b264519e918\n", 
            "date_created": "2015-06-09 20:08:15.140068+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}