{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:55:21.805944+00:00", 
    "description": "Admin context generated by context.get_admin_context() doesn't set valid auth_token+strategy.\n\nWithout these fields properly set different \"internal\" nova tasks (like periodic_tasks) are unable to access image_service when Keystone is used.\n\n\nAs a result, new imagecache functionality added to Essex fails with ERROR:\n\n401 Unauthorized\n\nThis server could not verify that you are authorized to access the document you requested. Either you supplied the wrong credentials (e.g., bad password), or your browser does not understand how to supply the credentials required.\n\nAuthentication required", 
    "tags": [
        "canonistack"
    ], 
    "importance": "Medium", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/934464", 
    "owner": "https://api.launchpad.net/1.0/~mikal", 
    "id": 934464, 
    "index": 2759, 
    "created": "2012-02-17 20:09:52.401814+00:00", 
    "title": "New instance imagecache doesn't work with keystone: get_admin_context() doesn't set a valid token/strategy", 
    "comments": [
        {
            "content": "Admin context generated by context.get_admin_context() doesn't set valid auth_token+strategy.\n\nWithout these fields properly set different \"internal\" nova tasks (like periodic_tasks) are unable to access image_service when Keystone is used.\n\n\nAs a result, new imagecache functionality added to Essex fails with ERROR:\n\n401 Unauthorized\n\nThis server could not verify that you are authorized to access the document you requested. Either you supplied the wrong credentials (e.g., bad password), or your browser does not understand how to supply the credentials required.\n\nAuthentication required", 
            "date_created": "2012-02-17 20:09:52.401814+00:00", 
            "author": "https://api.launchpad.net/1.0/~vladimir.p"
        }, 
        {
            "content": "The context here comes from rom nova/service.py where Service.periodic_tasks() just calls context.get_admin_context(), so I think the imagecache code is just the lucky first victim. It seems like the right fix is to make sure that admin contexts work correctly with keystone in general.", 
            "date_created": "2012-02-17 23:20:35.024282+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "Looks like we won't have a fix in time for E4", 
            "date_created": "2012-03-01 09:29:46.024925+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Vladimir -- I don't have a keystone test environment at the moment, and I don't want to hold up the fix while I build one. Can you confirm whether the attached patch fixes your problem? You'd need to specify an admin context token with the --admin_auth_token flag in nova.conf for this to work.\n\nThanks.", 
            "date_created": "2012-03-05 03:47:32.046987+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "Michael,\n\nIt will almost work :-) It seems like it is required to set the strategy as\nwell.\n\nIn our local branch I changed the __init__ of RequestContext() like:\n+        if is_admin:\n+            if auth_token is None:\n+                self.auth_token = FLAGS.admin_auth_token\n+            if strategy == 'noauth':\n+                self.strategy = FLAGS.admin_auth_strategy\n\nBut it is possible to add arguments within get_admin_context() as well.\n\nRegards,\n-Vladimir\n\n\n-----Original Message-----\nFrom: <email address hidden> [mailto:<email address hidden>] On Behalf Of\nMichael Still\nSent: Sunday, March 04, 2012 7:48 PM\nTo: <email address hidden>\nSubject: [Bug 934464] Re: New instance imagecache doesn't work with\nkeystone: get_admin_context() doesn't set a valid token/strategy\n\nVladimir -- I don't have a keystone test environment at the moment, and I\ndon't want to hold up the fix while I build one. Can you confirm whether the\nattached patch fixes your problem? You'd need to specify an admin context\ntoken with the --admin_auth_token flag in nova.conf for this to work.\n\nThanks.\n\n** Patch added: \"imc-admin-context.patch\"\n   https://bugs.launchpad.net/nova/+bug/934464/+attachment/2815292/+files/imc-admin-context.patch\n\n--\nYou received this bug notification because you are subscribed to the bug\nreport.\nhttps://bugs.launchpad.net/bugs/934464\n\nTitle:\n  New instance imagecache doesn't work with keystone:\n  get_admin_context() doesn't set a valid token/strategy\n\nStatus in OpenStack Compute (Nova):\n  Confirmed\n\nBug description:\n  Admin context generated by context.get_admin_context() doesn't set\n  valid auth_token+strategy.\n\n  Without these fields properly set different \"internal\" nova tasks\n  (like periodic_tasks) are unable to access image_service when Keystone\n  is used.\n\n\n  As a result, new imagecache functionality added to Essex fails with ERROR:\n\n  401 Unauthorized\n\n  This server could not verify that you are authorized to access the\n  document you requested. Either you supplied the wrong credentials\n  (e.g., bad password), or your browser does not understand how to\n  supply the credentials required.\n\n  Authentication required\n\nTo manage notifications about this bug go to:\nhttps://bugs.launchpad.net/nova/+bug/934464/+subscriptions\n", 
            "date_created": "2012-03-05 18:11:05+00:00", 
            "author": "https://api.launchpad.net/1.0/~vladimir.p"
        }, 
        {
            "content": "FYI, devstack installs keystone by default.  Yes the strategy needs to be set as well.", 
            "date_created": "2012-03-05 19:29:29.157437+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I'm thinking an alternate solution is better for essex since we haven't nailed down adminstrative interactions between services. Imagecache is the only thing that tries to talk to glance directly as an admin.  Lets just modify imagecache to not verify images with glance for now. We can revisit this in folsom.", 
            "date_created": "2012-03-05 21:37:37.543736+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I have just sent off a review which eliminates calls to glance in the image cache manager.", 
            "date_created": "2012-03-08 10:29:34.305755+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "For reference: https://review.openstack.org/#change,5075", 
            "date_created": "2012-03-12 16:21:35.683270+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/5075\nCommitted: http://github.com/openstack/nova/commit/ad53f91e623f05cfe994101d56d6d2cf54cd8412\nSubmitter: Jenkins\nBranch:    master\n\ncommit ad53f91e623f05cfe994101d56d6d2cf54cd8412\nAuthor: Michael Still <email address hidden>\nDate:   Tue Mar 6 16:45:40 2012 +1100\n\n    Don't use glance when verifying images.\n    \n    Using glance means that admin contexts need to know how to use\n    keystone when that is enabled. Its safer to avoid calling glance\n    at all from inside the periodic task.\n    \n    This should resolve bug 934464.\n    \n    Change-Id: Ib730e3f57721fca7080d90ae80b5f8916c1dc76c\n", 
            "date_created": "2012-03-12 18:37:05.252585+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}