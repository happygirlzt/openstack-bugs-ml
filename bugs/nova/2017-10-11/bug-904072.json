{
    "status": "Fix Released", 
    "last_updated": "2013-01-22 16:06:58.349731+00:00", 
    "description": "project_id could be overwritten to any value by URI value.\nUser can create server on any project (even if it is not exist) \nQuota function will not be working because of this bug. (So This bug is a security vulnerability)\n\n--Test condition\nuser : demo (not admin)\nproject_id: 2 \n\n-- Requeest\nstack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers  <-- invalid tenant_id\n\n-- Response\n{\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$ \n\n-- DB result\ninstance with project_id \"tushar2\" is created\n\nmysql> select id,project_id from instances;\n+----+------------+\n| id | project_id |\n+----+------------+\n|  1 | demo5      |\n|  2 | demo5      |\n|  3 | tushar     |\n|  4 | tushar1    |\n|  5 | tushar2    |\n|  6 | tushar2    |\n|  7 | tushar2    |\n+----+------------+\n7 rows in set (0.00 sec)\n\n--Cause of this bug\nThis code set project_id to request object from uri\nhttps://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n\nThen this code set the project_id to context object\nhttps://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554", 
    "tags": [
        "in-stable-diablo"
    ], 
    "importance": "High", 
    "heat": 264, 
    "link": "https://bugs.launchpad.net/nova/+bug/904072", 
    "owner": "https://api.launchpad.net/1.0/~ttx", 
    "id": 904072, 
    "index": 541, 
    "created": "2011-12-14 03:17:59.157404+00:00", 
    "title": "project_id could be overwritten to any value by URI value", 
    "comments": [
        {
            "content": "project_id could be overwritten to any value by URI value.\nUser can create server on any project (even if it is not exist) \nQuota function will not be working because of this bug. (So This bug is a security vulnerability)\n\n--Test condition\nuser : demo (not admin)\nproject_id: 2 \n\n-- Requeest\nstack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers  <-- invalid tenant_id\n\n-- Response\n{\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$ \n\n-- DB result\ninstance with project_id \"tushar2\" is created\n\nmysql> select id,project_id from instances;\n+----+------------+\n| id | project_id |\n+----+------------+\n|  1 | demo5      |\n|  2 | demo5      |\n|  3 | tushar     |\n|  4 | tushar1    |\n|  5 | tushar2    |\n|  6 | tushar2    |\n|  7 | tushar2    |\n+----+------------+\n7 rows in set (0.00 sec)\n\n--Cause of this bug\nThis code set project_id to request object from uri\nhttps://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n\nThen this code set the project_id to context object\nhttps://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554", 
            "date_created": "2011-12-14 03:17:59.157404+00:00", 
            "author": "https://api.launchpad.net/1.0/~nati-ueno"
        }, 
        {
            "content": "fix is pretty easy, but fixing the tests afterwards is really annoying.\n\ndiff --git a/nova/api/openstack/wsgi.py b/nova/api/openstack/wsgi.py\nindex 1ffca9e..5760f88 100644\n--- a/nova/api/openstack/wsgi.py\n+++ b/nova/api/openstack/wsgi.py\n@@ -560,8 +560,10 @@ class Resource(wsgi.Application):\n             return Fault(webob.exc.HTTPBadRequest(explanation=msg))\n \n         project_id = args.pop(\"project_id\", None)\n-        if 'nova.context' in request.environ and project_id:\n-            request.environ['nova.context'].project_id = project_id\n+        if ('nova.context' in request.environ and project_id\n+            and project_id != request.environ['nova.context'].project_id):\n+            msg = _(\"Malformed request url\")\n+            return Fault(webob.exc.HTTPBadRequest(explanation=msg))\n \n         try:\n             action_result = self.dispatch(request, action, args)", 
            "date_created": "2011-12-15 18:08:30.750993+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "FYI This change breaks the tests badly.  I have fixes for the tests in trunk, but it is kind of big.  Included.", 
            "date_created": "2011-12-15 18:15:04.356152+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "#approve", 
            "date_created": "2011-12-15 18:31:25.750214+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "BTW, I saw this patch fix a live environment.", 
            "date_created": "2011-12-15 18:31:48.214451+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "#approve", 
            "date_created": "2011-12-15 18:33:12.639880+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "We'll need to coordinate this one downstream. I'll ask a CVE and send downstream, probably tomorrow.", 
            "date_created": "2011-12-15 18:42:01.951587+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Time is running short to disclose this in a coordinated fashion before the holiday weeks. It's clearly not best practice to release a security advisory the days before Christmas.\n\nNachi: are you comfortable with not disclosing this in the next two weeks (and wait for the first days of January for coordinating the disclosure downstream) ? Are you the original finder that should be credited for finding this ?\n\nBrian: what do you mean by \"I saw this patch fix a live environment\" ? How public is this already ?\n\nVish: there is no way to make the patch shorter ? :)\n\nI'm preparing the impact statement / CVE request and need a bit more information about impact. My understanding is that an authentified user can issue commands for any project... Am I right in assuming that (1) you need to be authentified, (2) you can issue any command and (3) this affects both EC2 and OSAPI ?\n\nIn particular for (2), I suspect that the user cannot issue *any* command, but just the ones that he would be... entitled to on projects belonging to him ? How do we map roles/users/projects usually ?", 
            "date_created": "2011-12-16 14:37:34.268190+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "ttx: Sorry, I should have been a bit clearer in my comment. I helped somebody on my team reproduce this bug in an existing (private) environment then apply the proposed fix and verify the bug was no longer reproducible.", 
            "date_created": "2011-12-16 20:56:49.357788+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "ttx\n\n1) you still need to be authenticated.  The keystone middleware doesn't let the request hit the router if you fail to auth.\n\n2) you can issue any openstack api request against any tenant.   \n\nBecause most logic in the API uses the context (not the URL) to specify the resources you are interacting with (for example list servers uses the tenant from the context)\n\n        instance_list = self.compute_api.get_all(context,\n                                                 search_opts=search_opts)\n\nhttps://github.com/openstack/nova/blob/master/nova/api/openstack/v2/servers.py#L145\n\nSo you can create a server in another project but delete, list, show (and most other api calls) will not be able to modify it by via the api.  This is because the way that the database layer is written is defensive - it only lets you access data that your context says you have access to.\n\nThis is still bad in that it allows creation of resources outside of your project (for quota/billing avoidance) and there could be more tunnels.\n\n3) only affects if you are the openstack api using keystone (not deprecated auth) \n\nIt shouldn't affect people who use the default (which is nova's internal legacy auth) or who use the ec2 api", 
            "date_created": "2011-12-16 21:30:37.244632+00:00", 
            "author": "https://api.launchpad.net/1.0/~anotherjesse"
        }, 
        {
            "content": "Comments below\n\nOn Dec 16, 2011, at 1:30 PM, anotherjesse wrote:\n\n> ttx\n> \n> 1) you still need to be authenticated.  The keystone middleware doesn't\n> let the request hit the router if you fail to auth.\n> \n> 2) you can issue any openstack api request against any tenant.\n> \n> Because most logic in the API uses the context (not the URL) to specify\n> the resources you are interacting with (for example list servers uses\n> the tenant from the context)\n> \n>        instance_list = self.compute_api.get_all(context,\n>                                                 search_opts=search_opts)\n> \n> https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/servers.py#L145\n> \n> So you can create a server in another project but delete, list, show\n> (and most other api calls) will not be able to modify it by via the api.\n> This is because the way that the database layer is written is defensive\n> - it only lets you access data that your context says you have access\n> to.\n> \n> This is still bad in that it allows creation of resources outside of\n> your project (for quota/billing avoidance) and there could be more\n> tunnels.\n\nI believe this is incorrect.  The broken code actually sets context.project_id = to whatever was in the url, so I think you can list and terminate instances in other projects as well.\n> \n> 3) only affects if you are the openstack api using keystone (not\n> deprecated auth)\n> \n> It shouldn't affect people who use the default (which is nova's internal\n> legacy auth) or who use the ec2 api\n\nlegacy auth is also broken afaik, because it will successfully authenticate and then the authentication will be overwritten by the url.  EC2 auth shouldn't be affected.\n> \n> -- \n> You received this bug notification because you are a member of Nova\n> Core, which is subscribed to the bug report.\n> https://bugs.launchpad.net/bugs/904072\n> \n> Title:\n>  project_id could be overwritten to any value by URI value\n> \n> Status in OpenStack Compute (Nova):\n>  Confirmed\n> \n> Bug description:\n>  project_id could be overwritten to any value by URI value.\n>  User can create server on any project (even if it is not exist) \n>  Quota function will not be working because of this bug. (So This bug is a security vulnerability)\n> \n>  --Test condition\n>  user : demo (not admin)\n>  project_id: 2 \n> \n>  -- Requeest\n>  stack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers  <-- invalid tenant_id\n> \n>  -- Response\n>  {\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$ \n> \n>  -- DB result\n>  instance with project_id \"tushar2\" is created\n> \n>  mysql> select id,project_id from instances;\n>  +----+------------+\n>  | id | project_id |\n>  +----+------------+\n>  |  1 | demo5      |\n>  |  2 | demo5      |\n>  |  3 | tushar     |\n>  |  4 | tushar1    |\n>  |  5 | tushar2    |\n>  |  6 | tushar2    |\n>  |  7 | tushar2    |\n>  +----+------------+\n>  7 rows in set (0.00 sec)\n> \n>  --Cause of this bug\n>  This code set project_id to request object from uri\n>  https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n> \n>  Then this code set the project_id to context object\n>  https://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/904072/+subscriptions\n\n", 
            "date_created": "2011-12-16 22:42:40+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Hi All\n\n>ttx\nI'm ok to not disclosing this in the next two\nweeks. Me, Rohit and Ravi found this bug.\n\n>Vish\nThank you for your patch.\nI have one question. Why we still set project_id from URL?\n\nCheers\nNati\n\n2011/12/16 Vish Ishaya <email address hidden>:\n> Comments below\n>\n> On Dec 16, 2011, at 1:30 PM, anotherjesse wrote:\n>\n>> ttx\n>>\n>> 1) you still need to be authenticated. \u00a0The keystone middleware doesn't\n>> let the request hit the router if you fail to auth.\n>>\n>> 2) you can issue any openstack api request against any tenant.\n>>\n>> Because most logic in the API uses the context (not the URL) to specify\n>> the resources you are interacting with (for example list servers uses\n>> the tenant from the context)\n>>\n>> \u00a0 \u00a0 \u00a0 \u00a0instance_list = self.compute_api.get_all(context,\n>> \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 search_opts=search_opts)\n>>\n>> https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/servers.py#L145\n>>\n>> So you can create a server in another project but delete, list, show\n>> (and most other api calls) will not be able to modify it by via the api.\n>> This is because the way that the database layer is written is defensive\n>> - it only lets you access data that your context says you have access\n>> to.\n>>\n>> This is still bad in that it allows creation of resources outside of\n>> your project (for quota/billing avoidance) and there could be more\n>> tunnels.\n>\n> I believe this is incorrect. \u00a0The broken code actually sets context.project_id = to whatever was in the url, so I think you can list and terminate instances in other projects as well.\n>>\n>> 3) only affects if you are the openstack api using keystone (not\n>> deprecated auth)\n>>\n>> It shouldn't affect people who use the default (which is nova's internal\n>> legacy auth) or who use the ec2 api\n>\n> legacy auth is also broken afaik, because it will successfully authenticate and then the authentication will be overwritten by the url. \u00a0EC2 auth shouldn't be affected.\n>>\n>> --\n>> You received this bug notification because you are a member of Nova\n>> Core, which is subscribed to the bug report.\n>> https://bugs.launchpad.net/bugs/904072\n>>\n>> Title:\n>> \u00a0project_id could be overwritten to any value by URI value\n>>\n>> Status in OpenStack Compute (Nova):\n>> \u00a0Confirmed\n>>\n>> Bug description:\n>> \u00a0project_id could be overwritten to any value by URI value.\n>> \u00a0User can create server on any project (even if it is not exist)\n>> \u00a0Quota function will not be working because of this bug. (So This bug is a security vulnerability)\n>>\n>> \u00a0--Test condition\n>> \u00a0user : demo (not admin)\n>> \u00a0project_id: 2\n>>\n>> \u00a0-- Requeest\n>> \u00a0stack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers \u00a0<-- invalid tenant_id\n>>\n>> \u00a0-- Response\n>> \u00a0{\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$\n>>\n>> \u00a0-- DB result\n>> \u00a0instance with project_id \"tushar2\" is created\n>>\n>> \u00a0mysql> select id,project_id from instances;\n>> \u00a0+----+------------+\n>> \u00a0| id | project_id |\n>> \u00a0+----+------------+\n>> \u00a0| \u00a01 | demo5 \u00a0 \u00a0 \u00a0|\n>> \u00a0| \u00a02 | demo5 \u00a0 \u00a0 \u00a0|\n>> \u00a0| \u00a03 | tushar \u00a0 \u00a0 |\n>> \u00a0| \u00a04 | tushar1 \u00a0 \u00a0|\n>> \u00a0| \u00a05 | tushar2 \u00a0 \u00a0|\n>> \u00a0| \u00a06 | tushar2 \u00a0 \u00a0|\n>> \u00a0| \u00a07 | tushar2 \u00a0 \u00a0|\n>> \u00a0+----+------------+\n>> \u00a07 rows in set (0.00 sec)\n>>\n>> \u00a0--Cause of this bug\n>> \u00a0This code set project_id to request object from uri\n>> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n>>\n>> \u00a0Then this code set the project_id to context object\n>> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554\n>>\n>> To manage notifications about this bug go to:\n>> https://bugs.launchpad.net/nova/+bug/904072/+subscriptions\n>\n> --\n> You received this bug notification because you are subscribed to the bug\n> report.\n> https://bugs.launchpad.net/bugs/904072\n>\n> Title:\n> \u00a0project_id could be overwritten to any value by URI value\n>\n> Status in OpenStack Compute (Nova):\n> \u00a0Confirmed\n>\n> Bug description:\n> \u00a0project_id could be overwritten to any value by URI value.\n> \u00a0User can create server on any project (even if it is not exist)\n> \u00a0Quota function will not be working because of this bug. (So This bug is a security vulnerability)\n>\n> \u00a0--Test condition\n> \u00a0user : demo (not admin)\n> \u00a0project_id: 2\n>\n> \u00a0-- Requeest\n> \u00a0stack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers \u00a0<-- invalid tenant_id\n>\n> \u00a0-- Response\n> \u00a0{\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$\n>\n> \u00a0-- DB result\n> \u00a0instance with project_id \"tushar2\" is created\n>\n> \u00a0mysql> select id,project_id from instances;\n> \u00a0+----+------------+\n> \u00a0| id | project_id |\n> \u00a0+----+------------+\n> \u00a0| \u00a01 | demo5 \u00a0 \u00a0 \u00a0|\n> \u00a0| \u00a02 | demo5 \u00a0 \u00a0 \u00a0|\n> \u00a0| \u00a03 | tushar \u00a0 \u00a0 |\n> \u00a0| \u00a04 | tushar1 \u00a0 \u00a0|\n> \u00a0| \u00a05 | tushar2 \u00a0 \u00a0|\n> \u00a0| \u00a06 | tushar2 \u00a0 \u00a0|\n> \u00a0| \u00a07 | tushar2 \u00a0 \u00a0|\n> \u00a0+----+------------+\n> \u00a07 rows in set (0.00 sec)\n>\n> \u00a0--Cause of this bug\n> \u00a0This code set project_id to request object from uri\n> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n>\n> \u00a0Then this code set the project_id to context object\n> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554\n>\n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/904072/+subscriptions\n", 
            "date_created": "2011-12-17 01:11:51+00:00", 
            "author": "https://api.launchpad.net/1.0/~nati-ueno"
        }, 
        {
            "content": "\nOn Dec 16, 2011, at 5:11 PM, Nachi Ueno wrote:\n\n> Hi All\n> \n>> ttx\n> I'm ok to not disclosing this in the next two\n> weeks. Me, Rohit and Ravi found this bug.\n> \n>> Vish\n> Thank you for your patch.\n> I have one question. Why we still set project_id from URL?\n\nWe don't.\n\nIt raises an exception if project_id in the url doesn't match project_id in the context.  I think this is the right behavior.\n\n> \n> Cheers\n> Nati\n> \n> 2011/12/16 Vish Ishaya <email address hidden>:\n>> Comments below\n>> \n>> On Dec 16, 2011, at 1:30 PM, anotherjesse wrote:\n>> \n>>> ttx\n>>> \n>>> 1) you still need to be authenticated.  The keystone middleware doesn't\n>>> let the request hit the router if you fail to auth.\n>>> \n>>> 2) you can issue any openstack api request against any tenant.\n>>> \n>>> Because most logic in the API uses the context (not the URL) to specify\n>>> the resources you are interacting with (for example list servers uses\n>>> the tenant from the context)\n>>> \n>>>        instance_list = self.compute_api.get_all(context,\n>>>                                                 search_opts=search_opts)\n>>> \n>>> https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/servers.py#L145\n>>> \n>>> So you can create a server in another project but delete, list, show\n>>> (and most other api calls) will not be able to modify it by via the api.\n>>> This is because the way that the database layer is written is defensive\n>>> - it only lets you access data that your context says you have access\n>>> to.\n>>> \n>>> This is still bad in that it allows creation of resources outside of\n>>> your project (for quota/billing avoidance) and there could be more\n>>> tunnels.\n>> \n>> I believe this is incorrect.  The broken code actually sets context.project_id = to whatever was in the url, so I think you can list and terminate instances in other projects as well.\n>>> \n>>> 3) only affects if you are the openstack api using keystone (not\n>>> deprecated auth)\n>>> \n>>> It shouldn't affect people who use the default (which is nova's internal\n>>> legacy auth) or who use the ec2 api\n>> \n>> legacy auth is also broken afaik, because it will successfully authenticate and then the authentication will be overwritten by the url.  EC2 auth shouldn't be affected.\n>>> \n>>> --\n>>> You received this bug notification because you are a member of Nova\n>>> Core, which is subscribed to the bug report.\n>>> https://bugs.launchpad.net/bugs/904072\n>>> \n>>> Title:\n>>>  project_id could be overwritten to any value by URI value\n>>> \n>>> Status in OpenStack Compute (Nova):\n>>>  Confirmed\n>>> \n>>> Bug description:\n>>>  project_id could be overwritten to any value by URI value.\n>>>  User can create server on any project (even if it is not exist)\n>>>  Quota function will not be working because of this bug. (So This bug is a security vulnerability)\n>>> \n>>>  --Test condition\n>>>  user : demo (not admin)\n>>>  project_id: 2\n>>> \n>>>  -- Requeest\n>>>  stack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers  <-- invalid tenant_id\n>>> \n>>>  -- Response\n>>>  {\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$\n>>> \n>>>  -- DB result\n>>>  instance with project_id \"tushar2\" is created\n>>> \n>>>  mysql> select id,project_id from instances;\n>>>  +----+------------+\n>>>  | id | project_id |\n>>>  +----+------------+\n>>>  |  1 | demo5      |\n>>>  |  2 | demo5      |\n>>>  |  3 | tushar     |\n>>>  |  4 | tushar1    |\n>>>  |  5 | tushar2    |\n>>>  |  6 | tushar2    |\n>>>  |  7 | tushar2    |\n>>>  +----+------------+\n>>>  7 rows in set (0.00 sec)\n>>> \n>>>  --Cause of this bug\n>>>  This code set project_id to request object from uri\n>>>  https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n>>> \n>>>  Then this code set the project_id to context object\n>>>  https://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554\n>>> \n>>> To manage notifications about this bug go to:\n>>> https://bugs.launchpad.net/nova/+bug/904072/+subscriptions\n>> \n>> --\n>> You received this bug notification because you are subscribed to the bug\n>> report.\n>> https://bugs.launchpad.net/bugs/904072\n>> \n>> Title:\n>>  project_id could be overwritten to any value by URI value\n>> \n>> Status in OpenStack Compute (Nova):\n>>  Confirmed\n>> \n>> Bug description:\n>>  project_id could be overwritten to any value by URI value.\n>>  User can create server on any project (even if it is not exist)\n>>  Quota function will not be working because of this bug. (So This bug is a security vulnerability)\n>> \n>>  --Test condition\n>>  user : demo (not admin)\n>>  project_id: 2\n>> \n>>  -- Requeest\n>>  stack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers  <-- invalid tenant_id\n>> \n>>  -- Response\n>>  {\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$\n>> \n>>  -- DB result\n>>  instance with project_id \"tushar2\" is created\n>> \n>>  mysql> select id,project_id from instances;\n>>  +----+------------+\n>>  | id | project_id |\n>>  +----+------------+\n>>  |  1 | demo5      |\n>>  |  2 | demo5      |\n>>  |  3 | tushar     |\n>>  |  4 | tushar1    |\n>>  |  5 | tushar2    |\n>>  |  6 | tushar2    |\n>>  |  7 | tushar2    |\n>>  +----+------------+\n>>  7 rows in set (0.00 sec)\n>> \n>>  --Cause of this bug\n>>  This code set project_id to request object from uri\n>>  https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n>> \n>>  Then this code set the project_id to context object\n>>  https://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554\n>> \n>> To manage notifications about this bug go to:\n>> https://bugs.launchpad.net/nova/+bug/904072/+subscriptions\n> \n> -- \n> You received this bug notification because you are a member of Nova\n> Core, which is subscribed to the bug report.\n> https://bugs.launchpad.net/bugs/904072\n> \n> Title:\n>  project_id could be overwritten to any value by URI value\n> \n> Status in OpenStack Compute (Nova):\n>  Confirmed\n> \n> Bug description:\n>  project_id could be overwritten to any value by URI value.\n>  User can create server on any project (even if it is not exist) \n>  Quota function will not be working because of this bug. (So This bug is a security vulnerability)\n> \n>  --Test condition\n>  user : demo (not admin)\n>  project_id: 2 \n> \n>  -- Requeest\n>  stack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers  <-- invalid tenant_id\n> \n>  -- Response\n>  {\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$ \n> \n>  -- DB result\n>  instance with project_id \"tushar2\" is created\n> \n>  mysql> select id,project_id from instances;\n>  +----+------------+\n>  | id | project_id |\n>  +----+------------+\n>  |  1 | demo5      |\n>  |  2 | demo5      |\n>  |  3 | tushar     |\n>  |  4 | tushar1    |\n>  |  5 | tushar2    |\n>  |  6 | tushar2    |\n>  |  7 | tushar2    |\n>  +----+------------+\n>  7 rows in set (0.00 sec)\n> \n>  --Cause of this bug\n>  This code set project_id to request object from uri\n>  https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n> \n>  Then this code set the project_id to context object\n>  https://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/904072/+subscriptions\n\n", 
            "date_created": "2011-12-17 22:15:51+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Hi Vish\n\nSorry, I misread your patch. It is right behavior.\n\n2011/12/17 Vish Ishaya <email address hidden>:\n> On Dec 16, 2011, at 5:11 PM, Nachi Ueno wrote:\n>\n>> Hi All\n>>\n>>> ttx\n>> I'm ok to not disclHosing this in the next two\n>> weeks. Me, Rohit and Ravi found this bug.\n>>\n>>> Vish\n>> Thank you for your patch.\n>> I have one question. Why we still set project_id from URL?\n>\n> We don't.\n>\n> It raises an exception if project_id in the url doesn't match project_id\n> in the context. \u00a0I think this is the right behavior.\n>\n>>\n>> Cheers\n>> Nati\n>>\n>> 2011/12/16 Vish Ishaya <email address hidden>:\n>>> Comments below\n>>>\n>>> On Dec 16, 2011, at 1:30 PM, anotherjesse wrote:\n>>>\n>>>> ttx\n>>>>\n>>>> 1) you still need to be authenticated. \u00a0The keystone middleware doesn't\n>>>> let the request hit the router if you fail to auth.\n>>>>\n>>>> 2) you can issue any openstack api request against any tenant.\n>>>>\n>>>> Because most logic in the API uses the context (not the URL) to specify\n>>>> the resources you are interacting with (for example list servers uses\n>>>> the tenant from the context)\n>>>>\n>>>> \u00a0 \u00a0 \u00a0 \u00a0instance_list = self.compute_api.get_all(context,\n>>>> \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 search_opts=search_opts)\n>>>>\n>>>> https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/servers.py#L145\n>>>>\n>>>> So you can create a server in another project but delete, list, show\n>>>> (and most other api calls) will not be able to modify it by via the api.\n>>>> This is because the way that the database layer is written is defensive\n>>>> - it only lets you access data that your context says you have access\n>>>> to.\n>>>>\n>>>> This is still bad in that it allows creation of resources outside of\n>>>> your project (for quota/billing avoidance) and there could be more\n>>>> tunnels.\n>>>\n>>> I believe this is incorrect. \u00a0The broken code actually sets context.project_id = to whatever was in the url, so I think you can list and terminate instances in other projects as well.\n>>>>\n>>>> 3) only affects if you are the openstack api using keystone (not\n>>>> deprecated auth)\n>>>>\n>>>> It shouldn't affect people who use the default (which is nova's internal\n>>>> legacy auth) or who use the ec2 api\n>>>\n>>> legacy auth is also broken afaik, because it will successfully authenticate and then the authentication will be overwritten by the url. \u00a0EC2 auth shouldn't be affected.\n>>>>\n>>>> --\n>>>> You received this bug notification because you are a member of Nova\n>>>> Core, which is subscribed to the bug report.\n>>>> https://bugs.launchpad.net/bugs/904072\n>>>>\n>>>> Title:\n>>>> \u00a0project_id could be overwritten to any value by URI value\n>>>>\n>>>> Status in OpenStack Compute (Nova):\n>>>> \u00a0Confirmed\n>>>>\n>>>> Bug description:\n>>>> \u00a0project_id could be overwritten to any value by URI value.\n>>>> \u00a0User can create server on any project (even if it is not exist)\n>>>> \u00a0Quota function will not be working because of this bug. (So This bug is a security vulnerability)\n>>>>\n>>>> \u00a0--Test condition\n>>>> \u00a0user : demo (not admin)\n>>>> \u00a0project_id: 2\n>>>>\n>>>> \u00a0-- Requeest\n>>>> \u00a0stack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers \u00a0<-- invalid tenant_id\n>>>>\n>>>> \u00a0-- Response\n>>>> \u00a0{\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$\n>>>>\n>>>> \u00a0-- DB result\n>>>> \u00a0instance with project_id \"tushar2\" is created\n>>>>\n>>>> \u00a0mysql> select id,project_id from instances;\n>>>> \u00a0+----+------------+\n>>>> \u00a0| id | project_id |\n>>>> \u00a0+----+------------+\n>>>> \u00a0| \u00a01 | demo5 \u00a0 \u00a0 \u00a0|\n>>>> \u00a0| \u00a02 | demo5 \u00a0 \u00a0 \u00a0|\n>>>> \u00a0| \u00a03 | tushar \u00a0 \u00a0 |\n>>>> \u00a0| \u00a04 | tushar1 \u00a0 \u00a0|\n>>>> \u00a0| \u00a05 | tushar2 \u00a0 \u00a0|\n>>>> \u00a0| \u00a06 | tushar2 \u00a0 \u00a0|\n>>>> \u00a0| \u00a07 | tushar2 \u00a0 \u00a0|\n>>>> \u00a0+----+------------+\n>>>> \u00a07 rows in set (0.00 sec)\n>>>>\n>>>> \u00a0--Cause of this bug\n>>>> \u00a0This code set project_id to request object from uri\n>>>> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n>>>>\n>>>> \u00a0Then this code set the project_id to context object\n>>>> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554\n>>>>\n>>>> To manage notifications about this bug go to:\n>>>> https://bugs.launchpad.net/nova/+bug/904072/+subscriptions\n>>>\n>>> --\n>>> You received this bug notification because you are subscribed to the bug\n>>> report.\n>>> https://bugs.launchpad.net/bugs/904072\n>>>\n>>> Title:\n>>> \u00a0project_id could be overwritten to any value by URI value\n>>>\n>>> Status in OpenStack Compute (Nova):\n>>> \u00a0Confirmed\n>>>\n>>> Bug description:\n>>> \u00a0project_id could be overwritten to any value by URI value.\n>>> \u00a0User can create server on any project (even if it is not exist)\n>>> \u00a0Quota function will not be working because of this bug. (So This bug is a security vulnerability)\n>>>\n>>> \u00a0--Test condition\n>>> \u00a0user : demo (not admin)\n>>> \u00a0project_id: 2\n>>>\n>>> \u00a0-- Requeest\n>>> \u00a0stack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers \u00a0<-- invalid tenant_id\n>>>\n>>> \u00a0-- Response\n>>> \u00a0{\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$\n>>>\n>>> \u00a0-- DB result\n>>> \u00a0instance with project_id \"tushar2\" is created\n>>>\n>>> \u00a0mysql> select id,project_id from instances;\n>>> \u00a0+----+------------+\n>>> \u00a0| id | project_id |\n>>> \u00a0+----+------------+\n>>> \u00a0| \u00a01 | demo5 \u00a0 \u00a0 \u00a0|\n>>> \u00a0| \u00a02 | demo5 \u00a0 \u00a0 \u00a0|\n>>> \u00a0| \u00a03 | tushar \u00a0 \u00a0 |\n>>> \u00a0| \u00a04 | tushar1 \u00a0 \u00a0|\n>>> \u00a0| \u00a05 | tushar2 \u00a0 \u00a0|\n>>> \u00a0| \u00a06 | tushar2 \u00a0 \u00a0|\n>>> \u00a0| \u00a07 | tushar2 \u00a0 \u00a0|\n>>> \u00a0+----+------------+\n>>> \u00a07 rows in set (0.00 sec)\n>>>\n>>> \u00a0--Cause of this bug\n>>> \u00a0This code set project_id to request object from uri\n>>> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n>>>\n>>> \u00a0Then this code set the project_id to context object\n>>> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554\n>>>\n>>> To manage notifications about this bug go to:\n>>> https://bugs.launchpad.net/nova/+bug/904072/+subscriptions\n>>\n>> --\n>> You received this bug notification because you are a member of Nova\n>> Core, which is subscribed to the bug report.\n>> https://bugs.launchpad.net/bugs/904072\n>>\n>> Title:\n>> \u00a0project_id could be overwritten to any value by URI value\n>>\n>> Status in OpenStack Compute (Nova):\n>> \u00a0Confirmed\n>>\n>> Bug description:\n>> \u00a0project_id could be overwritten to any value by URI value.\n>> \u00a0User can create server on any project (even if it is not exist)\n>> \u00a0Quota function will not be working because of this bug. (So This bug is a security vulnerability)\n>>\n>> \u00a0--Test condition\n>> \u00a0user : demo (not admin)\n>> \u00a0project_id: 2\n>>\n>> \u00a0-- Requeest\n>> \u00a0stack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers \u00a0<-- invalid tenant_id\n>>\n>> \u00a0-- Response\n>> \u00a0{\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$\n>>\n>> \u00a0-- DB result\n>> \u00a0instance with project_id \"tushar2\" is created\n>>\n>> \u00a0mysql> select id,project_id from instances;\n>> \u00a0+----+------------+\n>> \u00a0| id | project_id |\n>> \u00a0+----+------------+\n>> \u00a0| \u00a01 | demo5 \u00a0 \u00a0 \u00a0|\n>> \u00a0| \u00a02 | demo5 \u00a0 \u00a0 \u00a0|\n>> \u00a0| \u00a03 | tushar \u00a0 \u00a0 |\n>> \u00a0| \u00a04 | tushar1 \u00a0 \u00a0|\n>> \u00a0| \u00a05 | tushar2 \u00a0 \u00a0|\n>> \u00a0| \u00a06 | tushar2 \u00a0 \u00a0|\n>> \u00a0| \u00a07 | tushar2 \u00a0 \u00a0|\n>> \u00a0+----+------------+\n>> \u00a07 rows in set (0.00 sec)\n>>\n>> \u00a0--Cause of this bug\n>> \u00a0This code set project_id to request object from uri\n>> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n>>\n>> \u00a0Then this code set the project_id to context object\n>> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554\n>>\n>> To manage notifications about this bug go to:\n>> https://bugs.launchpad.net/nova/+bug/904072/+subscriptions\n>\n> --\n> You received this bug notification because you are subscribed to the bug\n> report.\n> https://bugs.launchpad.net/bugs/904072\n>\n> Title:\n> \u00a0project_id could be overwritten to any value by URI value\n>\n> Status in OpenStack Compute (Nova):\n> \u00a0Confirmed\n>\n> Bug description:\n> \u00a0project_id could be overwritten to any value by URI value.\n> \u00a0User can create server on any project (even if it is not exist)\n> \u00a0Quota function will not be working because of this bug. (So This bug is a security vulnerability)\n>\n> \u00a0--Test condition\n> \u00a0user : demo (not admin)\n> \u00a0project_id: 2\n>\n> \u00a0-- Requeest\n> \u00a0stack@freecloud116:~/devstack$ curl -H \"Content-type: application/json\" -H \"x-auth-token: 8bbdb554-a671-446e-a6c2-07326eeb9ad5\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"1\", \"name\": \"test5\", \"imageRef\": \"2\", \"max_count\": 1}}' http://localhost:8774/v1.1/tushar2/servers \u00a0<-- invalid tenant_id\n>\n> \u00a0-- Response\n> \u00a0{\"server\": {\"status\": \"BUILD\", \"updated\": \"2011-12-14T03:06:04Z\", \"hostId\": \"\", \"user_id\": \"demo\", \"name\": \"test5\", \"links\": [{\"href\": \"http://localhost:8774/v1.1/tushar2/servers/7\", \"rel\": \"self\"}, {\"href\": \"http://localhost:8774/tushar2/servers/7\", \"rel\": \"bookmark\"}], \"addresses\": {}, \"tenant_id\": \"tushar2\", \"image\": {\"id\": \"2\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/images/2\", \"rel\": \"bookmark\"}]}, \"created\": \"2011-12-14T03:06:04Z\", \"uuid\": \"5b63c965-8966-4ebc-ae1b-1c1c551a044c\", \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"key_name\": null, \"adminPass\": \"id8SngCb7xeRq67K\", \"progress\": 0, \"flavor\": {\"id\": \"1\", \"links\": [{\"href\": \"http://localhost:8774/tushar2/flavors/1\", \"rel\": \"bookmark\"}]}, \"config_drive\": \"\", \"id\": 7, \"metadata\": {}}}stack@freecloud116:~/devstack$\n>\n> \u00a0-- DB result\n> \u00a0instance with project_id \"tushar2\" is created\n>\n> \u00a0mysql> select id,project_id from instances;\n> \u00a0+----+------------+\n> \u00a0| id | project_id |\n> \u00a0+----+------------+\n> \u00a0| \u00a01 | demo5 \u00a0 \u00a0 \u00a0|\n> \u00a0| \u00a02 | demo5 \u00a0 \u00a0 \u00a0|\n> \u00a0| \u00a03 | tushar \u00a0 \u00a0 |\n> \u00a0| \u00a04 | tushar1 \u00a0 \u00a0|\n> \u00a0| \u00a05 | tushar2 \u00a0 \u00a0|\n> \u00a0| \u00a06 | tushar2 \u00a0 \u00a0|\n> \u00a0| \u00a07 | tushar2 \u00a0 \u00a0|\n> \u00a0+----+------------+\n> \u00a07 rows in set (0.00 sec)\n>\n> \u00a0--Cause of this bug\n> \u00a0This code set project_id to request object from uri\n> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/v2/__init__.py#L78\n>\n> \u00a0Then this code set the project_id to context object\n> \u00a0https://github.com/openstack/nova/blob/master/nova/api/openstack/wsgi.py#L554\n>\n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/904072/+subscriptions\n", 
            "date_created": "2011-12-17 23:19:27+00:00", 
            "author": "https://api.launchpad.net/1.0/~nati-ueno"
        }, 
        {
            "content": "OK, we'll start coordinating fix and disclosure starting January 3rd.\n\n@Nachi: do you want credit to go to \"Nachi Ueno, Rohit Karajgi and Ravi (add last name here)\" or to some specific lab or entity (\"Researchers at NTT DATA\") or both (\"Nachi Ueno, Rohit Karajgi and Ravi (add last name here) from NTT DATA\") ?\n\n@Jesse/Vish/Everyone, please confirm proposed impact statement:\n\n\"$CREDIT discovered a vulnerability in Nova API nodes handling of incoming requests. An authenticated user may craft malicious commands to affect resources on tenants he is not a member of, potentially leading to incorrect billing, quota escaping or compromise of computing resources created by a third-party. Only setups allowing the OpenStack API are affected.\"", 
            "date_created": "2011-12-19 14:44:37.014584+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "impact statement looks good.  I will have to fix up the test fixes as well when this is ready to go in.  The patch itself is small, so maybe I will put together a check to turn it off for the tests, then I can remove the check and fix all the tessts in a subsequent patch.", 
            "date_created": "2012-01-03 20:37:03.533129+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Nachi says credit should go to \"Nachi Ueno from NTT PF lab, Rohit Karajgi from Vertex and Venkatesan Ravikumar from HP\"", 
            "date_created": "2012-01-04 13:14:21.513993+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "I'm split, I fear we'll have to communicate the testfix.patch downstream as well, even if it makes a bit of a giant patch. Separating them should make it quite clear that the fix is simple.\n\n@Vish: could you attach updated patches (fix.patch + testfix.patch) that I can use in the downstream announcement ?\n", 
            "date_created": "2012-01-04 13:46:08.358217+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Here is the vuln patch", 
            "date_created": "2012-01-04 22:00:50.549050+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "This patch removes the testing workaround and fixes all of the tests.", 
            "date_created": "2012-01-04 22:22:55.459717+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Message sent to downstream, embargo set to Wednesday, January 11, 2012, 1500UTC", 
            "date_created": "2012-01-05 11:23:00.581721+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Adding Dave Walker for diablo/stable coordination. Markmc should have access through nova-core already.", 
            "date_created": "2012-01-05 12:39:57.556455+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Adding ubuntu-security to help them coordinate disclosure.", 
            "date_created": "2012-01-05 12:46:09.231694+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Are the patches in comment #18 and #19 considered official and blessed by upstream?", 
            "date_created": "2012-01-05 13:56:07.977241+00:00", 
            "author": "https://api.launchpad.net/1.0/~jdstrand"
        }, 
        {
            "content": "@Jamie: Yes, those are the ones we included in the \"downstream stakeholders\" post to <email address hidden> you should have received.", 
            "date_created": "2012-01-05 14:11:34.254684+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "FYI, the testfix patch is not likely to apply cleanly to stable/diablo or any other branch.  The first patch should apply cleanly though. We need to either:\na) be ok with the workaround to keep tests working in the first patch\nor\nb) do some backporting to fix the tests\n\n", 
            "date_created": "2012-01-05 18:20:21.524170+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I took a crack at doing the backport, but need help. I sent this to <email address hidden>:\n\n\"nova 2011.3 needs a slightly different patch for the vulnerability.\nSpecifically, nova/api/openstack/wsgi.py needs to use 'return\nfaults.Fault(...)' instead of 'return Fault(...)'. I've attached this.\n\nThe testsuite proved more problematic for me. I was able to get it down\nto 7 failures (one in test_quotas.py and 6 in test_servers.py). Attached\nis a preliminary patch for 2011.3 that I created. It would be great if\nsomeone upstream could verify what I've done (especially the changes to\ntest_quotas.py and test_servers.py) and fix the remaining testsuite\nfailures.\"\n\nI also privately corresponded with Mark McLoughlin, so he may or may not be looking into. Attaching the preliminary patches here for completeness.", 
            "date_created": "2012-01-05 20:03:04.990511+00:00", 
            "author": "https://api.launchpad.net/1.0/~jdstrand"
        }, 
        {
            "content": "", 
            "date_created": "2012-01-05 20:03:28.268856+00:00", 
            "author": "https://api.launchpad.net/1.0/~jdstrand"
        }, 
        {
            "content": "This has been assigned CVE-2012-0030.", 
            "date_created": "2012-01-06 14:32:26.915383+00:00", 
            "author": "https://api.launchpad.net/1.0/~jdstrand"
        }, 
        {
            "content": "Vish's patch against master needed some rebasing after Vek's \"Serialization, deserialization, and response code decorators\" commit. Nothing major.\n\nI've taken the liberty of combining the vuln/testfix patches, rebasing and adding a commit message. I've retained Vish as the author of the commit.", 
            "date_created": "2012-01-10 00:24:57.523572+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "Here's the patch backported to the stable branch.\n\nCaveat: I'm having some late night weirdness with tests failing that have nothing to do with this patch, and continuing to fail after the patch is reverted. If someone could double-check that the tests pass, that'd be great.", 
            "date_created": "2012-01-10 00:26:34.087794+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "Jamie - your patch was pretty close, actually. I started from scratch, just to be doubly sure, and ended up with an identical patch apart from fixes for the test failures you mentioned. The attached diff compares yours to mine.", 
            "date_created": "2012-01-10 00:30:07.774240+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "Thanks Mark! This patch works great against Ubuntu's 2011.3 in 11.10 (adjusting for some fuzz and removing two test functions that didn't exist in our ealier version) and the testsuite passes here just fine.  Thanks again for your help. :)", 
            "date_created": "2012-01-10 09:54:11.117952+00:00", 
            "author": "https://api.launchpad.net/1.0/~jdstrand"
        }, 
        {
            "content": "This looks fine to me, fwiw.", 
            "date_created": "2012-01-11 13:35:06.208640+00:00", 
            "author": "https://api.launchpad.net/1.0/~soren"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/2960", 
            "date_created": "2012-01-11 14:59:32.997061+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/diablo\nReview: https://review.openstack.org/2961", 
            "date_created": "2012-01-11 15:02:51.078079+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2960\nCommitted: http://github.com/openstack/nova/commit/c9c09bd60e7a0e0258d218a31d7878755bea1395\nSubmitter: Jenkins\nBranch:    master\n\ncommit c9c09bd60e7a0e0258d218a31d7878755bea1395\nAuthor: Thierry Carrez <email address hidden>\nDate:   Wed Jan 11 13:48:29 2012 +0100\n\n    Do not overwrite project_id from request params\n    \n    Prevent project_id overwriting from OSAPI request parameters.\n    The patch is actually very simple (nova/api/openstack/wsgi.py) but\n    needs significant test adjustments (nova/tests/*) to pass.\n    \n    Fixes bug 904072. Patch from Vish Ishaya and Mark McLoughlin.\n    \n    Change-Id: I66ea0f178ce6271ec1020e9f1a73bd4e8c83ddab\n", 
            "date_created": "2012-01-11 15:11:36.488063+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fyi, per Thierry's go ahead, I pushed updates to Ubuntu 11.10 and 12.04.", 
            "date_created": "2012-01-11 15:29:29.247462+00:00", 
            "author": "https://api.launchpad.net/1.0/~jdstrand"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2961\nCommitted: http://github.com/openstack/nova/commit/3d4ffb64f1e18117240c26809788528979e3bd15\nSubmitter: Jenkins\nBranch:    stable/diablo\n\ncommit 3d4ffb64f1e18117240c26809788528979e3bd15\nAuthor: Thierry Carrez <email address hidden>\nDate:   Wed Jan 11 13:48:29 2012 +0100\n\n    Do not overwrite project_id from request params\n    \n    Prevent project_id overwriting from OSAPI request parameters.\n    The patch is actually very simple (nova/api/openstack/wsgi.py) but\n    needs significant test adjustments (nova/tests/*) to pass.\n    \n    Fixes bug 904072. Patch from Vish Ishaya and Mark McLoughlin.\n    \n    (cherry picked from commit c9c09bd60e7a0e0258d218a31d7878755bea1395)\n    \n    Change-Id: I66ea0f178ce6271ec1020e9f1a73bd4e8c83ddab\n", 
            "date_created": "2012-01-11 15:45:18.806482+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Published as OSSA 2012-001\nhttps://lists.launchpad.net/openstack/msg06648.html", 
            "date_created": "2012-01-11 15:54:22.712375+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Rejecting from oneiric-proposed. It's a security update and should go via -security.", 
            "date_created": "2012-01-13 17:05:31.274312+00:00", 
            "author": "https://api.launchpad.net/1.0/~pitti"
        }
    ]
}