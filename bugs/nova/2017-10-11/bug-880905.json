{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:37:31.063962+00:00", 
    "description": "Recently, run_tests.sh inside of a virtualenv stopped working on my setup (lucid). With git bisect, I traced it down to this commit:\n\ncommit 7eeee584ad64b5a76c029641243a8fca2c875772\nAuthor: Mark McLoughlin <email address hidden>\nDate:   Thu Sep 29 15:06:54 2011 +0100\n\n\u00a0\u00a0\u00a0\u00a0install_venv: don't use --no-site-packages with virtualenv\n\n\u00a0\u00a0\u00a0\u00a0libvirt isn't listed in pip-requires because (a) it's not in PyPi and\n\u00a0\u00a0\u00a0\u00a0(b) you always want to use libvirt's python bindings that matches the\n\u00a0\u00a0\u00a0\u00a0version of libvirt installed on the system.\n\n\u00a0\u00a0\u00a0\u00a0Currently, running nova-compute in virtualenv fails because libvirt\n\u00a0\u00a0\u00a0\u00a0can't be imported. The --no-site-packages flag is what prevents this.\n\u00a0\u00a0\u00a0\u00a0Everything seems to work fine without it. To verify, try deleting the\n\u00a0\u00a0\u00a0\u00a0no-global-site-packages.txt from your .nova-venv.\n\n\u00a0\u00a0\u00a0\u00a0Change-Id: I1df5e8e3c4426ca333c2d6b5b4fa8ece144dddf3\n\ndiff --git a/tools/install_venv.py b/tools/install_venv.py\nindex a137f11..912d0a2 100644\n--- a/tools/install_venv.py\n+++ b/tools/install_venv.py\n@@ -89,7 +89,7 @@ def create_virtualenv(venv=VENV):\n\u00a0\u00a0\u00a0\u00a0\u00a0virtual environment\n\u00a0\u00a0\u00a0\u00a0\u00a0\"\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0print 'Creating venv...',\n-    run_command(['virtualenv', '-q', '--no-site-packages', VENV])\n+    run_command(['virtualenv', '-q', VENV])\n\u00a0\u00a0\u00a0\u00a0\u00a0print 'done.'\n\u00a0\u00a0\u00a0\u00a0\u00a0print 'Installing pip in virtualenv...',\n\u00a0\u00a0\u00a0\u00a0\u00a0if not run_command(['tools/with_venv.sh', 'easy_install', 'pip']).strip():\n\nSince it's related to --no-site-packages, it's probably interfering with some package setup on my machine, but I'm not sure what packages are interfering.\n\nHere's the error message for the package that's failing (glance). The full output is attached.\n\n$ ./run_tests.sh -f -V\nCleaning virtualenv...\ndone.\nCreating venv... done.\nInstalling pip in virtualenv... done.\nInstalling dependencies with pip (this can take a while)...\n...\n\u00a0\u00a0Running setup.py install for glance\n\u00a0\u00a0\u00a0\u00a0ERROR: Python module kombu.connection not found\n\u00a0\u00a0\u00a0\u00a0ERROR: Python module swift.common.client not found\n\u00a0\u00a0\u00a0\u00a0ERROR: Python module xattr not found\n\u00a0\u00a0\u00a0\u00a0usage: -c [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0or: -c --help [cmd1 cmd2 ...]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0or: -c --help-commands\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0or: -c cmd --help\n\n\u00a0\u00a0\u00a0\u00a0error: option --single-version-externally-managed not recognized\n\u00a0\u00a0\u00a0\u00a0Complete output from command /home/lorin/nova/.nova-venv/bin/python -c \"import setuptools;__file__='/home/lorin/nova/.nova-venv/build/glance/setup.py';execfile(__file__)\" install --single-version-externally-managed --record /tmp/pip-Xcyxmf-record/install-record.txt --install-headers /home/lorin/nova/.nova-venv/include/site/python2.6:\n\u00a0\u00a0\u00a0\u00a0ERROR: Python module kombu.connection not found\n\nERROR: Python module swift.common.client not found\n\nERROR: Python module xattr not found\n\nusage: -c [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]\n\n\u00a0\u00a0\u00a0or: -c --help [cmd1 cmd2 ...]\n\n\u00a0\u00a0\u00a0or: -c --help-commands\n\n\u00a0\u00a0\u00a0or: -c cmd --help\n\nerror: option --single-version-externally-managed not recognized\n\n----------------------------------------\nCommand /home/lorin/nova/.nova-venv/bin/python -c \"import setuptools;__file__='/home/lorin/nova/.nova-venv/build/glance/setup.py';execfile(__file__)\" install --single-version-externally-managed --record /tmp/pip-Xcyxmf-record/install-record.txt --install-headers /home/lorin/nova/.nova-venv/include/site/python2.6 failed with error code 1\nStoring complete log in /home/lorin/.pip/pip.log\nCommand \"tools/with_venv.sh pip install --upgrade -r /home/lorin/nova/tools/pip-requires\" failed.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/880905", 
    "owner": "https://api.launchpad.net/1.0/~lorinh", 
    "id": 880905, 
    "index": 2325, 
    "created": "2011-10-24 14:57:56.217642+00:00", 
    "title": "run_tests fails in venv on my setup (lucid)", 
    "comments": [
        {
            "content": "Recently, run_tests.sh inside of a virtualenv stopped working on my setup (lucid). With git bisect, I traced it down to this commit:\n\n\ncommit 7eeee584ad64b5a76c029641243a8fca2c875772\nAuthor: Mark McLoughlin <email address hidden>\nDate:   Thu Sep 29 15:06:54 2011 +0100\n\n    install_venv: don't use --no-site-packages with virtualenv\n    \n    libvirt isn't listed in pip-requires because (a) it's not in PyPi and\n    (b) you always want to use libvirt's python bindings that matches the\n    version of libvirt installed on the system.\n    \n    Currently, running nova-compute in virtualenv fails because libvirt\n    can't be imported. The --no-site-packages flag is what prevents this.\n    Everything seems to work fine without it. To verify, try deleting the\n    no-global-site-packages.txt from your .nova-venv.\n    \n    Change-Id: I1df5e8e3c4426ca333c2d6b5b4fa8ece144dddf3\n\ndiff --git a/tools/install_venv.py b/tools/install_venv.py\nindex a137f11..912d0a2 100644\n--- a/tools/install_venv.py\n+++ b/tools/install_venv.py\n@@ -89,7 +89,7 @@ def create_virtualenv(venv=VENV):\n     virtual environment\n     \"\"\"\n     print 'Creating venv...',\n-    run_command(['virtualenv', '-q', '--no-site-packages', VENV])\n+    run_command(['virtualenv', '-q', VENV])\n     print 'done.'\n     print 'Installing pip in virtualenv...',\n     if not run_command(['tools/with_venv.sh', 'easy_install', 'pip']).strip():\n\nHere's the failing output. Since it's related to --no-site-packages, it's probably interfering with some package setup on my machine, but I'm not sure what packages are interfering.\n\nHere's the error message for the package that's failing (glance). The full output is attached.\n\n$ ./run_tests.sh -f -V \nCleaning virtualenv...\ndone.\nCreating venv... done.\nInstalling pip in virtualenv... done.\nInstalling dependencies with pip (this can take a while)...\n...\n  Running setup.py install for glance\n    ERROR: Python module kombu.connection not found\n    ERROR: Python module swift.common.client not found\n    ERROR: Python module xattr not found\n    usage: -c [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]\n       or: -c --help [cmd1 cmd2 ...]\n       or: -c --help-commands\n       or: -c cmd --help\n    \n    error: option --single-version-externally-managed not recognized\n    Complete output from command /home/lorin/nova/.nova-venv/bin/python -c \"import setuptools;__file__='/home/lorin/nova/.nova-venv/build/glance/setup.py';execfile(__file__)\" install --single-version-externally-managed --record /tmp/pip-Xcyxmf-record/install-record.txt --install-headers /home/lorin/nova/.nova-venv/include/site/python2.6:\n    ERROR: Python module kombu.connection not found\n\nERROR: Python module swift.common.client not found\n\nERROR: Python module xattr not found\n\nusage: -c [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]\n\n   or: -c --help [cmd1 cmd2 ...]\n\n   or: -c --help-commands\n\n   or: -c cmd --help\n\n\n\nerror: option --single-version-externally-managed not recognized\n\n----------------------------------------\nCommand /home/lorin/nova/.nova-venv/bin/python -c \"import setuptools;__file__='/home/lorin/nova/.nova-venv/build/glance/setup.py';execfile(__file__)\" install --single-version-externally-managed --record /tmp/pip-Xcyxmf-record/install-record.txt --install-headers /home/lorin/nova/.nova-venv/include/site/python2.6 failed with error code 1\nStoring complete log in /home/lorin/.pip/pip.log\nCommand \"tools/with_venv.sh pip install --upgrade -r /home/lorin/nova/tools/pip-requires\" failed.", 
            "date_created": "2011-10-24 14:57:56.217642+00:00", 
            "author": "https://api.launchpad.net/1.0/~lorinh"
        }, 
        {
            "content": "", 
            "date_created": "2011-10-24 14:57:56.217642+00:00", 
            "author": "https://api.launchpad.net/1.0/~lorinh"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/1208\nCommitted: http://github.com/openstack/nova/commit/b08bd96ce5bf290ac6198079ad2dce71e675b481\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit b08bd96ce5bf290ac6198079ad2dce71e675b481\nAuthor: Lorin Hochstein <email address hidden>\nDate:   Sun Oct 30 09:00:59 2011 -0400\n\n    Optional --no-site-packages in venv\n    \n    Added a flag to run_tests.sh to allow user to optionally install venv with --no-site-packages.\n    \n    This fixes bug 880905\n    \n    Change-Id: Ic645e0ec56c90b72fef526ebc9f55975d446e2ae\n", 
            "date_created": "2011-11-08 16:59:21+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }
    ]
}