{
    "status": "Fix Released", 
    "last_updated": "2017-06-16 12:18:42.948326+00:00", 
    "description": "After evacuate an instance to a new host successfully, then start the old host's nova-compute, bug the old instance not be destroyed as expected.\nSee following code:\nhttps://github.com/openstack/nova/blob/stable/liberty/nova/compute/manager.py#L817\nnova-compute read migration record from db to get the evacuated instance and then destroy it.  It filters migration with status 'accepted'. \nhttps://github.com/openstack/nova/blob/stable/liberty/nova/compute/manager.py#L2715\nAfter successfully evacuate instance, status of migration will change to 'done' from 'accepted' \nSo, I think we should modify 'accepted' to 'done' when filter migration record.", 
    "tags": [
        "compute", 
        "evacuate", 
        "in-stable-liberty", 
        "rebuild"
    ], 
    "importance": "Medium", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1518200", 
    "owner": "https://api.launchpad.net/1.0/~dbcocle", 
    "id": 1518200, 
    "index": 4387, 
    "created": "2015-11-20 07:48:15.107368+00:00", 
    "title": "instance is not destroyed on source host after a successful evacuate", 
    "comments": [
        {
            "content": "After evacuate an instance to a new host successfully, then start the old host's nova-compute, bug the old instance not be destroyed as expected.\nSee following code:\nhttps://github.com/openstack/nova/blob/stable/liberty/nova/compute/manager.py#L817\nnova-compute read migration record from db to get the evacuated instance and then destroy it.  It filters migration with status 'accepted'. \nhttps://github.com/openstack/nova/blob/stable/liberty/nova/compute/manager.py#L2715\nAfter successfully evacuate instance, status of migration will change to 'done' from 'accepted' \nSo, I think we should modify 'accepted' to 'done' when filter migration record.", 
            "date_created": "2015-11-20 07:48:15.107368+00:00", 
            "author": "https://api.launchpad.net/1.0/~dbcocle"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/250101", 
            "date_created": "2015-11-26 01:26:48.250698+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "the solution will (probably) fix this bug: https://bugs.launchpad.net/nova/+bug/1532657", 
            "date_created": "2016-01-15 12:30:36.175338+00:00", 
            "author": "https://api.launchpad.net/1.0/~roman-dobosz"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/250101\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=a79ac83bae4e673a416cca4b86a3f47f4f25b0aa\nSubmitter: Jenkins\nBranch:    master\n\ncommit a79ac83bae4e673a416cca4b86a3f47f4f25b0aa\nAuthor: lvdongbing <email address hidden>\nDate:   Tue Dec 1 04:33:56 2015 -0500\n\n    Fix instance not destroyed after successful evacuation\n    \n    After complete evacuate action, the status of migration will change\n    to 'done' from 'accepted', so the _destroy_evacuated_instances action\n    in old nova-compute should consider the status 'done' to filter\n    migration list when they're back up.\n    \n    Closes-bug: #1518200\n    Co-Authored-By: Sylvain Bauza <email address hidden>\n    \n    Change-Id: Ie4825dcaa778d229922c963a96590ad5a2604257\n", 
            "date_created": "2016-01-16 12:54:55.093715+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/liberty\nReview: https://review.openstack.org/269185", 
            "date_created": "2016-01-18 17:01:27.893240+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/269185\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d1f371560272b1afb4236ce6a7fd156e64cae44d\nSubmitter: Jenkins\nBranch:    stable/liberty\n\ncommit d1f371560272b1afb4236ce6a7fd156e64cae44d\nAuthor: lvdongbing <email address hidden>\nDate:   Tue Dec 1 04:33:56 2015 -0500\n\n    Fix instance not destroyed after successful evacuation\n    \n    After complete evacuate action, the status of migration will change\n    to 'done' from 'accepted', so the _destroy_evacuated_instances action\n    in old nova-compute should consider the status 'done' to filter\n    migration list when they're back up.\n    \n    Closes-bug: #1518200\n    Co-Authored-By: Sylvain Bauza <email address hidden>\n    \n    Change-Id: Ie4825dcaa778d229922c963a96590ad5a2604257\n    (cherry picked from commit a79ac83bae4e673a416cca4b86a3f47f4f25b0aa)\n", 
            "date_created": "2016-02-01 21:07:34.437501+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This change raises a psycopg2.ProgrammingError with postgres and psycopg2. \n\nTraceback and Error \n==========================\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/site-packages/eventlet/hubs/poll.py\", line 115, in wait\n    listener.cb(fileno)\n  File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/usr/lib/python2.7/site-packages/oslo_service/service.py\", line 671, in run_service\n    service.start()\n  File \"/usr/lib/python2.7/site-packages/nova/service.py\", line 164, in start\n    self.manager.init_host()\n  File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 1309, in init_host\n    self._destroy_evacuated_instances(context)\n  File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 820, in _destroy_evacuated_instances\n    evacuations = objects.MigrationList.get_by_filters(context, filters)\n  File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 169, in wrapper\n    args, kwargs)\n  File \"/usr/lib/python2.7/site-packages/nova/conductor/rpcapi.py\", line 229, in object_class_action\n    args, kwargs)\n  File \"/usr/lib/python2.7/site-packages/nova/conductor/rpcapi.py\", line 237, in object_class_action_versions\n    args=args, kwargs=kwargs)\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/client.py\", line 158, in call\n    retry=self.retry)\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/transport.py\", line 90, in _send\n    timeout=timeout, retry=retry)\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 466, in send\n    retry=retry)\n  File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 457, in _send\n    raise result\nRemoteError: Remote error: DBError (psycopg2.ProgrammingError) operator does not exist: character varying = text[]\nLINE 3: ...HERE migrations.deleted = 0 AND migrations.status = ARRAY['a...\n                                                             ^\nHINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.\n [SQL: 'SELECT migrations.created_at AS migrations_created_at, migrations.updated_at AS migrations_updated_at, migrations.deleted_at AS migrations_deleted_at, migrations.deleted AS migrations_deleted, migrations.id AS migrations_id, migrations.source_compute AS migrations_source_compute, migrations.dest_compute AS migrations_dest_compute, migrations.source_node AS migrations_source_node, migrations.dest_node AS migrations_dest_node, migrations.dest_host AS migrations_dest_host, migrations.old_instance_type_id AS migrations_old_instance_type_id, migrations.new_instance_type_id AS migrations_new_instance_type_id, migrations.instance_uuid AS migrations_instance_uuid, migrations.status AS migrations_status, migrations.migration_type AS migrations_migration_type, migrations.hidden AS migrations_hidden \\nFROM migrations \\nWHERE migrations.deleted = %(deleted_1)s AND migrations.status = %(status_1)s AND migrations.source_compute = %(source_compute_1)s AND migrations.migration_type = %(migration_type_1)s'] [parameters: {'deleted_1': 0, 'migration_type_1': u'evacuation', 'source_compute_1': u'seanmccully', 'status_1': [u'accepted', u'done']}]\n[u'Traceback (most recent call last):\\n', u'  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 447, in _object_dispatch\\n    return getattr(target, method)(*args, **kwargs)\\n', u'  File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 179, in wrapper\\n    result = fn(cls, context, *args, **kwargs)\\n', u'  File \"/usr/lib/python2.7/site-packages/nova/objects/migration.py\", line 157, in get_by_filters\\n    db_migrations = db.migration_get_all_by_filters(context, filters)\\n', u'  File \"/usr/lib/python2.7/site-packages/nova/db/api.py\", line 484, in migration_get_all_by_filters\\n    return IMPL.migration_get_all_by_filters(context, filters)\\n', u'  File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 4500, in migration_get_all_by_filters\\n    return query.all()\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2588, in all\\n    return list(self)\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2736, in __iter__\\n    return self._execute_and_instances(context)\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2751, in _execute_and_instances\\n    result = conn.execute(querycontext.statement, self._params)\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 914, in execute\\n    return meth(self, multiparams, params)\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\\n    return connection._execute_clauseelement(self, multiparams, params)\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\\n    compiled_sql, distilled_params\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\\n    context)\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1337, in _handle_dbapi_exception\\n    util.raise_from_cause(newraise, exc_info)\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/util/compat.py\", line 200, in raise_from_cause\\n    reraise(type(exception), exception, tb=exc_tb)\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\\n    context)\\n', u'  File \"/usr/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\\n    cursor.execute(statement, parameters)\\n', u\"DBError: (psycopg2.ProgrammingError) operator does not exist: character varying = text[]\\nLINE 3: ...HERE migrations.deleted = 0 AND migrations.status = ARRAY['a...\\n                                                             ^\\nHINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.\\n [SQL: 'SELECT migrations.created_at AS migrations_created_at, migrations.updated_at AS migrations_updated_at, migrations.deleted_at AS migrations_deleted_at, migrations.deleted AS migrations_deleted, migrations.id AS migrations_id, migrations.source_compute AS migrations_source_compute, migrations.dest_compute AS migrations_dest_compute, migrations.source_node AS migrations_source_node, migrations.dest_node AS migrations_dest_node, migrations.dest_host AS migrations_dest_host, migrations.old_instance_type_id AS migrations_old_instance_type_id, migrations.new_instance_type_id AS migrations_new_instance_type_id, migrations.instance_uuid AS migrations_instance_uuid, migrations.status AS migrations_status, migrations.migration_type AS migrations_migration_type, migrations.hidden AS migrations_hidden \\\\nFROM migrations \\\\nWHERE migrations.deleted = %(deleted_1)s AND migrations.status = %(status_1)s AND migrations.source_compute = %(source_compute_1)s AND migrations.migration_type = %(migration_type_1)s'] [parameters: {'deleted_1': 0, 'migration_type_1': u'evacuation', 'source_compute_1': u'seanmccully', 'status_1': [u'accepted', u'done']}]\\n\"].\n==============================", 
            "date_created": "2016-02-07 05:37:16.485939+00:00", 
            "author": "https://api.launchpad.net/1.0/~sean-mccully"
        }, 
        {
            "content": "Hi Sean,\n\nI've opened a new bug based on your comment:\n\nhttps://bugs.launchpad.net/nova/+bug/1543382", 
            "date_created": "2016-02-09 01:19:51.980133+00:00", 
            "author": "https://api.launchpad.net/1.0/~melwitt"
        }
    ]
}