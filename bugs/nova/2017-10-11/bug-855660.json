{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:36:32.182246+00:00", 
    "description": "by 'sporadically' i mean roughly every-other time.\nWe have a nova cloud installed with the daily ppa:\n\u00a0\u00a0python-nova at version 2012.1~e1~20110920.1604-0ubuntu0ppa1~oneiric2\n\nWe would see:\n$ euca-describe-instances \nUnknownError: An unknown error has occurred. Please try your request again.\n\n\nWe saw the following trace in logs:\nubuntu@mabolo:~$ 2011-09-21 11:03:47,041 DEBUG nova.api [-] action: DescribeInstances from (pid=25529) __call__ /usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py:290\n2011-09-21 11:03:47,042 DEBUG nova.compute.api [-] Searching by: {'deleted': False} from (pid=25529) get_all /usr/lib/python2.7/dist-packages/nova/compute/api.py:862\n2011-09-21 11:03:47,162 ERROR nova.api [70460539-3492-4108-b805-3e73f00c0e3c 35a1d80e-ab85-42ab-81f8-7fb7e0197ccb novaproject] Unexpected error raised: Parent instance <Instance at 0x5413310> is not bound to a Session; lazy load operation of attribute 'fixed_ips' cannot proceed\n(nova.api): TRACE: Traceback (most recent call last):\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 398, in __call__\n(nova.api): TRACE:     result = api_request.invoke(context)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/apirequest.py\", line 78, in invoke\n(nova.api): TRACE:     result = method(context, **args)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/cloud.py\", line 1151, in describe_instances\n(nova.api): TRACE:     instance_id=instance_id)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/cloud.py\", line 1160, in _format_describe_instances\n(nova.api): TRACE:     return {'reservationSet': self._format_instances(context, **kwargs)}\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/cloud.py\", line 1260, in _format_instances\n(nova.api): TRACE:     if instance['fixed_ips']:\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/models.py\", line 76, in __getitem__\n(nova.api): TRACE:     return getattr(self, key)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/attributes.py\", line 168, in __get__\n(nova.api): TRACE:     instance_dict(instance))\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/attributes.py\", line 388, in get\n(nova.api): TRACE:     value = callable_(passive=passive)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/strategies.py\", line 599, in __call__\n(nova.api): TRACE:     (mapperutil.state_str(state), self.key)\n(nova.api): TRACE: DetachedInstanceError: Parent instance <Instance at 0x5413310> is not bound to a Session; lazy load operation of attribute 'fixed_ips' cannot proceed\n(nova.api): TRACE:\n2011-09-21 11:03:47,162 ERROR nova.api [70460539-3492-4108-b805-3e73f00c0e3c 35a1d80e-ab85-42ab-81f8-7fb7e0197ccb novaproject] Environment: {\"CONTENT_TYPE\": \"application/x-www-form-urlencoded; charset=UTF-8\", \"SCRIPT_NAME\": \"/services/Cloud\", \"REQUEST_METHOD\": \"POST\", \"HTTP_HOST\": \"10.55.55.5:8773\", \"PATH_INFO\": \"/\", \"SERVER_PROTOCOL\": \"HTTP/1.0\", \"HTTP_USER_AGENT\": \"Boto/2.0 (linux2)\", \"SERVER_NAME\": \"10.55.55.5\", \"REMOTE_ADDR\": \"10.55.55.5\", \"wsgi.url_scheme\": \"http\", \"SERVER_PORT\": \"8773\", \"GATEWAY_INTERFACE\": \"CGI/1.1\", \"HTTP_ACCEPT_ENCODING\": \"identity\"}\n2011-09-21 11:03:47,162 ERROR nova.api [70460539-3492-4108-b805-3e73f00c0e3c 35a1d80e-ab85-42ab-81f8-7fb7e0197ccb novaproject] UnknownError: An unknown error has occurred. Please try your request again.\n2011-09-21 11:03:47,163 INFO nova.api [70460539-3492-4108-b805-3e73f00c0e3c 35a1d80e-ab85-42ab-81f8-7fb7e0197ccb novaproject] 0.121898s 10.55.55.5 POST /services/Cloud/ CloudController:DescribeInstances 400 [Boto/2.0 (linux2)] application/x-www-form-urlencoded text/xml", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 44, 
    "link": "https://bugs.launchpad.net/nova/+bug/855660", 
    "owner": "https://api.launchpad.net/1.0/~cbehrens", 
    "id": 855660, 
    "index": 2282, 
    "created": "2011-09-21 15:42:34.492040+00:00", 
    "title": "DescribeInstances fails sporadically", 
    "comments": [
        {
            "content": "by 'sporadically' i mean roughly every-other time.\nWe have a nova cloud installed with the daily ppa:\n  python-nova at version 2012.1~e1~20110920.1604-0ubuntu0ppa1~oneiric2\n\nWe saw the following trace in logs:\nubuntu@mabolo:~$ 2011-09-21 11:03:47,041 DEBUG nova.api [-] action: DescribeInstances from (pid=25529) __call__ /usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py:290\n2011-09-21 11:03:47,042 DEBUG nova.compute.api [-] Searching by: {'deleted': False} from (pid=25529) get_all /usr/lib/python2.7/dist-packages/nova/compute/api.py:862\n2011-09-21 11:03:47,162 ERROR nova.api [70460539-3492-4108-b805-3e73f00c0e3c 35a1d80e-ab85-42ab-81f8-7fb7e0197ccb novaproject] Unexpected error raised: Parent instance <Instance at 0x5413310> is not bound to a Session; lazy load operation of attribute 'fixed_ips' cannot proceed\n(nova.api): TRACE: Traceback (most recent call last):\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 398, in __call__\n(nova.api): TRACE:     result = api_request.invoke(context)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/apirequest.py\", line 78, in invoke\n(nova.api): TRACE:     result = method(context, **args)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/cloud.py\", line 1151, in describe_instances\n(nova.api): TRACE:     instance_id=instance_id)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/cloud.py\", line 1160, in _format_describe_instances\n(nova.api): TRACE:     return {'reservationSet': self._format_instances(context, **kwargs)}\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/cloud.py\", line 1260, in _format_instances\n(nova.api): TRACE:     if instance['fixed_ips']:\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/models.py\", line 76, in __getitem__\n(nova.api): TRACE:     return getattr(self, key)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/attributes.py\", line 168, in __get__\n(nova.api): TRACE:     instance_dict(instance))\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/attributes.py\", line 388, in get\n(nova.api): TRACE:     value = callable_(passive=passive)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/strategies.py\", line 599, in __call__\n(nova.api): TRACE:     (mapperutil.state_str(state), self.key)\n(nova.api): TRACE: DetachedInstanceError: Parent instance <Instance at 0x5413310> is not bound to a Session; lazy load operation of attribute 'fixed_ips' cannot proceed\n(nova.api): TRACE:\n2011-09-21 11:03:47,162 ERROR nova.api [70460539-3492-4108-b805-3e73f00c0e3c 35a1d80e-ab85-42ab-81f8-7fb7e0197ccb novaproject] Environment: {\"CONTENT_TYPE\": \"application/x-www-form-urlencoded; charset=UTF-8\", \"SCRIPT_NAME\": \"/services/Cloud\", \"REQUEST_METHOD\": \"POST\", \"HTTP_HOST\": \"10.55.55.5:8773\", \"PATH_INFO\": \"/\", \"SERVER_PROTOCOL\": \"HTTP/1.0\", \"HTTP_USER_AGENT\": \"Boto/2.0 (linux2)\", \"SERVER_NAME\": \"10.55.55.5\", \"REMOTE_ADDR\": \"10.55.55.5\", \"wsgi.url_scheme\": \"http\", \"SERVER_PORT\": \"8773\", \"GATEWAY_INTERFACE\": \"CGI/1.1\", \"HTTP_ACCEPT_ENCODING\": \"identity\"}\n2011-09-21 11:03:47,162 ERROR nova.api [70460539-3492-4108-b805-3e73f00c0e3c 35a1d80e-ab85-42ab-81f8-7fb7e0197ccb novaproject] UnknownError: An unknown error has occurred. Please try your request again.\n2011-09-21 11:03:47,163 INFO nova.api [70460539-3492-4108-b805-3e73f00c0e3c 35a1d80e-ab85-42ab-81f8-7fb7e0197ccb novaproject] 0.121898s 10.55.55.5 POST /services/Cloud/ CloudController:DescribeInstances 400 [Boto/2.0 (linux2)] application/x-www-form-urlencoded text/xml", 
            "date_created": "2011-09-21 15:42:34.492040+00:00", 
            "author": "https://api.launchpad.net/1.0/~smoser"
        }, 
        {
            "content": "running the command sequentially for 300 times, i got:\n132 passes and 168 failures.", 
            "date_created": "2011-09-21 15:51:10.676870+00:00", 
            "author": "https://api.launchpad.net/1.0/~davewalker"
        }, 
        {
            "content": "So this is trunk only, due to some joinedloads being removed in\nnova/db/sqlalchemy/api:instance_get_all_by_filters\n", 
            "date_created": "2011-09-21 21:59:42.445963+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "And the backref for virtual_interfaces was removed.  I guess the idea here is to prepare to query quantum for this info.  The merge prop that removed this completely unties virtual_interfaces from Instance when you do most queries for an instance.  References to instance['virtual_interfaces'] need to now query the network service. \n", 
            "date_created": "2011-09-24 20:37:18.155246+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "BTW, when you do not get an exception....   any queries (like doing a servers/detail via OS API) return no IP addresses.  So, in trunk right now, if you do a 'nova list' via OS API1.1, you get no IP address information.  Same with 'nova show'.  Ran into this part of it while functional testing an unrelated branch.  Have a fix OS API here:\n\nhttp://paste.openstack.org/show/2553/\n\nEC2 will need something similar...  I'll get a merge prop RSN unless someone beats me to it.", 
            "date_created": "2011-09-24 20:43:27.036023+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "Decided compute_api.get() and get_all() should return the instance(s) with 'virtual_interfaces' set, instead of above kludge.\n\nAlso: I'm changing everything that references instance['fixed_ips'] to use 'virtual_interfaces', instead, so we can remove the joining of 'fixed_ips.floating_ips' when doing a 'db.instance_get', etc.  This is more in line with the intent of the earlier merge to force grabbing network information separately for an instance (possibly via an external service).\n\nhttps://github.com/comstud/nova/compare/master...bugs/855660\n\nPropping when tests are clean..", 
            "date_created": "2011-09-25 04:23:29.681510+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "I should mention I'm also seeing this sporadically on 2011.3-0ubuntu2~ppa1~natty1, but it's a different table (FixedIp)\n\nSession; lazy load operation of attribute 'network' cannot proceed\n(nova.api): TRACE: Traceback (most recent call last):\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 347, in __call__\n(nova.api): TRACE:     result = api_request.invoke(context)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/apirequest.py\", line 78, in invoke\n(nova.api): TRACE:     result = method(context, **args)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/cloud.py\", line 1151, in describe_instances\n(nova.api): TRACE:     instance_id=instance_id)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/cloud.py\", line 1160, in _format_describe_instances\n(nova.api): TRACE:     return {'reservationSet': self._format_instances(context, **kwargs)}\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/cloud.py\", line 1265, in _format_instances\n(nova.api): TRACE:     if fixed['network'] and use_v6:\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/models.py\", line 76, in __getitem__\n(nova.api): TRACE:     return getattr(self, key)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/attributes.py\", line 163, in __get__\n(nova.api): TRACE:     instance_dict(instance))\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/attributes.py\", line 383, in get\n(nova.api): TRACE:     value = callable_(passive=passive)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/strategies.py\", line 595, in __call__\n(nova.api): TRACE:     (mapperutil.state_str(state), self.key)\n(nova.api): TRACE: DetachedInstanceError: Parent instance <FixedIp at 0x4330d50> is not bound to a Session; lazy load operation of attribute 'network' cannot proceed\n(nova.api): TRACE: \n\nAdditionally (and this should probably be it's own bug, so I can file it if necessary), when attempting to add source security groups I get:\n\n\n2011-09-25 19:00:44,507 CRITICAL nova [-] Parent instance <SecurityGroup at 0x4f628d0> is not bound to a Session; lazy load operation of attribute 'instances' cannot proceed\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/bin/nova-compute\", line 49, in <module>\n(nova): TRACE:     service.wait()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 357, in wait\n(nova): TRACE:     _launcher.wait()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 107, in wait\n(nova): TRACE:     service.wait()\n(nova): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 166, in wait\n(nova): TRACE:     return self._exit_event.wait()\n(nova): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 116, in wait\n(nova): TRACE:     return hubs.get_hub().switch()\n(nova): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n(nova): TRACE:     return self.greenlet.switch()\n(nova): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n(nova): TRACE:     result = function(*args, **kwargs)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 77, in run_server\n(nova): TRACE:     server.start()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 137, in start\n(nova): TRACE:     self.manager.init_host()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 181, in init_host\n(nova): TRACE:     net_info)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1616, in ensure_filtering_rules_for_instance\n(nova): TRACE:     network_info)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/firewall.py\", line 546, in prepare_instance_filter\n(nova): TRACE:     self.add_filters_for_instance(instance)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/firewall.py\", line 582, in add_filters_for_instance\n(nova): TRACE:     ipv4_rules, ipv6_rules = self.instance_rules(instance, network_info)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/firewall.py\", line 702, in instance_rules\n(nova): TRACE:     for instance in rule['grantee_group']['instances']:\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/models.py\", line 76, in __getitem__\n(nova): TRACE:     return getattr(self, key)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/attributes.py\", line 163, in __get__\n(nova): TRACE:     instance_dict(instance))\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/attributes.py\", line 383, in get\n(nova): TRACE:     value = callable_(passive=passive)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/strategies.py\", line 595, in __call__\n(nova): TRACE:     (mapperutil.state_str(state), self.key)\n(nova): TRACE: DetachedInstanceError: Parent instance <SecurityGroup at 0x4f628d0> is not bound to a Session; lazy load operation of attribute 'instances' cannot proceed\n(nova): TRACE: \n\nThis is especially troubling, because it causes any rules after the offending one to not be applied and it keeps nova-compute from starting if there is an instance running in a group that has a source group specified.", 
            "date_created": "2011-09-26 02:23:58.630080+00:00", 
            "author": "https://api.launchpad.net/1.0/~kbringard"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/641\nCommitted: http://github.com/openstack/nova/commit/4584e552a653904c36cf04cb295a7bf09d2def28\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit 4584e552a653904c36cf04cb295a7bf09d2def28\nAuthor: Chris Behrens <email address hidden>\nDate:   Wed Sep 28 22:56:34 2011 +0000\n\n    Fixes euca-describe-instances failing or not showing IPs\n    \n    Fixes bug 855660\n    \n    Makes EC2 call network manager to get IP information now, to match the\n    same change to OS API\n    Also refactors a bit of OS API's calls... moving some code into 'common'\n    \n    Fixed tests.  Some tests for OS API v1.0 were not properly testing.\n    \n    Fixed imports per HACKING in files touched.\n    \n    Change-Id: I455637a9feb802291dfaf2ef694dabc2607784f9\n", 
            "date_created": "2011-09-29 17:47:09+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "I've just started noticing this with the latest stable/diablo branch, should this (or part of this) make its way in there as well?", 
            "date_created": "2011-10-26 10:52:37.416020+00:00", 
            "author": "https://api.launchpad.net/1.0/~kiall"
        }, 
        {
            "content": "Kiall: would be good to file a separate bug against the stable branch and include the full details of what you're seeing. There's been major changes around this code, so it may not be the same thing", 
            "date_created": "2011-11-10 08:37:56.422916+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }
    ]
}