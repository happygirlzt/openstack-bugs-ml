{
    "status": "Opinion", 
    "last_updated": "2017-06-08 13:30:11.710007+00:00", 
    "description": "When request vnc console using /servers/{server_id}/remote_console API,\nif the server could not be found in the hypervisor layer,\nexception.InstanceNotFound will raise and if the server's vm_state is\n\"BUILDING\" it will be translated to exception.InstanceNotReady and raise,\notherwise exception.InstanceNotFound will raise to the API layer and\nresponse to the users.\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L4594\n\nThis could be confusing in scenarios as follows:\n1. Boot a server with suitable image and flavor;\n2. Rebuild the server with a qcow2 type image, and the image size in glance is smaller than the server's flavor but when we use \"force_raw_image\" in compute, so it will pass API layer image vs flavor check, but it will become larger and failed to spawn in compute, the detailed example that we used will be shown latter;\n3. The server is now in ERROR state in Nova DB but gone in hypervisor;\n4. List/Show the server, not problems;\n5. Get VNC console for the server, exception.InstanceNotFound raised.\n\nAs for this kind of scenario, user can list/show the server, but it raised exception.InstanceNotFound when try to get vnc console for this server, this might be confusing, as exception.InstanceNotFound is normally replied to user when the server is not exist in Nova DB;\n\nIt might be better if we can use an separate exception for the above mentioned scenario.\n\ndetailed example:\n\nENV: devstack + nova master:\nroot@zhenyu-dev:/opt/stack/nova# git log\ncommit c2d3e80658801ca2ac91899479e525538f233fb1\nAuthor: He Jie Xu <email address hidden>\nDate:   Tue May 2 11:21:47 2017 +0800\n\n\u00a0\u00a0\u00a0\u00a0Add description to policies in extended_status and extended_volumes\n\n\u00a0\u00a0\u00a0\u00a0This updates the policy doc for  extended_status.py and extended_volumes.py\n\n\u00a0\u00a0\u00a0\u00a0Partial implement blueprint policy-docs\n\n\u00a0\u00a0\u00a0\u00a0Change-Id: I980eff5fd118601ecdf61c558013f3abba56a6ce\n\nStep 1:\nBoot an server, using cirros image and flavor 1 from devstack (1G disk):\nroot@zhenyu-dev:/opt/stack/nova# nova boot --flavor 1 --image 2808c30b-1848-418f-bfb1-653e65c4e6f3 --nic net-id=0353454b-9fee-4943-a1bc-a3f6ca679667 test\n\nStep2:\nRebuild the instance using a qcow2 image that is:\n1) size is smaller than the flavor's disk;\n2) when \"force_raw_image\" is set in compute, and this image transformed to raw, size is larger than flavor's disk;\nIn our case:\nroot@zhenyu-dev:/opt/stack/nova# glance image-list\n+--------------------------------------+--------------------------+\n| ID                                   | Name                     |\n+--------------------------------------+--------------------------+\n| 2808c30b-1848-418f-bfb1-653e65c4e6f3 | cirros-0.3.5-x86_64-disk |\n| 4ccc6dcc-cf66-438f-ab5d-1e8e115ba685 | mysql                    |\n+--------------------------------------+--------------------------+\nroot@zhenyu-dev:/opt/stack/nova# glance image-show 4ccc6dcc-cf66-438f-ab5d-1e8e115ba685\n+------------------+--------------------------------------+\n| Property         | Value                                |\n+------------------+--------------------------------------+\n| checksum         | 5c34dc5993beb9068eb9f9b1b25def27     |\n| container_format | bare                                 |\n| created_at       | 2017-05-12T02:09:46Z                 |\n| disk_format      | qcow2                                |\n| id               | 4ccc6dcc-cf66-438f-ab5d-1e8e115ba685 |\n| min_disk         | 0                                    |\n| min_ram          | 0                                    |\n| name             | mysql                                |\n| owner            | 3ed63cea5fe5433eaed39fae595d5a9d     |\n| protected        | False                                |\n| size             | 517668864                            |\n| status           | active                               |\n| tags             | []                                   |\n| updated_at       | 2017-05-12T02:09:48Z                 |\n| virtual_size     | None                                 |\n| visibility       | public                               |\n+------------------+--------------------------------------+\nthis is a ubuntu 16.04 image and its size is about 500MB which suits out flavor, but it will grow to 2.5G when transformed to RAW;\n\nroot@zhenyu-dev:/opt/stack/nova# nova list\n/usr/local/lib/python2.7/dist-packages/novaclient/client.py:278: UserWarning: The 'tenant_id' argument is deprecated in Ocata and its use may result in errors in future releases. As 'project_id' is provided, the 'tenant_id' argument will be ignored.\n\u00a0\u00a0warnings.warn(msg)\n+--------------------------------------+------+--------+------------+-------------+---------------------------------------------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks                                                |\n+--------------------------------------+------+--------+------------+-------------+---------------------------------------------------------+\n| 6eecb8aa-c431-446b-a450-e9663a9b29ec | test | ACTIVE | -          | Running     | private=10.0.0.10, fd32:6d3f:e1e6:0:f816:3eff:fefb:5419 |\n\nDO THE REBUILD:\nroot@zhenyu-dev:/opt/stack/nova# nova rebuild 6eecb8aa-c431-446b-a450-e9663a9b29ec 4ccc6dcc-cf66-438f-ab5d-1e8e115ba685\n\nroot@zhenyu-dev:/opt/stack/nova# nova list\n/usr/local/lib/python2.7/dist-packages/novaclient/client.py:278: UserWarning: The 'tenant_id' argument is deprecated in Ocata and its use may result in errors in future releases. As 'project_id' is provided, the 'tenant_id' argument will be ignored.\n\u00a0\u00a0warnings.warn(msg)\n+--------------------------------------+------+--------+------------+-------------+---------------------------------------------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks                                                |\n+--------------------------------------+------+--------+------------+-------------+---------------------------------------------------------+\n| 6eecb8aa-c431-446b-a450-e9663a9b29ec | test | ERROR  | -          | Running     | private=10.0.0.10, fd32:6d3f:e1e6:0:f816:3eff:fefb:5419 |\n+--------------------------------------+------+--------+------------+-------------+---------------------------------------------------------+\n\ninstance in ERROR state due to:\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 2668, in _rebuild_default_impl\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server     block_device_info=new_block_device_info)\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2688, in spawn\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server     block_device_info=block_device_info)\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3095, in _create_image\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server     fallback_from_host)\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3211, in _create_and_inject_local_root\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server     instance, size, fallback_from_host)\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 6780, in _try_fetch_image_cache\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server     size=size)\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/libvirt/imagebackend.py\", line 227, in cache\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server     *args, **kwargs)\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/libvirt/imagebackend.py\", line 574, in create_image\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server     self.verify_base_size(base, size)\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/libvirt/imagebackend.py\", line 283, in verify_base_size\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server     flavor_size=size, image_size=base_size)\n2017-05-12 15:34:05.995 TRACE oslo_messaging.rpc.server FlavorDiskSmallerThanImage: Flavor's disk is too small for requested image. Flavor disk is 1073741824 bytes, image is 2523463680 bytes.\n\nAnd the domain in hypervisor is gone;\n\nLast Step:\nTry to get vnc console for the server:\n\nroot@zhenyu-dev:/opt/stack/nova# nova get-vnc-console 6eecb8aa-c431-446b-a450-e9663a9b29ec novnc\n/usr/local/lib/python2.7/dist-packages/novaclient/client.py:278: UserWarning: The 'tenant_id' argument is deprecated in Ocata and its use may result in errors in future releases. As 'project_id' is provided, the 'tenant_id' argument will be ignored.\n\u00a0\u00a0warnings.warn(msg)\nERROR (NotFound): Instance 6eecb8aa-c431-446b-a450-e9663a9b29ec could not be found. (HTTP 404) (Request-ID: req-46eb7721-1d18-48af-96ac-e8a521a99791)\n\nA little bit confusing as I can list/show the server, but when I calling for vnc-console, it shows InstanceNotFound.", 
    "tags": [], 
    "importance": "Wishlist", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1690311", 
    "owner": "None", 
    "id": 1690311, 
    "index": 1869, 
    "created": "2017-05-12 07:08:53.848413+00:00", 
    "title": "Raise particular exception when cannot found instance in hypervisor layer", 
    "comments": [
        {
            "content": "TBA", 
            "date_created": "2017-05-12 07:08:53.848413+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengzhenyu"
        }, 
        {
            "content": "There is no active patch here", 
            "date_created": "2017-06-08 13:29:46.147547+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "A patch is welcomed, but this really isn't a bug per say", 
            "date_created": "2017-06-08 13:30:10.760584+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}