{
    "status": "Fix Released", 
    "last_updated": "2015-03-13 00:54:08.842093+00:00", 
    "description": "If an instance fails during its network creation (for example if the network-vif-plugged event doesn't arrive in time) a subsequent delete will also fail when it tries to delete the vif, leaving the instance in a Error(deleting) state.\n\nThis can be avoided by including the \"--if-exists\" option to the ovs=vsctl command.\n\nExample of stack trace:\n\n 2014-04-16 12:28:51.949 AUDIT nova.compute.manager [req-af72c100-5d9b-44f6-b941-3d72529b3401 demo demo] [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f] Terminating instance\n2014-04-16 12:28:52.309 ERROR nova.virt.libvirt.driver [-] [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f] During wait destroy, instance disappeared.\n2014-04-16 12:28:52.407 ERROR nova.network.linux_net [req-af72c100-5d9b-44f6-b941-3d72529b3401 demo demo] Unable to execute ['ovs-vsctl', '--timeout=120', 'del-port', 'br-int', u'qvo67a96e96-10']. Exception: Unexpected error while running command.\nCommand: sudo nova-rootwrap /etc/nova/rootwrap.conf ovs-vsctl --timeout=120 del-port br-int qvo67a96e96-10\nExit code: 1\nStdout: ''\nStderr: 'ovs-vsctl: no port named qvo67a96e96-10\\n'\n2014-04-16 12:28:52.573 ERROR nova.compute.manager [req-af72c100-5d9b-44f6-b941-3d72529b3401 demo demo] [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f] Setting instance vm_state to ERROR\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f] Traceback (most recent call last):\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/compute/manager.py\", line 2261, in do_terminate_instance\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self._delete_instance(context, instance, bdms, quotas)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/hooks.py\", line 103, in inner\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     rv = f(*args, **kwargs)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/compute/manager.py\", line 2231, in _delete_instance\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     quotas.rollback()\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/openstack/common/excutils.py\", line 82, in __exit__\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     six.reraise(self.type_, self.value, self.tb)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/compute/manager.py\", line 2203, in _delete_instance\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self._shutdown_instance(context, db_inst, bdms)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/compute/manager.py\", line 2145, in _shutdown_instance\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     requested_networks)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/openstack/common/excutils.py\", line 82, in __exit__\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     six.reraise(self.type_, self.value, self.tb)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/compute/manager.py\", line 2135, in _shutdown_instance\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     block_device_info)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/driver.py\", line 955, in destroy\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     destroy_disks)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/driver.py\", line 991, in cleanup\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self.unplug_vifs(instance, network_info)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/driver.py\", line 863, in unplug_vifs\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self.vif_driver.unplug(instance, vif)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/vif.py\", line 783, in unplug\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self.unplug_ovs(instance, vif)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/vif.py\", line 667, in unplug_ovs\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self.unplug_ovs_hybrid(instance, vif)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/vif.py\", line 661, in unplug_ovs_hybrid\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     v2_name)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/network/linux_net.py\", line 1318, in delete_ovs_vif_port\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     _ovs_vsctl(['del-port', bridge, dev])\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/network/linux_net.py\", line 1302, in _ovs_vsctl\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     raise exception.AgentError(method=full_args)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f] AgentError: Error during following call to agent: ['ovs-vsctl', '--timeout=120', 'del-port', 'br-int', u'qvo67a96e96-10']", 
    "tags": [
        "icehouse-backport-potential", 
        "in-stable-icehouse"
    ], 
    "importance": "Undecided", 
    "heat": 38, 
    "link": "https://bugs.launchpad.net/nova/+bug/1308544", 
    "owner": "https://api.launchpad.net/1.0/~philip-day", 
    "id": 1308544, 
    "index": 4762, 
    "created": "2014-04-16 13:28:17.297396+00:00", 
    "title": "libvirt: Trying to delete a non-existing vif raises an exception", 
    "comments": [
        {
            "content": "If an instance fails during its network creation (for example if the network-vif-plugged event doesn't arrive in time) a subsequent delete will also fail when it tries to delete the vif, leaving the instance in a Error(deleting) state.\n\nThis can be avoided by including the \"--if-exists\" option to the ovs=vsctl command.\n\nExample of stack trace:\n\n 2014-04-16 12:28:51.949 AUDIT nova.compute.manager [req-af72c100-5d9b-44f6-b941-3d72529b3401 demo demo] [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f] Terminating instance\n2014-04-16 12:28:52.309 ERROR nova.virt.libvirt.driver [-] [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f] During wait destroy, instance disappeared.\n2014-04-16 12:28:52.407 ERROR nova.network.linux_net [req-af72c100-5d9b-44f6-b941-3d72529b3401 demo demo] Unable to execute ['ovs-vsctl', '--timeout=120', 'del-port', 'br-int', u'qvo67a96e96-10']. Exception: Unexpected error while running command.\nCommand: sudo nova-rootwrap /etc/nova/rootwrap.conf ovs-vsctl --timeout=120 del-port br-int qvo67a96e96-10\nExit code: 1\nStdout: ''\nStderr: 'ovs-vsctl: no port named qvo67a96e96-10\\n'\n2014-04-16 12:28:52.573 ERROR nova.compute.manager [req-af72c100-5d9b-44f6-b941-3d72529b3401 demo demo] [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f] Setting instance vm_state to ERROR\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f] Traceback (most recent call last):\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/compute/manager.py\", line 2261, in do_terminate_instance\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self._delete_instance(context, instance, bdms, quotas)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/hooks.py\", line 103, in inner\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     rv = f(*args, **kwargs)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/compute/manager.py\", line 2231, in _delete_instance\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     quotas.rollback()\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/openstack/common/excutils.py\", line 82, in __exit__\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     six.reraise(self.type_, self.value, self.tb)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/compute/manager.py\", line 2203, in _delete_instance\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self._shutdown_instance(context, db_inst, bdms)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/compute/manager.py\", line 2145, in _shutdown_instance\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     requested_networks)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/openstack/common/excutils.py\", line 82, in __exit__\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     six.reraise(self.type_, self.value, self.tb)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/compute/manager.py\", line 2135, in _shutdown_instance\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     block_device_info)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/driver.py\", line 955, in destroy\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     destroy_disks)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/driver.py\", line 991, in cleanup\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self.unplug_vifs(instance, network_info)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/driver.py\", line 863, in unplug_vifs\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self.vif_driver.unplug(instance, vif)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/vif.py\", line 783, in unplug\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self.unplug_ovs(instance, vif)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/vif.py\", line 667, in unplug_ovs\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     self.unplug_ovs_hybrid(instance, vif)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/virt/libvirt/vif.py\", line 661, in unplug_ovs_hybrid\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     v2_name)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/network/linux_net.py\", line 1318, in delete_ovs_vif_port\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     _ovs_vsctl(['del-port', bridge, dev])\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]   File \"/mnt/stack/nova/nova/network/linux_net.py\", line 1302, in _ovs_vsctl\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f]     raise exception.AgentError(method=full_args)\n2014-04-16 12:28:52.573 TRACE nova.compute.manager [instance: 3b7ac090-1ada-4beb-9e56-1ba3a6445e1f] AgentError: Error during following call to agent: ['ovs-vsctl', '--timeout=120', 'del-port', 'br-int', u'qvo67a96e96-10']", 
            "date_created": "2014-04-16 13:28:17.297396+00:00", 
            "author": "https://api.launchpad.net/1.0/~philip-day"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/87998", 
            "date_created": "2014-04-16 15:25:17.695916+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/87998\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=476dc5efcdb11c9859b062dc69a8c205e69be861\nSubmitter: Jenkins\nBranch:    master\n\ncommit 476dc5efcdb11c9859b062dc69a8c205e69be861\nAuthor: Phil Day <email address hidden>\nDate:   Wed Apr 16 15:23:15 2014 +0000\n\n    Ignore errors when deleting non-existing vifs\n    \n    If an instance fails during its network creation (for example\n    if the network-vif-plugged event doesn't arrive in time) a\n    subsequent delete will also fail when it tries to delete the\n    vif, leaving the instance in a Error(deleting) state.\n    \n    This can be avoided by including the \"--if-exists\" option to\n    the ovs-vsctl command so that the command doesn't fail if the\n    vif doesn't exist.\n    \n    Change-Id: Ic613c9d6e0619f51fcd931e62f6d6bce404ebe81\n    Closes-bug: #1308544\n", 
            "date_created": "2014-05-23 07:05:19.198573+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/125210", 
            "date_created": "2014-09-30 21:41:31.848772+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/125210\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=698c821ad7b6878041be15901e89ddf6dd2c1636\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 698c821ad7b6878041be15901e89ddf6dd2c1636\nAuthor: Phil Day <email address hidden>\nDate:   Wed Apr 16 15:23:15 2014 +0000\n\n    Ignore errors when deleting non-existing vifs\n    \n    If an instance fails during its network creation (for example\n    if the network-vif-plugged event doesn't arrive in time) a\n    subsequent delete will also fail when it tries to delete the\n    vif, leaving the instance in a Error(deleting) state.\n    \n    This can be avoided by including the \"--if-exists\" option to\n    the ovs-vsctl command so that the command doesn't fail if the\n    vif doesn't exist.\n    \n    Change-Id: Ic613c9d6e0619f51fcd931e62f6d6bce404ebe81\n    Closes-bug: #1308544\n    (cherry picked from commit 476dc5efcdb11c9859b062dc69a8c205e69be861)\n", 
            "date_created": "2014-10-15 00:05:48.571933+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}