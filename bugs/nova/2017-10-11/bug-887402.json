{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:48:13.603362+00:00", 
    "description": "When I try to terminate an instance with attached volumes, I've got following exceptions.\n\n2011-11-08 08:58:51,553 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2003-10.com.lefthandnetworks:lhn:533:volume-00000003 -p 192.168.1.10:3260 --op update -n node.startup -v manual from (pid=27971) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-11-08 08:58:51,576 DEBUG nova.utils [-] Result was 255 from (pid=27971) execute /usr/lib/python2.7/dist-packages/nova/utils.py:184\n2011-11-08 08:58:51,584 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 115, in wrapped\n(nova.rpc): TRACE:     return f(*args, **kw)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 122, in decorated_function\n(nova.rpc): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 601, in terminate_instance\n(nova.rpc): TRACE:     self._delete_instance(context, instance_id)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 578, in _delete_instance\n(nova.rpc): TRACE:     self._shutdown_instance(context, instance_id, 'Terminating', True)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 564, in _shutdown_instance\n(nova.rpc): TRACE:     self.driver.destroy(instance, network_info, block_device_info, cleanup)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 348, in destroy\n(nova.rpc): TRACE:     mountpoint)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 371, in volume_driver_method\n(nova.rpc): TRACE:     return method(connection_info, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/volume.py\", line 147, in disconnect_volume\n(nova.rpc): TRACE:     self._iscsiadm_update(iscsi_properties, \"node.startup\", \"manual\")\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/volume.py\", line 82, in _iscsiadm_update\n(nova.rpc): TRACE:     return self._run_iscsiadm(iscsi_properties, iscsi_command)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/volume.py\", line 74, in _run_iscsiadm\n(nova.rpc): TRACE:     *iscsi_command, run_as_root=True)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 192, in execute\n(nova.rpc): TRACE:     cmd=' '.join(cmd))\n(nova.rpc): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova.rpc): TRACE: Command: sudo iscsiadm -m node -T iqn.2003-10.com.lefthandnetworks:lhn:533:volume-00000003 -p 192.168.1.10:3260 --op update -n node.startup -v manual\n(nova.rpc): TRACE: Exit code: 255\n(nova.rpc): TRACE: Stdout: ''\n(nova.rpc): TRACE: Stderr: 'iscsiadm: no records found!\\n'\n\n----\n\nI've checked codes, and it looks the cause is that nova-compute tries  to disconnect volume twice.\nfirst one runs when detaching volumes, second one runs when destroy instance. \nSo second try makes the excepion because there's no iscsi device, it already removed.\n\nPlease check this.\n\nThanks.", 
    "tags": [
        "in-milestone-proposed"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/887402", 
    "owner": "https://api.launchpad.net/1.0/~dtroyer", 
    "id": 887402, 
    "index": 518, 
    "created": "2011-11-08 02:42:30.622007+00:00", 
    "title": "can't terminate instance with attached volumes", 
    "comments": [
        {
            "content": "When I try to terminate an instance with attached volumes, I've got following exceptions.\n\n2011-11-08 08:58:51,553 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2003-10.com.lefthandnetworks:lhn:533:volume-00000003 -p 192.168.1.10:3260 --op update -n node.startup -v manual from (pid=27971) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-11-08 08:58:51,576 DEBUG nova.utils [-] Result was 255 from (pid=27971) execute /usr/lib/python2.7/dist-packages/nova/utils.py:184\n2011-11-08 08:58:51,584 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 115, in wrapped\n(nova.rpc): TRACE:     return f(*args, **kw)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 122, in decorated_function\n(nova.rpc): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 601, in terminate_instance\n(nova.rpc): TRACE:     self._delete_instance(context, instance_id)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 578, in _delete_instance\n(nova.rpc): TRACE:     self._shutdown_instance(context, instance_id, 'Terminating', True)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 564, in _shutdown_instance\n(nova.rpc): TRACE:     self.driver.destroy(instance, network_info, block_device_info, cleanup)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 348, in destroy\n(nova.rpc): TRACE:     mountpoint)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 371, in volume_driver_method\n(nova.rpc): TRACE:     return method(connection_info, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/volume.py\", line 147, in disconnect_volume\n(nova.rpc): TRACE:     self._iscsiadm_update(iscsi_properties, \"node.startup\", \"manual\")\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/volume.py\", line 82, in _iscsiadm_update\n(nova.rpc): TRACE:     return self._run_iscsiadm(iscsi_properties, iscsi_command)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/volume.py\", line 74, in _run_iscsiadm\n(nova.rpc): TRACE:     *iscsi_command, run_as_root=True)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 192, in execute\n(nova.rpc): TRACE:     cmd=' '.join(cmd))\n(nova.rpc): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova.rpc): TRACE: Command: sudo iscsiadm -m node -T iqn.2003-10.com.lefthandnetworks:lhn:533:volume-00000003 -p 192.168.1.10:3260 --op update -n node.startup -v manual\n(nova.rpc): TRACE: Exit code: 255\n(nova.rpc): TRACE: Stdout: ''\n(nova.rpc): TRACE: Stderr: 'iscsiadm: no records found!\\n'\n\n----\n\nI've checked codes, and it looks the cause is that nova-compute tries  to disconnect volume twice.\nSo second try makes the excepion because there's no iscsi device.\n\nPlease check this.\n\nThanks.", 
            "date_created": "2011-11-08 02:42:30.622007+00:00", 
            "author": "https://api.launchpad.net/1.0/~daeseong.kim"
        }, 
        {
            "content": "The problem is not recognizing the exit code 255 as valid on the second call to disconnect_volume.\n\nProposed Icffeb0fe82 to not check exit codes on logout/delete.", 
            "date_created": "2011-12-14 17:52:39.108540+00:00", 
            "author": "https://api.launchpad.net/1.0/~dtroyer"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2326\nCommitted: http://github.com/openstack/nova/commit/ed1b801a2cc3691cdab6ca2ae95f7299a964d00f\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit ed1b801a2cc3691cdab6ca2ae95f7299a964d00f\nAuthor: Dean Troyer <email address hidden>\nDate:   Tue Dec 13 19:05:21 2011 -0600\n\n    Fixes bug 887402\n    \n    Change utils.execute to accept a list or a single integer in\n    check_exit_code.\n    \n    In libvirt.disconnect_volume() return codes 0 and 255 are both valid\n    for logout/delete, where 255 is returned if the volume is already\n    disconnected.\n    \n    Change-Id: Icffeb0fe8269a02d95ac6ed180ba0bb9f458a6ed\n", 
            "date_created": "2011-12-15 01:22:00+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "This is a critical issue that will need to be backported to essex2 immediately. ", 
            "date_created": "2011-12-15 04:28:47.306923+00:00", 
            "author": "https://api.launchpad.net/1.0/~devcamcar"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2346\nCommitted: http://github.com/openstack/nova/commit/31a7924ecfae0b9c9fea0edc344f0e3ca2fe78a5\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit 31a7924ecfae0b9c9fea0edc344f0e3ca2fe78a5\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Wed Dec 14 14:03:04 2011 -0800\n\n    Refactors handling of detach volume\n    \n     * removes unnecessary flags in detach_volume call\n     * stops double detach reported in bug 887402\n     * moves volume.API() into init\n    \n    Change-Id: I65332cabedf2edb88acb48b3293cba291d440238\n", 
            "date_created": "2011-12-15 06:16:21+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2365\nCommitted: http://github.com/openstack/nova/commit/44955a1937ae25514bfe4ee5ccb561642681ab1c\nSubmitter: Jenkins\nBranch:    milestone-proposed\n\n tag in-milestone-proposed\n done\n\ncommit 44955a1937ae25514bfe4ee5ccb561642681ab1c\nAuthor: Dean Troyer <email address hidden>\nDate:   Tue Dec 13 19:05:21 2011 -0600\n\n    Fixes bug 887402\n    \n    Change utils.execute to accept a list or a single integer in\n    check_exit_code.\n    \n    In libvirt.disconnect_volume() return codes 0 and 255 are both valid\n    for logout/delete, where 255 is returned if the volume is already\n    disconnected.\n    \n    Also includes a fix by Dan Prince for a regression introduced by\n    the above fix (bug 904560)\n    \n    Change-Id: Icffeb0fe8269a02d95ac6ed180ba0bb9f458a6ed\n", 
            "date_created": "2011-12-15 17:36:26+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "Is this applicable to Diablo? Anyone care to backport it?", 
            "date_created": "2012-01-04 15:10:10.082176+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }
    ]
}