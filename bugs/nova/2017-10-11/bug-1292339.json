{
    "status": "Fix Released", 
    "last_updated": "2014-12-04 18:16:29.587636+00:00", 
    "description": "during we cold-migrating or resizing an instance to another host(or during deleting it), the get_console_output\nmethod may raise an InstanceNotFound excetpion if the instance is not on the hypervisor, this is an expected error,\nso we should add the InstanceNotFound excetpion to expected exceptions list in the compute manager.\n\n2014-03-14 11:59:58.884 AUDIT nova.compute.manager [req-6414594a-7fcd-427e-9ed6-1d78f12d40e0 demo demo] [instance: c68b2e95-8299-415a-a837-ff9f7303e6db] Get console output\n2014-03-14 11:59:58.901 ERROR oslo.messaging._executors.base [-] Exception during message handling\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base Traceback (most recent call last):\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/oslo.messaging/oslo/messaging/_executors/base.py\", line 36, in _dispatch\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     incoming.reply(self.callback(incoming.ctxt, incoming.message))\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/oslo.messaging/oslo/messaging/rpc/dispatcher.py\", line 134, in __call__\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     return self._dispatch(endpoint, method, ctxt, args)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/oslo.messaging/oslo/messaging/rpc/dispatcher.py\", line 104, in _dispatch\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/oslo.messaging/oslo/messaging/rpc/server.py\", line 153, in inner\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     return func(*args, **kwargs)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/exception.py\", line 88, in wrapped\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     payload)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     six.reraise(self.type_, self.value, self.tb)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/exception.py\", line 71, in wrapped\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     return f(self, context, *args, **kw)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/compute/manager.py\", line 293, in decorated_function\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     return function(self, context, *args, **kwargs)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/compute/manager.py\", line 3932, in get_console_output\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     output = self.driver.get_console_output(context, instance)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2268, in get_console_output\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     virt_dom = self._lookup_by_name(instance.name)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3437, in _lookup_by_name\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     raise exception.InstanceNotFound(instance_id=instance_name)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base InstanceNotFound: Instance instance-0000000c could not be found.\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base", 
    "tags": [
        "compute"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1292339", 
    "owner": "https://api.launchpad.net/1.0/~hzwangpan", 
    "id": 1292339, 
    "index": 6100, 
    "created": "2014-03-14 04:05:51.480051+00:00", 
    "title": "instance not found trace log can be ignored while get-console-output", 
    "comments": [
        {
            "content": "during we cold-migrating or resizing an instance to another host(or during deleting it), the get_console_output\nmethod may raise an InstanceNotFound excetpion if the instance is not on the hypervisor, this is an expected error,\nso we should add the InstanceNotFound excetpion to expected exceptions list in the compute manager.\n\n2014-03-14 11:59:58.884 AUDIT nova.compute.manager [req-6414594a-7fcd-427e-9ed6-1d78f12d40e0 demo demo] [instance: c68b2e95-8299-415a-a837-ff9f7303e6db] Get console output\n2014-03-14 11:59:58.901 ERROR oslo.messaging._executors.base [-] Exception during message handling\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base Traceback (most recent call last):\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/oslo.messaging/oslo/messaging/_executors/base.py\", line 36, in _dispatch\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     incoming.reply(self.callback(incoming.ctxt, incoming.message))\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/oslo.messaging/oslo/messaging/rpc/dispatcher.py\", line 134, in __call__\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     return self._dispatch(endpoint, method, ctxt, args)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/oslo.messaging/oslo/messaging/rpc/dispatcher.py\", line 104, in _dispatch\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/oslo.messaging/oslo/messaging/rpc/server.py\", line 153, in inner\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     return func(*args, **kwargs)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/exception.py\", line 88, in wrapped\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     payload)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     six.reraise(self.type_, self.value, self.tb)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/exception.py\", line 71, in wrapped\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     return f(self, context, *args, **kw)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/compute/manager.py\", line 293, in decorated_function\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     return function(self, context, *args, **kwargs)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/compute/manager.py\", line 3932, in get_console_output\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     output = self.driver.get_console_output(context, instance)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2268, in get_console_output\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     virt_dom = self._lookup_by_name(instance.name)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3437, in _lookup_by_name\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base     raise exception.InstanceNotFound(instance_id=instance_name)\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base InstanceNotFound: Instance instance-0000000c could not be found.\n2014-03-14 11:59:58.901 TRACE oslo.messaging._executors.base", 
            "date_created": "2014-03-14 04:05:51.480051+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "we'd better get debug log like below:\n2014-03-14 11:58:40.348 AUDIT nova.compute.manager [req-3d9c7f54-8247-4719-9bbd-37d9faffa0b2 demo demo] [instance: c68b2e95-8299-415a-a837-ff9f7303e6db] Get console output\n2014-03-14 11:58:40.356 DEBUG oslo.messaging._executors.base [-] Expected exception during message handling (Instance instance-0000000c could not be found.) from (pid=4318) _dispatch /opt/stack/oslo.messaging/oslo/messaging/_executors/base.py:39", 
            "date_created": "2014-03-14 04:07:07.092536+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "https://review.openstack.org/#/c/80471/", 
            "date_created": "2014-03-14 05:13:09.651099+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/80471\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=1c0c1eb01d45eb016ba6b2ad63b9e3e652365b34\nSubmitter: Jenkins\nBranch:    master\n\ncommit 1c0c1eb01d45eb016ba6b2ad63b9e3e652365b34\nAuthor: Wangpan <email address hidden>\nDate:   Fri Mar 14 12:08:29 2014 +0800\n\n    Ignore InstanceNotFound while getting console output\n    \n    During we cold-migrating or resizing an instance to another host,\n    or during deleting it, the get_console_output method may raise an\n    InstanceNotFound excetpion if the instance is not on the hypervisor,\n    this is an expected error, so we should add it to expected\n    exceptions list in compute manager.\n    \n    Closes-bug: #1292339\n    Change-Id: I23a99438d73826f01ff5662130dcbfa72dc39a6e\n", 
            "date_created": "2014-04-24 02:58:28.796083+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "I suspect the fix is not complete.\n\nDuring migration, there is a window (which can be pretty large) where the instance is present on the new node, but the data is still being rsynced. When the rsync order is libvirt.xml, disk, console.log, the instance is already present, but opening (and chowning) the consolelog will throw ProcessExecutionError.\n\nWe're theorizing that's the mechanism behind this stacktrace (we're seing this on 30% of resizemigrations, as our user interface polls the console log by default)\n\nTraceback (most recent call last):\n  File \"oslo/messaging/rpc/dispatcher.py\", line 134, in _dispatch_and_reply\n    incoming.message))\n  File \"oslo/messaging/rpc/dispatcher.py\", line 177, in _dispatch\n    return self._do_dispatch(endpoint, method, ctxt, args)\n  File \"oslo/messaging/rpc/dispatcher.py\", line 123, in _do_dispatch\n    result = getattr(endpoint, method)(ctxt, **new_args)\n  File \"oslo/messaging/rpc/server.py\", line 137, in inner\n    return func(*args, **kwargs)\n  File \"nova/exception.py\", line 88, in wrapped\n    payload)\n  File \"nova/openstack/common/excutils.py\", line 68, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"nova/exception.py\", line 71, in wrapped\n    return f(self, context, *args, **kw)\n  File \"nova/compute/manager.py\", line 309, in decorated_function\n    e, sys.exc_info())\n  File \"nova/openstack/common/excutils.py\", line 68, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"nova/compute/manager.py\", line 296, in decorated_function\n    return function(self, context, *args, **kwargs)\n  File \"nova/compute/manager.py\", line 3939, in get_console_output\n    output = self.driver.get_console_output(context, instance)\n  File \"nova/virt/libvirt/driver.py\", line 2309, in get_console_output\n    libvirt_utils.chown(path, os.getuid())\n  File \"nova/virt/libvirt/utils.py\", line 539, in chown\n    execute('chown', owner, path, run_as_root=True)\n  File \"nova/virt/libvirt/utils.py\", line 53, in execute\n    return utils.execute(*args, **kwargs)\n  File \"nova/utils.py\", line 164, in execute\n    return processutils.execute(*cmd, **kwargs)\n  File \"nova/openstack/common/processutils.py\", line 193, in execute\n    cmd=' '.join(cmd))\nProcessExecutionError: Unexpected error while running command.", 
            "date_created": "2014-11-26 18:18:00.408078+00:00", 
            "author": "https://api.launchpad.net/1.0/~kvdveer"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/137445\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=cb88a77da869926fbf051ee4aa52ee6513c4d192\nSubmitter: Jenkins\nBranch:    master\n\ncommit cb88a77da869926fbf051ee4aa52ee6513c4d192\nAuthor: Koert van der Veer <email address hidden>\nDate:   Wed Nov 26 19:48:51 2014 +0100\n\n    Libvirt: Don't let get_console_output crash on missing console file.\n    \n    During a migration, the console file may be configured, even though\n    the file itself is not yet present. This patch prevents a\n    ProcessExecutionError which gets thrown by the chown if the file\n    doesn't exist.\n    \n    Change-Id: Ifd75ae911fc264f8284ec3f2adbf1d73bc8c4aca\n    Related-Bug: #1292339\n", 
            "date_created": "2014-12-04 18:16:28.786321+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}