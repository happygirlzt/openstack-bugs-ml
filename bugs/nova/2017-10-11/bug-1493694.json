{
    "status": "Fix Released", 
    "last_updated": "2016-01-21 23:18:35.909287+00:00", 
    "description": "This is a timing issue and can occur if instance delete call reaches to _delete_instance method in nova/compute/manager.py module and nova-compute crashes after setting instance vm_state to 'DELETED' but before destroying the instance in db.\n\nNow on restarting nova-compute service, _init_instance method call checks whether instance vm_state is 'DELETED' or not, if yes, then it tries to call _complete_partial_deletion method and destroys instance in db then raises \"ValueError: Circular reference detected\" and quota was not updated for that instance which is not as expected.\n\nSteps to reproduce:\n1) Put a break point in nova/compute/manager.py module in _delete_instance method, just after updating instance vm_state to 'DELETED' but before destroying instance in db.\n2) Create instance and wait until instance vm_state become 'ACTIVE'.\n$ nova boot --image <image_id> --flavor <flavor_id> <name>\n\n3) Send request to delete instance.\n$ nova delete <instance_id>\n\n4) When delete request reaches to break point in nova-compute, make sure instance vm_state is marked as 'DELETED' and stop the nova-compute service.\n5) Restart nova-compute service and in _init_instance method call below error (ValueError: Circular reference detected) will be raised and instance will be marked as deleted in db but quota for that instance will never be updated.\n\n2015-09-08 00:36:34.133 ERROR nova.compute.manager [req-3222b8a4-0542-48cf-a2e1-c92e5fd91e5e None None] [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] Failed to complete a deletion\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] Traceback (most recent call last):\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/opt/stack/nova/nova/compute/manager.py\", line 952, in _init_instance\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     self._complete_partial_deletion(context, instance)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/opt/stack/nova/nova/compute/manager.py\", line 879, in _complete_partial_d\neletion\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     bdms = objects.BlockDeviceMappingList.get_by_instance_uuid(\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", lin\ne 197, in wrapper\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     ctxt, self, fn.__name__, args, kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 246, in object_action\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     objmethod=objmethod, args=args, kwargs=kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 158, in call\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     retry=self.retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     timeout=timeout, retry=retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 431, in send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     retry=retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 399, in _send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     msg = rpc_common.serialize_msg(msg)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/common.py\", line 286, in serialize_msg\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     _MESSAGE_KEY: jsonutils.dumps(raw_msg)}\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_serialization/jsonutils.py\", line 185, in dumps\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     return json.dumps(obj, default=default, **kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/lib/python2.7/json/__init__.py\", line 250, in dumps\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     sort_keys=sort_keys, **kw).encode(obj)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/lib/python2.7/json/encoder.py\", line 207, in encode\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     chunks = self.iterencode(o, _one_shot=True)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/lib/python2.7/json/encoder.py\", line 270, in iterencode\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     return _iterencode(o, 0)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] ValueError: Circular reference detected", 
    "tags": [
        "compute", 
        "db", 
        "in-stable-kilo", 
        "quotas"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1493694", 
    "owner": "https://api.launchpad.net/1.0/~rajesh-tailor", 
    "id": 1493694, 
    "index": 5753, 
    "created": "2015-09-09 07:14:27.218739+00:00", 
    "title": "On compute restart, quotas are not updated when instance vm_state is 'DELETED' but instance is not destroyed in db", 
    "comments": [
        {
            "content": "This is a timing issue and can occur if instance delete call reaches to _delete_instance method in nova/compute/manager.py module and nova-compute crashes after setting instance vm_state to 'DELETED' but before destroying the instance in db.\n\nNow on restarting nova-compute service, _init_instance method call checks whether instance vm_state is 'DELETED' or not, if yes, then it tries to call _complete_partial_deletion method and destroys instance in db then raises \"ValueError: Circular reference detected\" and quota was not updated for that instance which is not as expected.\n\nSteps to reproduce:\n1) Put a break point in nova/compute/manager.py module in _delete_instance method, just after updating instance vm_state to 'DELETED' but before destroying instance in db.\n2) Create instance and wait until instance vm_state become 'ACTIVE'.\n$ nova boot --image <image_id> --flavor <flavor_id> <name>\n\n3) Send request to delete instance.\n$ nova delete <instance_id>\n\n4) When delete request reaches to break point in nova-compute, make sure instance vm_state is marked as 'DELETED' and stop the nova-compute service.\n5) Restart nova-compute service and in _init_instance method call below error (ValueError: Circular reference detected) will be raised and instance will be marked as deleted in db but quota for that instance will never be updated.\n\n2015-09-08 00:36:34.133 ERROR nova.compute.manager [req-3222b8a4-0542-48cf-a2e1-c92e5fd91e5e None None] [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] Failed to complete a deletion\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] Traceback (most recent call last):\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/opt/stack/nova/nova/compute/manager.py\", line 952, in _init_instance\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     self._complete_partial_deletion(context, instance)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/opt/stack/nova/nova/compute/manager.py\", line 879, in _complete_partial_d\neletion\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     bdms = objects.BlockDeviceMappingList.get_by_instance_uuid(\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", lin\ne 197, in wrapper\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     ctxt, self, fn.__name__, args, kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 246, in object_action\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     objmethod=objmethod, args=args, kwargs=kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 158, in call\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     retry=self.retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     timeout=timeout, retry=retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 431, in send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     retry=retry)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 399, in _send\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     msg = rpc_common.serialize_msg(msg)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/common.py\", line 286, in serialize_msg\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     _MESSAGE_KEY: jsonutils.dumps(raw_msg)}\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/local/lib/python2.7/dist-packages/oslo_serialization/jsonutils.py\", line 185, in dumps\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     return json.dumps(obj, default=default, **kwargs)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/lib/python2.7/json/__init__.py\", line 250, in dumps\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     sort_keys=sort_keys, **kw).encode(obj)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/lib/python2.7/json/encoder.py\", line 207, in encode\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     chunks = self.iterencode(o, _one_shot=True)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]   File \"/usr/lib/python2.7/json/encoder.py\", line 270, in iterencode\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536]     return _iterencode(o, 0)\n2015-09-08 00:36:34.133 TRACE nova.compute.manager [instance: 00c7a9ae-bff1-461f-ab95-0e8f15327536] ValueError: Circular reference detected", 
            "date_created": "2015-09-09 07:14:27.218739+00:00", 
            "author": "https://api.launchpad.net/1.0/~rajesh-tailor"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/226168", 
            "date_created": "2015-09-22 06:06:41.372895+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/226168\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=fdd85c10de35c21700dd33bb9b2e0a3ff425d83a\nSubmitter: Jenkins\nBranch:    master\n\ncommit fdd85c10de35c21700dd33bb9b2e0a3ff425d83a\nAuthor: Rajesh Tailor <email address hidden>\nDate:   Thu Sep 10 02:01:47 2015 -0700\n\n    Fix quota update in init_instance on nova-compute restart\n    \n    During instance deletion if nova-compute crashes after setting\n    instance vm_state to 'DELETED' but before destroying instance from db,\n    then on restart of nova-compute _init_instance method deletes instance\n    from db as well but fails to update quota for that instance.\n    \n    Since on nova-compute restart that instance was marked as deleted in\n    db also, quota for that instance never gets updated.\n    \n    Added code to get instance metadata in init_host as it is required in\n    'notify_about_instance_usage' method and getting instance\n    system_metadata before destroying instance from db\n    in _complete_partial_deletion.\n    \n    Closes-Bug: 1493694\n    Change-Id: Ib4ff381848957b33774a4d7c1bfcf1410d67a657\n", 
            "date_created": "2015-09-23 12:01:58.785421+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/229261", 
            "date_created": "2015-09-30 06:44:38.048725+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/229261\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=68e9359d88646760030a6fe769af122e70986d8c\nSubmitter: Jenkins\nBranch:    stable/kilo\n\ncommit 68e9359d88646760030a6fe769af122e70986d8c\nAuthor: Rajesh Tailor <email address hidden>\nDate:   Thu Sep 10 02:01:47 2015 -0700\n\n    Fix quota update in init_instance on nova-compute restart\n    \n    During instance deletion if nova-compute crashes after setting\n    instance vm_state to 'DELETED' but before destroying instance from db,\n    then on restart of nova-compute _init_instance method deletes instance\n    from db as well but fails to update quota for that instance.\n    \n    Since on nova-compute restart that instance was marked as deleted in\n    db also, quota for that instance never gets updated.\n    \n    Added code to get instance metadata in init_host as it is required in\n    'notify_about_instance_usage' method and getting instance\n    system_metadata before destroying instance from db\n    in _complete_partial_deletion.\n    \n    Closes-Bug: 1493694\n    Change-Id: Ib4ff381848957b33774a4d7c1bfcf1410d67a657\n    (cherry picked from commit fdd85c10de35c21700dd33bb9b2e0a3ff425d83a)\n", 
            "date_created": "2015-10-05 14:35:58.524658+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}