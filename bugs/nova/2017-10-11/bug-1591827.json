{
    "status": "Fix Released", 
    "last_updated": "2016-12-19 12:02:15.350078+00:00", 
    "description": "Description\n===========\nUsing nova to create an instance in Aarch64,the disk.config is the 'cdrom' and has the type of 'scsi'.After instance creation ,log into the instance and can't see the cdrom device.\n\nSteps to reproduce\n==================\n1.Using devstack to deploy openstack. Using default local.conf.\n\n2.Upload the aarch64 image with glance.\n$ source ~/devstack/openrc admin admin\n$ glance image-create --name image-arm64.img --disk-format qcow2 --container-format bare --visibility public --file images/image-arm64-wily.qcow2 --progress\n$ glance image-create --name image-arm64.vmlinuz --disk-format aki --container-format aki --visibility public --file images/image-arm64-wily.vmlinuz --progress\n$ glance image-create --name image-arm64.initrd --disk-format ari --container-format ari --visibility public --file images/image-arm64-wily.initrd --progress\n$ IMAGE_UUID=$(glance image-list | grep image-arm64.img | awk '{ print $2 }')\n$ IMAGE_KERNEL_UUID=$(glance image-list | grep image-arm64.vmlinuz | awk '{ print $2 }')\n$ IMAGE_INITRD_UUID=$(glance image-list | grep image-arm64.initrd | awk '{ print $2 }')\n$ glance image-update --kernel-id ${IMAGE_KERNEL_UUID} --ramdisk-id ${IMAGE_INITRD_UUID} ${IMAGE_UUID}\n3.Set the scsi model:\n$ glance image-update --property hw_disk_bus --property hw_scsi_model=virtio-scsi ${IMAGE_UUID}\n\n4.nova add keypair\n$ nova keypair-add default --pub-key ~/.ssh/id_rsa.pub\n\n5.Launch the instance:\n$ image=$(nova image-list | egrep \"image-arm64.img\"'[^-]' | awk '{ print $2 }')\n$ nova boot --flavor m1.small--image ${image} --key-name default test-arm64\n\n6.After creation,use ssh to login into the instance.In the guest:\n$ ls -l /dev\nThe we can see that cdrom doesn't exist.\n\nExpected result\n===============\nAfter spawningn the instance, login into the guest :\n$ ls -l /dev\nWe can see the cdrom is here.\n\nActual result\n=============\nThe xml file of the disk.config is generated by nova ,but can't work.\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n\u00a0\u00a0list for all releases: http://docs.openstack.org/releases/\n\u00a0\u00a0\u00a0Nova development, commit code: 279f1a9bf65c4b904e01d26f0619a62ed99fc4d3\n\n2. Which hypervisor did you use?\n\u00a0\u00a0\u00a0\u00a0Libvirt+KVM\n\u00a0\u00a0\u00a0\u00a0$ kvm --version\n\u00a0\u00a0\u00a0\u00a0QEMU emulator version 2.5.0 (Debian 1:2.5+dfsg-5ubuntu10.1), Copyright (c) 2003-2008 Fabrice Bellard\n\u00a0\u00a0\u00a0\u00a0$ libvirtd --version\n\u00a0\u00a0\u00a0\u00a0libvirtd (libvirt) 1.3.1\n\n2. Which storage type did you use?\n\u00a0\u00a0\u00a0In the host file system,all in one physics machine.\nstack@u202154:/opt/stack/nova$ df -hl\nFilesystem Size Used Avail Use% Mounted on\nudev 7.8G 0 7.8G 0% /dev\ntmpfs 1.6G 61M 1.6G 4% /run\n/dev/sda2 917G 41G 830G 5% /\ntmpfs 7.9G 0 7.9G 0% /dev/shm\ntmpfs 5.0M 0 5.0M 0% /run/lock\ntmpfs 7.9G 0 7.9G 0% /sys/fs/cgroup\n/dev/sda1 511M 888K 511M 1% /boot/efi\ncgmfs 100K 0 100K 0% /run/cgmanager/fs\ntmpfs 1.6G 0 1.6G 0% /run/user/1002\ntmpfs 1.6G 0 1.6G 0% /run/user/1000\ntmpfs 1.6G 0 1.6G 0% /run/user/0\n\n3. Which networking type did you use?\n\u00a0\u00a0\u00a0nova-network\n\n4. Environment information:\n\u00a0\u00a0\u00a0Architecture : AARCH64\n\u00a0\u00a0\u00a0OS: Ubuntu 16.04\n\nDetailed log info is in the accessory.\nThe guest xml is also in the log info.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1591827", 
    "owner": "https://api.launchpad.net/1.0/~kevin-zhao", 
    "id": 1591827, 
    "index": 4553, 
    "created": "2016-06-13 03:08:31.462995+00:00", 
    "title": "Scsi device can't be recognized in Guest in aarch64", 
    "comments": [
        {
            "content": "Description\n===========\nUsing nova to create an instance in Aarch64,the disk.config is the 'cdrom' and has the type of 'scsi'.After instance creation ,log into the instance and can't see the cdrom device.\n\nSteps to reproduce\n==================\n1.Using devstack to deploy openstack. Using default local.conf.\n\n2.Upload the aarch64 image with glance.\n$ source ~/devstack/openrc admin admin\n$ glance image-create --name image-arm64.img --disk-format qcow2 --container-format bare --visibility public --file images/image-arm64-wily.qcow2 --progress\n$ glance image-create --name image-arm64.vmlinuz --disk-format aki --container-format aki --visibility public --file images/image-arm64-wily.vmlinuz --progress\n$ glance image-create --name image-arm64.initrd --disk-format ari --container-format ari --visibility public --file images/image-arm64-wily.initrd --progress\n$ IMAGE_UUID=$(glance image-list | grep image-arm64.img | awk '{ print $2 }')\n$ IMAGE_KERNEL_UUID=$(glance image-list | grep image-arm64.vmlinuz | awk '{ print $2 }')\n$ IMAGE_INITRD_UUID=$(glance image-list | grep image-arm64.initrd | awk '{ print $2 }')\n$ glance image-update --kernel-id ${IMAGE_KERNEL_UUID} --ramdisk-id ${IMAGE_INITRD_UUID} ${IMAGE_UUID} \n3.Set the scsi model:\n$ glance image-update --property hw_scsi_model=virtio-scsi ${IMAGE_UUID}\n\n4.nova add keypair\n$ nova keypair-add default --pub-key ~/.ssh/id_rsa.pub\n\n5.Launch the instance:\n$ image=$(nova image-list | egrep \"image-arm64.img\"'[^-]' | awk '{ print $2 }')\n$ nova boot --flavor m1.small--image ${image} --key-name default test-arm64\n\n6.After creation,use ssh to login into the instance.In the guest:\n$ ls -l /dev\nThe we can see that cdrom doesn't exist.\n\nExpected result\n===============\nAfter spawningn the instance, login into the guest :\n$ ls -l /dev \nWe can see the cdrom is here.\n\nActual result\n=============\nThe xml file of the disk.config is generated by nova ,but can't work.\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n  list for all releases: http://docs.openstack.org/releases/\n   Nova development, commit code: 279f1a9bf65c4b904e01d26f0619a62ed99fc4d3\n\n2. Which hypervisor did you use?\n    Libvirt+KVM\n    $ kvm --version\n    QEMU emulator version 2.5.0 (Debian 1:2.5+dfsg-5ubuntu10.1), Copyright (c) 2003-2008 Fabrice Bellard\n    $ libvirtd --version\n    libvirtd (libvirt) 1.3.1\n\n2. Which storage type did you use?\n   In the host file system,all in one physics machine.\nstack@u202154:/opt/stack/nova$ df -hl\nFilesystem Size Used Avail Use% Mounted on\nudev 7.8G 0 7.8G 0% /dev\ntmpfs 1.6G 61M 1.6G 4% /run\n/dev/sda2 917G 41G 830G 5% /\ntmpfs 7.9G 0 7.9G 0% /dev/shm\ntmpfs 5.0M 0 5.0M 0% /run/lock\ntmpfs 7.9G 0 7.9G 0% /sys/fs/cgroup\n/dev/sda1 511M 888K 511M 1% /boot/efi\ncgmfs 100K 0 100K 0% /run/cgmanager/fs\ntmpfs 1.6G 0 1.6G 0% /run/user/1002\ntmpfs 1.6G 0 1.6G 0% /run/user/1000\ntmpfs 1.6G 0 1.6G 0% /run/user/0\n\n3. Which networking type did you use?\n   nova-network\n\n4. Environment information:\n   Architecture : AARCH64\n   OS: Ubuntu 16.04\n\nDetailed log info is in the accessory.\nThe guest xml is also in the log info.", 
            "date_created": "2016-06-13 03:08:31.462995+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "This is the xml file that generated by nova to create the instance.We can see there is a scsi controller which has the model type: virtio-scsi.", 
            "date_created": "2016-06-13 03:11:09.164695+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/329403", 
            "date_created": "2016-06-14 12:04:01.864204+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Kevin, you seemed to have mixed up the file you intended to add on comment#1 -- you've added some snippet of log file, while you're talking about the Nova-generated guest XML definition.", 
            "date_created": "2016-06-20 14:44:44.483307+00:00", 
            "author": "https://api.launchpad.net/1.0/~kashyapc"
        }, 
        {
            "content": "Hi Kashyap,\nHere is the xml that Nova generated. \n<domain type=\"kvm\">\n  <uuid>b0540cfd-2477-47fb-82d9-a91d7b8e37d7</uuid>\n  <name>instance-00000023</name>\n  <memory>2097152</memory>\n  <vcpu>1</vcpu>\n  <metadata>\n    <nova:instance xmlns:nova=\"http://openstack.org/xmlns/libvirt/nova/1.0\">\n      <nova:package version=\"14.0.0\"/>\n      <nova:name>test-arm64-1</nova:name>\n      <nova:creationTime>2016-06-07 08:18:04</nova:creationTime>\n      <nova:flavor name=\"m1.small\">\n        <nova:memory>2048</nova:memory>\n        <nova:disk>20</nova:disk>\n        <nova:swap>0</nova:swap>\n        <nova:ephemeral>0</nova:ephemeral>\n        <nova:vcpus>1</nova:vcpus>\n      </nova:flavor>\n      <nova:owner>\n        <nova:user uuid=\"d06750c5a5094ebebcc8c20bdb243b1a\">admin</nova:user>\n        <nova:project uuid=\"40757abc778346698c52718f921e9853\">admin</nova:project>\n      </nova:owner>\n      <nova:root type=\"image\" uuid=\"c6f4f941-7d4b-4a6c-b9c7-2688924826ca\"/>\n    </nova:instance>\n  </metadata>\n  <os>\n    <type machine=\"virt\">hvm</type>\n    <kernel>/opt/stack/data/nova/instances/b0540cfd-2477-47fb-82d9-a91d7b8e37d7/kernel</kernel>\n    <initrd>/opt/stack/data/nova/instances/b0540cfd-2477-47fb-82d9-a91d7b8e37d7/ramdisk</initrd>\n    <cmdline>root=/dev/vda console=tty0 console=ttyS0</cmdline>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n  </features>\n  <cputune>\n    <shares>1024</shares>\n  </cputune>\n  <clock offset=\"utc\">\n    <timer name=\"pit\" tickpolicy=\"delay\"/>\n    <timer name=\"rtc\" tickpolicy=\"catchup\"/>\n  </clock>\n  <cpu mode=\"host-model\" match=\"exact\">\n    <topology sockets=\"1\" cores=\"1\" threads=\"1\"/>\n  </cpu>\n  <devices>\n    <disk type=\"file\" device=\"disk\">\n      <driver name=\"qemu\" type=\"qcow2\" cache=\"none\"/>\n      <source file=\"/opt/stack/data/nova/instances/b0540cfd-2477-47fb-82d9-a91d7b8e37d7/disk\"/>\n      <target bus=\"virtio\" dev=\"vda\"/>\n    </disk>\n    <disk type=\"file\" device=\"cdrom\">\n      <driver name=\"qemu\" type=\"raw\" cache=\"none\"/>\n      <source file=\"/opt/stack/data/nova/instances/b0540cfd-2477-47fb-82d9-a91d7b8e37d7/disk.config\"/>\n      <target bus=\"scsi\" dev=\"sdz\"/>\n    </disk>\n    <controller type=\"scsi\" model=\"virtio-scsi\"/>\n    <interface type=\"bridge\">\n      <mac address=\"fa:16:3e:38:8c:51\"/>\n      <model type=\"virtio\"/>\n      <source bridge=\"br100\"/>\n      <filterref filter=\"nova-instance-instance-00000023-fa163e388c51\"/>\n    </interface>\n    <serial type=\"file\">\n      <source path=\"/opt/stack/data/nova/instances/b0540cfd-2477-47fb-82d9-a91d7b8e37d7/console.log\"/>\n    </serial>\n    <serial type=\"pty\"/>\n    <memballoon model=\"virtio\">\n      <stats period=\"10\"/>\n    </memballoon>\n  </devices>\n</domain>\n\n", 
            "date_created": "2016-06-21 02:07:50.927765+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "Hi Kashyap,\n   Pls ignore the comment#4.\n   Here is the Nova generated xml here. We can see that the virtio-scsi controller is added : \n<controller type=\"scsi\" model=\"virtio-scsi\"/>\n   The controller.index=0 by default.\n   index=0 controller worked for sda->sdg\nBut for sdz(cdrom), the controller bus can not be recognized.\n   The next attachment is the xml file by \"virsh dumpxml instance-00000006\"", 
            "date_created": "2016-06-21 07:26:06.713975+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "", 
            "date_created": "2016-06-21 07:26:30.306712+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "The xml which Nova generated for spawning the instance", 
            "date_created": "2016-06-21 07:40:35.825564+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "We really need to just fix nova so that it doesn't hardcode a device name of sdz. It should be using the normal block device dev assignment code for the config drive, which would result in it gettig a sensible name of 'sda' (if there's no other SCSI devs attached before it)", 
            "date_created": "2016-07-20 13:34:43.027481+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }, 
        {
            "content": "Hi Daniel,\n    Nova has hardcode the config drive --> cdrom as the last device name sdz. With your method, we can change the cdrom dev name to the front of the devname such as sda,sdb,,,  That will work due to add controller:\n<controller type=\"scsi\" model=\"virtio-scsi\"/>\nThe default index for controller virtio-scsi is index=0, which corresponding to sda to sdg. But for example, sdh, it needs virtio-scsi controller that has index=1 and so as sdz need index=3. So...\n    Actually I meet another problem by virtio-scsi mode here. When I set hw_scsi_model=virtio-scsi and hw_disk_bus=scsi, then I use \"nova volume-attach\" to add the volume to an existing instanc, I have add device one by one. Adding volume as sdb, sdc,sde are all OK, they can be hotplug. When the adding device has devname \"sdh\", it can't be recognized by the instance, due to the controller index problem.\n    So I think maybe add the index calculator according to its devname and add the controller xml corresponding devname can solve the problem.\n    Thanks~\n", 
            "date_created": "2016-07-20 14:08:25.206496+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/329403\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d442c1aa31b0a0cbfa0d057e8b6574002ee2e2fc\nSubmitter: Jenkins\nBranch:    master\n\ncommit d442c1aa31b0a0cbfa0d057e8b6574002ee2e2fc\nAuthor: KevinZhao <email address hidden>\nDate:   Mon Jun 13 02:14:51 2016 +0000\n\n    libvirt: Delete the lase_device of find_disk_dev_for_disk_bus\n    \n    Delete the last_device parameters of find_disk_dev_for_disk_bus.\n    Just pick the first available letter on the bus as the device,\n    instead of hardcoding on the last device for config drive. Also\n    tweak the test case for this.\n    \n    Closes-bug: #1591827\n    \n    Change-Id: I6343d7ab6f1b0aa58f29805e24db7e2c61d1409e\n    Signed-off-by: Kevin Zhao <email address hidden>\n", 
            "date_created": "2016-11-24 20:10:48.012745+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/403256", 
            "date_created": "2016-11-25 19:01:47.934468+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/403256\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3d0ec34865df871f448525fca2beca4f83accae3\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 3d0ec34865df871f448525fca2beca4f83accae3\nAuthor: KevinZhao <email address hidden>\nDate:   Mon Jun 13 02:14:51 2016 +0000\n\n    libvirt: Delete the lase_device of find_disk_dev_for_disk_bus\n    \n    Delete the last_device parameters of find_disk_dev_for_disk_bus.\n    Just pick the first available letter on the bus as the device,\n    instead of hardcoding on the last device for config drive. Also\n    tweak the test case for this.\n    \n    Closes-bug: #1591827\n    Change-Id: I6343d7ab6f1b0aa58f29805e24db7e2c61d1409e\n    Signed-off-by: Kevin Zhao <email address hidden>\n    (cherry picked from commit d442c1aa31b0a0cbfa0d057e8b6574002ee2e2fc)\n", 
            "date_created": "2016-12-15 12:25:46.055815+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b2 development milestone.", 
            "date_created": "2016-12-15 17:35:56.282298+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.3 release.", 
            "date_created": "2016-12-19 12:02:13.529988+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}