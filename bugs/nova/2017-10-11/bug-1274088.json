{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:08:50.035663+00:00", 
    "description": "During an attach to an iSCSI device, the LUN may not appear as soon as the path which contains the LUNs.  The XenAPI code copes with multiple (or no) LUNs for an SR, so there is a race condition where the SR is created but no VDIs are registered, leading to the following exception:\n\n2014-01-29 08:19:41.804 ERROR nova.compute.manager [req-144fa10e-7003-45dc-a54c-f45b1b3581fd tempest.scenario.manager-tempest-1638977579-user tempest.scenario.manager-tempest-1638977579-tenant] [instance: cc864540-8650-40ea-9142-ba533c1e39f9] Failed to attach volume 2ac02e92-8880-4bd7-a382-8942ffe14f7c at /dev/xvdb\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9] Traceback (most recent call last):\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/compute/manager.py\", line 3852, in _attach_volume\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     encryption=encryption)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 435, in attach_volume\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     mountpoint)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 59, in attach_volume\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     hotplug=hotplug)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 130, in _connect_volume\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     volume_utils.forget_sr(self._session, sr_ref)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     six.reraise(self.type_, self.value, self.tb)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 108, in _connect_volume\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     target_lun=connection_data['target_lun'])\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/virt/xenapi/volume_utils.py\", line 160, in introduce_vdi\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     vdi_rec = session.call_xenapi(\"VDI.get_record\", vdi_ref)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9] UnboundLocalError: local variable 'vdi_ref' referenced before assignment", 
    "tags": [
        "xenserver"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1274088", 
    "owner": "https://api.launchpad.net/1.0/~bob-ball", 
    "id": 1274088, 
    "index": 3776, 
    "created": "2014-01-29 12:09:45.052844+00:00", 
    "title": "XenAPI: iscsi connection may not show VDI during attach", 
    "comments": [
        {
            "content": "During an attach to an iSCSI device, the LUN may not appear as soon as the path which contains the LUNs.  The XenAPI code copes with multiple (or no) LUNs for an SR, so there is a race condition where the SR is created but no VDIs are registered, leading to the following exception:\n\n2014-01-29 08:19:41.804 ERROR nova.compute.manager [req-144fa10e-7003-45dc-a54c-f45b1b3581fd tempest.scenario.manager-tempest-1638977579-user tempest.scenario.manager-tempest-1638977579-tenant] [instance: cc864540-8650-40ea-9142-ba533c1e39f9] Failed to attach volume 2ac02e92-8880-4bd7-a382-8942ffe14f7c at /dev/xvdb\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9] Traceback (most recent call last):\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/compute/manager.py\", line 3852, in _attach_volume\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     encryption=encryption)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 435, in attach_volume\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     mountpoint)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 59, in attach_volume\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     hotplug=hotplug)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 130, in _connect_volume\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     volume_utils.forget_sr(self._session, sr_ref)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     six.reraise(self.type_, self.value, self.tb)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 108, in _connect_volume\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     target_lun=connection_data['target_lun'])\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]   File \"/opt/stack/nova/nova/virt/xenapi/volume_utils.py\", line 160, in introduce_vdi\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9]     vdi_rec = session.call_xenapi(\"VDI.get_record\", vdi_ref)\n2014-01-29 08:19:41.804 TRACE nova.compute.manager [instance: cc864540-8650-40ea-9142-ba533c1e39f9] UnboundLocalError: local variable 'vdi_ref' referenced before assignment", 
            "date_created": "2014-01-29 12:09:45.052844+00:00", 
            "author": "https://api.launchpad.net/1.0/~bob-ball"
        }, 
        {
            "content": "Note: This causes tempest test failures:\n08:29:59 Traceback (most recent call last):\n08:29:59   File \"tempest/scenario/test_minimum_basic.py\", line 161, in test_minimum_basic_scenario\n08:29:59     self.nova_volume_attach()\n08:29:59   File \"tempest/scenario/test_minimum_basic.py\", line 118, in nova_volume_attach\n08:29:59     self._wait_for_volume_status('in-use')\n08:29:59   File \"tempest/scenario/test_minimum_basic.py\", line 46, in _wait_for_volume_status\n08:29:59     self.volume_client.volumes, volume_id, status)\n08:29:59   File \"tempest/scenario/manager.py\", line 348, in status_timeout\n08:29:59     not_found_exception=not_found_exception)\n08:29:59   File \"tempest/scenario/manager.py\", line 409, in _status_timeout\n08:29:59     raise exceptions.TimeoutException(message)\n08:29:59 TimeoutException: Request timed out\n08:29:59 Details: Timed out waiting for thing 2ac02e92-8880-4bd7-a382-8942ffe14f7c to become in-use", 
            "date_created": "2014-01-29 12:16:22.247814+00:00", 
            "author": "https://api.launchpad.net/1.0/~bob-ball"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/69879\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=187d1668d43da6977eb9ae4d96cd85243838ed6b\nSubmitter: Jenkins\nBranch:    master\n\ncommit 187d1668d43da6977eb9ae4d96cd85243838ed6b\nAuthor: Bob Ball <email address hidden>\nDate:   Wed Jan 29 15:06:54 2014 +0000\n\n    XenAPI: Wait for VDI on introduce\n    \n    Some SRs, particularly iSCSI connections, are slow to see the VDIs.\n    \n    Introduce a sleep when a VDI that we're definitely expecting is not\n    present on the SR.\n    \n    Change-Id: I7c71f1c7b811603aeacbb34c913dc236bba2132a\n    Closes-bug: 1274088\n", 
            "date_created": "2014-02-11 23:18:00.806566+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}