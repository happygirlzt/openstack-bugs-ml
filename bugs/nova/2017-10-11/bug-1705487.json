{
    "status": "Fix Released", 
    "last_updated": "2017-07-21 03:20:03.962401+00:00", 
    "description": "When an allocation requests on placement results in an invalid inventory due to the capacity is exceeded then placement return HTTP 409 properly but at the same time logs an ERROR log (see below). \nThe ERROR log is not necessary as this is not a software error.\n\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: [pid: 9543|app: 0|req: 790/1579] 192.168.122.191 () {66 vars in 1440 bytes} [Thu Jul 20 11:44:38 2017] PUT /placement/allocations/485c7480-939c-4b88-8c\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG nova.api.openstack.placement.requestlog [None req-ce309a62-3819-4ccb-8491-828046235f2d service placement] Starting request: 192.168.122.191 \"GET \nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-ce309a62-3819-4ccb-8491-828046235f2d service placement] Acquired semaphore \"rc_cache\" {{(pid=9542) lock /usr\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-ce309a62-3819-4ccb-8491-828046235f2d service placement] Releasing semaphore \"rc_cache\" {{(pid=9542) lock /us\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: INFO nova.api.openstack.placement.requestlog [None req-ce309a62-3819-4ccb-8491-828046235f2d service placement] 192.168.122.191 \"GET /placement/allocati\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: [pid: 9542|app: 0|req: 790/1580] 192.168.122.191 () {60 vars in 1344 bytes} [Thu Jul 20 11:44:38 2017] GET /placement/allocations/9fff84b6-71e4-4f53-ad\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG nova.api.openstack.placement.requestlog [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Starting request: 192.168.122.191 \"PUT \nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Acquired semaphore \"rc_cache\" {{(pid=9543) lock /usr\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Releasing semaphore \"rc_cache\" {{(pid=9543) lock /us\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Acquired semaphore \"rc_cache\" {{(pid=9543) lock /usr\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Releasing semaphore \"rc_cache\" {{(pid=9543) lock /us\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Acquired semaphore \"rc_cache\" {{(pid=9543) lock /usr\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Releasing semaphore \"rc_cache\" {{(pid=9543) lock /us\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Bad inventory: InvalidInventor\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation Traceback (most recent call last):\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation   File \"/opt/stack/nova/nova/api/openstack/placement/handlers/allocation.py\", line 249, in _set_\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation     allocations.create_all()\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation   File \"/opt/stack/nova/nova/objects/resource_provider.py\", line 1869, in create_all\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation     self._set_allocations(self._context, self.objects)\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/enginefacade.py\", line 979, in\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation     return fn(*args, **kwargs)\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation   File \"/opt/stack/nova/nova/objects/resource_provider.py\", line 1829, in _set_allocations\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation     before_gens = _check_capacity_exceeded(conn, allocs)\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation   File \"/opt/stack/nova/nova/objects/resource_provider.py\", line 1633, in _check_capacity_exceed\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation     resource_provider=rp_uuid)\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation InvalidInventory: Inventory for 'CUSTOM_MAGIC' on resource provider 'a0a1d7f3-41f0-448f-ba36-e57\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation \nJul 20 11:44:39 ubuntu <email address hidden>[9538]: DEBUG nova.api.openstack.placement.wsgi_wrapper [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Placement API returning an error resp", 
    "tags": [
        "placement"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1705487", 
    "owner": "https://api.launchpad.net/1.0/~jaypipes", 
    "id": 1705487, 
    "index": 947, 
    "created": "2017-07-20 13:43:06.724334+00:00", 
    "title": "placement logs an ERROR when PUT /allocation result in an invalid inventory", 
    "comments": [
        {
            "content": "When an allocation requests on placement results in an invalid inventory due to the capacity is exceeded then placement return HTTP 409 properly but at the same time logs an ERROR log (see below). \nThe ERROR log is not necessary as this is not a software error.\n\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: [pid: 9543|app: 0|req: 790/1579] 192.168.122.191 () {66 vars in 1440 bytes} [Thu Jul 20 11:44:38 2017] PUT /placement/allocations/485c7480-939c-4b88-8c\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG nova.api.openstack.placement.requestlog [None req-ce309a62-3819-4ccb-8491-828046235f2d service placement] Starting request: 192.168.122.191 \"GET \nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-ce309a62-3819-4ccb-8491-828046235f2d service placement] Acquired semaphore \"rc_cache\" {{(pid=9542) lock /usr\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-ce309a62-3819-4ccb-8491-828046235f2d service placement] Releasing semaphore \"rc_cache\" {{(pid=9542) lock /us\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: INFO nova.api.openstack.placement.requestlog [None req-ce309a62-3819-4ccb-8491-828046235f2d service placement] 192.168.122.191 \"GET /placement/allocati\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: [pid: 9542|app: 0|req: 790/1580] 192.168.122.191 () {60 vars in 1344 bytes} [Thu Jul 20 11:44:38 2017] GET /placement/allocations/9fff84b6-71e4-4f53-ad\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG nova.api.openstack.placement.requestlog [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Starting request: 192.168.122.191 \"PUT \nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Acquired semaphore \"rc_cache\" {{(pid=9543) lock /usr\nJul 20 11:44:38 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Releasing semaphore \"rc_cache\" {{(pid=9543) lock /us\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Acquired semaphore \"rc_cache\" {{(pid=9543) lock /usr\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Releasing semaphore \"rc_cache\" {{(pid=9543) lock /us\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Acquired semaphore \"rc_cache\" {{(pid=9543) lock /usr\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: DEBUG oslo_concurrency.lockutils [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Releasing semaphore \"rc_cache\" {{(pid=9543) lock /us\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Bad inventory: InvalidInventor\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation Traceback (most recent call last):\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation   File \"/opt/stack/nova/nova/api/openstack/placement/handlers/allocation.py\", line 249, in _set_\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation     allocations.create_all()\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation   File \"/opt/stack/nova/nova/objects/resource_provider.py\", line 1869, in create_all\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation     self._set_allocations(self._context, self.objects)\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/enginefacade.py\", line 979, in\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation     return fn(*args, **kwargs)\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation   File \"/opt/stack/nova/nova/objects/resource_provider.py\", line 1829, in _set_allocations\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation     before_gens = _check_capacity_exceeded(conn, allocs)\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation   File \"/opt/stack/nova/nova/objects/resource_provider.py\", line 1633, in _check_capacity_exceed\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation     resource_provider=rp_uuid)\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation InvalidInventory: Inventory for 'CUSTOM_MAGIC' on resource provider 'a0a1d7f3-41f0-448f-ba36-e57\nJul 20 11:44:39 ubuntu <email address hidden>[9538]: ERROR nova.api.openstack.placement.handlers.allocation \nJul 20 11:44:39 ubuntu <email address hidden>[9538]: DEBUG nova.api.openstack.placement.wsgi_wrapper [None req-149d9b07-f06c-4b5b-ae8d-504d2a51340e service placement] Placement API returning an error resp", 
            "date_created": "2017-07-20 13:43:06.724334+00:00", 
            "author": "https://api.launchpad.net/1.0/~balazs-gibizer"
        }, 
        {
            "content": "Sure, this is a straightforward bug and fix. Just need to make the LOG be a DEBUG level not ERROR since, as Gibi points out, it's not a software error. Merely attempted to allocate against a full provider.", 
            "date_created": "2017-07-20 15:55:45.987470+00:00", 
            "author": "https://api.launchpad.net/1.0/~jaypipes"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/485726", 
            "date_created": "2017-07-20 16:01:06.035101+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/485726\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=66988da3db3bf73cd380db303bd0ca9bebcb3c64\nSubmitter: Jenkins\nBranch:    master\n\ncommit 66988da3db3bf73cd380db303bd0ca9bebcb3c64\nAuthor: Jay Pipes <email address hidden>\nDate:   Thu Jul 20 11:58:09 2017 -0400\n\n    Remove improper LOG.exception() calls in placement\n    \n    The PUT /allocations Placement API handler was improperly calling\n    LOG.exception() when two normal-operation events were occurring:\n    \n    1) When a concurrent attempt to allocate against the same resource\n    providers had occurred\n    \n    2) When, due to another process consuming resources concurrently\n    resulted in capacity being exceeded on one or more of the requested\n    providers\n    \n    Neither of the above scenarios is a software error and so the\n    LOG.exception() calls have been removed.\n    \n    Change-Id: I569b28313e52d979ac9be5bea88c021a0664d851\n    Fixes-bug: #1705487\n", 
            "date_created": "2017-07-21 03:20:01.883457+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}