{
    "status": "Won't Fix", 
    "last_updated": "2013-03-12 15:08:26.074270+00:00", 
    "description": "Expected:\nIf the /var/log/nova directory is deleted then nova loggers should fail and nova-api return with HTTP 500 and request should not proceed further.\n\nCurrent:\nIf the /var/log/nova/ directory is deleted then the logs are not written to nova-api.log file but the request is processed further. And the python-wsgi logs are failing with HTTP 400.\n\nTraceback (most recent call last):\nFile \"/usr/lib/python2.7/dist-packages/eventlet/greenpool.py\", line 80, in _spawn_n_impl\nfunc(*args, **kwargs)\nFile \"/usr/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 514, in process_request\nproto = self.protocol(socket, address, self)\nFile \"/usr/lib/python2.7/SocketServer.py\", line 638, in _init_\nself.handle()\nFile \"/usr/lib/python2.7/BaseHTTPServer.py\", line 340, in handle\nself.handle_one_request()\nFile \"/usr/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 232, in handle_one_request\nself.handle_one_response()\nFile \"/usr/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 393, in handle_one_response\nwall_seconds=finish - start))\nFile \"/usr/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 518, in log_message\nself.log.write(message + '\\n')\nFile \"/usr/lib/python2.7/dist-packages/nova/openstack/common/log.py\", line 380, in write\nself.logger.log(self.level, msg)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 1461, in log\nself.logger.log(level, msg, *args, **kwargs)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 1203, in log\nself._log(level, msg, args, **kwargs)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 1258, in _log\nself.handle(record)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 1268, in handle\nself.callHandlers(record)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 1308, in callHandlers\nhdlr.handle(record)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 748, in handle\nself.emit(record)\nFile \"/usr/lib/python2.7/logging/handlers.py\", line 408, in emit\nself.stream.flush()\nValueError: I/O operation on closed file\n\nroot@nova-in-a-box:/usr/share/pyshared# nova list\n------------------------------------------------------------------------------------+\nID \tName \tStatus \tNetworks\n\n------------------------------------------------------------------------------------+\n4854e498-bcce-49d0-8a93-753c023e6f72 \tat_boot_test \tACTIVE \tprivate=10.10.0.2, 10.30.0.1\n\n------------------------------------------------------------------------------------+\nroot@nova-in-a-box:/usr/share/pyshared# mv /var/log/nova/ /var/log/nova_bck\nroot@nova-in-a-box:/usr/share/pyshared# nova list\nERROR: n/a (HTTP 400)", 
    "tags": [], 
    "importance": "Low", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1065430", 
    "owner": "None", 
    "id": 1065430, 
    "index": 5565, 
    "created": "2012-10-11 09:17:17.489349+00:00", 
    "title": "If the log directory is not present then nova-api should fail to write the log messages", 
    "comments": [
        {
            "content": "Expected:\nIf the /var/log/nova directory is deleted then nova loggers should fail and nova-api return with HTTP 500 and request should not proceed further.\n\nCurrent:\nIf the /var/log/nova/ directory is deleted then the logs are not written to nova-api.log file but the request is processed further. And the python-wsgi logs are failing with HTTP 400.\n\nTraceback (most recent call last):\nFile \"/usr/lib/python2.7/dist-packages/eventlet/greenpool.py\", line 80, in _spawn_n_impl\nfunc(*args, **kwargs)\nFile \"/usr/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 514, in process_request\nproto = self.protocol(socket, address, self)\nFile \"/usr/lib/python2.7/SocketServer.py\", line 638, in _init_\nself.handle()\nFile \"/usr/lib/python2.7/BaseHTTPServer.py\", line 340, in handle\nself.handle_one_request()\nFile \"/usr/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 232, in handle_one_request\nself.handle_one_response()\nFile \"/usr/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 393, in handle_one_response\nwall_seconds=finish - start))\nFile \"/usr/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 518, in log_message\nself.log.write(message + '\\n')\nFile \"/usr/lib/python2.7/dist-packages/nova/openstack/common/log.py\", line 380, in write\nself.logger.log(self.level, msg)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 1461, in log\nself.logger.log(level, msg, *args, **kwargs)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 1203, in log\nself._log(level, msg, args, **kwargs)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 1258, in _log\nself.handle(record)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 1268, in handle\nself.callHandlers(record)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 1308, in callHandlers\nhdlr.handle(record)\nFile \"/usr/lib/python2.7/logging/_init_.py\", line 748, in handle\nself.emit(record)\nFile \"/usr/lib/python2.7/logging/handlers.py\", line 408, in emit\nself.stream.flush()\nValueError: I/O operation on closed file\n\nroot@nova-in-a-box:/usr/share/pyshared# nova list\n------------------------------------------------------------------------------------+\nID \tName \tStatus \tNetworks\n\n------------------------------------------------------------------------------------+\n4854e498-bcce-49d0-8a93-753c023e6f72 \tat_boot_test \tACTIVE \tprivate=10.10.0.2, 10.30.0.1\n\n------------------------------------------------------------------------------------+\nroot@nova-in-a-box:/usr/share/pyshared# mv /var/log/nova/ /var/log/nova_bck\nroot@nova-in-a-box:/usr/share/pyshared# nova list\nERROR: n/a (HTTP 400)", 
            "date_created": "2012-10-11 09:17:17.489349+00:00", 
            "author": "https://api.launchpad.net/1.0/~arathi-darshanam"
        }, 
        {
            "content": "Hi. What version of nova are you using?", 
            "date_created": "2012-10-15 20:41:15.799418+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "I am using nova-api  of 2012.2+git201208131210~precise-0ubuntu1 version", 
            "date_created": "2012-10-16 04:45:19.227059+00:00", 
            "author": "https://api.launchpad.net/1.0/~arathi-darshanam"
        }, 
        {
            "content": "I'm not really sure what the best approach here is. Do we really want nova to stop working because an admin deleted the log directory? What do other applications do in this case?\n\nI tested apache by moving the log directory away and it just keeps on serving, which I guess makes sense because the file descriptors are still valid until they're closed, even if the files are deleted.\n\nIf you remove the log directory and then restart apache then it refuses to start.\n\n", 
            "date_created": "2013-03-11 01:57:47.704983+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/24092", 
            "date_created": "2013-03-11 17:50:31.258746+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Actually, I went back and had another poke at this and I think the current behaviour is reasonable. Here's an example:\n\nmikal@xen:/opt/stack/nova$ grep log /etc/nova/nova.conf \nlogging_context_format_string = %(asctime)s.%(msecs)03d %(levelname)s %(name)s [%(request_id)s %(user_name)s %(project_name)s] %(instance)s%(message)s\nlogdir = /var/log/nova\n\nmikal@xen:/opt/stack/nova$ ls -l /var/log/nova\nls: cannot access /var/log/nova: No such file or directory\n\nmikal@xen:/opt/stack/nova$ cd /opt/stack/nova && /opt/stack/nova/bin/nova-api || touch \"/opt/stack/status/stack/n-api.failure\"\nTraceback (most recent call last):\n  File \"/opt/stack/nova/bin/nova-api\", line 51, in <module>\n    logging.setup(\"nova\")\n  File \"/opt/stack/nova/nova/openstack/common/log.py\", line 331, in setup\n    _setup_logging_from_conf(product_name)\n  File \"/opt/stack/nova/nova/openstack/common/log.py\", line 378, in _setup_logging_from_conf\n    filelog = logging.handlers.WatchedFileHandler(logpath)\n  File \"/usr/lib/python2.7/logging/handlers.py\", line 394, in __init__\n    logging.FileHandler.__init__(self, filename, mode, encoding, delay)\n  File \"/usr/lib/python2.7/logging/__init__.py\", line 901, in __init__\n    StreamHandler.__init__(self, self._open())\n  File \"/usr/lib/python2.7/logging/__init__.py\", line 924, in _open\n    stream = open(self.baseFilename, self.mode)\nIOError: [Errno 2] No such file or directory: '/var/log/nova/nova-api.log'\n\nSo, nova-api does refuse to start if the log directory is missing. I'm going to abandon my review and declare this not a bug unless anyone else has thoughts on this.", 
            "date_created": "2013-03-12 15:07:09.851621+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }
    ]
}