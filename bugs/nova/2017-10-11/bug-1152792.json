{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:17:59.782775+00:00", 
    "description": "To enable automatic confirmation after resize/migrate, we set the value of confirm_resize_window to 1.  This did in fact enable the processing for the automatic confirmation, but an error was returned because of a database access issue:\n\n2013-03-08 12:13:42.072 93054 INFO nova.compute.manager [-] Found 1 unconfirmed migrations older than 1 seconds\n2013-03-08 12:13:42.074 93054 INFO nova.compute.manager [-] Automatically confirming migration 18 for instance da9eba9d-0175-4b1c-b85f-246d7bb20c05\n2013-03-08 12:13:42.074 93054 DEBUG nova.openstack.common.rpc.amqp [-] Making synchronous call on conductor ... multicall /usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py:541\n2013-03-08 12:13:42.074 93054 DEBUG nova.openstack.common.rpc.amqp [-] MSG_ID is 14ef28def01b4e55aa8db832b236dfbe multicall /usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py:544\n2013-03-08 12:13:42.231 93054 DEBUG nova.utils [-] Reloading cached file /etc/nova/policy.json read_cached_file /usr/lib/python2.6/site-packages/nova/utils.py:1123\n2013-03-08 12:13:42.242 93054 ERROR nova.compute [-] No db access allowed in nova-compute:   File \"/usr/lib/python2.6/site-packages/eventlet/greenthread.py\", line 192, in main\n    result = function(*args, **kwargs)\n  File \"/usr/lib/python2.6/site-packages/nova/utils.py\", line 636, in _inner\n    idle = self.f(*self.args, **self.kw)\n  File \"/usr/lib/python2.6/site-packages/nova/service.py\", line 571, in periodic_tasks\n    return self.manager.periodic_tasks(ctxt, raise_on_error=raise_on_error)\n  File \"/usr/lib/python2.6/site-packages/nova/manager.py\", line 241, in periodic_tasks\n    task(self, context)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3248, in _poll_unconfirmed_resizes\n    self.compute_api.confirm_resize(context, instance)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/api.py\", line 170, in wrapped\n    return func(self, context, target, *args, **kwargs)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/api.py\", line 160, in inner\n    return function(self, context, instance, *args, **kwargs)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/api.py\", line 141, in inner\n    return f(self, context, instance, *args, **kw)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/api.py\", line 1852, in confirm_resize\n    instance['uuid'], 'finished')\n  File \"/usr/lib/python2.6/site-packages/nova/db/api.py\", line 397, in migration_get_by_instance_and_status\n    status)\n  File \"/usr/bin/nova-compute\", line 66, in __call__\n    stacktrace = \"\".join(traceback.format_stack()) \n\n\nAfter searching the community and coming across the blueprint at https://blueprints.launchpad.net/nova/+spec/no-db-compute and the bug at https://bugs.launchpad.net/nova/+bug/823000, I started to suspect the issue could have been caused by this change.  To test this theory, in /usr/bin/nova-compute we commented out lines 78 and 79 and set the parm referenced in line 83 to db_allowed=True (https://github.com/openstack/nova/blob/master/bin/nova-compute#L78).  After restarting nova and trying a new resize operation, the automatic confirmation was working.", 
    "tags": [], 
    "importance": "High", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1152792", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1152792, 
    "index": 1008, 
    "created": "2013-03-08 22:44:06.948117+00:00", 
    "title": "automatic confirmation after resize fails", 
    "comments": [
        {
            "content": "To enable automatic confirmation after resize/migrate, we set the value of confirm_resize_window to 1.  This did in fact enable the processing for the automatic confirmation, but an error was returned because of a database access issue:\n\n2013-03-08 12:13:42.072 93054 INFO nova.compute.manager [-] Found 1 unconfirmed migrations older than 1 seconds\n2013-03-08 12:13:42.074 93054 INFO nova.compute.manager [-] Automatically confirming migration 18 for instance da9eba9d-0175-4b1c-b85f-246d7bb20c05\n2013-03-08 12:13:42.074 93054 DEBUG nova.openstack.common.rpc.amqp [-] Making synchronous call on conductor ... multicall /usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py:541\n2013-03-08 12:13:42.074 93054 DEBUG nova.openstack.common.rpc.amqp [-] MSG_ID is 14ef28def01b4e55aa8db832b236dfbe multicall /usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py:544\n2013-03-08 12:13:42.231 93054 DEBUG nova.utils [-] Reloading cached file /etc/nova/policy.json read_cached_file /usr/lib/python2.6/site-packages/nova/utils.py:1123\n2013-03-08 12:13:42.242 93054 ERROR nova.compute [-] No db access allowed in nova-compute:   File \"/usr/lib/python2.6/site-packages/eventlet/greenthread.py\", line 192, in main\n    result = function(*args, **kwargs)\n  File \"/usr/lib/python2.6/site-packages/nova/utils.py\", line 636, in _inner\n    idle = self.f(*self.args, **self.kw)\n  File \"/usr/lib/python2.6/site-packages/nova/service.py\", line 571, in periodic_tasks\n    return self.manager.periodic_tasks(ctxt, raise_on_error=raise_on_error)\n  File \"/usr/lib/python2.6/site-packages/nova/manager.py\", line 241, in periodic_tasks\n    task(self, context)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3248, in _poll_unconfirmed_resizes\n    self.compute_api.confirm_resize(context, instance)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/api.py\", line 170, in wrapped\n    return func(self, context, target, *args, **kwargs)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/api.py\", line 160, in inner\n    return function(self, context, instance, *args, **kwargs)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/api.py\", line 141, in inner\n    return f(self, context, instance, *args, **kw)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/api.py\", line 1852, in confirm_resize\n    instance['uuid'], 'finished')\n  File \"/usr/lib/python2.6/site-packages/nova/db/api.py\", line 397, in migration_get_by_instance_and_status\n    status)\n  File \"/usr/bin/nova-compute\", line 66, in __call__\n    stacktrace = \"\".join(traceback.format_stack()) \n\n\nAfter searching the community and coming across the blueprint at https://blueprints.launchpad.net/nova/+spec/no-db-compute and the bug at https://bugs.launchpad.net/nova/+bug/823000, I started to suspect the issue could have been caused by this change.  To test this theory, in /usr/bin/nova-compute we commented out lines 78 and 79 and set the parm referenced in line 83 to db_allowed=True (https://github.com/openstack/nova/blob/master/bin/nova-compute#L78).  After restarting nova and trying a new resize operation, the automatic confirmation was working.", 
            "date_created": "2013-03-08 22:44:06.948117+00:00", 
            "author": "https://api.launchpad.net/1.0/~philnel"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/24090", 
            "date_created": "2013-03-11 17:16:30.369549+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/24090\nCommitted: http://github.com/openstack/nova/commit/d8d7d148fe2c185f2efda0c4cfc2ca125d4008d7\nSubmitter: Jenkins\nBranch:    master\n\ncommit d8d7d148fe2c185f2efda0c4cfc2ca125d4008d7\nAuthor: Dan Smith <email address hidden>\nDate:   Mon Mar 11 13:13:11 2013 -0400\n\n    Pass migration_ref when when auto-confirming\n    \n    The _poll_unconfirmed_resizes() task in compute/manager calls back to\n    compute_api to confirm resizes. This triggers a db lookup for the\n    migration, which is not allowed by no-db-compute. Since we already have\n    the migration, pass it through to avoid the lookup.\n    \n    Since this doesn't change rpcapi (and thus, RPC clients should not\n    know about this optional paramter), we don't need to bump the RPC\n    version here.\n    \n    Fixes bug 1152792\n    \n    Change-Id: I4bd3b0c88968ed7f64e7df0afa12e83009ee8ccf\n", 
            "date_created": "2013-03-12 00:55:58.604962+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}