{
    "status": "Fix Released", 
    "last_updated": "2015-11-03 16:24:45.507368+00:00", 
    "description": "Tempest scenario TestEncryptedCinderVolumes has been silently skipped when run with NFS cinder drivers that did not\nset the 'encrypted' key in the connection_info['data'] dict in their initialize_connection methods.  Change\nhttps://review.openstack.org/#/c/193673/ - which sets the encrypted flag generically, in the VolumeManager's\ninitialize_connection, on the basis of the volume.encryption_key_id value - causes this test to actually run its encryption\nproviders and exposes a problem in LuksEncryptor:attach_volume() for NFS exported volumes.\n\nAt https://github.com/openstack/nova/blob/master/nova/volume/encryptors/luks.py#L119 we have:\n\n        # modify the original symbolic link to refer to the decrypted device\n        utils.execute('ln', '--symbolic', '--force',\n                      '/dev/mapper/%s' % self.dev_name, self.symlink_path,\n                      run_as_root=True, check_exit_code=True)\n\nbut in TestEncryptedCinderVolumes we get the following exception:\n\n2015-06-29 06:44:06.353 DEBUG oslo_concurrency.processutils [req-35a458fe-8bfc-4570-ac8e-388e8b74d4ea TestEncryptedCinderVolumes-1523565967 TestEncryptedCinderVolumes-1577400956] u'sudo nova-rootwrap /etc/nova/rootwrap.conf ln --symbolic --force /dev/mapper/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc /opt/stack/data/nova/mnt/21dd48babac42ae884d1192b8697a041/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc' failed. Not Retrying. execute /usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py:293\n2015-06-29 06:44:06.353 ERROR nova.virt.libvirt.driver [req-35a458fe-8bfc-4570-ac8e-388e8b74d4ea TestEncryptedCinderVolumes-1523565967 TestEncryptedCinderVolumes-1577400956] [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Failed to attach volume at mountpoint: /dev/vdb\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Traceback (most recent call last):\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 1082, in attach_volume\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]     encryptor.attach_volume(context, **encryption)\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]   File \"/opt/stack/new/nova/nova/volume/encryptors/luks.py\", line 121, in attach_volume\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]     run_as_root=True, check_exit_code=True)\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]   File \"/opt/stack/new/nova/nova/utils.py\", line 229, in execute\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]     return processutils.execute(*cmd, **kwargs)\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\", line 260, in execute\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]     cmd=sanitized_cmd)\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] ProcessExecutionError: Unexpected error while running command.\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf ln --symbolic --force /dev/mapper/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc /opt/stack/data/nova/mnt/21dd48babac42ae884d1192b8697a041/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Exit code: 99\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Stdout: u''\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Stderr: u'/usr/local/bin/nova-rootwrap: Unauthorized command: ln --symbolic --force /dev/mapper/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc /opt/stack/data/nova/mnt/21dd48babac42ae884d1192b8697a041/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc (no filter matched)\\n'\n\nThe cause is evidently the rootwrap filter at\nhttps://github.com/openstack/nova/blob/master/etc/nova/rootwrap.d/compute.filters#L215, namely:\n\nln: RegExpFilter, ln, root, ln, --symbolic, --force, /dev/mapper/ip-.*-iscsi-iqn.*, /dev/disk/by-path/ip-.*-iscsi-iqn.*\n\nwhich only allows for iscsi paths.", 
    "tags": [
        "low-hanging-fruit", 
        "rootwrap", 
        "volumes"
    ], 
    "importance": "Medium", 
    "heat": 20, 
    "link": "https://bugs.launchpad.net/nova/+bug/1470142", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1470142, 
    "index": 4282, 
    "created": "2015-06-30 15:15:25.835359+00:00", 
    "title": "Nova volume encryptors attach volume fails for NFS and FC (rootwrap)", 
    "comments": [
        {
            "content": "Tempest scenario TestEncryptedCinderVolumes has been silently skipped when run with NFS cinder drivers that did not\nset the 'encrypted' key in the connection_info['data'] dict in their initialize_connection methods.  Change\nhttps://review.openstack.org/#/c/193673/ - which sets the encrypted flag generically, in the VolumeManager's\ninitialize_connection, on the basis of the volume.encryption_key_id value - causes this test to actually run its encryption\nproviders and exposes a problem in LuksEncryptor:attach_volume() for NFS exported volumes.\n\nAt https://github.com/openstack/nova/blob/master/nova/volume/encryptors/luks.py#L119 we have:\n\n        # modify the original symbolic link to refer to the decrypted device\n        utils.execute('ln', '--symbolic', '--force',\n                      '/dev/mapper/%s' % self.dev_name, self.symlink_path,\n                      run_as_root=True, check_exit_code=True)\n\nbut in TestEncryptedCinderVolumes we get the following exception:\n\n2015-06-29 06:44:06.353 DEBUG oslo_concurrency.processutils [req-35a458fe-8bfc-4570-ac8e-388e8b74d4ea TestEncryptedCinderVolumes-1523565967 TestEncryptedCinderVolumes-1577400956] u'sudo nova-rootwrap /etc/nova/rootwrap.conf ln --symbolic --force /dev/mapper/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc /opt/stack/data/nova/mnt/21dd48babac42ae884d1192b8697a041/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc' failed. Not Retrying. execute /usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py:293\n2015-06-29 06:44:06.353 ERROR nova.virt.libvirt.driver [req-35a458fe-8bfc-4570-ac8e-388e8b74d4ea TestEncryptedCinderVolumes-1523565967 TestEncryptedCinderVolumes-1577400956] [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Failed to attach volume at mountpoint: /dev/vdb\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Traceback (most recent call last):\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 1082, in attach_volume\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]     encryptor.attach_volume(context, **encryption)\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]   File \"/opt/stack/new/nova/nova/volume/encryptors/luks.py\", line 121, in attach_volume\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]     run_as_root=True, check_exit_code=True)\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]   File \"/opt/stack/new/nova/nova/utils.py\", line 229, in execute\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]     return processutils.execute(*cmd, **kwargs)\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\", line 260, in execute\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8]     cmd=sanitized_cmd)\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] ProcessExecutionError: Unexpected error while running command.\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf ln --symbolic --force /dev/mapper/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc /opt/stack/data/nova/mnt/21dd48babac42ae884d1192b8697a041/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Exit code: 99\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Stdout: u''\n2015-06-29 06:44:06.353 13140 ERROR nova.virt.libvirt.driver [instance: b285fed7-6d65-4b57-9ab0-8c17ce0cf6a8] Stderr: u'/usr/local/bin/nova-rootwrap: Unauthorized command: ln --symbolic --force /dev/mapper/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc /opt/stack/data/nova/mnt/21dd48babac42ae884d1192b8697a041/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc (no filter matched)\\n'\n\nThe cause is evidently the rootwrap filter at\nhttps://github.com/openstack/nova/blob/master/etc/nova/rootwrap.d/compute.filters#L215, namely:\n\nln: RegExpFilter, ln, root, ln, --symbolic, --force, /dev/mapper/ip-.*-iscsi-iqn.*, /dev/disk/by-path/ip-.*-iscsi-iqn.*\n\nwhich only allows for iscsi paths.", 
            "date_created": "2015-06-30 15:15:25.835359+00:00", 
            "author": "https://api.launchpad.net/1.0/~tpb"
        }, 
        {
            "content": "The test failed on the FC driver also because Nova was using the nova rootwrap filter for the iSCSI device.\n\n2015-06-29 05:02:18.267 16351 ERROR nova.virt.libvirt.driver [instance: 9d62ca74-31ad-4691-af75-3c2e4f758c72] cmd=sanitized_cmd) 2015-06-29 05:02:18.267 16351 ERROR nova.virt.libvirt.driver [instance: 9d62ca74-31ad-4691-af75-3c2e4f758c72] ProcessExecutionError: Unexpected error while running command. 2015-06-29 05:02:18.267 16351 ERROR nova.virt.libvirt.driver [instance: 9d62ca74-31ad-4691-af75-3c2e4f758c72] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf ln --symbolic --force /dev/mapper/pci-0000:06:00.0-fc-0x5006016508603f9f-lun-151 /dev/disk/by-path/pci-0000:06:00.0-fc-0x5006016508603f9f-lun-151 2015-06-29 05:02:18.267 16351 ERROR nova.virt.libvirt.driver [instance: 9d62ca74-31ad-4691-af75-3c2e4f758c72] Exit code: 99 2015-06-29 05:02:18.267 16351 ERROR nova.virt.libvirt.driver [instance: 9d62ca74-31ad-4691-af75-3c2e4f758c72] Stdout: u'' 2015-06-29 05:02:18.267 16351 ERROR nova.virt.libvirt.driver [instance: 9d62ca74-31ad-4691-af75-3c2e4f758c72] Stderr: u'/usr/local/bin/nova-rootwrap: Unauthorized command: ln --symbolic --force /dev/mapper/pci-0000:06:00.0-fc-0x5006016508603f9f-lun-151 /dev/disk/by-path/pci-0000:06:00.0-fc-0x5006016508603f9f-lun-151 (no filter matched)\\n' 2015-06-29 05:02:18.267 16351 ERROR nova.virt.libvirt.driver [instance: 9d62ca74-31ad-4691-af75-3c2e4f758c72]", 
            "date_created": "2015-06-30 19:54:37.505291+00:00", 
            "author": "https://api.launchpad.net/1.0/~xing-yang"
        }, 
        {
            "content": "Same thing happens for test_encrypted_cinder_volumes_cryptsetup.", 
            "date_created": "2015-07-01 15:09:18.975130+00:00", 
            "author": "https://api.launchpad.net/1.0/~tpb"
        }, 
        {
            "content": "Possibly related for the FC issue: https://review.openstack.org/#/c/195350/", 
            "date_created": "2015-07-01 16:10:29.248309+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/197713\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0facd1f89edfd88188662e0cac274a136a424c3d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0facd1f89edfd88188662e0cac274a136a424c3d\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Jul 1 12:09:49 2015 -0700\n\n    rootwrap: update ln --symbolic filter for FS and FC type volume drivers\n    \n    Cinder change I03f8cae05cc117e14f7482115de685fc9f3fa54a sets the\n    'encrypted' key for all cinder volume drivers connection_info. When run\n    through the encrypted volume tests in Tempest, this hits the encryption\n    providers in Nova that fail for certain types of volume drivers, like\n    file system and fibre channel, due to the rootwrap filter not matching.\n    \n    This change updates the symbolic link rootwrap filter so it works with\n    file system and fibre channel type volume backends rather than just\n    iSCSI.\n    \n    The /dev/mapper/ prefix is always set in the encryptor modules, so that\n    can remain as before.\n    \n    The symbolic link path is a complete wildcard, however, because the file\n    system volume backends all have a configurable option for the mount path\n    prefix, which defaults to $state_path/mnt but may not be that value.\n    \n    An example call for NFS:\n    \n    ln --symbolic --force \\\n    /dev/mapper/volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc \\\n    /opt/stack/data/nova/mnt/21dd48babac42ae884d1192b8697a041/\\\n    volume-f5684ecc-959f-4de8-8d62-a8adf4bdb4cc\n    \n    An example call for fibre channel:\n    \n    ln --symbolic --force \\\n    /dev/mapper/pci-0000:06:00.0-fc-0x5006016508603f9f-lun-151 \\\n    /dev/disk/by-path/pci-0000:06:00.0-fc-0x5006016508603f9f-lun-151\n    \n    This change also updates the sg_info and sgscan entries to reference the\n    correct module since those are not called from nova.virt.libvirt.volume\n    anymore.\n    \n    Closes-Bug: #1470142\n    Related-Bug: #1440227\n    \n    Change-Id: I181b594a3119f7ad74c595fc7059d521079b1d74\n", 
            "date_created": "2015-07-27 11:54:58.085747+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/237582", 
            "date_created": "2015-10-20 13:36:16.687591+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Lee Yarwood (<email address hidden>) on branch: stable/kilo\nReview: https://review.openstack.org/237582\nReason: Missed stable/kilo that is now security fixes only.", 
            "date_created": "2015-11-03 16:24:44.731109+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}