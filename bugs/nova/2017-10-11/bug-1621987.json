{
    "status": "Fix Released", 
    "last_updated": "2016-10-18 17:01:47.387483+00:00", 
    "description": "By default, 1000 greenthreads can be used to synchronize the power state of instances running on a compute node.\n\nIn the Ironic context, this means 1000 simultaneous HTTP requests can be initiated to the Ironic API. Some of those requests can fail with the following error:\n\n    ERROR nova.compute.manager [-] [instance: XXXXXXXXXXXXXX] Periodic sync_power_state task had an error while processing an instance.\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX] Traceback (most recent call last):\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 6083, in _sync\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     query_driver_power_state_and_sync()\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/oslo_concurrency/lockutils.py\", line 252, in inner\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     return f(*args, **kwargs)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 6080, in query_driver_power_state_and_sync\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     self._query_driver_power_state_and_sync(context, db_instance)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 6110, in _query_driver_power_state_and_sync\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     vm_instance = self.driver.get_info(db_instance)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/virt/ironic/driver.py\", line 557, in get_info\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     node = _validate_instance_and_node(self.ironicclient, instance)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/virt/ironic/driver.py\", line 126, in _validate_instance_and_node\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     return ironicclient.call(\"node.get_by_instance_uuid\", instance.uuid)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/virt/ironic/client_wrapper.py\", line 122, in call\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     return self._multi_getattr(client, method)(*args, **kwargs)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/ironicclient/v1/node.py\", line 151, in get_by_instance_uuid\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     nodes = self._list(self._path(path), 'nodes')\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/ironicclient/common/base.py\", line 119, in _list\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     resp, body = self.api.json_request('GET', url)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/ironicclient/common/http.py\", line 351, in json_request\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     resp, body_iter = self._http_request(url, method, **kwargs)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/ironicclient/common/http.py\", line 160, in wrapper\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     return func(self, url, method, **kwargs)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/ironicclient/common/http.py\", line 296, in _http_request\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     resp = conn.getresponse()\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/usr/lib/python2.7/httplib.py\", line 1051, in getresponse\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     response.begin()\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/usr/lib/python2.7/httplib.py\", line 415, in begin\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     version, status, reason = self._read_status()\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/usr/lib/python2.7/httplib.py\", line 379, in _read_status\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     raise BadStatusLine(line)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX] BadStatusLine: ''\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX] \n\nThere should be a way to limit the number of simultaneous requests made against the hypervisor to synchronize the instance power states so it's not overwhelm.", 
    "tags": [
        "compute", 
        "ironic"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1621987", 
    "owner": "https://api.launchpad.net/1.0/~mgagne", 
    "id": 1621987, 
    "index": 4620, 
    "created": "2016-09-09 19:32:39.388645+00:00", 
    "title": "Power state synchronization in compute is too agressive", 
    "comments": [
        {
            "content": "By default, 1000 greenthreads can be used to synchronize the power state of instances running on a compute node.\n\nIn the Ironic context, this means 1000 simultaneous HTTP requests can be initiated to the Ironic API. Some of those requests can fail with the following error:\n\n    ERROR nova.compute.manager [-] [instance: XXXXXXXXXXXXXX] Periodic sync_power_state task had an error while processing an instance.\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX] Traceback (most recent call last):\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 6083, in _sync\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     query_driver_power_state_and_sync()\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/oslo_concurrency/lockutils.py\", line 252, in inner\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     return f(*args, **kwargs)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 6080, in query_driver_power_state_and_sync\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     self._query_driver_power_state_and_sync(context, db_instance)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 6110, in _query_driver_power_state_and_sync\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     vm_instance = self.driver.get_info(db_instance)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/virt/ironic/driver.py\", line 557, in get_info\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     node = _validate_instance_and_node(self.ironicclient, instance)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/virt/ironic/driver.py\", line 126, in _validate_instance_and_node\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     return ironicclient.call(\"node.get_by_instance_uuid\", instance.uuid)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/nova/virt/ironic/client_wrapper.py\", line 122, in call\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     return self._multi_getattr(client, method)(*args, **kwargs)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/ironicclient/v1/node.py\", line 151, in get_by_instance_uuid\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     nodes = self._list(self._path(path), 'nodes')\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/ironicclient/common/base.py\", line 119, in _list\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     resp, body = self.api.json_request('GET', url)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/ironicclient/common/http.py\", line 351, in json_request\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     resp, body_iter = self._http_request(url, method, **kwargs)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/ironicclient/common/http.py\", line 160, in wrapper\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     return func(self, url, method, **kwargs)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/opt/nova/local/lib/python2.7/site-packages/ironicclient/common/http.py\", line 296, in _http_request\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     resp = conn.getresponse()\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/usr/lib/python2.7/httplib.py\", line 1051, in getresponse\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     response.begin()\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/usr/lib/python2.7/httplib.py\", line 415, in begin\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     version, status, reason = self._read_status()\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]   File \"/usr/lib/python2.7/httplib.py\", line 379, in _read_status\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX]     raise BadStatusLine(line)\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX] BadStatusLine: ''\n    ERROR nova.compute.manager [instance: XXXXXXXXXXXXXX] \n\nThere should be a way to limit the number of simultaneous requests made against the hypervisor to synchronize the instance power states so it's not overwhelm.", 
            "date_created": "2016-09-09 19:32:39.388645+00:00", 
            "author": "https://api.launchpad.net/1.0/~mgagne"
        }, 
        {
            "content": "Patch is here: https://review.openstack.org/#/c/367746/", 
            "date_created": "2016-09-09 20:59:14.352814+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/367746\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=386812e287198cd2d340d273753ef06075f7c05d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 386812e287198cd2d340d273753ef06075f7c05d\nAuthor: Mathieu Gagne\u0301 <email address hidden>\nDate:   Fri Sep 9 00:35:50 2016 -0400\n\n    Add sync_power_state_pool_size option\n    \n    The sync_power_state_pool_size option allows to set\n    the number of greenthreads available for use to sync power states.\n    \n    It can be used to reduce the number of concurrent requests\n    made to the hypervisor or system with real instance power states\n    for performance reasons.\n    \n    Closes-bug: #1621987\n    Change-Id: I9cf900314d71c44ec51eb190c102ddc60e13a767\n", 
            "date_created": "2016-09-12 15:46:42.916414+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/368951", 
            "date_created": "2016-09-12 16:27:34.716123+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/368951\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=328d8a18e5d31829c6356b8dc9a148169e7ce34c\nSubmitter: Jenkins\nBranch:    master\n\ncommit 328d8a18e5d31829c6356b8dc9a148169e7ce34c\nAuthor: Mathieu Gagne\u0301 <email address hidden>\nDate:   Mon Sep 12 12:26:11 2016 -0400\n\n    Extended description for sync_power_state_pool_size option\n    \n    Explain why you would want to configure its value.\n    \n    Change-Id: I44e30d4839ffd4aef3be6a83a091bff2a09c55b9\n    Related-bug: #1621987\n", 
            "date_created": "2016-09-12 19:37:30.141290+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0rc1 release candidate.", 
            "date_created": "2016-09-26 20:14:06.924541+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0rc1 release candidate.", 
            "date_created": "2016-10-18 17:01:46.570383+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}