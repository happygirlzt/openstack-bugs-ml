{
    "status": "Fix Released", 
    "last_updated": "2012-03-28 09:55:40.464094+00:00", 
    "description": "Seems like the container is still running when nova tries to detach the container, therefore failing:\n\nroot@compute01:~# fuser -m /dev/loop1\n/dev/loop1:          15525rce 15535rce 18189rce 18197rce 18203rce 18214rce\n\nThe processes:\n15525 ?        Ss     0:00 /sbin/init\n15535 ?        S      0:00 /sbin/plymouthd --mode=boot --attach-to-session\n18189 ?        S      0:00 upstart-udev-bridge --daemon\n18197 ?        Ss     0:00 /usr/sbin/sshd -D\n18203 ?        Sl     0:00 rsyslogd -c4\n18214 ?        S<s    0:00 udevd --daemon\n\nTrace:\n2011-09-04 16:18:31,704 INFO nova.virt.libvirt_conn [-] instance instance-00000110: deleting instance files /var/lib/nova/instances/instance-00000110\n2011-09-04 16:18:31,706 DEBUG nova.utils [-] Running cmd (subprocess): sudo umount /var/lib/nova/instances/instance-00000110/rootfs from (pid=15094) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-04 16:18:31,867 DEBUG nova.utils [-] Running cmd (subprocess): sudo losetup -a from (pid=15094) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-04 16:18:32,033 DEBUG nova.utils [-] Running cmd (subprocess): sudo losetup --detach /dev/loop1 from (pid=15094) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-04 16:18:32,184 DEBUG nova.utils [-] Result was 1 from (pid=15094) execute /usr/lib/pymodules/python2.7/nova/utils.py:180\n2011-09-04 16:18:32,208 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/exception.py\", line 98, in wrapped\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/compute/manager.py\", line 117, in decorated_function\n(nova.exception): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/compute/manager.py\", line 492, in terminate_instance\n(nova.exception): TRACE:     self._shutdown_instance(context, instance_id, 'Terminating')\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/compute/manager.py\", line 483, in _shutdown_instance\n(nova.exception): TRACE:     self.driver.destroy(instance, network_info)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/virt/libvirt/connection.py\", line 326, in destroy\n(nova.exception): TRACE:     self._cleanup(instance)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/virt/libvirt/connection.py\", line 336, in _cleanup\n(nova.exception): TRACE:     disk.destroy_container(target, instance, nbd=FLAGS.use_cow_images)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/virt/disk.py\", line 159, in destroy_container\n(nova.exception): TRACE:     _unlink_device(device, nbd)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/virt/disk.py\", line 190, in _unlink_device\n(nova.exception): TRACE:     utils.execute('losetup', '--detach', device, run_as_root=True)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/utils.py\", line 188, in execute\n(nova.exception): TRACE:     cmd=' '.join(cmd))\n(nova.exception): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova.exception): TRACE: Command: sudo losetup --detach /dev/loop1\n(nova.exception): TRACE: Exit code: 1\n(nova.exception): TRACE: Stdout: ''\n(nova.exception): TRACE: Stderr: \"loop: can't delete device /dev/loop1: Device or resource busy\\n\"\n(nova.exception): TRACE: \n2011-09-04 16:18:32,218 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/exception.py\", line 129, in wrapped\n(nova.rpc): TRACE:     raise Error(str(e))\n(nova.rpc): TRACE: Error: Unexpected error while running command.\n(nova.rpc): TRACE: Command: sudo losetup --detach /dev/loop1\n(nova.rpc): TRACE: Exit code: 1\n(nova.rpc): TRACE: Stdout: ''\n(nova.rpc): TRACE: Stderr: \"loop: can't delete device /dev/loop1: Device or resource busy\\n\"\n\nUsing these versions:\nii nova-common 2011.3~rc~20110903.1526-0ubuntu0ppa1~natty1 OpenStack Compute - common files\nii nova-compute 2011.3~rc~20110903.1526-0ubuntu0ppa1~natty1 OpenStack Compute - compute node\nii nova-compute-kvm 2011.3~rc~20110903.1526-0ubuntu0ppa1~natty1 OpenStack Compute - compute node (KVM)\n\nMy configuration:\n--cc_host=controller\n--ec2_url=http://controller:8773/services/Cloud\n--ec2_host=controller\n--rabbit_host=controller\n--network_manager=nova.network.manager.VlanManager\n--flat_interface=eth0\n--fixed_range=172.16.0.0/16\n--network_size=256\n--sql_connection=mysql://nova:passW0rd@controller/nova\n--glance_api_servers=glance:9292\n--image_service=nova.image.glance.GlanceImageService\n--network_host=controller\n--vnc_console_proxy_url=http://controller:6080\n--vncproxy_url=http://controller:6080\n--vncproxy_host=controller\n--vnc_enabled=False\n--minimum_root_size=2147483648\n--iscsi_ip_prefix=192.168.191\n--libvirt_type=lxc\n--use_cow_images=False\n\nMy DB version:\n44", 
    "tags": [
        "lxc"
    ], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/841060", 
    "owner": "https://api.launchpad.net/1.0/~zulcss", 
    "id": 841060, 
    "index": 475, 
    "created": "2011-09-04 14:25:14.085890+00:00", 
    "title": "Terminating an instance with --libvirt_type=lxc fails, can't detach loop device", 
    "comments": [
        {
            "content": "Seems like the container is still running when nova tries to detach the container, therefore failing:\n\nroot@compute01:~# fuser -m /dev/loop1\n/dev/loop1:          15525rce 15535rce 18189rce 18197rce 18203rce 18214rce\n\nThe processes:\n15525 ?        Ss     0:00 /sbin/init\n15535 ?        S      0:00 /sbin/plymouthd --mode=boot --attach-to-session\n18189 ?        S      0:00 upstart-udev-bridge --daemon\n18197 ?        Ss     0:00 /usr/sbin/sshd -D\n18203 ?        Sl     0:00 rsyslogd -c4\n18214 ?        S<s    0:00 udevd --daemon\n\nTrace:\n2011-09-04 16:18:31,704 INFO nova.virt.libvirt_conn [-] instance instance-00000110: deleting instance files /var/lib/nova/instances/instance-00000110\n2011-09-04 16:18:31,706 DEBUG nova.utils [-] Running cmd (subprocess): sudo umount /var/lib/nova/instances/instance-00000110/rootfs from (pid=15094) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-04 16:18:31,867 DEBUG nova.utils [-] Running cmd (subprocess): sudo losetup -a from (pid=15094) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-04 16:18:32,033 DEBUG nova.utils [-] Running cmd (subprocess): sudo losetup --detach /dev/loop1 from (pid=15094) execute /usr/lib/pymodules/python2.7/nova/utils.py:165\n2011-09-04 16:18:32,184 DEBUG nova.utils [-] Result was 1 from (pid=15094) execute /usr/lib/pymodules/python2.7/nova/utils.py:180\n2011-09-04 16:18:32,208 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/exception.py\", line 98, in wrapped\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/compute/manager.py\", line 117, in decorated_function\n(nova.exception): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/compute/manager.py\", line 492, in terminate_instance\n(nova.exception): TRACE:     self._shutdown_instance(context, instance_id, 'Terminating')\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/compute/manager.py\", line 483, in _shutdown_instance\n(nova.exception): TRACE:     self.driver.destroy(instance, network_info)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/virt/libvirt/connection.py\", line 326, in destroy\n(nova.exception): TRACE:     self._cleanup(instance)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/virt/libvirt/connection.py\", line 336, in _cleanup\n(nova.exception): TRACE:     disk.destroy_container(target, instance, nbd=FLAGS.use_cow_images)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/virt/disk.py\", line 159, in destroy_container\n(nova.exception): TRACE:     _unlink_device(device, nbd)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/virt/disk.py\", line 190, in _unlink_device\n(nova.exception): TRACE:     utils.execute('losetup', '--detach', device, run_as_root=True)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/utils.py\", line 188, in execute\n(nova.exception): TRACE:     cmd=' '.join(cmd))\n(nova.exception): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova.exception): TRACE: Command: sudo losetup --detach /dev/loop1\n(nova.exception): TRACE: Exit code: 1\n(nova.exception): TRACE: Stdout: ''\n(nova.exception): TRACE: Stderr: \"loop: can't delete device /dev/loop1: Device or resource busy\\n\"\n(nova.exception): TRACE: \n2011-09-04 16:18:32,218 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/pymodules/python2.7/nova/exception.py\", line 129, in wrapped\n(nova.rpc): TRACE:     raise Error(str(e))\n(nova.rpc): TRACE: Error: Unexpected error while running command.\n(nova.rpc): TRACE: Command: sudo losetup --detach /dev/loop1\n(nova.rpc): TRACE: Exit code: 1\n(nova.rpc): TRACE: Stdout: ''\n(nova.rpc): TRACE: Stderr: \"loop: can't delete device /dev/loop1: Device or resource busy\\n\"\n\nUsing these versions:\nii nova-common 2011.3~rc~20110903.1526-0ubuntu0ppa1~natty1 OpenStack Compute - common files\nii nova-compute 2011.3~rc~20110903.1526-0ubuntu0ppa1~natty1 OpenStack Compute - compute node\nii nova-compute-kvm 2011.3~rc~20110903.1526-0ubuntu0ppa1~natty1 OpenStack Compute - compute node (KVM)\n\nMy configuration:\n--cc_host=controller\n--ec2_url=http://controller:8773/services/Cloud\n--ec2_host=controller\n--rabbit_host=controller\n--network_manager=nova.network.manager.VlanManager\n--flat_interface=eth0\n--fixed_range=172.16.0.0/16\n--network_size=256\n--sql_connection=mysql://nova:passW0rd@controller/nova\n--glance_api_servers=glance:9292\n--image_service=nova.image.glance.GlanceImageService\n--network_host=controller\n--vnc_console_proxy_url=http://controller:6080\n--vncproxy_url=http://controller:6080\n--vncproxy_host=controller\n--vnc_enabled=False\n--minimum_root_size=2147483648\n--iscsi_ip_prefix=192.168.191\n--libvirt_type=lxc\n--use_cow_images=False\n\nMy DB version:\n44", 
            "date_created": "2011-09-04 14:25:14.085890+00:00", 
            "author": "https://api.launchpad.net/1.0/~xavicampa"
        }
    ]
}