{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:49:51.747903+00:00", 
    "description": "Because of the instance object lazy loading its possible to get into situations where the API code is half way through assembling data to return to the client when the instance disappears underneath it. We really need to ensure everything we will need is retreived up front so we have a consistent snapshot view of the instance\n\n[req-5ca39eb3-c1d2-433b-8dac-1bf5f338ce1f ServersAdminNegativeV3Test-1453501114 ServersAdminNegativeV3Test-364813115] Unexpected exception in API method\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions Traceback (most recent call last):\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/extensions.py\", line 473, in wrapped\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/plugins/v3/servers.py\", line 410, in show\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     return self._view_builder.show(req, instance)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/views/servers.py\", line 268, in show\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     _inst_fault = self._get_fault(request, instance)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/views/servers.py\", line 214, in _get_fault\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     fault = instance.fault\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/base.py\", line 67, in getter\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     self.obj_load_attr(name)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 520, in obj_load_attr\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     expected_attrs=[attrname])\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/base.py\", line 153, in wrapper\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 310, in get_by_uuid\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     use_slave=use_slave)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/api.py\", line 676, in instance_get_by_uuid\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     columns_to_join, use_slave=use_slave)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 167, in wrapper\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1715, in instance_get_by_uuid\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     columns_to_join=columns_to_join, use_slave=use_slave)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1727, in _instance_get_by_uuid\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     raise exception.InstanceNotFound(instance_id=uuid)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions InstanceNotFound: Instance fcff276a-d410-4760-9b98-4014024b1353 could not be found.\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions \n\n \thttp://logs.openstack.org/periodic-qa/periodic-tempest-dsvm-nova-v3-full-master/a278802/logs/screen-n-api.txt", 
    "tags": [
        "api"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1352659", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1352659, 
    "index": 3978, 
    "created": "2014-08-05 03:46:55.845193+00:00", 
    "title": "race in server show api", 
    "comments": [
        {
            "content": "Because of the instance object lazy loading its possible to get into situations where the API code is half way through assembling data to return to the client when the instance disappears underneath it. We really need to ensure everything we will need is retreived up front so we have a consistent snapshot view of the instance\n\n[req-5ca39eb3-c1d2-433b-8dac-1bf5f338ce1f ServersAdminNegativeV3Test-1453501114 ServersAdminNegativeV3Test-364813115] Unexpected exception in API method\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions Traceback (most recent call last):\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/extensions.py\", line 473, in wrapped\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/plugins/v3/servers.py\", line 410, in show\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     return self._view_builder.show(req, instance)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/views/servers.py\", line 268, in show\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     _inst_fault = self._get_fault(request, instance)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/views/servers.py\", line 214, in _get_fault\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     fault = instance.fault\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/base.py\", line 67, in getter\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     self.obj_load_attr(name)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 520, in obj_load_attr\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     expected_attrs=[attrname])\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/base.py\", line 153, in wrapper\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 310, in get_by_uuid\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     use_slave=use_slave)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/api.py\", line 676, in instance_get_by_uuid\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     columns_to_join, use_slave=use_slave)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 167, in wrapper\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1715, in instance_get_by_uuid\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     columns_to_join=columns_to_join, use_slave=use_slave)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1727, in _instance_get_by_uuid\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions     raise exception.InstanceNotFound(instance_id=uuid)\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions InstanceNotFound: Instance fcff276a-d410-4760-9b98-4014024b1353 could not be found.\n2014-08-04 06:37:25.738 21228 TRACE nova.api.openstack.extensions \n\n \thttp://logs.openstack.org/periodic-qa/periodic-tempest-dsvm-nova-v3-full-master/a278802/logs/screen-n-api.txt", 
            "date_created": "2014-08-05 03:46:55.845193+00:00", 
            "author": "https://api.launchpad.net/1.0/~cyeoh-0"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/112192", 
            "date_created": "2014-08-06 05:21:08.291363+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/113947", 
            "date_created": "2014-08-13 16:05:22.874976+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Yeah this shows up in the periodic-qa and experimental queues on non-negative API tests:\n\nmessage:\"Unexpected exception in API method\" AND message:\"show\" AND message:\"InstanceNotFound\" AND tags:\"screen-n-api.txt\"\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJtZXNzYWdlOlwiVW5leHBlY3RlZCBleGNlcHRpb24gaW4gQVBJIG1ldGhvZFwiIEFORCBtZXNzYWdlOlwic2hvd1wiIEFORCBtZXNzYWdlOlwiSW5zdGFuY2VOb3RGb3VuZFwiIEFORCB0YWdzOlwic2NyZWVuLW4tYXBpLnR4dFwiIiwiZmllbGRzIjpbXSwib2Zmc2V0IjowLCJ0aW1lZnJhbWUiOiI2MDQ4MDAiLCJncmFwaG1vZGUiOiJjb3VudCIsInRpbWUiOnsidXNlcl9pbnRlcnZhbCI6MH0sInN0YW1wIjoxNDA4MTMyNjM2ODkxLCJtb2RlIjoiIiwiYW5hbHl6ZV9maWVsZCI6IiJ9", 
            "date_created": "2014-08-15 19:58:50.974756+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/113947\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=257183a8a9130f2b444f7f96ec8582da89684528\nSubmitter: Jenkins\nBranch:    master\n\ncommit 257183a8a9130f2b444f7f96ec8582da89684528\nAuthor: Dan Smith <email address hidden>\nDate:   Wed Aug 13 09:03:49 2014 -0700\n\n    Direct-load Instance.fault when lazy-loading\n    \n    This breaks out instance.fault lazy-loading from the other attributes,\n    since we have a direct and more efficient way of fetching the fault than\n    re-querying the entire instance with the fault attached.\n    \n    This also should help address fault-related races in the API where a\n    list of instances is queried, one of those is deleted, and the fault\n    attribute later triggers an InstanceNotFound whilst trying to do the\n    lazy-load.\n    \n    Change-Id: Iceb552663db93fa2a01fb90ece0c1eebecdb783f\n    Closes-bug: #1352659\n", 
            "date_created": "2014-08-15 22:36:45.618104+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Christopher Yeoh (<email address hidden>) on branch: master\nReview: https://review.openstack.org/112192\nReason: Addressed by https://review.openstack.org/#/c/113947/ instead", 
            "date_created": "2014-08-22 04:28:23.498611+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}