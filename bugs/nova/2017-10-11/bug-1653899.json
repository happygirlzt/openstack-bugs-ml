{
    "status": "Fix Released", 
    "last_updated": "2017-01-27 00:51:09.104475+00:00", 
    "description": "We have a lot of filters are pattern match. \n\nThere is list for exact match https://github.com/openstack/nova/blob/df2fd4a252cecc1e1ef471c071e57526ddf65499/nova/db/sqlalchemy/api.py#L2221\n\nOut of that list will be pattern match\nhttps://github.com/openstack/nova/blob/df2fd4a252cecc1e1ef471c071e57526ddf65499/nova/db/sqlalchemy/api.py#L2231\n\nWhen I input a invalid regex pattern, I will get 500 returned.\n\nFor example:\n\ncurl -g -i -X GET http://hp-pc:8774/v2.1/servers?node=[[[ -H \"OpenStack-API-Version: compute 2.39\" -H \"User-Agent: python-novaclient\" -H \"Accept: application/json\" -H \"X-OpenStack-Nova-API-Version: 2.39\" -H \"X-Auth-Token: gAAAAABYbKbto9BeEG31MtaiSCtIc43YKQCclVRJBklKMTv010fyB9jUgjmgvFSLCj8TyYfwJyIKiMduDesKNweCqnjcfLNlkMOsiNsHb4AyYrk0OlvZMwJ5I2rS1x_3kjyP2zbEUEJEKU1WrIY7QvjRBXQ7-r8AoI2QBCqolZjhtm2ckfoULTA\"\n\nThere is traceback in the log:\n\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters Traceback (most recent call last):\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     context)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     cursor.execute(statement, parameters)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 166, in execute\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     result = self._query(query)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 322, in _query\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     conn.query(q)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 835, in query\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1019, in _read_query_result\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     result.read()\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1302, in read\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     first_packet = self.connection._read_packet()\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 981, in _read_packet\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     packet.check_error()\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 393, in check_error\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     err.raise_mysql_exception(self._data)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 107, in raise_mysql_exception\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     raise errorclass(errno, errval)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters InternalError: (1139, u\"Got error 'brackets ([ ]) not balanced' from regexp\"", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1653899", 
    "owner": "https://api.launchpad.net/1.0/~zhengzhenyu", 
    "id": 1653899, 
    "index": 4721, 
    "created": "2017-01-04 07:31:48.934004+00:00", 
    "title": "The 500 returns for invalid regex in the pattern match query parameters", 
    "comments": [
        {
            "content": "We have a lot of filters are pattern match. \n\nThere is list for exact match https://github.com/openstack/nova/blob/df2fd4a252cecc1e1ef471c071e57526ddf65499/nova/db/sqlalchemy/api.py#L2221\n\nOut of that list will be pattern match\nhttps://github.com/openstack/nova/blob/df2fd4a252cecc1e1ef471c071e57526ddf65499/nova/db/sqlalchemy/api.py#L2231\n\nWhen I input a invalid regex pattern, I will get 500 returned.\n\nFor example:\n\ncurl -g -i -X GET http://hp-pc:8774/v2.1/servers?node=[[[ -H \"OpenStack-API-Version: compute 2.39\" -H \"User-Agent: python-novaclient\" -H \"Accept: application/json\" -H \"X-OpenStack-Nova-API-Version: 2.39\" -H \"X-Auth-Token: gAAAAABYbKbto9BeEG31MtaiSCtIc43YKQCclVRJBklKMTv010fyB9jUgjmgvFSLCj8TyYfwJyIKiMduDesKNweCqnjcfLNlkMOsiNsHb4AyYrk0OlvZMwJ5I2rS1x_3kjyP2zbEUEJEKU1WrIY7QvjRBXQ7-r8AoI2QBCqolZjhtm2ckfoULTA\"\n\nThere is traceback in the log:\n\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters Traceback (most recent call last):\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     context)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     cursor.execute(statement, parameters)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 166, in execute\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     result = self._query(query)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 322, in _query\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     conn.query(q)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 835, in query\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1019, in _read_query_result\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     result.read()\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1302, in read\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     first_packet = self.connection._read_packet()\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 981, in _read_packet\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     packet.check_error()\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 393, in check_error\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     err.raise_mysql_exception(self._data)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 107, in raise_mysql_exception\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters     raise errorclass(errno, errval)\n2017-01-04 15:43:49.113 TRACE oslo_db.sqlalchemy.exc_filters InternalError: (1139, u\"Got error 'brackets ([ ]) not balanced' from regexp\"", 
            "date_created": "2017-01-04 07:31:48.934004+00:00", 
            "author": "https://api.launchpad.net/1.0/~xuhj"
        }, 
        {
            "content": "This should be fixed with jsonschema validation after https://review.openstack.org/#/q/topic:bp/add-whitelist-for-server-list-filter-sort-parameters", 
            "date_created": "2017-01-04 07:32:36.020661+00:00", 
            "author": "https://api.launchpad.net/1.0/~xuhj"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/420494", 
            "date_created": "2017-01-16 04:10:15.527712+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/420494\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=841916daf78e740172da8f8b671069e81ae9a735\nSubmitter: Jenkins\nBranch:    master\n\ncommit 841916daf78e740172da8f8b671069e81ae9a735\nAuthor: Kevin_Zheng <email address hidden>\nDate:   Mon Jan 16 12:02:30 2017 +0800\n\n    Strict pattern match query parameters\n    \n    We have a lot of filters are pattern match.\n    \n    There is list for exact match\n    https://github.com/openstack/nova/blob/df2fd4a252cecc1e1ef471c071e57526ddf65499/nova/db/sqlalchemy/api.py#L2221\n    \n    Out of that list will be pattern match\n    https://github.com/openstack/nova/blob/df2fd4a252cecc1e1ef471c071e57526ddf65499/nova/db/sqlalchemy/api.py#L2231\n    \n    HTTP 500 raises if invalid regex provided for\n    those filters, strict there format to be regex\n    in JSON schema to avoid this.\n    \n    partial implement of bp add-whitelist-for-server-list-filter-sort-parameters\n    Closes-Bug: #1653899\n    \n    Change-Id: I4cf38407c20284dee7127edfe312da81caac9272\n", 
            "date_created": "2017-01-20 08:01:20.988620+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b3 development milestone.", 
            "date_created": "2017-01-27 00:51:07.627779+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}