{
    "status": "Fix Released", 
    "last_updated": "2017-04-26 17:46:39.997877+00:00", 
    "description": "1. Exact version of Nova/OpenStack you are running: Kilo Stable\n\n2. Relevant log files:\n\nI'm testing using ceph RADOS block devices to attach VM; however I've hit an issue when ceph cluster is different between VM and volumes.\n\n<--error message-->\n2015-09-24 11:32:31 13083 DEBUG nova.virt.libvirt.config [req-b9bbd744-cf75-477b-b6a6-ea5b72f6181f 9504f2c4fe6b4b34a1bb0330f2faba35 0788824d5d1f46f2b014597ba8dc0585] Generated XML ('<disk type=\"network\" device=\"disk\">\\n  <driver name=\"qemu\" type=\"raw\" cache=\"none\"/>\\n  <source protocol=\"rbd\" name=\"rbd/volume-727c5319-1926-44ac-ba52-de55485faf2b\">\\n    <host name=\"10.40.100.115\" port=\"6789\"/>\\n    <host name=\"10.40.100.116\" port=\"6789\"/>\\n    <host name=\"10.40.100.119\" port=\"6789\"/>\\n  </source>\\n  <auth username=\"cinder\">\\n    <secret type=\"ceph\" uuid=\"457eb676-33da-42ec-9a8c-9293d545c337\"/>\\n  </auth>\\n  <target bus=\"virtio\" dev=\"vdb\"/>\\n  <serial>727c5319-1926-44ac-ba52-de55485faf2b</serial>\\n</disk>\\n',)  to_xml /opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/nova/virt/libvirt/config.py:82\n2015-09-24 11:32:31 13083 ERROR nova.virt.libvirt.driver [req-b9bbd744-cf75-477b-b6a6-ea5b72f6181f 9504f2c4fe6b4b34a1bb0330f2faba35 0788824d5d1f46f2b014597ba8dc0585] [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] Failed to attach volume at mountpoint: /dev/vdb\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] Traceback (most recent call last):\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1092, in attach_volume\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     virt_dom.attachDeviceFlags(conf.to_xml(), flags)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     rv = execute(f, *args, **kwargs)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     six.reraise(c, e, tb)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     rv = meth(*args, **kwargs)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/libvirt.py\", line 528, in attachDeviceFlags\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     if ret == -1: raise libvirtError ('virDomainAttachDeviceFlags() failed', dom=self)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] libvirtError: internal error: unable to execute QEMU command 'device_add': Property 'virtio-blk-device.drive' can't find value 'drive-virtio-disk1'\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]\n2015-09-24 11:32:31 13083 ERROR nova.virt.block_device [req-b9bbd744-cf75-477b-b6a6-ea5b72f6181f 9504f2c4fe6b4b34a1bb0330f2faba35 0788824d5d1f46f2b014597ba8dc0585] [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] Driver failed to attach volume 727c5319-1926-44ac-ba52-de55485faf2b at /dev/vdb\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] Traceback (most recent call last):\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/nova/virt/block_device.py\", line 255, in attach\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     device_type=self['device_type'], encryption=encryption)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1103, in attach_volume\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     self._disconnect_volume(connection_info, disk_dev)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     six.reraise(self.type_, self.value, self.tb)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1092, in attach_volume\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     virt_dom.attachDeviceFlags(conf.to_xml(), flags)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     rv = execute(f, *args, **kwargs)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     six.reraise(c, e, tb)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     rv = meth(*args, **kwargs)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/libvirt.py\", line 528, in attachDeviceFlags\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     if ret == -1: raise libvirtError ('virDomainAttachDeviceFlags() failed', dom=self)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] libvirtError: internal error: unable to execute QEMU command 'device_add': Property 'virtio-blk-device.drive' can't find value 'drive-virtio-disk1'\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]\n\nThis is a VM libvirt xml. A root disk is created in \"ceph1\" cluster.\n\n<--xml-->\n    <disk type='network' device='disk'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <auth username='cinder'>\n        <secret type='ceph' uuid='457eb676-33da-42ec-9a8c-9293d545c337'/>\n      </auth>\n      <source protocol='rbd' name='volumes/def50421-13d9-4bbd-ad93-4f95b9d38bf6_disk'>\n        <host name='10.40.100.36' port='6789'/>\n        <host name='10.40.100.37' port='6789'/>\n        <host name='10.40.100.38' port='6789'/>\n      </source>\n      <backingStore/>\n      <target dev='vda' bus='virtio'/>\n      <alias name='virtio-disk0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </disk>\n\n\nbut in my environment, I have two ceph clusters and use multi backends and volume is created in \"ssdceph\" cluster. \n\n<--cinder config for multi backends-->\n# Configure the enabled backends\nenabled_backends= ceph1,ssdceph\n\n[ssdceph]\nrbd_max_clone_depth = 5\nrbd_flatten_volume_from_snapshot = False\nrbd_user = admin\nrbd_pool = rbd\nrbd_ceph_conf = /etc/ceph/ssd/ceph.conf\nvolume_driver = cinder.volume.drivers.rbd.RBDDriver\nvolume_backend_name = ssdceph\nrbd_secret_uuid = 7b16f0cb-1276-4ba5-a7c5-74e2bb06d836\n\n[ceph1]\nrbd_max_clone_depth = 5\nrbd_flatten_volume_from_snapshot = False\nrbd_secret_uuid = 457eb676-33da-42ec-9a8c-9293d545c337\nrbd_user = cinder\nrbd_pool = volumes\nrbd_ceph_conf = /etc/ceph/ceph.conf\n\nbackup_driver = cinder.backup.drivers.ceph\nbackup_ceph_conf = /etc/ceph/ceph.conf\nbackup_ceph_user = cinder-backup\nbackup_ceph_chunk_size = 134217728\nbackup_ceph_pool = backups\nbackup_ceph_stripe_unit = 0\nbackup_ceph_stripe_count = 0\nrestore_discard_excess_bytes = true\nvolume_driver = cinder.volume.drivers.rbd.RBDDriver\nvolume_backend_name = ceph\n\n3. Reproduce steps:\n(1) Create VM \"X\" with \"A\" ceph cluster. A root disk is created in \"A\" ceph cluster.\n(2) Create volume \"Y\" with \"B\" ceph cluster using multi backends in cinder.\n(3) Attach volume \"Y\" to \"X\", libvirt can't attach a volume properly.\n\nExpected result: volume status is \"in-use\" and volume attached.\nActual result: volume status back to \"available\" and libvirt can't attach a volume properly.\n\nnova-compute try to attach a volume using the secret_uuid, username parameter in nova.conf. If a volume has different secret_uuid, username with nova.conf, libvirt can't find exact volume in ceph cluster and error occured.\n\nIf a backend of volume which try to attach is ceph, user and secret_uuid information of volume should be provided by cinder; not in nova.conf.", 
    "tags": [
        "ceph", 
        "libvirt"
    ], 
    "importance": "Low", 
    "heat": 34, 
    "link": "https://bugs.launchpad.net/nova/+bug/1502028", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1502028, 
    "index": 596, 
    "created": "2015-10-02 07:56:14.113847+00:00", 
    "title": "cannot attach a volume when using multiple ceph backends", 
    "comments": [
        {
            "content": "1. Exact version of Nova/OpenStack you are running: Kilo Stable\n\n2. Relevant log files:\n\nI'm testing using ceph RADOS block devices to attach VM; however I've hit an issue when ceph cluster is different between VM and volumes.\n\n<--error message-->\n2015-09-24 11:32:31 13083 DEBUG nova.virt.libvirt.config [req-b9bbd744-cf75-477b-b6a6-ea5b72f6181f 9504f2c4fe6b4b34a1bb0330f2faba35 0788824d5d1f46f2b014597ba8dc0585] Generated XML ('<disk type=\"network\" device=\"disk\">\\n  <driver name=\"qemu\" type=\"raw\" cache=\"none\"/>\\n  <source protocol=\"rbd\" name=\"rbd/volume-727c5319-1926-44ac-ba52-de55485faf2b\">\\n    <host name=\"10.40.100.115\" port=\"6789\"/>\\n    <host name=\"10.40.100.116\" port=\"6789\"/>\\n    <host name=\"10.40.100.119\" port=\"6789\"/>\\n  </source>\\n  <auth username=\"cinder\">\\n    <secret type=\"ceph\" uuid=\"457eb676-33da-42ec-9a8c-9293d545c337\"/>\\n  </auth>\\n  <target bus=\"virtio\" dev=\"vdb\"/>\\n  <serial>727c5319-1926-44ac-ba52-de55485faf2b</serial>\\n</disk>\\n',)  to_xml /opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/nova/virt/libvirt/config.py:82\n2015-09-24 11:32:31 13083 ERROR nova.virt.libvirt.driver [req-b9bbd744-cf75-477b-b6a6-ea5b72f6181f 9504f2c4fe6b4b34a1bb0330f2faba35 0788824d5d1f46f2b014597ba8dc0585] [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] Failed to attach volume at mountpoint: /dev/vdb\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] Traceback (most recent call last):\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1092, in attach_volume\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     virt_dom.attachDeviceFlags(conf.to_xml(), flags)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     rv = execute(f, *args, **kwargs)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     six.reraise(c, e, tb)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     rv = meth(*args, **kwargs)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/libvirt.py\", line 528, in attachDeviceFlags\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     if ret == -1: raise libvirtError ('virDomainAttachDeviceFlags() failed', dom=self)\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] libvirtError: internal error: unable to execute QEMU command 'device_add': Property 'virtio-blk-device.drive' can't find value 'drive-virtio-disk1'\n2015-09-24 11:32:31.923 13083 TRACE nova.virt.libvirt.driver [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]\n2015-09-24 11:32:31 13083 ERROR nova.virt.block_device [req-b9bbd744-cf75-477b-b6a6-ea5b72f6181f 9504f2c4fe6b4b34a1bb0330f2faba35 0788824d5d1f46f2b014597ba8dc0585] [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] Driver failed to attach volume 727c5319-1926-44ac-ba52-de55485faf2b at /dev/vdb\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] Traceback (most recent call last):\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/nova/virt/block_device.py\", line 255, in attach\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     device_type=self['device_type'], encryption=encryption)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1103, in attach_volume\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     self._disconnect_volume(connection_info, disk_dev)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     six.reraise(self.type_, self.value, self.tb)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1092, in attach_volume\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     virt_dom.attachDeviceFlags(conf.to_xml(), flags)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     rv = execute(f, *args, **kwargs)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     six.reraise(c, e, tb)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     rv = meth(*args, **kwargs)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]   File \"/opt/stack/venv/nova-20150831T151915Z/lib/python2.7/site-packages/libvirt.py\", line 528, in attachDeviceFlags\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]     if ret == -1: raise libvirtError ('virDomainAttachDeviceFlags() failed', dom=self)\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165] libvirtError: internal error: unable to execute QEMU command 'device_add': Property 'virtio-blk-device.drive' can't find value 'drive-virtio-disk1'\n2015-09-24 11:32:31.926 13083 TRACE nova.virt.block_device [instance: 3aa05494-88ef-44c3-a7ad-705437b5f165]\n\nThis is a VM libvirt xml. A root disk is created in \"ceph1\" cluster.\n\n<--xml-->\n    <disk type='network' device='disk'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <auth username='cinder'>\n        <secret type='ceph' uuid='457eb676-33da-42ec-9a8c-9293d545c337'/>\n      </auth>\n      <source protocol='rbd' name='volumes/def50421-13d9-4bbd-ad93-4f95b9d38bf6_disk'>\n        <host name='10.40.100.36' port='6789'/>\n        <host name='10.40.100.37' port='6789'/>\n        <host name='10.40.100.38' port='6789'/>\n      </source>\n      <backingStore/>\n      <target dev='vda' bus='virtio'/>\n      <alias name='virtio-disk0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </disk>\n\n\nbut in my environment, I have two ceph clusters and use multi backends and volume is created in \"ssdceph\" cluster. \n\n<--cinder config for multi backends-->\n# Configure the enabled backends\nenabled_backends= ceph1,ssdceph\n\n[ssdceph]\nrbd_max_clone_depth = 5\nrbd_flatten_volume_from_snapshot = False\nrbd_user = admin\nrbd_pool = rbd\nrbd_ceph_conf = /etc/ceph/ssd/ceph.conf\nvolume_driver = cinder.volume.drivers.rbd.RBDDriver\nvolume_backend_name = ssdceph\nrbd_secret_uuid = 7b16f0cb-1276-4ba5-a7c5-74e2bb06d836\n\n[ceph1]\nrbd_max_clone_depth = 5\nrbd_flatten_volume_from_snapshot = False\nrbd_secret_uuid = 457eb676-33da-42ec-9a8c-9293d545c337\nrbd_user = cinder\nrbd_pool = volumes\nrbd_ceph_conf = /etc/ceph/ceph.conf\n\nbackup_driver = cinder.backup.drivers.ceph\nbackup_ceph_conf = /etc/ceph/ceph.conf\nbackup_ceph_user = cinder-backup\nbackup_ceph_chunk_size = 134217728\nbackup_ceph_pool = backups\nbackup_ceph_stripe_unit = 0\nbackup_ceph_stripe_count = 0\nrestore_discard_excess_bytes = true\nvolume_driver = cinder.volume.drivers.rbd.RBDDriver\nvolume_backend_name = ceph\n\n3. Reproduce steps:\n(1) Create VM \"X\" with \"A\" ceph cluster. A root disk is created in \"A\" ceph cluster.\n(2) Create volume \"Y\" with \"B\" ceph cluster using multi backends in cinder.\n(3) Attach volume \"Y\" to \"X\", libvirt can't attach a volume properly.\n\nExpected result: volume status is \"in-use\" and volume attached.\nActual result: volume status back to \"available\" and libvirt can't attach a volume properly.\n\nnova-compute try to attach a volume using the secret_uuid, username parameter in nova.conf. If a volume has different secret_uuid, username with nova.conf, libvirt can't find exact volume in ceph cluster and error occured.\n\nIf a backend of volume which try to attach is ceph, user and secret_uuid information of volume should be provided by cinder; not in nova.conf.", 
            "date_created": "2015-10-02 07:56:14.113847+00:00", 
            "author": "https://api.launchpad.net/1.0/~hyangii"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/318405", 
            "date_created": "2016-05-19 01:54:47.277796+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Sean Dague (<email address hidden>) on branch: master\nReview: https://review.openstack.org/318405\nReason: This is no way looks like a valid bug fix. Please don't upload noop changes without an description in the commit message about why you are.", 
            "date_created": "2016-06-07 16:27:53.381575+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Its been a long time this bug has been assigned and has no progress. The last patch submitted was invalid and abandoned. Removing the assignee.\n\nJay Lee: Feel free to add yourself as assignee and push a patch for it.", 
            "date_created": "2016-06-17 22:19:05.589652+00:00", 
            "author": "https://api.launchpad.net/1.0/~sujitha-neti"
        }, 
        {
            "content": "I looks like the version this bug was reported against is Kilo, which is at end of life. Has anyone confirmed if this is an issue in Mitaka or master?", 
            "date_created": "2016-06-21 22:34:53.549356+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2016-08-21 04:17:35.680313+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }, 
        {
            "content": "In Mitaka,\n   When I use nova to attach the volume to an instance(with Ceph), will get error:\n2016-08-22 03:30:04.879 DEBUG nova.virt.libvirt.guest [^[[01;36mreq-af1bf2bd-5346-4b56-b68f-e22b44e32715 ^[[00;36mdemo demo] ^[[01;35mattach device xml: <disk type=\"network\" device=\"disk\">\n  <driver name=\"qemu\" type=\"raw\" cache=\"none\"/>\n  <source protocol=\"rbd\" name=\"volumes/volume-aa3152f6-db7b-4893-8c5f-ff05de3ac36e\">\n    <host name=\"10.20.100.3\" port=\"6789\"/>\n    <host name=\"10.20.100.4\" port=\"6789\"/>\n    <host name=\"10.20.100.5\" port=\"6789\"/>\n  </source>\n  <auth username=\"nova\">\n    <secret type=\"ceph\" uuid=\"06214a0d-dc30-4e9b-856b-c8f0c0e63d9d\"/>\n  </auth>\n  <target bus=\"scsi\" dev=\"sdb\"/>\n  <serial>aa3152f6-db7b-4893-8c5f-ff05de3ac36e</serial>\n</disk>\n\n2016-08-22 03:30:04.946 ERROR nova.virt.libvirt.driver [^[[01;36mreq-af1bf2bd-5346-4b56-b68f-e22b44e32715 ^[[00;36mdemo demo] ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] Failed to attach volume at mountpoint: /dev/sdb^[[00m\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00mTraceback (most recent call last):\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1225, in attach_volume\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    guest.attach_device(conf, persistent=True, live=live)\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/guest.py\", line 296, in attach_device\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    self._domain.attachDeviceFlags(device_xml, flags=flags)\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 186, in doit\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 144, in proxy_call\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    rv = execute(f, *args, **kwargs)\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 125, in execute\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    six.reraise(c, e, tb)\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 83, in tworker\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    rv = meth(*args, **kwargs)\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/libvirt.py\", line 560, in attachDeviceFlags\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    if ret == -1: raise libvirtError ('virDomainAttachDeviceFlags() failed', dom=self)\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00mlibvirtError: internal error: unable to execute QEMU command 'device_add': Property 'scsi-hd.drive' can't find value 'drive-scsi0-0-0-1'\n2016-08-22 03:30:04.946 TRACE nova.virt.libvirt.driver ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m\n2016-08-22 03:30:04.949 ERROR nova.virt.block_device [^[[01;36mreq-af1bf2bd-5346-4b56-b68f-e22b44e32715 ^[[00;36mdemo demo] ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] Driver failed to attach volume aa3152f6-db7b-4893-8c5f-ff05de3ac36e at /dev/sdb^[[00m\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00mTraceback (most recent call last):\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/nova/virt/block_device.py\", line 274, in attach\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    device_type=self['device_type'], encryption=encryption)\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1236, in attach_volume\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    self._disconnect_volume(connection_info, disk_dev)\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    self.force_reraise()\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    six.reraise(self.type_, self.value, self.tb)\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1225, in attach_volume\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    guest.attach_device(conf, persistent=True, live=live)\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/guest.py\", line 296, in attach_device\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    self._domain.attachDeviceFlags(device_xml, flags=flags)\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 186, in doit\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 144, in proxy_call\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    rv = execute(f, *args, **kwargs)\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 125, in execute\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    six.reraise(c, e, tb)\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 83, in tworker\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    rv = meth(*args, **kwargs)\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m  File \"/srv/nova/local/lib/python2.7/site-packages/libvirt.py\", line 560, in attachDeviceFlags\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00m    if ret == -1: raise libvirtError ('virDomainAttachDeviceFlags() failed', dom=self)\n2016-08-22 03:30:04.949 TRACE nova.virt.block_device ^[[01;35m[instance: bfa9db55-e55b-4aaa-9dab-7d2ebf85c009] ^[[00mlibvirtError: internal error: unable to execute QEMU command 'device_add': Property 'scsi-hd.drive' can't find value 'drive-scsi0-0-0-1'\n", 
            "date_created": "2016-08-22 08:45:55.033214+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "I am seeing this bug in Mitaka on Ubuntu. I am trying to get Magnum containers working, but its broken because Magnum is trying to attach my Ceph-backed Cinder volume to Nova instance.  Is there a possible for a short-term fix? Thanks!", 
            "date_created": "2016-08-31 19:57:52.345015+00:00", 
            "author": "https://api.launchpad.net/1.0/~shorton3"
        }, 
        {
            "content": "This issue also affects my org.\n\nThis looks to be address (in Master, at time of writing O cycle) here:\nhttps://github.com/openstack/nova/commit/b89efa3ef611a1932df0c2d6e6f30315b5111a57\n\nLooks like a good candidate for backport.", 
            "date_created": "2016-12-09 01:29:10.136281+00:00", 
            "author": "https://api.launchpad.net/1.0/~gugino-michael"
        }, 
        {
            "content": "Hello\nI have the same issue (Mitaka). Nova compute is passing rbd_user and rbd_secret from nova.conf to libvirt, which are overwriting user and secret passed from cinder-volume service during attaching volume from another ceph storage.\n\nIs there any solution implemented already?", 
            "date_created": "2017-04-26 14:07:06.916741+00:00", 
            "author": "https://api.launchpad.net/1.0/~jacolex"
        }, 
        {
            "content": "As mentioned in comment 8, I think this got fixed by  https://review.openstack.org/#/c/389399 in Ocata (15.0.0.0b2).\r\n\r\nAs for a backport, the best way is to ask in #openstack-nova in IRC or in a Nova meeting or on the openstack-dev mailing list.", 
            "date_created": "2017-04-26 17:46:35.239096+00:00", 
            "author": "https://api.launchpad.net/1.0/~melwitt"
        }
    ]
}