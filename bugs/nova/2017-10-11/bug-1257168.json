{
    "status": "Fix Released", 
    "last_updated": "2015-02-02 14:12:19.880681+00:00", 
    "description": "Getting the following error when trying to unlock an instance\n\n2013-12-03 15:14:31.198 31688 DEBUG nova.compute.api [req-266c1f02-b77c-440a-8983-948f6ab2357c 671dcaba8087487c8a28afe42b6672fa e4eee8dbc16a49dcbc76edac96674e96] [instance: fb468a1d-2e64-4560-850d-31a5fd698305] Unlocking unlock /usr/lib/python2.7/dist-packages/nova/compute/api.py:2612\n2013-12-03 15:14:31.200 31688 ERROR nova.cells.messaging [req-266c1f02-b77c-440a-8983-948f6ab2357c 671dcaba8087487c8a28afe42b6672fa e4eee8dbc16a49dcbc76edac96674e96] Error processing message locally: Object '<Instance at 0x5948a90>' is already attached to session '1247' (this is '1248')\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging Traceback (most recent call last):\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/cells/messaging.py\", line 205, in _process_locally\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging resp_value = self.msg_runner._process_message_locally(self)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/cells/messaging.py\", line 1476, in _process_message_locally\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging return fn(message, **message.method_kwargs)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/cells/messaging.py\", line 708, in run_compute_api_method\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging return self._run_api_method(message, method_info, fn)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/cells/messaging.py\", line 702, in _run_api_method\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging return fn(message.ctxt, *args, **method_info['method_kwargs'])\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/compute/api.py\", line 198, in wrapped\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging return func(self, context, target, *args, **kwargs)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/compute/api.py\", line 2615, in unlock\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging instance.save()\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/db/sqlalchemy/models.py\", line 52, in save\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging session.add(self)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1399, in add\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging self._save_or_update_state(state)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1411, in _save_or_update_state\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging self._save_or_update_impl(state)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1667, in _save_or_update_impl\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging self._update_impl(state)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1661, in _update_impl\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging self._attach(state)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1749, in _attach\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging state.session_id, self.hash_key))\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging InvalidRequestError: Object '<Instance at 0x5948a90>' is already attached to session '1247' (this is '1248')\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging", 
    "tags": [
        "cells", 
        "icehouse-backport-potential"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1257168", 
    "owner": "https://api.launchpad.net/1.0/~sorrison", 
    "id": 1257168, 
    "index": 4348, 
    "created": "2013-12-03 04:50:50.925196+00:00", 
    "title": "Cells: Error unlocking instances", 
    "comments": [
        {
            "content": "Getting the following error when trying to unlock an instance\n\n2013-12-03 15:14:31.198 31688 DEBUG nova.compute.api [req-266c1f02-b77c-440a-8983-948f6ab2357c 671dcaba8087487c8a28afe42b6672fa e4eee8dbc16a49dcbc76edac96674e96] [instance: fb468a1d-2e64-4560-850d-31a5fd698305] Unlocking unlock /usr/lib/python2.7/dist-packages/nova/compute/api.py:2612\n2013-12-03 15:14:31.200 31688 ERROR nova.cells.messaging [req-266c1f02-b77c-440a-8983-948f6ab2357c 671dcaba8087487c8a28afe42b6672fa e4eee8dbc16a49dcbc76edac96674e96] Error processing message locally: Object '<Instance at 0x5948a90>' is already attached to session '1247' (this is '1248')\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging Traceback (most recent call last):\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/cells/messaging.py\", line 205, in _process_locally\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging resp_value = self.msg_runner._process_message_locally(self)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/cells/messaging.py\", line 1476, in _process_message_locally\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging return fn(message, **message.method_kwargs)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/cells/messaging.py\", line 708, in run_compute_api_method\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging return self._run_api_method(message, method_info, fn)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/cells/messaging.py\", line 702, in _run_api_method\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging return fn(message.ctxt, *args, **method_info['method_kwargs'])\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/compute/api.py\", line 198, in wrapped\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging return func(self, context, target, *args, **kwargs)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/compute/api.py\", line 2615, in unlock\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging instance.save()\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/db/sqlalchemy/models.py\", line 52, in save\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging session.add(self)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1399, in add\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging self._save_or_update_state(state)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1411, in _save_or_update_state\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging self._save_or_update_impl(state)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1667, in _save_or_update_impl\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging self._update_impl(state)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1661, in _update_impl\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging self._attach(state)\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1749, in _attach\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging state.session_id, self.hash_key))\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging InvalidRequestError: Object '<Instance at 0x5948a90>' is already attached to session '1247' (this is '1248')\n2013-12-03 15:14:31.200 31688 TRACE nova.cells.messaging", 
            "date_created": "2013-12-03 04:50:50.925196+00:00", 
            "author": "https://api.launchpad.net/1.0/~sorrison"
        }, 
        {
            "content": "https://review.openstack.org/89487", 
            "date_created": "2014-04-22 06:41:02.038367+00:00", 
            "author": "https://api.launchpad.net/1.0/~sorrison"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/89487\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=fb9b60fb5d3084d4cab29936fd1f534e5599f231\nSubmitter: Jenkins\nBranch:    master\n\ncommit fb9b60fb5d3084d4cab29936fd1f534e5599f231\nAuthor: Sam Morrison <email address hidden>\nDate:   Tue Apr 22 16:34:26 2014 +1000\n\n    Remove cell api overrides for lock and unlock\n    \n    This isn't actually needed as these methods handle objects and is\n    triggered when the instance object is saved.\n    It actually caused a race condition with unlock as it triggers 2\n    instance updates from a compute cell.\n    \n    Change-Id: I42eea6a2984f70527d4fc37f48ad973a2248721c\n    Closes-Bug: #1257168\n", 
            "date_created": "2014-07-14 15:59:35.426735+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Note: OpenStack Nova Icehouse is also affected by this bug.\nFortunately, the fix proposed works fine with OpenStack Nova Icehouse.", 
            "date_created": "2015-01-28 23:10:17.973878+00:00", 
            "author": "https://api.launchpad.net/1.0/~mgagne"
        }
    ]
}