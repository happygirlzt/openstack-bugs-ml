{
    "status": "Fix Released", 
    "last_updated": "2016-02-19 20:18:07.317975+00:00", 
    "description": "Under a stock DevStack setup on bare metal, I started stack.sh, which creates a public network (w/o DHCP) and a private network (with DHCP) and a router.  On the host I created a br-ex and added eth3 to the bridge. The public network is connected via a physical switch, to another host (also running Devstack).\n\nI am able to create VMs, and ping between them, and I can also (with the new VPNaaS feature under development) ping VMs over the public (provider?) network.\n\nIf I create a VM (seen this with cirros and others) and specify the private network, or create a VM with the public network, they launch fine. However, if I try to boot an instance with two NICs, the launch fails:\n\n localnet=`neutron net-list | grep private | cut -f 2 -d'|' | cut -f 2 -d' '`\n nova boot --image cirros-0.3.1-x86_64-uec --flavor 1 mary --nic net-id=$localnet\n \npubnet=`neutron net-list | grep public | cut -f 2 -d'|' | cut -f 2 -d' '`\nnova boot --image cirros-0.3.1-x86_64-uec --flavor 1 peter --nic net-id=$pubnet\n\nnova boot --image cirros-0.3.1-x86_64-uec --flavor 1 paul --nic net-id=$localnet --nic net-id=$pubnet\n\nnova list\n+--------------------------------------+-------+--------+------------+-------------+---------------------+\n| ID                                   | Name  | Status | Task State | Power State | Networks            |\n+--------------------------------------+-------+--------+------------+-------------+---------------------+\n| 0fc9c41c-fcd7-45a8-ae10-568b506a331f | mary  | ACTIVE | None       | Running     | private=10.2.0.4    |\n| 76925e14-a0b7-4285-9197-5ff0e92f5bb4 | paul  | ERROR  | None       | NOSTATE     |                     |\n| c8cd45a4-10d9-4d8c-9a5a-f806e63683c0 | peter | ACTIVE | None       | Running     | public=172.24.4.235 |\n+--------------------------------------+-------+--------+------------+-------------+---------------------+\n\nLooking at the logs, I see that the screen-n-cpu.log reports an error and has a traceback:\n\n2013-09-04 18:01:47.963 ERROR nova.compute.manager [req-187bbd89-f40d-4637-b549-0edfc9b66419 admin admin] [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4] Instance failed to spawn\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4] Traceback (most recent call last):\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1293, in _spawn\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     block_device_info)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1699, in spawn\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     block_device_info)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2697, in _creat\\\ne_domain_and_network\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     domain = self._create_domain(xml, instance=instance, power_on=power_on\\\n)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2652, in _creat\\\ne_domain\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     domain.XMLDesc(0))\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2647, in _creat\\\ne_domain\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     domain.createWithFlags(launch_flags)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 17\\\n9, in doit\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 13\\\n9, in proxy_call\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     rv = execute(f,*args,**kwargs)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 77\\\n, in tworker\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     rv = meth(*args,**kwargs)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 581, in createW\\\nithFlags\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed',\\\n dom=self)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4] libvirtError: internal error Cannot instantiate filter due to unresolvable\\\n variables: DHCPSERVER\n\nThere is no DHCP server on the public network, but there is one on the local network.\n\nThis is consistently reproducible and occurs with other image types.\n\nThe nova code is off the master branch (havana) with the SHA1 of 86c97ff from 6 days ago.", 
    "tags": [
        "in-stable-icehouse", 
        "libvirt"
    ], 
    "importance": "Medium", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1220856", 
    "owner": "https://api.launchpad.net/1.0/~r-mibu", 
    "id": 1220856, 
    "index": 3553, 
    "created": "2013-09-04 18:37:19.731720+00:00", 
    "title": "libvirt error when create VM with 2 NICs under DevStack", 
    "comments": [
        {
            "content": "Under a stock DevStack setup on bare metal, I started stack.sh, which creates a public network (w/o DHCP) and a private network (with DHCP) and a router.  On the host I created a br-ex and added eth3 to the bridge. The public network is connected via a physical switch, to another host (also running Devstack).\n\nI am able to create VMs, and ping between them, and I can also (with the new VPNaaS feature under development) ping VMs over the public (provider?) network.\n\nIf I create a VM (seen this with cirros and others) and specify the private network, or create a VM with the public network, they launch fine. However, if I try to boot an instance with two NICs, the launch fails:\n\n localnet=`neutron net-list | grep private | cut -f 2 -d'|' | cut -f 2 -d' '`\n nova boot --image cirros-0.3.1-x86_64-uec --flavor 1 mary --nic net-id=$localnet\n \npubnet=`neutron net-list | grep public | cut -f 2 -d'|' | cut -f 2 -d' '`\nnova boot --image cirros-0.3.1-x86_64-uec --flavor 1 peter --nic net-id=$pubnet\n\nnova boot --image cirros-0.3.1-x86_64-uec --flavor 1 paul --nic net-id=$localnet --nic net-id=$pubnet\n\nnova list\n+--------------------------------------+-------+--------+------------+-------------+---------------------+\n| ID                                   | Name  | Status | Task State | Power State | Networks            |\n+--------------------------------------+-------+--------+------------+-------------+---------------------+\n| 0fc9c41c-fcd7-45a8-ae10-568b506a331f | mary  | ACTIVE | None       | Running     | private=10.2.0.4    |\n| 76925e14-a0b7-4285-9197-5ff0e92f5bb4 | paul  | ERROR  | None       | NOSTATE     |                     |\n| c8cd45a4-10d9-4d8c-9a5a-f806e63683c0 | peter | ACTIVE | None       | Running     | public=172.24.4.235 |\n+--------------------------------------+-------+--------+------------+-------------+---------------------+\n\nLooking at the logs, I see that the screen-n-cpu.log reports an error and has a traceback:\n\n2013-09-04 18:01:47.963 ERROR nova.compute.manager [req-187bbd89-f40d-4637-b549-0edfc9b66419 admin admin] [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4] Instance failed to spawn\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4] Traceback (most recent call last):\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1293, in _spawn\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     block_device_info)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1699, in spawn\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     block_device_info)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2697, in _creat\\\ne_domain_and_network\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     domain = self._create_domain(xml, instance=instance, power_on=power_on\\\n)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2652, in _creat\\\ne_domain\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     domain.XMLDesc(0))\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2647, in _creat\\\ne_domain\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     domain.createWithFlags(launch_flags)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 17\\\n9, in doit\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 13\\\n9, in proxy_call\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     rv = execute(f,*args,**kwargs)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 77\\\n, in tworker\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     rv = meth(*args,**kwargs)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 581, in createW\\\nithFlags\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4]     if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed',\\\n dom=self)\n2013-09-04 18:01:47.963 9855 TRACE nova.compute.manager [instance: 76925e14-a0b7-4285-9197-5ff0e92f5bb4] libvirtError: internal error Cannot instantiate filter due to unresolvable\\\n variables: DHCPSERVER\n\nThere is no DHCP server on the public network, but there is one on the local network.\n\nThis is consistently reproducible and occurs with other image types.\n\nThe nova code is off the master branch (havana) with the SHA1 of 86c97ff from 6 days ago.", 
            "date_created": "2013-09-04 18:37:19.731720+00:00", 
            "author": "https://api.launchpad.net/1.0/~pcm"
        }, 
        {
            "content": "I found the problem in another bug report.  See https://bugs.launchpad.net/neutron/+bug/1186557", 
            "date_created": "2013-11-05 23:12:33.284391+00:00", 
            "author": "https://api.launchpad.net/1.0/~canderso"
        }, 
        {
            "content": "Actually since this is a nova problem and not neutron issue, I'll elaborate on the problem here.\n\nThe problem is in nova/virt/libvirt/firewall.py (Grizzly):\n\nallow_dhcp = False\nfor (network, mapping) in network_info:\n    if mapping['dhcp_server']:\n        allow_dhcp = True\n        break\n\nLooping through each network, if any of them happens to have dhcp_server, then it is setting them for ALL.  Hence you get nova-base for all your vif filters, instead of nova-base for some and nova-nodhcp for others.", 
            "date_created": "2013-11-05 23:32:33.485396+00:00", 
            "author": "https://api.launchpad.net/1.0/~canderso"
        }, 
        {
            "content": "Master has the same problem.  base_filter is set only once, then it loops through each vif applying the same base_filter, instead of a per-vif base_filter.\n\nbase_filter = self.get_base_filter_list(instance, allow_dhcp)\n\nfor vif in network_info:\n     self._define_filter(self._get_instance_filter_xml(instance,\n                                                              base_filter,\n                                                              vif))", 
            "date_created": "2013-11-05 23:38:28.794866+00:00", 
            "author": "https://api.launchpad.net/1.0/~canderso"
        }, 
        {
            "content": "I revised the function as follows on my grizzly install, which resolved the issue for me:\n\n    def setup_basic_filtering(self, instance, network_info):\n        \"\"\"Set up basic filtering (MAC, IP, and ARP spoofing protection).\"\"\"\n        LOG.info(_('Called setup_basic_filtering in nwfilter'),\n                 instance=instance)\n\n        if self.handle_security_groups:\n            # No point in setting up a filter set that we'll be overriding\n            # anyway.\n            return\n\n        LOG.info(_('Ensuring static filters'), instance=instance)\n        self._ensure_static_filters()\n\n        nodhcp_base_filter = self.get_base_filter_list(instance, False)\n        dhcp_base_filter = self.get_base_filter_list(instance, True)\n\n        for (network, mapping) in network_info:\n            if mapping['dhcp_server']:\n                self._define_filter(self._get_instance_filter_xml(instance,\n                                                              dhcp_base_filter,\n                                                              network,\n                                                              mapping))\n            else:\n                self._define_filter(self._get_instance_filter_xml(instance,\n                                                              nodhcp_base_filter,\n                                                              network,\n                                                              mapping))\n", 
            "date_created": "2013-11-05 23:47:42.823746+00:00", 
            "author": "https://api.launchpad.net/1.0/~canderso"
        }, 
        {
            "content": "Craig,\n\nCan you propose a patch to nova? I don't see any patch context in your last comment, but it seems sane enough to me. Let me know if you are not able to proposed the patch and we'll work something else out.", 
            "date_created": "2014-02-12 03:24:56.444992+00:00", 
            "author": "https://api.launchpad.net/1.0/~geekinutah"
        }, 
        {
            "content": "Hi Carig,\n\nThanks for pointing the issue.\nI also wrote patch for master [1], because the network info model has been changed [2]. It works for me.\nI hope this fix merged into mainline and backported to havana.\n\n[1]\ndiff --git a/nova/virt/libvirt/firewall.py b/nova/virt/libvirt/firewall.py\nindex 1cbba78..58756db 100644\n--- a/nova/virt/libvirt/firewall.py\n+++ b/nova/virt/libvirt/firewall.py\n@@ -117,20 +117,18 @@ class NWFilterFirewall(base_firewall.FirewallDriver):\n         LOG.info(_('Ensuring static filters'), instance=instance)\n         self._ensure_static_filters()\n\n-        allow_dhcp = False\n+        nodhcp_base_filter = self.get_base_filter_list(instance, False)\n+        dhcp_base_filter = self.get_base_filter_list(instance, True)\n+\n         for vif in network_info:\n-            if not vif['network'] or not vif['network']['subnets']:\n-                continue\n+            _base_filter = nodhcp_base_filter\n             for subnet in vif['network']['subnets']:\n                 if subnet.get_meta('dhcp_server'):\n-                    allow_dhcp = True\n+                    _base_filter = dhcp_base_filter\n                     break\n\n-        base_filter = self.get_base_filter_list(instance, allow_dhcp)\n-\n-        for vif in network_info:\n             self._define_filter(self._get_instance_filter_xml(instance,\n-                                                              base_filter,\n+                                                              _base_filter,\n                                                               vif))\n\n     def _get_instance_filter_parameters(self, vif):\n\n\n[2] https://review.openstack.org/#/c/38589/", 
            "date_created": "2014-02-21 04:30:42.851195+00:00", 
            "author": "https://api.launchpad.net/1.0/~r-mibu"
        }, 
        {
            "content": "Ryota Mibu: We use Gerrit for submitting patches for code review.  Can you please submit this through OpenStack's Gerrit?  You can find more information here: https://wiki.openstack.org/wiki/GerritJenkinsGit", 
            "date_created": "2014-03-06 20:28:26.714070+00:00", 
            "author": "https://api.launchpad.net/1.0/~sross-7"
        }, 
        {
            "content": "OK. I will submit my patch (with UTs that haven't been wrriten).", 
            "date_created": "2014-03-07 03:34:10.699474+00:00", 
            "author": "https://api.launchpad.net/1.0/~r-mibu"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/78999", 
            "date_created": "2014-03-07 15:53:34.009725+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/78999\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d2874463010b129e62a568357cfa1df3ab4805e6\nSubmitter: Jenkins\nBranch:    master\n\ncommit d2874463010b129e62a568357cfa1df3ab4805e6\nAuthor: Ryota MIBU <email address hidden>\nDate:   Fri Mar 7 17:08:11 2014 +0900\n\n    libvirt: Make nwfilter driver use right filterref\n    \n    This fixes Bug #1220856 which occurs with Libvirt NWFilterFirewall\n    Driver.  While creating a VM with multiple NICs including one connects\n    to DHCP serving network and another to DHCP non-serving network,\n    NWFilterFirewall Driver will use the same base filter that allows DHCP\n    for all NICs. This leads a libvirt launch error due to lack of\n    'dhcp_server' parameter which is needed to define allow-DHCP filters.\n    \n    This patch makes NWFilterFirewall Driver use right base filter for\n    each NIC depends on 'dhcp_server' config.\n    \n    Closes-bug: #1220856\n    Change-Id: I7f9a7c281f152985478b2ec295f0644ba475fd76\n", 
            "date_created": "2014-06-15 16:01:45.839139+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/102441", 
            "date_created": "2014-06-25 06:12:09.665709+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/102441\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=f59886479f1014c225989e24c425106412b3f0f0\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit f59886479f1014c225989e24c425106412b3f0f0\nAuthor: Ryota MIBU <email address hidden>\nDate:   Fri Mar 7 17:08:11 2014 +0900\n\n    libvirt: Make nwfilter driver use right filterref\n    \n    This fixes Bug #1220856 which occurs with Libvirt NWFilterFirewall\n    Driver.  While creating a VM with multiple NICs including one connects\n    to DHCP serving network and another to DHCP non-serving network,\n    NWFilterFirewall Driver will use the same base filter that allows DHCP\n    for all NICs. This leads a libvirt launch error due to lack of\n    'dhcp_server' parameter which is needed to define allow-DHCP filters.\n    \n    This patch makes NWFilterFirewall Driver use right base filter for\n    each NIC depends on 'dhcp_server' config.\n    \n    Closes-bug: #1220856\n    Change-Id: I7f9a7c281f152985478b2ec295f0644ba475fd76\n    (cherry picked from commit d2874463010b129e62a568357cfa1df3ab4805e6)\n", 
            "date_created": "2014-07-16 04:52:36.763254+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}