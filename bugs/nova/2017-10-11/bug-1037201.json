{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:26:39.366457+00:00", 
    "description": "As of this morning I'm getting unit test failures on Fedora 17 when running the Nova unit tests:\n\n\nSchedulerHintsTestCase\n    test_create_missing_server                                   ^[[31mERROR^[[0m^[[31m  0.35^[[0m\n\n======================================================================\nERROR: Test create with malformed body\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/dprince/projects/nova/nova/tests/api/openstack/compute/contrib/test_scheduler_hints.py\", line 112, in test_create_missing_server\n    res = req.get_response(self.app)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/request.py\", line 1053, in get_response\n    application, catch_exc_info=False)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/request.py\", line 1022, in call_application\n    app_iter = application(self.environ, start_response)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/dec.py\", line 159, in __call__\n    return resp(environ, start_response)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/routes/middleware.py\", line 131, in __call__\n    response = self.app(environ, start_response)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/dec.py\", line 159, in __call__\n    return resp(environ, start_response)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/dec.py\", line 147, in __call__\n    resp = self.call_func(req, *args, **self.kwargs)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/dec.py\", line 208, in call_func\n    return self.func(req, *args, **kwargs)\n  File \"/home/dprince/projects/nova/nova/api/openstack/wsgi.py\", line 864, in __call__\n    content_type, body, accept)\n  File \"/home/dprince/projects/nova/nova/api/openstack/wsgi.py\", line 907, in _process_stack\n    request, action_args)\n  File \"/home/dprince/projects/nova/nova/api/openstack/wsgi.py\", line 797, in pre_process_extensions\n    response = gen.next()\n  File \"/home/dprince/projects/nova/nova/api/openstack/compute/contrib/disk_config.py\", line 142, in create\n    self._set_disk_config(body['server'])\nKeyError: \"'server'\\n-------------------- <snip>\n\n------", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1037201", 
    "owner": "https://api.launchpad.net/1.0/~dan-prince", 
    "id": 1037201, 
    "index": 754, 
    "created": "2012-08-15 16:43:06.410173+00:00", 
    "title": "SchedulerHintsTestCase.test_create_missing_server fails on F17", 
    "comments": [
        {
            "content": "As of this morning I'm getting unit test failures on Fedora 17 when running the Nova unit tests:\n\n\nSchedulerHintsTestCase\n    test_create_missing_server                                   ^[[31mERROR^[[0m^[[31m  0.35^[[0m\n\n======================================================================\nERROR: Test create with malformed body\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/dprince/projects/nova/nova/tests/api/openstack/compute/contrib/test_scheduler_hints.py\", line 112, in test_create_missing_server\n    res = req.get_response(self.app)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/request.py\", line 1053, in get_response\n    application, catch_exc_info=False)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/request.py\", line 1022, in call_application\n    app_iter = application(self.environ, start_response)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/dec.py\", line 159, in __call__\n    return resp(environ, start_response)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/routes/middleware.py\", line 131, in __call__\n    response = self.app(environ, start_response)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/dec.py\", line 159, in __call__\n    return resp(environ, start_response)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/dec.py\", line 147, in __call__\n    resp = self.call_func(req, *args, **self.kwargs)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/webob/dec.py\", line 208, in call_func\n    return self.func(req, *args, **kwargs)\n  File \"/home/dprince/projects/nova/nova/api/openstack/wsgi.py\", line 864, in __call__\n    content_type, body, accept)\n  File \"/home/dprince/projects/nova/nova/api/openstack/wsgi.py\", line 907, in _process_stack\n    request, action_args)\n  File \"/home/dprince/projects/nova/nova/api/openstack/wsgi.py\", line 797, in pre_process_extensions\n    response = gen.next()\n  File \"/home/dprince/projects/nova/nova/api/openstack/compute/contrib/disk_config.py\", line 142, in create\n    self._set_disk_config(body['server'])\nKeyError: \"'server'\\n-------------------- <snip>\n\n------", 
            "date_created": "2012-08-15 16:43:06.410173+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "https://review.openstack.org/#/c/11420/", 
            "date_created": "2012-08-15 17:56:08.914510+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/11420", 
            "date_created": "2012-08-16 00:16:04.483152+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/11420\nCommitted: http://github.com/openstack/nova/commit/00f0b170ec15299b20c345fa1f66f21185c2dc79\nSubmitter: Jenkins\nBranch:    master\n\ncommit 00f0b170ec15299b20c345fa1f66f21185c2dc79\nAuthor: Dan Prince <email address hidden>\nDate:   Wed Aug 15 13:07:19 2012 -0400\n\n    Update disk config to check for 'server' in req.\n    \n    Updates the disk config extension to check for 'server' in the\n    request body before trying to use it. This avoids a potential\n    KeyError exception. Given that we already validate the 'server'\n    dict in servers.py and raise a proper exception there this seems\n    reasonable to me... no reason to duplicate all of the validation\n    logic.\n    \n    The reason this change was able to make it into Nova to begin\n    with is that the Extensions loader orders things differently\n    depending on the OS/python version being used. I tested this\n    by running SchedulerHintsTestCase.test_create_missing_server\n    on both Fedora 16 (passes) and Fedora 17 (fails). The problem\n    only manifests itself when the disk config extension gets called\n    before the scheduler_hints extension. To fix this issue\n    I've updated the scheduler_hints extensions in this patchset\n    to simply pass when 'server' isn't defined which like above seems\n    reasonable because we already validate this in servers.py.\n    \n    As part of this fix I'm also moving test_create_missing_server out\n    of the Scheduler Hints tests and into a new ServersAllExtensionsTestCase\n    class in test_servers.py which explicitly tests for things with *all*\n    extensions enabled. As part of the move I also updated the test to\n    look for HTTP 422 Unprocessable Entity which is what we throw when\n    'server' doesn't exist in a POST to servers (the correct exception).\n    \n    Fixes LP Bug #1037201.\n    \n    Change-Id: I912fc1234b2e7a76ecc54140f4a31c2e32fdfa98\n", 
            "date_created": "2012-08-16 01:37:26.559193+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}