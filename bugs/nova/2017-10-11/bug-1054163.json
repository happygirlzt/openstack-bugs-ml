{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 10:54:20.065764+00:00", 
    "description": "calling this a security exposure since delete data is resurrected\n\n\n\n\nan image existed with uuid ending in af79:\n\nID                                   Name                           Disk Format          Container Format     Size\n------------------------------------ ------------------------------ -------------------- -------------------- --------------\ndcaf164d-7295-4a5a-9878-c2e4b0d3af79 ub.vdi                         vdi                  ovf                       965775360\n0698b15f-160a-48aa-bd97-8ac696b8f8d6 avutil-51.dll                  ami                  ami                          144424\n\nthen it was deleted:\n\nID                                   Name                           Disk Format          Container Format     Size\n------------------------------------ ------------------------------ -------------------- -------------------- --------------\n0698b15f-160a-48aa-bd97-8ac696b8f8d6 avutil-51.dll                  ami                  ami                          144424\n\n\n\nthen a new image with the same text name was added, but with uuid ending in 28f9:\nID                                   Name                           Disk Format          Container Format     Size\n------------------------------------ ------------------------------ -------------------- -------------------- --------------\nb19e1ca7-256e-4aff-8ece-e3ea770e28f9 ub.vdi                         vdi                  ovf                               0\n0698b15f-160a-48aa-bd97-8ac696b8f8d6 avutil-51.dll                  ami                  ami                          144424\n\nthen I booted the deleted image using nova\n\n n boot --flavor 1 --image dcaf164d-7295-4a5a-9878-c2e4b0d3af79  kirk5\n+-------------------------------------+--------------------------------------+\n|               Property              |                Value                 |\n+-------------------------------------+--------------------------------------+\n| OS-DCF:diskConfig                   | MANUAL                               |\n| OS-EXT-SRV-ATTR:host                | None                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | None                                 |\n| OS-EXT-SRV-ATTR:instance_name       | instance-00000006                    |\n| OS-EXT-STS:power_state              | 0                                    |\n| OS-EXT-STS:task_state               | scheduling                           |\n| OS-EXT-STS:vm_state                 | building                             |\n| accessIPv4                          |                                      |\n| accessIPv6                          |                                      |\n| adminPass                           | 97SjHC9vZQaD                         |\n| config_drive                        |                                      |\n| created                             | 2012-09-21T15:43:03Z                 |\n| flavor                              | standard.xsmall                      |\n| hostId                              |                                      |\n| id                                  | 90114972-2386-480c-8e51-2cb2a41828d0 |\n| image                               | ub.vdi                               |\n| key_name                            |                                      |\n| metadata                            | {}                                   |\n| name                                | kirk5                                |\n| progress                            | 0                                    |\n| status                              | BUILD                                |\n| tenant_id                           | aeb143d32b734e6dae0145cbfe7561ba     |\n| updated                             | 2012-09-21T15:43:03Z                 |\n| user_id                             | 804e32e815c146b7b955f19355b3b7a9     |\n+-------------------------------------+--------------------------------------+\n[root@sticken-isc1 ~]# n list\n+--------------------------------------+-------+--------+------------------+\n|                  ID                  |  Name | Status |     Networks     |\n+--------------------------------------+-------+--------+------------------+\n| 90114972-2386-480c-8e51-2cb2a41828d0 | kirk5 | ACTIVE | novanet=10.1.0.6 |\n+--------------------------------------+-------+--------+------------------+\n[root@sticken-isc1 ~]# n list\n+--------------------------------------+-------+--------+-------------------------------+\n|                  ID                  |  Name | Status |            Networks           |\n+--------------------------------------+-------+--------+-------------------------------+\n| 90114972-2386-480c-8e51-2cb2a41828d0 | kirk5 | ACTIVE | novanet=10.1.0.6, 192.168.1.7 |\n+--------------------------------------+-------+--------+-------------------------------", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1054163", 
    "owner": "https://api.launchpad.net/1.0/~mikal", 
    "id": 1054163, 
    "index": 3072, 
    "created": "2012-09-21 15:54:38.151575+00:00", 
    "title": "nova boot succeeds for deleted glance image", 
    "comments": [
        {
            "content": "calling this a security exposure since delete data is resurrected\n\n\n\n\nan image existed with uuid ending in af79:\n\nID                                   Name                           Disk Format          Container Format     Size\n------------------------------------ ------------------------------ -------------------- -------------------- --------------\ndcaf164d-7295-4a5a-9878-c2e4b0d3af79 ub.vdi                         vdi                  ovf                       965775360\n0698b15f-160a-48aa-bd97-8ac696b8f8d6 avutil-51.dll                  ami                  ami                          144424\n\nthen it was deleted:\n\nID                                   Name                           Disk Format          Container Format     Size\n------------------------------------ ------------------------------ -------------------- -------------------- --------------\n0698b15f-160a-48aa-bd97-8ac696b8f8d6 avutil-51.dll                  ami                  ami                          144424\n\n\n\nthen a new image with the same text name was added, but with uuid ending in 28f9:\nID                                   Name                           Disk Format          Container Format     Size\n------------------------------------ ------------------------------ -------------------- -------------------- --------------\nb19e1ca7-256e-4aff-8ece-e3ea770e28f9 ub.vdi                         vdi                  ovf                               0\n0698b15f-160a-48aa-bd97-8ac696b8f8d6 avutil-51.dll                  ami                  ami                          144424\n\nthen I booted the deleted image using nova\n\n n boot --flavor 1 --image dcaf164d-7295-4a5a-9878-c2e4b0d3af79  kirk5\n+-------------------------------------+--------------------------------------+\n|               Property              |                Value                 |\n+-------------------------------------+--------------------------------------+\n| OS-DCF:diskConfig                   | MANUAL                               |\n| OS-EXT-SRV-ATTR:host                | None                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | None                                 |\n| OS-EXT-SRV-ATTR:instance_name       | instance-00000006                    |\n| OS-EXT-STS:power_state              | 0                                    |\n| OS-EXT-STS:task_state               | scheduling                           |\n| OS-EXT-STS:vm_state                 | building                             |\n| accessIPv4                          |                                      |\n| accessIPv6                          |                                      |\n| adminPass                           | 97SjHC9vZQaD                         |\n| config_drive                        |                                      |\n| created                             | 2012-09-21T15:43:03Z                 |\n| flavor                              | standard.xsmall                      |\n| hostId                              |                                      |\n| id                                  | 90114972-2386-480c-8e51-2cb2a41828d0 |\n| image                               | ub.vdi                               |\n| key_name                            |                                      |\n| metadata                            | {}                                   |\n| name                                | kirk5                                |\n| progress                            | 0                                    |\n| status                              | BUILD                                |\n| tenant_id                           | aeb143d32b734e6dae0145cbfe7561ba     |\n| updated                             | 2012-09-21T15:43:03Z                 |\n| user_id                             | 804e32e815c146b7b955f19355b3b7a9     |\n+-------------------------------------+--------------------------------------+\n[root@sticken-isc1 ~]# n list\n+--------------------------------------+-------+--------+------------------+\n|                  ID                  |  Name | Status |     Networks     |\n+--------------------------------------+-------+--------+------------------+\n| 90114972-2386-480c-8e51-2cb2a41828d0 | kirk5 | ACTIVE | novanet=10.1.0.6 |\n+--------------------------------------+-------+--------+------------------+\n[root@sticken-isc1 ~]# n list\n+--------------------------------------+-------+--------+-------------------------------+\n|                  ID                  |  Name | Status |            Networks           |\n+--------------------------------------+-------+--------+-------------------------------+\n| 90114972-2386-480c-8e51-2cb2a41828d0 | kirk5 | ACTIVE | novanet=10.1.0.6, 192.168.1.7 |\n+--------------------------------------+-------+--------+-------------------------------", 
            "date_created": "2012-09-21 15:54:38.151575+00:00", 
            "author": "https://api.launchpad.net/1.0/~william-kir-sticken"
        }, 
        {
            "content": "opened against glance at first, changed to nova compute", 
            "date_created": "2012-09-21 15:58:24.338293+00:00", 
            "author": "https://api.launchpad.net/1.0/~william-kir-sticken"
        }, 
        {
            "content": "So here is what seems to be happening:\n\n1) A non-admin user boots the image in question, caching it on the nova-compute node (by uuid)\n2) That non-admin user deletes said image - the image is *not* removed from the cache, however\n3) An admin user can still see the metadata in Glance, and since the data is cached locally, it is still bootable by that admin user\n\nIt is key to realize that Glance allows admin users to make HEAD (metadata-only) requests of images through the v1 API. When Nova checks for image existence before trying to boot the vm and everything seems to check out. It doesnt attempt to download the data since it has a local cached copy.\n\nI tried creating a new vm from an image that had never been cached and the vm did go to ERROR.", 
            "date_created": "2012-09-21 16:25:07.141038+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "If only an admin can boot the deleted image, I'd say this is just a regular bug and not a vulnerability.  Thoughts?", 
            "date_created": "2012-09-21 18:14:10.055254+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "That sounds fair. We should probably delete images from the cache if the image was deleted explicitly through the OpenStack Compute API.", 
            "date_created": "2012-09-21 18:45:59.554619+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "my thought: it is important that proper data clensing be done.  having a hidden image (on the file system?) that does not show in \"glance index\" seems dicey to me.  at least make a \"flush the cache\" parameter part of the delete image call", 
            "date_created": "2012-09-21 18:59:46.088036+00:00", 
            "author": "https://api.launchpad.net/1.0/~william-kir-sticken"
        }, 
        {
            "content": "The cache is distributed across all compute nodes, though.  Forcing it to be deleted from the cache would require broadcasting a message to all compute nodes every time an image is deleted, though.  Is there a way for nova to know that an image has been deleted based on the metadata the admin user can see about that image?\n\nOn a related note, right now if the image is no longer in use (no instances running on that compute node that used it as their base), it will get deleted from the cache by a periodic task that runs every 40 to 60 minutes or so (40 ticks, so 40 * 60 seconds plus however long it takes for 40 runs of periodic tasks).\n", 
            "date_created": "2012-09-21 20:14:28.685887+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "We can't just delete the image from the cache -- it might still be in use for instances which were started before the delete. It seems like we need a check to make sure the image still exists before we create a new instance.", 
            "date_created": "2012-09-22 06:20:29.879086+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "Ok, so attached is a possible fix for this problem. I have two questions:\n\n - what do people think of this approach?\n - what's the right way to push this out for review? Just plonk it into gerrit with no bug comment? Something else?", 
            "date_created": "2012-09-23 22:12:33.212493+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "I agree that this is not a vulnerability per se (due do it only being accessible to admins) but should definitely be strengthened. Will open the bug to public soon unless someone objects.", 
            "date_created": "2012-09-24 08:49:43.621015+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Yes open to public. Only admins can do it so I don't think there is a security issue here. Mikal: patch seems reasonable to me.", 
            "date_created": "2012-09-25 23:50:20.398063+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I messed up the commit message tag for this bug, so here's me doing it manually. The patch just merged as https://review.openstack.org/#/c/13692/", 
            "date_created": "2012-09-27 21:14:01.802926+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }
    ]
}