{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:58:47.349728+00:00", 
    "description": "It's a command to terminate instance.\n# nova delete <instance-id>\nthen, compute-api call self.db.instance_destroy(context, instance_id)\n\nnova/compute/manager.py\n 555     def _delete_instance(self, context, instance_id):\n 556         \"\"\"Delete an instance on this host.\"\"\"\n 557         self._shutdown_instance(context, instance_id, 'Terminating', True)\n 558         self._cleanup_volumes(context, instance_id)\n 559         instance = self.db.instance_get(context.elevated(), instance_id)\n 560         self._instance_update(context,\n 561                               instance_id,\n 562                               vm_state=vm_states.DELETED,\n 563                               task_state=None,\n 564                               terminated_at=utils.utcnow())\n 565\n 566         self.db.instance_destroy(context, instance_id)\n 567\n 568         usage_info = utils.usage_from_instance(instance)\n 569         notifier.notify('compute.%s' % self.host,\n 570                         'compute.instance.delete',\n 571                         notifier.INFO, usage_info)\n\nfinally, instance_destroy() is called at nova/db/sqlalchemy/api.py \n1168 @require_context\n1169 def instance_destroy(context, instance_id):\n1170     session = get_session()\n1171     with session.begin():\n1172         session.query(models.Instance).\\\n1173                 filter_by(id=instance_id).\\\n1174                 update({'deleted': True,\n1175                         'deleted_at': utils.utcnow(),\n1176                         'updated_at': literal_column('updated_at')})\n1177         session.query(models.SecurityGroupInstanceAssociation).\\\n1178                 filter_by(instance_id=instance_id).\\\n1179                 update({'deleted': True,\n1180                         'deleted_at': utils.utcnow(),\n1181                         'updated_at': literal_column('updated_at')})\n1182         session.query(models.InstanceMetadata).\\\n1183                 filter_by(instance_id=instance_id).\\\n1184                 update({'deleted': True,\n1185                         'deleted_at': utils.utcnow(),\n1186                         'updated_at': literal_column('updated_at')})\n1187         session.query(models.BlockDeviceMapping).\\\n1188                 filter_by(instance_id=instance_id).\\\n1189                 update({'deleted': True,\n1190                         'deleted_at': utils.utcnow(),\n1191                         'updated_at': literal_column('updated_at')})\n\n\nBut, this update didn't clean or delete any network information of instance.\n instance_destroy() update only instances, security_group_instance_association, instance_metadata, block_device_mapping table.\nBecause this method didn't update fixed_ips and floating_ips, there is error occured when I allocate all fixed or floating ip address to instance.\n\nthis is example)\n# nova list\n+--------------------------------------+--------------+--------+------------------------------------+\n|                  ID                  |     Name     | Status |              Networks              |\n+--------------------------------------+--------------+--------+------------------------------------+\n| 1fcc667d-a8cd-407b-864c-21b021bfbb19 | CentOS_1     | ACTIVE | private=10.0.152.23                |\n| a2561d60-5bb4-4429-b946-67df5abb247d | network_test | ACTIVE | private=10.0.152.31                |\n| bbfa18ce-a21a-460c-8689-e746e0583939 | backend      | ACTIVE | private=10.0.152.21                |\n| cf737e81-aa7a-4ce5-b8bd-bce503d96b06 | wintest      | ACTIVE | private=10.0.152.22, 192.168.0.208 |\n+--------------------------------------+--------------+--------+------------------------------------+\n\nmysql>select * from fixed_ips where deleted=0;\nmysql> select * from fixed_ips where deleted=0;\n+---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n| created_at          | updated_at          | deleted_at | deleted | id | address     | network_id | instance_id | allocated | leased | reserved | virtual_interface_id | host    |\n+---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n| 2011-11-10 01:41:21 | NULL                | NULL       |       0 |  1 | 10.0.152.0  |          1 |        NULL |         0 |      0 |        1 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | NULL                | NULL       |       0 |  2 | 10.0.152.1  |          1 |        NULL |         0 |      0 |        1 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 01:40:58 | NULL       |       0 |  3 | 10.0.152.2  |          1 |           1 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-10 02:22:19 | NULL       |       0 |  4 | 10.0.152.3  |          1 |        NULL |         0 |      0 |        0 |                 NULL | nova152 |\n| 2011-11-10 01:41:21 | 2011-11-15 01:37:06 | NULL       |       0 |  5 | 10.0.152.4  |          1 |           2 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 04:32:53 | NULL       |       0 |  6 | 10.0.152.5  |          1 |           3 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 04:32:47 | NULL       |       0 |  7 | 10.0.152.6  |          1 |           4 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 04:32:42 | NULL       |       0 |  8 | 10.0.152.7  |          1 |           5 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 04:32:59 | NULL       |       0 |  9 | 10.0.152.8  |          1 |           6 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:20 | NULL       |       0 | 10 | 10.0.152.9  |          1 |           7 |         1 |      0 |        0 |                    7 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:21 | NULL       |       0 | 11 | 10.0.152.10 |          1 |           8 |         1 |      0 |        0 |                    8 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:22 | NULL       |       0 | 12 | 10.0.152.11 |          1 |           9 |         1 |      0 |        0 |                    9 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:24 | NULL       |       0 | 13 | 10.0.152.12 |          1 |          10 |         1 |      0 |        0 |                   10 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:25 | NULL       |       0 | 14 | 10.0.152.13 |          1 |          11 |         1 |      0 |        0 |                   11 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 05:39:57 | NULL       |       0 | 15 | 10.0.152.14 |          1 |          12 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-16 06:29:44 | NULL       |       0 | 16 | 10.0.152.15 |          1 |          13 |         1 |      0 |        0 |                   13 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-16 07:32:12 | NULL       |       0 | 17 | 10.0.152.16 |          1 |          14 |         1 |      0 |        0 |                   14 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:27 | NULL       |       0 | 18 | 10.0.152.17 |          1 |          15 |         1 |      0 |        0 |                   15 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:28 | NULL       |       0 | 19 | 10.0.152.18 |          1 |          16 |         1 |      0 |        0 |                   16 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-16 08:22:54 | NULL       |       0 | 20 | 10.0.152.19 |          1 |          17 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-16 08:28:41 | NULL       |       0 | 21 | 10.0.152.20 |          1 |          18 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-12-01 05:44:58 | NULL       |       0 | 22 | 10.0.152.21 |          1 |          19 |         1 |      1 |        0 |                   19 | NULL    |\n| 2011-11-10 01:41:21 | 2011-12-01 05:44:17 | NULL       |       0 | 23 | 10.0.152.22 |          1 |          20 |         1 |      1 |        0 |                   20 | NULL    |\n| 2011-11-10 01:41:21 | 2011-12-01 05:44:54 | NULL       |       0 | 24 | 10.0.152.23 |          1 |          21 |         1 |      1 |        0 |                   21 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-29 08:51:37 | NULL       |       0 | 25 | 10.0.152.24 |          1 |          22 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-29 08:54:12 | NULL       |       0 | 26 | 10.0.152.25 |          1 |          23 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-29 08:53:49 | NULL       |       0 | 27 | 10.0.152.26 |          1 |          24 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-30 02:00:44 | NULL       |       0 | 28 | 10.0.152.27 |          1 |          25 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-12-01 04:13:22 | NULL       |       0 | 29 | 10.0.152.28 |          1 |          26 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-30 11:14:07 | NULL       |       0 | 30 | 10.0.152.29 |          1 |          27 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-30 02:05:08 | NULL       |       0 | 31 | 10.0.152.30 |          1 |          28 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-30 09:02:26 | NULL       |       0 | 32 | 10.0.152.31 |          1 |          30 |         1 |      0 |        0 |                   30 | NULL    |\n+---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n\nevery fixed_ips was allocated one time. But now There are only 4 instances, other instances was deleted.\n\nthen, I try to boot new instance, nova didn't. \n/var/log/nova/nova-compute.log\n2011-12-01 14:46:40,776 DEBUG nova.rpc [-] received {u'_context_roles': [], u'_context_request_id': u'16045694-f17a-4c22-bb5b-1207c2f72b24', u'_context_read_deleted': False, u'args': {u'instance_id': 32, u'requested_networks': None, u'admin_password': u'v4PTPrMAgn2Z', u'injected_files': []}, u'_context_auth_token': None, u'_context_strategy': u'noauth', u'_context_is_admin': True, u'_context_project_id': u'sds', u'_context_timestamp': u'2011-12-01T05:46:40.217989', u'_context_user_id': u'nova', u'method': u'run_instance', u'_context_remote_address': u'127.0.0.1'} from (pid=5977) __call__ /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:600\n2011-12-01 14:46:40,777 DEBUG nova.rpc [-] unpacked context: {'user_id': u'nova', 'roles': [], 'timestamp': u'2011-12-01T05:46:40.217989', 'auth_token': None, 'msg_id': None, 'remote_address': u'127.0.0.1', 'strategy': u'noauth', 'is_admin': True, 'request_id': u'16045694-f17a-4c22-bb5b-1207c2f72b24', 'project_id': u'sds', 'read_deleted': False} from (pid=5977) _unpack_context /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:646\n2011-12-01 14:46:47,914 AUDIT nova.compute.manager [16045694-f17a-4c22-bb5b-1207c2f72b24 nova sds] instance 32: starting...\n2011-12-01 14:46:47,988 DEBUG nova.rpc [-] Making asynchronous call on network ... from (pid=5977) multicall /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:721\n2011-12-01 14:46:47,988 DEBUG nova.rpc [-] MSG_ID is 9436655168cb45c7aea3ba4017fc58d4 from (pid=5977) multicall /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:724\n2011-12-01 14:46:48,128 ERROR nova.compute.manager [-] Instance '32' failed network setup.\n(nova.compute.manager): TRACE: Traceback (most recent call last):\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 415, in _logging_error\n(nova.compute.manager): TRACE:     yield\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 446, in _run_instance\n(nova.compute.manager): TRACE:     network_info = _make_network_info()\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 382, in _make_network_info\n(nova.compute.manager): TRACE:     requested_networks=requested_networks)\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/api.py\", line 119, in allocate_for_instance\n(nova.compute.manager): TRACE:     'args': args})\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/__init__.py\", line 45, in call\n(nova.compute.manager): TRACE:     return get_impl().call(context, topic, msg)\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 738, in call\n(nova.compute.manager): TRACE:     rv = list(rv)\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 703, in __iter__\n(nova.compute.manager): TRACE:     raise result\n(nova.compute.manager): TRACE: RemoteError: Remote error: NoMoreFixedIps Zero fixed ips available.\n(nova.compute.manager): TRACE: [u'Traceback (most recent call last):\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\\n    rval = node_func(context=ctxt, **node_args)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 223, in allocate_for_instance\\n    super(FloatingIP, self).allocate_for_instance(context, **kwargs)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 631, in allocate_for_instance\\n    requested_networks=requested_networks)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 172, in _allocate_fixed_ips\\n    vpn=vpn, address=address)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 802, in allocate_fixed_ip\\n    instance_id)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 366, in fixed_ip_associate_pool\\n    instance_id, host)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 102, in wrapper\\n    return f(*args, **kwargs)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 757, in fixed_ip_associate_pool\\n    raise exception.NoMoreFixedIps()\\n', u'NoMoreFixedIps: Zero fixed ips available.\\n'].\n\n\n\nI think when terminate instance, nova should clean network ip information(fixed_ips, floating_ips). \nOR, when boot new instance, nova should select ip to instance properly.", 
    "tags": [
        "instance", 
        "ip", 
        "network"
    ], 
    "importance": "High", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/898485", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 898485, 
    "index": 531, 
    "created": "2011-12-01 05:58:12.957919+00:00", 
    "title": "terminate instance didn't clean ip information", 
    "comments": [
        {
            "content": "It's a command to terminate instance.\n# nova delete <instance-id>\nthen, compute-api call self.db.instance_destroy(context, instance_id)\n\nnova/compute/manager.py\n 555     def _delete_instance(self, context, instance_id):\n 556         \"\"\"Delete an instance on this host.\"\"\"\n 557         self._shutdown_instance(context, instance_id, 'Terminating', True)\n 558         self._cleanup_volumes(context, instance_id)\n 559         instance = self.db.instance_get(context.elevated(), instance_id)\n 560         self._instance_update(context,\n 561                               instance_id,\n 562                               vm_state=vm_states.DELETED,\n 563                               task_state=None,\n 564                               terminated_at=utils.utcnow())\n 565\n 566         self.db.instance_destroy(context, instance_id)\n 567\n 568         usage_info = utils.usage_from_instance(instance)\n 569         notifier.notify('compute.%s' % self.host,\n 570                         'compute.instance.delete',\n 571                         notifier.INFO, usage_info)\n\nfinally, instance_destroy() is called at nova/db/sqlalchemy/api.py \n1168 @require_context\n1169 def instance_destroy(context, instance_id):\n1170     session = get_session()\n1171     with session.begin():\n1172         session.query(models.Instance).\\\n1173                 filter_by(id=instance_id).\\\n1174                 update({'deleted': True,\n1175                         'deleted_at': utils.utcnow(),\n1176                         'updated_at': literal_column('updated_at')})\n1177         session.query(models.SecurityGroupInstanceAssociation).\\\n1178                 filter_by(instance_id=instance_id).\\\n1179                 update({'deleted': True,\n1180                         'deleted_at': utils.utcnow(),\n1181                         'updated_at': literal_column('updated_at')})\n1182         session.query(models.InstanceMetadata).\\\n1183                 filter_by(instance_id=instance_id).\\\n1184                 update({'deleted': True,\n1185                         'deleted_at': utils.utcnow(),\n1186                         'updated_at': literal_column('updated_at')})\n1187         session.query(models.BlockDeviceMapping).\\\n1188                 filter_by(instance_id=instance_id).\\\n1189                 update({'deleted': True,\n1190                         'deleted_at': utils.utcnow(),\n1191                         'updated_at': literal_column('updated_at')})\n\n\nBut, this update didn't clean or delete any network information of instance.\n instance_destroy() update only instances, security_group_instance_association, instance_metadata, block_device_mapping table.\nBecause this method didn't update fixed_ips and floating_ips, there is error occured when I allocate all fixed or floating ip address to instance.\n\nthis is example)\n# nova list\n+--------------------------------------+--------------+--------+------------------------------------+\n|                  ID                  |     Name     | Status |              Networks              |\n+--------------------------------------+--------------+--------+------------------------------------+\n| 1fcc667d-a8cd-407b-864c-21b021bfbb19 | CentOS_1     | ACTIVE | private=10.0.152.23                |\n| a2561d60-5bb4-4429-b946-67df5abb247d | network_test | ACTIVE | private=10.0.152.31                |\n| bbfa18ce-a21a-460c-8689-e746e0583939 | backend      | ACTIVE | private=10.0.152.21                |\n| cf737e81-aa7a-4ce5-b8bd-bce503d96b06 | wintest      | ACTIVE | private=10.0.152.22, 192.168.0.208 |\n+--------------------------------------+--------------+--------+------------------------------------+\n\nmysql>select * from fixed_ips where deleted=0;\nmysql> select * from fixed_ips where deleted=0;\n+---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n| created_at          | updated_at          | deleted_at | deleted | id | address     | network_id | instance_id | allocated | leased | reserved | virtual_interface_id | host    |\n+---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n| 2011-11-10 01:41:21 | NULL                | NULL       |       0 |  1 | 10.0.152.0  |          1 |        NULL |         0 |      0 |        1 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | NULL                | NULL       |       0 |  2 | 10.0.152.1  |          1 |        NULL |         0 |      0 |        1 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 01:40:58 | NULL       |       0 |  3 | 10.0.152.2  |          1 |           1 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-10 02:22:19 | NULL       |       0 |  4 | 10.0.152.3  |          1 |        NULL |         0 |      0 |        0 |                 NULL | nova152 |\n| 2011-11-10 01:41:21 | 2011-11-15 01:37:06 | NULL       |       0 |  5 | 10.0.152.4  |          1 |           2 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 04:32:53 | NULL       |       0 |  6 | 10.0.152.5  |          1 |           3 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 04:32:47 | NULL       |       0 |  7 | 10.0.152.6  |          1 |           4 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 04:32:42 | NULL       |       0 |  8 | 10.0.152.7  |          1 |           5 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 04:32:59 | NULL       |       0 |  9 | 10.0.152.8  |          1 |           6 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:20 | NULL       |       0 | 10 | 10.0.152.9  |          1 |           7 |         1 |      0 |        0 |                    7 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:21 | NULL       |       0 | 11 | 10.0.152.10 |          1 |           8 |         1 |      0 |        0 |                    8 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:22 | NULL       |       0 | 12 | 10.0.152.11 |          1 |           9 |         1 |      0 |        0 |                    9 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:24 | NULL       |       0 | 13 | 10.0.152.12 |          1 |          10 |         1 |      0 |        0 |                   10 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:25 | NULL       |       0 | 14 | 10.0.152.13 |          1 |          11 |         1 |      0 |        0 |                   11 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-15 05:39:57 | NULL       |       0 | 15 | 10.0.152.14 |          1 |          12 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-16 06:29:44 | NULL       |       0 | 16 | 10.0.152.15 |          1 |          13 |         1 |      0 |        0 |                   13 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-16 07:32:12 | NULL       |       0 | 17 | 10.0.152.16 |          1 |          14 |         1 |      0 |        0 |                   14 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:27 | NULL       |       0 | 18 | 10.0.152.17 |          1 |          15 |         1 |      0 |        0 |                   15 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-17 23:47:28 | NULL       |       0 | 19 | 10.0.152.18 |          1 |          16 |         1 |      0 |        0 |                   16 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-16 08:22:54 | NULL       |       0 | 20 | 10.0.152.19 |          1 |          17 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-16 08:28:41 | NULL       |       0 | 21 | 10.0.152.20 |          1 |          18 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-12-01 05:44:58 | NULL       |       0 | 22 | 10.0.152.21 |          1 |          19 |         1 |      1 |        0 |                   19 | NULL    |\n| 2011-11-10 01:41:21 | 2011-12-01 05:44:17 | NULL       |       0 | 23 | 10.0.152.22 |          1 |          20 |         1 |      1 |        0 |                   20 | NULL    |\n| 2011-11-10 01:41:21 | 2011-12-01 05:44:54 | NULL       |       0 | 24 | 10.0.152.23 |          1 |          21 |         1 |      1 |        0 |                   21 | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-29 08:51:37 | NULL       |       0 | 25 | 10.0.152.24 |          1 |          22 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-29 08:54:12 | NULL       |       0 | 26 | 10.0.152.25 |          1 |          23 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-29 08:53:49 | NULL       |       0 | 27 | 10.0.152.26 |          1 |          24 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-30 02:00:44 | NULL       |       0 | 28 | 10.0.152.27 |          1 |          25 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-12-01 04:13:22 | NULL       |       0 | 29 | 10.0.152.28 |          1 |          26 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-30 11:14:07 | NULL       |       0 | 30 | 10.0.152.29 |          1 |          27 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-30 02:05:08 | NULL       |       0 | 31 | 10.0.152.30 |          1 |          28 |         0 |      0 |        0 |                 NULL | NULL    |\n| 2011-11-10 01:41:21 | 2011-11-30 09:02:26 | NULL       |       0 | 32 | 10.0.152.31 |          1 |          30 |         1 |      0 |        0 |                   30 | NULL    |\n+---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n\nevery fixed_ips was allocated one time. But now There are only 4 instances, other instances was deleted.\n\nthen, I try to boot new instance, nova didn't. \n/var/log/nova/nova-compute.log\n2011-12-01 14:46:40,776 DEBUG nova.rpc [-] received {u'_context_roles': [], u'_context_request_id': u'16045694-f17a-4c22-bb5b-1207c2f72b24', u'_context_read_deleted': False, u'args': {u'instance_id': 32, u'requested_networks': None, u'admin_password': u'v4PTPrMAgn2Z', u'injected_files': []}, u'_context_auth_token': None, u'_context_strategy': u'noauth', u'_context_is_admin': True, u'_context_project_id': u'sds', u'_context_timestamp': u'2011-12-01T05:46:40.217989', u'_context_user_id': u'nova', u'method': u'run_instance', u'_context_remote_address': u'127.0.0.1'} from (pid=5977) __call__ /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:600\n2011-12-01 14:46:40,777 DEBUG nova.rpc [-] unpacked context: {'user_id': u'nova', 'roles': [], 'timestamp': u'2011-12-01T05:46:40.217989', 'auth_token': None, 'msg_id': None, 'remote_address': u'127.0.0.1', 'strategy': u'noauth', 'is_admin': True, 'request_id': u'16045694-f17a-4c22-bb5b-1207c2f72b24', 'project_id': u'sds', 'read_deleted': False} from (pid=5977) _unpack_context /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:646\n2011-12-01 14:46:47,914 AUDIT nova.compute.manager [16045694-f17a-4c22-bb5b-1207c2f72b24 nova sds] instance 32: starting...\n2011-12-01 14:46:47,988 DEBUG nova.rpc [-] Making asynchronous call on network ... from (pid=5977) multicall /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:721\n2011-12-01 14:46:47,988 DEBUG nova.rpc [-] MSG_ID is 9436655168cb45c7aea3ba4017fc58d4 from (pid=5977) multicall /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:724\n2011-12-01 14:46:48,128 ERROR nova.compute.manager [-] Instance '32' failed network setup.\n(nova.compute.manager): TRACE: Traceback (most recent call last):\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 415, in _logging_error\n(nova.compute.manager): TRACE:     yield\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 446, in _run_instance\n(nova.compute.manager): TRACE:     network_info = _make_network_info()\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 382, in _make_network_info\n(nova.compute.manager): TRACE:     requested_networks=requested_networks)\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/api.py\", line 119, in allocate_for_instance\n(nova.compute.manager): TRACE:     'args': args})\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/__init__.py\", line 45, in call\n(nova.compute.manager): TRACE:     return get_impl().call(context, topic, msg)\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 738, in call\n(nova.compute.manager): TRACE:     rv = list(rv)\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 703, in __iter__\n(nova.compute.manager): TRACE:     raise result\n(nova.compute.manager): TRACE: RemoteError: Remote error: NoMoreFixedIps Zero fixed ips available.\n(nova.compute.manager): TRACE: [u'Traceback (most recent call last):\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\\n    rval = node_func(context=ctxt, **node_args)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 223, in allocate_for_instance\\n    super(FloatingIP, self).allocate_for_instance(context, **kwargs)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 631, in allocate_for_instance\\n    requested_networks=requested_networks)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 172, in _allocate_fixed_ips\\n    vpn=vpn, address=address)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 802, in allocate_fixed_ip\\n    instance_id)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 366, in fixed_ip_associate_pool\\n    instance_id, host)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 102, in wrapper\\n    return f(*args, **kwargs)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 757, in fixed_ip_associate_pool\\n    raise exception.NoMoreFixedIps()\\n', u'NoMoreFixedIps: Zero fixed ips available.\\n'].\n\n\n\nI think when terminate instance, nova should clean network ip information(fixed_ips, floating_ips). \nOR, when boot new instance, nova should select ip to instance properly.", 
            "date_created": "2011-12-01 05:58:12.957919+00:00", 
            "author": "https://api.launchpad.net/1.0/~hyangii"
        }, 
        {
            "content": "IPs are supposed to be disassociated after a timeout (by default 600 seconds), see fixed_ip_disassociate_timeout for example, so I think that's intended behavior ?", 
            "date_created": "2011-12-02 13:16:12.219656+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Yes, I know fixed_ip_disassociate_timeout can disassociate ip address, but this method could run when host value in networks DB.\nBut, When we make a network, host value didn't put any value, So default host value is NULL.\nFor example)\n# nova-manage network create test_network 10.102.0.0/24\n\nmysql>select * from networks\\G;\n*************************** 2. row ***************************\n         created_at: 2011-12-09 05:20:13\n         updated_at: NULL\n         deleted_at: NULL\n            deleted: 0\n                 id: 2\n           injected: 0\n               cidr: 10.102.0.0/24\n            netmask: 255.255.255.0\n             bridge: br100\n            gateway: 10.102.0.1\n          broadcast: 10.102.0.255\n               dns1: 8.8.4.4\n               vlan: NULL\n vpn_public_address: NULL\n    vpn_public_port: NULL\nvpn_private_address: NULL\n         dhcp_start: 10.102.0.2\n         project_id: NULL\n               host: NULL\n            cidr_v6: NULL\n         gateway_v6: NULL\n              label: test_network\n         netmask_v6: NULL\n   bridge_interface: bond1\n         multi_host: 1\n               dns2: NULL\n               uuid: 07774f63-df94-4ddb-9274-800ff8e5ae20\n           priority: NULL\n\n\n\nbecause host value is null,  fixed_ip_disassociate_timeout method didn't run properly.\n\nthis is source code of network.manager.periodic_tasks\n 509     def periodic_tasks(self, context=None):\n 510         \"\"\"Tasks to be run at a periodic interval.\"\"\"\n 511         super(NetworkManager, self).periodic_tasks(context)\n 512         print('timeout_fixed_ips: {}').format(self.timeout_fixed_ips)\n 513         if self.timeout_fixed_ips:\n 514             now = utils.utcnow()\n 515             timeout = FLAGS.fixed_ip_disassociate_timeout\n 516             time = now - datetime.timedelta(seconds=timeout)\n 517             num = self.db.fixed_ip_disassociate_all_by_timeout(context,\n 518                                                                self.host,\n 519                                                                time)\n\nmaybe nova-network send self.host and time value through self.db.fixed_ip_disassociate_all_by_timeout.\n\nbut In database, host is null so \n\nself.host != host value in db\n\ndb.sqlalchemy.api.fixed_ip_disassociate_all_by_timeout could run properly when \n\nself.host == host value in db\n\nthis is source code of db.sqlalchemy.api.fixed_ip_disassociate_all_by_timeout\n 801 @require_admin_context\n 802 def fixed_ip_disassociate_all_by_timeout(_context, host, time):\n 803     session = get_session()\n 804     inner_q = session.query(models.Network.id).\\\n 805                       filter_by(host=host).\\\n 806                       subquery()\n 807     result = session.query(models.FixedIp).\\\n 808                      filter(models.FixedIp.network_id.in_(inner_q)).\\\n 809                      filter(models.FixedIp.updated_at < time).\\\n 810                      filter(models.FixedIp.instance_id != None).\\\n 811                      filter_by(allocated=False).\\\n 812                      update({'instance_id': None,\n 813                              'leased': False,\n 814                              'updated_at': utils.utcnow()},\n 815                              synchronize_session='fetch')\n\n\nSo, I think there is some host value when create a new network to DB.\nOR db.sqlalchemy.api.fixed_ip_disassociate_all_by_timeout don't check host value in DB.\n", 
            "date_created": "2011-12-09 05:28:04.216178+00:00", 
            "author": "https://api.launchpad.net/1.0/~hyangii"
        }, 
        {
            "content": "Ah, nice find.  The disassociate timeout looks broken.  It wasn't updated to handle multi_host networks properly.  As a workaround, you can use --force_dhcp_release to make nova release the dhcp lease immediately when the vm is deleted.\n\nOn Dec 8, 2011, at 9:28 PM, jaesanglee wrote:\n\n> Yes, I know fixed_ip_disassociate_timeout can disassociate ip address, but this method could run when host value in networks DB.\n> But, When we make a network, host value didn't put any value, So default host value is NULL.\n> For example)\n> # nova-manage network create test_network 10.102.0.0/24\n> \n> mysql>select * from networks\\G;\n> *************************** 2. row ***************************\n>         created_at: 2011-12-09 05:20:13\n>         updated_at: NULL\n>         deleted_at: NULL\n>            deleted: 0\n>                 id: 2\n>           injected: 0\n>               cidr: 10.102.0.0/24\n>            netmask: 255.255.255.0\n>             bridge: br100\n>            gateway: 10.102.0.1\n>          broadcast: 10.102.0.255\n>               dns1: 8.8.4.4\n>               vlan: NULL\n> vpn_public_address: NULL\n>    vpn_public_port: NULL\n> vpn_private_address: NULL\n>         dhcp_start: 10.102.0.2\n>         project_id: NULL\n>               host: NULL\n>            cidr_v6: NULL\n>         gateway_v6: NULL\n>              label: test_network\n>         netmask_v6: NULL\n>   bridge_interface: bond1\n>         multi_host: 1\n>               dns2: NULL\n>               uuid: 07774f63-df94-4ddb-9274-800ff8e5ae20\n>           priority: NULL\n> \n> \n> because host value is null,  fixed_ip_disassociate_timeout method didn't\n> run properly.\n> \n> this is source code of network.manager.periodic_tasks\n> 509     def periodic_tasks(self, context=None):\n> 510         \"\"\"Tasks to be run at a periodic interval.\"\"\"\n> 511         super(NetworkManager, self).periodic_tasks(context)\n> 512         print('timeout_fixed_ips: {}').format(self.timeout_fixed_ips)\n> 513         if self.timeout_fixed_ips:\n> 514             now = utils.utcnow()\n> 515             timeout = FLAGS.fixed_ip_disassociate_timeout\n> 516             time = now - datetime.timedelta(seconds=timeout)\n> 517             num = self.db.fixed_ip_disassociate_all_by_timeout(context,\n> 518                                                                self.host,\n> 519                                                                time)\n> \n> maybe nova-network send self.host and time value through\n> self.db.fixed_ip_disassociate_all_by_timeout.\n> \n> but In database, host is null so\n> \n> self.host != host value in db\n> \n> db.sqlalchemy.api.fixed_ip_disassociate_all_by_timeout could run\n> properly when\n> \n> self.host == host value in db\n> \n> this is source code of db.sqlalchemy.api.fixed_ip_disassociate_all_by_timeout\n> 801 @require_admin_context\n> 802 def fixed_ip_disassociate_all_by_timeout(_context, host, time):\n> 803     session = get_session()\n> 804     inner_q = session.query(models.Network.id).\\\n> 805                       filter_by(host=host).\\\n> 806                       subquery()\n> 807     result = session.query(models.FixedIp).\\\n> 808                      filter(models.FixedIp.network_id.in_(inner_q)).\\\n> 809                      filter(models.FixedIp.updated_at < time).\\\n> 810                      filter(models.FixedIp.instance_id != None).\\\n> 811                      filter_by(allocated=False).\\\n> 812                      update({'instance_id': None,\n> 813                              'leased': False,\n> 814                              'updated_at': utils.utcnow()},\n> 815                              synchronize_session='fetch')\n> \n> \n> So, I think there is some host value when create a new network to DB.\n> OR db.sqlalchemy.api.fixed_ip_disassociate_all_by_timeout don't check host value in DB.\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/898485\n> \n> Title:\n>  terminate instance didn't clean ip information\n> \n> Status in OpenStack Compute (Nova):\n>  Incomplete\n> \n> Bug description:\n>  It's a command to terminate instance.\n>  # nova delete <instance-id>\n>  then, compute-api call self.db.instance_destroy(context, instance_id)\n> \n>  nova/compute/manager.py\n>   555     def _delete_instance(self, context, instance_id):\n>   556         \"\"\"Delete an instance on this host.\"\"\"\n>   557         self._shutdown_instance(context, instance_id, 'Terminating', True)\n>   558         self._cleanup_volumes(context, instance_id)\n>   559         instance = self.db.instance_get(context.elevated(), instance_id)\n>   560         self._instance_update(context,\n>   561                               instance_id,\n>   562                               vm_state=vm_states.DELETED,\n>   563                               task_state=None,\n>   564                               terminated_at=utils.utcnow())\n>   565\n>   566         self.db.instance_destroy(context, instance_id)\n>   567\n>   568         usage_info = utils.usage_from_instance(instance)\n>   569         notifier.notify('compute.%s' % self.host,\n>   570                         'compute.instance.delete',\n>   571                         notifier.INFO, usage_info)\n> \n>  finally, instance_destroy() is called at nova/db/sqlalchemy/api.py \n>  1168 @require_context\n>  1169 def instance_destroy(context, instance_id):\n>  1170     session = get_session()\n>  1171     with session.begin():\n>  1172         session.query(models.Instance).\\\n>  1173                 filter_by(id=instance_id).\\\n>  1174                 update({'deleted': True,\n>  1175                         'deleted_at': utils.utcnow(),\n>  1176                         'updated_at': literal_column('updated_at')})\n>  1177         session.query(models.SecurityGroupInstanceAssociation).\\\n>  1178                 filter_by(instance_id=instance_id).\\\n>  1179                 update({'deleted': True,\n>  1180                         'deleted_at': utils.utcnow(),\n>  1181                         'updated_at': literal_column('updated_at')})\n>  1182         session.query(models.InstanceMetadata).\\\n>  1183                 filter_by(instance_id=instance_id).\\\n>  1184                 update({'deleted': True,\n>  1185                         'deleted_at': utils.utcnow(),\n>  1186                         'updated_at': literal_column('updated_at')})\n>  1187         session.query(models.BlockDeviceMapping).\\\n>  1188                 filter_by(instance_id=instance_id).\\\n>  1189                 update({'deleted': True,\n>  1190                         'deleted_at': utils.utcnow(),\n>  1191                         'updated_at': literal_column('updated_at')})\n> \n> \n>  But, this update didn't clean or delete any network information of instance.\n>   instance_destroy() update only instances, security_group_instance_association, instance_metadata, block_device_mapping table.\n>  Because this method didn't update fixed_ips and floating_ips, there is error occured when I allocate all fixed or floating ip address to instance.\n> \n>  this is example)\n>  # nova list\n>  +--------------------------------------+--------------+--------+------------------------------------+\n>  |                  ID                  |     Name     | Status |              Networks              |\n>  +--------------------------------------+--------------+--------+------------------------------------+\n>  | 1fcc667d-a8cd-407b-864c-21b021bfbb19 | CentOS_1     | ACTIVE | private=10.0.152.23                |\n>  | a2561d60-5bb4-4429-b946-67df5abb247d | network_test | ACTIVE | private=10.0.152.31                |\n>  | bbfa18ce-a21a-460c-8689-e746e0583939 | backend      | ACTIVE | private=10.0.152.21                |\n>  | cf737e81-aa7a-4ce5-b8bd-bce503d96b06 | wintest      | ACTIVE | private=10.0.152.22, 192.168.0.208 |\n>  +--------------------------------------+--------------+--------+------------------------------------+\n> \n>  mysql>select * from fixed_ips where deleted=0;\n>  mysql> select * from fixed_ips where deleted=0;\n>  +---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n>  | created_at          | updated_at          | deleted_at | deleted | id | address     | network_id | instance_id | allocated | leased | reserved | virtual_interface_id | host    |\n>  +---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n>  | 2011-11-10 01:41:21 | NULL                | NULL       |       0 |  1 | 10.0.152.0  |          1 |        NULL |         0 |      0 |        1 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | NULL                | NULL       |       0 |  2 | 10.0.152.1  |          1 |        NULL |         0 |      0 |        1 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 01:40:58 | NULL       |       0 |  3 | 10.0.152.2  |          1 |           1 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-10 02:22:19 | NULL       |       0 |  4 | 10.0.152.3  |          1 |        NULL |         0 |      0 |        0 |                 NULL | nova152 |\n>  | 2011-11-10 01:41:21 | 2011-11-15 01:37:06 | NULL       |       0 |  5 | 10.0.152.4  |          1 |           2 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 04:32:53 | NULL       |       0 |  6 | 10.0.152.5  |          1 |           3 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 04:32:47 | NULL       |       0 |  7 | 10.0.152.6  |          1 |           4 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 04:32:42 | NULL       |       0 |  8 | 10.0.152.7  |          1 |           5 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 04:32:59 | NULL       |       0 |  9 | 10.0.152.8  |          1 |           6 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:20 | NULL       |       0 | 10 | 10.0.152.9  |          1 |           7 |         1 |      0 |        0 |                    7 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:21 | NULL       |       0 | 11 | 10.0.152.10 |          1 |           8 |         1 |      0 |        0 |                    8 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:22 | NULL       |       0 | 12 | 10.0.152.11 |          1 |           9 |         1 |      0 |        0 |                    9 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:24 | NULL       |       0 | 13 | 10.0.152.12 |          1 |          10 |         1 |      0 |        0 |                   10 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:25 | NULL       |       0 | 14 | 10.0.152.13 |          1 |          11 |         1 |      0 |        0 |                   11 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 05:39:57 | NULL       |       0 | 15 | 10.0.152.14 |          1 |          12 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-16 06:29:44 | NULL       |       0 | 16 | 10.0.152.15 |          1 |          13 |         1 |      0 |        0 |                   13 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-16 07:32:12 | NULL       |       0 | 17 | 10.0.152.16 |          1 |          14 |         1 |      0 |        0 |                   14 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:27 | NULL       |       0 | 18 | 10.0.152.17 |          1 |          15 |         1 |      0 |        0 |                   15 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:28 | NULL       |       0 | 19 | 10.0.152.18 |          1 |          16 |         1 |      0 |        0 |                   16 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-16 08:22:54 | NULL       |       0 | 20 | 10.0.152.19 |          1 |          17 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-16 08:28:41 | NULL       |       0 | 21 | 10.0.152.20 |          1 |          18 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-12-01 05:44:58 | NULL       |       0 | 22 | 10.0.152.21 |          1 |          19 |         1 |      1 |        0 |                   19 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-12-01 05:44:17 | NULL       |       0 | 23 | 10.0.152.22 |          1 |          20 |         1 |      1 |        0 |                   20 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-12-01 05:44:54 | NULL       |       0 | 24 | 10.0.152.23 |          1 |          21 |         1 |      1 |        0 |                   21 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-29 08:51:37 | NULL       |       0 | 25 | 10.0.152.24 |          1 |          22 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-29 08:54:12 | NULL       |       0 | 26 | 10.0.152.25 |          1 |          23 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-29 08:53:49 | NULL       |       0 | 27 | 10.0.152.26 |          1 |          24 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-30 02:00:44 | NULL       |       0 | 28 | 10.0.152.27 |          1 |          25 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-12-01 04:13:22 | NULL       |       0 | 29 | 10.0.152.28 |          1 |          26 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-30 11:14:07 | NULL       |       0 | 30 | 10.0.152.29 |          1 |          27 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-30 02:05:08 | NULL       |       0 | 31 | 10.0.152.30 |          1 |          28 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-30 09:02:26 | NULL       |       0 | 32 | 10.0.152.31 |          1 |          30 |         1 |      0 |        0 |                   30 | NULL    |\n>  +---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n> \n>  every fixed_ips was allocated one time. But now There are only 4\n>  instances, other instances was deleted.\n> \n>  then, I try to boot new instance, nova didn't. \n>  /var/log/nova/nova-compute.log\n>  2011-12-01 14:46:40,776 DEBUG nova.rpc [-] received {u'_context_roles': [], u'_context_request_id': u'16045694-f17a-4c22-bb5b-1207c2f72b24', u'_context_read_deleted': False, u'args': {u'instance_id': 32, u'requested_networks': None, u'admin_password': u'v4PTPrMAgn2Z', u'injected_files': []}, u'_context_auth_token': None, u'_context_strategy': u'noauth', u'_context_is_admin': True, u'_context_project_id': u'sds', u'_context_timestamp': u'2011-12-01T05:46:40.217989', u'_context_user_id': u'nova', u'method': u'run_instance', u'_context_remote_address': u'127.0.0.1'} from (pid=5977) __call__ /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:600\n>  2011-12-01 14:46:40,777 DEBUG nova.rpc [-] unpacked context: {'user_id': u'nova', 'roles': [], 'timestamp': u'2011-12-01T05:46:40.217989', 'auth_token': None, 'msg_id': None, 'remote_address': u'127.0.0.1', 'strategy': u'noauth', 'is_admin': True, 'request_id': u'16045694-f17a-4c22-bb5b-1207c2f72b24', 'project_id': u'sds', 'read_deleted': False} from (pid=5977) _unpack_context /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:646\n>  2011-12-01 14:46:47,914 AUDIT nova.compute.manager [16045694-f17a-4c22-bb5b-1207c2f72b24 nova sds] instance 32: starting...\n>  2011-12-01 14:46:47,988 DEBUG nova.rpc [-] Making asynchronous call on network ... from (pid=5977) multicall /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:721\n>  2011-12-01 14:46:47,988 DEBUG nova.rpc [-] MSG_ID is 9436655168cb45c7aea3ba4017fc58d4 from (pid=5977) multicall /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:724\n>  2011-12-01 14:46:48,128 ERROR nova.compute.manager [-] Instance '32' failed network setup.\n>  (nova.compute.manager): TRACE: Traceback (most recent call last):\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 415, in _logging_error\n>  (nova.compute.manager): TRACE:     yield\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 446, in _run_instance\n>  (nova.compute.manager): TRACE:     network_info = _make_network_info()\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 382, in _make_network_info\n>  (nova.compute.manager): TRACE:     requested_networks=requested_networks)\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/api.py\", line 119, in allocate_for_instance\n>  (nova.compute.manager): TRACE:     'args': args})\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/__init__.py\", line 45, in call\n>  (nova.compute.manager): TRACE:     return get_impl().call(context, topic, msg)\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 738, in call\n>  (nova.compute.manager): TRACE:     rv = list(rv)\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 703, in __iter__\n>  (nova.compute.manager): TRACE:     raise result\n>  (nova.compute.manager): TRACE: RemoteError: Remote error: NoMoreFixedIps Zero fixed ips available.\n>  (nova.compute.manager): TRACE: [u'Traceback (most recent call last):\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\\n    rval = node_func(context=ctxt, **node_args)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 223, in allocate_for_instance\\n    super(FloatingIP, self).allocate_for_instance(context, **kwargs)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 631, in allocate_for_instance\\n    requested_networks=requested_networks)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 172, in _allocate_fixed_ips\\n    vpn=vpn, address=address)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 802, in allocate_fixed_ip\\n    instance_id)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 366, in fixed_ip_associate_pool\\n    instance_id, host)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 102, in wrapper\\n    return f(*args, **kwargs)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 757, in fixed_ip_associate_pool\\n    raise exception.NoMoreFixedIps()\\n', u'NoMoreFixedIps: Zero fixed ips available.\\n'].\n> \n> \n>  I think when terminate instance, nova should clean network ip information(fixed_ips, floating_ips). \n>  OR, when boot new instance, nova should select ip to instance properly.\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/898485/+subscriptions\n\n", 
            "date_created": "2011-12-09 06:05:05+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Vish, I understan your comment, But Problem isn't fix yet.\nIrrespective of force_dhcp_release, when terminate instance, nova don't touch instance value of fixed_ips table.\n\n 815     def deallocate_fixed_ip(self, context, address, **kwargs):\n 816         \"\"\"Returns a fixed ip to the pool.\"\"\"\n 817         self.db.fixed_ip_update(context, address,\n 818                                 {'allocated': False,\n 819                                  'virtual_interface_id': None})\n\n(only update 'allocated', 'virtual_interface_id')\n\nBut, When create instance, instance get a fixed ip from the pool\n 787     def allocate_fixed_ip(self, context, instance_id, network, **kwargs):\n 788         \"\"\"Gets a fixed ip from the pool.\"\"\"\n 789         # TODO(vish): when this is called by compute, we can associate compute\n 790         #             with a network, or a cluster of computes with a network\n 791         #             and use that network here with a method like\n 792         #             network_get_by_compute_host\n 793         address = None\n 794         if network['cidr']:\n 795             address = kwargs.get('address', None)\n 796             if address:\n 797                 address = self.db.fixed_ip_associate(context,\n 798                                                      address, instance_id,\n 799                                                      network['id'])\n 800             else:\n 801                 address = self.db.fixed_ip_associate_pool(context.elevated(),\n 802                                                           network['id'],\n 803                                                           instance_id)\n\ndb.fixed_ip_associate_pool() is\n 741 def fixed_ip_associate_pool(context, network_id, instance_id=None, host=None):\n 742     session = get_session()\n 743     with session.begin():\n 744         network_or_none = or_(models.FixedIp.network_id == network_id,\n 745                               models.FixedIp.network_id == None)\n 746         fixed_ip_ref = session.query(models.FixedIp).\\\n 747                                filter(network_or_none).\\\n 748                                filter_by(reserved=False).\\\n 749                                filter_by(deleted=False).\\\n 750                                filter_by(instance=None).\\\n 751                                filter_by(host=None).\\\n 752                                with_lockmode('update').\\\n 753                                first()\n\nmethod choice fixed_ip what instance==None.\nwhen terminate instance, nova don't update instance value to NULL, So termiated ip address couldn't reuse. ", 
            "date_created": "2011-12-10 06:15:05.322331+00:00", 
            "author": "https://api.launchpad.net/1.0/~hyangii"
        }, 
        {
            "content": "when you use --force_dhcp_release it will result in a callback from dnsmasq that will call release_fixed_ip.  Release fixed_ip will call self.db.fixed_ip_disassociate(context, address)\n\nNote that this is necessary because we can't reuse an ip until dnsmasq is done with it.\n\nVish\n\nOn Dec 9, 2011, at 10:15 PM, jaesanglee wrote:\n\n> Vish, I understan your comment, But Problem isn't fix yet.\n> Irrespective of force_dhcp_release, when terminate instance, nova don't touch instance value of fixed_ips table.\n> \n> 815     def deallocate_fixed_ip(self, context, address, **kwargs):\n> 816         \"\"\"Returns a fixed ip to the pool.\"\"\"\n> 817         self.db.fixed_ip_update(context, address,\n> 818                                 {'allocated': False,\n> 819                                  'virtual_interface_id': None})\n> \n> (only update 'allocated', 'virtual_interface_id')\n> \n> But, When create instance, instance get a fixed ip from the pool\n> 787     def allocate_fixed_ip(self, context, instance_id, network, **kwargs):\n> 788         \"\"\"Gets a fixed ip from the pool.\"\"\"\n> 789         # TODO(vish): when this is called by compute, we can associate compute\n> 790         #             with a network, or a cluster of computes with a network\n> 791         #             and use that network here with a method like\n> 792         #             network_get_by_compute_host\n> 793         address = None\n> 794         if network['cidr']:\n> 795             address = kwargs.get('address', None)\n> 796             if address:\n> 797                 address = self.db.fixed_ip_associate(context,\n> 798                                                      address, instance_id,\n> 799                                                      network['id'])\n> 800             else:\n> 801                 address = self.db.fixed_ip_associate_pool(context.elevated(),\n> 802                                                           network['id'],\n> 803                                                           instance_id)\n> \n> db.fixed_ip_associate_pool() is\n> 741 def fixed_ip_associate_pool(context, network_id, instance_id=None, host=None):\n> 742     session = get_session()\n> 743     with session.begin():\n> 744         network_or_none = or_(models.FixedIp.network_id == network_id,\n> 745                               models.FixedIp.network_id == None)\n> 746         fixed_ip_ref = session.query(models.FixedIp).\\\n> 747                                filter(network_or_none).\\\n> 748                                filter_by(reserved=False).\\\n> 749                                filter_by(deleted=False).\\\n> 750                                filter_by(instance=None).\\\n> 751                                filter_by(host=None).\\\n> 752                                with_lockmode('update').\\\n> 753                                first()\n> \n> method choice fixed_ip what instance==None.\n> when terminate instance, nova don't update instance value to NULL, So termiated ip address couldn't reuse.\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/898485\n> \n> Title:\n>  terminate instance didn't clean ip information\n> \n> Status in OpenStack Compute (Nova):\n>  Triaged\n> \n> Bug description:\n>  It's a command to terminate instance.\n>  # nova delete <instance-id>\n>  then, compute-api call self.db.instance_destroy(context, instance_id)\n> \n>  nova/compute/manager.py\n>   555     def _delete_instance(self, context, instance_id):\n>   556         \"\"\"Delete an instance on this host.\"\"\"\n>   557         self._shutdown_instance(context, instance_id, 'Terminating', True)\n>   558         self._cleanup_volumes(context, instance_id)\n>   559         instance = self.db.instance_get(context.elevated(), instance_id)\n>   560         self._instance_update(context,\n>   561                               instance_id,\n>   562                               vm_state=vm_states.DELETED,\n>   563                               task_state=None,\n>   564                               terminated_at=utils.utcnow())\n>   565\n>   566         self.db.instance_destroy(context, instance_id)\n>   567\n>   568         usage_info = utils.usage_from_instance(instance)\n>   569         notifier.notify('compute.%s' % self.host,\n>   570                         'compute.instance.delete',\n>   571                         notifier.INFO, usage_info)\n> \n>  finally, instance_destroy() is called at nova/db/sqlalchemy/api.py \n>  1168 @require_context\n>  1169 def instance_destroy(context, instance_id):\n>  1170     session = get_session()\n>  1171     with session.begin():\n>  1172         session.query(models.Instance).\\\n>  1173                 filter_by(id=instance_id).\\\n>  1174                 update({'deleted': True,\n>  1175                         'deleted_at': utils.utcnow(),\n>  1176                         'updated_at': literal_column('updated_at')})\n>  1177         session.query(models.SecurityGroupInstanceAssociation).\\\n>  1178                 filter_by(instance_id=instance_id).\\\n>  1179                 update({'deleted': True,\n>  1180                         'deleted_at': utils.utcnow(),\n>  1181                         'updated_at': literal_column('updated_at')})\n>  1182         session.query(models.InstanceMetadata).\\\n>  1183                 filter_by(instance_id=instance_id).\\\n>  1184                 update({'deleted': True,\n>  1185                         'deleted_at': utils.utcnow(),\n>  1186                         'updated_at': literal_column('updated_at')})\n>  1187         session.query(models.BlockDeviceMapping).\\\n>  1188                 filter_by(instance_id=instance_id).\\\n>  1189                 update({'deleted': True,\n>  1190                         'deleted_at': utils.utcnow(),\n>  1191                         'updated_at': literal_column('updated_at')})\n> \n> \n>  But, this update didn't clean or delete any network information of instance.\n>   instance_destroy() update only instances, security_group_instance_association, instance_metadata, block_device_mapping table.\n>  Because this method didn't update fixed_ips and floating_ips, there is error occured when I allocate all fixed or floating ip address to instance.\n> \n>  this is example)\n>  # nova list\n>  +--------------------------------------+--------------+--------+------------------------------------+\n>  |                  ID                  |     Name     | Status |              Networks              |\n>  +--------------------------------------+--------------+--------+------------------------------------+\n>  | 1fcc667d-a8cd-407b-864c-21b021bfbb19 | CentOS_1     | ACTIVE | private=10.0.152.23                |\n>  | a2561d60-5bb4-4429-b946-67df5abb247d | network_test | ACTIVE | private=10.0.152.31                |\n>  | bbfa18ce-a21a-460c-8689-e746e0583939 | backend      | ACTIVE | private=10.0.152.21                |\n>  | cf737e81-aa7a-4ce5-b8bd-bce503d96b06 | wintest      | ACTIVE | private=10.0.152.22, 192.168.0.208 |\n>  +--------------------------------------+--------------+--------+------------------------------------+\n> \n>  mysql>select * from fixed_ips where deleted=0;\n>  mysql> select * from fixed_ips where deleted=0;\n>  +---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n>  | created_at          | updated_at          | deleted_at | deleted | id | address     | network_id | instance_id | allocated | leased | reserved | virtual_interface_id | host    |\n>  +---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n>  | 2011-11-10 01:41:21 | NULL                | NULL       |       0 |  1 | 10.0.152.0  |          1 |        NULL |         0 |      0 |        1 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | NULL                | NULL       |       0 |  2 | 10.0.152.1  |          1 |        NULL |         0 |      0 |        1 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 01:40:58 | NULL       |       0 |  3 | 10.0.152.2  |          1 |           1 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-10 02:22:19 | NULL       |       0 |  4 | 10.0.152.3  |          1 |        NULL |         0 |      0 |        0 |                 NULL | nova152 |\n>  | 2011-11-10 01:41:21 | 2011-11-15 01:37:06 | NULL       |       0 |  5 | 10.0.152.4  |          1 |           2 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 04:32:53 | NULL       |       0 |  6 | 10.0.152.5  |          1 |           3 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 04:32:47 | NULL       |       0 |  7 | 10.0.152.6  |          1 |           4 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 04:32:42 | NULL       |       0 |  8 | 10.0.152.7  |          1 |           5 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 04:32:59 | NULL       |       0 |  9 | 10.0.152.8  |          1 |           6 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:20 | NULL       |       0 | 10 | 10.0.152.9  |          1 |           7 |         1 |      0 |        0 |                    7 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:21 | NULL       |       0 | 11 | 10.0.152.10 |          1 |           8 |         1 |      0 |        0 |                    8 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:22 | NULL       |       0 | 12 | 10.0.152.11 |          1 |           9 |         1 |      0 |        0 |                    9 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:24 | NULL       |       0 | 13 | 10.0.152.12 |          1 |          10 |         1 |      0 |        0 |                   10 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:25 | NULL       |       0 | 14 | 10.0.152.13 |          1 |          11 |         1 |      0 |        0 |                   11 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-15 05:39:57 | NULL       |       0 | 15 | 10.0.152.14 |          1 |          12 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-16 06:29:44 | NULL       |       0 | 16 | 10.0.152.15 |          1 |          13 |         1 |      0 |        0 |                   13 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-16 07:32:12 | NULL       |       0 | 17 | 10.0.152.16 |          1 |          14 |         1 |      0 |        0 |                   14 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:27 | NULL       |       0 | 18 | 10.0.152.17 |          1 |          15 |         1 |      0 |        0 |                   15 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-17 23:47:28 | NULL       |       0 | 19 | 10.0.152.18 |          1 |          16 |         1 |      0 |        0 |                   16 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-16 08:22:54 | NULL       |       0 | 20 | 10.0.152.19 |          1 |          17 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-16 08:28:41 | NULL       |       0 | 21 | 10.0.152.20 |          1 |          18 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-12-01 05:44:58 | NULL       |       0 | 22 | 10.0.152.21 |          1 |          19 |         1 |      1 |        0 |                   19 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-12-01 05:44:17 | NULL       |       0 | 23 | 10.0.152.22 |          1 |          20 |         1 |      1 |        0 |                   20 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-12-01 05:44:54 | NULL       |       0 | 24 | 10.0.152.23 |          1 |          21 |         1 |      1 |        0 |                   21 | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-29 08:51:37 | NULL       |       0 | 25 | 10.0.152.24 |          1 |          22 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-29 08:54:12 | NULL       |       0 | 26 | 10.0.152.25 |          1 |          23 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-29 08:53:49 | NULL       |       0 | 27 | 10.0.152.26 |          1 |          24 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-30 02:00:44 | NULL       |       0 | 28 | 10.0.152.27 |          1 |          25 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-12-01 04:13:22 | NULL       |       0 | 29 | 10.0.152.28 |          1 |          26 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-30 11:14:07 | NULL       |       0 | 30 | 10.0.152.29 |          1 |          27 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-30 02:05:08 | NULL       |       0 | 31 | 10.0.152.30 |          1 |          28 |         0 |      0 |        0 |                 NULL | NULL    |\n>  | 2011-11-10 01:41:21 | 2011-11-30 09:02:26 | NULL       |       0 | 32 | 10.0.152.31 |          1 |          30 |         1 |      0 |        0 |                   30 | NULL    |\n>  +---------------------+---------------------+------------+---------+----+-------------+------------+-------------+-----------+--------+----------+----------------------+---------+\n> \n>  every fixed_ips was allocated one time. But now There are only 4\n>  instances, other instances was deleted.\n> \n>  then, I try to boot new instance, nova didn't. \n>  /var/log/nova/nova-compute.log\n>  2011-12-01 14:46:40,776 DEBUG nova.rpc [-] received {u'_context_roles': [], u'_context_request_id': u'16045694-f17a-4c22-bb5b-1207c2f72b24', u'_context_read_deleted': False, u'args': {u'instance_id': 32, u'requested_networks': None, u'admin_password': u'v4PTPrMAgn2Z', u'injected_files': []}, u'_context_auth_token': None, u'_context_strategy': u'noauth', u'_context_is_admin': True, u'_context_project_id': u'sds', u'_context_timestamp': u'2011-12-01T05:46:40.217989', u'_context_user_id': u'nova', u'method': u'run_instance', u'_context_remote_address': u'127.0.0.1'} from (pid=5977) __call__ /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:600\n>  2011-12-01 14:46:40,777 DEBUG nova.rpc [-] unpacked context: {'user_id': u'nova', 'roles': [], 'timestamp': u'2011-12-01T05:46:40.217989', 'auth_token': None, 'msg_id': None, 'remote_address': u'127.0.0.1', 'strategy': u'noauth', 'is_admin': True, 'request_id': u'16045694-f17a-4c22-bb5b-1207c2f72b24', 'project_id': u'sds', 'read_deleted': False} from (pid=5977) _unpack_context /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:646\n>  2011-12-01 14:46:47,914 AUDIT nova.compute.manager [16045694-f17a-4c22-bb5b-1207c2f72b24 nova sds] instance 32: starting...\n>  2011-12-01 14:46:47,988 DEBUG nova.rpc [-] Making asynchronous call on network ... from (pid=5977) multicall /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:721\n>  2011-12-01 14:46:47,988 DEBUG nova.rpc [-] MSG_ID is 9436655168cb45c7aea3ba4017fc58d4 from (pid=5977) multicall /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:724\n>  2011-12-01 14:46:48,128 ERROR nova.compute.manager [-] Instance '32' failed network setup.\n>  (nova.compute.manager): TRACE: Traceback (most recent call last):\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 415, in _logging_error\n>  (nova.compute.manager): TRACE:     yield\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 446, in _run_instance\n>  (nova.compute.manager): TRACE:     network_info = _make_network_info()\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 382, in _make_network_info\n>  (nova.compute.manager): TRACE:     requested_networks=requested_networks)\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/api.py\", line 119, in allocate_for_instance\n>  (nova.compute.manager): TRACE:     'args': args})\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/__init__.py\", line 45, in call\n>  (nova.compute.manager): TRACE:     return get_impl().call(context, topic, msg)\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 738, in call\n>  (nova.compute.manager): TRACE:     rv = list(rv)\n>  (nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 703, in __iter__\n>  (nova.compute.manager): TRACE:     raise result\n>  (nova.compute.manager): TRACE: RemoteError: Remote error: NoMoreFixedIps Zero fixed ips available.\n>  (nova.compute.manager): TRACE: [u'Traceback (most recent call last):\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\\n    rval = node_func(context=ctxt, **node_args)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 223, in allocate_for_instance\\n    super(FloatingIP, self).allocate_for_instance(context, **kwargs)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 631, in allocate_for_instance\\n    requested_networks=requested_networks)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 172, in _allocate_fixed_ips\\n    vpn=vpn, address=address)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 802, in allocate_fixed_ip\\n    instance_id)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 366, in fixed_ip_associate_pool\\n    instance_id, host)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 102, in wrapper\\n    return f(*args, **kwargs)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 757, in fixed_ip_associate_pool\\n    raise exception.NoMoreFixedIps()\\n', u'NoMoreFixedIps: Zero fixed ips available.\\n'].\n> \n> \n>  I think when terminate instance, nova should clean network ip information(fixed_ips, floating_ips). \n>  OR, when boot new instance, nova should select ip to instance properly.\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/898485/+subscriptions\n\n", 
            "date_created": "2011-12-10 20:03:00+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2437\nCommitted: http://github.com/openstack/nova/commit/fb6850a5b9d7d61a4bb96af8d1cd516fd139c1f8\nSubmitter: Jenkins\nBranch:    master\n\ncommit fb6850a5b9d7d61a4bb96af8d1cd516fd139c1f8\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Fri Dec 16 16:02:54 2011 -0800\n\n    Makes disassociate by timeout work with multi-host\n    \n     * fixes bug 898485\n     * updates timeout query to key off of instance host as well\n     * removes unused status=1 in related query\n    \n    Change-Id: Ia11b3d4d3db930eb31ccc2f74635971ba6edc32c\n", 
            "date_created": "2011-12-21 16:31:42.038202+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Is this applicable to Diablo? Anyone care to backport it, if so?", 
            "date_created": "2012-01-04 15:38:42.055651+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "Looks like we'd also need the fix for bug #907898 to be backported too", 
            "date_created": "2012-01-04 15:45:04.669395+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "Please keep FixCommitted until this is in milestone-proposed.", 
            "date_created": "2012-01-17 16:30:25.432856+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }
    ]
}