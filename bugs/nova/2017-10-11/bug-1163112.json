{
    "status": "Invalid", 
    "last_updated": "2014-09-04 18:35:27.902976+00:00", 
    "description": "Hi all:\n\nI use github to install nova and quantum, but when I launch an instance, nova-compute fails:\n\n2013-04-02 11:00:15    DEBUG [nova.openstack.common.lockutils] Released file lock \"iptables\" at /var/lock/nova/nova-iptables for method \"_apply\"...\n2013-04-02 11:00:17    ERROR [nova.compute.manager] Instance failed to spawn\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2013.2.a89.ge9912c6-py2.7.egg/nova/compute/manager.py\", line 1069, in _spawn\n    block_device_info)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2013.2.a89.ge9912c6-py2.7.egg/nova/virt/libvirt/driver.py\", line 1520, in spawn\n    block_device_info)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2013.2.a89.ge9912c6-py2.7.egg/nova/virt/libvirt/driver.py\", line 2435, in _create_domain_and_network\n    domain = self._create_domain(xml, instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2013.2.a89.ge9912c6-py2.7.egg/nova/virt/libvirt/driver.py\", line 2396, in _create_domain\n    domain.createWithFlags(launch_flags)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 187, in doit \n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 147, in proxy_call\n    rv = execute(f,*args,**kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 76, in tworker\n    rv = meth(*args,**kwargs)\n  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 581, in createWithFlags\n    if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\nlibvirtError: Unable to add bridge br-int port tap89ed2dc0-2e: Operation not supported\n2013-04-02 11:00:17    DEBUG [nova.openstack.common.lockutils] Got semaphore \"compute_resources\" for method \"abort\"...\n2013-04-02 11:00:17    DEBUG [nova.compute.claims] Aborting claim: [Claim: 512 MB memory, 0 GB disk, 1 VCPUS]\n\nIs it because user nova call libvirt to create a port so it has not enough permission?\n\nnote1:I set up sudoer:\nroot@node1:~# cat /etc/sudoers.d/nova_sudoers \nDefaults:nova !requiretty\n\nnova ALL = (root) NOPASSWD: /usr/local/bin/nova-rootwrap  \n\n\nnote2:I login as root, execute \" ovs-vsctl add-port\", and succeed.\n\nroot@node1:~# ovs-vsctl add-port br-int  tap89ed2dc0-2e\nroot@node1:~# ovs-vsctl show\nf3f4cdc0-1391-45fd-a535-1947d5aea488\n    Bridge \"br0\"\n        Port \"eth0\"\n            Interface \"eth0\"\n        Port \"br0\"\n            Interface \"br0\"\n                type: internal\n    Bridge br-int\n        Port br-int\n            Interface br-int\n                type: internal\n        Port patch-tun\n            Interface patch-tun\n                type: patch\n                options: {peer=patch-int}\n        Port \"tap89ed2dc0-2e\"\n            Interface \"tap89ed2dc0-2e\"\n    Bridge br-tun\n        Port patch-int\n            Interface patch-int\n                type: patch\n                options: {peer=patch-tun}\n        Port \"gre-1\"\n            Interface \"gre-1\"\n                type: gre\n                options: {in_key=flow, out_key=flow, remote_ip=\"192.168.19.1\"}\n        Port br-tun\n            Interface br-tun\n                type: internal\n    ovs_version: \"1.4.0+build0\"\n\n\nI add the following lines to qemu.conf\ncgroup_device_acl = [\n    \"/dev/null\", \"/dev/full\", \"/dev/zero\",\n    \"/dev/random\", \"/dev/urandom\",\n    \"/dev/ptmx\", \"/dev/kvm\", \"/dev/kqemu\",\n    \"/dev/rtc\", \"/dev/hpet\",\"/dev/net/tun\",\n]\n\nroot@node1:~# service qemu-kvm restart\nqemu-kvm stop/waiting\nqemu-kvm start/running\n\nroot@node1:~# service libvirt-bin restart\nlibvirt-bin stop/waiting\nlibvirt-bin start/running, process 30917", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1163112", 
    "owner": "None", 
    "id": 1163112, 
    "index": 3561, 
    "created": "2013-04-02 04:58:59.511634+00:00", 
    "title": "nova calls libvirt but failed:Operation not supported", 
    "comments": [
        {
            "content": "Hi all:\n\nI use github to install nova and quantum, but when I launch an instance, nova-compute fails:\n\n2013-04-02 11:00:15    DEBUG [nova.openstack.common.lockutils] Released file lock \"iptables\" at /var/lock/nova/nova-iptables for method \"_apply\"...\n2013-04-02 11:00:17    ERROR [nova.compute.manager] Instance failed to spawn\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2013.2.a89.ge9912c6-py2.7.egg/nova/compute/manager.py\", line 1069, in _spawn\n    block_device_info)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2013.2.a89.ge9912c6-py2.7.egg/nova/virt/libvirt/driver.py\", line 1520, in spawn\n    block_device_info)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2013.2.a89.ge9912c6-py2.7.egg/nova/virt/libvirt/driver.py\", line 2435, in _create_domain_and_network\n    domain = self._create_domain(xml, instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2013.2.a89.ge9912c6-py2.7.egg/nova/virt/libvirt/driver.py\", line 2396, in _create_domain\n    domain.createWithFlags(launch_flags)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 187, in doit \n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 147, in proxy_call\n    rv = execute(f,*args,**kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 76, in tworker\n    rv = meth(*args,**kwargs)\n  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 581, in createWithFlags\n    if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\nlibvirtError: Unable to add bridge br-int port tap89ed2dc0-2e: Operation not supported\n2013-04-02 11:00:17    DEBUG [nova.openstack.common.lockutils] Got semaphore \"compute_resources\" for method \"abort\"...\n2013-04-02 11:00:17    DEBUG [nova.compute.claims] Aborting claim: [Claim: 512 MB memory, 0 GB disk, 1 VCPUS]\n\nIs it because user nova call libvirt to create a port so it has not enough permission?\n\nnote1:I set up sudoer:\nroot@node1:~# cat /etc/sudoers.d/nova_sudoers \nDefaults:nova !requiretty\n\nnova ALL = (root) NOPASSWD: /usr/local/bin/nova-rootwrap  \n\n\nnote2:I login as root, execute \" ovs-vsctl add-port\", and succeed.\n\nroot@node1:~# ovs-vsctl add-port br-int  tap89ed2dc0-2e\nroot@node1:~# ovs-vsctl show\nf3f4cdc0-1391-45fd-a535-1947d5aea488\n    Bridge \"br0\"\n        Port \"eth0\"\n            Interface \"eth0\"\n        Port \"br0\"\n            Interface \"br0\"\n                type: internal\n    Bridge br-int\n        Port br-int\n            Interface br-int\n                type: internal\n        Port patch-tun\n            Interface patch-tun\n                type: patch\n                options: {peer=patch-int}\n        Port \"tap89ed2dc0-2e\"\n            Interface \"tap89ed2dc0-2e\"\n    Bridge br-tun\n        Port patch-int\n            Interface patch-int\n                type: patch\n                options: {peer=patch-tun}\n        Port \"gre-1\"\n            Interface \"gre-1\"\n                type: gre\n                options: {in_key=flow, out_key=flow, remote_ip=\"192.168.19.1\"}\n        Port br-tun\n            Interface br-tun\n                type: internal\n    ovs_version: \"1.4.0+build0\"\n\n\nI add the following lines to qemu.conf\ncgroup_device_acl = [\n    \"/dev/null\", \"/dev/full\", \"/dev/zero\",\n    \"/dev/random\", \"/dev/urandom\",\n    \"/dev/ptmx\", \"/dev/kvm\", \"/dev/kqemu\",\n    \"/dev/rtc\", \"/dev/hpet\",\"/dev/net/tun\",\n]\n\nroot@node1:~# service qemu-kvm restart\nqemu-kvm stop/waiting\nqemu-kvm start/running\n\nroot@node1:~# service libvirt-bin restart\nlibvirt-bin stop/waiting\nlibvirt-bin start/running, process 30917", 
            "date_created": "2013-04-02 04:58:59.511634+00:00", 
            "author": "https://api.launchpad.net/1.0/~marvelliu"
        }, 
        {
            "content": "Which version of libvirt and which distro?", 
            "date_created": "2013-04-11 17:34:08.091806+00:00", 
            "author": "https://api.launchpad.net/1.0/~zulcss"
        }, 
        {
            "content": "We cannot solve the issue you reported without more information. Could you please provide the requested information ?", 
            "date_created": "2013-05-08 10:38:21.625031+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Ping?", 
            "date_created": "2013-05-22 05:20:44.705052+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "Have same issue:\nroot@havana:~# dpkg -l | grep libvirt \nii  libvirt-bin                       1.1.1-0ubuntu4                              amd64        programs for the libvirt library\nii  libvirt0                          1.1.1-0ubuntu4                              amd64        library for interfacing with different virtualization systems\nii  python-libvirt                    1.1.1-0ubuntu4                              amd64        libvirt Python bindings\n\nroot@devstack:~# cat /etc/lsb-release \nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=13.10\nDISTRIB_CODENAME=saucy\nDISTRIB_DESCRIPTION=\"Ubuntu Saucy Salamander (development branch)\"\n\nlatest package versions", 
            "date_created": "2013-08-30 09:02:05.303860+00:00", 
            "author": "https://api.launchpad.net/1.0/~pavel-kirpichyov"
        }, 
        {
            "content": "openvswitch is used:\nroot@devstack:~# dpkg -l | grep openvswitch\nii  neutron-plugin-openvswitch        1:2013.2~b2-0ubuntu3                        all          Neutron is a virtual network service for Openstack - Open vSwitch plugin\nii  neutron-plugin-openvswitch-agent  1:2013.2~b2-0ubuntu3                        all          Neutron is a virtual network service for Openstack - Open vSwitch plugin agent\nii  openvswitch-common                1.10.1+git20130823-0ubuntu3                 amd64        Open vSwitch common components\nii  openvswitch-datapath-dkms         1.10.1+git20130823-0ubuntu3                 all          Open vSwitch datapath module source - DKMS version\nii  openvswitch-switch                1.10.1+git20130823-0ubuntu3                 amd64        Open vSwitch switch implementations", 
            "date_created": "2013-08-30 09:13:01.013053+00:00", 
            "author": "https://api.launchpad.net/1.0/~pavel-kirpichyov"
        }, 
        {
            "content": "root@devstack:~# tail -f /var/log/libvirt/libvirtd.log\n2013-08-30 10:08:25.126+0000: 1922: warning : virAuditSend:135 : Failed to send audit message virt=kvm vm=\"instance-0000000e\" uuid=9fb2429f-a40a-490d-81e3-a93554ab9f17 vm-ctx=libvirt-9fb2429f-a40a-490d-81e3-a93554ab9f17 img-ctx=libvirt-9fb2429f-a40a-490d-81e3-a93554ab9f17 model=apparmor: Operation not permitted\n2013-08-30 10:08:25.126+0000: 1922: warning : virAuditSend:135 : Failed to send audit message virt=kvm vm=\"instance-0000000e\" uuid=9fb2429f-a40a-490d-81e3-a93554ab9f17 vm-ctx=0:0 img-ctx=0:0 model=dac: Operation not permitted\n2013-08-30 10:08:25.156+0000: 1922: error : virNetDevBridgeAddPort:370 : Unable to add bridge br-int port tapc6991af4-4a: Operation not supported\n2013-08-30 10:08:25.182+0000: 1922: warning : virAuditSend:135 : Failed to send audit message virt=kvm resrc=net reason=open vm=\"instance-0000000e\" uuid=9fb2429f-a40a-490d-81e3-a93554ab9f17 net=fa:16:3e:51:1b:cd path=\"/dev/net/tun\" rdev=0A:C8: Operation not permitted\n2013-08-30 10:08:25.182+0000: 1922: warning : virAuditSend:135 : Failed to send audit message virt=kvm resrc=disk reason=start vm=\"instance-0000000e\" uuid=9fb2429f-a40a-490d-81e3-a93554ab9f17 old-disk=\"?\" new-disk=\"/var/lib/nova/instances/9fb2429f-a40a-490d-81e3-a93554ab9f17/disk\": Operation not permitted\n2013-08-30 10:08:25.182+0000: 1922: warning : virAuditSend:135 : Failed to send audit message virt=kvm resrc=net reason=start vm=\"instance-0000000e\" uuid=9fb2429f-a40a-490d-81e3-a93554ab9f17 old-net=? new-net=fa:16:3e:51:1b:cd: Operation not permitted\n2013-08-30 10:08:25.182+0000: 1922: warning : virAuditSend:135 : Failed to send audit message virt=kvm resrc=mem reason=start vm=\"instance-0000000e\" uuid=9fb2429f-a40a-490d-81e3-a93554ab9f17 old-mem=0 new-mem=524288: Operation not permitted\n2013-08-30 10:08:25.182+0000: 1922: warning : virAuditSend:135 : Failed to send audit message virt=kvm resrc=vcpu reason=start vm=\"instance-0000000e\" uuid=9fb2429f-a40a-490d-81e3-a93554ab9f17 old-vcpu=0 new-vcpu=1: Operation not permitted\n2013-08-30 10:08:25.182+0000: 1922: warning : virAuditSend:135 : Failed to send audit message virt=kvm op=start reason=booted vm=\"instance-0000000e\" uuid=9fb2429f-a40a-490d-81e3-a93554ab9f17 vm-pid=-1: Operation not permitted\n2013-08-30 10:10:19.779+0000: 1918: error : virNetSocketReadWire:1377 : End of file while reading data: Input/output error\n\n\nDisabling apparmor solves almost all problems, but:\n2013-08-30 10:11:02.080+0000: 1883: error : virNetDevBridgeAddPort:370 : Unable to add bridge br-int port tap388f8b30-8a: Operation not supported\nis still exists", 
            "date_created": "2013-08-30 10:12:47.547209+00:00", 
            "author": "https://api.launchpad.net/1.0/~pavel-kirpichyov"
        }, 
        {
            "content": "Problem is solved, I had forgot to change libvirt_vif_driver in /etc/nova/nova-compute.conf to:\n\nlibvirt_vif_driver=nova.virt.libvirt.vif.LibvirtHybridOVSBridgeDriver", 
            "date_created": "2013-08-30 11:23:16.056213+00:00", 
            "author": "https://api.launchpad.net/1.0/~pavel-kirpichyov"
        }, 
        {
            "content": "I'm seeing the same errors here at my Havana Compute Node (libvirt.log).\n\nJust a curiosity, I'm seeing the following message after starting an Instance:\n\n/var/log/nova/nova-compute.log:2013-10-21 03:52:45.311 2916 WARNING nova.virt.libvirt.vif [req-af8cb382-d184-451b-9d25-c3e9b8b1feb4 7b583bd22de54c6e836073e1261440b2 0023e46f902142d18cb35286ddf1b816] Deprecated: The LibvirtHybridOVSBridgeDriver VIF driver is now deprecated and will be removed in the next release. Please use the LibvirtGenericVIFDriver VIF driver, together with a network plugin that reports the 'vif_type' attribute\n\nI tried GenericVIFDriver but, those messages still persist on my libvirt.log.\n\nI disabled AppArmor but, same result...\n\nMy Libvirt log after rebooting a Compute Node:\n\nhttp://paste.openstack.org/show/48929/\n\n\nI'm using Ubuntu 12.04.3 + Havana Cloud Archive, \"Per-Tenant Routers with Private Networks\" topology.\n", 
            "date_created": "2013-10-22 02:45:31.235354+00:00", 
            "author": "https://api.launchpad.net/1.0/~martinx"
        }, 
        {
            "content": "configuration error", 
            "date_created": "2014-09-04 18:35:26.529657+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}