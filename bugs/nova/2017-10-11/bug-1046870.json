{
    "status": "Fix Released", 
    "last_updated": "2013-09-23 22:49:21.842126+00:00", 
    "description": "Recently all tempest runs have been failing with some selection of errors in test_servers_negative.py and test_images.py. The n-cpu log is loaded with errors and stacktraces. Here is a sample of the most recent case but there is some flakiness and not all builds show exactly the same set of failures: http://logs.openstack.org/11936/13/check/gate-tempest-devstack-vm/10571/\n\nHere is some output from my local run:\n\n======================================================================\nERROR: Reboot a deleted server\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/opt/stack/tempest/tempest/tests/compute/test_servers_negative.py\", line 127, in test_reboot_deleted_server\n    self.client.wait_for_server_termination(self.server_id)\n  File \"/opt/stack/tempest/tempest/services/nova/json/servers_client.py\", line 167, in wait_for_server_termination\n    raise exceptions.BuildErrorException\nBuildErrorException: Server %(server_id)s failed to build and is in ERROR status\n\n======================================================================\nERROR: Rebuild a deleted server\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/opt/stack/tempest/tempest/tests/compute/test_servers_negative.py\", line 144, in test_rebuild_deleted_server\n    self.client.wait_for_server_termination(self.server_id)\n  File \"/opt/stack/tempest/tempest/services/nova/json/servers_client.py\", line 167, in wait_for_server_termination\n    raise exceptions.BuildErrorException\nBuildErrorException: Server %(server_id)s failed to build and is in ERROR status\n\n======================================================================\nERROR: Return error when creating an image of a server that is building\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/opt/stack/tempest/tempest/tests/compute/test_images.py\", line 380, in tearDown\n    ImagesTestBase.tearDown(self)\n  File \"/opt/stack/tempest/tempest/tests/compute/test_images.py\", line 37, in tearDown\n    self.servers_client.wait_for_server_termination(server['id'])\n  File \"/opt/stack/tempest/tempest/services/nova/json/servers_client.py\", line 167, in wait_for_server_termination\n    raise exceptions.BuildErrorException\nBuildErrorException: Server %(server_id)s failed to build and is in ERROR status\nDetails: Server %(server_id)s failed to build and is in ERROR status\n-------------------- >> begin captured logging << --------------------\ntempest.common.rest_client: ERROR: Request URL: http://172.18.0.156:8774/v2/8e694b8a45df44c18fb54aabdeb48c71/servers/01defe3f-1aed-419c-8b02-43ece401a73b/action\ntempest.common.rest_client: ERROR: Request Body: {\"createImage\": {\"name\": \"test-snap-56810686560\"}}\ntempest.common.rest_client: ERROR: Response Headers: {'date': 'Thu, 06 Sep 2012 14:31:56 GMT', 'status': '409', 'content-length': '111', 'content-type': 'application/json; charset=UTF-8', 'x-compute-request-id': 'req-ba860a75-c914-4611-87e0-105c53ddf2a6'}\ntempest.common.rest_client: ERROR: Response Body: {u'conflictingRequest': {u'message': u\"Cannot 'createImage' while instance is in vm_state building\", u'code': 409}}\n--------------------- >> end captured logging << ---------------------\n\n======================================================================\nERROR: Return error when creating an image of a server that is building\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/opt/stack/tempest/tempest/tests/compute/test_images.py\", line 406, in tearDown\n    ImagesTestBase.tearDown(self)\n  File \"/opt/stack/tempest/tempest/tests/compute/test_images.py\", line 37, in tearDown\n    self.servers_client.wait_for_server_termination(server['id'])\n  File \"/opt/stack/tempest/tempest/services/nova/json/servers_client.py\", line 167, in wait_for_server_termination\n    raise exceptions.BuildErrorException\nBuildErrorException: Server %(server_id)s failed to build and is in ERROR status\nDetails: Server %(server_id)s failed to build and is in ERROR status\n-------------------- >> begin captured logging << --------------------\ntempest.common.rest_client: ERROR: Request URL: http://172.18.0.156:8774/v2/6d20fdf0dac54e0c96f52c5032aa7cdf/servers/18dacb06-d135-40a4-98a2-c75211a55fac/action\ntempest.common.rest_client: ERROR: Request Body: {\"createImage\": {\"name\": \"test-snap-99444707830\"}}\ntempest.common.rest_client: ERROR: Response Headers: {'date': 'Thu, 06 Sep 2012 14:34:58 GMT', 'status': '409', 'content-length': '111', 'content-type': 'application/json; charset=UTF-8', 'x-compute-request-id': 'req-d130e4ad-6c90-416b-8624-571ca2e6f9ab'}\ntempest.common.rest_client: ERROR: Response Body: {u'conflictingRequest': {u'message': u\"Cannot 'createImage' while instance is in vm_state building\", u'code': 409}}\n--------------------- >> end captured logging << ---------------------\n\n-------", 
    "tags": [
        "tempest"
    ], 
    "importance": "Medium", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1046870", 
    "owner": "https://api.launchpad.net/1.0/~sdague", 
    "id": 1046870, 
    "index": 3037, 
    "created": "2012-09-06 14:38:55.387001+00:00", 
    "title": "test_negative_servers in tempest is disabled because of nova bugs", 
    "comments": [
        {
            "content": "Recently all tempest runs have been failing with some selection of errors in test_servers_negative.py and test_images.py. The n-cpu log is loaded with errors and stacktraces. Here is a sample of the most recent case but there is some flakiness and not all builds show exactly the same set of failures: http://logs.openstack.org/11936/13/check/gate-tempest-devstack-vm/10571/\n\nHere is some output from my local run:\n\n======================================================================\nERROR: Reboot a deleted server\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/opt/stack/tempest/tempest/tests/compute/test_servers_negative.py\", line 127, in test_reboot_deleted_server\n    self.client.wait_for_server_termination(self.server_id)\n  File \"/opt/stack/tempest/tempest/services/nova/json/servers_client.py\", line 167, in wait_for_server_termination\n    raise exceptions.BuildErrorException\nBuildErrorException: Server %(server_id)s failed to build and is in ERROR status\n\n======================================================================\nERROR: Rebuild a deleted server\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/opt/stack/tempest/tempest/tests/compute/test_servers_negative.py\", line 144, in test_rebuild_deleted_server\n    self.client.wait_for_server_termination(self.server_id)\n  File \"/opt/stack/tempest/tempest/services/nova/json/servers_client.py\", line 167, in wait_for_server_termination\n    raise exceptions.BuildErrorException\nBuildErrorException: Server %(server_id)s failed to build and is in ERROR status\n\n======================================================================\nERROR: Return error when creating an image of a server that is building\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/opt/stack/tempest/tempest/tests/compute/test_images.py\", line 380, in tearDown\n    ImagesTestBase.tearDown(self)\n  File \"/opt/stack/tempest/tempest/tests/compute/test_images.py\", line 37, in tearDown\n    self.servers_client.wait_for_server_termination(server['id'])\n  File \"/opt/stack/tempest/tempest/services/nova/json/servers_client.py\", line 167, in wait_for_server_termination\n    raise exceptions.BuildErrorException\nBuildErrorException: Server %(server_id)s failed to build and is in ERROR status\nDetails: Server %(server_id)s failed to build and is in ERROR status\n-------------------- >> begin captured logging << --------------------\ntempest.common.rest_client: ERROR: Request URL: http://172.18.0.156:8774/v2/8e694b8a45df44c18fb54aabdeb48c71/servers/01defe3f-1aed-419c-8b02-43ece401a73b/action\ntempest.common.rest_client: ERROR: Request Body: {\"createImage\": {\"name\": \"test-snap-56810686560\"}}\ntempest.common.rest_client: ERROR: Response Headers: {'date': 'Thu, 06 Sep 2012 14:31:56 GMT', 'status': '409', 'content-length': '111', 'content-type': 'application/json; charset=UTF-8', 'x-compute-request-id': 'req-ba860a75-c914-4611-87e0-105c53ddf2a6'}\ntempest.common.rest_client: ERROR: Response Body: {u'conflictingRequest': {u'message': u\"Cannot 'createImage' while instance is in vm_state building\", u'code': 409}}\n--------------------- >> end captured logging << ---------------------\n\n======================================================================\nERROR: Return error when creating an image of a server that is building\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/opt/stack/tempest/tempest/tests/compute/test_images.py\", line 406, in tearDown\n    ImagesTestBase.tearDown(self)\n  File \"/opt/stack/tempest/tempest/tests/compute/test_images.py\", line 37, in tearDown\n    self.servers_client.wait_for_server_termination(server['id'])\n  File \"/opt/stack/tempest/tempest/services/nova/json/servers_client.py\", line 167, in wait_for_server_termination\n    raise exceptions.BuildErrorException\nBuildErrorException: Server %(server_id)s failed to build and is in ERROR status\nDetails: Server %(server_id)s failed to build and is in ERROR status\n-------------------- >> begin captured logging << --------------------\ntempest.common.rest_client: ERROR: Request URL: http://172.18.0.156:8774/v2/6d20fdf0dac54e0c96f52c5032aa7cdf/servers/18dacb06-d135-40a4-98a2-c75211a55fac/action\ntempest.common.rest_client: ERROR: Request Body: {\"createImage\": {\"name\": \"test-snap-99444707830\"}}\ntempest.common.rest_client: ERROR: Response Headers: {'date': 'Thu, 06 Sep 2012 14:34:58 GMT', 'status': '409', 'content-length': '111', 'content-type': 'application/json; charset=UTF-8', 'x-compute-request-id': 'req-d130e4ad-6c90-416b-8624-571ca2e6f9ab'}\ntempest.common.rest_client: ERROR: Response Body: {u'conflictingRequest': {u'message': u\"Cannot 'createImage' while instance is in vm_state building\", u'code': 409}}\n--------------------- >> end captured logging << ---------------------\n\n-------", 
            "date_created": "2012-09-06 14:38:55.387001+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Can you narrow this down a bit?  Which specific tests are failing?  What do those tests do?  What does compute.log have in it?  You mentioned stack traces, can you share them?", 
            "date_created": "2012-09-07 18:54:49.153107+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "Please follow the link in the description and go to the bottom of the console log. You will see the errors. Note that the current\nversions of test_images.py and test_servers_negative.py have skips. The problem seems to be more general than one particular test. If you follow the link and go into the logs directory you can see the stacktraces. Like in \n\nhttp://logs.openstack.org/11936/13/check/gate-tempest-devstack-vm/10571/logs/screen-n-cpu.txt", 
            "date_created": "2012-09-07 20:23:51.805732+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Looks like all errors are due to the same cause:\r\n\r\n2012-09-06 06:00:56 TRACE nova.compute.manager Traceback (most recent call last):\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 167, in decorated_function\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     return function(self, context, *args, **kwargs)\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 202, in decorated_function\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     kwargs['instance']['uuid'], e, sys.exc_info())\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     self.gen.next()\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 196, in decorated_function\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     return function(self, context, *args, **kwargs)\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 816, in run_instance\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     do_run_instance()\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/utils.py\", line 751, in inner\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     retval = f(*args, **kwargs)\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 815, in do_run_instance\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     admin_password, is_first_time, instance)\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 512, in _run_instance\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     self._set_instance_error_state(context, instance['uuid'])\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     self.gen.next()\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 477, in _run_instance\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     self._start_building(context, instance)\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 687, in _start_building\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     None))\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 254, in _instance_update\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     context, instance_uuid, kwargs)\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/db/api.py\", line 675, in instance_update_and_get_original\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     values)\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 130, in wrapper\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     return f(*args, **kwargs)\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 1768, in instance_update_and_get_original\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     copy_old_instance=True)\r\n2012-09-06 06:00:56 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 1788, in _instance_update\r\n2012-09-06 06:00:56 TRACE nova.compute.manager     expected=expected)\r\n2012-09-06 06:00:56 TRACE nova.compute.manager UnexpectedTaskStateError: unexpected task state: expecting ('scheduling', None) but the actual state is deleting\r\n", 
            "date_created": "2012-09-13 13:51:32.881687+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Seems to no longer happen in recent runs...", 
            "date_created": "2012-09-13 14:02:41.876051+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Thierry, maybe you missed the bit in comment #2 that these tests are now skipped in tempest so that they do not continue to fail and block other checkins. I tried enabling them again and the same failures happen.", 
            "date_created": "2012-09-14 00:07:50.962780+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Even with these tests commented out the n-cpu log is strewn with ERRORs and backtraces, some of them on the scary side at least to me. Is any one concerned about this?", 
            "date_created": "2012-09-25 16:21:36.105997+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Hi David,\n\nFrom the last comment I understand that the errors seen are not related to the tests that are commented. I see the tempest tests to be skipped even in top of the tree. \n\nWould it make sense to enable them now. If you are fine with enabling the tests, I will raise a bug in launchpad and get the tests enabled. \n\nPlease let me know. \n\nRegards\nNithya", 
            "date_created": "2012-12-12 04:07:06.684964+00:00", 
            "author": "https://api.launchpad.net/1.0/~nithya-ganesan"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/23199", 
            "date_created": "2013-02-28 20:04:42.467405+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/23203", 
            "date_created": "2013-02-28 20:35:59.598470+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/23199\nCommitted: http://github.com/openstack/nova/commit/d6999fbe8c545292a98c4e3d20f3b80e3e66d901\nSubmitter: Jenkins\nBranch:    master\n\ncommit d6999fbe8c545292a98c4e3d20f3b80e3e66d901\nAuthor: Sean Dague <email address hidden>\nDate:   Thu Feb 28 14:58:42 2013 -0500\n\n    don't stack trace if long ints are passed to db\n    \n    If we pass a integer, which is longer than the id field in the\n    database, but a valid python integer into any of the REST API\n    calls SQLalchemy throws a DataError, and the user sees a 500\n    instead of InstanceNotFound. This can be triggered by using a\n    id of 9223372036854775808 (for instance).\n    \n    This issue is seen on postgresql, mysql and sqlite don't hit it.\n    \n    Instead, catch the DataError exception, and return an InvalidID\n    exception. If InvalidID is thrown catch that at the API layer\n    and return the expected not found.\n    \n    This was caught when reenabling tempest tests for bug #1046870\n    and is one of serveral patches in nova needed to enable\n    test_servers_negative.py in tempest.\n    \n    Change-Id: I6130863a95567eabd3ae05a09e4a9f26bb5f5098\n", 
            "date_created": "2013-03-01 22:14:46.836188+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/23203\nCommitted: http://github.com/openstack/nova/commit/1c6cc18b0cef25bfff8566c2a646cd8bcbbe132a\nSubmitter: Jenkins\nBranch:    master\n\ncommit 1c6cc18b0cef25bfff8566c2a646cd8bcbbe132a\nAuthor: Sean Dague <email address hidden>\nDate:   Thu Feb 28 15:32:33 2013 -0500\n\n    validate security_groups on server create\n    \n    security_groups were getting passed all the way into the database\n    without ever checking for their existance. This allowed for crudding\n    up the db with bad data, as well as succeeding when an admin typoed\n    a security group, and getting no active security group.\n    \n    Also, security_group is actually an array, which is not implied by\n    it being a singular variable. Make it a plural variable to cause\n    less confusion in the future.\n    \n    And given that we multiply change security_groups from None =>\n    ['default'], get rid of a utility function that serves no purpose\n    to handle the None or string cases.\n    \n    To test this correctly, stub out the db call, so we manage to get\n    all the way down to the bottom of the stack sanely. Also ensure that\n    the negative case gets us the expected HTTPBadRequest.\n    \n    Partial fix for nova bugs needed to reenable test_servers_negative\n    in Tempest. Fixes bug #1046870\n    \n    Change-Id: I5b477f7bc1992abb47e014f137b8010cc76b2113\n", 
            "date_created": "2013-03-02 04:38:31.709095+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/23110\nCommitted: http://github.com/openstack/tempest/commit/e623f75ca687db6ada2efded3509d7be1bf738fe\nSubmitter: Jenkins\nBranch:    master\n\ncommit e623f75ca687db6ada2efded3509d7be1bf738fe\nAuthor: Sean Dague <email address hidden>\nDate:   Wed Feb 27 14:52:15 2013 -0500\n\n    enable test_servers_negative\n    \n    this was disabled when we were seeing flakey fails during Folsom\n    release, however all but one of these tests current pass. And the\n    failure is a new nova bug. Pushing to CI to verify that bug on both\n    databases before providing the fixes to nova (of which there will\n    be at least 2)\n    \n    fix xml clients for negative tests\n    \n    the xml clients were failing additional tests because the clients\n    didn't support all the features as the json tests. This enables\n    security_groups and networks in the xml client for create.\n    \n    It also skips the test_create_numeric_server_name as that can't be\n    tested in xml, it always turns it into a string.\n    \n    Fixes bug #1046870\n    \n    Change-Id: I8a3a0bef9b1d134da369242a0cf14c3dcb61c6de\n", 
            "date_created": "2013-03-04 23:44:12.462758+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}