{
    "status": "Fix Released", 
    "last_updated": "2016-09-02 01:15:25.092265+00:00", 
    "description": "Encountered an exception in the pci whitelist causes the resource tracker to stop and blocks user/admin to spawn further VMs\n\nwe have the following pci_whitelist to support both SRIOV and PCIPT on\npci_passthrough_whitelist =\n[{\"devname\": \"eth1\", \"physical_network\": \"physnet1\"},\n{\"physical_network\": \"physnet1\", \"address\": \"*:04:00.0\"},\n{\"physical_network\": \"physnet2\", \"address\": \"*:04:00.1\"}]\n\nOnce we boot the PCI passthrough VM on physnet1 using eth1,\nthe device eth1 no longer available to hypervisor.\nSo when we try to boot another PCI passthrough VM using eth2,\nthe current code tries to validate the pci_whitelist and\nthrows an error saying - device eth1 is not found.\nThis is because pci_whitelist has devname eth1 and\ncode tries to get the PCI address of the device which is not available.\nWe also found that with the above mentioned pci_whitelist,\nas soon as we boot a PCI passthrough VM, the periodic resource\ntracker also stops. We further analysed and found that any\nmisconfiguration of pci_whitelist could cause periodic\nresource tracker to stop.\n\n\nWe get the following error in the nova compute log if eth1 is not present. But compute still shows up and the periodic hypervisor update stops working.\n\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager [req-0e7e62d5-23c9-48f2-8ca4-b47b763c29df None None] Error updating resources for node padawan-cp1-comp0001-mgmt.\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager Traceback (most recent call last):\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/compute/manager.py\", line 6472, in update_available_resource\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager rt.update_available_resource(context)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/compute/resource_tracker.py\", line 531, in update_available_resource\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager self._update_available_resource(context, resources)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/oslo_concurrency/lockutils.py\", line 271, in inner\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager return f(*args, **kwargs)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/compute/resource_tracker.py\", line 564, in _update_available_resource\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager node_id=n_id)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/pci/manager.py\", line 68, in __init__\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager self.dev_filter = whitelist.Whitelist(CONF.pci_passthrough_whitelist)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/pci/whitelist.py\", line 78, in __init__\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager self.specs = self._parse_white_list_from_config(whitelist_spec)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/pci/whitelist.py\", line 59, in _parse_white_list_from_config\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager spec = devspec.PciDeviceSpec(ds)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/pci/devspec.py\", line 134, in __init__\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager self._init_dev_details()\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/pci/devspec.py\", line 155, in _init_dev_details\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager raise exception.PciDeviceNotFoundById(id=self.dev_name)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager PciDeviceNotFoundById: PCI device eth1 not found\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager", 
    "tags": [
        "compute", 
        "pci"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1605549", 
    "owner": "https://api.launchpad.net/1.0/~mpatil", 
    "id": 1605549, 
    "index": 1952, 
    "created": "2016-07-22 08:57:35.366672+00:00", 
    "title": "PCI whitelist exception causes the resource tracker to stop and will not allow us to spawn further SR-IOV/PCIPT VMs when SR-IOV PF is assigned to a VM.", 
    "comments": [
        {
            "content": "Encountered an exception in the pci whitelist causes the resource tracker to stop and blocks user/admin to spawn further VMs\n\nwe have the following pci_whitelist to support both SRIOV and PCIPT on\npci_passthrough_whitelist =\n[{\"devname\": \"eth1\", \"physical_network\": \"physnet1\"},\n{\"physical_network\": \"physnet1\", \"address\": \"*:04:00.0\"},\n{\"physical_network\": \"physnet2\", \"address\": \"*:04:00.1\"}]\n\nOnce we boot the PCI passthrough VM on physnet1 using eth1,\nthe device eth1 no longer available to hypervisor.\nSo when we try to boot another PCI passthrough VM using eth2,\nthe current code tries to validate the pci_whitelist and\nthrows an error saying - device eth1 is not found.\nThis is because pci_whitelist has devname eth1 and\ncode tries to get the PCI address of the device which is not available.\nWe also found that with the above mentioned pci_whitelist,\nas soon as we boot a PCI passthrough VM, the periodic resource\ntracker also stops. We further analysed and found that any\nmisconfiguration of pci_whitelist could cause periodic\nresource tracker to stop.\n\n\nWe get the following error in the nova compute log if eth1 is not present. But compute still shows up and the periodic hypervisor update stops working.\n\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager [req-0e7e62d5-23c9-48f2-8ca4-b47b763c29df None None] Error updating resources for node padawan-cp1-comp0001-mgmt.\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager Traceback (most recent call last):\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/compute/manager.py\", line 6472, in update_available_resource\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager rt.update_available_resource(context)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/compute/resource_tracker.py\", line 531, in update_available_resource\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager self._update_available_resource(context, resources)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/oslo_concurrency/lockutils.py\", line 271, in inner\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager return f(*args, **kwargs)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/compute/resource_tracker.py\", line 564, in _update_available_resource\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager node_id=n_id)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/pci/manager.py\", line 68, in __init__\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager self.dev_filter = whitelist.Whitelist(CONF.pci_passthrough_whitelist)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/pci/whitelist.py\", line 78, in __init__\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager self.specs = self._parse_white_list_from_config(whitelist_spec)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/pci/whitelist.py\", line 59, in _parse_white_list_from_config\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager spec = devspec.PciDeviceSpec(ds)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/pci/devspec.py\", line 134, in __init__\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager self._init_dev_details()\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager File \"/opt/stack/venv/nova-20160607T195234Z/lib/python2.7/site-packages/nova/pci/devspec.py\", line 155, in _init_dev_details\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager raise exception.PciDeviceNotFoundById(id=self.dev_name)\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager PciDeviceNotFoundById: PCI device eth1 not found\n2016-07-13 09:22:42.146 28800 ERROR nova.compute.manager", 
            "date_created": "2016-07-22 08:57:35.366672+00:00", 
            "author": "https://api.launchpad.net/1.0/~mpatil"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/345925", 
            "date_created": "2016-07-22 09:09:13.255426+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi,\n\nThis bug is not a duplicate of https://bugs.launchpad.net/bugs/1603034\n\nIn the discussion https://review.openstack.org/#/c/342301/ we had agreed to have different patches for syntax and regex-type validation and second one which fixes user-driven failures due to VM assigned a PF.\n\nQuoting from discussion -->  \"Yeah, having two separate patches is what I'm arguing for... one (this one) to move syntax and regex-type validation of the whitelist into the nova-compute startup and a second patch that fixes the user-driven failures that can occur due to a VM being assigned a PF and the whitelist value no longer being fully acceptable on the host.\"\n\n", 
            "date_created": "2016-07-23 06:36:28.278019+00:00", 
            "author": "https://api.launchpad.net/1.0/~mpatil"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/345925\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=433fe514e8d166345b2bd8fa0b3055724285406d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 433fe514e8d166345b2bd8fa0b3055724285406d\nAuthor: Manjunath Patil <email address hidden>\nDate:   Fri Jul 22 14:31:11 2016 +0530\n\n    Resolve PCI devices on the host during Guest boot-up.\n    \n    When devname is used in Whitelist configuration,\n    resolve the address of devname when trying to\n    match a device in the whiltelist.\n    \n    Change-Id: I7a65857454cc132d97df9abb8297d350514cf2df\n    Closes-Bug: #1605549\n    Co-Authored-By: Raghuveer Shenoy <email address hidden>\n    Co-Authored-By: Sonu <email address hidden>\n", 
            "date_created": "2016-08-04 00:10:05.881474+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b3 development milestone.", 
            "date_created": "2016-09-02 01:15:24.203938+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}