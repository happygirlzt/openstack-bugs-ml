{
    "status": "Opinion", 
    "last_updated": "2017-03-03 06:24:21.000481+00:00", 
    "description": "I am confronted with a really strange problem with nova-consoleauth. I am running OpenStack Newton on Ubuntu Server 16.04.1. When I use VNC from Horizon, I get frequently get the error \"Failed to connect to server (code: 1006)\". There is only a single nova-consoleauth service available.\n\nThere are two scenarios:\n- The first login with a fresh token fails. The next one succeeds.\n- The first login succeeds, but the token expires really fast.\n\nScenario 1 (nova-consoleauth.log):\n2016-10-28 06:50:55.845 9973 INFO nova.consoleauth.manager [req-f0f8fc1d-ae41-443d-9647-83287114bf1d 58963f571cad45b3b7b6272c73f4cb3b 638770a11625458299c2d205759d09df - - -] Received Token: 37d8bbfb-03b8-4368-b339-b3791e77a4b7, {'instance_uuid': u'f35b3673-e2ac-4bfa-878c-6700efd289d5', 'access_url': u'https://10.30.216.100:6080/vnc_auto.html?token=37d8bbfb-03b8-4368-b339-b3791e77a4b7', 'token': u'37d8bbfb-03b8-4368-b339-b3791e77a4b7', 'last_activity_at': 1477630255.842381, 'internal_access_path': None, 'console_type': u'novnc', 'host': u'10.30.200.113', 'port': u'5900'}\n2016-10-28 06:50:56.313 9973 INFO nova.consoleauth.manager [req-1d623f93-5e05-462a-8058-4867bca71665 - - - - -] Checking Token: 37d8bbfb-03b8-4368-b339-b3791e77a4b7, False\n2016-10-28 06:51:22.427 9973 INFO nova.consoleauth.manager [req-805a354e-c325-4f67-8a64-9e6b1a689f18 - - - - -] Checking Token: 37d8bbfb-03b8-4368-b339-b3791e77a4b7, False\n2016-10-28 06:51:48.809 9973 INFO nova.consoleauth.manager [req-048a2bf7-ac53-4136-b28a-d3c5903ef226 58963f571cad45b3b7b6272c73f4cb3b 638770a11625458299c2d205759d09df - - -] Received Token: cdf07104-102c-44c6-ba90-56049702e3ae, {'instance_uuid': u'8c793085-1f79-458f-92a8-ee95add830da', 'access_url': u'https://10.30.216.100:6080/vnc_auto.html?token=cdf07104-102c-44c6-ba90-56049702e3ae', 'token': u'cdf07104-102c-44c6-ba90-56049702e3ae', 'last_activity_at': 1477630068.805975, 'internal_access_path': None, 'console_type': u'novnc', 'host': u'10.30.200.111', 'port': u'5900'}\n2016-10-28 06:52:49.168 9973 INFO nova.consoleauth.manager [req-81b8c139-303f-4c6e-9b2d-0f7e0ea1467c - - - - -] Checking Token: cdf07104-102c-44c6-ba90-56049702e3ae, True\n2016-10-28 06:53:02.168 9973 INFO nova.consoleauth.manager [req-81b8c139-303f-4c6e-9b2d-0f7e0ea1467c - - - - -] Checking Token: cdf07104-102c-44c6-ba90-56049702e3ae, True\n\nScenario 2 (nova-consoleauth.log):\n2016-10-28 07:11:00.059 9973 INFO nova.consoleauth.manager [req-c3cfaf64-935f-4b2e-83f1-6bff35f4e923 ba6f9eddfd154b88b6a45d218fb5b310 638770a11625458299c2d205759d09df - - -] Received Token: bc3c697d-8740-4053-adf9-8133ce5f2296, {'instance_uuid': u'8c793085-1f79-458f-92a8-ee95add830da', 'access_url': u'https://10.30.216.100:6080/vnc_auto.html?token=bc3c697d-8740-4053-adf9-8133ce5f2296', 'token': u'bc3c697d-8740-4053-adf9-8133ce5f2296', 'last_activity_at': 1477631460.049053, 'internal_access_path': None, 'console_type': u'novnc', 'host': u'10.30.200.111', 'port': u'5900'}\n2016-10-28 07:11:00.494 9973 INFO nova.consoleauth.manager [req-34d85dce-54e9-475d-9968-524bedffaa0b - - - - -] Checking Token: bc3c697d-8740-4053-adf9-8133ce5f2296, True\n2016-10-28 07:11:07.479 9973 INFO nova.consoleauth.manager [req-c835b16c-4bb4-4d9d-83c8-e59c174052a6 - - - - -] Checking Token: bc3c697d-8740-4053-adf9-8133ce5f2296, True\n2016-10-28 07:12:24.923 9973 INFO nova.consoleauth.manager [req-f1748791-e631-429d-b75e-7b865664a09b - - - - -] Checking Token: bc3c697d-8740-4053-adf9-8133ce5f2296, False\n\nI successfully locked in at \"07:11:00.059\" with the token \"bc3c697d-8740-4053-adf9-8133ce5f229\" and made some refreshes. At \"07:12:24.923\" the token is suddenly invalid. This is really fast... What is the reason.\n\nThis is my nova.conf on the controller:\n[DEFAULT]\nauth_strategy = keystone\ndebug = true\nenabled_apis = osapi_compute,metadata\nfirewall_driver = nova.virt.firewall.NoopFirewallDriver\nhost = os-controller01\nlinuxnet_interface_driver = nova.network.linux_net.LinuxOVSInterfaceDriver\nlog_dir = /var/log/nova\nmemcached_servers = os-memcache:11211\nmetadata_listen = $my_ip\nmetadata_listen_port = 8775\nmy_ip = 10.30.200.101\nosapi_compute_listen = $my_ip\nosapi_compute_listen_port = 8774\nstate_path = /var/lib/nova\ntransport_url = rabbit://nova:XYZ@os-rabbit01:5672,nova:XYZ@os-rabbit02:5672/openstack\nuse_neutron = true\n\n[cache]\nbackend = oslo_cache.memcache_pool\nenabled = true\nmemcache_servers = os-memcache:11211\n\n[cinder]\ncatalog_info = volumev2:cinderv2:internalURL\nos_region_name = RegionOne\n\n[database]\nconnection = mysql+pymysql://nova:XYZ@os-controller/nova\nmax_retries = -1\n\n[api_database]\nconnection = mysql+pymysql://nova:XYZ@os-controller/nova_api\nmax_retries = -1\n\n[glance]\napi_servers = http://os-image:9292\n\n[keystone_authtoken]\nauth_type = password\nauth_uri = http://os-identity:5000\nauth_url = http://os-identity:35357\nmemcached_servers = os-memcache:11211\npassword = XYZ\nproject_domain_name = default\nproject_name = service\nuser_domain_name = default\nusername = nova\n\n[neutron]\nauth_type = password\nauth_uri = http://os-identity:5000\nauth_url = http://os-identity:35357\nmetadata_proxy_shared_secret = 2a9c2c3a435ad6fefd61\npassword = XYZ\nproject_domain_name = default\nproject_name = service\nregion_name = RegionOne\nservice_metadata_proxy = true\n# NOTE: python-rfc3986 could not handle URI which has '-' characters.\n#       Should be replaced as soon as possible by 'http://os-network:9696'.\n#       https://bugs.launchpad.net/kolla/+bug/1629729\nurl = http://10.30.200.100:9696\nuser_domain_name = default\nusername = neutron\n\n[oslo_concurrency]\nlock_path = /var/lock/nova\n\n[oslo_messaging_notifications]\ndriver = messagingv2\n\n[oslo_messaging_rabbit]\namqp_durable_queues = true\nrabbit_ha_queues = true\nrabbit_retry_backoff = 2\nrabbit_retry_interval = 1\n\n[oslo_middleware]\nenable_proxy_headers_parsing = true\n\n[vnc]\nenabled = true\nnovncproxy_host = 10.30.200.101\nnovncproxy_port = 6080\nvncserver_listen = $my_ip\nvncserver_proxyclient_address = $my_ip\n\nAll caches are configured. I looked at the code of the consoleauth service. If I get everything right, the manager just looks into the cache and checks if the token is present. If it is not, it denies access to the console.\n\nHas anybody an idea what causes the issue?\n\nThanks a lot!", 
    "tags": [
        "console", 
        "nova-consoleauth"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1637390", 
    "owner": "None", 
    "id": 1637390, 
    "index": 6499, 
    "created": "2016-10-28 05:32:31.112949+00:00", 
    "title": "nova.consoleauth.manager often denies access to VNC: First login fails or token expires too fast", 
    "comments": [
        {
            "content": "I am confronted with a really strange problem with nova-consoleauth. I am running OpenStack Newton on Ubuntu Server 16.04.1. When I use VNC from Horizonm, I get frequently get the error \"Failed to connect to server (code: 1006)\". There is only a single nova-consoleauth service available.\n\nThere are two scenarios:\n- The first login with a fresh token fails. The next one succeeds.\n- The first logon succeeds, but the token expires really fast.\n\nScenario 1 (nova-consoleauth.log):\n2016-10-28 06:50:55.845 9973 INFO nova.consoleauth.manager [req-f0f8fc1d-ae41-443d-9647-83287114bf1d 58963f571cad45b3b7b6272c73f4cb3b 638770a11625458299c2d205759d09df - - -] Received Token: 37d8bbfb-03b8-4368-b339-b3791e77a4b7, {'instance_uuid': u'f35b3673-e2ac-4bfa-878c-6700efd289d5', 'access_url': u'https://10.30.216.100:6080/vnc_auto.html?token=37d8bbfb-03b8-4368-b339-b3791e77a4b7', 'token': u'37d8bbfb-03b8-4368-b339-b3791e77a4b7', 'last_activity_at': 1477630255.842381, 'internal_access_path': None, 'console_type': u'novnc', 'host': u'10.30.200.113', 'port': u'5900'}\n2016-10-28 06:50:56.313 9973 INFO nova.consoleauth.manager [req-1d623f93-5e05-462a-8058-4867bca71665 - - - - -] Checking Token: 37d8bbfb-03b8-4368-b339-b3791e77a4b7, False\n2016-10-28 06:51:22.427 9973 INFO nova.consoleauth.manager [req-805a354e-c325-4f67-8a64-9e6b1a689f18 - - - - -] Checking Token: 37d8bbfb-03b8-4368-b339-b3791e77a4b7, False\n2016-10-28 06:51:48.809 9973 INFO nova.consoleauth.manager [req-048a2bf7-ac53-4136-b28a-d3c5903ef226 58963f571cad45b3b7b6272c73f4cb3b 638770a11625458299c2d205759d09df - - -] Received Token: cdf07104-102c-44c6-ba90-56049702e3ae, {'instance_uuid': u'8c793085-1f79-458f-92a8-ee95add830da', 'access_url': u'https://10.30.216.100:6080/vnc_auto.html?token=cdf07104-102c-44c6-ba90-56049702e3ae', 'token': u'cdf07104-102c-44c6-ba90-56049702e3ae', 'last_activity_at': 1477630068.805975, 'internal_access_path': None, 'console_type': u'novnc', 'host': u'10.30.200.111', 'port': u'5900'}\n2016-10-28 06:52:49.168 9973 INFO nova.consoleauth.manager [req-81b8c139-303f-4c6e-9b2d-0f7e0ea1467c - - - - -] Checking Token: cdf07104-102c-44c6-ba90-56049702e3ae, True\n2016-10-28 06:53:02.168 9973 INFO nova.consoleauth.manager [req-81b8c139-303f-4c6e-9b2d-0f7e0ea1467c - - - - -] Checking Token: cdf07104-102c-44c6-ba90-56049702e3ae, True\n\nScenario 2 (nova-consoleauth.log):\n2016-10-28 07:11:00.059 9973 INFO nova.consoleauth.manager [req-c3cfaf64-935f-4b2e-83f1-6bff35f4e923 ba6f9eddfd154b88b6a45d218fb5b310 638770a11625458299c2d205759d09df - - -] Received Token: bc3c697d-8740-4053-adf9-8133ce5f2296, {'instance_uuid': u'8c793085-1f79-458f-92a8-ee95add830da', 'access_url': u'https://10.30.216.100:6080/vnc_auto.html?token=bc3c697d-8740-4053-adf9-8133ce5f2296', 'token': u'bc3c697d-8740-4053-adf9-8133ce5f2296', 'last_activity_at': 1477631460.049053, 'internal_access_path': None, 'console_type': u'novnc', 'host': u'10.30.200.111', 'port': u'5900'}\n2016-10-28 07:11:00.494 9973 INFO nova.consoleauth.manager [req-34d85dce-54e9-475d-9968-524bedffaa0b - - - - -] Checking Token: bc3c697d-8740-4053-adf9-8133ce5f2296, True\n2016-10-28 07:11:07.479 9973 INFO nova.consoleauth.manager [req-c835b16c-4bb4-4d9d-83c8-e59c174052a6 - - - - -] Checking Token: bc3c697d-8740-4053-adf9-8133ce5f2296, True\n2016-10-28 07:12:24.923 9973 INFO nova.consoleauth.manager [req-f1748791-e631-429d-b75e-7b865664a09b - - - - -] Checking Token: bc3c697d-8740-4053-adf9-8133ce5f2296, False\n\nI successfully locked in at \"07:11:00.059\" with the token \"bc3c697d-8740-4053-adf9-8133ce5f229\" and made some refreshes. At \"07:12:24.923\" the token is suddenly invalid. This is really fast... What is the reason.\n\nThis is my nova.conf on the controller:\n[DEFAULT]\nauth_strategy = keystone\ndebug = true\nenabled_apis = osapi_compute,metadata\nfirewall_driver = nova.virt.firewall.NoopFirewallDriver\nhost = os-controller01\nlinuxnet_interface_driver = nova.network.linux_net.LinuxOVSInterfaceDriver\nlog_dir = /var/log/nova\nmemcached_servers = os-memcache:11211\nmetadata_listen = $my_ip\nmetadata_listen_port = 8775\nmy_ip = 10.30.200.101\nosapi_compute_listen = $my_ip\nosapi_compute_listen_port = 8774\nstate_path = /var/lib/nova\ntransport_url = rabbit://nova:XYZ@os-rabbit01:5672,nova:XYZ@os-rabbit02:5672/openstack\nuse_neutron = true\n\n[cache]\nbackend = oslo_cache.memcache_pool\nenabled = true\nmemcache_servers = os-memcache:11211\n\n[cinder]\ncatalog_info = volumev2:cinderv2:internalURL\nos_region_name = RegionOne\n\n[database]\nconnection = mysql+pymysql://nova:XYZ@os-controller/nova\nmax_retries = -1\n\n[api_database]\nconnection = mysql+pymysql://nova:XYZ@os-controller/nova_api\nmax_retries = -1\n\n[glance]\napi_servers = http://os-image:9292\n\n[keystone_authtoken]\nauth_type = password\nauth_uri = http://os-identity:5000\nauth_url = http://os-identity:35357\nmemcached_servers = os-memcache:11211\npassword = XYZ\nproject_domain_name = default\nproject_name = service\nuser_domain_name = default\nusername = nova\n\n[neutron]\nauth_type = password\nauth_uri = http://os-identity:5000\nauth_url = http://os-identity:35357\nmetadata_proxy_shared_secret = 2a9c2c3a435ad6fefd61\npassword = XYZ\nproject_domain_name = default\nproject_name = service\nregion_name = RegionOne\nservice_metadata_proxy = true\n# NOTE: python-rfc3986 could not handle URI which has '-' characters.\n#       Should be replaced as soon as possible by 'http://os-network:9696'.\n#       https://bugs.launchpad.net/kolla/+bug/1629729\nurl = http://10.30.200.100:9696\nuser_domain_name = default\nusername = neutron\n\n[oslo_concurrency]\nlock_path = /var/lock/nova\n\n[oslo_messaging_notifications]\ndriver = messagingv2\n\n[oslo_messaging_rabbit]\namqp_durable_queues = true\nrabbit_ha_queues = true\nrabbit_retry_backoff = 2\nrabbit_retry_interval = 1\n\n[oslo_middleware]\nenable_proxy_headers_parsing = true\n\n[vnc]\nenabled = true\nnovncproxy_host = 10.30.200.101\nnovncproxy_port = 6080\nvncserver_listen = $my_ip\nvncserver_proxyclient_address = $my_ip\n\nAll caches are configured. I looked at the code of the consoleauth service. If I get everything right, the manager just looks into the cache and checks if the token is present. If it is not, it denies access to the console.\n\nHas anybody an idea what causes the issue?\n\nThanks a lot!", 
            "date_created": "2016-10-28 05:32:31.112949+00:00", 
            "author": "https://api.launchpad.net/1.0/~cfiehe"
        }, 
        {
            "content": "Things are getting more and more strange... Have a look to the follwing excerpt:\n2016-10-28 08:20:27.987 30439 INFO nova.consoleauth.manager [req-a0bab6a8-8bb6-4bae-a6af-493d21e0dd9f - - - - -] Checking Token: e1c8eec9-29c5-4f37-aef8-e38727e8252d, False\n2016-10-28 08:20:31.007 30439 INFO nova.consoleauth.manager [req-42ab3892-dffc-4991-93ed-1e0eb9adffb1 - - - - -] Checking Token: e1c8eec9-29c5-4f37-aef8-e38727e8252d, True\n\nThe token \"e1c8eec9-29c5-4f37-aef8-e38727e8252d\" is first invaild and after a refresh it is valid. The first call gives me \"Failed to connect to server (code: 1006)\", after refresh the state is \"Connected\". In my environment, there is only one nova-consoleauth service and only one memcache service.\n\nWhat is going on here?", 
            "date_created": "2016-10-28 06:25:54.340562+00:00", 
            "author": "https://api.launchpad.net/1.0/~cfiehe"
        }, 
        {
            "content": "I think, I have found the issue. Connections to the memcache service are handled in my case via HaProxy with uses a client connection timeout of 60s. That is the timespan that causes nova-consoleauth to fail during the token validation. I would expect that just a reconnect happens and token validation succeeds, because each token added by nova to memcache has a default expiration_time of 600s. It seems to me that reconnections interfere with the memcache lookup result. That is someting, what I do not expect.\n\nA quick workaround (or solution?) is to extend the client timeout in the HaProxy configuration to e.g. 1h. With this setting, I get a stable connection to VNC and the nova-consoleauth service is able to successfully validate the received token.\n\nAny thoughts?", 
            "date_created": "2016-10-28 08:07:57.215843+00:00", 
            "author": "https://api.launchpad.net/1.0/~cfiehe"
        }, 
        {
            "content": "First, thanks for good description.\n\nI believe that your case is valid, for example for solving the same problem with mysql 'select 1' is issued before each request. I'm not sure it can be treated like a bug, would rather mark this like \"wishlist\" behavior.", 
            "date_created": "2017-03-03 06:24:09.922150+00:00", 
            "author": "https://api.launchpad.net/1.0/~avolkov"
        }
    ]
}