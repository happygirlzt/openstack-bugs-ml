{
    "status": "Fix Released", 
    "last_updated": "2015-08-02 23:28:12.411292+00:00", 
    "description": "I created a backup to an instance which had no volume attached. \n\nattached a volume -> rebuild the instance from the backup. \n\nIt appears as though the volume is not attached anymore after the rebuild, but if we try to attach it to the same device we get an error that a device is already attached:\n\n2013-10-18 16:54:36.632 2478 DEBUG qpid.messaging [-] RETR[2fca830]: Message(properties={'x-amqp-0-10.routing-key': u'reply_70fb16e321724b38b3d3face4e83f363'}, content={u'oslo.message': u'{\"_unique_id\": \"dd2a85b63c56498c8f2835f9b96e9bb9\"\n, \"failure\": null, \"_msg_id\": \"7ce524cebbb34aecab9d608a48103a1c\", \"result\": null, \"ending\": true}', u'oslo.version': u'2.0'}) _get /usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py:654\n2013-10-18 16:54:36.633 2478 DEBUG qpid.messaging.io.ops [-] SENT[2fa6cb0]: MessageFlow(destination='0', unit=0, value=1L, id=serial(5206)) write_op /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:686\n2013-10-18 16:54:36.634 2478 DEBUG qpid.messaging.io.ops [-] SENT[2fa6cb0]: SessionCompleted(commands=[0-5199]) write_op /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:686\n2013-10-18 16:54:36.639 2478 ERROR nova.openstack.common.rpc.amqp [req-4a884bb4-5ba6-403d-8be7-df1eeebc1324 bbce236d5aac4d1dbc086a8835ed0ebc d09f3bf0f9224affa92ab97010b37270] Exception during message handling\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 90, in wrapped\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 73, in wrapped\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 243, in decorated_function\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     pass\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 229, in decorated_function\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 271, in decorated_function\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 258, in decorated_function\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3624, in reserve_block_device_name\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     return do_reserve()\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 246, in inner\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kwargs)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3613, in do_reserve\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     context, instance, bdms, device)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/utils.py\", line 135, in get_device_name_for_instance\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     mappings['root'], device)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/utils.py\", line 217, in get_next_device_name\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     raise exception.DevicePathInUse(path=device)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp DevicePathInUse: The supplied device path (/dev/vdc) is in use.\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp \n2013-10-18 16:54:36.641 2478 ERROR nova.openstack.common.rpc.common [req-4a884bb4-5ba6-403d-8be7-df1eeebc1324 bbce236d5aac4d1dbc086a8835ed0ebc d09f3bf0f9224affa92ab97010b37270] Returning exception The supplied device path (/dev/vdc) is i\nn use. to caller\n2013-10-18 16:54:36.642 2478 ERROR nova.openstack.common.rpc.common [req-4a884bb4-5ba6-403d-8be7-df1eeebc1324 bbce236d5aac4d1dbc086a8835ed0ebc d09f3bf0f9224affa92ab97010b37270] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/p\nython2.6/site-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\\n    **args)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\\n    result = getattr(proxyo\nbj, method)(ctxt, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 90, in wrapped\\n    payload)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 73, in wrapped\\n    return f(self, con\ntext, *args, **kw)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 243, in decorated_function\\n    pass\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 229, in decorated_function\\\nn    return function(self, context, *args, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 271, in decorated_function\\n    e, sys.exc_info())\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compu\nte/manager.py\", line 258, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3624, in reserve_block_device_name\\n    return do_reserve()\n\\n', '  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 246, in inner\\n    return f(*args, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3613, in do_reserve\\n    c\nontext, instance, bdms, device)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/utils.py\", line 135, in get_device_name_for_instance\\n    mappings[\\'root\\'], device)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/u\ntils.py\", line 217, in get_next_device_name\\n    raise exception.DevicePathInUse(path=device)\\n', 'DevicePathInUse: The supplied device path (/dev/vdc) is in use.\\n']\n2013-10-18 16:54:36.642 2478 DEBUG nova.openstack.common.rpc.amqp [req-4a884bb4-5ba6-403d-8be7-df1eeebc1324 bbce236d5aac4d1dbc086a8835ed0ebc d09f3bf0f9224affa92ab97010b37270] UNIQUE_ID is 5d08dde3f40e4186b50e28a9dad5385b. _add_unique_id \n/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py:341\n\n\nIf I try to attach the same volume to the same instance on a different device it seems to be working, however, when we try to detach it we get the following error: \n\n2013-10-18 16:58:11.288 2478 DEBUG qpid.messaging [-] RCVD[2fca830]: Message(properties={'x-amqp-0-10.routing-key': u'reply_70fb16e321724b38b3d3face4e83f363'}, content={u'oslo.message': u'{\"_unique_id\": \"20a035f66eac46f7b44e8420cd5a2d14\"\n, \"failure\": null, \"_msg_id\": \"27d7abfd907146c4a0e052cf067a4d69\", \"result\": null, \"ending\": true}', u'oslo.version': u'2.0'}) do_message_transfer /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:1295\n2013-10-18 16:58:11.289 2478 DEBUG qpid.messaging [-] RETR[2fca830]: Message(properties={'x-amqp-0-10.routing-key': u'reply_70fb16e321724b38b3d3face4e83f363'}, content={u'oslo.message': u'{\"_unique_id\": \"20a035f66eac46f7b44e8420cd5a2d14\"\n, \"failure\": null, \"_msg_id\": \"27d7abfd907146c4a0e052cf067a4d69\", \"result\": null, \"ending\": true}', u'oslo.version': u'2.0'}) _get /usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py:654\n2013-10-18 16:58:11.289 2478 DEBUG qpid.messaging.io.ops [-] SENT[2fa6cb0]: MessageFlow(destination='0', unit=0, value=1L, id=serial(5308)) write_op /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:686\n2013-10-18 16:58:11.290 2478 DEBUG qpid.messaging.io.ops [-] SENT[2fa6cb0]: SessionCompleted(commands=[0-5301]) write_op /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:686\n2013-10-18 16:58:11.296 2478 ERROR nova.openstack.common.rpc.amqp [req-62e56d8a-9dc1-447c-acef-2b2dafdd5079 bbce236d5aac4d1dbc086a8835ed0ebc d09f3bf0f9224affa92ab97010b37270] Exception during message handling\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 90, in wrapped\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 73, in wrapped\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 243, in decorated_function\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     pass\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 229, in decorated_function\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 271, in decorated_function\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 258, in decorated_function\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3760, in detach_volume\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     self._detach_volume(context, instance, bdm)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3732, in _detach_volume\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     self.volume_api.roll_detaching(context, volume_id)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3725, in _detach_volume\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     encryption=encryption)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1205, in detach_volume\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     raise exception.DiskNotFound(location=disk_dev)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp DiskNotFound: No disk at vdc\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp \n2013-10-18 16:58:11.298 2478 DEBUG qpid.messaging.io.raw [-] SENT[2fa6cb0]: '\\x0f\\x01\\x00\\x19\\x00\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x04\\n\\x01\\x00\\x07\\x00\\x010\\x00\\x00\\x00\\x00\\x01\\x0f\\x00\\x00\\x1a\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x02\\n\\x01\\x00\\x0\n0\\x08\\x00\\x00\\x00\\x00\\x00\\x00\\x14\\xb5' writeable /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:480\n2013-10-18 16:58:14.265 2478 DEBUG qpid.messaging.io.raw [-] READ[2fa6cb0]: '\\x0f\\x00\\x00\\x10\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\n\\x00\\x00' readable /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:416\n2013-10-18 16:58:14.266 2478 DEBUG qpid.messaging.io.ops [-] RCVD[2fa6cb0]: ConnectionHeartbeat() write /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:654\n2013-10-18 16:58:14.291 2478 DEBUG qpid.messaging.io.raw [-] READ[2fca998]: '\\x0f\\x00\\x00\\x10\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\n\\x00\\x00' readable /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:416\n2013-10-18 16:58:14.291 2478 DEBUG qpid.messaging.io.ops [-] RCVD[2fca998]: ConnectionHeartbeat() write /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:654\n2013-10-18 16:58:15.019 2478 DEBUG nova.openstack.common.periodic_task [-] Running periodic task ComputeManager._poll_volume_usage run_periodic_tasks /usr/lib/python2.6/site-packages/nova/openstack/common/periodic_task.py:176\n2013-10-18 16:58:15.024 2478 DEBUG nova.openstack.common.periodic_task [-] Running periodic task ComputeManager._instance_usage_audit run_periodic_tasks /usr/lib/python2.6/site-packages/nova/openstack/common/periodic_task.py:176\n2013-10-18 16:58:15.024 2478 DEBUG nova.openstack.common.periodic_task [-] Running periodic task ComputeManager.update_available_resource run_periodic_tasks /usr/lib/python2.6/site-packages/nova/openstack/common/periodic_task.py:176\n2013-10-18 16:58:15.025 2478 DEBUG nova.openstack.common.lockutils [-] Got semaphore \"compute_resources\" lock /usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py:166\n2013-10-18 16:58:15.025 2478 DEBUG nova.openstack.common.lockutils [-] Got semaphore / lock \"update_available_resource\" inner /usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py:245\n2013-10-18 16:58:15.025 2478 AUDIT nova.compute.resource_tracker [-] Auditing locally available compute resources", 
    "tags": [
        "volumes"
    ], 
    "importance": "High", 
    "heat": 20, 
    "link": "https://bugs.launchpad.net/nova/+bug/1241615", 
    "owner": "https://api.launchpad.net/1.0/~ndipanov", 
    "id": 1241615, 
    "index": 1279, 
    "created": "2013-10-18 14:04:40.290289+00:00", 
    "title": "rebuild with volume attached leaves instance without the volume and in an inconsistent state", 
    "comments": [
        {
            "content": "I created a backup to an instance which had no volume attached. \n\nattached a volume -> rebuild the instance from the backup. \n\nIt appears as though the volume is not attached anymore after the rebuild, but if we try to attach it to the same device we get an error that a device is already attached:\n\n2013-10-18 16:54:36.632 2478 DEBUG qpid.messaging [-] RETR[2fca830]: Message(properties={'x-amqp-0-10.routing-key': u'reply_70fb16e321724b38b3d3face4e83f363'}, content={u'oslo.message': u'{\"_unique_id\": \"dd2a85b63c56498c8f2835f9b96e9bb9\"\n, \"failure\": null, \"_msg_id\": \"7ce524cebbb34aecab9d608a48103a1c\", \"result\": null, \"ending\": true}', u'oslo.version': u'2.0'}) _get /usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py:654\n2013-10-18 16:54:36.633 2478 DEBUG qpid.messaging.io.ops [-] SENT[2fa6cb0]: MessageFlow(destination='0', unit=0, value=1L, id=serial(5206)) write_op /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:686\n2013-10-18 16:54:36.634 2478 DEBUG qpid.messaging.io.ops [-] SENT[2fa6cb0]: SessionCompleted(commands=[0-5199]) write_op /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:686\n2013-10-18 16:54:36.639 2478 ERROR nova.openstack.common.rpc.amqp [req-4a884bb4-5ba6-403d-8be7-df1eeebc1324 bbce236d5aac4d1dbc086a8835ed0ebc d09f3bf0f9224affa92ab97010b37270] Exception during message handling\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 90, in wrapped\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 73, in wrapped\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 243, in decorated_function\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     pass\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 229, in decorated_function\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 271, in decorated_function\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 258, in decorated_function\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3624, in reserve_block_device_name\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     return do_reserve()\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 246, in inner\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kwargs)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3613, in do_reserve\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     context, instance, bdms, device)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/utils.py\", line 135, in get_device_name_for_instance\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     mappings['root'], device)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/utils.py\", line 217, in get_next_device_name\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp     raise exception.DevicePathInUse(path=device)\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp DevicePathInUse: The supplied device path (/dev/vdc) is in use.\n2013-10-18 16:54:36.639 2478 TRACE nova.openstack.common.rpc.amqp \n2013-10-18 16:54:36.641 2478 ERROR nova.openstack.common.rpc.common [req-4a884bb4-5ba6-403d-8be7-df1eeebc1324 bbce236d5aac4d1dbc086a8835ed0ebc d09f3bf0f9224affa92ab97010b37270] Returning exception The supplied device path (/dev/vdc) is i\nn use. to caller\n2013-10-18 16:54:36.642 2478 ERROR nova.openstack.common.rpc.common [req-4a884bb4-5ba6-403d-8be7-df1eeebc1324 bbce236d5aac4d1dbc086a8835ed0ebc d09f3bf0f9224affa92ab97010b37270] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/p\nython2.6/site-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\\n    **args)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\\n    result = getattr(proxyo\nbj, method)(ctxt, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 90, in wrapped\\n    payload)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 73, in wrapped\\n    return f(self, con\ntext, *args, **kw)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 243, in decorated_function\\n    pass\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 229, in decorated_function\\\nn    return function(self, context, *args, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 271, in decorated_function\\n    e, sys.exc_info())\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compu\nte/manager.py\", line 258, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3624, in reserve_block_device_name\\n    return do_reserve()\n\\n', '  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 246, in inner\\n    return f(*args, **kwargs)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3613, in do_reserve\\n    c\nontext, instance, bdms, device)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/utils.py\", line 135, in get_device_name_for_instance\\n    mappings[\\'root\\'], device)\\n', '  File \"/usr/lib/python2.6/site-packages/nova/compute/u\ntils.py\", line 217, in get_next_device_name\\n    raise exception.DevicePathInUse(path=device)\\n', 'DevicePathInUse: The supplied device path (/dev/vdc) is in use.\\n']\n2013-10-18 16:54:36.642 2478 DEBUG nova.openstack.common.rpc.amqp [req-4a884bb4-5ba6-403d-8be7-df1eeebc1324 bbce236d5aac4d1dbc086a8835ed0ebc d09f3bf0f9224affa92ab97010b37270] UNIQUE_ID is 5d08dde3f40e4186b50e28a9dad5385b. _add_unique_id \n/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py:341\n\n\nIf I try to attach the same volume to the same instance on a different device it seems to be working, however, when we try to detach it we get the following error: \n\n2013-10-18 16:58:11.288 2478 DEBUG qpid.messaging [-] RCVD[2fca830]: Message(properties={'x-amqp-0-10.routing-key': u'reply_70fb16e321724b38b3d3face4e83f363'}, content={u'oslo.message': u'{\"_unique_id\": \"20a035f66eac46f7b44e8420cd5a2d14\"\n, \"failure\": null, \"_msg_id\": \"27d7abfd907146c4a0e052cf067a4d69\", \"result\": null, \"ending\": true}', u'oslo.version': u'2.0'}) do_message_transfer /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:1295\n2013-10-18 16:58:11.289 2478 DEBUG qpid.messaging [-] RETR[2fca830]: Message(properties={'x-amqp-0-10.routing-key': u'reply_70fb16e321724b38b3d3face4e83f363'}, content={u'oslo.message': u'{\"_unique_id\": \"20a035f66eac46f7b44e8420cd5a2d14\"\n, \"failure\": null, \"_msg_id\": \"27d7abfd907146c4a0e052cf067a4d69\", \"result\": null, \"ending\": true}', u'oslo.version': u'2.0'}) _get /usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py:654\n2013-10-18 16:58:11.289 2478 DEBUG qpid.messaging.io.ops [-] SENT[2fa6cb0]: MessageFlow(destination='0', unit=0, value=1L, id=serial(5308)) write_op /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:686\n2013-10-18 16:58:11.290 2478 DEBUG qpid.messaging.io.ops [-] SENT[2fa6cb0]: SessionCompleted(commands=[0-5301]) write_op /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:686\n2013-10-18 16:58:11.296 2478 ERROR nova.openstack.common.rpc.amqp [req-62e56d8a-9dc1-447c-acef-2b2dafdd5079 bbce236d5aac4d1dbc086a8835ed0ebc d09f3bf0f9224affa92ab97010b37270] Exception during message handling\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 90, in wrapped\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 73, in wrapped\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 243, in decorated_function\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     pass\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 229, in decorated_function\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 271, in decorated_function\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 258, in decorated_function\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3760, in detach_volume\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     self._detach_volume(context, instance, bdm)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3732, in _detach_volume\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     self.volume_api.roll_detaching(context, volume_id)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3725, in _detach_volume\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     encryption=encryption)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1205, in detach_volume\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp     raise exception.DiskNotFound(location=disk_dev)\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp DiskNotFound: No disk at vdc\n2013-10-18 16:58:11.296 2478 TRACE nova.openstack.common.rpc.amqp \n2013-10-18 16:58:11.298 2478 DEBUG qpid.messaging.io.raw [-] SENT[2fa6cb0]: '\\x0f\\x01\\x00\\x19\\x00\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x04\\n\\x01\\x00\\x07\\x00\\x010\\x00\\x00\\x00\\x00\\x01\\x0f\\x00\\x00\\x1a\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x02\\n\\x01\\x00\\x0\n0\\x08\\x00\\x00\\x00\\x00\\x00\\x00\\x14\\xb5' writeable /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:480\n2013-10-18 16:58:14.265 2478 DEBUG qpid.messaging.io.raw [-] READ[2fa6cb0]: '\\x0f\\x00\\x00\\x10\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\n\\x00\\x00' readable /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:416\n2013-10-18 16:58:14.266 2478 DEBUG qpid.messaging.io.ops [-] RCVD[2fa6cb0]: ConnectionHeartbeat() write /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:654\n2013-10-18 16:58:14.291 2478 DEBUG qpid.messaging.io.raw [-] READ[2fca998]: '\\x0f\\x00\\x00\\x10\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\n\\x00\\x00' readable /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:416\n2013-10-18 16:58:14.291 2478 DEBUG qpid.messaging.io.ops [-] RCVD[2fca998]: ConnectionHeartbeat() write /usr/lib/python2.6/site-packages/qpid/messaging/driver.py:654\n2013-10-18 16:58:15.019 2478 DEBUG nova.openstack.common.periodic_task [-] Running periodic task ComputeManager._poll_volume_usage run_periodic_tasks /usr/lib/python2.6/site-packages/nova/openstack/common/periodic_task.py:176\n2013-10-18 16:58:15.024 2478 DEBUG nova.openstack.common.periodic_task [-] Running periodic task ComputeManager._instance_usage_audit run_periodic_tasks /usr/lib/python2.6/site-packages/nova/openstack/common/periodic_task.py:176\n2013-10-18 16:58:15.024 2478 DEBUG nova.openstack.common.periodic_task [-] Running periodic task ComputeManager.update_available_resource run_periodic_tasks /usr/lib/python2.6/site-packages/nova/openstack/common/periodic_task.py:176\n2013-10-18 16:58:15.025 2478 DEBUG nova.openstack.common.lockutils [-] Got semaphore \"compute_resources\" lock /usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py:166\n2013-10-18 16:58:15.025 2478 DEBUG nova.openstack.common.lockutils [-] Got semaphore / lock \"update_available_resource\" inner /usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py:245\n2013-10-18 16:58:15.025 2478 AUDIT nova.compute.resource_tracker [-] Auditing locally available compute resources", 
            "date_created": "2013-10-18 14:04:40.290289+00:00", 
            "author": "https://api.launchpad.net/1.0/~dron-3"
        }, 
        {
            "content": "Was able to reproduce this - the issue is that in compute manager's rebuild_instance method does\n\nif bdms is None:\n                bdms = self.conductor_api.\\\n                        block_device_mapping_get_all_by_instance(\n                                context, instance)\n\nWhich will return the old style (legacy) bdm format if called without legacy=True. Since https://review.openstack.org/#/c/39086/ - it is only possible to pass the new format to _prep_block_device (whcih follows soon after in the control flow of the method) and this causes the volume to be disregarded.", 
            "date_created": "2013-10-29 19:22:37.739323+00:00", 
            "author": "https://api.launchpad.net/1.0/~ndipanov"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/54545", 
            "date_created": "2013-10-30 14:02:27.833918+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/54572", 
            "date_created": "2013-10-30 16:09:51.296989+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/70136", 
            "date_created": "2014-01-30 15:16:11.300070+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/70136\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=effa12e8711ff6e23aa2d4b40f4e9f248e141915\nSubmitter: Jenkins\nBranch:    master\n\ncommit effa12e8711ff6e23aa2d4b40f4e9f248e141915\nAuthor: Nikola Dipanov <email address hidden>\nDate:   Thu Jan 30 14:31:11 2014 +0100\n\n    Move rebuild to BDM objects\n    \n    This patch makes the rebuild code path use new-world block device\n    mapping objects.\n    \n    Closes-bug: #1241615\n    Part of blueprint: clean-up-legacy-block-device-mapping\n    Part of blueprint: icehouse-objects\n    \n    Change-Id: Id09dba6560b6c0624f9b7fbfa893360a2a3d41b6\n", 
            "date_created": "2014-03-04 17:29:09.533502+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}