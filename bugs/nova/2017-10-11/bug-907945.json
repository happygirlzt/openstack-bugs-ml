{
    "status": "Invalid", 
    "last_updated": "2012-06-07 12:42:04.457922+00:00", 
    "description": "Keys end up as unicode in keystone middleware's _cache_get() / _cache_put() (keystone/middleware/auth_token.py)\n\nTriggered on an otherwise functioning nova-api + keystone setup (each on seperate servers) after enabling caching on the nova-api server (memcache_hosts = 127.0.0.1:11211)   Explicitly converting the keys to strings in each function is a workaround, but I'm not sure the solution since the issue doesn't affect swift-proxy's use of the middleware (although that is triggering type errors in the same methods for different variables)\n\n\n(nova.api): TRACE: Traceback (most recent call last):\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 57, in __call__\n(nova.api): TRACE:     return req.get_response(self.application)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1086, in get_response\n(nova.api): TRACE:     application, catch_exc_info=False)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1055, in call_application\n(nova.api): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 147, in __call__\n(nova.api): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 210, in call_func\n(nova.api): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 69, in __call__\n(nova.api): TRACE:     rv = req.get_response(self.application)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1086, in get_response\n(nova.api): TRACE:     application, catch_exc_info=False)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1055, in call_application\n(nova.api): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n(nova.api): TRACE:     return resp(environ, start_response)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 270, in __call__\n(nova.api): TRACE:     claims = self._verify_claims(env, token)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 400, in _verify_claims\n(nova.api): TRACE:     cached_claims = self._cache_get(env, claims)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 362, in _cache_get\n(nova.api): TRACE:     cached_claims = cache.get(key)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 862, in get\n(nova.api): TRACE:     return self._get('get', key)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 813, in _get\n(nova.api): TRACE:     self.check_key(key)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 1014, in check_key\n(nova.api): TRACE:     \"Keys must be str()'s, not unicode.  Convert your unicode \"\n(nova.api): TRACE: MemcachedStringEncodingError: Keys must be str()'s, not unicode.  Convert your unicode strings using mystring.encode(charset)!", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/907945", 
    "owner": "None", 
    "id": 907945, 
    "index": 2450, 
    "created": "2011-12-22 23:18:15.610300+00:00", 
    "title": "Enabling keystone caching  results in type errors in middleware", 
    "comments": [
        {
            "content": "Keys end up as unicode in keystone middleware's _cache_get() / _cache_put() (keystone/middleware/auth_token.py)\n\nTriggered on an otherwise functioning nova-api + keystone setup (each on seperate servers) after enabling caching on the nova-api server (memcache_hosts = 127.0.0.1:11211)   Explicitly converting the keys to strings in each function is a workaround, but I'm not sure the solution since the issue doesn't affect swift-proxy's use of the middleware (although that is triggering type errors in the same methods for different variables)\n\n\n(nova.api): TRACE: Traceback (most recent call last):\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 57, in __call__\n(nova.api): TRACE:     return req.get_response(self.application)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1086, in get_response\n(nova.api): TRACE:     application, catch_exc_info=False)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1055, in call_application\n(nova.api): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 147, in __call__\n(nova.api): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 210, in call_func\n(nova.api): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 69, in __call__\n(nova.api): TRACE:     rv = req.get_response(self.application)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1086, in get_response\n(nova.api): TRACE:     application, catch_exc_info=False)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1055, in call_application\n(nova.api): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n(nova.api): TRACE:     return resp(environ, start_response)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 270, in __call__\n(nova.api): TRACE:     claims = self._verify_claims(env, token)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 400, in _verify_claims\n(nova.api): TRACE:     cached_claims = self._cache_get(env, claims)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 362, in _cache_get\n(nova.api): TRACE:     cached_claims = cache.get(key)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 862, in get\n(nova.api): TRACE:     return self._get('get', key)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 813, in _get\n(nova.api): TRACE:     self.check_key(key)\n(nova.api): TRACE:   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 1014, in check_key\n(nova.api): TRACE:     \"Keys must be str()'s, not unicode.  Convert your unicode \"\n(nova.api): TRACE: MemcachedStringEncodingError: Keys must be str()'s, not unicode.  Convert your unicode strings using mystring.encode(charset)!", 
            "date_created": "2011-12-22 23:18:15.610300+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "I'm sorry, but I don't quite understand what the the solution is here. Can you explain what exactly you are caching and what is causing that data to be utf8?", 
            "date_created": "2012-01-26 23:08:46.637061+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "IIUC this should be closed on Nova's side as well. Please reopen if you disagree.", 
            "date_created": "2012-06-07 12:42:00.173390+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }
    ]
}