{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:58:52.423811+00:00", 
    "description": "I can't delete an instance when using postgresql, because the code is passing an integer instance id where a UUID is expected to instance_info_cache_delete_by_instance_id.  I expect the bug also exists on MySQL, but MySQL is much more liberal with parameter conversion, though the data won't be deleted.\n\n\n2011-12-12 01:56:01,892 DEBUG nova.api [092ca398-491c-c49c-e6b0-d9de0123a2c3 e51d453d-e88d-ed8d-886f-f7f91f111a2d e51d453d-e88d-ed8d-886f-f7f91f111a2d] arg: InstanceId.1               val: i-00000001 from (pid=7157) __call__ /usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/api/ec2/__init__.py:253\n2011-12-12 01:56:01,892 DEBUG nova.api.ec2.cloud [092ca398-491c-c49c-e6b0-d9de0123a2c3 e51d453d-e88d-ed8d-886f-f7f91f111a2d e51d453d-e88d-ed8d-886f-f7f91f111a2d] Going to start terminating instances from (pid=7157) terminate_instances /usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/api/ec2/cloud.py:1296\n2011-12-12 01:56:01,957 DEBUG nova.compute.api [092ca398-491c-c49c-e6b0-d9de0123a2c3 e51d453d-e88d-ed8d-886f-f7f91f111a2d e51d453d-e88d-ed8d-886f-f7f91f111a2d] Going to try to terminate a7da7be8-0369-cf4a-bfee-f7a74a2b029d from (pid=7157) delete /usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/compute/api.py:812\n2011-12-12 01:56:01,964 ERROR nova.api [092ca398-491c-c49c-e6b0-d9de0123a2c3 e51d453d-e88d-ed8d-886f-f7f91f111a2d e51d453d-e88d-ed8d-886f-f7f91f111a2d] Unexpected error raised: (ProgrammingError) operator does not exist: character varying = integer\nLINE 3: WHERE instance_info_caches.instance_id = 1\n                                               ^\nHINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.\n(nova.api): TRACE: Traceback (most recent call last):\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/api/ec2/__init__.py\", line 357, in __call__\n(nova.api): TRACE:     result = api_request.invoke(context)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/api/ec2/apirequest.py\", line 90, in invoke\n(nova.api): TRACE:     result = method(context, **args)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/api/ec2/cloud.py\", line 1300, in terminate_instances\n(nova.api): TRACE:     self.compute_api.delete(context, instance)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/scheduler/api.py\", line 321, in wrapped_f\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/compute/api.py\", line 817, in delete\n(nova.api): TRACE:     self._delete(context, instance)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/compute/api.py\", line 807, in _delete\n(nova.api): TRACE:     self.db.instance_destroy(context, instance['id'])\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/api.py\", line 514, in instance_destroy\n(nova.api): TRACE:     return IMPL.instance_destroy(context, instance_id)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1136, in instance_destroy\n(nova.api): TRACE:     session=session)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1625, in instance_info_cache_delete_by_instance_id\n(nova.api): TRACE:     instance_info_cache_update(context, instance_id, values, session)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1605, in instance_info_cache_update\n(nova.api): TRACE:     session=session)\n\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1625, in instance_info_cache_delete_by_instance_id\n(nova.api): TRACE:     instance_info_cache_update(context, instance_id, values, session)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1605, in instance_info_cache_update\n(nova.api): TRACE:     session=session)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1589, in instance_info_cache_get\n(nova.api): TRACE:     filter_by(instance_id=instance_id).\\\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/orm/query.py\", line 1988, in first\n(nova.api): TRACE:     ret = list(self[0:1])\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/orm/query.py\", line 1882, in __getitem__\n(nova.api): TRACE:     return list(res)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/orm/query.py\", line 2057, in __iter__\n(nova.api): TRACE:     return self._execute_and_instances(context)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/orm/query.py\", line 2072, in _execute_and_instances\n(nova.api): TRACE:     result = conn.execute(querycontext.statement, self._params)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/engine/base.py\", line 1405, in execute\n(nova.api): TRACE:     params)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/engine/base.py\", line 1538, in _execute_clauseelement\n(nova.api): TRACE:     compiled_sql, distilled_params\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/engine/base.py\", line 1646, in _execute_context\n(nova.api): TRACE:     context)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/engine/base.py\", line 1639, in _execute_context\n(nova.api): TRACE:     context)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/engine/default.py\", line 330, in do_execute\n(nova.api): TRACE:     cursor.execute(statement, parameters)\n(nova.api): TRACE: ProgrammingError: (ProgrammingError) operator does not exist: character varying = integer\n(nova.api): TRACE: LINE 3: WHERE instance_info_caches.instance_id = 1\n(nova.api): TRACE:                                                ^\n(nova.api): TRACE: HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.\n(nova.api): TRACE:  'SELECT instance_info_caches.created_at AS instance_info_caches_created_at, instance_info_caches.updated_at AS instance_info_caches_updated_at, instance_info_caches.deleted_at AS instance_info_caches_deleted_at, instance_info_caches.deleted AS instance_info_caches_deleted, instance_info_caches.id AS instance_info_caches_id, instance_info_caches.network_info AS instance_info_caches_network_info, instance_info_caches.instance_id AS instance_info_caches_instance_id \\nFROM instance_info_caches \\nWHERE instance_info_caches.instance_id = %(instance_id_1)s \\n LIMIT %(param_1)s' {'param_1': 1, 'instance_id_1': 1}", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/903497", 
    "owner": "https://api.launchpad.net/1.0/~alex-meade", 
    "id": 903497, 
    "index": 540, 
    "created": "2011-12-13 01:10:35.314435+00:00", 
    "title": "Confusion between UUID instance ID and integer ID in instance_info_cache_delete_by_instance_id", 
    "comments": [
        {
            "content": "I can't delete an instance when using postgresql, because the code is passing an integer instance id where a UUID is expected to instance_info_cache_delete_by_instance_id.  I expect the bug also exists on MySQL, but MySQL is much more liberal with parameter conversion, though the data won't be deleted.\n\n\n2011-12-12 01:56:01,892 DEBUG nova.api [092ca398-491c-c49c-e6b0-d9de0123a2c3 e51d453d-e88d-ed8d-886f-f7f91f111a2d e51d453d-e88d-ed8d-886f-f7f91f111a2d] arg: InstanceId.1               val: i-00000001 from (pid=7157) __call__ /usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/api/ec2/__init__.py:253\n2011-12-12 01:56:01,892 DEBUG nova.api.ec2.cloud [092ca398-491c-c49c-e6b0-d9de0123a2c3 e51d453d-e88d-ed8d-886f-f7f91f111a2d e51d453d-e88d-ed8d-886f-f7f91f111a2d] Going to start terminating instances from (pid=7157) terminate_instances /usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/api/ec2/cloud.py:1296\n2011-12-12 01:56:01,957 DEBUG nova.compute.api [092ca398-491c-c49c-e6b0-d9de0123a2c3 e51d453d-e88d-ed8d-886f-f7f91f111a2d e51d453d-e88d-ed8d-886f-f7f91f111a2d] Going to try to terminate a7da7be8-0369-cf4a-bfee-f7a74a2b029d from (pid=7157) delete /usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/compute/api.py:812\n2011-12-12 01:56:01,964 ERROR nova.api [092ca398-491c-c49c-e6b0-d9de0123a2c3 e51d453d-e88d-ed8d-886f-f7f91f111a2d e51d453d-e88d-ed8d-886f-f7f91f111a2d] Unexpected error raised: (ProgrammingError) operator does not exist: character varying = integer\nLINE 3: WHERE instance_info_caches.instance_id = 1\n                                               ^\nHINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.\n(nova.api): TRACE: Traceback (most recent call last):\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/api/ec2/__init__.py\", line 357, in __call__\n(nova.api): TRACE:     result = api_request.invoke(context)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/api/ec2/apirequest.py\", line 90, in invoke\n(nova.api): TRACE:     result = method(context, **args)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/api/ec2/cloud.py\", line 1300, in terminate_instances\n(nova.api): TRACE:     self.compute_api.delete(context, instance)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/scheduler/api.py\", line 321, in wrapped_f\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/compute/api.py\", line 817, in delete\n(nova.api): TRACE:     self._delete(context, instance)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/compute/api.py\", line 807, in _delete\n(nova.api): TRACE:     self.db.instance_destroy(context, instance['id'])\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/api.py\", line 514, in instance_destroy\n(nova.api): TRACE:     return IMPL.instance_destroy(context, instance_id)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1136, in instance_destroy\n(nova.api): TRACE:     session=session)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1625, in instance_info_cache_delete_by_instance_id\n(nova.api): TRACE:     instance_info_cache_update(context, instance_id, values, session)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1605, in instance_info_cache_update\n(nova.api): TRACE:     session=session)\n\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1625, in instance_info_cache_delete_by_instance_id\n(nova.api): TRACE:     instance_info_cache_update(context, instance_id, values, session)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1605, in instance_info_cache_update\n(nova.api): TRACE:     session=session)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n(nova.api): TRACE:     return f(*args, **kwargs)\n(nova.api): TRACE:   File \"/usr/lib/python2.6/site-packages/nova-2012.1-py2.6.egg/nova/db/sqlalchemy/api.py\", line 1589, in instance_info_cache_get\n(nova.api): TRACE:     filter_by(instance_id=instance_id).\\\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/orm/query.py\", line 1988, in first\n(nova.api): TRACE:     ret = list(self[0:1])\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/orm/query.py\", line 1882, in __getitem__\n(nova.api): TRACE:     return list(res)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/orm/query.py\", line 2057, in __iter__\n(nova.api): TRACE:     return self._execute_and_instances(context)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/orm/query.py\", line 2072, in _execute_and_instances\n(nova.api): TRACE:     result = conn.execute(querycontext.statement, self._params)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/engine/base.py\", line 1405, in execute\n(nova.api): TRACE:     params)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/engine/base.py\", line 1538, in _execute_clauseelement\n(nova.api): TRACE:     compiled_sql, distilled_params\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/engine/base.py\", line 1646, in _execute_context\n(nova.api): TRACE:     context)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/engine/base.py\", line 1639, in _execute_context\n(nova.api): TRACE:     context)\n(nova.api): TRACE:   File \"build/bdist.solaris-2.11-i86pc/egg/sqlalchemy/engine/default.py\", line 330, in do_execute\n(nova.api): TRACE:     cursor.execute(statement, parameters)\n(nova.api): TRACE: ProgrammingError: (ProgrammingError) operator does not exist: character varying = integer\n(nova.api): TRACE: LINE 3: WHERE instance_info_caches.instance_id = 1\n(nova.api): TRACE:                                                ^\n(nova.api): TRACE: HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.\n(nova.api): TRACE:  'SELECT instance_info_caches.created_at AS instance_info_caches_created_at, instance_info_caches.updated_at AS instance_info_caches_updated_at, instance_info_caches.deleted_at AS instance_info_caches_deleted_at, instance_info_caches.deleted AS instance_info_caches_deleted, instance_info_caches.id AS instance_info_caches_id, instance_info_caches.network_info AS instance_info_caches_network_info, instance_info_caches.instance_id AS instance_info_caches_instance_id \\nFROM instance_info_caches \\nWHERE instance_info_caches.instance_id = %(instance_id_1)s \\n LIMIT %(param_1)s' {'param_1': 1, 'instance_id_1': 1}", 
            "date_created": "2011-12-13 01:10:35.314435+00:00", 
            "author": "https://api.launchpad.net/1.0/~justin-fathomdb"
        }, 
        {
            "content": "This is true! It's as simple as instance_destroy passes instance id instead of instance uuid into instance_info_cache_delete in nova/db/sqlalchemy/api.py.", 
            "date_created": "2012-01-11 16:02:50.156857+00:00", 
            "author": "https://api.launchpad.net/1.0/~alex-meade"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/2972", 
            "date_created": "2012-01-11 19:44:23.334185+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2972\nCommitted: http://github.com/openstack/nova/commit/26b7b9457a5899ecca93fd67d3879efcad4e4968\nSubmitter: Jenkins\nBranch:    master\n\ncommit 26b7b9457a5899ecca93fd67d3879efcad4e4968\nAuthor: Alex Meade <email address hidden>\nDate:   Wed Jan 11 19:43:26 2012 +0000\n\n    Call to instance_info_cache_delete to use uuid\n    \n    Fixes bug 903497\n    Also updated incorrect calls to instance_destroy that were using uuids.\n    \n    Change-Id: I25eead020ceb7ebf7234c268543ad77d8ecf1185\n", 
            "date_created": "2012-01-12 00:02:42.167447+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}