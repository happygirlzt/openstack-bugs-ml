{
    "status": "Confirmed", 
    "last_updated": "2017-09-27 16:35:26.943746+00:00", 
    "description": "Description\n===========\n\nFresh Install\n\nUbuntu 16.04\n\nI followed Ubuntu install guide up to Install Nova on Controller, I configured Nova.conf and specified api_database and database connection string with SSL/TLS Parameters, then ran the DB commands. The following are successful. \n\nsu -s /bin/sh -c \"nova-manage api_db sync\" nova\nsu -s /bin/sh -c \"nova-manage cell_v2 map_cell0\" nova\nsu -s /bin/sh -c \"nova-manage cell_v2 create_cell --name=cell1 --verbose\" nova\n\nThe following command fails with error\n\nsu -s /bin/sh -c \"nova-manage db sync\" nova\n\nERROR: could not access cell mapping database - has api db been created?\n\nMy connection string is as follows\n\nconnection = mysql+pymysql://nova:my_password@my_IP/nova_api?charset=utf8&ssl_ca=/etc/nova/tls/mysql/ca-cert.pem&ssl_cert=/etc/nova/tls/mysql/server-cert.pem&ssl_key=/etc/nova/tls/mysql/server-key.pem\n\n\nThe following connection string is what appears in the database table\n\nmysql+pymysql://nova:4f35d884c9960df0ac80@10.30.0.2/nova?charset=utf8&ssl_ca=/etc/nova/tls/mysql/ca-cert.pem&ssl_cert=/etc/nova/tls/mysql/server-cert.pem&ssl_key=/etc/nova/tls/mysql/server-key.pemnova_cell0\n\n\n<mriedem> on #openstack-nova suggests that this is a string substitution bug.\n\nSteps to reproduce\n===============\n\n1. Install Ubuntu 16.04 \n2. Install Keystone \n3. Configure Database connection string with TLS/SSL Parameters  \n4. Install Glance\n5. Configure Database connection string with TLS/SSL Parameters \n6. Install Nova\n7. Configure Database connection string with TLS/SSL Parameters\n8. Run the DB sync commands in order from the Docs\nFailure at > su -s /bin/sh -c \"nova-manage db sync\" nova\n\n\n\nExpected result\n===============\nNova database Populates without error\n\nActual result\n=============\nNova database does not populate and following error thrown\n\nERROR: could not access cell mapping database - has api db been created?\n\n\nEnvironment\n===========\nOcata\n\nUbuntu cloud Archive\n\n\n\nnova-api                           2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - API frontend\nnova-common                        2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - common files\nnova-conductor                     2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - conductor service\nnova-consoleauth                   2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - Console Authenticator\nnova-novncproxy                    2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - NoVNC proxy\nnova-placement-api                 2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - placement API frontend\nnova-scheduler                     2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - virtual machine scheduler\npython-nova                        2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute Python libraries\npython-novaclient                  2:7.1.0-0ubuntu1~cloud0                    all          client library for OpenStack Compute API - Python 2.7\n\nOpenVSwitch\n\nKVM\n\nLogs & Configs\n==============\n[DEFAULT]\n#debug = true\n#####################################\n#dhcpbridge_flagfile=/etc/nova/nova.conf\n#dhcpbridge=/usr/bin/nova-dhcpbridge\n#force_dhcp_release=true\n#####################################\nmy_ip = my_ip\nstate_path = /var/lib/nova\n####\nenabled_apis = osapi_compute,metadata\nenabled_ssl_apis = osapi_compute,metadata\n####\nosapi_compute_listen = my_ip\nosapi_compute_listen_port = 8774\n####\nmetadata_host = $my_ip\nmetadata_listen = my_ip\nmetadata_listen_port = 8775\nmetadata_port = 8775\n#####\nrootwrap_config = /etc/nova/rootwrap.conf\napi_paste_config = /etc/nova/api-paste.ini\nlog_dir = /var/log/nova\nuse_neutron = True\nfirewall_driver = nova.virt.firewall.NoopFirewallDriver\n######\ncert = /etc/nova/tls/server-cert.pem\nkey = /etc/nova/tls/server-key.pem\nssl_only = True\n\ntransport_url = rabbit://controller01:my_password@my_ip\n\ncompute_api_class=nova.compute.cells_api.ComputeCellsAPI\n\n[api]\nauth_strategy = keystone\n\n[api_database]\nconnection = mysql+pymysql://nova:my_password@my_ip/nova_api?charset=utf8&ssl_ca=/etc/nova/tls/mysql/ca-cert.pem&ssl_cert=/etc/nova/tls/mysql/server-cert.pem&ssl_key=/etc/nova/tls/mysql/server-key.pem\n\n#connection_debug = 1\n\n[barbican]\n[cache]\n[cells]\nenable=True\ncell_type = api\n[cinder]\n[cloudpipe]\n[conductor]\n[console]\n[consoleauth]\n\n[cors]\n[cors.subdomain]\n[crypto]\n##\ncert_file = /etc/nova/tls/server-cert.pem\nkey_file = /etc/nova/tls/server-key.pem\nca_file = /etc/nova/tls/ca-cert.pem\n##\n[database]\nconnection = mysql+pymysql://nova:my_password@my_ip/nova?charset=utf8&ssl_ca=/etc/nova/tls/mysql/ca-cert.pem&ssl_cert=/etc/nova/tls/mysql/server-cert.pem&ssl_key=/etc/nova/tls/mysql/server-key.pem\n\n#connection_debug = 1\n\n[ephemeral_storage_encryption]\n[filter_scheduler]\n[glance]\napi_servers = https://my_ip:9292\napi_insecure = False\n[guestfs]\n[healthcheck]\n[hyperv]\n[image_file_url]\n[ironic]\n[key_manager]\n[keystone_authtoken]\nauth_uri = https://my_ip:5000\nauth_url = https://my_ip:35357\nmemcached_servers = my_ip:11211\nauth_type = password\nproject_domain_name = default\nuser_domain_name = default\nproject_name = service\nusername = nova\npassword = my_password\n###\ncertfile = /etc/nova/tls/server-cert.pem\nkeyfile = /etc/nova/tls/server-key.pem\ncafile = /etc/nova/tls/ca-cert.pem\nservice_token_roles_required = True\n###\n[libvirt]\n[matchmaker_redis]\n[metrics]\n[mks]\n[neutron]\n[notifications]\n[osapi_v21]\n[oslo_concurrency]\nlock_path=/var/lib/nova/tmp\n[oslo_messaging_amqp]\n[oslo_messaging_kafka]\n[oslo_messaging_notifications]\n[oslo_messaging_rabbit]\nrabbit_use_ssl = True\nkombu_ssl_keyfile = /etc/nova/tls/server-key.pem\nkombu_ssl_certfile = /etc/nova/tls/server-cert.pem\nkombu_ssl_ca_certs = /etc/nova/tls/ca-cert.pem\nkombu_ssl_version = TLSv1_2\nrpc_reply_retry_attempts = 10\nrpc_retry_delay = 10.0\nsocket_timeout = 0.25\ntcp_user_timeout = 10.0\t\n[oslo_messaging_zmq]\n[oslo_middleware]\n[oslo_policy]\n[pci]\n[placement]\nos_region_name = RegionOne\nproject_domain_name = Default\nproject_name = service\nuser_domain_name = Default\nusername = placement\npassword = my_password\nauth_url = https://my_IP:35357/v3\nauth_type = password\ncertfile = /etc/nova/tls/server-cert.pem\nkeyfile = /etc/nova/tls/server-key.pem\ncafile = /etc/nova/tls/ca-cert.pem\ninsecure = False\n[quota]\n[rdp]\n[remote_debug]\n[scheduler]\n[serial_console]\n[service_user]\n[spice]\n[ssl]\ncert_file = /etc/nova/tls/server-cert.pem\nkey_file = /etc/nova/tls/server-key.pem\nca_file = /etc/nova/tls/ca-cert.pem\nciphers = AES256-GCM-SHA384\nversion = TLSv1_2\n[trusted_computing]\n[upgrade_levels]\n[vendordata_dynamic_auth]\n[vmware]\n[vnc]\nenabled = True\nvncserver_listen = 0.0.0.0\nvncserver_proxyclient_address = $my_ip\nnovncproxy_base_url = https://my_IP:6080/vnc_auto.html\n\n[workarounds]\n[wsgi]\napi_paste_config=/etc/nova/api-paste.ini\nsecure_proxy_ssl_header = https\nssl_key_file = /etc/nova/tls/server-key.pem\nssl_cert_file = /etc/nova/tls/server-cert.pem\nssl_ca_file = /etc/nova/tls/ca-cert.pem\n\n[xenserver]\n[xvp]", 
    "tags": [
        "in-stable-ocata", 
        "in-stable-pike"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1706118", 
    "owner": "None", 
    "id": 1706118, 
    "index": 2113, 
    "created": "2017-07-24 16:27:30.777932+00:00", 
    "title": "Adding TLS Connection String To Database Connection Causes malformed URL in cell_mappings DB", 
    "comments": [
        {
            "content": "Description\n===========\n\nFresh Install\n\nUbuntu 16.04\n\nI followed Ubuntu install guide up to Install Nova on Controller, I configured Nova.conf and specified api_database and database connection string with SSL/TLS Parameters, then ran the DB commands. The following are successful. \n\nsu -s /bin/sh -c \"nova-manage api_db sync\" nova\nsu -s /bin/sh -c \"nova-manage cell_v2 map_cell0\" nova\nsu -s /bin/sh -c \"nova-manage cell_v2 create_cell --name=cell1 --verbose\" nova\n\nThe following command fails with error\n\nsu -s /bin/sh -c \"nova-manage db sync\" nova\n\nERROR: could not access cell mapping database - has api db been created?\n\nMy connection string is as follows\n\nconnection = mysql+pymysql://nova:my_password@my_IP/nova_api?charset=utf8&ssl_ca=/etc/nova/tls/mysql/ca-cert.pem&ssl_cert=/etc/nova/tls/mysql/server-cert.pem&ssl_key=/etc/nova/tls/mysql/server-key.pem\n\n\nThe following connection string is what appears in the database table\n\nmysql+pymysql://nova:4f35d884c9960df0ac80@10.30.0.2/nova?charset=utf8&ssl_ca=/etc/nova/tls/mysql/ca-cert.pem&ssl_cert=/etc/nova/tls/mysql/server-cert.pem&ssl_key=/etc/nova/tls/mysql/server-key.pemnova_cell0\n\n\n<mriedem> on #openstack-nova suggests that this is a string substitution bug.\n\nSteps to reproduce\n===============\n\n1. Install Ubuntu 16.04 \n2. Install Keystone \n3. Configure Database connection string with TLS/SSL Parameters  \n4. Install Glance\n5. Configure Database connection string with TLS/SSL Parameters \n6. Install Nova\n7. Configure Database connection string with TLS/SSL Parameters\n8. Run the DB sync commands in order from the Docs\nFailure at > su -s /bin/sh -c \"nova-manage db sync\" nova\n\n\n\nExpected result\n===============\nNova database Populates without error\n\nActual result\n=============\nNova database does not populate and following error thrown\n\nERROR: could not access cell mapping database - has api db been created?\n\n\nEnvironment\n===========\nOcata\n\nUbuntu cloud Archive\n\n\n\nnova-api                           2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - API frontend\nnova-common                        2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - common files\nnova-conductor                     2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - conductor service\nnova-consoleauth                   2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - Console Authenticator\nnova-novncproxy                    2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - NoVNC proxy\nnova-placement-api                 2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - placement API frontend\nnova-scheduler                     2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute - virtual machine scheduler\npython-nova                        2:15.0.5-0ubuntu1~cloud0                   all          OpenStack Compute Python libraries\npython-novaclient                  2:7.1.0-0ubuntu1~cloud0                    all          client library for OpenStack Compute API - Python 2.7\n\nOpenVSwitch\n\nKVM\n\nLogs & Configs\n==============\n[DEFAULT]\n#debug = true\n#####################################\n#dhcpbridge_flagfile=/etc/nova/nova.conf\n#dhcpbridge=/usr/bin/nova-dhcpbridge\n#force_dhcp_release=true\n#####################################\nmy_ip = my_ip\nstate_path = /var/lib/nova\n####\nenabled_apis = osapi_compute,metadata\nenabled_ssl_apis = osapi_compute,metadata\n####\nosapi_compute_listen = my_ip\nosapi_compute_listen_port = 8774\n####\nmetadata_host = $my_ip\nmetadata_listen = my_ip\nmetadata_listen_port = 8775\nmetadata_port = 8775\n#####\nrootwrap_config = /etc/nova/rootwrap.conf\napi_paste_config = /etc/nova/api-paste.ini\nlog_dir = /var/log/nova\nuse_neutron = True\nfirewall_driver = nova.virt.firewall.NoopFirewallDriver\n######\ncert = /etc/nova/tls/server-cert.pem\nkey = /etc/nova/tls/server-key.pem\nssl_only = True\n\ntransport_url = rabbit://controller01:my_password@my_ip\n\ncompute_api_class=nova.compute.cells_api.ComputeCellsAPI\n\n[api]\nauth_strategy = keystone\n\n[api_database]\nconnection = mysql+pymysql://nova:my_password@my_ip/nova_api?charset=utf8&ssl_ca=/etc/nova/tls/mysql/ca-cert.pem&ssl_cert=/etc/nova/tls/mysql/server-cert.pem&ssl_key=/etc/nova/tls/mysql/server-key.pem\n\n#connection_debug = 1\n\n[barbican]\n[cache]\n[cells]\nenable=True\ncell_type = api\n[cinder]\n[cloudpipe]\n[conductor]\n[console]\n[consoleauth]\n\n[cors]\n[cors.subdomain]\n[crypto]\n##\ncert_file = /etc/nova/tls/server-cert.pem\nkey_file = /etc/nova/tls/server-key.pem\nca_file = /etc/nova/tls/ca-cert.pem\n##\n[database]\nconnection = mysql+pymysql://nova:my_password@my_ip/nova?charset=utf8&ssl_ca=/etc/nova/tls/mysql/ca-cert.pem&ssl_cert=/etc/nova/tls/mysql/server-cert.pem&ssl_key=/etc/nova/tls/mysql/server-key.pem\n\n#connection_debug = 1\n\n[ephemeral_storage_encryption]\n[filter_scheduler]\n[glance]\napi_servers = https://my_ip:9292\napi_insecure = False\n[guestfs]\n[healthcheck]\n[hyperv]\n[image_file_url]\n[ironic]\n[key_manager]\n[keystone_authtoken]\nauth_uri = https://my_ip:5000\nauth_url = https://my_ip:35357\nmemcached_servers = my_ip:11211\nauth_type = password\nproject_domain_name = default\nuser_domain_name = default\nproject_name = service\nusername = nova\npassword = my_password\n###\ncertfile = /etc/nova/tls/server-cert.pem\nkeyfile = /etc/nova/tls/server-key.pem\ncafile = /etc/nova/tls/ca-cert.pem\nservice_token_roles_required = True\n###\n[libvirt]\n[matchmaker_redis]\n[metrics]\n[mks]\n[neutron]\n[notifications]\n[osapi_v21]\n[oslo_concurrency]\nlock_path=/var/lib/nova/tmp\n[oslo_messaging_amqp]\n[oslo_messaging_kafka]\n[oslo_messaging_notifications]\n[oslo_messaging_rabbit]\nrabbit_use_ssl = True\nkombu_ssl_keyfile = /etc/nova/tls/server-key.pem\nkombu_ssl_certfile = /etc/nova/tls/server-cert.pem\nkombu_ssl_ca_certs = /etc/nova/tls/ca-cert.pem\nkombu_ssl_version = TLSv1_2\nrpc_reply_retry_attempts = 10\nrpc_retry_delay = 10.0\nsocket_timeout = 0.25\ntcp_user_timeout = 10.0\t\n[oslo_messaging_zmq]\n[oslo_middleware]\n[oslo_policy]\n[pci]\n[placement]\nos_region_name = RegionOne\nproject_domain_name = Default\nproject_name = service\nuser_domain_name = Default\nusername = placement\npassword = my_password\nauth_url = https://my_IP:35357/v3\nauth_type = password\ncertfile = /etc/nova/tls/server-cert.pem\nkeyfile = /etc/nova/tls/server-key.pem\ncafile = /etc/nova/tls/ca-cert.pem\ninsecure = False\n[quota]\n[rdp]\n[remote_debug]\n[scheduler]\n[serial_console]\n[service_user]\n[spice]\n[ssl]\ncert_file = /etc/nova/tls/server-cert.pem\nkey_file = /etc/nova/tls/server-key.pem\nca_file = /etc/nova/tls/ca-cert.pem\nciphers = AES256-GCM-SHA384\nversion = TLSv1_2\n[trusted_computing]\n[upgrade_levels]\n[vendordata_dynamic_auth]\n[vmware]\n[vnc]\nenabled = True\nvncserver_listen = 0.0.0.0\nvncserver_proxyclient_address = $my_ip\nnovncproxy_base_url = https://my_IP:6080/vnc_auto.html\n\n[workarounds]\n[wsgi]\napi_paste_config=/etc/nova/api-paste.ini\nsecure_proxy_ssl_header = https\nssl_key_file = /etc/nova/tls/server-key.pem\nssl_cert_file = /etc/nova/tls/server-cert.pem\nssl_ca_file = /etc/nova/tls/ca-cert.pem\n\n[xenserver]\n[xvp]", 
            "date_created": "2017-07-24 16:27:30.777932+00:00", 
            "author": "https://api.launchpad.net/1.0/~k.s-dean"
        }, 
        {
            "content": "", 
            "date_created": "2017-07-24 16:27:30.777932+00:00", 
            "author": "https://api.launchpad.net/1.0/~k.s-dean"
        }, 
        {
            "content": "As noted in IRC, it sounds like another variant of bug 1673613 which was fixed in Ocata 15.0.5:\n\nhttps://docs.openstack.org/releasenotes/nova/ocata.html#id1\n\nWhich is what's being used here, so probably another case we need to handle in this code:\n\nhttps://github.com/openstack/nova/blob/321f426c30f8f4f6e3dcafbbc7e5d87560b58c82/nova/cmd/manage.py#L1190-L1204\n\nAnd that's parsed from the nova (cell1) database connection string, which from above is this:\n\n\"mysql+pymysql://nova:my_password@my_ip/nova?charset=utf8&ssl_ca=/etc/nova/tls/mysql/ca-cert.pem&ssl_cert=/etc/nova/tls/mysql/server-cert.pem&ssl_key=/etc/nova/tls/mysql/server-key.pem\"", 
            "date_created": "2017-07-24 18:01:19.743234+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "The workaround for now is specify the --database_connection option with the 'nova-manage cell_v2 map_cell0' command to avoid the command messing up the URL stored for the cell0 mapping in the nova_api.cell_mappings table.", 
            "date_created": "2017-07-24 18:02:49.688498+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/486660\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=05f3d9d39b7b95fac343ba431855482a5d96584a\nSubmitter: Jenkins\nBranch:    master\n\ncommit 05f3d9d39b7b95fac343ba431855482a5d96584a\nAuthor: Matt Riedemann <email address hidden>\nDate:   Mon Jul 24 11:30:35 2017 -0400\n\n    Provide hints when nova-manage db sync fails to sync cell0\n    \n    Lots of people get tripped up on the error message when\n    syncing cell0 fails and the question asked is confusing and\n    possibly misleading, so this change includes several questions\n    for troubleshooting and also dumps the actual error message.\n    \n    Related-Bug: #1706118\n    \n    Change-Id: I865f76705f10493152af50b9842c6fedc563fea4\n", 
            "date_created": "2017-09-07 02:23:55.629836+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: stable/pike\nReview: https://review.openstack.org/501745", 
            "date_created": "2017-09-07 13:49:41.455178+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/501746", 
            "date_created": "2017-09-07 13:49:55.190421+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/501745\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=423c7bbdb99e14fd49681dd58edd348060f25005\nSubmitter: Jenkins\nBranch:    stable/pike\n\ncommit 423c7bbdb99e14fd49681dd58edd348060f25005\nAuthor: Matt Riedemann <email address hidden>\nDate:   Mon Jul 24 11:30:35 2017 -0400\n\n    Provide hints when nova-manage db sync fails to sync cell0\n    \n    Lots of people get tripped up on the error message when\n    syncing cell0 fails and the question asked is confusing and\n    possibly misleading, so this change includes several questions\n    for troubleshooting and also dumps the actual error message.\n    \n    Related-Bug: #1706118\n    \n    Change-Id: I865f76705f10493152af50b9842c6fedc563fea4\n    (cherry picked from commit 05f3d9d39b7b95fac343ba431855482a5d96584a)\n", 
            "date_created": "2017-09-15 22:19:47.440768+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/501746\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b55ca354463a387d79e265701dd78cf3a51e457f\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit b55ca354463a387d79e265701dd78cf3a51e457f\nAuthor: Matt Riedemann <email address hidden>\nDate:   Mon Jul 24 11:30:35 2017 -0400\n\n    Provide hints when nova-manage db sync fails to sync cell0\n    \n    Lots of people get tripped up on the error message when\n    syncing cell0 fails and the question asked is confusing and\n    possibly misleading, so this change includes several questions\n    for troubleshooting and also dumps the actual error message.\n    \n    Related-Bug: #1706118\n    \n    Change-Id: I865f76705f10493152af50b9842c6fedc563fea4\n    (cherry picked from commit 05f3d9d39b7b95fac343ba431855482a5d96584a)\n", 
            "date_created": "2017-09-27 16:35:25.211938+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}