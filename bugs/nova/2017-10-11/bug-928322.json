{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:13:19.876398+00:00", 
    "description": "The recent 075 migration fails with this traceback on my development system:\n\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/bin/nova-manage\", line 2382, in <module>\n(nova): TRACE:     main()\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/bin/nova-manage\", line 2369, in main\n(nova): TRACE:     fn(*fn_args, **fn_kwargs)\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/bin/nova-manage\", line 1193, in sync\n(nova): TRACE:     return migration.db_sync(version)\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/nova/db/migration.py\", line 35, in db_sync\n(nova): TRACE:     return IMPL.db_sync(version=version)\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/nova/db/sqlalchemy/migration.py\", line 51, in db_sync\n(nova): TRACE:     return versioning_api.upgrade(FLAGS.sql_connection, repo_path, version)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n(nova): TRACE:     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n(nova): TRACE:   File \"<string>\", line 2, in _migrate\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/migrate/versioning/util/__init__.py\", line 159, in with_engine\n(nova): TRACE:     return f(*a, **kw)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/migrate/versioning/api.py\", line 365, in _migrate\n(nova): TRACE:     schema.runchange(ver, change, changeset.step)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/migrate/versioning/schema.py\", line 84, in runchange\n(nova): TRACE:     change.run(self.engine, step)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/migrate/versioning/script/py.py\", line 145, in run\n(nova): TRACE:     script_func(engine)\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/nova/db/sqlalchemy/migrate_repo/versions/075_convert_bw_usage_to_store_network_id.py\", line 54, in upgrade\n(nova): TRACE:     networks.c.id == vifs.c.network_id))\\\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/sql/expression.py\", line 1217, in execute\n(nova): TRACE:     return e._execute_clauseelement(self, multiparams, params)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1722, in _execute_clauseelement\n(nova): TRACE:     return connection._execute_clauseelement(elem, multiparams, params)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n(nova): TRACE:     return self.__execute_context(context)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n(nova): TRACE:     context.parameters[0], context=context)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n(nova): TRACE:     context)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n(nova): TRACE:     context)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/default.py\", line 288, in do_execute\n(nova): TRACE:     cursor.execute(statement, parameters)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/MySQLdb/cursors.py\", line 166, in execute\n(nova): TRACE:     self.errorhandler(self, exc, value)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/MySQLdb/connections.py\", line 35, in defaulterrorhandler\n(nova): TRACE:     raise errorclass, errorvalue\n(nova): TRACE: OperationalError: (OperationalError) (1242, 'Subquery returns more than 1 row') 'UPDATE bw_usage_cache SET updated_at=%s, mac=(SELECT virtual_interfaces.address \\nFROM virtual_interfaces, networks \\nWHERE networks.label = bw_usage_cache.network_label AND networks.id = virtual_interfaces.network_id)' (datetime.datetime(2012, 2, 7, 15, 47, 20, 996688),)", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/928322", 
    "owner": "https://api.launchpad.net/1.0/~jason-koelker", 
    "id": 928322, 
    "index": 2533, 
    "created": "2012-02-07 15:49:38.726558+00:00", 
    "title": "075 migration fails with OperationalError", 
    "comments": [
        {
            "content": "The recent 075 migration fails with this traceback on my development system:\n\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/bin/nova-manage\", line 2382, in <module>\n(nova): TRACE:     main()\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/bin/nova-manage\", line 2369, in main\n(nova): TRACE:     fn(*fn_args, **fn_kwargs)\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/bin/nova-manage\", line 1193, in sync\n(nova): TRACE:     return migration.db_sync(version)\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/nova/db/migration.py\", line 35, in db_sync\n(nova): TRACE:     return IMPL.db_sync(version=version)\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/nova/db/sqlalchemy/migration.py\", line 51, in db_sync\n(nova): TRACE:     return versioning_api.upgrade(FLAGS.sql_connection, repo_path, version)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n(nova): TRACE:     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n(nova): TRACE:   File \"<string>\", line 2, in _migrate\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/migrate/versioning/util/__init__.py\", line 159, in with_engine\n(nova): TRACE:     return f(*a, **kw)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/migrate/versioning/api.py\", line 365, in _migrate\n(nova): TRACE:     schema.runchange(ver, change, changeset.step)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/migrate/versioning/schema.py\", line 84, in runchange\n(nova): TRACE:     change.run(self.engine, step)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/migrate/versioning/script/py.py\", line 145, in run\n(nova): TRACE:     script_func(engine)\n(nova): TRACE:   File \"/home/johannes/openstack/nova/trunk/nova/db/sqlalchemy/migrate_repo/versions/075_convert_bw_usage_to_store_network_id.py\", line 54, in upgrade\n(nova): TRACE:     networks.c.id == vifs.c.network_id))\\\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/sql/expression.py\", line 1217, in execute\n(nova): TRACE:     return e._execute_clauseelement(self, multiparams, params)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1722, in _execute_clauseelement\n(nova): TRACE:     return connection._execute_clauseelement(elem, multiparams, params)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n(nova): TRACE:     return self.__execute_context(context)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n(nova): TRACE:     context.parameters[0], context=context)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n(nova): TRACE:     context)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n(nova): TRACE:     context)\n(nova): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/sqlalchemy/engine/default.py\", line 288, in do_execute\n(nova): TRACE:     cursor.execute(statement, parameters)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/MySQLdb/cursors.py\", line 166, in execute\n(nova): TRACE:     self.errorhandler(self, exc, value)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/MySQLdb/connections.py\", line 35, in defaulterrorhandler\n(nova): TRACE:     raise errorclass, errorvalue\n(nova): TRACE: OperationalError: (OperationalError) (1242, 'Subquery returns more than 1 row') 'UPDATE bw_usage_cache SET updated_at=%s, mac=(SELECT virtual_interfaces.address \\nFROM virtual_interfaces, networks \\nWHERE networks.label = bw_usage_cache.network_label AND networks.id = virtual_interfaces.network_id)' (datetime.datetime(2012, 2, 7, 15, 47, 20, 996688),)", 
            "date_created": "2012-02-07 15:49:38.726558+00:00", 
            "author": "https://api.launchpad.net/1.0/~johannes.erdfelt"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/3852", 
            "date_created": "2012-02-07 15:56:04.922169+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/3852\nCommitted: http://github.com/openstack/nova/commit/6dbbd26cb193d659b517e440f19737bb899af917\nSubmitter: Jenkins\nBranch:    master\n\ncommit 6dbbd26cb193d659b517e440f19737bb899af917\nAuthor: Jason K\u00f6lker <email address hidden>\nDate:   Tue Feb 7 09:54:30 2012 -0600\n\n    Update migration to work when data already exists\n    \n    Fixes LP928322\n    \n    Change-Id: I64213b863f019700f0555ab0db9fa0914145548a\n", 
            "date_created": "2012-02-07 16:33:18.179836+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}