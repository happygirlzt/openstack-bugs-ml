{
    "status": "Fix Released", 
    "last_updated": "2014-03-30 22:39:08.728350+00:00", 
    "description": "\nSummary: \n  iscsi client session is not removed after live migration leading to undeletable volumes (error_deleting)\n\nDescription: \n  When using cinder with iSCSI as EBS Backend and KVM as virtualization, live migrating a machine then then terminating it leads to undeletable volumes\n  (volumes beeing stuck in \"error_delete\" state)\n  \nProblem: \n  After the live migration, the iSCSI Session on the source host to the cinder storage is not removed. When deleting the instance, the volume is cleared (dd) and then the iscsi session on the machine, the instance is currently running on is removed. However the iscsi session on the source host of the migration is not cleared, leading to a situation where the target on Cinder (TGTD) can not be removed as it is still \"in use\". \n\nSolution: \n  a) Force Logout of Cinder with something like the folloing before deleteing the volume: \n\n     tgtadm --lld iscsi --mode target --op unbind --tid=X -I ALL \n\t tgtadm --lld iscsi --mode conn --op delete --tid=X --sid Y --cid 0 \n\t tgtadm --op delete --mode logicalunit --tid=X --lun 1 \n\t tgtadm --lld iscsi --mode target --op delete --tid=X\n\t \n  b) After the migration was successfull, logout of the iSCSi Target on the source host \n  \nb) is probably easier and cleaner !\n\ndoing a+b) should be very solid and error prove\n  \nHow to Reproduce: \n\n1) Configure 2 Node Cluster with EBS DISK (Cinder)\n2) Create a VM based on SAN Boot Volumes \n3) Migrate the machine from HOST1 to HOST2\n4) Terminate the instance \n5) Delete the Volume of the instance \n6) Here the Volume is stuck in undeletable state (\"error_delete\")\n\n\nDebug Info: \n------------\n\nInstance in Question: instance-0000005b \nHypervisor Hosts: ESX1 / ESX2 (running KVM, not ESX - naming fun :))\n\nroot@esx1:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\ntcp: [8] 172.16.0.130:3260,1 iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\n\nroot@esx1:~# virsh list\n Id    Name                           State\n----------------------------------------------------\n 2     quantum                        running\n 8     instance-0000005b              running\n\n \n root@esx1:~# virsh dumpxml instance-0000005b\n<domain type='kvm' id='8'>\n  <name>instance-0000005b</name>\n  <uuid>4bd1426d-4972-4176-8a72-bfccd3c9035b</uuid>\n  <memory unit='KiB'>524288</memory>\n  <currentMemory unit='KiB'>524288</currentMemory>\n  <vcpu placement='static'>1</vcpu>\n  <os>\n    <type arch='x86_64' machine='pc-1.2'>hvm</type>\n    <boot dev='hd'/>\n  </os>\n  <features>\n    <acpi/>\n  </features>\n  <cpu mode='host-model'>\n    <model fallback='allow'/>\n  </cpu>\n  <clock offset='utc'>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='rtc' tickpolicy='catchup'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <devices>\n    <emulator>/usr/bin/kvm</emulator>\n    <disk type='block' device='disk'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <source dev='/dev/disk/by-path/ip-172.16.0.130:3260-iscsi-iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7-lun-1'/>\n      <target dev='vda' bus='virtio'/>\n      <alias name='virtio-disk0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </disk>\n    <controller type='usb' index='0'>\n      <alias name='usb0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/>\n    </controller>\n    <interface type='bridge'>\n      <mac address='fa:16:3e:32:59:24'/>\n      <source bridge='qbr6b2a850f-46'/>\n      <target dev='vnet3'/>\n      <model type='virtio'/>\n      <filterref filter='nova-instance-instance-0000005b-fa163e325924'>\n        <parameter name='DHCPSERVER' value='192.168.102.3'/>\n        <parameter name='IP' value='192.168.102.4'/>\n        <parameter name='PROJMASK' value='255.255.255.0'/>\n        <parameter name='PROJNET' value='192.168.102.0'/>\n      </filterref>\n      <alias name='net0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </interface>\n    <serial type='file'>\n      <source path='/var/lib/nova/instances/instance-0000005b/console.log'/>\n      <target port='0'/>\n      <alias name='serial0'/>\n    </serial>\n    <serial type='pty'>\n      <source path='/dev/pts/2'/>\n      <target port='1'/>\n      <alias name='serial1'/>\n    </serial>\n    <console type='file'>\n      <source path='/var/lib/nova/instances/instance-0000005b/console.log'/>\n      <target type='serial' port='0'/>\n      <alias name='serial0'/>\n    </console>\n    <input type='tablet' bus='usb'>\n      <alias name='input0'/>\n    </input>\n    <input type='mouse' bus='ps2'/>\n    <graphics type='vnc' port='5901' autoport='yes' listen='0.0.0.0' keymap='en-us'>\n      <listen type='address' address='0.0.0.0'/>\n    </graphics>\n    <video>\n      <model type='cirrus' vram='9216' heads='1'/>\n      <alias name='video0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>\n    </video>\n    <memballoon model='virtio'>\n      <alias name='balloon0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>\n    </memballoon>\n  </devices>\n  <seclabel type='dynamic' model='apparmor' relabel='yes'>\n    <label>libvirt-4bd1426d-4972-4176-8a72-bfccd3c9035b</label>\n    <imagelabel>libvirt-4bd1426d-4972-4176-8a72-bfccd3c9035b</imagelabel>\n  </seclabel>\n</domain>\n\n\n\nroot@esx2:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\n\nroot@esx2:~# virsh list\n Id    Name                           State\n----------------------------------------------------\n\n\nroot@openstack:/etc/init.d# nova list --all-tenants\nPlease enter password for encrypted keyring:\n+--------------------------------------+----------+--------+--------------------+\n| ID                                   | Name     | Status | Networks           |\n+--------------------------------------+----------+--------+--------------------+\n| 4bd1426d-4972-4176-8a72-bfccd3c9035b | asdasdad | ACTIVE | lan1=192.168.102.4 |\n+--------------------------------------+----------+--------+--------------------+\n\n\nroot@openstack:/etc/init.d# nova show 4bd1426d-4972-4176-8a72-bfccd3c9035b\nPlease enter password for encrypted keyring:\n+-------------------------------------+-----------------------------------------------------------+\n| Property                            | Value                                                     |\n+-------------------------------------+-----------------------------------------------------------+\n| OS-DCF:diskConfig                   | MANUAL                                                    |\n| OS-EXT-SRV-ATTR:host                | esx1                                                      |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | esx1.lab.elconas.de                                       |\n| OS-EXT-SRV-ATTR:instance_name       | instance-0000005b                                         |\n| OS-EXT-STS:power_state              | 1                                                         |\n| OS-EXT-STS:task_state               | None                                                      |\n| OS-EXT-STS:vm_state                 | active                                                    |\n| accessIPv4                          |                                                           |\n| accessIPv6                          |                                                           |\n| config_drive                        |                                                           |\n| created                             | 2013-02-23T15:15:57Z                                      |\n| flavor                              | m1.tiny (6)                                               |\n| hostId                              | 8a48ee7c074e396d726b6da80eeacb9a7bae4bf41450e5b772cf9ff0  |\n| id                                  | 4bd1426d-4972-4176-8a72-bfccd3c9035b                      |\n| image                               | Ubuntu-Image-12.04 (cf59575f-189f-4275-9e66-1cc39efb47e4) |\n| key_name                            | rheinzmann                                                |\n| lan1 network                        | 192.168.102.4                                             |\n| metadata                            | {}                                                        |\n| name                                | asdasdad                                                  |\n| progress                            | 0                                                         |\n| security_groups                     | [{u'name': u'default'}]                                   |\n| status                              | ACTIVE                                                    |\n| tenant_id                           | 62515dbc834241d8ab5d58ed7ea50f6b                          |\n| updated                             | 2013-02-23T15:28:47Z                                      |\n| user_id                             | b193e3443cd94f41bac8938f4da5a9d0                          |\n+-------------------------------------+-----------------------------------------------------------+\n\n\nroot@openstack:/etc/init.d# nova live-migration 4bd1426d-4972-4176-8a72-bfccd3c9035b esx2\nPlease enter password for encrypted keyring:\nroot@openstack:/etc/init.d# nova show 4bd1426d-4972-4176-8a72-bfccd3c9035b\nPlease enter password for encrypted keyring:\n+-------------------------------------+-----------------------------------------------------------+\n| Property                            | Value                                                     |\n+-------------------------------------+-----------------------------------------------------------+\n| OS-DCF:diskConfig                   | MANUAL                                                    |\n| OS-EXT-SRV-ATTR:host                | esx2                                                      |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | esx2.lab.elconas.de                                       |\n| OS-EXT-SRV-ATTR:instance_name       | instance-0000005b                                         |\n| OS-EXT-STS:power_state              | 1                                                         |\n| OS-EXT-STS:task_state               | None                                                      |\n| OS-EXT-STS:vm_state                 | active                                                    |\n| accessIPv4                          |                                                           |\n| accessIPv6                          |                                                           |\n| config_drive                        |                                                           |\n| created                             | 2013-02-23T15:15:57Z                                      |\n| flavor                              | m1.tiny (6)                                               |\n| hostId                              | cd6040c927390b663ce86a21e25f48228cd8dd084d05a2e826f5ac0e  |\n| id                                  | 4bd1426d-4972-4176-8a72-bfccd3c9035b                      |\n| image                               | Ubuntu-Image-12.04 (cf59575f-189f-4275-9e66-1cc39efb47e4) |\n| key_name                            | rheinzmann                                                |\n| lan1 network                        | 192.168.102.4                                             |\n| metadata                            | {}                                                        |\n| name                                | asdasdad                                                  |\n| progress                            | 0                                                         |\n| security_groups                     | [{u'name': u'default'}]                                   |\n| status                              | ACTIVE                                                    |\n| tenant_id                           | 62515dbc834241d8ab5d58ed7ea50f6b                          |\n| updated                             | 2013-02-23T15:45:21Z                                      |\n| user_id                             | b193e3443cd94f41bac8938f4da5a9d0                          |\n+-------------------------------------+-----------------------------------------------------------+\n\nroot@esx1:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\ntcp: [8] 172.16.0.130:3260,1 iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\nroot@esx1:~# virsh list\n Id    Name                           State\n----------------------------------------------------\n 2     quantum                        running\n\n\n \nroot@esx2:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\ntcp: [4] 172.16.0.130:3260,1 iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\nroot@esx2:~# virsh list\n Id    Name                           State\n----------------------------------------------------\n 3     instance-0000005b              running\n\nroot@esx2:~#\n\n=> Terminate Instance in GUI ......\n\n=> Instance Terminated and Deleted\n\n=> Volume ff447b2f-6910-4e35-a3c0-78bffe6f35d7 beeing Available ...\n\nTry to delete volume ff447b2f-6910-4e35-a3c0-78bffe6f35d7 in GUI ....\n\nNow the \"dd\" takes place to remove the volume \n\nAfter the \"dd\" the deletion has ended in \"Error_Deleting\" \n\nroot@esx1:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\ntcp: [8] 172.16.0.130:3260,1 iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\n\nroot@esx2:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\n\nroot@esx2:~# cinder list --all-tenants\n+--------------------------------------+----------------+--------------+------+-------------+-------------+\n|                  ID                  |     Status     | Display Name | Size | Volume Type | Attached to |\n+--------------------------------------+----------------+--------------+------+-------------+-------------+\n| 332e4755-070c-45b4-b4b4-408c3fe6609b |   available    |    mytest    |  5   |     None    |             |\n| df9416af-0b35-4acf-af1b-3c2593757b67 | error_deleting |              |  5   |     None    |             |\n| ff447b2f-6910-4e35-a3c0-78bffe6f35d7 | error_deleting |              |  5   |     None    |             |\n+--------------------------------------+----------------+--------------+------+-------------+-------------+\n\n\nOn Cinder: \n\nroot@esx2:~# tgtadm --mode target --op show\n...\nTarget 2: iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\n    System information:\n        Driver: iscsi\n        State: ready\n    I_T nexus information:\n        I_T nexus: 6\n            Initiator: iqn.2010-09.org.etherboot:openstack164\n            Connection: 0\n                IP Address: 172.16.0.120\n    LUN information:\n        LUN: 0\n            Type: controller\n            SCSI ID: IET     00020000\n            SCSI SN: beaf20\n            Size: 0 MB, Block size: 1\n            Online: Yes\n            Removable media: No\n            Readonly: No\n            Backing store type: null\n            Backing store path: None\n            Backing store flags:\n        LUN: 1\n            Type: disk\n            SCSI ID: IET     00020001\n            SCSI SN: beaf21\n            Size: 5369 MB, Block size: 512\n            Online: Yes\n            Removable media: No\n            Readonly: No\n            Backing store type: rdwr\n            Backing store path: /dev/cinder-volumes/volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\n            Backing store flags:\n    Account information:\n    ACL information:\n        ALL\n\t\nLeft Over Session:\n\t\nroot@esx2:~# tgtadm --lld iscsi --mode conn --op show --tid 2\nSession: 6\n    Connection: 0\n        Initiator: iqn.2010-09.org.etherboot:openstack164\n        IP Address: 172.16.0.120\n\nDelete the Session \n\nroot@esx1:~# iscsiadm -m session -r 8 -u\nLogging out of session [sid: 8, target: iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7, portal: 172.16.0.130,3260]\nLogout of [sid: 8, target: iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7, portal: 172.16.0.130,3260] successful.\n\nroot@esx2:~# tgtadm --mode target --op delete --tid 2\n\nroot@esx2:~# lvremove /dev/cinder-volumes/volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\nFile descriptor 3 (/usr/share/bash-completion/completions) leaked on lvremove invocation. Parent PID 11376: -bash\nDo you really want to remove active logical volume volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7? [y/n]: y\n  Logical volume \"volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\" successfully removed", 
    "tags": [
        "cinder", 
        "iscsi", 
        "tgtd"
    ], 
    "importance": "Medium", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1132146", 
    "owner": "https://api.launchpad.net/1.0/~jdillaman", 
    "id": 1132146, 
    "index": 3243, 
    "created": "2013-02-23 16:04:48.152113+00:00", 
    "title": "Summary: Undeletable volumes after live migration (iSCSI)", 
    "comments": [
        {
            "content": "\nSummary: \n  iscsi client session is not removed after live migration leading to undeletable volumes (error_deleting)\n\nDescription: \n  When using cinder with iSCSI as EBS Backend and KVM as virtualization, live migrating a machine then then terminating it leads to undeletable volumes\n  (volumes beeing stuck in \"error_delete\" state)\n  \nProblem: \n  After the live migration, the iSCSI Session on the source host to the cinder storage is not removed. When deleting the instance, the volume is cleared (dd) and then the iscsi session on the machine, the instance is currently running on is removed. However the iscsi session on the source host of the migration is not cleared, leading to a situation where the target on Cinder (TGTD) can not be removed as it is still \"in use\". \n\nSolution: \n  a) Force Logout of Cinder with something like the folloing before deleteing the volume: \n\n     tgtadm --lld iscsi --mode target --op unbind --tid=X -I ALL \n\t tgtadm --lld iscsi --mode conn --op delete --tid=X --sid Y --cid 0 \n\t tgtadm --op delete --mode logicalunit --tid=X --lun 1 \n\t tgtadm --lld iscsi --mode target --op delete --tid=X\n\t \n  b) After the migration was successfull, logout of the iSCSi Target on the source host \n  \nb) is probably easier and cleaner !\n\ndoing a+b) should be very solid and error prove\n  \nHow to Reproduce: \n\n1) Configure 2 Node Cluster with EBS DISK (Cinder)\n2) Create a VM based on SAN Boot Volumes \n3) Migrate the machine from HOST1 to HOST2\n4) Terminate the instance \n5) Delete the Volume of the instance \n6) Here the Volume is stuck in undeletable state (\"error_delete\")\n\n\nDebug Info: \n------------\n\nInstance in Question: instance-0000005b \nHypervisor Hosts: ESX1 / ESX2 (running KVM, not ESX - naming fun :))\n\nroot@esx1:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\ntcp: [8] 172.16.0.130:3260,1 iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\n\nroot@esx1:~# virsh list\n Id    Name                           State\n----------------------------------------------------\n 2     quantum                        running\n 8     instance-0000005b              running\n\n \n root@esx1:~# virsh dumpxml instance-0000005b\n<domain type='kvm' id='8'>\n  <name>instance-0000005b</name>\n  <uuid>4bd1426d-4972-4176-8a72-bfccd3c9035b</uuid>\n  <memory unit='KiB'>524288</memory>\n  <currentMemory unit='KiB'>524288</currentMemory>\n  <vcpu placement='static'>1</vcpu>\n  <os>\n    <type arch='x86_64' machine='pc-1.2'>hvm</type>\n    <boot dev='hd'/>\n  </os>\n  <features>\n    <acpi/>\n  </features>\n  <cpu mode='host-model'>\n    <model fallback='allow'/>\n  </cpu>\n  <clock offset='utc'>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='rtc' tickpolicy='catchup'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <devices>\n    <emulator>/usr/bin/kvm</emulator>\n    <disk type='block' device='disk'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <source dev='/dev/disk/by-path/ip-172.16.0.130:3260-iscsi-iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7-lun-1'/>\n      <target dev='vda' bus='virtio'/>\n      <alias name='virtio-disk0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </disk>\n    <controller type='usb' index='0'>\n      <alias name='usb0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/>\n    </controller>\n    <interface type='bridge'>\n      <mac address='fa:16:3e:32:59:24'/>\n      <source bridge='qbr6b2a850f-46'/>\n      <target dev='vnet3'/>\n      <model type='virtio'/>\n      <filterref filter='nova-instance-instance-0000005b-fa163e325924'>\n        <parameter name='DHCPSERVER' value='192.168.102.3'/>\n        <parameter name='IP' value='192.168.102.4'/>\n        <parameter name='PROJMASK' value='255.255.255.0'/>\n        <parameter name='PROJNET' value='192.168.102.0'/>\n      </filterref>\n      <alias name='net0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </interface>\n    <serial type='file'>\n      <source path='/var/lib/nova/instances/instance-0000005b/console.log'/>\n      <target port='0'/>\n      <alias name='serial0'/>\n    </serial>\n    <serial type='pty'>\n      <source path='/dev/pts/2'/>\n      <target port='1'/>\n      <alias name='serial1'/>\n    </serial>\n    <console type='file'>\n      <source path='/var/lib/nova/instances/instance-0000005b/console.log'/>\n      <target type='serial' port='0'/>\n      <alias name='serial0'/>\n    </console>\n    <input type='tablet' bus='usb'>\n      <alias name='input0'/>\n    </input>\n    <input type='mouse' bus='ps2'/>\n    <graphics type='vnc' port='5901' autoport='yes' listen='0.0.0.0' keymap='en-us'>\n      <listen type='address' address='0.0.0.0'/>\n    </graphics>\n    <video>\n      <model type='cirrus' vram='9216' heads='1'/>\n      <alias name='video0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>\n    </video>\n    <memballoon model='virtio'>\n      <alias name='balloon0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>\n    </memballoon>\n  </devices>\n  <seclabel type='dynamic' model='apparmor' relabel='yes'>\n    <label>libvirt-4bd1426d-4972-4176-8a72-bfccd3c9035b</label>\n    <imagelabel>libvirt-4bd1426d-4972-4176-8a72-bfccd3c9035b</imagelabel>\n  </seclabel>\n</domain>\n\n\n\nroot@esx2:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\n\nroot@esx2:~# virsh list\n Id    Name                           State\n----------------------------------------------------\n\n\nroot@openstack:/etc/init.d# nova list --all-tenants\nPlease enter password for encrypted keyring:\n+--------------------------------------+----------+--------+--------------------+\n| ID                                   | Name     | Status | Networks           |\n+--------------------------------------+----------+--------+--------------------+\n| 4bd1426d-4972-4176-8a72-bfccd3c9035b | asdasdad | ACTIVE | lan1=192.168.102.4 |\n+--------------------------------------+----------+--------+--------------------+\n\n\nroot@openstack:/etc/init.d# nova show 4bd1426d-4972-4176-8a72-bfccd3c9035b\nPlease enter password for encrypted keyring:\n+-------------------------------------+-----------------------------------------------------------+\n| Property                            | Value                                                     |\n+-------------------------------------+-----------------------------------------------------------+\n| OS-DCF:diskConfig                   | MANUAL                                                    |\n| OS-EXT-SRV-ATTR:host                | esx1                                                      |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | esx1.lab.elconas.de                                       |\n| OS-EXT-SRV-ATTR:instance_name       | instance-0000005b                                         |\n| OS-EXT-STS:power_state              | 1                                                         |\n| OS-EXT-STS:task_state               | None                                                      |\n| OS-EXT-STS:vm_state                 | active                                                    |\n| accessIPv4                          |                                                           |\n| accessIPv6                          |                                                           |\n| config_drive                        |                                                           |\n| created                             | 2013-02-23T15:15:57Z                                      |\n| flavor                              | m1.tiny (6)                                               |\n| hostId                              | 8a48ee7c074e396d726b6da80eeacb9a7bae4bf41450e5b772cf9ff0  |\n| id                                  | 4bd1426d-4972-4176-8a72-bfccd3c9035b                      |\n| image                               | Ubuntu-Image-12.04 (cf59575f-189f-4275-9e66-1cc39efb47e4) |\n| key_name                            | rheinzmann                                                |\n| lan1 network                        | 192.168.102.4                                             |\n| metadata                            | {}                                                        |\n| name                                | asdasdad                                                  |\n| progress                            | 0                                                         |\n| security_groups                     | [{u'name': u'default'}]                                   |\n| status                              | ACTIVE                                                    |\n| tenant_id                           | 62515dbc834241d8ab5d58ed7ea50f6b                          |\n| updated                             | 2013-02-23T15:28:47Z                                      |\n| user_id                             | b193e3443cd94f41bac8938f4da5a9d0                          |\n+-------------------------------------+-----------------------------------------------------------+\n\n\nroot@openstack:/etc/init.d# nova live-migration 4bd1426d-4972-4176-8a72-bfccd3c9035b esx2\nPlease enter password for encrypted keyring:\nroot@openstack:/etc/init.d# nova show 4bd1426d-4972-4176-8a72-bfccd3c9035b\nPlease enter password for encrypted keyring:\n+-------------------------------------+-----------------------------------------------------------+\n| Property                            | Value                                                     |\n+-------------------------------------+-----------------------------------------------------------+\n| OS-DCF:diskConfig                   | MANUAL                                                    |\n| OS-EXT-SRV-ATTR:host                | esx2                                                      |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | esx2.lab.elconas.de                                       |\n| OS-EXT-SRV-ATTR:instance_name       | instance-0000005b                                         |\n| OS-EXT-STS:power_state              | 1                                                         |\n| OS-EXT-STS:task_state               | None                                                      |\n| OS-EXT-STS:vm_state                 | active                                                    |\n| accessIPv4                          |                                                           |\n| accessIPv6                          |                                                           |\n| config_drive                        |                                                           |\n| created                             | 2013-02-23T15:15:57Z                                      |\n| flavor                              | m1.tiny (6)                                               |\n| hostId                              | cd6040c927390b663ce86a21e25f48228cd8dd084d05a2e826f5ac0e  |\n| id                                  | 4bd1426d-4972-4176-8a72-bfccd3c9035b                      |\n| image                               | Ubuntu-Image-12.04 (cf59575f-189f-4275-9e66-1cc39efb47e4) |\n| key_name                            | rheinzmann                                                |\n| lan1 network                        | 192.168.102.4                                             |\n| metadata                            | {}                                                        |\n| name                                | asdasdad                                                  |\n| progress                            | 0                                                         |\n| security_groups                     | [{u'name': u'default'}]                                   |\n| status                              | ACTIVE                                                    |\n| tenant_id                           | 62515dbc834241d8ab5d58ed7ea50f6b                          |\n| updated                             | 2013-02-23T15:45:21Z                                      |\n| user_id                             | b193e3443cd94f41bac8938f4da5a9d0                          |\n+-------------------------------------+-----------------------------------------------------------+\n\nroot@esx1:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\ntcp: [8] 172.16.0.130:3260,1 iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\nroot@esx1:~# virsh list\n Id    Name                           State\n----------------------------------------------------\n 2     quantum                        running\n\n\n \nroot@esx2:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\ntcp: [4] 172.16.0.130:3260,1 iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\nroot@esx2:~# virsh list\n Id    Name                           State\n----------------------------------------------------\n 3     instance-0000005b              running\n\nroot@esx2:~#\n\n=> Terminate Instance in GUI ......\n\n=> Instance Terminated and Deleted\n\n=> Volume ff447b2f-6910-4e35-a3c0-78bffe6f35d7 beeing Available ...\n\nTry to delete volume ff447b2f-6910-4e35-a3c0-78bffe6f35d7 in GUI ....\n\nNow the \"dd\" takes place to remove the volume \n\nAfter the \"dd\" the deletion has ended in \"Error_Deleting\" \n\nroot@esx1:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\ntcp: [8] 172.16.0.130:3260,1 iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\n\nroot@esx2:~# iscsiadm -m session\ntcp: [1] 172.16.0.110:3260,2 iqn.1986-03.com.sun:nexentaboot\n\nroot@esx2:~# cinder list --all-tenants\n+--------------------------------------+----------------+--------------+------+-------------+-------------+\n|                  ID                  |     Status     | Display Name | Size | Volume Type | Attached to |\n+--------------------------------------+----------------+--------------+------+-------------+-------------+\n| 332e4755-070c-45b4-b4b4-408c3fe6609b |   available    |    mytest    |  5   |     None    |             |\n| df9416af-0b35-4acf-af1b-3c2593757b67 | error_deleting |              |  5   |     None    |             |\n| ff447b2f-6910-4e35-a3c0-78bffe6f35d7 | error_deleting |              |  5   |     None    |             |\n+--------------------------------------+----------------+--------------+------+-------------+-------------+\n\n\nOn Cinder: \n\nroot@esx2:~# tgtadm --mode target --op show\n...\nTarget 2: iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\n    System information:\n        Driver: iscsi\n        State: ready\n    I_T nexus information:\n        I_T nexus: 6\n            Initiator: iqn.2010-09.org.etherboot:openstack164\n            Connection: 0\n                IP Address: 172.16.0.120\n    LUN information:\n        LUN: 0\n            Type: controller\n            SCSI ID: IET     00020000\n            SCSI SN: beaf20\n            Size: 0 MB, Block size: 1\n            Online: Yes\n            Removable media: No\n            Readonly: No\n            Backing store type: null\n            Backing store path: None\n            Backing store flags:\n        LUN: 1\n            Type: disk\n            SCSI ID: IET     00020001\n            SCSI SN: beaf21\n            Size: 5369 MB, Block size: 512\n            Online: Yes\n            Removable media: No\n            Readonly: No\n            Backing store type: rdwr\n            Backing store path: /dev/cinder-volumes/volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\n            Backing store flags:\n    Account information:\n    ACL information:\n        ALL\n\t\nLeft Over Session:\n\t\nroot@esx2:~# tgtadm --lld iscsi --mode conn --op show --tid 2\nSession: 6\n    Connection: 0\n        Initiator: iqn.2010-09.org.etherboot:openstack164\n        IP Address: 172.16.0.120\n\nDelete the Session \n\nroot@esx1:~# iscsiadm -m session -r 8 -u\nLogging out of session [sid: 8, target: iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7, portal: 172.16.0.130,3260]\nLogout of [sid: 8, target: iqn.2010-10.org.openstack:volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7, portal: 172.16.0.130,3260] successful.\n\nroot@esx2:~# tgtadm --mode target --op delete --tid 2\n\nroot@esx2:~# lvremove /dev/cinder-volumes/volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\nFile descriptor 3 (/usr/share/bash-completion/completions) leaked on lvremove invocation. Parent PID 11376: -bash\nDo you really want to remove active logical volume volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7? [y/n]: y\n  Logical volume \"volume-ff447b2f-6910-4e35-a3c0-78bffe6f35d7\" successfully removed", 
            "date_created": "2013-02-23 16:04:48.152113+00:00", 
            "author": "https://api.launchpad.net/1.0/~reg-x"
        }, 
        {
            "content": "Wouldn't this be the responsibility of the compute node (nova) to disconnect the session on migration?", 
            "date_created": "2013-03-05 21:20:23.710868+00:00", 
            "author": "https://api.launchpad.net/1.0/~john-griffith"
        }, 
        {
            "content": "It think it should be part of the \"live migration\" orchestration. \nActually I don't know which componente coordinates the live migration - \nif it is nova-compute then yes, it should be part of this component ?\n\nAm 05.03.2013 22:20, schrieb John Griffith:\n> Wouldn't this be the responsibility of the compute node (nova) to\n> disconnect the session on migration?\n>\n\n", 
            "date_created": "2013-03-05 21:52:35+00:00", 
            "author": "https://api.launchpad.net/1.0/~reg-x"
        }, 
        {
            "content": "Which version of nova?", 
            "date_created": "2013-03-18 13:41:51.119194+00:00", 
            "author": "https://api.launchpad.net/1.0/~zulcss"
        }, 
        {
            "content": "Compute: \n\nroot@COMPUTE1:~# dpkg -l | grep -i openstack\n\nii  nova-common                                  2012.2.3-0ubuntu1                                 all          OpenStack Compute - common files\nii  nova-compute                                 2012.2.3-0ubuntu1                                 all          OpenStack Compute - compute node\nii  nova-compute-kvm                             2012.2.3-0ubuntu1                                 all          OpenStack Compute - compute node (KVM)\nii  python-cinderclient                          1:1.0.0-0ubuntu1                                  all          python bindings to the OpenStack Volume API\nii  python-glance                                2012.2.3-0ubuntu1                                 all          OpenStack Image Registry and Delivery Service - Python library\nii  python-glanceclient                          1:0.5.1-0ubuntu1                                  all          Client library for Openstack glance server.\nii  python-keystone                              2012.2.3+stable-20130206-82c87e56-0ubuntu1        all          OpenStack identity service - Python library\nii  python-keystoneclient                        1:0.1.3-0ubuntu1.1                                all          Client libary for Openstack Keystone API\nii  python-nova                                  2012.2.3-0ubuntu1                                 all          OpenStack Compute Python libraries\nii  python-novaclient                            1:2.9.0-0ubuntu1                                  all          client library for OpenStack Compute API\nii  python-quantum                               2012.2.3-0ubuntu1                                 all          Quantum is a virutal network service for Openstack. (python library)\nii  python-quantumclient                         1:2.1-0ubuntu1                                    all          client - Quantum is a virtual network service for Openstack\nii  python-swiftclient                           1:1.2.0-0ubuntu2                                  all          Client libary for Openstack Swift API.\nii  quantum-common                               2012.2.3-0ubuntu1                                 all          common - Quantum is a virtual network service for Openstack.\nii  quantum-plugin-openvswitch                   2012.2.3-0ubuntu1                                 all          Quantum is a virtual network service for Openstack. (openvswitch plugin)\nii  quantum-plugin-openvswitch-agent             2012.2.3-0ubuntu1                                 all          Quantum is a virtual network service for Openstack. (openvswitch plugin agent)\n\nController (KeyStone etc.)\n\nroot@openstack:~# dpkg -l | grep -i Openstack\nii  glance                           2012.2.3-0ubuntu1                          all          OpenStack Image Registry and Delivery Service - Daemons\nii  glance-api                       2012.2.3-0ubuntu1                          all          OpenStack Image Registry and Delivery Service - API\nii  glance-common                    2012.2.3-0ubuntu1                          all          OpenStack Image Registry and Delivery Service - Common\nii  glance-registry                  2012.2.3-0ubuntu1                          all          OpenStack Image Registry and Delivery Service - Registry\nii  keystone                         2012.2.3+stable-20130206-82c87e56-0ubuntu1 all          OpenStack identity service - Daemons\nii  nova-api                         2012.2.3-0ubuntu1                          all          OpenStack Compute - API frontend\nii  nova-cert                        2012.2.3-0ubuntu1                          all          OpenStack Compute - certificate management\nii  nova-common                      2012.2.3-0ubuntu1                          all          OpenStack Compute - common files\nii  nova-consoleauth                 2012.2.3-0ubuntu1                          all          OpenStack Compute - Console Authenticator\nii  nova-novncproxy                  2012.2.3-0ubuntu1                          all          OpenStack Compute - NoVNC proxy\nii  nova-scheduler                   2012.2.3-0ubuntu1                          all          OpenStack Compute - virtual machine scheduler\nii  openstack-dashboard              2012.2.3-0ubuntu1                          all          django web interface to Openstack\nii  openstack-dashboard-ubuntu-theme 2012.2.3-0ubuntu1                          all          Ubuntu theme for the Openstack dashboard\nii  python-cinderclient              1:1.0.0-0ubuntu1                           all          python bindings to the OpenStack Volume API\nii  python-django-horizon            2012.2.3-0ubuntu1                          all          Django module providing web based interaction with OpenStack\nii  python-glance                    2012.2.3-0ubuntu1                          all          OpenStack Image Registry and Delivery Service - Python library\nii  python-glanceclient              1:0.5.1-0ubuntu1                           all          Client library for Openstack glance server.\nii  python-keystone                  2012.2.3+stable-20130206-82c87e56-0ubuntu1 all          OpenStack identity service - Python library\nii  python-keystoneclient            1:0.1.3-0ubuntu1.1                         all          Client libary for Openstack Keystone API\nii  python-nova                      2012.2.3-0ubuntu1                          all          OpenStack Compute Python libraries\nii  python-novaclient                1:2.9.0-0ubuntu1                           all          client library for OpenStack Compute API\nii  python-openstack-auth            1.0.1-0ubuntu6                             all          A django authentication backend for Openstack\nii  python-quantumclient             1:2.1-0ubuntu1                             all          client - Quantum is a virtual network service for Openstack\nii  python-swiftclient               1:1.2.0-0ubuntu2                           all          Client libary for Openstack Swift API.\nrc  quantum-common                   2012.2.1-0ubuntu1~cloud0                   all          common - Quantum is a virtual network service for Openstack.\nrc  quantum-plugin-openvswitch       2012.2.1-0ubuntu1~cloud0                   all          Quantum is a virtual network service for Openstack. (openvswitch plugin)\nrc  quantum-server                   2012.2.1-0ubuntu1~cloud0                   all          server - Quantum is a virtual network service for Openstack\n", 
            "date_created": "2013-03-19 17:59:21.257733+00:00", 
            "author": "https://api.launchpad.net/1.0/~reg-x"
        }, 
        {
            "content": "I reported the same bug yersteday (https://bugs.launchpad.net/nova/+bug/1156788) and if it can help :\n\nI run Nova and Cinder Folsom (2012.2.3) on Debian Wheezy X86_64 Kernel 3.2.\nI installed nova from github repositories.", 
            "date_created": "2013-03-19 21:53:39.966259+00:00", 
            "author": "https://api.launchpad.net/1.0/~adrien8255"
        }, 
        {
            "content": "This needs to be investigated to see if it is still a problem. It looks like we might be missing some cleanup in the complete live migration code path", 
            "date_created": "2013-04-04 18:30:18.995215+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/34617", 
            "date_created": "2013-06-26 21:27:14.644320+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/34617\nCommitted: http://github.com/openstack/nova/commit/38e6e93a8102751b781d79da37249fe9c55f2575\nSubmitter: Jenkins\nBranch:    master\n\ncommit 38e6e93a8102751b781d79da37249fe9c55f2575\nAuthor: Jason Dillaman <email address hidden>\nDate:   Wed Jun 26 16:53:03 2013 -0400\n\n    Disconnect from iSCSI volume sessions after live migration\n    \n    The live migration source host will now disconnect from\n    iSCSI volume sessions after the VM is successfully migrated\n    to the destination host.\n    \n    Fixes bug 1132146\n    Change-Id: I132869612bdf2baa810756586e643ea68ea8d8f6\n", 
            "date_created": "2013-09-02 07:10:41.259826+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/grizzly\nReview: https://review.openstack.org/48246", 
            "date_created": "2013-09-25 13:08:24.006833+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}