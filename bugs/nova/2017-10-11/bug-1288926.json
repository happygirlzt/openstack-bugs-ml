{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:15:44.481410+00:00", 
    "description": "This is using the latest nova from trunk. In our deployment, we had a hypervisor go down and the tenant issued a hard reboot prior. When attempting a reboot on a guest with the state HARD_REBOOT, nova controller throws this error in it's logs and returns 'ERROR: The server has either erred or is incapable of performing the requested operation. (HTTP 500)' to the user:\n\n\n2014-03-06 18:21:00,535 (routes.middleware): DEBUG middleware __call__ Matched POST /tenant1/servers/778032b2-469d-445e-abde-7b9b0b673324/action\n2014-03-06 18:21:00,536 (routes.middleware): DEBUG middleware __call__ Route path: '/{project_id}/servers/:(id)/action', defaults: {'action': u'action', 'controller': <nova.api.openstack.wsgi.Resource object at 0x5242c90>}\n2014-03-06 18:21:00,536 (routes.middleware): DEBUG middleware __call__ Match dict: {'action': u'action', 'controller': <nova.api.openstack.wsgi.Resource object at 0x5242c90>, 'project_id': u'tenant1', 'id': u'778032b2-469d-445e-abde-7b9b0b673324'}\n2014-03-06 18:21:00,537 (nova.api.openstack.wsgi): DEBUG wsgi _process_stack Action: 'action', body: {\"reboot\": {\"type\": \"SOFT\"}}\n2014-03-06 18:21:00,538 (nova.api.openstack.wsgi): DEBUG wsgi _process_stack Calling method <bound method Controller._action_reboot of <nova.api.openstack.compute.contrib.keypairs.Controller object at 0x4c35a50>>\n2014-03-06 18:21:00,747 (nova.api.openstack): ERROR __init__ _error Caught error: Unexpected task state: expecting [None, 'rebooting'] but the actual state is rebooting_hard\nTraceback (most recent call last):\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/api/openstack/__init__.py\", line 125, in __call__\n    return req.get_response(self.application)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/request.py\", line 1320, in send\n    application, catch_exc_info=False)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/request.py\", line 1284, in call_application\n    app_iter = application(self.environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/keystoneclient/middleware/auth_token.py\", line 598, in __call__\n    return self.app(env, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/routes/middleware.py\", line 131, in __call__\n    response = self.app(environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 130, in __call__\n    resp = self.call_func(req, *args, **self.kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 195, in call_func\n    return self.func(req, *args, **kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/api/openstack/wsgi.py\", line 925, in __call__\n    content_type, body, accept)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/api/openstack/wsgi.py\", line 987, in _process_stack\n    action_result = self.dispatch(meth, request, action_args)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/api/openstack/wsgi.py\", line 1074, in dispatch\n    return method(req=request, **action_args)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/api/openstack/compute/servers.py\", line 1145, in _action_reboot\n    self.compute_api.reboot(context, instance, reboot_type)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/compute/api.py\", line 199, in wrapped\n    return func(self, context, target, *args, **kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/compute/api.py\", line 189, in inner\n    return function(self, context, instance, *args, **kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/compute/api.py\", line 170, in inner\n    return f(self, context, instance, *args, **kw)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/compute/api.py\", line 2073, in reboot\n    instance.save(expected_task_state=[None, task_states.REBOOTING])\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/objects/base.py\", line 151, in wrapper\n    return fn(self, ctxt, *args, **kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/objects/instance.py\", line 472, in save\n    columns_to_join=_expected_cols(expected_attrs))\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/db/api.py\", line 739, in instance_update_and_get_original\n    columns_to_join=columns_to_join)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/db/sqlalchemy/api.py\", line 128, in wrapper\n    return f(*args, **kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/db/sqlalchemy/api.py\", line 2164, in instance_update_and_get_original\n    columns_to_join=columns_to_join)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/db/sqlalchemy/api.py\", line 2215, in _instance_update\n    actual=actual_state, expected=expected)\nUnexpectedTaskStateError: Unexpected task state: expecting [None, 'rebooting'] but the actual state is rebooting_hard\n2014-03-06 18:21:00,750 (nova.api.openstack): INFO __init__ _error http://nova-controller.isg.apple.com:8774/v2/tenant1/servers/778032b2-469d-445e-abde-7b9b0b673324/action returned with HTTP 500\n\n\nThe actual error message back to the user must be something along the lines of 'Unexpected task state: expecting [None, 'rebooting'] but the actual state is rebooting_hard' with a 4xx HTTP code.", 
    "tags": [
        "icehouse-rc-potential"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1288926", 
    "owner": "https://api.launchpad.net/1.0/~liusheng", 
    "id": 1288926, 
    "index": 3821, 
    "created": "2014-03-06 18:49:24.729177+00:00", 
    "title": "incorrect error code when rebooting a rebooting_hard guest", 
    "comments": [
        {
            "content": "This is using the latest nova from trunk. In our deployment, we had a hypervisor go down and the tenant issued a hard reboot prior. When attempting a reboot on a guest with the state HARD_REBOOT, nova controller throws this error in it's logs and returns 'ERROR: The server has either erred or is incapable of performing the requested operation. (HTTP 500)' to the user:\n\n\n2014-03-06 18:21:00,535 (routes.middleware): DEBUG middleware __call__ Matched POST /tenant1/servers/778032b2-469d-445e-abde-7b9b0b673324/action\n2014-03-06 18:21:00,536 (routes.middleware): DEBUG middleware __call__ Route path: '/{project_id}/servers/:(id)/action', defaults: {'action': u'action', 'controller': <nova.api.openstack.wsgi.Resource object at 0x5242c90>}\n2014-03-06 18:21:00,536 (routes.middleware): DEBUG middleware __call__ Match dict: {'action': u'action', 'controller': <nova.api.openstack.wsgi.Resource object at 0x5242c90>, 'project_id': u'tenant1', 'id': u'778032b2-469d-445e-abde-7b9b0b673324'}\n2014-03-06 18:21:00,537 (nova.api.openstack.wsgi): DEBUG wsgi _process_stack Action: 'action', body: {\"reboot\": {\"type\": \"SOFT\"}}\n2014-03-06 18:21:00,538 (nova.api.openstack.wsgi): DEBUG wsgi _process_stack Calling method <bound method Controller._action_reboot of <nova.api.openstack.compute.contrib.keypairs.Controller object at 0x4c35a50>>\n2014-03-06 18:21:00,747 (nova.api.openstack): ERROR __init__ _error Caught error: Unexpected task state: expecting [None, 'rebooting'] but the actual state is rebooting_hard\nTraceback (most recent call last):\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/api/openstack/__init__.py\", line 125, in __call__\n    return req.get_response(self.application)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/request.py\", line 1320, in send\n    application, catch_exc_info=False)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/request.py\", line 1284, in call_application\n    app_iter = application(self.environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/keystoneclient/middleware/auth_token.py\", line 598, in __call__\n    return self.app(env, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/routes/middleware.py\", line 131, in __call__\n    response = self.app(environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 130, in __call__\n    resp = self.call_func(req, *args, **self.kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/webob/dec.py\", line 195, in call_func\n    return self.func(req, *args, **kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/api/openstack/wsgi.py\", line 925, in __call__\n    content_type, body, accept)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/api/openstack/wsgi.py\", line 987, in _process_stack\n    action_result = self.dispatch(meth, request, action_args)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/api/openstack/wsgi.py\", line 1074, in dispatch\n    return method(req=request, **action_args)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/api/openstack/compute/servers.py\", line 1145, in _action_reboot\n    self.compute_api.reboot(context, instance, reboot_type)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/compute/api.py\", line 199, in wrapped\n    return func(self, context, target, *args, **kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/compute/api.py\", line 189, in inner\n    return function(self, context, instance, *args, **kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/compute/api.py\", line 170, in inner\n    return f(self, context, instance, *args, **kw)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/compute/api.py\", line 2073, in reboot\n    instance.save(expected_task_state=[None, task_states.REBOOTING])\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/objects/base.py\", line 151, in wrapper\n    return fn(self, ctxt, *args, **kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/objects/instance.py\", line 472, in save\n    columns_to_join=_expected_cols(expected_attrs))\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/db/api.py\", line 739, in instance_update_and_get_original\n    columns_to_join=columns_to_join)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/db/sqlalchemy/api.py\", line 128, in wrapper\n    return f(*args, **kwargs)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/db/sqlalchemy/api.py\", line 2164, in instance_update_and_get_original\n    columns_to_join=columns_to_join)\n  File \"/usr/local/gshare/csi-nova.venv/lib/python2.6/site-packages/nova/db/sqlalchemy/api.py\", line 2215, in _instance_update\n    actual=actual_state, expected=expected)\nUnexpectedTaskStateError: Unexpected task state: expecting [None, 'rebooting'] but the actual state is rebooting_hard\n2014-03-06 18:21:00,750 (nova.api.openstack): INFO __init__ _error http://nova-controller.isg.apple.com:8774/v2/tenant1/servers/778032b2-469d-445e-abde-7b9b0b673324/action returned with HTTP 500\n\n\nThe actual error message back to the user must be something along the lines of 'Unexpected task state: expecting [None, 'rebooting'] but the actual state is rebooting_hard' with a 4xx HTTP code.", 
            "date_created": "2014-03-06 18:49:24.729177+00:00", 
            "author": "https://api.launchpad.net/1.0/~sarathmenon"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/79274", 
            "date_created": "2014-03-10 08:23:18.749213+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "not only REBOOTING_HARD has this problem, I would think REBOOTING also has this problem \nso hopefully this issue can also be fixed", 
            "date_created": "2014-03-11 01:41:38.852061+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/79274\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=00f5125745dc72afbc9aeade8b780d7a3be49a30\nSubmitter: Jenkins\nBranch:    master\n\ncommit 00f5125745dc72afbc9aeade8b780d7a3be49a30\nAuthor: liu-sheng <email address hidden>\nDate:   Mon Mar 10 16:20:16 2014 +0800\n\n    Don't allow reboot when instance in rebooting_hard\n    \n    It shouldn't allow reboot a instance while the instance in\n    rebooting_hard task state.\n    If the instance is in rebooting_hard, solf reboot action is\n    meaningless.\n    \n    Change-Id: I43147104a7473eaaf1b86f84386bb28b7e3574c3\n    Closes-bug: #1288926\n", 
            "date_created": "2014-03-22 10:17:37.048165+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}