{
    "status": "Fix Released", 
    "last_updated": "2014-09-22 10:15:06.894907+00:00", 
    "description": "Short problem summary:\n====================\n\nWhen LUN id is reused by SCSI provider, it may cause device size mismatch on the compute node. Host may report to guest the device size corresponding to volume previously mapped to this LUN id, not the device that is mapped there now. This happens for SCSI providers that use one target with many LUNs (eg Netapp).\n\nDetailed problem description:\n========================\n\nOpenstack iSCSI client in disconnect_volume() will call iscsiadm with --logout only if nobody else is using LUNs from that target. Otherwise, it will do nothing. Device stays there..\n\n# ls -l /dev/disk/by-path/ip-172.30.128.3\\:3260-iscsi-iqn.1992-08.com.netapp\\:node.netapp02-lun-0\nlrwxrwxrwx. 1 root root 9 Feb  1 11:06 /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-0 -> ../../sdg\n\nLater, nova-volume will unmap LUN from the initiator. This devices becomes invalid. Example \"sanlun\" output:\n\n# sanlun lun show\ncontroller(7mode)/                                                                               device          host                  lun    \nvserver(Cmode)       lun-pathname                                                                filename        adapter    protocol   size    mode \n---------------------------------------------------------------------------------------------------------------------------------------------------\n1081809-413161-N2    <unknown>                                                                   /dev/sdg        host7      iSCSI              7    \n\nAt some point, a different volume needs to be made available to the same compute node. Remote SCSI provider may choose to recycle an unused LUN id. From client's point of view, a different Openstack volume is visible under the same target and LUN id (as used before). After nova-volume completed LUN mapping, nova-compute's connect_volume() is called. Note that, at this point, iSCSI session to the target is up and device symlink (/dev/disk/by-path/..) exists. Openstack iSCSI driver will call \"iscsiadm .. --login\" (with no effect). Rescan is not called, because the device exists. Libvirt and VM will start to use device..\n\nAccess to the re-mapped device will produce \nFeb  1 11:06:45 prod-cmp10 kernel: sd 7:0:0:1: [sdh] Warning! Received an indication that the LUN assignments on this target have changed. The Linux SCSI layer does not automatically remap LUN assignments.\nFeb  1 11:06:45 prod-cmp10 kernel: sd 7:0:0:0: [sdg] Result: hostbyte=DID_OK driverbyte=DRIVER_SENSE\nFeb  1 11:06:45 prod-cmp10 kernel: sd 7:0:0:0: [sdg] Sense Key : Illegal Request [current] \nFeb  1 11:06:45 prod-cmp10 kernel: Info fld=0x0\n\nFor some strange reason, kernel reports the warning on device that did NOT change (\"sdh\" vs \"sdg\"). Possible bug in Linux iSCSI client ?\n\nThis issue affects SCSI systems where there are targets with multiple LUNs (eg Netapp). Openstack implementation on LVM/tgtd backend is not affected because there are multiple targets with single LUN. When the LUN becomes unused, driver will close the whole session.\n\nSteps to reproduce:\n================\n\n1) create tree volumes with different sizes (1, 2, 3GB)\n\n# euca-describe-volumes vol-00000551 vol-00000552 vol-00000553\nVOLUME\tvol-00000551\t 1\t\tna.dev-netapp\tavailable\t2013-02-01T09:32:01.000Z\nVOLUME\tvol-00000552\t 2\t\tna.dev-netapp\tavailable\t2013-02-01T09:32:07.000Z\nVOLUME\tvol-00000553\t 3\t\tna.dev-netapp\tavailable\t2013-02-01T09:32:13.000Z\n\n2) attach volumes 3G, 2G to an instance\n\ncompute node# virsh domblklist i-000005dc\nTarget     Source\n------------------------------------------------\n...\nvdc        /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-0\nvdd        /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-1\n\ninstance# lsblk\nNAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\n...\nvdc    252:32   0   3G  0 disk \nvdd    252:48   0   2G  0 disk \n\n3) detach volume 3G (LUN0 becomes unused)\n\nDevice still exists\n\n# ls -l /dev/disk/by-path/\n...\nlrwxrwxrwx. 1 root root  9 Feb  1 10:46 ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-0 -> ../../sdg\nlrwxrwxrwx. 1 root root  9 Feb  1 10:44 ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-1 -> ../../sdh\n\n# sanlun lun show\ncontroller(7mode)/                                                                               device          host                  lun    \nvserver(Cmode)       lun-pathname                                                                filename        adapter    protocol   size    mode \n---------------------------------------------------------------------------------------------------------------------------------------------------\n1081809-413161-N2    /vol/OpenStack_103a49bb861e485ea05aa78f9b0216bd_1/vol-00000552/vol-00000552 /dev/sdh        host7      iSCSI      2g      7    \n1081809-413161-N2    <unknown>                                                                   /dev/sdg        host7      iSCSI              7    \n\n4) attach volume 1G to the same instance (LUN0 is reused for different volume)\n\nExpected result:\nInstance can see new 1G device attached\n\nActual result:\nInstance is reporting the size to be 3G.\n\nHost OS is also reporting 3G. SCSI tools report correct size (1G).\n\ninstance# lsblk\nNAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\n...\nvdc    252:32   0   3G  0 disk \nvdd    252:48   0   2G  0 disk \n\ncompute# virsh domblklist i-000005dc\nTarget     Source\n------------------------------------------------\n...\nvdc        /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-0\nvdd        /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-1\n\ncompute# ls -l /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-?\nlrwxrwxrwx. 1 root root 9 Feb  1 10:47 /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-0 -> ../../sdg\nlrwxrwxrwx. 1 root root 9 Feb  1 10:47 /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-1 -> ../../sdh\n\ncompute# lsblk\n...\nsdg                                        8:96   0     3G  0 disk \nsdh                                        8:112  0     2G  0 disk \n\ncompute# sanlun lun show\ncontroller(7mode)/                                                                               device          host                  lun    \nvserver(Cmode)       lun-pathname                                                                filename        adapter    protocol   size    mode \n---------------------------------------------------------------------------------------------------------------------------------------------------\n1081809-413161-N2    /vol/OpenStack_103a49bb861e485ea05aa78f9b0216bd_1/vol-00000552/vol-00000552 /dev/sdh        host7      iSCSI      2g      7    \n1081809-413161-N2    /vol/OpenStack_103a49bb861e485ea05aa78f9b0216bd_1/vol-00000551/vol-00000551 /dev/sdg        host7      iSCSI      1g      7    \n\n\nI'm attaching also more outputs with preserved formatting (outputs.txt) ..\n\nRegards,\n\nBrano Zarnovican", 
    "tags": [
        "havana-backport-potential", 
        "iscsi", 
        "libvirt"
    ], 
    "importance": "Medium", 
    "heat": 36, 
    "link": "https://bugs.launchpad.net/nova/+bug/1112483", 
    "owner": "https://api.launchpad.net/1.0/~jdillaman", 
    "id": 1112483, 
    "index": 3215, 
    "created": "2013-02-01 13:11:47.799669+00:00", 
    "title": "LibvirtISCSIVolumeDriver: device size mismatch when LUN is reused", 
    "comments": [
        {
            "content": "Short problem summary:\n====================\n\nWhen LUN id is reused by SCSI provider, it may cause device size mismatch on the compute node. Host may report to guest the device size corresponding to volume previously mapped to this LUN id, not the device that is mapped there now. This happens for SCSI providers that use one target with many LUNs (eg Netapp).\n\nDetailed problem description:\n========================\n\nOpenstack iSCSI client in disconnect_volume() will call iscsiadm with --logout only if nobody else is using LUNs from that target. Otherwise, it will do nothing. Device stays there..\n\n# ls -l /dev/disk/by-path/ip-172.30.128.3\\:3260-iscsi-iqn.1992-08.com.netapp\\:node.netapp02-lun-0\nlrwxrwxrwx. 1 root root 9 Feb  1 11:06 /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-0 -> ../../sdg\n\nLater, nova-volume will unmap LUN from the initiator. This devices becomes invalid. Example \"sanlun\" output:\n\n# sanlun lun show\ncontroller(7mode)/                                                                               device          host                  lun    \nvserver(Cmode)       lun-pathname                                                                filename        adapter    protocol   size    mode \n---------------------------------------------------------------------------------------------------------------------------------------------------\n1081809-413161-N2    <unknown>                                                                   /dev/sdg        host7      iSCSI              7    \n\nAt some point, a different volume needs to be made available to the same compute node. Remote SCSI provider may choose to recycle an unused LUN id. From client's point of view, a different Openstack volume is visible under the same target and LUN id (as used before). After nova-volume completed LUN mapping, nova-compute's connect_volume() is called. Note that, at this point, iSCSI session to the target is up and device symlink (/dev/disk/by-path/..) exists. Openstack iSCSI driver will call \"iscsiadm .. --login\" (with no effect). Rescan is not called, because the device exists. Libvirt and VM will start to use device..\n\nAccess to the re-mapped device will produce \nFeb  1 11:06:45 prod-cmp10 kernel: sd 7:0:0:1: [sdh] Warning! Received an indication that the LUN assignments on this target have changed. The Linux SCSI layer does not automatically remap LUN assignments.\nFeb  1 11:06:45 prod-cmp10 kernel: sd 7:0:0:0: [sdg] Result: hostbyte=DID_OK driverbyte=DRIVER_SENSE\nFeb  1 11:06:45 prod-cmp10 kernel: sd 7:0:0:0: [sdg] Sense Key : Illegal Request [current] \nFeb  1 11:06:45 prod-cmp10 kernel: Info fld=0x0\n\nFor some strange reason, kernel reports the warning on device that did NOT change (\"sdh\" vs \"sdg\"). Possible bug in Linux iSCSI client ?\n\nThis issue affects SCSI systems where there are targets with multiple LUNs (eg Netapp). Openstack implementation on LVM/tgtd backend is not affected because there are multiple targets with single LUN. When the LUN becomes unused, driver will close the whole session.\n\nSteps to reproduce:\n================\n\n1) create tree volumes with different sizes (1, 2, 3GB)\n\n# euca-describe-volumes vol-00000551 vol-00000552 vol-00000553\nVOLUME\tvol-00000551\t 1\t\tna.dev-netapp\tavailable\t2013-02-01T09:32:01.000Z\nVOLUME\tvol-00000552\t 2\t\tna.dev-netapp\tavailable\t2013-02-01T09:32:07.000Z\nVOLUME\tvol-00000553\t 3\t\tna.dev-netapp\tavailable\t2013-02-01T09:32:13.000Z\n\n2) attach volumes 3G, 2G to an instance\n\ncompute node# virsh domblklist i-000005dc\nTarget     Source\n------------------------------------------------\n...\nvdc        /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-0\nvdd        /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-1\n\ninstance# lsblk\nNAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\n...\nvdc    252:32   0   3G  0 disk \nvdd    252:48   0   2G  0 disk \n\n3) detach volume 3G (LUN0 becomes unused)\n\nDevice still exists\n\n# ls -l /dev/disk/by-path/\n...\nlrwxrwxrwx. 1 root root  9 Feb  1 10:46 ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-0 -> ../../sdg\nlrwxrwxrwx. 1 root root  9 Feb  1 10:44 ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-1 -> ../../sdh\n\n# sanlun lun show\ncontroller(7mode)/                                                                               device          host                  lun    \nvserver(Cmode)       lun-pathname                                                                filename        adapter    protocol   size    mode \n---------------------------------------------------------------------------------------------------------------------------------------------------\n1081809-413161-N2    /vol/OpenStack_103a49bb861e485ea05aa78f9b0216bd_1/vol-00000552/vol-00000552 /dev/sdh        host7      iSCSI      2g      7    \n1081809-413161-N2    <unknown>                                                                   /dev/sdg        host7      iSCSI              7    \n\n4) attach volume 1G to the same instance (LUN0 is reused for different volume)\n\nExpected result:\nInstance can see new 1G device attached\n\nActual result:\nInstance is reporting the size to be 3G.\n\nHost OS is also reporting 3G. SCSI tools report correct size (1G).\n\ninstance# lsblk\nNAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\n...\nvdc    252:32   0   3G  0 disk \nvdd    252:48   0   2G  0 disk \n\ncompute# virsh domblklist i-000005dc\nTarget     Source\n------------------------------------------------\n...\nvdc        /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-0\nvdd        /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-1\n\ncompute# ls -l /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-?\nlrwxrwxrwx. 1 root root 9 Feb  1 10:47 /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-0 -> ../../sdg\nlrwxrwxrwx. 1 root root 9 Feb  1 10:47 /dev/disk/by-path/ip-172.30.128.3:3260-iscsi-iqn.1992-08.com.netapp:node.netapp02-lun-1 -> ../../sdh\n\ncompute# lsblk\n...\nsdg                                        8:96   0     3G  0 disk \nsdh                                        8:112  0     2G  0 disk \n\ncompute# sanlun lun show\ncontroller(7mode)/                                                                               device          host                  lun    \nvserver(Cmode)       lun-pathname                                                                filename        adapter    protocol   size    mode \n---------------------------------------------------------------------------------------------------------------------------------------------------\n1081809-413161-N2    /vol/OpenStack_103a49bb861e485ea05aa78f9b0216bd_1/vol-00000552/vol-00000552 /dev/sdh        host7      iSCSI      2g      7    \n1081809-413161-N2    /vol/OpenStack_103a49bb861e485ea05aa78f9b0216bd_1/vol-00000551/vol-00000551 /dev/sdg        host7      iSCSI      1g      7    \n\n\nI'm attaching also more outputs with preserved formatting (outputs.txt) ..\n\nRegards,\n\nBrano Zarnovican", 
            "date_created": "2013-02-01 13:11:47.799669+00:00", 
            "author": "https://api.launchpad.net/1.0/~zarnovican"
        }, 
        {
            "content": "", 
            "date_created": "2013-02-01 13:11:47.799669+00:00", 
            "author": "https://api.launchpad.net/1.0/~zarnovican"
        }, 
        {
            "content": "I forgot to add sw versions..\n\nScientificLinux 6.3\nkernel-2.6.32-279.11.1.el6.x86_64\niscsi-initiator-utils-6.2.0.872-41.el6.x86_64\nOpenstack Essex 2012.1.3 (most likely affects also Folsom, master)\nNetapp OnTAP 7.3.6P5\n\nOne option to fix this problem:\n\nDuring disconnect_volume()..\n1) if this was the last LUN in a session, close the session (as it is doing now)\n2) otherwise delete that single device\n\necho 1 > /sys/block/sdX/device/delete\n\nThis is easier said than done, because 'rootwrap' module does not natively support \"echo 1 > /something\" :(\n", 
            "date_created": "2013-02-01 13:40:57.301742+00:00", 
            "author": "https://api.launchpad.net/1.0/~zarnovican"
        }, 
        {
            "content": "Can you attach the nova-compute log files when this happens?", 
            "date_created": "2013-02-04 19:13:27.026336+00:00", 
            "author": "https://api.launchpad.net/1.0/~zulcss"
        }, 
        {
            "content": "As per request, I'm attaching compute.log on DEBUG. There are three chunks of logs corresponding to the three steps to reproduce the problem.\n\nWe are running a slightly patched version of Essex. One patch introduced a log message which you might not be familiar with.. (grep for \"Attaching device\"). I believe that none of the patches on top of Essex introduced the problem described above. Anyway, it should be easily reproducible in any environment if you have Netapp at hand.\n", 
            "date_created": "2013-02-05 10:20:19.509982+00:00", 
            "author": "https://api.launchpad.net/1.0/~zarnovican"
        }, 
        {
            "content": "There are several ways to fix/workaround the problem..\n\nThe solution I liked most is to delete the device when Openstack stops using it (see patch). At the time this code is called in disconnect_volume(), the LUN is still mapped to compute node, but not used by libvirt. Soon after that, nova-volume will unmap the LUN.\n\nWhen some other volume will reuse the same LUN id, nova-compute will find the device missing and force rescan. This will create the device anew and do the usual kernel sensing..\n\nImplementation side-note: I had a real struggle to implement \"echo 1 > /sys/block/..\". Eventually I got it working as \"echo 1 | sudo cp /dev/stdin /sys/block/..\". I guess there could be a better support in rootwrap for this kind of use-case.\n", 
            "date_created": "2013-02-05 10:33:01.844974+00:00", 
            "author": "https://api.launchpad.net/1.0/~zarnovican"
        }, 
        {
            "content": "We use Netapp and the bug occurs at our site too. We've applied Brano's patch and could fix it successfully. ", 
            "date_created": "2013-02-07 20:49:10.796152+00:00", 
            "author": "https://api.launchpad.net/1.0/~gustavo-randich"
        }, 
        {
            "content": "I just found today (after days of troubleshooting) that OpenStack is calling disconnect_volume when terminating stopped instance. Because volume will retain 'connection_info' even after it is detached, this will lead to possibility that the code from my patch will delete SCSI device belonging to other volume. Remember that LUN id is reused and several volumes may have identical 'connection_info' details.\n\nI hereby renounce my own patch as \"unfit\" and will provide an updated one in the near future.\n", 
            "date_created": "2013-03-19 15:21:11.329682+00:00", 
            "author": "https://api.launchpad.net/1.0/~zarnovican"
        }, 
        {
            "content": "Here is the updated patch..\n\nWARNING: This patch significantly changes how Essex is handling volume connect/disconnect.\n\nThe cleanest option to address the problem of reusing LUN id was to remove the information about the old LUN id from the database. After this patch, code will wipe-out \"connection_info\" column from \"block_device_mapping\" table, when volume is disconnected. I found only two places in Essex where it needs to be done. There are couple more in 'master' branch. So, this patch should only be applied Essex and would need significant update for later releases.\n\nIf there is no info in DB on what was the LUN id when this volume was connected, then there is no chance that any future call to 'disconnect_volume' will cause harm to volume using the same LUN id now..\n\nYou may also look at related mail-thread with \"Libvirt iSCSI client: duplicit connection_info data\" subject..\n", 
            "date_created": "2013-04-03 13:58:47.170814+00:00", 
            "author": "https://api.launchpad.net/1.0/~zarnovican"
        }, 
        {
            "content": "I'm running a Folsom environment with a NetApp appliance and this bug affects me as well. So it's definitely not localized to Essex.\n", 
            "date_created": "2013-04-09 21:55:19.498132+00:00", 
            "author": "https://api.launchpad.net/1.0/~joe-topjian-v"
        }, 
        {
            "content": "@Joe, I believe that Folsom is affected too. I briefly reviewed the code. I shared the patch for Essex only, because that's what we are running. The same patch might work in Folsom, but there are couple more places where the 'connection_info' should be cleared. If you won't hit that part of code (eg live migration) then you should be fine with the patch posted above. In the couple of weeks we will be migrating to Folsom and I will share again the updated patch when it is ready.", 
            "date_created": "2013-04-10 06:28:26.163116+00:00", 
            "author": "https://api.launchpad.net/1.0/~zarnovican"
        }, 
        {
            "content": "Thanks, Brano! For the time being, I am going to write an external script triggered via cron to cleanup connection_info. While doing this in Nova would be more efficient, I don't want to modify Nova unless I absolutely have to. My volume traffic is low enough that a periodic cron cleanup should work.", 
            "date_created": "2013-04-10 14:38:44.680676+00:00", 
            "author": "https://api.launchpad.net/1.0/~joe-topjian-v"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/37907", 
            "date_created": "2013-07-19 14:09:53.729637+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hello Jason, do we have patch released for this issue for grizzly , we have a setup which runs 10 compute nodes , because of this problem we are not able to create any volume and assign it, or do we have any work around for it to solve it. ", 
            "date_created": "2013-11-20 05:59:38.515497+00:00", 
            "author": "https://api.launchpad.net/1.0/~riteshnanda09"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/37907\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8a6ee4808782820cc0938519eb3db63a5eb9a2ff\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8a6ee4808782820cc0938519eb3db63a5eb9a2ff\nAuthor: Jason Dillaman <email address hidden>\nDate:   Wed Jul 17 16:17:08 2013 -0400\n\n    Delete iSCSI devices after volume detached\n    \n    Previously, after detaching from a volume, the iSCSI device\n    remains attached on the compute node until all LUNs for a given\n    IQN are detached -- causing issues when LUNs are reused for\n    different volumes. This change will delete the device(s)\n    associated with the detached volume so LUNs can be reused.\n    \n    Fixes bug 1112483\n    Change-Id: Icae3ec4d1ee2036fbba7b9eb5c03a1c86014fcc0\n", 
            "date_created": "2014-01-09 02:10:50.292543+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/112391", 
            "date_created": "2014-08-06 19:34:45.270267+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Alan Pevec (<email address hidden>) on branch: stable/havana\nReview: https://review.openstack.org/112391\nReason: Final Havana release 2013.2.4 has been cut and stable/havana is going to be removed in a week.", 
            "date_created": "2014-09-22 10:15:05.737174+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}