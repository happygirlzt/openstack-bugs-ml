{
    "status": "Fix Released", 
    "last_updated": "2014-07-31 07:37:37.326544+00:00", 
    "description": "reproduce steps in my devstack env with latest master branch:\n1. change the nova.conf (#force_config_drive = always) and restart nova-compute\n2. download the cirros bootable qcow2 image cirros-0.3.0-x86_64-disk.img(wget https://launchpad.net/cirros/trunk/0.3.0/+download/cirros-0.3.0-x86_64-disk.img)\n3. upload the image to glance\n4. nova boot --flavor m1.nano --image cirros-0.3.0-x86_64-disk.img --file /etc/xxx/yyy=./start_nvs.sh test-inject\n\nthe reason is that, we don't `mkdir -p /etc/xxx/yyy` before `tee` like the folsom version.\n\nThe trace log:\n2014-01-26 11:59:18.948 ERROR nova.compute.manager [req-91698f94-67b6-483e-a6cf-1cade5f19fe6 admin admin] [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Error: Unexpected error while running command.\nCommand: tee /tmp/openstack-vfs-localfsrGqEY7/etc/xxx/yyy\nExit code: 1\nStdout: '#! /bin/bash\\nsudo pkill keystone\\nsudo pkill glance\\nsudo pkill nova-\\n\\nsudo keystone-all > ~/key.log 2>&1 &\\nsudo glance-api > ~/gapi.log 2>&1 &\\nsudo glance-registry > ~/greg.log 2>&1 &\\n\\nsudo nova-conductor >~/cond.log 2>&1 &\\nsudo nova-api >~/api.log 2>&1 &\\nsudo nova-scheduler >~/sch.log 2>&1 &\\nsudo nova-compute >~/com.log 2>&1 &\\nsudo nova-network >~/net.log 2>&1 &\\n'\nStderr: 'tee: /tmp/openstack-vfs-localfsrGqEY7/etc/xxx/yyy: No such file or directory\\n'\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Traceback (most recent call last):\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1054, in _build_instance\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     set_access_ip=set_access_ip)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/compute/manager.py\", line 357, in decorated_function\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     return function(self, context, *args, **kwargs)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1463, in _spawn\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     LOG.exception(_('Instance failed to spawn'), instance=instance)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     six.reraise(self.type_, self.value, self.tb)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1460, in _spawn\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     block_device_info)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2182, in spawn\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     admin_pass=admin_password)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2592, in _create_image\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     injection_path = image('disk').path\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     six.reraise(self.type_, self.value, self.tb)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2592, in _create_image\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     injection_path = image('disk').path\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 351, in inject_data\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     admin_password, files, mandatory)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 431, in inject_data_into_fs\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     inject_func(inject_val, fs)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 443, in _inject_files_into_fs\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     _inject_file_into_fs(fs, path, contents)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 452, in _inject_file_into_fs\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     fs.replace_file(path, contents)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/disk/vfs/localfs.py\", line 123, in replace_file\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     utils.execute('tee', *args, **kwargs)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/utils.py\", line 166, in execute\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     return processutils.execute(*cmd, **kwargs)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/openstack/common/processutils.py\", line 178, in execute\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     cmd=' '.join(cmd))\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] ProcessExecutionError: Unexpected error while running command.\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Command: tee /tmp/openstack-vfs-localfsrGqEY7/etc/xxx/yyy\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Exit code: 1\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Stdout: '#! /bin/bash\\nsudo pkill keystone\\nsudo pkill glance\\nsudo pkill nova-\\n\\nsudo keystone-all > ~/key.log 2>&1 &\\nsudo glance-api > ~/gapi.log 2>&1 &\\nsudo glance-registry > ~/greg.log 2>&1 &\\n\\nsudo nova-conductor >~/cond.log 2>&1 &\\nsudo nova-api >~/api.log 2>&1 &\\nsudo nova-scheduler >~/sch.log 2>&1 &\\nsudo nova-compute >~/com.log 2>&1 &\\nsudo nova-network >~/net.log 2>&1 &\\n'\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Stderr: 'tee: /tmp/openstack-vfs-localfsrGqEY7/etc/xxx/yyy: No such file or directory\\n'\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]", 
    "tags": [
        "compute"
    ], 
    "importance": "Undecided", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1272829", 
    "owner": "https://api.launchpad.net/1.0/~hzwangpan", 
    "id": 1272829, 
    "index": 4504, 
    "created": "2014-01-26 04:19:16.012538+00:00", 
    "title": "intance boots failed because of injecting a file to a not exist path in image", 
    "comments": [
        {
            "content": "reproduce steps in my devstack env with latest master branch:\n1. change the nova.conf (#force_config_drive = always) and restart nova-compute\n2. download the cirros bootable qcow2 image cirros-0.3.0-x86_64-disk.img(wget https://launchpad.net/cirros/trunk/0.3.0/+download/cirros-0.3.0-x86_64-disk.img)\n3. upload the image to glance\n3. nova boot --flavor m1.nano --image cirros-0.3.0-x86_64-disk.img --file /etc/xxx/yyy=./start_nvs.sh test-inject\n\nthe reason is that, we don't `mkdir -p /etc/xxx/yyy` before `tee` like the folsom version.\n\nThe trace log:\n2014-01-26 11:59:18.948 ERROR nova.compute.manager [req-91698f94-67b6-483e-a6cf-1cade5f19fe6 admin admin] [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Error: Unexpected error while running command.\nCommand: tee /tmp/openstack-vfs-localfsrGqEY7/etc/xxx/yyy\nExit code: 1\nStdout: '#! /bin/bash\\nsudo pkill keystone\\nsudo pkill glance\\nsudo pkill nova-\\n\\nsudo keystone-all > ~/key.log 2>&1 &\\nsudo glance-api > ~/gapi.log 2>&1 &\\nsudo glance-registry > ~/greg.log 2>&1 &\\n\\nsudo nova-conductor >~/cond.log 2>&1 &\\nsudo nova-api >~/api.log 2>&1 &\\nsudo nova-scheduler >~/sch.log 2>&1 &\\nsudo nova-compute >~/com.log 2>&1 &\\nsudo nova-network >~/net.log 2>&1 &\\n'\nStderr: 'tee: /tmp/openstack-vfs-localfsrGqEY7/etc/xxx/yyy: No such file or directory\\n'\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Traceback (most recent call last):\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1054, in _build_instance\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     set_access_ip=set_access_ip)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/compute/manager.py\", line 357, in decorated_function\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     return function(self, context, *args, **kwargs)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1463, in _spawn\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     LOG.exception(_('Instance failed to spawn'), instance=instance)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     six.reraise(self.type_, self.value, self.tb)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1460, in _spawn\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     block_device_info)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2182, in spawn\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     admin_pass=admin_password)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2592, in _create_image\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     injection_path = image('disk').path\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     six.reraise(self.type_, self.value, self.tb)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2592, in _create_image\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     injection_path = image('disk').path\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 351, in inject_data\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     admin_password, files, mandatory)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 431, in inject_data_into_fs\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     inject_func(inject_val, fs)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 443, in _inject_files_into_fs\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     _inject_file_into_fs(fs, path, contents)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 452, in _inject_file_into_fs\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     fs.replace_file(path, contents)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/virt/disk/vfs/localfs.py\", line 123, in replace_file\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     utils.execute('tee', *args, **kwargs)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/utils.py\", line 166, in execute\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     return processutils.execute(*cmd, **kwargs)\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]   File \"/opt/stack/nova/nova/openstack/common/processutils.py\", line 178, in execute\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]     cmd=' '.join(cmd))\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] ProcessExecutionError: Unexpected error while running command.\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Command: tee /tmp/openstack-vfs-localfsrGqEY7/etc/xxx/yyy\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Exit code: 1\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Stdout: '#! /bin/bash\\nsudo pkill keystone\\nsudo pkill glance\\nsudo pkill nova-\\n\\nsudo keystone-all > ~/key.log 2>&1 &\\nsudo glance-api > ~/gapi.log 2>&1 &\\nsudo glance-registry > ~/greg.log 2>&1 &\\n\\nsudo nova-conductor >~/cond.log 2>&1 &\\nsudo nova-api >~/api.log 2>&1 &\\nsudo nova-scheduler >~/sch.log 2>&1 &\\nsudo nova-compute >~/com.log 2>&1 &\\nsudo nova-network >~/net.log 2>&1 &\\n'\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e] Stderr: 'tee: /tmp/openstack-vfs-localfsrGqEY7/etc/xxx/yyy: No such file or directory\\n'\n2014-01-26 11:59:18.948 TRACE nova.compute.manager [instance: aa481bea-2822-4eca-89b1-d0d7734d9b9e]", 
            "date_created": "2014-01-26 04:19:16.012538+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "I have reproduced  the bug with libvirt driver.", 
            "date_created": "2014-01-26 10:19:10.313142+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/69185", 
            "date_created": "2014-01-26 11:34:28.520820+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi sahid, I have already commited a patch here:\nhttps://review.openstack.org/#/c/69175/", 
            "date_created": "2014-01-27 01:58:44.454196+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/69175\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=af8972a21b1f6da7ef470bae52fdbd47c3a5afeb\nSubmitter: Jenkins\nBranch:    master\n\ncommit af8972a21b1f6da7ef470bae52fdbd47c3a5afeb\nAuthor: Wangpan <email address hidden>\nDate:   Sun Jan 26 14:38:00 2014 +0800\n\n    Ensure parent dir exists while injecting files\n    \n    Currently, if we inject a file to a not existing path,\n    the injecting will be failed with error 'No such file\n    or directory'.\n    Nova will firstly execute `mkdir -p` in folsom before injecting,\n    but this operation is lost from commit\n    72918415f2b6a241d6097a563aba55a849936591\n    \n    This patch fix this bug by adding the `mkdir -p` operation as folsom.\n    \n    Closes-bug: #1272829\n    \n    Change-Id: If33a79c538e07cb25300db64ac7a9dee3d3b19c2\n", 
            "date_created": "2014-03-03 16:42:23.680605+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This bug also exists in stable havana, we should backport this commit to havana.", 
            "date_created": "2014-03-05 02:48:39.106419+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/78074", 
            "date_created": "2014-03-05 02:53:07.383295+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Wangpan (<email address hidden>) on branch: stable/havana\nReview: https://review.openstack.org/78074", 
            "date_created": "2014-07-31 07:37:36.250609+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}