{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:12:09.015142+00:00", 
    "description": "condition: reclaim_instance_interval > 0 in nova.conf\n\nI am testing soft-delete , found that quota_usages table will lead to error\nresult. when an instance was soft-deleted , before it was deleted completely by period task i soft-delete it again, the quato_usages table will reduce double resource of this instance.\n\nthe reason is that every execution of soft-delete instance,  the reservation will commit.\n\nhow to fixed it: we should make reservations=None when instance.vm_state='soft-deleted'.\n\n\nhow to reproduct it:\n\ni am project_id='30528b0d602c4a9c9d8b4cd3d416d710', and I have an instance:\n\nubuntu@xfolsom:/opt/stack/nova$ nova list\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks         |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| 6f6c1258-6eda-43f1-9531-7a4eb0b44724 | test | ACTIVE | -          | Running     | private=10.0.0.2 |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n\n1.first select from quota_usage, the result is :\n\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2014-06-20 08:24:35 | 2014-06-23 08:35:03 | NULL       |  1 | 30528b0d602c4a9c9d8b4cd3d416d710 | instances       |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:35:03 | NULL       |  2 | 30528b0d602c4a9c9d8b4cd3d416d710 | ram             |     64 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:35:03 | NULL       |  3 | 30528b0d602c4a9c9d8b4cd3d416d710 | cores           |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-20 08:24:35 | NULL       |  4 | 30528b0d602c4a9c9d8b4cd3d416d710 | security_groups |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:36 | 2014-06-23 03:56:03 | NULL       |  5 | 30528b0d602c4a9c9d8b4cd3d416d710 | fixed_ips       |      1 |        0 |          NULL |       0 | NULL                             |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n5 rows in set (0.00 sec)\n\n2.using nova-network, set reclaim_instance_interval=600 in nova.conf.\n3.nova delete 6f6c1258-6eda-43f1-9531-7a4eb0b44724\n4. select from quota_usages, result is :\n\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2014-06-20 08:24:35 | 2014-06-23 08:42:30 | NULL       |  1 | 30528b0d602c4a9c9d8b4cd3d416d710 | instances       |      0 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:42:30 | NULL       |  2 | 30528b0d602c4a9c9d8b4cd3d416d710 | ram             |      0 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:42:30 | NULL       |  3 | 30528b0d602c4a9c9d8b4cd3d416d710 | cores           |      0 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-20 08:24:35 | NULL       |  4 | 30528b0d602c4a9c9d8b4cd3d416d710 | security_groups |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:36 | 2014-06-23 03:56:03 | NULL       |  5 | 30528b0d602c4a9c9d8b4cd3d416d710 | fixed_ips       |      1 |        0 |          NULL |       0 | NULL                             |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n5 rows in set (0.00 sec)\n\n5. nova delete 6f6c1258-6eda-43f1-9531-7a4eb0b44724 again\n\nthen select from quota_usages, result is :\n\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2014-06-20 08:24:35 | 2014-06-23 08:43:38 | NULL       |  1 | 30528b0d602c4a9c9d8b4cd3d416d710 | instances       |     -1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:43:38 | NULL       |  2 | 30528b0d602c4a9c9d8b4cd3d416d710 | ram             |    -64 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:43:38 | NULL       |  3 | 30528b0d602c4a9c9d8b4cd3d416d710 | cores           |     -1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-20 08:24:35 | NULL       |  4 | 30528b0d602c4a9c9d8b4cd3d416d710 | security_groups |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:36 | 2014-06-23 03:56:03 | NULL       |  5 | 30528b0d602c4a9c9d8b4cd3d416d710 | fixed_ips       |      1 |        0 |          NULL |       0 | NULL                             |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n5 rows in set (0.00 sec)\n\noh my god!!! instance in_use is -1 and ram in_use is -64Mb, do you think this is right?\n\n6.nova restore 6f6c1258-6eda-43f1-9531-7a4eb0b44724\n\u00a0now the db result is:\n\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2014-06-20 08:24:35 | 2014-06-23 08:44:41 | NULL       |  1 | 30528b0d602c4a9c9d8b4cd3d416d710 | instances       |      2 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:44:41 | NULL       |  2 | 30528b0d602c4a9c9d8b4cd3d416d710 | ram             |    128 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:44:41 | NULL       |  3 | 30528b0d602c4a9c9d8b4cd3d416d710 | cores           |      2 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-20 08:24:35 | NULL       |  4 | 30528b0d602c4a9c9d8b4cd3d416d710 | security_groups |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:36 | 2014-06-23 03:56:03 | NULL       |  5 | 30528b0d602c4a9c9d8b4cd3d416d710 | fixed_ips       |      1 |        0 |          NULL |       0 | NULL                             |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n5 rows in set (0.00 sec)\n\nobviously, the result in db is error.now I have only one instance, but in db, i have used 2 instances, 2 cores , 128Mb ram and so on.\n\nThe correct way is that we should not allow deleting instance which status  in  soft-delete.", 
    "tags": [
        "quota"
    ], 
    "importance": "Medium", 
    "heat": 24, 
    "link": "https://bugs.launchpad.net/nova/+bug/1333145", 
    "owner": "https://api.launchpad.net/1.0/~snikitin", 
    "id": 1333145, 
    "index": 3933, 
    "created": "2014-06-23 08:47:25.193775+00:00", 
    "title": "quota-usage error in soft-delete ", 
    "comments": [
        {
            "content": "how to reproduct it:\n\ni am project_id='30528b0d602c4a9c9d8b4cd3d416d710', and I have an instance:\n\nubuntu@xfolsom:/opt/stack/nova$ nova list\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks         |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| 6f6c1258-6eda-43f1-9531-7a4eb0b44724 | test | ACTIVE | -          | Running     | private=10.0.0.2 |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n\n\n1.first select from quota_usage, the result is :\n\nmysql> select * from quota_usages;                                                                                                                                      \n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2014-06-20 08:24:35 | 2014-06-23 08:35:03 | NULL       |  1 | 30528b0d602c4a9c9d8b4cd3d416d710 | instances       |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:35:03 | NULL       |  2 | 30528b0d602c4a9c9d8b4cd3d416d710 | ram             |     64 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:35:03 | NULL       |  3 | 30528b0d602c4a9c9d8b4cd3d416d710 | cores           |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-20 08:24:35 | NULL       |  4 | 30528b0d602c4a9c9d8b4cd3d416d710 | security_groups |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:36 | 2014-06-23 03:56:03 | NULL       |  5 | 30528b0d602c4a9c9d8b4cd3d416d710 | fixed_ips       |      1 |        0 |          NULL |       0 | NULL                             |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n5 rows in set (0.00 sec)\n\n\n2.using nova-network, set reclaim_instance_interval=600 in nova.conf.\n3.nova delete 6f6c1258-6eda-43f1-9531-7a4eb0b44724\n4. select from quota_usages, result is :\n\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2014-06-20 08:24:35 | 2014-06-23 08:42:30 | NULL       |  1 | 30528b0d602c4a9c9d8b4cd3d416d710 | instances       |      0 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:42:30 | NULL       |  2 | 30528b0d602c4a9c9d8b4cd3d416d710 | ram             |      0 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:42:30 | NULL       |  3 | 30528b0d602c4a9c9d8b4cd3d416d710 | cores           |      0 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-20 08:24:35 | NULL       |  4 | 30528b0d602c4a9c9d8b4cd3d416d710 | security_groups |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:36 | 2014-06-23 03:56:03 | NULL       |  5 | 30528b0d602c4a9c9d8b4cd3d416d710 | fixed_ips       |      1 |        0 |          NULL |       0 | NULL                             |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n5 rows in set (0.00 sec)\n\n\n\n5. nova delete 6f6c1258-6eda-43f1-9531-7a4eb0b44724 again\n\nthen select from quota_usages, result is :\n\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2014-06-20 08:24:35 | 2014-06-23 08:43:38 | NULL       |  1 | 30528b0d602c4a9c9d8b4cd3d416d710 | instances       |     -1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:43:38 | NULL       |  2 | 30528b0d602c4a9c9d8b4cd3d416d710 | ram             |    -64 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:43:38 | NULL       |  3 | 30528b0d602c4a9c9d8b4cd3d416d710 | cores           |     -1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-20 08:24:35 | NULL       |  4 | 30528b0d602c4a9c9d8b4cd3d416d710 | security_groups |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:36 | 2014-06-23 03:56:03 | NULL       |  5 | 30528b0d602c4a9c9d8b4cd3d416d710 | fixed_ips       |      1 |        0 |          NULL |       0 | NULL                             |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n5 rows in set (0.00 sec)\n\n6.nova restore 6f6c1258-6eda-43f1-9531-7a4eb0b44724 \n now the db result is:\n\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource        | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n| 2014-06-20 08:24:35 | 2014-06-23 08:44:41 | NULL       |  1 | 30528b0d602c4a9c9d8b4cd3d416d710 | instances       |      2 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:44:41 | NULL       |  2 | 30528b0d602c4a9c9d8b4cd3d416d710 | ram             |    128 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-23 08:44:41 | NULL       |  3 | 30528b0d602c4a9c9d8b4cd3d416d710 | cores           |      2 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:35 | 2014-06-20 08:24:35 | NULL       |  4 | 30528b0d602c4a9c9d8b4cd3d416d710 | security_groups |      1 |        0 |          NULL |       0 | e522bb6fecaa4a69b6d7df69211dab13 |\n| 2014-06-20 08:24:36 | 2014-06-23 03:56:03 | NULL       |  5 | 30528b0d602c4a9c9d8b4cd3d416d710 | fixed_ips       |      1 |        0 |          NULL |       0 | NULL                             |\n+---------------------+---------------------+------------+----+----------------------------------+-----------------+--------+----------+---------------+---------+----------------------------------+\n5 rows in set (0.00 sec)\n\nobviously, the result in db is error.now I have only one instance, but in db, i have used 2 instances, 2 cores and so on.\n\n\nThe correct way is that we should not allow deleting instance which status  in  soft-delete.", 
            "date_created": "2014-06-23 08:47:25.193775+00:00", 
            "author": "https://api.launchpad.net/1.0/~xwwzzy"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/102153", 
            "date_created": "2014-06-24 09:20:07.602471+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by hzxiongwenwu (<email address hidden>) on branch: master\nReview: https://review.openstack.org/101855", 
            "date_created": "2014-06-24 09:20:19.306107+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Patch abandoned, not in progress any more", 
            "date_created": "2014-09-17 19:40:41.848651+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Change abandoned by Joe Gordon (<email address hidden>) on branch: master\nReview: https://review.openstack.org/102153\nReason: Patch is stalled waiting for the author, looks like this has been abandoned. Feel free to restore.", 
            "date_created": "2014-10-13 22:48:44.044135+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix here https://review.openstack.org/#/c/128848/", 
            "date_created": "2014-11-19 14:34:32.196992+00:00", 
            "author": "https://api.launchpad.net/1.0/~snikitin"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/128848\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=4546ce0012b526cd370533ba5a3f2f4107d249a2\nSubmitter: Jenkins\nBranch:    master\n\ncommit 4546ce0012b526cd370533ba5a3f2f4107d249a2\nAuthor: Sergey Nikitin <email address hidden>\nDate:   Thu Oct 16 12:31:13 2014 +0400\n\n    Fixed quotas double decreasing problem\n    \n    When we delete vm with status \"soft-delete\" we shouldn't change\n    quota values because they were changed during soft-deleting.\n    \n    Closes-bug: #1333145\n    Change-Id: I3ed7b3245b8908faa02903c74503918f061016bd\n", 
            "date_created": "2014-12-04 17:24:02.631024+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "possibly related to: https://bugs.launchpad.net/nova/+bug/1284424?", 
            "date_created": "2014-12-10 21:08:31.797224+00:00", 
            "author": "https://api.launchpad.net/1.0/~patrick-crews"
        }
    ]
}