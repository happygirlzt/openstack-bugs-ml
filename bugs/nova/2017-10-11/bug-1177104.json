{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:40:30.369932+00:00", 
    "description": "While trying to run this (on grizzly 2013.1):\n\ntempest/tempest/tests/compute/images/test_images_oneserver.py:ImagesOneServerTestJSON.test_create_second_image_when_first_image_is_being_saved\n\nWe get this:\n\n2013-05-06 14:53:51.344 5682 DEBUG nova.utils [-] Running cmd (SSH): lshwres -r mem --level sys -F configurable_sys_mem,curr_avail_sys_mem,sys_firmware_mem ssh_execute /usr/lib/python2.6/site-packages/nova/utils.py:288\n2013-05-06 14:53:51.344 5682 ERROR nova.manager [-] Error during ComputeManager.update_available_resource: SSH session not active\n2013-05-06 14:53:51.344 5682 TRACE nova.manager Traceback (most recent call last):\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/manager.py\", line 244, in periodic_tasks\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     task(self, context)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3898, in update_available_resource\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     nodenames = set(self.driver.get_available_nodes())\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/driver.py\", line 849, in get_available_nodes\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     stats = self.get_host_stats(refresh=True)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/driver.py\", line 97, in get_host_stats\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     return self._powervm.get_host_stats(refresh=refresh)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 170, in get_host_stats\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     self._update_host_stats()\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 174, in _update_host_stats\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     memory_info = self._operator.get_memory_info()\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 852, in get_memory_info\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     output = self.run_vios_command(cmd)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 934, in run_vios_command\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     check_exit_code=check_exit_code)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/utils.py\", line 297, in ssh_execute\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     stdin_stream, stdout_stream, stderr_stream = ssh.exec_command(cmd)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/paramiko/client.py\", line 364, in exec_command\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     chan = self._transport.open_session()\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/paramiko/transport.py\", line 661, in open_session\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     return self.open_channel('session')\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/paramiko/transport.py\", line 730, in open_channel\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     raise SSHException('SSH session not active')\n2013-05-06 14:53:51.344 5682 TRACE nova.manager SSHException: SSH session not active\n\nThis is because the test was ran earlier and the hypervisor was locked up.  The tester rebooted the hypervisor but trying to run the test again results in the SSHException.  This is due to the powervm operator.py code uses a cached paramiko ssh client connection:\n\nhttps://github.com/openstack/nova/blob/master/nova/virt/powervm/operator.py#L467\n\nThe code should check the connection before assuming it's OK and then failing because it's bad.", 
    "tags": [
        "powervm"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1177104", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1177104, 
    "index": 3632, 
    "created": "2013-05-06 21:34:12.544905+00:00", 
    "title": "PowerVM drver uses stale ssh connection if hypervisor is rebooted", 
    "comments": [
        {
            "content": "While trying to run this (on grizzly 2013.1):\n\ntempest/tempest/tests/compute/images/test_images_oneserver.py:ImagesOneServerTestJSON.test_create_second_image_when_first_image_is_being_saved\n\nWe get this:\n\n2013-05-06 14:53:51.344 5682 DEBUG nova.utils [-] Running cmd (SSH): lshwres -r mem --level sys -F configurable_sys_mem,curr_avail_sys_mem,sys_firmware_mem ssh_execute /usr/lib/python2.6/site-packages/nova/utils.py:288\n2013-05-06 14:53:51.344 5682 ERROR nova.manager [-] Error during ComputeManager.update_available_resource: SSH session not active\n2013-05-06 14:53:51.344 5682 TRACE nova.manager Traceback (most recent call last):\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/manager.py\", line 244, in periodic_tasks\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     task(self, context)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 3898, in update_available_resource\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     nodenames = set(self.driver.get_available_nodes())\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/driver.py\", line 849, in get_available_nodes\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     stats = self.get_host_stats(refresh=True)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/driver.py\", line 97, in get_host_stats\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     return self._powervm.get_host_stats(refresh=refresh)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 170, in get_host_stats\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     self._update_host_stats()\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 174, in _update_host_stats\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     memory_info = self._operator.get_memory_info()\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 852, in get_memory_info\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     output = self.run_vios_command(cmd)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 934, in run_vios_command\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     check_exit_code=check_exit_code)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/nova/utils.py\", line 297, in ssh_execute\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     stdin_stream, stdout_stream, stderr_stream = ssh.exec_command(cmd)\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/paramiko/client.py\", line 364, in exec_command\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     chan = self._transport.open_session()\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/paramiko/transport.py\", line 661, in open_session\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     return self.open_channel('session')\n2013-05-06 14:53:51.344 5682 TRACE nova.manager   File \"/usr/lib/python2.6/site-packages/paramiko/transport.py\", line 730, in open_channel\n2013-05-06 14:53:51.344 5682 TRACE nova.manager     raise SSHException('SSH session not active')\n2013-05-06 14:53:51.344 5682 TRACE nova.manager SSHException: SSH session not active\n\nThis is because the test was ran earlier and the hypervisor was locked up.  The tester rebooted the hypervisor but trying to run the test again results in the SSHException.  This is due to the powervm operator.py code uses a cached paramiko ssh client connection:\n\nhttps://github.com/openstack/nova/blob/master/nova/virt/powervm/operator.py#L467\n\nThe code should check the connection before assuming it's OK and then failing because it's bad.", 
            "date_created": "2013-05-06 21:34:12.544905+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/28451", 
            "date_created": "2013-05-07 18:38:35.500380+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/28451\nCommitted: http://github.com/openstack/nova/commit/75545ba974afb1ac76186a8dad359ae0aa751c01\nSubmitter: Jenkins\nBranch:    master\n\ncommit 75545ba974afb1ac76186a8dad359ae0aa751c01\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu May 9 19:15:25 2013 -0700\n\n    Check cached SSH connection in PowerVM driver\n    \n    The PowerVM operator code caches an SSH connection to the hypervisor\n    which can become invalid if the connection to the hypervisor is not\n    terminated cleanly, e.g. the hypervisor is rebooted while the compute\n    node is connected to it.\n    \n    This code checks an existing SSH connection object to see if it's\n    transport is still alive and if not, re-establishes the connection\n    before attempting to run SSH commands on the hypervisor.\n    \n    Also added some basic unit tests to cover the new check_connection\n    function in nova.virt.powervm.common.\n    \n    Fixes bug 1177104\n    \n    Change-Id: I08079cf0d9e60e1d8902d32d684d979b06f7f287\n", 
            "date_created": "2013-05-10 23:34:27.693552+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/grizzly\nReview: https://review.openstack.org/29110", 
            "date_created": "2013-05-14 16:59:18.349926+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}