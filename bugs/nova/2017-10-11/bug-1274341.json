{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:05:47.541906+00:00", 
    "description": "reservation_commit can deadlock under load:\n\n2014-01-29 18:51:00.470 ERROR nova.quota [req-659db2df-6124-4e6a-b86b-700aae1de805 183137d95c584efb84e773a21f2ef7a1 d8d5b06deffc45e7b258eb65ea04017c] Failed to commit reservations ['5bea6421-1648-4fe1-9d21-4232f536e031', '8b27edda-f40e-476c-a9b3-d007aa3f6aac', '58e357df-b45d-4008-9ef3-0da3d8daebbb']\n2014-01-29 18:51:00.470 4380 TRACE nova.quota Traceback (most recent call last):\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/nova/quota.py\", line 982, in commit\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     self._driver.commit(context, reservations, project_id=project_id)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/nova/quota.py\", line 370, in commit\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     db.reservation_commit(context, reservations, project_id=project_id)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 970, in reservation_commit\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     project_id=project_id)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 114, in wrapper\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     return f(*args, **kwargs)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 2786, in reservation_commit\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     for reservation in reservation_query.all():\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2115, in all\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     return list(self)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2227, in __iter__\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     return self._execute_and_instances(context)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2242, in _execute_and_instances\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     result = conn.execute(querycontext.statement, self._params)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1449, in execute\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     params)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1584, in _execute_clauseelement\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     compiled_sql, distilled_params\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1698, in _execute_context\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     context)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1691, in _execute_context\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     context)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 331, in do_execute\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     cursor.execute(statement, parameters)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/MySQLdb/cursors.py\", line 174, in execute\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     self.errorhandler(self, exc, value)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     raise errorclass, errorvalue\n2014-01-29 18:51:00.470 4380 TRACE nova.quota OperationalError: (OperationalError) (1213, 'Deadlock found when trying to get lock; try restarting transaction') 'SELECT reservations.created_at AS reservations_created_at, reservations.updated_at AS reservations_updated_at, reservations.deleted_at AS reservations_deleted_at, reservations.deleted AS reservations_deleted, reservations.id AS reservations_id, reservations.uuid AS reservations_uuid, reservations.usage_id AS reservations_usage_id, reservations.project_id AS reservations_project_id, reservations.resource AS reservations_resource, reservations.delta AS reservations_delta, reservations.expire AS reservations_expire \\nFROM reservations \\nWHERE reservations.deleted = %s AND reservations.uuid IN (%s, %s, %s) FOR UPDATE' (0, '5bea6421-1648-4fe1-9d21-4232f536e031', '8b27edda-f40e-476c-a9b3-d007aa3f6aac', '58e357df-b45d-4008-9ef3-0da3d8daebbb')\n\nThis can be fixed with our @_retry_on_deadlock wrapper", 
    "tags": [
        "in-stable-havana"
    ], 
    "importance": "High", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1274341", 
    "owner": "None", 
    "id": 1274341, 
    "index": 1383, 
    "created": "2014-01-30 00:34:37.619174+00:00", 
    "title": "reservation_commit can lead to deadlock", 
    "comments": [
        {
            "content": "reservation_commit can deadlock under load:\n\n2014-01-29 18:51:00.470 ERROR nova.quota [req-659db2df-6124-4e6a-b86b-700aae1de805 183137d95c584efb84e773a21f2ef7a1 d8d5b06deffc45e7b258eb65ea04017c] Failed to commit reservations ['5bea6421-1648-4fe1-9d21-4232f536e031', '8b27edda-f40e-476c-a9b3-d007aa3f6aac', '58e357df-b45d-4008-9ef3-0da3d8daebbb']\n2014-01-29 18:51:00.470 4380 TRACE nova.quota Traceback (most recent call last):\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/nova/quota.py\", line 982, in commit\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     self._driver.commit(context, reservations, project_id=project_id)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/nova/quota.py\", line 370, in commit\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     db.reservation_commit(context, reservations, project_id=project_id)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 970, in reservation_commit\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     project_id=project_id)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 114, in wrapper\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     return f(*args, **kwargs)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 2786, in reservation_commit\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     for reservation in reservation_query.all():\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2115, in all\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     return list(self)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2227, in __iter__\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     return self._execute_and_instances(context)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2242, in _execute_and_instances\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     result = conn.execute(querycontext.statement, self._params)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1449, in execute\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     params)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1584, in _execute_clauseelement\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     compiled_sql, distilled_params\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1698, in _execute_context\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     context)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1691, in _execute_context\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     context)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 331, in do_execute\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     cursor.execute(statement, parameters)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/MySQLdb/cursors.py\", line 174, in execute\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     self.errorhandler(self, exc, value)\n2014-01-29 18:51:00.470 4380 TRACE nova.quota   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n2014-01-29 18:51:00.470 4380 TRACE nova.quota     raise errorclass, errorvalue\n2014-01-29 18:51:00.470 4380 TRACE nova.quota OperationalError: (OperationalError) (1213, 'Deadlock found when trying to get lock; try restarting transaction') 'SELECT reservations.created_at AS reservations_created_at, reservations.updated_at AS reservations_updated_at, reservations.deleted_at AS reservations_deleted_at, reservations.deleted AS reservations_deleted, reservations.id AS reservations_id, reservations.uuid AS reservations_uuid, reservations.usage_id AS reservations_usage_id, reservations.project_id AS reservations_project_id, reservations.resource AS reservations_resource, reservations.delta AS reservations_delta, reservations.expire AS reservations_expire \\nFROM reservations \\nWHERE reservations.deleted = %s AND reservations.uuid IN (%s, %s, %s) FOR UPDATE' (0, '5bea6421-1648-4fe1-9d21-4232f536e031', '8b27edda-f40e-476c-a9b3-d007aa3f6aac', '58e357df-b45d-4008-9ef3-0da3d8daebbb')\n\nThis can be fixed with our @_retry_on_deadlock wrapper", 
            "date_created": "2014-01-30 00:34:37.619174+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "https://review.openstack.org/#/c/70027/", 
            "date_created": "2014-01-30 02:29:49.970319+00:00", 
            "author": "https://api.launchpad.net/1.0/~liyingjun"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/70027\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=9c556d1557a7056d6056b25d3b91ff4abcb97971\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9c556d1557a7056d6056b25d3b91ff4abcb97971\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Wed Jan 29 16:40:26 2014 -0800\n\n    Retry reservation commit and rollback on deadlock\n    \n    Reservations can deadlock when concurrent commits are run from\n    multiple hosts on the same project. This fixes the issue by using\n    our convienient retry on deadlock feature.\n    \n    Change-Id: I31d74f4267eaa33e798de926069d1a0f63006a59\n    Closes-bug: #1274341\n", 
            "date_created": "2014-01-31 13:05:54.064470+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Is this a duplicate of bug 1250173?", 
            "date_created": "2014-02-05 23:17:12.897873+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/72546", 
            "date_created": "2014-02-11 03:51:21.870379+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/72546\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0d3d7c94b34468980469f412739c5a2aaf633c79\nSubmitter: Jenkins\nBranch:    stable/havana\n\ncommit 0d3d7c94b34468980469f412739c5a2aaf633c79\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Wed Jan 29 16:40:26 2014 -0800\n\n    Retry reservation commit and rollback on deadlock\n    \n    Reservations can deadlock when concurrent commits are run from\n    multiple hosts on the same project. This fixes the issue by using\n    our convienient retry on deadlock feature.\n    \n    Change-Id: I31d74f4267eaa33e798de926069d1a0f63006a59\n    Closes-bug: #1274341\n    (cherry picked from commit 9c556d1557a7056d6056b25d3b91ff4abcb97971)\n", 
            "date_created": "2014-03-06 10:58:47.651042+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}