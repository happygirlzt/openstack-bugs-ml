{
    "status": "In Progress", 
    "last_updated": "2017-06-27 16:03:57.917054+00:00", 
    "description": "The bug is found in Kilo environment. It exists in master.\n\nBefore saving the bdm, the volume has been attached at the hypervisor level.\nWhen save fails, you will see the VM has virtual disk (virsh domblklist)\nbut can't see it when you do nova show or cinder show.\nEven worse, in my IP-SAN environment, the configuration isn't cleaned at the array,\nwhich might make data inconsistent.\n\nnova/virt/block_device.py\n\n    @update_db\n    def attach(self, context, instance, volume_api, virt_driver,\n               do_driver_attach=False, **kwargs):\n    .....\n        if volume['attach_status'] == \"detached\":\n            # NOTE(mriedem): save our current state so connection_info is in\n            # the database before the volume status goes to 'in-use' because\n            # after that we can detach and connection_info is required for\n            # detach.\n            self.save()         <==== Errors here !!!\n            try:\n                volume_api.attach(context, volume_id, instance.uuid,\n                                  self['mount_device'], mode=mode)\n            except Exception:\n                with excutils.save_and_reraise_exception():\n                    if do_driver_attach:\n                        try:\n                            virt_driver.detach_volume(connection_info,\n                                                      instance,\n                                                      self['mount_device'],\n                                                      encryption=encryption)\n                        except Exception:\n                            LOG.warning(_LW(\"Driver failed to detach volume \"\n                                         \"%(volume_id)s at %(mount_point)s.\"),\n                                     {'volume_id': volume_id,\n                                      'mount_point': self['mount_device']},\n                                     exc_info=True, instance=instance)\n                    volume_api.terminate_connection(context, volume_id,\n                                                    connector)\n\n\n\n\nThe trace:\n----------\n2017-05-24 17:24:23.272 3125 ERROR nova.compute.manager [req-6040188f-4338-47a1-855d-4ecc0eb71203 62f52135115f4898bd0d82c1f0cd632b 6c149dcd3cf64171b8dd972dd03bbac0 - - -] [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57] Failed to attach 2421acfd-0f94-4aca-81d0-747bf803aed7 at /dev/vdb\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57] Traceback (most recent call last):\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5226, in _attach_volume\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     do_check_attach=False, do_driver_attach=True)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 53, in wrapped\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     obj.save()\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 321, in save\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     super(DriverVolumeBlockDevice, self).save()\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 143, in save\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     self._bdm_obj.save()\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/objects/base.py\", line 192, in wrapper\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     self._context, self, fn.__name__, args, kwargs)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/conductor/rpcapi.py\", line 340, in object_action\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     objmethod=objmethod, args=args, kwargs=kwargs)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/client.py\", line 156, in call\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     retry=self.retry)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/oslo_messaging/transport.py\", line 90, in _send\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     timeout=timeout, retry=retry)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 350, in send\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     retry=retry)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 341, in _send\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     raise result\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57] TypeError: 'NoneType' object has no attribute '__getitem__'\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57] Traceback (most recent call last):\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 423, in _object_dispatch\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     return getattr(target, method)(*args, **kwargs)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/objects/base.py\", line 208, in wrapper\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     return fn(self, *args, **kwargs)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/objects/block_device.py\", line 175, in save\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     self._from_db_object(self._context, self, updated)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/objects/block_device.py\", line 89, in _from_db_object\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     block_device_obj[key] = db_block_device[key]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57] TypeError: 'NoneType' object has no attribute '__getitem__'\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n----------", 
    "tags": [
        "openstack-version.kilo"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1695187", 
    "owner": "https://api.launchpad.net/1.0/~felix23ma", 
    "id": 1695187, 
    "index": 6879, 
    "created": "2017-06-02 07:32:01.244982+00:00", 
    "title": "bdm save failure leaves inconsistent data during attaching volume", 
    "comments": [
        {
            "content": "The bug is found in Kilo environment. It exists in master.\n\nBefore saving the bdm, the volume has been attached at the hypervisor level.\nWhen save fails, you will see the VM has virtual disk (virsh domblklist)\nbut can't see it when you do nova show or cinder show.\nEven worse, in my IP-SAN environment, the configuration isn't cleaned at the array,\nwhich might make data inconsistent.\n\nnova/virt/block_device.py\n\n    @update_db\n    def attach(self, context, instance, volume_api, virt_driver,\n               do_driver_attach=False, **kwargs):\n    .....\n        if volume['attach_status'] == \"detached\":\n            # NOTE(mriedem): save our current state so connection_info is in\n            # the database before the volume status goes to 'in-use' because\n            # after that we can detach and connection_info is required for\n            # detach.\n            self.save()         <==== Errors here !!!\n            try:\n                volume_api.attach(context, volume_id, instance.uuid,\n                                  self['mount_device'], mode=mode)\n            except Exception:\n                with excutils.save_and_reraise_exception():\n                    if do_driver_attach:\n                        try:\n                            virt_driver.detach_volume(connection_info,\n                                                      instance,\n                                                      self['mount_device'],\n                                                      encryption=encryption)\n                        except Exception:\n                            LOG.warning(_LW(\"Driver failed to detach volume \"\n                                         \"%(volume_id)s at %(mount_point)s.\"),\n                                     {'volume_id': volume_id,\n                                      'mount_point': self['mount_device']},\n                                     exc_info=True, instance=instance)\n                    volume_api.terminate_connection(context, volume_id,\n                                                    connector)\n\n\n\n\nThe trace:\n----------\n2017-05-24 17:24:23.272 3125 ERROR nova.compute.manager [req-6040188f-4338-47a1-855d-4ecc0eb71203 62f52135115f4898bd0d82c1f0cd632b 6c149dcd3cf64171b8dd972dd03bbac0 - - -] [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57] Failed to attach 2421acfd-0f94-4aca-81d0-747bf803aed7 at /dev/vdb\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57] Traceback (most recent call last):\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5226, in _attach_volume\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     do_check_attach=False, do_driver_attach=True)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 53, in wrapped\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     obj.save()\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 321, in save\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     super(DriverVolumeBlockDevice, self).save()\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 143, in save\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     self._bdm_obj.save()\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/objects/base.py\", line 192, in wrapper\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     self._context, self, fn.__name__, args, kwargs)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/conductor/rpcapi.py\", line 340, in object_action\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     objmethod=objmethod, args=args, kwargs=kwargs)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/client.py\", line 156, in call\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     retry=self.retry)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/oslo_messaging/transport.py\", line 90, in _send\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     timeout=timeout, retry=retry)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 350, in send\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     retry=retry)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 341, in _send\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     raise result\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57] TypeError: 'NoneType' object has no attribute '__getitem__'\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57] Traceback (most recent call last):\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 423, in _object_dispatch\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     return getattr(target, method)(*args, **kwargs)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/objects/base.py\", line 208, in wrapper\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     return fn(self, *args, **kwargs)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/objects/block_device.py\", line 175, in save\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     self._from_db_object(self._context, self, updated)\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]   File \"/usr/lib/python2.7/site-packages/nova/objects/block_device.py\", line 89, in _from_db_object\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]     block_device_obj[key] = db_block_device[key]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57] TypeError: 'NoneType' object has no attribute '__getitem__'\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n2017-05-24 17:24:23.272 3125 TRACE nova.compute.manager [instance: 63b7baae-599c-41b3-bbee-f59bbc239e57]\n----------", 
            "date_created": "2017-06-02 07:32:01.244982+00:00", 
            "author": "https://api.launchpad.net/1.0/~felix23ma"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/470181", 
            "date_created": "2017-06-02 07:40:32.458747+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Automatically discovered version kilo in description. If this is incorrect, please update the description to include 'nova version: ...'", 
            "date_created": "2017-06-27 16:03:57.385659+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}