{
    "status": "Invalid", 
    "last_updated": "2014-03-13 06:43:18.985905+00:00", 
    "description": "I noticed this when some qemu-nbd processes were hung, and we had file injection off. I was like WAT.\n\nHere is a backtrace (I added an exception in the nbd code to find out what was calling it):\nTraceback (most recent call last):\n\u00a0\u00a0File \"/lib/python2.7/site-packages/oslo/messaging/_executors/base.py\", line 36, in _dispatch\n\u00a0\u00a0\u00a0\u00a0incoming.reply(self.callback(incoming.ctxt, incoming.message))\n\u00a0\u00a0File \"/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in __call__\n\u00a0\u00a0\u00a0\u00a0return self._dispatch(endpoint, method, ctxt, args)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 92, in _dispatch\n\u00a0\u00a0\u00a0\u00a0result = getattr(endpoint, method)(ctxt, **new_args)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n\u00a0\u00a0\u00a0\u00a0payload)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n\u00a0\u00a0\u00a0\u00a0six.reraise(self.type_, self.value, self.tb)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n\u00a0\u00a0\u00a0\u00a0return f(self, context, *args, **kw)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/compute/manager.py\", line 266, in decorated_function\n\u00a0\u00a0\u00a0\u00a0e, sys.exc_info())\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n\u00a0\u00a0\u00a0\u00a0six.reraise(self.type_, self.value, self.tb)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/compute/manager.py\", line 253, in decorated_function\n\u00a0\u00a0\u00a0\u00a0return function(self, context, *args, **kwargs)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/compute/manager.py\", line 4169, in pre_live_migration\n\u00a0\u00a0\u00a0\u00a0migrate_data)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4349, in pre_live_migration\n\u00a0\u00a0\u00a0\u00a0disk_info)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4446, in _create_images_and_backing\n\u00a0\u00a0\u00a0\u00a0size=info['virt_disk_size'])\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", line 180, in cache\n\u00a0\u00a0\u00a0\u00a0*args, **kwargs)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", line 330, in create_image\n\u00a0\u00a0\u00a0\u00a0copy_qcow2_image(base, self.path, size)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/openstack/common/lockutils.py\", line 249, in inner\n\u00a0\u00a0\u00a0\u00a0return f(*args, **kwargs)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", line 296, in copy_qcow2_image\n\u00a0\u00a0\u00a0\u00a0disk.extend(target, size, use_cow=True)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/disk/api.py\", line 155, in extend\n\u00a0\u00a0\u00a0\u00a0if not is_image_partitionless(image, use_cow):\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/disk/api.py\", line 205, in is_image_partitionless\n\u00a0\u00a0\u00a0\u00a0fs.setup()\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/disk/vfs/localfs.py\", line 82, in setup\n\u00a0\u00a0\u00a0\u00a0self.teardown()\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n\u00a0\u00a0\u00a0\u00a0six.reraise(self.type_, self.value, self.tb)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/disk/vfs/localfs.py\", line 76, in setup\n\u00a0\u00a0\u00a0\u00a0if not mount.do_mount():\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/disk/mount/api.py\", line 218, in do_mount\n\u00a0\u00a0\u00a0\u00a0status = self.get_dev() and self.map_dev() and self.mnt_dev()\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/disk/mount/nbd.py\", line 127, in get_dev\n\u00a0\u00a0\u00a0\u00a0return self._get_dev_retry_helper()\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/disk/mount/api.py\", line 118, in _get_dev_retry_helper\n\u00a0\u00a0\u00a0\u00a0device = self._inner_get_dev()\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/openstack/common/lockutils.py\", line 249, in inner\n\u00a0\u00a0\u00a0\u00a0return f(*args, **kwargs)\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/disk/mount/nbd.py\", line 86, in _inner_get_dev\n\u00a0\u00a0\u00a0\u00a0device = self._allocate_nbd()\n\u00a0\u00a0File \"/lib/python2.7/site-packages/nova/virt/disk/mount/nbd.py\", line 63, in _allocate_nbd\n\u00a0\u00a0\u00a0\u00a0raise Exception(\"FOAD\")\nException: FOAD", 
    "tags": [
        "libvirt"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1278203", 
    "owner": "None", 
    "id": 1278203, 
    "index": 4534, 
    "created": "2014-02-09 23:30:24.503963+00:00", 
    "title": "live migration attempts block device and fs resize", 
    "comments": [
        {
            "content": "AIUI we consider this a) fragile and b) a security risk,thus the bug report.\n\nI noticed this when some qemu-nbd processes were hung, and we had file injection off. I was like WAT.\n\nHere is a backtrace (I added an exception in the nbd code to find out what was calling it):\n\n2014-02-09 23:19:04.417 4295 ERROR oslo.messaging._executors.base [-] Exception during message handling\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base Traceback (most recent call last):\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/oslo/messaging/_executors/base.py\", line 36, in _dispatch\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     incoming.reply(self.callback(incoming.ctxt, incoming.message))\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in __call__\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     return self._dispatch(endpoint, method, ctxt, args)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 92, in _dispatch\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     payload)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     six.reraise(self.type_, self.value, self.tb)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     return f(self, context, *args, **kw)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 266, in decorated_function\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     e, sys.exc_info())\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     six.reraise(self.type_, self.value, self.tb)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 253, in decorated_function\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     return function(self, context, *args, **kwargs)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 4169, in pre_live_migration\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     migrate_data)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4349, in pre_live_migration\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     disk_info)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4446, in _create_images_and_backing\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     size=info['virt_disk_size'])\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", line 180, in cache\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     *args, **kwargs)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", line 330, in create_image\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     copy_qcow2_image(base, self.path, size)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/openstack/common/lockutils.py\", line 249, in inner\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     return f(*args, **kwargs)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", line 296, in copy_qcow2_image\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     disk.extend(target, size, use_cow=True)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/disk/api.py\", line 155, in extend\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     if not is_image_partitionless(image, use_cow):\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/disk/api.py\", line 205, in is_image_partitionless\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     fs.setup()\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/disk/vfs/localfs.py\", line 82, in setup\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     self.teardown()\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     six.reraise(self.type_, self.value, self.tb)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/disk/vfs/localfs.py\", line 76, in setup\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     if not mount.do_mount():\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/disk/mount/api.py\", line 218, in do_mount\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     status = self.get_dev() and self.map_dev() and self.mnt_dev()\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/disk/mount/nbd.py\", line 127, in get_dev\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     return self._get_dev_retry_helper()\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/disk/mount/api.py\", line 118, in _get_dev_retry_helper\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     device = self._inner_get_dev()\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/openstack/common/lockutils.py\", line 249, in inner\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     return f(*args, **kwargs)\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/disk/mount/nbd.py\", line 86, in _inner_get_dev\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     device = self._allocate_nbd()\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/disk/mount/nbd.py\", line 63, in _allocate_nbd\n2014-02-09 23:19:04.417 4295 TRACE oslo.messaging._executors.base     raise Exception(\"FOAD\")", 
            "date_created": "2014-02-09 23:30:24.503963+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "The migration was initiated via \n\"nova live-migration --block-migrate 267d5679-fbb7-4485-9060-fc3c1c0fe136 overcloud-novacompute0-kocxmro6jtkj\"", 
            "date_created": "2014-02-09 23:53:13.275782+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "(but the codepath that does the injection happens before the check for live vs block)", 
            "date_created": "2014-02-09 23:54:46.245367+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "It's strange. Live migration (block) does download backing file if it doesn't exist, but shouldn't mess around with the overlay file (instance-xxxx/disk). File injection would however, change the overlay file.\n\nCan you please list the nova.conf live-migration options, in particular the options dealing with copy-storage-inc or -all", 
            "date_created": "2014-02-10 10:15:58.247584+00:00", 
            "author": "https://api.launchpad.net/1.0/~parthipan"
        }, 
        {
            "content": "I think this bug is invalid. The code path looks to me like we're resizing the backing file for the disk that we fetched from glance. For better or for worse, when we know that the filesystem inside that backing file is an ext2 filesystem we also resize the file system after resizing the disk. Presumably this machine didn't have libguestfs, so it fell back to nbd.", 
            "date_created": "2014-03-13 06:42:02.791005+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }
    ]
}