{
    "status": "In Progress", 
    "last_updated": "2017-08-01 10:02:56.626459+00:00", 
    "description": "When live migrating an instance with an encrypted volume it fails to detach the encrypted volume from the source and attaches at the target as an unencrypted volume.\n\nI do see the encrypted volume connector on the source but not on the target\n\nls -l /dev/disk/by-path\ntotal 0\nlrwxrwxrwx 1 root root 121 Oct 13 10:26 ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-1a17d61f-7f44-450e-b040-a0baebdb0466-lun-1 -> /dev/mapper/crypt-ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-1a17d61f-7f44-450e-b040-a0baebdb0466-lun-1\nlrwxrwxrwx 1 root root   9 Oct 13 10:36 ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-76909639-61bc-4abd-9a1e-fd5624bb8fc1-lun-1 -> ../../sdd\n\nTarget\n\nls -l /dev/disk/by-path\ntotal 0\nlrwxrwxrwx 1 root root  9 Oct 13 10:48 ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-1a17d61f-7f44-450e-b040-a0baebdb0466-lun-1 -> ../../sdb\nlrwxrwxrwx 1 root root  9 Oct 13 10:48 ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-76909639-61bc-4abd-9a1e-fd5624bb8fc1-lun-1 -> ../../sdc\n\nThe instance can still access encrypted volume, but the data disappears when you umount/mount the device so I guess it looked ok at first due to filesystem caching\n\nThe live migration fails in post migrate on the source due to an error trying to detach the encrypted volume (see bug https://bugs.launchpad.net/os-brick/+bug/1631318, which I'll close now)\n\nSubsequent attempts to detach the volume from the instance (after manually updating it to say it is on the target and active, see https://bugs.launchpad.net/nova/+bug/1628606.", 
    "tags": [
        "live-migration"
    ], 
    "importance": "Undecided", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1633033", 
    "owner": "https://api.launchpad.net/1.0/~lyarwood", 
    "id": 1633033, 
    "index": 6480, 
    "created": "2016-10-13 10:43:29.737426+00:00", 
    "title": "live migration with encrypted volume fails", 
    "comments": [
        {
            "content": "When live migrating an instance with an encrypted volume it fails to detach the encrypted volume from the source and attaches at the target as an unencrypted volume.\n\nI do see the encrypted volume connector on the source but not on the target\n\nls -l /dev/disk/by-path\ntotal 0\nlrwxrwxrwx 1 root root 121 Oct 13 10:26 ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-1a17d61f-7f44-450e-b040-a0baebdb0466-lun-1 -> /dev/mapper/crypt-ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-1a17d61f-7f44-450e-b040-a0baebdb0466-lun-1\nlrwxrwxrwx 1 root root   9 Oct 13 10:36 ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-76909639-61bc-4abd-9a1e-fd5624bb8fc1-lun-1 -> ../../sdd\n\nTarget\n\nls -l /dev/disk/by-path\ntotal 0\nlrwxrwxrwx 1 root root  9 Oct 13 10:48 ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-1a17d61f-7f44-450e-b040-a0baebdb0466-lun-1 -> ../../sdb\nlrwxrwxrwx 1 root root  9 Oct 13 10:48 ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-76909639-61bc-4abd-9a1e-fd5624bb8fc1-lun-1 -> ../../sdc\n\nThe instance can still access encrypted volume, but the data disappears when you umount/mount the device so I guess it looked ok at first due to filesystem caching\n\nThe live migration fails in post migrate on the source due to an error trying to detach the encrypted volume (see bug https://bugs.launchpad.net/os-brick/+bug/1631318, which I'll close now)\n\nSubsequent attempts to detach the volume from the instance (after manually updating it to say it is on the target and active, see https://bugs.launchpad.net/nova/+bug/1628606.", 
            "date_created": "2016-10-13 10:43:29.737426+00:00", 
            "author": "https://api.launchpad.net/1.0/~paul-carlton2"
        }, 
        {
            "content": "I assume this is reproducible in devstack with the LVM/iSCSI cinder backend but could you just confirm?\n\nAlso as discussed on irc I'd be interested in seeing the connection_info captured on the destination host by a call to os-initialize_connection prior to connect_volume being called. Did it include the encrypted flag? ", 
            "date_created": "2016-10-13 13:11:21.960870+00:00", 
            "author": "https://api.launchpad.net/1.0/~lyarwood"
        }, 
        {
            "content": "Yes, it is reproducible in devstack\nThe connection info include a encrypted=True\nTrying to get the following fix to work...\n\n        for bdm in block_device_mapping:\n            connection_info = bdm['connection_info']\n            disk_info = blockinfo.get_info_from_bdm(\n                instance, CONF.libvirt.virt_type,\n                instance.image_meta, bdm)\n            # New code\n            LOG.debug(\"bdm: %s\" % bdm)\n            volume_id = connection_info.get('serial', None)\n            data = connection_info.get('data', {})\n            if data.get('encrypted', False):\n\n                encryption = encryptors.get_encryption_metadata(context,\n                                            self._volume_api, volume_id,\n                                            connection_info)\n                if encryption:\n                    encryptor = self._get_volume_encryptor(connection_info,\n                                                           encryption)\n                    encryptor.attach_volume(context, **encryption)\n            # end new code\n            self._connect_volume(connection_info, disk_info)\n\nBut it fails in get_volume_encrytor because the connection_info['data'] item has no 'device_path'\nThis seems to be set by connect_volume in volume/iscsi.py currently trying to figure out how to make that get called\n\n", 
            "date_created": "2016-10-13 15:03:05.598585+00:00", 
            "author": "https://api.launchpad.net/1.0/~paul-carlton2"
        }, 
        {
            "content": "Got a solution working for this bug in HPE Helion 4.0 version of OpenStack (Mitaka based).\nHowever when I try to get the same fix to work in devstack running off master I get and error relating to passphrase when trying to connect volume on target in pre live migration\n\n2016-10-21 08:19:28.779 78521 WARNING nova.keymgr.conf_key_mgr [req-09805499-5647-49c2-a3ea-e257ac627391 admin admin] This key manager is insecure and is not recommended for production deployments\n2016-10-21 08:19:28.782 78521 DEBUG nova.volume.encryptors [req-09805499-5647-49c2-a3ea-e257ac627391 admin admin] Using volume encryptor '<nova.volume.encryptors.luks.LuksEncryptor object at 0x7f7dec14a5d0>' for connection: {u'driver_volume_type': u'iscsi', 'connector': {'platform': 'x86_64', 'host': 'devstack-hlinux-c2', 'do_local_attach': False, 'ip': '192.168.16.22', 'os_type': 'linux2', 'multipath': False, 'initiator': 'iqn.1993-08.org.debian:01:d6a93bd1597f'}, 'serial': u'9e897b1b-599d-489a-b080-c32a47eab2cd', u'data': {u'access_mode': u'rw', u'target_discovered': False, u'encrypted': True, u'qos_specs': None, u'target_iqn': u'iqn.2010-10.org.openstack:volume-9e897b1b-599d-489a-b080-c32a47eab2cd', u'target_portal': u'192.168.16.20:3260', u'volume_id': u'9e897b1b-599d-489a-b080-c32a47eab2cd', u'target_lun': 1, 'device_path': u'/dev/disk/by-path/ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-9e897b1b-599d-489a-b080-c32a47eab2cd-lun-1', u'auth_password': u'***', u'auth_username': u'FFAtKjUUbEpUmLaEH6SZ', u'auth_method': u'CHAP'}} get_volume_encryptor /home/pcarlton/openstack/nova/nova/volume/encryptors/__init__.py:57\n2016-10-21 08:19:28.782 78521 DEBUG nova.volume.encryptors.luks [req-09805499-5647-49c2-a3ea-e257ac627391 admin admin] opening encrypted volume /dev/sdb _open_volume /home/pcarlton/openstack/nova/nova/volume/encryptors/luks.py:83\n2016-10-21 08:19:28.783 78521 DEBUG oslo_concurrency.processutils [req-09805499-5647-49c2-a3ea-e257ac627391 admin admin] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup luksOpen --key-file=- /dev/sdb crypt-ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-9e897b1b-599d-489a-b080-c32a47eab2cd-lun-1 execute /usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py:344\n2016-10-21 08:19:32.030 78521 DEBUG oslo_concurrency.processutils [req-09805499-5647-49c2-a3ea-e257ac627391 admin admin] CMD \"sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup luksOpen --key-file=- /dev/sdb crypt-ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-9e897b1b-599d-489a-b080-c32a47eab2cd-lun-1\" returned: 2 in 3.247s execute /usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py:374\n2016-10-21 08:19:32.031 78521 DEBUG oslo_concurrency.processutils [req-09805499-5647-49c2-a3ea-e257ac627391 admin admin] u'sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup luksOpen --key-file=- /dev/sdb crypt-ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-9e897b1b-599d-489a-b080-c32a47eab2cd-lun-1' failed. Not Retrying. execute /usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py:422\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [req-09805499-5647-49c2-a3ea-e257ac627391 admin admin] [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82] Failed to attach volume at mountpoint: /dev/vdb\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82] Traceback (most recent call last):\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]   File \"/home/pcarlton/openstack/nova/nova/virt/libvirt/driver.py\", line 1158, in attach_volume\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]     encryptor.attach_volume(context, **encryption)\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]   File \"/home/pcarlton/openstack/nova/nova/volume/encryptors/luks.py\", line 102, in attach_volume\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]     self._open_volume(passphrase, **kwargs)\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]   File \"/home/pcarlton/openstack/nova/nova/volume/encryptors/luks.py\", line 86, in _open_volume\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]     run_as_root=True, check_exit_code=True)\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]   File \"/home/pcarlton/openstack/nova/nova/utils.py\", line 295, in execute\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]     return RootwrapProcessHelper().execute(*cmd, **kwargs)\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]   File \"/home/pcarlton/openstack/nova/nova/utils.py\", line 178, in execute\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]     return processutils.execute(*cmd, **kwargs)\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\", line 389, in execute\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]     cmd=sanitized_cmd)\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82] ProcessExecutionError: Unexpected error while running command.\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup luksOpen --key-file=- /dev/sdb crypt-ip-192.168.16.20:3260-iscsi-iqn.2010-10.org.openstack:volume-9e897b1b-599d-489a-b080-c32a47eab2cd-lun-1\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82] Exit code: 2\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82] Stdout: u''\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82] Stderr: u'No key available with this passphrase.\\n'\n2016-10-21 08:19:32.033 78521 ERROR nova.virt.libvirt.driver [instance: 1b3bee12-f544-42fc-842e-25bcbfc5cd82]\n\nTried with fixed key and using key mgr\n\nInvestigating, but has anyone got any ideas what could be causing this?", 
            "date_created": "2016-10-21 08:03:24.174674+00:00", 
            "author": "https://api.launchpad.net/1.0/~paul-carlton2"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/389608", 
            "date_created": "2016-10-21 08:44:02.972538+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Note that there is a bug related to mangling the passphrase used for encrypting/decrypting: https://bugs.launchpad.net/nova/+bug/1633518\n\nThis might be related to the passphrase error that was encountered when testing the fix on master (mentioned in comment #3: https://bugs.launchpad.net/nova/+bug/1633033/comments/3).", 
            "date_created": "2016-11-02 18:28:06.178863+00:00", 
            "author": "https://api.launchpad.net/1.0/~brianna-poulos"
        }, 
        {
            "content": "Change abandoned by Sean Dague (<email address hidden>) on branch: master\nReview: https://review.openstack.org/389608\nReason: This review is > 4 weeks without comment, and is not mergable in it's current state. We are abandoning this for now. Feel free to reactivate the review by pressing the restore button and leaving a 'recheck' comment to get fresh test results.", 
            "date_created": "2017-08-01 10:02:56.099984+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}