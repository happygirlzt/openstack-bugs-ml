{
    "status": "Invalid", 
    "last_updated": "2016-03-10 15:54:39.179604+00:00", 
    "description": "1: Nova api microversion v2.25\n\n2: This is the log of source compute node:\n\n2016-03-04 02:25:44.598 INFO nova.virt.libvirt.driver [req-baf2d5a5-1e19-4f78-b38b-ef6ae67ae3f3 admin admin] [instance: d514ae11-3118-4adf-ab6d-9bc437173de3] Increasing downtime to 46 ms after 0 sec elapsed time\n2016-03-04 02:25:44.930 INFO nova.virt.libvirt.driver [req-baf2d5a5-1e19-4f78-b38b-ef6ae67ae3f3 admin admin] [instance: d514ae11-3118-4adf-ab6d-9bc437173de3] Migration running for 0 secs, memory 100% remaining; (bytes processed=0, remaining=0, total=0) <============================\n\n....\n\n\n2016-03-04 02:25:48.084 DEBUG nova.virt.libvirt.host [req-baf2d5a5-1e19-4f78-b38b-ef6ae67ae3f3 admin admin] Domain has shutdown/gone away: Requested operation is not valid: domain is not running from (pid=5066) for_domain /opt/stack/nova/nova/virt/libvirt/host.py:180\n2016-03-04 02:25:48.086 INFO nova.virt.libvirt.driver [req-baf2d5a5-1e19-4f78-b38b-ef6ae67ae3f3 admin admin] [instance: d514ae11-3118-4adf-ab6d-9bc437173de3] Migration operation has completed\n\n\n3 steps:\n3.1 create an instance \n3.2 nova --debug --os-compute-api-version 2.25 live-migration test2\n3.3 nova --debug --os-compute-api-version 2.25 server-migration-list test2\n\n+----+-------------+-----------+----------------+--------------+-----------+---------+--------------------------------------+----------------------------+----------------------------+--------------------+------------------------+------------------------+------------------+----------------------+----------------------+\n| Id | Source Node | Dest Node | Source Compute | Dest Compute | Dest Host | Status  | Server UUID                          | Created At                 | Updated At                 | Total Memory Bytes | Processed Memory Bytes | Remaining Memory Bytes | Total Disk Bytes | Processed Disk Bytes | Remaining Disk Bytes |\n+----+-------------+-----------+----------------+--------------+-----------+---------+--------------------------------------+----------------------------+----------------------------+--------------------+------------------------+------------------------+------------------+----------------------+----------------------+\n| 41 | -           | -         | lm-2           | lm-1         | -         | running | d514ae11-3118-4adf-ab6d-9bc437173de3 | 2016-03-04T02:09:26.000000 | 2016-03-04T02:09:40.000000 | 0                  | 0                      | 0                      | 0                | 0                    | 0                    |\n+----+-------------+-----------+----------------+--------------+-----------+---------+--------------------------------------+----------------------------+----------------------------+--------------------+------------------------+------------------------+------------------+----------------------+----------------------+\n\nsee from nova table:\n\nmysql> select * from migrations where id=41;\n+---------------------+---------------------+------------+----+----------------+--------------+-----------+-----------+--------------------------------------+----------------------+----------------------+-------------+-----------+---------+----------------+--------+--------------+------------------+------------------+------------+----------------+----------------+\n| created_at          | updated_at          | deleted_at | id | source_compute | dest_compute | dest_host | status    | instance_uuid                        | old_instance_type_id | new_instance_type_id | source_node | dest_node | deleted | migration_type | hidden | memory_total | memory_processed | memory_remaining | disk_total | disk_processed | disk_remaining |\n+---------------------+---------------------+------------+----+----------------+--------------+-----------+-----------+--------------------------------------+----------------------+----------------------+-------------+-----------+---------+----------------+--------+--------------+------------------+------------------+------------+----------------+----------------+\n| 2016-03-04 02:09:26 | 2016-03-04 02:09:50 | NULL       | 41 | lm-2           | lm-1         | NULL      | completed | d514ae11-3118-4adf-ab6d-9bc437173de3 |                    2 |                    2 | NULL        | NULL      |       0 | live-migration |      0 |            0 |                0 |                0 |          0 |              0 |              0 |\n+---------------------+---------------------+------------+----+----------------+--------------+-----------+-----------+--------------------------------------+----------------------+----------------------+-------------+-----------+---------+----------------+--------+--------------+------------------+------------------+------------+----------------+----------------+\n1 row in set (0.00 sec)\n\nExpected result:\n* Total Memory Bytes should not 0\n* Processed Memory Bytes  should be equal Total Memory Bytes  after migration finished.\n\nActual result:\n* Total Memory Bytes is 0\n* Processed Memory Bytes is 0", 
    "tags": [
        "live-migration"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1553011", 
    "owner": "https://api.launchpad.net/1.0/~gstepanov", 
    "id": 1553011, 
    "index": 6079, 
    "created": "2016-03-04 03:11:47.790043+00:00", 
    "title": "total_memory in migration-list is 0 while live-migration", 
    "comments": [
        {
            "content": "1: Nova api microversion v2.25\n\n2: This is the log of source compute node:\n\n2016-03-04 02:25:44.598 INFO nova.virt.libvirt.driver [req-baf2d5a5-1e19-4f78-b38b-ef6ae67ae3f3 admin admin] [instance: d514ae11-3118-4adf-ab6d-9bc437173de3] Increasing downtime to 46 ms after 0 sec elapsed time\n2016-03-04 02:25:44.930 INFO nova.virt.libvirt.driver [req-baf2d5a5-1e19-4f78-b38b-ef6ae67ae3f3 admin admin] [instance: d514ae11-3118-4adf-ab6d-9bc437173de3] Migration running for 0 secs, memory 100% remaining; (bytes processed=0, remaining=0, total=0) <============================\n\n....\n\n\n2016-03-04 02:25:48.084 DEBUG nova.virt.libvirt.host [req-baf2d5a5-1e19-4f78-b38b-ef6ae67ae3f3 admin admin] Domain has shutdown/gone away: Requested operation is not valid: domain is not running from (pid=5066) for_domain /opt/stack/nova/nova/virt/libvirt/host.py:180\n2016-03-04 02:25:48.086 INFO nova.virt.libvirt.driver [req-baf2d5a5-1e19-4f78-b38b-ef6ae67ae3f3 admin admin] [instance: d514ae11-3118-4adf-ab6d-9bc437173de3] Migration operation has completed\n\n\n3 steps:\n3.1 create an instance \n3.2 nova --debug --os-compute-api-version 2.25 live-migration test2\n3.3 nova --debug --os-compute-api-version 2.25 server-migration-list test2\n\n+----+-------------+-----------+----------------+--------------+-----------+---------+--------------------------------------+----------------------------+----------------------------+--------------------+------------------------+------------------------+------------------+----------------------+----------------------+\n| Id | Source Node | Dest Node | Source Compute | Dest Compute | Dest Host | Status  | Server UUID                          | Created At                 | Updated At                 | Total Memory Bytes | Processed Memory Bytes | Remaining Memory Bytes | Total Disk Bytes | Processed Disk Bytes | Remaining Disk Bytes |\n+----+-------------+-----------+----------------+--------------+-----------+---------+--------------------------------------+----------------------------+----------------------------+--------------------+------------------------+------------------------+------------------+----------------------+----------------------+\n| 41 | -           | -         | lm-2           | lm-1         | -         | running | d514ae11-3118-4adf-ab6d-9bc437173de3 | 2016-03-04T02:09:26.000000 | 2016-03-04T02:09:40.000000 | 0                  | 0                      | 0                      | 0                | 0                    | 0                    |\n+----+-------------+-----------+----------------+--------------+-----------+---------+--------------------------------------+----------------------------+----------------------------+--------------------+------------------------+------------------------+------------------+----------------------+----------------------+\n\nsee from nova table:\n\nmysql> select * from migrations where id=41;\n+---------------------+---------------------+------------+----+----------------+--------------+-----------+-----------+--------------------------------------+----------------------+----------------------+-------------+-----------+---------+----------------+--------+--------------+------------------+------------------+------------+----------------+----------------+\n| created_at          | updated_at          | deleted_at | id | source_compute | dest_compute | dest_host | status    | instance_uuid                        | old_instance_type_id | new_instance_type_id | source_node | dest_node | deleted | migration_type | hidden | memory_total | memory_processed | memory_remaining | disk_total | disk_processed | disk_remaining |\n+---------------------+---------------------+------------+----+----------------+--------------+-----------+-----------+--------------------------------------+----------------------+----------------------+-------------+-----------+---------+----------------+--------+--------------+------------------+------------------+------------+----------------+----------------+\n| 2016-03-04 02:09:26 | 2016-03-04 02:09:50 | NULL       | 41 | lm-2           | lm-1         | NULL      | completed | d514ae11-3118-4adf-ab6d-9bc437173de3 |                    2 |                    2 | NULL        | NULL      |       0 | live-migration |      0 |            0 |                0 |                0 |          0 |              0 |              0 |\n+---------------------+---------------------+------------+----+----------------+--------------+-----------+-----------+--------------------------------------+----------------------+----------------------+-------------+-----------+---------+----------------+--------+--------------+------------------+------------------+------------+----------------+----------------+\n1 row in set (0.00 sec)\n\nExpected result:\n* Total Memory Bytes should not 0\n* Processed Memory Bytes  should be equal Total Memory Bytes  after migration finished.\n\nActual result:\n* Total Memory Bytes is 0\n* Processed Memory Bytes is 0", 
            "date_created": "2016-03-04 03:11:47.790043+00:00", 
            "author": "https://api.launchpad.net/1.0/~taget-9"
        }, 
        {
            "content": "After we invoke the live migration operation, we use _live_migration_monitor to sync the status of migration in the branch of VIR_DOMAIN_JOB_UNBOUNDED:\n\nwe try to sync migration's info from host.DomainJobInfo.for_domain(dom)\nbut as you can see from nova compute log, host.DomainJobInfo.for_domain(dom) returns (bytes processed=0, remaining=0, total=0), so this may not nova's fault but libvirt, even should we report nova admin that total memory is 0?\n\n-Eli", 
            "date_created": "2016-03-04 03:18:09.058159+00:00", 
            "author": "https://api.launchpad.net/1.0/~taget-9"
        }, 
        {
            "content": "I thinks this issue is related to https://bugs.launchpad.net/nova/+bug/1499449 .\nInside of _live_migration_monitor progress_watermark is not tracked correctly and that is why logs has\nfalse value of memory that has been proceed.  \n\nHere is the code that should save info about migration https://github.com/openstack/nova/blob/master/nova/virt/libvirt/driver.py#L6360 , but i wonder that\nin my devstack env i mysql gived me only such info.\n\nmysql> select * from migrations where id = 97\\G\n*************************** 1. row ***************************\n          created_at: 2016-02-24 10:23:50\n          updated_at: 2016-02-24 10:24:09\n          deleted_at: NULL\n                  id: 97\n      source_compute: node1\n        dest_compute: node2\n           dest_host: NULL\n              status: completed\n       instance_uuid: e8eaca05-f7dc-4ddc-91ff-6bb0f9977778\nold_instance_type_id: 7\nnew_instance_type_id: 7\n         source_node: NULL\n           dest_node: NULL\n             deleted: 0\n      migration_type: live-migration\n              hidden: 0\n1 row in set (0.00 sec)\n\n\nAnd migrations table definition is following:\n\nmysql> describe migrations;\n+----------------------+----------------------------------------------------------+------+-----+---------+----------------+\n| Field                | Type                                                     | Null | Key | Default | Extra          |\n+----------------------+----------------------------------------------------------+------+-----+---------+----------------+\n| created_at           | datetime                                                 | YES  |     | NULL    |                |\n| updated_at           | datetime                                                 | YES  |     | NULL    |                |\n| deleted_at           | datetime                                                 | YES  |     | NULL    |                |\n| id                   | int(11)                                                  | NO   | PRI | NULL    | auto_increment |\n| source_compute       | varchar(255)                                             | YES  |     | NULL    |                |\n| dest_compute         | varchar(255)                                             | YES  |     | NULL    |                |\n| dest_host            | varchar(255)                                             | YES  |     | NULL    |                |\n| status               | varchar(255)                                             | YES  |     | NULL    |                |\n| instance_uuid        | varchar(36)                                              | YES  | MUL | NULL    |                |\n| old_instance_type_id | int(11)                                                  | YES  |     | NULL    |                |\n| new_instance_type_id | int(11)                                                  | YES  |     | NULL    |                |\n| source_node          | varchar(255)                                             | YES  |     | NULL    |                |\n| dest_node            | varchar(255)                                             | YES  |     | NULL    |                |\n| deleted              | int(11)                                                  | YES  | MUL | NULL    |                |\n| migration_type       | enum('migration','resize','live-migration','evacuation') | YES  |     | NULL    |                |\n| hidden               | tinyint(1)                                               | YES  |     | NULL    |                |\n+----------------------+----------------------------------------------------------+------+-----+---------+----------------+\n16 rows in set (0.01 sec)\n\n\nSo i can't see any data about migration memory usage.", 
            "date_created": "2016-03-09 14:25:15.783294+00:00", 
            "author": "https://api.launchpad.net/1.0/~gstepanov"
        }, 
        {
            "content": "It seems that my version of devstack from 10th Feb is staled, ive reinstalled it and these columns already\nhere, i will check why live migration memory is not tracked correctly.", 
            "date_created": "2016-03-09 16:25:36.060227+00:00", 
            "author": "https://api.launchpad.net/1.0/~gstepanov"
        }, 
        {
            "content": "I've checked your bug. So you have user True live migration using shared storage.\nThis type of live migration is made instantly without copying any data( from libvirt view) so\nDomainJobInfo has info about memory proceed equal to 0.\nIf you try block live migration\nnova live-migration <instance> <destination> --block-migrate\nand look to database you will see that all data persisted correctly.\n", 
            "date_created": "2016-03-10 15:54:08.162046+00:00", 
            "author": "https://api.launchpad.net/1.0/~gstepanov"
        }
    ]
}