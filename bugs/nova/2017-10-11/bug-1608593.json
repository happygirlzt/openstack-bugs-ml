{
    "status": "Expired", 
    "last_updated": "2016-10-10 04:18:14.258807+00:00", 
    "description": "I'm running current master nova under devstack on ubuntu 14.04\n\nnova git log:\ncommit eab62c0d8a3280c559d974d0f31d51a3f06e1048\nMerge: dd9af27 b790332\nAuthor: Jenkins <email address hidden>\nDate:   Mon Aug 1 00:24:20 2016 +0000\n\n    Merge \"Option Consistency for availability_zone.py\"\n\nSteps to reproduce:\n1. Boot up an instance with a network port.\n2. Update the port with \"device_id\" blank.\n3. Delete the nova instance.\n4. Attempt to boot a new instance with the port.\n5. Update the port with \"device_id\" blank.\n6. Delete the nova instance.\n7. Attempt to boot a new instance with the port.\n\nThis is a multi-failover scenario.\n\nError from n-cond.log:\n/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 2137, in _flush\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     transaction.rollback(_capture_exception=True)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/langhelpers.py\", line 60, in __exit__\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     compat.reraise(exc_type, exc_value, exc_tb)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 2101, in _flush\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     flush_context.execute()\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/unitofwork.py\", line 373, in execute\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     rec.execute(self)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/unitofwork.py\", line 532, in execute\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     uow\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 174, in save_obj\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     mapper, table, insert)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 800, in _emit_insert_statements\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     execute(statement, params)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 914, in execute\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     return meth(self, multiparams, params)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     return connection._execute_clauseelement(self, multiparams, params)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     compiled_sql, distilled_params\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     context)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1337, in _handle_dbapi_exception\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     util.raise_from_cause(newraise, exc_info)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 202, in raise_from_cause\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     reraise(type(exception), exception, tb=exc_tb, cause=cause)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     context)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     cursor.execute(statement, parameters)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 167, in execute\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     result = self._query(query)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 323, in _query\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     conn.query(q)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 836, in query\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1020, in _read_query_result\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     result.read()\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1303, in read\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     first_packet = self.connection._read_packet()\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 982, in _read_packet\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     packet.check_error()\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 394, in check_error\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     err.raise_mysql_exception(self._data)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 120, in raise_mysql_exception\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     _check_mysql_exception(errinfo)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 112, in _check_mysql_exception\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     raise errorclass(errno, errorvalue)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api DBDuplicateEntry: (pymysql.err.IntegrityError) (1062, u\"Duplicate entry 'fa:16:3e:f3:85:c0/58220635-8b9f-44fd-bbdc-7148777500f1-0' for key 'uniq_virtual_interfaces0address0deleted'\") [SQL: u'INSERT INTO virtual_interfaces (created_at, updated_at, deleted_at, deleted, address, network_id, instance_uuid, uuid, tag) VALUES (%(created_at)s, %(updated_at)s, %(deleted_at)s, %(deleted)s, %(address)s, %(network_id)s, %(instance_uuid)s, %(uuid)s, %(tag)s)'] [parameters: {'instance_uuid': '7ab65f46-0044-4098-a74e-9a28b8b20882', 'uuid': '58220635-8b9f-44fd-bbdc-7148777500f1', 'deleted': 0, 'created_at': datetime.datetime(2016, 8, 1, 15, 44, 12, 979629), 'updated_at': None, 'network_id': None, 'tag': None, 'address': u'fa:16:3e:f3:85:c0/58220635-8b9f-44fd-bbdc-7148777500f1', 'deleted_at': None}]\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api\n\nn-cpu.log:\n2016-08-01 15:44:14.075 ERROR nova.compute.manager [req-3296ed1c-0ca0-43aa-9b57-bd89412d92cc admin admin] [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Failed to allocate network(s)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Traceback (most recent call last):\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1911, in _build_and_run_instance\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     block_device_info=block_device_info)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2664, in spawn\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     write_to_disk=True)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4663, in _get_guest_xml\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     network_info_str = str(network_info)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/model.py\", line 524, in __str__\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return self._sync_wrapper(fn, *args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/model.py\", line 507, in _sync_wrapper\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     self.wait()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/model.py\", line 539, in wait\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     self[:] = self._gt.wait()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 175, in wait\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return self._exit_event.wait()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 121, in wait\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return hubs.get_hub().switch()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 294, in switch\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return self.greenlet.switch()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     result = function(*args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/utils.py\", line 1052, in context_wrapper\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return func(*args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1406, in _allocate_network_async\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     six.reraise(*exc_info)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1389, in _allocate_network_async\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     bind_host_id=bind_host_id)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 795, in allocate_for_instance\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     bind_host_id, dhcp_opts, available_macs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 914, in _update_ports_for_instance\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     vif.destroy()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     self.force_reraise()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     six.reraise(self.type_, self.value, self.tb)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 897, in _update_ports_for_instance\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     vifobj.create()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 210, in wrapper\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     ctxt, self, fn.__name__, args, kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 241, in object_action\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     objmethod=objmethod, args=args, kwargs=kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 169, in call\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     retry=self.retry)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 96, in _send\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     timeout=timeout, retry=retry)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 464, in send\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     retry=retry)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 455, in _send\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     raise result\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] VirtualInterfaceCreateException_Remote: Virtual Interface creation failed\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Traceback (most recent call last):\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/conductor/manager.py\", line 86, in _object_dispatch\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return getattr(target, method)(*args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 226, in wrapper\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return fn(self, *args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/objects/virtual_interface.py\", line 97, in create\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     db_vif = db.virtual_interface_create(self._context, updates)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/db/api.py\", line 649, in virtual_interface_create\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return IMPL.virtual_interface_create(context, values)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 169, in wrapper\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return f(*args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 240, in wrapped\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return f(context, *args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 1540, in virtual_interface_create\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     raise exception.VirtualInterfaceCreateException()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] VirtualInterfaceCreateException: Virtual Interface creation failed\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.079 DEBUG nova.compute.utils [req-3296ed1c-0ca0-43aa-9b57-bd89412d92cc admin admin] [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Virtual Interface creation failed from (pid=6197) notify_about_instance_usage /opt/stack/nova/nova/compute/utils.py:313\n2016-08-01 15:44:14.079 ERROR nova.compute.manager [req-3296ed1c-0ca0-43aa-9b57-bd89412d92cc admin admin] [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Build of instance 7ab65f46-0044-4098-a74e-9a28b8b20882 aborted: Failed to allocate the network(s), not rescheduling.\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Traceback (most recent call last):\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1770, in _do_build_and_run_instance\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     filter_properties)\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1950, in _build_and_run_instance\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     reason=msg)\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] BuildAbortException: Build of instance 7ab65f46-0044-4098-a74e-9a28b8b20882 aborted: Failed to allocate the network(s), not rescheduling.\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n\nmysql after the error:\nmysql> select * from virtual_interfaces;\n+---------------------+------------+---------------------+----+--------------------------------------------------------+------------+--------------------------------------+--------------------------------------+---------+------+\n| created_at          | updated_at | deleted_at          | id | address                                                | network_id | uuid                                 | instance_uuid                        | deleted | tag  |\n+---------------------+------------+---------------------+----+--------------------------------------------------------+------------+--------------------------------------+--------------------------------------+---------+------+\n| 2016-08-01 04:51:13 | NULL       | NULL                |  1 | fa:16:3e:94:0e:d9/a2dab54d-6fb7-458f-baa4-a4615c7a01c0 |       NULL | a2dab54d-6fb7-458f-baa4-a4615c7a01c0 | 83d7950b-2a46-4441-98f9-8b39ccd5ad13 |       0 | NULL |\n| 2016-08-01 04:51:14 | NULL       | NULL                |  2 | fa:16:3e:d2:3f:cc/c217cb17-9bb0-4520-a776-7f291027507a |       NULL | c217cb17-9bb0-4520-a776-7f291027507a | 75453188-c0a7-4943-a6e9-4d71b5816d19 |       0 | NULL |\n| 2016-08-01 04:52:37 | NULL       | 2016-08-01 04:57:57 |  3 | fa:16:3e:a2:48:c9/5a276860-903b-4a25-8688-40f03d375f4f |       NULL | 5a276860-903b-4a25-8688-40f03d375f4f | d223d120-7e46-45d5-b233-8d8719de5a29 |       3 | NULL |\n| 2016-08-01 04:52:58 | NULL       | 2016-08-01 04:57:57 |  4 | fa:16:3e:55:1f:f1/52f28060-9014-48c7-b94e-6847e336727c |       NULL | 52f28060-9014-48c7-b94e-6847e336727c | d223d120-7e46-45d5-b233-8d8719de5a29 |       4 | NULL |\n| 2016-08-01 04:54:09 | NULL       | 2016-08-01 04:57:57 |  5 | fa:16:3e:b9:bc:26/2f1fad78-451f-4e91-a164-e8c925933d72 |       NULL | 2f1fad78-451f-4e91-a164-e8c925933d72 | d223d120-7e46-45d5-b233-8d8719de5a29 |       5 | NULL |\n| 2016-08-01 04:54:43 | NULL       | 2016-08-01 04:57:57 |  6 | fa:16:3e:01:89:22/b3add585-c06c-47c7-b081-24c2120fa7c7 |       NULL | b3add585-c06c-47c7-b081-24c2120fa7c7 | d223d120-7e46-45d5-b233-8d8719de5a29 |       6 | NULL |\n| 2016-08-01 04:57:57 | NULL       | 2016-08-01 04:57:57 |  7 | fa:16:3e:62:4f:38/71b6d508-fc59-4386-8b5f-b09432cab419 |       NULL | 71b6d508-fc59-4386-8b5f-b09432cab419 | 95142ff6-ec33-408b-8f11-2c86f332bbf8 |       7 | NULL |\n| 2016-08-01 15:26:03 | NULL       | 2016-08-01 15:38:45 |  9 | fa:16:3e:60:f3:f3/775de30a-c39a-46ea-81ef-f7f94d1c40d3 |       NULL | 775de30a-c39a-46ea-81ef-f7f94d1c40d3 | 77e4184c-f3ec-4b01-aa14-191583673ea4 |       9 | NULL |\n| 2016-08-01 15:26:11 | NULL       | 2016-08-01 15:38:45 | 10 | fa:16:3e:02:04:92/f5e8d9c3-832a-4f49-86b3-974dfef6cd38 |       NULL | f5e8d9c3-832a-4f49-86b3-974dfef6cd38 | 77e4184c-f3ec-4b01-aa14-191583673ea4 |      10 | NULL |\n| 2016-08-01 15:27:23 | NULL       | 2016-08-01 15:38:45 | 11 | fa:16:3e:f3:85:c0/58220635-8b9f-44fd-bbdc-7148777500f1 |       NULL | 58220635-8b9f-44fd-bbdc-7148777500f1 | 77e4184c-f3ec-4b01-aa14-191583673ea4 |      11 | NULL |\n| 2016-08-01 15:27:57 | NULL       | 2016-08-01 15:38:45 | 12 | fa:16:3e:21:5b:85/e66a8ddd-8398-427b-a0fd-403bdcbe9fae |       NULL | e66a8ddd-8398-427b-a0fd-403bdcbe9fae | 77e4184c-f3ec-4b01-aa14-191583673ea4 |      12 | NULL |\n| 2016-08-01 15:38:45 | NULL       | 2016-08-01 15:44:13 | 13 | fa:16:3e:44:8a:e7/45ec8e98-722e-46e3-abc9-73578e4766d5 |       NULL | 45ec8e98-722e-46e3-abc9-73578e4766d5 | 5cdb6bb1-bc10-4879-85b9-321f54bf3e80 |      13 | NULL |\n| 2016-08-01 15:38:45 | NULL       | 2016-08-01 15:44:13 | 14 | fa:16:3e:f3:85:c0/58220635-8b9f-44fd-bbdc-7148777500f1 |       NULL | 58220635-8b9f-44fd-bbdc-7148777500f1 | 5cdb6bb1-bc10-4879-85b9-321f54bf3e80 |      14 | NULL |\n| 2016-08-01 15:38:45 | NULL       | 2016-08-01 15:44:13 | 15 | fa:16:3e:21:5b:85/e66a8ddd-8398-427b-a0fd-403bdcbe9fae |       NULL | e66a8ddd-8398-427b-a0fd-403bdcbe9fae | 5cdb6bb1-bc10-4879-85b9-321f54bf3e80 |      15 | NULL |\n| 2016-08-01 15:38:46 | NULL       | 2016-08-01 15:44:13 | 16 | fa:16:3e:02:04:92/f5e8d9c3-832a-4f49-86b3-974dfef6cd38 |       NULL | f5e8d9c3-832a-4f49-86b3-974dfef6cd38 | 5cdb6bb1-bc10-4879-85b9-321f54bf3e80 |      16 | NULL |\n| 2016-08-01 15:44:12 | NULL       | 2016-08-01 15:44:13 | 17 | fa:16:3e:0f:f7:7c/eeda7841-9c60-49b7-b0f9-09103b6a9b91 |       NULL | eeda7841-9c60-49b7-b0f9-09103b6a9b91 | 7ab65f46-0044-4098-a74e-9a28b8b20882 |      17 | NULL |\n+---------------------+------------+---------------------+----+--------------------------------------------------------+------------+--------------------------------------+--------------------------------------+---------+------+\n16 rows in set (0.00 sec)\n\nThis may be related to https://bugs.launchpad.net/nova/+bug/1602357", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1608593", 
    "owner": "None", 
    "id": 1608593, 
    "index": 6354, 
    "created": "2016-08-01 16:03:04.793302+00:00", 
    "title": "Nova exception 'DBDuplicateEntry' error in n-cond.log", 
    "comments": [
        {
            "content": "I'm running current master nova under devstack on ubuntu 14.04\n\nnova git log:\ncommit eab62c0d8a3280c559d974d0f31d51a3f06e1048\nMerge: dd9af27 b790332\nAuthor: Jenkins <email address hidden>\nDate:   Mon Aug 1 00:24:20 2016 +0000\n\n    Merge \"Option Consistency for availability_zone.py\"\n\nSteps to reproduce:\n1. Boot up an instance with a network port.\n2. Update the port with \"device_id\" blank.\n3. Delete the nova instance.\n4. Attempt to boot a new instance with the port.\n5. Update the port with \"device_id\" blank.\n6. Delete the nova instance.\n7. Attempt to boot a new instance with the port.\n\nThis is a multi-failover scenario.\n\nError from n-cond.log:\n/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 2137, in _flush\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     transaction.rollback(_capture_exception=True)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/langhelpers.py\", line 60, in __exit__\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     compat.reraise(exc_type, exc_value, exc_tb)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 2101, in _flush\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     flush_context.execute()\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/unitofwork.py\", line 373, in execute\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     rec.execute(self)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/unitofwork.py\", line 532, in execute\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     uow\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 174, in save_obj\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     mapper, table, insert)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py\", line 800, in _emit_insert_statements\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     execute(statement, params)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 914, in execute\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     return meth(self, multiparams, params)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     return connection._execute_clauseelement(self, multiparams, params)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     compiled_sql, distilled_params\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     context)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1337, in _handle_dbapi_exception\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     util.raise_from_cause(newraise, exc_info)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 202, in raise_from_cause\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     reraise(type(exception), exception, tb=exc_tb, cause=cause)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     context)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     cursor.execute(statement, parameters)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 167, in execute\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     result = self._query(query)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 323, in _query\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     conn.query(q)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 836, in query\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1020, in _read_query_result\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     result.read()\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1303, in read\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     first_packet = self.connection._read_packet()\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 982, in _read_packet\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     packet.check_error()\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 394, in check_error\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     err.raise_mysql_exception(self._data)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 120, in raise_mysql_exception\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     _check_mysql_exception(errinfo)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 112, in _check_mysql_exception\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api     raise errorclass(errno, errorvalue)\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api DBDuplicateEntry: (pymysql.err.IntegrityError) (1062, u\"Duplicate entry 'fa:16:3e:f3:85:c0/58220635-8b9f-44fd-bbdc-7148777500f1-0' for key 'uniq_virtual_interfaces0address0deleted'\") [SQL: u'INSERT INTO virtual_interfaces (created_at, updated_at, deleted_at, deleted, address, network_id, instance_uuid, uuid, tag) VALUES (%(created_at)s, %(updated_at)s, %(deleted_at)s, %(deleted)s, %(address)s, %(network_id)s, %(instance_uuid)s, %(uuid)s, %(tag)s)'] [parameters: {'instance_uuid': '7ab65f46-0044-4098-a74e-9a28b8b20882', 'uuid': '58220635-8b9f-44fd-bbdc-7148777500f1', 'deleted': 0, 'created_at': datetime.datetime(2016, 8, 1, 15, 44, 12, 979629), 'updated_at': None, 'network_id': None, 'tag': None, 'address': u'fa:16:3e:f3:85:c0/58220635-8b9f-44fd-bbdc-7148777500f1', 'deleted_at': None}]\n2016-08-01 15:44:12.981 TRACE nova.db.sqlalchemy.api\n\nn-cpu.log:\n2016-08-01 15:44:14.075 ERROR nova.compute.manager [req-3296ed1c-0ca0-43aa-9b57-bd89412d92cc admin admin] [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Failed to allocate network(s)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Traceback (most recent call last):\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1911, in _build_and_run_instance\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     block_device_info=block_device_info)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2664, in spawn\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     write_to_disk=True)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4663, in _get_guest_xml\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     network_info_str = str(network_info)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/model.py\", line 524, in __str__\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return self._sync_wrapper(fn, *args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/model.py\", line 507, in _sync_wrapper\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     self.wait()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/model.py\", line 539, in wait\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     self[:] = self._gt.wait()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 175, in wait\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return self._exit_event.wait()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 121, in wait\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return hubs.get_hub().switch()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 294, in switch\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return self.greenlet.switch()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     result = function(*args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/utils.py\", line 1052, in context_wrapper\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return func(*args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1406, in _allocate_network_async\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     six.reraise(*exc_info)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1389, in _allocate_network_async\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     bind_host_id=bind_host_id)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 795, in allocate_for_instance\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     bind_host_id, dhcp_opts, available_macs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 914, in _update_ports_for_instance\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     vif.destroy()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     self.force_reraise()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     six.reraise(self.type_, self.value, self.tb)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 897, in _update_ports_for_instance\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     vifobj.create()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 210, in wrapper\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     ctxt, self, fn.__name__, args, kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 241, in object_action\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     objmethod=objmethod, args=args, kwargs=kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 169, in call\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     retry=self.retry)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 96, in _send\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     timeout=timeout, retry=retry)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 464, in send\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     retry=retry)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 455, in _send\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     raise result\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] VirtualInterfaceCreateException_Remote: Virtual Interface creation failed\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Traceback (most recent call last):\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/conductor/manager.py\", line 86, in _object_dispatch\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return getattr(target, method)(*args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 226, in wrapper\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return fn(self, *args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/objects/virtual_interface.py\", line 97, in create\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     db_vif = db.virtual_interface_create(self._context, updates)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/db/api.py\", line 649, in virtual_interface_create\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return IMPL.virtual_interface_create(context, values)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 169, in wrapper\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return f(*args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 240, in wrapped\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     return f(context, *args, **kwargs)\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 1540, in virtual_interface_create\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     raise exception.VirtualInterfaceCreateException()\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] VirtualInterfaceCreateException: Virtual Interface creation failed\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.075 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n2016-08-01 15:44:14.079 DEBUG nova.compute.utils [req-3296ed1c-0ca0-43aa-9b57-bd89412d92cc admin admin] [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Virtual Interface creation failed from (pid=6197) notify_about_instance_usage /opt/stack/nova/nova/compute/utils.py:313\n2016-08-01 15:44:14.079 ERROR nova.compute.manager [req-3296ed1c-0ca0-43aa-9b57-bd89412d92cc admin admin] [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Build of instance 7ab65f46-0044-4098-a74e-9a28b8b20882 aborted: Failed to allocate the network(s), not rescheduling.\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] Traceback (most recent call last):\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1770, in _do_build_and_run_instance\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     filter_properties)\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1950, in _build_and_run_instance\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]     reason=msg)\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882] BuildAbortException: Build of instance 7ab65f46-0044-4098-a74e-9a28b8b20882 aborted: Failed to allocate the network(s), not rescheduling.\n2016-08-01 15:44:14.079 TRACE nova.compute.manager [instance: 7ab65f46-0044-4098-a74e-9a28b8b20882]\n\nmysql after the error:\nmysql> select * from virtual_interfaces;\n+---------------------+------------+---------------------+----+--------------------------------------------------------+------------+--------------------------------------+--------------------------------------+---------+------+\n| created_at          | updated_at | deleted_at          | id | address                                                | network_id | uuid                                 | instance_uuid                        | deleted | tag  |\n+---------------------+------------+---------------------+----+--------------------------------------------------------+------------+--------------------------------------+--------------------------------------+---------+------+\n| 2016-08-01 04:51:13 | NULL       | NULL                |  1 | fa:16:3e:94:0e:d9/a2dab54d-6fb7-458f-baa4-a4615c7a01c0 |       NULL | a2dab54d-6fb7-458f-baa4-a4615c7a01c0 | 83d7950b-2a46-4441-98f9-8b39ccd5ad13 |       0 | NULL |\n| 2016-08-01 04:51:14 | NULL       | NULL                |  2 | fa:16:3e:d2:3f:cc/c217cb17-9bb0-4520-a776-7f291027507a |       NULL | c217cb17-9bb0-4520-a776-7f291027507a | 75453188-c0a7-4943-a6e9-4d71b5816d19 |       0 | NULL |\n| 2016-08-01 04:52:37 | NULL       | 2016-08-01 04:57:57 |  3 | fa:16:3e:a2:48:c9/5a276860-903b-4a25-8688-40f03d375f4f |       NULL | 5a276860-903b-4a25-8688-40f03d375f4f | d223d120-7e46-45d5-b233-8d8719de5a29 |       3 | NULL |\n| 2016-08-01 04:52:58 | NULL       | 2016-08-01 04:57:57 |  4 | fa:16:3e:55:1f:f1/52f28060-9014-48c7-b94e-6847e336727c |       NULL | 52f28060-9014-48c7-b94e-6847e336727c | d223d120-7e46-45d5-b233-8d8719de5a29 |       4 | NULL |\n| 2016-08-01 04:54:09 | NULL       | 2016-08-01 04:57:57 |  5 | fa:16:3e:b9:bc:26/2f1fad78-451f-4e91-a164-e8c925933d72 |       NULL | 2f1fad78-451f-4e91-a164-e8c925933d72 | d223d120-7e46-45d5-b233-8d8719de5a29 |       5 | NULL |\n| 2016-08-01 04:54:43 | NULL       | 2016-08-01 04:57:57 |  6 | fa:16:3e:01:89:22/b3add585-c06c-47c7-b081-24c2120fa7c7 |       NULL | b3add585-c06c-47c7-b081-24c2120fa7c7 | d223d120-7e46-45d5-b233-8d8719de5a29 |       6 | NULL |\n| 2016-08-01 04:57:57 | NULL       | 2016-08-01 04:57:57 |  7 | fa:16:3e:62:4f:38/71b6d508-fc59-4386-8b5f-b09432cab419 |       NULL | 71b6d508-fc59-4386-8b5f-b09432cab419 | 95142ff6-ec33-408b-8f11-2c86f332bbf8 |       7 | NULL |\n| 2016-08-01 15:26:03 | NULL       | 2016-08-01 15:38:45 |  9 | fa:16:3e:60:f3:f3/775de30a-c39a-46ea-81ef-f7f94d1c40d3 |       NULL | 775de30a-c39a-46ea-81ef-f7f94d1c40d3 | 77e4184c-f3ec-4b01-aa14-191583673ea4 |       9 | NULL |\n| 2016-08-01 15:26:11 | NULL       | 2016-08-01 15:38:45 | 10 | fa:16:3e:02:04:92/f5e8d9c3-832a-4f49-86b3-974dfef6cd38 |       NULL | f5e8d9c3-832a-4f49-86b3-974dfef6cd38 | 77e4184c-f3ec-4b01-aa14-191583673ea4 |      10 | NULL |\n| 2016-08-01 15:27:23 | NULL       | 2016-08-01 15:38:45 | 11 | fa:16:3e:f3:85:c0/58220635-8b9f-44fd-bbdc-7148777500f1 |       NULL | 58220635-8b9f-44fd-bbdc-7148777500f1 | 77e4184c-f3ec-4b01-aa14-191583673ea4 |      11 | NULL |\n| 2016-08-01 15:27:57 | NULL       | 2016-08-01 15:38:45 | 12 | fa:16:3e:21:5b:85/e66a8ddd-8398-427b-a0fd-403bdcbe9fae |       NULL | e66a8ddd-8398-427b-a0fd-403bdcbe9fae | 77e4184c-f3ec-4b01-aa14-191583673ea4 |      12 | NULL |\n| 2016-08-01 15:38:45 | NULL       | 2016-08-01 15:44:13 | 13 | fa:16:3e:44:8a:e7/45ec8e98-722e-46e3-abc9-73578e4766d5 |       NULL | 45ec8e98-722e-46e3-abc9-73578e4766d5 | 5cdb6bb1-bc10-4879-85b9-321f54bf3e80 |      13 | NULL |\n| 2016-08-01 15:38:45 | NULL       | 2016-08-01 15:44:13 | 14 | fa:16:3e:f3:85:c0/58220635-8b9f-44fd-bbdc-7148777500f1 |       NULL | 58220635-8b9f-44fd-bbdc-7148777500f1 | 5cdb6bb1-bc10-4879-85b9-321f54bf3e80 |      14 | NULL |\n| 2016-08-01 15:38:45 | NULL       | 2016-08-01 15:44:13 | 15 | fa:16:3e:21:5b:85/e66a8ddd-8398-427b-a0fd-403bdcbe9fae |       NULL | e66a8ddd-8398-427b-a0fd-403bdcbe9fae | 5cdb6bb1-bc10-4879-85b9-321f54bf3e80 |      15 | NULL |\n| 2016-08-01 15:38:46 | NULL       | 2016-08-01 15:44:13 | 16 | fa:16:3e:02:04:92/f5e8d9c3-832a-4f49-86b3-974dfef6cd38 |       NULL | f5e8d9c3-832a-4f49-86b3-974dfef6cd38 | 5cdb6bb1-bc10-4879-85b9-321f54bf3e80 |      16 | NULL |\n| 2016-08-01 15:44:12 | NULL       | 2016-08-01 15:44:13 | 17 | fa:16:3e:0f:f7:7c/eeda7841-9c60-49b7-b0f9-09103b6a9b91 |       NULL | eeda7841-9c60-49b7-b0f9-09103b6a9b91 | 7ab65f46-0044-4098-a74e-9a28b8b20882 |      17 | NULL |\n+---------------------+------------+---------------------+----+--------------------------------------------------------+------------+--------------------------------------+--------------------------------------+---------+------+\n16 rows in set (0.00 sec)\n\nThis may be related to https://bugs.launchpad.net/nova/+bug/1602357", 
            "date_created": "2016-08-01 16:03:04.793302+00:00", 
            "author": "https://api.launchpad.net/1.0/~johnsom"
        }, 
        {
            "content": "You don't need to update the port.device_id to be '', nova will do that for ports it didn't create. By wiping those out before deleting the instance, nova can't find the ports to unbind/delete here:\n\nhttps://github.com/openstack/nova/blob/b790332f227411a16049f841c68292a7b0b88d81/nova/network/neutronv2/api.py#L1064\n\nBut nova should still be deleting the virtual interface records for the given instance here:\n\nhttps://github.com/openstack/nova/blob/b790332f227411a16049f841c68292a7b0b88d81/nova/network/neutronv2/api.py#L1091", 
            "date_created": "2016-08-01 18:46:18.029743+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Are you waiting for the nova instance to be deleted before trying to spawn a new instance with the port?", 
            "date_created": "2016-08-01 18:46:54.146079+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "To expand on comment 2, I'm wondering if you're just issuing the delete request which is a cast to the compute and asynchronous and before the vifs are deleted from the nova db you're already trying to boot a new instance with the port, and that's why you hit the unique constraint.\n\nIdeally what you should be doing is deleting the instance and polling the port.device_id to be unbound, that's what the tempest test \"test_reassign_port_between_servers\" does.", 
            "date_created": "2016-08-01 19:09:45.325254+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I am going to do additional testing on this today.  It may be that we are assigning the port too quickly, in which case polling is probably the right answer.", 
            "date_created": "2016-08-08 19:07:42.626297+00:00", 
            "author": "https://api.launchpad.net/1.0/~johnsom"
        }, 
        {
            "content": "Matt,\nI have done additional testing.  If I don't clear that device_id before the nova delete call the port ends up getting deleted.\n\nThis is a port_show before the nova delete of a port that gets deleted:\n\nport: {'status': u'ACTIVE', 'name': u'', 'admin_state_up': True, 'network_id': u'6708b678-eac3-4334-8404-d9b729b43eaf', 'device_owner': u'compute:None', 'device_id': u'93aec306-ba5b-48ff-a668-d2f4e18be215', 'mac_address': u'fa:16:3e:d6:f4:a5', 'project_id': u'4ab023de954e443b93d1163c0e729485', 'fixed_ips': None, 'id': u'38d10b1d-c06d-4316-b3b9-cb311f8cb690', 'network': None}\n\nI am puzzled as to why a nova delete of the instance would cause this port to get deleted.  Do you see something in the above port details that tips you off as to why it would get flagged for deletion?\n\nThank you for your help here,\nMichael\n\n", 
            "date_created": "2016-08-10 23:56:14.158329+00:00", 
            "author": "https://api.launchpad.net/1.0/~johnsom"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2016-10-10 04:18:07.453028+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ]
}