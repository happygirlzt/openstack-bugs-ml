{
    "status": "Expired", 
    "last_updated": "2015-10-16 04:17:22.927318+00:00", 
    "description": "There is a problem with the nova command 'volume-update' that leaves cinder volumes in the states 'attaching' and 'deleting'.\n\nIf the nova command 'volume-update' is used by a non admin user the command fails and the volumes referenced in the command are left in the states 'attaching' and 'deleting'.\n\n\nFor example, if a non admin user runs the command\n $ nova volume-update d39dc7f2-929d-49bb-b22f-56adb3f378c7 f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b 59b0cf66-67c8-4041-a505-78000b9c71f6\n\n Will result in the two volumes stuck like this:\n\n $ cinder list\n +--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n |                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n +--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n | 59b0cf66-67c8-4041-a505-78000b9c71f6 | attaching |     vol2     |  1   |     None    |  false   |                                      |\n | f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b | detaching |     vol1     |  1   |     None    |  false   | d39dc7f2-929d-49bb-b22f-56adb3f378c7 |\n +--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n\n\nAnd the following in the cinder-api log:\n\n\n2015-01-21 11:00:03.969 13588 DEBUG keystonemiddleware.auth_token [-] Received request from user: user_id None, project_id None, roles None service: user_id None, project_id None, roles None __call__ /opt/stack/venvs/openstack/local/lib/python2.7/site-packages/keystonemiddleware/auth_token.py:746\n2015-01-21 11:00:03.970 13588 DEBUG routes.middleware [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] Matched POST /d40e3207e34a4b558bf2d58bd3fe268a/volumes/f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b/action __call__ /opt/stack/venvs/openstack/local/lib/python2.7/site-packages/routes/middleware.py:100\n2015-01-21 11:00:03.971 13588 DEBUG routes.middleware [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] Route path: '/{project_id}/volumes/:(id)/action', defaults: {'action': u'action', 'controller': <cinder.api.openstack.wsgi.Resource object at 0x7febe7a89850>} __call__ /opt/stack/venvs/openstack/local/lib/python2.7/site-packages/routes/middleware.py:102\n2015-01-21 11:00:03.971 13588 DEBUG routes.middleware [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] Match dict: {'action': u'action', 'controller': <cinder.api.openstack.wsgi.Resource object at 0x7febe7a89850>, 'project_id': u'd40e3207e34a4b558bf2d58bd3fe268a', 'id': u'f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b'} __call__ /opt/stack/venvs/openstack/local/lib/python2.7/site-packages/routes/middleware.py:103\n2015-01-21 11:00:03.972 13588 INFO cinder.api.openstack.wsgi [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] POST http://192.0.2.24:8776/v1/d40e3207e34a4b558bf2d58bd3fe268a/volumes/f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b/action\n2015-01-21 11:00:03.972 13588 DEBUG cinder.api.openstack.wsgi [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] Action body: {\"os-migrate_volume_completion\": {\"new_volume\": \"59b0cf66-67c8-4041-a505-78000b9c71f6\", \"error\": false}} get_method /opt/stack/venvs/openstack/local/lib/python2.7/site-packages/cinder/api/openstack/wsgi.py:1010\n2015-01-21 11:00:03.973 13588 INFO cinder.api.openstack.wsgi [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] http://192.0.2.24:8776/v1/d40e3207e34a4b558bf2d58bd3fe268a/volumes/f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b/action returned with HTTP 403\n2015-01-21 11:00:03.975 13588 INFO eventlet.wsgi.server [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] 127.0.0.1 - - [21/Jan/2015 11:00:03] \"POST /v1/d40e3207e34a4b558bf2d58bd3fe268a/volumes/f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b/action HTTP/1.1\" 403 429 0.123613\n\n\n\n\nThe problem is that the nova policy.json file allows a non admin user to run the command 'volume-update', but the cinder policy.json file requires the admin role to run the action os-migrate_volume_completion, which is called by nova as part of the 'update-volume' process.\n\nThe operation will complete successfully if it is performed by an admin user, or if it is run by a non admin user after the cinder policy.json file is updated.\n\n\nThe simplest fix would be to remove the \"rule:admin_api\" requirement from the \"os-migrate_volume_completion\" action in cinder policy.json", 
    "tags": [
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1413610", 
    "owner": "None", 
    "id": 1413610, 
    "index": 5394, 
    "created": "2015-01-22 14:27:10.127947+00:00", 
    "title": "Nova volume-update leaves volumes stuck in attaching/detaching", 
    "comments": [
        {
            "content": "There is a problem with the nova command 'volume-update' that leaves cinder volumes in the states 'attaching' and 'deleting'.\n\nIf the nova command 'volume-update' is used by a non admin user the command fails and the volumes referenced in the command are left in the states 'attaching' and 'deleting'.\n\n\nFor example, if a non admin user runs the command\n $ nova volume-update d39dc7f2-929d-49bb-b22f-56adb3f378c7 f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b 59b0cf66-67c8-4041-a505-78000b9c71f6\n\n Will result in the two volumes stuck like this:\n\n $ cinder list\n +--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n |                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n +--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n | 59b0cf66-67c8-4041-a505-78000b9c71f6 | attaching |     vol2     |  1   |     None    |  false   |                                      |\n | f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b | detaching |     vol1     |  1   |     None    |  false   | d39dc7f2-929d-49bb-b22f-56adb3f378c7 |\n +--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n\n\nAnd the following in the cinder-api log:\n\n\n2015-01-21 11:00:03.969 13588 DEBUG keystonemiddleware.auth_token [-] Received request from user: user_id None, project_id None, roles None service: user_id None, project_id None, roles None __call__ /opt/stack/venvs/openstack/local/lib/python2.7/site-packages/keystonemiddleware/auth_token.py:746\n2015-01-21 11:00:03.970 13588 DEBUG routes.middleware [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] Matched POST /d40e3207e34a4b558bf2d58bd3fe268a/volumes/f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b/action __call__ /opt/stack/venvs/openstack/local/lib/python2.7/site-packages/routes/middleware.py:100\n2015-01-21 11:00:03.971 13588 DEBUG routes.middleware [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] Route path: '/{project_id}/volumes/:(id)/action', defaults: {'action': u'action', 'controller': <cinder.api.openstack.wsgi.Resource object at 0x7febe7a89850>} __call__ /opt/stack/venvs/openstack/local/lib/python2.7/site-packages/routes/middleware.py:102\n2015-01-21 11:00:03.971 13588 DEBUG routes.middleware [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] Match dict: {'action': u'action', 'controller': <cinder.api.openstack.wsgi.Resource object at 0x7febe7a89850>, 'project_id': u'd40e3207e34a4b558bf2d58bd3fe268a', 'id': u'f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b'} __call__ /opt/stack/venvs/openstack/local/lib/python2.7/site-packages/routes/middleware.py:103\n2015-01-21 11:00:03.972 13588 INFO cinder.api.openstack.wsgi [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] POST http://192.0.2.24:8776/v1/d40e3207e34a4b558bf2d58bd3fe268a/volumes/f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b/action\n2015-01-21 11:00:03.972 13588 DEBUG cinder.api.openstack.wsgi [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] Action body: {\"os-migrate_volume_completion\": {\"new_volume\": \"59b0cf66-67c8-4041-a505-78000b9c71f6\", \"error\": false}} get_method /opt/stack/venvs/openstack/local/lib/python2.7/site-packages/cinder/api/openstack/wsgi.py:1010\n2015-01-21 11:00:03.973 13588 INFO cinder.api.openstack.wsgi [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] http://192.0.2.24:8776/v1/d40e3207e34a4b558bf2d58bd3fe268a/volumes/f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b/action returned with HTTP 403\n2015-01-21 11:00:03.975 13588 INFO eventlet.wsgi.server [req-d08bc456-14e9-4f97-9f4e-a9f87e7d6add a00b77059c8c4bbbb00a4ff9a8496b2d d40e3207e34a4b558bf2d58bd3fe268a - - -] 127.0.0.1 - - [21/Jan/2015 11:00:03] \"POST /v1/d40e3207e34a4b558bf2d58bd3fe268a/volumes/f0c3ea8f-c00f-4db8-aa20-e2dc6a1ddc9b/action HTTP/1.1\" 403 429 0.123613\n\n\n\n\nThe problem is that the nova policy.json file allows a non admin user to run the command 'volume-update', but the cinder policy.json file requires the admin role to run the action os-migrate_volume_completion, which is called by nova as part of the 'update-volume' process.\n\nThe operation will complete successfully if it is performed by an admin user, or if it is run by a non admin user after the cinder policy.json file is updated.\n\n\nThe simplest fix would be to remove the \"rule:admin_api\" requirement from the \"os-migrate_volume_completion\" action in cinder policy.json", 
            "date_created": "2015-01-22 14:27:10.127947+00:00", 
            "author": "https://api.launchpad.net/1.0/~oliver-leahy-l"
        }, 
        {
            "content": "Should nova do some tidying up if it gets a permission denied? ", 
            "date_created": "2015-01-22 14:43:11.007829+00:00", 
            "author": "https://api.launchpad.net/1.0/~duncan-thomas"
        }, 
        {
            "content": "Currently 403 doesn't seem to be an expected code?\n\n    @wsgi.response(202)\n    @extensions.expected_errors((400, 404, 409))\n    @validation.schema(volumes_schema.update_volume_attachment)\n    def update(self, req, server_id, id, body):\n", 
            "date_created": "2015-01-22 18:41:41.003743+00:00", 
            "author": "https://api.launchpad.net/1.0/~parthipan"
        }, 
        {
            "content": "Duncan, Nova does not clean up if this call fails:\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L4783\n\nWhile I agree Nova shouldn't assume this call will succeed as it does today, what I think Loganathan is explaining is we have nova expecting volume migration completion to be ran by a normal end user, not the administrator.\n\nVolume migrate was never intended to be used by an end user, which is why by default it's required for the user running it to be within the admin role. In an OpenStack environment, the end user wouldn't know or care about the storage backends, they would just want to consume the resources based on requirements advertised by volume types, that's it. \n\nWith that in mind, the administrator cares/knows about the backends, so we expose this feature to an admin role only. However, I don't think that's the problem either.\n\nCurrently in the Nova code it does elevate the context which it talks to Cinder, so I'm not sure why this is happening:\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L4796", 
            "date_created": "2015-01-24 22:32:12.108493+00:00", 
            "author": "https://api.launchpad.net/1.0/~thingee"
        }, 
        {
            "content": "In this case migrate_volume_completion is not being called as part of 'Volume migrate', it's being called by the python-novaclient operation 'volume-update' which can be called by a non-admin user. The command 'volume-update takes as parameters an instance, an attached volume and a new volume; and it replaces the attached volume with the new volume. That is it does a copy - detach oldvol - attach newvol\n\nIf  an admin user runs 'nova volume-update ' the operation completes successfully. But if a user that does not have admin privs runs it, the we end up in the state described above.\n\n\nSo I think that what is happening is that nova performs  all it's operations as the necessary, elevating context as required. Then nova makes a call to the cinder api migrate_volume_completion, with the non-admin user creds. The cinder api server runs authorize() on the non admin-creds and refuses to continue.\n\nSo I think there are three questions here\n\n1. Should the python novaclient command 'volume-update' be a non-admin operation. The nova devs I've spoken to believe that it should be available to non-admin users\n\n2. If volume-admin is available to non-admins then should nova call the os-migrate_volume_completion api, or should it call os-detach and os-attach seperately on the old and new volumes\n\n3. Should nova clean up volume states in the case where an error occurs towards the end of a volume operation.\n\nFor the moment I'm assuming that cinder should support nova in allowing non-admin users to run update-volume, and I'm assuming cinder should allow the non-admin user to run the os-migrate_volume_completion command.\n\nI think the issue of nova cleaning up is an independent bug which could be raised on nova.\n\nSo, I'm preparing a patch that makes os-migrate_volume_completion a non-admin operation, \n\nPlease let me know if you think this is the wrong approach.", 
            "date_created": "2015-01-26 10:33:40.865334+00:00", 
            "author": "https://api.launchpad.net/1.0/~oliver-leahy-l"
        }, 
        {
            "content": "Ollie, this is nothing new with cinder client. There are plenty of things that can be called that are admin only. See this search for 'admin only' in the client code:\n\nhttp://paste.openstack.org/show/162316/\n\nAs explained in my last comment, Nova is elevating the context when making this call, so time should be spent on figuring out why that's not working as expeected:\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L4796", 
            "date_created": "2015-01-26 16:43:02.755446+00:00", 
            "author": "https://api.launchpad.net/1.0/~thingee"
        }, 
        {
            "content": "Mike: I'm aware nova /doesn't/ do any clean-up, I'm suggesting that it\nshould.\n\nContext.elevated, like cinder, does not use an admin context for\ninter-project rest calls, only RPC/db calls. There was a new version of\nelevate added to cinder recently to use a service (usually admin) user for\nspecific calls, I think nova has a similar concept but does not yet use it\nfor this call.\n", 
            "date_created": "2015-01-27 16:05:42+00:00", 
            "author": "https://api.launchpad.net/1.0/~duncan-thomas"
        }, 
        {
            "content": "Mike: Duncan is correct, elevating the nova context does not mean that nova will use different credentials when it connects to the cinder API. That's what I was saying in my last post and I've confirmed it with nova developers.\n\nGiven that, it seems that 'nova volume-update' is working as expected. The user credentials passed with the os-migrate_volume_completion do not have admin rights, so cinder returns the status 403.\n\nDo you agree with that? or is there something else you had in mind?", 
            "date_created": "2015-02-03 13:38:04.846811+00:00", 
            "author": "https://api.launchpad.net/1.0/~oliver-leahy-l"
        }, 
        {
            "content": "Hi,\n\nI have tested this issue on latest master and it is reproducible by admin user as well i.e., volumes are remaining in 'attaching' and 'detaching' states by admin user and normal user after running nova volume-update command.\n\nI have found one launchpad issue related to migrate attach volume which is already fixed,\nhttps://bugs.launchpad.net/cinder/+bug/1316079\n\nTwo different patches were submitted for this issue, but the cinder patch ( https://review.openstack.org/#/c/101932/1 ) was merged in Juno and nova patch ( https://review.openstack.org/#/c/101933/3 ) was merged in Kilo1.\nSo, volume update works properly on stable/juno because nova patch was not merged.\n\nIn nova patch, attach and detach calls are moved from swap_volume() method of nova.compute.manager to migrate_volume_completion() method of cinder.volume.manager.\n\nIMO, while fixing this cinder migrate attach volume issue, nova volume-update was not tested properly.\n\nWhen we migrate volume which is attached to the instance, cinder calls update_server_volume() method of nova from cinder.volume.manager, which internally calls swap_volume() method of nova.manager(which also gets called in case of nova volume-update.)\nhttps://github.com/openstack/cinder/blob/master/cinder/volume/manager.py#L1078\n\nIn swap_volume() of nova.compute, migrate_volume_completion() method of cinder.volume.manager is called which deletes the old volume after detaching it in case of cinder migrate attach volume, but in case of nova volume-update the new_volume_id gets returned from migrate_volume_completion() method of cinder.volume.api itself (It does not give call to manager because migration status of new volume and old volume are None).\n\nhttps://github.com/openstack/cinder/blob/master/cinder/volume/api.py#L1136\n\nHence volumes are remaining in 'attaching' and 'detaching' states.", 
            "date_created": "2015-02-11 09:27:04.259011+00:00", 
            "author": "https://api.launchpad.net/1.0/~pranali-deore"
        }, 
        {
            "content": "FYI,  I have added the missing tempest test for nova os-volume-attachment-update api.\nhttps://review.openstack.org/#/c/156515/1", 
            "date_created": "2015-02-17 09:31:04.385398+00:00", 
            "author": "https://api.launchpad.net/1.0/~pranali-deore"
        }, 
        {
            "content": "Putting in incomplete for nova until we sort out what is actually needed on the nova side. It seems unclear if there is an issue on that side.", 
            "date_created": "2015-03-30 19:54:46.015488+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Change abandoned by Mike Perez (<email address hidden>) on branch: master\nReview: https://review.openstack.org/150086\nReason: Over a month with no update.", 
            "date_created": "2015-08-16 08:09:11.041766+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2015-10-16 04:17:17.528137+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ]
}