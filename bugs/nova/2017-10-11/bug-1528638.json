{
    "status": "Fix Released", 
    "last_updated": "2016-07-14 13:00:57.143140+00:00", 
    "description": "It happens because qemu-img is called for directory instead of a file in case of ploop images.\nBacktrace is the following:\n\n\n2015-12-17 15:46:37.917 ERROR oslo_service.periodic_task [req-1309d92e-1c47-491f-9921-93553abb3430 None None] Error during ComputeManager._run_image_cache_manager_pass\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task Traceback (most recent call last):\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/usr/lib/python2.7/site-packages/oslo_service/periodic_task.py\", line 220, in run_periodic_tasks\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     task(self, context)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/compute/manager.py\", line 6524, in _run_image_cache_manager_pass\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     self.driver.manage_image_cache(context, filtered_instances)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/libvirt/driver.py\", line 6680, in manage_image_cache\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     self.image_cache_manager.update(context, all_instances)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/libvirt/imagecache.py\", line 664, in update\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     self._age_and_verify_cached_images(context, all_instances, base_dir)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/libvirt/imagecache.py\", line 600, in _age_and_verify_cached_images\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     inuse_backing_images = self._list_backing_images()\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/libvirt/imagecache.py\", line 309, in _list_backing_images\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     disk_path)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/libvirt/utils.py\", line 181, in get_disk_backing_file\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     backing_file = images.qemu_img_info(path).backing_file\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/images.py\", line 60, in qemu_img_info\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     'qemu-img', 'info', path)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/utils.py\", line 391, in execute\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     return processutils.execute(*cmd, **kwargs)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/usr/lib/python2.7/site-packages/oslo_concurrency/processutils.py\", line 312, in execute\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     cmd=sanitized_cmd)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task ProcessExecutionError: Unexpected error while running command.\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task Command: env LC_ALL=C LANG=C qemu-img info /vzt/stack/data/nova/instances/e9bd57ca-1210-461a-b12b-1c2b9788f106/disk\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task Exit code: 1\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task Stdout: u''\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task Stderr: u\"qemu-img: Could not open '/vzt/stack/data/nova/instances/e9bd57ca-1210-461a-b12b-1c2b9788f106/disk': Could not read image for determining its format: Is a directory\\n\"\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task", 
    "tags": [
        "libvirt", 
        "ploop", 
        "virtuozzo"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1528638", 
    "owner": "https://api.launchpad.net/1.0/~mfeoktistov", 
    "id": 1528638, 
    "index": 4415, 
    "created": "2015-12-22 16:48:39.233706+00:00", 
    "title": "nova manage_cache periodic task fails for ploop images", 
    "comments": [
        {
            "content": "It happens because qemu-img is called for directory instead of a file in case of ploop images.\nBacktrace is the following:\n\n\n2015-12-17 15:46:37.917 ERROR oslo_service.periodic_task [req-1309d92e-1c47-491f-9921-93553abb3430 None None] Error during ComputeManager._run_image_cache_manager_pass\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task Traceback (most recent call last):\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/usr/lib/python2.7/site-packages/oslo_service/periodic_task.py\", line 220, in run_periodic_tasks\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     task(self, context)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/compute/manager.py\", line 6524, in _run_image_cache_manager_pass\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     self.driver.manage_image_cache(context, filtered_instances)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/libvirt/driver.py\", line 6680, in manage_image_cache\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     self.image_cache_manager.update(context, all_instances)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/libvirt/imagecache.py\", line 664, in update\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     self._age_and_verify_cached_images(context, all_instances, base_dir)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/libvirt/imagecache.py\", line 600, in _age_and_verify_cached_images\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     inuse_backing_images = self._list_backing_images()\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/libvirt/imagecache.py\", line 309, in _list_backing_images\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     disk_path)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/libvirt/utils.py\", line 181, in get_disk_backing_file\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     backing_file = images.qemu_img_info(path).backing_file\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/virt/images.py\", line 60, in qemu_img_info\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     'qemu-img', 'info', path)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/vzt/stack/nova/nova/utils.py\", line 391, in execute\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     return processutils.execute(*cmd, **kwargs)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task   File \"/usr/lib/python2.7/site-packages/oslo_concurrency/processutils.py\", line 312, in execute\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task     cmd=sanitized_cmd)\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task ProcessExecutionError: Unexpected error while running command.\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task Command: env LC_ALL=C LANG=C qemu-img info /vzt/stack/data/nova/instances/e9bd57ca-1210-461a-b12b-1c2b9788f106/disk\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task Exit code: 1\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task Stdout: u''\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task Stderr: u\"qemu-img: Could not open '/vzt/stack/data/nova/instances/e9bd57ca-1210-461a-b12b-1c2b9788f106/disk': Could not read image for determining its format: Is a directory\\n\"\n2015-12-17 15:46:37.917 23014 ERROR oslo_service.periodic_task", 
            "date_created": "2015-12-22 16:48:39.233706+00:00", 
            "author": "https://api.launchpad.net/1.0/~mnestratov"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/260636", 
            "date_created": "2015-12-22 17:13:37.683445+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/260636\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=728559a25e4c380f3a3a8f447a8932979afa8379\nSubmitter: Jenkins\nBranch:    master\n\ncommit 728559a25e4c380f3a3a8f447a8932979afa8379\nAuthor: Maxim Nestratov <email address hidden>\nDate:   Tue Jun 21 12:57:43 2016 +0300\n\n    add ploop support into qemu-img info\n    \n    This is done by detecting ploop format as a directory\n    containing DiskDescriptor.xml file\n    \n    Change-Id: Icde0152ba1e735293fdaebde592a43a9242a6c3f\n    Partial-Bug: #1528638\n", 
            "date_created": "2016-06-27 11:01:49.322750+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/222567\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b1753b095abeeef2dea15b0e7fa95e43aaa56b21\nSubmitter: Jenkins\nBranch:    master\n\ncommit b1753b095abeeef2dea15b0e7fa95e43aaa56b21\nAuthor: Mikhail Feoktistov <email address hidden>\nDate:   Fri Sep 11 13:19:43 2015 +0300\n\n    libvirt: fix disk size calculation for VZ container instances\n    \n    Image based VZ containers root disks are stored in libvirt XML\n    configuration as filesystems, so we need to parse them accordinly.\n    Their virtual disks are in fact directories that contain different\n    files. We can get size of virtual image via qemu-img, while total disk\n    size is a total space that ploop directory consumes.\n    \n    Closes-Bug: #1528638\n    Change-Id: I7bac5511df1f30ded3cea263e6b46e605e20e5fb\n", 
            "date_created": "2016-06-27 11:06:40.738011+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b2 development milestone.", 
            "date_created": "2016-07-14 13:00:56.449043+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }
    ]
}