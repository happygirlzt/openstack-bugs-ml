{
    "status": "Fix Released", 
    "last_updated": "2016-06-02 19:34:41.393851+00:00", 
    "description": "Scenario A:\n1. image disk type: sparse\n2. image size(2.3G)\n3. flavor1(root_disk: 5G)\n4. use_linked_clone\n\nScenario B:\n1. image disk type: sparse\n2. image size(2.3G)\n3. flavor2(root_disk: 6G)\n4. use_linked_clone\n\nI boot an instance with sparse image disk, image size is 2.3G, Nova flavor root disk is 5G, everything got well(Scenario A).\n\nThen I boot another instance  with new flavor root disk 6G(Scenario B),  it raises error:\n2016-03-10 17:31:56.350 3211 ERROR nova.compute.manager [req-a3e93241-5f54-485a-a7f0-2e1e0ebad92d 4412e38ec9814b96a03e63097ec51f1a 8f75187cd29f4715881f450646fc6e08 - - -] [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925] Instance failed to spawn\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925] Traceback (most recent call last):\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2461, in _build_resources\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     yield resources\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2333, in _build_and_run_instance\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     block_device_info=block_device_info)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/driver.py\", line 480, in spawn\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     admin_password, network_info, block_device_info)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/vmops.py\", line 636, in spawn\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     self._use_disk_image_as_linked_clone(vm_ref, vi)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/vmops.py\", line 1747, in _use_disk_image_as_linked_clone\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     vi.dc_info, vi.ii, vi.instance, str(sized_disk_ds_loc))\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/vmops.py\", line 224, in _extend_if_required\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     root_vmdk_path, dc_info.ref)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/vmops.py\", line 202, in _extend_virtual_disk\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     self._delete_datastore_file(ds_path, dc_ref)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     six.reraise(self.type_, self.value, self.tb)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/vmops.py\", line 193, in _extend_virtual_disk\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     self._session._wait_for_task(vmdk_extend_task)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/driver.py\", line 680, in _wait_for_task\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     return self.wait_for_task(task_ref)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/oslo_vmware/api.py\", line 380, in wait_for_task\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     return evt.wait()\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/eventlet/event.py\", line 121, in wait\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     return hubs.get_hub().switch()\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/eventlet/hubs/hub.py\", line 294, in switch\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     return self.greenlet.switch()\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/oslo_vmware/common/loopingcall.py\", line 76, in _inner\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     self.f(*self.args, **self.kw)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/oslo_vmware/api.py\", line 417, in _poll_task\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     raise task_ex\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925] VMwareDriverException: \\u6307\\u5b9a\\u7684\\u53c2\\u6570\\u9519\\u8bef\\u3002\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925] capacity\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]\n2016-03-10 17:31:56.352 3211 INFO nova.compute.manager [req-a3e93241-5f54-485a-a7f0-2e1e0ebad92d 4412e38ec9814b96a03e63097ec51f1a 8f75187cd29f4715881f450646fc6e08 - - -] [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925] Terminating instance\n\n\nBecause the cache_image_folder already exists, it not update image size.  In _use_disk_image_as_linked_clone function, root_gb greater than image file size, so it excutes  _extend_virtual_disk error.", 
    "tags": [
        "vmware"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1555644", 
    "owner": "https://api.launchpad.net/1.0/~hellochosen", 
    "id": 1555644, 
    "index": 6091, 
    "created": "2016-03-10 13:59:09.750505+00:00", 
    "title": "VMware: Extending virtual disk failed with error: capacity", 
    "comments": [
        {
            "content": "Scenario A:\n1. image disk type: sparse\n2. image size(2.3G)\n3. flavor1(root_disk: 5G)\n4. use_linked_clone\n\nScenario B:\n1. image disk type: sparse\n2. image size(2.3G)\n3. flavor2(root_disk: 6G)\n4. use_linked_clone\n\nI boot an instance with sparse image disk, image size is 2.3G, Nova flavor root disk is 5G, everything got well(Scenario A).\n\nThen I boot another instance  with new flavor root disk 6G(Scenario B),  it raises error:\n2016-03-10 17:31:56.350 3211 ERROR nova.compute.manager [req-a3e93241-5f54-485a-a7f0-2e1e0ebad92d 4412e38ec9814b96a03e63097ec51f1a 8f75187cd29f4715881f450646fc6e08 - - -] [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925] Instance failed to spawn\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925] Traceback (most recent call last):\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2461, in _build_resources\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     yield resources\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2333, in _build_and_run_instance\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     block_device_info=block_device_info)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/driver.py\", line 480, in spawn\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     admin_password, network_info, block_device_info)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/vmops.py\", line 636, in spawn\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     self._use_disk_image_as_linked_clone(vm_ref, vi)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/vmops.py\", line 1747, in _use_disk_image_as_linked_clone\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     vi.dc_info, vi.ii, vi.instance, str(sized_disk_ds_loc))\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/vmops.py\", line 224, in _extend_if_required\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     root_vmdk_path, dc_info.ref)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/vmops.py\", line 202, in _extend_virtual_disk\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     self._delete_datastore_file(ds_path, dc_ref)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     six.reraise(self.type_, self.value, self.tb)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/vmops.py\", line 193, in _extend_virtual_disk\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     self._session._wait_for_task(vmdk_extend_task)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/nova/virt/vmwareapi/driver.py\", line 680, in _wait_for_task\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     return self.wait_for_task(task_ref)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/oslo_vmware/api.py\", line 380, in wait_for_task\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     return evt.wait()\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/eventlet/event.py\", line 121, in wait\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     return hubs.get_hub().switch()\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/eventlet/hubs/hub.py\", line 294, in switch\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     return self.greenlet.switch()\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/oslo_vmware/common/loopingcall.py\", line 76, in _inner\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     self.f(*self.args, **self.kw)\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]   File \"/usr/lib/python2.7/site-packages/oslo_vmware/api.py\", line 417, in _poll_task\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]     raise task_ex\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925] VMwareDriverException: \\u6307\\u5b9a\\u7684\\u53c2\\u6570\\u9519\\u8bef\\u3002\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925] capacity\n2016-03-10 17:31:56.350 3211 TRACE nova.compute.manager [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925]\n2016-03-10 17:31:56.352 3211 INFO nova.compute.manager [req-a3e93241-5f54-485a-a7f0-2e1e0ebad92d 4412e38ec9814b96a03e63097ec51f1a 8f75187cd29f4715881f450646fc6e08 - - -] [instance: 22ea4a58-2296-40fc-b69b-a511a3b6d925] Terminating instance\n\n\nBecause the cache_image_folder already exists, it not update image size.  In _use_disk_image_as_linked_clone function, root_gb greater than image file size, so it excutes  _extend_virtual_disk error.", 
            "date_created": "2016-03-10 13:59:09.750505+00:00", 
            "author": "https://api.launchpad.net/1.0/~hellochosen"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/291203", 
            "date_created": "2016-03-10 14:23:46.458599+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/291203\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=589660af7c4ac3903f209c912e89795b8d62a122\nSubmitter: Jenkins\nBranch:    master\n\ncommit 589660af7c4ac3903f209c912e89795b8d62a122\nAuthor: Dongcan Ye <email address hidden>\nDate:   Thu Mar 10 22:09:24 2016 +0800\n\n    VMware: Always update image size for sparse image\n    \n    In some situation, if image cache folder already exists, we may not\n    update image size. This will cause extend root disk failed in situation\n    using sparse image and use_linked_clone.\n    \n    This patch update image size for sparse image whether the image cache\n    folder exists or not.\n    \n    Change-Id: I017194e7314458a493ccc942bef34209a902809e\n    Closes-Bug: #1555644\n", 
            "date_created": "2016-04-05 11:03:04.658951+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b1 development milestone.", 
            "date_created": "2016-06-02 19:34:40.719415+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }
    ]
}