{
    "status": "Won't Fix", 
    "last_updated": "2016-12-09 13:34:54.836534+00:00", 
    "description": "Description\n===========\n\nI observed this issue a few times, mainly while doing stress testing of cold migration.\n\nNeutron returns this error (see stack trace):\nUnauthorized: Authentication required\n\nSteps to reproduce\n==================\n\n1) Boot multiple vms (5-6) \n2) Stress test cold migration: migrate all vms, once confirmed, redo again, over and over \n\nActual result\n=============\n\n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] Traceback (most recent call last): \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4271, in finish_resize \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] disk_info, image_meta) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4210, in _finish_resize \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] network_info = self.network_api.get_instance_nw_info(context, instance) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/network/base_api.py\", line 253, in get_instance_nw_info \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] result = self._get_instance_nw_info(context, instance, **kwargs) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 994, in _get_instance_nw_info \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] preexisting_port_ids) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 1787, in _build_network_info_model \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] context, instance, networks, port_ids) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 1017, in _gather_port_ids_and_networks \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] net_ids) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 207, in _get_available_networks \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] nets = neutron.list_networks(**search_opts).get('networks', []) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 105, in with_params \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] ret = self.function(instance, *args, **kwargs) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 730, in list_networks \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] **_params) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 384, in list \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] for r in self._pagination(collection, path, **params): \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 399, in _pagination \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] res = self.get(path, params=params) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 369, in get \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] headers=headers, params=params) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 346, in retry_request \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] headers=headers, params=params) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 309, in do_request \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] self._handle_fault_response(status_code, replybody, resp) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 284, in _handle_fault_response \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] exception_handler_v20(status_code, error_body) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 92, in exception_handler_v20 \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] request_ids=request_ids) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] Unauthorized: Authentication required \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] Neutron server returns request_ids: ['req-ad48fbe3-8405-4393-9251-ca5fa20c9653'] \n\nEnvironment\n===========\n\nMitaka", 
    "tags": [
        "neutron"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1625321", 
    "owner": "None", 
    "id": 1625321, 
    "index": 6442, 
    "created": "2016-09-19 19:01:51.174764+00:00", 
    "title": "Hitting 'Authentication required' on migration when building network info model (token expired)", 
    "comments": [
        {
            "content": "Description\n===========\n\nI observed this issue a few times, mainly while doing stress testing of cold migration.\n\nNeutron returns this error (see stack trace):\nUnauthorized: Authentication required\n\nSteps to reproduce\n==================\n\n1) Boot multiple vms (5-6) \n2) Stress test cold migration: migrate all vms, once confirmed, redo again, over and over \n\nActual result\n=============\n\n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] Traceback (most recent call last): \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4271, in finish_resize \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] disk_info, image_meta) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4210, in _finish_resize \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] network_info = self.network_api.get_instance_nw_info(context, instance) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/network/base_api.py\", line 253, in get_instance_nw_info \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] result = self._get_instance_nw_info(context, instance, **kwargs) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 994, in _get_instance_nw_info \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] preexisting_port_ids) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 1787, in _build_network_info_model \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] context, instance, networks, port_ids) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 1017, in _gather_port_ids_and_networks \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] net_ids) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 207, in _get_available_networks \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] nets = neutron.list_networks(**search_opts).get('networks', []) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 105, in with_params \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] ret = self.function(instance, *args, **kwargs) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 730, in list_networks \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] **_params) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 384, in list \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] for r in self._pagination(collection, path, **params): \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 399, in _pagination \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] res = self.get(path, params=params) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 369, in get \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] headers=headers, params=params) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 346, in retry_request \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] headers=headers, params=params) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 309, in do_request \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] self._handle_fault_response(status_code, replybody, resp) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 284, in _handle_fault_response \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] exception_handler_v20(status_code, error_body) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 92, in exception_handler_v20 \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] request_ids=request_ids) \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] Unauthorized: Authentication required \n2016-09-02 13:53:14.887 61968 ERROR nova.compute.manager [instance: da6e6dd9-6042-478f-9886-c88d332eb4e3] Neutron server returns request_ids: ['req-ad48fbe3-8405-4393-9251-ca5fa20c9653'] \n\nEnvironment\n===========\n\nMitaka", 
            "date_created": "2016-09-19 19:01:51.174764+00:00", 
            "author": "https://api.launchpad.net/1.0/~ludovic-beliveau"
        }, 
        {
            "content": "How long does any individual migration take to occur? (longest time)\n\nAre you getting new tokens before each API call, or are you running with tokens that you keep recycling?", 
            "date_created": "2016-09-19 19:04:02.203900+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "It is a known problem that when talking to services on a user's behalf (such as glance, cinder, neutron) and using a Token, that it could expire when making sub requests on behalf of the user. By default Keystone Token expiration time is 1 hour.\n\nThere is no definitive solution at this point for this problem. A number of ideas have been discussed during summit sessions around non expiring token types (would need keystone changes). However we may want to decide that for some class of known long standing operations that Nova will reject them if the token expiration is too close (much like traveling on a passport that is near expiration). That may be able to mitigate this.", 
            "date_created": "2016-09-19 19:08:58.889114+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "As a side note, I came across this havana commit that fixed a similar issue (but it's not clear at this point if this would fix this particular issue: https://review.openstack.org/#/c/54736", 
            "date_created": "2016-09-19 19:28:54.007866+00:00", 
            "author": "https://api.launchpad.net/1.0/~ludovic-beliveau"
        }, 
        {
            "content": "Sean, to answer your question, even when executing multiple migrations in parallel (actually 4 vms migrating at the same time, over and over), the longest migration I have observed took around 30 secs. to execute.\n\nAlso, looks like this might be related to the fact when using the CLI, a new token is used.  But when using horizon, I see the same token being recycled.\n\n", 
            "date_created": "2016-09-19 19:49:59.902507+00:00", 
            "author": "https://api.launchpad.net/1.0/~ludovic-beliveau"
        }, 
        {
            "content": "This is a long standing issue with Keystone architecture. There is no real fix at this stage. The work around is to increase token timeouts in keystone.", 
            "date_created": "2016-12-09 13:34:54.055873+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}