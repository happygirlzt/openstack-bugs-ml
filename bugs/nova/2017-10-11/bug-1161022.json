{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:24:47.202312+00:00", 
    "description": "During the Grizzly cycle, we made a change such that flavor details are copied for each instance and stored in instance_system_metadata.  There's an associated migration (153) for this, which accounts for *non-deleted* instances only.  Thus, if querying usage data containing pre-Grizzly, deleted instances, simple_tenant_usage will stack track due to not having the necessary flavor metadata:\n\n2013-03-27 03:41:00.883 ERROR nova.api.openstack [req-854b5c2a-da1e-47c1-bca9-e6a927642d49 af1711fbb8c84c73a1f245679699b419 62afa5ddaa2248d19e2518eb40b0fe8a] Caught error: 'instance_type_memory_\nmb'\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack Traceback (most recent call last):\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/__init__.py\", line 81, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return req.get_response(self.application)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     application, catch_exc_info=False)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/keystoneclient/middleware/auth_token.py\", line 451, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return self.app(env, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 890, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     content_type, body, accept)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 942, in _process_stack\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 1022, in dispatch\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return method(req=request, **action_args)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/simple_tenant_usage.py\", line 220, in index\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     detailed=detailed)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/simple_tenant_usage.py\", line 122, in _tenant_usages_for_period\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     flavor = instance_types.extract_instance_type(instance)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/compute/instance_types.py\", line 247, in extract_instance_type\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     instance_type[key] = type_fn(sys_meta[type_key])\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack KeyError: 'instance_type_memory_mb'\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack\n2013-03-27 03:41:00.902 INFO nova.api.openstack [req-854b5c2a-da1e-47c1-bca9-e6a927642d49 af1711fbb8c84c73a1f245679699b419 62afa5ddaa2248d19e2518eb40b0fe8a]\n\nWe've discussed (via #openstack-nova) a possible short term fix for Grizzly RC2, which is to add handling in the code to fall back to the old flavor data retrieval mechanism.  Then, as a longer term Havana solution, adding another migration inclusive of deleted data.\n\nEither way we need a fix for Grizzly, otherwise the Horizon \"overview\" pages will generate exceptions and manifest as errors back to users.", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1161022", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1161022, 
    "index": 1041, 
    "created": "2013-03-27 17:02:23.964013+00:00", 
    "title": "simply_tenant_usage stack traces due to lacking of flavor metadata", 
    "comments": [
        {
            "content": "During the Grizzly cycle, we made a change such that flavor details where copied for each instance and stored in instance_system_metadata.  There's an associated migration (153) for this, which accounts for *non-deleted* instances only.  Thus, if querying usage data containing pre-Grizzly, deleted instances, simple_tenant_usage will stack track due to not having the necessary flavor metadata:\n\n2013-03-27 03:41:00.883 ERROR nova.api.openstack [req-854b5c2a-da1e-47c1-bca9-e6a927642d49 af1711fbb8c84c73a1f245679699b419 62afa5ddaa2248d19e2518eb40b0fe8a] Caught error: 'instance_type_memory_\nmb'\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack Traceback (most recent call last):\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/__init__.py\", line 81, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return req.get_response(self.application)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     application, catch_exc_info=False)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/keystoneclient/middleware/auth_token.py\", line 451, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return self.app(env, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 890, in __call__\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     content_type, body, accept)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 942, in _process_stack\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 1022, in dispatch\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     return method(req=request, **action_args)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/simple_tenant_usage.py\", line 220, in index\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     detailed=detailed)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/simple_tenant_usage.py\", line 122, in _tenant_usages_for_period\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     flavor = instance_types.extract_instance_type(instance)\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/compute/instance_types.py\", line 247, in extract_instance_type\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack     instance_type[key] = type_fn(sys_meta[type_key])\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack KeyError: 'instance_type_memory_mb'\n2013-03-27 03:41:00.883 10756 TRACE nova.api.openstack\n2013-03-27 03:41:00.902 INFO nova.api.openstack [req-854b5c2a-da1e-47c1-bca9-e6a927642d49 af1711fbb8c84c73a1f245679699b419 62afa5ddaa2248d19e2518eb40b0fe8a] \n\nWe've discussed (via #openstack-nova) a possible short term fix for Grizzly RC2, which is to add handling in the code to fall back to the old flavor data retrieval mechanism.  Then, as a longer term Havana solution, adding another migration inclusive of deleted data.\n\nEither way we need a fix for Grizzly, otherwise the Horizon \"overview\" pages will generate exceptions and manifest as errors back to users.", 
            "date_created": "2013-03-27 17:02:23.964013+00:00", 
            "author": "https://api.launchpad.net/1.0/~rkhardalian"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/25550", 
            "date_created": "2013-03-27 18:34:03.527774+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/25550\nCommitted: http://github.com/openstack/nova/commit/30631d0077424001e2fa57674e6e9f2a12f0683e\nSubmitter: Jenkins\nBranch:    master\n\ncommit 30631d0077424001e2fa57674e6e9f2a12f0683e\nAuthor: Dan Smith <email address hidden>\nDate:   Wed Mar 27 11:30:49 2013 -0700\n\n    Make tenant_usage fall back to instance_type_id\n    \n    In order to expose historical usage information about instances that\n    were deleted at the time migration #153 was run, we need to fall back\n    to looking up type information by instance_type_id.\n    \n    This patch does that (only for deleted instances) and replicates the\n    previous behavior of skipping instances that have an instance_type_id\n    that points to a non-existent type.\n    \n    Fixes bug 1161022\n    \n    Change-Id: I39d30c59d1711d8f2a61c7a5e2545b3952e55dbe\n", 
            "date_created": "2013-03-28 12:34:13.513242+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: milestone-proposed\nReview: https://review.openstack.org/25614", 
            "date_created": "2013-03-28 13:29:16.847502+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/25614\nCommitted: http://github.com/openstack/nova/commit/f29ecbaa21fc51ce2c6c60ac395378cb8436e0c2\nSubmitter: Jenkins\nBranch:    milestone-proposed\n\ncommit f29ecbaa21fc51ce2c6c60ac395378cb8436e0c2\nAuthor: Dan Smith <email address hidden>\nDate:   Wed Mar 27 11:30:49 2013 -0700\n\n    Make tenant_usage fall back to instance_type_id\n    \n    In order to expose historical usage information about instances that\n    were deleted at the time migration #153 was run, we need to fall back\n    to looking up type information by instance_type_id.\n    \n    This patch does that (only for deleted instances) and replicates the\n    previous behavior of skipping instances that have an instance_type_id\n    that points to a non-existent type.\n    \n    Fixes bug 1161022\n    \n    (cherry-picked from 30631d0077424001e2fa57674e6e9f2a12f0683e)\n    \n    Change-Id: I39d30c59d1711d8f2a61c7a5e2545b3952e55dbe\n", 
            "date_created": "2013-03-28 14:08:54.701762+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}