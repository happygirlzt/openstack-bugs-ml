{
    "status": "Fix Released", 
    "last_updated": "2017-08-28 09:55:31.697670+00:00", 
    "description": "On my Ocata deployment (with a shared storage between my KVMs hypervisors), the following worflow is failing:\n * stop nova-compute on a KVM hypervisor\n * stop a VM on the KVM hypervisor using virsh destroy\n * evacuate the VM ... which fails with the stacktrace:\n\nERROR nova.compute.manager [req-dcb547e3-5f98-488e-8dbf-ad4453ce82ac 7e6f47b9c6cf4994bb38a2eb3ad6243f 920a4480938349eca2651c140ce33fdd - - -] [instance: a129ab8f-c224-4df2-8134-6716cfe89acf] Setting instance vm_state to ERROR\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf] Traceback (most recent call last):\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 6717, in _error_out_instance_on_exception\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     yield\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2751, in rebuild_instance\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     bdms, recreate, on_shared_storage, preserve_ephemeral)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2795, in _do_rebuild_instance_with_claim\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     self._do_rebuild_instance(*args, **kwargs)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2910, in _do_rebuild_instance\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     self._rebuild_default_impl(**kwargs)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2673, in _rebuild_default_impl\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     block_device_info=new_block_device_info)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2689, in spawn\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     self._ensure_console_log_for_instance(instance)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2961, in _ensure_console_log_for_instance\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     libvirt_utils.file_open(console_file, 'a').close()\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/utils.py\", line 350, in file_open\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     return open(*args, **kwargs)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf] IOError: [Errno 13] Permission denied: '/var/lib/nova/instances/a129ab8f-c224-4df2-8134-6716cfe89acf/console.log'\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]\n\n\nAfter some investigation:\n\n_ensure_console_log_for_instance[1] ensures console.log existence. A change[2] updated this method in order to succeed if the file exists without nova being able to open it by ignoring EPERM erros (errno 1, \"operation not permitted\") but it should ignore EACCES errors (errno 13, \"permission denied\").\n\n\n >>> open('/etc/shadow')\n Traceback (most recent call last):\n   File \"<stdin>\", line 1, in <module>\n IOError: [Errno 13] Permission denied: '/etc/shadow'\n\n\nEACCES errors are raised when you cannot do something because of insufficient permissions, EPERM are raised when you cannot do something (even with root account).\n\n\n[1] nova.virt.libvirt.driver\n[2] https://review.openstack.org/392643", 
    "tags": [
        "rebuild"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1691831", 
    "owner": "https://api.launchpad.net/1.0/~cbrandily", 
    "id": 1691831, 
    "index": 2079, 
    "created": "2017-05-18 19:25:42.537834+00:00", 
    "title": "VM evacuation is broken with shared storage if VM console.log is not owned by nova", 
    "comments": [
        {
            "content": "On my Ocata deployment (with a shared storage between my KVMs hypervisors), the following worflow is failing:\n * stop nova-compute on a KVM hypervisor\n * stop a VM on the KVM hypervisor using virsh destroy\n * evacuate the VM ... which fails with the stacktrace:\n\nERROR nova.compute.manager [req-dcb547e3-5f98-488e-8dbf-ad4453ce82ac 7e6f47b9c6cf4994bb38a2eb3ad6243f 920a4480938349eca2651c140ce33fdd - - -] [instance: a129ab8f-c224-4df2-8134-6716cfe89acf] Setting instance vm_state to ERROR\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf] Traceback (most recent call last):\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 6717, in _error_out_instance_on_exception\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     yield\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2751, in rebuild_instance\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     bdms, recreate, on_shared_storage, preserve_ephemeral)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2795, in _do_rebuild_instance_with_claim\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     self._do_rebuild_instance(*args, **kwargs)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2910, in _do_rebuild_instance\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     self._rebuild_default_impl(**kwargs)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2673, in _rebuild_default_impl\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     block_device_info=new_block_device_info)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2689, in spawn\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     self._ensure_console_log_for_instance(instance)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2961, in _ensure_console_log_for_instance\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     libvirt_utils.file_open(console_file, 'a').close()\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/utils.py\", line 350, in file_open\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]     return open(*args, **kwargs)\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf] IOError: [Errno 13] Permission denied: '/var/lib/nova/instances/a129ab8f-c224-4df2-8134-6716cfe89acf/console.log'\nERROR nova.compute.manager [instance: a129ab8f-c224-4df2-8134-6716cfe89acf]\n\n\nAfter some investigation:\n\n_ensure_console_log_for_instance[1] ensures console.log existence. A change[2] updated this method in order to succeed if the file exists without nova being able to open it by ignoring EPERM erros (errno 1, \"operation not permitted\") but it should ignore EACCES errors (errno 13, \"permission denied\").\n\n\n >>> open('/etc/shadow')\n Traceback (most recent call last):\n   File \"<stdin>\", line 1, in <module>\n IOError: [Errno 13] Permission denied: '/etc/shadow'\n\n\nEACCES errors are raised when you cannot do something because of insufficient permissions, EPERM are raised when you cannot do something (even with root account).\n\n\n[1] nova.virt.libvirt.driver\n[2] https://review.openstack.org/392643", 
            "date_created": "2017-05-18 19:25:42.537834+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbrandily"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/466088", 
            "date_created": "2017-05-18 19:47:58.051937+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/466088\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3072b0afbc157eef5e72f191525296cfa2b014cb\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3072b0afbc157eef5e72f191525296cfa2b014cb\nAuthor: cedric.brandily <email address hidden>\nDate:   Thu May 18 21:26:09 2017 +0200\n\n    Correct _ensure_console_log_for_instance implementation\n    \n    _ensure_console_log_for_instance[1] ensures VM console.log existence.\n    \n    A change[2] updated in order to succeed if the file exists without nova\n    being able to read it (typically happens when libvirt rewrites uid/gid)\n    by ignoring EPERM errors.\n    \n    It seems the method should ignore EACCES errors. Indeed EACCES errors\n    are raised when an action is not permitted because of insufficient\n    permissions where EPERM errors when an action is not permitted at all.\n    \n    [1] nova.virt.libvirt.driver\n    [2] https://review.openstack.org/392643\n    \n    Closes-Bug: #1691831\n    Change-Id: Ifc075a0fd91fc87651fcb306d6439be5369009b6\n", 
            "date_created": "2017-05-29 16:38:09.017317+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/469012", 
            "date_created": "2017-05-30 08:17:01.571267+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/469013", 
            "date_created": "2017-05-30 08:17:37.161754+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/469012\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=81838f1ae910383bf0992684e6b0ef30a6d943ba\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit 81838f1ae910383bf0992684e6b0ef30a6d943ba\nAuthor: cedric.brandily <email address hidden>\nDate:   Thu May 18 21:26:09 2017 +0200\n\n    Correct _ensure_console_log_for_instance implementation\n    \n    _ensure_console_log_for_instance[1] ensures VM console.log existence.\n    \n    A change[2] updated in order to succeed if the file exists without nova\n    being able to read it (typically happens when libvirt rewrites uid/gid)\n    by ignoring EPERM errors.\n    \n    It seems the method should ignore EACCES errors. Indeed EACCES errors\n    are raised when an action is not permitted because of insufficient\n    permissions where EPERM errors when an action is not permitted at all.\n    \n    [1] nova.virt.libvirt.driver\n    [2] https://review.openstack.org/392643\n    \n    Closes-Bug: #1691831\n    Change-Id: Ifc075a0fd91fc87651fcb306d6439be5369009b6\n    (cherry picked from commit 3072b0afbc157eef5e72f191525296cfa2b014cb)\n", 
            "date_created": "2017-05-30 15:45:39.415793+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/469013\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=9d299ae50ea52c63811eba11ee974643c17079ad\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 9d299ae50ea52c63811eba11ee974643c17079ad\nAuthor: cedric.brandily <email address hidden>\nDate:   Thu May 18 21:26:09 2017 +0200\n\n    Correct _ensure_console_log_for_instance implementation\n    \n    _ensure_console_log_for_instance[1] ensures VM console.log existence.\n    \n    A change[2] updated in order to succeed if the file exists without nova\n    being able to read it (typically happens when libvirt rewrites uid/gid)\n    by ignoring EPERM errors.\n    \n    It seems the method should ignore EACCES errors. Indeed EACCES errors\n    are raised when an action is not permitted because of insufficient\n    permissions where EPERM errors when an action is not permitted at all.\n    \n    [1] nova.virt.libvirt.driver\n    [2] https://review.openstack.org/392643\n    \n    Closes-Bug: #1691831\n    Change-Id: Ifc075a0fd91fc87651fcb306d6439be5369009b6\n    (cherry picked from commit 3072b0afbc157eef5e72f191525296cfa2b014cb)\n", 
            "date_created": "2017-06-03 21:20:35.985605+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b2 development milestone.", 
            "date_created": "2017-06-08 21:52:12.164316+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.6 release.", 
            "date_created": "2017-06-19 12:45:56.421753+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.8 release.", 
            "date_created": "2017-08-28 09:55:31.234934+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}