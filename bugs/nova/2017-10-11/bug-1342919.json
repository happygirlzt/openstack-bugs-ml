{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 10:00:39.467440+00:00", 
    "description": "This is weird - Ironic has used the mac from a different node (which quite naturally leads to failures to boot!)\n\nnova list | grep spawn\n| 6c364f0f-d4a0-44eb-ae37-e012bbdd368c | ci-overcloud-NovaCompute3-zmkjp5aa6vgf  | BUILD  | spawning   | NOSTATE     | ctlplane=10.10.16.137 |\n\n nova show 6c364f0f-d4a0-44eb-ae37-e012bbdd368c | grep hyperv\n | OS-EXT-SRV-ATTR:hypervisor_hostname  | b07295ee-1c09-484c-9447-10b9efee340c                     |\n\n neutron port-list | grep 137\n | 272f2413-0309-4e8b-9a6d-9cb6fdbe978d |                    | 78:e7:d1:23:90:0d | {\"subnet_id\": \"a6ddb35e-305e-40f1-9450-7befc8e1af47\", \"ip_address\": \"10.10.16.137\"} |\n\nironic node-show b07295ee-1c09-484c-9447-10b9efee340c | grep wait\n | provision_state        | wait call-back                                                         |\n\nironic port-list | grep 78:e7:d1:23:90:0d  # from neutron\n| 33ab97c0-3de9-458a-afb7-8252a981b37a | 78:e7:d1:23:90:0d |\n\nironic port-show 33ab97c0-3de9-458a-afb7-8252a981\n+------------+-----------------------------------------------------------+\n| Property   | Value                                                     |\n+------------+-----------------------------------------------------------+\n| node_uuid  | 69dc8c40-dd79-4ed6-83a9-374dcb18c39b                      |  # Ruh-roh, wrong node!\n| uuid       | 33ab97c0-3de9-458a-afb7-8252a981b37a                      |\n| extra      | {u'vif_port_id': u'aad5ee6b-52a3-4f8b-8029-7b8f40e7b54e'} |\n| created_at | 2014-07-08T23:09:16+00:00                                 |\n| updated_at | 2014-07-16T01:23:23+00:00                                 |\n| address    | 78:e7:d1:23:90:0d                                         |\n+------------+-----------------------------------------------------------+\n\n\nironic port-list | grep 78:e7:d1:23:9b:1d  # This is the MAC my hardware list says the node should have\n| caba5b36-f518-43f2-84ed-0bc516cc89df | 78:e7:d1:23:9b:1d |\n# ironic port-show caba5b36-f518-43f2-84ed-0bc516cc\n+------------+-----------------------------------------------------------+\n| Property   | Value                                                     |\n+------------+-----------------------------------------------------------+\n| node_uuid  | b07295ee-1c09-484c-9447-10b9efee340c                      |  # and tada right node\n| uuid       | caba5b36-f518-43f2-84ed-0bc516cc89df                      |\n| extra      | {u'vif_port_id': u'272f2413-0309-4e8b-9a6d-9cb6fdbe978d'} |\n| created_at | 2014-07-08T23:08:26+00:00                                 |\n| updated_at | 2014-07-16T19:07:56+00:00                                 |\n| address    | 78:e7:d1:23:9b:1d                                         |\n+------------+-----------------------------------------------------------+", 
    "tags": [
        "ironic"
    ], 
    "importance": "High", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1342919", 
    "owner": "https://api.launchpad.net/1.0/~cbehrens", 
    "id": 1342919, 
    "index": 1539, 
    "created": "2014-07-16 19:34:02.401112+00:00", 
    "title": "instances rescheduled after building network info do not update the MAC", 
    "comments": [
        {
            "content": "This is weird - Ironic has used the mac from a different node (which quite naturally leads to failures to boot!)\n\nnova list | grep spawn\n| 6c364f0f-d4a0-44eb-ae37-e012bbdd368c | ci-overcloud-NovaCompute3-zmkjp5aa6vgf  | BUILD  | spawning   | NOSTATE     | ctlplane=10.10.16.137 |\n\n nova show 6c364f0f-d4a0-44eb-ae37-e012bbdd368c | grep hyperv\n | OS-EXT-SRV-ATTR:hypervisor_hostname  | b07295ee-1c09-484c-9447-10b9efee340c                     |\n\n neutron port-list | grep 137\n | 272f2413-0309-4e8b-9a6d-9cb6fdbe978d |                    | 78:e7:d1:23:90:0d | {\"subnet_id\": \"a6ddb35e-305e-40f1-9450-7befc8e1af47\", \"ip_address\": \"10.10.16.137\"} |\n\nironic node-show b07295ee-1c09-484c-9447-10b9efee340c | grep wait\n | provision_state        | wait call-back                                                         |\n\nironic port-list | grep 78:e7:d1:23:90:0d  # from neutron\n| 33ab97c0-3de9-458a-afb7-8252a981b37a | 78:e7:d1:23:90:0d |\n\nironic port-show 33ab97c0-3de9-458a-afb7-8252a981\n+------------+-----------------------------------------------------------+\n| Property   | Value                                                     |\n+------------+-----------------------------------------------------------+\n| node_uuid  | 69dc8c40-dd79-4ed6-83a9-374dcb18c39b                      |  # Ruh-roh, wrong node!\n| uuid       | 33ab97c0-3de9-458a-afb7-8252a981b37a                      |\n| extra      | {u'vif_port_id': u'aad5ee6b-52a3-4f8b-8029-7b8f40e7b54e'} |\n| created_at | 2014-07-08T23:09:16+00:00                                 |\n| updated_at | 2014-07-16T01:23:23+00:00                                 |\n| address    | 78:e7:d1:23:90:0d                                         |\n+------------+-----------------------------------------------------------+\n\n\nironic port-list | grep 78:e7:d1:23:9b:1d  # This is the MAC my hardware list says the node should have\n| caba5b36-f518-43f2-84ed-0bc516cc89df | 78:e7:d1:23:9b:1d |\n# ironic port-show caba5b36-f518-43f2-84ed-0bc516cc\n+------------+-----------------------------------------------------------+\n| Property   | Value                                                     |\n+------------+-----------------------------------------------------------+\n| node_uuid  | b07295ee-1c09-484c-9447-10b9efee340c                      |  # and tada right node\n| uuid       | caba5b36-f518-43f2-84ed-0bc516cc89df                      |\n| extra      | {u'vif_port_id': u'272f2413-0309-4e8b-9a6d-9cb6fdbe978d'} |\n| created_at | 2014-07-08T23:08:26+00:00                                 |\n| updated_at | 2014-07-16T19:07:56+00:00                                 |\n| address    | 78:e7:d1:23:9b:1d                                         |\n+------------+-----------------------------------------------------------+", 
            "date_created": "2014-07-16 19:34:02.401112+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "ironic node-port-list b07295ee-1c09-484c-9447-10b\n+--------------------------------------+-------------------+\n| uuid                                 | address           |\n+--------------------------------------+-------------------+\n| caba5b36-f518-43f2-84ed-0bc516cc89df | 78:e7:d1:23:9b:1d |\n+--------------------------------------+-------------------+\n", 
            "date_created": "2014-07-16 19:34:59.642144+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "From the nova log - note that this is the wrong port 33ab97c0-3de9-458a-afb7-8252a981 vs caba5b36-f518-43f2-84ed-0bc516cc\n2014-07-16 18:59:25.412 8189 DEBUG ironicclient.common.http [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb ]\nHTTP/1.0 200 OK\ndate: Wed, 16 Jul 2014 18:59:25 GMT\ncontent-length: 301\ncontent-type: application/json; charset=UTF-8\nserver: WSGIServer/0.1 Python/2.7.6\n\n{\"ports\": [{\"uuid\": \"33ab97c0-3de9-458a-afb7-8252a981b37a\", \"links\": [{\"href\": \"http://138.35.77.4:6385/v1/ports/33ab97c0-3de9-458a-afb7-8252a981b37a\", \"rel\": \"self\"}, {\"href\": \"http://138.35.77.4:6385/ports/33ab97c0-3de9-458a-afb7-8252a981b37a\", \"rel\": \"bookmark\"}], \"address\": \"78:e7:d1:23:90:0d\"}]}\n\n", 
            "date_created": "2014-07-16 19:42:25.336874+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "This is the request that got the wrong port:\n\n2014-07-16 18:59:24.419 8189 DEBUG ironicclient.common.http [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb ] curl -i -X GET -H 'X-Auth-Token: _-..._v-MNNg==' -H 'Content-Type: application/json' -H 'Accept: application/json' -H 'User-Agent: python-ironicclient' http://138.35.77.4:6385//v1/nodes/69dc8c40-dd79-4ed6-83a9-374dcb18c39b/ports log_curl_request /opt/stack/venvs/nova/local/lib/python2.7/site-packages/ironicclient/common/http.py:97\n\nNote that the node is wrong: 69dc8c40-dd79-4ed6-83a9-374dcb18c39b is indeed the node with port 33ab97c0-3de9-458a-afb7-8252a981b37a but not the node that is waiting for callback.", 
            "date_created": "2014-07-16 19:50:44.568304+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Request before that was for http://138.35.77.4:6385//v1/nodes/69dc8c40-dd79-4ed6-83a9-374dcb18c39b - so consistent - the API is looking ok at the moent.", 
            "date_created": "2014-07-16 19:52:42.318407+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Interestingly - 2014-07-16 18:59:09.920 8189 DEBUG nova.compute.manager [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Build of instance 6c364f0f-d4a0-44eb-ae37-e012bbdd368c was re-scheduled: Insufficient compute resources: Free memory 0.00 MB < requested 98304 MB. do_build_and_run_instance /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py:1896\n\ncould be coincidence", 
            "date_created": "2014-07-16 19:55:16.201479+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Later on:\n2014-07-16 19:07:49.938 8189 DEBUG ironicclient.common.http [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb ] curl -i -X GET -H 'X-Auth-Token: PKIZ_eJytWFtzqkoTfZ9f8b2ndh0Y1BLQ58' -H 'Content-Type: application/json' -H 'Accept: application/json' -H 'User-Agent: python-ironicclient' http://138.35.77.4:6385//v1/nodes/b07295ee-1c09-484c-9447-10b9efee340c/ports log_curl_request /opt/stack/venvs/nova/local/lib/python2.7/site-packages/ironicclient/common/http.py:97\n\nthats the expected node from when I captured the issue and\n2014-07-16 19:07:51.050 8189 DEBUG ironicclient.common.http [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb ]\nHTTP/1.0 200 OK\ndate: Wed, 16 Jul 2014 19:07:51 GMT\ncontent-length: 301\ncontent-type: application/json; charset=UTF-8\nserver: WSGIServer/0.1 Python/2.7.6\n\n{\"ports\": [{\"uuid\": \"caba5b36-f518-43f2-84ed-0bc516cc89df\", \"links\": [{\"href\": \"http://138.35.77.4:6385/v1/ports/caba5b36-f518-43f2-84ed-0bc516cc89df\", \"rel\": \"self\"}, {\"href\": \"http://138.35.77.4:6385/ports/caba5b36-f518-43f2-84ed-0bc516cc89df\", \"rel\": \"bookmark\"}], \"address\": \"78:e7:d1:23:9b:1d\"}]}\n\nis correctly returned.\n\nSo its looking like the neutron port somehow has the mac address for the prior node", 
            "date_created": "2014-07-16 20:23:51.100767+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "claims timeline:\n\n18:59:09.918 failed\n18:59:17.549 Claim successful\n19:06:58.036 Aborting claim (releasing it)\n19:07:34.752 Claim successful\n19:39:53.854 Aborting claim (releasing it)\n\ngrep -n claims.*req-2a5adbcb-86ec-4ce0-a023-0618306b85e nova-compute.log /dev/null 2>&1| tee /tmp/vpHznXX/1\nnova-compute.log:1796639:2014-07-16 18:59:09.918 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Attempting claim: memory 98304 MB, disk 1600 GB, VCPUs 24\nnova-compute.log:1796640:2014-07-16 18:59:09.918 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Total memory: 98304 MB, used: 98304.00 MB\nnova-compute.log:1796641:2014-07-16 18:59:09.918 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] memory limit: 98304.00 MB, free: 0.00 MB\nnova-compute.log:1796642:2014-07-16 18:59:09.918 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Total disk: 1600 GB, used: 1600.00 GB\nnova-compute.log:1796643:2014-07-16 18:59:09.919 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] disk limit not specified, defaulting to unlimited\nnova-compute.log:1796644:2014-07-16 18:59:09.919 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Total CPUs: 24 VCPUs, used: 24.00 VCPUs\nnova-compute.log:1796645:2014-07-16 18:59:09.919 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] CPUs limit not specified, defaulting to unlimited\n2014-07-16 18:59:09.919 8189 DEBUG nova.openstack.common.lockutils [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] Semaphore / lock released \"instance_claim\" inner /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/openstack/common/lockutils.py:328\n2014-07-16 18:59:09.919 8189 DEBUG nova.compute.manager [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Insufficient compute resources: Free memory 0.00 MB < requested 98304 MB. _build_and_run_instance /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py:1981\n2014-07-16 18:59:09.920 8189 DEBUG nova.compute.utils [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Insufficient compute resources: Free memory 0.00 MB < requested 98304 MB. notify_about_instance_usage /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/utils.py:291\n2014-07-16 18:59:09.920 8189 DEBUG nova.compute.manager [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Build of instance 6c364f0f-d4a0-44eb-ae37-e012bbdd368c was re-scheduled: Insufficient compute resources: Free memory 0.00 MB < requested 98304 MB. do_build_and_run_instance /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py:1896\n********************\n\nnova-compute.log:1798491:2014-07-16 18:59:17.547 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Attempting claim: memory 98304 MB, disk 1600 GB, VCPUs 24\nnova-compute.log:1798492:2014-07-16 18:59:17.547 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Total memory: 98304 MB, used: 0.00 MB\nnova-compute.log:1798493:2014-07-16 18:59:17.547 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] memory limit: 98304.00 MB, free: 98304.00 MB\nnova-compute.log:1798494:2014-07-16 18:59:17.548 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Total disk: 1600 GB, used: 0.00 GB\nnova-compute.log:1798495:2014-07-16 18:59:17.548 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] disk limit not specified, defaulting to unlimited\nnova-compute.log:1798496:2014-07-16 18:59:17.548 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Total CPUs: 24 VCPUs, used: 0.00 VCPUs\nnova-compute.log:1798497:2014-07-16 18:59:17.548 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] CPUs limit not specified, defaulting to unlimited\nnova-compute.log:1798498:2014-07-16 18:59:17.549 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Claim successful\n*******************\n\nnova-compute.log:1853951:2014-07-16 19:06:58.036 8189 DEBUG nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Aborting claim: [Claim: 98304 MB memory, 1600 GB disk, 24 VCPUS] abort /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/claims.py:113\n********\n\nnova-compute.log:1858269:2014-07-16 19:07:34.750 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Attempting claim: memory 98304 MB, disk 1600 GB, VCPUs 24\nnova-compute.log:1858270:2014-07-16 19:07:34.751 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Total memory: 98304 MB, used: 0.00 MB\nnova-compute.log:1858271:2014-07-16 19:07:34.751 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] memory limit: 98304.00 MB, free: 98304.00 MB\nnova-compute.log:1858272:2014-07-16 19:07:34.751 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Total disk: 1600 GB, used: 0.00 GB\nnova-compute.log:1858273:2014-07-16 19:07:34.751 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] disk limit not specified, defaulting to unlimited\nnova-compute.log:1858274:2014-07-16 19:07:34.751 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Total CPUs: 24 VCPUs, used: 0.00 VCPUs\nnova-compute.log:1858275:2014-07-16 19:07:34.752 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] CPUs limit not specified, defaulting to unlimited\nnova-compute.log:1858276:2014-07-16 19:07:34.752 8189 AUDIT nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Claim successful\n*********\n\n\nnova-compute.log:1948374:2014-07-16 19:39:53.854 8189 DEBUG nova.compute.claims [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] [instance: 6c364f0f-d4a0-44eb-ae37-e012bbdd368c] Aborting claim: [Claim: 98304 MB memory, 1600 GB disk, 24 VCPUS] abort /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/claims.py:113\n*******\n", 
            "date_created": "2014-07-16 20:33:32.133753+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "The 7m error:\n19:06:56.721 GET http://138.35.77.4:6385//v1/nodes/?instance_uuid=6c364f0f-d4a0-44eb-ae37-e012bbdd368c\n19:06:58.033 {\"nodes\": []}\n2014-07-16 19:06:58.034 8189 WARNING ironic.nova.virt.ironic.driver [req-2a5adbcb-86ec-4ce0-a023-0618306b85eb None] Destroy called on non-existing instance 6c364f0f-d4a0-44eb-ae37-e012bbdd368c.\n", 
            "date_created": "2014-07-16 21:15:10.391154+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "So we now have a timeline:\nThe instance was raced with the scheduler once\nThen landed and claimed successfully, and built an instance on node 69dc8c40-dd79-4ed6-83a9-374dcb18c39b\nAfter polling for 7m the instance_uuid went awol in Ironic\nThe instance then landed and claimed successfully on node b07295ee-1c09-484c-9447-10b9efee340c with the wrong network UUID.\n\nI think this is enough information to mark this high or perhaps even critical.", 
            "date_created": "2014-07-16 21:23:29.363538+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "So, there are two branches here. One appears to be a race with something that unsets instance_uuid (it wasn't an admin).\nThe other is a bug when *any* failure post-claim&network generation occurs where the rescheduled instance has the wrong MAC.\n\nThis is problematic for two reasons:\n a) it doesn't work\n b) another instance scheduled onto that node will be unable to create its ports in neutron due to the mac being used already, leading to cascade failures.\n\nI think we need to make sure we remove the network allocation on reschedule, which means this may be a Nova bug.", 
            "date_created": "2014-07-16 21:31:33.709688+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Looking at the nova code, it only throws it away if the error is \n        except (exception.InstanceNotFound,\n                exception.UnexpectedDeletingTaskStateError):\n\nand not on the other code paths. That makes this a nova or nova-ironic-driver-interaction bug: adding a nova task.", 
            "date_created": "2014-07-16 21:34:18.894086+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/107511", 
            "date_created": "2014-07-16 21:48:13.682521+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/107511\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=963ad71af4750e28745b6de262da11816b403801\nSubmitter: Jenkins\nBranch:    master\n\ncommit 963ad71af4750e28745b6de262da11816b403801\nAuthor: Robert Collins <email address hidden>\nDate:   Thu Jul 17 09:44:00 2014 +1200\n\n    Deallocate the network if rescheduling for Ironic\n    \n    Ironic (and any other driver that limits the allowed MAC addresses\n    on an instance will fail if the rescheduled instance runs on a node\n    that has a different constraint for MAC addresses. To deal with this\n    we deallocate the network (rather than e.g. trying to lazy update it)\n    because Nova can't know what the implications of leaving the network\n    allocated are *when MAC limits are in place* - and we expect them to\n    be in place when external systems are constrained, so being\n    conservative is a good idea.\n    \n    However the code to trigger this looked at dhcp options (which drivers\n    can safely update pre-boot) not MAC addresses (which can cause conflicts\n    in Neutron if left in-place).\n    \n    Change-Id: I59e748db7a943d5a36d75ef63b2a1ec458c58937\n    Closes-Bug: #1342919\n", 
            "date_created": "2014-07-17 19:36:53.268702+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Is this issue associated with the scheduler race issue currently being experienced?", 
            "date_created": "2014-07-18 19:40:47.032647+00:00", 
            "author": "https://api.launchpad.net/1.0/~john-stafford"
        }, 
        {
            "content": "No this isn't a race its is a simple bug. The race increases how often this\nis encountered.\n", 
            "date_created": "2014-07-18 20:01:47+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Okay, thank you for the clarification.\r\n\r\nCheers!\r\nJohn Stafford\r\nProgram Manager | HP Helion Cloud\r\nE: <email address hidden> | V: 360.212.9720 | M: 206.963.0916\r\n\r\n\r\n\r\n-----Original Message-----\r\nFrom: <email address hidden> [mailto:<email address hidden>] On Behalf Of Robert Collins\r\nSent: Friday, July 18, 2014 1:02 PM\r\nTo: Stafford, John Richard\r\nSubject: Re: [Bug 1342919] Re: instances rescheduled after building network info do not update the MAC\r\n\r\nNo this isn't a race its is a simple bug. The race increases how often this is encountered.\r\n\r\n--\r\nYou received this bug notification because you are subscribed to the bug report.\r\nhttps://bugs.launchpad.net/bugs/1342919\r\n\r\nTitle:\r\n  instances rescheduled after building network info do not update the\r\n  MAC\r\n\r\nStatus in OpenStack Compute (Nova):\r\n  Fix Committed\r\n\r\nBug description:\r\n  This is weird - Ironic has used the mac from a different node (which\r\n  quite naturally leads to failures to boot!)\r\n\r\n  nova list | grep spawn\r\n  | 6c364f0f-d4a0-44eb-ae37-e012bbdd368c | ci-overcloud-NovaCompute3-zmkjp5aa6vgf  | BUILD  | spawning   | NOSTATE     | ctlplane=10.10.16.137 |\r\n\r\n   nova show 6c364f0f-d4a0-44eb-ae37-e012bbdd368c | grep hyperv\r\n   | OS-EXT-SRV-ATTR:hypervisor_hostname  | b07295ee-1c09-484c-9447-10b9efee340c                     |\r\n\r\n   neutron port-list | grep 137\r\n   | 272f2413-0309-4e8b-9a6d-9cb6fdbe978d |                    | 78:e7:d1:23:90:0d | {\"subnet_id\": \"a6ddb35e-305e-40f1-9450-7befc8e1af47\", \"ip_address\": \"10.10.16.137\"} |\r\n\r\n  ironic node-show b07295ee-1c09-484c-9447-10b9efee340c | grep wait\r\n   | provision_state        | wait call-back                                                         |\r\n\r\n  ironic port-list | grep 78:e7:d1:23:90:0d  # from neutron\r\n  | 33ab97c0-3de9-458a-afb7-8252a981b37a | 78:e7:d1:23:90:0d |\r\n\r\n  ironic port-show 33ab97c0-3de9-458a-afb7-8252a981\r\n  +------------+-----------------------------------------------------------+\r\n  | Property   | Value                                                     |\r\n  +------------+-----------------------------------------------------------+\r\n  | node_uuid  | 69dc8c40-dd79-4ed6-83a9-374dcb18c39b                      |  # Ruh-roh, wrong node!\r\n  | uuid       | 33ab97c0-3de9-458a-afb7-8252a981b37a                      |\r\n  | extra      | {u'vif_port_id': u'aad5ee6b-52a3-4f8b-8029-7b8f40e7b54e'} |\r\n  | created_at | 2014-07-08T23:09:16+00:00                                 |\r\n  | updated_at | 2014-07-16T01:23:23+00:00                                 |\r\n  | address    | 78:e7:d1:23:90:0d                                         |\r\n  +------------+-----------------------------------------------------------+\r\n\r\n  \r\n  ironic port-list | grep 78:e7:d1:23:9b:1d  # This is the MAC my hardware list says the node should have\r\n  | caba5b36-f518-43f2-84ed-0bc516cc89df | 78:e7:d1:23:9b:1d |\r\n  # ironic port-show caba5b36-f518-43f2-84ed-0bc516cc\r\n  +------------+-----------------------------------------------------------+\r\n  | Property   | Value                                                     |\r\n  +------------+-----------------------------------------------------------+\r\n  | node_uuid  | b07295ee-1c09-484c-9447-10b9efee340c                      |  # and tada right node\r\n  | uuid       | caba5b36-f518-43f2-84ed-0bc516cc89df                      |\r\n  | extra      | {u'vif_port_id': u'272f2413-0309-4e8b-9a6d-9cb6fdbe978d'} |\r\n  | created_at | 2014-07-08T23:08:26+00:00                                 |\r\n  | updated_at | 2014-07-16T19:07:56+00:00                                 |\r\n  | address    | 78:e7:d1:23:9b:1d                                         |\r\n  +------------+-----------------------------------------------------------+\r\n\r\nTo manage notifications about this bug go to:\r\nhttps://bugs.launchpad.net/nova/+bug/1342919/+subscriptions\r\n", 
            "date_created": "2014-07-18 20:12:33+00:00", 
            "author": "https://api.launchpad.net/1.0/~john-stafford"
        }, 
        {
            "content": "Sadly this fix wasn't quite paranoid enough: \n2014-07-19 23:09:37.469 6962 TRACE nova.compute.manager [instance: a371f81d-28d7-4936-b5b9-38de1b158bd0] Traceback (most recent call last):\n2014-07-19 23:09:37.469 6962 TRACE nova.compute.manager [instance: a371f81d-28d7-4936-b5b9-38de1b158bd0]   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 1917, in do_build_and_run_instance\n2014-07-19 23:09:37.469 6962 TRACE nova.compute.manager [instance: a371f81d-28d7-4936-b5b9-38de1b158bd0]     if self.driver.macs_for_instance(instance):\n2014-07-19 23:09:37.469 6962 TRACE nova.compute.manager [instance: a371f81d-28d7-4936-b5b9-38de1b158bd0]   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/ironic/nova/virt/ironic/driver.py\", line 462, in macs_for_instance\n2014-07-19 23:09:37.469 6962 TRACE nova.compute.manager [instance: a371f81d-28d7-4936-b5b9-38de1b158bd0]     ports = icli.call(\"node.list_ports\", node.uuid)\n2014-07-19 23:09:37.469 6962 TRACE nova.compute.manager [instance: a371f81d-28d7-4936-b5b9-38de1b158bd0]   File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/ironicclient/openstack/common/apiclient/base.py\", line 466, in __getattr__\n2014-07-19 23:09:37.469 6962 TRACE nova.compute.manager [instance: a371f81d-28d7-4936-b5b9-38de1b158bd0]     raise AttributeError(k)\n2014-07-19 23:09:37.469 6962 TRACE nova.compute.manager [instance: a371f81d-28d7-4936-b5b9-38de1b158bd0] AttributeError: uuid\n\nI believe instance['node'] is being set to None in one of the trigger-reschedule codepaths that led to the call to macs_for_instance. The symptom that shows up is instances in state BUILD with no task - like:\nhttp://logs.openstack.org/90/108190/1/check-tripleo/check-tripleo-overcloud-f20/59a563e/console.html\n\n2014-07-21 23:21:25.834 | +--------------------------------------+-------------------------------------+--------+------------+-------------+--------------------+\n2014-07-21 23:21:25.835 | | ID                                   | Name                                | Status | Task State | Power State | Networks           |\n2014-07-21 23:21:25.835 | +--------------------------------------+-------------------------------------+--------+------------+-------------+--------------------+\n2014-07-21 23:21:25.835 | | 5f15aefc-fdd4-4bba-83a0-0e00c484f62d | overcloud-NovaCompute0-zcia4qlu2737 | ACTIVE | -          | Running     | ctlplane=192.0.2.5 |\n2014-07-21 23:21:25.835 | | 31ba87a6-93b7-414c-8ff6-aea50127dc49 | overcloud-NovaCompute1-ojxfdgrekzoq | BUILD  | -          | NOSTATE     |                    |\n2014-07-21 23:21:25.835 | | 1640d0fb-1f31-40ab-8a02-c536b8882a46 | overcloud-controller0-gvwpcte3nqxl  | ACTIVE | -          | Running     | ctlplane=192.0.2.4 |\n2014-07-21 23:21:25.874 | +--------------------------------------+-------------------------------------+--------+------------+-------------+--------------------+", 
            "date_created": "2014-07-22 10:39:20.394805+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/108640", 
            "date_created": "2014-07-22 10:40:55.347864+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I'm proposing a new virt driver method for nova that allows the virt driver to say whether reschedules should deallocate networks. Once the nova side is confirmed, we'll add the method to ironic's virt driver.", 
            "date_created": "2014-08-04 23:01:56.380289+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/108640\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d3854f2c05502c7407d716da7d1bd7f1ca3e0a15\nSubmitter: Jenkins\nBranch:    master\n\ncommit d3854f2c05502c7407d716da7d1bd7f1ca3e0a15\nAuthor: Robert Collins <email address hidden>\nDate:   Fri Jul 18 18:45:30 2014 +1200\n\n    Add method for deallocating networks on reschedule\n    \n    The original call to dhcp_options_for_instance() is not a great way to\n    check whether deallocation of networks should happen on reschedules.\n    \n    This adds a new virt driver method 'deallocate_networks_on_reschedule'\n    which can be used by a virt driver to say whether reschedules should\n    deallocate networks first. This defaults to False and modifies the\n    baremetal virt driver to return True. Ironic virt driver will also need\n    to return True.\n    \n    Closes-Bug: 1342919\n    Change-Id: I54a3252ab15e2d8b596ccc90eb4755405021f1da\n", 
            "date_created": "2014-08-06 14:35:09.384907+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "With the Ironic virt driver now in Nova, I believe this no longer affects Ironic, and should be re-opened for Nova.\n\nGoing to leave it tagged to Ironic, however, so we can track it for the time being.", 
            "date_created": "2014-09-13 01:09:32.427268+00:00", 
            "author": "https://api.launchpad.net/1.0/~devananda"
        }, 
        {
            "content": "Looks like this bug is fixed", 
            "date_created": "2014-09-22 19:29:58.647774+00:00", 
            "author": "https://api.launchpad.net/1.0/~divius"
        }
    ]
}