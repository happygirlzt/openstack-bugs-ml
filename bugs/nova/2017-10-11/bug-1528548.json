{
    "status": "Fix Released", 
    "last_updated": "2016-05-20 03:38:39.523475+00:00", 
    "description": "Steps to reproduce\n\n- Boot vm1 with cinder volume vol1 using block-device option on host1\n- vm1 creation fails and gets rescheduled to another host2. The instance is cleaned up but the volumes are still in 'Available' state\n- instance creation fails on host2 as well and goes to 'Error' state\n- Another instance vm2 uses the same volume vol1 to boot and is created successfully\n- Detach vol1 from vm2\n\nExpected: vol1 should get detached from vm2\n\nActual:  detach volume fails with \n\nERROR nova.compute   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 4691, in _driver_detach_volume\nERROR nova.compute     connection_info = jsonutils.loads(bdm.connection_info)\nERROR nova.compute   File \"/usr/lib/python2.7/dist-packages/oslo_serialization/jsonutils.py\", line 214, in loads\nERROR nova.compute     return json.loads(encodeutils.safe_decode(s, encoding), **kwargs)\nERROR nova.compute   File \"/usr/lib/python2.7/dist-packages/oslo_utils/encodeutils.py\", line 33, in safe_decode\nERROR nova.compute     raise TypeError(\"%s can't be decoded\" % type(text))\nERROR nova.compute\nERROR nova.compute TypeError: <type 'NoneType'> can't be decoded\n\nThe issue is that remove_volume_connection in nova manager.py picks the first bdm entry for the given vol1 (objects.BlockDeviceMapping.get_by_volume_id() and in this case the vm1 which was also booting from same volume has bdm entries for vol1. The remove_volume_connection should pick the right bdm by volume and instance id.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1528548", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1528548, 
    "index": 5931, 
    "created": "2015-12-22 12:00:50.451150+00:00", 
    "title": "Wrong bdm entry picked up during detach if there are failed deploys with a block device", 
    "comments": [
        {
            "content": "Steps to reproduce\n\n- Boot vm1 with cinder volume vol1 using block-device option on host1\n- vm1 creation fails and gets rescheduled to another host2. The instance is cleaned up but the volumes are still in 'Available' state\n- instance creation fails on host2 as well and goes to 'Error' state\n- Another instance vm2 uses the same volume vol1 to boot and is created successfully\n- Detach vol1 from vm2\n\nExpected: vol1 should get detached from vm2\n\nActual:  detach volume fails with \n\nERROR nova.compute   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 4691, in _driver_detach_volume\nERROR nova.compute     connection_info = jsonutils.loads(bdm.connection_info)\nERROR nova.compute   File \"/usr/lib/python2.7/dist-packages/oslo_serialization/jsonutils.py\", line 214, in loads\nERROR nova.compute     return json.loads(encodeutils.safe_decode(s, encoding), **kwargs)\nERROR nova.compute   File \"/usr/lib/python2.7/dist-packages/oslo_utils/encodeutils.py\", line 33, in safe_decode\nERROR nova.compute     raise TypeError(\"%s can't be decoded\" % type(text))\nERROR nova.compute\nERROR nova.compute TypeError: <type 'NoneType'> can't be decoded\n\nThe issue is that remove_volume_connection in nova manager.py picks the first bdm entry for the given vol1 (objects.BlockDeviceMapping.get_by_volume_id() and in this case the vm1 which was also booting from same volume has bdm entries for vol1. The remove_volume_connection should pick the right bdm by volume and instance id.", 
            "date_created": "2015-12-22 12:00:50.451150+00:00", 
            "author": "https://api.launchpad.net/1.0/~shyvenug"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/261952", 
            "date_created": "2015-12-28 10:08:12.127013+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by John Garbutt (<email address hidden>) on branch: master\nReview: https://review.openstack.org/153033\nReason: <ildikov>\tjohnthetubaguy: hi. could you abandon a patch for me please? https://review.openstack.org/#/c/153033/", 
            "date_created": "2016-01-08 14:15:51.223985+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/267464", 
            "date_created": "2016-01-14 10:55:28.307281+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by John Garbutt (<email address hidden>) on branch: master\nReview: https://review.openstack.org/193133\nReason: apparently, this change is now dead.", 
            "date_created": "2016-01-14 11:03:02.552998+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Matt Riedemann (<email address hidden>) on branch: master\nReview: https://review.openstack.org/261952\nReason: We're going with this, see the dependent change under it:\n\nhttps://review.openstack.org/#/c/267464/", 
            "date_created": "2016-01-14 20:28:07.892397+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/267464\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=6cceca70e120820aaa605fc426d60e663b8ecf0e\nSubmitter: Jenkins\nBranch:    master\n\ncommit 6cceca70e120820aaa605fc426d60e663b8ecf0e\nAuthor: Ildiko Vancsa <email address hidden>\nDate:   Thu Jan 14 09:25:44 2016 +0100\n\n    Adapt the code to the new get_by_volume BDM functions\n    \n    Change get_by_volume_id to get_by_volume_and_instance, where we have the\n    instance_uuid available. The only place, where it's not available is the\n    volume_snapshot_create and volume_snapshot_delete, where the new\n    get_by_volume function is called.\n    \n    Closes-Bug: #1528548\n    Change-Id: I121cc557b0d1c1008f8d26a037962622a5360240\n", 
            "date_created": "2016-01-16 11:38:48.330241+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.0.0.0b2 development milestone.", 
            "date_created": "2016-01-21 13:42:42.317166+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "this also fails rebuild operation for liberty nova.", 
            "date_created": "2016-05-20 03:29:38.261489+00:00", 
            "author": "https://api.launchpad.net/1.0/~ljjjustin"
        }, 
        {
            "content": "sorry, not rebuild but evacuate operation. I have a boot from volume instance and it failed to evacuate due to the same error. \n\n2016-05-20 03:05:53.752 90087 ERROR nova.compute.manager [instance: 7ed5fd89-c2fd-4c1c-8c6e-3810220920d8]\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher [req-ec250076-0c75-4758-835c-3f7a7354705d aeccc9f883994fbba19ce6c84866b688 6b70d1fa5dec47febf28b1a1d1b758a4 - - -] Exception during message handling: argument of type 'NoneType' is not iterable\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     executor_callback))\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     executor_callback)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 129, in _do_dispatch\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/server.py\", line 142, in inner\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     return func(*args, **kwargs)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 89, in wrapped\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     payload)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     self.force_reraise()\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 72, in wrapped\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 350, in decorated_function\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     LOG.warning(msg, e, instance=instance)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     self.force_reraise()\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 323, in decorated_function\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 400, in decorated_function\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 378, in decorated_function\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     self.force_reraise()\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 366, in decorated_function\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2709, in rebuild_instance\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     bdms, recreate, on_shared_storage, preserve_ephemeral)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2748, in _do_rebuild_instance_with_claim\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     self._do_rebuild_instance(*args, **kwargs)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2857, in _do_rebuild_instance\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     self._rebuild_default_impl(**kwargs)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2609, in _rebuild_default_impl\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     detach_block_devices(context, bdms)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2834, in detach_block_devices\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     destroy_bdm=False)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4745, in _detach_volume\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     connection_info = self._driver_detach_volume(context, instance, bdm)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4697, in _driver_detach_volume\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     self.volume_api.roll_detaching(context, volume_id)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     self.force_reraise()\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4680, in _driver_detach_volume\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     context, self.volume_api, volume_id, connection_info)\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/volume/encryptors/__init__.py\", line 64, in get_encryption_metadata\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher     if ('data' in connection_info and\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher TypeError: argument of type 'NoneType' is not iterable\n2016-05-20 03:05:54.100 90087 ERROR oslo_messaging.rpc.dispatcher)\n\nI did a bit debug, I found that BlockDeviceMapping.get_by_volume_id don't return connection_info which lead to the failure.", 
            "date_created": "2016-05-20 03:37:35.233648+00:00", 
            "author": "https://api.launchpad.net/1.0/~ljjjustin"
        }, 
        {
            "content": "Maybe we should consider backport this bug to liberty branch.", 
            "date_created": "2016-05-20 03:38:37.175267+00:00", 
            "author": "https://api.launchpad.net/1.0/~ljjjustin"
        }, 
        {
            "content": "Maybe we should consider backport this bug to liberty branch.", 
            "date_created": "2016-05-20 03:38:38.875256+00:00", 
            "author": "https://api.launchpad.net/1.0/~ljjjustin"
        }
    ]
}