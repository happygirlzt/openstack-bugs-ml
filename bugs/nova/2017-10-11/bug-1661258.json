{
    "status": "Fix Released", 
    "last_updated": "2017-03-17 00:03:49.017924+00:00", 
    "description": "Running latest devstack, ironic and nova, I get the following error when I request an instance:\n\n| fault                                | {\"message\": \"Node 6cc8803d-4e77-4948-b653-663d8d5e52b7 could not be found. (HTTP 404)\", \"code\": 500, \"details\": \"  File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 1780, in _do_build_and_run_instance |\n|                                      |     filter_properties)                                                                                                                                                                                        |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2016, in _build_and_run_instance                                                                                                                     |\n|                                      |     instance_uuid=instance.uuid, reason=six.text_type(e))                                                                                                                                                     |\n|                                      | \", \"created\": \"2017-02-02T13:42:01Z\"}                                                                                                                                                                         |\n\nOn ironic side, this node was indeed deleted, it is also deleted from nova.compute_nodes table:\n\n| created_at          | updated_at          | deleted_at          | id | service_id | vcpus | memory_mb | local_gb | vcpus_used | memory_mb_used | local_gb_used | hypervisor_type | hypervisor_version | cpu_info | disk_available_least | free_ram_mb | free_disk_gb | current_workload | running_vms | hypervisor_hostname                  | deleted | host_ip        | supported_instances              | pci_stats                                                                                                                                                                         | metrics | extra_resources | stats                  | numa_topology | host   | ram_allocation_ratio | cpu_allocation_ratio | uuid                                 | disk_allocation_ratio |\n...................................................\n| 2017-02-02 12:20:27 | 2017-02-02 13:20:15 | 2017-02-02 13:21:15 |  2 |       NULL |     1 |      1536 |       10 |          0 |              0 |             0 | ironic          |                  1 |          |                   10 |        1536 |           10 |                0 |           0 | 6cc8803d-4e77-4948-b653-663d8d5e52b7 |       2 | 192.168.122.22 | [[\"x86_64\", \"baremetal\", \"hvm\"]] | {\"nova_object.version\": \"1.1\", \"nova_object.changes\": [\"objects\"], \"nova_object.name\": \"PciDevicePoolList\", \"nova_object.data\": {\"objects\": []}, \"nova_object.namespace\": \"nova\"} | []      | NULL            | {\"cpu_arch\": \"x86_64\"} | NULL          | ubuntu |                    1 |                    0 | 035be695-0797-44b3-930b-42349e40579e |                     0 |\n\nBut in nova_api.inventories it's still there:\n\n| created_at          | updated_at | id | resource_provider_id | resource_class_id | total | reserved | min_unit | max_unit | step_size | allocation_ratio |\n..........................\n| 2017-02-02 13:20:14 | NULL       | 13 |                    2 |                 0 |     1 |        0 |        1 |        1 |         1 |               16 |\n| 2017-02-02 13:20:14 | NULL       | 14 |                    2 |                 1 |  1536 |        0 |        1 |     1536 |         1 |                1 |\n| 2017-02-02 13:20:14 | NULL       | 15 |                    2 |                 2 |    10 |        0 |        1 |       10 |         1 |                1 |\n\nnova_api.resource_providers bit:\n| created_at          | updated_at          | id | uuid                                 | name                                 | generation | can_host |\n.........................\n| 2017-02-02 12:20:27 | 2017-02-02 13:20:14 |  2 | 035be695-0797-44b3-930b-42349e40579e | 6cc8803d-4e77-4948-b653-663d8d5e52b7 |          7 |        0 |\n\nWaiting for resource tracker run did not help, node's been deleted for ~30 minutes already and the inventory is still there.\n\nCode versions:\nDevstack commit debc695ddfc8b7b2aeb53c01c624e15f69ed9fa2 Updated from generate-devstack-plugins-list.\nNova commit 5dad7eaef7f8562425cce6b233aed610ca2d3148 Merge \"doc: update the man page entry for nova-manage db sync\"\nIronic commit 5071b99835143ebcae876432e2982fd27faece10 Merge \"Remove deprecated heartbeat policy check\"\n\nIf it is anyhow relevant, I also run two nova-computes on the same host, I've set host=test for the second one, other than that all configs are the same. I was trying to reproduce another cell-related issue, and was creating/deleting ironic nodes, so that they map to the second nova-compute by the hash_ring.", 
    "tags": [
        "compute", 
        "ironic", 
        "ocata-rc-potential", 
        "placement", 
        "resource-tracker"
    ], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1661258", 
    "owner": "https://api.launchpad.net/1.0/~cdent", 
    "id": 1661258, 
    "index": 2033, 
    "created": "2017-02-02 14:10:07.696433+00:00", 
    "title": "Deleted ironic node has an inventory in nova_api database", 
    "comments": [
        {
            "content": "Running latest devstack, ironic and nova, I get the following error when I request an instance:\n\n| fault                                | {\"message\": \"Node 6cc8803d-4e77-4948-b653-663d8d5e52b7 could not be found. (HTTP 404)\", \"code\": 500, \"details\": \"  File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 1780, in _do_build_and_run_instance |\n|                                      |     filter_properties)                                                                                                                                                                                        |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2016, in _build_and_run_instance                                                                                                                     |\n|                                      |     instance_uuid=instance.uuid, reason=six.text_type(e))                                                                                                                                                     |\n|                                      | \", \"created\": \"2017-02-02T13:42:01Z\"}                                                                                                                                                                         |\n\nOn ironic side, this node was indeed deleted, it is also deleted from nova.compute_nodes table:\n\n| created_at          | updated_at          | deleted_at          | id | service_id | vcpus | memory_mb | local_gb | vcpus_used | memory_mb_used | local_gb_used | hypervisor_type | hypervisor_version | cpu_info | disk_available_least | free_ram_mb | free_disk_gb | current_workload | running_vms | hypervisor_hostname                  | deleted | host_ip        | supported_instances              | pci_stats                                                                                                                                                                         | metrics | extra_resources | stats                  | numa_topology | host   | ram_allocation_ratio | cpu_allocation_ratio | uuid                                 | disk_allocation_ratio |\n...................................................\n| 2017-02-02 12:20:27 | 2017-02-02 13:20:15 | 2017-02-02 13:21:15 |  2 |       NULL |     1 |      1536 |       10 |          0 |              0 |             0 | ironic          |                  1 |          |                   10 |        1536 |           10 |                0 |           0 | 6cc8803d-4e77-4948-b653-663d8d5e52b7 |       2 | 192.168.122.22 | [[\"x86_64\", \"baremetal\", \"hvm\"]] | {\"nova_object.version\": \"1.1\", \"nova_object.changes\": [\"objects\"], \"nova_object.name\": \"PciDevicePoolList\", \"nova_object.data\": {\"objects\": []}, \"nova_object.namespace\": \"nova\"} | []      | NULL            | {\"cpu_arch\": \"x86_64\"} | NULL          | ubuntu |                    1 |                    0 | 035be695-0797-44b3-930b-42349e40579e |                     0 |\n\nBut in nova_api.inventories it's still there:\n\n| created_at          | updated_at | id | resource_provider_id | resource_class_id | total | reserved | min_unit | max_unit | step_size | allocation_ratio |\n..........................\n| 2017-02-02 13:20:14 | NULL       | 13 |                    2 |                 0 |     1 |        0 |        1 |        1 |         1 |               16 |\n| 2017-02-02 13:20:14 | NULL       | 14 |                    2 |                 1 |  1536 |        0 |        1 |     1536 |         1 |                1 |\n| 2017-02-02 13:20:14 | NULL       | 15 |                    2 |                 2 |    10 |        0 |        1 |       10 |         1 |                1 |\n\nnova_api.resource_providers bit:\n| created_at          | updated_at          | id | uuid                                 | name                                 | generation | can_host |\n.........................\n| 2017-02-02 12:20:27 | 2017-02-02 13:20:14 |  2 | 035be695-0797-44b3-930b-42349e40579e | 6cc8803d-4e77-4948-b653-663d8d5e52b7 |          7 |        0 |\n\nWaiting for resource tracker run did not help, node's been deleted for ~30 minutes already and the inventory is still there.\n\nCode versions:\nDevstack commit debc695ddfc8b7b2aeb53c01c624e15f69ed9fa2 Updated from generate-devstack-plugins-list.\nNova commit 5dad7eaef7f8562425cce6b233aed610ca2d3148 Merge \"doc: update the man page entry for nova-manage db sync\"\nIronic commit 5071b99835143ebcae876432e2982fd27faece10 Merge \"Remove deprecated heartbeat policy check\"\n\nIf it is anyhow relevant, I also run two nova-computes on the same host, I've set host=test for the second one, other than that all configs are the same. I was trying to reproduce another cell-related issue, and was creating/deleting ironic nodes, so that they map to the second nova-compute by the hash_ring.", 
            "date_created": "2017-02-02 14:10:07.696433+00:00", 
            "author": "https://api.launchpad.net/1.0/~vdrok"
        }, 
        {
            "content": "@vdrok: Do me a favor and comment out the call to node_is_available() here:\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/resource_tracker.py#L414\n\nand re-run.", 
            "date_created": "2017-02-02 14:22:04.276931+00:00", 
            "author": "https://api.launchpad.net/1.0/~jaypipes"
        }, 
        {
            "content": "The bit from the n-cpu log:\n\n2017-02-02 16:30:34.816 DEBUG nova.compute.manager [req-d0b3d3d8-d1d2-43de-8eec-efaa0d75b7e3 admin admin] [instance: 6e971b2d-31ff-4aa2-b737-c5\nece9d37d23] Start spawning the instance on the hypervisor. from (pid=30650) _build_and_run_instance /opt/stack/nova/nova/compute/manager.py:192\n5\n2017-02-02 16:30:34.816 DEBUG nova.virt.ironic.driver [req-d0b3d3d8-d1d2-43de-8eec-efaa0d75b7e3 admin admin] [instance: 6e971b2d-31ff-4aa2-b737\n-c5ece9d37d23] Spawn called for instance from (pid=30650) spawn /opt/stack/nova/nova/virt/ironic/driver.py:802\n2017-02-02 16:30:34.854 ERROR nova.compute.manager [req-d0b3d3d8-d1d2-43de-8eec-efaa0d75b7e3 admin admin] [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23] Instance failed to spawn\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23] Traceback (most recent call last):\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/opt/stack/nova/nova/compute/manager.py\", line 2125, in _build_resources\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     yield resources\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1930, in _build_and_run_instance\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     block_device_info=block_device_info)\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/opt/stack/nova/nova/virt/ironic/driver.py\", line 812, in spawn\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     node = self._get_node(node_uuid)\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/opt/stack/nova/nova/virt/ironic/driver.py\", line 160, in _get_node\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     fields=_NODE_FIELDS)\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/opt/stack/nova/nova/virt/ironic/client_wrapper.py\", line 148, in call\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     return self._multi_getattr(client, method)(*args, **kwargs)\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/usr/local/lib/python2.7/dist-packages/ironicclient/v1/node.py\", line 195, in get\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     return self._get(resource_id=node_id, fields=fields)\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/usr/local/lib/python2.7/dist-packages/ironicclient/common/base.py\", line 88, in _get\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     return self._list(self._path(resource_id))[0]\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/usr/local/lib/python2.7/dist-packages/ironicclient/common/base.py\", line 174, in _list\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     resp, body = self.api.json_request('GET', url)\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/usr/local/lib/python2.7/dist-packages/ironicclient/common/http.py\", line 552, in json_request\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     resp = self._http_request(url, method, **kwargs)\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/usr/local/lib/python2.7/dist-packages/ironicclient/common/http.py\", line 190, in wrapper\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     return func(self, url, method, **kwargs)\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]   File \"/usr/local/lib/python2.7/dist-packages/ironicclient/common/http.py\", line 534, in _http_request\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]     error_json.get('debuginfo'), method, url)\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23] NotFound: Node 6cc8803d-4e77-4948-b653-663d8d5e52b7 could not be found. (HTTP 404)\n2017-02-02 16:30:34.854 TRACE nova.compute.manager [instance: 6e971b2d-31ff-4aa2-b737-c5ece9d37d23]", 
            "date_created": "2017-02-02 14:33:31.368600+00:00", 
            "author": "https://api.launchpad.net/1.0/~vdrok"
        }, 
        {
            "content": "Seems we should have the compute manager call into the scheduler report client and delete the resource provider when the orphaned compute node is deleted here:\n\nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L6585", 
            "date_created": "2017-02-02 14:38:40.925239+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/428375", 
            "date_created": "2017-02-02 19:20:06.513162+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/428375\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=965fffc09d6fffba7918117e170d5799c69fe99b\nSubmitter: Jenkins\nBranch:    master\n\ncommit 965fffc09d6fffba7918117e170d5799c69fe99b\nAuthor: EdLeafe <email address hidden>\nDate:   Thu Feb 2 18:48:35 2017 +0000\n\n    Delete a compute node's resource provider when node is deleted\n    \n    Currently when a compute node is deleted, its record in the cell DB is\n    deleted, but its representation as a resource provider in the placement\n    service remains, along with any inventory and allocations. This could\n    cause the placement engine to return that provider record, even though\n    the compute node no longer exists. And since the periodic \"healing\" by\n    the resource tracker only updates compute node resources for records in\n    the compute_nodes table, these old records are never removed.\n    \n    This patch adds a call to delete the resource provider when the compute\n    node is deleted. It also adds a method to the scheduler report client\n    to make these calls to the placement API.\n    \n    Partial-Bug: #1661258\n    Closes-Bug: #1661014\n    \n    Change-Id: I6098d186d05ff8b9a568e23f860295a7bc2e6447\n", 
            "date_created": "2017-02-03 18:09:05.351895+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/429274", 
            "date_created": "2017-02-04 14:14:38.653676+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/429274\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=916ed4bfe42f8a3b2315e8cf4e07dec35d212657\nSubmitter: Jenkins\nBranch:    master\n\ncommit 916ed4bfe42f8a3b2315e8cf4e07dec35d212657\nAuthor: Matt Riedemann <email address hidden>\nDate:   Sat Feb 4 09:07:35 2017 -0500\n\n    Cleanup the caches when deleting a resource provider\n    \n    When we delete a resource provider in the scheduler\n    report we should also cleanup any entries we have in\n    the resource provider and aggregate map caches.\n    \n    Change-Id: I7f15720d3aaff5d5a504d04729b8003f51e2c37d\n    Related-Bug: #1661258\n", 
            "date_created": "2017-03-17 00:03:48.008138+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}