{
    "status": "Fix Released", 
    "last_updated": "2016-02-02 16:52:41.331185+00:00", 
    "description": "If a instance is booted from volume with an image to volume bdm where the volume size is not specified nova throws http 500 instead of http 400.\n\nVisible on master (b558d616c3b123dbe2a0914162b45765192f3a12) with devstack.\n\nTo reproduce:\n\n$ nova image-list\n+--------------------------------------+---------------------------------+--------+--------+\n| ID                                   | Name                            | Status | Server |\n+--------------------------------------+---------------------------------+--------+--------+\n| a7e6b974-0b5a-4d60-8d68-d4745aae9bb3 | cirros-0.3.4-x86_64-uec         | ACTIVE |        |\n| 10672d57-30b3-4c41-9f5b-f42c030970fa | cirros-0.3.4-x86_64-uec-kernel  | ACTIVE |        |\n| 70790401-6760-48d5-9bf4-175d18cfc9d6 | cirros-0.3.4-x86_64-uec-ramdisk | ACTIVE |        |\n+--------------------------------------+---------------------------------+--------+--------+\n\n$ nova boot --flavor 42 --block-device source=image,id=a7e6b974-0b5a-4d60-8d68-d4745aae9bb3,dest=volume,shutdown=preserve,bootindex=0 --poll vm1\nERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.InvalidBDM'> (HTTP 500) (Request-ID: req-996d695a-3f36-48ee-b91f-567c3ab2f1ce)\n\n\nThere is a stack trace in the nova-api log:\n2016-01-20 18:51:58.400 ERROR nova.api.openstack.extensions [req-996d695a-3f36-48ee-b91f-567c3ab2f1ce admin admin] Unexpected exception in API method\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions Traceback (most recent call last):\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/validation/__init__.py\", line 73, in wrapper\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     return func(*args, **kwargs)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/validation/__init__.py\", line 73, in wrapper\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     return func(*args, **kwargs)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/servers.py\", line 604, in create\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     **create_kwargs)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/hooks.py\", line 149, in inner\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     rv = f(*args, **kwargs)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 1504, in create\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     check_server_group_quota=check_server_group_quota)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 1127, in _create_instance\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     instance_group, check_server_group_quota)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 976, in _provision_instances\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     quotas.rollback()\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 204, in __exit__\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     six.reraise(self.type_, self.value, self.tb)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 939, in _provision_instances\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     num_instances, i, shutdown_terminate)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 1422, in create_db_entry_for_new_instance\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     instance.destroy()\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 204, in __exit__\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     six.reraise(self.type_, self.value, self.tb)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 1418, in create_db_entry_for_new_instance\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     context, instance, instance_type, block_device_mapping)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 1254, in _validate_bdm\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     raise exception.InvalidBDM(message=_(\"Images with \"\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions InvalidBDM: Images with destination_type 'volume' need to have a non-zero size specified", 
    "tags": [
        "api", 
        "low-hanging-fruit"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1538197", 
    "owner": "https://api.launchpad.net/1.0/~balazs-gibizer", 
    "id": 1538197, 
    "index": 4437, 
    "created": "2016-01-26 16:17:28.324618+00:00", 
    "title": "booting from volume throws http 500 if volume size is not specified", 
    "comments": [
        {
            "content": "If a instance is booted from volume with an image to volume bdm where the volume size is not specified nova throws http 500 instead of http 400.\n\nVisible on master (b558d616c3b123dbe2a0914162b45765192f3a12) with devstack.\n\nTo reproduce:\n\n$ nova image-list\n+--------------------------------------+---------------------------------+--------+--------+\n| ID                                   | Name                            | Status | Server |\n+--------------------------------------+---------------------------------+--------+--------+\n| a7e6b974-0b5a-4d60-8d68-d4745aae9bb3 | cirros-0.3.4-x86_64-uec         | ACTIVE |        |\n| 10672d57-30b3-4c41-9f5b-f42c030970fa | cirros-0.3.4-x86_64-uec-kernel  | ACTIVE |        |\n| 70790401-6760-48d5-9bf4-175d18cfc9d6 | cirros-0.3.4-x86_64-uec-ramdisk | ACTIVE |        |\n+--------------------------------------+---------------------------------+--------+--------+\n\n$ nova boot --flavor 42 --block-device source=image,id=a7e6b974-0b5a-4d60-8d68-d4745aae9bb3,dest=volume,shutdown=preserve,bootindex=0 --poll vm1\nERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.InvalidBDM'> (HTTP 500) (Request-ID: req-996d695a-3f36-48ee-b91f-567c3ab2f1ce)\n\n\nThere is a stack trace in the nova-api log:\n2016-01-20 18:51:58.400 ERROR nova.api.openstack.extensions [req-996d695a-3f36-48ee-b91f-567c3ab2f1ce admin admin] Unexpected exception in API method\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions Traceback (most recent call last):\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/validation/__init__.py\", line 73, in wrapper\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     return func(*args, **kwargs)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/validation/__init__.py\", line 73, in wrapper\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     return func(*args, **kwargs)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/servers.py\", line 604, in create\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     **create_kwargs)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/hooks.py\", line 149, in inner\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     rv = f(*args, **kwargs)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 1504, in create\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     check_server_group_quota=check_server_group_quota)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 1127, in _create_instance\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     instance_group, check_server_group_quota)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 976, in _provision_instances\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     quotas.rollback()\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 204, in __exit__\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     six.reraise(self.type_, self.value, self.tb)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 939, in _provision_instances\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     num_instances, i, shutdown_terminate)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 1422, in create_db_entry_for_new_instance\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     instance.destroy()\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 204, in __exit__\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     six.reraise(self.type_, self.value, self.tb)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 1418, in create_db_entry_for_new_instance\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     context, instance, instance_type, block_device_mapping)\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 1254, in _validate_bdm\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions     raise exception.InvalidBDM(message=_(\"Images with \"\n2016-01-20 18:51:58.400 TRACE nova.api.openstack.extensions InvalidBDM: Images with destination_type 'volume' need to have a non-zero size specified", 
            "date_created": "2016-01-26 16:17:28.324618+00:00", 
            "author": "https://api.launchpad.net/1.0/~balazs-gibizer"
        }, 
        {
            "content": "Bug skimming \n------------------\nyeah, I guess the exception type \"InvalidBDM\" is missing in [1].\n\n{1] https://git.openstack.org/cgit/openstack/nova/tree/nova/api/openstack/compute/servers.py?id=b558d616c3b123dbe2a0914162b45765192f3a12#n649", 
            "date_created": "2016-01-26 16:59:03.714847+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "@Balazs Gibizer:\nThanks for taking over the bug. Please provide a fix in the next weeks.", 
            "date_created": "2016-01-26 17:05:39.214210+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/272732", 
            "date_created": "2016-01-26 20:52:21.003144+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/272732\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=5cad74c27befb8f1bd584753de21d8ca60eaf901\nSubmitter: Jenkins\nBranch:    master\n\ncommit 5cad74c27befb8f1bd584753de21d8ca60eaf901\nAuthor: Balazs Gibizer <email address hidden>\nDate:   Tue Jan 26 21:48:11 2016 +0100\n\n    Return HTTP 400 if volume size is not defined\n    \n    Nova API properly checks that in case of booting from a image to\n    volume bdm the client shall specify the size of the created volume.\n    However the API does not handle the exception properly and returns\n    HTTP 500. This patch handles the InvalidBDM exception and returns\n    HTTP 400.\n    \n    Change-Id: I80d0aa64885f25081dad91b1f45da5b318d8ae25\n    Closes-bug: #1538197\n", 
            "date_created": "2016-02-02 16:52:40.177575+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}