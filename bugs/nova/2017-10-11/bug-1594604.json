{
    "status": "In Progress", 
    "last_updated": "2017-06-28 12:03:57.726609+00:00", 
    "description": "Environment:\nStable/Liberty with neutron ML2 (Mechanism Driver is a custom asynchronous driver based off the Opendaylight V2 driver)\nNo agents or OVS bridges in use.\nOne controller/network node and two compute nodes.\n\nWhen a VM fails to start on any compute node, nova removes the host binding from the VM but doesn't send a port update to neutron notifying it about the hostbinding change.\n\nWhen the same error state VM is deleted, nova doesn't send any events to neutron. As a result the driver thinks the port is still active, owned by an existing VM and bound to the host properly.\n\nNOTE: This behavior is only seen with VM's in the ERROR state, ports for VMs in ACTIVE state are deleted properly.\n\n$ nova show vm1\n+--------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Property                             | Value                                                                                                                                                                                     |\n+--------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| OS-DCF:diskConfig                    | AUTO                                                                                                                                                                                      |\n| OS-EXT-AZ:availability_zone          | nova                                                                                                                                                                                      |\n| OS-EXT-SRV-ATTR:host                 | -                                                                                                                                                                                         |\n| OS-EXT-SRV-ATTR:hostname             | vm1                                                                                                                                                                                       |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                                                                                                                                                         |\n| OS-EXT-SRV-ATTR:instance_name        | instance-0000077a                                                                                                                                                                         |\n| OS-EXT-SRV-ATTR:kernel_id            | 72d053dc-aae8-4559-a7c4-107c980bd674                                                                                                                                                      |\n| OS-EXT-SRV-ATTR:launch_index         | 0                                                                                                                                                                                         |\n| OS-EXT-SRV-ATTR:ramdisk_id           | 3d25fd54-ffbc-4370-b971-2196a7963c24                                                                                                                                                      |\n| OS-EXT-SRV-ATTR:reservation_id       | r-pujfofv9                                                                                                                                                                                |\n| OS-EXT-SRV-ATTR:root_device_name     | /dev/vda                                                                                                                                                                                  |\n| OS-EXT-SRV-ATTR:user_data            | -                                                                                                                                                                                         |\n| OS-EXT-STS:power_state               | 0                                                                                                                                                                                         |\n| OS-EXT-STS:task_state                | -                                                                                                                                                                                         |\n| OS-EXT-STS:vm_state                  | error                                                                                                                                                                                     |\n| OS-SRV-USG:launched_at               | -                                                                                                                                                                                         |\n| OS-SRV-USG:terminated_at             | -                                                                                                                                                                                         |\n| accessIPv4                           |                                                                                                                                                                                           |\n| accessIPv6                           |                                                                                                                                                                                           |\n| config_drive                         |                                                                                                                                                                                           |\n| created                              | 2016-06-20T22:51:13Z                                                                                                                                                                      |\n| fault                                | {\"message\": \"No valid host was found. There are not enough hosts available.\", \"code\": 500, \"details\": \"  File \\\"/opt/stack/nova/nova/conductor/manager.py\\\", line 739, in build_instances                                                                                                                                                                                                                                                                               |\n| flavor                               | m1.small (2)                                                                                                                                                                              |\n| hostId                               |                                                                                                                                                                                           |\n| id                                   | 5d37f0b1-d3ac-4246-badc-b1a2aa6c3137                                                                                                                                                      |\n| image                                | cirros-0.3.4-x86_64-uec (50976ce1-c00e-4a80-9d72-6bf5d1abe54a)                                                                                                                            |\n| key_name                             | -                                                                                                                                                                                         |\n| metadata                             | {}                                                                                                                                                                                        |\n| name                                 | vm1                                                                                                                                                                                       |\n| net1 network                         | 30.0.0.231                                                                                                                                                                                |\n| os-extended-volumes:volumes_attached | []                                                                                                                                                                                        |\n| security_groups                      | default                                                                                                                                                                                   |\n| status                               | ERROR                                                                                                                                                                                     |\n| tenant_id                            | 4c3ddd212d4f4af9b4d0d55e89b43125                                                                                                                                                          |\n| updated                              | 2016-06-20T22:51:23Z                                                                                                                                                                      |\n| user_id                              | 1e3e7e3addc14861afe177f285e43b40                                                                                                                                                          |\n+--------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\n$ neutron port-show 5efcfa1b-1300-4194-8229-11863f85d0a9\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+\n| Field                 | Value                                                                                                                         |\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                                                                          |\n| allowed_address_pairs |                                                                                                                               |\n| binding:host_id       | bxb-ds-50                                                                                                                     |\n| binding:profile       | {}                                                                                                                            |\n| binding:vif_details   | {\"port_filter\": false, \"vhostuser_ovs_plug\": false, \"vhostuser_socket\": \"/tmp/sock-fa163eaba0d2\", \"vhostuser_mode\": \"server\"} |\n| binding:vif_type      | vhostuser                                                                                                                     |\n| binding:vnic_type     | normal                                                                                                                        |\n| device_id             | 5d37f0b1-d3ac-4246-badc-b1a2aa6c3137                                                                                          |\n| device_owner          | compute:nova                                                                                                                  |\n| dns_assignment        | {\"hostname\": \"host-30-0-0-231\", \"ip_address\": \"30.0.0.231\", \"fqdn\": \"host-30-0-0-231.openstacklocal.\"}                        |\n| dns_name              |                                                                                                                               |\n| extra_dhcp_opts       |                                                                                                                               |\n| fixed_ips             | {\"subnet_id\": \"880aac1b-662e-4a4f-b640-7929d69a2b3d\", \"ip_address\": \"30.0.0.231\"}                                             |\n| id                    | 5efcfa1b-1300-4194-8229-11863f85d0a9                                                                                          |\n| mac_address           | fa:16:3e:ab:a0:d2                                                                                                             |\n| name                  |                                                                                                                               |\n| network_id            | cf31ce68-4c5b-4e22-b725-dff0b6511a3d                                                                                          |\n| port_security_enabled | True                                                                                                                          |\n| security_groups       | ae59a53e-38f2-471d-9de9-b8aea815dc27                                                                                          |\n| status                | ACTIVE                                                                                                                        |\n| tenant_id             | 4c3ddd212d4f4af9b4d0d55e89b43125                                                                                              |\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+\n\n$ nova delete vm1\nRequest to delete server vm1 has been accepted.\n\n$ nova show vm1\nERROR (CommandError): No server with a name or ID of 'vm1' exists.\n\n$ neutron port-show 5efcfa1b-1300-4194-8229-11863f85d0a9\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+\n| Field                 | Value                                                                                                                         |\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                                                                          |\n| allowed_address_pairs |                                                                                                                               |\n| binding:host_id       | bxb-ds-50                                                                                                                     |\n| binding:profile       | {}                                                                                                                            |\n| binding:vif_details   | {\"port_filter\": false, \"vhostuser_ovs_plug\": false, \"vhostuser_socket\": \"/tmp/sock-fa163eaba0d2\", \"vhostuser_mode\": \"server\"} |\n| binding:vif_type      | vhostuser                                                                                                                     |\n| binding:vnic_type     | normal                                                                                                                        |\n| device_id             | 5d37f0b1-d3ac-4246-badc-b1a2aa6c3137                                                                                          |\n| device_owner          | compute:nova                                                                                                                  |\n| dns_assignment        | {\"hostname\": \"host-30-0-0-231\", \"ip_address\": \"30.0.0.231\", \"fqdn\": \"host-30-0-0-231.openstacklocal.\"}                        |\n| dns_name              |                                                                                                                               |\n| extra_dhcp_opts       |                                                                                                                               |\n| fixed_ips             | {\"subnet_id\": \"880aac1b-662e-4a4f-b640-7929d69a2b3d\", \"ip_address\": \"30.0.0.231\"}                                             |\n| id                    | 5efcfa1b-1300-4194-8229-11863f85d0a9                                                                                          |\n| mac_address           | fa:16:3e:ab:a0:d2                                                                                                             |\n| name                  |                                                                                                                               |\n| network_id            | cf31ce68-4c5b-4e22-b725-dff0b6511a3d                                                                                          |\n| port_security_enabled | True                                                                                                                          |\n| security_groups       | ae59a53e-38f2-471d-9de9-b8aea815dc27                                                                                          |\n| status                | ACTIVE                                                                                                                        |\n| tenant_id             | 4c3ddd212d4f4af9b4d0d55e89b43125                                                                                              |\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+", 
    "tags": [
        "openstack-version.liberty"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1594604", 
    "owner": "https://api.launchpad.net/1.0/~melwitt", 
    "id": 1594604, 
    "index": 6291, 
    "created": "2016-06-20 23:01:40.476746+00:00", 
    "title": "Nova does not delete or update neutron port for failed VMs", 
    "comments": [
        {
            "content": "Environment:\nStable/Liberty with neutron ML2 (Mechanism Driver is a custom asynchronous driver based off the Opendaylight V2 driver)\nNo agents or OVS bridges in use.\nOne controller and network node and two compute nodes.\n\nWhen a VM fails to start on any compute node, nova removes the host binding from the VM but doesn't send a port update to neutron notifying it about the hostbinding change.\n\nWhen the same error state VM is deleted, nova doesn't send any events to neutron. As a result the driver thinks the port is still active, owned by an existing VM and bound to the host properly.\n\nNOTE: This behavior is only seen with VM's in the ERROR state, ports for VMs in ACTIVE state are deleted properly.\n\n$ nova show vm1\n+--------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Property                             | Value                                                                                                                                                                                     |\n+--------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| OS-DCF:diskConfig                    | AUTO                                                                                                                                                                                      |\n| OS-EXT-AZ:availability_zone          | nova                                                                                                                                                                                      |\n| OS-EXT-SRV-ATTR:host                 | -                                                                                                                                                                                         |\n| OS-EXT-SRV-ATTR:hostname             | vm1                                                                                                                                                                                       |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                                                                                                                                                         |\n| OS-EXT-SRV-ATTR:instance_name        | instance-0000077a                                                                                                                                                                         |\n| OS-EXT-SRV-ATTR:kernel_id            | 72d053dc-aae8-4559-a7c4-107c980bd674                                                                                                                                                      |\n| OS-EXT-SRV-ATTR:launch_index         | 0                                                                                                                                                                                         |\n| OS-EXT-SRV-ATTR:ramdisk_id           | 3d25fd54-ffbc-4370-b971-2196a7963c24                                                                                                                                                      |\n| OS-EXT-SRV-ATTR:reservation_id       | r-pujfofv9                                                                                                                                                                                |\n| OS-EXT-SRV-ATTR:root_device_name     | /dev/vda                                                                                                                                                                                  |\n| OS-EXT-SRV-ATTR:user_data            | -                                                                                                                                                                                         |\n| OS-EXT-STS:power_state               | 0                                                                                                                                                                                         |\n| OS-EXT-STS:task_state                | -                                                                                                                                                                                         |\n| OS-EXT-STS:vm_state                  | error                                                                                                                                                                                     |\n| OS-SRV-USG:launched_at               | -                                                                                                                                                                                         |\n| OS-SRV-USG:terminated_at             | -                                                                                                                                                                                         |\n| accessIPv4                           |                                                                                                                                                                                           |\n| accessIPv6                           |                                                                                                                                                                                           |\n| config_drive                         |                                                                                                                                                                                           |\n| created                              | 2016-06-20T22:51:13Z                                                                                                                                                                      |\n| fault                                | {\"message\": \"No valid host was found. There are not enough hosts available.\", \"code\": 500, \"details\": \"  File \\\"/opt/stack/nova/nova/conductor/manager.py\\\", line 739, in build_instances                                                                                                                                                                                                                                                                               |\n| flavor                               | m1.small (2)                                                                                                                                                                              |\n| hostId                               |                                                                                                                                                                                           |\n| id                                   | 5d37f0b1-d3ac-4246-badc-b1a2aa6c3137                                                                                                                                                      |\n| image                                | cirros-0.3.4-x86_64-uec (50976ce1-c00e-4a80-9d72-6bf5d1abe54a)                                                                                                                            |\n| key_name                             | -                                                                                                                                                                                         |\n| metadata                             | {}                                                                                                                                                                                        |\n| name                                 | vm1                                                                                                                                                                                       |\n| net1 network                         | 30.0.0.231                                                                                                                                                                                |\n| os-extended-volumes:volumes_attached | []                                                                                                                                                                                        |\n| security_groups                      | default                                                                                                                                                                                   |\n| status                               | ERROR                                                                                                                                                                                     |\n| tenant_id                            | 4c3ddd212d4f4af9b4d0d55e89b43125                                                                                                                                                          |\n| updated                              | 2016-06-20T22:51:23Z                                                                                                                                                                      |\n| user_id                              | 1e3e7e3addc14861afe177f285e43b40                                                                                                                                                          |\n+--------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\n$ neutron port-show 5efcfa1b-1300-4194-8229-11863f85d0a9\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+\n| Field                 | Value                                                                                                                         |\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                                                                          |\n| allowed_address_pairs |                                                                                                                               |\n| binding:host_id       | bxb-ds-50                                                                                                                     |\n| binding:profile       | {}                                                                                                                            |\n| binding:vif_details   | {\"port_filter\": false, \"vhostuser_ovs_plug\": false, \"vhostuser_socket\": \"/tmp/sock-fa163eaba0d2\", \"vhostuser_mode\": \"server\"} |\n| binding:vif_type      | vhostuser                                                                                                                     |\n| binding:vnic_type     | normal                                                                                                                        |\n| device_id             | 5d37f0b1-d3ac-4246-badc-b1a2aa6c3137                                                                                          |\n| device_owner          | compute:nova                                                                                                                  |\n| dns_assignment        | {\"hostname\": \"host-30-0-0-231\", \"ip_address\": \"30.0.0.231\", \"fqdn\": \"host-30-0-0-231.openstacklocal.\"}                        |\n| dns_name              |                                                                                                                               |\n| extra_dhcp_opts       |                                                                                                                               |\n| fixed_ips             | {\"subnet_id\": \"880aac1b-662e-4a4f-b640-7929d69a2b3d\", \"ip_address\": \"30.0.0.231\"}                                             |\n| id                    | 5efcfa1b-1300-4194-8229-11863f85d0a9                                                                                          |\n| mac_address           | fa:16:3e:ab:a0:d2                                                                                                             |\n| name                  |                                                                                                                               |\n| network_id            | cf31ce68-4c5b-4e22-b725-dff0b6511a3d                                                                                          |\n| port_security_enabled | True                                                                                                                          |\n| security_groups       | ae59a53e-38f2-471d-9de9-b8aea815dc27                                                                                          |\n| status                | ACTIVE                                                                                                                        |\n| tenant_id             | 4c3ddd212d4f4af9b4d0d55e89b43125                                                                                              |\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+\n\n$ nova delete vm1\nRequest to delete server vm1 has been accepted.\n\n$ nova show vm1\nERROR (CommandError): No server with a name or ID of 'vm1' exists.\n\n$ neutron port-show 5efcfa1b-1300-4194-8229-11863f85d0a9\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+\n| Field                 | Value                                                                                                                         |\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                                                                          |\n| allowed_address_pairs |                                                                                                                               |\n| binding:host_id       | bxb-ds-50                                                                                                                     |\n| binding:profile       | {}                                                                                                                            |\n| binding:vif_details   | {\"port_filter\": false, \"vhostuser_ovs_plug\": false, \"vhostuser_socket\": \"/tmp/sock-fa163eaba0d2\", \"vhostuser_mode\": \"server\"} |\n| binding:vif_type      | vhostuser                                                                                                                     |\n| binding:vnic_type     | normal                                                                                                                        |\n| device_id             | 5d37f0b1-d3ac-4246-badc-b1a2aa6c3137                                                                                          |\n| device_owner          | compute:nova                                                                                                                  |\n| dns_assignment        | {\"hostname\": \"host-30-0-0-231\", \"ip_address\": \"30.0.0.231\", \"fqdn\": \"host-30-0-0-231.openstacklocal.\"}                        |\n| dns_name              |                                                                                                                               |\n| extra_dhcp_opts       |                                                                                                                               |\n| fixed_ips             | {\"subnet_id\": \"880aac1b-662e-4a4f-b640-7929d69a2b3d\", \"ip_address\": \"30.0.0.231\"}                                             |\n| id                    | 5efcfa1b-1300-4194-8229-11863f85d0a9                                                                                          |\n| mac_address           | fa:16:3e:ab:a0:d2                                                                                                             |\n| name                  |                                                                                                                               |\n| network_id            | cf31ce68-4c5b-4e22-b725-dff0b6511a3d                                                                                          |\n| port_security_enabled | True                                                                                                                          |\n| security_groups       | ae59a53e-38f2-471d-9de9-b8aea815dc27                                                                                          |\n| status                | ACTIVE                                                                                                                        |\n| tenant_id             | 4c3ddd212d4f4af9b4d0d55e89b43125                                                                                              |\n+-----------------------+-------------------------------------------------------------------------------------------------------------------------------+", 
            "date_created": "2016-06-20 23:01:40.476746+00:00", 
            "author": "https://api.launchpad.net/1.0/~asomya"
        }, 
        {
            "content": "On further investigation, it seems that the network_info cache in the db is wiped out on VM error:\nselect * from instances where id=1964\\G;\n*************************** 1. row ***************************\n              created_at: 2016-06-21 14:44:17\n              updated_at: 2016-06-21 14:44:19\n              deleted_at: NULL\n                      id: 1964\n             internal_id: NULL\n                 user_id: 1e3e7e3addc14861afe177f285e43b40\n              project_id: 4c3ddd212d4f4af9b4d0d55e89b43125\n               image_ref: 50976ce1-c00e-4a80-9d72-6bf5d1abe54a\n               kernel_id: 72d053dc-aae8-4559-a7c4-107c980bd674\n              ramdisk_id: 3d25fd54-ffbc-4370-b971-2196a7963c24\n            launch_index: 9\n                key_name: NULL\n                key_data: NULL\n             power_state: 0\n                vm_state: error\n               memory_mb: 2048\n                   vcpus: 1\n                hostname: vm1-10\n                    host: NULL\n               user_data: NULL\n          reservation_id: r-xr60h8pj\n            scheduled_at: NULL\n             launched_at: NULL\n           terminated_at: NULL\n            display_name: vm1-10\n     display_description: vm1\n       availability_zone: nova\n                  locked: 0\n                 os_type: NULL\n             launched_on: NULL\n        instance_type_id: 5\n                 vm_mode: NULL\n                    uuid: 9e191fd1-7a5d-430f-973b-625190f525b9\n            architecture: NULL\n        root_device_name: NULL\n            access_ip_v4: NULL\n            access_ip_v6: NULL\n            config_drive: \n              task_state: NULL\ndefault_ephemeral_device: NULL\n     default_swap_device: NULL\n                progress: 0\n        auto_disk_config: 1\n      shutdown_terminate: 0\n       disable_terminate: 0\n                 root_gb: 20\n            ephemeral_gb: 0\n               cell_name: NULL\n                    node: NULL\n                 deleted: 0\n               locked_by: NULL\n                 cleaned: 0\n      ephemeral_key_uuid: NULL\n1 row in set (0.00 sec)\n\nmysql> select * from instance_info_caches where id='1964'\\G;\n*************************** 1. row ***************************\n   created_at: 2016-06-21 14:44:17\n   updated_at: NULL\n   deleted_at: NULL\n           id: 1964\n network_info: []\ninstance_uuid: 9e191fd1-7a5d-430f-973b-625190f525b9\n      deleted: 0\n1 row in set (0.00 sec)", 
            "date_created": "2016-06-21 15:35:44.523344+00:00", 
            "author": "https://api.launchpad.net/1.0/~asomya"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/333579", 
            "date_created": "2016-06-23 20:45:36.540521+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Baodong (Robert) Li (<email address hidden>) on branch: master\nReview: https://review.openstack.org/333579\nReason: https://review.openstack.org/#/c/340614/\nHas a similar fix that in addition includes fix for volume detach. So abandon this one.", 
            "date_created": "2016-08-01 13:29:27.494730+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "\nThere are no currently open reviews on this bug, changing\nthe status back to the previous state and unassigning. If\nthere are active reviews related to this bug, please include\nlinks in comments.\n", 
            "date_created": "2017-06-23 12:51:16.781308+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Automatically discovered version liberty in description. If this is incorrect, please update the description to include 'nova version: ...'", 
            "date_created": "2017-06-27 16:02:30.672758+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}