{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:34:05.616244+00:00", 
    "description": "Recent changes (https://review.openstack.org/4368) to the xen plugins fixed an issue where shutil.move was resulting in a copy even if a much faster rename would suffice.  However, those fixes meant that if /images isn't on the same device as /var/run/sr-mount/<uuid>, then the resize would fail completely. Since it is totally possible that a xen hypervisor has many sr-mounts, and the default one could change when the compute manager is reconfigured, we should expect the plugin code to work even if /images is on a different device than the given sr-mount.\n\nHere's an example trace I saw when this happened\n\n2012-02-23 16:51:59 WARNING nova.virt.xenapi_conn [-] Task [Async.host.call_plugin] OpaqueRef:f5b9678f-a87b-015e-8b6a-0b48c16ad9ec status: failure    ['XENAPI_PLUGIN_EXCEPTION', 'move_vhds_into_sr', 'OSError', '[Errno 18] Invalid cross-device link']\n2012-02-23 16:51:59 ERROR nova.compute.manager [-] ['XENAPI_PLUGIN_EXCEPTION', 'move_vhds_into_sr', 'OSError', '[Errno 18] Invalid cross-device link']. Setting instance vm_state to ERROR\n2012-02-23 16:51:59 ERROR nova.rpc.common [-] Exception during message handling\n(nova.rpc.common): TRACE: Traceback (most recent call last):\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/rpc/amqp.py\", line 250, in _process_data\n(nova.rpc.common): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/exception.py\", line 112, in wrapped\n(nova.rpc.common): TRACE:     return f(*args, **kw)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 156, in decorated_function\n(nova.rpc.common): TRACE:     function(self, context, instance_uuid, *args, **kwargs)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 180, in decorated_function\n(nova.rpc.common): TRACE:     sys.exc_info())\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/contextlib.py\", line 23, in __exit__\n(nova.rpc.common): TRACE:     self.gen.next()\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 174, in decorated_function\n(nova.rpc.common): TRACE:     return function(self, context, instance_uuid, *args, **kwargs)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 1379, in finish_resize\n(nova.rpc.common): TRACE:     self._set_instance_error_state(context, instance_ref.uuid)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/contextlib.py\", line 23, in __exit__\n(nova.rpc.common): TRACE:     self.gen.next()\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 1374, in finish_resize\n(nova.rpc.common): TRACE:     disk_info)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 1346, in _finish_resize\n(nova.rpc.common): TRACE:     image_meta, resize_instance)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi_conn.py\", line 223, in finish_migration\n(nova.rpc.common): TRACE:     network_info, image_meta, resize_instance)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 161, in finish_migration\n(nova.rpc.common): TRACE:     vdi_uuid = self._move_disks(instance, disk_info)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 844, in _move_disks\n(nova.rpc.common): TRACE:     self._session.wait_for_task(task, instance['uuid'])\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi_conn.py\", line 647, in wait_for_task\n(nova.rpc.common): TRACE:     raise self.XenAPI.Failure(error_info)\n(nova.rpc.common): TRACE: Failure: ['XENAPI_PLUGIN_EXCEPTION', 'move_vhds_into_sr', 'OSError', '[Errno 18] Invalid cross-device link']\n(nova.rpc.common): TRACE:", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/939916", 
    "owner": "https://api.launchpad.net/1.0/~markwash", 
    "id": 939916, 
    "index": 2613, 
    "created": "2012-02-23 23:38:27.402186+00:00", 
    "title": "OSError Invalid cross-device link during resize", 
    "comments": [
        {
            "content": "Recent changes (https://review.openstack.org/4368) to the xen plugins fixed an issue where shutil.move was resulting in a copy even if a much faster rename would suffice.  However, those fixes meant that if /images isn't on the same device as /var/run/sr-mount/<uuid>, then the resize would fail completely. Since it is totally possible that a xen hypervisor has many sr-mounts, and the default one could change when the compute manager is reconfigured, we should expect the plugin code to work even if /images is on a different device than the given sr-mount.\n\nHere's an example trace I saw when this happened\n\n2012-02-23 16:51:59 WARNING nova.virt.xenapi_conn [-] Task [Async.host.call_plugin] OpaqueRef:f5b9678f-a87b-015e-8b6a-0b48c16ad9ec status: failure    ['XENAPI_PLUGIN_EXCEPTION', 'move_vhds_into_sr', 'OSError', '[Errno 18] Invalid cross-device link']\n2012-02-23 16:51:59 ERROR nova.compute.manager [-] ['XENAPI_PLUGIN_EXCEPTION', 'move_vhds_into_sr', 'OSError', '[Errno 18] Invalid cross-device link']. Setting instance vm_state to ERROR\n2012-02-23 16:51:59 ERROR nova.rpc.common [-] Exception during message handling\n(nova.rpc.common): TRACE: Traceback (most recent call last):\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/rpc/amqp.py\", line 250, in _process_data\n(nova.rpc.common): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/exception.py\", line 112, in wrapped\n(nova.rpc.common): TRACE:     return f(*args, **kw)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 156, in decorated_function\n(nova.rpc.common): TRACE:     function(self, context, instance_uuid, *args, **kwargs)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 180, in decorated_function\n(nova.rpc.common): TRACE:     sys.exc_info())\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/contextlib.py\", line 23, in __exit__\n(nova.rpc.common): TRACE:     self.gen.next()\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 174, in decorated_function\n(nova.rpc.common): TRACE:     return function(self, context, instance_uuid, *args, **kwargs)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 1379, in finish_resize\n(nova.rpc.common): TRACE:     self._set_instance_error_state(context, instance_ref.uuid)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/contextlib.py\", line 23, in __exit__\n(nova.rpc.common): TRACE:     self.gen.next()\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 1374, in finish_resize\n(nova.rpc.common): TRACE:     disk_info)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/compute/manager.py\", line 1346, in _finish_resize\n(nova.rpc.common): TRACE:     image_meta, resize_instance)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi_conn.py\", line 223, in finish_migration\n(nova.rpc.common): TRACE:     network_info, image_meta, resize_instance)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 161, in finish_migration\n(nova.rpc.common): TRACE:     vdi_uuid = self._move_disks(instance, disk_info)\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi/vmops.py\", line 844, in _move_disks\n(nova.rpc.common): TRACE:     self._session.wait_for_task(task, instance['uuid'])\n(nova.rpc.common): TRACE:   File \"/usr/lib/python2.6/dist-packages/nova/virt/xenapi_conn.py\", line 647, in wait_for_task\n(nova.rpc.common): TRACE:     raise self.XenAPI.Failure(error_info)\n(nova.rpc.common): TRACE: Failure: ['XENAPI_PLUGIN_EXCEPTION', 'move_vhds_into_sr', 'OSError', '[Errno 18] Invalid cross-device link']\n(nova.rpc.common): TRACE:", 
            "date_created": "2012-02-23 23:38:27.402186+00:00", 
            "author": "https://api.launchpad.net/1.0/~markwash"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/4473", 
            "date_created": "2012-02-23 23:42:13.433658+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/4473\nCommitted: http://github.com/openstack/nova/commit/0d487d4f2350e42d6a63febd413b70e663053a1b\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0d487d4f2350e42d6a63febd413b70e663053a1b\nAuthor: Mark Washenberger <email address hidden>\nDate:   Thu Feb 23 18:39:03 2012 -0500\n\n    Copy data when migration dst is on a different FS\n    \n    Fixes bug 939916\n    \n    Change-Id: I678e15a13f99b59b16bd446f566b2c48dcba6057\n", 
            "date_created": "2012-02-24 16:13:23.050740+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}