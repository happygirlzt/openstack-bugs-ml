{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:48:41.293724+00:00", 
    "description": "Nova version: CE, havana\nDescription:\nnova.db.aggregate_get_by_host() return all aggregates, it should return the aggregates which contain the host.\n\nTest environment:\n1. cmd line:\nallengao@allengao-OptiPlex-790:/opt/stack/nova$ nova aggregate-list\n+----+------+-------------------+\n| Id | Name | Availability Zone |\n+----+------+-------------------+\n| 1  | agg1 | None              |\n| 2  | agg2 | None              |\n| 3  | agg3 | None              |\n+----+------+-------------------+\n\nallengao@allengao-OptiPlex-790:/opt/stack/nova$ nova aggregate-details 1\n+----+------+-------------------+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Id | Name | Availability Zone | Hosts | Metadata                                                                                                                                                                                                                                                                                                      |\n+----+------+-------------------+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| 1  | agg1 | None              | []    | {u'ongoingpolicy::max_parallel': u'10', u'initialpolicy::id': u'3', u'ongoingpolicy::threshold': u'80', u'ongoing-policy::threshold': u'70', u'test': u'2', u'ongoingpolicy::stabilization': u'3', u'ongoingpolicy::id': u'1', u'ongoingpolicy::action': u'migrate_vm', u'ongoingpolicy::run_interval': u'1'} |\n+----+------+-------------------+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\nallengao@allengao-OptiPlex-790:/opt/stack/nova$ nova aggregate-details 2\n+----+------+-------------------+----------------------------+----------+\n| Id | Name | Availability Zone | Hosts                      | Metadata |\n+----+------+-------------------+----------------------------+----------+\n| 2  | agg2 | None              | [u'allengao-OptiPlex-790'] | {}       |\n+----+------+-------------------+----------------------------+----------+\n\nallengao@allengao-OptiPlex-790:/opt/stack/nova$ nova aggregate-create agg3\n+----+------+-------------------+-------+----------+\n| Id | Name | Availability Zone | Hosts | Metadata |\n+----+------+-------------------+-------+----------+\n| 3  | agg3 | None              |       |          |\n+----+------+-------------------+-------+----------+\n\n2. DB\nmysql> select * from aggregates;\n+---------------------+------------+------------+----+------+---------+\n| created_at          | updated_at | deleted_at | id | name | deleted |\n+---------------------+------------+------------+----+------+---------+\n| 2013-06-03 09:46:08 | NULL       | NULL       |  1 | agg1 |       0 |\n| 2013-06-05 07:51:09 | NULL       | NULL       |  2 | agg2 |       0 |\n| 2013-06-05 09:17:42 | NULL       | NULL       |  3 | agg3 |       0 |\n+---------------------+------------+------------+----+------+---------+\n\nmysql> select * from aggregate_hosts;\n+---------------------+------------+------------+----+-----------------------+--------------+---------+\n| created_at          | updated_at | deleted_at | id | host                  | aggregate_id | deleted |\n+---------------------+------------+------------+----+-----------------------+--------------+---------+\n| 2013-06-05 08:50:42 | NULL       | NULL       |  3 | allengao-OptiPlex-790 |            2 |       0 |\n+---------------------+------------+------------+----+-----------------------+--------------+---------+\n\n3. Debug message\n137                 host = service['host']\n138  ->             aggregates = db.aggregate_get_by_host(self.context, host)\n139                 agg_name = []\n140                 for agg in aggregates:\n141                     agg_name.append(agg.name)\n142                 host_aggregate_map[host] = agg_name\n143             self.host_aggregate_map = host_aggregate_map\n(Pdb) p host\nu'allengao-OptiPlex-790'\n\n\n(Pdb) l\n138                 aggregates = db.aggregate_get_by_host(self.context, host)\n139                 agg_name = []\n140                 for agg in aggregates:\n141                     agg_name.append(agg.name)\n142                 host_aggregate_map[host] = agg_name\n143  ->         self.host_aggregate_map = host_aggregate_map\n[EOF]\n(Pdb) p agg_name\n[u'agg1', u'agg2', u'agg3']", 
    "tags": [
        "aggregate", 
        "db"
    ], 
    "importance": "Medium", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1187708", 
    "owner": "https://api.launchpad.net/1.0/~dripton", 
    "id": 1187708, 
    "index": 3420, 
    "created": "2013-06-05 09:46:02.317157+00:00", 
    "title": "CE:havana: aggregate_get_by_host return all aggregates", 
    "comments": [
        {
            "content": "Nova version: CE, havana\nDescription:\nnova.db.aggregate_get_by_host() return all aggregates, it should return the aggregates which contain the host.\n\nTest environment:\n1. cmd line:\nallengao@allengao-OptiPlex-790:/opt/stack/nova$ nova aggregate-list\n+----+------+-------------------+\n| Id | Name | Availability Zone |\n+----+------+-------------------+\n| 1  | agg1 | None              |\n| 2  | agg2 | None              |\n| 3  | agg3 | None              |\n+----+------+-------------------+\n\nallengao@allengao-OptiPlex-790:/opt/stack/nova$ nova aggregate-details 1\n+----+------+-------------------+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Id | Name | Availability Zone | Hosts | Metadata                                                                                                                                                                                                                                                                                                      |\n+----+------+-------------------+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| 1  | agg1 | None              | []    | {u'ongoingpolicy::max_parallel': u'10', u'initialpolicy::id': u'3', u'ongoingpolicy::threshold': u'80', u'ongoing-policy::threshold': u'70', u'test': u'2', u'ongoingpolicy::stabilization': u'3', u'ongoingpolicy::id': u'1', u'ongoingpolicy::action': u'migrate_vm', u'ongoingpolicy::run_interval': u'1'} |\n+----+------+-------------------+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\nallengao@allengao-OptiPlex-790:/opt/stack/nova$ nova aggregate-details 2\n+----+------+-------------------+----------------------------+----------+\n| Id | Name | Availability Zone | Hosts                      | Metadata |\n+----+------+-------------------+----------------------------+----------+\n| 2  | agg2 | None              | [u'allengao-OptiPlex-790'] | {}       |\n+----+------+-------------------+----------------------------+----------+\n\nallengao@allengao-OptiPlex-790:/opt/stack/nova$ nova aggregate-create agg3\n+----+------+-------------------+-------+----------+\n| Id | Name | Availability Zone | Hosts | Metadata |\n+----+------+-------------------+-------+----------+\n| 3  | agg3 | None              |       |          |\n+----+------+-------------------+-------+----------+\n\n2. DB\nmysql> select * from aggregates;\n+---------------------+------------+------------+----+------+---------+\n| created_at          | updated_at | deleted_at | id | name | deleted |\n+---------------------+------------+------------+----+------+---------+\n| 2013-06-03 09:46:08 | NULL       | NULL       |  1 | agg1 |       0 |\n| 2013-06-05 07:51:09 | NULL       | NULL       |  2 | agg2 |       0 |\n| 2013-06-05 09:17:42 | NULL       | NULL       |  3 | agg3 |       0 |\n+---------------------+------------+------------+----+------+---------+\n\nmysql> select * from aggregate_hosts;\n+---------------------+------------+------------+----+-----------------------+--------------+---------+\n| created_at          | updated_at | deleted_at | id | host                  | aggregate_id | deleted |\n+---------------------+------------+------------+----+-----------------------+--------------+---------+\n| 2013-06-05 08:50:42 | NULL       | NULL       |  3 | allengao-OptiPlex-790 |            2 |       0 |\n+---------------------+------------+------------+----+-----------------------+--------------+---------+\n\n3. Debug message\n137                 host = service['host']\n138  ->             aggregates = db.aggregate_get_by_host(self.context, host)\n139                 agg_name = []\n140                 for agg in aggregates:\n141                     agg_name.append(agg.name)\n142                 host_aggregate_map[host] = agg_name\n143             self.host_aggregate_map = host_aggregate_map\n(Pdb) p host\nu'allengao-OptiPlex-790'\n\n\n(Pdb) l\n138                 aggregates = db.aggregate_get_by_host(self.context, host)\n139                 agg_name = []\n140                 for agg in aggregates:\n141                     agg_name.append(agg.name)\n142                 host_aggregate_map[host] = agg_name\n143  ->         self.host_aggregate_map = host_aggregate_map\n[EOF]\n(Pdb) p agg_name\n[u'agg1', u'agg2', u'agg3']", 
            "date_created": "2013-06-05 09:46:02.317157+00:00", 
            "author": "https://api.launchpad.net/1.0/~gaozheng0123"
        }, 
        {
            "content": "This bug looks legit.  The code is in nova.db.sqlalchemy.api.  test_db_api.py test_aggregate_get_by_host seems wrong.", 
            "date_created": "2013-06-05 17:46:46.161812+00:00", 
            "author": "https://api.launchpad.net/1.0/~dripton"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/31849", 
            "date_created": "2013-06-05 19:18:10.392537+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/31849\nCommitted: http://github.com/openstack/nova/commit/7fadc012939faf063bbe9ad3a2f35067ce16a4b2\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7fadc012939faf063bbe9ad3a2f35067ce16a4b2\nAuthor: David Ripton <email address hidden>\nDate:   Wed Jun 5 15:14:31 2013 -0400\n\n    Use an inner join on aggregate_hosts in aggregate_get_by_host\n    \n    Fixes bug 1187708\n    \n    By default, sqlalchemy.orm.joinedload does a left outer join.  But in\n    aggregate_get_by_host, we only want to get aggregates rows with\n    aggregate_hosts rows that match the host, and a left outer join also\n    gave us aggregates rows with no matching aggregate_hosts row.\n    \n    Also improve test_aggregate_get_by_host to catch this bug.\n    \n    Change-Id: Ida9647af02ab58229abe3c50dc3d2c7ec9792a5e\n", 
            "date_created": "2013-06-13 05:39:35.563313+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The fix of this bug is not correct.\n\nI encountered the same problem on grizzly version.  And I change the api.py  follow the commited.\nHowerver, it is also not work well.\n\nAccording the document of sqlalchemy, query options.(joinedload(c)) is not really join.\nquery.filter(models.AggregateHost.host == host) can not work.\n\n http://github.com/openstack/nova/commit/7fadc012939faf063bbe9ad3a2f35067ce16a4b2\n\nnova/db/sqlalchemy/api.py\nThe line number 4625 need to change like this:\nquery = query.join(\"_host\").filter(models.AggregateHost.host == host) \n\nnova/tests/db/test_db_api.py \nneed to add the assert  \" as is not in result set\"\n", 
            "date_created": "2013-07-04 03:34:49.373833+00:00", 
            "author": "https://api.launchpad.net/1.0/~rmm0811"
        }, 
        {
            "content": "What renminmin wrote looks correct.\n\nI've submitted bug 1201277 to track the fix of this fix, since I want to see it backported to Grizzly.", 
            "date_created": "2013-07-15 06:11:59.787868+00:00", 
            "author": "https://api.launchpad.net/1.0/~kspear"
        }
    ]
}