{
    "status": "Invalid", 
    "last_updated": "2015-10-05 13:50:18.576712+00:00", 
    "description": "On a multinode devstack installation I have created a new lvm device:\nsudo dd if=/dev/zero of=/loopy bs=1M count=5124 # 5gb\nsudo losetup /dev/loop2 /loopy\n\nsudo sfdisk /dev/loop2 << EOF\n,,8e,,\nEOF\nsudo pvcreate /dev/loop2\nsudo vgcreate encrypted-ephemeral /dev/loop2\n \nPlease note that the volume group name is \"ecnrypted-ephemeral\" but I am not using any encryption.\nI set up my nova compute to use lvm images for the ephemeral disks:\n[libvirt]\nimages_type = lvm\nimages_volume_group = encrypted-ephemeral\n\nThen I changed the live migration uri to use tcp instead of ssh:\nlive_migration_uri = qemu+tcp://%s/system\n\nI did the same configuration on a second compute node.\n\nAt this point I booted a vm which became ACTIVE with no error then I tried to migrate the instance:\nnova live-migration <instance_name> devstackmn-2 --block-migrate\n\nand the migration fails and in the libivirt log file there is this error reported:\n2015-09-24 08:23:17.674+0000: 26629: error : virNetClientProgramDispatchError:175 : Failed to open file '/dev/encrypted-ephemeral/9c1c82cb-cf11-4b2b-a994-2d94d286bfb9_disk': No such file or directory\n\nand in the nova-compute log file of the source node I see a similar error:\n\n2015-09-24 14:33:19.023 ERROR nova.virt.libvirt.driver [req-3f358ce5-7746-4532-9bb4-bf1189181ce8 admin admin] [instance: 9c1c82cb-cf11-4b2b-a994-2d94d286bfb9] Live Migration failure: Failed to open file '/dev/encrypted-ephemeral/9c1c82cb-cf11-4b2b-a994-2d94d286bfb9_disk': No such file or directory\n2015-09-24 14:33:19.023 DEBUG nova.virt.libvirt.driver [req-3f358ce5-7746-4532-9bb4-bf1189181ce8 admin admin] [instance: 9c1c82cb-cf11-4b2b-a994-2d94d286bfb9] Migration operation thread notification from (pid=21098) thread_finished /opt/stack/nova/nova/virt/libvirt/driver.py:6041\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 457, in fire_timers\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 58, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 168, in _do_send\n    waiter.switch(result)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/utils.py\", line 1154, in context_wrapper\n    return func(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5643, in _live_migration_operation\n    instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 195, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5611, in _live_migration_operation\n    CONF.libvirt.live_migration_bandwidth)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 1586, in migrateToURI2\n    if ret == -1: raise libvirtError ('virDomainMigrateToURI2() failed', dom=self)\nlibvirtError: Failed to open file '/dev/encrypted-ephemeral/9c1c82cb-cf11-4b2b-a994-2d94d286bfb9_disk': No such file or directory\n2015-09-24 14:33:19.224 DEBUG nova.virt.libvirt.driver [req-3f358ce5-7746-4532-9bb4-bf1189181ce8 admin admin] [instance: 9c1c82cb-cf11-4b2b-a994-2d94d286bfb9] VM running on src, migration failed from (pid=21098) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5847\n2015-09-24 14:33:19.224 DEBUG nova.virt.libvirt.driver [req-3f358ce5-7746-4532-9bb4-bf1189181ce8 admin admin] [instance: 9c1c82cb-cf11-4b2b-a994-2d94d286bfb9] Fixed incorrect job type to be 4 from (pid=21098) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5867\n2015-09-24 14:33:19.224 ERROR nova.virt.libvirt.driver [req-3f358ce5-7746-4532-9bb4-bf1189181ce8 admin admin] [instance: 9c1c82cb-cf11-4b2b-a994-2d94d286bfb9] Migration operation has aborted\n\n\n\nNova version as per git log\n\ncommit 806dc025dbc9a102f7bace78be9c56f8e9af0929\nMerge: 424aaf3 ae3d970\nAuthor: Jenkins <email address hidden>\nDate:   Sat Sep 19 05:03:38 2015 +0000\n\n    Merge \"libvirt:Remove duplicated check code for config option sysinfo_serial\"", 
    "tags": [
        "libvirt", 
        "live-migrate"
    ], 
    "importance": "Undecided", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1499405", 
    "owner": "None", 
    "id": 1499405, 
    "index": 5790, 
    "created": "2015-09-24 14:38:25.253378+00:00", 
    "title": "Live block migration fails for instances with LVM ephemeral devices", 
    "comments": [
        {
            "content": "On a multinode devstack installation I have created a new lvm device:\nsudo dd if=/dev/zero of=/loopy bs=1M count=5124 # 5gb\nsudo losetup /dev/loop2 /loopy\n\nsudo sfdisk /dev/loop2 << EOF\n,,8e,,\nEOF\nsudo pvcreate /dev/loop2\nsudo vgcreate encrypted-ephemeral /dev/loop2\n \nPlease note that the volume group name is \"ecnrypted-ephemeral\" but I am not using any encryption.\nI set up my nova compute to use lvm images for the ephemeral disks:\n[libvirt]\nimages_type = lvm\nimages_volume_group = encrypted-ephemeral\n\nThen I changed the live migration uri to use tcp instead of ssh:\nlive_migration_uri = qemu+tcp://%s/system\n\nI did the same configuration on a second compute node.\n\nAt this point I booted a vm which became ACTIVE with no error then I tried to migrate the instance:\nnova live-migration <instance_name> devstackmn-2 --block-migrate\n\nand the migration fails and in the libivirt log file there is this error reported:\n2015-09-24 08:23:17.674+0000: 26629: error : virNetClientProgramDispatchError:175 : Failed to open file '/dev/encrypted-ephemeral/9c1c82cb-cf11-4b2b-a994-2d94d286bfb9_disk': No such file or directory\n\nand in the nova-compute log file of the source node I see a similar error:\n\n2015-09-24 14:33:19.023 ERROR nova.virt.libvirt.driver [req-3f358ce5-7746-4532-9bb4-bf1189181ce8 admin admin] [instance: 9c1c82cb-cf11-4b2b-a994-2d94d286bfb9] Live Migration failure: Failed to open file '/dev/encrypted-ephemeral/9c1c82cb-cf11-4b2b-a994-2d94d286bfb9_disk': No such file or directory\n2015-09-24 14:33:19.023 DEBUG nova.virt.libvirt.driver [req-3f358ce5-7746-4532-9bb4-bf1189181ce8 admin admin] [instance: 9c1c82cb-cf11-4b2b-a994-2d94d286bfb9] Migration operation thread notification from (pid=21098) thread_finished /opt/stack/nova/nova/virt/libvirt/driver.py:6041\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 457, in fire_timers\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 58, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 168, in _do_send\n    waiter.switch(result)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/utils.py\", line 1154, in context_wrapper\n    return func(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5643, in _live_migration_operation\n    instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 195, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5611, in _live_migration_operation\n    CONF.libvirt.live_migration_bandwidth)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 1586, in migrateToURI2\n    if ret == -1: raise libvirtError ('virDomainMigrateToURI2() failed', dom=self)\nlibvirtError: Failed to open file '/dev/encrypted-ephemeral/9c1c82cb-cf11-4b2b-a994-2d94d286bfb9_disk': No such file or directory\n2015-09-24 14:33:19.224 DEBUG nova.virt.libvirt.driver [req-3f358ce5-7746-4532-9bb4-bf1189181ce8 admin admin] [instance: 9c1c82cb-cf11-4b2b-a994-2d94d286bfb9] VM running on src, migration failed from (pid=21098) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5847\n2015-09-24 14:33:19.224 DEBUG nova.virt.libvirt.driver [req-3f358ce5-7746-4532-9bb4-bf1189181ce8 admin admin] [instance: 9c1c82cb-cf11-4b2b-a994-2d94d286bfb9] Fixed incorrect job type to be 4 from (pid=21098) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5867\n2015-09-24 14:33:19.224 ERROR nova.virt.libvirt.driver [req-3f358ce5-7746-4532-9bb4-bf1189181ce8 admin admin] [instance: 9c1c82cb-cf11-4b2b-a994-2d94d286bfb9] Migration operation has aborted\n\n\n\nNova version as per git log\n\ncommit 806dc025dbc9a102f7bace78be9c56f8e9af0929\nMerge: 424aaf3 ae3d970\nAuthor: Jenkins <email address hidden>\nDate:   Sat Sep 19 05:03:38 2015 +0000\n\n    Merge \"libvirt:Remove duplicated check code for config option sysinfo_serial\"", 
            "date_created": "2015-09-24 14:38:25.253378+00:00", 
            "author": "https://api.launchpad.net/1.0/~andrea-rosa-m"
        }, 
        {
            "content": "just one more thing, libvirt and nova complain with a \" Failed to open file '/dev/encrypted-ephemeral/9c1c82cb-cf11-4b2b-a994-2d94d286bfb9_disk': No such file or directory\nBut the file exists and the libvitrt-qemu user can see it:\n\nsu libvirt-qemu -s /bin/sh\n$ whoami\nlibvirt-qemu\n$ ls /dev/encrypted-ephemeral/9c1c82cb-cf11-4b2b-a994-2d94d286bfb9_disk\n/dev/encrypted-ephemeral/9c1c82cb-cf11-4b2b-a994-2d94d286bfb9_disk\n", 
            "date_created": "2015-09-24 14:51:32.536923+00:00", 
            "author": "https://api.launchpad.net/1.0/~andrea-rosa-m"
        }, 
        {
            "content": "If you exclude the --block-migrate option from the live-migration CLI is there any difference?", 
            "date_created": "2015-09-24 16:00:05.153697+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "@matt if I do not use that parameter I got an error:\nnova live-migration roz_2 devstackmn-2\nERROR (BadRequest): devstackmn-1 is not on shared storage: Live migration can not be used without shared storage except a booted from volume VM which does not have a local disk. (HTTP 400) (Request-ID: req-43a0decd-a1cb-4ef3-b237-cfde433fdfa6)\n\nThe instance is not booted from a volume and I do not have shared storage as it is a lvm on the local compute node.\nHope this helps\n\n", 
            "date_created": "2015-09-25 09:18:49.655747+00:00", 
            "author": "https://api.launchpad.net/1.0/~andrea-rosa-m"
        }, 
        {
            "content": "Not sure I totally understand, so you want to do live-migration using block-devices but specifying TCP as the transport layer instead of SSH ? \n\nI really wonder if that is currently supported. What if you replace tcp by ssh and do the necessary keypairing stuff before live-migrating again?", 
            "date_created": "2015-10-05 08:44:30.583281+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "@sylvain-bauza yes that is what I want to test, trying the migration using TCP instead of SSH.\nSSH is considered insecure in my scenario, It is considered high risk to configure all the compute nodes to allow ssh access each other.\nWhy do you think that  a different transport layer could fix the problem?\n\n", 
            "date_created": "2015-10-05 09:48:29.081108+00:00", 
            "author": "https://api.launchpad.net/1.0/~andrea-rosa-m"
        }, 
        {
            "content": "QEMU only supports TCP for native (direct) live migrations. When libvirt tunneling is enabled then both transport layers are supported - SSH and TCP.\n\nAFAIK block live migration with NBD does not work when tunneling is enabled:\nhttps://wiki.openstack.org/wiki/OSSN/OSSN-0007\nhttps://bugs.launchpad.net/nova/+bug/1441054/comments/2", 
            "date_created": "2015-10-05 09:51:33.041980+00:00", 
            "author": "https://api.launchpad.net/1.0/~pawel-koniszewski"
        }, 
        {
            "content": "Just wondering how much that bug is related to https://bugs.launchpad.net/devstack/+bug/1487262\n\n", 
            "date_created": "2015-10-05 12:30:12.663085+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "I had time to did more investigation and I found that the live migration for LVM backed instances is not supported:\nhttps://github.com/openstack/nova/blob/master/nova/virt/libvirt/driver.py#L6665\n\nThis change https://review.openstack.org/73387 was for raising the NotImplementedError exception when we try LVM migration.\nIn my case I didn't see that exception probably because I hit a different exception before, we still need to check that the control about LVM is done at the right time, but that will be a different bug.\n\nI am going to mark  this bug as Invalid as it is a duplicate of https://bugs.launchpad.net/nova/+bug/1282643", 
            "date_created": "2015-10-05 13:50:06.495369+00:00", 
            "author": "https://api.launchpad.net/1.0/~andrea-rosa-m"
        }
    ]
}