{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:58:24.431215+00:00", 
    "description": "I am using the latest quantum and nova code from github.  I created a VM with three interfaces.  One interface failed to be created.  When I delete the interface that had a port state of \"error\" (50350ce9...) with `nova interface-delete` `nova list` still shows it under \"Networks\"  \n\nThe interface that I deleted that had state active (64f1911e...) did not show up in nova list after I deleted it.\n\nI expected nova list to only show one interface under the \"Networks\" section after I deleted two of the three.\n\n(The below is probably unreadable, so I also pasted at http://paste.openstack.org/show/39491/)\n\n$ nova interface-list jaybuff-test\n+------------+--------------------------------------+--------------------------------------+---------------+-------------+\n| Port State | Port ID                              | Net ID                               | IP addresses  | MAC Address |\n+------------+--------------------------------------+--------------------------------------+---------------+-------------+\n| ACTIVE     | 64f1911e-4843-47f0-bb5a-5855ea7ac69d | d5178745-1d6f-4308-8a7b-c6ea5c72c7df | 10.1.1.3      |             |\n| ACTIVE     | cd82324e-825f-43da-8e48-c46ede23281b | 04d07b77-96fe-4083-a628-08888389d8a1 | 10.211.250.3  |             |\n| ERROR      | 50350ce9-2da1-4100-8d57-b85538492fdb | 1337c239-dd8d-4fbc-915f-46f26a98121b | 1.2.3.4       |             |\n+------------+--------------------------------------+--------------------------------------+---------------+-------------+\n\n$ nova interface-detach jaybuff-test cd82324e-825f-43da-8e48-c46ede23281b\n\n$ nova interface-detach jaybuff-test 50350ce9-2da1-4100-8d57-b85538492fdb\n\n$ nova interface-list jaybuff-test\n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n| Port State | Port ID                              | Net ID                               | IP addresses | MAC Address |\n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n| ACTIVE     | 64f1911e-4843-47f0-bb5a-5855ea7ac69d | d5178745-1d6f-4308-8a7b-c6ea5c72c7df | 10.1.1.3     |             |\n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n\n$ nova list\n+--------------------------------------+--------------+--------+----------------------------------------------------------------+\n| ID                                   | Name         | Status | Networks                                                       |\n+--------------------------------------+--------------+--------+----------------------------------------------------------------+\n| 199cafd5-b20f-4c9f-9fc6-937315229dde | jaybuff-test | ACTIVE | public-network=1.2.3.4; tempest-private-network=10.1.1.3       |\n+--------------------------------------+--------------+--------+----------------------------------------------------------------+", 
    "tags": [
        "low-hanging-fruit"
    ], 
    "importance": "Medium", 
    "heat": 26, 
    "link": "https://bugs.launchpad.net/nova/+bug/1197192", 
    "owner": "https://api.launchpad.net/1.0/~cyril-roelandt", 
    "id": 1197192, 
    "index": 3469, 
    "created": "2013-07-02 23:50:32.979361+00:00", 
    "title": "nova list still shows error'ed network after interface-delete of an error'ed interface", 
    "comments": [
        {
            "content": "I am using the latest quantum and nova code from github.  I created a VM with three interfaces.  One interface failed to be created.  When I delete the interface that had a port state of \"error\" with ```nova interface-delete``` ```nova list``` still shows it under \"Networks\"\n\n\n(The below is probably unreadable, so I also pasted at http://paste.openstack.org/show/39491/)\n\n$ nova interface-list jaybuff-test\n+------------+--------------------------------------+--------------------------------------+---------------+-------------+\n| Port State | Port ID                              | Net ID                               | IP addresses  | MAC Address |\n+------------+--------------------------------------+--------------------------------------+---------------+-------------+\n| ACTIVE     | 64f1911e-4843-47f0-bb5a-5855ea7ac69d | d5178745-1d6f-4308-8a7b-c6ea5c72c7df | 10.1.1.3      |             |\n| ACTIVE     | cd82324e-825f-43da-8e48-c46ede23281b | 04d07b77-96fe-4083-a628-08888389d8a1 | 10.211.250.3  |             |\n| ERROR      | 50350ce9-2da1-4100-8d57-b85538492fdb | 1337c239-dd8d-4fbc-915f-46f26a98121b | 1.2.3.4       |             |\n+------------+--------------------------------------+--------------------------------------+---------------+-------------+\n\n$ nova interface-detach jaybuff-test cd82324e-825f-43da-8e48-c46ede23281b\n\n$ nova interface-detach jaybuff-test 50350ce9-2da1-4100-8d57-b85538492fdb\n\n$ nova interface-list jaybuff-test \n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n| Port State | Port ID                              | Net ID                               | IP addresses | MAC Address |\n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n| ACTIVE     | 64f1911e-4843-47f0-bb5a-5855ea7ac69d | d5178745-1d6f-4308-8a7b-c6ea5c72c7df | 10.1.1.3     |             |\n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n\n$ nova list\n+--------------------------------------+--------------+--------+----------------------------------------------------------------+\n| ID                                   | Name         | Status | Networks                                                       |\n+--------------------------------------+--------------+--------+----------------------------------------------------------------+\n| 199cafd5-b20f-4c9f-9fc6-937315229dde | jaybuff-test | ACTIVE | public-network=1.2.3.4; tempest-private-network=10.1.1.3       |\n+--------------------------------------+--------------+--------+----------------------------------------------------------------+", 
            "date_created": "2013-07-02 23:50:32.979361+00:00", 
            "author": "https://api.launchpad.net/1.0/~jaybuff"
        }, 
        {
            "content": "It looks like this isn't related to the fact that the port was in error state.  I found this in the log on the compute node any time I run interface-{attach,delete}:\n\n2013-07-03 00:12:23,360 (nova.network.api): ERROR api update_instance_cache_with_nw_info Failed storing info cache\nTraceback (most recent call last):\n  File \"/usr/local/csi/share/csi-nova.venv/lib/python2.6/site-packages/nova/network/api.py\", line 84, in update_instance_cache_with_nw_info\n    cache)\n  File \"/usr/local/csi/share/csi-nova.venv/lib/python2.6/site-packages/nova/db/api.py\", line 818, in instance_info_cache_update\n    return IMPL.instance_info_cache_update(context, instance_uuid, values)\n  File \"/usr/local/csi/share/csi-nova.venv/lib/python2.6/site-packages/nova/cmd/compute.py\", line 50, in __call__\n    raise exception.DBNotAllowed('nova-compute')\nDBNotAllowed: nova-compute\n", 
            "date_created": "2013-07-03 00:14:06.599646+00:00", 
            "author": "https://api.launchpad.net/1.0/~jaybuff"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/37700", 
            "date_created": "2013-07-18 15:18:16.775843+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I think this patch does not completely solve this bug. I managed to get a\nreproducible test case (after applying https://review.openstack.org/#/c/37030/\nand https://review.openstack.org/#/c/37700/):\n\n$ nova image-list\n+--------------------------------------+---------------------------------+--------+--------+\n| ID                                   | Name                            | Status | Server |\n+--------------------------------------+---------------------------------+--------+--------+\n| 71f62aba-0b7c-4f2f-a557-d6145d2ee151 | cirros-0.3.1-x86_64-uec         | ACTIVE |        |\n| e52f691c-05d3-429a-89c0-52deb0c013fd | cirros-0.3.1-x86_64-uec-kernel  | ACTIVE |        |\n| ba2fe70e-553c-4d28-9aa8-c5e44f14f9cf | cirros-0.3.1-x86_64-uec-ramdisk | ACTIVE |        |\n+--------------------------------------+---------------------------------+--------+--------+\n\n$ nova boot --flavor m1.nano --image  71f62aba-0b7c-4f2f-a557-d6145d2ee151 nanotest\n...\n\n$ nova list --fields name,networks\n+--------------------------------------+----------+---------------------+\n| ID                                   | Name     | Networks            |\n+--------------------------------------+----------+---------------------+\n| d8d39a88-0c72-46cf-a361-b9890cfa81fc | nanotest | public=172.24.4.227 |\n+--------------------------------------+----------+---------------------+\n\n$ nova interface-list nanotest\n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n| Port State | Port ID                              | Net ID                               | IP addresses | MAC Address |\n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n| ACTIVE     | 33e680fd-57c5-4cc2-9357-7c0591d82312 | a31050d7-2b87-41d1-abd8-c018ade1242c | 172.24.4.227 |             |   \n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n\n$ nova interface-attach --net-id  a31050d7-2b87-41d1-abd8-c018ade1242c nanotest\n\n$ nova list\n+--------------------------------------+----------+--------+------------+-------------+---------------------+\n| ID                                   | Name     | Status | Task State | Power State | Networks            |   \n+--------------------------------------+----------+--------+------------+-------------+---------------------+\n| d8d39a88-0c72-46cf-a361-b9890cfa81fc | nanotest | ACTIVE | None       | Running     | public=172.24.4.228 |\n+--------------------------------------+----------+--------+------------+-------------+---------------------+\n\n$ nova interface-list nanotest\n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n| Port State | Port ID                              | Net ID                               | IP addresses | MAC Address |\n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n| ACTIVE     | 33e680fd-57c5-4cc2-9357-7c0591d82312 | a31050d7-2b87-41d1-abd8-c018ade1242c | 172.24.4.227 |             |   \n| ACTIVE     | 496604ae-f2cf-4da1-a392-b418e6853515 | a31050d7-2b87-41d1-abd8-c018ade1242c | 172.24.4.228 |             |   \n+------------+--------------------------------------+--------------------------------------+--------------+-------------+\n\n\n\nAfter running \"nova interface-attach\", a second interface is attached to\n\"nanotest\", but \"nova list\" only displays one. After a few minutes, it returns\nthe correct output though:\n\n$ nova list --fields name,networks\n+--------------------------------------+----------+-----------------------------------+\n| ID                                   | Name     | Networks                          |   \n+--------------------------------------+----------+-----------------------------------+\n| d8d39a88-0c72-46cf-a361-b9890cfa81fc | nanotest | public=172.24.4.227, 172.24.4.228 |\n+--------------------------------------+----------+-----------------------------------+\n\nprobably thanks to _heal_instance_info_cache(), which is called periodically.\n\n\nI think this failure is related to the patch that fixes this bug\nhttps://bugs.launchpad.net/nova/+bug/1131264 . Here is the problem:\n\nIn nova/network/neutronv2/api.py, the allocate_port_for_instance() method\nreturns the result of allocate_for_instance(), which is decorated with\n\"@refresh_cache\". This decorator runs the function it decorates and updates the\ninstance network cache with the result it returns. Now that\nallocate_for_instance() returns only one port, the instance network cache is\ncompletely overwritten by a single value, and all other ports are removed from\nit.\n\nI'm not sure how to fix this, but I'm wondering whether it would be possible to\nrevert this patch and have allocate_for_instance() return something like:\n\n    return (network_model.NetworkInfo(nw_info),\n            created_port_ids + touched_port_ids)\n\nThis way, the filtering could be done in the compute manager and the cache\ncould be correctly refreshed.\n\nWhat do you think ?\n", 
            "date_created": "2013-07-19 15:42:24.643535+00:00", 
            "author": "https://api.launchpad.net/1.0/~cyril-roelandt"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/37700\nCommitted: http://github.com/openstack/nova/commit/3379e95515dbc4f0574a9c030127ba19ba07f0e2\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3379e95515dbc4f0574a9c030127ba19ba07f0e2\nAuthor: Cyril Roelandt <email address hidden>\nDate:   Thu Jul 18 14:16:18 2013 +0000\n\n    Fix DB access when refreshing the network cache.\n    \n    When calling ComputeManager.attach_interface(), the following happens:\n    \n    1) self.network_api.allocate_port_for_instance() is called from within\n       ComputeManager.attach_interface();\n    2) refresh_cache() is called, since it decorates allocate_port_for_instance();\n    3) refresh_cache calls update_instance_cache_with_nw_info(), with\n       \"conductor_api=None\" since 'conductor_api' cannot be found in the kwargs;\n    4) update_instance_cache_with_nw_info() calls\n       api.db.instance_info_cache_update();\n    5) Since the call to the database should be made through the conductor, a\n       DBNotAllowed exception is raised, which prevents the cache from being updated.\n    \n    This patch fixes the call to allocate_port_for_instance (step 1) so that\n    'conductor_api' can be found in the kwargs (step 3).\n    \n    When using ComputeManager.detach_interface, the exact same problem arises (with\n    deallocate_port_for_instance instead of allocate_port_for_instance).\n    \n    This is a first step towards fixing bug #1197192.\n    \n    Change-Id: I647795907b22790759d3be74afcaf70b712cb338\n", 
            "date_created": "2013-07-23 21:52:57.415763+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}