{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:41:35.750565+00:00", 
    "description": "Resize a power instance with  option \"allow_resize_to_same_host = True\" in nova.conf, the             resize operation failed  due to report using duplicated mac address . Cold migrate also failed  .This only occurred  resize/migrate in same host ,not between two hosts .  PowerVM does not allow MAC addresses to be directly set on LPARs. Instead, use the hypervisor-supplied-nics feature to generate MAC addresses we can ensure are provisioned correctly.  Resize/migrate will get MAC address from network_info to create new LPAR, so original and new LPAR will get same MAC address in same host. Need backup original LPAR's MAC address to other to avoid mac collision issue .", 
    "tags": [
        "powervm"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1161226", 
    "owner": "https://api.launchpad.net/1.0/~lbragstad", 
    "id": 1161226, 
    "index": 3323, 
    "created": "2013-03-28 06:04:12.952749+00:00", 
    "title": "migrate/resize failed in same host with powervm driver", 
    "comments": [
        {
            "content": "Resize a power instance with  option \"allow_resize_to_same_host = True\" in nova.conf, the resize operation failed  due to report using duplicated mac address . Cold migrate also failed  .This only occurred  resize/migrate in same host ,not between two hosts .  PowerVM does not allow MAC addresses to be directly set on LPARs. Instead, use the hypervisor-supplied-nics feature to generate MAC addresses we can ensure are provisioned correctly.  Resize/migrate will get MAC address from network_info to create new LPAR, so original and new LPAR will get same MAC address in same host. Need backup original LPAR's MAC address to other to avoid mac collision issue .\n\nThis is  log of compute: \n\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2392, in finish_resize\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp     self._set_instance_error_state(context, instance['uuid'])\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2380, in finish_resize\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp     disk_info, image)\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2347, in _finish_resize\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp     block_device_info)\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/driver.py\", line 291, in finish_migration\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp     lpar_obj, disk_info['root_disk_file'], disk_size_bytes)\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 595, in deploy_from_migrated_file\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp     self._deploy_from_vios_file(lpar, raw_file_path, size)\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 601, in _deploy_from_vios_file\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp     self._operator.create_lpar(lpar)\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 668, in create_lpar\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp     conf_data))\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 870, in run_vios_command\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp     check_exit_code=check_exit_code)\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/utils.py\", line 323, in ssh_execute\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp     cmd=cmd)\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp ProcessExecutionError: Unexpected error while running command.\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp Command: mksyscfg -r lpar -i \"max_virtual_slots=64,max_procs=2,lpar_env=aixlinux,desired_procs=1,min_procs=1,proc_mode=shared,virtual_eth_adapters=60/0/1//0/0,desired_proc_units=0.1,sharing_mode=uncap,min_mem=512,desired_mem=512,virtual_eth_mac_base_value=fa5e74eddf,max_proc_units=2,name=rzq-0000001f,max_mem=1536,min_proc_units=0.1\"\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp Exit code: 1\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp Stdout: ''\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp Stderr: '[VIOSE0105013E-0433] Specified virtual Ethernet MAC address base value is already used by partition with ID 9.\\n\\n'\n2013-03-20 18:14:42.744 1739 TRACE nova.openstack.common.rpc.amqp", 
            "date_created": "2013-03-28 06:04:12.952749+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "This is  nova-compute log:\nTRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2392, in finish_resize\nTRACE nova.openstack.common.rpc.amqp     self._set_instance_error_state(context, instance['uuid'])\nTRACE nova.openstack.common.rpc.amqp   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\nTRACE nova.openstack.common.rpc.amqp     self.gen.next()\nTRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2380, in finish_resize\nTRACE nova.openstack.common.rpc.amqp     disk_info, image)\nTRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2347, in _finish_resize\nTRACE nova.openstack.common.rpc.amqp     block_device_info)\nTRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/driver.py\", line 291, in finish_migration\nTRACE nova.openstack.common.rpc.amqp     lpar_obj, disk_info['root_disk_file'], disk_size_bytes)\nTRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 595, in deploy_from_migrated_file\nTRACE nova.openstack.common.rpc.amqp     self._deploy_from_vios_file(lpar, raw_file_path, size)\nTRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 601, in _deploy_from_vios_file\nTRACE nova.openstack.common.rpc.amqp     self._operator.create_lpar(lpar)\nTRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 668, in create_lpar\nTRACE nova.openstack.common.rpc.amqp     conf_data))\nTRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/powervm/operator.py\", line 870, in run_vios_command\nTRACE nova.openstack.common.rpc.amqp     check_exit_code=check_exit_code)\nTRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/utils.py\", line 323, in ssh_execute\nTRACE nova.openstack.common.rpc.amqp     cmd=cmd)\nTRACE nova.openstack.common.rpc.amqp ProcessExecutionError: Unexpected error while running command.\nTRACE nova.openstack.common.rpc.amqp Command: mksyscfg -r lpar -i \"max_virtual_slots=64,max_procs=2,lpar_env=aixlinux,desired_procs=1,min_procs=1,proc_mode=shared,virtual_eth_adapters=60/0/1//0/0,desired_proc_units=0.1,sharing_mode=uncap,min_mem=512,desired_mem=512,virtual_eth_mac_base_value=fa5e74eddf,max_proc_units=2,name=rzq-0000001f,max_mem=1536,min_proc_units=0.1\"\nTRACE nova.openstack.common.rpc.amqp Exit code: 1\nTRACE nova.openstack.common.rpc.amqp Stdout: ''\nTRACE nova.openstack.common.rpc.amqp Stderr: '[VIOSE0105013E-0433] Specified virtual Ethernet MAC address base value is already used by partition with ID 9.\\n\\n'\nTRACE nova.openstack.common.rpc.amqp ", 
            "date_created": "2013-03-28 06:08:57.562808+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "I think there are some possible solution:\n1. Remove the VM but don't destory disk and create new in finish_migration and finish_revert_migration.\n2. Check if the resize/cold migration is happening on the same host to avoid the issue.\n3. Remove the MAC address in migrate_disk_and_power_off and get it back in finish_migration and finish_revert_migration.", 
            "date_created": "2013-03-28 06:48:06.275534+00:00", 
            "author": "https://api.launchpad.net/1.0/~flwang"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/25943", 
            "date_created": "2013-04-02 20:19:16.732106+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/25943\nCommitted: http://github.com/openstack/nova/commit/2a43c4020927c936ed3b3f07416413f5171d62f8\nSubmitter: Jenkins\nBranch:    master\n\ncommit 2a43c4020927c936ed3b3f07416413f5171d62f8\nAuthor: Lance Bragstad <email address hidden>\nDate:   Tue Apr 2 04:38:20 2013 +0000\n\n    Resolve conflicting mac address in resize\n    \n    This patch fixes bug 1161226 and mac address conflicts when migrating or\n    resizing an instance using the PowerVM driver. This will ensure that if\n    a migration or resize is taking place on the same host, a temporary mac\n    address will be assigned to the original LPAR so there is no conflict on\n    the VIOS when a second LPAR is started with the same address.\n    \n    Change-Id: I59db484defb789f3a7c0eddbd5ef9e92efc22419\n", 
            "date_created": "2013-04-04 21:23:33.952395+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/grizzly\nReview: https://review.openstack.org/26242", 
            "date_created": "2013-04-05 17:09:45.789580+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/26242\nCommitted: http://github.com/openstack/nova/commit/99b77cc24f02893eb3377c67f77af60e9d9dbe4b\nSubmitter: Jenkins\nBranch:    stable/grizzly\n\ncommit 99b77cc24f02893eb3377c67f77af60e9d9dbe4b\nAuthor: Lance Bragstad <email address hidden>\nDate:   Tue Apr 2 04:38:20 2013 +0000\n\n    Resolve conflicting mac address in resize\n    \n    This patch fixes bug 1161226 and mac address conflicts when migrating or\n    resizing an instance using the PowerVM driver. This will ensure that if\n    a migration or resize is taking place on the same host, a temporary mac\n    address will be assigned to the original LPAR so there is no conflict on\n    the VIOS when a second LPAR is started with the same address.\n    \n    Change-Id: I59db484defb789f3a7c0eddbd5ef9e92efc22419\n    (cherry picked from commit 2a43c4020927c936ed3b3f07416413f5171d62f8)\n", 
            "date_created": "2013-04-12 22:47:02.384656+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}