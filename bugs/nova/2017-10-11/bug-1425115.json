{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:27:00.378165+00:00", 
    "description": "Hi,\n\nA recent change introduced by https://review.openstack.org/152177 break nova on Xen (with the libvirt driver).\n\nThis is the error:\nlibvirtError: this function is not supported by the connection driver: virNodeGetCPUMap\n\nAnd the traceback:\n  File \"/opt/stack/nova/nova/openstack/common/service.py\", line 491, in run_service\n    service.start()\n  File \"/opt/stack/nova/nova/service.py\", line 181, in start\n    self.manager.pre_start_hook()\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 1188, in pre_start_hook\n    self.update_available_resource(nova.context.get_admin_context())\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 6062, in update_available_resource\n    rt.update_available_resource(context)\n  File \"/opt/stack/nova/nova/compute/resource_tracker.py\", line 315, in update_available_resource\n    resources = self.driver.get_available_resource(self.nodename)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4896, in get_available_resource\n    numa_topology = self._get_host_numa_topology()\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4749, in _get_host_numa_topology\n    online_cpus = self._host.get_online_cpus()\n  File \"/opt/stack/nova/nova/virt/libvirt/host.py\", line 599, in get_online_cpus\n    (cpus, cpu_map, online) = self.get_connection().getCPUMap()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 3604, in getCPUMap\n    if ret is None: raise libvirtError ('virNodeGetCPUMap() failed', conn=self)", 
    "tags": [
        "libvirt", 
        "xen"
    ], 
    "importance": "High", 
    "heat": 20, 
    "link": "https://bugs.launchpad.net/nova/+bug/1425115", 
    "owner": "https://api.launchpad.net/1.0/~ndipanov", 
    "id": 1425115, 
    "index": 1691, 
    "created": "2015-02-24 14:57:59.483199+00:00", 
    "title": "nova can't start with libvirt-xen driver", 
    "comments": [
        {
            "content": "Hi,\n\nA recent change introduced by https://review.openstack.org/152177 break nova on Xen (with the libvirt driver).\n\nThis is the error:\nlibvirtError: this function is not supported by the connection driver: virNodeGetCPUMap\n\nAnd the traceback:\n  File \"/opt/stack/nova/nova/openstack/common/service.py\", line 491, in run_service\n    service.start()\n  File \"/opt/stack/nova/nova/service.py\", line 181, in start\n    self.manager.pre_start_hook()\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 1188, in pre_start_hook\n    self.update_available_resource(nova.context.get_admin_context())\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 6062, in update_available_resource\n    rt.update_available_resource(context)\n  File \"/opt/stack/nova/nova/compute/resource_tracker.py\", line 315, in update_available_resource\n    resources = self.driver.get_available_resource(self.nodename)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4896, in get_available_resource\n    numa_topology = self._get_host_numa_topology()\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4749, in _get_host_numa_topology\n    online_cpus = self._host.get_online_cpus()\n  File \"/opt/stack/nova/nova/virt/libvirt/host.py\", line 599, in get_online_cpus\n    (cpus, cpu_map, online) = self.get_connection().getCPUMap()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 3604, in getCPUMap\n    if ret is None: raise libvirtError ('virNodeGetCPUMap() failed', conn=self)", 
            "date_created": "2015-02-24 14:57:59.483199+00:00", 
            "author": "https://api.launchpad.net/1.0/~anthony-perard"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/159106", 
            "date_created": "2015-02-25 12:55:43.646775+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Is it in the nova.git master or in some branch. \nI am trying on cavium thunderx board (armv8 / XEN)", 
            "date_created": "2015-03-19 09:45:09.051864+00:00", 
            "author": "https://api.launchpad.net/1.0/~mjaggi"
        }, 
        {
            "content": "This is not currently committed to any branch, but you can easily check it out from gerrit with:\ngit fetch https://review.openstack.org/openstack/nova refs/changes/06/159106/5 && git checkout FETCH_HEAD", 
            "date_created": "2015-03-19 09:53:00.442087+00:00", 
            "author": "https://api.launchpad.net/1.0/~bob-ball"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/159106\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=945ab28df04e22f3c1b8948972f538ee6b5e7410\nSubmitter: Jenkins\nBranch:    master\n\ncommit 945ab28df04e22f3c1b8948972f538ee6b5e7410\nAuthor: Daniel P. Berrange <email address hidden>\nDate:   Wed Feb 25 10:11:14 2015 +0000\n\n    libvirt: fix disablement of NUMA & hugepages on unsupported platforms\n    \n    Two previous commits updated the libvirt XML config generator so\n    that it would omit the config elements for huge pages and NUMA\n    placement when running on old libvirt:\n    \n      commit cf3a1262ecf12f4345326309c273722ebc26b466\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Wed Jan 28 00:54:26 2015 -0500\n    \n        libvirt: avoid setting the memnodes where when it's not a supported option\n    \n      commit 3466e727546e0f7595378b8274254bed913f42ee\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Tue Jan 6 14:23:38 2015 -0500\n    \n        libvirt: not setting membacking when mempages are empty host topology\n    \n    The problem arising from this is that the hosts are still reporting\n    to the schedular that they can support NUMA and huge pages if\n    libvirt >= 1.0.4, but we are silently discarding the guest config\n    if libvirt < 1.2.7 (numa) or 1.2.8 (huge pages).\n    \n    The result is that the schedular thinks the host can support the\n    requested feature and so places the guest there, but the actual\n    guest that is launched is missing the feature. So the user is not\n    getting what they requested.\n    \n    The correct approach is to update the \"_get_host_numa_topology\"\n    method so that it does not report any NUMA topology in the first\n    place, if the host is incapable of having guests configured in\n    the way Nova requires. Likewise if the host cannot support the\n    huge page configuration method required, it should not report\n    availability of huge pages.\n    \n    In summary, we are moving the version checks added by the two\n    commits above to the point at which host capability reporting\n    is done. We add a fatal error check in the guest XML config\n    generator methods, so that if there is some future schedular\n    bug causing it to not honour host capabilities, we see a\n    clear error instead of silently starting guests with the\n    wrong config.\n    \n    There is a further mistake in that a version number check alone\n    is insufficient. We must also check that the hypervisor is\n    either QEMU or KVM, to prevent the code paths running on Xen\n    or LXC.\n    \n    Closes-bug: #1425115\n    Related-bug: #1408070\n    Related-bug: #1415333\n    \n    Change-Id: I8326596696cbb030ae95d17f3dd430d05279081a\n", 
            "date_created": "2015-04-05 14:52:11.038332+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/159106\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=945ab28df04e22f3c1b8948972f538ee6b5e7410\nSubmitter: Jenkins\nBranch:    master\n\ncommit 945ab28df04e22f3c1b8948972f538ee6b5e7410\nAuthor: Daniel P. Berrange <email address hidden>\nDate:   Wed Feb 25 10:11:14 2015 +0000\n\n    libvirt: fix disablement of NUMA & hugepages on unsupported platforms\n    \n    Two previous commits updated the libvirt XML config generator so\n    that it would omit the config elements for huge pages and NUMA\n    placement when running on old libvirt:\n    \n      commit cf3a1262ecf12f4345326309c273722ebc26b466\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Wed Jan 28 00:54:26 2015 -0500\n    \n        libvirt: avoid setting the memnodes where when it's not a supported option\n    \n      commit 3466e727546e0f7595378b8274254bed913f42ee\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Tue Jan 6 14:23:38 2015 -0500\n    \n        libvirt: not setting membacking when mempages are empty host topology\n    \n    The problem arising from this is that the hosts are still reporting\n    to the schedular that they can support NUMA and huge pages if\n    libvirt >= 1.0.4, but we are silently discarding the guest config\n    if libvirt < 1.2.7 (numa) or 1.2.8 (huge pages).\n    \n    The result is that the schedular thinks the host can support the\n    requested feature and so places the guest there, but the actual\n    guest that is launched is missing the feature. So the user is not\n    getting what they requested.\n    \n    The correct approach is to update the \"_get_host_numa_topology\"\n    method so that it does not report any NUMA topology in the first\n    place, if the host is incapable of having guests configured in\n    the way Nova requires. Likewise if the host cannot support the\n    huge page configuration method required, it should not report\n    availability of huge pages.\n    \n    In summary, we are moving the version checks added by the two\n    commits above to the point at which host capability reporting\n    is done. We add a fatal error check in the guest XML config\n    generator methods, so that if there is some future schedular\n    bug causing it to not honour host capabilities, we see a\n    clear error instead of silently starting guests with the\n    wrong config.\n    \n    There is a further mistake in that a version number check alone\n    is insufficient. We must also check that the hypervisor is\n    either QEMU or KVM, to prevent the code paths running on Xen\n    or LXC.\n    \n    Closes-bug: #1425115\n    Related-bug: #1408070\n    Related-bug: #1415333\n    \n    Change-Id: I8326596696cbb030ae95d17f3dd430d05279081a\n", 
            "date_created": "2015-04-05 14:52:18.466988+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}