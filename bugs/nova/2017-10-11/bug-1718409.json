{
    "status": "Invalid", 
    "last_updated": "2017-09-21 02:12:23.698260+00:00", 
    "description": "Description\n===========\nWhen instance rescheduling happens in cell:\n1. Nova compute casts to the build_instances method in cell1 conductor.\n2. In cell1 conductor, build_instances method calls the scheduler_client.select_destinations method, it calls to scheduler for getting scheduled host **without cell0 targeting**, and then, wait scheduler reply.\n\nNobody could get this scheduler message in cell1 mq, because Scheduler just only lisening to the api cell(cell0) mq.\n\nflow like this:\ncompute --> (reschedule) -->  cell1-conductor  -->  (call rpc to CELL1) --> timeout\n\nIt seems conductor shouldn't call this message to CELL1 mq. Maybe, we might transfer the mq connection to api cell mq(target cell0) before call.\n\nAfter this, the flow as blow:\ncompute --> (reschedule) -->  cell1-conductor  --> target CELL0 -->  (call rpc to CELL0) --> scheduler\n\nBTW, a devstack issue founded.\nIn order to let scheduler could get instance group from nova_api database in code here: \nhttps://github.com/openstack/nova/blob/5bf1bb47c7e17c26592a699d07c2faa59d98bfb8/nova/conductor/manager.py#L623\nIt seems we need add 'connection' config in [api_database] section, but now devstack doesn't deal with it.\npatch is here: https://review.openstack.org/#/c/505607/\n\nSteps to reproduce\n==================\n\n* 1. Inject some exception in compute code to reproduce a reschedule operation:\nraise exception.RescheduledException(\"reschedule trigger\") in here:\nhttps://github.com/openstack/nova/blob/5bf1bb47c7e17c26592a699d07c2faa59d98bfb8/nova/compute/manager.py#L1951\n* 2. nova compute cast reschedule request to cell-conductor\n* 3. cell-conductor calls to cell mq, nobody could process that.\n* 4. Instacne state stuck in BUILD(scheduling)\nstack@yikun:~/nova$ nova list\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n| ID                                   | Name                | Status | Task State | Power State | Networks |\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n| af3fe405-7155-429d-97a8-a0f9f4c82911 | test_resch_instance | BUILD  | scheduling | NOSTATE     |          |\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n* 4. Finally, Instance state is ERROR.\nstack@yikun:~/nova$ nova list\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n| ID                                   | Name                | Status | Task State | Power State | Networks |\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n| af3fe405-7155-429d-97a8-a0f9f4c82911 | test_resch_instance | ERROR  | -          | NOSTATE     |          |\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n\n\nLogs & Configs\n==============\ncell config show as blow:\n\nstack@yikun:~/nova$ cat /etc/nova/nova_cell1.conf \n[database]\nconnection = mysql+pymysql://root:1@127.0.0.1/nova_cell1?charset=utf8\n\n[api_database]\nconnection = mysql+pymysql://root:1@127.0.0.1/nova_api?charset=utf8\n\n\n[conductor]\nworkers = 2\n\n[DEFAULT]\nlogging_user_identity_format = %(project_name)s %(user_name)s\ntransport_url = rabbit://stackrabbit:1@XXX:5672/nova_cell1\ndebug = True\n\n\nLog in cell conductor:\n2017-09-20 06:18:01.306 21701 ERROR nova.scheduler.utils [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] [instance: af3fe405-7155-429d-97a8-a0f9f4c82911] Error from last host: yikun (node yikun): [u'Traceback (most recent call last):\\n', u'  File \"/opt/stack/nova/nova/compute/manager.py\", line 1826, in _do_build_and_run_instance\\n    filter_properties)\\n', u'  File \"/opt/stack/nova/nova/compute/manager.py\", line 2057, in _build_and_run_instance\\n    instance_uuid=instance.uuid, reason=six.text_type(e))\\n', u'RescheduledException: Build of instance af3fe405-7155-429d-97a8-a0f9f4c82911 was re-scheduled: reschedule trigger\\n']\n2017-09-20 06:18:01.347 21701 DEBUG oslo_db.sqlalchemy.engines [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] MySQL server mode set to STRICT_TRANS_TABLES,STRICT_ALL_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,TRADITIONAL,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION _check_effective_sql_mode /usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/engines.py:285\n2017-09-20 06:19:01.433 21701 WARNING nova.scheduler.utils [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] Retrying select_destinations after a MessagingTimeout, attempt 1 of 2.: MessagingTimeout: Timed out waiting for a reply to message ID 5dd1a54aa6f446a696f3ab0307572f3f\n2017-09-20 06:20:01.441 21701 WARNING nova.scheduler.utils [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] Retrying select_destinations after a MessagingTimeout, attempt 2 of 2.: MessagingTimeout: Timed out waiting for a reply to message ID c27726fbfcd64211a2a1eb64d05c98f4\n2017-09-20 06:21:01.457 21701 WARNING nova.scheduler.utils [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] Failed to compute_task_build_instances: Timed out waiting for a reply to message ID 5885e65436b14658a857134596cbf277: MessagingTimeout: Timed out waiting for a reply to message ID 5885e65436b14658a857134596cbf277\n2017-09-20 06:21:01.458 21701 WARNING nova.scheduler.utils [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] [instance: af3fe405-7155-429d-97a8-a0f9f4c82911] Setting instance to ERROR state.: MessagingTimeout: Timed out waiting for a reply to message ID 5885e65436b14658a857134596cbf277", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1718409", 
    "owner": "None", 
    "id": 1718409, 
    "index": 7048, 
    "created": "2017-09-20 12:05:26.217031+00:00", 
    "title": "Failed to reschedule instance in cell.", 
    "comments": [
        {
            "content": "Description\n===========\nWhen instance rescheduling happens in cell:\n1. Nova compute casts to the build_instances method in cell1 conductor.\n2. In cell1 conductor, build_instances method calls the scheduler_client.select_destinations method, it calls to scheduler for getting scheduled host **without cell0 targeting**, and then, wait scheduler reply.\n\nNobody could get this scheduler message in cell1 mq, because Scheduler just only lisening to the api cell(cell0) mq.\n\nflow like this:\ncompute --> (reschedule) -->  cell1-conductor  -->  (call rpc to CELL1) --> timeout\n\nIt seems conductor shouldn't call this message to CELL1 mq. Maybe, we might transfer the mq connection to api cell mq(target cell0) before call.\n\nAfter this, the flow as blow:\ncompute --> (reschedule) -->  cell1-conductor  --> target CELL0 -->  (call rpc to CELL0) --> scheduler\n\nBTW, a devstack issue founded.\nIn order to let scheduler could get instance group from nova_api database in code here: \nhttps://github.com/openstack/nova/blob/5bf1bb47c7e17c26592a699d07c2faa59d98bfb8/nova/conductor/manager.py#L623\nIt seems we need add 'connection' config in [api_database] section, but now devstack doesn't deal with it.\npatch is here: https://review.openstack.org/#/c/505607/\n\nSteps to reproduce\n==================\n\n* 1. Inject some exception in compute code to reproduce a reschedule operation:\nraise exception.RescheduledException(\"reschedule trigger\") in here:\nhttps://github.com/openstack/nova/blob/5bf1bb47c7e17c26592a699d07c2faa59d98bfb8/nova/compute/manager.py#L1951\n* 2. nova compute cast reschedule request to cell-conductor\n* 3. cell-conductor calls to cell mq, nobody could process that.\n* 4. Instacne state stuck in BUILD(scheduling)\nstack@yikun:~/nova$ nova list\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n| ID                                   | Name                | Status | Task State | Power State | Networks |\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n| af3fe405-7155-429d-97a8-a0f9f4c82911 | test_resch_instance | BUILD  | scheduling | NOSTATE     |          |\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n* 4. Finally, Instance state is ERROR.\nstack@yikun:~/nova$ nova list\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n| ID                                   | Name                | Status | Task State | Power State | Networks |\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n| af3fe405-7155-429d-97a8-a0f9f4c82911 | test_resch_instance | ERROR  | -          | NOSTATE     |          |\n+--------------------------------------+---------------------+--------+------------+-------------+----------+\n\n\nLogs & Configs\n==============\ncell config show as blow:\n\nstack@yikun:~/nova$ cat /etc/nova/nova_cell1.conf \n[database]\nconnection = mysql+pymysql://root:1@127.0.0.1/nova_cell1?charset=utf8\n\n[api_database]\nconnection = mysql+pymysql://root:1@127.0.0.1/nova_api?charset=utf8\n\n\n[conductor]\nworkers = 2\n\n[DEFAULT]\nlogging_user_identity_format = %(project_name)s %(user_name)s\ntransport_url = rabbit://stackrabbit:1@XXX:5672/nova_cell1\ndebug = True\n\n\nLog in cell conductor:\n2017-09-20 06:18:01.306 21701 ERROR nova.scheduler.utils [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] [instance: af3fe405-7155-429d-97a8-a0f9f4c82911] Error from last host: yikun (node yikun): [u'Traceback (most recent call last):\\n', u'  File \"/opt/stack/nova/nova/compute/manager.py\", line 1826, in _do_build_and_run_instance\\n    filter_properties)\\n', u'  File \"/opt/stack/nova/nova/compute/manager.py\", line 2057, in _build_and_run_instance\\n    instance_uuid=instance.uuid, reason=six.text_type(e))\\n', u'RescheduledException: Build of instance af3fe405-7155-429d-97a8-a0f9f4c82911 was re-scheduled: reschedule trigger\\n']\n2017-09-20 06:18:01.347 21701 DEBUG oslo_db.sqlalchemy.engines [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] MySQL server mode set to STRICT_TRANS_TABLES,STRICT_ALL_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,TRADITIONAL,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION _check_effective_sql_mode /usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/engines.py:285\n2017-09-20 06:19:01.433 21701 WARNING nova.scheduler.utils [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] Retrying select_destinations after a MessagingTimeout, attempt 1 of 2.: MessagingTimeout: Timed out waiting for a reply to message ID 5dd1a54aa6f446a696f3ab0307572f3f\n2017-09-20 06:20:01.441 21701 WARNING nova.scheduler.utils [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] Retrying select_destinations after a MessagingTimeout, attempt 2 of 2.: MessagingTimeout: Timed out waiting for a reply to message ID c27726fbfcd64211a2a1eb64d05c98f4\n2017-09-20 06:21:01.457 21701 WARNING nova.scheduler.utils [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] Failed to compute_task_build_instances: Timed out waiting for a reply to message ID 5885e65436b14658a857134596cbf277: MessagingTimeout: Timed out waiting for a reply to message ID 5885e65436b14658a857134596cbf277\n2017-09-20 06:21:01.458 21701 WARNING nova.scheduler.utils [req-5890b731-4b48-4503-a446-ef3f858eda4a admin admin] [instance: af3fe405-7155-429d-97a8-a0f9f4c82911] Setting instance to ERROR state.: MessagingTimeout: Timed out waiting for a reply to message ID 5885e65436b14658a857134596cbf277", 
            "date_created": "2017-09-20 12:05:26.217031+00:00", 
            "author": "https://api.launchpad.net/1.0/~yikunkero"
        }, 
        {
            "content": "Reschedules and up-calls from the cell conductor to the API database (and scheduler) don't work in superconductor mode in devstack. I commented on the devstack patch. Please read and understand this first:\n\nhttps://docs.openstack.org/nova/latest/user/cellsv2_layout.html", 
            "date_created": "2017-09-21 01:17:28.496114+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Also, see priority #1 here:\n\nhttp://lists.openstack.org/pipermail/openstack-dev/2017-September/122209.html", 
            "date_created": "2017-09-21 01:30:45.068437+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "And https://www.openstack.org/videos/boston-2017/scaling-nova-how-cellsv2-affects-your-deployment", 
            "date_created": "2017-09-21 01:32:26.203679+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Ok, got it, thanks for your reminder, I have found the answer in the page you given.\n\nIn super conductor mode, cell conductor can't reach the api database. This case will work well after alternative hosts bp is completed.", 
            "date_created": "2017-09-21 02:12:23.229417+00:00", 
            "author": "https://api.launchpad.net/1.0/~yikunkero"
        }
    ]
}