{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:53:16.917717+00:00", 
    "description": "I really hesitate to report this as a bug because it is so hard to believe but a user reported it and I can reproduce it.\n\n1. Booted a vm using oneiric-server-cloudimg-amd64 and assigned floating ip\n2. Ssh to vm and\n   sudo apt-get install -y git\n   git clone git://github.com/rackspace/python-novaclient.git\n3. nova reboot\n4. Ssh in again. The python-novaclient directory is intact but all the files have zero length\n\nThis happens often but not always. I had been using these vms myself without such a problem.\n\nThis was running stable-diablo on oneiric with kvm. I don't now what info would be more useful but on vm:\n\nubuntu@buggy:~$ df\nFilesystem           1K-blocks      Used Available Use% Mounted on\n/dev/vda              10321208    687340   9109592   8% /\ndevtmpfs               1026112         4   1026108   1% /dev\nnone                    205648       196    205452   1% /run\nnone                      5120         0      5120   0% /run/lock\nnone                   1028228         0   1028228   0% /run/shm\n/dev/vdb              20642428    176196  19417656   1% /mnt\nubuntu@buggy:~$ mount\n/dev/vda on / type ext4 (rw)\nnone on /proc type proc (rw,noexec,nosuid,nodev)\nnone on /sys type sysfs (rw,noexec,nosuid,nodev)\nnone on /sys/fs/fuse/connections type fusectl (rw)\nnone on /sys/kernel/debug type debugfs (rw)\nnone on /sys/kernel/security type securityfs (rw)\ndevtmpfs on /dev type devtmpfs (rw,mode=0755)\nnone on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)\nnone on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)\nnone on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)\nnone on /run/shm type tmpfs (rw,nosuid,nodev)\n/dev/vdb on /mnt type ext3 (rw)", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/939557", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 939557, 
    "index": 589, 
    "created": "2012-02-23 14:50:41.761023+00:00", 
    "title": "'nova reboot' under KVM always does a hard reboot", 
    "comments": [
        {
            "content": "I really hesitate to report this as a bug because it is so hard to believe but a user reported it and I can reproduce it.\n\n1. Booted a vm using oneiric-server-cloudimg-amd64 and assigned floating ip\n2. Ssh to vm and\n   sudo apt-get install -y git\n   git clone git://github.com/rackspace/python-novaclient.git\n3. nova reboot\n4. Ssh in again. The python-novaclient directory is intact but all the files have zero length\n\nThis happens often but not always. I had been using these vms myself without such a problem.\n\nThis was running stable-diablo on oneiric with kvm. I don't now what info would be more useful but on vm:\n\nubuntu@buggy:~$ df\nFilesystem           1K-blocks      Used Available Use% Mounted on\n/dev/vda              10321208    687340   9109592   8% /\ndevtmpfs               1026112         4   1026108   1% /dev\nnone                    205648       196    205452   1% /run\nnone                      5120         0      5120   0% /run/lock\nnone                   1028228         0   1028228   0% /run/shm\n/dev/vdb              20642428    176196  19417656   1% /mnt\nubuntu@buggy:~$ mount\n/dev/vda on / type ext4 (rw)\nnone on /proc type proc (rw,noexec,nosuid,nodev)\nnone on /sys type sysfs (rw,noexec,nosuid,nodev)\nnone on /sys/fs/fuse/connections type fusectl (rw)\nnone on /sys/kernel/debug type debugfs (rw)\nnone on /sys/kernel/security type securityfs (rw)\ndevtmpfs on /dev type devtmpfs (rw,mode=0755)\nnone on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)\nnone on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)\nnone on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)\nnone on /run/shm type tmpfs (rw,nosuid,nodev)\n/dev/vdb on /mnt type ext3 (rw)", 
            "date_created": "2012-02-23 14:50:41.761023+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "After too much manual retrying this I conclude with high probability that this does not happen if I do a reboot from the shell of the vm, only through the nova API. Furthermore, once I reboot from the vm shell, a subsequent reboot through nova does not zero the files. Strange. I wanted to try this on trystack but reboot from the dashboard is not working.", 
            "date_created": "2012-02-23 19:51:36.473258+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "I suspect nova reboot does a hard reboot while files weren't flushed to disk yet, while doing reboot from the vm does a soft reboot that flushes disks first. In which case I'm not sure that should be considered a bug... What happens if you do a \"sync\" before nova reboot ?", 
            "date_created": "2012-02-24 13:35:40.982587+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "I tried doing a sync and the problem did not happen. However, 'nova reboot' is documented to do a SOFT reboot unless you give it the --hard flag. I verified using the --debug flag that it is indeed doing SOFT. Any ideas for further debugging this? Or is even a SOFT reboot not supposed to flush?\n\nsend: u'POST /v1.1/testproject/servers/d231cdf2-1967-41f8-9528-6eadee5fd7f1/action HTTP/1.1\\r\\nHost: 172.18.0.131:8774\\r\\nContent-Length: 28\\r\\nx-auth-project-id: testproject\\r\\naccept-encoding: gzip, deflate\\r\\naccept: application/json\\r\\nx-auth-token: 866223043243cc5b0fa536d6cb3094acbefd817e\\r\\nuser-agent: python-novaclient\\r\\ncontent-type: application/json\\r\\n\\r\\n{\"reboot\": {\"type\": \"SOFT\"}}'\n", 
            "date_created": "2012-02-24 14:37:15.167788+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "This diablo code TODO appears to be the culprit. It was changed in essex.  I will test in essex, but this bug might be considered for diablo backport.\n\n    def _action_reboot(self, input_dict, req, id):\n        if 'reboot' in input_dict and 'type' in input_dict['reboot']:\n            valid_reboot_types = ['HARD', 'SOFT']\n            reboot_type = input_dict['reboot']['type'].upper()\n            if not valid_reboot_types.count(reboot_type):\n                msg = _(\"Argument 'type' for reboot is not HARD or SOFT\")\n                LOG.exception(msg)\n                raise exc.HTTPBadRequest(explanation=msg)\n        else:\n            msg = _(\"Missing argument 'type' for reboot\")\n            LOG.exception(msg)\n            raise exc.HTTPBadRequest(explanation=msg)\n        try:\n            # TODO(gundlach): pass reboot_type, support soft reboot in\n            # virt driver\n            self.compute_api.reboot(req.environ['nova.context'], id)\n        except Exception, e:\n            LOG.exception(_(\"Error in reboot %s\"), e)\n            raise exc.HTTPUnprocessableEntity()\n        return webob.Response(status_int=202)\n", 
            "date_created": "2012-02-24 15:44:59.086327+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "soft reboot isn't implemented in libvirt.\n\nlooks like it could be done relatively easily by using dom.shutdown() / waiting for it to power off and then starting it again instead of doing the hard version which is destroy/create\n\nVish\n\nOn Feb 24, 2012, at 6:37 AM, David Kranz wrote:\n\n> I tried doing a sync and the problem did not happen. However, 'nova\n> reboot' is documented to do a SOFT reboot unless you give it the --hard\n> flag. I verified using the --debug flag that it is indeed doing SOFT.\n> Any ideas for further debugging this? Or is even a SOFT reboot not\n> supposed to flush?\n> \n> send: u'POST\n> /v1.1/testproject/servers/d231cdf2-1967-41f8-9528-6eadee5fd7f1/action\n> HTTP/1.1\\r\\nHost: 172.18.0.131:8774\\r\\nContent-Length: 28\\r\\nx-auth-\n> project-id: testproject\\r\\naccept-encoding: gzip, deflate\\r\\naccept:\n> application/json\\r\\nx-auth-token:\n> 866223043243cc5b0fa536d6cb3094acbefd817e\\r\\nuser-agent: python-\n> novaclient\\r\\ncontent-type: application/json\\r\\n\\r\\n{\"reboot\": {\"type\":\n> \"SOFT\"}}'\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/939557\n> \n> Title:\n>  Files in vm sometimes zeroed after 'nova reboot'\n> \n> Status in OpenStack Compute (Nova):\n>  Incomplete\n> \n> Bug description:\n>  I really hesitate to report this as a bug because it is so hard to\n>  believe but a user reported it and I can reproduce it.\n> \n>  1. Booted a vm using oneiric-server-cloudimg-amd64 and assigned floating ip\n>  2. Ssh to vm and\n>     sudo apt-get install -y git\n>     git clone git://github.com/rackspace/python-novaclient.git\n>  3. nova reboot\n>  4. Ssh in again. The python-novaclient directory is intact but all the files have zero length\n> \n>  This happens often but not always. I had been using these vms myself\n>  without such a problem.\n> \n>  This was running stable-diablo on oneiric with kvm. I don't now what\n>  info would be more useful but on vm:\n> \n>  ubuntu@buggy:~$ df\n>  Filesystem           1K-blocks      Used Available Use% Mounted on\n>  /dev/vda              10321208    687340   9109592   8% /\n>  devtmpfs               1026112         4   1026108   1% /dev\n>  none                    205648       196    205452   1% /run\n>  none                      5120         0      5120   0% /run/lock\n>  none                   1028228         0   1028228   0% /run/shm\n>  /dev/vdb              20642428    176196  19417656   1% /mnt\n>  ubuntu@buggy:~$ mount\n>  /dev/vda on / type ext4 (rw)\n>  none on /proc type proc (rw,noexec,nosuid,nodev)\n>  none on /sys type sysfs (rw,noexec,nosuid,nodev)\n>  none on /sys/fs/fuse/connections type fusectl (rw)\n>  none on /sys/kernel/debug type debugfs (rw)\n>  none on /sys/kernel/security type securityfs (rw)\n>  devtmpfs on /dev type devtmpfs (rw,mode=0755)\n>  none on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)\n>  none on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)\n>  none on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)\n>  none on /run/shm type tmpfs (rw,nosuid,nodev)\n>  /dev/vdb on /mnt type ext3 (rw)\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/939557/+subscriptions\n\n", 
            "date_created": "2012-02-24 19:34:02+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "This is a pretty serious bug and hope it can be fixed. I think it is not the only case where the compute API defines something but some hypervisor doesn't do it right. What is the \"official\" story about these deviations? I would think that the driver for any hypervisor that is supported in nova core (i.e. can be mentioned by name in nova.conf) needs to honor the core API.", 
            "date_created": "2012-02-24 19:56:25.841101+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Agreed.\n\nWe tried to minimize all of the feature gaps during this release.  Looks like we missed this one. It seems like a relatively easy addition if someone wants to tackle it.\n\nVish\n\nOn Feb 24, 2012, at 11:56 AM, David Kranz wrote:\n\n> This is a pretty serious bug and hope it can be fixed. I think it is not\n> the only case where the compute API defines something but some\n> hypervisor doesn't do it right. What is the \"official\" story about these\n> deviations? I would think that the driver for any hypervisor that is\n> supported in nova core (i.e. can be mentioned by name in nova.conf)\n> needs to honor the core API.\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/939557\n> \n> Title:\n>  Files in vm sometimes zeroed after 'nova reboot'\n> \n> Status in OpenStack Compute (Nova):\n>  Incomplete\n> \n> Bug description:\n>  I really hesitate to report this as a bug because it is so hard to\n>  believe but a user reported it and I can reproduce it.\n> \n>  1. Booted a vm using oneiric-server-cloudimg-amd64 and assigned floating ip\n>  2. Ssh to vm and\n>     sudo apt-get install -y git\n>     git clone git://github.com/rackspace/python-novaclient.git\n>  3. nova reboot\n>  4. Ssh in again. The python-novaclient directory is intact but all the files have zero length\n> \n>  This happens often but not always. I had been using these vms myself\n>  without such a problem.\n> \n>  This was running stable-diablo on oneiric with kvm. I don't now what\n>  info would be more useful but on vm:\n> \n>  ubuntu@buggy:~$ df\n>  Filesystem           1K-blocks      Used Available Use% Mounted on\n>  /dev/vda              10321208    687340   9109592   8% /\n>  devtmpfs               1026112         4   1026108   1% /dev\n>  none                    205648       196    205452   1% /run\n>  none                      5120         0      5120   0% /run/lock\n>  none                   1028228         0   1028228   0% /run/shm\n>  /dev/vdb              20642428    176196  19417656   1% /mnt\n>  ubuntu@buggy:~$ mount\n>  /dev/vda on / type ext4 (rw)\n>  none on /proc type proc (rw,noexec,nosuid,nodev)\n>  none on /sys type sysfs (rw,noexec,nosuid,nodev)\n>  none on /sys/fs/fuse/connections type fusectl (rw)\n>  none on /sys/kernel/debug type debugfs (rw)\n>  none on /sys/kernel/security type securityfs (rw)\n>  devtmpfs on /dev type devtmpfs (rw,mode=0755)\n>  none on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)\n>  none on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)\n>  none on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)\n>  none on /run/shm type tmpfs (rw,nosuid,nodev)\n>  /dev/vdb on /mnt type ext3 (rw)\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/939557/+subscriptions\n\n", 
            "date_created": "2012-02-24 21:24:27+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "There is a comment in the essex code about shutdown not working with kvm. This seems to be relevant:\n\nhttp://wiki.libvirt.org/page/Tips#Debian.2FUbuntu_guests_under_KVM_don.27t_shut_down_properly\n\nIt suggests that if the guest installs a certain package then the shutdown will work.", 
            "date_created": "2012-02-25 21:43:36.372014+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Still seems like we could implement it and just doc the fact that you need guest config for it to work.  They can always use --hard if need be.\n\n\nOn Feb 25, 2012, at 1:43 PM, David Kranz wrote:\n\n> There is a comment in the essex code about shutdown not working with\n> kvm. This seems to be relevant:\n> \n> http://wiki.libvirt.org/page/Tips#Debian.2FUbuntu_guests_under_KVM_don.27t_shut_down_properly\n> \n> It suggests that if the guest installs a certain package then the\n> shutdown will work.\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/939557\n> \n> Title:\n>  Files in vm sometimes zeroed after 'nova reboot'\n> \n> Status in OpenStack Compute (Nova):\n>  Incomplete\n> \n> Bug description:\n>  I really hesitate to report this as a bug because it is so hard to\n>  believe but a user reported it and I can reproduce it.\n> \n>  1. Booted a vm using oneiric-server-cloudimg-amd64 and assigned floating ip\n>  2. Ssh to vm and\n>     sudo apt-get install -y git\n>     git clone git://github.com/rackspace/python-novaclient.git\n>  3. nova reboot\n>  4. Ssh in again. The python-novaclient directory is intact but all the files have zero length\n> \n>  This happens often but not always. I had been using these vms myself\n>  without such a problem.\n> \n>  This was running stable-diablo on oneiric with kvm. I don't now what\n>  info would be more useful but on vm:\n> \n>  ubuntu@buggy:~$ df\n>  Filesystem           1K-blocks      Used Available Use% Mounted on\n>  /dev/vda              10321208    687340   9109592   8% /\n>  devtmpfs               1026112         4   1026108   1% /dev\n>  none                    205648       196    205452   1% /run\n>  none                      5120         0      5120   0% /run/lock\n>  none                   1028228         0   1028228   0% /run/shm\n>  /dev/vdb              20642428    176196  19417656   1% /mnt\n>  ubuntu@buggy:~$ mount\n>  /dev/vda on / type ext4 (rw)\n>  none on /proc type proc (rw,noexec,nosuid,nodev)\n>  none on /sys type sysfs (rw,noexec,nosuid,nodev)\n>  none on /sys/fs/fuse/connections type fusectl (rw)\n>  none on /sys/kernel/debug type debugfs (rw)\n>  none on /sys/kernel/security type securityfs (rw)\n>  devtmpfs on /dev type devtmpfs (rw,mode=0755)\n>  none on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)\n>  none on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)\n>  none on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)\n>  none on /run/shm type tmpfs (rw,nosuid,nodev)\n>  /dev/vdb on /mnt type ext3 (rw)\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/939557/+subscriptions\n\n", 
            "date_created": "2012-02-26 01:13:48+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Vish, I agree. I wonder if the Ubuntu folks consider it a bug that their cloud image does not handle this out-of-the-box?", 
            "date_created": "2012-02-27 18:32:33.937524+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "If it's not a bug, it's at the very least a wanted feature. Let me check with them", 
            "date_created": "2012-02-28 13:13:56.957905+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/4747", 
            "date_created": "2012-03-01 16:09:05.402546+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/4747\nCommitted: http://github.com/openstack/nova/commit/2efb017a06afeb10b474245455310ec21601a701\nSubmitter: Jenkins\nBranch:    master\n\ncommit 2efb017a06afeb10b474245455310ec21601a701\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Wed Feb 29 17:29:02 2012 -0800\n\n    Adds soft-reboot support to libvirt\n    \n     * Falls back to hard reboot if guest doesn't respond\n     * Cleans up reboot/rescue/unrescue interaction\n     * Fixed fake for tests\n     * Added a force hard reboot test to verify fallback works\n     * Fixes bug 939557\n    \n    Change-Id: I8d0c9a35725de5e5bfb8f13a2d869c6122ba44ef\n", 
            "date_created": "2012-03-03 00:53:08.111724+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}