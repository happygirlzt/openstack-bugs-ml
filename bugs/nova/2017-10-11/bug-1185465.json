{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:53:03.939439+00:00", 
    "description": "When using qpid, I see periodic tracebacks like this in various nova logs:\n\n2013-05-26 03:56:03.821 2785 INFO nova.service [-] Caught SIGTERM, exiting\n2013-05-26 03:56:03.831 2785 CRITICAL nova [-] need more than 0 values to unpack\n2013-05-26 03:56:03.831 2785 TRACE nova Traceback (most recent call last):\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/bin/nova-compute\", line 85, in <module>\n2013-05-26 03:56:03.831 2785 TRACE nova     service.wait()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/service.py\", line 69\n6, in wait\n2013-05-26 03:56:03.831 2785 TRACE nova     _launcher.wait()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/service.py\", line 21\n9, in wait\n2013-05-26 03:56:03.831 2785 TRACE nova     rpc.cleanup()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc\n/__init__.py\", line 240, in cleanup\n2013-05-26 03:56:03.831 2785 TRACE nova     return _get_impl().cleanup()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc\n/impl_qpid.py\", line 649, in cleanup\n2013-05-26 03:56:03.831 2785 TRACE nova     return rpc_amqp.cleanup(Connection.pool)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc\n/amqp.py\", line 670, in cleanup\n2013-05-26 03:56:03.831 2785 TRACE nova     connection_pool.empty()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc\n/amqp.py\", line 80, in empty\n2013-05-26 03:56:03.831 2785 TRACE nova     self.get().close()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc\n/impl_qpid.py\", line 386, in close\n2013-05-26 03:56:03.831 2785 TRACE nova     self.connection.close()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"<string>\", line 6, in close\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.\npy\", line 316, in close\n2013-05-26 03:56:03.831 2785 TRACE nova     ssn.close(timeout=timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"<string>\", line 6, in close\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 749, in close\n2013-05-26 03:56:03.831 2785 TRACE nova     if not self._ewait(lambda: self.closed, timeout=timeout):\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 566, in _ewait\n2013-05-26 03:56:03.831 2785 TRACE nova     result = self.connection._ewait(lambda: self.error or predicate(), timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 208, in _ewait\n2013-05-26 03:56:03.831 2785 TRACE nova     result = self._wait(lambda: self.error or predicate(), timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 193, in _wait\n2013-05-26 03:56:03.831 2785 TRACE nova     return self._waiter.wait(predicate, timeout=timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/concurrency.py\", line 57, in wait\n2013-05-26 03:56:03.831 2785 TRACE nova     self.condition.wait(3)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/concurrency.py\", line 96, in wait\n2013-05-26 03:56:03.831 2785 TRACE nova     sw.wait(timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/compat.py\", line 53, in wait\n2013-05-26 03:56:03.831 2785 TRACE nova     ready, _, _ = select([self], [], [], timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova ValueError: need more than 0 values to unpack\n2013-05-26 03:56:03.831 2785 TRACE nova", 
    "tags": [], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1185465", 
    "owner": "https://api.launchpad.net/1.0/~dripton", 
    "id": 1185465, 
    "index": 5773, 
    "created": "2013-05-29 14:41:02.074496+00:00", 
    "title": "Periodic ValueErrors when using qpid", 
    "comments": [
        {
            "content": "When using qpid, I see periodic tracebacks like this in various nova logs:\n\n2013-05-26 03:56:03.821 2785 INFO nova.service [-] Caught SIGTERM, exiting\n2013-05-26 03:56:03.831 2785 CRITICAL nova [-] need more than 0 values to unpack\n2013-05-26 03:56:03.831 2785 TRACE nova Traceback (most recent call last):\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/bin/nova-compute\", line 85, in <module>\n2013-05-26 03:56:03.831 2785 TRACE nova     service.wait()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/service.py\", line 69\n6, in wait\n2013-05-26 03:56:03.831 2785 TRACE nova     _launcher.wait()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/service.py\", line 21\n9, in wait\n2013-05-26 03:56:03.831 2785 TRACE nova     rpc.cleanup()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc\n/__init__.py\", line 240, in cleanup\n2013-05-26 03:56:03.831 2785 TRACE nova     return _get_impl().cleanup()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc\n/impl_qpid.py\", line 649, in cleanup\n2013-05-26 03:56:03.831 2785 TRACE nova     return rpc_amqp.cleanup(Connection.pool)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc\n/amqp.py\", line 670, in cleanup\n2013-05-26 03:56:03.831 2785 TRACE nova     connection_pool.empty()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc\n/amqp.py\", line 80, in empty\n2013-05-26 03:56:03.831 2785 TRACE nova     self.get().close()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc\n/impl_qpid.py\", line 386, in close\n2013-05-26 03:56:03.831 2785 TRACE nova     self.connection.close()\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"<string>\", line 6, in close\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.\npy\", line 316, in close\n2013-05-26 03:56:03.831 2785 TRACE nova     ssn.close(timeout=timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"<string>\", line 6, in close\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 749, in close\n2013-05-26 03:56:03.831 2785 TRACE nova     if not self._ewait(lambda: self.closed, timeout=timeout):\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 566, in _ewait\n2013-05-26 03:56:03.831 2785 TRACE nova     result = self.connection._ewait(lambda: self.error or predicate(), timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 208, in _ewait\n2013-05-26 03:56:03.831 2785 TRACE nova     result = self._wait(lambda: self.error or predicate(), timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 193, in _wait\n2013-05-26 03:56:03.831 2785 TRACE nova     return self._waiter.wait(predicate, timeout=timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/concurrency.py\", line 57, in wait\n2013-05-26 03:56:03.831 2785 TRACE nova     self.condition.wait(3)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/concurrency.py\", line 96, in wait\n2013-05-26 03:56:03.831 2785 TRACE nova     sw.wait(timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova   File \"/usr/lib/python2.6/site-packages/qpid/compat.py\", line 53, in wait\n2013-05-26 03:56:03.831 2785 TRACE nova     ready, _, _ = select([self], [], [], timeout)\n2013-05-26 03:56:03.831 2785 TRACE nova ValueError: need more than 0 values to unpack\n2013-05-26 03:56:03.831 2785 TRACE nova", 
            "date_created": "2013-05-29 14:41:02.074496+00:00", 
            "author": "https://api.launchpad.net/1.0/~dripton"
        }, 
        {
            "content": "The actual bug may be in the python-qpid package, not in Nova proper.  It's unpacking the return value from select(), which it expects to have length 3, but which actually has length 1 for some reason.", 
            "date_created": "2013-05-29 14:43:49.888699+00:00", 
            "author": "https://api.launchpad.net/1.0/~dripton"
        }, 
        {
            "content": "Also seen in http://lists.openstack.org/pipermail/openstack-dev/2013-January/004740.html\n\nI'm not sure why select() is ever returning the wrong number of items, but it would be simple enough to check the length of the return value.\n\nThe code for python-qpid is inside the python directory in the main Apache Qpid svn repository, not a separate project.  (Though some distributions package it separately.)", 
            "date_created": "2013-05-29 16:22:04.651841+00:00", 
            "author": "https://api.launchpad.net/1.0/~dripton"
        }, 
        {
            "content": "Note that it's actually select() from eventlet, since it's monkey_patched", 
            "date_created": "2013-05-31 12:40:48.315295+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "I would actually start by looking into the eventlet code to see if you can find where it be returning nothing.", 
            "date_created": "2013-05-31 12:44:00.138195+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "eventlet.green.select's select only explicitly returns hub.switch(), which is Magic.  It can implicitly return None by falling off the end of the function, but that first invokes two finally blocks that remove all listeners and timers.\n\nBasically, it looks like we're getting an exception from trying to use a dead socket during cleanup.\n\nGetting cleanup timing perfect and race-free across Nova, Oslo, python-qpid, and eventlet is very difficult, and not really worth a lot of effort, since you're shutting down that connection anyway, and software can *never* guarantee clean shutdown.  (No matter how clever your cleanup logic, if I cut power to your CPU before it's done running, you still lose.  Real cleanup has to happen after the next restart, not on shutdown.  Once you're done that, you might as well just always crash hard rather than even trying to clean up on shutdown.  http://en.wikipedia.org/wiki/Crash-only_software )\n\nSo, I think the correct solution is to squelch exceptions during shutdown rather than logging them.  I will propose a patch.", 
            "date_created": "2013-05-31 22:32:33.837132+00:00", 
            "author": "https://api.launchpad.net/1.0/~dripton"
        }, 
        {
            "content": "The change is in oslo-incubator: 15d8d698b7c67", 
            "date_created": "2013-06-03 13:20:33.734437+00:00", 
            "author": "https://api.launchpad.net/1.0/~dripton"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/31496", 
            "date_created": "2013-06-03 13:25:26.426381+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/31496\nCommitted: http://github.com/openstack/nova/commit/361d116d820939207a0b01399c3ce50c7bc30dcd\nSubmitter: Jenkins\nBranch:    master\n\ncommit 361d116d820939207a0b01399c3ce50c7bc30dcd\nAuthor: David Ripton <email address hidden>\nDate:   Mon Jun 3 09:23:13 2013 -0400\n\n    Silence exceptions from qpid connection.close() (from oslo)\n    \n    This is commit 15d8d698b7 in oslo-incubator.\n    \n    Fixes bug 1185465\n    \n    Don't log exceptions that happen during connection.close().  They're\n    not surprising (a closed socket can't be read or written), don't\n    require sysadmin attention, and provide red herrings in the logs\n    to distract from finding real root causes of problems.\n    \n    Change-Id: Ia0e25fbc11094b5ad5d6d2cf7d0e786acb3df1f6\n", 
            "date_created": "2013-06-12 13:37:13.310704+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/grizzly\nReview: https://review.openstack.org/33997", 
            "date_created": "2013-06-21 15:07:48.789337+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/33997\nCommitted: http://github.com/openstack/nova/commit/19fbc29754f72de6c178ba008f2b330ac24ef1c7\nSubmitter: Jenkins\nBranch:    stable/grizzly\n\ncommit 19fbc29754f72de6c178ba008f2b330ac24ef1c7\nAuthor: David Ripton <email address hidden>\nDate:   Mon Jun 3 09:23:13 2013 -0400\n\n    Silence exceptions from qpid connection.close() (from oslo)\n    \n    This is commit 15d8d698b7 in oslo-incubator.\n    \n    Fixes bug 1185465\n    \n    Don't log exceptions that happen during connection.close().  They're\n    not surprising (a closed socket can't be read or written), don't\n    require sysadmin attention, and provide red herrings in the logs\n    to distract from finding real root causes of problems.\n    \n    Change-Id: Ia0e25fbc11094b5ad5d6d2cf7d0e786acb3df1f6\n    (cherry picked from commit 361d116d820939207a0b01399c3ce50c7bc30dcd)\n", 
            "date_created": "2013-07-02 19:29:23.245631+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}