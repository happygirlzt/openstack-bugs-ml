{
    "status": "Expired", 
    "last_updated": "2017-08-23 04:18:37.591139+00:00", 
    "description": "I understand there are code to clean up the instance directory on the target host if the live migration failed, but the directory is not cleanup if libvirt's connection is timeout.\n\nI haven't got a change to root cause the issue, but I feel the code could be optimized a little bit to avoid this issue.\n\nHere is some trace log from my side.\n\n- Libvirt connection timed out\n2017-03-07 02:34:37.540 ERROR nova.virt.libvirt.driver [req-35bc9ca8-c77b-481c-ae3e-93bbfed6187f admin admin] [instance: 6714b056-4950-4e63-83d3-fc383e977a53] Live Migration failure: unable to connect to server at 'ceph-dev:49152': Connection timed out\n2017-03-07 02:34:37.541 DEBUG nova.virt.libvirt.driver [req-35bc9ca8-c77b-481c-ae3e-93bbfed6187f admin admin] [instance: 6714b056-4950-4e63-83d3-fc383e977a53] Migration operation thread notification from (pid=18073) thread_finished /opt/stack/nova/nova/virt/libvirt/driver.py:6361\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 457, in fire_timers\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 58, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 168, in _do_send\n    waiter.switch(result)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/utils.py\", line 1066, in context_wrapper\n    return func(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5962, in _live_migration_operation\n    instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5958, in _live_migration_operation\n    bandwidth=CONF.libvirt.live_migration_bandwidth)\n  File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 605, in migrate\n    flags=flags, bandwidth=bandwidth)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 1586, in migrateToURI2\n    if ret == -1: raise libvirtError ('virDomainMigrateToURI2() failed', dom=self)\n\nlibvirtError: unable to connect to server at 'ceph-dev:49152': Connection timed out\n\n\n- The instance's directory haven't cleanup, and the next migration will fail.\n\nTraceback (most recent call last):\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 133, in _process_incoming\n    res = self.dispatcher.dispatch(message)\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 150, in dispatch\n    return self._do_dispatch(endpoint, method, ctxt, args)\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 121, in _do_dispatch\n    result = func(ctxt, **new_args)\n\n  File \"/opt/stack/nova/nova/exception_wrapper.py\", line 75, in wrapped\n    function_name, call_dict, binary)\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n\n  File \"/opt/stack/nova/nova/exception_wrapper.py\", line 66, in wrapped\n    return f(self, context, *args, **kw)\n\n  File \"/opt/stack/nova/nova/compute/utils.py\", line 613, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 216, in decorated_function\n    kwargs['instance'], e, sys.exc_info())\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 204, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 5192, in pre_live_migration\n    migrate_data)\n\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 6474, in pre_live_migration\n    raise exception.DestinationDiskExists(path=instance_dir)\n\nDestinationDiskExists: The supplied disk path (/opt/stack/data/nova/instances/6714b056-4950-4e63-83d3-fc383e977a53) already exists, it is expected not to exist.", 
    "tags": [
        "live-migration"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1672597", 
    "owner": "None", 
    "id": 1672597, 
    "index": 6726, 
    "created": "2017-03-14 03:33:47.839670+00:00", 
    "title": "[live migration] The  instance directory on the destination host is not clean up", 
    "comments": [
        {
            "content": "I understand there are code to clean up the instance directory on the target host if the live migration failed, but the directory is not cleanup if libvirt's connection is timeout.\n\nI haven't got a change to root cause the issue, but I feel the code could be optimized a little bit to avoid this issue.\n\nHere is some trace log from my side.\n\n- Libvirt connection timed out\n2017-03-07 02:34:37.540 ERROR nova.virt.libvirt.driver [req-35bc9ca8-c77b-481c-ae3e-93bbfed6187f admin admin] [instance: 6714b056-4950-4e63-83d3-fc383e977a53] Live Migration failure: unable to connect to server at 'ceph-dev:49152': Connection timed out\n2017-03-07 02:34:37.541 DEBUG nova.virt.libvirt.driver [req-35bc9ca8-c77b-481c-ae3e-93bbfed6187f admin admin] [instance: 6714b056-4950-4e63-83d3-fc383e977a53] Migration operation thread notification from (pid=18073) thread_finished /opt/stack/nova/nova/virt/libvirt/driver.py:6361\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 457, in fire_timers\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 58, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 168, in _do_send\n    waiter.switch(result)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/utils.py\", line 1066, in context_wrapper\n    return func(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5962, in _live_migration_operation\n    instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5958, in _live_migration_operation\n    bandwidth=CONF.libvirt.live_migration_bandwidth)\n  File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 605, in migrate\n    flags=flags, bandwidth=bandwidth)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 1586, in migrateToURI2\n    if ret == -1: raise libvirtError ('virDomainMigrateToURI2() failed', dom=self)\n\nlibvirtError: unable to connect to server at 'ceph-dev:49152': Connection timed out\n\n\n- The instance's directory haven't cleanup, and the next migration will fail.\n\nTraceback (most recent call last):\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 133, in _process_incoming\n    res = self.dispatcher.dispatch(message)\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 150, in dispatch\n    return self._do_dispatch(endpoint, method, ctxt, args)\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 121, in _do_dispatch\n    result = func(ctxt, **new_args)\n\n  File \"/opt/stack/nova/nova/exception_wrapper.py\", line 75, in wrapped\n    function_name, call_dict, binary)\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n\n  File \"/opt/stack/nova/nova/exception_wrapper.py\", line 66, in wrapped\n    return f(self, context, *args, **kw)\n\n  File \"/opt/stack/nova/nova/compute/utils.py\", line 613, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 216, in decorated_function\n    kwargs['instance'], e, sys.exc_info())\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 204, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 5192, in pre_live_migration\n    migrate_data)\n\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 6474, in pre_live_migration\n    raise exception.DestinationDiskExists(path=instance_dir)\n\nDestinationDiskExists: The supplied disk path (/opt/stack/data/nova/instances/6714b056-4950-4e63-83d3-fc383e977a53) already exists, it is expected not to exist.", 
            "date_created": "2017-03-14 03:33:47.839670+00:00", 
            "author": "https://api.launchpad.net/1.0/~wei-d-chen"
        }, 
        {
            "content": "Hello, could you please specify Openstack version you are using and I assume that there is a ceph rbd as a backend? Is that right?\nMarking this as incomplete for now", 
            "date_created": "2017-03-28 08:45:47.207838+00:00", 
            "author": "https://api.launchpad.net/1.0/~tdurakov"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2017-08-23 04:18:35.000128+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ]
}