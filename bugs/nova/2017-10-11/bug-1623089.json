{
    "status": "Fix Released", 
    "last_updated": "2017-05-30 16:05:18.279789+00:00", 
    "description": "Description\n===========\n\nSuspending a guest with direct-physical ports (PCI passthrough) is failing and the guest is set in error. \n\nSteps to reproduce\n==================\n\n1) NETID=`neutron net-list | grep private | awk '{print $2}'`\n2) PORTID=`neutron port-create $NETID --name sriov_port --binding:vnic_type direct-physical | grep \"\\ id\\ \" | awk '{ print $4 }'`\n3) nova boot test --image=cirros-0.3.4-x86_64-uec  --nic port-id=$PORTID --flavor=m1.small\n4) nova suspend test\n\nExpected result\n===============\n\nInstance is successfully suspended.\n\nActual result\n=============\n\nInstance is put in error.\n\nStack trace:\n\n2016-09-13 09:23:22.724 ERROR nova.compute.manager [req-ca82e24d-fc99-42c8-8bea-18e1c7185282 demo demo] [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1] Setting instance vm_state to ERROR\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1] Traceback (most recent call last):\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/opt/stack/nova/nova/compute/manager.py\", line 6571, in _error_out_instance_on_exception\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     yield\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/opt/stack/nova/nova/compute/manager.py\", line 4113, in suspend_instance\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     self.driver.suspend(context, instance)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2435, in suspend\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     guest.save_memory_state()\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 426, in save_memory_state\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     self._domain.managedSave(0)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 186, in doit\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 144, in proxy_call\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     rv = execute(f, *args, **kwargs)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 125, in execute\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     six.reraise(c, e, tb)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 83, in tworker\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     rv = meth(*args, **kwargs)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1397, in managedSave\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     if ret == -1: raise libvirtError ('virDomainManagedSave() failed', dom=self)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1] libvirtError: Requested operation is not valid: domain has assigned non-USB host devices\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]\n\nEnvironment\n===========\n\ncommit 5b207f9a1376b5edda9d4900ccadc4980d26dd1f\nMerge: ba718e3 f5b7a33\nAuthor: Jenkins <email address hidden>\nDate:   Tue Sep 13 01:46:47 2016 +0000\n\n    Merge \"Example & Parameter verification of os-security-group-default-rules.inc\"", 
    "tags": [
        "pci"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1623089", 
    "owner": "https://api.launchpad.net/1.0/~ludovic-beliveau", 
    "id": 1623089, 
    "index": 4625, 
    "created": "2016-09-13 15:19:31.890966+00:00", 
    "title": "Fail to suspend guest with direct-physical ports", 
    "comments": [
        {
            "content": "Description\n===========\n\nSuspending a guest with direct-physical ports (PCI passthrough) is failing and the guest is set in error. \n\nSteps to reproduce\n==================\n\n1) NETID=`neutron net-list | grep private | awk '{print $2}'`\n2) PORTID=`neutron port-create $NETID --name sriov_port --binding:vnic_type direct-physical | grep \"\\ id\\ \" | awk '{ print $4 }'`\n3) nova boot test --image=cirros-0.3.4-x86_64-uec  --nic port-id=$PORTID --flavor=m1.small\n4) nova suspend test\n\nExpected result\n===============\n\nInstance is successfully suspended.\n\nActual result\n=============\n\nInstance is put in error.\n\nStack trace:\n\n2016-09-13 09:23:22.724 ERROR nova.compute.manager [req-ca82e24d-fc99-42c8-8bea-18e1c7185282 demo demo] [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1] Setting instance vm_state to ERROR\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1] Traceback (most recent call last):\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/opt/stack/nova/nova/compute/manager.py\", line 6571, in _error_out_instance_on_exception\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     yield\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/opt/stack/nova/nova/compute/manager.py\", line 4113, in suspend_instance\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     self.driver.suspend(context, instance)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2435, in suspend\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     guest.save_memory_state()\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 426, in save_memory_state\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     self._domain.managedSave(0)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 186, in doit\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 144, in proxy_call\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     rv = execute(f, *args, **kwargs)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 125, in execute\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     six.reraise(c, e, tb)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 83, in tworker\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     rv = meth(*args, **kwargs)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]   File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1397, in managedSave\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]     if ret == -1: raise libvirtError ('virDomainManagedSave() failed', dom=self)\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1] libvirtError: Requested operation is not valid: domain has assigned non-USB host devices\n2016-09-13 09:23:22.724 TRACE nova.compute.manager [instance: 6b069ca8-4bb8-4781-93a7-7d58cf8122a1]\n\nEnvironment\n===========\n\ncommit 5b207f9a1376b5edda9d4900ccadc4980d26dd1f\nMerge: ba718e3 f5b7a33\nAuthor: Jenkins <email address hidden>\nDate:   Tue Sep 13 01:46:47 2016 +0000\n\n    Merge \"Example & Parameter verification of os-security-group-default-rules.inc\"", 
            "date_created": "2016-09-13 15:19:31.890966+00:00", 
            "author": "https://api.launchpad.net/1.0/~ludovic-beliveau"
        }, 
        {
            "content": "Fix proposed:\nhttps://review.openstack.org/#/c/369556/", 
            "date_created": "2016-09-13 16:16:27.693439+00:00", 
            "author": "https://api.launchpad.net/1.0/~ludovic-beliveau"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/369556\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8568cb4ce162661f2e9bab4524e4f5adb299549c\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8568cb4ce162661f2e9bab4524e4f5adb299549c\nAuthor: Ludovic Beliveau <email address hidden>\nDate:   Tue Sep 13 12:00:16 2016 -0400\n\n    Fixed suspend for PCI passthrough\n    \n    The VNIC_TYPE_DIRECT_PHYSICAL was being ignored by the _has_sriov_port()\n    method.\n    \n    The fix is to also check for VNIC_TYPE_DIRECT_PHYSICAL so that PF\n    devices are unplugged.\n    \n    Change-Id: I8ccc5b30ccdbd16a90165a4a8a33e081ae23736c\n    Closes-Bug: #1623089\n", 
            "date_created": "2016-09-20 11:09:41.368516+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b1 development milestone.", 
            "date_created": "2016-11-17 13:14:19.956432+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/462503", 
            "date_created": "2017-05-04 11:23:39.870394+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/462503\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b4bbe68e279aa94aa71aef1a3879d42bf90d3170\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit b4bbe68e279aa94aa71aef1a3879d42bf90d3170\nAuthor: Ludovic Beliveau <email address hidden>\nDate:   Tue Sep 13 12:00:16 2016 -0400\n\n    Fixed suspend for PCI passthrough\n    \n    The VNIC_TYPE_DIRECT_PHYSICAL was being ignored by the _has_sriov_port()\n    method.\n    \n    The fix is to also check for VNIC_TYPE_DIRECT_PHYSICAL so that PF\n    devices are unplugged.\n    \n    Change-Id: I8ccc5b30ccdbd16a90165a4a8a33e081ae23736c\n    Closes-Bug: #1623089\n    (cherry picked from commit 8568cb4ce162661f2e9bab4524e4f5adb299549c)\n", 
            "date_created": "2017-05-26 04:54:23.284641+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.7 release.", 
            "date_created": "2017-05-30 16:05:17.368740+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}