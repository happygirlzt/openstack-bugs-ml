{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:10:48.241092+00:00", 
    "description": "From http://logs.openstack.org/70/113270/3/check/gate-nova-python26/038b3fa/console.html:\n\n2014-08-21 20:08:33.507 | Traceback (most recent call last):\n2014-08-21 20:08:33.507 |   File \"nova/tests/conductor/test_conductor.py\", line 1343, in test_build_instances_scheduler_failure\n2014-08-21 20:08:33.507 |     legacy_bdm=False)\n2014-08-21 20:08:33.507 |   File \"nova/conductor/rpcapi.py\", line 415, in build_instances\n2014-08-21 20:08:33.507 |     cctxt.cast(context, 'build_instances', **kw)\n2014-08-21 20:08:33.508 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/client.py\", line 152, in call\n2014-08-21 20:08:33.508 |     retry=self.retry)\n2014-08-21 20:08:33.508 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-08-21 20:08:33.508 |     timeout=timeout, retry=retry)\n2014-08-21 20:08:33.508 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/_drivers/impl_fake.py\", line 194, in send\n2014-08-21 20:08:33.508 |     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2014-08-21 20:08:33.508 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/_drivers/impl_fake.py\", line 181, in _send\n2014-08-21 20:08:33.508 |     raise failure\n2014-08-21 20:08:33.509 | UnexpectedMethodCallError: Unexpected method call.  unexpected:-  expected:+\n2014-08-21 20:15:52.443 | - handle_schedule_error.__call__(<nova.tests.conductor.test_conductor.FakeContext object at 0xc19a3d0>, NoValidHost(u'No valid host was found. fake-reason',), '8eb9d649-0985-43libvir:  error : internal error could not initialize domain event timer\n2014-08-21 20:16:46.065 | Exception TypeError: \"'NoneType' object is not callable\" in <bound method GreenSocket.__del__ of <eventlet.greenio.GreenSocket object at 0xdc5bd10>> ignored\n2014-08-21 20:19:45.254 | 50-8946-570ce100534c', {'instance_properties': Instance(access_ip_v4=None,access_ip_v6=None,architecture=None,auto_disk_config=False,availability_zone=None,cell_name=None,cleaned=False,config_drive=None,created_at=1955-11-05T00:00:00Z,default_ephemeral_device=None,default_swap_device=None,deleted=False,deleted_at=None,disable_terminate=False,display_description=None,display_name=None,ephemeral_gb=0,ephemeral_key_uuid=None,fault=<?>,host='fake-host',hostname=None,id=1,image_ref=None,info_cache=<?>,instance_type_id=None,kernel_id=None,key_data=None,key_name=None,launch_index=None,launched_at=None,launched_on=None,locked=False,locked_by=None,memory_mb=None,metadata=<?>,node=None,os_type=None,pci_devices=<?>,power_state=None,progress=None,project_id='fake-project',ramdisk_id=None,reservation_id=None,root_device_name=None,root_gb=0,scheduled_at=None,security_groups=<?>,shutdown_terminate=False,system_metadata=<?>,task_state=None,terminated_at=None,updated_at=None,user_data=None,user_id='fake-user',uuid=8eb9d649-0985-4350-8946-570ce100534c,vcpus=None,vm_mode=None,vm_state=None), 'fake': 'specs'}) -> None\n2014-08-21 20:19:45.254 | + handle_schedule_error.__call__(<nova.tests.conductor.test_conductor.FakeContext object at 0xc19a3d0>, NoValidHost(u'No valid host was found. fake-reason',), '712006a3-7ca5-4350-8f7f-028a9e4c78b2', {'instance_properties': Instance(access_ip_v4=None,access_ip_v6=None,architecture=None,auto_disk_config=False,availability_zone=None,cell_name=None,cleaned=False,config_drive=None,created_at=1955-11-05T00:00:00Z,default_ephemeral_device=None,default_swap_device=None,deleted=False,deleted_at=None,disable_terminate=False,display_description=None,display_name=None,ephemeral_gb=0,ephemeral_key_uuid=None,fault=<?>,host='fake-host',hostname=None,id=1,image_ref=None,info_cache=<?>,instance_type_id=None,kernel_id=None,key_data=None,key_name=None,launch_index=None,launched_at=None,launched_on=None,locked=False,locked_by=None,memory_mb=None,metadata=<?>,node=None,os_type=None,pci_devices=<?>,power_state=None,progress=None,project_id='fake-project',ramdisk_id=None,reservation_id=None,root_device_name=None,root_gb=0,scheduled_at=None,security_groups=<?>,shutdown_terminate=False,system_metadata=<?>,task_state=None,terminated_at=None,updated_at=None,user_data=None,user_id='fake-user',uuid=8eb9d649-0985-4350-8946-570ce100534c,vcpus=None,vm_mode=None,vm_state=None), 'fake': 'specs'}) -> None", 
    "tags": [
        "compute", 
        "conductor", 
        "testing"
    ], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1360320", 
    "owner": "None", 
    "id": 1360320, 
    "index": 1578, 
    "created": "2014-08-22 15:21:54.312235+00:00", 
    "title": "Unit tests fail in handle_schedule_error with wrong instance", 
    "comments": [
        {
            "content": "From http://logs.openstack.org/70/113270/3/check/gate-nova-python26/038b3fa/console.html:\n\n2014-08-21 20:08:33.507 | Traceback (most recent call last):\n2014-08-21 20:08:33.507 |   File \"nova/tests/conductor/test_conductor.py\", line 1343, in test_build_instances_scheduler_failure\n2014-08-21 20:08:33.507 |     legacy_bdm=False)\n2014-08-21 20:08:33.507 |   File \"nova/conductor/rpcapi.py\", line 415, in build_instances\n2014-08-21 20:08:33.507 |     cctxt.cast(context, 'build_instances', **kw)\n2014-08-21 20:08:33.508 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/rpc/client.py\", line 152, in call\n2014-08-21 20:08:33.508 |     retry=self.retry)\n2014-08-21 20:08:33.508 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-08-21 20:08:33.508 |     timeout=timeout, retry=retry)\n2014-08-21 20:08:33.508 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/_drivers/impl_fake.py\", line 194, in send\n2014-08-21 20:08:33.508 |     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2014-08-21 20:08:33.508 |   File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/oslo/messaging/_drivers/impl_fake.py\", line 181, in _send\n2014-08-21 20:08:33.508 |     raise failure\n2014-08-21 20:08:33.509 | UnexpectedMethodCallError: Unexpected method call.  unexpected:-  expected:+\n2014-08-21 20:15:52.443 | - handle_schedule_error.__call__(<nova.tests.conductor.test_conductor.FakeContext object at 0xc19a3d0>, NoValidHost(u'No valid host was found. fake-reason',), '8eb9d649-0985-43libvir:  error : internal error could not initialize domain event timer\n2014-08-21 20:16:46.065 | Exception TypeError: \"'NoneType' object is not callable\" in <bound method GreenSocket.__del__ of <eventlet.greenio.GreenSocket object at 0xdc5bd10>> ignored\n2014-08-21 20:19:45.254 | 50-8946-570ce100534c', {'instance_properties': Instance(access_ip_v4=None,access_ip_v6=None,architecture=None,auto_disk_config=False,availability_zone=None,cell_name=None,cleaned=False,config_drive=None,created_at=1955-11-05T00:00:00Z,default_ephemeral_device=None,default_swap_device=None,deleted=False,deleted_at=None,disable_terminate=False,display_description=None,display_name=None,ephemeral_gb=0,ephemeral_key_uuid=None,fault=<?>,host='fake-host',hostname=None,id=1,image_ref=None,info_cache=<?>,instance_type_id=None,kernel_id=None,key_data=None,key_name=None,launch_index=None,launched_at=None,launched_on=None,locked=False,locked_by=None,memory_mb=None,metadata=<?>,node=None,os_type=None,pci_devices=<?>,power_state=None,progress=None,project_id='fake-project',ramdisk_id=None,reservation_id=None,root_device_name=None,root_gb=0,scheduled_at=None,security_groups=<?>,shutdown_terminate=False,system_metadata=<?>,task_state=None,terminated_at=None,updated_at=None,user_data=None,user_id='fake-user',uuid=8eb9d649-0985-4350-8946-570ce100534c,vcpus=None,vm_mode=None,vm_state=None), 'fake': 'specs'}) -> None\n2014-08-21 20:19:45.254 | + handle_schedule_error.__call__(<nova.tests.conductor.test_conductor.FakeContext object at 0xc19a3d0>, NoValidHost(u'No valid host was found. fake-reason',), '712006a3-7ca5-4350-8f7f-028a9e4c78b2', {'instance_properties': Instance(access_ip_v4=None,access_ip_v6=None,architecture=None,auto_disk_config=False,availability_zone=None,cell_name=None,cleaned=False,config_drive=None,created_at=1955-11-05T00:00:00Z,default_ephemeral_device=None,default_swap_device=None,deleted=False,deleted_at=None,disable_terminate=False,display_description=None,display_name=None,ephemeral_gb=0,ephemeral_key_uuid=None,fault=<?>,host='fake-host',hostname=None,id=1,image_ref=None,info_cache=<?>,instance_type_id=None,kernel_id=None,key_data=None,key_name=None,launch_index=None,launched_at=None,launched_on=None,locked=False,locked_by=None,memory_mb=None,metadata=<?>,node=None,os_type=None,pci_devices=<?>,power_state=None,progress=None,project_id='fake-project',ramdisk_id=None,reservation_id=None,root_device_name=None,root_gb=0,scheduled_at=None,security_groups=<?>,shutdown_terminate=False,system_metadata=<?>,task_state=None,terminated_at=None,updated_at=None,user_data=None,user_id='fake-user',uuid=8eb9d649-0985-4350-8946-570ce100534c,vcpus=None,vm_mode=None,vm_state=None), 'fake': 'specs'}) -> None", 
            "date_created": "2014-08-22 15:21:54.312235+00:00", 
            "author": "https://api.launchpad.net/1.0/~danms"
        }, 
        {
            "content": "Yeah the diff is in the instance.uuid that's expected, from the test, it mocks out handle_schedule_error:\n\nself.mox.StubOutWithMock(scheduler_driver, 'handle_schedule_error')\n\nIt's trying to build 2 instances and handle errors for both:\n\n        for instance in instances:\n            scheduler_driver.handle_schedule_error(self.context, exception,\n                    instance.uuid, spec)\n\nThis is going through the now-deprecated _build_instances method in nova.compute.manager, which was updated recently to not call _instance_update:\n\nhttps://review.openstack.org/#/c/114033/\n\nI'm not really sure how that would cause issues, unless it was slowing the test down before so we didn't race, or was changing the database differently?\n\nUsing this query:\n\nmessage:\"+ handle_schedule_error.__call__\" AND message:\"nova.tests.conductor.test_conductor.FakeContext object at\" AND message:\"No valid host was found. fake-reason\" AND tags:\"console\" AND project:\"openstack/nova\"\n\nThere are 14 hits since 8/21, check queue only and on 2 changes:\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJtZXNzYWdlOlwiKyBoYW5kbGVfc2NoZWR1bGVfZXJyb3IuX19jYWxsX19cIiBBTkQgbWVzc2FnZTpcIm5vdmEudGVzdHMuY29uZHVjdG9yLnRlc3RfY29uZHVjdG9yLkZha2VDb250ZXh0IG9iamVjdCBhdFwiIEFORCBtZXNzYWdlOlwiTm8gdmFsaWQgaG9zdCB3YXMgZm91bmQuIGZha2UtcmVhc29uXCIgQU5EIHRhZ3M6XCJjb25zb2xlXCIgQU5EIHByb2plY3Q6XCJvcGVuc3RhY2svbm92YVwiIiwiZmllbGRzIjpbXSwib2Zmc2V0IjowLCJ0aW1lZnJhbWUiOiI2MDQ4MDAiLCJncmFwaG1vZGUiOiJjb3VudCIsInRpbWUiOnsidXNlcl9pbnRlcnZhbCI6MH0sInN0YW1wIjoxNDA4NzIwMTI4NDQyLCJtb2RlIjoiIiwiYW5hbHl6ZV9maWVsZCI6IiJ9\n\nOne of those changes is an objects change, the other isn't, so this is probably something that is already merged.", 
            "date_created": "2014-08-22 15:36:16.767937+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I'm seeing a lot of tests running concurrently through the same code paths at the same time when looking through the subunit logs.  There are several cases of InstanceNotFound when scheduler_driver.handle_schedule_error is called and this is run on the instance uuid:\n\n    (old_ref, new_ref) = db.instance_update_and_get_original(context,\n            instance_uuid, {'vm_state': vm_states.ERROR,\n                            'task_state': None})\n\nI don't see anything in nova.conductor.manager.build_instance that handles that, so maybe those are just from negative unit tests?\n\nWhen you check the subunit logs for the instance.uuid that is expected to be passed to handle_schedule_error, it doesn't show up anywhere else.\n\nIf you check the instance.uuid from the 'unexpected' call though, it's the instance object mapped to 'instance_properties' in the spec passed to build_request_spec, and in the test that's the first instance created (of the 2):\n\n    def test_build_instances_scheduler_failure(self):\n        instances = [fake_instance.fake_instance_obj(self.context)\n                for i in xrange(2)]\n        image = {'fake-data': 'should_pass_silently'}\n        spec = {'fake': 'specs',\n                'instance_properties': instances[0]}\n\nSo it looks like the test is expecting handle_schedule_error to be called with the 2nd instance but it's getting the first, I'm not sure why, but maybe order isn't important in how handle_schedule_error is called as long as it's called on each instance.", 
            "date_created": "2014-08-22 16:10:27.219905+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Maybe this is racing with things that are racing in the shelve tests, i.e. bug 1353654.  These could all be races related to the fact that the test_keypairs, test_shelve, test_conductor and test_compute tests are all extending from a common base class in nova.tests.compute.test_compute.BaseTestCase, and there are 3 conductor task test classes running at the same time.\n\nI wouldn't think concurrent runs would be an issue since those should be in separate processes, but they are all hitting the database for their instances and mocking out different things so maybe the database is getting wonky somehow.  In this case there are 7 workers.\n\nThis might be totally unrelated as well, but there are 19 instances of this in the subunit logs:\n\nTraceback (most recent call last):\n  File \"nova/quota.py\", line 1326, in commit\n    user_id=user_id)\n  File \"nova/quota.py\", line 569, in commit\n    user_id=user_id)\n  File \"nova/db/api.py\", line 1148, in reservation_commit\n    user_id=user_id)\n  File \"nova/db/sqlalchemy/api.py\", line 167, in wrapper\n    return f(*args, **kwargs)\n  File \"nova/db/sqlalchemy/api.py\", line 205, in wrapped\n    return f(*args, **kwargs)\n  File \"nova/db/sqlalchemy/api.py\", line 3299, in reservation_commit\n    context, session, project_id, user_id)\n  File \"nova/db/sqlalchemy/api.py\", line 3057, in _get_project_user_quota_usages\n    with_lockmode('update').\\\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/orm/query.py\", line 2300, in all\n    return list(self)\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/orm/query.py\", line 2412, in __iter__\n    return self._execute_and_instances(context)\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/orm/query.py\", line 2427, in _execute_and_instances\n    result = conn.execute(querycontext.statement, self._params)\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/engine/base.py\", line 729, in execute\n    return meth(self, multiparams, params)\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/sql/elements.py\", line 321, in _execute_on_connection\n    return connection._execute_clauseelement(self, multiparams, params)\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/engine/base.py\", line 826, in _execute_clauseelement\n    compiled_sql, distilled_params\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/engine/base.py\", line 958, in _execute_context\n    context)\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/engine/base.py\", line 1160, in _handle_dbapi_exception\n    exc_info\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/util/compat.py\", line 199, in raise_from_cause\n    reraise(type(exception), exception, tb=exc_tb)\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/engine/base.py\", line 951, in _execute_context\n    context)\n  File \"/home/jenkins/workspace/gate-nova-python26/.tox/py26/lib/python2.6/site-packages/sqlalchemy/engine/default.py\", line 436, in do_execute\n    cursor.execute(statement, parameters)\nOperationalError: (OperationalError) no such table: quota_usages u'SELECT quota_usages.created_at AS quota_usages_created_at, quota_usages.updated_at AS quota_usages_updated_at, quota_usages.deleted_at AS quota_usages_deleted_at, quota_usages.deleted AS quota_usages_deleted, quota_usages.id AS quota_usages_id, quota_usages.project_id AS quota_usages_project_id, quota_usages.user_id AS quota_usages_user_id, quota_usages.resource AS quota_usages_resource, quota_usages.in_use AS quota_usages_in_use, quota_usages.reserved AS quota_usages_reserved, quota_usages.until_refresh AS quota_usages_until_refresh \\nFROM quota_usages \\nWHERE quota_usages.deleted = ? AND quota_usages.project_id = ?' (0, 'fake')\n\nThat's when the conductor and cells tests are running.", 
            "date_created": "2014-08-22 16:31:57.763266+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Just saw this again", 
            "date_created": "2014-09-27 01:25:56.277024+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "http://logs.openstack.org//33/112733/10/gate/gate-nova-python26/37662c3/console.html#_2014-09-27_01_12_11_565", 
            "date_created": "2014-09-27 01:26:06.725220+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Possible fix: https://review.openstack.org/122726", 
            "date_created": "2014-10-05 22:13:16.090707+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanlind"
        }, 
        {
            "content": "not seeing nova unit tests fail in the gate anymore so this looks like was fixed somehow.", 
            "date_created": "2014-12-10 22:21:49.522216+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }
    ]
}