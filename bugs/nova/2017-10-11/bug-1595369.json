{
    "status": "Confirmed", 
    "last_updated": "2017-06-27 16:01:27.949882+00:00", 
    "description": "Description\n===========\nin schedule/manager.py\nThe task _expire_reservations did not have a control for the schedule time.\nThe default would be 60s.\nAnd we need a parameter to disable the task or to control the interval time for schedules.\n\n\nSteps to reproduce\n==================\nIn the latest source code:\n\n    @periodic_task.periodic_task\n    def _expire_reservations(self, context):\n        QUOTAS.expire(context)\n\n    @periodic_task.periodic_task(spacing=CONF.scheduler_driver_task_period,\n                                 run_immediately=True)\n    def _run_periodic_tasks(self, context):\n        self.driver.run_periodic_tasks(context)\n\n\nExpected result\n===============\nwe need to control the time for the schedule of _expire_reservations\n\nActual result\n=============\nThe schedule run as 60s per time. And even if we set the parameter scheduler_driver_task_period to 60000, it would still run every time.\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n  list for all releases: http://docs.openstack.org/releases/\n\n   If this is from a distro please provide\ndpkg -l | grep nova\nii  nova-api                            2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - API frontend\nii  nova-cert                           2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - certificate management\nii  nova-common                         2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - common files\nii  nova-compute                        2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - compute node base\nii  nova-compute-kvm                    2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - compute node (KVM)\nii  nova-compute-libvirt                2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - compute node libvirt support\nii  nova-conductor                      2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - conductor service\nii  nova-consoleauth                    2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - Console Authenticator\nii  nova-novncproxy                     2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - NoVNC proxy\nii  nova-scheduler                      2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - virtual machine scheduler\nii  python-nova                         2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute Python libraries\nii  python-novaclient                   2:2.30.1-1~cloud0                     all          client library for OpenStack Compute API\n\n2. Which hypervisor did you use?\nKVM\n\n2. Which storage type did you use?\nLVM\n\n3. Which networking type did you use?\nNeutron with OpenVSwitch\n\nLogs & Configs\n==============\n2016-06-23 10:35:01.714 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._expire_reservations run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:35:12.427 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._run_periodic_tasks run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:36:01.715 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._expire_reservations run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:36:12.428 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._run_periodic_tasks run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:37:01.715 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._expire_reservations run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:37:14.419 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._run_periodic_tasks run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:38:02.714 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._expire_reservations run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:38:14.419 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._run_periodic_tasks run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n\nThanks.", 
    "tags": [
        "config", 
        "openstack-version.liberty"
    ], 
    "importance": "Low", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1595369", 
    "owner": "None", 
    "id": 1595369, 
    "index": 759, 
    "created": "2016-06-23 02:39:18.855290+00:00", 
    "title": "no spacing configuration for schedule _expire_reservations", 
    "comments": [
        {
            "content": "Description\n===========\nin schedule/manager.py\nThe task _expire_reservations did not have a control for the schedule time.\nThe default would be 60s.\nAnd we need a parameter to disable the task or to control the interval time for schedules.\n\n\nSteps to reproduce\n==================\nIn the latest source code:\n\n    @periodic_task.periodic_task\n    def _expire_reservations(self, context):\n        QUOTAS.expire(context)\n\n    @periodic_task.periodic_task(spacing=CONF.scheduler_driver_task_period,\n                                 run_immediately=True)\n    def _run_periodic_tasks(self, context):\n        self.driver.run_periodic_tasks(context)\n\n\nExpected result\n===============\nwe need to control the time for the schedule of _expire_reservations\n\nActual result\n=============\nThe schedule run as 60s per time. And even if we set the parameter scheduler_driver_task_period to 60000, it would still run every time.\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n  list for all releases: http://docs.openstack.org/releases/\n\n   If this is from a distro please provide\ndpkg -l | grep nova\nii  nova-api                            2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - API frontend\nii  nova-cert                           2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - certificate management\nii  nova-common                         2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - common files\nii  nova-compute                        2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - compute node base\nii  nova-compute-kvm                    2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - compute node (KVM)\nii  nova-compute-libvirt                2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - compute node libvirt support\nii  nova-conductor                      2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - conductor service\nii  nova-consoleauth                    2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - Console Authenticator\nii  nova-novncproxy                     2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - NoVNC proxy\nii  nova-scheduler                      2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute - virtual machine scheduler\nii  python-nova                         2:12.0.3-0ubuntu1~cloud0              all          OpenStack Compute Python libraries\nii  python-novaclient                   2:2.30.1-1~cloud0                     all          client library for OpenStack Compute API\n\n2. Which hypervisor did you use?\nKVM\n\n2. Which storage type did you use?\nLVM\n\n3. Which networking type did you use?\nNeutron with OpenVSwitch\n\nLogs & Configs\n==============\n2016-06-23 10:35:01.714 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._expire_reservations run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:35:12.427 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._run_periodic_tasks run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:36:01.715 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._expire_reservations run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:36:12.428 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._run_periodic_tasks run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:37:01.715 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._expire_reservations run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:37:14.419 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._run_periodic_tasks run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:38:02.714 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._expire_reservations run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n2016-06-23 10:38:14.419 112316 DEBUG oslo_service.periodic_task [req-0167a2d5-0dd2-44e7-82b6-8907dc0b4c0b - - - - -] Running periodic task SchedulerManager._run_periodic_tasks run_periodic_tasks /usr/lib/python2.7/dist-packages/oslo_service/periodic_task.py:213\n\nThanks.", 
            "date_created": "2016-06-23 02:39:18.855290+00:00", 
            "author": "https://api.launchpad.net/1.0/~caijinr"
        }, 
        {
            "content": "According to oslo.config, if the spacing value is negative it will not run the task. https://github.com/openstack/oslo.service/blob/master/oslo_service/periodic_task.py#L52-L53\n\nI added a exit statement to the run_periodic tasks to verify the actual execution of the task.\n\n    @periodic_task.periodic_task(spacing=CONF.scheduler_driver_task_period,\n                                 run_immediately=True)\n    def _run_periodic_tasks(self, context):\n        import sys; sys.exit()\n        self.driver.run_periodic_tasks(context)\n\nAfter one minute the process stopped as expected as soon as \"Running periodic task SchedulerManager._expire_reservations\" was logged. \n\nI added the setting in nova.conf for scheduler_driver_task_period with value 5, and it still exited after 5 seconds immediatelly after logging \"Running periodic task SchedulerManager._expire_reservations\", so the time interval change worked.\n\nI then changed the value to -1, and let it run for a couple of minutes. \"Running periodic task SchedulerManager._expire_reservations\" was still logged, but the process didn't actually exit, so the task didn't actually run.\n\n", 
            "date_created": "2016-07-08 19:51:56.122710+00:00", 
            "author": "https://api.launchpad.net/1.0/~knikolla"
        }, 
        {
            "content": "\nThere are no currently open reviews on this bug, changing\nthe status back to the previous state and unassigning. If\nthere are active reviews related to this bug, please include\nlinks in comments.\n", 
            "date_created": "2017-06-23 12:38:21.320557+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Automatically discovered version liberty in description. If this is incorrect, please update the description to include 'nova version: ...'", 
            "date_created": "2017-06-27 16:01:27.388721+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}