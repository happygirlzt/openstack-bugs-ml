{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:50:59.778076+00:00", 
    "description": "When we  try to boot multi instances from volume (with a  large image source)  at the same time,  we usually got a block device allocate error as the logs in nova-compute.log:\n\n2015-03-30 23:22:46.920 6445 WARNING nova.compute.manager [-] Volume id: 551ea616-e1c4-4ef2-9bf3-b0ca6d4474dc finished being created but was not set as 'available'\n2015-03-30 23:22:47.131 6445 ERROR nova.compute.manager [-] [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6] Instance failed block device setup\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6] Traceback (most recent call last):\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1829, in _prep_block_device\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     do_check_attach=do_check_attach) +\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/virt/block_device.py\", line 407, in attach_block_devices\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     map(_log_and_attach, block_device_mapping)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/virt/block_device.py\", line 405, in _log_and_attach\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     bdm.attach(*attach_args, **attach_kwargs)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/virt/block_device.py\", line 339, in attach\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     do_check_attach=do_check_attach)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/virt/block_device.py\", line 46, in wrapped\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     ret_val = method(obj, context, *args, **kwargs)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/virt/block_device.py\", line 229, in attach\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     volume_api.check_attach(context, volume, instance=instance)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/volume/cinder.py\", line 305, in check_attach\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     raise exception.InvalidVolume(reason=msg)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6] InvalidVolume: Invalid volume: status must be 'available'\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]\n\nThis error cause the VM in \"error\" status:\n+--------------------------------------+------------+--------+----------------------+-------------+----------------------+\n| ID                                   | Name       | Status | Task State           | Power State | Networks             |\n+--------------------------------------+------------+--------+----------------------+-------------+----------------------+\n| 1fa2d7aa-8bd9-4a22-8538-0a07d9dae8aa | inst02     | ERROR  | block_device_mapping | NOSTATE     |                      |\n+--------------------------------------+------------+--------+----------------------+-------------+----------------------+\nBut the volume was in \"available\" status:\n-----------------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n| a9ab2dc2-b117-44ef-8678-f71067a9e770 | available | None |  2   |     None    |   true   |                                      |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n+--------------------------------------+------------+--------+----------------------+-------------+-------\n\n\nAnd when we teminiate this VM, the volume will still exist,  since there is no volume attachment info stored in this VM.\n\nThis can be easily reproduced:\n1. add the following options  to nova.conf  in compute node ( make sure the error will  be happened even with small image such as cirros):\nblock_device_allocate_retries = 1\nblock_device_allocate_retries_interval = 1\n\n2. restart the nova-compute service and try boot one instance from volume:\n\nnova boot --flavor 1 --block-device source=image,id=929dfa0b-0b9b-4819-9f84-e4ed22e81f33,dest=volume,size=2,shutdown=remove,bootindex=0 --nic net-id=a302dfa6-0c5d-46ab-9295-8f8b9119fe83 --availability-zone nova:compute01-juno.ibm.com inst02", 
    "tags": [
        "volumes"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1447884", 
    "owner": "https://api.launchpad.net/1.0/~lqslan", 
    "id": 1447884, 
    "index": 4235, 
    "created": "2015-04-24 03:12:28.720813+00:00", 
    "title": "Boot from volume, block device allocate timeout cause VM error, but volume would be available later", 
    "comments": [
        {
            "content": "When we  try to boot multi instances from volume (with a  large image source)  at the same time,  we usually got a block device allocate error as the logs in nova-compute.log:\n\n2015-03-30 23:22:46.920 6445 WARNING nova.compute.manager [-] Volume id: 551ea616-e1c4-4ef2-9bf3-b0ca6d4474dc finished being created but was not set as 'available'\n2015-03-30 23:22:47.131 6445 ERROR nova.compute.manager [-] [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6] Instance failed block device setup\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6] Traceback (most recent call last):\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1829, in _prep_block_device\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     do_check_attach=do_check_attach) +\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/virt/block_device.py\", line 407, in attach_block_devices\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     map(_log_and_attach, block_device_mapping)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/virt/block_device.py\", line 405, in _log_and_attach\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     bdm.attach(*attach_args, **attach_kwargs)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/virt/block_device.py\", line 339, in attach\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     do_check_attach=do_check_attach)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/virt/block_device.py\", line 46, in wrapped\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     ret_val = method(obj, context, *args, **kwargs)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/virt/block_device.py\", line 229, in attach\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     volume_api.check_attach(context, volume, instance=instance)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]   File \"/usr/lib/python2.6/site-packages/nova/volume/cinder.py\", line 305, in check_attach\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]     raise exception.InvalidVolume(reason=msg)\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6] InvalidVolume: Invalid volume: status must be 'available'\n2015-03-30 23:22:47.131 6445 TRACE nova.compute.manager [instance: 483472b2-61b3-4574-95e2-8cd0304f90f6]\n\nThis error cause the VM in \"error\" status:\n+--------------------------------------+------------+--------+----------------------+-------------+----------------------+\n| ID                                   | Name       | Status | Task State           | Power State | Networks             |\n+--------------------------------------+------------+--------+----------------------+-------------+----------------------+\n| 1fa2d7aa-8bd9-4a22-8538-0a07d9dae8aa | inst02     | ERROR  | block_device_mapping | NOSTATE     |                      |\n+--------------------------------------+------------+--------+----------------------+-------------+----------------------+\nBut the volume was in \"available\" status:\n-----------------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n| a9ab2dc2-b117-44ef-8678-f71067a9e770 | available | None |  2   |     None    |   true   |                                      |\n+--------------------------------------+-----------+------+------+-------------+----------+--------------------------------------+\n+--------------------------------------+------------+--------+----------------------+-------------+-------\n\n\nAnd when we teminiate this VM, the volume will still exist,  since there is no volume attachment info stored in this VM.\n\nThis can be easily reproduced:\n1. add the following options  to nova.conf  in compute node ( make sure the error will  be happened even with small image such as cirros):\nblock_device_allocate_retries = 1\nblock_device_allocate_retries_interval = 1\n\n2. restart the nova-compute service and try boot one instance from volume:\n\nnova boot --flavor 1 --block-device source=image,id=929dfa0b-0b9b-4819-9f84-e4ed22e81f33,dest=volume,size=2,shutdown=remove,bootindex=0 --nic net-id=a302dfa6-0c5d-46ab-9295-8f8b9119fe83 --availability-zone nova:compute01-juno.ibm.com inst02", 
            "date_created": "2015-04-24 03:12:28.720813+00:00", 
            "author": "https://api.launchpad.net/1.0/~lqslan"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/177084", 
            "date_created": "2015-04-24 06:04:31.631622+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/177084\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8772653ddec24ae68a0bcd9440e9e6ec81ea301b\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8772653ddec24ae68a0bcd9440e9e6ec81ea301b\nAuthor: Lan Qi song <email address hidden>\nDate:   Fri Apr 24 11:49:45 2015 +0800\n\n    Remove useless volume when boot from volume failed\n    \n    Currently, when boot instance from block device, user can choose three\n    kinds of sources: (blank, snapshot or image), and compute manager will\n    create a volume from one of them. But the volume creation may fail or\n    timeout at this time, then the process of instance boot will fail.\n    \n    During cleanup, the failed volume cannot be deleted, and becomes unusable.\n    \n    This patch removes the corresponding volume when block device allocation\n    fails or times out.\n    \n    Closes-Bug: #1447884\n    \n    Change-Id: Ib3c915b5b5920c8289d5fc69cde4a3c485ed8600\n", 
            "date_created": "2015-06-08 16:22:01.159724+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/189702", 
            "date_created": "2015-06-09 13:06:24.535238+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/189702\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=540221fc91fb5b5c0ac8a79cdc5d74a9ec8b492e\nSubmitter: Jenkins\nBranch:    stable/kilo\n\ncommit 540221fc91fb5b5c0ac8a79cdc5d74a9ec8b492e\nAuthor: Lan Qi song <email address hidden>\nDate:   Fri Apr 24 11:49:45 2015 +0800\n\n    Remove useless volume when boot from volume failed\n    \n    Currently, when boot instance from block device, user can choose three\n    kinds of sources: (blank, snapshot or image), and compute manager will\n    create a volume from one of them. But the volume creation may fail or\n    timeout at this time, then the process of instance boot will fail.\n    \n    During cleanup, the failed volume cannot be deleted, and becomes unusable.\n    \n    This patch removes the corresponding volume when block device allocation\n    fails or times out.\n    \n    Closes-Bug: #1447884\n    \n    Change-Id: Ib3c915b5b5920c8289d5fc69cde4a3c485ed8600\n    (cherry picked from commit 8772653ddec24ae68a0bcd9440e9e6ec81ea301b)\n", 
            "date_created": "2015-06-13 05:34:57.567986+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}