{
    "status": "Invalid", 
    "last_updated": "2016-01-14 14:48:13.337926+00:00", 
    "description": "while trying to live-migrate an instance with the --block-migrate option, I've got an error on the host which hosts the VM :  \n\n\n2015-04-07 11:01:32.554 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Starting monitoring of live migration from (pid=5202) _live_migration /opt/stack/nova/nova/virt/libvirt/driver.py:5642\n2015-04-07 11:01:32.556 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Operation thread is still running from (pid=5202) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5494\n2015-04-07 11:01:32.557 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Migration not running yet from (pid=5202) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5525\n2015-04-07 11:01:33.142 INFO nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Migration running for 0 secs, memory 0% remaining; (bytes processed=0, remaining=0, total=0)\n2015-04-07 11:01:33.277 ERROR nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Live Migration failure: End of file while reading data: Input/output error\n2015-04-07 11:01:33.278 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Migration operation thread notification from (pid=5202) thread_finished /opt/stack/nova/nova/virt/libvirt/driver.py:5633\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 457, in fire_timers\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 58, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 168, in _do_send\n    waiter.switch(result)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5428, in _live_migration_operation\n    instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 85, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5397, in _live_migration_operation\n    CONF.libvirt.live_migration_bandwidth)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 1734, in migrateToURI2\n    if ret == -1: raise libvirtError ('virDomainMigrateToURI2() failed', dom=self)\nlibvirtError: End of file while reading data: Input/output error\n2015-04-07 11:01:33.644 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] VM running on src, migration failed from (pid=5202) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5500\n2015-04-07 11:01:33.645 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Fixed incorrect job type to be 4 from (pid=5202) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5520\n2015-04-07 11:01:33.645 ERROR nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Migration operation has aborted\n2015-04-07 11:01:33.733 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Live migration monitoring is all done from (pid=5202) _live_migration /opt/stack/nova/nova/virt/libvirt/driver.py:5653\n\n\nlive migration with block-migrate works fine when I remove the flag VIR_MIGRATE_TUNNELLED from the option block_migration_flag.\n\nindeed, live block migration cannot occur in tunneling mode, as reported here : \nhttps://wiki.openstack.org/wiki/OSSN/OSSN-0007", 
    "tags": [
        "live-migration"
    ], 
    "importance": "Medium", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1441054", 
    "owner": "https://api.launchpad.net/1.0/~mathieu-rohon", 
    "id": 1441054, 
    "index": 4210, 
    "created": "2015-04-07 09:21:09.104127+00:00", 
    "title": "live-migration --block-migrate fails with default libvirt flags", 
    "comments": [
        {
            "content": "while trying to live-migrate an instance with the --block-migrate option, I've got an error on the host which hosts the VM :  \n\n\n2015-04-07 11:01:32.554 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Starting monitoring of live migration from (pid=5202) _live_migration /opt/stack/nova/nova/virt/libvirt/driver.py:5642\n2015-04-07 11:01:32.556 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Operation thread is still running from (pid=5202) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5494\n2015-04-07 11:01:32.557 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Migration not running yet from (pid=5202) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5525\n2015-04-07 11:01:33.142 INFO nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Migration running for 0 secs, memory 0% remaining; (bytes processed=0, remaining=0, total=0)\n2015-04-07 11:01:33.277 ERROR nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Live Migration failure: End of file while reading data: Input/output error\n2015-04-07 11:01:33.278 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Migration operation thread notification from (pid=5202) thread_finished /opt/stack/nova/nova/virt/libvirt/driver.py:5633\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 457, in fire_timers\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 58, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 168, in _do_send\n    waiter.switch(result)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5428, in _live_migration_operation\n    instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 85, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5397, in _live_migration_operation\n    CONF.libvirt.live_migration_bandwidth)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 1734, in migrateToURI2\n    if ret == -1: raise libvirtError ('virDomainMigrateToURI2() failed', dom=self)\nlibvirtError: End of file while reading data: Input/output error\n2015-04-07 11:01:33.644 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] VM running on src, migration failed from (pid=5202) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5500\n2015-04-07 11:01:33.645 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Fixed incorrect job type to be 4 from (pid=5202) _live_migration_monitor /opt/stack/nova/nova/virt/libvirt/driver.py:5520\n2015-04-07 11:01:33.645 ERROR nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Migration operation has aborted\n2015-04-07 11:01:33.733 DEBUG nova.virt.libvirt.driver [-] [instance: 31b63d63-b392-4197-8864-b6d85dae438f] Live migration monitoring is all done from (pid=5202) _live_migration /opt/stack/nova/nova/virt/libvirt/driver.py:5653\n\n\nlive migration with block-migrate works fine when I remove the flag VIR_MIGRATE_TUNNELLED from the option block_migration_flag.\n\nindeed, live block migration cannot occur in tunneling mode, as reported here : \nhttps://wiki.openstack.org/wiki/OSSN/OSSN-0007", 
            "date_created": "2015-04-07 09:21:09.104127+00:00", 
            "author": "https://api.launchpad.net/1.0/~mathieu-rohon"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/171098", 
            "date_created": "2015-04-07 09:29:21.878339+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I noted the context in the commit, noting here too.\n\nDuring migration, the VIR_MIGRATE TUNNELLED transports data\nover libvirt's RPC layer (taking advantage of encryption). However, it\nis not supported yet. From a discussion with upstream libvirt \ndevelopers:\n\n    The support for Network Block Device (NBD) is just not implemented \n    in libvirt for tunneled migration. It's becuase we'd have to\n    implement some multiplexing of memory stream and all disks streams\n    into a single libvirt stream. Or we'd have to provide new APIs for\n    migrations that would support more than one stream and since\n    tunneled migration is not the best idea anyway, we just decided not\n    to implement NBD.\n    \n    The right solution is to implement TLS support for QEMU so that we\n    can do secure non-tunneled migration.  \n\nOn a very related note, Daniel Berrange said on upstream QEMU devel \nlist, he has in-progress (mid/long-term) work to support \"Universal\nencryption on QEMU I/O channels\"[1]\n\n\n[1] https://lists.gnu.org/archive/html/qemu-devel/2015-02/msg00529.html", 
            "date_created": "2015-04-07 10:35:51.779254+00:00", 
            "author": "https://api.launchpad.net/1.0/~kashyapc"
        }, 
        {
            "content": "Interestingly, in my testing of block migration over tunneled mode I'm seeing libvirt recognize that it can't do the NBD/drive-mirror type of migration but falls back to the older 'inc = true' approach which causes qemu to do the data transfer over the same channel as the memory. The logs show:\n\n  qemuMigrationRun:4254 : Destination doesn't support NBD server Falling back to previous implementation.\n\nbut it works just fine. The QMP migrate command is:\n\n  \"migrate\",\"arguments\":{\"detach\":true,\"blk\":false,\"inc\":true,\"uri\":\"fd:migrate\"}\n\nThis is with libvirt-1.2.17-13.el7_2.2.x86_64 on RHEL 7.2 but it looks like this has been the behavior since the drive-mirror approach was added: http://libvirt.org/git/?p=libvirt.git;a=commitdiff;h=7b7600b3e6", 
            "date_created": "2016-01-04 21:32:03.628673+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "@markmc:  Your observation matches my test, and it is valid behavior.\n\nThe current default flags Nova sets for live block migration are[1]:\n\n    VIR_MIGRATE_UNDEFINE_SOURCE, VIR_MIGRATE_PEER2PEER, VIR_MIGRATE_LIVE,\n    VIR_MIGRATE_TUNNELLED, VIR_MIGRATE_NON_SHARED_INC\n\nSo, since currently there's no support for NBD in TUNNELLED mode, when\nyou perform, it first throws a warning saying that:\n\n-----------\n2016-01-07 12:02:26.886+0000: 13202: warning : qemuMigrationBeginPhase:2654 : NBD in tunnelled migration is currently not supported\n-----------\n\nAnd, as you saw, it falls back to the older implementation:\n\n-----------\n2016-01-07 12:02:27.212+0000: 13202: debug : qemuMigrationDriveMirror:1727 : Destination doesn't support NBD server Falling back to previous implementation.\n[...]\n    2016-01-07 12:02:27.226+0000: 13202: debug : qemuMonitorJSONCommandWithFd:290 : Send command '{\"execute\":\"migrate\",\"arguments\":{{\"detach\":true,\"blk\":false,\"inc\":true,\"uri\":\"fd:migrate\"},\"id\":\"libvirt-18\"}' for write with FD -1\n-----------\n\nI just did a test just with the above flags, but supplying them directly\nto the libvirt wrapper `virsh`, to confirm the behavior:\n\n    $ virsh migrate --verbose \\\n        --undefinesource \\\n        --copy-storage-inc \\\n        --p2p \\\n        --live \\\n        --tunnelled \\\n        cvm1 qemu+ssh://root@devstack2/system\n\n\n\n[1] https://github.com/openstack/nova/blob/master/nova/virt/libvirt/driver.py#L165,L168\n", 
            "date_created": "2016-01-07 12:22:09.979902+00:00", 
            "author": "https://api.launchpad.net/1.0/~kashyapc"
        }, 
        {
            "content": "Mathieu, you haven't mentioned what exact libvirt/QEMU/Nova versions you've tested with.  The report is more than an year old. Can you please re-test (and mention the versions you've done your tests with).\n\nFrom comment #3 and comment #4,  you can see that the behavior you state is not reproducible currently.\n\nWith the below versions of using VIR_MIGRATE_TUNNELLED flag (which is the current default) with block-migrate works just fine.\n\nI also tested with Nova, and I see identical behavior as to what I noticed with direct libvirt wrapper (see comment #4)\n\n    $ nova live-migration --block-migrate vm1 devstack2\n\nLive block migration completes successfully.\n\n\nI tested (see comment #4) with these versions:\n\n    $ rpm -q libvirt qemu-system-x86\n    libvirt-1.2.13.1-3.fc22.x86_64\n    qemu-system-x86-2.3.1-7.fc22.x86_64\n\nNova:\n\n    $ git describe\n    13.0.0.0b1-555-g6e2c516", 
            "date_created": "2016-01-07 13:55:01.418492+00:00", 
            "author": "https://api.launchpad.net/1.0/~kashyapc"
        }, 
        {
            "content": "I confirm that live-migration is working fine by default  with debian jessie, even without explicitly removing the VIR_MIGRATE_TUNNELLED flag.\n\nversions of packages :\nlibvirt0=1.2.9-9+deb8u1\nqemu-kvm=1:2.1+dfsg-12+deb8u4\n\nI also observe that libvirt tries the tunnel mode, but then fallback to 'previous implementation'.\nI can see those two logs from libvirt : \n\nwarning : qemuMigrationBeginPhase:2332 : NBD in tunnelled migration is currently not supported\ndebug : qemuMigrationDriveMirror:1442 : Destination doesn't support NBD server Falling back to previous implementation.", 
            "date_created": "2016-01-13 14:18:40.385524+00:00", 
            "author": "https://api.launchpad.net/1.0/~mathieu-rohon"
        }, 
        {
            "content": "Change abandoned by Mathieu Rohon (<email address hidden>) on branch: master\nReview: https://review.openstack.org/171098\nReason: I confirm that newest libvirt allow to fallback to previous implementation for live-migration. This change is not needed anymore.", 
            "date_created": "2016-01-14 14:46:48.109405+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}