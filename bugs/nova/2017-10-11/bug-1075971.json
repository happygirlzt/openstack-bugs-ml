{
    "status": "Won't Fix", 
    "last_updated": "2015-11-05 02:46:15.400644+00:00", 
    "description": "Running devstack with libvirt/qemu - the problem is that attaching a volume (either by passing it with --block_device_mapping to boot or by using nova volume-attach) completely disregards the device name passed as can be seen fromt the folloowng shell session. However the device remains reserved so subsequent attach attempts will fail on the specified device, and succeed with some other given (which will not be honored again).\n\nThe following session is how to reproduce it:\n\n[ndipanov@devstack devstack]$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+-------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Attached to |\n+--------------------------------------+-----------+--------------+------+-------------+-------------+\n| 5792f1ed-c5f7-40c6-913f-43aa66c717c7 | available |   bootable   |  3   |     None    |             |\n| abc77933-119b-4105-b085-092c93be36f5 | available |   blank_2    |  1   |     None    |             |\n| b4de941a-627c-447a-9226-456159d95173 | available |    blank     |  1   |     None    |             |\n+--------------------------------------+-----------+--------------+------+-------------+-------------+\n[ndipanov@devstack devstack]$ nova list\n\n[ndipanov@devstack devstack]$ nova boot --image c346fdd1-d438-472b-98f5-b4c5f2b716f8 --flavor 1 --block_device_mapping vdr=b4de941a-627c-447a-9226-456159d95173:::0 --key_name nova_key w_vol\n+------------------------+--------------------------------------+\n| Property               | Value                                |\n+------------------------+--------------------------------------+\n| OS-DCF:diskConfig      | MANUAL                               |\n| OS-EXT-STS:power_state | 0                                    |\n| OS-EXT-STS:task_state  | scheduling                           |\n| OS-EXT-STS:vm_state    | building                             |\n| accessIPv4             |                                      |\n| accessIPv6             |                                      |\n| adminPass              | CqgT4dXkq64t                         |\n| config_drive           |                                      |\n| created                | 2012-11-07T14:02:00Z                 |\n| flavor                 | m1.tiny                              |\n| hostId                 |                                      |\n| id                     | caa459d5-27ae-4c5b-b190-fd740054a2ec |\n| image                  | cirros-0.3.0-x86_64-uec              |\n| key_name               | nova_key                             |\n| metadata               | {}                                   |\n| name                   | w_vol                                |\n| progress               | 0                                    |\n| security_groups        | [{u'name': u'default'}]              |\n| status                 | BUILD                                |\n| tenant_id              | 5f68e605463940dda20e876604385c43     |\n| updated                | 2012-11-07T14:02:01Z                 |\n| user_id                | 104895e85fe54ae5a2cc5c5a650f50b0     |\n+------------------------+--------------------------------------+\n[ndipanov@devstack devstack]$ nova list\n        +--------------------------------------+-------+--------+------------------+\n| ID                                   | Name  | Status | Networks         |\n+--------------------------------------+-------+--------+------------------+\n| caa459d5-27ae-4c5b-b190-fd740054a2ec | w_vol | ACTIVE | private=10.0.0.2 |\n+--------------------------------------+-------+--------+------------------+\n[ndipanov@devstack devstack]$ ssh -o StrictHostKeyChecking=no -i nova_key.priv cirros@10.0.0.2\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\nIt is also possible that a host key has just been changed.\nThe fingerprint for the RSA key sent by the remote host is\n57:ca:fe:e8:4f:b6:30:5a:06:20:d4:37:ed:06:aa:c8.\nPlease contact your system administrator.\nAdd correct host key in /home/ndipanov/.ssh/known_hosts to get rid of this message.\nOffending RSA key in /home/ndipanov/.ssh/known_hosts:2\nPassword authentication is disabled to avoid man-in-the-middle attacks.\nKeyboard-interactive authentication is disabled to avoid man-in-the-middle attacks.\n$ cat /proc/partitions\nmajor minor  #blocks  name\n\n 253        0      24576 vda\n 253       16    1048576 vdb\n$ ls -la /dev | grep vd.*\nlrwxrwxrwx    1 root     root             3 Nov  7 07:03 root -> vda\nbrw-------    1 root     root      253,   0 Nov  7 07:02 vda\nbrw-------    1 root     root      253,  16 Nov  7 07:02 vdb\n$ Connection to 10.0.0.2 closed.\n[ndipanov@devstack devstack]$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+--------------------------------------+\n| 5792f1ed-c5f7-40c6-913f-43aa66c717c7 | available |   bootable   |  3   |     None    |                                      |\n| abc77933-119b-4105-b085-092c93be36f5 | available |   blank_2    |  1   |     None    |                                      |\n| b4de941a-627c-447a-9226-456159d95173 |   in-use  |    blank     |  1   |     None    | caa459d5-27ae-4c5b-b190-fd740054a2ec |\n+--------------------------------------+-----------+--------------+------+-------------+--------------------------------------+\n(reverse-i-search)`vol': nova boot --image c346fdd1-d438-472b-98f5-b4c5f2b716f8 --flavor 1 --block_device_mapping vdr=b4de941a-627c-447a-9226-456159d95173:::0 --key_name nova_key w_^Cl\n[ndipanov@devstack devstack]$ nova volume-attach w_vol abc77933-119b-4105-b085-092c93be36f5 /dev/vdr\nERROR: The supplied device path (/dev/vda) is in use.\nTraceback (most recent call last):\n\n  File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\n    rval = self.proxy.dispatch(ctxt, version, method, **args)\n\n  File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\n    return getattr(proxyobj, method)(ctxt, **kwargs)\n\n  File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n    temp_level, payload)\n\n  File \"/usr/lib64/python2.7/contextlib.py\", line 24, in __exit__\n    self.gen.next()\n\n  File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\n    return f(*args, **kw)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 175, in decorated_function\n    pass\n\n  File \"/usr/lib64/python2.7/contextlib.py\", line 24, in __exit__\n    self.gen.next()\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 161, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 202, in decorated_function\n    kwargs['instance']['uuid'], e, sys.exc_info())\n\n  File \"/usr/lib64/python2.7/contextlib.py\", line 24, in __exit__\n    self.gen.next()\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 190, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 2167, in reserve_block_device_name\n    return do_reserve()\n\n  File \"/opt/stack/nova/nova/openstack/common/lockutils.py\", line 229, in inner\n    retval = f(*args, **kwargs)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 2160, in do_reserve\n    device)\n\n  File \"/opt/stack/nova/nova/compute/utils.py\", line 110, in get_device_name_for_instance\n    raise exception.DevicePathInUse(path=device)\n\nDevicePathInUse: The supplied device path (/dev/vda) is in use.\n (HTTP 400) (Request-ID: req-76852a0d-1c70-4e11-879c-0089956ba02e)\n[ndipanov@devstack ~]$ nova volume-attach w_vol abc77933-119b-4105-b085-092c93be36f5 /dev/vdc\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdc                             |\n| id       | abc77933-119b-4105-b085-092c93be36f5 |\n| serverId | caa459d5-27ae-4c5b-b190-fd740054a2ec |\n| volumeId | abc77933-119b-4105-b085-092c93be36f5 |\n+----------+--------------------------------------+\n\n\nThis seems to be somehow related to the changes introduced by https://bugs.launchpad.net/nova/+bug/1004328", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 42, 
    "link": "https://bugs.launchpad.net/nova/+bug/1075971", 
    "owner": "https://api.launchpad.net/1.0/~ndipanov", 
    "id": 1075971, 
    "index": 3133, 
    "created": "2012-11-07 14:22:16.303713+00:00", 
    "title": "Attach volume with libvirt disregards target device but still reserves it", 
    "comments": [
        {
            "content": "Running devstack with libvirt/qemu - the problem is that attaching a volume (either by passing it with --block_device_mapping to boot or by using nova volume-attach) completely disregards the device name passed as can be seen fromt the folloowng shell session. However the device remains reserved so subsequent attach attempts will fail on the specified device, and succeed with some other given (which will not be honored again).\n\nThe following session is how to reproduce it:\n\n[ndipanov@devstack devstack]$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+-------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Attached to |\n+--------------------------------------+-----------+--------------+------+-------------+-------------+\n| 5792f1ed-c5f7-40c6-913f-43aa66c717c7 | available |   bootable   |  3   |     None    |             |\n| abc77933-119b-4105-b085-092c93be36f5 | available |   blank_2    |  1   |     None    |             |\n| b4de941a-627c-447a-9226-456159d95173 | available |    blank     |  1   |     None    |             |\n+--------------------------------------+-----------+--------------+------+-------------+-------------+\n[ndipanov@devstack devstack]$ nova list\n\n[ndipanov@devstack devstack]$ nova boot --image c346fdd1-d438-472b-98f5-b4c5f2b716f8 --flavor 1 --block_device_mapping vdr=b4de941a-627c-447a-9226-456159d95173:::0 --key_name nova_key w_vol\n+------------------------+--------------------------------------+\n| Property               | Value                                |\n+------------------------+--------------------------------------+\n| OS-DCF:diskConfig      | MANUAL                               |\n| OS-EXT-STS:power_state | 0                                    |\n| OS-EXT-STS:task_state  | scheduling                           |\n| OS-EXT-STS:vm_state    | building                             |\n| accessIPv4             |                                      |\n| accessIPv6             |                                      |\n| adminPass              | CqgT4dXkq64t                         |\n| config_drive           |                                      |\n| created                | 2012-11-07T14:02:00Z                 |\n| flavor                 | m1.tiny                              |\n| hostId                 |                                      |\n| id                     | caa459d5-27ae-4c5b-b190-fd740054a2ec |\n| image                  | cirros-0.3.0-x86_64-uec              |\n| key_name               | nova_key                             |\n| metadata               | {}                                   |\n| name                   | w_vol                                |\n| progress               | 0                                    |\n| security_groups        | [{u'name': u'default'}]              |\n| status                 | BUILD                                |\n| tenant_id              | 5f68e605463940dda20e876604385c43     |\n| updated                | 2012-11-07T14:02:01Z                 |\n| user_id                | 104895e85fe54ae5a2cc5c5a650f50b0     |\n+------------------------+--------------------------------------+\n[ndipanov@devstack devstack]$ nova list\n        +--------------------------------------+-------+--------+------------------+\n| ID                                   | Name  | Status | Networks         |\n+--------------------------------------+-------+--------+------------------+\n| caa459d5-27ae-4c5b-b190-fd740054a2ec | w_vol | ACTIVE | private=10.0.0.2 |\n+--------------------------------------+-------+--------+------------------+\n[ndipanov@devstack devstack]$ ssh -o StrictHostKeyChecking=no -i nova_key.priv cirros@10.0.0.2\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\nIt is also possible that a host key has just been changed.\nThe fingerprint for the RSA key sent by the remote host is\n57:ca:fe:e8:4f:b6:30:5a:06:20:d4:37:ed:06:aa:c8.\nPlease contact your system administrator.\nAdd correct host key in /home/ndipanov/.ssh/known_hosts to get rid of this message.\nOffending RSA key in /home/ndipanov/.ssh/known_hosts:2\nPassword authentication is disabled to avoid man-in-the-middle attacks.\nKeyboard-interactive authentication is disabled to avoid man-in-the-middle attacks.\n$ cat /proc/partitions\nmajor minor  #blocks  name\n\n 253        0      24576 vda\n 253       16    1048576 vdb\n$ ls -la /dev | grep vd.*\nlrwxrwxrwx    1 root     root             3 Nov  7 07:03 root -> vda\nbrw-------    1 root     root      253,   0 Nov  7 07:02 vda\nbrw-------    1 root     root      253,  16 Nov  7 07:02 vdb\n$ Connection to 10.0.0.2 closed.\n[ndipanov@devstack devstack]$ cinder list\n+--------------------------------------+-----------+--------------+------+-------------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+--------------------------------------+\n| 5792f1ed-c5f7-40c6-913f-43aa66c717c7 | available |   bootable   |  3   |     None    |                                      |\n| abc77933-119b-4105-b085-092c93be36f5 | available |   blank_2    |  1   |     None    |                                      |\n| b4de941a-627c-447a-9226-456159d95173 |   in-use  |    blank     |  1   |     None    | caa459d5-27ae-4c5b-b190-fd740054a2ec |\n+--------------------------------------+-----------+--------------+------+-------------+--------------------------------------+\n(reverse-i-search)`vol': nova boot --image c346fdd1-d438-472b-98f5-b4c5f2b716f8 --flavor 1 --block_device_mapping vdr=b4de941a-627c-447a-9226-456159d95173:::0 --key_name nova_key w_^Cl\n[ndipanov@devstack devstack]$ nova volume-attach w_vol abc77933-119b-4105-b085-092c93be36f5 /dev/vdr\nERROR: The supplied device path (/dev/vda) is in use.\nTraceback (most recent call last):\n\n  File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\n    rval = self.proxy.dispatch(ctxt, version, method, **args)\n\n  File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\n    return getattr(proxyobj, method)(ctxt, **kwargs)\n\n  File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n    temp_level, payload)\n\n  File \"/usr/lib64/python2.7/contextlib.py\", line 24, in __exit__\n    self.gen.next()\n\n  File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\n    return f(*args, **kw)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 175, in decorated_function\n    pass\n\n  File \"/usr/lib64/python2.7/contextlib.py\", line 24, in __exit__\n    self.gen.next()\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 161, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 202, in decorated_function\n    kwargs['instance']['uuid'], e, sys.exc_info())\n\n  File \"/usr/lib64/python2.7/contextlib.py\", line 24, in __exit__\n    self.gen.next()\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 190, in decorated_function\n    return function(self, context, *args, **kwargs)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 2167, in reserve_block_device_name\n    return do_reserve()\n\n  File \"/opt/stack/nova/nova/openstack/common/lockutils.py\", line 229, in inner\n    retval = f(*args, **kwargs)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 2160, in do_reserve\n    device)\n\n  File \"/opt/stack/nova/nova/compute/utils.py\", line 110, in get_device_name_for_instance\n    raise exception.DevicePathInUse(path=device)\n\nDevicePathInUse: The supplied device path (/dev/vda) is in use.\n (HTTP 400) (Request-ID: req-76852a0d-1c70-4e11-879c-0089956ba02e)\n[ndipanov@devstack ~]$ nova volume-attach w_vol abc77933-119b-4105-b085-092c93be36f5 /dev/vdc\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdc                             |\n| id       | abc77933-119b-4105-b085-092c93be36f5 |\n| serverId | caa459d5-27ae-4c5b-b190-fd740054a2ec |\n| volumeId | abc77933-119b-4105-b085-092c93be36f5 |\n+----------+--------------------------------------+\n\n\nThis seems to be somehow related to the changes introduced by https://bugs.launchpad.net/nova/+bug/1004328", 
            "date_created": "2012-11-07 14:22:16.303713+00:00", 
            "author": "https://api.launchpad.net/1.0/~ndipanov"
        }, 
        {
            "content": "Since it is now possible to both boot instances and attach volumes without specifying device names after https://blueprints.launchpad.net/nova/+spec/improve-block-device-handling BP has been implemented. in which case the device names will be handled properly by Nova.\n\nIt is still possible to supply device names (for backwards compatibility's sake), which would cause the same behavior as described above. This is really an issue due to the fact that there is no way to make sure libvirt uses the same device name as supplied to it since libvirt only takes this as ordering hints. the best solution really _is_ to rely on Nova to actually choose the device name as per implemented BP.", 
            "date_created": "2014-03-24 11:34:45.509110+00:00", 
            "author": "https://api.launchpad.net/1.0/~ndipanov"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/189632", 
            "date_created": "2015-06-09 10:10:22.545118+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/189632\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0283234e837d9faf807e6e8da6ec6321ee56b31a\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0283234e837d9faf807e6e8da6ec6321ee56b31a\nAuthor: Nikola Dipanov <email address hidden>\nDate:   Tue Jun 9 10:05:14 2015 +0100\n\n    libvirt: Always default device names at boot\n    \n    Up until now, libvirt would default it's own device names unless they\n    were specified by the user at boot. This could lead to inconsistencies,\n    so the soft approach was to discourage users from passing in explicit\n    device names, by documenting the fact that they will not be honoured,\n     but not override them.\n    \n    It turns out that this approach causes more trouble, especially when we\n    add attaching volumes into the mix. So the approach now is to make\n    libvirt _always_ override what is passed in. That way even if the user\n    specifies a device name, the attach will not fail due to a device name\n    collision (a common problem - see related bug), and Nova book keeping\n    will match what we can see in the instance on most OSes.\n    \n    In order to get there we now make sure boot starts acting like that\n    before we switch attach_volume over too, so that there is consistent\n    behavior.\n    \n    Also - make tests for defaulting device names more realistic as they now\n    actually run the code instead of just making sure the right methods get\n    called.\n    \n    UpgradeImpact: After this commit, supplying a device name for any of\n    the block devices specified as part of the `nova boot` call will not be\n    honoured by any libvirt compute nodes.\n    \n    Change-Id: I76a7cfd995db6c04f7af48ff8c9acdd55750ed76\n    Related-bug: #1075971\n", 
            "date_created": "2015-07-28 13:22:24.439746+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/229612", 
            "date_created": "2015-09-30 20:38:20.117272+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Matt Riedemann (<email address hidden>) on branch: stable/kilo\nReview: https://review.openstack.org/229612\nReason: This didn't make test_stamp_pattern magically start working in the kilo compat job.", 
            "date_created": "2015-11-05 02:46:14.242087+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}