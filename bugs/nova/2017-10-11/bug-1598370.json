{
    "status": "Fix Released", 
    "last_updated": "2016-09-02 01:16:07.415930+00:00", 
    "description": "Description\n===========\nUsing nova to create an instance in AArch64,and finally got AttributeError \"'NoneType' object has no attribute 'parse_dom'\" after \"_get_guest_xml\".\n==================\n1.Using devstack to deploy openstack. Using default local.conf.\n\n2.Upload the aarch64 image with glance.\n$ source ~/devstack/openrc admin admin\n$ glance image-create --name image-arm64.img --disk-format qcow2 --container-format bare --visibility public --file images/image-arm64-wily.qcow2 --progress\n$ glance image-create --name image-arm64.vmlinuz --disk-format aki --container-format aki --visibility public --file images/image-arm64-wily.vmlinuz --progress\n$ glance image-create --name image-arm64.initrd --disk-format ari --container-format ari --visibility public --file images/image-arm64-wily.initrd --progress\n$ IMAGE_UUID=$(glance image-list | grep image-arm64.img | awk '{ print $2 }')\n$ IMAGE_KERNEL_UUID=$(glance image-list | grep image-arm64.vmlinuz | awk '{ print $2 }')\n$ IMAGE_INITRD_UUID=$(glance image-list | grep image-arm64.initrd | awk '{ print $2 }')\n$ glance image-update --kernel-id ${IMAGE_KERNEL_UUID} --ramdisk-id ${IMAGE_INITRD_UUID} ${IMAGE_UUID}\n3.Set the scsi model:\n$ glance image-update --property hw_disk_bus --property hw_scsi_model=virtio-scsi ${IMAGE_UUID}\n\n4.nova add keypair\n$ nova keypair-add default --pub-key ~/.ssh/id_rsa.pub\n\n5.Launch the instance:\n$ image=$(nova image-list | egrep \"image-arm64.img\"'[^-]' | awk '{ print $2 }')\n$ nova boot --flavor m1.small--image ${image} --key-name default test-arm64\n\n6.See the n-cpu log, we can get the error information.\n\nExpected result\n===============\nSpawning guest successfully.\n\nActual result\n=============\nGot the error log information as below:\n2016-07-02 06:57:08.645 ERROR nova.compute.manager [req-c8805971-7d8a-4775-ae95-7ac62b284487 admin admin] [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd] Instance failed to spawn\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd] Traceback (most recent call last):\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/compute/manager.py\", line 2063, in _build_resources\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     yield resources\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1907, in _build_and_run_instance\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     block_device_info=block_device_info)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2665, in spawn\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     post_xml_callback=gen_confdrive)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4860, in _create_domain_and_network\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     post_xml_callback=post_xml_callback)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4784, in _create_domain\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     post_xml_callback()\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3137, in _create_configdrive\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     instance)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 7547, in _build_device_metadata\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     guest_config.parse_dom(xml_dom)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/config.py\", line 2193, in parse_dom\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     obj.parse_dom(d)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/config.py\", line 1402, in parse_dom\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     obj.parse_dom(c)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd] AttributeError: 'NoneType' object has no attribute 'parse_dom'\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd] \n2016-07-02 06:57:08.647 INFO nova.compute.manager [req-c8805971-7d8a-4775-ae95-7ac62b284487 admin admin] [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd] Terminating instance\n\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n  list for all releases: http://docs.openstack.org/releases/\n   Nova development, commit code: 23153952a979c93a414705744b0f8ba4bde18f75\n\n2. Which hypervisor did you use?\n    Libvirt+KVM\n    $ kvm --version\n    QEMU emulator version 2.5.0 (Debian 1:2.5+dfsg-5ubuntu10.1), Copyright (c) 2003-2008 Fabrice Bellard\n    $ libvirtd --version\n    libvirtd (libvirt) 1.3.1\n\n2. Which storage type did you use?\n   In the host file system,all in one physics machine.\nstack@u202154:/opt/stack/nova$ df -hl\nFilesystem      Size  Used Avail Use% Mounted on\nudev            7.8G     0  7.8G   0% /dev\ntmpfs           1.6G   21M  1.6G   2% /run\n/dev/sda2       917G   12G  859G   2% /\ntmpfs           7.9G     0  7.9G   0% /dev/shm\ntmpfs           5.0M     0  5.0M   0% /run/lock\ntmpfs           7.9G     0  7.9G   0% /sys/fs/cgroup\n/dev/sda1       511M  888K  511M   1% /boot/efi\ncgmfs           100K     0  100K   0% /run/cgmanager/fs\ntmpfs           1.6G     0  1.6G   0% /run/user/1002\n\n\n3. Which networking type did you use?\n   nova-network\n\n4. Environment information:\n   Architecture : AARCH64\n   OS: Ubuntu 16.04\n\nDetailed log info is in the accessory.\nThe guest xml is also in the log info.", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1598370", 
    "owner": "https://api.launchpad.net/1.0/~kevin-zhao", 
    "id": 1598370, 
    "index": 1943, 
    "created": "2016-07-02 07:08:26.851597+00:00", 
    "title": "Got AttributeError  when launching instance in Aarch64", 
    "comments": [
        {
            "content": "Description\n===========\nUsing nova to create an instance in AArch64,and finally got AttributeError \"'NoneType' object has no attribute 'parse_dom'\" after \"_get_guest_xml\".\n==================\n1.Using devstack to deploy openstack. Using default local.conf.\n\n2.Upload the aarch64 image with glance.\n$ source ~/devstack/openrc admin admin\n$ glance image-create --name image-arm64.img --disk-format qcow2 --container-format bare --visibility public --file images/image-arm64-wily.qcow2 --progress\n$ glance image-create --name image-arm64.vmlinuz --disk-format aki --container-format aki --visibility public --file images/image-arm64-wily.vmlinuz --progress\n$ glance image-create --name image-arm64.initrd --disk-format ari --container-format ari --visibility public --file images/image-arm64-wily.initrd --progress\n$ IMAGE_UUID=$(glance image-list | grep image-arm64.img | awk '{ print $2 }')\n$ IMAGE_KERNEL_UUID=$(glance image-list | grep image-arm64.vmlinuz | awk '{ print $2 }')\n$ IMAGE_INITRD_UUID=$(glance image-list | grep image-arm64.initrd | awk '{ print $2 }')\n$ glance image-update --kernel-id ${IMAGE_KERNEL_UUID} --ramdisk-id ${IMAGE_INITRD_UUID} ${IMAGE_UUID}\n3.Set the scsi model:\n$ glance image-update --property hw_disk_bus --property hw_scsi_model=virtio-scsi ${IMAGE_UUID}\n\n4.nova add keypair\n$ nova keypair-add default --pub-key ~/.ssh/id_rsa.pub\n\n5.Launch the instance:\n$ image=$(nova image-list | egrep \"image-arm64.img\"'[^-]' | awk '{ print $2 }')\n$ nova boot --flavor m1.small--image ${image} --key-name default test-arm64\n\n6.See the n-cpu log, we can get the error information.\n\nExpected result\n===============\nSpawning guest successfully.\n\nActual result\n=============\nGot the error log information as below:\n2016-07-02 06:57:08.645 ERROR nova.compute.manager [req-c8805971-7d8a-4775-ae95-7ac62b284487 admin admin] [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd] Instance failed to spawn\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd] Traceback (most recent call last):\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/compute/manager.py\", line 2063, in _build_resources\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     yield resources\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1907, in _build_and_run_instance\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     block_device_info=block_device_info)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2665, in spawn\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     post_xml_callback=gen_confdrive)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4860, in _create_domain_and_network\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     post_xml_callback=post_xml_callback)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4784, in _create_domain\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     post_xml_callback()\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3137, in _create_configdrive\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     instance)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 7547, in _build_device_metadata\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     guest_config.parse_dom(xml_dom)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/config.py\", line 2193, in parse_dom\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     obj.parse_dom(d)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]   File \"/opt/stack/nova/nova/virt/libvirt/config.py\", line 1402, in parse_dom\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd]     obj.parse_dom(c)\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd] AttributeError: 'NoneType' object has no attribute 'parse_dom'\n2016-07-02 06:57:08.645 TRACE nova.compute.manager [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd] \n2016-07-02 06:57:08.647 INFO nova.compute.manager [req-c8805971-7d8a-4775-ae95-7ac62b284487 admin admin] [instance: c8ea40f1-2877-45d7-af4c-2cc6e8b966bd] Terminating instance\n\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n  list for all releases: http://docs.openstack.org/releases/\n   Nova development, commit code: 23153952a979c93a414705744b0f8ba4bde18f75\n\n2. Which hypervisor did you use?\n    Libvirt+KVM\n    $ kvm --version\n    QEMU emulator version 2.5.0 (Debian 1:2.5+dfsg-5ubuntu10.1), Copyright (c) 2003-2008 Fabrice Bellard\n    $ libvirtd --version\n    libvirtd (libvirt) 1.3.1\n\n2. Which storage type did you use?\n   In the host file system,all in one physics machine.\nstack@u202154:/opt/stack/nova$ df -hl\nFilesystem      Size  Used Avail Use% Mounted on\nudev            7.8G     0  7.8G   0% /dev\ntmpfs           1.6G   21M  1.6G   2% /run\n/dev/sda2       917G   12G  859G   2% /\ntmpfs           7.9G     0  7.9G   0% /dev/shm\ntmpfs           5.0M     0  5.0M   0% /run/lock\ntmpfs           7.9G     0  7.9G   0% /sys/fs/cgroup\n/dev/sda1       511M  888K  511M   1% /boot/efi\ncgmfs           100K     0  100K   0% /run/cgmanager/fs\ntmpfs           1.6G     0  1.6G   0% /run/user/1002\n\n\n3. Which networking type did you use?\n   nova-network\n\n4. Environment information:\n   Architecture : AARCH64\n   OS: Ubuntu 16.04\n\nDetailed log info is in the accessory.\nThe guest xml is also in the log info.", 
            "date_created": "2016-07-02 07:08:26.851597+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "Here I attach the error log and the guest.xml.", 
            "date_created": "2016-07-02 07:13:51.410184+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "", 
            "date_created": "2016-07-02 07:14:28.403089+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "Hacked into the code :\nnova/nova/virt/libvirt/driver.py 7547:\n\ndef _build_device_metadata(self, context, instance):\n        \"\"\"Builds a metadata object for instance devices, that maps the user\n           provided tag to the hypervisor assigned device address.\n        \"\"\"\n        def _get_device_name(bdm):\n            return block_device.strip_dev(bdm.device_name)\n\n        vifs = objects.VirtualInterfaceList.get_by_instance_uuid(context,\n                                                                 instance.uuid)\n        tagged_vifs = {vif.address: vif for vif in vifs if vif.tag}\n\n        bdms = objects.BlockDeviceMappingList.get_by_instance_uuid(\n            context, instance.uuid)\n        tagged_bdms = {_get_device_name(bdm): bdm for bdm in bdms if bdm.tag}\n\n        devices = []\n        guest = self._host.get_guest(instance)\n        xml = guest.get_xml_desc()\n        xml_dom = etree.fromstring(xml)\n        guest_config = vconfig.LibvirtConfigGuest()\n        guest_config.parse_dom(xml_dom)\n\nAnd get the print the xml from this \"xml = guest.get_xml_desc()\",I can see the interface xml is :\n<interface type='bridge'>\n      <mac address='fa:16:3e:15:2d:b8'/>\n      <source bridge='br100'/>\n      <model type='virtio'/>\n      <filterref filter='nova-instance-instance-0000000c-fa163e152db8'/>\n      <address type='virtio-mmio'/>\n    </interface>\nI can see  the interface address type is virtio-mmio.", 
            "date_created": "2016-07-02 07:19:22.500890+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-zhao"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/336781", 
            "date_created": "2016-07-02 09:45:07.543706+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "That's in progress, see comment #4", 
            "date_created": "2016-07-04 11:39:43.495278+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "I assume this is based on [1] which returns None if the IF and ELIF don't find a match [2].\n\n    @staticmethod\n    def factory(xmldoc):\n        addr_type = xmldoc.get('type')\n        if addr_type == 'pci':\n            return LibvirtConfigGuestDeviceAddressPCI()\n        elif addr_type == 'drive':\n            return LibvirtConfigGuestDeviceAddressDrive()\n\nReferences:\n[1] https://github.com/openstack/nova/commit/7b6f7ecfa6c7190d9136ed9287cfd86bdd5023d7#diff-d362bac3c354dd65e061ca91a8d1e14eR1146\n[2] https://github.com/openstack/nova/blob/23153952a979c93a414705744b0f8ba4bde18f75/nova/virt/libvirt/config.py#L1148-L1154", 
            "date_created": "2016-07-04 13:29:26.791523+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "This sounds virt-specific and libvirt is optional as a backend configuration in nova so it's not a critical bug. Dropped to High.", 
            "date_created": "2016-07-12 18:04:12.563198+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/336781\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=a221eb4cc6ea6bd3459495be9d2a443e9808fb1a\nSubmitter: Jenkins\nBranch:    master\n\ncommit a221eb4cc6ea6bd3459495be9d2a443e9808fb1a\nAuthor: Kevin Zhao <email address hidden>\nDate:   Sat Jul 2 09:13:58 2016 +0000\n\n    libvirt: Modify the interface address object assignment\n    \n    In some other arch such as AArch64, the interface of the device\n    has the address \"virtio-mmio\", not \"PCI\" or \"Drive\", so assign the\n    default object \"LibvirtConfigGuestDeviceAddress\" to the interface.\n    Also fix problem for S390x, s390x has address \"ccw\".\n    \n    Closes-Bug: #1598370\n    \n    Change-Id: I10004c2060ff8f5a60e065b237311fe5b9fd1876\n    Signed-off-by: Kevin Zhao <email address hidden>\n", 
            "date_created": "2016-07-25 18:19:18.129809+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b3 development milestone.", 
            "date_created": "2016-09-02 01:16:05.689318+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}