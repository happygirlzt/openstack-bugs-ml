{
    "status": "Fix Released", 
    "last_updated": "2014-11-11 16:49:30.629918+00:00", 
    "description": "When SIGHUP signal is send to nova-api service, it stops all the nova-api processes and while restarting the nova-api processes, it throws AttributeError: 'WSGIService' object has no attribute 'reset'.\n\n\n2014-06-24 15:52:55.185 CRITICAL nova [-] AttributeError: 'WSGIService' object has no attribute 'reset'\n\n2014-06-24 15:52:55.185 TRACE nova Traceback (most recent call last):\n2014-06-24 15:52:55.185 TRACE nova   File \"/usr/local/bin/nova-api\", line 10, in <module>\n2014-06-24 15:52:55.185 TRACE nova     sys.exit(main())\n2014-06-24 15:52:55.185 TRACE nova   File \"/opt/stack/nova/nova/cmd/api.py\", line 56, in main\n2014-06-24 15:52:55.185 TRACE nova     launcher.launch_service(server, workers=server.workers or 1)\n2014-06-24 15:52:55.185 TRACE nova   File \"/opt/stack/nova/nova/openstack/common/service.py\", line 340, in launch_service\n2014-06-24 15:52:55.185 TRACE nova     self._start_child(wrap)\n2014-06-24 15:52:55.185 TRACE nova   File \"/opt/stack/nova/nova/openstack/common/service.py\", line 324, in _start_child\n2014-06-24 15:52:55.185 TRACE nova     launcher.restart()\n2014-06-24 15:52:55.185 TRACE nova   File \"/opt/stack/nova/nova/openstack/common/service.py\", line 145, in restart\n2014-06-24 15:52:55.185 TRACE nova     self.services.restart()\n2014-06-24 15:52:55.185 TRACE nova   File \"/opt/stack/nova/nova/openstack/common/service.py\", line 478, in restart\n2014-06-24 15:52:55.185 TRACE nova     restart_service.reset()\n2014-06-24 15:52:55.185 TRACE nova AttributeError: 'WSGIService' object has no attribute 'reset'\n2014-06-24 15:52:55.185 TRACE nova \n\nSteps to reproduce:\n1. Run nova-api service as daemon.\n2. Send SIGHUP signal to nova-api service\n   kill -1 <parent_process_id_of_nova_api>", 
    "tags": [
        "ntt"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1334651", 
    "owner": "https://api.launchpad.net/1.0/~rajesh-tailor", 
    "id": 1334651, 
    "index": 4952, 
    "created": "2014-06-26 12:56:59.495767+00:00", 
    "title": "Nova api service outputs error messages when SIGHUP signal is sent", 
    "comments": [
        {
            "content": "When SIGHUP signal is send to nova-api service, it stops all the nova-api processes and while restarting the nova-api processes, it throws AttributeError: 'WSGIService' object has no attribute 'reset'.\n\n\n2014-06-24 15:52:55.185 CRITICAL nova [-] AttributeError: 'WSGIService' object has no attribute 'reset'\n\n2014-06-24 15:52:55.185 TRACE nova Traceback (most recent call last):\n2014-06-24 15:52:55.185 TRACE nova   File \"/usr/local/bin/nova-api\", line 10, in <module>\n2014-06-24 15:52:55.185 TRACE nova     sys.exit(main())\n2014-06-24 15:52:55.185 TRACE nova   File \"/opt/stack/nova/nova/cmd/api.py\", line 56, in main\n2014-06-24 15:52:55.185 TRACE nova     launcher.launch_service(server, workers=server.workers or 1)\n2014-06-24 15:52:55.185 TRACE nova   File \"/opt/stack/nova/nova/openstack/common/service.py\", line 340, in launch_service\n2014-06-24 15:52:55.185 TRACE nova     self._start_child(wrap)\n2014-06-24 15:52:55.185 TRACE nova   File \"/opt/stack/nova/nova/openstack/common/service.py\", line 324, in _start_child\n2014-06-24 15:52:55.185 TRACE nova     launcher.restart()\n2014-06-24 15:52:55.185 TRACE nova   File \"/opt/stack/nova/nova/openstack/common/service.py\", line 145, in restart\n2014-06-24 15:52:55.185 TRACE nova     self.services.restart()\n2014-06-24 15:52:55.185 TRACE nova   File \"/opt/stack/nova/nova/openstack/common/service.py\", line 478, in restart\n2014-06-24 15:52:55.185 TRACE nova     restart_service.reset()\n2014-06-24 15:52:55.185 TRACE nova AttributeError: 'WSGIService' object has no attribute 'reset'\n2014-06-24 15:52:55.185 TRACE nova \n\nSteps to reproduce:\n1. Run nova-api service as daemon.\n2. Send SIGHUP signal to nova-api service\n   kill -1 <parent_process_id_of_nova_api>", 
            "date_created": "2014-06-26 12:56:59.495767+00:00", 
            "author": "https://api.launchpad.net/1.0/~rajesh-tailor"
        }, 
        {
            "content": "After adding reset method in WSGIService class.\nWhen SIGHUP signal is send to nova-api service, it stops all the nova-api processes \nand while restarting the nova-api processes, it throws \nerror: [Errno 9] Bad file descriptor.\n\nFile \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    result = function(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 635, in server\nTraceback (most recent call last):\nTraceback (most recent call last):\n    serv = Server(sock, sock.getsockname(),\n  File \"/usr/lib/python2.7/socket.py\", line 224, in meth\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n2014-06-26 20:38:34.240 INFO nova.wsgi [-] WSGI server has stopped.\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 346, in fire_timers\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    timer()\n    result = function(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 635, in server\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    serv = Server(sock, sock.getsockname(),\n2014-06-26 20:38:34.241 INFO nova.wsgi [-] WSGI server has stopped.\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n2014-06-26 20:38:34.241 INFO nova.wsgi [-] WSGI server has stopped.\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 346, in fire_timers\n    result = function(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 635, in server\nTraceback (most recent call last):\n    result = function(*args, **kwargs)\n    return getattr(self._sock,name)(*args)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 635, in server\nTraceback (most recent call last):\n    result = function(*args, **kwargs)\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 346, in fire_timers\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 346, in fire_timers\n    serv = Server(sock, sock.getsockname(),\n  File \"/usr/lib/python2.7/socket.py\", line 224, in meth\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n  File \"/usr/lib/python2.7/socket.py\", line 224, in meth\n    timer()\n    return getattr(self._sock,name)(*args)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n  File \"/usr/lib/python2.7/socket.py\", line 170, in _dummy\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    result = function(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 635, in server\n    result = function(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 635, in server\n    serv = Server(sock, sock.getsockname(),\n  File \"/usr/lib/python2.7/socket.py\", line 224, in meth\n    serv = Server(sock, sock.getsockname(),\n  File \"/usr/lib/python2.7/socket.py\", line 224, in meth\n    return getattr(self._sock,name)(*args)\n  File \"/usr/lib/python2.7/socket.py\", line 170, in _dummy\n    return getattr(self._sock,name)(*args)\n    raise error(EBADF, 'Bad file descriptor')\n    cb(*args, **kw)\n  File \"/usr/lib/python2.7/socket.py\", line 170, in _dummy\nerror: [Errno 9] Bad file descriptor\n  ", 
            "date_created": "2014-07-04 07:37:41.023585+00:00", 
            "author": "https://api.launchpad.net/1.0/~rajesh-tailor"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/104887", 
            "date_created": "2014-07-04 13:02:33.493193+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/104887\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=2f3d774eb51eac9a370813362047a2cb3d124d86\nSubmitter: Jenkins\nBranch:    master\n\ncommit 2f3d774eb51eac9a370813362047a2cb3d124d86\nAuthor: Rajesh Tailor <email address hidden>\nDate:   Thu Jul 3 07:44:20 2014 -0700\n\n    Nova-api service throws error when SIGHUP is sent\n    \n    Added reset method in WSGIService class.\n    \n    After adding reset method when SIGHUP signal is sent to\n    wsgi service parent process,then it sends SIGHUP signal\n    to all of its child processes. Each child process handles\n    SIGHUP signal by first stopping the service and then calls\n    service start method again. When it stops the service, it\n    kills the eventlet thread, which internally closes the wsgi\n    server socket object. This server socket object is now not\n    usable again and it throws following error, while restarting\n    the service:\n    \n    error: [Errno 9] Bad file descriptor\n    \n    To resolve 'Bad file descriptor' error, creating duplicate\n    socket object, every time service starts.\n    \n    When the wsgi service is stopped, it sets the green pool\n    size to 0, so resizing the green pool to default value,\n    on service restart.\n    \n    Closes-Bug: #1334651\n    \n    Change-Id: If1035deaf8b31f2712d88f0112fdd2e9e9dc7cb0\n", 
            "date_created": "2014-07-15 03:02:31.769298+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi Rajesh,\n\nDoes nova-api really support SIGHUP? I test it in devstack environment, the last commit of nova is a7e1433a79b30937e29f69a866172c061ced5a5f(Thu Oct 30 00:35:25 2014 +0000). \n\nWhen I hit \"kill -1 $PID_OF_NOVA_API_PARENT\" nova-api just log below messages then exit\n2014-11-04 08:28:38.520 8249 INFO nova.openstack.common.service [-] Caught SIGHUP, stopping children\n2014-11-04 08:28:38.521 8332 INFO nova.openstack.common.service [-] Child caught SIGTERM, exiting\n2014-11-04 08:28:38.521 8294 INFO nova.openstack.common.service [-] Child caught SIGTERM, exiting\n....\n2014-11-04 08:28:38.557 8249 INFO nova.openstack.common.service [-] Child 8294 exited with status 1\n2014-11-04 08:28:38.557 8249 INFO nova.openstack.common.service [-] Child 8295 exited with status 1\n2014-11-04 08:28:38.557 8249 INFO nova.openstack.common.service [-] Child 8296 exited with status 1\n2014-11-04 08:28:38.558 8249 INFO nova.openstack.common.service [-] Child 8322 exited with status 1\n\nBut in your environment I believe nova plays very well with SIGHUP, is there some config items to enable this feature? do I missing some thing?", 
            "date_created": "2014-11-04 08:31:08.297096+00:00", 
            "author": "https://api.launchpad.net/1.0/~gtt116"
        }, 
        {
            "content": "Hi Tiantian,\n\nYou need to run the nova-api service as daemon.\n\nSteps to reproduce:\n1. Run nova-api service as daemon.\n2. Send SIGHUP signal to nova-api service\n   kill -1 <parent_process_id_of_nova_api>\n\nJust for testing in your environment, you can use below work around to fulfill step 1.\n\ndiff --git a/nova/openstack/common/service.py b/nova/openstack/common/servic\nindex f682b2b..12127d6 100644\n--- a/nova/openstack/common/service.py\n+++ b/nova/openstack/common/service.py\n@@ -77,7 +77,7 @@ def _is_sighup_and_daemon(signo):\n         # Avoid checking if we are a daemon, because the signal isn't\n         # SIGHUP.\n         return False\n-    return _is_daemon()\n+    return True\n\n def _signo_to_signame(signo):\n", 
            "date_created": "2014-11-04 11:00:24.121308+00:00", 
            "author": "https://api.launchpad.net/1.0/~rajesh-tailor"
        }, 
        {
            "content": "Hi Rajesh,\n\nThank you very much for the patch. It works well for me.\n\n2014-11-04 19:00 GMT+08:00 Rajesh Tailor <email address hidden>:\n\n> Hi Tiantian,\n>\n> You need to run the nova-api service as daemon.\n>\n> Steps to reproduce:\n> 1. Run nova-api service as daemon.\n> 2. Send SIGHUP signal to nova-api service\n>    kill -1 <parent_process_id_of_nova_api>\n>\n> Just for testing in your environment, you can use below work around to\n> fulfill step 1.\n>\n> diff --git a/nova/openstack/common/service.py\n> b/nova/openstack/common/servic\n> index f682b2b..12127d6 100644\n> --- a/nova/openstack/common/service.py\n> +++ b/nova/openstack/common/service.py\n> @@ -77,7 +77,7 @@ def _is_sighup_and_daemon(signo):\n>          # Avoid checking if we are a daemon, because the signal isn't\n>          # SIGHUP.\n>          return False\n> -    return _is_daemon()\n> +    return True\n>\n>  def _signo_to_signame(signo):\n>\n> --\n> You received this bug notification because you are subscribed to the bug\n> report.\n> https://bugs.launchpad.net/bugs/1334651\n>\n> Title:\n>   Nova api service outputs error messages when SIGHUP signal is sent\n>\n> Status in OpenStack Compute (Nova):\n>   Fix Released\n> Status in The Oslo library incubator:\n>   Triaged\n>\n> Bug description:\n>   When SIGHUP signal is send to nova-api service, it stops all the nova-\n>   api processes and while restarting the nova-api processes, it throws\n>   AttributeError: 'WSGIService' object has no attribute 'reset'.\n>\n>\n>   2014-06-24 15:52:55.185 CRITICAL nova [-] AttributeError: 'WSGIService'\n> object has no attribute 'reset'\n>\n>   2014-06-24 15:52:55.185 TRACE nova Traceback (most recent call last):\n>   2014-06-24 15:52:55.185 TRACE nova   File \"/usr/local/bin/nova-api\",\n> line 10, in <module>\n>   2014-06-24 15:52:55.185 TRACE nova     sys.exit(main())\n>   2014-06-24 15:52:55.185 TRACE nova   File\n> \"/opt/stack/nova/nova/cmd/api.py\", line 56, in main\n>   2014-06-24 15:52:55.185 TRACE nova     launcher.launch_service(server,\n> workers=server.workers or 1)\n>   2014-06-24 15:52:55.185 TRACE nova   File\n> \"/opt/stack/nova/nova/openstack/common/service.py\", line 340, in\n> launch_service\n>   2014-06-24 15:52:55.185 TRACE nova     self._start_child(wrap)\n>   2014-06-24 15:52:55.185 TRACE nova   File\n> \"/opt/stack/nova/nova/openstack/common/service.py\", line 324, in\n> _start_child\n>   2014-06-24 15:52:55.185 TRACE nova     launcher.restart()\n>   2014-06-24 15:52:55.185 TRACE nova   File\n> \"/opt/stack/nova/nova/openstack/common/service.py\", line 145, in restart\n>   2014-06-24 15:52:55.185 TRACE nova     self.services.restart()\n>   2014-06-24 15:52:55.185 TRACE nova   File\n> \"/opt/stack/nova/nova/openstack/common/service.py\", line 478, in restart\n>   2014-06-24 15:52:55.185 TRACE nova     restart_service.reset()\n>   2014-06-24 15:52:55.185 TRACE nova AttributeError: 'WSGIService' object\n> has no attribute 'reset'\n>   2014-06-24 15:52:55.185 TRACE nova\n>\n>   Steps to reproduce:\n>   1. Run nova-api service as daemon.\n>   2. Send SIGHUP signal to nova-api service\n>      kill -1 <parent_process_id_of_nova_api>\n>\n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/1334651/+subscriptions\n>\n\n\n\n-- \nBest regards,\nTim Gao\n", 
            "date_created": "2014-11-05 07:51:54+00:00", 
            "author": "https://api.launchpad.net/1.0/~gtt116"
        }, 
        {
            "content": "It appears this was fixed in Nova and there's nothing to be done in Oslo.  Let me know if I'm wrong about that.", 
            "date_created": "2014-11-11 16:49:29.924625+00:00", 
            "author": "https://api.launchpad.net/1.0/~bnemec"
        }
    ]
}