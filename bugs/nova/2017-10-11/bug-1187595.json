{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:48:51.733943+00:00", 
    "description": "As of 6b16c8731c44e4a6c80b803f3e8afdd88386d577 (Call scheduler for run_instance from conductor) I'm now getting consistent failures when using Nova w/ qpid. See the stack trace below:\n\n==> /var/log/nova/scheduler.log <==\n2013-06-05 00:32:15.215 10750 ERROR nova.scheduler.driver [req-cbf2bc32-b206-4f00-9216-ad3db8c79567 d01f4833227947a08af2a35dcc3835fc 69c74074c2ed4d7797e2b7cd25e78993] Exception during scheduler.run_instance\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver Traceback (most recent call last):\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/scheduler/filter_scheduler.py\", line 110, in schedule_run_instance\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     instance_uuid=instance_uuid)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/scheduler/filter_scheduler.py\", line 195, in _provision_resource\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     node=weighed_host.obj.nodename)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/compute/rpcapi.py\", line 550, in run_instance\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     version='2.19')\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/proxy.py\", line 166, in cast\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     rpc.cast(context, self._get_topic(topic), msg)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/__init__.py\", line 158, in cast\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     return _get_impl().cast(CONF, context, topic, msg)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/impl_qpid.py\", line 618, in cast\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     rpc_amqp.get_connection_pool(conf, Connection))\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py\", line 627, in cast\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     conn.topic_send(topic, rpc_common.serialize_msg(msg))\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py\", line 152, in __exit__\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self._done()\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py\", line 141, in _done\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.connection.reset()\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/impl_qpid.py\", line 394, in reset\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.session.close()\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"<string>\", line 6, in close\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 739, in close\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.sync(timeout=timeout)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"<string>\", line 6, in sync\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 730, in sync\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     snd.sync(timeout=timeout)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"<string>\", line 6, in sync\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 885, in sync\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     if not self._ewait(lambda: self.acked >= mno, timeout=timeout):\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 799, in _ewait\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     result = self.session._ewait(lambda: self.error or predicate(), timeout)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 566, in _ewait\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     result = self.connection._ewait(lambda: self.error or predicate(), timeout)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 209, in _ewait\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.check_error()\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 202, in check_error\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     raise self.error\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver InternalError: Traceback (most recent call last):\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/driver.py\", line 497, in dispatch\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.engine.dispatch()\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/driver.py\", line 802, in dispatch\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.process(ssn)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/driver.py\", line 1037, in process\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.send(snd, msg)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/driver.py\", line 1248, in send\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     body = enc(msg.content)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/message.py\", line 28, in encode\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     sc.write_primitive(type, x)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 73, in write_primitive\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     getattr(self, \"write_%s\" % type.NAME)(v)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 257, in write_map\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     sc.write(string.joinfields(map(self._write_map_elem, m.keys(), m.values()), \"\"))\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 250, in _write_map_elem\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     sc.write_primitive(type, v)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 73, in write_primitive\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     getattr(self, \"write_%s\" % type.NAME)(v)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 190, in write_str16\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.write_vbin16(s.encode(\"utf8\"))\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 203, in write_vbin16\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.write_uint16(len(b))\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 116, in write_uint16\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     raise CodecException(\"Cannot encode %d as uint16\" % n)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver CodecException: Cannot encode 68527 as uint16", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1187595", 
    "owner": "https://api.launchpad.net/1.0/~alaski", 
    "id": 1187595, 
    "index": 3716, 
    "created": "2013-06-05 00:44:38.499383+00:00", 
    "title": "CodecException: Cannot encode 68527 as uint16", 
    "comments": [
        {
            "content": "As of 6b16c8731c44e4a6c80b803f3e8afdd88386d577 (Call scheduler for run_instance from conductor) I'm now getting consistent failures when using Nova w/ qpid. See the stack trace below:\n\n==> /var/log/nova/scheduler.log <==\n2013-06-05 00:32:15.215 10750 ERROR nova.scheduler.driver [req-cbf2bc32-b206-4f00-9216-ad3db8c79567 d01f4833227947a08af2a35dcc3835fc 69c74074c2ed4d7797e2b7cd25e78993] Exception during scheduler.run_instance\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver Traceback (most recent call last):\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/scheduler/filter_scheduler.py\", line 110, in schedule_run_instance\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     instance_uuid=instance_uuid)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/scheduler/filter_scheduler.py\", line 195, in _provision_resource\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     node=weighed_host.obj.nodename)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/compute/rpcapi.py\", line 550, in run_instance\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     version='2.19')\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/proxy.py\", line 166, in cast\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     rpc.cast(context, self._get_topic(topic), msg)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/__init__.py\", line 158, in cast\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     return _get_impl().cast(CONF, context, topic, msg)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/impl_qpid.py\", line 618, in cast\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     rpc_amqp.get_connection_pool(conf, Connection))\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py\", line 627, in cast\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     conn.topic_send(topic, rpc_common.serialize_msg(msg))\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py\", line 152, in __exit__\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self._done()\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py\", line 141, in _done\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.connection.reset()\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/rpc/impl_qpid.py\", line 394, in reset\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.session.close()\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"<string>\", line 6, in close\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 739, in close\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.sync(timeout=timeout)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"<string>\", line 6, in sync\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 730, in sync\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     snd.sync(timeout=timeout)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"<string>\", line 6, in sync\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 885, in sync\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     if not self._ewait(lambda: self.acked >= mno, timeout=timeout):\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 799, in _ewait\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     result = self.session._ewait(lambda: self.error or predicate(), timeout)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 566, in _ewait\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     result = self.connection._ewait(lambda: self.error or predicate(), timeout)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 209, in _ewait\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.check_error()\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/endpoints.py\", line 202, in check_error\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     raise self.error\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver InternalError: Traceback (most recent call last):\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/driver.py\", line 497, in dispatch\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.engine.dispatch()\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/driver.py\", line 802, in dispatch\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.process(ssn)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/driver.py\", line 1037, in process\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.send(snd, msg)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/driver.py\", line 1248, in send\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     body = enc(msg.content)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/messaging/message.py\", line 28, in encode\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     sc.write_primitive(type, x)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 73, in write_primitive\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     getattr(self, \"write_%s\" % type.NAME)(v)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 257, in write_map\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     sc.write(string.joinfields(map(self._write_map_elem, m.keys(), m.values()), \"\"))\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 250, in _write_map_elem\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     sc.write_primitive(type, v)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 73, in write_primitive\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     getattr(self, \"write_%s\" % type.NAME)(v)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 190, in write_str16\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.write_vbin16(s.encode(\"utf8\"))\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 203, in write_vbin16\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     self.write_uint16(len(b))\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver   File \"/usr/lib/python2.7/site-packages/qpid/codec010.py\", line 116, in write_uint16\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver     raise CodecException(\"Cannot encode %d as uint16\" % n)\n2013-06-05 00:32:15.215 10750 TRACE nova.scheduler.driver CodecException: Cannot encode 68527 as uint16", 
            "date_created": "2013-06-05 00:44:38.499383+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "The commit Dan mentions is https://review.openstack.org/29091", 
            "date_created": "2013-06-05 13:08:03.386853+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "Normally I'd revert things but this commit seemed a bit large for a revert.", 
            "date_created": "2013-06-05 13:13:00.656072+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/31791", 
            "date_created": "2013-06-05 14:13:42.535251+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Is this maybe related to bug 1175808?\nThe error from the trace is the same.", 
            "date_created": "2013-06-05 14:27:37.173911+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanlind"
        }, 
        {
            "content": "Thanks Hans, that does appear to be it.  I was striving for no fundamental changes to the parameters to scheduler_run_instance in https://review.openstack.org/31791 but there were minor changes that must have pushed the message size over the limit.", 
            "date_created": "2013-06-05 15:57:40.500927+00:00", 
            "author": "https://api.launchpad.net/1.0/~alaski"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/31803", 
            "date_created": "2013-06-05 16:07:49.511888+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/31803\nCommitted: http://github.com/openstack/nova/commit/781a8f908cd3e5e69ff8b88d998fa93c48532e15\nSubmitter: Jenkins\nBranch:    master\n\ncommit 781a8f908cd3e5e69ff8b88d998fa93c48532e15\nAuthor: Andrew Laski <email address hidden>\nDate:   Wed Jun 5 10:02:07 2013 -0400\n\n    Update rpc/impl_qpid.py from oslo\n    \n    The current qpid driver cannot serialize objects containing strings\n    longer than 65535 characters.  This just became a breaking issue when\n    the message to scheduler_run_instance went over that limit.  The fix has\n    been commited to oslo, so this just syncs it over to Nova.\n    \n    Bug 1175808\n    Bug 1187595\n    \n    Change-Id: If95c11a7e03c81d89133f6cad0dcbb6d8acb8148\n", 
            "date_created": "2013-06-05 20:33:18.551649+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}