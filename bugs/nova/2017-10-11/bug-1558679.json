{
    "status": "Expired", 
    "last_updated": "2016-08-23 04:38:58.296120+00:00", 
    "description": "Hi,\n\nWhen I attempt to do a live block migration of my VM instance, I see the following exception in my nova-compute.log and migration did not happen:\n\n2016-03-15 12:27:48.121 15330 ERROR oslo_messaging.rpc.dispatcher [req-e41b3f49-8bf8-4a4e-8511-1f8eea811dff b567c533c6a842908a3888a4ce80117e 0a6eee33460e4c86ba591fd427cce163 - - -] Exception during message handling: string indices must be integers\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 6845, in pre_live_migration\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     disk, migrate_data=migrate_data)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 461, in decorated_function\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     payload)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 369, in decorated_function\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 357, in decorated_function\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5272, in pre_live_migration\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     migrate_data)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 6003, in pre_live_migration\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     image_file = os.path.basename(info['path'])\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher TypeError: string indices must be integers\n\nThe Nova/OpenStack version that I'm running is as follows (as shown in 'rpm -qa | grep nova'):\npython-nova-2015.1.2-18.1.el7ost.noarch\npython-novaclient-2.23.0-2.el7ost.noarch\nopenstack-nova-common-2015.1.2-18.1.el7ost.noarch\nopenstack-nova-compute-2015.1.2-18.1.el7ost.noarch\n\nThe '/nova/virt/libvirt/driver.py' file running on my system is dated Mar 4, 2016.  Please note that I have other systems running an older version of the '/nova/virt/libvirt/driver.py' file (dated Jan 22) and live block migration is working fine on those systems.\n\nUpon further investigation, it was noted that the following section of the code in the '/nova/virt/libvirt/driver.py' file that throws exception was added very recently:\n\n            # Recreate the disk.info file and in doing so stop the\n            # imagebackend from recreating it incorrectly by inspecting the\n            # contents of each file when using the Raw backend.\n            if disk_info:\n                image_disk_info = {}\n                for info in disk_info:\n                    image_file = os.path.basename(info['path'])\n                    image_path = os.path.join(instance_dir, image_file)\n                    image_disk_info[image_path] = info['type']\n\n                LOG.debug('Creating disk.info with the contents: %s',\n                          image_disk_info, instance=instance)\n\n                image_disk_info_path = os.path.join(instance_dir,\n                                                    'disk.info')\n                libvirt_utils.write_to_file(image_disk_info_path,\n                                            jsonutils.dumps(image_disk_info))\n\nThe reason why it throws exception seems to be that the 'disk_info' variable that was passed in to the pre_live_migration method was previously encoded using jsonutils.dumps, but the 'disk_info' variable was NOT decoded using jsonutils.loads in this block of code, which causes the 'info' object not being read properly.\n\nAfter updating the code to use jsonutils.loads as follows, the live block migration seems to be working fine:\n\n            if disk_info:\n                disk_info_obj = jsonutils.loads(disk_info)\n                image_disk_info = {}\n                for info in disk_info_obj:\n                    image_file = os.path.basename(info['path'])\n                    image_path = os.path.join(instance_dir, image_file)\n                    image_disk_info[image_path] = info['type']\n\nWould you mind taking a look and share your findings?  If you could also please let me know when the fix would be available, that would be great!  Thanks very much!\n\nRegards,\nAngela", 
    "tags": [
        "live-migration"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1558679", 
    "owner": "None", 
    "id": 1558679, 
    "index": 6107, 
    "created": "2016-03-17 16:59:37.242996+00:00", 
    "title": "Live block migration fails with TypeError exception in driver.py", 
    "comments": [
        {
            "content": "Hi,\n\nWhen I attempt to do a live block migration of my VM instance, I see the following exception in my nova-compute.log and migration did not happen:\n\n2016-03-15 12:27:48.121 15330 ERROR oslo_messaging.rpc.dispatcher [req-e41b3f49-8bf8-4a4e-8511-1f8eea811dff b567c533c6a842908a3888a4ce80117e 0a6eee33460e4c86ba591fd427cce163 - - -] Exception during message handling: string indices must be integers\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 6845, in pre_live_migration\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     disk, migrate_data=migrate_data)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 461, in decorated_function\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     payload)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 369, in decorated_function\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 357, in decorated_function\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 5272, in pre_live_migration\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     migrate_data)\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 6003, in pre_live_migration\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher     image_file = os.path.basename(info['path'])\n2016-03-15 12:27:48.121 15330 TRACE oslo_messaging.rpc.dispatcher TypeError: string indices must be integers\n\nThe Nova/OpenStack version that I'm running is as follows (as shown in 'rpm -qa | grep nova'):\npython-nova-2015.1.2-18.1.el7ost.noarch\npython-novaclient-2.23.0-2.el7ost.noarch\nopenstack-nova-common-2015.1.2-18.1.el7ost.noarch\nopenstack-nova-compute-2015.1.2-18.1.el7ost.noarch\n\nThe '/nova/virt/libvirt/driver.py' file running on my system is dated Mar 4, 2016.  Please note that I have other systems running an older version of the '/nova/virt/libvirt/driver.py' file (dated Jan 22) and live block migration is working fine on those systems.\n\nUpon further investigation, it was noted that the following section of the code in the '/nova/virt/libvirt/driver.py' file that throws exception was added very recently:\n\n            # Recreate the disk.info file and in doing so stop the\n            # imagebackend from recreating it incorrectly by inspecting the\n            # contents of each file when using the Raw backend.\n            if disk_info:\n                image_disk_info = {}\n                for info in disk_info:\n                    image_file = os.path.basename(info['path'])\n                    image_path = os.path.join(instance_dir, image_file)\n                    image_disk_info[image_path] = info['type']\n\n                LOG.debug('Creating disk.info with the contents: %s',\n                          image_disk_info, instance=instance)\n\n                image_disk_info_path = os.path.join(instance_dir,\n                                                    'disk.info')\n                libvirt_utils.write_to_file(image_disk_info_path,\n                                            jsonutils.dumps(image_disk_info))\n\nThe reason why it throws exception seems to be that the 'disk_info' variable that was passed in to the pre_live_migration method was previously encoded using jsonutils.dumps, but the 'disk_info' variable was NOT decoded using jsonutils.loads in this block of code, which causes the 'info' object not being read properly.\n\nAfter updating the code to use jsonutils.loads as follows, the live block migration seems to be working fine:\n\n            if disk_info:\n                disk_info_obj = jsonutils.loads(disk_info)\n                image_disk_info = {}\n                for info in disk_info_obj:\n                    image_file = os.path.basename(info['path'])\n                    image_path = os.path.join(instance_dir, image_file)\n                    image_disk_info[image_path] = info['type']\n\nWould you mind taking a look and share your findings?  If you could also please let me know when the fix would be available, that would be great!  Thanks very much!\n\nRegards,\nAngela", 
            "date_created": "2016-03-17 16:59:37.242996+00:00", 
            "author": "https://api.launchpad.net/1.0/~anglam"
        }, 
        {
            "content": "Seems like duplicated with this one: https://bugs.launchpad.net/nova/+bug/1558697", 
            "date_created": "2016-03-18 00:51:32.449274+00:00", 
            "author": "https://api.launchpad.net/1.0/~yuywz"
        }, 
        {
            "content": "Looks like this bug was never reproduced (and therefore never confirmed) and it's been suggested that it could be a duplicate. Resetting status as New so others can weigh in.", 
            "date_created": "2016-06-16 16:32:08.398032+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "@Angela:\nYou mentioned that you observed this in version 2015.1.2. Please have a look at but 1558697. It looks very similar to your problem and it got fixed with Nova version 2015.1.4. Please check if an upgrade of your system to version 2015.1.4 fixes your issue.\nIf it does, please close this bug report.\nIf it doesn't, please check if the behavior is also in liberty or mitaka, as the Kilo release (2015.1.x) is not supported anymore.", 
            "date_created": "2016-06-23 13:00:11.917027+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2016-08-23 04:19:12.779229+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ]
}