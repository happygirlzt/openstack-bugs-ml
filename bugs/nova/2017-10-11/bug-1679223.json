{
    "status": "Fix Released", 
    "last_updated": "2017-05-01 17:11:24.888870+00:00", 
    "description": "Description\n===========\nThese tempest test cases fail on centos7 nodes:\n    test_server_tags.ServerTagsTestJSON.test_create_delete_tag\n    test_server_tags.ServerTagsTestJSON.test_delete_all_tags\n    test_server_tags.ServerTagsTestJSON.test_update_all_tags\n    test_server_tags.ServerTagsTestJSON.test_check_tag_existence\n\nhttp://logstash.openstack.org/#/dashboard/file/logstash.json?from=7d&query=message:%5C%22Malformed%20request%20body%5C%22\n\n\nSteps to reproduce\n==================\nSee any test run of the 3rd party CI \"IBM zKVM CI\" after the last successful run from 2017-03-30T06:22:14:\nhttp://ci-watch.tintri.com/project?project=nova&time=7+days\n\n\nExpected result\n===============\nThe server tagging functionality tests should work since they got introduced with https://github.com/openstack/tempest/commit/7c95befefb7db27296114f87cf49e8f2b8f43a59\n\n\nActual result\n=============\n\nAs an example:\n\n    [tempest.lib.common.rest_client] \n    Request (ServerTagsTestJSON:test_check_tag_existence): \n    400 PUT https://15.184.67.250:8774/v2.1/servers/b56af78e-d406-4858-9509-473863275223/tags/tempest-tag-151463324\n\n    [tempest.lib.common.rest_client] \n    Request - Headers: \n    {'Content-Type': 'application/json', 'Accept': 'application/json', \n    'X-OpenStack-Nova-API-Version': '2.26', 'X-Auth-Token': '<omitted>'}\n     Body: None\n\n    Response - Headers: {'status': '400', u'content-length': '66', \n    u'server': 'Apache/2.4.6 (CentOS) OpenSSL/1.0.1e-fips mod_wsgi/3.4 Python/2.7.5',\n    u'date': 'Mon, 03 Apr 2017 10:15:12 GMT', \n    u'x-openstack-nova-api-version': '2.26', \n    u'x-compute-request-id': 'req-1f8726fc-df20-4592-a214-cff3fa73c8e6', \n    u'content-type': 'application/json; charset=UTF-8', \n    content-location': 'https://15.184.67.250:8774/v2.1/servers/b56af78e-d406-4858-9509-473863275223/tags/tempest-tag-151463324', \n    u'vary': 'OpenStack-API-Version,X-OpenStack-Nova-API-Version', \n    u'openstack-api-version': 'compute 2.26', \n    u'connection': 'close'}\n    Body: {\"badRequest\": {\"message\": \"Malformed request body\", \"code\": 400}}\n\nTraceback: http://paste.openstack.org/show/605262/\n\n\nEnvironment\n===========\nThis happens in various gate test jobs. The common theme is that the build\nnode is centos7 based. \nLogstash query: http://logstash.openstack.org/#/dashboard/file/logstash.json?from=7d&query=message:%5C%22Malformed%20request%20body%5C%22\n\nYou can also see this constantly on the centos based 3rd party CI \"IBM zKVM CI\":\nhttps://review.openstack.org/#/q/reviewer:%22IBM+zKVM+CI%22\n\nLogs & Configs\n==============\nSee any test run of the 3rd party CI \"IBM zKVM CI\" after the last successful run from 2017-03-30T06:22:14:\nhttp://ci-watch.tintri.com/project?project=nova&time=7+days", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1679223", 
    "owner": "https://api.launchpad.net/1.0/~mzoeller", 
    "id": 1679223, 
    "index": 2060, 
    "created": "2017-04-03 15:55:57.300686+00:00", 
    "title": "tempest.api.compute.servers.test_server_tags.ServerTagsTestJSON fail on centos7 nodes", 
    "comments": [
        {
            "content": "Description\n===========\nThese tempest test cases fail on centos7 nodes:\n    test_server_tags.ServerTagsTestJSON.test_create_delete_tag\n    test_server_tags.ServerTagsTestJSON.test_delete_all_tags\n    test_server_tags.ServerTagsTestJSON.test_update_all_tags\n    test_server_tags.ServerTagsTestJSON.test_check_tag_existence\n\nhttp://logstash.openstack.org/#/dashboard/file/logstash.json?from=7d&query=message:%5C%22Malformed%20request%20body%5C%22\n\n\nSteps to reproduce\n==================\nSee any test run of the 3rd party CI \"IBM zKVM CI\" after the last successful run from 2017-03-30T06:22:14:\nhttp://ci-watch.tintri.com/project?project=nova&time=7+days\n\n\nExpected result\n===============\nThe server tagging functionality tests should work since they got introduced with https://github.com/openstack/tempest/commit/7c95befefb7db27296114f87cf49e8f2b8f43a59\n\n\nActual result\n=============\n\nAs an example:\n\n    [tempest.lib.common.rest_client] \n    Request (ServerTagsTestJSON:test_check_tag_existence): \n    400 PUT https://15.184.67.250:8774/v2.1/servers/b56af78e-d406-4858-9509-473863275223/tags/tempest-tag-151463324\n\n    [tempest.lib.common.rest_client] \n    Request - Headers: \n    {'Content-Type': 'application/json', 'Accept': 'application/json', \n    'X-OpenStack-Nova-API-Version': '2.26', 'X-Auth-Token': '<omitted>'}\n     Body: None\n\n    Response - Headers: {'status': '400', u'content-length': '66', \n    u'server': 'Apache/2.4.6 (CentOS) OpenSSL/1.0.1e-fips mod_wsgi/3.4 Python/2.7.5',\n    u'date': 'Mon, 03 Apr 2017 10:15:12 GMT', \n    u'x-openstack-nova-api-version': '2.26', \n    u'x-compute-request-id': 'req-1f8726fc-df20-4592-a214-cff3fa73c8e6', \n    u'content-type': 'application/json; charset=UTF-8', \n    content-location': 'https://15.184.67.250:8774/v2.1/servers/b56af78e-d406-4858-9509-473863275223/tags/tempest-tag-151463324', \n    u'vary': 'OpenStack-API-Version,X-OpenStack-Nova-API-Version', \n    u'openstack-api-version': 'compute 2.26', \n    u'connection': 'close'}\n    Body: {\"badRequest\": {\"message\": \"Malformed request body\", \"code\": 400}}\n\nTraceback: http://paste.openstack.org/show/605262/\n\n\nEnvironment\n===========\nThis happens in various gate test jobs. The common theme is that the build\nnode is centos7 based. \nLogstash query: http://logstash.openstack.org/#/dashboard/file/logstash.json?from=7d&query=message:%5C%22Malformed%20request%20body%5C%22\n\nYou can also see this constantly on the centos based 3rd party CI \"IBM zKVM CI\":\nhttps://review.openstack.org/#/q/reviewer:%22IBM+zKVM+CI%22\n\nLogs & Configs\n==============\nSee any test run of the 3rd party CI \"IBM zKVM CI\" after the last successful run from 2017-03-30T06:22:14:\nhttp://ci-watch.tintri.com/project?project=nova&time=7+days", 
            "date_created": "2017-04-03 15:55:57.300686+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "What confuses me is, that \"PUT\" is defined as a HTTP method which needs a body:\nhttps://github.com/openstack/nova/blob/94671e279fddc0d8eba29375750dd85410a0b9b9/nova/api/openstack/wsgi.py#L52-L55\n\nBut the servers client in the tempest tests doesn't define a body: \nhttps://github.com/openstack/tempest/blob/14158c95fbfd85847273dc79b9e5d2db75c3d932/tempest/lib/services/compute/servers_client.py#L798-L798\n\nThe nova in-tree functional test cases itself don't generate a body, and use \"POST\" under the cover, which generates a body automatically:\nhttps://github.com/openstack/nova/blob/83404013cb53aef16b97b5616c0627c50af76ac8/nova/tests/functional/api_samples_test_base.py#L493-L509\nCan this hide an issue?\n\nAt last, IIUC, json decode issue won't get logged because that message:\n https://github.com/openstack/nova/blob/94671e279fddc0d8eba29375750dd85410a0b9b9/nova/api/openstack/wsgi.py#L266-L271 \ngets overwritten by:\n https://github.com/openstack/nova/blob/94671e279fddc0d8eba29375750dd85410a0b9b9/nova/api/openstack/wsgi.py#L635-L637", 
            "date_created": "2017-04-03 16:08:26.056919+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "I can reproduce that issue with a Centos7 virtual machine:\n1) setup VM with https://github.com/markuszoeller/openstack/commit/c746607d65b3f9870ad476171c888eb75814b080\n2) log in: `vagrant ssh`\n3) become stack user: `sudo su - stack`\n4) go to prepared devstack: `cd /opt/stack/devstack`\n5) start stack: `make stack`\n6) wait till fully stacked\n7) go to tempest `cd /opt/stack/tempest`\n8) run the server tagging tests: `tempest run --regex tempest.api.compute.servers.test_server_tags.ServerTagsTestJSON`\n\nCaptured traceback:\n~~~~~~~~~~~~~~~~~~~\n    Traceback (most recent call last):\n      File \"tempest/api/compute/servers/test_server_tags.py\", line 76, in test_update_all_tags\n        self._update_server_tags(self.server['id'], tags)\n      File \"tempest/api/compute/servers/test_server_tags.py\", line 50, in _update_server_tags\n        self.client.update_tag(server_id, tag)\n      File \"tempest/lib/services/compute/servers_client.py\", line 798, in update_tag\n        resp, body = self.put(url, None)\n      File \"tempest/lib/common/rest_client.py\", line 341, in put\n        return self.request('PUT', url, extra_headers, headers, body, chunked)\n      File \"tempest/lib/services/compute/base_compute_client.py\", line 48, in request\n        method, url, extra_headers, headers, body, chunked)\n      File \"tempest/lib/common/rest_client.py\", line 666, in request\n        self._error_checker(resp, resp_body)\n      File \"tempest/lib/common/rest_client.py\", line 777, in _error_checker\n        raise exceptions.BadRequest(resp_body, resp=resp)\n    tempest.lib.exceptions.BadRequest: Bad request\n    Details: {u'message': u'Malformed request body', u'code': 400}", 
            "date_created": "2017-04-04 11:36:34.693493+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/453179", 
            "date_created": "2017-04-04 13:49:47.635943+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/453220", 
            "date_created": "2017-04-04 15:25:29.525103+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I'm more and more convinced that the new version of \"webob\" is the culprit. \nOn 2017-04-01 merged https://review.openstack.org/#/c/425950/7 which bumped webob from 1.6.0 to 1.7.1 in the global-requirements.txt\nOn 2017-03-29 merged https://review.openstack.org/#/c/417591/8 with bumped the upper-constraints to 1.7.2\n\nThe webob project lists this as backwards incompatible change:\n\n    Response.__init__ will no longer set the default Content-Type, \n    nor Content-Length on Responses that don't have a body. This \n    allows WebOb to return proper responses for things like \n    Response(status='204 No Content').\n\nhttps://webob.readthedocs.io/en/stable/whatsnew-1.7.html\n\nTheir docs say \"Response object\", but the code change looks like it also affects the Request object: https://github.com/Pylons/webob/pull/281", 
            "date_created": "2017-04-04 15:54:46.654741+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "It's definitely the new version of \"webob\":\n\n                   Python    webob    content_length    tempest\n    -----------------------------------------------------------\n    Ubuntu 1604    2.7.12    1.7.2                 0         ok\n    Centos 7       2.7.5     1.7.2              None     failed\n    Centos 7       2.7.5     1.7.1              None     failed\n    Centos 7       2.7.5     1.6.0                 0         ok\n\nOn a Centos7 system, with a \"webob\" package, downgraded to 1.6.0, the tempest tests succeed because the content_length is set to zero, which allows the Nova API to take the correct code path in: \nhttps://github.com/openstack/nova/blob/94671e279fddc0d8eba29375750dd85410a0b9b9/nova/api/openstack/wsgi.py#L631-L634\n\n", 
            "date_created": "2017-04-05 11:59:30.875662+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "I always forget how Launchpad hates spaces... so here is the same table as above (in less ugly):\n\n...................Python....webob....content_length....tempest\n....-----------------------------------------------------------\n....Ubuntu.1604....2.7.12....1.7.2.................0.........ok\n....Centos.7.......2.7.5.....1.7.2..............None.....failed\n....Centos.7.......2.7.5.....1.7.1..............None.....failed\n....Centos.7.......2.7.5.....1.6.0.................0.........ok", 
            "date_created": "2017-04-05 12:01:42.932695+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "As all Centos7 based test jobs are affected by that, I'm setting the importance as \"high\".", 
            "date_created": "2017-04-05 12:07:18.183998+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/453220\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7db528379ac8bd9a1f2101a73f78f882884825da\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7db528379ac8bd9a1f2101a73f78f882884825da\nAuthor: Markus Zoeller <email address hidden>\nDate:   Tue Apr 4 17:23:09 2017 +0200\n\n    API: accept None as content-length in HTTP requests\n    \n    The API defines PUT and POST as HTTP methods which need a request body.\n    It is allowed, that this request body might be of zero length. What was\n    missing is, that the \"content-length\" of the request also might be None.\n    \n    The tempest test cases of servers.test_server_tags.ServerTagsTestJSON\n    revealed that a PUT with a non-existing body raises a BadRequest exception\n    because of the missing \"content-length\".\n    \n      [tempest.lib.common.rest_client]\n      Request - Headers:\n      {'Content-Type': 'application/json', 'Accept': 'application/json',\n      'X-OpenStack-Nova-API-Version': '2.26', 'X-Auth-Token': '<omitted>'}\n      Body: None\n    \n      Response - Headers: {'status': '400', u'content-length': '66',\n      u'server': 'Apache/2.4.6 (CentOS)\n                  OpenSSL/1.0.1e-fips mod_wsgi/3.4 Python/2.7.5',\n      u'date': 'Mon, 03 Apr 2017 10:15:12 GMT',\n      u'x-openstack-nova-api-version': '2.26',\n      u'x-compute-request-id': 'req-1f8726fc-df20-4592-a214-cff3fa73c8e6',\n      u'content-type': 'application/json; charset=UTF-8',\n      content-location': 'https://ctrl:8774/v2.1/servers/<uuid>/tags/mytag',\n      u'vary': 'OpenStack-API-Version,X-OpenStack-Nova-API-Version',\n      u'openstack-api-version': 'compute 2.26',\n      u'connection': 'close'}\n      Body: {\"badRequest\":\n              {\"message\": \"Malformed request body\", \"code\": 400}\n            }\n    \n    For some reason this, this seems to only occur on centos7 test nodes,\n    but not on ubuntu xenial nodes. The root cause is still unclear to me.\n    I suspect the underlying \"webob.Request\" object which is used in Nova's\n    API, but I don't have proof for that.\n    \n    This change checks for \"content-length is None\". The logic to determine the\n    request content was part of a very long method which is hard to test. That's\n    why I extracted the code paths to a new method. That made the unit test much\n    easier.\n    \n    Change I3236648f79f44d2758bb7ab0d64d58b0143f6bdb alters the tempest test\n    cases which revealed the missing handling of \"content-length is None\".\n    \n    Change-Id: Id0b0ab5050a4ec15ab2a0d0dd67fcefe4b1ecb39\n    Closes-Bug: #1679223\n", 
            "date_created": "2017-04-05 20:23:13.082025+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b1 development milestone.", 
            "date_created": "2017-04-14 09:22:20.507075+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Markus Zoeller (markus_z) (<email address hidden>) on branch: master\nReview: https://review.openstack.org/453179\nReason: I'm out of arguments. This patch has technically a -2, but you have to read the comments for that.", 
            "date_created": "2017-04-27 12:05:20.260692+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This bug is not necessary to be fixed on Tempest side as https://review.openstack.org/453179", 
            "date_created": "2017-05-01 17:11:23.660374+00:00", 
            "author": "https://api.launchpad.net/1.0/~oomichi"
        }
    ]
}