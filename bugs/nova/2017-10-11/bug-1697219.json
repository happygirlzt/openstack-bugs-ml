{
    "status": "Confirmed", 
    "last_updated": "2017-06-28 12:23:59.794779+00:00", 
    "description": "Description\n===========\nI'm surprised not to have found reference to this already, so forgive me if this is just user error. \n\nIt seems that when using the VMWareVCDriver and your VMWare cluster has multiple datastores, the total storage capacity reported to Nova is that of the selected datastore instead of the combined capacity of all valid datastores.\n\nFurther, in the logs i see nova.compute.resource_tracker lists phys_disk as the total capacity of the selected datastore, but used_disk seems to be the total used storage across all datastores (or possibly the total storage consumed by deployed instances? I'm not sure how that figure is calculated). \n\nThe end result is that with, say, two 6TB datastores, once you have more than 3TB of data on each of them, your total used_disk figure is greater than the total capacity returned by phys_disk which results in the cluster being an invalid destination and you can no longer start instances. However, in reality you still have almost 6TB of available storage so it should be fine.\n\nAssuming this is valid, and i haven't done something stupid somewhere, i think there are two possible solutions:\n\n1. Correct the total phys_disk figure to account for all valid datastores\n2. Adjust the used_disk figure to only return the used amount for the selected datastore\n\n\nSteps to reproduce\n==================\nTo reproduce, set up an environment using vCenter. Provision more than one datastore and then begin filling them. If you had two 100 GB data stores, then filling them both beyond 50GB should reproduce the problem. \n\n\nExpected result\n===============\nI would expect that for a given cluster the total storage capacity would be the sum of the capacities of the valid datastores.\n\n\nActual result\n=============\nThe actual result is that the total capacity reported is that of the datastore with the largest amount of free space (and that matches any regex if it's provided).\n\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. \n\ndpkg -l | grep nova\nii  nova-common                        2:15.0.2-0ubuntu1~cloud0                   all          OpenStack Compute - common files\nii  nova-compute                       2:15.0.2-0ubuntu1~cloud0                   all          OpenStack Compute - compute node base\nii  nova-compute-kvm                   2:15.0.2-0ubuntu1~cloud0                   all          OpenStack Compute - compute node (KVM)\nii  nova-compute-libvirt               2:15.0.2-0ubuntu1~cloud0                   all          OpenStack Compute - compute node libvirt support\nii  python-nova                        2:15.0.2-0ubuntu1~cloud0                   all          OpenStack Compute Python libraries\n\n\n\n2. Which hypervisor did you use?\n   vCenter 6.5 + Esxi 6.5\n\n2. Which storage type did you use?\n   VMWare Datastore VMFS 6", 
    "tags": [
        "openstack-version.ocata", 
        "vmware"
    ], 
    "importance": "Low", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1697219", 
    "owner": "None", 
    "id": 1697219, 
    "index": 931, 
    "created": "2017-06-10 21:46:50.510490+00:00", 
    "title": "VMWareVCDriver Incorrectly reports total datastore capacity", 
    "comments": [
        {
            "content": "Description\n===========\nI'm surprised not to have found reference to this already, so forgive me if this is just user error. \n\nIt seems that when using the VMWareVCDriver and your VMWare cluster has multiple datastores, the total storage capacity reported to Nova is that of the selected datastore instead of the combined capacity of all valid datastores.\n\nFurther, in the logs i see nova.compute.resource_tracker lists phys_disk as the total capacity of the selected datastore, but used_disk seems to be the total used storage across all datastores (or possibly the total storage consumed by deployed instances? I'm not sure how that figure is calculated). \n\nThe end result is that with, say, two 6TB datastores, once you have more than 3TB of data on each of them, your total used_disk figure is greater than the total capacity returned by phys_disk which results in the cluster being an invalid destination and you can no longer start instances. However, in reality you still have almost 6TB of available storage so it should be fine.\n\nAssuming this is valid, and i haven't done something stupid somewhere, i think there are two possible solutions:\n\n1. Correct the total phys_disk figure to account for all valid datastores\n2. Adjust the used_disk figure to only return the used amount for the selected datastore\n\n\nSteps to reproduce\n==================\nTo reproduce, set up an environment using vCenter. Provision more than one datastore and then begin filling them. If you had two 100 GB data stores, then filling them both beyond 50GB should reproduce the problem. \n\n\nExpected result\n===============\nI would expect that for a given cluster the total storage capacity would be the sum of the capacities of the valid datastores.\n\n\nActual result\n=============\nThe actual result is that the total capacity reported is that of the datastore with the largest amount of free space (and that matches any regex if it's provided).\n\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. \n\ndpkg -l | grep nova\nii  nova-common                        2:15.0.2-0ubuntu1~cloud0                   all          OpenStack Compute - common files\nii  nova-compute                       2:15.0.2-0ubuntu1~cloud0                   all          OpenStack Compute - compute node base\nii  nova-compute-kvm                   2:15.0.2-0ubuntu1~cloud0                   all          OpenStack Compute - compute node (KVM)\nii  nova-compute-libvirt               2:15.0.2-0ubuntu1~cloud0                   all          OpenStack Compute - compute node libvirt support\nii  python-nova                        2:15.0.2-0ubuntu1~cloud0                   all          OpenStack Compute Python libraries\n\n\n\n2. Which hypervisor did you use?\n   vCenter 6.5 + Esxi 6.5\n\n2. Which storage type did you use?\n   VMWare Datastore VMFS 6", 
            "date_created": "2017-06-10 21:46:50.510490+00:00", 
            "author": "https://api.launchpad.net/1.0/~njhowell"
        }, 
        {
            "content": "Automatically discovered version ocata in description. If this is incorrect, please update the description to include 'nova version: ...'", 
            "date_created": "2017-06-27 16:04:05.875344+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}