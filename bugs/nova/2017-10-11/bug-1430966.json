{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:52:28.340936+00:00", 
    "description": "When an instance is using an image that gets deleted, the instance will fail to launch if it is hard-rebooted.\n\nSteps to reproduce:\n\n    1. Launch new instance using cirros 0.3.2 image\n\n    2. After instance is done booting, delete the cirros 0.3.2 image files\n\n    3. Return to 'instances' page and select \"hard reboot\" for instance\n\nExpected behavior:\n\n    Image should successfully reboot\n\nActual behvior:\n\n    UI reports \"Error: Failed to launch instance ...\" (image could not be found),\n    and the instance goes into error state", 
    "tags": [], 
    "importance": "Low", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1430966", 
    "owner": "https://api.launchpad.net/1.0/~darren-s", 
    "id": 1430966, 
    "index": 333, 
    "created": "2015-03-11 18:59:32.792656+00:00", 
    "title": "Image deletion causes instance hard-reboot failure", 
    "comments": [
        {
            "content": "When an instance is using an image that gets deleted, the instance will fail to launch if it is hard-rebooted.\n\nSteps to reproduce:\n\n    1. Launch new instance using cirros 0.3.2 image\n\n    2. After instance is done booting, delete the cirros 0.3.2 image files\n\n    3. Return to 'instances' page and select \"hard reboot\" for instance\n\nExpected behavior:\n\n    Image should successfully reboot\n\nActual behvior:\n\n    UI reports \"Error: Failed to launch instance ...\" (image could not be found),\n    and the instance goes into error state", 
            "date_created": "2015-03-11 18:59:32.792656+00:00", 
            "author": "https://api.launchpad.net/1.0/~darren-s"
        }, 
        {
            "content": "Additional detail and steps to reproduce using the CLI.\n\n\nCLI commands to reproduce\n=========================\n$ nova boot --availability-zone nova --image cirros-0.3.2-x86_64-uec --flavor m1.tiny inst1\n$ glance image-delete cirros-0.3.2-x86_64-uec cirros-0.3.2-x86_64-uec-kernel cirros-0.3.2-x86_64-uec-ramdisk\n$ nova reboot --hard bcfc5d83-7d22-42c3-b7be-cf83c63c5f10\n\n$ nova list\n+--------------------------------------+-------+--------+------------+-------------+------------------+\n| ID                                   | Name  | Status | Task State | Power State | Networks         |\n+--------------------------------------+-------+--------+------------+-------------+------------------+\n| bcfc5d83-7d22-42c3-b7be-cf83c63c5f10 | inst1 | ERROR  | -          | Running     | private=10.0.0.3 |\n+--------------------------------------+-------+--------+------------+-------------+------------------+\n\n\nStacktrace from Nova Compute screen log:\n========================================\n\n2015-03-11 12:53:17.318 ERROR oslo_messaging.rpc.dispatcher [req-c28bee61-2e10-4363-8f6a-fc83ee0fe48f admin admin] Exception during message handling: Image 68a7d315-5ef6-436f-bd39-739d0076f99c could not be found.\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/exception.py\", line 88, in wrapped\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     payload)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 82, in __exit__\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/exception.py\", line 71, in wrapped\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 302, in decorated_function\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     pass\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 82, in __exit__\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 287, in decorated_function\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 352, in decorated_function\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 330, in decorated_function\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 82, in __exit__\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 318, in decorated_function\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 3037, in reboot_instance\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     self._set_instance_obj_error_state(context, instance)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 82, in __exit__\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 3018, in reboot_instance\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     bad_volumes_callback=bad_volumes_callback)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1986, in reboot\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     block_device_info)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2090, in _hard_reboot\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     disk_info_json)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5915, in _create_images_and_backing\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     context, instance, fallback_from_host=fallback_from_host)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5687, in _fetch_instance_kernel_ramdisk\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     instance, fallback_from_host)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5667, in _try_fetch_image\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     instance.project_id)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 501, in fetch_image\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     max_size=max_size)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/images.py\", line 87, in fetch_to_raw\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     max_size=max_size)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/images.py\", line 77, in fetch\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     IMAGE_API.download(context, image_href, dest_path=path)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/image/api.py\", line 182, in download\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     dst_path=dest_path)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/image/glance.py\", line 352, in download\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     _reraise_translated_image_exception(image_id)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/image/glance.py\", line 350, in download\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     image_chunks = self._client.call(context, 1, 'data', image_id)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/image/glance.py\", line 219, in call\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     return getattr(client.images, method)(*args, **kwargs)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/glanceclient/v1/images.py\", line 143, in data\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     % urlparse.quote(str(image_id)))\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/glanceclient/common/http.py\", line 262, in get\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     return self._request('GET', url, **kwargs)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/glanceclient/common/http.py\", line 230, in _request\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher     raise exc.from_response(resp, resp.text)\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher ImageNotFound: Image 68a7d315-5ef6-436f-bd39-739d0076f99c could not be found.\n2015-03-11 12:53:17.318 TRACE oslo_messaging.rpc.dispatcher \n\n", 
            "date_created": "2015-03-11 20:00:08.365498+00:00", 
            "author": "https://api.launchpad.net/1.0/~darren-s"
        }, 
        {
            "content": "This test was done using Nova Master branch\n\nNova commit 4103a86f30bf7da3e4616d9d769213b128f0946d\n\nI've also confirmed the bug in Icehouse, so presumably it also exists in Juno.\n", 
            "date_created": "2015-03-11 20:20:20.564601+00:00", 
            "author": "https://api.launchpad.net/1.0/~darren-s"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/163661", 
            "date_created": "2015-03-12 01:03:26.605962+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}