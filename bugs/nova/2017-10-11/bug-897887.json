{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:00:40.496965+00:00", 
    "description": "There appears to be a race condition when creating a server and then quickly deleting a server in using Xen.\n\nThe trace is an example of a result of this race condition, but the general problem of what to do when an instance has not finished booting initially but we receive a delete should be addressed.\n\n\n2011-11-29 18:12:26,422 WARNING nova.virt.xenapi [d999221b-b265-44f3-aba5-2de28a346564 None None] Task [Async.host.call_plugin] OpaqueRef:ddf715fd-05fe-082c-1481-4193f9cee736 status: failure    ['XENAPI_PLUGIN_EXCEPTION', 'version', 'XenstoreError', \"cmd: ['xenstore-rm', '/local/domain/270/data/host/5a7cafc3-8ce0-4b19-baac-7248e859b02e']; returncode: 1; stderr: xenstore-rm: could not remove path /local/domain/270/data/host/5a7cafc3-8ce0-4b19-baac-7248e859b02e\\n; stdout: \"]\n2011-11-29 18:12:26,422 ERROR nova.virt.xenapi.vmops [-] The call to version returned an error: ['XENAPI_PLUGIN_EXCEPTION', 'version', 'XenstoreError', \"cmd: ['xenstore-rm', '/local/domain/270/data/host/5a7cafc3-8ce0-4b19-baac-7248e859b02e']; returncode: 1; stderr: xenstore-rm: could not remove path /local/domain/270/data/host/5a7cafc3-8ce0-4b19-baac-7248e859b02e\\n; stdout: \"]. VM id=2232; args={'path': '', 'dom_id': '270', 'id': '5a7cafc3-8ce0-4b19-baac-7248e859b02e'}\n2011-11-29 18:12:26,423 ERROR nova.virt.xenapi.vmops [-] Failed to query agent version: {'message': '; stdout: ', 'returncode': 'error'}\n2011-11-29 18:12:26,472 WARNING nova.virt.xenapi.vmops [-] ['HANDLE_INVALID', 'VM', 'OpaqueRef:18a07139-2918-7551-ea50-508585bde4bc']\n2011-11-29 18:12:26,472 ERROR nova.virt.xenapi.vmops [-] Instance instance-b79dce45-4ab0-4722-8eff-d97d4d69ee75: failed to boot\n(nova.virt.xenapi.vmops): TRACE: Traceback (most recent call last):\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/xenapi/vmops.py\", line 499, in _wait_for_boot\n(nova.virt.xenapi.vmops): TRACE:     _check_agent_version()\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/xenapi/vmops.py\", line 440, in _check_agent_version\n(nova.virt.xenapi.vmops): TRACE:     version = self.get_agent_version(instance)\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/xenapi/vmops.py\", line 852, in get_agent_version\n(nova.virt.xenapi.vmops): TRACE:     vm_rec = self._session.call_xenapi(\"VM.get_record\", vm_ref)\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/xenapi_conn.py\", line 491, in call_xenapi\n(nova.virt.xenapi.vmops): TRACE:     return tpool.execute(f, *args)\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/lib/pymodules/python2.6/eventlet/tpool.py\", line 76, in tworker\n(nova.virt.xenapi.vmops): TRACE:     rv = meth(*args,**kwargs)\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 229, in __call__\n(nova.virt.xenapi.vmops): TRACE:     return self.__send(self.__name, args)\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 133, in xenapi_request\n(nova.virt.xenapi.vmops): TRACE:     result = _parse_result(getattr(self, methodname)(*full_params))\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 203, in _parse_result\n(nova.virt.xenapi.vmops): TRACE:     raise Failure(result['ErrorDescription'])\n(nova.virt.xenapi.vmops): TRACE: Failure: ['HANDLE_INVALID', 'VM', 'OpaqueRef:18a07139-2918-7551-ea50-508585bde4bc']\n(nova.virt.xenapi.vmops): TRACE:", 
    "tags": [
        "concurrency"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/897887", 
    "owner": "https://api.launchpad.net/1.0/~johannes.erdfelt", 
    "id": 897887, 
    "index": 2665, 
    "created": "2011-11-29 22:00:59.684147+00:00", 
    "title": "Delete while creating: HANDLE_INVALID", 
    "comments": [
        {
            "content": "There appears to be a race condition when creating a server and then quickly deleting a server in using Xen.\n\nThe trace is an example of a result of this race condition, but the general problem of what to do when an instance has not finished booting initially but we receive a delete should be addressed.\n\n\n2011-11-29 18:12:26,422 WARNING nova.virt.xenapi [d999221b-b265-44f3-aba5-2de28a346564 None None] Task [Async.host.call_plugin] OpaqueRef:ddf715fd-05fe-082c-1481-4193f9cee736 status: failure    ['XENAPI_PLUGIN_EXCEPTION', 'version', 'XenstoreError', \"cmd: ['xenstore-rm', '/local/domain/270/data/host/5a7cafc3-8ce0-4b19-baac-7248e859b02e']; returncode: 1; stderr: xenstore-rm: could not remove path /local/domain/270/data/host/5a7cafc3-8ce0-4b19-baac-7248e859b02e\\n; stdout: \"]\n2011-11-29 18:12:26,422 ERROR nova.virt.xenapi.vmops [-] The call to version returned an error: ['XENAPI_PLUGIN_EXCEPTION', 'version', 'XenstoreError', \"cmd: ['xenstore-rm', '/local/domain/270/data/host/5a7cafc3-8ce0-4b19-baac-7248e859b02e']; returncode: 1; stderr: xenstore-rm: could not remove path /local/domain/270/data/host/5a7cafc3-8ce0-4b19-baac-7248e859b02e\\n; stdout: \"]. VM id=2232; args={'path': '', 'dom_id': '270', 'id': '5a7cafc3-8ce0-4b19-baac-7248e859b02e'}\n2011-11-29 18:12:26,423 ERROR nova.virt.xenapi.vmops [-] Failed to query agent version: {'message': '; stdout: ', 'returncode': 'error'}\n2011-11-29 18:12:26,472 WARNING nova.virt.xenapi.vmops [-] ['HANDLE_INVALID', 'VM', 'OpaqueRef:18a07139-2918-7551-ea50-508585bde4bc']\n2011-11-29 18:12:26,472 ERROR nova.virt.xenapi.vmops [-] Instance instance-b79dce45-4ab0-4722-8eff-d97d4d69ee75: failed to boot\n(nova.virt.xenapi.vmops): TRACE: Traceback (most recent call last):\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/xenapi/vmops.py\", line 499, in _wait_for_boot\n(nova.virt.xenapi.vmops): TRACE:     _check_agent_version()\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/xenapi/vmops.py\", line 440, in _check_agent_version\n(nova.virt.xenapi.vmops): TRACE:     version = self.get_agent_version(instance)\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/xenapi/vmops.py\", line 852, in get_agent_version\n(nova.virt.xenapi.vmops): TRACE:     vm_rec = self._session.call_xenapi(\"VM.get_record\", vm_ref)\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/xenapi_conn.py\", line 491, in call_xenapi\n(nova.virt.xenapi.vmops): TRACE:     return tpool.execute(f, *args)\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/lib/pymodules/python2.6/eventlet/tpool.py\", line 76, in tworker\n(nova.virt.xenapi.vmops): TRACE:     rv = meth(*args,**kwargs)\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 229, in __call__\n(nova.virt.xenapi.vmops): TRACE:     return self.__send(self.__name, args)\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 133, in xenapi_request\n(nova.virt.xenapi.vmops): TRACE:     result = _parse_result(getattr(self, methodname)(*full_params))\n(nova.virt.xenapi.vmops): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 203, in _parse_result\n(nova.virt.xenapi.vmops): TRACE:     raise Failure(result['ErrorDescription'])\n(nova.virt.xenapi.vmops): TRACE: Failure: ['HANDLE_INVALID', 'VM', 'OpaqueRef:18a07139-2918-7551-ea50-508585bde4bc']\n(nova.virt.xenapi.vmops): TRACE:", 
            "date_created": "2011-11-29 22:00:59.684147+00:00", 
            "author": "https://api.launchpad.net/1.0/~westmaas"
        }, 
        {
            "content": "Note further that create/delete isn't the only race condition, anything that interacts with Xen directly may have this same issue: pause/unpause, etc.", 
            "date_created": "2011-11-29 22:05:56.555203+00:00", 
            "author": "https://api.launchpad.net/1.0/~westmaas"
        }, 
        {
            "content": "Just for reference, this is a similar problem to https://bugs.launchpad.net/nova/+bug/887708\n\nBut it appears to be caused by a slightly different problem.", 
            "date_created": "2011-12-05 20:26:06.264449+00:00", 
            "author": "https://api.launchpad.net/1.0/~johannes.erdfelt"
        }, 
        {
            "content": "I don't think this is a duplicate of bug #893582. This bug deals with deleting a different VM from the one being created. Bug #893582 deals with deleting the same VM as the one being created.\n\nI think they have different failure scenarios and should be separate bugs.", 
            "date_created": "2011-12-07 19:45:38.662570+00:00", 
            "author": "https://api.launchpad.net/1.0/~johannes.erdfelt"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2257\nCommitted: http://github.com/openstack/nova/commit/d58c2d2bae97c9193e54056405a8f851051fdada\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit d58c2d2bae97c9193e54056405a8f851051fdada\nAuthor: Johannes Erdfelt <email address hidden>\nDate:   Mon Dec 12 18:01:54 2011 +0000\n\n    Make XenAPI agent configuration synchronous\n    \n    Fixes bug 897887\n    \n    Much of the XenAPI agent configuration happens asynchronously from the\n    spawn process. This allows the instance to go ACTIVE state earlier and\n    leaves the possibility of a race with delete open. This makes the\n    steps synchronous, ensuring the process only goes to ACTIVE after the\n    configuration is done.\n    \n    Change-Id: I294b595128979e153c797d9e610b66bc76f47666\n", 
            "date_created": "2011-12-15 17:13:19+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }
    ]
}