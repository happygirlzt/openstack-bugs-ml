{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:11:18.667574+00:00", 
    "description": "Just did a distro upgrade to juno rc2.. Running an old nova-network cloud with mult-host, nova-api running on compute host.  Noticed ubuntu instances cloud-init is failing:\n\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/dist-packages/boto/utils.py\", line 177, in retry_url\n    resp = urllib2.urlopen(req)\n  File \"/usr/lib/python2.7/urllib2.py\", line 126, in urlopen\n    return _opener.open(url, data, timeout)\n  File \"/usr/lib/python2.7/urllib2.py\", line 406, in open\n    response = meth(req, response)\n  File \"/usr/lib/python2.7/urllib2.py\", line 519, in http_response\n    'http', request, response, code, msg, hdrs)\n  File \"/usr/lib/python2.7/urllib2.py\", line 444, in error\n    return self._call_chain(*args)\n  File \"/usr/lib/python2.7/urllib2.py\", line 378, in _call_chain\n    result = func(*args)\n  File \"/usr/lib/python2.7/urllib2.py\", line 527, in http_error_default\n    raise HTTPError(req.get_full_url(), code, msg, hdrs, fp)\n\nLooking at nova-api.log on compute, webob is throwing an exception:\n\n2014-10-13 13:47:37.468 9183 INFO nova.metadata.wsgi.server [req-e133f95b-5f99-41e5-89dc-8e35b41f7cd6 None] 10.0.0.6 \"GET /2009-04-04/meta-data/security-groups HTTP/1.1\" status: 400 len: 265 time: 0.2675409\n2014-10-13 13:48:41.947 9182 ERROR nova.api.ec2 [req-47b84883-a48c-4004-914b-c983895a33be None] FaultWrapper: You cannot set Response.body to a text object (use Response.text)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2 Traceback (most recent call last):\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 87, in __call__\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     return req.get_response(self.application)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1320, in send\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     application, catch_exc_info=False)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1284, in call_application\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     app_iter = application(self.environ, start_response)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     resp = self.call_func(req, *args, **self.kwargs)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     return self.func(req, *args, **kwargs)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 99, in __call__\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     rv = req.get_response(self.application)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1320, in send\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     application, catch_exc_info=False)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1284, in call_application\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     app_iter = application(self.environ, start_response)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     resp = self.call_func(req, *args, **self.kwargs)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     return self.func(req, *args, **kwargs)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/nova/api/metadata/handler.py\", line 136, in __call__\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     req.response.body = resp\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/response.py\", line 373, in _body__set\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     raise TypeError(msg)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2 TypeError: You cannot set Response.body to a text object (use Response.text)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2 \n\nA bit of poking shows that nova.api.metadata.base.ec2_md_print() is converting the secgroup list to string:\n\n    elif isinstance(data, list):\n        return '\\n'.join(data)\n\n.. but in this case data=[u'default'], and the exception is being raised when resp.body = u'default'.  ec2_md_print() needs to ensure its returning non-unicode string here.", 
    "tags": [
        "ec2", 
        "in-stable-juno", 
        "juno-backport-potential"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1380792", 
    "owner": "https://api.launchpad.net/1.0/~gandelman-a", 
    "id": 1380792, 
    "index": 1637, 
    "created": "2014-10-13 20:55:30.046805+00:00", 
    "title": "requests to EC2 metadata's '/2009-04-04/meta-data/security-groups' failing", 
    "comments": [
        {
            "content": "Just did a distro upgrade to juno rc2.. Running an old nova-network cloud with mult-host, nova-api running on compute host.  Noticed ubuntu instances cloud-init is failing:\n\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/dist-packages/boto/utils.py\", line 177, in retry_url\n    resp = urllib2.urlopen(req)\n  File \"/usr/lib/python2.7/urllib2.py\", line 126, in urlopen\n    return _opener.open(url, data, timeout)\n  File \"/usr/lib/python2.7/urllib2.py\", line 406, in open\n    response = meth(req, response)\n  File \"/usr/lib/python2.7/urllib2.py\", line 519, in http_response\n    'http', request, response, code, msg, hdrs)\n  File \"/usr/lib/python2.7/urllib2.py\", line 444, in error\n    return self._call_chain(*args)\n  File \"/usr/lib/python2.7/urllib2.py\", line 378, in _call_chain\n    result = func(*args)\n  File \"/usr/lib/python2.7/urllib2.py\", line 527, in http_error_default\n    raise HTTPError(req.get_full_url(), code, msg, hdrs, fp)\n\nLooking at nova-api.log on compute, webob is throwing an exception:\n\n2014-10-13 13:47:37.468 9183 INFO nova.metadata.wsgi.server [req-e133f95b-5f99-41e5-89dc-8e35b41f7cd6 None] 10.0.0.6 \"GET /2009-04-04/meta-data/security-groups HTTP/1.1\" status: 400 len: 265 time: 0.2675409\n2014-10-13 13:48:41.947 9182 ERROR nova.api.ec2 [req-47b84883-a48c-4004-914b-c983895a33be None] FaultWrapper: You cannot set Response.body to a text object (use Response.text)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2 Traceback (most recent call last):\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 87, in __call__\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     return req.get_response(self.application)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1320, in send\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     application, catch_exc_info=False)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1284, in call_application\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     app_iter = application(self.environ, start_response)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     resp = self.call_func(req, *args, **self.kwargs)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     return self.func(req, *args, **kwargs)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/nova/api/ec2/__init__.py\", line 99, in __call__\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     rv = req.get_response(self.application)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1320, in send\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     application, catch_exc_info=False)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1284, in call_application\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     app_iter = application(self.environ, start_response)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     resp = self.call_func(req, *args, **self.kwargs)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     return self.func(req, *args, **kwargs)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/nova/api/metadata/handler.py\", line 136, in __call__\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     req.response.body = resp\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2   File \"/usr/lib/python2.7/dist-packages/webob/response.py\", line 373, in _body__set\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2     raise TypeError(msg)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2 TypeError: You cannot set Response.body to a text object (use Response.text)\n2014-10-13 13:48:41.947 9182 TRACE nova.api.ec2 \n\nA bit of poking shows that nova.api.metadata.base.ec2_md_print() is converting the secgroup list to string:\n\n    elif isinstance(data, list):\n        return '\\n'.join(data)\n\n.. but in this case data=[u'default'], and the exception is being raised when resp.body = u'default'.  ec2_md_print() needs to ensure its returning non-unicode string here.", 
            "date_created": "2014-10-13 20:55:30.046805+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "Which versions of webob and boto are you using?", 
            "date_created": "2014-10-13 21:02:32.905291+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This is bad:\n\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/api/ec2/__init__.py?id=2014.2.rc2#n89\n\nWe aren't supposed to cast exceptions to unicode, <email address hidden> had a patch to fix these in nova I thought as part of the i18n work.\n\nHowever, adam_g pointed out he's using boto 2.20.1 and the min version required for nova rc2 is >= 2.32.1:\n\nhttp://git.openstack.org/cgit/openstack/nova/tree/requirements.txt?id=2014.2.rc2#n9\n\nSo try using a newer boto and see if the problem goes away.", 
            "date_created": "2014-10-13 21:05:21.955701+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/128100", 
            "date_created": "2014-10-13 21:15:13.142519+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Tested with the boto described in requirements (2.33.0) and the issue still exists.  It's not boto related, its a webob excpetion raised when attempting to set:\n\nreq.response.body = u'foo'\n*** TypeError: You cannot set Response.body to a text object (use Response.text)\n", 
            "date_created": "2014-10-13 21:15:55.002606+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "It looks like security groups metadata always exists internally as a list of unicode names, however nova's unit test coverage doesn't stress fetching any metadata that would trigger this.  AFAICS 'security_groups' is the only bit of ec2 metadata that would contain a list, adding a simple unit test to fetch that path triggers the bug.  I can't find anything in Tempest that would hit this, either.", 
            "date_created": "2014-10-13 23:43:45.760239+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "Proposed a failing test to tempest that triggers the issue: https://review.openstack.org/#/c/128422/\n\nhttp://logs.openstack.org/22/128422/1/check/check-tempest-dsvm-full/3734c9e/logs/screen-n-api.txt.gz#_2014-10-14_20_21_58_603", 
            "date_created": "2014-10-14 21:35:51.381547+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/128100\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=f0f07fdb6702f89f3800a5054e9365c3abc90f7a\nSubmitter: Jenkins\nBranch:    master\n\ncommit f0f07fdb6702f89f3800a5054e9365c3abc90f7a\nAuthor: Adam Gandelman <email address hidden>\nDate:   Mon Oct 13 17:42:42 2014 -0700\n\n    Use response.text for returning unicode EC2 metadata\n    \n    When serving meta-data that contains unicode, use the webob Response.text\n    instead of Response.body.  This also adds a test that triggers the bug in\n    addition to testing that all meta-data offered by the server can be served.\n    \n    Closes-bug: #1380792\n    \n    Change-Id: If2ddaa97bbc89cf574205c0327e3caa02dd503fc\n", 
            "date_created": "2014-10-22 01:58:33.459852+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/130342", 
            "date_created": "2014-10-22 19:49:13.735301+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/130342\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c159f9107b2184f1d8af546eae5a985a3627e7d9\nSubmitter: Jenkins\nBranch:    stable/juno\n\ncommit c159f9107b2184f1d8af546eae5a985a3627e7d9\nAuthor: Adam Gandelman <email address hidden>\nDate:   Mon Oct 13 17:42:42 2014 -0700\n\n    Use response.text for returning unicode EC2 metadata\n    \n    When serving meta-data that contains unicode, use the webob Response.text\n    instead of Response.body.  This also adds a test that triggers the bug in\n    addition to testing that all meta-data offered by the server can be served.\n    \n    Closes-bug: #1380792\n    \n    Change-Id: If2ddaa97bbc89cf574205c0327e3caa02dd503fc\n    (cherry picked from commit f0f07fdb6702f89f3800a5054e9365c3abc90f7a)\n", 
            "date_created": "2014-11-27 11:21:43.234567+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}