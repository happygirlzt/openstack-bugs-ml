{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:06:44.013176+00:00", 
    "description": "I get this stack trace when I try the 'boot from volume feature' on Grizzly (Cinder configured with the iscsi Driver):\n\n2012-11-19 18:01:55 DEBUG nova.openstack.common.lockutils [req-75241d7f-d5d9-4a88-9d38-70b50db25f36 demo demo] Got semaphore \"compute_resources\" for method \"update_usage\"... inner /opt/stack/nova/nova/openstack/common/lockutils.py:185\n2012-11-19 18:01:55 2475 ERROR nova.openstack.common.rpc.amqp [-] Exception during message handling\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp rval = self.proxy.dispatch(ctxt, version, method, **args)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp return getattr(proxyobj, method)(ctxt, **kwargs)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/exception.py\", line 115, in wrapped\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp temp_level, payload)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self.gen.next()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/exception.py\", line 90, in wrapped\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp return f(*args, **kw)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 176, in decorated_function\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp pass\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self.gen.next()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 162, in decorated_function\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 203, in decorated_function\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp kwargs['instance']['uuid'], e, sys.exc_info())\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self.gen.next()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 191, in decorated_function\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 933, in run_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp do_run_instance()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/openstack/common/lockutils.py\", line 228, in inner\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp retval = f(*args, **kwargs)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 932, in do_run_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp admin_password, is_first_time, instance)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 608, in _run_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self._set_instance_error_state(context, instance['uuid'])\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self.gen.next()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 596, in _run_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp is_first_time, request_spec, filter_properties)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 582, in _run_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp injected_files, admin_password)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 840, in _spawn\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp block_device_info)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 172, in spawn\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp admin_password, network_info, block_device_info)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 408, in spawn\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp undo_mgr.rollback_and_reraise(msg=msg, instance=instance)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/utils.py\", line 1154, in rollback_and_reraise\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self._rollback()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self.gen.next()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 391, in spawn\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp vdis = create_disks_step(undo_mgr, disk_image_type, image_meta)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 134, in inner\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp rv = f(*args, **kwargs)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 275, in create_disks_step\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp block_device_info)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 246, in _create_disks\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp block_device_info=block_device_info)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vm_utils.py\", line 520, in get_vdis_for_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp dev_params)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vm_utils.py\", line 458, in get_vdis_for_boot_from_vol\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp sr_uuid = dev_params['sr_uuid']\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp KeyError: 'sr_uuid'\n\nI get the same error with Folsom stable (with slightly different line numbers).\n\nI think this has to do with the fact that the definition of get_vdis_for_boot_from_vol is tightly coupled with the XenAPI Storage Manager back-end (which is the one where keys like sr_uuid are coming from); however I see no good reason why this is. I think this can safely work with an iscsi driver.\n\nI know that there's some work going on in refactoring how xenapi handles volume-related requests, so I would suggest that the Grizzly and Folsom fixes follow different paths.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1087308", 
    "owner": "https://api.launchpad.net/1.0/~armando-migliaccio", 
    "id": 1087308, 
    "index": 3251, 
    "created": "2012-12-06 15:38:02.807575+00:00", 
    "title": "KeyError: 'sr_uuid' when booting from volume on xenapi", 
    "comments": [
        {
            "content": "I get this stack trace when I try the 'boot from volume feature' on Grizzly (Cinder configured with the iscsi Driver):\n\n2012-11-19 18:01:55 DEBUG nova.openstack.common.lockutils [req-75241d7f-d5d9-4a88-9d38-70b50db25f36 demo demo] Got semaphore \"compute_resources\" for method \"update_usage\"... inner /opt/stack/nova/nova/openstack/common/lockutils.py:185\n2012-11-19 18:01:55 2475 ERROR nova.openstack.common.rpc.amqp [-] Exception during message handling\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp rval = self.proxy.dispatch(ctxt, version, method, **args)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp return getattr(proxyobj, method)(ctxt, **kwargs)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/exception.py\", line 115, in wrapped\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp temp_level, payload)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self.gen.next()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/exception.py\", line 90, in wrapped\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp return f(*args, **kw)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 176, in decorated_function\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp pass\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self.gen.next()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 162, in decorated_function\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 203, in decorated_function\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp kwargs['instance']['uuid'], e, sys.exc_info())\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self.gen.next()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 191, in decorated_function\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 933, in run_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp do_run_instance()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/openstack/common/lockutils.py\", line 228, in inner\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp retval = f(*args, **kwargs)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 932, in do_run_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp admin_password, is_first_time, instance)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 608, in _run_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self._set_instance_error_state(context, instance['uuid'])\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self.gen.next()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 596, in _run_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp is_first_time, request_spec, filter_properties)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 582, in _run_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp injected_files, admin_password)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 840, in _spawn\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp block_device_info)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 172, in spawn\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp admin_password, network_info, block_device_info)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 408, in spawn\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp undo_mgr.rollback_and_reraise(msg=msg, instance=instance)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/utils.py\", line 1154, in rollback_and_reraise\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self._rollback()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in _exit_\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp self.gen.next()\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 391, in spawn\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp vdis = create_disks_step(undo_mgr, disk_image_type, image_meta)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 134, in inner\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp rv = f(*args, **kwargs)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 275, in create_disks_step\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp block_device_info)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 246, in _create_disks\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp block_device_info=block_device_info)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vm_utils.py\", line 520, in get_vdis_for_instance\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp dev_params)\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/vm_utils.py\", line 458, in get_vdis_for_boot_from_vol\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp sr_uuid = dev_params['sr_uuid']\n2012-11-19 18:01:55 2475 TRACE nova.openstack.common.rpc.amqp KeyError: 'sr_uuid'\n\nI get the same error with Folsom stable (with slightly different line numbers).\n\nI think this has to do with the fact that the definition of get_vdis_for_boot_from_vol is tightly coupled with the XenAPI Storage Manager back-end (which is the one where keys like sr_uuid are coming from); however I see no good reason why this is. I think this can safely work with an iscsi driver.\n\nI know that there's some work going on in refactoring how xenapi handles volume-related requests, so I would suggest that the Grizzly and Folsom fixes follow different paths.", 
            "date_created": "2012-12-06 15:38:02.807575+00:00", 
            "author": "https://api.launchpad.net/1.0/~armando-migliaccio"
        }, 
        {
            "content": "I think I have a fix for Folsom stable, I'll be pushing it shortly.", 
            "date_created": "2012-12-06 15:42:12.587688+00:00", 
            "author": "https://api.launchpad.net/1.0/~armando-migliaccio"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/17726\nCommitted: http://github.com/openstack/nova/commit/503d5729547f135951d75d5237b398fe1700aaf2\nSubmitter: Jenkins\nBranch:    master\n\ncommit 503d5729547f135951d75d5237b398fe1700aaf2\nAuthor: Armando Migliaccio <email address hidden>\nDate:   Fri Dec 7 21:06:43 2012 +0000\n\n    Fixes KeyError: 'sr_uuid' when booting from volume on xenapi\n    \n    This change fixes the capability for a XenServer/XCP hypervisor\n    to boot instances from an iscsi volume running on Cinder.\n    \n    This patch takes into account that Cinder can be configured\n    with an iscsi back-end, instead of a xensm one, where keys like\n    sr_uuid are not being specified. It works through the magic of\n    determining the SR, and the vdi associated with the iscsi target\n    and lun.\n    \n    This patch also does a bit of clean-up of code/comments that no\n    longer apply.\n    \n    Addresses bug #1087308\n    \n    Change-Id: Ie7d65eeb965b3468e4407981788725e2b43bff5e\n", 
            "date_created": "2012-12-14 18:34:07.905643+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "A patch for the folsom stable branch", 
            "date_created": "2012-12-20 22:13:48.890517+00:00", 
            "author": "https://api.launchpad.net/1.0/~armando-migliaccio"
        }
    ]
}