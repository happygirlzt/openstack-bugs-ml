{
    "status": "Fix Released", 
    "last_updated": "2016-09-02 07:31:56.679612+00:00", 
    "description": "The command:\n$ nova-manage db archive_deleted_rows <NUMBER> --verbose\nfails for very large NUMBER value on nova master\n\nNova version:\nopenstack@openstack-136:/opt/stack/nova$ git log -1\ncommit 29641bd9778b51ac5794dfed9d4b881c5d47dc50\nMerge: 21e79d5 9fbe683\nAuthor: Jenkins <email address hidden>\nDate:   Wed Feb 10 06:03:00 2016 +0000\n\n    Merge \"Top 100 slow tests: api.openstack.compute.test_api\"\n\nExample:\n\nopenstack@openstack-136:~$ nova-manage db archive_deleted_rows 2147483547647747477747474775366545456499999 --verbose\n2016-02-09 22:17:10.713 ERROR oslo_db.sqlalchemy.exc_filters [-] DBAPIError exception wrapped from (pymysql.err.ProgrammingError) (1064, u\"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '2147483547647747477747474775366545456499999' at line 4\") [SQL: u'INSERT INTO shadow_instance_actions_events (created_at, updated_at, deleted_at, deleted, id, event, action_id, start_time, finish_time, result, traceback, host, details) SELECT instance_actions_events.created_at, instance_actions_events.updated_at, instance_actions_events.deleted_at, instance_actions_events.deleted, instance_actions_events.id, instance_actions_events.event, instance_actions_events.action_id, instance_actions_events.start_time, instance_actions_events.finish_time, instance_actions_events.result, instance_actions_events.traceback, instance_actions_events.host, instance_actions_events.details \\nFROM instance_actions_events \\nWHERE instance_actions_events.deleted != %s ORDER BY instance_actions_events.id \\n LIMIT %s'] [parameters: (0, 2147483547647747477747474775366545456499999L)]\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters Traceback (most recent call last):\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     context)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     cursor.execute(statement, parameters)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 146, in execute\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     result = self._query(query)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 296, in _query\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     conn.query(q)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 781, in query\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 942, in _read_query_result\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     result.read()\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1138, in read\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     first_packet = self.connection._read_packet()\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 906, in _read_packet\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     packet.check_error()\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 367, in check_error\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     err.raise_mysql_exception(self._data)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 120, in raise_mysql_exception\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     _check_mysql_exception(errinfo)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 112, in _check_mysql_exception\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     raise errorclass(errno, errorvalue)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters ProgrammingError: (1064, u\"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '2147483547647747477747474775366545456499999' at line 4\")\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters\nCommand failed, please check log for more info\n2016-02-09 22:17:10.716 CRITICAL nova [-] DBError: (pymysql.err.ProgrammingError) (1064, u\"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '2147483547647747477747474775366545456499999' at line 4\") [SQL: u'INSERT INTO shadow_instance_actions_events (created_at, updated_at, deleted_at, deleted, id, event, action_id, start_time, finish_time, result, traceback, host, details) SELECT instance_actions_events.created_at, instance_actions_events.updated_at, instance_actions_events.deleted_at, instance_actions_events.deleted, instance_actions_events.id, instance_actions_events.event, instance_actions_events.action_id, instance_actions_events.start_time, instance_actions_events.finish_time, instance_actions_events.result, instance_actions_events.traceback, instance_actions_events.host, instance_actions_events.details \\nFROM instance_actions_events \\nWHERE instance_actions_events.deleted != %s ORDER BY instance_actions_events.id \\n LIMIT %s'] [parameters: (0, 2147483547647747477747474775366545456499999L)]\n\n2016-02-09 22:17:10.716 TRACE nova Traceback (most recent call last):\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/bin/nova-manage\", line 10, in <module>\n2016-02-09 22:17:10.716 TRACE nova     sys.exit(main())\n2016-02-09 22:17:10.716 TRACE nova   File \"/opt/stack/nova/nova/cmd/manage.py\", line 1448, in main\n2016-02-09 22:17:10.716 TRACE nova     ret = fn(*fn_args, **fn_kwargs)\n2016-02-09 22:17:10.716 TRACE nova   File \"/opt/stack/nova/nova/cmd/manage.py\", line 951, in archive_deleted_rows\n2016-02-09 22:17:10.716 TRACE nova     table_to_rows_archived = db.archive_deleted_rows(max_rows)\n2016-02-09 22:17:10.716 TRACE nova   File \"/opt/stack/nova/nova/db/api.py\", line 1945, in archive_deleted_rows\n2016-02-09 22:17:10.716 TRACE nova     return IMPL.archive_deleted_rows(max_rows=max_rows)\n2016-02-09 22:17:10.716 TRACE nova   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 6129, in archive_deleted_rows\n2016-02-09 22:17:10.716 TRACE nova     tablename, max_rows=max_rows - total_rows_archived)\n2016-02-09 22:17:10.716 TRACE nova   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 6084, in _archive_deleted_rows_for_table\n2016-02-09 22:17:10.716 TRACE nova     conn.execute(insert)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 914, in execute\n2016-02-09 22:17:10.716 TRACE nova     return meth(self, multiparams, params)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\n2016-02-09 22:17:10.716 TRACE nova     return connection._execute_clauseelement(self, multiparams, params)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n2016-02-09 22:17:10.716 TRACE nova     compiled_sql, distilled_params\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n2016-02-09 22:17:10.716 TRACE nova     context)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1337, in _handle_dbapi_exception\n2016-02-09 22:17:10.716 TRACE nova     util.raise_from_cause(newraise, exc_info)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 200, in raise_from_cause\n2016-02-09 22:17:10.716 TRACE nova     reraise(type(exception), exception, tb=exc_tb)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2016-02-09 22:17:10.716 TRACE nova     context)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2016-02-09 22:17:10.716 TRACE nova     cursor.execute(statement, parameters)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 146, in execute\n2016-02-09 22:17:10.716 TRACE nova     result = self._query(query)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 296, in _query\n2016-02-09 22:17:10.716 TRACE nova     conn.query(q)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 781, in query\n2016-02-09 22:17:10.716 TRACE nova     self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 942, in _read_query_result\n2016-02-09 22:17:10.716 TRACE nova     result.read()\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1138, in read\n2016-02-09 22:17:10.716 TRACE nova     first_packet = self.connection._read_packet()\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 906, in _read_packet\n2016-02-09 22:17:10.716 TRACE nova     packet.check_error()\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 367, in check_error\n2016-02-09 22:17:10.716 TRACE nova     err.raise_mysql_exception(self._data)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 120, in raise_mysql_exception\n2016-02-09 22:17:10.716 TRACE nova     _check_mysql_exception(errinfo)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 112, in _check_mysql_exception\n2016-02-09 22:17:10.716 TRACE nova     raise errorclass(errno, errorvalue)\n2016-02-09 22:17:10.716 TRACE nova DBError: (pymysql.err.ProgrammingError) (1064, u\"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '2147483547647747477747474775366545456499999' at line 4\") [SQL: u'INSERT INTO shadow_instance_actions_events (created_at, updated_at, deleted_at, deleted, id, event, action_id, start_time, finish_time, result, traceback, host, details) SELECT instance_actions_events.created_at, instance_actions_events.updated_at, instance_actions_events.deleted_at, instance_actions_events.deleted, instance_actions_events.id, instance_actions_events.event, instance_actions_events.action_id, instance_actions_events.start_time, instance_actions_events.finish_time, instance_actions_events.result, instance_actions_events.traceback, instance_actions_events.host, instance_actions_events.details \\nFROM instance_actions_events \\nWHERE instance_actions_events.deleted != %s ORDER BY instance_actions_events.id \\n LIMIT %s'] [parameters: (0, 2147483547647747477747474775366545456499999L)]\n2016-02-09 22:17:10.716 TRACE nova\n\nInstead of a stacktrace user should get a user friendly message like: \"max rows must be <= 2147483647\"", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1543937", 
    "owner": "https://api.launchpad.net/1.0/~ravishekar-jethani", 
    "id": 1543937, 
    "index": 6030, 
    "created": "2016-02-10 07:03:52.160821+00:00", 
    "title": "db purge records fails for very large number", 
    "comments": [
        {
            "content": "\nThe command:\n$ nova-manage db archive_deleted_rows <NUMBER> --verbose \nfails for very large NUMBER value on nova master\n\nNova version:\nopenstack@openstack-136:/opt/stack/nova$ git log -1\ncommit 34cf19c8a4dababd1e723c0364a80823c0ac2637\nMerge: 6248dd0 83cd67c\nAuthor: Jenkins <email address hidden>\nDate:   Wed Jan 13 02:57:09 2016 +0000\n\n    Merge \"Add 'hw:cpu_thread_policy=require' scheduling\"\n\n\nExample:\n\nopenstack@openstack-136:~$ nova-manage db archive_deleted_rows 2147483547647747477747474775366545456499999 --verbose\n2016-02-09 22:17:10.713 ERROR oslo_db.sqlalchemy.exc_filters [-] DBAPIError exception wrapped from (pymysql.err.ProgrammingError) (1064, u\"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '2147483547647747477747474775366545456499999' at line 4\") [SQL: u'INSERT INTO shadow_instance_actions_events (created_at, updated_at, deleted_at, deleted, id, event, action_id, start_time, finish_time, result, traceback, host, details) SELECT instance_actions_events.created_at, instance_actions_events.updated_at, instance_actions_events.deleted_at, instance_actions_events.deleted, instance_actions_events.id, instance_actions_events.event, instance_actions_events.action_id, instance_actions_events.start_time, instance_actions_events.finish_time, instance_actions_events.result, instance_actions_events.traceback, instance_actions_events.host, instance_actions_events.details \\nFROM instance_actions_events \\nWHERE instance_actions_events.deleted != %s ORDER BY instance_actions_events.id \\n LIMIT %s'] [parameters: (0, 2147483547647747477747474775366545456499999L)]\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters Traceback (most recent call last):\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     context)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     cursor.execute(statement, parameters)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 146, in execute\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     result = self._query(query)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 296, in _query\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     conn.query(q)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 781, in query\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 942, in _read_query_result\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     result.read()\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1138, in read\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     first_packet = self.connection._read_packet()\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 906, in _read_packet\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     packet.check_error()\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 367, in check_error\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     err.raise_mysql_exception(self._data)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 120, in raise_mysql_exception\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     _check_mysql_exception(errinfo)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 112, in _check_mysql_exception\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters     raise errorclass(errno, errorvalue)\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters ProgrammingError: (1064, u\"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '2147483547647747477747474775366545456499999' at line 4\")\n2016-02-09 22:17:10.713 TRACE oslo_db.sqlalchemy.exc_filters\nCommand failed, please check log for more info\n2016-02-09 22:17:10.716 CRITICAL nova [-] DBError: (pymysql.err.ProgrammingError) (1064, u\"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '2147483547647747477747474775366545456499999' at line 4\") [SQL: u'INSERT INTO shadow_instance_actions_events (created_at, updated_at, deleted_at, deleted, id, event, action_id, start_time, finish_time, result, traceback, host, details) SELECT instance_actions_events.created_at, instance_actions_events.updated_at, instance_actions_events.deleted_at, instance_actions_events.deleted, instance_actions_events.id, instance_actions_events.event, instance_actions_events.action_id, instance_actions_events.start_time, instance_actions_events.finish_time, instance_actions_events.result, instance_actions_events.traceback, instance_actions_events.host, instance_actions_events.details \\nFROM instance_actions_events \\nWHERE instance_actions_events.deleted != %s ORDER BY instance_actions_events.id \\n LIMIT %s'] [parameters: (0, 2147483547647747477747474775366545456499999L)]\n\n2016-02-09 22:17:10.716 TRACE nova Traceback (most recent call last):\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/bin/nova-manage\", line 10, in <module>\n2016-02-09 22:17:10.716 TRACE nova     sys.exit(main())\n2016-02-09 22:17:10.716 TRACE nova   File \"/opt/stack/nova/nova/cmd/manage.py\", line 1448, in main\n2016-02-09 22:17:10.716 TRACE nova     ret = fn(*fn_args, **fn_kwargs)\n2016-02-09 22:17:10.716 TRACE nova   File \"/opt/stack/nova/nova/cmd/manage.py\", line 951, in archive_deleted_rows\n2016-02-09 22:17:10.716 TRACE nova     table_to_rows_archived = db.archive_deleted_rows(max_rows)\n2016-02-09 22:17:10.716 TRACE nova   File \"/opt/stack/nova/nova/db/api.py\", line 1945, in archive_deleted_rows\n2016-02-09 22:17:10.716 TRACE nova     return IMPL.archive_deleted_rows(max_rows=max_rows)\n2016-02-09 22:17:10.716 TRACE nova   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 6129, in archive_deleted_rows\n2016-02-09 22:17:10.716 TRACE nova     tablename, max_rows=max_rows - total_rows_archived)\n2016-02-09 22:17:10.716 TRACE nova   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 6084, in _archive_deleted_rows_for_table\n2016-02-09 22:17:10.716 TRACE nova     conn.execute(insert)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 914, in execute\n2016-02-09 22:17:10.716 TRACE nova     return meth(self, multiparams, params)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\n2016-02-09 22:17:10.716 TRACE nova     return connection._execute_clauseelement(self, multiparams, params)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n2016-02-09 22:17:10.716 TRACE nova     compiled_sql, distilled_params\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n2016-02-09 22:17:10.716 TRACE nova     context)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1337, in _handle_dbapi_exception\n2016-02-09 22:17:10.716 TRACE nova     util.raise_from_cause(newraise, exc_info)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 200, in raise_from_cause\n2016-02-09 22:17:10.716 TRACE nova     reraise(type(exception), exception, tb=exc_tb)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2016-02-09 22:17:10.716 TRACE nova     context)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2016-02-09 22:17:10.716 TRACE nova     cursor.execute(statement, parameters)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 146, in execute\n2016-02-09 22:17:10.716 TRACE nova     result = self._query(query)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/cursors.py\", line 296, in _query\n2016-02-09 22:17:10.716 TRACE nova     conn.query(q)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 781, in query\n2016-02-09 22:17:10.716 TRACE nova     self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 942, in _read_query_result\n2016-02-09 22:17:10.716 TRACE nova     result.read()\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 1138, in read\n2016-02-09 22:17:10.716 TRACE nova     first_packet = self.connection._read_packet()\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 906, in _read_packet\n2016-02-09 22:17:10.716 TRACE nova     packet.check_error()\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/connections.py\", line 367, in check_error\n2016-02-09 22:17:10.716 TRACE nova     err.raise_mysql_exception(self._data)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 120, in raise_mysql_exception\n2016-02-09 22:17:10.716 TRACE nova     _check_mysql_exception(errinfo)\n2016-02-09 22:17:10.716 TRACE nova   File \"/usr/local/lib/python2.7/dist-packages/pymysql/err.py\", line 112, in _check_mysql_exception\n2016-02-09 22:17:10.716 TRACE nova     raise errorclass(errno, errorvalue)\n2016-02-09 22:17:10.716 TRACE nova DBError: (pymysql.err.ProgrammingError) (1064, u\"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '2147483547647747477747474775366545456499999' at line 4\") [SQL: u'INSERT INTO shadow_instance_actions_events (created_at, updated_at, deleted_at, deleted, id, event, action_id, start_time, finish_time, result, traceback, host, details) SELECT instance_actions_events.created_at, instance_actions_events.updated_at, instance_actions_events.deleted_at, instance_actions_events.deleted, instance_actions_events.id, instance_actions_events.event, instance_actions_events.action_id, instance_actions_events.start_time, instance_actions_events.finish_time, instance_actions_events.result, instance_actions_events.traceback, instance_actions_events.host, instance_actions_events.details \\nFROM instance_actions_events \\nWHERE instance_actions_events.deleted != %s ORDER BY instance_actions_events.id \\n LIMIT %s'] [parameters: (0, 2147483547647747477747474775366545456499999L)]\n2016-02-09 22:17:10.716 TRACE nova\n\n\nInstead of a stacktrace user should get a user friendly message like: \"max rows must be <= 2147483647\"", 
            "date_created": "2016-02-10 07:03:52.160821+00:00", 
            "author": "https://api.launchpad.net/1.0/~ravishekar-jethani"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/278268", 
            "date_created": "2016-02-10 09:29:04.015120+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Similarly glance-manage db purge 1 111111111111111111111111111111111111111111111111111111111111111 fails and give long stack trace.\n\n", 
            "date_created": "2016-02-11 11:54:20.476702+00:00", 
            "author": "https://api.launchpad.net/1.0/~abhishek-kekane"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/280571", 
            "date_created": "2016-02-16 09:41:18.517996+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi all,\n\nThere is also an issue with 'age_in_days'  and 'max_rows' positional arguments type validation for glance.\n\nCommand:\n$ glance-manage db purge \"something\"\n\nLOG:\n2016-02-16 21:59:00.799 CRITICAL glance [-] ValueError: invalid literal for int() with base 10: 'something'\n\n2016-02-16 21:59:00.799 TRACE glance Traceback (most recent call last):\n2016-02-16 21:59:00.799 TRACE glance   File \"/usr/local/bin/glance-manage\", line 10, in <module>\n2016-02-16 21:59:00.799 TRACE glance     sys.exit(main())\n2016-02-16 21:59:00.799 TRACE glance   File \"/opt/stack/glance/glance/cmd/manage.py\", line 344, in main\n2016-02-16 21:59:00.799 TRACE glance     return CONF.command.action_fn(*func_args, **func_kwargs)\n2016-02-16 21:59:00.799 TRACE glance   File \"/opt/stack/glance/glance/cmd/manage.py\", line 156, in purge\n2016-02-16 21:59:00.799 TRACE glance     age_in_days = int(age_in_days)\n2016-02-16 21:59:00.799 TRACE glance ValueError: invalid literal for int() with base 10: 'something'\n2016-02-16 21:59:00.799 TRACE glance\n\nThe same issue is present for 'max_rows' positional argument.\n\nCommand:\n$ glance-manage db purge 1 \"something\"\n\nLOG:\n2016-02-16 23:01:36.484 CRITICAL glance [-] ValueError: invalid literal for int() with base 10: 'something'\n\n2016-02-16 23:01:36.484 TRACE glance Traceback (most recent call last):\n2016-02-16 23:01:36.484 TRACE glance   File \"/usr/local/bin/glance-manage\", line 10, in <module>\n2016-02-16 23:01:36.484 TRACE glance     sys.exit(main())\n2016-02-16 23:01:36.484 TRACE glance   File \"/opt/stack/glance/glance/cmd/manage.py\", line 344, in main\n2016-02-16 23:01:36.484 TRACE glance     return CONF.command.action_fn(*func_args, **func_kwargs)\n2016-02-16 23:01:36.484 TRACE glance   File \"/opt/stack/glance/glance/cmd/manage.py\", line 157, in purge\n2016-02-16 23:01:36.484 TRACE glance     max_rows = int(max_rows)\n2016-02-16 23:01:36.484 TRACE glance ValueError: invalid literal for int() with base 10: 'something'\n2016-02-16 23:01:36.484 TRACE glance\n\nInteger type validation of 'age_in_days' and 'max_rows' is done in purge_deleted_rows()[1] method\nbut that code is not reachable as it is going to throw an exception in purge() method [3] itself before \ncall to the actual purge_deleted_rows() method [1].\n\nTo fix this issue we need to shift validation part of 'age_in_days' and 'max_rows'\nfrom purge_deleted_rows() method [1] to purge() method [2].\n\nI will fix all these issues in a single patch. \n\n[1] https://github.com/openstack/glance/blob/master/glance/db/sqlalchemy/api.py#L1236\n[2] https://github.com/openstack/glance/blob/master/glance/cmd/manage.py#L154\n[3] https://github.com/openstack/glance/blob/master/glance/cmd/manage.py#L156", 
            "date_created": "2016-02-17 07:15:32.311228+00:00", 
            "author": "https://api.launchpad.net/1.0/~dinesh-bhor"
        }, 
        {
            "content": "Hi All,\n\nThe current implementation of glance-manage doesn't support validation of both positional \nand optional arguments using args decorator [1]. Adding validation of argument type inside the \nmethod doesn't look nice as it could increase the code footprint and developer would need to \nadd this validation for all commands wherever arguments are used.\n\nPossible solution:\n\nA] Make all glance-manage arguments positional:\n\tThis requires major change of code in glance-manage and all arguments are \n\tconsidered to be required and if we hit 'glance-manage db purge'\n\twithout any arguments then it will give error: too few arguments.\n\nIf someone has any other solution please suggest.\n\nThe same issue is present in nova.\n\n[1] https://github.com/openstack/glance/blob/master/glance/cmd/manage.py#L150", 
            "date_created": "2016-02-26 13:23:43.002652+00:00", 
            "author": "https://api.launchpad.net/1.0/~dinesh-bhor"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/278268\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=02141ae7d7af5a9e04f0c64488dcfc8aeabf82f6\nSubmitter: Jenkins\nBranch:    master\n\ncommit 02141ae7d7af5a9e04f0c64488dcfc8aeabf82f6\nAuthor: Ravi Shekhar Jethani <email address hidden>\nDate:   Wed Feb 10 00:58:01 2016 -0800\n\n    Add check to limit maximum value of max_rows\n    \n    Currently archive_deleted_rows() fails if we provide\n    a very large number as input. This patch adds a check\n    to see that max_rows should not exceed db.MAX_INT and\n    provides a meaningful error message to the user.\n    \n    Change-Id: I66a5d2cc7b7101e987ee89fcc7779bd9d5a4d144\n    Closes-Bug: #1543937\n", 
            "date_created": "2016-02-27 10:35:06.536432+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.0.0.0b3 development milestone.", 
            "date_created": "2016-03-03 16:20:07.921420+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/293275", 
            "date_created": "2016-03-16 06:39:37.792764+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/293275\nCommitted: https://git.openstack.org/cgit/openstack/glance/commit/?id=371043656b64904e536f09afcd23e41e8758fe38\nSubmitter: Jenkins\nBranch:    master\n\ncommit 371043656b64904e536f09afcd23e41e8758fe38\nAuthor: dineshbhor <email address hidden>\nDate:   Tue Mar 15 04:12:26 2016 +0000\n\n    Fix db purge type validation\n    \n    Moved validation for age_in_days and max_rows from\n    glance.db.sqlalchemy.api to glance.cmd.manage since\n    code from purge_deleted_rows() method of\n    glance.db.sqlalchemy.api is unreachable as it is\n    throwing ValueError exception for invalid input from\n    glance.cmd.manage itself.\n    \n    Related-Bug: #1543937\n    Change-Id: I4e976fde2a78fd901c233966adc350a0ded41841\n", 
            "date_created": "2016-04-06 08:46:54.410810+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi all,\n\nThere is same issue in cinder if we give the 'age_in_days' positional arguments value as long number.\n\nCommand:\n$ cinder-manage db purge 18065656675675675756786976879809080675675\n\nLOG:\n\n2016-05-13 18:34:21.239 DEBUG oslo_db.sqlalchemy.engines [req-e6ba6d96-6e30-4086-88dc-5db604c9cecb None None] MySQL server mode set to STRICT_TRANS_TABLES,STRICT_ALL_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,TRADITIONAL,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION from (pid=23371) _check_effective_sql_mode /usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/engines.py:256\n2016-05-13 18:34:21.415 INFO cinder.db.sqlalchemy.api [req-e6ba6d96-6e30-4086-88dc-5db604c9cecb None None] Purging deleted rows older than age=18065656675675675756786976879809080675675 days from table=transfers\n2016-05-13 18:34:21.417 CRITICAL cinder [req-e6ba6d96-6e30-4086-88dc-5db604c9cecb None None] OverflowError: Python int too large to convert to C long\n\n2016-05-13 18:34:21.417 TRACE cinder Traceback (most recent call last):\n2016-05-13 18:34:21.417 TRACE cinder   File \"/usr/local/bin/cinder-manage\", line 10, in <module>\n2016-05-13 18:34:21.417 TRACE cinder     sys.exit(main())\n2016-05-13 18:34:21.417 TRACE cinder   File \"/opt/stack/cinder/cinder/cmd/manage.py\", line 604, in main\n2016-05-13 18:34:21.417 TRACE cinder     fn(*fn_args)\n2016-05-13 18:34:21.417 TRACE cinder   File \"/opt/stack/cinder/cinder/cmd/manage.py\", line 235, in purge\n2016-05-13 18:34:21.417 TRACE cinder     db.purge_deleted_rows(ctxt, age_in_days)\n2016-05-13 18:34:21.417 TRACE cinder   File \"/opt/stack/cinder/cinder/db/api.py\", line 1064, in purge_deleted_rows\n2016-05-13 18:34:21.417 TRACE cinder     return IMPL.purge_deleted_rows(context, age_in_days=age_in_days)\n2016-05-13 18:34:21.417 TRACE cinder   File \"/opt/stack/cinder/cinder/db/sqlalchemy/api.py\", line 176, in wrapper\n2016-05-13 18:34:21.417 TRACE cinder     return f(*args, **kwargs)\n2016-05-13 18:34:21.417 TRACE cinder   File \"/opt/stack/cinder/cinder/db/sqlalchemy/api.py\", line 4260, in purge_deleted_rows\n2016-05-13 18:34:21.417 TRACE cinder     deleted_age = timeutils.utcnow() - dt.timedelta(days=age_in_days)\n2016-05-13 18:34:21.417 TRACE cinder OverflowError: Python int too large to convert to C long", 
            "date_created": "2016-05-17 09:47:31.135630+00:00", 
            "author": "https://api.launchpad.net/1.0/~bhagyashri-shewale"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/322757", 
            "date_created": "2016-05-30 10:42:39.628787+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/322757\nCommitted: https://git.openstack.org/cgit/openstack/cinder/commit/?id=25f5eed56faa81969a0e0cd6a732f789deaddb0c\nSubmitter: Jenkins\nBranch:    master\n\ncommit 25f5eed56faa81969a0e0cd6a732f789deaddb0c\nAuthor: bhagyashris <email address hidden>\nDate:   Wed May 18 18:04:30 2016 +0530\n\n    Add check to limit maximum value of age_in_days\n    \n    If you pass age_in_days value greater than unix epoch\n    then it raises OverflowError. Added check to ensure\n    age_in_days is within unix epoch time to fix this problem.\n    \n    Removed the redundant check for age_in_days value from\n    cinder.db.sqlalchemy.api module which is already checked\n    at cinder.cmd.manage module.\n    \n    Closes-Bug: #1543937\n    Change-Id: Ib418627fb8527a1275c2656d1451f1e1dfeb72ef\n", 
            "date_created": "2016-07-26 17:11:22.729240+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/280571\nCommitted: https://git.openstack.org/cgit/openstack/glance/commit/?id=9338e5c046679d665537b4355f0279d14aedd62d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9338e5c046679d665537b4355f0279d14aedd62d\nAuthor: Dinesh Bhor <email address hidden>\nDate:   Tue Feb 16 01:36:15 2016 -0800\n\n    Add check to limit maximum value of max_rows\n    \n    Currently 'glance-manage db purge' fails if given a\n    very large number for max_rows.\n    \n    Moved and renamed validate_mysql_int() from\n    glance.common.utils to glance.db.sqlalchemy.api as\n    _validate_db_int() since it is related to database\n    only so that it can be used to validate max_rows\n    for maximum limit.\n    \n    Closes-Bug: #1543937\n    Change-Id: Id16694807c180632c1785e9b1ebe8d1c79d885ab\n", 
            "date_created": "2016-07-30 22:32:49.593130+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/glance 13.0.0.0b3 development milestone.", 
            "date_created": "2016-09-01 22:07:14.290669+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/glance 13.0.0.0b3 development milestone.", 
            "date_created": "2016-09-01 23:29:55.876456+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/cinder 9.0.0.0b3 development milestone.", 
            "date_created": "2016-09-02 07:31:54.985975+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }
    ]
}