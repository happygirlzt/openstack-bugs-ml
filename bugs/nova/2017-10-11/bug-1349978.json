{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:12:19.578661+00:00", 
    "description": "I'm running stateless Nova compute servers (booted with ram_fs mounted on /). If I power-cycle a server it forgets all its instances but they could be recovered by hard-rebooting, except hard-rebooting a libvirt instance assumes the instance's folder already exists (ie. /var/lib/nova/instances/e4e4a4a3-1036-4734-9c0b-3bb34c88b8b6/). When nova tries to re-create the XML file it causes this stack trace:\n\n2014-07-29 16:02:41.250 2922 ERROR oslo.messaging.rpc.dispatcher [-] Exception during message handling: [Errno 2] No such file or directory: '/var/lib/nova/instances/e4e4a4a3-1036-4734-9c0b-3bb34c88b8b6/libvirt.xml'\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 88, in wrapped\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     payload)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 71, in wrapped\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 274, in decorated_function\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     pass\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 260, in decorated_function\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 327, in decorated_function\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     function(self, context, *args, **kwargs)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 303, in decorated_function\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     e, sys.exc_info())\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 290, in decorated_function\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2649, in reboot_instance\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     self._set_instance_obj_error_state(context, instance)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2630, in reboot_instance\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     bad_volumes_callback=bad_volumes_callback)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1999, in reboot\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     block_device_info)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2092, in _hard_reboot\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     write_to_disk=True)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 3455, in to_xml\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     libvirt_utils.write_to_file(xml_path, xml)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/utils.py\", line 526, in write_to_file\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     with open(path, 'w') as f:\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher IOError: [Errno 2] No such file or directory: '/var/lib/nova/instances/e4e4a4a3-1036-4734-9c0b-3bb34c88b8b6/libvirt.xml'\n\nIf I manually create the directory then hard-reboot will re-create everything else and work as expected.\n\nOS: Ubuntu 14.04, 64-bit\nnova-compute version: icehouse 2014.1.1\nlibvirt: v1.2.2\nUsing Ceph for storage: v0.80.1", 
    "tags": [
        "compute"
    ], 
    "importance": "Medium", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1349978", 
    "owner": "https://api.launchpad.net/1.0/~melwitt", 
    "id": 1349978, 
    "index": 3970, 
    "created": "2014-07-29 18:24:20.415036+00:00", 
    "title": "hard reboot doesn't re-create instance folder", 
    "comments": [
        {
            "content": "hard-rebooting a libvirt instance assumes the instance's folder exists (ie. /var/lib/nova/instances/e4e4a4a3-1036-4734-9c0b-3bb34c88b8b6/). When nova tries to re-create the XML file it causes this stack trace:\n\n2014-07-29 16:02:41.250 2922 ERROR oslo.messaging.rpc.dispatcher [-] Exception during message handling: [Errno 2] No such file or directory: '/var/lib/nova/instances/e4e4a4a3-1036-4734-9c0b-3bb34c88b8b6/libvirt.xml'\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 88, in wrapped\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     payload)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 71, in wrapped\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 274, in decorated_function\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     pass\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 260, in decorated_function\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 327, in decorated_function\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     function(self, context, *args, **kwargs)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 303, in decorated_function\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     e, sys.exc_info())\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 290, in decorated_function\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2649, in reboot_instance\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     self._set_instance_obj_error_state(context, instance)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2630, in reboot_instance\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     bad_volumes_callback=bad_volumes_callback)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1999, in reboot\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     block_device_info)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2092, in _hard_reboot\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     write_to_disk=True)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 3455, in to_xml\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     libvirt_utils.write_to_file(xml_path, xml)\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/utils.py\", line 526, in write_to_file\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher     with open(path, 'w') as f:\n2014-07-29 16:02:41.250 2922 TRACE oslo.messaging.rpc.dispatcher IOError: [Errno 2] No such file or directory: '/var/lib/nova/instances/e4e4a4a3-1036-4734-9c0b-3bb34c88b8b6/libvirt.xml'\n\nIf I manually create the directory hard-reboot works as expected.\n\nExample why this might happen:\nIf your nova-compute node was stateless (booted with ram_fs mounted on /) it would forget all its instances after being power cycled. The instances could be recovered with hard-reboot (assuming their disks weren't local) if the instance's folder was re-created.\n\nnova-compute version: icehouse 2014.1.1 \n\n\nI could write a patch + tests if we decide to do this. The change would be small.", 
            "date_created": "2014-07-29 18:24:20.415036+00:00", 
            "author": "https://api.launchpad.net/1.0/~sergio-martins"
        }, 
        {
            "content": "", 
            "date_created": "2014-07-29 21:01:16.242136+00:00", 
            "author": "https://api.launchpad.net/1.0/~sergio-martins"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/110524", 
            "date_created": "2014-07-30 01:53:36.500458+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/110524\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=a7b11d076b236e3f792dfbc8d326287b9b5211bd\nSubmitter: Jenkins\nBranch:    master\n\ncommit a7b11d076b236e3f792dfbc8d326287b9b5211bd\nAuthor: lvdongbing <email address hidden>\nDate:   Wed Jul 30 09:45:31 2014 +0800\n\n    Hard reboot doesn't re-create instance folder\n    \n    When use share storage like ceph, instance's disk data is in ceph,\n    instance's disk doesn't rely on local instance folder anymore. So\n    when rebooting a instance, we should create the instance folder if\n    it is missed.\n    \n    Closes-Bug: #1349978\n    \n    Change-Id: I5948c7979a7dbe7764fba6cad1d9867893824024\n", 
            "date_created": "2014-12-03 19:27:53.060757+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}