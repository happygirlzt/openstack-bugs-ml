{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:54:29.515158+00:00", 
    "description": "Using the latest Nova Essex builds it appears resize's when using XenServer are broken:\n\n2012-03-14 08:57:30 DEBUG nova.virt.xenapi_conn [-] Got exception: ['XENAPI_PLUGIN_EXCEPTION', 'transfer_vhd', 'TypeError', 'execv() argument 1 must be (encoded string without NULL bytes), not str'] from (pid=8531) _unwrap_plugin_exceptions /usr/lib/python2.7/dist-packages/nova/virt/xenapi_conn.py:611\n2012-03-14 08:57:30 DEBUG nova.virt.xenapi.vmops [-] Destroying VDIs for Instance 426a8458-e417-466e-bc86-d258ae32e6f7 from (pid=8531) _destroy_vdis /usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py:1089\n2012-03-14 08:57:30 DEBUG nova.virt.xenapi.vm_utils [-] VDI f67fb7c7-e548-426a-98af-051d1ed196a1 is still available from (pid=8531) lookup_vm_vdis /usr/lib/python2.7/dist-packages/nova/virt/xenapi/vm_utils.py:1002\n2012-03-14 08:57:30 DEBUG nova.virt.xenapi.vmops [-] Instance 426a8458-e417-466e-bc86-d258ae32e6f7 VM destroyed from (pid=8531) _destroy_vm /usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py:1167\n2012-03-14 08:57:30 ERROR nova.compute.manager [-] Migration error: Failed to transfer vhd to new host. Setting instance vm_state to ERROR\n2012-03-14 08:57:30 ERROR nova.rpc.amqp [-] Exception during message handling\n(nova.rpc.amqp): TRACE: Traceback (most recent call last):\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 252, in _process_data\n(nova.rpc.amqp): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 114, in wrapped\n(nova.rpc.amqp): TRACE:     return f(*args, **kw)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 153, in decorated_function\n(nova.rpc.amqp): TRACE:     function(self, context, instance_uuid, *args, **kwargs)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 177, in decorated_function\n(nova.rpc.amqp): TRACE:     sys.exc_info())\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n(nova.rpc.amqp): TRACE:     self.gen.next()\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 171, in decorated_function\n(nova.rpc.amqp): TRACE:     return function(self, context, instance_uuid, *args, **kwargs)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1320, in resize_instance\n(nova.rpc.amqp): TRACE:     self._set_instance_error_state(context, instance_uuid)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n(nova.rpc.amqp): TRACE:     self.gen.next()\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1315, in resize_instance\n(nova.rpc.amqp): TRACE:     instance_type_ref, self._legacy_nw_info(network_info))\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi_conn.py\", line 238, in migrate_disk_and_power_off\n(nova.rpc.amqp): TRACE:     dest, instance_type)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 813, in migrate_disk_and_power_off\n(nova.rpc.amqp): TRACE:     self._migrate_vhd(instance, base_copy_uuid, dest, sr_path)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 710, in _migrate_vhd\n(nova.rpc.amqp): TRACE:     raise exception.MigrationError(reason=msg)\n(nova.rpc.amqp): TRACE: MigrationError: Migration error: Failed to transfer vhd to new host\n(nova.rpc.amqp): TRACE: \n\n----\n\nLooks like some sort of encoding issue:\n\nperhaps this is the culprit? https://github.com/openstack/nova/commit/cf09a214c3007a8fa8dbe98f4cb6fcf732e09932", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/955064", 
    "owner": "https://api.launchpad.net/1.0/~dan-prince", 
    "id": 955064, 
    "index": 628, 
    "created": "2012-03-14 13:59:30.038730+00:00", 
    "title": "XenServer resize broken: 'TypeError', 'execv() argument 1 must be (encoded string without NULL bytes),", 
    "comments": [
        {
            "content": "Using the latest Nova Essex builds it appears resize's when using XenServer are broken:\n\n2012-03-14 08:57:30 DEBUG nova.virt.xenapi_conn [-] Got exception: ['XENAPI_PLUGIN_EXCEPTION', 'transfer_vhd', 'TypeError', 'execv() argument 1 must be (encoded string without NULL bytes), not str'] from (pid=8531) _unwrap_plugin_exceptions /usr/lib/python2.7/dist-packages/nova/virt/xenapi_conn.py:611\n2012-03-14 08:57:30 DEBUG nova.virt.xenapi.vmops [-] Destroying VDIs for Instance 426a8458-e417-466e-bc86-d258ae32e6f7 from (pid=8531) _destroy_vdis /usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py:1089\n2012-03-14 08:57:30 DEBUG nova.virt.xenapi.vm_utils [-] VDI f67fb7c7-e548-426a-98af-051d1ed196a1 is still available from (pid=8531) lookup_vm_vdis /usr/lib/python2.7/dist-packages/nova/virt/xenapi/vm_utils.py:1002\n2012-03-14 08:57:30 DEBUG nova.virt.xenapi.vmops [-] Instance 426a8458-e417-466e-bc86-d258ae32e6f7 VM destroyed from (pid=8531) _destroy_vm /usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py:1167\n2012-03-14 08:57:30 ERROR nova.compute.manager [-] Migration error: Failed to transfer vhd to new host. Setting instance vm_state to ERROR\n2012-03-14 08:57:30 ERROR nova.rpc.amqp [-] Exception during message handling\n(nova.rpc.amqp): TRACE: Traceback (most recent call last):\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 252, in _process_data\n(nova.rpc.amqp): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 114, in wrapped\n(nova.rpc.amqp): TRACE:     return f(*args, **kw)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 153, in decorated_function\n(nova.rpc.amqp): TRACE:     function(self, context, instance_uuid, *args, **kwargs)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 177, in decorated_function\n(nova.rpc.amqp): TRACE:     sys.exc_info())\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n(nova.rpc.amqp): TRACE:     self.gen.next()\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 171, in decorated_function\n(nova.rpc.amqp): TRACE:     return function(self, context, instance_uuid, *args, **kwargs)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1320, in resize_instance\n(nova.rpc.amqp): TRACE:     self._set_instance_error_state(context, instance_uuid)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n(nova.rpc.amqp): TRACE:     self.gen.next()\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1315, in resize_instance\n(nova.rpc.amqp): TRACE:     instance_type_ref, self._legacy_nw_info(network_info))\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi_conn.py\", line 238, in migrate_disk_and_power_off\n(nova.rpc.amqp): TRACE:     dest, instance_type)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 813, in migrate_disk_and_power_off\n(nova.rpc.amqp): TRACE:     self._migrate_vhd(instance, base_copy_uuid, dest, sr_path)\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/xenapi/vmops.py\", line 710, in _migrate_vhd\n(nova.rpc.amqp): TRACE:     raise exception.MigrationError(reason=msg)\n(nova.rpc.amqp): TRACE: MigrationError: Migration error: Failed to transfer vhd to new host\n(nova.rpc.amqp): TRACE: \n\n----\n\nLooks like some sort of encoding issue:\n\nperhaps this is the culprit? https://github.com/openstack/nova/commit/cf09a214c3007a8fa8dbe98f4cb6fcf732e09932", 
            "date_created": "2012-03-14 13:59:30.038730+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Looking a bit closer.... it appears that python shlex may not handle unicode correctly. This gets used by the migrate plugins transfer_vhd function to create an rsync argument array.\n\nSo cf09a214c3007a8fa8dbe98f4cb6fcf732e09932 probably related to this issue here.", 
            "date_created": "2012-03-14 14:24:24.388728+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/5335", 
            "date_created": "2012-03-14 14:58:50.670096+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Ugh, I fear for other places where unicode strings will break things.", 
            "date_created": "2012-03-14 15:13:22.704936+00:00", 
            "author": "https://api.launchpad.net/1.0/~johannes.erdfelt"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/5335\nCommitted: http://github.com/openstack/nova/commit/a236fdd380bec0793b6198e5e8eb40aa30ab729d\nSubmitter: Jenkins\nBranch:    master\n\ncommit a236fdd380bec0793b6198e5e8eb40aa30ab729d\nAuthor: Dan Prince <email address hidden>\nDate:   Wed Mar 14 10:53:36 2012 -0400\n\n    Update transfer_vhd to handle unicode correctly.\n    \n    Python 2.4's shlex implementation doesn't seem to like unicode.\n    This updates the XenServer migration plugin so it converts to\n    ascii before shlex'ing the rsync args.\n    \n    Fixes OSAPI resizes when using XenServer.\n    \n    Fixes LP Bug #955064.\n    \n    Change-Id: I7f2681bfe64ccde449a87c68b9739866a381a213\n", 
            "date_created": "2012-03-14 15:52:31.437325+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}