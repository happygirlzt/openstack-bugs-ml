{
    "status": "Fix Released", 
    "last_updated": "2016-03-07 11:15:31.867128+00:00", 
    "description": "\n1. version\nkilo 2015.1.0\n\n2. Relevant log files:\nnova-scheduler.log\n2015-11-12 12:56:50.472 27408 INFO nova.filters [req-70882f90-d48e-4ca0-8b09-b15a82df792f 9c67877ee37b47e989148a776862c7b8 40fc54dc632c4a02b44bf31d7ff15c82 - - -] Filter NUMATopologyFilter returned 0 hosts for instance 890d0215-5033-44ac-bb8c-3b90ce0db6a4\n\n3. Reproduce steps:\n\n3.1  environment described\n\nI have one compute node  with 32 cpus\uff0c\n\nIt\u2019s numa_topology is as follows\uff1a\n2 sockets * 8 cores * 2 thread = 32 \n\nthis mean this host have 2 numa_node\uff0cand have 16 cpu on per numa_node\n\n3.2 create a flavor  with 30 cpus\uff1a\n\n[root@nail-SBCJ-5-3-13 nova(keystone_admin)]# nova flavor-show 30cpu\n+----------------------------+-------+\n| Property                   | Value |\n+----------------------------+-------+\n| OS-FLV-DISABLED:disabled   | False |\n| OS-FLV-EXT-DATA:ephemeral  | 0     |\n| disk                       | 1     |\n| extra_specs                | {}    |\n| id                         | 7     |\n| name                       | 30cpu |\n| os-flavor-access:is_public | True  |\n| ram                        | 512   |\n| rxtx_factor                | 1.0   |\n| swap                       |       |\n| vcpus                      | 30    |\n+----------------------------+-------+\n3.3 Set the numa properties as follows\uff08numa_node1:15 vcpu numa_node2:15 vcpu\uff09\uff0cthen\uff0ccreate vm use the flavor\nnova flavor-key 30cpu  set hw:numa_nodes=2 hw:numa_cpus.0=\"0-14\" hw:numa_mem.0=256 hw:numa_cpus.1=\"15-29\" hw:numa_mem.1=256 hw:cpu_policy=dedicated\nExpected result: create success\nActual result \uff1a create failed  \nError log: ----> 2. Relevant log files\n\n3.4 Set the numa properties  as follows again\uff08numa_node1: 14 vcpu numa_node2: 16 vcpu\uff09\uff0cthen\uff0ccreate vm use the flavor\nnova flavor-key 30cpu  set hw:numa_nodes=2 hw:numa_cpus.0=\"0-13\" hw:numa_mem.0=256 hw:numa_cpus.1=\"14-29\" hw:numa_mem.1=256 hw:cpu_policy=dedicated\nExpected result: create success\nActual result \uff1a create success\n\n3.5 create another flavor with 14 cpus\uff08numa_node1:7 vcpu numa_node2:7 vcpu\uff09\uff0cSet the numa properties as follows\uff0cthen\uff0ccreate vm use the flavor\nnova flavor-key 14cpu  set hw:numa_nodes=2 hw:numa_cpus.0=\"0-6\" hw:numa_mem.0=256 hw:numa_cpus.1=\"7-13\" hw:numa_mem.1=256 hw:cpu_policy=dedicated\nExpected result: create success\nActual result \uff1a create success\n \n OR \uff08numa_node1\uff1a6 vcpu numa_node2:8 vcpu\uff09\n \nnova flavor-key 14cpu  set hw:numa_nodes=2 hw:numa_cpus.0=\"0-5\" hw:numa_mem.0=256 hw:numa_cpus.1=\"6-13\" hw:numa_mem.1=256 hw:cpu_policy=dedicated\nExpected result: create success\nActual result \uff1a create success\n \n4 \nThe above results show that\uff1a\nIt must be less than cores per socket of host\uff0cwhen specify the VM \u2019s single numa_node vcpus is odd number \uff08when cpu pining policy = dedicated\uff09\u3002\nbut if the number is even number does not exist this kind of situation\u3002\nI don't think it is reasonable", 
    "tags": [
        "numa"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1515490", 
    "owner": "https://api.launchpad.net/1.0/~stephenfinucane", 
    "id": 1515490, 
    "index": 5841, 
    "created": "2015-11-12 05:46:59.330909+00:00", 
    "title": "Fail to create instance when single numa_node vcpus  that set in flavor is odd number (cpu_policy=dedicated\uff09", 
    "comments": [
        {
            "content": "\n1. version\nkilo 2015.1.0\n\n2. Relevant log files:\nnova-scheduler.log\n2015-11-12 12:56:50.472 27408 INFO nova.filters [req-70882f90-d48e-4ca0-8b09-b15a82df792f 9c67877ee37b47e989148a776862c7b8 40fc54dc632c4a02b44bf31d7ff15c82 - - -] Filter NUMATopologyFilter returned 0 hosts for instance 890d0215-5033-44ac-bb8c-3b90ce0db6a4\n\n3. Reproduce steps:\n\n3.1  environment described\n\nI have one compute node  with 32 cpus\uff0c\n\nIt\u2019s numa_topology is as follows\uff1a\n2 sockets * 8 cores * 2 thread = 32 \n\nthis mean this host have 2 numa_node\uff0cand have 16 cpu on per numa_node\n\n3.2 create a flavor  with 30 cpus\uff1a\n\n[root@nail-SBCJ-5-3-13 nova(keystone_admin)]# nova flavor-show 30cpu\n+----------------------------+-------+\n| Property                   | Value |\n+----------------------------+-------+\n| OS-FLV-DISABLED:disabled   | False |\n| OS-FLV-EXT-DATA:ephemeral  | 0     |\n| disk                       | 1     |\n| extra_specs                | {}    |\n| id                         | 7     |\n| name                       | 30cpu |\n| os-flavor-access:is_public | True  |\n| ram                        | 512   |\n| rxtx_factor                | 1.0   |\n| swap                       |       |\n| vcpus                      | 30    |\n+----------------------------+-------+\n3.3 Set the numa properties as follows\uff08numa_node1:15 vcpu numa_node2:15 vcpu\uff09\uff0cthen\uff0ccreate vm use the flavor\nnova flavor-key 30cpu  set hw:numa_nodes=2 hw:numa_cpus.0=\"0-14\" hw:numa_mem.0=256 hw:numa_cpus.1=\"15-29\" hw:numa_mem.1=256 hw:cpu_policy=dedicated\nExpected result: create success\nActual result \uff1a create failed  \nError log: ----> 2. Relevant log files\n\n3.4 Set the numa properties  as follows again\uff08numa_node1: 14 vcpu numa_node2: 16 vcpu\uff09\uff0cthen\uff0ccreate vm use the flavor\nnova flavor-key 30cpu  set hw:numa_nodes=2 hw:numa_cpus.0=\"0-13\" hw:numa_mem.0=256 hw:numa_cpus.1=\"14-29\" hw:numa_mem.1=256 hw:cpu_policy=dedicated\nExpected result: create success\nActual result \uff1a create success\n\n3.5 create another flavor with 14 cpus\uff08numa_node1:7 vcpu numa_node2:7 vcpu\uff09\uff0cSet the numa properties as follows\uff0cthen\uff0ccreate vm use the flavor\nnova flavor-key 14cpu  set hw:numa_nodes=2 hw:numa_cpus.0=\"0-6\" hw:numa_mem.0=256 hw:numa_cpus.1=\"7-13\" hw:numa_mem.1=256 hw:cpu_policy=dedicated\nExpected result: create success\nActual result \uff1a create success\n \n OR \uff08numa_node1\uff1a6 vcpu numa_node2:8 vcpu\uff09\n \nnova flavor-key 14cpu  set hw:numa_nodes=2 hw:numa_cpus.0=\"0-5\" hw:numa_mem.0=256 hw:numa_cpus.1=\"6-13\" hw:numa_mem.1=256 hw:cpu_policy=dedicated\nExpected result: create success\nActual result \uff1a create success\n \n4 \nThe above results show that\uff1a\nIt must be less than cores per socket of host\uff0cwhen specify the VM \u2019s single numa_node vcpus is odd number \uff08when cpu pining policy = dedicated\uff09\u3002\nbut if the number is even number does not exist this kind of situation\u3002\nI don't think it is reasonable", 
            "date_created": "2015-11-12 05:46:59.330909+00:00", 
            "author": "https://api.launchpad.net/1.0/~ni-jinquan"
        }, 
        {
            "content": "So I have a system with 40 cores (2 sockets, 10 cores, hypethreading enabled).\nThe NUMA topology is as follows:\n\n    $ numactl --hardware\n    available: 2 nodes (0-1)\n    node 0 cpus: 0 1 2 3 4 5 6 7 8 9 20 21 22 23 24 25 26 27 28 29\n    node 0 size: 32083 MB\n    node 0 free: 16652 MB\n    node 1 cpus: 10 11 12 13 14 15 16 17 18 19 30 31 32 33 34 35 36 37 38 39\n    node 1 size: 32237 MB\n    node 1 free: 25386 MB\n    node distances:\n    node   0   1\n      0:  10  21\n      1:  21  10\n\nI'm using OpenStack provisioned by DevStack on a Fedora 23 host:\n\n    $ cat /etc/*-release*\n    Fedora release 23 (Twenty Three)\n    ...\n    $ uname -r\n    4.3.5-300.fc23.x86_64\n\n    $ cd /opt/stack/nova\n    $ git show --oneline\n    8bafc99 Merge \"remove the unnecessary parem of set_vm_state_and_notify\"\n\nI defined a flavor similar to yours, but without the unnecessary swap and\ndisk space and with a smaller RAM allocation (KISS?).\n\n    $ openstack flavor create bug.1515490 --id 100 --ram 512 --disk 0 \\\n        --vcpus 30\n\n    $ openstack flavor set bug.1515490 \\\n        --property \"hw:cpu_policy=dedicated\"\n        --property \"hw:numa_nodes=2\" \\\n        --property \"hw:numa_cpus.0=0-14\" \\\n        --property \"hw:numa_mem.0=256\" \\\n        --property \"hw:numa_cpus.1=15-29\" \\\n        --property \"hw:numa_mem.1=256\"\n\n    $ openstack flavor show bug.1464286\n    +----------------------------+---------------------------------------------------------------------------------------------------------------------------------------+\n    | Field                      | Value                                                                                                                                 |\n    +----------------------------+---------------------------------------------------------------------------------------------------------------------------------------+\n    | OS-FLV-DISABLED:disabled   | False                                                                                                                                 |\n    | OS-FLV-EXT-DATA:ephemeral  | 0                                                                                                                                     |\n    | disk                       | 0                                                                                                                                     |\n    | id                         | 100                                                                                                                                   |\n    | name                       | bug.1515490                                                                                                                           |\n    | os-flavor-access:is_public | True                                                                                                                                  |\n    | properties                 | hw:cpu_policy='dedicated', hw:numa_cpus.0='0-14', hw:numa_cpus.1='15-29', hw:numa_mem.0='256', hw:numa_mem.1='256', hw:numa_nodes='2' |\n    | ram                        | 512                                                                                                                                   |\n    | rxtx_factor                | 1.0                                                                                                                                   |\n    | swap                       |                                                                                                                                       |\n    | vcpus                      | 30                                                                                                                                    |\n    +----------------------------+---------------------------------------------------------------------------------------------------------------------------------------+\n\nI also modified the default quotas to allow allocation of more than 20 cores:\n\n    $ openstack quota set --cores 40 demo\n\nI boot one instance...\n\n    $ openstack server create --flavor=bug.1515490 \\\n        --image=cirros-0.3.4-x86_64-uec --wait test1\n\n    $ sudo virsh list\n     Id    Name                           State\n    ----------------------------------------------------\n     22    instance-00000013              running\n\n    $ sudo virsh dumpxml 22\n    <domain type='kvm' id='22'>\n      <name>instance-00000013</name>\n      ...\n      <memory unit='KiB'>524288</memory>\n      <currentMemory unit='KiB'>524288</currentMemory>\n      <vcpu placement='static'>30</vcpu>\n      <cputune>\n        <shares>30720</shares>\n        <vcpupin vcpu='0' cpuset='1'/>\n        <vcpupin vcpu='1' cpuset='21'/>\n        <vcpupin vcpu='2' cpuset='0'/>\n        <vcpupin vcpu='3' cpuset='20'/>\n        <vcpupin vcpu='4' cpuset='25'/>\n        <vcpupin vcpu='5' cpuset='5'/>\n        <vcpupin vcpu='6' cpuset='8'/>\n        <vcpupin vcpu='7' cpuset='28'/>\n        <vcpupin vcpu='8' cpuset='9'/>\n        <vcpupin vcpu='9' cpuset='29'/>\n        <vcpupin vcpu='10' cpuset='24'/>\n        <vcpupin vcpu='11' cpuset='4'/>\n        <vcpupin vcpu='12' cpuset='27'/>\n        <vcpupin vcpu='13' cpuset='7'/>\n        <vcpupin vcpu='14' cpuset='2'/>\n        <vcpupin vcpu='15' cpuset='35'/>\n        <vcpupin vcpu='16' cpuset='15'/>\n        <vcpupin vcpu='17' cpuset='10'/>\n        <vcpupin vcpu='18' cpuset='30'/>\n        <vcpupin vcpu='19' cpuset='16'/>\n        <vcpupin vcpu='20' cpuset='36'/>\n        <vcpupin vcpu='21' cpuset='11'/>\n        <vcpupin vcpu='22' cpuset='31'/>\n        <vcpupin vcpu='23' cpuset='32'/>\n        <vcpupin vcpu='24' cpuset='12'/>\n        <vcpupin vcpu='25' cpuset='17'/>\n        <vcpupin vcpu='26' cpuset='37'/>\n        <vcpupin vcpu='27' cpuset='18'/>\n        <vcpupin vcpu='28' cpuset='38'/>\n        <vcpupin vcpu='29' cpuset='19'/>\n        <emulatorpin cpuset='0-2,4-5,7-12,15-21,24-25,27-32,35-38'/>\n      </cputune>\n      <numatune>\n        <memory mode='strict' nodeset='0-1'/>\n        <memnode cellid='0' mode='strict' nodeset='0'/>\n        <memnode cellid='1' mode='strict' nodeset='1'/>\n      </numatune>\n      ...\n      <cpu>\n        <topology sockets='30' cores='1' threads='1'/>\n        <numa>\n          <cell id='0' cpus='0-14' memory='262144' unit='KiB'/>\n          <cell id='1' cpus='15-29' memory='262144' unit='KiB'/>\n        </numa>\n      </cpu>\n      ...\n    </domain>\n\nSo, based on the above, it seems this bug has been resolved in Mitaka and no\nlonger applies. I think this is an identical issue to bug 1467927 and the\nfixes for that also fix this. In fact, I think these patches were backported\nto Kilo so they should be fixed there also (though I'm not testing this - feel\nfree to do so, if required). As such, I'm going to mark this as \"fix released\".\n", 
            "date_created": "2016-03-07 11:15:17.189458+00:00", 
            "author": "https://api.launchpad.net/1.0/~stephenfinucane"
        }
    ]
}