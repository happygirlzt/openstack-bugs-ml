{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:31:45.614503+00:00", 
    "description": "I am running on devstack on XenServer, and the terminate-instance fails from euca exercise. I also cannot terminate the instance through Horizon. \n\nexercise.sh log:\n+ timeout 30 sh -c 'while euca-describe-instances i-00000001 | grep -q running; do sleep 1; done'\n+ echo 'server didn'\\''t terminate within 30 seconds'\nserver didn't terminate within 30 seconds\n+ exit 1\n\n\n Stacktraces:\n\nnova.openstack.common.rpc.common Traceback (most recent call last):             \nnova.openstack.common.rpc.common   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 513, in ensure\nnova.openstack.common.rpc.common     return method(*args, **kwargs)             \nnova.openstack.common.rpc.common   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 590, in _consume\nnova.openstack.common.rpc.common     return self.connection.drain_events(timeout=timeout)\nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/connection.py\", line 175, in drain_events\nnova.openstack.common.rpc.common     return self.transport.drain_events(self.connection, **kwargs)\nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 238, in drain_events\nnova.openstack.common.rpc.common     return connection.drain_events(**kwargs)   \nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 57, in drain_events\nnova.openstack.common.rpc.common     return self.wait_multi(self.channels.values(), timeout=timeout)\nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 63, in wait_multi\nnova.openstack.common.rpc.common     chanmap.keys(), allowed_methods, timeout=timeout)\nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 120, in _wait_multiple\nnova.openstack.common.rpc.common     channel, method_sig, args, content = read_timeout(timeout)\nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 94, in read_timeout\nnova.openstack.common.rpc.common     return self.method_reader.read_method()    \nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/method_framing.py\", line 221, in read_method\nnova.openstack.common.rpc.common     raise m                                    \nnova.openstack.common.rpc.common timeout: timed out\n\nnova.openstack.common.rpc.amqp Traceback (most recent call last):               \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 275, in _process_data\nnova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\nnova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\nnova.openstack.common.rpc.amqp     temp_level, payload)                         \nnova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nnova.openstack.common.rpc.amqp     self.gen.next()                              \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\nnova.openstack.common.rpc.amqp     return f(*args, **kw)                        \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 211, in decorated_function\nnova.openstack.common.rpc.amqp     pass                                         \nnova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nnova.openstack.common.rpc.amqp     self.gen.next()                              \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 204, in decorated_function\nnova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 184, in decorated_function\nnova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 237, in decorated_function\nnova.openstack.common.rpc.amqp     instance_uuid, e, sys.exc_info())            \nnova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nnova.openstack.common.rpc.amqp     self.gen.next()                              \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 226, in decorated_function\nnova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 955, in terminate_instance\nnova.openstack.common.rpc.amqp     do_terminate_instance(instance)              \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/utils.py\", line 733, in inner\nnova.openstack.common.rpc.amqp     retval = f(*args, **kwargs)                  \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 947, in do_terminate_instance\nnova.openstack.common.rpc.amqp     self._delete_instance(context, instance)     \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 917, in _delete_instance \nnova.openstack.common.rpc.amqp     self._shutdown_instance(context, instance)   \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 874, in _shutdown_instance\nnova.openstack.common.rpc.amqp     self._deallocate_network(context, instance)  \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 800, in _deallocate_network\nnova.openstack.common.rpc.amqp     self.network_api.deallocate_for_instance(context, instance)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/api.py\", line 260, in deallocate_for_instance\nnova.openstack.common.rpc.amqp     'args': args})                               \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/__init__.py\", line 102, in call\nnova.openstack.common.rpc.amqp     return _get_impl().call(cfg.CONF, context, topic, msg, timeout)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 712, in call\nnova.openstack.common.rpc.amqp     rpc_amqp.get_connection_pool(conf, Connection))\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 368, in call\nnova.openstack.common.rpc.amqp     rv = list(rv)                                \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 329, in __iter__\nnova.openstack.common.rpc.amqp     self.done()                                  \nnova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nnova.openstack.common.rpc.amqp     self.gen.next()                              \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 326, in __iter__\nnova.openstack.common.rpc.amqp     self._iterator.next()                        \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 595, in iterconsume\nnova.openstack.common.rpc.amqp     yield self.ensure(_error_callback, _consume) \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 526, in ensure\nnova.openstack.common.rpc.amqp     error_callback(e)                            \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 576, in _error_callback\nnova.openstack.common.rpc.amqp     raise rpc_common.Timeout()                   \nnova.openstack.common.rpc.amqp Timeout: Timeout while waiting on RPC response.", 
    "tags": [
        "xapi", 
        "xenserver"
    ], 
    "importance": "High", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1043905", 
    "owner": "https://api.launchpad.net/1.0/~mate-lakat", 
    "id": 1043905, 
    "index": 781, 
    "created": "2012-08-30 15:41:25.925300+00:00", 
    "title": "RPC timeout with multi_host networking", 
    "comments": [
        {
            "content": "I am running on devstack on XenServer, and the terminate-instance fails from euca exercise. I also cannot terminate the instance through Horizon. \n\nexercise.sh log:\n+ timeout 30 sh -c 'while euca-describe-instances i-00000001 | grep -q running; do sleep 1; done'\n+ echo 'server didn'\\''t terminate within 30 seconds'\nserver didn't terminate within 30 seconds\n+ exit 1\n\n\n Stacktraces:\n\nnova.openstack.common.rpc.common Traceback (most recent call last):             \nnova.openstack.common.rpc.common   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 513, in ensure\nnova.openstack.common.rpc.common     return method(*args, **kwargs)             \nnova.openstack.common.rpc.common   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 590, in _consume\nnova.openstack.common.rpc.common     return self.connection.drain_events(timeout=timeout)\nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/connection.py\", line 175, in drain_events\nnova.openstack.common.rpc.common     return self.transport.drain_events(self.connection, **kwargs)\nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 238, in drain_events\nnova.openstack.common.rpc.common     return connection.drain_events(**kwargs)   \nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 57, in drain_events\nnova.openstack.common.rpc.common     return self.wait_multi(self.channels.values(), timeout=timeout)\nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 63, in wait_multi\nnova.openstack.common.rpc.common     chanmap.keys(), allowed_methods, timeout=timeout)\nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 120, in _wait_multiple\nnova.openstack.common.rpc.common     channel, method_sig, args, content = read_timeout(timeout)\nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/kombu/transport/pyamqplib.py\", line 94, in read_timeout\nnova.openstack.common.rpc.common     return self.method_reader.read_method()    \nnova.openstack.common.rpc.common   File \"/usr/lib/python2.7/dist-packages/amqplib/client_0_8/method_framing.py\", line 221, in read_method\nnova.openstack.common.rpc.common     raise m                                    \nnova.openstack.common.rpc.common timeout: timed out\n\nnova.openstack.common.rpc.amqp Traceback (most recent call last):               \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 275, in _process_data\nnova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 145, in dispatch\nnova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\nnova.openstack.common.rpc.amqp     temp_level, payload)                         \nnova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nnova.openstack.common.rpc.amqp     self.gen.next()                              \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 92, in wrapped\nnova.openstack.common.rpc.amqp     return f(*args, **kw)                        \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 211, in decorated_function\nnova.openstack.common.rpc.amqp     pass                                         \nnova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nnova.openstack.common.rpc.amqp     self.gen.next()                              \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 204, in decorated_function\nnova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 184, in decorated_function\nnova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 237, in decorated_function\nnova.openstack.common.rpc.amqp     instance_uuid, e, sys.exc_info())            \nnova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nnova.openstack.common.rpc.amqp     self.gen.next()                              \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 226, in decorated_function\nnova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 955, in terminate_instance\nnova.openstack.common.rpc.amqp     do_terminate_instance(instance)              \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/utils.py\", line 733, in inner\nnova.openstack.common.rpc.amqp     retval = f(*args, **kwargs)                  \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 947, in do_terminate_instance\nnova.openstack.common.rpc.amqp     self._delete_instance(context, instance)     \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 917, in _delete_instance \nnova.openstack.common.rpc.amqp     self._shutdown_instance(context, instance)   \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 874, in _shutdown_instance\nnova.openstack.common.rpc.amqp     self._deallocate_network(context, instance)  \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 800, in _deallocate_network\nnova.openstack.common.rpc.amqp     self.network_api.deallocate_for_instance(context, instance)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/api.py\", line 260, in deallocate_for_instance\nnova.openstack.common.rpc.amqp     'args': args})                               \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/__init__.py\", line 102, in call\nnova.openstack.common.rpc.amqp     return _get_impl().call(cfg.CONF, context, topic, msg, timeout)\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 712, in call\nnova.openstack.common.rpc.amqp     rpc_amqp.get_connection_pool(conf, Connection))\nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 368, in call\nnova.openstack.common.rpc.amqp     rv = list(rv)                                \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 329, in __iter__\nnova.openstack.common.rpc.amqp     self.done()                                  \nnova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nnova.openstack.common.rpc.amqp     self.gen.next()                              \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 326, in __iter__\nnova.openstack.common.rpc.amqp     self._iterator.next()                        \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 595, in iterconsume\nnova.openstack.common.rpc.amqp     yield self.ensure(_error_callback, _consume) \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 526, in ensure\nnova.openstack.common.rpc.amqp     error_callback(e)                            \nnova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 576, in _error_callback\nnova.openstack.common.rpc.amqp     raise rpc_common.Timeout()                   \nnova.openstack.common.rpc.amqp Timeout: Timeout while waiting on RPC response.", 
            "date_created": "2012-08-30 15:41:25.925300+00:00", 
            "author": "https://api.launchpad.net/1.0/~mate-lakat"
        }, 
        {
            "content": "See my comment at:\nhttps://github.com/openstack/nova/commit/32b0346eb40a94ec6def3eed01e9424b0c660c53#nova/network/manager.py", 
            "date_created": "2012-08-30 16:46:54.603681+00:00", 
            "author": "https://api.launchpad.net/1.0/~mate-lakat"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/12249", 
            "date_created": "2012-08-31 09:38:27.101333+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/12249\nCommitted: http://github.com/openstack/nova/commit/cda9b490eb601fe846061720c5c66a46dc74048b\nSubmitter: Jenkins\nBranch:    master\n\ncommit cda9b490eb601fe846061720c5c66a46dc74048b\nAuthor: Mate Lakat <email address hidden>\nDate:   Fri Aug 31 10:12:26 2012 +0100\n\n    Fix deallocate_fixed_ip invocation\n    \n    Fixes bug 1043905.\n    \n    The host parameter was not passed to deallocate_fixed_ip method, so that\n    the deallocation tried to do a remote call to another host, which timed\n    out, thus instance termination failed.\n    \n    Change-Id: I18d6de31d15767a45f389ae14769985c3951d560\n", 
            "date_created": "2012-08-31 18:36:43.285580+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Guys, while we are here. I fixed only the deallocate_for_instance call in NetworkManager, but I think something still smells:\n\nSee my comment in the original commit, at line 1738:\n\nhttps://github.com/openstack/nova/commit/32b0346eb40a94ec6def3eed01e9424b0c660c53#L0R1738\n\nSo if you are using FlatManager, and multi_host, you are likely to run into some similar problem, as the host is not passed through.", 
            "date_created": "2012-09-04 09:18:22.542673+00:00", 
            "author": "https://api.launchpad.net/1.0/~mate-lakat"
        }
    ]
}