{
    "status": "Confirmed", 
    "last_updated": "2017-05-03 06:42:33.168430+00:00", 
    "description": "Example output:\n\n2017-02-21 06:42:10.010442 | ==============================\n2017-02-21 06:42:10.010458 | Failed 1 tests - output below:\n2017-02-21 06:42:10.010471 | ==============================\n2017-02-21 06:42:10.010477 | \n2017-02-21 06:42:10.010507 | tempest.api.compute.servers.test_novnc.NoVNCConsoleTestJSON.test_novnc[id-c640fdff-8ab4-45a4-a5d8-7e6146cbd0dc]\n2017-02-21 06:42:10.010542 | ---------------------------------------------------------------------------------------------------------------\n2017-02-21 06:42:10.010548 | \n2017-02-21 06:42:10.010558 | Captured traceback:\n2017-02-21 06:42:10.010569 | ~~~~~~~~~~~~~~~~~~~\n2017-02-21 06:42:10.010583 |     Traceback (most recent call last):\n2017-02-21 06:42:10.010606 |       File \"tempest/api/compute/servers/test_novnc.py\", line 152, in test_novnc\n2017-02-21 06:42:10.010621 |         self._validate_rfb_negotiation()\n2017-02-21 06:42:10.010646 |       File \"tempest/api/compute/servers/test_novnc.py\", line 77, in _validate_rfb_negotiation\n2017-02-21 06:42:10.010665 |         'Token must be invalid because the connection '\n2017-02-21 06:42:10.010721 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/unittest2/case.py\", line 696, in assertFalse\n2017-02-21 06:42:10.010737 |         raise self.failureException(msg)\n2017-02-21 06:42:10.010762 |     AssertionError: True is not false : Token must be invalid because the connection closed.\n2017-02-21 06:42:10.010768 |     \n2017-02-21 06:42:10.010774 | \n2017-02-21 06:42:10.010785 | Captured pythonlogging:\n2017-02-21 06:42:10.010796 | ~~~~~~~~~~~~~~~~~~~~~~~\n2017-02-21 06:42:10.010848 |     2017-02-21 06:07:18,545 16286 INFO     [tempest.lib.common.rest_client] Request (NoVNCConsoleTestJSON:test_novnc): 200 POST https://10.27.33.58:8774/v2.1/servers/82d4d4ca-c263-4ac5-85bc-a33488af5ff5/action 0.165s\n2017-02-21 06:42:10.010905 |     2017-02-21 06:07:18,545 16286 DEBUG    [tempest.lib.common.rest_client] Request - Headers: {'Accept': 'application/json', 'X-Auth-Token': '<omitted>', 'Content-Type': 'application/json'}\n2017-02-21 06:42:10.010925 |             Body: {\"os-getVNCConsole\": {\"type\": \"novnc\"}}\n2017-02-21 06:42:10.011109 |         Response - Headers: {u'content-type': 'application/json', 'content-location': 'https://10.27.33.58:8774/v2.1/servers/82d4d4ca-c263-4ac5-85bc-a33488af5ff5/action', u'date': 'Tue, 21 Feb 2017 06:07:18 GMT', u'x-openstack-nova-api-version': '2.1', 'status': '200', u'content-length': '121', u'server': 'Apache/2.4.18 (Ubuntu)', u'connection': 'close', u'openstack-api-version': 'compute 2.1', u'vary': 'OpenStack-API-Version,X-OpenStack-Nova-API-Version', u'x-compute-request-id': 'req-d9681919-5b5e-4477-b38d-2734b660a099'}\n2017-02-21 06:42:10.011153 |             Body: {\"console\": {\"url\": \"http://10.27.33.58:6080/vnc_auto.html?token=f8a52df3-8e0d-4d64-8877-07f607f84b74\", \"type\": \"novnc\"}}\n2017-02-21 06:42:10.011161 |     \n2017-02-21 06:42:10.011167 | \n2017-02-21 06:42:10.011172 | \n\n\nFull logs at: http://logs.openstack.org/38/431038/3/check/gate-tempest-dsvm-neutron-multinode-full-ubuntu-xenial-nv/5e1d485/console.html#_2017-02-21_06_07_18_740230\n\nThis started at 2017-02-21\n\nThe very first change which failed here was https://review.openstack.org/#/c/431038/ but is not related to the error.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1669468", 
    "owner": "None", 
    "id": 1669468, 
    "index": 4764, 
    "created": "2017-03-02 15:15:08.205023+00:00", 
    "title": "tempest.api.compute.servers.test_novnc.NoVNCConsoleTestJSON.test_novnc fails intermittently in neutron multinode nv job", 
    "comments": [
        {
            "content": "Example output:\n\n2017-02-21 06:42:10.010442 | ==============================\n2017-02-21 06:42:10.010458 | Failed 1 tests - output below:\n2017-02-21 06:42:10.010471 | ==============================\n2017-02-21 06:42:10.010477 | \n2017-02-21 06:42:10.010507 | tempest.api.compute.servers.test_novnc.NoVNCConsoleTestJSON.test_novnc[id-c640fdff-8ab4-45a4-a5d8-7e6146cbd0dc]\n2017-02-21 06:42:10.010542 | ---------------------------------------------------------------------------------------------------------------\n2017-02-21 06:42:10.010548 | \n2017-02-21 06:42:10.010558 | Captured traceback:\n2017-02-21 06:42:10.010569 | ~~~~~~~~~~~~~~~~~~~\n2017-02-21 06:42:10.010583 |     Traceback (most recent call last):\n2017-02-21 06:42:10.010606 |       File \"tempest/api/compute/servers/test_novnc.py\", line 152, in test_novnc\n2017-02-21 06:42:10.010621 |         self._validate_rfb_negotiation()\n2017-02-21 06:42:10.010646 |       File \"tempest/api/compute/servers/test_novnc.py\", line 77, in _validate_rfb_negotiation\n2017-02-21 06:42:10.010665 |         'Token must be invalid because the connection '\n2017-02-21 06:42:10.010721 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/unittest2/case.py\", line 696, in assertFalse\n2017-02-21 06:42:10.010737 |         raise self.failureException(msg)\n2017-02-21 06:42:10.010762 |     AssertionError: True is not false : Token must be invalid because the connection closed.\n2017-02-21 06:42:10.010768 |     \n2017-02-21 06:42:10.010774 | \n2017-02-21 06:42:10.010785 | Captured pythonlogging:\n2017-02-21 06:42:10.010796 | ~~~~~~~~~~~~~~~~~~~~~~~\n2017-02-21 06:42:10.010848 |     2017-02-21 06:07:18,545 16286 INFO     [tempest.lib.common.rest_client] Request (NoVNCConsoleTestJSON:test_novnc): 200 POST https://10.27.33.58:8774/v2.1/servers/82d4d4ca-c263-4ac5-85bc-a33488af5ff5/action 0.165s\n2017-02-21 06:42:10.010905 |     2017-02-21 06:07:18,545 16286 DEBUG    [tempest.lib.common.rest_client] Request - Headers: {'Accept': 'application/json', 'X-Auth-Token': '<omitted>', 'Content-Type': 'application/json'}\n2017-02-21 06:42:10.010925 |             Body: {\"os-getVNCConsole\": {\"type\": \"novnc\"}}\n2017-02-21 06:42:10.011109 |         Response - Headers: {u'content-type': 'application/json', 'content-location': 'https://10.27.33.58:8774/v2.1/servers/82d4d4ca-c263-4ac5-85bc-a33488af5ff5/action', u'date': 'Tue, 21 Feb 2017 06:07:18 GMT', u'x-openstack-nova-api-version': '2.1', 'status': '200', u'content-length': '121', u'server': 'Apache/2.4.18 (Ubuntu)', u'connection': 'close', u'openstack-api-version': 'compute 2.1', u'vary': 'OpenStack-API-Version,X-OpenStack-Nova-API-Version', u'x-compute-request-id': 'req-d9681919-5b5e-4477-b38d-2734b660a099'}\n2017-02-21 06:42:10.011153 |             Body: {\"console\": {\"url\": \"http://10.27.33.58:6080/vnc_auto.html?token=f8a52df3-8e0d-4d64-8877-07f607f84b74\", \"type\": \"novnc\"}}\n2017-02-21 06:42:10.011161 |     \n2017-02-21 06:42:10.011167 | \n2017-02-21 06:42:10.011172 | \n\n\nFull logs at: http://logs.openstack.org/38/431038/3/check/gate-tempest-dsvm-neutron-multinode-full-ubuntu-xenial-nv/5e1d485/console.html#_2017-02-21_06_07_18_740230\n\nThis started at 2017-02-21\n\nThe very first change which failed here was https://review.openstack.org/#/c/431038/ but is not related to the error.", 
            "date_created": "2017-03-02 15:15:08.205023+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "The only novnc related merge I found in that timeframe is https://github.com/openstack/nova/commit/b726f2553c3eebdc4ab5753a45a99724e952b4ac but that merged a few hours after the first hit.", 
            "date_created": "2017-03-02 15:16:33.776439+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "This might have started before 2/21, logstash only goes back 10 days.", 
            "date_created": "2017-03-02 15:17:52.217369+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "http://logs.openstack.org/38/431038/3/check/gate-tempest-dsvm-neutron-multinode-full-ubuntu-xenial-nv/5e1d485/console.html#_2017-02-21_06_42_10_010507\n\n2017-02-21 06:42:10.010507 | tempest.api.compute.servers.test_novnc.NoVNCConsoleTestJSON.test_novnc[id-c640fdff-8ab4-45a4-a5d8-7e6146cbd0dc]\n2017-02-21 06:42:10.010542 | ---------------------------------------------------------------------------------------------------------------\n2017-02-21 06:42:10.010548 | \n2017-02-21 06:42:10.010558 | Captured traceback:\n2017-02-21 06:42:10.010569 | ~~~~~~~~~~~~~~~~~~~\n2017-02-21 06:42:10.010583 |     Traceback (most recent call last):\n2017-02-21 06:42:10.010606 |       File \"tempest/api/compute/servers/test_novnc.py\", line 152, in test_novnc\n2017-02-21 06:42:10.010621 |         self._validate_rfb_negotiation()\n2017-02-21 06:42:10.010646 |       File \"tempest/api/compute/servers/test_novnc.py\", line 77, in _validate_rfb_negotiation\n2017-02-21 06:42:10.010665 |         'Token must be invalid because the connection '\n2017-02-21 06:42:10.010721 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/unittest2/case.py\", line 696, in assertFalse\n2017-02-21 06:42:10.010737 |         raise self.failureException(msg)\n2017-02-21 06:42:10.010762 |     AssertionError: True is not false : Token must be invalid because the connection closed.\n2017-02-21 06:42:10.010768 |     \n2017-02-21 06:42:10.010774 | \n2017-02-21 06:42:10.010785 | Captured pythonlogging:\n2017-02-21 06:42:10.010796 | ~~~~~~~~~~~~~~~~~~~~~~~\n2017-02-21 06:42:10.010848 |     2017-02-21 06:07:18,545 16286 INFO     [tempest.lib.common.rest_client] Request (NoVNCConsoleTestJSON:test_novnc): 200 POST https://10.27.33.58:8774/v2.1/servers/82d4d4ca-c263-4ac5-85bc-a33488af5ff5/action 0.165s\n2017-02-21 06:42:10.010905 |     2017-02-21 06:07:18,545 16286 DEBUG    [tempest.lib.common.rest_client] Request - Headers: {'Accept': 'application/json', 'X-Auth-Token': '<omitted>', 'Content-Type': 'application/json'}\n2017-02-21 06:42:10.010925 |             Body: {\"os-getVNCConsole\": {\"type\": \"novnc\"}}\n2017-02-21 06:42:10.011109 |         Response - Headers: {u'content-type': 'application/json', 'content-location': 'https://10.27.33.58:8774/v2.1/servers/82d4d4ca-c263-4ac5-85bc-a33488af5ff5/action', u'date': 'Tue, 21 Feb 2017 06:07:18 GMT', u'x-openstack-nova-api-version': '2.1', 'status': '200', u'content-length': '121', u'server': 'Apache/2.4.18 (Ubuntu)', u'connection': 'close', u'openstack-api-version': 'compute 2.1', u'vary': 'OpenStack-API-Version,X-OpenStack-Nova-API-Version', u'x-compute-request-id': 'req-d9681919-5b5e-4477-b38d-2734b660a099'}\n2017-02-21 06:42:10.011153 |             Body: {\"console\": {\"url\": \"http://10.27.33.58:6080/vnc_auto.html?token=f8a52df3-8e0d-4d64-8877-07f607f84b74\", \"type\": \"novnc\"}}\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22in%20_validate_rfb_negotiation%5C%22&from=7d\n\n203 hits in 7 days, master and stable/ocata, this mostly shows up in the neutron multinode job which is non-voting.", 
            "date_created": "2017-03-02 15:19:37.436817+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "The failing tempest test got added with https://github.com/openstack/tempest/commit/1f87a5611a983acac2208c3e0ba07eee75fe9a51 and merged 2017-02-03 16:39:00 ", 
            "date_created": "2017-03-02 15:28:37.048644+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "I tried to brute force it on a single node system:\n\n    $ for i in {1..500}; do tempest run --regex tempest.api.compute.servers.test_novnc.NoVNCConsoleTestJSON.test_novnc >> brute_force_1669468.txt; done\n\nNo failing tests here. I'll try again with a multinode setup.", 
            "date_created": "2017-03-07 11:57:08.195402+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Michelle Mandel figured it out, all credits to her, I'm only summarizing things here:\n\nThe compute node in the multinode tests has a wrong value for the config\noption \"vnc.vncserver_proxyclient_address\". It uses 127.0.0.1, but it\nshould be the IP address of the controller node. This is also described\nin the help of that config option [1]:\n\n    > \"Private, internal IP address or hostname of VNC console proxy.\n\n    > The VNC proxy is an OpenStack component that enables compute service\n    > users to access their instances through VNC clients.\n\n    > This option sets the private address to which proxy clients, such as\n    > ``nova-xvpvncproxy``, should connect to.\"\n\nAs the multinode test job uses a controller node (*with* compute services)\n+ compute node, this also explains why this fails intermittently. The test\npasses if the instance gets scheduled onto the controller (*with* compute)\nand fails if the instance gets scheduler onto the compute node.\n\nSteps to check that assumption:\n* check the failure in \"screen-n-novnc.txt\"\n* note down the instance_uuid of the failing connection attempt\n* check the file \"subnode-2/screen-n-cpu.txt\", the instance_uuid \n  should be there\n\nI checked this with these multiple failing test runs.\n\nOptions:\n1) skip multinode tests for this test case\n2) enforce scheduling onto the controller (*with* compute services)\n3) change the multi node test job config to setup the vnc options correctly\n\nPersonally, I tend to option 3), as this is a more realistic scenario.\nIt should also not be that big of a change. Should be these 3 options (max,\nI haven't yet tested the minimum to change)\n* NOVNCPROXY_URL=\"http://$SERVICE_HOST:6080/vnc_auto.html\"\n* VNCSERVER_LISTEN=$HOST_IP\n* VNCSERVER_PROXYCLIENT_ADDRESS=$VNCSERVER_LISTEN\n\nReferences:\n[1] https://github.com/openstack/nova/blob/cd3b57d0c0cb867ef48a6e9721d9b3e28cb08e84/nova/conf/vnc.py#L70-L78", 
            "date_created": "2017-03-09 09:08:07.925012+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Ah, good find, I was just about to start looking into this myself.\n\nNote that the multinode job was broken earlier until https://review.openstack.org/434996 added\n\nDEVSTACK_LOCAL_CONFIG=\"NOVA_VNC_ENABLED=true\"\n\nbut this probably needs amending.", 
            "date_created": "2017-03-09 09:39:05.094200+00:00", 
            "author": "https://api.launchpad.net/1.0/~j-harbott"
        }, 
        {
            "content": "Fix: https://review.openstack.org/#/c/444164/", 
            "date_created": "2017-03-10 09:08:29.954152+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Change https://review.openstack.org/#/c/444164/6 didn't solve it completely.\nThe VNC settings are not complete. The controller node (with compute service)\nis set up correctly:\n\n    [vnc]\n    xvpvncproxy_host = 0.0.0.0\n    novncproxy_host = 0.0.0.0\n    vncserver_proxyclient_address = 158.69.78.118\n    vncserver_listen = 0.0.0.0\n    xvpvncproxy_base_url = http://158.69.78.118:6081/console\n    novncproxy_base_url = http://158.69.78.118:6080/vnc_auto.html\n\nBut the compute node (subnode-2) is not:\n\n    [vnc]\n    xvpvncproxy_host = 0.0.0.0\n    novncproxy_host = 0.0.0.0\n    vncserver_proxyclient_address =\n    vncserver_listen = 0.0.0.0\n    xvpvncproxy_base_url = http://158.69.78.118:6081/console\n    novncproxy_base_url = http://158.69.78.118:6080/vnc_auto.html\n\nNote the missing IP address for \"vncserver_proxyclient_address\". This is\nprobably due to the wrong order of the variables in the \"local.conf\" of\nthe subnode:\n\n    NOVA_VNC_ENABLED=true\n    VNCSERVER_LISTEN=0.0.0.0\n    VNCSERVER_PROXYCLIENT_ADDRESS=$HOST_IP\n\n    HOST_IP=158.69.78.119\n\nThe \"HOST_IP\" has to be *before* the \"VNCSERVER_PROXYCLIENT_ADDRESS\".\nLogs: http://logs.openstack.org/76/400876/31/check/gate-tempest-dsvm-neutron-multinode-full-ubuntu-xenial-nv/63d2bdd/logs/\n\nThe Logstash query: http://logstash.openstack.org/#/dashboard/file/logstash.json?from=7d&query=message:%5C%22AssertionError:%20True%20is%20not%20false%20:%20Token%20must%20be%20invalid%20because%20the%20connection%20closed.%5C%22", 
            "date_created": "2017-03-21 12:38:24.480364+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "An attempt to fix the order of localrc variables for the subnode: https://review.openstack.org/#/c/448078/1", 
            "date_created": "2017-03-21 13:02:43.757142+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "No hits in logstash after https://review.openstack.org/#/c/448078/1 merged. => resolved", 
            "date_created": "2017-03-22 08:53:20.292358+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "It's still hitting master and stable, including non-multinode jobs. Example: http://logs.openstack.org/27/461827/1/check/gate-tempest-dsvm-py35-ubuntu-xenial/6805498/logs/testr_results.html.gz", 
            "date_created": "2017-05-02 19:25:49.473702+00:00", 
            "author": "https://api.launchpad.net/1.0/~ihar-hrachyshka"
        }, 
        {
            "content": "Yeah still showing up:\n\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=(message%3A%5C%22AssertionError%3A%20True%20is%20not%20false%20%3A%20Token%20must%20be%20invalid%20because%20the%20connection%20closed.%5C%22%20OR%20message%3A%5C%22b'AssertionError%3A%20True%20is%20not%20false%20%3A%20Token%20must%20be%20invalid%20because%20the%20connection%20closed.'%5C%22)%20AND%20tags%3A%5C%22console%5C%22&from=7d", 
            "date_created": "2017-05-02 19:38:17.044449+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Hmm... that piece stands out:\n\n    stderr: {{{\n/opt/stack/new/tempest/tempest/api/compute/servers/test_novnc.py:166: ResourceWarning: unclosed <socket.socket fd=4, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('10.36.191.29', 60968), raddr=('10.36.191.29', 6080)>\n  self._validate_novnc_html(body['url'])\n\nMaybe I can take a look at it this week. If someone else is faster, be my guest.", 
            "date_created": "2017-05-03 06:42:32.402777+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }
    ]
}