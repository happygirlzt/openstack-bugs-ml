{
    "status": "Invalid", 
    "last_updated": "2013-05-11 18:18:42.596612+00:00", 
    "description": "Hyper-V driver gets host_ip from https://github.com/openstack/nova/blob/master/nova/virt/hyperv/hostops.py#L169 , will use  my_ip  got from https://github.com/openstack/nova/blob/master/nova/netconf.py firstly.   If it raise a execption without my_ip set in nova.conf and can't connect to Google DNS server , my_ip will be '127.0.0.1'.  In this situation will report Hyper-V host 's ip '127.0.0.1'  to control node .  It raise IO exception during resize", 
    "tags": [], 
    "importance": "Low", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1177708", 
    "owner": "None", 
    "id": 1177708, 
    "index": 5755, 
    "created": "2013-05-08 09:05:13.481922+00:00", 
    "title": "Resize instance fails on Hyper-V due to my_ip set to 127.0.0.1 when routing to 8.8.8.8 fails", 
    "comments": [
        {
            "content": "Hyper-V driver gets host_ip from https://github.com/openstack/nova/blob/master/nova/virt/hyperv/hostops.py#L169 , will use  my_ip  got from https://github.com/openstack/nova/blob/master/nova/netconf.py firstly.   If it raise a execption ,  my_ip will be '127.0.0.1'  In this situation will report Hyper-V host 's ip '127.0.0.1'  to control node .  It raise  IO exception during resze", 
            "date_created": "2013-05-08 09:05:13.481922+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "1.  Error message\nnova show Issue_151720_1\n+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Property                            | Value                                                                                                                                                                                                      |\n+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| status                              | ERROR                                                                                                                                                                                                      |\n| vlan210 network                     | 10.210.100.1                                                                                                                                                                                               |\n| updated                             | 2013-05-07T15:04:00Z                                                                                                                                                                                       |\n| OS-EXT-STS:task_state               | None                                                                                                                                                                                                       |\n| OS-EXT-SRV-ATTR:host                | idpx49                                                                                                                                                                                                     |\n| key_name                            | None                                                                                                                                                                                                       |\n| image                               | quantal-server-cloudimg-amd64 (3ac73a1c-8ee8-4150-a643-74ce2a030a7f)                                                                                                                                       |\n| hostId                              | 9eac277b631ae154ada2f8e564f663f6f33753ec2375671429cf935b                                                                                                                                                   |\n| OS-EXT-STS:vm_state                 | error                                                                                                                                                                                                      |\n| OS-EXT-SRV-ATTR:instance_name       | instance-000003d9                                                                                                                                                                                          |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | idpx49                                                                                                                                                                                                     |\n| flavor                              | m1.small (2)                                                                                                                                                                                               |\n| id                                  | 084992fb-af87-4ff1-bd97-08711c4c3e5b                                                                                                                                                                       |\n| security_groups                     | [{u'name': u'default'}]                                                                                                                                                                                    |\n| user_id                             | eed0d0d80e154eb2b1d967380cb15231                                                                                                                                                                           |\n| name                                | Issue_151720_1                                                                                                                                                                                             |\n| created                             | 2013-05-07T15:01:43Z                                                                                                                                                                                       |\n| tenant_id                           | 17c4fe77ff6444f599e0ccd8b93afaa0                                                                                                                                                                           |\n| OS-DCF:diskConfig                   | MANUAL                                                                                                                                                                                                     |\n| metadata                            | {}                                                                                                                                                                                                         |\n| accessIPv4                          |                                                                                                                                                                                                            |\n| accessIPv6                          |                                                                                                                                                                                                            |\n| fault                               | {u'message': u'IOError', u'code': 500, u'details': u'The file copy from D:\\\\Hyper-V Agent\\\\instances\\\\instance-000003d9\\\\root.vhd to \\\\\\\\127.0.0.1\\\\D$\\\\Hyper-V Agent\\\\instances\\\\instance-000003d9 failed |\n|                                     |   File \"C:\\\\Program Files (x86)\\\\IBM\\\\SmartCloud Entry\\\\Hyper-V Agent\\\\Python27\\\\lib\\\\site-packages\\                                                                                                       |\n|                                     | ova\\\\compute\\\\manager.py\", line 230, in decorated_function                                                                                                                                                 |\n|                                     |     return function(self, context, *args, **kwargs)                                                                                                                                                        |\n|                                     |   File \"C:\\\\Program Files (x86)\\\\IBM\\\\SmartCloud Entry\\\\Hyper-V Agent\\\\Python27\\\\lib\\\\site-packages\\                                                                                                       |\n|                                     | ova\\\\compute\\\\manager.py\", line 2380, in resize_instance                                                                                                                                                   |\n|                                     |     block_device_info)                                                                                                                                                                                     |\n|                                     |   File \"C:\\\\Program Files (x86)\\\\IBM\\\\SmartCloud Entry\\\\Hyper-V Agent\\\\Python27\\\\lib\\\\site-packages\\                                                                                                       |\n|                                     | ova\\\\virt\\\\hyperv\\\\driver.py\", line 172, in migrate_disk_and_power_off                                                                                                                                     |\n|                                     |     block_device_info)                                                                                                                                                                                     |\n|                                     |   File \"C:\\\\Program Files (x86)\\\\IBM\\\\SmartCloud Entry\\\\Hyper-V Agent\\\\Python27\\\\lib\\\\site-packages\\                                                                                                       |\n|                                     | ova\\\\virt\\\\hyperv\\\\migrationops.py\", line 114, in migrate_disk_and_power_off                                                                                                                               |\n|                                     |     self._migrate_disk_files(instance_name, disk_files, dest)                                                                                                                                              |\n|                                     |   File \"C:\\\\Program Files (x86)\\\\IBM\\\\SmartCloud Entry\\\\Hyper-V Agent\\\\Python27\\\\lib\\\\site-packages\\                                                                                                       |\n|                                     | ova\\\\virt\\\\hyperv\\\\migrationops.py\", line 87, in _migrate_disk_files                                                                                                                                       |\n|                                     |     dest_path)                                                                                                                                                                                             |\n|                                     |   File \"C:\\\\Program Files (x86)\\\\IBM\\\\SmartCloud Entry\\\\Hyper-V Agent\\\\Python27\\\\lib\\\\contextlib.py\", line 24, in __exit__                                                                                 |\n|                                     |     self.gen.next()                                                                                                                                                                                        |\n|                                     |   File \"C:\\\\Program Files (x86)\\\\IBM\\\\SmartCloud Entry\\\\Hyper-V Agent\\\\Python27\\\\lib\\\\site-packages\\                                                                                                       |\n|                                     | ova\\\\virt\\\\hyperv\\\\migrationops.py\", line 78, in _migrate_disk_files                                                                                                                                       |\n|                                     |     self._pathutils.copy(disk_file, dest_path)                                                                                                                                                             |\n|                                     |   File \"C:\\\\Program Files (x86)\\\\IBM\\\\SmartCloud Entry\\\\Hyper-V Agent\\\\Python27\\\\lib\\\\site-packages\\                                                                                                       |\n|                                     | ova\\\\virt\\\\hyperv\\\\pathutils.py\", line 74, in copy                                                                                                                                                         |\n|                                     |     raise IOError(_(\\'The file copy from %(src)s to %(dest)s failed\\' % locals()))                                                                                                                         |\n|                                     | ', u'created': u'2013-05-07T15:03:59Z'}                                                                                                                                                                    |\n| OS-EXT-STS:power_state              | 1                                                                                                                                                                                                          |\n| OS-EXT-AZ:availability_zone         | nova                                                                                                                                                                                                       |\n| config_drive                        |                                                                                                                                                                                                            |\n+-------------------------------------+-------------------------------------------------------------------------------------------------------\n", 
            "date_created": "2013-05-08 09:10:38.437580+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "2. report 127.0.0.1 to compute node \n2013-05-08 04:08:56.565 2798 DEBUG nova.openstack.common.rpc.amqp [-] received {u'_context_roles': [], u'_context_request_id': u'req-8d0e0b84-de1c-454a-9111-e093415ec105', u'_context_quota_class': None, u'_context_project_name': None, u'_context_service_catalog': [], u'_context_user_name': None, u'_context_auth_token': '<SANITIZED>', u'args': {u'service_name': u'compute', u'host': u'idpx49', u'capabilities': [{u'host_memory_free_computed': 121811, u'disk_available': 3567, u'supported_instances': [[u'i686', u'hyperv', u'hvm'], [u'x86_64', u'hyperv', u'hvm']], u'host_memory_overhead': 9249, u'host_ip': u'127.0.0.1', u'hypervisor_hostname': u'idpx49', u'host_memory_free': 121811, u'disk_total': 3721, u'host_memory_total': 131060, u'disk_used': 154}]}, u'_context_tenant': None, u'_context_instance_lock_checked': False, u'_context_timestamp': u'2013-05-08T09:09:17.291000', u'_context_is_admin': True, u'version': u'2.4', u'_context_project_id': None, u'_context_user': None, u'_unique_id': u'be7e06fb962a47fe8b71983ee9259fc8', u'_context_read_deleted': u'no', u'_context_user_id': None, u'method': u'update_service_capabilities', u'_context_remote_address': None} _safe_log /usr/lib/python2.6/site-packages/nova/openstack/common/rpc/common.py:276\n\n", 
            "date_created": "2013-05-08 09:13:59.350066+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "There is no my_ip option in nova.conf, I try  the following in my Hyper-V , it raise a exception .\ndef _get_my_ip():\n    \"\"\"\n    Returns the actual ip of the local machine.\n\n    This code figures out what source address would be used if some traffic\n    were to be sent out to some well known address on the Internet. In this\n    case, a Google DNS server is used, but the specific address does not\n    matter much.  No traffic is actually sent.\n    \"\"\"\n    try:\n        csock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)\n        csock.connect(('8.8.8.8', 80))  -----------------------------> this will fail\n        (addr, port) = csock.getsockname()\n        csock.close()\n        return addr\n    except socket.error:\n        return \"127.0.0.1\"\n1)\nDo we need  add addtion logic to check this situation in https://github.com/openstack/nova/blob/master/nova/virt/hyperv/hostops.py#L169 ?\n2) method _migrate_disk_files in  nova/nova/virt/hyperv/migrationops.py  using  _hostutils.get_local_ips() to check if the resize in the same host.  '127.0.0.1' is not in local ips ,then treat it as different host resize , lead to the IO exeception .\n", 
            "date_created": "2013-05-08 09:27:34.333003+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "Can you please use http://paste.openstack.org/ to paste the logs and long command outputs?\n\nFormat issues and size make comments unreadable.\n\nThanks!\n", 
            "date_created": "2013-05-08 09:32:29.644209+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }, 
        {
            "content": "As an additional note, the resize target network share is based on the following conf setting: \"instances_path_share\"\n\nhttps://github.com/openstack/nova/blob/master/nova/virt/hyperv/pathutils.py#L28\n", 
            "date_created": "2013-05-08 09:38:35.204058+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }, 
        {
            "content": " Error mesage  in  http://paste.openstack.org/show/36967/", 
            "date_created": "2013-05-08 10:09:34.084998+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "More information about the test enviroments :  There are  four Hyper-V hosts , and one control node .   Three hosts   report   '127.0.0.1' as host_ip to control node , only one host can report its host_ip correctly . If the scheduler   decides resize to the three ones , the dest ip  will be 127.0.0.1 , then the error occurs.\n\nThe following is compute log:\nhttp://paste.openstack.org/show/37035/", 
            "date_created": "2013-05-09 03:24:52.169909+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "Work around for this issue  , We can set my_ip option in nova.conf ,   \nor  add patch  as follow:\nopenstack@ubuntu:~/test$ diff -u hostops.py.old hostops.py\n--- hostops.py.old\t2013-05-08 22:19:42.115338394 -0700\n+++ hostops.py\t2013-05-08 22:32:31.194188754 -0700\n@@ -168,7 +168,7 @@\n \n     def get_host_ip_addr(self):\n         host_ip = CONF.my_ip\n-        if not host_ip:\n+        if not host_ip or host_ip == '127.0.0.1':\n             # Return the first available address\n             host_ip = self._hostutils.get_local_ips()[0]\n         LOG.debug(_(\"Host IP address is: %s\"), host_ip)\nIn current logic  CONF.my_ip always has one value ,  host_ip = self._hostutils.get_local_ips()[0] is never called.\nWhat's your  opinion ?", 
            "date_created": "2013-05-09 05:35:42.844948+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "Frankly the way in which _get_my_ip() works could be improved as there are quite a few situations in which Internet access is simply not available.\n\nYour proposed workaround looks good to me.", 
            "date_created": "2013-05-09 14:55:59.612611+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }, 
        {
            "content": "Looking better at the _get_my_ip() code, since it's using UDP (SOCK_DGRAM), the only reason for a failure is if a default gateway is not set:\n\nhttps://github.com/openstack/nova/blob/master/nova/netconf.py#L37\n\nCan you try to set a default gateway (real or fake) on your host and let me know if you get the proper address?\n\nTo add a default gw on WIndows on the command line:\n\nroute add 0.0.0.0 mask 0.0.0.0  <gateway ip address> \n", 
            "date_created": "2013-05-09 15:18:49.319508+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }, 
        {
            "content": "Thanks for your  reply , I saw libvirt alse gets   host_ip  like this ,  so this is about network configuration issue not a bug ,right ?", 
            "date_created": "2013-05-09 16:02:03.983018+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "I'd consider this a network configuration issue. \n\nCan you confirm that with a default gateway set everything works?\n\nWe can also add support for scenarios in which a gateway is not set by adding the workaround that you suggested (checking for my_ip == \"127.0.0.1\").\n", 
            "date_created": "2013-05-09 16:15:48.565331+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }, 
        {
            "content": "My colleague  help confirm that with a default  gateway set everything works:\n \"I added a gateway to each of the hosts  and commented out the my_ip option in the nova.conf file on each host. \nThe resize commands are now working on each of the hosts.  The vm has a VERIFY_RESIZE status after the command completes.\"\n", 
            "date_created": "2013-05-10 01:47:26.285456+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "update :  a fake gateway doesn't work ", 
            "date_created": "2013-05-10 05:21:52.078528+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "The gateway was properly configured (same network as the expected adapter IP)?\n\nCan you post a pastebin with the output of:\n\nipconfig /all\nroute print\n\nAnd finally the output of a LOG statement to be added here: https://github.com/openstack/nova/blob/master/nova/netconf.py#L43\n\nThanks\n", 
            "date_created": "2013-05-10 06:31:53.400503+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }, 
        {
            "content": "A  fake gateway doesn't work on Window 7  in #14,  I  don't have chance to try fake gateway  on a Hyper-V host. \n My colleage  added a real gateway on a Hyper-V hsot , it works well.\nthanks.", 
            "date_created": "2013-05-10 06:51:03.953909+00:00", 
            "author": "https://api.launchpad.net/1.0/~glongwave"
        }, 
        {
            "content": "Windows 7??? :-)\n", 
            "date_created": "2013-05-10 08:20:44.468301+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }
    ]
}