{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 12:06:56.728969+00:00", 
    "description": "An example from a quota_usages table affected by I24af1f6bc439d5d740303c6fe176a9bffe754579 as best I can tell.  The project_id in this case has 2 provisioned instances.\n\nmysql> select * from quota_usages where project_id = '5853597';+---------------------+---------------------+------------+------+------------+-----------+--------+----------+---------------+---------+----------+\n| created_at          | updated_at          | deleted_at | id   | project_id | resource  | in_use | reserved | until_refresh | deleted | user_id  |\n+---------------------+---------------------+------------+------+------------+-----------+--------+----------+---------------+---------+----------+\n| 2013-04-22 19:57:31 | 2013-08-06 15:44:07 | NULL       | 2595 | 5853597    | instances |     95 |        0 |          NULL |       0 | NULL     |\n| 2013-04-22 19:57:31 | 2013-08-06 15:44:07 | NULL       | 2596 | 5853597    | ram       |  58880 |        0 |          NULL |       0 | NULL     |\n| 2013-04-22 19:57:31 | 2013-08-06 15:44:07 | NULL       | 2597 | 5853597    | cores     |     95 |        0 |          NULL |       0 | NULL     |\n| 2013-08-07 21:35:07 | 2013-08-15 17:33:53 | NULL       | 3294 | 5853597    | instances |      2 |        0 |          NULL |       0 | 10141776 |\n| 2013-08-07 21:35:07 | 2013-08-15 17:33:53 | NULL       | 3295 | 5853597    | ram       |   1024 |        0 |          NULL |       0 | 10141776 |\n| 2013-08-07 21:35:07 | 2013-08-15 17:33:53 | NULL       | 3296 | 5853597    | cores     |      2 |        0 |          NULL |       0 | 10141776 |\n| 2013-08-12 15:18:02 | 2013-08-12 15:18:56 | NULL       | 3575 | 5853597    | instances |      0 |        0 |          NULL |       0 | 10085931 |\n| 2013-08-12 15:18:02 | 2013-08-12 15:18:56 | NULL       | 3576 | 5853597    | ram       |      0 |        0 |          NULL |       0 | 10085931 |\n| 2013-08-12 15:18:02 | 2013-08-12 15:18:56 | NULL       | 3577 | 5853597    | cores     |      0 |        0 |          NULL |       0 | 10085931 |\n+---------------------+---------------------+------------+------+------------+-----------+--------+----------+---------------+---------+----------+\n9 rows in set (0.00 sec)\n\nThe migration and code in I24af1f6bc439d5d740303c6fe176a9bffe754579 added a user_id column and support for tracking quota_usage by user.  What appears to be happening is when the user_id column is added the current rows are left with a NULL user_id.  So all further quota_usages updates create and affect new rows and the user_id=NULL rows are never updated again.\n\nThis becomes an issue because of the self healing for quota_usages.  In this case user_id 10141776 deleted the 95 instances that existed at the time of the migration, but each time in_use goes negative there's a sync method called in db/sqlalchemy/api.py:quota_reserve() which sets it properly for that user but doesn't update the usage for the NULL user.", 
    "tags": [], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1212798", 
    "owner": "https://api.launchpad.net/1.0/~alaski", 
    "id": 1212798, 
    "index": 1183, 
    "created": "2013-08-15 18:50:52.890932+00:00", 
    "title": "quota_usages not decremented properly after per user quota migration", 
    "comments": [
        {
            "content": "An example from a quota_usages table affected by I24af1f6bc439d5d740303c6fe176a9bffe754579 as best I can tell.  The project_id in this case has 2 provisioned instances.\n\nmysql> select * from quota_usages where project_id = '5853597';+---------------------+---------------------+------------+------+------------+-----------+--------+----------+---------------+---------+----------+\n| created_at          | updated_at          | deleted_at | id   | project_id | resource  | in_use | reserved | until_refresh | deleted | user_id  |\n+---------------------+---------------------+------------+------+------------+-----------+--------+----------+---------------+---------+----------+\n| 2013-04-22 19:57:31 | 2013-08-06 15:44:07 | NULL       | 2595 | 5853597    | instances |     95 |        0 |          NULL |       0 | NULL     |\n| 2013-04-22 19:57:31 | 2013-08-06 15:44:07 | NULL       | 2596 | 5853597    | ram       |  58880 |        0 |          NULL |       0 | NULL     |\n| 2013-04-22 19:57:31 | 2013-08-06 15:44:07 | NULL       | 2597 | 5853597    | cores     |     95 |        0 |          NULL |       0 | NULL     |\n| 2013-08-07 21:35:07 | 2013-08-15 17:33:53 | NULL       | 3294 | 5853597    | instances |      2 |        0 |          NULL |       0 | 10141776 |\n| 2013-08-07 21:35:07 | 2013-08-15 17:33:53 | NULL       | 3295 | 5853597    | ram       |   1024 |        0 |          NULL |       0 | 10141776 |\n| 2013-08-07 21:35:07 | 2013-08-15 17:33:53 | NULL       | 3296 | 5853597    | cores     |      2 |        0 |          NULL |       0 | 10141776 |\n| 2013-08-12 15:18:02 | 2013-08-12 15:18:56 | NULL       | 3575 | 5853597    | instances |      0 |        0 |          NULL |       0 | 10085931 |\n| 2013-08-12 15:18:02 | 2013-08-12 15:18:56 | NULL       | 3576 | 5853597    | ram       |      0 |        0 |          NULL |       0 | 10085931 |\n| 2013-08-12 15:18:02 | 2013-08-12 15:18:56 | NULL       | 3577 | 5853597    | cores     |      0 |        0 |          NULL |       0 | 10085931 |\n+---------------------+---------------------+------------+------+------------+-----------+--------+----------+---------------+---------+----------+\n9 rows in set (0.00 sec)\n\nThe migration and code in I24af1f6bc439d5d740303c6fe176a9bffe754579 added a user_id column and support for tracking quota_usage by user.  What appears to be happening is when the user_id column is added the current rows are left with a NULL user_id.  So all further quota_usages updates create and affect new rows and the user_id=NULL rows are never updated again.\n\nThis becomes an issue because of the self healing for quota_usages.  In this case user_id 10141776 deleted the 95 instances that existed at the time of the migration, but each time in_use goes negative there's a sync method called in db/sqlalchemy/api.py:quota_reserve() which sets it properly for that user but doesn't update the usage for the NULL user.", 
            "date_created": "2013-08-15 18:50:52.890932+00:00", 
            "author": "https://api.launchpad.net/1.0/~alaski"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/42736", 
            "date_created": "2013-08-19 21:02:42.643470+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/42736\nCommitted: http://github.com/openstack/nova/commit/a1e433b476498c8889d90b5aeee3b4d307e2ace0\nSubmitter: Jenkins\nBranch:    master\n\ncommit a1e433b476498c8889d90b5aeee3b4d307e2ace0\nAuthor: Andrew Laski <email address hidden>\nDate:   Mon Aug 19 16:57:50 2013 -0400\n\n    Full sync of quota_usages\n    \n    Migration 203 added a user_id column to the quota_usages table.  Now\n    some usages are incremented/decremented on a per user basis but there\n    are preexisting usages stored with a NULL user, and some usages are\n    tracked per project but there are usages stored with a user_id.  These\n    quotas are never decremented leading to invalid quota limits being\n    enforced.\n    \n    This migration performs a full sync of quotas, and removes the incorrect\n    rows for each resource type.\n    \n    Change-Id: Iff96f81e36b135df94a6f25c9443d0e9333bd18f\n    Closes-Bug: #1212798\n", 
            "date_created": "2013-10-01 08:12:44.787825+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}