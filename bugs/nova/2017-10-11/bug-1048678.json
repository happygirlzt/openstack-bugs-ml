{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:46:10.060762+00:00", 
    "description": "Problem Description:\n\nWhen attempting \"nova flavor-delete\" sometimes an API error occurs, where it seems that the ID passed as a nova CLI argument is mapped to the wrong flavor name, resulting in a \"could not be found\" 404 error, even though the selected ID is present in the \"nova flavor-list\" output:\n\n```\n[root@heatlt heat]# nova flavor-list\n+----+------------+-----------+------+-----------+------+-------+-------------+\n| ID |    Name    | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor |\n+----+------------+-----------+------+-----------+------+-------+-------------+\n| 1  | t1.micro   | 256       | 0    | 10        |      | 1     | 1.0         |\n| 8  | m2.2xlarge | 2048      | 0    | 10        |      | 2     | 1.0         |\n| 9  | m2.4xlarge | 2048      | 0    | 10        |      | 2     | 1.0         |\n+----+------------+-----------+------+-----------+------+-------+-------------+\n\n[root@heatlt heat]# nova --debug flavor-delete 1\nconnect: (127.0.0.1, 5000)\nsend: 'POST /v2.0/tokens HTTP/1.1\\r\\nHost: 127.0.0.1:5000\\r\\nContent-Length: 106\\r\\ncontent-type: application/json\\r\\naccept-encoding: gzip, deflate\\r\\naccept: application/json\\r\\nuser-agent: python-novaclient\\r\\n\\r\\n{\"auth\": {\"tenantName\": \"admin\", \"passwordCredentials\": {\"username\": \"admin\", \"password\": \"verybadpass\"}}}'\nreply: 'HTTP/1.1 200 OK\\r\\n'\nheader: Content-Type: application/json\nheader: Vary: X-Auth-Token\nheader: Date: Mon, 10 Sep 2012 14:15:08 GMT\nheader: Transfer-Encoding: chunked\nconnect: (localhost, 8774)\nsend: u'DELETE /v1.1/fd7795f68eab47d0906d305e470ab155/flavors/1 HTTP/1.1\\r\\nHost: localhost:8774\\r\\nx-auth-project-id: admin\\r\\nx-auth-token: 1f98c1b6366146ea8a8b70ba1a4cfd31\\r\\naccept-encoding: gzip, deflate\\r\\naccept: application/json\\r\\nuser-agent: python-novaclient\\r\\n\\r\\n'\nreply: 'HTTP/1.1 404 Not Found\\r\\n'\nheader: Content-Length: 78\nheader: Content-Type: application/json; charset=UTF-8\nheader: X-Compute-Request-Id: req-ece516fa-cebd-491b-ac66-c24f75bc63c5\nheader: Date: Mon, 10 Sep 2012 14:15:09 GMT\nDEBUG (shell:416) The resource could not be found. (HTTP 404)\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/site-packages/novaclient/shell.py\", line 413, in main\n    OpenStackComputeShell().main(sys.argv[1:])\n  File \"/usr/lib/python2.7/site-packages/novaclient/shell.py\", line 364, in main\n    args.func(self.cs, args)\n  File \"/usr/lib/python2.7/site-packages/novaclient/v1_1/shell.py\", line 311, in do_flavor_delete\n    cs.flavors.delete(args.id)\n  File \"/usr/lib/python2.7/site-packages/novaclient/v1_1/flavors.py\", line 59, in delete\n    self._delete(\"/flavors/%s\" % base.getid(flavor))\n  File \"/usr/lib/python2.7/site-packages/novaclient/base.py\", line 166, in _delete\n    resp, body = self.api.client.delete(url)\n  File \"/usr/lib/python2.7/site-packages/novaclient/client.py\", line 145, in delete\n    return self._cs_request(url, 'DELETE', **kwargs)\n  File \"/usr/lib/python2.7/site-packages/novaclient/client.py\", line 124, in _cs_request\n    **kwargs)\n  File \"/usr/lib/python2.7/site-packages/novaclient/client.py\", line 107, in request\n    raise exceptions.from_response(resp, body)\nNotFound: The resource could not be found. (HTTP 404)\nERROR: The resource could not be found. (HTTP 404)\n```\n\nThere is a backtrace in the nova API log, which seems to suggest the ID (t1.micro) is being mapped to the wrong name ( m1.tiny), full backtrace attached.\n\n```\n2012-09-10 15:15:09 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/contrib/flavormanage.py\", line 49, in _delete\n2012-09-10 15:15:09 TRACE nova.api.openstack     instance_types.destroy(flavor['name'])\n2012-09-10 15:15:09 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/instance_types.py\", line 87, in destroy\n2012-09-10 15:15:09 TRACE nova.api.openstack     raise exception.InstanceTypeNotFoundByName(instance_type_name=name)\n2012-09-10 15:15:09 TRACE nova.api.openstack InstanceTypeNotFoundByName: Instance type with name m1.tiny could not be found.\n2012-09-10 15:15:09 TRACE nova.api.openstack \n2012-09-10 15:15:09 INFO nova.api.openstack [req-ece516fa-cebd-491b-ac66-c24f75bc63c5 0c8a0190783648159f3e4b4fd2aaca03 fd7795f68eab47d0906d305e470ab155] http://localhost:8774/v1.1/fd7795f68eab47d0906d305e470ab155/flavors/1 returned with HTTP 404\n```\n\nTest environment : Fedora 17, package versions as follows:\n\n$ rpm -qa | grep nova\nopenstack-nova-volume-2012.1.1-15.fc17.noarch\npython-nova-2012.1.1-15.fc17.noarch\nopenstack-nova-cert-2012.1.1-15.fc17.noarch\nopenstack-nova-scheduler-2012.1.1-15.fc17.noarch\npython-novaclient-2012.1-2.fc17.noarch\nopenstack-nova-compute-2012.1.1-15.fc17.noarch\nopenstack-nova-api-2012.1.1-15.fc17.noarch\nopenstack-nova-2012.1.1-15.fc17.noarch\nopenstack-nova-objectstore-2012.1.1-15.fc17.noarch\nopenstack-nova-console-2012.1.1-15.fc17.noarch\nopenstack-nova-common-2012.1.1-15.fc17.noarch\nopenstack-nova-network-2012.1.1-15.fc17.noarch\n\n\nReproducer:\n\nRunning the heat-api \"tools/nova_create_flavors.sh\" script multiple times will reliably trigger this bug.  \n\nThis script deletes all current flavors, and creates a predefined set of flavors.  It will work once, then on the second run it nearly always errors on one flavor-delete.  Copy of this script is attached below.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1048678", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 1048678, 
    "index": 3041, 
    "created": "2012-09-10 14:40:24.410862+00:00", 
    "title": "nova flavor-delete fails with InstanceTypeNotFoundByName API error", 
    "comments": [
        {
            "content": "Problem Description:\n\nWhen attempting \"nova flavor-delete\" sometimes an API error occurs, where it seems that the ID passed as a nova CLI argument is mapped to the wrong flavor name, resulting in a \"could not be found\" 404 error, even though the selected ID is present in the \"nova flavor-list\" output:\n\n```\n[root@heatlt heat]# nova flavor-list\n+----+------------+-----------+------+-----------+------+-------+-------------+\n| ID |    Name    | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor |\n+----+------------+-----------+------+-----------+------+-------+-------------+\n| 1  | t1.micro   | 256       | 0    | 10        |      | 1     | 1.0         |\n| 8  | m2.2xlarge | 2048      | 0    | 10        |      | 2     | 1.0         |\n| 9  | m2.4xlarge | 2048      | 0    | 10        |      | 2     | 1.0         |\n+----+------------+-----------+------+-----------+------+-------+-------------+\n\n[root@heatlt heat]# nova --debug flavor-delete 1\nconnect: (127.0.0.1, 5000)\nsend: 'POST /v2.0/tokens HTTP/1.1\\r\\nHost: 127.0.0.1:5000\\r\\nContent-Length: 106\\r\\ncontent-type: application/json\\r\\naccept-encoding: gzip, deflate\\r\\naccept: application/json\\r\\nuser-agent: python-novaclient\\r\\n\\r\\n{\"auth\": {\"tenantName\": \"admin\", \"passwordCredentials\": {\"username\": \"admin\", \"password\": \"verybadpass\"}}}'\nreply: 'HTTP/1.1 200 OK\\r\\n'\nheader: Content-Type: application/json\nheader: Vary: X-Auth-Token\nheader: Date: Mon, 10 Sep 2012 14:15:08 GMT\nheader: Transfer-Encoding: chunked\nconnect: (localhost, 8774)\nsend: u'DELETE /v1.1/fd7795f68eab47d0906d305e470ab155/flavors/1 HTTP/1.1\\r\\nHost: localhost:8774\\r\\nx-auth-project-id: admin\\r\\nx-auth-token: 1f98c1b6366146ea8a8b70ba1a4cfd31\\r\\naccept-encoding: gzip, deflate\\r\\naccept: application/json\\r\\nuser-agent: python-novaclient\\r\\n\\r\\n'\nreply: 'HTTP/1.1 404 Not Found\\r\\n'\nheader: Content-Length: 78\nheader: Content-Type: application/json; charset=UTF-8\nheader: X-Compute-Request-Id: req-ece516fa-cebd-491b-ac66-c24f75bc63c5\nheader: Date: Mon, 10 Sep 2012 14:15:09 GMT\nDEBUG (shell:416) The resource could not be found. (HTTP 404)\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/site-packages/novaclient/shell.py\", line 413, in main\n    OpenStackComputeShell().main(sys.argv[1:])\n  File \"/usr/lib/python2.7/site-packages/novaclient/shell.py\", line 364, in main\n    args.func(self.cs, args)\n  File \"/usr/lib/python2.7/site-packages/novaclient/v1_1/shell.py\", line 311, in do_flavor_delete\n    cs.flavors.delete(args.id)\n  File \"/usr/lib/python2.7/site-packages/novaclient/v1_1/flavors.py\", line 59, in delete\n    self._delete(\"/flavors/%s\" % base.getid(flavor))\n  File \"/usr/lib/python2.7/site-packages/novaclient/base.py\", line 166, in _delete\n    resp, body = self.api.client.delete(url)\n  File \"/usr/lib/python2.7/site-packages/novaclient/client.py\", line 145, in delete\n    return self._cs_request(url, 'DELETE', **kwargs)\n  File \"/usr/lib/python2.7/site-packages/novaclient/client.py\", line 124, in _cs_request\n    **kwargs)\n  File \"/usr/lib/python2.7/site-packages/novaclient/client.py\", line 107, in request\n    raise exceptions.from_response(resp, body)\nNotFound: The resource could not be found. (HTTP 404)\nERROR: The resource could not be found. (HTTP 404)\n```\n\nThere is a backtrace in the nova API log, which seems to suggest the ID (t1.micro) is being mapped to the wrong name ( m1.tiny), full backtrace attached.\n\n```\n2012-09-10 15:15:09 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/contrib/flavormanage.py\", line 49, in _delete\n2012-09-10 15:15:09 TRACE nova.api.openstack     instance_types.destroy(flavor['name'])\n2012-09-10 15:15:09 TRACE nova.api.openstack   File \"/usr/lib/python2.7/site-packages/nova/compute/instance_types.py\", line 87, in destroy\n2012-09-10 15:15:09 TRACE nova.api.openstack     raise exception.InstanceTypeNotFoundByName(instance_type_name=name)\n2012-09-10 15:15:09 TRACE nova.api.openstack InstanceTypeNotFoundByName: Instance type with name m1.tiny could not be found.\n2012-09-10 15:15:09 TRACE nova.api.openstack \n2012-09-10 15:15:09 INFO nova.api.openstack [req-ece516fa-cebd-491b-ac66-c24f75bc63c5 0c8a0190783648159f3e4b4fd2aaca03 fd7795f68eab47d0906d305e470ab155] http://localhost:8774/v1.1/fd7795f68eab47d0906d305e470ab155/flavors/1 returned with HTTP 404\n```\n\nTest environment : Fedora 17, package versions as follows:\n\n$ rpm -qa | grep nova\nopenstack-nova-volume-2012.1.1-15.fc17.noarch\npython-nova-2012.1.1-15.fc17.noarch\nopenstack-nova-cert-2012.1.1-15.fc17.noarch\nopenstack-nova-scheduler-2012.1.1-15.fc17.noarch\npython-novaclient-2012.1-2.fc17.noarch\nopenstack-nova-compute-2012.1.1-15.fc17.noarch\nopenstack-nova-api-2012.1.1-15.fc17.noarch\nopenstack-nova-2012.1.1-15.fc17.noarch\nopenstack-nova-objectstore-2012.1.1-15.fc17.noarch\nopenstack-nova-console-2012.1.1-15.fc17.noarch\nopenstack-nova-common-2012.1.1-15.fc17.noarch\nopenstack-nova-network-2012.1.1-15.fc17.noarch\n\n\nReproducer:\n\nRunning the heat-api \"tools/nova_create_flavors.sh\" script multiple times will reliably trigger this bug.  \n\nThis script deletes all current flavors, and creates a predefined set of flavors.  It will work once, then on the second run it nearly always errors on one flavor-delete.  Copy of this script is attached below.", 
            "date_created": "2012-09-10 14:40:24.410862+00:00", 
            "author": "https://api.launchpad.net/1.0/~shardy"
        }, 
        {
            "content": "", 
            "date_created": "2012-09-10 14:40:24.410862+00:00", 
            "author": "https://api.launchpad.net/1.0/~shardy"
        }, 
        {
            "content": "Script repoducer (from https://github.com/heat-api/heat tools)\n\nRun this multiple times and the error described above occurs.", 
            "date_created": "2012-09-10 14:42:49.211291+00:00", 
            "author": "https://api.launchpad.net/1.0/~shardy"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/12729", 
            "date_created": "2012-09-10 19:18:16.435062+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/12729\nCommitted: http://github.com/openstack/nova/commit/d741328543ad6059bef56adb59f4c94781eaedcd\nSubmitter: Jenkins\nBranch:    master\n\ncommit d741328543ad6059bef56adb59f4c94781eaedcd\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Mon Sep 10 12:15:02 2012 -0700\n\n    Fix flavor deletion when there is a deleted flavor\n    \n    If there is a deleted flavor with the same ID as an undeleted flavor,\n    the flavormanage delete code attempts to delete it again, which fails.\n    This patch makes sure to pass read_deleted='no' when the flavor is\n    retrieved for deletion so we get the undeleted flavor. Includes a\n    failing test to make sure the value is passed properly.\n    \n    Fixes bug 1048678\n    \n    Change-Id: If6a20de2526b7ba90ada4a40317a98f79b2141dc\n", 
            "date_created": "2012-09-12 23:20:43.411435+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}