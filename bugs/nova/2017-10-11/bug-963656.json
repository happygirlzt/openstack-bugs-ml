{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 11:21:20.582039+00:00", 
    "description": "I can't reproduce it by hand, but I can with a testing script I'm working on. I think it may be timing related, but that's not clear yet.\n\nMy script has only been able to reproduce when reverting a resize. I don't know how that is related yet.\n\nThe symptom is that you will have an instance left still running after a delete instance. The instance will be marked as deleted in the database and won't show up in 'nova list'.\n\nExceptions like this will end up in the nova-compute logs:\n\n2012-03-24 03:04:53 DEBUG nova.virt.xenapi.vm_utils [req-2d2923e0-efd9-4e50-9cb4-03c816e9f8e9 admin openstack] VDI c50358e4-6171-49dc-acfa-f4114bbae294 is still available from (pid=22488) lookup_vm_vdis /home/johannes/openstack/nova/trunk/nova/virt/xenapi/vm_utils.py:1025\n2012-03-24 03:04:53 ERROR nova.virt.xenapi.vm_utils [req-2d2923e0-efd9-4e50-9cb4-03c816e9f8e9 admin openstack] ['VDI_IN_USE', 'OpaqueRef:94e3ae3c-5ed2-3203-7ae9-c7ebdcb26116']\n(nova.virt.xenapi.vm_utils): TRACE: Traceback (most recent call last):\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/home/johannes/openstack/nova/trunk/nova/virt/xenapi/vm_utils.py\", line 318, in destroy_vdi\n(nova.virt.xenapi.vm_utils): TRACE:     session.call_xenapi('VDI.destroy', vdi_ref)\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/home/johannes/openstack/nova/trunk/nova/virt/xenapi_conn.py\", line 574, in call_xenapi\n(nova.virt.xenapi.vm_utils): TRACE:     return tpool.execute(f, *args)\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/eventlet/tpool.py\", line 76, in tworker\n(nova.virt.xenapi.vm_utils): TRACE:     rv = meth(*args,**kwargs)\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/eventlet/tpool.py\", line 76, in tworker\n(nova.virt.xenapi.vm_utils): TRACE:     rv = meth(*args,**kwargs)\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 229, in __call__\n(nova.virt.xenapi.vm_utils): TRACE:     return self.__send(self.__name, args)\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 133, in xenapi_request\n(nova.virt.xenapi.vm_utils): TRACE:     result = _parse_result(getattr(self, methodname)(*full_params))\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 203, in _parse_result\n(nova.virt.xenapi.vm_utils): TRACE:     raise Failure(result['ErrorDescription'])\n(nova.virt.xenapi.vm_utils): TRACE: Failure: ['VDI_IN_USE', 'OpaqueRef:94e3ae3c-5ed2-3203-7ae9-c7ebdcb26116']\n(nova.virt.xenapi.vm_utils): TRACE:\n2012-03-24 03:04:53 ERROR nova.virt.xenapi.vmops [req-2d2923e0-efd9-4e50-9cb4-03c816e9f8e9 admin openstack] Unable to destroy VDI OpaqueRef:94e3ae3c-5ed2-3203-7ae9-c7ebdcb26116", 
    "tags": [
        "essex-rc-potential"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/963656", 
    "owner": "https://api.launchpad.net/1.0/~johannes.erdfelt", 
    "id": 963656, 
    "index": 2719, 
    "created": "2012-03-24 04:25:47.860310+00:00", 
    "title": "xenapi VDI_IN_USE error when deleting an instance", 
    "comments": [
        {
            "content": "I can't reproduce it by hand, but I can with a testing script I'm working on. I think it may be timing related, but that's not clear yet.\n\nMy script has only been able to reproduce when reverting a resize. I don't know how that is related yet.\n\nThe symptom is that you will have an instance left still running after a delete instance. The instance will be marked as deleted in the database and won't show up in 'nova list'.\n\nExceptions like this will end up in the nova-compute logs:\n\n\n2012-03-24 03:04:53 DEBUG nova.virt.xenapi.vm_utils [req-2d2923e0-efd9-4e50-9cb4-03c816e9f8e9 admin openstack] VDI c50358e4-6171-49dc-acfa-f4114bbae294 is still available from (pid=22488) lookup_vm_vdis /home/johannes/openstack/nova/trunk/nova/virt/xenapi/vm_utils.py:1025\n2012-03-24 03:04:53 ERROR nova.virt.xenapi.vm_utils [req-2d2923e0-efd9-4e50-9cb4-03c816e9f8e9 admin openstack] ['VDI_IN_USE', 'OpaqueRef:94e3ae3c-5ed2-3203-7ae9-c7ebdcb26116']\n(nova.virt.xenapi.vm_utils): TRACE: Traceback (most recent call last):\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/home/johannes/openstack/nova/trunk/nova/virt/xenapi/vm_utils.py\", line 318, in destroy_vdi\n(nova.virt.xenapi.vm_utils): TRACE:     session.call_xenapi('VDI.destroy', vdi_ref)\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/home/johannes/openstack/nova/trunk/nova/virt/xenapi_conn.py\", line 574, in call_xenapi\n(nova.virt.xenapi.vm_utils): TRACE:     return tpool.execute(f, *args)\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/eventlet/tpool.py\", line 76, in tworker  \n(nova.virt.xenapi.vm_utils): TRACE:     rv = meth(*args,**kwargs)\n\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/eventlet/tpool.py\", line 76, in tworker  \n(nova.virt.xenapi.vm_utils): TRACE:     rv = meth(*args,**kwargs)\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 229, in __call__\n(nova.virt.xenapi.vm_utils): TRACE:     return self.__send(self.__name, args)\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 133, in xenapi_request  \n(nova.virt.xenapi.vm_utils): TRACE:     result = _parse_result(getattr(self, methodname)(*full_params))\n(nova.virt.xenapi.vm_utils): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 203, in _parse_result   \n(nova.virt.xenapi.vm_utils): TRACE:     raise Failure(result['ErrorDescription'])\n(nova.virt.xenapi.vm_utils): TRACE: Failure: ['VDI_IN_USE', 'OpaqueRef:94e3ae3c-5ed2-3203-7ae9-c7ebdcb26116']\n(nova.virt.xenapi.vm_utils): TRACE:\n2012-03-24 03:04:53 ERROR nova.virt.xenapi.vmops [req-2d2923e0-efd9-4e50-9cb4-03c816e9f8e9 admin openstack] Unable to destroy VDI OpaqueRef:94e3ae3c-5ed2-3203-7ae9-c7ebdcb26116", 
            "date_created": "2012-03-24 04:25:47.860310+00:00", 
            "author": "https://api.launchpad.net/1.0/~johannes.erdfelt"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/5827", 
            "date_created": "2012-03-26 19:39:56.753345+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/5827\nCommitted: http://github.com/openstack/nova/commit/80a55176e11da1594c9d663df0e4a0a755018c16\nSubmitter: Jenkins\nBranch:    master\n\ncommit 80a55176e11da1594c9d663df0e4a0a755018c16\nAuthor: Johannes Erdfelt <email address hidden>\nDate:   Mon Mar 26 17:25:12 2012 +0000\n\n    Don't set instance ACTIVE until it's really active\n    \n    Fixes bug 963656\n    \n    Reverting a resize would end up setting the instance ACTIVE before the\n    driver had finished all of the work starting up the original instance.\n    If the instance is deleted quickly after the revert, a race condition\n    could occur between restarting the original instance and deleting it.\n    \n    Change-Id: Iba26ad7d1bc1049137f94e13898be86698963fb3\n", 
            "date_created": "2012-03-26 21:20:48.617775+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: milestone-proposed\nReview: https://review.openstack.org/6032", 
            "date_created": "2012-03-31 00:08:18.393450+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/6032\nCommitted: http://github.com/openstack/nova/commit/9a21d9f7938a5f1e82f14bdf51502eda78c268c7\nSubmitter: Jenkins\nBranch:    milestone-proposed\n\ncommit 9a21d9f7938a5f1e82f14bdf51502eda78c268c7\nAuthor: Johannes Erdfelt <email address hidden>\nDate:   Mon Mar 26 17:25:12 2012 +0000\n\n    Don't set instance ACTIVE until it's really active\n    \n    Fixes bug 963656\n    \n    Reverting a resize would end up setting the instance ACTIVE before the\n    driver had finished all of the work starting up the original instance.\n    If the instance is deleted quickly after the revert, a race condition\n    could occur between restarting the original instance and deleting it.\n    \n    Change-Id: Iba26ad7d1bc1049137f94e13898be86698963fb3\n", 
            "date_created": "2012-04-01 02:07:50.090114+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}