{
    "status": "Fix Released", 
    "last_updated": "2016-12-19 12:01:58.380330+00:00", 
    "description": "trying to remove compute node properly\n\nSteps to reproduce\n==================\n1) remove all instances from the hypervisor:\n(env) vance@zs95k5:~$ nova hypervisor-servers zs93k23\n+----+------+---------------+---------------------+\n| ID | Name | Hypervisor ID | Hypervisor Hostname |\n+----+------+---------------+---------------------+\n+----+------+---------------+---------------------+\n\n2) disable the hypervisor:\n(env) vance@zs95k5:~$ nova service-list\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n| Id | Binary         | Host                | Zone     | Status   | State | Updated_at                 | Disabled Reason |\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n| 3  | nova-cert      | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:13:34.000000 | -               |\n| 4  | nova-scheduler | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:13:27.000000 | -               |\n| 5  | nova-conductor | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:13:30.000000 | -               |\n| 14 | nova-compute   | u27-maas-machine-1  | nova     | disabled | up    | 2016-11-30T21:13:28.000000 | -               |\n| 16 | nova-compute   | zs95k181            | nova     | enabled  | up    | 2016-11-30T21:13:33.000000 | -               |\n| 17 | nova-compute   | zs93k23             | nova     | enabled  | up    | 2016-11-30T21:13:33.000000 | -               |\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n(env) vance@zs95k5:~$ nova service-disable zs93k23 nova-compute\n+---------+--------------+----------+\n| Host    | Binary       | Status   |\n+---------+--------------+----------+\n| zs93k23 | nova-compute | disabled |\n+---------+--------------+----------+\n\n3) delete the compute service\n(env) vance@zs95k5:~$ nova service-delete 17\n(env) vance@zs95k5:~$ nova service-list\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n| Id | Binary         | Host                | Zone     | Status   | State | Updated_at                 | Disabled Reason |\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n| 3  | nova-cert      | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:14:54.000000 | -               |\n| 4  | nova-scheduler | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:14:47.000000 | -               |\n| 5  | nova-conductor | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:14:56.000000 | -               |\n| 14 | nova-compute   | u27-maas-machine-1  | nova     | disabled | up    | 2016-11-30T21:14:48.000000 | -               |\n| 16 | nova-compute   | zs95k181            | nova     | enabled  | up    | 2016-11-30T21:14:53.000000 | -               |\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n\n4) delete the neutron agent\n(env) vance@zs95k5:~$ openstack network agent list\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n| ID                                   | Agent Type         | Host               | Availability Zone | Alive | State | Binary                    |\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n| 039e4b7a-3dbe-4e87-a9a5-d4b569d3113d | Open vSwitch agent | u27-maas-machine-2 | None              | True  | UP    | neutron-openvswitch-agent |\n| 2aa13570-0e62-4198-96d9-dfe732d7874d | DHCP agent         | u27-maas-machine-2 | nova              | True  | UP    | neutron-dhcp-agent        |\n| 2ab2320a-69cb-4a7f-8ae4-541d3b2bdd3b | L3 agent           | u27-maas-machine-2 | nova              | True  | UP    | neutron-l3-agent          |\n| 48d6d83b-e459-46c8-945c-eea4197c01ec | Open vSwitch agent | zs95k181           | None              | True  | UP    | neutron-openvswitch-agent |\n| a36eecd5-1fb4-436a-becd-fccc737518fd | Metering agent     | u27-maas-machine-2 | None              | True  | UP    | neutron-metering-agent    |\n| aaee3bf0-f8bd-41b7-94ed-f9213f120016 | Open vSwitch agent | zs93k23            | None              | True  | UP    | neutron-openvswitch-agent |\n| c6039c81-ad20-4258-a926-bc4a90dccc96 | Loadbalancer agent | u27-maas-machine-2 | None              | True  | UP    | neutron-lbaas-agent       |\n| cfecc66c-2888-4c3d-8241-1d3fcd018a1f | Metadata agent     | u27-maas-machine-2 | None              | True  | UP    | neutron-metadata-agent    |\n| f60cbf28-f030-43ae-a598-0d0182529804 | Open vSwitch agent | u27-maas-machine-1 | None              | True  | UP    | neutron-openvswitch-agent |\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n(env) vance@zs95k5:~$ openstack network agent delete aaee3bf0-f8bd-41b7-94ed-f9213f120016\n(env) vance@zs95k5:~$ openstack network agent list\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n| ID                                   | Agent Type         | Host               | Availability Zone | Alive | State | Binary                    |\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n| 039e4b7a-3dbe-4e87-a9a5-d4b569d3113d | Open vSwitch agent | u27-maas-machine-2 | None              | True  | UP    | neutron-openvswitch-agent |\n| 2aa13570-0e62-4198-96d9-dfe732d7874d | DHCP agent         | u27-maas-machine-2 | nova              | True  | UP    | neutron-dhcp-agent        |\n| 2ab2320a-69cb-4a7f-8ae4-541d3b2bdd3b | L3 agent           | u27-maas-machine-2 | nova              | True  | UP    | neutron-l3-agent          |\n| 48d6d83b-e459-46c8-945c-eea4197c01ec | Open vSwitch agent | zs95k181           | None              | True  | UP    | neutron-openvswitch-agent |\n| a36eecd5-1fb4-436a-becd-fccc737518fd | Metering agent     | u27-maas-machine-2 | None              | True  | UP    | neutron-metering-agent    |\n| c6039c81-ad20-4258-a926-bc4a90dccc96 | Loadbalancer agent | u27-maas-machine-2 | None              | True  | UP    | neutron-lbaas-agent       |\n| cfecc66c-2888-4c3d-8241-1d3fcd018a1f | Metadata agent     | u27-maas-machine-2 | None              | True  | UP    | neutron-metadata-agent    |\n| f60cbf28-f030-43ae-a598-0d0182529804 | Open vSwitch agent | u27-maas-machine-1 | None              | True  | UP    | neutron-openvswitch-agent |\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n\n5) check hypervisor list\n(env) vance@zs95k5:~$ nova hypervisor-list\nERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.ComputeHostNotFound'> (HTTP 500) (Request-ID: req-2b773323-be4f-4c8c-be05-a41144ebed76)\n\nOkay, here is the error from the log:\nhttp://paste.ubuntu.com/23559892/\n\nExpected result\n===============\nNova compute node is properly removed from the OS database.\n\nEnvironment\n===========\n1. OpenStack nova version 2:13.1.2-0ubuntu2\n\n2. Hypervisor:\n\u00a0\u00a0\u00a0Libvirt+KVM (KVM for IBM z Systems)\n\n3. Networking type: OVS+GRE", 
    "tags": [
        "api", 
        "db", 
        "openstack-ibm"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1646255", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1646255, 
    "index": 4696, 
    "openned": "2016-11-30 21:40:49.096645+00:00", 
    "created": "2016-11-30 21:40:49.096645+00:00", 
    "title": "removing compute node causes ComputeHostNotFound in nova-api", 
    "comments": [
        {
            "content": "trying to remove compute node properly\n\nSteps to reproduce\n==================\n1) remove all instances from the hypervisor:\n(env) vance@zs95k5:~$ nova hypervisor-servers zs93k23\n+----+------+---------------+---------------------+\n| ID | Name | Hypervisor ID | Hypervisor Hostname |\n+----+------+---------------+---------------------+\n+----+------+---------------+---------------------+\n\n2) disable the hypervisor:\n(env) vance@zs95k5:~$ nova service-list\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n| Id | Binary         | Host                | Zone     | Status   | State | Updated_at                 | Disabled Reason |\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n| 3  | nova-cert      | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:13:34.000000 | -               |\n| 4  | nova-scheduler | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:13:27.000000 | -               |\n| 5  | nova-conductor | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:13:30.000000 | -               |\n| 14 | nova-compute   | u27-maas-machine-1  | nova     | disabled | up    | 2016-11-30T21:13:28.000000 | -               |\n| 16 | nova-compute   | zs95k181            | nova     | enabled  | up    | 2016-11-30T21:13:33.000000 | -               |\n| 17 | nova-compute   | zs93k23             | nova     | enabled  | up    | 2016-11-30T21:13:33.000000 | -               |\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n(env) vance@zs95k5:~$ nova service-disable zs93k23 nova-compute\n+---------+--------------+----------+\n| Host    | Binary       | Status   |\n+---------+--------------+----------+\n| zs93k23 | nova-compute | disabled |\n+---------+--------------+----------+\n\n3) delete the compute service\n(env) vance@zs95k5:~$ nova service-delete 17\n(env) vance@zs95k5:~$ nova service-list\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n| Id | Binary         | Host                | Zone     | Status   | State | Updated_at                 | Disabled Reason |\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n| 3  | nova-cert      | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:14:54.000000 | -               |\n| 4  | nova-scheduler | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:14:47.000000 | -               |\n| 5  | nova-conductor | juju-605709-2-lxd-3 | internal | enabled  | up    | 2016-11-30T21:14:56.000000 | -               |\n| 14 | nova-compute   | u27-maas-machine-1  | nova     | disabled | up    | 2016-11-30T21:14:48.000000 | -               |\n| 16 | nova-compute   | zs95k181            | nova     | enabled  | up    | 2016-11-30T21:14:53.000000 | -               |\n+----+----------------+---------------------+----------+----------+-------+----------------------------+-----------------+\n\n4) delete the neutron agent\n(env) vance@zs95k5:~$ openstack network agent list\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n| ID                                   | Agent Type         | Host               | Availability Zone | Alive | State | Binary                    |\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n| 039e4b7a-3dbe-4e87-a9a5-d4b569d3113d | Open vSwitch agent | u27-maas-machine-2 | None              | True  | UP    | neutron-openvswitch-agent |\n| 2aa13570-0e62-4198-96d9-dfe732d7874d | DHCP agent         | u27-maas-machine-2 | nova              | True  | UP    | neutron-dhcp-agent        |\n| 2ab2320a-69cb-4a7f-8ae4-541d3b2bdd3b | L3 agent           | u27-maas-machine-2 | nova              | True  | UP    | neutron-l3-agent          |\n| 48d6d83b-e459-46c8-945c-eea4197c01ec | Open vSwitch agent | zs95k181           | None              | True  | UP    | neutron-openvswitch-agent |\n| a36eecd5-1fb4-436a-becd-fccc737518fd | Metering agent     | u27-maas-machine-2 | None              | True  | UP    | neutron-metering-agent    |\n| aaee3bf0-f8bd-41b7-94ed-f9213f120016 | Open vSwitch agent | zs93k23            | None              | True  | UP    | neutron-openvswitch-agent |\n| c6039c81-ad20-4258-a926-bc4a90dccc96 | Loadbalancer agent | u27-maas-machine-2 | None              | True  | UP    | neutron-lbaas-agent       |\n| cfecc66c-2888-4c3d-8241-1d3fcd018a1f | Metadata agent     | u27-maas-machine-2 | None              | True  | UP    | neutron-metadata-agent    |\n| f60cbf28-f030-43ae-a598-0d0182529804 | Open vSwitch agent | u27-maas-machine-1 | None              | True  | UP    | neutron-openvswitch-agent |\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n(env) vance@zs95k5:~$ openstack network agent delete aaee3bf0-f8bd-41b7-94ed-f9213f120016\n(env) vance@zs95k5:~$ openstack network agent list\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n| ID                                   | Agent Type         | Host               | Availability Zone | Alive | State | Binary                    |\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n| 039e4b7a-3dbe-4e87-a9a5-d4b569d3113d | Open vSwitch agent | u27-maas-machine-2 | None              | True  | UP    | neutron-openvswitch-agent |\n| 2aa13570-0e62-4198-96d9-dfe732d7874d | DHCP agent         | u27-maas-machine-2 | nova              | True  | UP    | neutron-dhcp-agent        |\n| 2ab2320a-69cb-4a7f-8ae4-541d3b2bdd3b | L3 agent           | u27-maas-machine-2 | nova              | True  | UP    | neutron-l3-agent          |\n| 48d6d83b-e459-46c8-945c-eea4197c01ec | Open vSwitch agent | zs95k181           | None              | True  | UP    | neutron-openvswitch-agent |\n| a36eecd5-1fb4-436a-becd-fccc737518fd | Metering agent     | u27-maas-machine-2 | None              | True  | UP    | neutron-metering-agent    |\n| c6039c81-ad20-4258-a926-bc4a90dccc96 | Loadbalancer agent | u27-maas-machine-2 | None              | True  | UP    | neutron-lbaas-agent       |\n| cfecc66c-2888-4c3d-8241-1d3fcd018a1f | Metadata agent     | u27-maas-machine-2 | None              | True  | UP    | neutron-metadata-agent    |\n| f60cbf28-f030-43ae-a598-0d0182529804 | Open vSwitch agent | u27-maas-machine-1 | None              | True  | UP    | neutron-openvswitch-agent |\n+--------------------------------------+--------------------+--------------------+-------------------+-------+-------+---------------------------+\n\n5) check hypervisor list\n(env) vance@zs95k5:~$ nova hypervisor-list\nERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.ComputeHostNotFound'> (HTTP 500) (Request-ID: req-2b773323-be4f-4c8c-be05-a41144ebed76)\n\n\nOkay, here is the error from the log:\nhttp://paste.ubuntu.com/23559892/\n\n\nExpected result\n===============\nNova compute node is properly removed from the OS database.\n\n\nEnvironment\n===========\n1. OpenStack nova version 2:13.1.2-0ubuntu2\n\n2. Hypervisor:\n   Libvirt+KVM (KVM for IBM z Systems 1.1.3-beta4.3)\n\n3. Networking type: OVS+GRE", 
            "date_created": "2016-11-30 21:40:49.096645+00:00", 
            "author": "https://api.launchpad.net/1.0/~vmorris"
        }, 
        {
            "content": "Can you dump the services and compute_nodes tables from the database, does zs93k23 still show up? It might, but the deleted column should be a non-0 value.", 
            "date_created": "2016-12-04 02:40:57.357150+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Looks like it fails here:\n\nhttps://github.com/openstack/nova/blob/13.1.2/nova/api/openstack/compute/hypervisors.py#L98\n\nWhich means the service record is deleted, but the compute_node record isn't.\n\nI'm not sure what deletes the compute node record in the database. The resource tracker running in the nova-compute service itself on the host creates the compute node record, but would have to dig into what destroys it.\n\nIs the nova-compute service still running on the host because I think even if you deleted it, if the service is still running it will automatically recreate the compute node record in the update_available_resource periodic task on the compute.", 
            "date_created": "2016-12-04 02:49:46.248870+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Looks like this is where the orphaned compute node record would be deleted:\n\nhttps://github.com/openstack/nova/blob/13.1.2/nova/compute/manager.py#L6513\n\n", 
            "date_created": "2016-12-04 02:57:29.153198+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Looks like https://github.com/openstack/nova/blob/13.1.2/nova/compute/manager.py#L6513 doesn't help on remove the compute node record. It only delete the compute node which hypervisor didn't know.\n\nProbably we have same problem, when the compute is down, then user remove the service records, then still no-one can remove the compute node record.", 
            "date_created": "2016-12-04 03:28:22.500518+00:00", 
            "author": "https://api.launchpad.net/1.0/~xuhj"
        }, 
        {
            "content": "Looks like you have to delete the compute node from the database manually as we have no APIs to do it:\n\nhttp://www.thereluctanttecchie.com/openstack-removing-a-compute-node-in-icehouse/\n\nThere are several articles and support pages around similar to ^ so we need to handle that 404 in the services API code and ignore it.", 
            "date_created": "2016-12-04 04:52:24.784169+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/406627", 
            "date_created": "2016-12-04 20:11:32.421410+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/406627\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=f0d44c5b09f3f3c84038d40b621bb629a1f8110e\nSubmitter: Jenkins\nBranch:    master\n\ncommit f0d44c5b09f3f3c84038d40b621bb629a1f8110e\nAuthor: Matt Riedemann <email address hidden>\nDate:   Sun Dec 4 15:08:04 2016 -0500\n\n    Handle ComputeHostNotFound when listing hypervisors\n    \n    Compute node resources must currently be deleted manually\n    in the database, and as such they can reference service\n    records which have been deleted via the services delete API.\n    Because of this when listing hypervisors (compute nodes), we\n    may get a ComputeHostNotFound error when trying to lookup a\n    service record for a compute node where the service was\n    deleted. This causes the API to fail with a 500 since it's not\n    handled.\n    \n    This change handles the ComputeHostNotFound when looping over\n    compute nodes in the hypervisors index and detail methods and\n    simply ignores them.\n    \n    Change-Id: I2717274bb1bd370870acbf58c03dc59cee30cc5e\n    Closes-Bug: #1646255\n", 
            "date_created": "2016-12-07 07:46:28.713992+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/407961", 
            "date_created": "2016-12-07 09:26:14.410222+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/407961\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=5931f555568eb52235dd28bb520f354d884b7ea4\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 5931f555568eb52235dd28bb520f354d884b7ea4\nAuthor: Matt Riedemann <email address hidden>\nDate:   Sun Dec 4 15:08:04 2016 -0500\n\n    Handle ComputeHostNotFound when listing hypervisors\n    \n    Compute node resources must currently be deleted manually\n    in the database, and as such they can reference service\n    records which have been deleted via the services delete API.\n    Because of this when listing hypervisors (compute nodes), we\n    may get a ComputeHostNotFound error when trying to lookup a\n    service record for a compute node where the service was\n    deleted. This causes the API to fail with a 500 since it's not\n    handled.\n    \n    This change handles the ComputeHostNotFound when looping over\n    compute nodes in the hypervisors index and detail methods and\n    simply ignores them.\n    \n    Change-Id: I2717274bb1bd370870acbf58c03dc59cee30cc5e\n    Closes-Bug: #1646255\n    (cherry picked from commit f0d44c5b09f3f3c84038d40b621bb629a1f8110e)\n", 
            "date_created": "2016-12-12 13:41:31.634955+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b2 development milestone.", 
            "date_created": "2016-12-15 17:34:39.323727+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.3 release.", 
            "date_created": "2016-12-19 12:01:57.862614+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-12-07 07:46:25.404442+00:00"
}