{
    "status": "Fix Released", 
    "last_updated": "2017-06-08 21:51:48.314297+00:00", 
    "description": "Description\n===========\n\nWhen create server API fails because of no valid host, the instance's status remains in BUILD status and \"scheduling\" task state.  Additionally, users can't delete the instance by delete server API.\n\n\nSteps to reproduce\n==================\n\n1. create devstack with default configs\n2. boot instances until nova scheduler says \"no valid host was found\"\n3. check the error instance's status, then its status remains in \"BUILD\" and its task state remains in \"scheduling\".\n4. check nova-conductor's log, then it has a following error\n5. I can't delete the failed instance by delete instance API\n\nExpected result\n===============\n\nthe instance goes ERROR status and none task state because of \"no valid host was found\". And I can delete the instance by delete instance API.\n\nEnvironment\n===========\n\n- git log\nMerge: bedcf29 3838d5e\nAuthor: Jenkins <email address hidden>\nDate:   Thu May 25 01:15:41 2017 +0000\n\n    Merge \"Handle uuid in HostAPI._find_service\"\n\n\n- hypervisor: KVM\n\n\nLogs & Configs\n==============\n\n- nova-conductor's log:\n\nnova-conductor[28120]: NoValidHost: No valid host was found. There are not enough hosts available.\nnova-conductor[28120]: \nnova-conductor[28120]: WARNING nova.scheduler.utils [req-7969ec7f-795d-420d-b847-b5c3c6bc8489 admin admin] [instance: e5e9cfe9-49ec-40a4-b763-d8bda68d5e56] Setting instance to ERROR state.\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server [req-7969ec7f-795d-420d-b847-b5c3c6bc8489 admin admin] Exception during message handling\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server Traceback (most recent call last):\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 157, in _process_incoming\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     res = self.dispatcher.dispatch(message)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 213, in dispatch\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     return self._do_dispatch(endpoint, method, ctxt, args)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 183, in _do_dispatch\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     result = func(ctxt, **new_args)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     build_requests=build_requests)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/conductor/manager.py\", line 893, in _bury_in_cell0\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     exc, legacy_spec)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/conductor/manager.py\", line 355, in _set_vm_state_and_notify\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     ex, request_spec)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/scheduler/utils.py\", line 104, in set_vm_state_and_notify\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     instance.save()\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 226, in wrapper\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     return fn(self, *args, **kwargs)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/objects/instance.py\", line 781, in save\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     columns_to_join=_expected_cols(expected_attrs))\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/db/api.py\", line 860, in instance_update_and_get_original\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     expected=expected)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/db/sqlalchemy/api.py\", line 180, in wrapper\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     return f(*args, **kwargs)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/api.py\", line 150, in wrapper\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     ectxt.value = e.inner_exc\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     self.force_reraise()\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/api.py\", line 138, in wrapper\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     return f(*args, **kwargs)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/db/sqlalchemy/api.py\", line 251, in wrapped\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     return f(context, *args, **kwargs)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/db/sqlalchemy/api.py\", line 2673, in instance_update_and_get_original\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     columns_to_join=columns_to_join)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/db/sqlalchemy/api.py\", line 1929, in _instance_get_by_uuid\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     raise exception.InstanceNotFound(instance_id=uuid)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server InstanceNotFound: Instance e5e9cfe9-49ec-40a4-b763-d8bda68d5e56 could not be found.\n\n- inspections for the bug\n    * nova_api db has the failed instance info in its db, but it's cell_id is NULL\n\nmysql> select instance_uuid, cell_id from instance_mappings;\n+--------------------------------------+---------+\n| instance_uuid                        | cell_id |\n+--------------------------------------+---------+\n| 86be67fc-86db-4153-b142-2cdd77874e9a |       2 |\n| db4f56bc-5069-4f0a-9fdc-f23e7fdb613d |       2 |\n| 072e6db4-9ccd-4da3-935e-15e16f300cc7 |       2 |\n| f4d577a7-4c3f-4c03-a875-6d3c1d3441e4 |    NULL |\n| 9720785e-210e-4607-a16c-58250d092efc |    NULL |\n| 8ced7975-b234-463e-86aa-bd30632812f7 |    NULL |\n| 5b675dff-d588-491b-8d13-9f0d95aec131 |       2 |\n| 3785265d-b05e-47f6-9ff5-5f2300cb9a1f |    NULL |\n| 50dafdb8-dbd4-4d09-a5b4-cb604c1c28e9 |       2 |\n| 901d03fb-a079-4707-a50c-8a9ea12f3347 |    NULL |\n| b3ddeeb4-d5a5-4fd6-b847-b5bb49d4f984 |    NULL |\n| 78439d4c-65cd-432b-9d43-835d583529b7 |       2 |\n| e5e9cfe9-49ec-40a4-b763-d8bda68d5e56 |    NULL |\n+--------------------------------------+---------+\n\nmysql> select id,uuid,name from cell_mappings;\n+----+--------------------------------------+-------+\n| id | uuid                                 | name  |\n+----+--------------------------------------+-------+\n|  1 | 00000000-0000-0000-0000-000000000000 | cell0 |\n|  2 | 60d185ff-8de0-4b9a-8832-494d71c3f895 | cell1 |\n+----+--------------------------------------+-------+\n\n\n    * all rows in nova_cell0's instances table remain building and scheduling\n\nmysql> select id, uuid, vm_state, task_state from instances;\n+----+--------------------------------------+----------+------------+\n| id | uuid                                 | vm_state | task_state |\n+----+--------------------------------------+----------+------------+\n|  1 | 8ced7975-b234-463e-86aa-bd30632812f7 | building | scheduling |\n|  2 | 3785265d-b05e-47f6-9ff5-5f2300cb9a1f | building | scheduling |\n|  3 | 901d03fb-a079-4707-a50c-8a9ea12f3347 | building | scheduling |\n|  4 | b3ddeeb4-d5a5-4fd6-b847-b5bb49d4f984 | building | scheduling |\n|  5 | e5e9cfe9-49ec-40a4-b763-d8bda68d5e56 | building | scheduling |\n+----+--------------------------------------+----------+------------+", 
    "tags": [
        "cellsv2"
    ], 
    "importance": "Critical", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1693438", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1693438, 
    "index": 289, 
    "openned": "2017-05-25 07:38:40.715148+00:00", 
    "created": "2017-05-25 07:38:40.715148+00:00", 
    "title": "error instances remain in 'Build' status and can't delete it", 
    "comments": [
        {
            "content": "Description\n===========\n\nWhen create server API fails because of no valid host, the instance's status remains in BUILD status and \"scheduling\" task state.  Additionally, users can't delete the instance by delete server API.\n\n\nSteps to reproduce\n==================\n\n1. create devstack with default configs\n2. boot instances until nova scheduler says \"no valid host was found\"\n3. check the error instance's status, then its status remains in \"BUILD\" and its task state remains in \"scheduling\".\n4. check nova-conductor's log, then it has a following error\n5. I can't delete the failed instance by delete instance API\n\nExpected result\n===============\n\nthe instance goes ERROR status and none task state because of \"no valid host was found\". And I can delete the instance by delete instance API.\n\nEnvironment\n===========\n\n- git log\nMerge: bedcf29 3838d5e\nAuthor: Jenkins <email address hidden>\nDate:   Thu May 25 01:15:41 2017 +0000\n\n    Merge \"Handle uuid in HostAPI._find_service\"\n\n\n- hypervisor: KVM\n\n\nLogs & Configs\n==============\n\n- nova-conductor's log:\n\nnova-conductor[28120]: NoValidHost: No valid host was found. There are not enough hosts available.\nnova-conductor[28120]: \nnova-conductor[28120]: WARNING nova.scheduler.utils [req-7969ec7f-795d-420d-b847-b5c3c6bc8489 admin admin] [instance: e5e9cfe9-49ec-40a4-b763-d8bda68d5e56] Setting instance to ERROR state.\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server [req-7969ec7f-795d-420d-b847-b5c3c6bc8489 admin admin] Exception during message handling\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server Traceback (most recent call last):\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 157, in _process_incoming\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     res = self.dispatcher.dispatch(message)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 213, in dispatch\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     return self._do_dispatch(endpoint, method, ctxt, args)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 183, in _do_dispatch\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     result = func(ctxt, **new_args)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     build_requests=build_requests)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/conductor/manager.py\", line 893, in _bury_in_cell0\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     exc, legacy_spec)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/conductor/manager.py\", line 355, in _set_vm_state_and_notify\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     ex, request_spec)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/scheduler/utils.py\", line 104, in set_vm_state_and_notify\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     instance.save()\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 226, in wrapper\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     return fn(self, *args, **kwargs)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/objects/instance.py\", line 781, in save\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     columns_to_join=_expected_cols(expected_attrs))\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/db/api.py\", line 860, in instance_update_and_get_original\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     expected=expected)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/db/sqlalchemy/api.py\", line 180, in wrapper\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     return f(*args, **kwargs)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/api.py\", line 150, in wrapper\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     ectxt.value = e.inner_exc\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     self.force_reraise()\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/api.py\", line 138, in wrapper\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     return f(*args, **kwargs)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/db/sqlalchemy/api.py\", line 251, in wrapped\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     return f(context, *args, **kwargs)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/db/sqlalchemy/api.py\", line 2673, in instance_update_and_get_original\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     columns_to_join=columns_to_join)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server   File \"/devstack/devstack_data/nova/nova/db/sqlalchemy/api.py\", line 1929, in _instance_get_by_uuid\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server     raise exception.InstanceNotFound(instance_id=uuid)\nnova-conductor[28120]: ERROR oslo_messaging.rpc.server InstanceNotFound: Instance e5e9cfe9-49ec-40a4-b763-d8bda68d5e56 could not be found.\n\n- inspections for the bug\n    * nova_api db has the failed instance info in its db, but it's cell_id is NULL\n\nmysql> select instance_uuid, cell_id from instance_mappings;\n+--------------------------------------+---------+\n| instance_uuid                        | cell_id |\n+--------------------------------------+---------+\n| 86be67fc-86db-4153-b142-2cdd77874e9a |       2 |\n| db4f56bc-5069-4f0a-9fdc-f23e7fdb613d |       2 |\n| 072e6db4-9ccd-4da3-935e-15e16f300cc7 |       2 |\n| f4d577a7-4c3f-4c03-a875-6d3c1d3441e4 |    NULL |\n| 9720785e-210e-4607-a16c-58250d092efc |    NULL |\n| 8ced7975-b234-463e-86aa-bd30632812f7 |    NULL |\n| 5b675dff-d588-491b-8d13-9f0d95aec131 |       2 |\n| 3785265d-b05e-47f6-9ff5-5f2300cb9a1f |    NULL |\n| 50dafdb8-dbd4-4d09-a5b4-cb604c1c28e9 |       2 |\n| 901d03fb-a079-4707-a50c-8a9ea12f3347 |    NULL |\n| b3ddeeb4-d5a5-4fd6-b847-b5bb49d4f984 |    NULL |\n| 78439d4c-65cd-432b-9d43-835d583529b7 |       2 |\n| e5e9cfe9-49ec-40a4-b763-d8bda68d5e56 |    NULL |\n+--------------------------------------+---------+\n\nmysql> select id,uuid,name from cell_mappings;\n+----+--------------------------------------+-------+\n| id | uuid                                 | name  |\n+----+--------------------------------------+-------+\n|  1 | 00000000-0000-0000-0000-000000000000 | cell0 |\n|  2 | 60d185ff-8de0-4b9a-8832-494d71c3f895 | cell1 |\n+----+--------------------------------------+-------+\n\n\n    * all rows in nova_cell0's instances table remain building and scheduling\n\nmysql> select id, uuid, vm_state, task_state from instances;\n+----+--------------------------------------+----------+------------+\n| id | uuid                                 | vm_state | task_state |\n+----+--------------------------------------+----------+------------+\n|  1 | 8ced7975-b234-463e-86aa-bd30632812f7 | building | scheduling |\n|  2 | 3785265d-b05e-47f6-9ff5-5f2300cb9a1f | building | scheduling |\n|  3 | 901d03fb-a079-4707-a50c-8a9ea12f3347 | building | scheduling |\n|  4 | b3ddeeb4-d5a5-4fd6-b847-b5bb49d4f984 | building | scheduling |\n|  5 | e5e9cfe9-49ec-40a4-b763-d8bda68d5e56 | building | scheduling |\n+----+--------------------------------------+----------+------------+", 
            "date_created": "2017-05-25 07:38:40.715148+00:00", 
            "author": "https://api.launchpad.net/1.0/~muroi-masahito"
        }, 
        {
            "content": "Trove CI is failing for the same reason:\n\nhttp://logs.openstack.org/47/467447/14/check/gate-trove-scenario-dsvm-mariadb-multi-ubuntu-xenial-nv/6efec50/logs/screen-n-cond.txt.gz#_May_26_03_24_31_157974\n\nSorry to take this bug over but I noticed the bug report after I pushed the patch.", 
            "date_created": "2017-05-26 12:35:55.294905+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Patch is here: https://review.openstack.org/#/c/468401/", 
            "date_created": "2017-05-26 15:07:53.260101+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/468401\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=5fac17ae960d36eeb7a642725a37f82e8ca95ec1\nSubmitter: Jenkins\nBranch:    master\n\ncommit 5fac17ae960d36eeb7a642725a37f82e8ca95ec1\nAuthor: Matt Riedemann <email address hidden>\nDate:   Fri May 26 08:27:07 2017 -0400\n\n    Use targeted context when burying instances in cell0\n    \n    After Iccdf6b80f5fc8adcc8a89ce6ece3f37b6cbcaee2 we need to\n    use the yielded context which is targeted to the cell when\n    we do DB operations, which in this case is creating the\n    instance in the cell0 database and then updating it's status.\n    \n    There is another place in here where this was missed, which is\n    when we're trying to delete a build request which was already\n    deleted.\n    \n    Closes-Bug: #1693438\n    \n    Change-Id: I142f97d691fa55e9824714c9c224f998ad72337e\n", 
            "date_created": "2017-05-28 23:41:41.034724+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b2 development milestone.", 
            "date_created": "2017-06-08 21:51:47.580022+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-05-28 23:41:38.271675+00:00"
}