{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:59:42.082141+00:00", 
    "description": "I'm testing creating, attaching, detaching and removing of iSCSI volumes at the moment (5 seconds pause after each action).\n\nAfter running the test for one hour I've some iSCSI volumes left. The couldn't be remove because \"Device or resource busy.\" while running \"ietadm --op delete --tid=20\". \n\nMaybe the pause of 5 seconds after each action is too short, but I think nova-volume should handle the case that a call to ietadm fails and should retry it 5 times or so. I tried to manually remove the targets after stopping the test and that's working.\n\n---snip---\n2011-02-25 23:08:16,547 DEBUG nova.volume.manager [-] volume volume-00000453: removing export from (pid=26259) delete_volume /usr/lib64/python2.6/site-packages/nova/volume/manager.py:140\n2011-02-25 23:08:16,549 DEBUG nova.utils [-] Running cmd (subprocess): sudo ietadm --op show --tid=20  from (pid=26259) execute /usr/lib64/python2.6/site-packages/nova/utils.py:132\n2011-02-25 23:08:16,570 DEBUG nova.utils [-] Running cmd (subprocess): sudo ietadm --op delete --tid=20 --lun=0 from (pid=26259) execute /usr/lib64/python2.6/site-packages/nova/utils.py:132\n2011-02-25 23:08:16,591 DEBUG nova.utils [-] Running cmd (subprocess): sudo ietadm --op delete --tid=20 from (pid=26259) execute /usr/lib64/python2.6/site-packages/nova/utils.py:132\n2011-02-25 23:08:16,612 DEBUG nova.utils [-] Result was 240 from (pid=26259) execute /usr/lib64/python2.6/site-packages/nova/utils.py:145\n2011-02-25 23:08:16,628 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 199, in _receive\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/volume/manager.py\", line 141, in delete_volume\n(nova): TRACE:     self.driver.remove_export(context, volume_ref)\n(nova): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/volume/driver.py\", line 311, in remove_export\n(nova): TRACE:     iscsi_target)\n(nova): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/utils.py\", line 151, in execute\n(nova): TRACE:     cmd=cmd)\n(nova): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova): TRACE: Command: sudo ietadm --op delete --tid=20\n(nova): TRACE: Exit code: 240\n(nova): TRACE: Stdout: ''\n(nova): TRACE: Stderr: 'Device or resource busy.\\n'\n(nova): TRACE:\n---snap---\n\n---snip---\nVOLUME  vol-00000453     1              nova    error_deleting (berendt, deimos, None, None)    2011-02-25T22:08:00Z\n---snap---\n\n---snip---\nchronos:~ # euca-delete-volume vol-00000453\nUnknown: Unknown: Volume status must be available\n---snap---", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/725328", 
    "owner": "https://api.launchpad.net/1.0/~zyluo", 
    "id": 725328, 
    "index": 2298, 
    "openned": "2011-02-25 22:59:39.496897+00:00", 
    "created": "2011-02-25 22:59:39.496897+00:00", 
    "title": "removing of iSCSI volumes failed because 'Device or resource busy.'", 
    "comments": [
        {
            "content": "I'm testing creating, attaching, detaching and removing of iSCSI volumes at the moment (5 seconds pause after each action).\n\nAfter running the test for one hour I've some iSCSI volumes left. The couldn't be remove because \"Device or resource busy.\" while running \"ietadm --op delete --tid=20\". \n\nMaybe the pause of 5 seconds after each action is too short, but I think nova-volume should handle the case that a call to ietadm fails and should retry it 5 times or so. I tried to manually remove the targets after stopping the test and that's working.\n\n---snip---\n2011-02-25 23:08:16,547 DEBUG nova.volume.manager [-] volume volume-00000453: removing export from (pid=26259) delete_volume /usr/lib64/python2.6/site-packages/nova/volume/manager.py:140\n2011-02-25 23:08:16,549 DEBUG nova.utils [-] Running cmd (subprocess): sudo ietadm --op show --tid=20  from (pid=26259) execute /usr/lib64/python2.6/site-packages/nova/utils.py:132\n2011-02-25 23:08:16,570 DEBUG nova.utils [-] Running cmd (subprocess): sudo ietadm --op delete --tid=20 --lun=0 from (pid=26259) execute /usr/lib64/python2.6/site-packages/nova/utils.py:132\n2011-02-25 23:08:16,591 DEBUG nova.utils [-] Running cmd (subprocess): sudo ietadm --op delete --tid=20 from (pid=26259) execute /usr/lib64/python2.6/site-packages/nova/utils.py:132\n2011-02-25 23:08:16,612 DEBUG nova.utils [-] Result was 240 from (pid=26259) execute /usr/lib64/python2.6/site-packages/nova/utils.py:145\n2011-02-25 23:08:16,628 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/rpc.py\", line 199, in _receive\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/volume/manager.py\", line 141, in delete_volume\n(nova): TRACE:     self.driver.remove_export(context, volume_ref)\n(nova): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/volume/driver.py\", line 311, in remove_export\n(nova): TRACE:     iscsi_target)\n(nova): TRACE:   File \"/usr/lib64/python2.6/site-packages/nova/utils.py\", line 151, in execute\n(nova): TRACE:     cmd=cmd)\n(nova): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova): TRACE: Command: sudo ietadm --op delete --tid=20\n(nova): TRACE: Exit code: 240\n(nova): TRACE: Stdout: ''\n(nova): TRACE: Stderr: 'Device or resource busy.\\n'\n(nova): TRACE:\n---snap---\n\n---snip---\nVOLUME  vol-00000453     1              nova    error_deleting (berendt, deimos, None, None)    2011-02-25T22:08:00Z\n---snap---\n\n---snip---\nchronos:~ # euca-delete-volume vol-00000453\nUnknown: Unknown: Volume status must be available\n---snap---", 
            "date_created": "2011-02-25 22:59:39.496897+00:00", 
            "author": "https://api.launchpad.net/1.0/~berendt"
        }, 
        {
            "content": "I tested creation and deletion several times with the following script and got no issues. So it's probably a problem with the detaching of a volume.\n\n---snip---\n#!/bin/sh\n\nfor i in $(seq 1 30); do\n  euca-create-volume -s 1 -z nova\ndone\n\nsleep 30\n\nfor i in $(euca-describe-volumes | cut -f 2); do\n  euca-delete-volume $i\ndone\n---snap---", 
            "date_created": "2011-02-25 23:19:25.962365+00:00", 
            "author": "https://api.launchpad.net/1.0/~berendt"
        }, 
        {
            "content": "Perhaps libvirt isn't actually done with the volume when it returns from detach.  We should probably put a delay in there unless we can figure out a way to loop until the volume is actually clear (check lsof in a loop?)", 
            "date_created": "2011-02-25 23:33:35.279368+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "This bug was fix on the commit below:\nhttps://github.com/openstack/nova/commit/a135c8ecd16bb6a97743e4be1b060daff874879e#nova/virt/libvirt/volume.py", 
            "date_created": "2011-12-27 02:00:17.558732+00:00", 
            "author": "https://api.launchpad.net/1.0/~zyluo"
        }
    ], 
    "closed": "2012-01-25 09:53:41.831119+00:00"
}