{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:34:22.268081+00:00", 
    "description": "This commit:\n\n---\ncommit 17bca438954638d74035d560e826a26a532b3ea3\nAuthor: Joe Gordon <email address hidden>\nDate:   Wed Mar 13 16:58:13 2013 -0700\n\n    Delete InstanceSystemMetadata on instance deletion\n\n    Thanks to no-db-compute only pre-delete instance data is used in\n    notifications. So now we can go back to deleting InstanceSystemMetadata\n    when an instance is deleted.\n\n    Fixes bug 1153827\n\n    Change-Id: Ic66b998cde2a15a24f302f08c34753a8b57da73d\n---\n\nChanged things so that we delete the instance_system_metadata entries for an instance when instance_destroy() is called.  However, the commit message turns out to be wrong, from what I can tell.  There's 2 cases that need access to instance_type data that's stored in sys_meta AFTER an instance is deleted:\n\n1) The API.  If you specify 'changes-since', the API will return deleted instances.  The instance_type data needs to be extracted in order to form the API response\n2) _usage_audit_log() task in compute manager.  This task potentially queries for deleted instances in the past day to send audit information for them nightly.\n\nI don't have a traceback for #1 handy, but:\n\nTraceback for #2:\n\nTraceback (most recent call last):\n  File \"/meow/nova/compute/manager.py\", line 3813, in _instance_usage_audit\n        include_bandwidth=True\n  File \"/meow/nova/conductor/api.py\", line 308, in notify_usage_exists\n    system_metadata, extra_usage_info, include_bandwidth)\n  File \"/meow/nova/utils.py\", line 1089, in wrapper\n    return func(*args, **kwargs)\n  File \"/meow/nova/conductor/manager.py\", line 405, in notify_usage_exists\n        include_bandwidth)  File \"/meow/nova/compute/utils.py\", line 224, in notify_usage_exists\n    system_metadata=system_metadata, extra_usage_info=extra_info)\n  File \"/meow/nova/compute/utils.py\", line 250, in notify_about_instance_usage\n    network_info, system_metadata, **extra_usage_info)\n  File \"/meow/nova/notifications.py\", line 287, in info_from_instance\n        instance_type = flavors.extract_instance_type(instance_ref)\n  File \"/meow/nova/compute/flavors.py\", line 247, in extract_instance_type\n    instance_type[key] = type_fn(sys_meta[type_key])\nKeyError: 'instance_type_memory_mb'", 
    "tags": [
        "db"
    ], 
    "importance": "Critical", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1185190", 
    "owner": "https://api.launchpad.net/1.0/~cbehrens", 
    "id": 1185190, 
    "index": 140, 
    "openned": "2013-05-28 22:27:08.445276+00:00", 
    "created": "2013-05-28 22:27:08.445276+00:00", 
    "title": "instance_type data cannot be extracted from sys_meta after instance deleted", 
    "comments": [
        {
            "content": "This commit:\n\n---\ncommit 17bca438954638d74035d560e826a26a532b3ea3\nAuthor: Joe Gordon <email address hidden>\nDate:   Wed Mar 13 16:58:13 2013 -0700\n\n    Delete InstanceSystemMetadata on instance deletion\n\n    Thanks to no-db-compute only pre-delete instance data is used in\n    notifications. So now we can go back to deleting InstanceSystemMetadata\n    when an instance is deleted.\n\n    Fixes bug 1153827\n\n    Change-Id: Ic66b998cde2a15a24f302f08c34753a8b57da73d\n---\n\nChanged things so that we delete the instance_system_metadata entries for an instance when instance_destroy() is called.  However, the commit message turns out to be wrong, from what I can tell.  There's 2 cases that need access to instance_type data that's stored in sys_meta AFTER an instance is deleted:\n\n1) The API.  If you specify 'changes-since', the API will return deleted instances.  The instance_type data needs to be extracted in order to form the API response\n2) _usage_audit_log() task in compute manager.  This task potentially queries for deleted instances in the past day to send audit information for them nightly.\n\nI don't have a traceback for #1 handy, but:\n\nTraceback for #2:\n\nTraceback (most recent call last):\n  File \"/meow/nova/compute/manager.py\", line 3813, in _instance_usage_audit\n        include_bandwidth=True\n  File \"/meow/nova/conductor/api.py\", line 308, in notify_usage_exists\n    system_metadata, extra_usage_info, include_bandwidth)\n  File \"/meow/nova/utils.py\", line 1089, in wrapper\n    return func(*args, **kwargs)\n  File \"/meow/nova/conductor/manager.py\", line 405, in notify_usage_exists\n        include_bandwidth)  File \"/meow/nova/compute/utils.py\", line 224, in notify_usage_exists\n    system_metadata=system_metadata, extra_usage_info=extra_info)\n  File \"/meow/nova/compute/utils.py\", line 250, in notify_about_instance_usage\n    network_info, system_metadata, **extra_usage_info)\n  File \"/meow/nova/notifications.py\", line 287, in info_from_instance\n        instance_type = flavors.extract_instance_type(instance_ref)\n  File \"/meow/nova/compute/flavors.py\", line 247, in extract_instance_type\n    instance_type[key] = type_fn(sys_meta[type_key])\nKeyError: 'instance_type_memory_mb'", 
            "date_created": "2013-05-28 22:27:08.445276+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "Pushing back to H2, please set back to H1 if this is milestone-critical (in which case the fix needs to land in master first and then be backported to milestone-proposed before tomorrow)", 
            "date_created": "2013-05-29 08:38:06.735713+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/30894\nCommitted: http://github.com/openstack/nova/commit/4885aa28706a1858f4fc51a0d2c661eec05139c0\nSubmitter: Jenkins\nBranch:    master\n\ncommit 4885aa28706a1858f4fc51a0d2c661eec05139c0\nAuthor: Chris Behrens <email address hidden>\nDate:   Wed May 29 14:21:00 2013 +0000\n\n    Don't delete sys_meta on instance delete\n    \n    Unfortunately, we require to access instance_system_metadata to get\n    data (specifically at least instance_type data) for instances that have\n    been deleted.\n    \n    There's 2 cases where this is true:\n    \n    1) nova-api supports showing deleting instances when you specify a\n    'changes-since' param.\n    2) The _usage_audit_log periodic task pulls all instances during the\n    audit period, which includes instances that have been deleted during\n    that period.\n    \n    This reverts commit 17bca438954638d74035d560e826a26a532b3ea3, which was\n    attempting to fix a bug where we leave instance_system_metadata entries\n    undeleted from the DB.  There's not an easy way to query for the deleted\n    sys_meta data in an efficient manner, and leaving the entries undeleted is\n    the lesser of the 2 evils for now.\n    \n    Fixes bug 1185190\n    \n    Change-Id: I898f0546c49126dcc56a4237120082f95dc82304\n", 
            "date_created": "2013-05-29 16:09:20.730630+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: milestone-proposed\nReview: https://review.openstack.org/30954", 
            "date_created": "2013-05-29 21:48:53.172001+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/30954\nCommitted: http://github.com/openstack/nova/commit/04d9fb406783ba5934d9cb249550a92202555bc7\nSubmitter: Jenkins\nBranch:    milestone-proposed\n\ncommit 04d9fb406783ba5934d9cb249550a92202555bc7\nAuthor: Chris Behrens <email address hidden>\nDate:   Wed May 29 14:21:00 2013 +0000\n\n    Don't delete sys_meta on instance delete\n    \n    Unfortunately, we require to access instance_system_metadata to get\n    data (specifically at least instance_type data) for instances that have\n    been deleted.\n    \n    There's 2 cases where this is true:\n    \n    1) nova-api supports showing deleting instances when you specify a\n    'changes-since' param.\n    2) The _usage_audit_log periodic task pulls all instances during the\n    audit period, which includes instances that have been deleted during\n    that period.\n    \n    This reverts commit 17bca438954638d74035d560e826a26a532b3ea3, which was\n    attempting to fix a bug where we leave instance_system_metadata entries\n    undeleted from the DB.  There's not an easy way to query for the deleted\n    sys_meta data in an efficient manner, and leaving the entries undeleted is\n    the lesser of the 2 evils for now.\n    \n    Fixes bug 1185190\n    \n    Change-Id: I898f0546c49126dcc56a4237120082f95dc82304\n    (cherry picked from commit 4885aa28706a1858f4fc51a0d2c661eec05139c0)\n", 
            "date_created": "2013-05-30 09:08:50.792711+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/grizzly\nReview: https://review.openstack.org/31244", 
            "date_created": "2013-05-31 16:53:30.861917+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/31244\nCommitted: http://github.com/openstack/nova/commit/8c136a8ee4733d8d3af61406fc9eeccb4e9b7a68\nSubmitter: Jenkins\nBranch:    stable/grizzly\n\ncommit 8c136a8ee4733d8d3af61406fc9eeccb4e9b7a68\nAuthor: Chris Behrens <email address hidden>\nDate:   Wed May 29 14:21:00 2013 +0000\n\n    Don't delete sys_meta on instance delete\n    \n    Unfortunately, we require to access instance_system_metadata to get\n    data (specifically at least instance_type data) for instances that have\n    been deleted.\n    \n    There's 2 cases where this is true:\n    \n    1) nova-api supports showing deleting instances when you specify a\n    'changes-since' param.\n    2) The _usage_audit_log periodic task pulls all instances during the\n    audit period, which includes instances that have been deleted during\n    that period.\n    \n    This reverts commit 17bca438954638d74035d560e826a26a532b3ea3, which was\n    attempting to fix a bug where we leave instance_system_metadata entries\n    undeleted from the DB.  There's not an easy way to query for the deleted\n    sys_meta data in an efficient manner, and leaving the entries undeleted is\n    the lesser of the 2 evils for now.\n    \n    Fixes bug 1185190\n    \n    Change-Id: I898f0546c49126dcc56a4237120082f95dc82304\n    (cherry picked from commit 4885aa28706a1858f4fc51a0d2c661eec05139c0)\n", 
            "date_created": "2013-06-05 08:20:37.800932+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-05-30 09:08:48.242906+00:00"
}