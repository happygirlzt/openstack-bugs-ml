{
    "status": "Expired", 
    "last_updated": "2017-03-01 12:27:47.092588+00:00", 
    "description": "We are running openstack mitaka out of clean installation (no upgrade).\nAll was functioning correctly until recently nova started to perform updates like this\n\n2016-11-23 10:48:09.065 17498 INFO nova.service [req-c91ec40f-2dc2 - - - - -] Updating service version for nova-conductor on nova-tlc01.specs.de from 15 to 9\n\nThe full error log from /var/log/nova/nova-conductor.log looks like\n\n2016-11-23 10:48:08.967 17499 INFO nova.service [-] Starting conductor node (version 13.1.2)\n2016-11-23 10:48:09.065 17498 INFO nova.service [req-c91ec40f-2dc2- - - - - -] Updating service version for nova-conductor on nova-tlc01.specs.de from 15 to 9\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service [req-c91ec40f-2dc2-4ab0-ad61-1ab1f9d7bbc9 - - - - -] Error starting thread.\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service Traceback (most recent call last):\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/oslo_service/service.py\", line 680, in run_service\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     service.start()\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 195, in start\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     _update_service_ref(self.service_ref)\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 151, in _update_service_ref\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     service.save()\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 223, in wrapper\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     return fn(self, *args, **kwargs)\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/objects/service.py\", line 291, in save\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     self._check_minimum_version()\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/objects/service.py\", line 275, in _check_minimum_version\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     minver=minver)\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service ServiceTooOld: This service is older (v9) than the minimum (v15) version of the rest of the deployment. Unable to continue.\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service\n\nI checked the changes in recent versions of nova/service.py\nhttps://fossies.org/diffs/nova/13.1.1_vs_13.1.2/nova/service.py-diff.html", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1644186", 
    "owner": "None", 
    "id": 1644186, 
    "index": 7818, 
    "openned": "2016-11-23 10:40:00.300993+00:00", 
    "created": "2016-11-23 10:40:00.300993+00:00", 
    "title": "nova service performs wrong update from version 15 to 9", 
    "comments": [
        {
            "content": "We are running openstack mitaka out of clean installation (no upgrade).\nAll was functioning correctly until recently nova started to perform updates like this \n\n2016-11-23 10:48:09.065 17498 INFO nova.service [req-c91ec40f-2dc2 - - - - -] Updating service version for nova-conductor on nova-tlc01.specs.de from 15 to 9\n\nThe full error log from /var/log/nova/nova-conductor.log is looks like \n\n2016-11-23 10:48:08.967 17499 INFO nova.service [-] Starting conductor node (version 13.1.2)\n2016-11-23 10:48:09.065 17498 INFO nova.service [req-c91ec40f-2dc2- - - - - -] Updating service version for nova-conductor on nova-tlc01.specs.de from 15 to 9\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service [req-c91ec40f-2dc2-4ab0-ad61-1ab1f9d7bbc9 - - - - -] Error starting thread.\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service Traceback (most recent call last):\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/oslo_service/service.py\", line 680, in run_service\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     service.start()\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 195, in start\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     _update_service_ref(self.service_ref)\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 151, in _update_service_ref\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     service.save()\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 223, in wrapper\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     return fn(self, *args, **kwargs)\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/objects/service.py\", line 291, in save\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     self._check_minimum_version()\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/objects/service.py\", line 275, in _check_minimum_version\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service     minver=minver)\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service ServiceTooOld: This service is older (v9) than the minimum (v15) version of the rest of the deployment. Unable to continue.\n2016-11-23 10:48:09.068 17498 ERROR oslo_service.service \n\nI checked the changes in recent versions of nova/service.py\nhttps://fossies.org/diffs/nova/13.1.1_vs_13.1.2/nova/service.py-diff.html\n\nNot sure, but looks like the problem is in this function under nova/service.py\n\ndef _update_service_ref(service):\n    if service.version != service_obj.SERVICE_VERSION:\n        LOG.info(_LI('Updating service version for %(binary)s on '\n                     '%(host)s from %(old)i to %(new)i'),\n                 {'binary': service.binary,\n                  'host': service.host,\n                  'old': service.version,\n                  'new': service_obj.SERVICE_VERSION})\n        service.version = service_obj.SERVICE_VERSION\n        service.save()", 
            "date_created": "2016-11-23 10:40:00.300993+00:00", 
            "author": "https://api.launchpad.net/1.0/~levong"
        }, 
        {
            "content": "What this means is that you are not running mitaka code everywhere. At least one service was upgraded to newton (where version 15 was introduced), it updated its service record, and then may or may not have been downgraded back. At that point, if you stop all the mitaka services, you end up with the newest service in the deployment at 15, which may then start doing things assuming no version 9 services will ever come back, which is why the version 9 services refuse to start.\n\nSo, if I were you, I would try tweaking the service records (in the services table) back to version 9 and then start all your services again (ensuring they are all on mitaka) and hope for the best. That, or upgrade to newton.", 
            "date_created": "2016-12-07 20:17:20.404240+00:00", 
            "author": "https://api.launchpad.net/1.0/~danms"
        }, 
        {
            "content": "Thanks Dan for the detailed reply. \nWill check out all the version installed and let you know if this was the case.\n", 
            "date_created": "2016-12-08 19:14:42.953483+00:00", 
            "author": "https://api.launchpad.net/1.0/~levong"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2017-02-07 04:17:31.098004+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }, 
        {
            "content": "Not a bug. Had some after mistakenly installed neutron on the second node instead of mitaka and it changed the version in the db on the first node. And did not roll back when downgraded. Solved by rolling down to mitaka and setting in nova db \"update services  set version='9' where version='15';\"", 
            "date_created": "2017-03-01 12:27:46.350242+00:00", 
            "author": "https://api.launchpad.net/1.0/~dmlp"
        }
    ], 
    "closed": "2017-02-07 04:17:31.641568+00:00"
}