{
    "status": "Fix Released", 
    "last_updated": "2015-12-03 21:36:41.169662+00:00", 
    "description": "Deleting a server created using bootable volume which is still in build state leaves behind volume in 'in-use' state and this volume can not be deleted using delete api. Below is the shell script to reproduce it.\n\ncurl -g -i -X POST https://10.0.0.5:4523/v2/ee61323896a34bea9c9a5623fbb6f239/os-volumes_boot?format=xml -H \"User-Agent: python-novaclient\" -H \"Content-Type: application/json\" -H \"Accept: application/json\" -H \"X-Auth-Token: <omitted>\" -d '{\"server\": {\"name\": \"testVolIssue\", \"imageRef\": \"\", \"block_device_mapping_v2\": [{\"boot_index\": \"0\", \"uuid\": \"5d246189-a666-470c-8cee-36ee489cbd9e\", \"volume_size\": \"6\", \"source_type\": \"image\", \"destination_type\": \"volume\", \"delete_on_termination\": \"1\"}], \"flavorRef\": \"da9ba7b5-be67-4a62-bb35-a362e05ba2f2\", \"max_count\": 1, \"min_count\": 1, \"networks\": [{\"uuid\": \"b5220eb2-e105-4ae0-8fc7-75a7cd468a40\"}]}}' > /dev/null ; var=`nova list | grep testVolIssue | awk '{print $2}'`;echo Server Id: $var;nova delete $var; nova show $var\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   839  100   436  100   403    589    544 --:--:-- --:--:-- --:--:--   589\nServer Id: 8f04539c-a0a6-4276-af1f-17c447cc8c53\nRequest to delete server 8f04539c-a0a6-4276-af1f-17c447cc8c53 has been accepted.\n+--------------------------------------+----------------------------------------------------------+\n| Property                             | Value                                                    |\n+--------------------------------------+----------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                   |\n| OS-EXT-AZ:availability_zone          | nova                                                     |\n| OS-EXT-STS:power_state               | 0                                                        |\n| OS-EXT-STS:task_state                | deleting                                                 |\n| OS-EXT-STS:vm_state                  | building                                                 |\n| OS-SRV-USG:launched_at               | -                                                        |\n| OS-SRV-USG:terminated_at             | -                                                        |\n| accessIPv4                           |                                                          |\n| accessIPv6                           |                                                          |\n| config_drive                         |                                                          |\n| created                              | 2015-05-24T09:24:30Z                                     |\n| flavor                               | small (da9ba7b5-be67-4a62-bb35-a362e05ba2f2)             |\n| hostId                               | f96a91b0f7f407d7880f3ee32208c4003f8245431115666dad4bb2e5 |\n| id                                   | 8f04539c-a0a6-4276-af1f-17c447cc8c53                     |\n| image                                | Attempt to boot from volume - no image supplied          |\n| key_name                             | -                                                        |\n| metadata                             | {}                                                       |\n| name                                 | testVolIssue                                             |\n| os-extended-volumes:volumes_attached | [{\"id\": \"97017c0c-b752-4cba-9c42-dcc5600a5f95\"}]         |\n| progress                             | 0                                                        |\n| security_groups                      | default                                                  |\n| status                               | BUILD                                                    |\n| tenant_id                            | ee61323896a34bea9c9a5623fbb6f239                         |\n| updated                              | 2015-05-24T09:24:32Z                                     |\n| user_id                              | 6cb8b12bed5046ff810d71ed73bdcb2e                         |\n+--------------------------------------+----------------------------------------------------------+\nnova show 8f04539c-a0a6-4276-af1f-17c447cc8c53\nERROR (CommandError): No server with a name or ID of '8f04539c-a0a6-4276-af1f-17c447cc8c53' exists.\n\ncinder list | grep 8f04539c-a0a6-4276-af1f-17c447cc8c53\n| 97017c0c-b752-4cba-9c42-dcc5600a5f95 |   in-use  |                         |  6   |     None    |   true   | 8f04539c-a0a6-4276-af1f-17c447cc8c53 |\ncinder delete 97017c0c-b752-4cba-9c42-dcc5600a5f95\nDelete for volume 97017c0c-b752-4cba-9c42-dcc5600a5f95 failed: Bad Request (HTTP 400) (Request-ID: req-30d7843f-6c12-42ad-89e3-4103db630c1c)\nERROR: Unable to delete any of the specified volumes.", 
    "tags": [
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1458308", 
    "owner": "https://api.launchpad.net/1.0/~ankitagrawal", 
    "id": 1458308, 
    "index": 6825, 
    "openned": "2015-05-24 09:50:04.446428+00:00", 
    "created": "2015-05-24 09:50:04.446428+00:00", 
    "title": "Deleting a volume booted server which is still in build state leaves behind volume in 'in-use' state", 
    "comments": [
        {
            "content": "Deleting a server created using bootable volume which is still in build state leaves behind volume in 'in-use' state and this volume can not be deleted using delete api. Below is the shell script to reproduce it.\n\ncurl -g -i -X POST https://10.0.0.5:4523/v2/ee61323896a34bea9c9a5623fbb6f239/os-volumes_boot?format=xml -H \"User-Agent: python-novaclient\" -H \"Content-Type: application/json\" -H \"Accept: application/json\" -H \"X-Auth-Token: <omitted>\" -d '{\"server\": {\"name\": \"testVolIssue\", \"imageRef\": \"\", \"block_device_mapping_v2\": [{\"boot_index\": \"0\", \"uuid\": \"5d246189-a666-470c-8cee-36ee489cbd9e\", \"volume_size\": \"6\", \"source_type\": \"image\", \"destination_type\": \"volume\", \"delete_on_termination\": \"1\"}], \"flavorRef\": \"da9ba7b5-be67-4a62-bb35-a362e05ba2f2\", \"max_count\": 1, \"min_count\": 1, \"networks\": [{\"uuid\": \"b5220eb2-e105-4ae0-8fc7-75a7cd468a40\"}]}}' > /dev/null ; var=`nova list | grep testVolIssue | awk '{print $2}'`;echo Server Id: $var;nova delete $var; nova show $var\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   839  100   436  100   403    589    544 --:--:-- --:--:-- --:--:--   589\nServer Id: 8f04539c-a0a6-4276-af1f-17c447cc8c53\nRequest to delete server 8f04539c-a0a6-4276-af1f-17c447cc8c53 has been accepted.\n+--------------------------------------+----------------------------------------------------------+\n| Property                             | Value                                                    |\n+--------------------------------------+----------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                   |\n| OS-EXT-AZ:availability_zone          | nova                                                     |\n| OS-EXT-STS:power_state               | 0                                                        |\n| OS-EXT-STS:task_state                | deleting                                                 |\n| OS-EXT-STS:vm_state                  | building                                                 |\n| OS-SRV-USG:launched_at               | -                                                        |\n| OS-SRV-USG:terminated_at             | -                                                        |\n| accessIPv4                           |                                                          |\n| accessIPv6                           |                                                          |\n| config_drive                         |                                                          |\n| created                              | 2015-05-24T09:24:30Z                                     |\n| flavor                               | small (da9ba7b5-be67-4a62-bb35-a362e05ba2f2)             |\n| hostId                               | f96a91b0f7f407d7880f3ee32208c4003f8245431115666dad4bb2e5 |\n| id                                   | 8f04539c-a0a6-4276-af1f-17c447cc8c53                     |\n| image                                | Attempt to boot from volume - no image supplied          |\n| key_name                             | -                                                        |\n| metadata                             | {}                                                       |\n| name                                 | testVolIssue                                             |\n| os-extended-volumes:volumes_attached | [{\"id\": \"97017c0c-b752-4cba-9c42-dcc5600a5f95\"}]         |\n| progress                             | 0                                                        |\n| security_groups                      | default                                                  |\n| status                               | BUILD                                                    |\n| tenant_id                            | ee61323896a34bea9c9a5623fbb6f239                         |\n| updated                              | 2015-05-24T09:24:32Z                                     |\n| user_id                              | 6cb8b12bed5046ff810d71ed73bdcb2e                         |\n+--------------------------------------+----------------------------------------------------------+\nnova show 8f04539c-a0a6-4276-af1f-17c447cc8c53\nERROR (CommandError): No server with a name or ID of '8f04539c-a0a6-4276-af1f-17c447cc8c53' exists.\n\ncinder list | grep 8f04539c-a0a6-4276-af1f-17c447cc8c53\n| 97017c0c-b752-4cba-9c42-dcc5600a5f95 |   in-use  |                         |  6   |     None    |   true   | 8f04539c-a0a6-4276-af1f-17c447cc8c53 |\ncinder delete 97017c0c-b752-4cba-9c42-dcc5600a5f95\nDelete for volume 97017c0c-b752-4cba-9c42-dcc5600a5f95 failed: Bad Request (HTTP 400) (Request-ID: req-30d7843f-6c12-42ad-89e3-4103db630c1c)\nERROR: Unable to delete any of the specified volumes.", 
            "date_created": "2015-05-24 09:50:04.446428+00:00", 
            "author": "https://api.launchpad.net/1.0/~afaheem88"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/194063\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ecdf331bafddfd2bb8c92d3fd96f301bc7ac644f\nSubmitter: Jenkins\nBranch:    master\n\ncommit ecdf331bafddfd2bb8c92d3fd96f301bc7ac644f\nAuthor: ankitagrawal <email address hidden>\nDate:   Wed Sep 23 03:58:19 2015 -0700\n\n    Detach volume after deleting instance with no host\n    \n    If an instance is booted from a volume, shelved, and goes into an error\n    state due to some reason. Volume from which instance is booted, remains\n    in-use state even the instance is deleted because instance has no host\n    associated with it.\n    \n    Called _local_delete() to detach volume and destroy bdm if instance is\n    in shelved_offloaded state or has no host associated with it. This will\n    cleanup both volumes and the networks.\n    \n    Note:\n    I had submitted same patch [1] earlier which was reverted [2] due to a\n    race condition on jenkins if an instance is deleted when it is in\n    building state. In this patch I have fixed the failure of race condition\n    by reverting the ObjectActionError exception handling in _delete.\n    \n    [1] Ic630ae7d026a9697afec46ac9ea40aea0f5b5ffb\n    [2] Id4e405e7579530ed1c1f22ccc972d45b6d185f41\n    \n    Closes-Bug: 1404867\n    Closes-Bug: 1408527\n    Closes-Bug: 1458308\n    Change-Id: Ic107d8edc7ee7a4ebb04eac58ef0cdbf506d6173\n", 
            "date_created": "2015-11-27 19:32:58.834280+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.0.0.0b1 development milestone.", 
            "date_created": "2015-12-02 16:18:18.882198+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }
    ], 
    "closed": "2015-12-03 21:36:38.720054+00:00"
}