{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:58:22.527005+00:00", 
    "description": "Tempest scenario TestEncryptedCinderVolumes has been silently skipped when run with NetApp iSCSI cinder volume drivers because they did not set the 'encrypted' key in the connection_info['data'] dict in their initialize_connection methods. Change\nhttps://review.openstack.org/#/c/193673/ - which sets the encrypted flag generically, in the VolumeManager's initialize_connection, on the basis of the volume.encryption_key_id value - causes this test to actually run its encryption providers and exposes a problem in LuksEncryptor:_format_volume() for these iSCSI volumes.\n\nIn TestEncryptedCinderVolumes we get the following exception:\n\n2015-06-29 06:27:18.866 ERROR nova.virt.libvirt.driver [req-7124728f-64b7-4951-806b-10901bb2f6b9 TestEncryptedCinderVolumes-1766245790 TestEncryptedCinderVolumes-1100414243] [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Failed to attach volume at mountpoint: /dev/vdb\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Traceback (most recent call last):\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 1082, in attach_volume\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]     encryptor.attach_volume(context, **encryption)\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]   File \"/opt/stack/new/nova/nova/volume/encryptors/luks.py\", line 113, in attach_volume\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]     self._format_volume(passphrase, **kwargs)\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]   File \"/opt/stack/new/nova/nova/volume/encryptors/luks.py\", line 78, in _format_volume\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]     check_exit_code=True, run_as_root=True)\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]   File \"/opt/stack/new/nova/nova/utils.py\", line 229, in execute\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]     return processutils.execute(*cmd, **kwargs)\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\", line 260, in execute\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]     cmd=sanitized_cmd)\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] ProcessExecutionError: Unexpected error while running command.\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup --batch-mode luksFormat --key-file=- --cipher aes-xts-plain64 --key-size 512 /dev/sdh\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Exit code: 5\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Stdout: u''\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Stderr: u'Cannot format device /dev/sdh which is still in use.\\n'\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] \n\nThis is on master, corresponding code is: https://github.com/openstack/nova/blob/master/nova/volume/encryptors/luks.py#L78", 
    "tags": [
        "volumes"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1470562", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1470562, 
    "index": 4288, 
    "openned": "2015-07-01 15:23:14.717357+00:00", 
    "created": "2015-07-01 15:23:14.717357+00:00", 
    "title": "'in use' error when Nova volume encryptors format cinder volumes", 
    "comments": [
        {
            "content": "Tempest scenario TestEncryptedCinderVolumes has been silently skipped when run with NetApp iSCSI cinder volume drivers because they did not set the 'encrypted' key in the connection_info['data'] dict in their initialize_connection methods. Change\nhttps://review.openstack.org/#/c/193673/ - which sets the encrypted flag generically, in the VolumeManager's initialize_connection, on the basis of the volume.encryption_key_id value - causes this test to actually run its encryption providers and exposes a problem in LuksEncryptor:_format_volume() for these iSCSI volumes.\n\nIn TestEncryptedCinderVolumes we get the following exception:\n\n2015-06-29 06:27:18.866 ERROR nova.virt.libvirt.driver [req-7124728f-64b7-4951-806b-10901bb2f6b9 TestEncryptedCinderVolumes-1766245790 TestEncryptedCinderVolumes-1100414243] [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Failed to attach volume at mountpoint: /dev/vdb\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Traceback (most recent call last):\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 1082, in attach_volume\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]     encryptor.attach_volume(context, **encryption)\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]   File \"/opt/stack/new/nova/nova/volume/encryptors/luks.py\", line 113, in attach_volume\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]     self._format_volume(passphrase, **kwargs)\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]   File \"/opt/stack/new/nova/nova/volume/encryptors/luks.py\", line 78, in _format_volume\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]     check_exit_code=True, run_as_root=True)\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]   File \"/opt/stack/new/nova/nova/utils.py\", line 229, in execute\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]     return processutils.execute(*cmd, **kwargs)\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\", line 260, in execute\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c]     cmd=sanitized_cmd)\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] ProcessExecutionError: Unexpected error while running command.\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Command: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup --batch-mode luksFormat --key-file=- --cipher aes-xts-plain64 --key-size 512 /dev/sdh\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Exit code: 5\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Stdout: u''\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] Stderr: u'Cannot format device /dev/sdh which is still in use.\\n'\n2015-06-29 06:27:18.866 12852 ERROR nova.virt.libvirt.driver [instance: 4a5dd4fd-78f8-42ea-8736-406ccb178d7c] \n\nThis is on master, corresponding code is: https://github.com/openstack/nova/blob/master/nova/volume/encryptors/luks.py#L78", 
            "date_created": "2015-07-01 15:23:14.717357+00:00", 
            "author": "https://api.launchpad.net/1.0/~tpb"
        }, 
        {
            "content": "Any idea what's causing the in-use when this happens?", 
            "date_created": "2015-07-01 17:52:18.080730+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Could be similar to bug 1374458 where we just added a retry of 3 when trying to close the volume:\n\nhttps://review.openstack.org/#/c/124418/", 
            "date_created": "2015-07-01 19:18:54.257075+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Here is the netapp iscsi third party CI log where this failed:\n\nhttp://dcf901611175aa43f968-c54047c910227e27e1d6f03bb1796fd7.r95.cf5.rackcdn.com/73/193673/3/check/cinder-cDOT-iSCSI/e911b71/screen-n-cpu.txt", 
            "date_created": "2015-07-01 19:22:56.087357+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "It's using cryptsetup 1.6.1:\n\nii  cryptsetup                            2:1.6.1-1ubuntu1                      amd64        disk encryption support - startup scripts\nii  cryptsetup-bin                        2:1.6.1-1ubuntu1                      amd64        disk encryption support - command line tools\n\nI was wondering because I was searching threads for issues with cryptsetup returning exit code 5 and found this:\n\nhttps://bbs.archlinux.org/viewtopic.php?id=186296\n\nWhere they were talking about issues after 1.6.4, but we wouldn't be hitting that.", 
            "date_created": "2015-07-01 19:23:55.953439+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I also see this in the failed test run:\n\n2015-06-29 06:27:17.930 INFO nova.volume.encryptors.luks [req-7124728f-64b7-4951-806b-10901bb2f6b9 TestEncryptedCinderVolumes-1766245790 TestEncryptedCinderVolumes-1100414243] /dev/sdh is not a valid LUKS device; formatting device for first use", 
            "date_created": "2015-07-01 19:35:53.956219+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Here is the patch: https://review.openstack.org/#/c/197721/", 
            "date_created": "2015-07-01 20:13:16.046965+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/197721\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3aabe378b128163b0e4e443a38a8d99e8bde1006\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3aabe378b128163b0e4e443a38a8d99e8bde1006\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Jul 1 12:37:29 2015 -0700\n\n    Try luksFormat up to 3 times in case the device is in use\n    \n    Cinder change I03f8cae05cc117e14f7482115de685fc9f3fa54a is failing for\n    some volume driver third party CI like NetApp iSCSI because the device\n    is in use when formatting the device for LUKS.\n    \n    This change adds a retry counter to the luksFormat command execution\n    like we did in commit eef97cdf4bb7f426d7feb394ef54510db8b1656b for\n    closing the volume and hitting intermittent in-use issues.\n    \n    Closes-Bug: #1470562\n    Related-Bug: #1440227\n    \n    Change-Id: I0cb32a6f9fbe68ae033ad00534512aa5d82a417b\n", 
            "date_created": "2015-07-29 23:49:38.499710+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-09-03 11:45:21.392206+00:00"
}