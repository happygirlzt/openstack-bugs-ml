{
    "status": "Invalid", 
    "last_updated": "2015-11-19 21:48:26.291684+00:00", 
    "description": "A new test has been added to tempest to stress the os-baremetal-nodes API extension.  The test periodically fails in the gate with traceback in n-api log:\n\n[req-01dcd35b-55f4-4688-ba18-7fe0c6defd52 BaremetalNodesAdminTestJSON-1864409967 BaremetalNodesAdminTestJSON-1481542636] Caught error: 'cpus'\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack Traceback (most recent call last):\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/__init__.py\", line 125, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return req.get_response(self.application)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1320, in send\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     application, catch_exc_info=False)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1284, in call_application\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return resp(environ, start_response)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/keystonemiddleware/auth_token.py\", line 977, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return self._call_app(env, start_response)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/keystonemiddleware/auth_token.py\", line 902, in _call_app\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return self._app(env, _fake_start_response)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/routes/middleware.py\", line 136, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 749, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     content_type, body, accept)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 814, in _process_stack\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 904, in dispatch\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return method(req=request, **action_args)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/compute/contrib/baremetal_nodes.py\", line 123, in index\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     'cpus': inode.properties['cpus'],\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack KeyError: 'cpus'\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack\n\nThis hits only periodically and only when another tempest baremetal test is running in parallel to the new test.  The other tests (tempest.api.baremetal.*) create some nodes in Ironic with node properties that are not the standard resource properties the nova->ironic proxy expects (from nova/api/openstack/compute/contrib/baremetal_nodes.py:201):\n\n          for inode in ironic_nodes:\n                node = {'id': inode.uuid,\n                        'interfaces': [],\n                        'host': 'IRONIC MANAGED',\n                        'task_state': inode.provision_state,\n                        'cpus': inode.properties['cpus'],\n                        'memory_mb': inode.properties['memory_mb'],\n                        'disk_gb': inode.properties['local_gb']}\n                nodes.append(node)\n\nThe other tempest test is creating nodes with a different set of properties:\n\n {u'cpu_arch': u'x86', u'cpu_num': 8, u'memory': 4096, u'storage': 1024}\n\nIronic node properties are meant to be an arbitrary json dict, so the nova code needs to account for this in one way or another.", 
    "tags": [
        "api", 
        "baremetal", 
        "ironic"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1423427", 
    "owner": "None", 
    "id": 1423427, 
    "index": 6710, 
    "openned": "2015-11-14 13:51:22.804641+00:00", 
    "created": "2015-02-19 03:00:29.071511+00:00", 
    "title": "tempest baremetal client is creating node with wrong property keys", 
    "comments": [
        {
            "content": "A new test has been added to tempest to stress the os-baremetal-nodes API extension.  The test periodically fails in the gate with traceback in n-api log:\n\n[req-01dcd35b-55f4-4688-ba18-7fe0c6defd52 BaremetalNodesAdminTestJSON-1864409967 BaremetalNodesAdminTestJSON-1481542636] Caught error: 'cpus'\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack Traceback (most recent call last):\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/__init__.py\", line 125, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return req.get_response(self.application)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1320, in send\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     application, catch_exc_info=False)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1284, in call_application\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return resp(environ, start_response)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/keystonemiddleware/auth_token.py\", line 977, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return self._call_app(env, start_response)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/keystonemiddleware/auth_token.py\", line 902, in _call_app\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return self._app(env, _fake_start_response)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/routes/middleware.py\", line 136, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 749, in __call__\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     content_type, body, accept)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 814, in _process_stack\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 904, in dispatch\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     return method(req=request, **action_args)\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/compute/contrib/baremetal_nodes.py\", line 123, in index\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack     'cpus': inode.properties['cpus'],\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack KeyError: 'cpus'\n2015-02-19 01:37:41.910 2521 TRACE nova.api.openstack\n\nThis hits only periodically and only when another tempest baremetal test is running in parallel to the new test.  The other tests (tempest.api.baremetal.*) create some nodes in Ironic with node properties that are not the standard resource properties the nova->ironic proxy expects (from nova/api/openstack/compute/contrib/baremetal_nodes.py:201):\n\n          for inode in ironic_nodes:\n                node = {'id': inode.uuid,\n                        'interfaces': [],\n                        'host': 'IRONIC MANAGED',\n                        'task_state': inode.provision_state,\n                        'cpus': inode.properties['cpus'],\n                        'memory_mb': inode.properties['memory_mb'],\n                        'disk_gb': inode.properties['local_gb']}\n                nodes.append(node)\n\nThe other tempest test is creating nodes with a different set of properties:\n\n {u'cpu_arch': u'x86', u'cpu_num': 8, u'memory': 4096, u'storage': 1024}\n\nIronic node properties are meant to be an arbitrary json dict, so the nova code needs to account for this in one way or another.", 
            "date_created": "2015-02-19 03:00:29.071511+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "We should probably just do something like this:\n\n'cpus': inode.properties.get('cpus') or inode.properties.get('cpu_num'),", 
            "date_created": "2015-02-19 04:20:59.306380+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "These are the baremetal tests added to tempest on 2/16 when the failure started:\n\nhttps://github.com/openstack/tempest/commit/ac0879accd2a451c54ed935297a6f8e0a8aaf25a\n\nAnd looking at the tempest api schema checks and the nova code, they match what's in the ironic API:\n\nhttp://docs.openstack.org/developer/ironic/webapi/v1.html#nodes\n\nSo I'm not convinced now that this is a nova bug, maybe ironic is passing back different keys?  Or tempest is somehow setting up bad data?", 
            "date_created": "2015-02-19 04:53:14.147391+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "The baremetal client in tempest is creating the node with the wrong data:\n\nhttp://git.openstack.org/cgit/openstack/tempest/tree/tempest/services/baremetal/v1/json/baremetal_client.py#n134", 
            "date_created": "2015-02-19 04:54:49.676267+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/157256", 
            "date_created": "2015-02-19 05:02:26.534195+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/157256\nCommitted: https://git.openstack.org/cgit/openstack/tempest/commit/?id=3ea1eb81d557a9a86553960f2bdb39ccc99787ea\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3ea1eb81d557a9a86553960f2bdb39ccc99787ea\nAuthor: Adam Gandelman <email address hidden>\nDate:   Wed Feb 18 19:13:25 2015 -0800\n\n    Fix baremetal node property keys\n    \n    The baremetal_client is creating test nodes with property keys that\n    don't match what the nova os-baremetal-nodes extension is pulling out of\n    the node properties from the ironic client. This results in KeyErrors\n    when this test runs in parallel to other baremetal tests that were added\n    to Tempest on 2/16 with commit ac0879accd2a451c54ed935297a6f8e0a8aaf25a.\n    \n    Closes-Bug: #1423427\n    \n    Co-authored-by: Adam Gandelman <email address hidden>\n    \n    Change-Id: I3593f58de5088d2442fddd52c6a11d055bb4f6a0\n", 
            "date_created": "2015-02-20 18:20:21.730785+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-11-14 13:51:33.422947+00:00"
}