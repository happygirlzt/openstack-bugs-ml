{
    "status": "Fix Released", 
    "last_updated": "2016-11-17 13:13:45.894140+00:00", 
    "description": "Seen here:\n\nhttp://logs.openstack.org/98/355098/1/check/gate-tempest-dsvm-full-ubuntu-xenial/3c301f3/logs/screen-n-cond.txt.gz?level=TRACE#_2016-08-13_00_53_27_621\n\n2016-08-13 00:53:27.621 15971 ERROR nova.scheduler.utils [req-e7b83619-01ae-43f2-b293-af02c5cb35a8 tempest-FixedIPsTestJson-2017152444 tempest-FixedIPsTestJson-2017152444] [instance: ac2c9a4a-1b07-43e1-8f4c-b75541331307] Error from last host: ubuntu-xenial-rax-ord-3453779 (node ubuntu-xenial-rax-ord-3453779): [u'Traceback (most recent call last):\\n', u'  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1778, in _do_build_and_run_instance\\n    filter_properties)\\n', u'  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1973, in _build_and_run_instance\\n    instance_uuid=instance.uuid, reason=six.text_type(e))\\n', u\"RescheduledException: Build of instance ac2c9a4a-1b07-43e1-8f4c-b75541331307 was re-scheduled: operation failed: filter 'nova-no-nd-reflection' already exists with uuid 1f47eeb2-d473-481e-998a-c4d64a44ac5e\\n\"]\n2016-08-13 00:53:27.676 15971 WARNING nova.scheduler.utils [req-e7b83619-01ae-43f2-b293-af02c5cb35a8 tempest-FixedIPsTestJson-2017152444 tempest-FixedIPsTestJson-2017152444] Failed to compute_task_build_instances: No valid host was found. There are not enough hosts available.\nTraceback (most recent call last):\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 199, in inner\n    return func(*args, **kwargs)\n\n  File \"/opt/stack/new/nova/nova/scheduler/manager.py\", line 104, in select_destinations\n    dests = self.driver.select_destinations(ctxt, spec_obj)\n\n  File \"/opt/stack/new/nova/nova/scheduler/filter_scheduler.py\", line 74, in select_destinations\n    raise exception.NoValidHost(reason=reason)\n\nNoValidHost: No valid host was found. There are not enough hosts available.\n\n2016-08-13 00:53:27.676 15971 WARNING nova.scheduler.utils [req-e7b83619-01ae-43f2-b293-af02c5cb35a8 tempest-FixedIPsTestJson-2017152444 tempest-FixedIPsTestJson-2017152444] [instance: ac2c9a4a-1b07-43e1-8f4c-b75541331307] Setting instance to ERROR state.\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22was%20re-scheduled%3A%20operation%20failed%3A%20filter%20'nova-no-nd-reflection'%20already%20exists%20with%20uuid%5C%22%20AND%20tags%3A%5C%22screen-n-cond.txt%5C%22&from=7d\n\n5 hits in 7 days, check queue only, but multiple changes.", 
    "tags": [
        "firewall", 
        "gate-failure", 
        "libvirt", 
        "network"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1612875", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1612875, 
    "index": 1972, 
    "openned": "2016-08-13 01:26:42.593269+00:00", 
    "created": "2016-08-13 01:26:42.593269+00:00", 
    "title": "FixedIPsTestJson fails server build with 'was re-scheduled: operation failed: filter 'nova-no-nd-reflection' already exists with uuid'", 
    "comments": [
        {
            "content": "Seen here:\n\nhttp://logs.openstack.org/98/355098/1/check/gate-tempest-dsvm-full-ubuntu-xenial/3c301f3/logs/screen-n-cond.txt.gz?level=TRACE#_2016-08-13_00_53_27_621\n\n2016-08-13 00:53:27.621 15971 ERROR nova.scheduler.utils [req-e7b83619-01ae-43f2-b293-af02c5cb35a8 tempest-FixedIPsTestJson-2017152444 tempest-FixedIPsTestJson-2017152444] [instance: ac2c9a4a-1b07-43e1-8f4c-b75541331307] Error from last host: ubuntu-xenial-rax-ord-3453779 (node ubuntu-xenial-rax-ord-3453779): [u'Traceback (most recent call last):\\n', u'  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1778, in _do_build_and_run_instance\\n    filter_properties)\\n', u'  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1973, in _build_and_run_instance\\n    instance_uuid=instance.uuid, reason=six.text_type(e))\\n', u\"RescheduledException: Build of instance ac2c9a4a-1b07-43e1-8f4c-b75541331307 was re-scheduled: operation failed: filter 'nova-no-nd-reflection' already exists with uuid 1f47eeb2-d473-481e-998a-c4d64a44ac5e\\n\"]\n2016-08-13 00:53:27.676 15971 WARNING nova.scheduler.utils [req-e7b83619-01ae-43f2-b293-af02c5cb35a8 tempest-FixedIPsTestJson-2017152444 tempest-FixedIPsTestJson-2017152444] Failed to compute_task_build_instances: No valid host was found. There are not enough hosts available.\nTraceback (most recent call last):\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 199, in inner\n    return func(*args, **kwargs)\n\n  File \"/opt/stack/new/nova/nova/scheduler/manager.py\", line 104, in select_destinations\n    dests = self.driver.select_destinations(ctxt, spec_obj)\n\n  File \"/opt/stack/new/nova/nova/scheduler/filter_scheduler.py\", line 74, in select_destinations\n    raise exception.NoValidHost(reason=reason)\n\nNoValidHost: No valid host was found. There are not enough hosts available.\n\n2016-08-13 00:53:27.676 15971 WARNING nova.scheduler.utils [req-e7b83619-01ae-43f2-b293-af02c5cb35a8 tempest-FixedIPsTestJson-2017152444 tempest-FixedIPsTestJson-2017152444] [instance: ac2c9a4a-1b07-43e1-8f4c-b75541331307] Setting instance to ERROR state.\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22was%20re-scheduled%3A%20operation%20failed%3A%20filter%20'nova-no-nd-reflection'%20already%20exists%20with%20uuid%5C%22%20AND%20tags%3A%5C%22screen-n-cond.txt%5C%22&from=7d\n\n5 hits in 7 days, check queue only, but multiple changes.", 
            "date_created": "2016-08-13 01:26:42.593269+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Failed differently here:\n\nhttp://logs.openstack.org/95/325895/13/gate/gate-tempest-dsvm-postgres-full-ubuntu-xenial/bb138b1/logs/screen-n-cond.txt.gz?level=TRACE\n\n2016-08-12 19:46:39.498 12354 ERROR nova.scheduler.utils [req-efd43cdc-26fa-4391-a65c-687239446e74 tempest-FloatingIPsTestJSON-1799526450 tempest-FloatingIPsTestJSON-1799526450] [instance: ec8ea43e-b71a-48d1-8a71-826b1f5133a2] Error from last host: ubuntu-xenial-ovh-bhs1-3445846 (node ubuntu-xenial-ovh-bhs1-3445846): [u'Traceback (most recent call last):\\n', u'  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1778, in _do_build_and_run_instance\\n    filter_properties)\\n', u'  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1973, in _build_and_run_instance\\n    instance_uuid=instance.uuid, reason=six.text_type(e))\\n', u\"RescheduledException: Build of instance ec8ea43e-b71a-48d1-8a71-826b1f5133a2 was re-scheduled: operation failed: filter 'nova-base' already exists with uuid 95b42da7-c704-4eca-bcd0-3d7c8168804c\\n\"]", 
            "date_created": "2016-08-13 01:36:45.154639+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Ah it's not a scheduler filter (which is what I thought was related to this), it's a libvirt firewall driver network filter:\n\nhttp://logs.openstack.org/24/374324/1/gate/gate-tempest-dsvm-cells-ubuntu-xenial/81f45de/logs/screen-n-cpu.txt.gz?level=TRACE#_2016-09-21_21_20_24_446\n\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [req-462fe36b-6d85-4b74-9eab-4d2a0ea9c3d5 tempest-ListImageFiltersTestJSON-1517708761 tempest-ListImageFiltersTestJSON-1517708761] [instance: 9103de54-6d83-4877-8075-9807ec099778] Instance failed to spawn\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778] Traceback (most recent call last):\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2078, in _build_resources\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     yield resources\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1920, in _build_and_run_instance\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     block_device_info=block_device_info)\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 2583, in spawn\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     post_xml_callback=gen_confdrive)\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4816, in _create_domain_and_network\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     network_info)\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/opt/stack/new/nova/nova/virt/libvirt/firewall.py\", line 339, in setup_basic_filtering\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     self.nwfilter.setup_basic_filtering(instance, network_info)\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/opt/stack/new/nova/nova/virt/libvirt/firewall.py\", line 122, in setup_basic_filtering\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     self._ensure_static_filters()\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/opt/stack/new/nova/nova/virt/libvirt/firewall.py\", line 225, in _ensure_static_filters\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     self._define_filter(self.nova_no_nd_reflection_filter())\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/opt/stack/new/nova/nova/virt/libvirt/firewall.py\", line 262, in _define_filter\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     self._conn.nwfilterDefineXML(xml)\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     rv = execute(f, *args, **kwargs)\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     six.reraise(c, e, tb)\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     rv = meth(*args, **kwargs)\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]   File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 4341, in nwfilterDefineXML\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778]     if ret is None:raise libvirtError('virNWFilterDefineXML() failed', conn=self)\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778] libvirtError: operation failed: filter 'nova-no-nd-reflection' already exists with uuid e740c5ec-c715-4f73-9874-630cc73d4ac2\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778] ", 
            "date_created": "2016-09-22 16:14:58.808863+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I see that right before the failure we lookup the filter by name and get the uuid:\n\nhttp://logs.openstack.org/24/374324/1/gate/gate-tempest-dsvm-cells-ubuntu-xenial/81f45de/logs/screen-n-cpu.txt.gz#_2016-09-21_21_20_24_441\n\n2016-09-21 21:20:24.441 12207 DEBUG nova.virt.libvirt.firewall [req-462fe36b-6d85-4b74-9eab-4d2a0ea9c3d5 tempest-ListImageFiltersTestJSON-1517708761 tempest-ListImageFiltersTestJSON-1517708761] UUID for filter 'nova-no-nd-reflection' is '0e742215d36e4ebb8830ef09d513c9a1' _get_filter_uuid /opt/stack/new/nova/nova/virt/libvirt/firewall.py:256\n\nAnd then 5ms after that it fails because the filter exists with some other uuid:\n\n2016-09-21 21:20:24.446 12207 ERROR nova.compute.manager [instance: 9103de54-6d83-4877-8075-9807ec099778] libvirtError: operation failed: filter 'nova-no-nd-reflection' already exists with uuid e740c5ec-c715-4f73-9874-630cc73d4ac2", 
            "date_created": "2016-09-22 16:22:40.442957+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Yeah apparently this doesn't exist in libvirt 1.2.1:\n\nhttps://github.com/libvirt/libvirt/blob/v1.2.1/src/conf/nwfilter_conf.c#L2979\n\nWhich is our minimum supported version, and ubuntu 14.04 runs with 1.2.2.\n\nIn ubuntu 16.04 we're running with libvirt 1.3.1 which shows the check and error:\n\nhttps://github.com/libvirt/libvirt/blob/v1.3.1/src/conf/nwfilter_conf.c#L3099-L3101\n\n            virReportError(VIR_ERR_OPERATION_FAILED,\n                           _(\"filter '%s' already exists with uuid %s\"),\n                           def->name, uuidstr);\n\nIt's unfortunate that there isn't a specific error code, we'll have to check for VIR_ERR_OPERATION_FAILED and the message.", 
            "date_created": "2016-09-22 16:33:53.657964+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/374975", 
            "date_created": "2016-09-22 16:46:17.578038+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/374975\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=2ce193e16d7ca5b93671d7f0d2e3b35761f5d386\nSubmitter: Jenkins\nBranch:    master\n\ncommit 2ce193e16d7ca5b93671d7f0d2e3b35761f5d386\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu Sep 22 12:41:46 2016 -0400\n\n    libvirt: ignore conflict when defining network filters\n    \n    We have a latent race in the libvirt firewall code when setting\n    up static filters which is now an error with libvirt>=1.2.7,\n    which is why we started seeing this in CI failures starting in\n    newton which run on xenial nodes that have libvirt 1.3.1 (but\n    didn't see it on trusty nodes with libvirt 1.2.2).\n    \n    Libvirt commit 46a811db0731cedaea0153fc223faa6096cee5b5 checks\n    for an existing filter with the same name but a different uuid\n    when defining network filters and raises an error if found. That\n    was added in the 1.2.7 release.\n    \n    This change simply handles the error and ignores it so we don't\n    fail to boot the instance.\n    \n    Unfortunately we don't have a specific error code from libvirt\n    when this happens so the best we can do is compare the error\n    message from the libvirt error which is only going to work for\n    English locales because the error message from libvirt is\n    translated.\n    \n    Change-Id: I161be26d605351f168e351d3ed3d308234346f6f\n    Closes-Bug: #1612875\n", 
            "date_created": "2016-09-29 14:19:23.792370+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/380645", 
            "date_created": "2016-09-30 20:48:37.434492+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/380645\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c7a9998f9824e4e9508108429eefa86eadbc9f50\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit c7a9998f9824e4e9508108429eefa86eadbc9f50\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu Sep 22 12:41:46 2016 -0400\n\n    libvirt: ignore conflict when defining network filters\n    \n    We have a latent race in the libvirt firewall code when setting\n    up static filters which is now an error with libvirt>=1.2.7,\n    which is why we started seeing this in CI failures starting in\n    newton which run on xenial nodes that have libvirt 1.3.1 (but\n    didn't see it on trusty nodes with libvirt 1.2.2).\n    \n    Libvirt commit 46a811db0731cedaea0153fc223faa6096cee5b5 checks\n    for an existing filter with the same name but a different uuid\n    when defining network filters and raises an error if found. That\n    was added in the 1.2.7 release.\n    \n    This change simply handles the error and ignores it so we don't\n    fail to boot the instance.\n    \n    Unfortunately we don't have a specific error code from libvirt\n    when this happens so the best we can do is compare the error\n    message from the libvirt error which is only going to work for\n    English locales because the error message from libvirt is\n    translated.\n    \n    Change-Id: I161be26d605351f168e351d3ed3d308234346f6f\n    Closes-Bug: #1612875\n    (cherry picked from commit 2ce193e16d7ca5b93671d7f0d2e3b35761f5d386)\n", 
            "date_created": "2016-10-06 20:31:30.840702+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.1 release.", 
            "date_created": "2016-10-12 03:48:28.042887+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b1 development milestone.", 
            "date_created": "2016-11-17 13:13:45.168784+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-09-29 14:19:20.289696+00:00"
}