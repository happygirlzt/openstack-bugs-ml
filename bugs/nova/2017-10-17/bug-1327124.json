{
    "status": "Fix Released", 
    "last_updated": "2015-09-11 16:45:57.482324+00:00", 
    "description": "After fix this bug https://bugs.launchpad.net/nova/+bug/1326207 , The reschedule works.\n\nBut found instance stuck at spawning status after rescheduling.\n\nEnvoriment is:\nos3 is running ovs agent\nos4 is running linuxbridge agent\n\nWhen boot new instance, instance schedule to os3, but failed.\nnova begin to reschedule instance to os4.\n\nBut the instance is stuck at spawning status.\n\nos@os3:~/devstack$ nova show vm8\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-SRV-ATTR:host                 | os4                                                            |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | os4                                                            |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000034                                              |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | spawning                                                       |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| config_drive                         |                                                                |\n| created                              | 2014-06-06T09:18:38Z                                           |\n| flavor                               | m1.tiny (1)                                                    |\n| hostId                               | bf5039d22c8737b688f12f58afef5cde768f38732c47e48403932b44       |\n| id                                   | b6f6d043-1cfc-4c6d-914d-df4a48134589                           |\n| image                                | cirros-0.3.2-x86_64-uec (855f5370-8c60-4840-990d-f89b87bd3d19) |\n| key_name                             | -                                                              |\n| metadata                             | {}                                                             |\n| name                                 | vm8                                                            |\n| net1 network                         | 13.0.0.33                                                      |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | default                                                        |\n| status                               | BUILD                                                          |\n| tenant_id                            | 5c76520922254aa0a1459dc687bcbc1d                               |\n| updated                              | 2014-06-06T09:18:40Z                                           |\n| user_id                              | 9be4442569e54c15ac6bab7d30af7d8f                               |\n+--------------------------------------+----------------------------------------------------------------+\n\n\nGet error from os4 linuxbridge agent:\n\n2014-06-06 17:18:46.570 ERROR neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent [-] Error in agent loop. Devices info: {'current': set(['tap15c2b6bc-51', 'tap2723ce44-87', 'tap484a667a-b1', 'tap8641bd9a-64', 'tap78fef3dd-1f', 'tap66d5a70e-0d']), 'removed': set([]), 'added': set(['tap15c2b6bc-51', 'tap2723ce44-87', 'tap484a667a-b1', 'tap8641bd9a-64', 'tap78fef3dd-1f', 'tap66d5a70e-0d'])}\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent Traceback (most recent call last):\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/plugins/linuxbridge/agent/linuxbridge_neutron_agent.py\", line 1011, in daemon_loop\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     sync = self.process_network_devices(device_info)\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/plugins/linuxbridge/agent/linuxbridge_neutron_agent.py\", line 908, in process_network_devices\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     resync_a = self.treat_devices_added(device_info['added'])\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/plugins/linuxbridge/agent/linuxbridge_neutron_agent.py\", line 946, in treat_devices_added\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     details['port_id']):\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/plugins/linuxbridge/agent/linuxbridge_neutron_agent.py\", line 424, in add_interface\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     tap_device_name)\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/plugins/linuxbridge/agent/linuxbridge_neutron_agent.py\", line 406, in add_tap_interface\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     root_helper=self.root_helper):\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/agent/linux/utils.py\", line 76, in execute\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     raise RuntimeError(m)\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent RuntimeError:\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent Command: ['sudo', '/usr/local/bin/neutron-rootwrap', '/etc/neutron/rootwrap.conf', 'brctl', 'addif', 'brq4103cd57-70', 'tap8641bd9a-64']\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent Exit code: 1\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent Stdout: ''\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent Stderr: \"device tap8641bd9a-64 is already a member of a bridge; can't enslave it to bridge brq4103cd57-70.\\n\"\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent \n\n\n\nCheck the port status:\n\nos@os3:~/devstack$ neutron port-show 8641bd9a-64b2-439f-a9bd-8644787d25b6\n+-----------------------+----------------------------------------------------------------------------------+\n| Field                 | Value                                                                            |\n+-----------------------+----------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                             |\n| allowed_address_pairs |                                                                                  |\n| binding:host_id       | os3                                                                              |\n| binding:profile       | {}                                                                               |\n| binding:vif_details   | {\"port_filter\": true, \"ovs_hybrid_plug\": true}                                   |\n| binding:vif_type      | ovs                                                                              |\n| binding:vnic_type     | normal                                                                           |\n| device_id             | b6f6d043-1cfc-4c6d-914d-df4a48134589                                             |\n| device_owner          | compute:None                                                                     |\n| extra_dhcp_opts       |                                                                                  |\n| fixed_ips             | {\"subnet_id\": \"c26683fc-122f-4c30-bd05-f27f0499c6af\", \"ip_address\": \"13.0.0.33\"} |\n| id                    | 8641bd9a-64b2-439f-a9bd-8644787d25b6                                             |\n| mac_address           | fa:16:3e:4e:69:3b                                                                |\n| name                  |                                                                                  |\n| network_id            | 4103cd57-70d9-4aa4-9501-5441585278f5                                             |\n| security_groups       | 8a836d5b-27fc-499f-9b7d-7d279afaca3d                                             |\n| status                | BUILD                                                                            |\n| tenant_id             | 5c76520922254aa0a1459dc687bcbc1d                                                 |\n+-----------------------+----------------------------------------------------------------------------------+\n\n\n\nIt still binding at os3 host.", 
    "tags": [
        "juno-backport-potential"
    ], 
    "importance": "High", 
    "heat": 44, 
    "link": "https://bugs.launchpad.net/nova/+bug/1327124", 
    "owner": "https://api.launchpad.net/1.0/~xuhj", 
    "id": 1327124, 
    "index": 1506, 
    "openned": "2014-06-06 09:21:36.579527+00:00", 
    "created": "2014-06-06 09:21:36.579527+00:00", 
    "title": "Instance stuck at spawning status after rescheduling", 
    "comments": [
        {
            "content": "After fix this bug https://bugs.launchpad.net/nova/+bug/1326207 , The reschedule works.\n\nBut found instance stuck at spawning status after rescheduling.\n\nEnvoriment is:\nos3 is running ovs agent\nos4 is running linuxbridge agent\n\nWhen boot new instance, instance schedule to os3, but failed.\nnova begin to reschedule instance to os4.\n\nBut the instance is stuck at spawning status.\n\nos@os3:~/devstack$ nova show vm8\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-SRV-ATTR:host                 | os4                                                            |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | os4                                                            |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000034                                              |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | spawning                                                       |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| config_drive                         |                                                                |\n| created                              | 2014-06-06T09:18:38Z                                           |\n| flavor                               | m1.tiny (1)                                                    |\n| hostId                               | bf5039d22c8737b688f12f58afef5cde768f38732c47e48403932b44       |\n| id                                   | b6f6d043-1cfc-4c6d-914d-df4a48134589                           |\n| image                                | cirros-0.3.2-x86_64-uec (855f5370-8c60-4840-990d-f89b87bd3d19) |\n| key_name                             | -                                                              |\n| metadata                             | {}                                                             |\n| name                                 | vm8                                                            |\n| net1 network                         | 13.0.0.33                                                      |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | default                                                        |\n| status                               | BUILD                                                          |\n| tenant_id                            | 5c76520922254aa0a1459dc687bcbc1d                               |\n| updated                              | 2014-06-06T09:18:40Z                                           |\n| user_id                              | 9be4442569e54c15ac6bab7d30af7d8f                               |\n+--------------------------------------+----------------------------------------------------------------+\n\n\nGet error from os4 linuxbridge agent:\n\n2014-06-06 17:18:46.570 ERROR neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent [-] Error in agent loop. Devices info: {'current': set(['tap15c2b6bc-51', 'tap2723ce44-87', 'tap484a667a-b1', 'tap8641bd9a-64', 'tap78fef3dd-1f', 'tap66d5a70e-0d']), 'removed': set([]), 'added': set(['tap15c2b6bc-51', 'tap2723ce44-87', 'tap484a667a-b1', 'tap8641bd9a-64', 'tap78fef3dd-1f', 'tap66d5a70e-0d'])}\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent Traceback (most recent call last):\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/plugins/linuxbridge/agent/linuxbridge_neutron_agent.py\", line 1011, in daemon_loop\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     sync = self.process_network_devices(device_info)\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/plugins/linuxbridge/agent/linuxbridge_neutron_agent.py\", line 908, in process_network_devices\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     resync_a = self.treat_devices_added(device_info['added'])\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/plugins/linuxbridge/agent/linuxbridge_neutron_agent.py\", line 946, in treat_devices_added\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     details['port_id']):\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/plugins/linuxbridge/agent/linuxbridge_neutron_agent.py\", line 424, in add_interface\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     tap_device_name)\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/plugins/linuxbridge/agent/linuxbridge_neutron_agent.py\", line 406, in add_tap_interface\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     root_helper=self.root_helper):\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent   File \"/opt/stack/neutron/neutron/agent/linux/utils.py\", line 76, in execute\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent     raise RuntimeError(m)\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent RuntimeError:\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent Command: ['sudo', '/usr/local/bin/neutron-rootwrap', '/etc/neutron/rootwrap.conf', 'brctl', 'addif', 'brq4103cd57-70', 'tap8641bd9a-64']\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent Exit code: 1\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent Stdout: ''\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent Stderr: \"device tap8641bd9a-64 is already a member of a bridge; can't enslave it to bridge brq4103cd57-70.\\n\"\n2014-06-06 17:18:46.570 TRACE neutron.plugins.linuxbridge.agent.linuxbridge_neutron_agent \n\n\n\nCheck the port status:\n\nos@os3:~/devstack$ neutron port-show 8641bd9a-64b2-439f-a9bd-8644787d25b6\n+-----------------------+----------------------------------------------------------------------------------+\n| Field                 | Value                                                                            |\n+-----------------------+----------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                             |\n| allowed_address_pairs |                                                                                  |\n| binding:host_id       | os3                                                                              |\n| binding:profile       | {}                                                                               |\n| binding:vif_details   | {\"port_filter\": true, \"ovs_hybrid_plug\": true}                                   |\n| binding:vif_type      | ovs                                                                              |\n| binding:vnic_type     | normal                                                                           |\n| device_id             | b6f6d043-1cfc-4c6d-914d-df4a48134589                                             |\n| device_owner          | compute:None                                                                     |\n| extra_dhcp_opts       |                                                                                  |\n| fixed_ips             | {\"subnet_id\": \"c26683fc-122f-4c30-bd05-f27f0499c6af\", \"ip_address\": \"13.0.0.33\"} |\n| id                    | 8641bd9a-64b2-439f-a9bd-8644787d25b6                                             |\n| mac_address           | fa:16:3e:4e:69:3b                                                                |\n| name                  |                                                                                  |\n| network_id            | 4103cd57-70d9-4aa4-9501-5441585278f5                                             |\n| security_groups       | 8a836d5b-27fc-499f-9b7d-7d279afaca3d                                             |\n| status                | BUILD                                                                            |\n| tenant_id             | 5c76520922254aa0a1459dc687bcbc1d                                                 |\n+-----------------------+----------------------------------------------------------------------------------+\n\n\n\nIt still binding at os3 host.", 
            "date_created": "2014-06-06 09:21:36.579527+00:00", 
            "author": "https://api.launchpad.net/1.0/~xuhj"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/98340", 
            "date_created": "2014-06-06 09:23:45.172886+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/116578", 
            "date_created": "2014-08-25 10:05:25.652349+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/116579", 
            "date_created": "2014-08-25 10:05:35.557893+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Alex Xu (<email address hidden>) on branch: master\nReview: https://review.openstack.org/116579\nReason: Merge into https://review.openstack.org/#/c/116578/4", 
            "date_created": "2014-10-13 03:02:25.951973+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I also hit this issue, but it happened in the case of evacuating an instance. The phenomenon I saw is that the vm couldn't get ip address after evacuated.  It's caused by that  neutron refused to activate the port the new host since the port was still owned by the original host before evacuating.  Without the process of activating,  the bridge forwarding entries can't be populated on new host. Therefore the dhcp request packet from the instantce can't reach dhcp server.  So in all the cases which will launch an instance on a different host, like unshelve, evacuate and so on,   nova has to call neutron API to update the port binding with new host because neutron has no idea of  the change.\n\nI have verified the approach in https://review.openstack.org/#/c/116578/4 by  calling the new added update api in the code path of evacuating.  In my opinion, this is a very severe issue and it should be fixed as soon as possible. \n", 
            "date_created": "2014-11-16 09:28:06.783776+00:00", 
            "author": "https://api.launchpad.net/1.0/~wudx05"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/116578\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7368d9f6e9e94819b199d0f2cc1ac69706870586\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7368d9f6e9e94819b199d0f2cc1ac69706870586\nAuthor: He Jie Xu <email address hidden>\nDate:   Thu Aug 21 15:27:11 2014 +0800\n\n    Add setup/cleanup_instance_network_on_host api for neutron/nova-network\n    \n    When reschedule/unshelve/evacuate/rebuild instance, the instance\n    is moved from one host to another. The network should be updated\n    for the instance. And there are similar APIs\n    migrate_instance_start/stop, those two APIs should be used for\n    migration case as the name. So adds new APIs used to update\n    network resource when instance is moved.\n    \n    This patch implements the new APIs both for neutron and\n    nova-network.\n    \n    Change-Id: I513e0a08b32aa7f38c480488b398cd97d8cdc471\n    Related-bug: #1327124\n", 
            "date_created": "2015-01-22 04:39:49.313949+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/98340\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=05cd4824a9749c6067bb3eddc0994126d8940941\nSubmitter: Jenkins\nBranch:    master\n\ncommit 05cd4824a9749c6067bb3eddc0994126d8940941\nAuthor: He Jie Xu <email address hidden>\nDate:   Thu Aug 21 21:17:08 2014 +0800\n\n    Update network resource when rescheduling instance\n    \n    When instance building failed, compute manager will try to reschedule\n    the failed instance. If the network resource already allocated before\n    failed, the network resource need update at current compute node and\n    next compute node.\n    \n    Before rescheduling the failed instance, for nova-network with multihost,\n    because the network already setup on the compute node, the floating ip\n    should be cleanup at compute node.\n    \n    After rescheduling, because the network already allocated, then compute\n    manager won't allocate network again. For neutron, the port binding info\n    need update to new compute node. For nova-network with multihost, the\n    floating ip should be setup on the new compute node.\n    \n    Change-Id: Id4822ca0a902b35396025bde2a16411a02c46e0e\n    Closes-Bug: #1327124\n", 
            "date_created": "2015-01-22 19:39:26.794748+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/184796", 
            "date_created": "2015-05-21 14:36:20.804784+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: stable/juno\nReview: https://review.openstack.org/184801", 
            "date_created": "2015-05-21 15:13:55.065495+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Michal Jura (<email address hidden>) on branch: stable/juno\nReview: https://review.openstack.org/184796\nReason: This will no work out with Juno", 
            "date_created": "2015-05-27 08:49:43.250887+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Michal Jura (<email address hidden>) on branch: stable/juno\nReview: https://review.openstack.org/184801\nReason: This will no work out with Juno", 
            "date_created": "2015-05-27 08:50:27.790828+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: stable/juno\nReview: https://review.openstack.org/215160", 
            "date_created": "2015-08-20 14:42:38.403997+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Roman Podoliaka (<email address hidden>) on branch: stable/juno\nReview: https://review.openstack.org/215160", 
            "date_created": "2015-09-11 16:45:56.764058+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-02-05 20:14:19.219745+00:00"
}