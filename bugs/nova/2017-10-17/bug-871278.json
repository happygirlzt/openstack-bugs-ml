{
    "status": "Fix Released", 
    "last_updated": "2014-12-03 09:34:59.722355+00:00", 
    "description": "I cannot attach a volume to an instance if both are on different hosts.\n\nThis is a problem which is specific to tgt which is used on Oneiric. I file that bug in Nova (Ubuntu) and not in Nova (Openstack), even though it is not an Ubuntu packaging problem.\n\nExample:\n\nSW: OpenStack 2011.3 (Diablo) -- Package: 2011.3-0ubuntu6\nOS: Ubuntu 11.10 (Oneiric -- Beta2)\n\nnode1 (192.168.1.201): vol-00000004\nnode2 (192.168.1.202): i-00000004\n\nroot@node1:~# euca-attach-volume -i i-00000004 -d /dev/vdc vol-00000004\n\nError seen in nova-compute.log:\n\nError: iSCSI device not found at /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0\n\nExplanation:\n\nnova-compute is waiting for a device to be configured as:\n\n/dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0\n\nbut the device is configured as:\n\n/dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-1\n\nnova-compute waits for xxx-lun-0, but xxx-lun-1 is configured:\n\nroot@node2:/dev/disk/by-path# ls -l\nlrwxrwxrwx 1 root root  9 2011-10-08 22:02 ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-1 -> ../../sdd\n\nI guess this is a difference between the iet and tgt softwares used to configure iSCSI targets.\n\nOn Oneiric, tgt is used by default, and iet cannot be used because the kernel module is no more available.\n\nIn nova.conf:\n\n--iscsi_helper=tgtadm\n\nIf I adapt the code from lun-0 to lun-1, everything works well:\n\ndiff /usr/share/pyshared/nova/volume/driver.py-patched /usr/share/pyshared/nova/volume/driver.py-unpatched\n536c536\n<         mount_device = (\"/dev/disk/by-path/ip-%s-iscsi-%s-lun-1\" %\n---\n>         mount_device = (\"/dev/disk/by-path/ip-%s-iscsi-%s-lun-0\" %\n\nComplete nova-compute.log:\n\nroot@node2:~# tail -50 /var/log/nova/nova-compute.log\n2011-10-08 22:02:31,179 DEBUG nova.rpc [-] received {u'_context_roles': [u'projectmanager'], u'_context_request_id': u'8911d1d6-66eb-48eb-ab9a-f7a387d858fa', u'_context_read_deleted': False, u'args': {u'instance_id': 4, u'mountpoint': u'/dev/vdc', u'volume_id': 4}, u'_context_auth_token': None, u'_context_strategy': u'noauth', u'_context_is_admin': True, u'_context_project_id': u'project-one', u'_context_timestamp': u'2011-10-08T20:02:31.145628', u'_context_user_id': u'admin', u'method': u'attach_volume', u'_context_remote_address': u'192.168.1.201'} from (pid=1585) __call__ /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:600\n2011-10-08 22:02:31,180 DEBUG nova.rpc [-] unpacked context: {'user_id': u'admin', 'roles': [u'projectmanager'], 'timestamp': u'2011-10-08T20:02:31.145628', 'auth_token': None, 'msg_id': None, 'remote_address': u'192.168.1.201', 'strategy': u'noauth', 'is_admin': True, 'request_id': u'8911d1d6-66eb-48eb-ab9a-f7a387d858fa', 'project_id': u'project-one', 'read_deleted': False} from (pid=1585) _unpack_context /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:646\n2011-10-08 22:02:31,181 INFO nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] check_instance_lock: decorating: |<function attach_volume at 0x2946230>|\n2011-10-08 22:02:31,181 INFO nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x21e5790>| |<nova.rpc.impl_kombu.RpcContext object at 0x43fdf10>| |4|\n2011-10-08 22:02:31,181 DEBUG nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] instance 4: getting locked state from (pid=1585) get_lock /usr/lib/python2.7/dist-packages/nova/compute/manager.py:1165\n2011-10-08 22:02:31,333 INFO nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] check_instance_lock: locked: |False|\n2011-10-08 22:02:31,334 INFO nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] check_instance_lock: admin: |True|\n2011-10-08 22:02:31,334 INFO nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] check_instance_lock: executing: |<function attach_volume at 0x2946230>|\n2011-10-08 22:02:31,410 AUDIT nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] instance 4: attaching volume 4 to /dev/vdc\n2011-10-08 22:02:31,447 WARNING nova.volume.driver [-] ISCSI provider_location not stored, using discovery\n2011-10-08 22:02:31,447 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m discovery -t sendtargets -p node1 from (pid=1585) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:31,489 DEBUG nova.volume.driver [-] ISCSI Discovery: Found 192.168.1.201:3260,1 iqn.2010-10.org.openstack:volume-00000004 from (pid=1585) _get_iscsi_properties /usr/lib/python2.7/dist-packages/nova/volume/driver.py:479\n2011-10-08 22:02:31,490 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.201:3260 --login from (pid=1585) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:32,015 DEBUG nova.volume.driver [-] iscsiadm ('--login',): stdout=Logging in to [iface: default, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.201,3260]\nLogin to [iface: default, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.201,3260]: successful\n\u00a0stderr= from (pid=1585) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\n2011-10-08 22:02:32,015 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.201:3260 --op update -n node.startup -v automatic from (pid=1585) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:32,033 DEBUG nova.volume.driver [-] iscsiadm ('--op', 'update', '-n', 'node.startup', '-v', 'automatic'): stdout= stderr= from (pid=1585) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\n2011-10-08 22:02:32,033 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0. Will rescan & retry.  Try number: 0\n2011-10-08 22:02:32,034 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.201:3260 --rescan from (pid=1585) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:32,052 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 3, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.201,3260]\n\u00a0stderr= from (pid=1585) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\n2011-10-08 22:02:33,054 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0. Will rescan & retry.  Try number: 1\n2011-10-08 22:02:33,054 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.201:3260 --rescan from (pid=1585) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:33,073 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 3, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.201,3260]\n\u00a0stderr= from (pid=1585) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\n2011-10-08 22:02:37,077 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0. Will rescan & retry.  Try number: 2\n2011-10-08 22:02:37,077 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.201:3260 --rescan from (pid=1585) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:37,095 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 3, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.201,3260]\n\u00a0stderr= from (pid=1585) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\n2011-10-08 22:02:46,100 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 117, in decorated_function\n(nova.rpc): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1242, in attach_volume\n(nova.rpc): TRACE:     volume_id)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/volume/manager.py\", line 245, in setup_compute_volume\n(nova.rpc): TRACE:     path = self.driver.discover_volume(context, volume_ref)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/volume/driver.py\", line 546, in discover_volume\n(nova.rpc): TRACE:     (mount_device))\n(nova.rpc): TRACE: Error: iSCSI device not found at /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0\n(nova.rpc): TRACE:\n2011-10-08 22:03:52,889 INFO nova.compute.manager [-] Updating host status\n2011-10-08 22:05:55,440 INFO nova.compute.manager [-] Updating host status\n\nroot@node2:/dev/disk/by-path# ls -l\ntotal 0\nlrwxrwxrwx 1 root root  9 2011-10-08 22:02 ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-1 -> ../../sdd\nlrwxrwxrwx 1 root root  9 2011-10-08 20:35 pci-0000:00:1f.2-scsi-0:0:0:0 -> ../../sda\nlrwxrwxrwx 1 root root 10 2011-10-08 20:35 pci-0000:00:1f.2-scsi-0:0:0:0-part1 -> ../../sda1\nlrwxrwxrwx 1 root root 10 2011-10-08 20:35 pci-0000:00:1f.2-scsi-0:0:0:0-part2 -> ../../sda2\nlrwxrwxrwx 1 root root 10 2011-10-08 20:35 pci-0000:00:1f.2-scsi-0:0:0:0-part5 -> ../../sda5\nlrwxrwxrwx 1 root root  9 2011-10-08 20:35 pci-0000:00:1f.2-scsi-0:0:1:0 -> ../../sdb\nlrwxrwxrwx 1 root root 10 2011-10-08 21:38 pci-0000:00:1f.2-scsi-0:0:1:0-part1 -> ../../sdb1\nlrwxrwxrwx 1 root root  9 2011-10-08 20:35 pci-0000:00:1f.2-scsi-1:0:0:0 -> ../../sdc\nlrwxrwxrwx 1 root root 10 2011-10-08 20:35 pci-0000:00:1f.2-scsi-1:0:0:0-part1 -> ../../sdc1\nlrwxrwxrwx 1 root root  9 2011-10-08 20:35 pci-0000:00:1f.2-scsi-1:0:1:0 -> ../../sr0\n\nroot@node1:~#  tgtadm --lld iscsi --op show --mode target\nTarget 1: iqn.2010-10.org.openstack:volume-00000004\n\u00a0\u00a0\u00a0\u00a0System information:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Driver: iscsi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0State: ready\n\u00a0\u00a0\u00a0\u00a0I_T nexus information:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0I_T nexus: 1\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Initiator: iqn.1993-08.org.debian:01:63503b146b7\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Connection: 0\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0IP Address: 192.168.1.202 <========= initiator (i-00000004) on node2 is connected to target (vol-00000004) on node1\n\u00a0\u00a0\u00a0\u00a0LUN information:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0LUN: 0\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Type: controller\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0SCSI ID: IET     00010000\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0SCSI SN: beaf10\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Size: 0 MB, Block size: 1\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Online: Yes\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Removable media: No\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Readonly: No\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Backing store type: null\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Backing store path: None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Backing store flags:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0LUN: 1 <==================================== LUN = 1 (and not 0)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Type: disk\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0SCSI ID: IET     00010001\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0SCSI SN: beaf11\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Size: 1074 MB, Block size: 512\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Online: Yes\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Removable media: No\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Readonly: No\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Backing store type: rdwr\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Backing store path: /dev/nova-volumes/volume-00000004\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Backing store flags:\n\u00a0\u00a0\u00a0\u00a0Account information:\n\u00a0\u00a0\u00a0\u00a0ACL information:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0ALL", 
    "tags": [
        "iscsi", 
        "server-o-rs", 
        "tgt", 
        "verification-failed", 
        "volume"
    ], 
    "importance": "Medium", 
    "heat": 48, 
    "link": "https://bugs.launchpad.net/nova/+bug/871278", 
    "owner": "https://api.launchpad.net/1.0/~zulcss", 
    "id": 871278, 
    "index": 2590, 
    "openned": "2011-10-26 17:22:27.510494+00:00", 
    "created": "2011-10-09 12:56:11.186842+00:00", 
    "title": "Cannot attach volumes to instances if tgt is used", 
    "comments": [
        {
            "content": "I cannot attach a volume to an instance if both are on different hosts.\n\nThis a problem which is specific to tgt which is used on Oneiric. I file that bug in Nova (Ubuntu) and not in Nova (Openstack), even though it is not an Ubuntu packaging problem. \n\nExample:\n\nSW: OpenStack 2011.3 (Diablo) -- Package: 2011.3-0ubuntu6\nOS: Ubuntu 11.10 (Oneiric -- Beta2)\n\nnode1 (192.168.1.201): vol-00000004\nnode2 (192.168.1.202): i-00000004\n\nroot@node1:~# euca-attach-volume -i i-00000004 -d /dev/vdc vol-00000004\n\nError seen in nova-compute.log:\n\nError: iSCSI device not found at /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0\n\nExplanation: nova-compute is waiting for a device to be configured as \n\n/dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-1\n\nbut the device is configued as\n /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0\n\nnova-compute waits for xxx-lun-0, but xxx-lun-1 is configured:\n\nroot@node2:/dev/disk/by-path# ls -l\nlrwxrwxrwx 1 root root  9 2011-10-08 22:02 ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-1 -> ../../sdd\n\nI guess this is a difference between the iet and tgt softwares used to configure iSCSI targets.\n\nOn Oneiric, tgt is used by default, and iet cannot be used because the kernel module is no more available.\n\nIn nova.conf:\n\n--iscsi_helper=tgtadm\n\nIf I adapt the code from lun-0 to lun-1, everything works well:\n\ndiff /usr/share/pyshared/nova/volume/driver.py-patched /usr/share/pyshared/nova/volume/driver.py-unpatched\n536c536\n<         mount_device = (\"/dev/disk/by-path/ip-%s-iscsi-%s-lun-1\" %\n---\n>         mount_device = (\"/dev/disk/by-path/ip-%s-iscsi-%s-lun-0\" %\n\nComplete nova-compute.log:\n\nroot@node2:~# tail -50 /var/log/nova/nova-compute.log\n2011-10-08 22:02:31,179 DEBUG nova.rpc [-] received {u'_context_roles': [u'projectmanager'], u'_context_request_id': u'8911d1d6-66eb-48eb-ab9a-f7a387d858fa', u'_context_read_deleted': False, u'args': \n\n{u'instance_id': 4, u'mountpoint': u'/dev/vdc', u'volume_id': 4}, u'_context_auth_token': None, u'_context_strategy': u'noauth', u'_context_is_admin': True, u'_context_project_id': u'project-one', \n\nu'_context_timestamp': u'2011-10-08T20:02:31.145628', u'_context_user_id': u'admin', u'method': u'attach_volume', u'_context_remote_address': u'192.168.1.201'} from (pid=1585) __call__ \n\n/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:600\n2011-10-08 22:02:31,180 DEBUG nova.rpc [-] unpacked context: {'user_id': u'admin', 'roles': [u'projectmanager'], 'timestamp': u'2011-10-08T20:02:31.145628', 'auth_token': None, 'msg_id': None, \n\n'remote_address': u'192.168.1.201', 'strategy': u'noauth', 'is_admin': True, 'request_id': u'8911d1d6-66eb-48eb-ab9a-f7a387d858fa', 'project_id': u'project-one', 'read_deleted': False} from (pid=1585) \n\n_unpack_context /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:646\n2011-10-08 22:02:31,181 INFO nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] check_instance_lock: decorating: |<function attach_volume at 0x2946230>|\n2011-10-08 22:02:31,181 INFO nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x21e5790>| |\n\n<nova.rpc.impl_kombu.RpcContext object at 0x43fdf10>| |4|\n2011-10-08 22:02:31,181 DEBUG nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] instance 4: getting locked state from (pid=1585) get_lock /usr/lib/python2.7/dist-\n\npackages/nova/compute/manager.py:1165\n2011-10-08 22:02:31,333 INFO nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] check_instance_lock: locked: |False|\n2011-10-08 22:02:31,334 INFO nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] check_instance_lock: admin: |True|\n2011-10-08 22:02:31,334 INFO nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] check_instance_lock: executing: |<function attach_volume at 0x2946230>|\n2011-10-08 22:02:31,410 AUDIT nova.compute.manager [8911d1d6-66eb-48eb-ab9a-f7a387d858fa admin project-one] instance 4: attaching volume 4 to /dev/vdc\n2011-10-08 22:02:31,447 WARNING nova.volume.driver [-] ISCSI provider_location not stored, using discovery\n2011-10-08 22:02:31,447 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m discovery -t sendtargets -p node1 from (pid=1585) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:31,489 DEBUG nova.volume.driver [-] ISCSI Discovery: Found 192.168.1.201:3260,1 iqn.2010-10.org.openstack:volume-00000004 from (pid=1585) _get_iscsi_properties /usr/lib/python2.7/dist-\n\npackages/nova/volume/driver.py:479\n2011-10-08 22:02:31,490 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.201:3260 --login from (pid=1585) execute \n\n/usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:32,015 DEBUG nova.volume.driver [-] iscsiadm ('--login',): stdout=Logging in to [iface: default, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.201,3260]\nLogin to [iface: default, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.201,3260]: successful\n stderr= from (pid=1585) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\n2011-10-08 22:02:32,015 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.201:3260 --op update -n node.startup -v automatic from \n\n(pid=1585) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:32,033 DEBUG nova.volume.driver [-] iscsiadm ('--op', 'update', '-n', 'node.startup', '-v', 'automatic'): stdout= stderr= from (pid=1585) _run_iscsiadm /usr/lib/python2.7/dist-\n\npackages/nova/volume/driver.py:506\n2011-10-08 22:02:32,033 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0. Will rescan & retry.  Try \n\nnumber: 0\n2011-10-08 22:02:32,034 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.201:3260 --rescan from (pid=1585) execute \n\n/usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:32,052 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 3, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.201,3260]\n stderr= from (pid=1585) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\n2011-10-08 22:02:33,054 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0. Will rescan & retry.  Try \n\nnumber: 1\n2011-10-08 22:02:33,054 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.201:3260 --rescan from (pid=1585) execute \n\n/usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:33,073 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 3, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.201,3260]\n stderr= from (pid=1585) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\n2011-10-08 22:02:37,077 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0. Will rescan & retry.  Try \n\nnumber: 2\n2011-10-08 22:02:37,077 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.201:3260 --rescan from (pid=1585) execute \n\n/usr/lib/python2.7/dist-packages/nova/utils.py:168\n2011-10-08 22:02:37,095 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 3, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.201,3260]\n stderr= from (pid=1585) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\n2011-10-08 22:02:46,100 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 117, in decorated_function\n(nova.rpc): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1242, in attach_volume\n(nova.rpc): TRACE:     volume_id)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/volume/manager.py\", line 245, in setup_compute_volume\n(nova.rpc): TRACE:     path = self.driver.discover_volume(context, volume_ref)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/volume/driver.py\", line 546, in discover_volume\n(nova.rpc): TRACE:     (mount_device))\n(nova.rpc): TRACE: Error: iSCSI device not found at /dev/disk/by-path/ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0\n(nova.rpc): TRACE:\n2011-10-08 22:03:52,889 INFO nova.compute.manager [-] Updating host status\n2011-10-08 22:05:55,440 INFO nova.compute.manager [-] Updating host status\n\nroot@node2:/dev/disk/by-path# ls -l\ntotal 0\nlrwxrwxrwx 1 root root  9 2011-10-08 22:02 ip-192.168.1.201:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-1 -> ../../sdd\nlrwxrwxrwx 1 root root  9 2011-10-08 20:35 pci-0000:00:1f.2-scsi-0:0:0:0 -> ../../sda\nlrwxrwxrwx 1 root root 10 2011-10-08 20:35 pci-0000:00:1f.2-scsi-0:0:0:0-part1 -> ../../sda1\nlrwxrwxrwx 1 root root 10 2011-10-08 20:35 pci-0000:00:1f.2-scsi-0:0:0:0-part2 -> ../../sda2\nlrwxrwxrwx 1 root root 10 2011-10-08 20:35 pci-0000:00:1f.2-scsi-0:0:0:0-part5 -> ../../sda5\nlrwxrwxrwx 1 root root  9 2011-10-08 20:35 pci-0000:00:1f.2-scsi-0:0:1:0 -> ../../sdb\nlrwxrwxrwx 1 root root 10 2011-10-08 21:38 pci-0000:00:1f.2-scsi-0:0:1:0-part1 -> ../../sdb1\nlrwxrwxrwx 1 root root  9 2011-10-08 20:35 pci-0000:00:1f.2-scsi-1:0:0:0 -> ../../sdc\nlrwxrwxrwx 1 root root 10 2011-10-08 20:35 pci-0000:00:1f.2-scsi-1:0:0:0-part1 -> ../../sdc1\nlrwxrwxrwx 1 root root  9 2011-10-08 20:35 pci-0000:00:1f.2-scsi-1:0:1:0 -> ../../sr0\n\nroot@node1:~#  tgtadm --lld iscsi --op show --mode target\nTarget 1: iqn.2010-10.org.openstack:volume-00000004\n    System information:\n        Driver: iscsi\n        State: ready\n    I_T nexus information:\n        I_T nexus: 1\n            Initiator: iqn.1993-08.org.debian:01:63503b146b7  \n            Connection: 0\n                IP Address: 192.168.1.202 <========= initiator (i-00000004) on node2 is connected to target (vol-00000004) on node1\n    LUN information:\n        LUN: 0\n            Type: controller\n            SCSI ID: IET     00010000\n            SCSI SN: beaf10\n            Size: 0 MB, Block size: 1\n            Online: Yes\n            Removable media: No\n            Readonly: No\n            Backing store type: null\n            Backing store path: None\n            Backing store flags:\n        LUN: 1 <==================================== LUN = 1 (and not 0)\n            Type: disk\n            SCSI ID: IET     00010001\n            SCSI SN: beaf11\n            Size: 1074 MB, Block size: 512\n            Online: Yes\n            Removable media: No\n            Readonly: No\n            Backing store type: rdwr\n            Backing store path: /dev/nova-volumes/volume-00000004\n            Backing store flags:\n    Account information:\n    ACL information:\n        ALL", 
            "date_created": "2011-10-09 12:56:11.186842+00:00", 
            "author": "https://api.launchpad.net/1.0/~dodeeric"
        }, 
        {
            "content": "Thank you for the wonderfully detailed bug report.  \n\nI am intrigued why they differ by 1.. \"/ \n\nThis might need some smarter logic for us to be able to push a conditional mount_device value upstream, to support both formats.", 
            "date_created": "2011-10-09 16:54:55.196987+00:00", 
            "author": "https://api.launchpad.net/1.0/~davewalker"
        }, 
        {
            "content": "Hello Eric, or anyone else affected,\n\nAccepted nova into oneiric-proposed, the package will build now and be available in a few hours. Please test and give feedback here. See https://wiki.ubuntu.com/Testing/EnableProposed for documentation how to enable and use -proposed. Thank you in advance!", 
            "date_created": "2011-10-14 08:17:59.302940+00:00", 
            "author": "https://api.launchpad.net/1.0/~pitti"
        }, 
        {
            "content": "This bug was fixed in the package nova - 2011.3-0ubuntu7\n\n---------------\nnova (2011.3-0ubuntu7) precise; urgency=low\n\n  [Scott Moser]\n  * Removed db_pool complexities from nova.db.sqlalchemy.session (LP: #838581)\n\n  [Chuck Short]\n  * debian/patches/fix-iscsi-target-path.patch: Fix ISCSI target path patch.\n    (LP: #871278)\n  * debian/control: Either install xen-hypervisor-4.1-amd64 or\n    xen-hypervisor-4.1-i386 for nova-compute-xen. (LP: #873243)\n -- Dave Walker (Daviey) <email address hidden>   Sun, 16 Oct 2011 23:00:52 +0100", 
            "date_created": "2011-10-16 22:05:11.496679+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }, 
        {
            "content": "I do not see any difference between package 2011.3-0ubuntu6 and 2011.3-0ubuntu6.1 (oneiric-proposed). For me, it looks like the problem is still there: nova-compute is still looking for lun-0 when it should look for lun-1. lun-0 is reserved by tgt for the controler.\r\n\r\nBellow the three cases I have tested:\r\n\r\nA) instance on node2 and volume on node1: NOK\r\nB) instance and volume on node2: OK (but iSCSI not used in such case)\r\nC) instance on node1 and volume on node2: NOK\r\n\r\nCase A) and C) give the same error.\r\n\r\n---\r\n\r\nnode1: 172.17.68.16 (nova-api, nova-objectstore, nova-scheduler, nova-network, mysql, rabbitmq, glance, nova-compute, nova-volume)\r\nnode2: 172.17.68.100 (nova-compute, nova-volume)\r\n\r\nroot@node1:~# cat /etc/lsb-release \r\nDISTRIB_ID=Ubuntu\r\nDISTRIB_RELEASE=11.10\r\nDISTRIB_CODENAME=oneiric\r\nDISTRIB_DESCRIPTION=\"Ubuntu 11.10\"\r\n\r\nroot@node2:~# cat /etc/lsb-release \r\nDISTRIB_ID=Ubuntu\r\nDISTRIB_RELEASE=11.10\r\nDISTRIB_CODENAME=oneiric\r\nDISTRIB_DESCRIPTION=\"Ubuntu 11.10\"\r\n\r\nI have upgraded all the packages from oneiric-proposed (not only nova, but also open-iscsi, etc.):\r\n\r\nnode1:\r\n\r\n24 packages upgraded:\r\n\r\n[UPGRADE] initramfs-tools 0.99ubuntu7 -> 0.99ubuntu8\r\n[UPGRADE] initramfs-tools-bin 0.99ubuntu7 -> 0.99ubuntu8\r\n[UPGRADE] libgssapi-krb5-2 1.9.1+dfsg-1ubuntu1 -> 1.9.1+dfsg-1ubuntu2\r\n[UPGRADE] libk5crypto3 1.9.1+dfsg-1ubuntu1 -> 1.9.1+dfsg-1ubuntu2\r\n[UPGRADE] libkrb5-3 1.9.1+dfsg-1ubuntu1 -> 1.9.1+dfsg-1ubuntu2\r\n[UPGRADE] libkrb5support0 1.9.1+dfsg-1ubuntu1 -> 1.9.1+dfsg-1ubuntu2\r\n[UPGRADE] libpam-modules 1.1.3-2ubuntu1 -> 1.1.3-2ubuntu2\r\n[UPGRADE] libpam-modules-bin 1.1.3-2ubuntu1 -> 1.1.3-2ubuntu2\r\n[UPGRADE] libpam-runtime 1.1.3-2ubuntu1 -> 1.1.3-2ubuntu2\r\n[UPGRADE] libpam0g 1.1.3-2ubuntu1 -> 1.1.3-2ubuntu2\r\n[UPGRADE] libxenstore3.0 4.1.1-2ubuntu4 -> 4.1.1-2ubuntu4.1\r\n[UPGRADE] nova-api 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-common 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-compute 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-compute-kvm 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-doc 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-network 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-objectstore 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-scheduler 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-volume 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] open-iscsi 2.0.871-0ubuntu8 -> 2.0.871-0ubuntu9\r\n[UPGRADE] open-iscsi-utils 2.0.871-0ubuntu8 -> 2.0.871-0ubuntu9\r\n[UPGRADE] python-nova 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] update-manager-core 1:0.152.25 -> 1:0.152.25.2\r\n\r\nnode2:\r\n\r\n20 packages upgraded:\r\n\r\n[UPGRADE] initramfs-tools 0.99ubuntu7 -> 0.99ubuntu8\r\n[UPGRADE] initramfs-tools-bin 0.99ubuntu7 -> 0.99ubuntu8\r\n[UPGRADE] libgssapi-krb5-2 1.9.1+dfsg-1ubuntu1 -> 1.9.1+dfsg-1ubuntu2\r\n[UPGRADE] libk5crypto3 1.9.1+dfsg-1ubuntu1 -> 1.9.1+dfsg-1ubuntu2\r\n[UPGRADE] libkrb5-3 1.9.1+dfsg-1ubuntu1 -> 1.9.1+dfsg-1ubuntu2\r\n[UPGRADE] libkrb5support0 1.9.1+dfsg-1ubuntu1 -> 1.9.1+dfsg-1ubuntu2\r\n[UPGRADE] libpam-modules 1.1.3-2ubuntu1 -> 1.1.3-2ubuntu2\r\n[UPGRADE] libpam-modules-bin 1.1.3-2ubuntu1 -> 1.1.3-2ubuntu2\r\n[UPGRADE] libpam-runtime 1.1.3-2ubuntu1 -> 1.1.3-2ubuntu2\r\n[UPGRADE] libpam0g 1.1.3-2ubuntu1 -> 1.1.3-2ubuntu2\r\n[UPGRADE] libxenstore3.0 4.1.1-2ubuntu4 -> 4.1.1-2ubuntu4.1\r\n[UPGRADE] nova-common 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-compute 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-compute-kvm 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-doc 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] nova-volume 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] open-iscsi 2.0.871-0ubuntu8 -> 2.0.871-0ubuntu9\r\n[UPGRADE] open-iscsi-utils 2.0.871-0ubuntu8 -> 2.0.871-0ubuntu9\r\n[UPGRADE] python-nova 2011.3-0ubuntu6 -> 2011.3-0ubuntu6.1\r\n[UPGRADE] update-manager-core 1:0.152.25 -> 1:0.152.25.2\r\n\r\nroot@node1:~# nova-manage service list\r\nBinary           Host                                 Zone             Status     State Updated_At\r\nnova-scheduler   node1                                nova             enabled    :-)   2011-10-18 12:06:45\r\nnova-network     node1                                nova             enabled    :-)   2011-10-18 12:06:41\r\nnova-compute     node1                                nova             enabled    :-)   2011-10-18 12:06:46\r\nnova-volume      node1                                nova             enabled    :-)   2011-10-18 12:06:42\r\nnova-volume      node2                                nova             enabled    :-)   2011-10-18 12:06:42\r\nnova-compute     node2                                nova             enabled    :-)   2011-10-18 12:06:43\r\n\r\nroot@node1:~# dpkg -l | grep nova\r\nii  nova-api                        2011.3-0ubuntu6.1                       OpenStack Compute - API frontend\r\nii  nova-common                     2011.3-0ubuntu6.1                       OpenStack Compute - common files\r\nii  nova-compute                    2011.3-0ubuntu6.1                       OpenStack Compute - compute node\r\nii  nova-compute-kvm                2011.3-0ubuntu6.1                       OpenStack Compute - compute node (KVM)\r\nii  nova-doc                        2011.3-0ubuntu6.1                       OpenStack Compute - documetation\r\nii  nova-network                    2011.3-0ubuntu6.1                       OpenStack Compute - Network manager\r\nii  nova-objectstore                2011.3-0ubuntu6.1                       OpenStack Compute - object store\r\nii  nova-scheduler                  2011.3-0ubuntu6.1                       OpenStack Compute - virtual machine scheduler\r\nii  nova-volume                     2011.3-0ubuntu6.1                       OpenStack Compute - storage\r\nii  python-nova                     2011.3-0ubuntu6.1                       OpenStack Compute Python libraries\r\nii  python-novaclient               2.6.4~bzr112-0ubuntu1                   client library for OpenStack Compute API\r\n\r\nroot@node2:~# dpkg -l | grep nova\r\nii  nova-common                     2011.3-0ubuntu6.1                       OpenStack Compute - common files\r\nii  nova-compute                    2011.3-0ubuntu6.1                       OpenStack Compute - compute node\r\nii  nova-compute-kvm                2011.3-0ubuntu6.1                       OpenStack Compute - compute node (KVM)\r\nii  nova-doc                        2011.3-0ubuntu6.1                       OpenStack Compute - documetation\r\nii  nova-volume                     2011.3-0ubuntu6.1                       OpenStack Compute - storage\r\nii  python-nova                     2011.3-0ubuntu6.1                       OpenStack Compute Python libraries\r\nii  python-novaclient               2.6.4~bzr112-0ubuntu1                   client library for OpenStack Compute API\r\n\r\n********************************************************************************************\r\nA) instance on node2 and volume on node1: NOK\r\n********************************************************************************************\r\n\r\nroot@client:~# euca-create-volume -s 1 -z nova\r\nVOLUME  vol-00000008    1       creating (project-one, None, None, None)        2011-10-18T12:01:13Z\r\n\r\nroot@client:~# euca-describe-volumes \r\nVOLUME  vol-00000008     1              nova    available (project-one, node1, None, None)      2011-10-18T12:01:13Z\r\n\r\nroot@node1:~# lvdisplay \r\n  --- Logical volume ---\r\n  LV Name                /dev/nova-volumes/volume-00000008\r\n  VG Name                nova-volumes\r\n  LV UUID                jH5OkI-idHM-WJ4b-8lez-o2N7-L1RX-zIAT7N\r\n  LV Write Access        read/write\r\n  LV Status              available\r\n  # open                 1\r\n  LV Size                1.00 GiB\r\n  Current LE             256\r\n  Segments               1\r\n  Allocation             inherit\r\n  Read ahead sectors     auto\r\n  - currently set to     256\r\n  Block device           252:2\r\n\r\nroot@node1:~# tgtadm --lld iscsi --op show --mode target\r\nTarget 1: iqn.2010-10.org.openstack:volume-00000008\r\n    System information:\r\n        Driver: iscsi\r\n        State: ready\r\n    I_T nexus information:\r\n    LUN information:\r\n        LUN: 0\r\n            Type: controller\r\n            SCSI ID: IET     00010000\r\n            SCSI SN: beaf10\r\n            Size: 0 MB, Block size: 1\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: null\r\n            Backing store path: None\r\n            Backing store flags: \r\n        LUN: 1\r\n            Type: disk\r\n            SCSI ID: IET     00010001\r\n            SCSI SN: beaf11\r\n            Size: 1074 MB, Block size: 512\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: rdwr\r\n            Backing store path: /dev/nova-volumes/volume-00000008\r\n            Backing store flags: \r\n    Account information:\r\n    ACL information:\r\n        ALL\r\n\r\nroot@client:~# euca-describe-images\r\nIMAGE   ami-00000002    None (oneiric-server-cloudimg-amd64)            available       public          x86_64  machine aki-00000001    instance-store\r\nIMAGE   aki-00000001    None (oneiric-server-cloudimg-amd64-kernel)     available       public          x86_64  kernel                  instance-store\r\n\r\nroot@client:~# euca-run-instances -k key-dodeeric -t m1.medium ami-00000002\r\nRESERVATION     r-sr4ftljp      project-one     default\r\nINSTANCE        i-00000004      ami-00000002                    pending key-dodeeric (project-one, None)        0               m1.medium       2011-10-18T12:09:42Z unknown zone    aki-00000001    ami-00000000\r\n\r\nroot@client:~# euca-describe-instances \r\nRESERVATION     r-sr4ftljp      project-one     default\r\nINSTANCE        i-00000004      ami-00000002    10.0.1.3        10.0.1.3        running key-dodeeric (project-one, node2)       0               m1.medium   2011-10-18T12:09:42Z     nova    aki-00000001    ami-00000000\r\n\r\nroot@node1:~# euca-attach-volume -i i-00000004 -d /dev/vdd vol-00000008\r\nVOLUME  vol-00000008\r\n\r\nroot@node1:~# euca-describe-volumes \r\nVOLUME  vol-00000008     1              nova    available (project-one, node1, None, None)      2011-10-18T12:01:13Z ==========> NOK (not attached)\r\n\r\nroot@node2:~# tail -200 /var/log/nova/nova-compute.log\r\n2011-10-18 14:11:39,174 DEBUG nova.rpc [-] received {u'_context_roles': [u'projectmanager'], u'_context_request_id': u'92867742-133c-4676-baa3-27b99f013277', u'_context_read_deleted': False, u'args': {u'instance_id': 4, u'mountpoint': u'/dev/vdd', u'volume_id': 8}, u'_context_auth_token': None, u'_context_strategy': u'noauth', u'_context_is_admin': True, u'_context_project_id': u'project-one', u'_context_timestamp': u'2011-10-18T12:11:39.081979', u'_context_user_id': u'dodeeric', u'method': u'attach_volume', u'_context_remote_address': u'172.17.68.16'} from (pid=1013) __call__ /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:600\r\n2011-10-18 14:11:39,175 DEBUG nova.rpc [-] unpacked context: {'user_id': u'dodeeric', 'roles': [u'projectmanager'], 'timestamp': u'2011-10-18T12:11:39.081979', 'auth_token': None, 'msg_id': None, 'remote_address': u'172.17.68.16', 'strategy': u'noauth', 'is_admin': True, 'request_id': u'92867742-133c-4676-baa3-27b99f013277', 'project_id': u'project-one', 'read_deleted': False} from (pid=1013) _unpack_context /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:646\r\n2011-10-18 14:11:39,176 INFO nova.compute.manager [92867742-133c-4676-baa3-27b99f013277 dodeeric project-one] check_instance_lock: decorating: |<function attach_volume at 0x1e01230>|\r\n2011-10-18 14:11:39,177 INFO nova.compute.manager [92867742-133c-4676-baa3-27b99f013277 dodeeric project-one] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x16a0790>| |<nova.rpc.impl_kombu.RpcContext object at 0x3382650>| |4|\r\n2011-10-18 14:11:39,177 DEBUG nova.compute.manager [92867742-133c-4676-baa3-27b99f013277 dodeeric project-one] instance 4: getting locked state from (pid=1013) get_lock /usr/lib/python2.7/dist-packages/nova/compute/manager.py:1165\r\n2011-10-18 14:11:39,250 INFO nova.compute.manager [92867742-133c-4676-baa3-27b99f013277 dodeeric project-one] check_instance_lock: locked: |False|\r\n2011-10-18 14:11:39,251 INFO nova.compute.manager [92867742-133c-4676-baa3-27b99f013277 dodeeric project-one] check_instance_lock: admin: |True|\r\n2011-10-18 14:11:39,251 INFO nova.compute.manager [92867742-133c-4676-baa3-27b99f013277 dodeeric project-one] check_instance_lock: executing: |<function attach_volume at 0x1e01230>|\r\n2011-10-18 14:11:39,324 AUDIT nova.compute.manager [92867742-133c-4676-baa3-27b99f013277 dodeeric project-one] instance 4: attaching volume 8 to /dev/vdd\r\n2011-10-18 14:11:39,362 WARNING nova.volume.driver [-] ISCSI provider_location not stored, using discovery\r\n2011-10-18 14:11:39,363 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m discovery -t sendtargets -p node1 from (pid=1013) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:11:39,445 DEBUG nova.volume.driver [-] ISCSI Discovery: Found 172.17.68.16:3260,1 iqn.2010-10.org.openstack:volume-00000008 from (pid=1013) _get_iscsi_properties /usr/lib/python2.7/dist-packages/nova/volume/driver.py:479\r\n2011-10-18 14:11:39,447 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000008 -p 172.17.68.16:3260 --login from (pid=1013) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:11:40,011 DEBUG nova.volume.driver [-] iscsiadm ('--login',): stdout=Logging in to [iface: default, target: iqn.2010-10.org.openstack:volume-00000008, portal: 172.17.68.16,3260]\r\nLogin to [iface: default, target: iqn.2010-10.org.openstack:volume-00000008, portal: 172.17.68.16,3260]: successful\r\n stderr= from (pid=1013) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\r\n2011-10-18 14:11:40,017 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000008 -p 172.17.68.16:3260 --op update -n node.startup -v automatic from (pid=1013) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:11:40,087 DEBUG nova.volume.driver [-] iscsiadm ('--op', 'update', '-n', 'node.startup', '-v', 'automatic'): stdout= stderr= from (pid=1013) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\r\n2011-10-18 14:11:40,091 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-172.17.68.16:3260-iscsi-iqn.2010-10.org.openstack:volume-00000008-lun-0. Will rescan & retry.  Try number: 0\r\n2011-10-18 14:11:40,092 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000008 -p 172.17.68.16:3260 --rescan from (pid=1013) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:11:40,149 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 2, target: iqn.2010-10.org.openstack:volume-00000008, portal: 172.17.68.16,3260]\r\n stderr= from (pid=1013) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\r\n2011-10-18 14:11:41,153 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-172.17.68.16:3260-iscsi-iqn.2010-10.org.openstack:volume-00000008-lun-0. Will rescan & retry.  Try number: 1\r\n2011-10-18 14:11:41,154 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000008 -p 172.17.68.16:3260 --rescan from (pid=1013) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:11:41,215 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 2, target: iqn.2010-10.org.openstack:volume-00000008, portal: 172.17.68.16,3260]\r\n stderr= from (pid=1013) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\r\n2011-10-18 14:11:45,218 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-172.17.68.16:3260-iscsi-iqn.2010-10.org.openstack:volume-00000008-lun-0. Will rescan & retry.  Try number: 2\r\n2011-10-18 14:11:45,218 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000008 -p 172.17.68.16:3260 --rescan from (pid=1013) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:11:45,273 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 2, target: iqn.2010-10.org.openstack:volume-00000008, portal: 172.17.68.16,3260]\r\n stderr= from (pid=1013) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\r\n2011-10-18 14:11:54,278 ERROR nova.rpc [-] Exception during message handling\r\n(nova.rpc): TRACE: Traceback (most recent call last):\r\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\r\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\r\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 117, in decorated_function\r\n(nova.rpc): TRACE:     function(self, context, instance_id, *args, **kwargs)\r\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1242, in attach_volume\r\n(nova.rpc): TRACE:     volume_id)\r\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/volume/manager.py\", line 245, in setup_compute_volume\r\n(nova.rpc): TRACE:     path = self.driver.discover_volume(context, volume_ref)\r\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/volume/driver.py\", line 551, in discover_volume\r\n(nova.rpc): TRACE:     (mount_device))\r\n(nova.rpc): TRACE: Error: iSCSI device not found at /dev/disk/by-path/ip-172.17.68.16:3260-iscsi-iqn.2010-10.org.openstack:volume-00000008-lun-0\r\n(nova.rpc): TRACE: \r\n\r\nroot@node1:~# tgtadm --lld iscsi --op show --mode target\r\nTarget 1: iqn.2010-10.org.openstack:volume-00000008\r\n    System information:\r\n        Driver: iscsi\r\n        State: ready\r\n    I_T nexus information:\r\n        I_T nexus: 1\r\n            Initiator: iqn.1993-08.org.debian:01:dc2ba8e71e8e\r\n            Connection: 0\r\n                IP Address: 172.17.68.100 <========== OK (node2 initiator)\r\n    LUN information:\r\n        LUN: 0\r\n            Type: controller\r\n            SCSI ID: IET     00010000\r\n            SCSI SN: beaf10\r\n            Size: 0 MB, Block size: 1\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: null\r\n            Backing store path: None\r\n            Backing store flags: \r\n        LUN: 1\r\n            Type: disk\r\n            SCSI ID: IET     00010001\r\n            SCSI SN: beaf11\r\n            Size: 1074 MB, Block size: 512\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: rdwr\r\n            Backing store path: /dev/nova-volumes/volume-00000008\r\n            Backing store flags: \r\n    Account information:\r\n    ACL information:\r\n        ALL\r\n\r\nroot@node2:/dev/disk/by-path# ls -l\r\nlrwxrwxrwx 1 root root  9 2011-10-18 14:11 ip-172.17.68.16:3260-iscsi-iqn.2010-10.org.openstack:volume-00000008-lun-1 -> ../../sda <========== OK (lun-1)\r\n\r\nProblem: still looking for lun-0 when it should look for lun-1 (nova-compute problem)\r\n\r\n********************************************************************************************\r\nB) instance and volume on node2: OK\r\n********************************************************************************************\r\n\r\nroot@client:~# euca-create-volume -s 1 -z nova\r\nVOLUME  vol-00000009    1       creating (project-one, None, None, None)        2011-10-18T12:03:31Z\r\n\r\nroot@client:~# euca-describe-volumes \r\nVOLUME  vol-00000009     1              nova    available (project-one, node2, None, None)      2011-10-18T12:03:31Z\r\n\r\nroot@node2:~# lvdisplay \r\n  --- Logical volume ---\r\n  LV Name                /dev/nova-volumes/volume-00000009\r\n  VG Name                nova-volumes\r\n  LV UUID                N89fbU-xr2N-jhfc-UHJD-fLwY-m1US-vtSiCm\r\n  LV Write Access        read/write\r\n  LV Status              available\r\n  # open                 1\r\n  LV Size                1.00 GiB\r\n  Current LE             256\r\n  Segments               1\r\n  Allocation             inherit\r\n  Read ahead sectors     auto\r\n  - currently set to     256\r\n  Block device           252:2\r\n\r\nroot@node2:~# tgtadm --lld iscsi --op show --mode target\r\nTarget 1: iqn.2010-10.org.openstack:volume-00000009\r\n    System information:\r\n        Driver: iscsi\r\n        State: ready\r\n    I_T nexus information:\r\n    LUN information:\r\n        LUN: 0\r\n            Type: controller\r\n            SCSI ID: IET     00010000\r\n            SCSI SN: beaf10\r\n            Size: 0 MB, Block size: 1\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: null\r\n            Backing store path: None\r\n            Backing store flags: \r\n        LUN: 1\r\n            Type: disk\r\n            SCSI ID: IET     00010001\r\n            SCSI SN: beaf11\r\n            Size: 1074 MB, Block size: 512\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: rdwr\r\n            Backing store path: /dev/nova-volumes/volume-00000009\r\n            Backing store flags: \r\n    Account information:\r\n    ACL information:\r\n        ALL\r\n\r\nroot@client:~# euca-run-instances -k key-dodeeric -t m1.medium ami-00000002\r\n\r\nroot@client:~# euca-describe-instances \r\nRESERVATION     r-sr4ftljp      project-one     default\r\nINSTANCE        i-00000004      ami-00000002    10.0.1.3        10.0.1.3        running key-dodeeric (project-one, node2)       0               m1.medium   2011-10-18T12:09:42Z     nova    aki-00000001    ami-00000000\r\n\r\nroot@client:~# euca-attach-volume -i i-00000004 -d /dev/vdd vol-00000009\r\nVOLUME  vol-00000009\r\n\r\nroot@client:~# euca-describe-volumes \r\nVOLUME  vol-00000009     1              nova    in-use (project-one, node2, i-00000004[node2], /dev/vdd)        2011-10-18T12:03:31Z <========== OK\r\n\r\nroot@node1:~# ssh -i key-dodeeric.priv ubuntu@10.0.1.3\r\nWelcome to Ubuntu 11.10 (GNU/Linux 3.0.0-12-virtual x86_64)\r\nubuntu@server-4:~$ sudo fdisk -l\r\nDisk /dev/vdc: 1073 MB, 1073741824 bytes <========== OK (disk is seen from inside the instance)\r\n\r\nroot@node2:~# tail -200 /var/log/nova/nova-compute.log \r\n2011-10-18 14:20:11,571 DEBUG nova.rpc [-] received {u'_context_roles': [u'projectmanager'], u'_context_request_id': u'5bbce3c8-4910-4bad-89f4-763d58592a50', u'_context_read_deleted': False, u'args': {u'instance_id': 4, u'mountpoint': u'/dev/vdd', u'volume_id': 9}, u'_context_auth_token': None, u'_context_strategy': u'noauth', u'_context_is_admin': True, u'_context_project_id': u'project-one', u'_context_timestamp': u'2011-10-18T12:20:11.473531', u'_context_user_id': u'dodeeric', u'method': u'attach_volume', u'_context_remote_address': u'172.17.68.16'} from (pid=1013) __call__ /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:600\r\n2011-10-18 14:20:11,571 DEBUG nova.rpc [-] unpacked context: {'user_id': u'dodeeric', 'roles': [u'projectmanager'], 'timestamp': u'2011-10-18T12:20:11.473531', 'auth_token': None, 'msg_id': None, 'remote_address': u'172.17.68.16', 'strategy': u'noauth', 'is_admin': True, 'request_id': u'5bbce3c8-4910-4bad-89f4-763d58592a50', 'project_id': u'project-one', 'read_deleted': False} from (pid=1013) _unpack_context /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:646\r\n2011-10-18 14:20:11,572 INFO nova.compute.manager [5bbce3c8-4910-4bad-89f4-763d58592a50 dodeeric project-one] check_instance_lock: decorating: |<function attach_volume at 0x1e01230>|\r\n2011-10-18 14:20:11,573 INFO nova.compute.manager [5bbce3c8-4910-4bad-89f4-763d58592a50 dodeeric project-one] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x16a0790>| |<nova.rpc.impl_kombu.RpcContext object at 0x3526410>| |4|\r\n2011-10-18 14:20:11,573 DEBUG nova.compute.manager [5bbce3c8-4910-4bad-89f4-763d58592a50 dodeeric project-one] instance 4: getting locked state from (pid=1013) get_lock /usr/lib/python2.7/dist-packages/nova/compute/manager.py:1165\r\n2011-10-18 14:20:11,638 INFO nova.compute.manager [5bbce3c8-4910-4bad-89f4-763d58592a50 dodeeric project-one] check_instance_lock: locked: |False|\r\n2011-10-18 14:20:11,638 INFO nova.compute.manager [5bbce3c8-4910-4bad-89f4-763d58592a50 dodeeric project-one] check_instance_lock: admin: |True|\r\n2011-10-18 14:20:11,638 INFO nova.compute.manager [5bbce3c8-4910-4bad-89f4-763d58592a50 dodeeric project-one] check_instance_lock: executing: |<function attach_volume at 0x1e01230>|\r\n2011-10-18 14:20:11,705 AUDIT nova.compute.manager [5bbce3c8-4910-4bad-89f4-763d58592a50 dodeeric project-one] instance 4: attaching volume 9 to /dev/vdd\r\n\r\nroot@node2:~# tgtadm --lld iscsi --op show --mode target <========== OK (no initiator connected: iSCSI not used if instance and volume on the same node)\r\nTarget 1: iqn.2010-10.org.openstack:volume-00000009\r\n    System information:\r\n        Driver: iscsi\r\n        State: ready\r\n    I_T nexus information:\r\n    LUN information:\r\n        LUN: 0\r\n            Type: controller\r\n            SCSI ID: IET     00010000\r\n            SCSI SN: beaf10\r\n            Size: 0 MB, Block size: 1\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: null\r\n            Backing store path: None\r\n            Backing store flags: \r\n        LUN: 1\r\n            Type: disk\r\n            SCSI ID: IET     00010001\r\n            SCSI SN: beaf11\r\n            Size: 1074 MB, Block size: 512\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: rdwr\r\n            Backing store path: /dev/nova-volumes/volume-00000009\r\n            Backing store flags: \r\n    Account information:\r\n    ACL information:\r\n        ALL\r\n\r\n********************************************************************************************\r\nC) instance on node1 and volume on node2: NOK\r\n********************************************************************************************\r\n\r\nroot@client:~# euca-create-volume -s 1 -z nova\r\nVOLUME  vol-0000000a    1       creating (project-one, None, None, None)        2011-10-18T12:30:46Z\r\n\r\nroot@client:~# euca-describe-volumes \r\nVOLUME  vol-0000000a     1              nova    available (project-one, node2, None, None)      2011-10-18T12:30:46Z\r\n\r\nroot@node2:~# lvdisplay \r\n  --- Logical volume ---\r\n  LV Name                /dev/nova-volumes/volume-0000000a\r\n  VG Name                nova-volumes\r\n  LV UUID                HCdftL-bTeB-KwNE-yb83-mqKT-eO9d-IuHC2v\r\n  LV Write Access        read/write\r\n  LV Status              available\r\n  # open                 1\r\n  LV Size                1.00 GiB\r\n  Current LE             256\r\n  Segments               1\r\n  Allocation             inherit\r\n  Read ahead sectors     auto\r\n  - currently set to     256\r\n  Block device           252:3\r\n\r\nroot@node2:~# tgtadm --lld iscsi --op show --mode target\r\nTarget 2: iqn.2010-10.org.openstack:volume-0000000a\r\n    System information:\r\n        Driver: iscsi\r\n        State: ready\r\n    I_T nexus information:\r\n    LUN information:\r\n        LUN: 0\r\n            Type: controller\r\n            SCSI ID: IET     00020000\r\n            SCSI SN: beaf20\r\n            Size: 0 MB, Block size: 1\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: null\r\n            Backing store path: None\r\n            Backing store flags: \r\n        LUN: 1\r\n            Type: disk\r\n            SCSI ID: IET     00020001\r\n            SCSI SN: beaf21\r\n            Size: 1074 MB, Block size: 512\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: rdwr\r\n            Backing store path: /dev/nova-volumes/volume-0000000a\r\n            Backing store flags: \r\n    Account information:\r\n    ACL information:\r\n        ALL\r\n\r\nroot@client:~# euca-run-instances -k key-dodeeric -t m1.medium ami-00000002\r\nRESERVATION     r-tmxplzvs      project-one     default\r\nINSTANCE        i-00000008      ami-00000002                    pending key-dodeeric (project-one, None)        0               m1.medium       2011-10-18T12:37:25Z unknown zone    aki-00000001    ami-00000000\r\n\r\nroot@client:~# euca-describe-instances \r\nINSTANCE        i-00000008      ami-00000002    10.0.1.7        10.0.1.7        running key-dodeeric (project-one, node1)       0               m1.medium   2011-10-18T12:37:25Z     nova    aki-00000001    ami-00000000\r\n\r\nroot@client:~# euca-attach-volume -i i-00000008 -d /dev/vdd vol-0000000a\r\nVOLUME  vol-0000000a\r\n\r\nroot@client:~# euca-describe-volumes \r\nVOLUME  vol-0000000a     1              nova    available (project-one, node2, None, None)      2011-10-18T12:30:46Z <========== NOK (not attached)\r\n\r\nroot@node2:~# tgtadm --lld iscsi --op show --mode target\r\nTarget 2: iqn.2010-10.org.openstack:volume-0000000a\r\n    System information:\r\n        Driver: iscsi\r\n        State: ready\r\n    I_T nexus information:\r\n        I_T nexus: 1\r\n            Initiator: iqn.1993-08.org.debian:01:2e5ee63e3872\r\n            Connection: 0\r\n                IP Address: 172.17.68.16 <========== OK (node1 initiator)\r\n    LUN information:\r\n        LUN: 0\r\n            Type: controller\r\n            SCSI ID: IET     00020000\r\n            SCSI SN: beaf20\r\n            Size: 0 MB, Block size: 1\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: null\r\n            Backing store path: None\r\n            Backing store flags: \r\n        LUN: 1\r\n            Type: disk\r\n            SCSI ID: IET     00020001\r\n            SCSI SN: beaf21\r\n            Size: 1074 MB, Block size: 512\r\n            Online: Yes\r\n            Removable media: No\r\n            Readonly: No\r\n            Backing store type: rdwr\r\n            Backing store path: /dev/nova-volumes/volume-0000000a\r\n            Backing store flags: \r\n    Account information:\r\n    ACL information:\r\n        ALL\r\n\r\nroot@node1:/dev/disk/by-path# ls -l\r\nlrwxrwxrwx 1 root root  9 2011-10-18 14:39 ip-172.17.68.100:3260-iscsi-iqn.2010-10.org.openstack:volume-0000000a-lun-1 -> ../../sda <========== OK\r\n\r\nroot@node1:~# tail -200 /var/log/nova/nova-compute.log\r\n2011-10-18 14:39:25,519 DEBUG nova.rpc [-] received {u'_context_roles': [u'projectmanager'], u'_context_request_id': u'0e1d4934-97f8-4115-83aa-7d08f5e92f32', u'_context_read_deleted': False, u'args': {u'instance_id': 8, u'mountpoint': u'/dev/vdd', u'volume_id': 10}, u'_context_auth_token': None, u'_context_strategy': u'noauth', u'_context_is_admin': True, u'_context_project_id': u'project-one', u'_context_timestamp': u'2011-10-18T12:39:25.401601', u'_context_user_id': u'dodeeric', u'method': u'attach_volume', u'_context_remote_address': u'172.17.68.16'} from (pid=1743) __call__ /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:600\r\n2011-10-18 14:39:25,519 DEBUG nova.rpc [-] unpacked context: {'user_id': u'dodeeric', 'roles': [u'projectmanager'], 'timestamp': u'2011-10-18T12:39:25.401601', 'auth_token': None, 'msg_id': None, 'remote_address': u'172.17.68.16', 'strategy': u'noauth', 'is_admin': True, 'request_id': u'0e1d4934-97f8-4115-83aa-7d08f5e92f32', 'project_id': u'project-one', 'read_deleted': False} from (pid=1743) _unpack_context /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:646\r\n2011-10-18 14:39:25,520 INFO nova.compute.manager [0e1d4934-97f8-4115-83aa-7d08f5e92f32 dodeeric project-one] check_instance_lock: decorating: |<function attach_volume at 0x2848230>|\r\n2011-10-18 14:39:25,521 INFO nova.compute.manager [0e1d4934-97f8-4115-83aa-7d08f5e92f32 dodeeric project-one] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x20e77d0>| |<nova.rpc.impl_kombu.RpcContext object at 0x4068e90>| |8|\r\n2011-10-18 14:39:25,521 DEBUG nova.compute.manager [0e1d4934-97f8-4115-83aa-7d08f5e92f32 dodeeric project-one] instance 8: getting locked state from (pid=1743) get_lock /usr/lib/python2.7/dist-packages/nova/compute/manager.py:1165\r\n2011-10-18 14:39:25,648 INFO nova.compute.manager [0e1d4934-97f8-4115-83aa-7d08f5e92f32 dodeeric project-one] check_instance_lock: locked: |False|\r\n2011-10-18 14:39:25,649 INFO nova.compute.manager [0e1d4934-97f8-4115-83aa-7d08f5e92f32 dodeeric project-one] check_instance_lock: admin: |True|\r\n2011-10-18 14:39:25,649 INFO nova.compute.manager [0e1d4934-97f8-4115-83aa-7d08f5e92f32 dodeeric project-one] check_instance_lock: executing: |<function attach_volume at 0x2848230>|\r\n2011-10-18 14:39:25,712 AUDIT nova.compute.manager [0e1d4934-97f8-4115-83aa-7d08f5e92f32 dodeeric project-one] instance 8: attaching volume 10 to /dev/vdd\r\n2011-10-18 14:39:25,753 WARNING nova.volume.driver [-] ISCSI provider_location not stored, using discovery\r\n2011-10-18 14:39:25,753 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m discovery -t sendtargets -p node2 from (pid=1743) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:39:25,967 DEBUG nova.volume.driver [-] ISCSI Discovery: Found 172.17.68.100:3260,1 iqn.2010-10.org.openstack:volume-0000000a from (pid=1743) _get_iscsi_properties /usr/lib/python2.7/dist-packages/nova/volume/driver.py:479\r\n2011-10-18 14:39:25,970 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-0000000a -p 172.17.68.100:3260 --login from (pid=1743) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:39:26,576 DEBUG nova.volume.driver [-] iscsiadm ('--login',): stdout=Logging in to [iface: default, target: iqn.2010-10.org.openstack:volume-0000000a, portal: 172.17.68.100,3260]\r\nLogin to [iface: default, target: iqn.2010-10.org.openstack:volume-0000000a, portal: 172.17.68.100,3260]: successful\r\n stderr= from (pid=1743) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\r\n2011-10-18 14:39:26,581 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-0000000a -p 172.17.68.100:3260 --op update -n node.startup -v automatic from (pid=1743) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:39:26,667 DEBUG nova.volume.driver [-] iscsiadm ('--op', 'update', '-n', 'node.startup', '-v', 'automatic'): stdout= stderr= from (pid=1743) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\r\n2011-10-18 14:39:26,669 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-172.17.68.100:3260-iscsi-iqn.2010-10.org.openstack:volume-0000000a-lun-0. Will rescan & retry.  Try number: 0\r\n2011-10-18 14:39:26,679 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-0000000a -p 172.17.68.100:3260 --rescan from (pid=1743) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:39:26,783 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 2, target: iqn.2010-10.org.openstack:volume-0000000a, portal: 172.17.68.100,3260]\r\n stderr= from (pid=1743) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\r\n2011-10-18 14:39:27,786 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-172.17.68.100:3260-iscsi-iqn.2010-10.org.openstack:volume-0000000a-lun-0. Will rescan & retry.  Try number: 1\r\n2011-10-18 14:39:27,787 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-0000000a -p 172.17.68.100:3260 --rescan from (pid=1743) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:39:27,845 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 2, target: iqn.2010-10.org.openstack:volume-0000000a, portal: 172.17.68.100,3260]\r\n stderr= from (pid=1743) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\r\n2011-10-18 14:39:31,849 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-172.17.68.100:3260-iscsi-iqn.2010-10.org.openstack:volume-0000000a-lun-0. Will rescan & retry.  Try number: 2\r\n2011-10-18 14:39:31,850 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-0000000a -p 172.17.68.100:3260 --rescan from (pid=1743) execute /usr/lib/python2.7/dist-packages/nova/utils.py:168\r\n2011-10-18 14:39:31,902 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 2, target: iqn.2010-10.org.openstack:volume-0000000a, portal: 172.17.68.100,3260]\r\n stderr= from (pid=1743) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:506\r\n2011-10-18 14:39:40,908 ERROR nova.rpc [-] Exception during message handling\r\n(nova.rpc): TRACE: Traceback (most recent call last):\r\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\r\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\r\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 117, in decorated_function\r\n(nova.rpc): TRACE:     function(self, context, instance_id, *args, **kwargs)\r\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1242, in attach_volume\r\n(nova.rpc): TRACE:     volume_id)\r\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/volume/manager.py\", line 245, in setup_compute_volume\r\n(nova.rpc): TRACE:     path = self.driver.discover_volume(context, volume_ref)\r\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/volume/driver.py\", line 551, in discover_volume\r\n(nova.rpc): TRACE:     (mount_device))\r\n(nova.rpc): TRACE: Error: iSCSI device not found at /dev/disk/by-path/ip-172.17.68.100:3260-iscsi-iqn.2010-10.org.openstack:volume-0000000a-lun-0\r\n(nova.rpc): TRACE: \r\n\r\n---\r\n\r\nOn a platform where both nodes are running natty and iet (and not tgt), nova-compute searchs for lun-0 and find it: the volume can be attached correctly to the instance:\r\n\r\nroot@node1:~# euca-describe-instances \r\nRESERVATION     r-jzwo7bdc      project-toc     group-toc\r\nINSTANCE        i-0000001c      ami-00000019    192.168.1.240   10.0.3.3        running key-dodeeric (project-toc, node1)       0               a1.medium   2011-10-14T08:35:23Z     nova    aki-00000005    ari-00000006\r\n\r\nroot@node1:~# euca-describe-volumes \r\nVOLUME  vol-00000004     5              nova    in-use (project-toc, node2, i-0000001c[node1], /dev/vdd)        2011-10-11T10:13:07Z\r\n\r\nroot@node1:/var/log/nova# zgrep -i \"2011-10-14 10:40:5\" nova-compute.log.4 \r\n2011-10-14 10:40:58,648 DEBUG nova.rpc [-] received {u'_context_roles': [u'projectmanager'], u'_context_request_id': u'0ce80ca4-c77f-40e7-8366-9bdcc14f1c32', u'_context_read_deleted': False, u'args': {u'instance_id': 28, u'mountpoint': u'/dev/vdd', u'volume_id': 4}, u'_context_auth_token': None, u'_context_strategy': u'noauth', u'_context_is_admin': False, u'_context_project_id': u'project-toc', u'_context_timestamp': u'2011-10-14T08:40:58.552407', u'_context_user_id': u'dodeeric', u'method': u'attach_volume', u'_context_remote_address': u'192.168.1.201'} from (pid=2608) __call__ /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:600\r\n2011-10-14 10:40:58,648 DEBUG nova.rpc [-] unpacked context: {'user_id': u'dodeeric', 'roles': [u'projectmanager'], 'timestamp': u'2011-10-14T08:40:58.552407', 'auth_token': None, 'msg_id': None, 'remote_address': u'192.168.1.201', 'strategy': u'noauth', 'is_admin': False, 'request_id': u'0ce80ca4-c77f-40e7-8366-9bdcc14f1c32', 'project_id': u'project-toc', 'read_deleted': False} from (pid=2608) _unpack_context /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:646\r\n2011-10-14 10:40:58,649 INFO nova.compute.manager [0ce80ca4-c77f-40e7-8366-9bdcc14f1c32 dodeeric project-toc] check_instance_lock: decorating: |<function attach_volume at 0x2ce6230>|\r\n2011-10-14 10:40:58,650 INFO nova.compute.manager [0ce80ca4-c77f-40e7-8366-9bdcc14f1c32 dodeeric project-toc] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x259fbd0>| |<nova.rpc.impl_kombu.RpcContext object at 0x45adc50>| |28|\r\n2011-10-14 10:40:58,650 DEBUG nova.compute.manager [0ce80ca4-c77f-40e7-8366-9bdcc14f1c32 dodeeric project-toc] instance 28: getting locked state from (pid=2608) get_lock /usr/lib/python2.7/dist-packages/nova/compute/manager.py:1165\r\n2011-10-14 10:40:58,709 INFO nova.compute.manager [0ce80ca4-c77f-40e7-8366-9bdcc14f1c32 dodeeric project-toc] check_instance_lock: locked: |False|\r\n2011-10-14 10:40:58,709 INFO nova.compute.manager [0ce80ca4-c77f-40e7-8366-9bdcc14f1c32 dodeeric project-toc] check_instance_lock: admin: |False|\r\n2011-10-14 10:40:58,709 INFO nova.compute.manager [0ce80ca4-c77f-40e7-8366-9bdcc14f1c32 dodeeric project-toc] check_instance_lock: executing: |<function attach_volume at 0x2ce6230>|\r\n2011-10-14 10:40:58,745 AUDIT nova.compute.manager [0ce80ca4-c77f-40e7-8366-9bdcc14f1c32 dodeeric project-toc] instance 28: attaching volume 4 to /dev/vdd\r\n2011-10-14 10:40:58,762 WARNING nova.volume.driver [-] ISCSI provider_location not stored, using discovery\r\n2011-10-14 10:40:58,762 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m discovery -t sendtargets -p node2 from (pid=2608) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\r\n2011-10-14 10:40:58,793 DEBUG nova.volume.driver [-] ISCSI Discovery: Found 192.168.1.202:3260,1 iqn.2010-10.org.openstack:volume-00000004 from (pid=2608) _get_iscsi_properties /usr/lib/python2.7/dist-packages/nova/volume/driver.py:487\r\n2011-10-14 10:40:58,794 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.202:3260 --login from (pid=2608) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\r\n2011-10-14 10:40:59,323 DEBUG nova.volume.driver [-] iscsiadm ('--login',): stdout=Logging in to [iface: default, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.202,3260]\r\n2011-10-14 10:40:59,324 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.202:3260 --op update -n node.startup -v automatic from (pid=2608) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\r\n2011-10-14 10:40:59,345 DEBUG nova.volume.driver [-] iscsiadm ('--op', 'update', '-n', 'node.startup', '-v', 'automatic'): stdout= stderr= from (pid=2608) _run_iscsiadm /usr/lib/python2.7/dist-packages/nova/volume/driver.py:514\r\n2011-10-14 10:40:59,346 WARNING nova.volume.driver [-] ISCSI volume not yet found at: /dev/disk/by-path/ip-192.168.1.202:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0. Will rescan & retry.  Try number: 0\r\n2011-10-14 10:40:59,346 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-00000004 -p 192.168.1.202:3260 --rescan from (pid=2608) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\r\n2011-10-14 10:40:59,366 DEBUG nova.volume.driver [-] iscsiadm ('--rescan',): stdout=Rescanning session [sid: 1, target: iqn.2010-10.org.openstack:volume-00000004, portal: 192.168.1.202,3260]\r\n2011-10-14 10:40:59,367 DEBUG nova.volume.driver [-] Found iSCSI node /dev/disk/by-path/ip-192.168.1.202:3260-iscsi-iqn.2010-10.org.openstack:volume-00000004-lun-0 (after 1 rescans) from (pid=2608) discover_volume /usr/lib/python2.7/dist-packages/nova/volume/driver.py:570", 
            "date_created": "2011-10-18 13:26:33.903200+00:00", 
            "author": "https://api.launchpad.net/1.0/~dodeeric"
        }, 
        {
            "content": "I have the same problem, when I attach a volume, it also show:\r\n\"Error: iSCSI device not found at /dev/disk/by-path/ip-10.200.200.4:3260-iscsi-iqn.2010-10.org.openstack:volume-00000001-lun-0\"\r\n\r\nmy version is\r\n2012.1-dev (2012.1-LOCALBRANCH:LOCALREVISION)", 
            "date_created": "2011-10-25 02:26:16.893449+00:00", 
            "author": "https://api.launchpad.net/1.0/~mwjpiero"
        }, 
        {
            "content": "I have modified three fils:\r\n\r\n/usr/local/lib/python2.7/dist-packages/nova/virt/libvirt/volume.py\r\nnova/volume/driver.py\r\nnova/virt/libvirt/volume.py\r\n\r\nchange lun0->lun1\r\n\r\n- host_device = (\"/dev/disk/by-path/ip-%s-iscsi-%s-lun-0\"\r\n+ host_device = (\"/dev/disk/by-path/ip-%s-iscsi-%s-lun-1\"\r\n\r\nit works well. but are the developer ready to fix this bugs", 
            "date_created": "2011-10-25 07:02:51.672985+00:00", 
            "author": "https://api.launchpad.net/1.0/~mwjpiero"
        }, 
        {
            "content": "oneiric-proposed has been superseded by the 2011.3-0ubuntu6.2 security update.", 
            "date_created": "2011-10-25 17:15:29.308587+00:00", 
            "author": "https://api.launchpad.net/1.0/~jdstrand"
        }, 
        {
            "content": "Just ran into this issue myself.\n\nOpenstack is looking for lun-0, but the device shows up on my Oneiric install as lun-1.\n\nHave subscribed to bug report...hopefully looking for an update here.", 
            "date_created": "2011-11-03 18:16:11.576208+00:00", 
            "author": "https://api.launchpad.net/1.0/~nkoterba"
        }, 
        {
            "content": "Fix proposed here: https://review.openstack.org/1113", 
            "date_created": "2011-11-15 12:09:21.577232+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2296\nCommitted: http://github.com/openstack/nova/commit/15cc877cc2af71135b896974f17cb4a63291a08c\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit 15cc877cc2af71135b896974f17cb4a63291a08c\nAuthor: Chuck Short <email address hidden>\nDate:   Tue Dec 13 13:45:43 2011 -0500\n\n    Fix tgtadm off by one error. Fixes bug #871278\n    \n    Change-Id: Ia359045465ada9753b86d1a08cc947966b3ac899\n    Signed-off-by: Chuck Short <email address hidden>\n", 
            "date_created": "2011-12-14 08:42:25+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "This bug was fixed in the package nova - 2012.1~e2-0ubuntu1\n\n---------------\nnova (2012.1~e2-0ubuntu1) precise; urgency=low\n\n  * New usptream release. Fixes the following bugs:\n    (LP: #871278, #848643, #859679, #83199)\n  * debian/nova-console.install: Fix empty package.\n  * debian/patches, debian/pydist-overrides: Cleaner way\n    of disabling unwanted python-dependencies.\n  * debian/control:\n    - Suggest python-keystone. (LP: #901881)\n    - Update build dependencies.\n  * debian/nova.conf: Use virtio networking by default.\n    (LP: #904480)\n  * debian/fix-traversal-via-image-register.patch: Dropped\n    fixed upstream.\n -- Chuck Short <email address hidden>   Fri, 16 Dec 2011 13:03:55 -0500", 
            "date_created": "2011-12-16 18:40:14.121714+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }, 
        {
            "content": "Fix was merged into master", 
            "date_created": "2012-01-13 10:13:09.475797+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "This is still occurring in oneiric with diablo, could someone spin a new pkg that isn't superseded by the 2011.3-0ubuntu6.2 security update?\n\nThanks!", 
            "date_created": "2012-03-09 14:26:59.135731+00:00", 
            "author": "https://api.launchpad.net/1.0/~tellis"
        }, 
        {
            "content": "I had to modify the original patch a little to to get it to work (set it to 1 instead of 0 for tgt):\nhttp://paste.ubuntu.com/876094/\n\nFor essex, I see driver.py has changed anyway and now has that fix in the iscsi.py helper script.", 
            "date_created": "2012-03-09 14:59:31.485722+00:00", 
            "author": "https://api.launchpad.net/1.0/~tellis"
        }, 
        {
            "content": "oneiric has seen the end of its life and is no longer receiving any updates. Marking the oneiric task for this ticket as \"Won't Fix\".", 
            "date_created": "2014-12-03 09:34:53.407456+00:00", 
            "author": "https://api.launchpad.net/1.0/~r0lf"
        }
    ], 
    "closed": "2012-01-25 09:54:04.466001+00:00"
}