{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:35:15.915402+00:00", 
    "description": "The following behavior has been reported:\n\nImages are set up so that the root partition is on the /dev/xvda device, and swap is on /dev/xvdc:\n\nroot@singularity:~# ll /dev/xv*\nbrw-rw---- 1 root disk 202,  0 Sep  6 20:03 /dev/xvda\nbrw-rw---- 1 root disk 202,  1 Sep  6 20:03 /dev/xvda1\nbrw-rw---- 1 root disk 202, 32 Sep  6 20:03 /dev/xvdc\nbrw-rw---- 1 root disk 202, 33 Sep  6 20:03 /dev/xvdc1\n\nAttach a volume:\n\nadr-ego:~$ supernova dfw volume-attach SERVER_ID 1411650e-45e8-4cd4-ae80-f27452072b82 auto\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | None                                 |\n| id       | 1411650e-45e8-4cd4-ae80-f27452072b82 |\n| serverId | 38d17e58-ec60-41ca-84ba-e5ea48c9e1ef |\n| volumeId | 1411650e-45e8-4cd4-ae80-f27452072b82 |\n+----------+--------------------------------------+\n\nA few moments later, I see this:\n\nroot@singularity:~# ll /dev/xv*\nbrw-rw---- 1 root disk 202,  0 Sep  6 20:03 /dev/xvda\nbrw-rw---- 1 root disk 202,  1 Sep  6 20:03 /dev/xvda1\nbrw-rw---- 1 root disk 202, 16 Sep 21 15:46 /dev/xvdb  <=== new volume\nbrw-rw---- 1 root disk 202, 32 Sep  6 20:03 /dev/xvdc\nbrw-rw---- 1 root disk 202, 33 Sep  6 20:03 /dev/xvdc1\n\nCool beans.  Now to attach another\u2026..\n\nadr-ego:~$ supernova dfw volume-attach SERVER_ID 0cb2b905-208c-41f7-839c-df5ee1a259f0 auto\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | None                                 |\n| id       | 0cb2b905-208c-41f7-839c-df5ee1a259f0 |\n| serverId | 38d17e58-ec60-41ca-84ba-e5ea48c9e1ef |\n| volumeId | 0cb2b905-208c-41f7-839c-df5ee1a259f0 |\n+----------+--------------------------------------+\n\nThe volume fails to attach, and the following error is in the logs (Ths is Xenserver):\n\nUnable to use SR OpaqueRef:a2d2dea8-eab2-7845-3cf2-969daa9da5a2 for instance instance-38d17e58-ec60-41ca-84ba-e5ea48c9e1ef\n\nIt would appear that it is trying to auto-attach to /dev/xvdc even though it is already in use, and just to verify:\n\nadr-ego:~$ supernova dfw volume-attach SERVER_ID 0cb2b905-208c-41f7-839c-df5ee1a259f0 /dev/sdd\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | None                                 |\n| id       | 0cb2b905-208c-41f7-839c-df5ee1a259f0 |\n| serverId | 38d17e58-ec60-41ca-84ba-e5ea48c9e1ef |\n| volumeId | 0cb2b905-208c-41f7-839c-df5ee1a259f0 |\n+----------+--------------------------------------+\n\nMoments later, it showed up on the guest as expected:\n\nroot@singularity:~# ll /dev/xv*\nbrw-rw---- 1 root disk 202,  0 Sep  6 20:03 /dev/xvda\nbrw-rw---- 1 root disk 202,  1 Sep  6 20:03 /dev/xvda1\nbrw-rw---- 1 root disk 202, 16 Sep 21 15:46 /dev/xvdb\nbrw-rw---- 1 root disk 202, 32 Sep  6 20:03 /dev/xvdc\nbrw-rw---- 1 root disk 202, 33 Sep  6 20:03 /dev/xvdc1\nbrw-rw---- 1 root disk 202, 48 Sep 21 16:07 /dev/xvdd  <=== new volume\n\nHoping that I have now forced it to start counting from the correct point, I tried to auto-attach another volume:\n\nadr-ego:~$ supernova dfw volume-attach SERVER_ID 302bf831-b11e-4396-bd3b-42301b074eda auto\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | None                                 |\n| id       | 302bf831-b11e-4396-bd3b-42301b074eda |\n| serverId | 38d17e58-ec60-41ca-84ba-e5ea48c9e1ef |\n| volumeId | 302bf831-b11e-4396-bd3b-42301b074eda |\n+----------+--------------------------------------+\n\nNope, generated another fault, with the same error.\n\nIt seems that the \"auto\" method of selecting a guest block device needs to be a little smarter, and take into consideration what the default volumes are called.", 
    "tags": [], 
    "importance": "High", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1055712", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 1055712, 
    "index": 830, 
    "openned": "2012-09-24 19:05:31.795946+00:00", 
    "created": "2012-09-24 19:05:31.795946+00:00", 
    "title": "Volume auto attach can fail if there is a swap or ephemeral device", 
    "comments": [
        {
            "content": "The following behavior has been reported:\n\nImages are set up so that the root partition is on the /dev/xvda device, and swap is on /dev/xvdc:\n\nroot@singularity:~# ll /dev/xv*\nbrw-rw---- 1 root disk 202,  0 Sep  6 20:03 /dev/xvda\nbrw-rw---- 1 root disk 202,  1 Sep  6 20:03 /dev/xvda1\nbrw-rw---- 1 root disk 202, 32 Sep  6 20:03 /dev/xvdc\nbrw-rw---- 1 root disk 202, 33 Sep  6 20:03 /dev/xvdc1\n\nAttach a volume:\n\nadr-ego:~$ supernova dfw volume-attach SERVER_ID 1411650e-45e8-4cd4-ae80-f27452072b82 auto\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | None                                 |\n| id       | 1411650e-45e8-4cd4-ae80-f27452072b82 |\n| serverId | 38d17e58-ec60-41ca-84ba-e5ea48c9e1ef |\n| volumeId | 1411650e-45e8-4cd4-ae80-f27452072b82 |\n+----------+--------------------------------------+\n\nA few moments later, I see this:\n\nroot@singularity:~# ll /dev/xv*\nbrw-rw---- 1 root disk 202,  0 Sep  6 20:03 /dev/xvda\nbrw-rw---- 1 root disk 202,  1 Sep  6 20:03 /dev/xvda1\nbrw-rw---- 1 root disk 202, 16 Sep 21 15:46 /dev/xvdb  <=== new volume\nbrw-rw---- 1 root disk 202, 32 Sep  6 20:03 /dev/xvdc\nbrw-rw---- 1 root disk 202, 33 Sep  6 20:03 /dev/xvdc1\n\nCool beans.  Now to attach another\u2026..\n\nadr-ego:~$ supernova dfw volume-attach SERVER_ID 0cb2b905-208c-41f7-839c-df5ee1a259f0 auto\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | None                                 |\n| id       | 0cb2b905-208c-41f7-839c-df5ee1a259f0 |\n| serverId | 38d17e58-ec60-41ca-84ba-e5ea48c9e1ef |\n| volumeId | 0cb2b905-208c-41f7-839c-df5ee1a259f0 |\n+----------+--------------------------------------+\n\nThe volume fails to attach, and the following error is in the logs (Ths is Xenserver):\n\nUnable to use SR OpaqueRef:a2d2dea8-eab2-7845-3cf2-969daa9da5a2 for instance instance-38d17e58-ec60-41ca-84ba-e5ea48c9e1ef\n\nIt would appear that it is trying to auto-attach to /dev/xvdc even though it is already in use, and just to verify:\n\nadr-ego:~$ supernova dfw volume-attach SERVER_ID 0cb2b905-208c-41f7-839c-df5ee1a259f0 /dev/sdd\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | None                                 |\n| id       | 0cb2b905-208c-41f7-839c-df5ee1a259f0 |\n| serverId | 38d17e58-ec60-41ca-84ba-e5ea48c9e1ef |\n| volumeId | 0cb2b905-208c-41f7-839c-df5ee1a259f0 |\n+----------+--------------------------------------+\n\nMoments later, it showed up on the guest as expected:\n\nroot@singularity:~# ll /dev/xv*\nbrw-rw---- 1 root disk 202,  0 Sep  6 20:03 /dev/xvda\nbrw-rw---- 1 root disk 202,  1 Sep  6 20:03 /dev/xvda1\nbrw-rw---- 1 root disk 202, 16 Sep 21 15:46 /dev/xvdb\nbrw-rw---- 1 root disk 202, 32 Sep  6 20:03 /dev/xvdc\nbrw-rw---- 1 root disk 202, 33 Sep  6 20:03 /dev/xvdc1\nbrw-rw---- 1 root disk 202, 48 Sep 21 16:07 /dev/xvdd  <=== new volume\n\nHoping that I have now forced it to start counting from the correct point, I tried to auto-attach another volume:\n\nadr-ego:~$ supernova dfw volume-attach SERVER_ID 302bf831-b11e-4396-bd3b-42301b074eda auto\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | None                                 |\n| id       | 302bf831-b11e-4396-bd3b-42301b074eda |\n| serverId | 38d17e58-ec60-41ca-84ba-e5ea48c9e1ef |\n| volumeId | 302bf831-b11e-4396-bd3b-42301b074eda |\n+----------+--------------------------------------+\n\nNope, generated another fault, with the same error.\n\nIt seems that the \"auto\" method of selecting a guest block device needs to be a little smarter, and take into consideration what the default volumes are called.", 
            "date_created": "2012-09-24 19:05:31.795946+00:00", 
            "author": "https://api.launchpad.net/1.0/~cthier"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/13649", 
            "date_created": "2012-09-25 18:23:50.850907+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/13649\nCommitted: http://github.com/openstack/nova/commit/69564763960cddc249138469811a0a771db16e19\nSubmitter: Jenkins\nBranch:    master\n\ncommit 69564763960cddc249138469811a0a771db16e19\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Tue Sep 25 11:15:14 2012 -0700\n\n    Fix issues with device autoassignment in xenapi\n    \n    This is a workaround for two issues in xenapi. The first is that\n    does not set the instance default_root_device to /dev/xvda so it\n    defaults to /dev/sda. The proper fix for this involves setting the\n    default_root_device in xenapi and a db migration to set the proper\n    default_root_device for existing instances.\n    \n    This patch works around this issue by explicitly setting the prefix\n    to /dev/xvd if the compute driver is xenapi.\n    \n    The second issue is that xenapi never updates the instance record\n    to include default_swap_device and default_ephemeral device. The\n    fix for this involes adding the appropriate update to the instance\n    record and a migration that sets the proper values for all existing\n    instances.\n    \n    This patch works around this issue by explicily checking the\n    instance_type and removing the devices from the list if the compute\n    driver is xenapi.\n    \n    Fixes bug 1055715 and bug 1055712\n    \n    Change-Id: I61aa15e69eb0a22430bb22ea5149b1f0735b3328\n", 
            "date_created": "2012-09-25 21:57:45.438936+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: milestone-proposed\nReview: https://review.openstack.org/13674", 
            "date_created": "2012-09-25 22:02:09.576252+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/13674\nCommitted: http://github.com/openstack/nova/commit/076cb9d98330ae1ead94cc4d2c08b27939752648\nSubmitter: Jenkins\nBranch:    milestone-proposed\n\ncommit 076cb9d98330ae1ead94cc4d2c08b27939752648\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Tue Sep 25 11:15:14 2012 -0700\n\n    Fix issues with device autoassignment in xenapi\n    \n    This is a workaround for two issues in xenapi. The first is that\n    does not set the instance default_root_device to /dev/xvda so it\n    defaults to /dev/sda. The proper fix for this involves setting the\n    default_root_device in xenapi and a db migration to set the proper\n    default_root_device for existing instances.\n    \n    This patch works around this issue by explicitly setting the prefix\n    to /dev/xvd if the compute driver is xenapi.\n    \n    The second issue is that xenapi never updates the instance record\n    to include default_swap_device and default_ephemeral device. The\n    fix for this involes adding the appropriate update to the instance\n    record and a migration that sets the proper values for all existing\n    instances.\n    \n    This patch works around this issue by explicily checking the\n    instance_type and removing the devices from the list if the compute\n    driver is xenapi.\n    \n    Fixes bug 1055715 and bug 1055712\n    \n    Change-Id: I61aa15e69eb0a22430bb22ea5149b1f0735b3328\n    (cherry picked from commit 69564763960cddc249138469811a0a771db16e19)\n", 
            "date_created": "2012-09-26 00:48:04.591001+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-09-26 00:48:02.865795+00:00"
}