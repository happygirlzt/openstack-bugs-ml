{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:55:14.674452+00:00", 
    "description": "VMs' drives placement in Ceph option has been chosen (libvirt.images_types == 'rbd').\n\nWhen user creates a flavor and specifies:\n   - root drive size >0\n   - ephemeral drive size >0 (important)\n\nand tries to boot a VM, he gets \"no valid host was found\" in the scheduler log:\n\nError from last host: node-3.int.host.com (node node-3.int.host.com): [u'Traceback (most recent call last):\\n', u'\n File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1305, in _build_instance\\n set_access_ip=set_access_ip)\\n', u' File \"/usr/l\nib/python2.6/site-packages/nova/compute/manager.py\", line 393, in decorated_function\\n return function(self, context, *args, **kwargs)\\n', u' File\n \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1717, in _spawn\\n LOG.exception(_(\\'Instance failed to spawn\\'), instance=instanc\ne)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\n six.reraise(self.type_, self.value, se\nlf.tb)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1714, in _spawn\\n block_device_info)\\n', u' File \"/usr/lib/py\nthon2.6/site-packages/nova/virt/libvirt/driver.py\", line 2259, in spawn\\n admin_pass=admin_password)\\n', u' File \"/usr/lib/python2.6/site-packages\n/nova/virt/libvirt/driver.py\", line 2648, in _create_image\\n ephemeral_size=ephemeral_gb)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/virt/\nlibvirt/imagebackend.py\", line 186, in cache\\n *args, **kwargs)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/imagebackend.py\",\nline 587, in create_image\\n prepare_template(target=base, max_size=size, *args, **kwargs)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/opens\ntack/common/lockutils.py\", line 249, in inner\\n return f(*args, **kwargs)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/imagebac\nkend.py\", line 176, in fetch_func_sync\\n fetch_func(target=target, *args, **kwargs)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/virt/libvir\nt/driver.py\", line 2458, in _create_ephemeral\\n disk.mkfs(os_type, fs_label, target, run_as_root=is_block_dev)\\n', u' File \"/usr/lib/python2.6/sit\ne-packages/nova/virt/disk/api.py\", line 117, in mkfs\\n utils.mkfs(default_fs, target, fs_label, run_as_root=run_as_root)\\n', u' File \"/usr/lib/pyt\nhon2.6/site-packages/nova/utils.py\", line 856, in mkfs\\n execute(*args, run_as_root=run_as_root)\\n', u' File \"/usr/lib/python2.6/site-packages/nov\na/utils.py\", line 165, in execute\\n return processutils.execute(*cmd, **kwargs)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/openstack/commo\nn/processutils.py\", line 193, in execute\\n cmd=\\' \\'.join(cmd))\\n', u\"ProcessExecutionError: Unexpected error while running command.\\nCommand: sudo\n nova-rootwrap /etc/nova/rootwrap.conf mkfs -t ext3 -F -L ephemeral0 /var/lib/nova/instances/_base/ephemeral_1_default\\nExit code: 1\\nStdout: ''\\nStde\nrr: 'mke2fs 1.41.12 (17-May-2010)\\\\nmkfs.ext3: No such file or directory while trying to determine filesystem size\\\\n'\\n\"]", 
    "tags": [
        "ceph", 
        "cts", 
        "in-stable-icehouse", 
        "libvirt", 
        "rbd"
    ], 
    "importance": "High", 
    "heat": 20, 
    "link": "https://bugs.launchpad.net/nova/+bug/1362221", 
    "owner": "https://api.launchpad.net/1.0/~rpodolyaka", 
    "id": 1362221, 
    "index": 1586, 
    "openned": "2014-08-27 15:35:37.698007+00:00", 
    "created": "2014-08-27 15:35:37.698007+00:00", 
    "title": "VMs fail to start when Ceph is used as a backend for ephemeral drives", 
    "comments": [
        {
            "content": "VMs' drives placement in Ceph option has been chosen (libvirt.images_types == 'rbd').\n\nWhen user creates a flavor and specifies:\n   - root drive size >0\n   - ephemeral drive size >0 (important)\n\nand tries to boot a VM, he gets \"no valid host was found\" in the scheduler log:\n\nError from last host: node-3.int.host.com (node node-3.int.host.com): [u'Traceback (most recent call last):\\n', u'\n File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1305, in _build_instance\\n set_access_ip=set_access_ip)\\n', u' File \"/usr/l\nib/python2.6/site-packages/nova/compute/manager.py\", line 393, in decorated_function\\n return function(self, context, *args, **kwargs)\\n', u' File\n \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1717, in _spawn\\n LOG.exception(_(\\'Instance failed to spawn\\'), instance=instanc\ne)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\\n six.reraise(self.type_, self.value, se\nlf.tb)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1714, in _spawn\\n block_device_info)\\n', u' File \"/usr/lib/py\nthon2.6/site-packages/nova/virt/libvirt/driver.py\", line 2259, in spawn\\n admin_pass=admin_password)\\n', u' File \"/usr/lib/python2.6/site-packages\n/nova/virt/libvirt/driver.py\", line 2648, in _create_image\\n ephemeral_size=ephemeral_gb)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/virt/\nlibvirt/imagebackend.py\", line 186, in cache\\n *args, **kwargs)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/imagebackend.py\",\nline 587, in create_image\\n prepare_template(target=base, max_size=size, *args, **kwargs)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/opens\ntack/common/lockutils.py\", line 249, in inner\\n return f(*args, **kwargs)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/imagebac\nkend.py\", line 176, in fetch_func_sync\\n fetch_func(target=target, *args, **kwargs)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/virt/libvir\nt/driver.py\", line 2458, in _create_ephemeral\\n disk.mkfs(os_type, fs_label, target, run_as_root=is_block_dev)\\n', u' File \"/usr/lib/python2.6/sit\ne-packages/nova/virt/disk/api.py\", line 117, in mkfs\\n utils.mkfs(default_fs, target, fs_label, run_as_root=run_as_root)\\n', u' File \"/usr/lib/pyt\nhon2.6/site-packages/nova/utils.py\", line 856, in mkfs\\n execute(*args, run_as_root=run_as_root)\\n', u' File \"/usr/lib/python2.6/site-packages/nov\na/utils.py\", line 165, in execute\\n return processutils.execute(*cmd, **kwargs)\\n', u' File \"/usr/lib/python2.6/site-packages/nova/openstack/commo\nn/processutils.py\", line 193, in execute\\n cmd=\\' \\'.join(cmd))\\n', u\"ProcessExecutionError: Unexpected error while running command.\\nCommand: sudo\n nova-rootwrap /etc/nova/rootwrap.conf mkfs -t ext3 -F -L ephemeral0 /var/lib/nova/instances/_base/ephemeral_1_default\\nExit code: 1\\nStdout: ''\\nStde\nrr: 'mke2fs 1.41.12 (17-May-2010)\\\\nmkfs.ext3: No such file or directory while trying to determine filesystem size\\\\n'\\n\"]", 
            "date_created": "2014-08-27 15:35:37.698007+00:00", 
            "author": "https://api.launchpad.net/1.0/~rpodolyaka"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/117282", 
            "date_created": "2014-08-27 15:52:03.640343+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/117282\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=e9eb1d69bf75c22b0ad4b50e4892a5644c78cf68\nSubmitter: Jenkins\nBranch:    master\n\ncommit e9eb1d69bf75c22b0ad4b50e4892a5644c78cf68\nAuthor: Roman Podoliaka <email address hidden>\nDate:   Fri Aug 22 20:01:33 2014 +0300\n\n    Fix instance boot when Ceph is used for ephemeral storage\n    \n    is_block_dev attribute was mistakenly set to True for RBD images\n    (we don't actually map RBD images to block devices in the *host*\n    system, but only in *guests*, so as far as the host system is\n    concerned an RBD image must not be treated like a system block\n    device). This led to a situation when mkfs was called for a non\n    existing file and failed when trying to create an ephemeral fs.\n    \n    Closes-Bug: #1362221\n    \n    Change-Id: I54c0d117a53bb61f278b2e137bd29a595548f5a1\n", 
            "date_created": "2014-09-05 19:50:52.363127+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/119520", 
            "date_created": "2014-09-06 02:11:41.087958+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/119520\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=1613cd99345e51e314bf011f47654ed730138f64\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 1613cd99345e51e314bf011f47654ed730138f64\nAuthor: Roman Podoliaka <email address hidden>\nDate:   Fri Aug 22 20:01:33 2014 +0300\n\n    Fix instance boot when Ceph is used for ephemeral storage\n    \n    is_block_dev attribute was mistakenly set to True for RBD images\n    (we don't actually map RBD images to block devices in the *host*\n    system, but only in *guests*, so as far as the host system is\n    concerned an RBD image must not be treated like a system block\n    device). This led to a situation when mkfs was called for a non\n    existing file and failed when trying to create an ephemeral fs.\n    \n    Closes-Bug: #1362221\n    \n    Change-Id: I54c0d117a53bb61f278b2e137bd29a595548f5a1\n    (cherry picked from commit e9eb1d69bf75c22b0ad4b50e4892a5644c78cf68)\n", 
            "date_created": "2014-09-23 16:15:39.504791+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-10-01 07:37:40.589862+00:00"
}