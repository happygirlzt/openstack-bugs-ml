{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 11:09:53.705088+00:00", 
    "description": "Nova does not correctly handle glance not-authorized errors, so nova image-list gives a 500 under these conditions.\n\nStep to reproduce:\n\n> run devstack\n> modify glance/etc/policy.json so that all calls will be unauthorized:  \"default\": [[\"role:asd\"]]\n> nova image-list\n\nExpected:\n\nAn Unauthorized message\n\nActual:\n\n{\"computeFault\": {\"message\": \"The server has either erred or is incapable of performing the requested operation.\", \"code\": 500}}\nERROR: The server has either erred or is incapable of performing the requested operation. (HTTP 500)\n\n\nn-api:\n\n\nnova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/api/openstack/compute/images.py\", line 201, in detail\n(nova.api.openstack): TRACE:     **page_params)\n(nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 176, in detail\n(nova.api.openstack): TRACE:     for image_meta in image_metas:\n(nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 208, in _fetch_images\n(nova.api.openstack): TRACE:     _reraise_translated_exception()\n(nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 206, in _fetch_images\n(nova.api.openstack): TRACE:     images = fetch_func(**kwargs)\n(nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/client.py\", line 76, in get_images_detailed\n(nova.api.openstack): TRACE:     res = self.do_request(\"GET\", \"/images/detail\", params=params)\n(nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 58, in wrapped\n(nova.api.openstack): TRACE:     return func(self, *args, **kwargs)\n(nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 420, in do_request\n(nova.api.openstack): TRACE:     headers=headers)\n(nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 75, in wrapped\n(nova.api.openstack): TRACE:     return func(self, method, url, body, headers)\n(nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 538, in _do_request\n(nova.api.openstack): TRACE:     raise exception.Forbidden(res.read())\n(nova.api.openstack): TRACE: Forbidden: You are not authorized to complete this action.\n(nova.api.openstack): TRACE: Details: 403 Forbidden\n(nova.api.openstack): TRACE:\n(nova.api.openstack): TRACE: Access was denied to this resource.\n(nova.api.openstack): TRACE:\n(nova.api.openstack): TRACE:\n(nova.api.openstack): TRACE:", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/965540", 
    "owner": "https://api.launchpad.net/1.0/~sleepsonthefloor", 
    "id": 965540, 
    "index": 2830, 
    "openned": "2012-03-26 17:58:58.235085+00:00", 
    "created": "2012-03-26 17:58:58.235085+00:00", 
    "title": "nova does not handle glance_exception.Forbidden ", 
    "comments": [
        {
            "content": "Nova does not correctly handle glance not-authorized errors, so nova image-list gives a 500 under these conditions.\n\nStep to reproduce:\n\n> run devstack\n> modify glance/etc/policy.json so that all calls will be unauthorized:  \"default\": [[\"role:asd\"]]\n> nova image-list\n\nExpected:\n\nAn Unauthorized message\n\nActual:\n\n{\"computeFault\": {\"message\": \"The server has either erred or is incapable of performing the requested operation.\", \"code\": 500}}\nERROR: The server has either erred or is incapable of performing the requested operation. (HTTP 500)\n\n\nn-api:\n\n\nnova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/api/openstack/compute/images.py\", line 201, in detail\n(nova.api.openstack): TRACE:     **page_params)\n(nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 176, in detail\n(nova.api.openstack): TRACE:     for image_meta in image_metas:\n(nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 208, in _fetch_images\n(nova.api.openstack): TRACE:     _reraise_translated_exception()\n(nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 206, in _fetch_images\n(nova.api.openstack): TRACE:     images = fetch_func(**kwargs)\n(nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/client.py\", line 76, in get_images_detailed\n(nova.api.openstack): TRACE:     res = self.do_request(\"GET\", \"/images/detail\", params=params)\n(nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 58, in wrapped\n(nova.api.openstack): TRACE:     return func(self, *args, **kwargs)\n(nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 420, in do_request\n(nova.api.openstack): TRACE:     headers=headers)\n(nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 75, in wrapped\n(nova.api.openstack): TRACE:     return func(self, method, url, body, headers)\n(nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 538, in _do_request\n(nova.api.openstack): TRACE:     raise exception.Forbidden(res.read())\n(nova.api.openstack): TRACE: Forbidden: You are not authorized to complete this action.\n(nova.api.openstack): TRACE: Details: 403 Forbidden\n(nova.api.openstack): TRACE:\n(nova.api.openstack): TRACE: Access was denied to this resource.\n(nova.api.openstack): TRACE:\n(nova.api.openstack): TRACE:\n(nova.api.openstack): TRACE:", 
            "date_created": "2012-03-26 17:58:58.235085+00:00", 
            "author": "https://api.launchpad.net/1.0/~sleepsonthefloor"
        }, 
        {
            "content": "Ugh, this is because we are working around the issue.  The client used to raise:\n488     if exc_type in (glance_exception.NotAuthorized,\n489                     glance_exception.MissingCredentialError):\n\nSeems like an additional line in nova/image/glance.py above adding in glance_exception.Forbidden should fix that.\n\nVish\n\nOn Mar 26, 2012, at 10:58 AM, Anthony Young wrote:\n\n> Public bug reported:\n> \n> Nova does not correctly handle glance not-authorized errors, so nova\n> image-list gives a 500 under these conditions.\n> \n> Step to reproduce:\n> \n>> run devstack\n>> modify glance/etc/policy.json so that all calls will be unauthorized:  \"default\": [[\"role:asd\"]]\n>> nova image-list\n> \n> Expected:\n> \n> An Unauthorized message\n> \n> Actual:\n> \n> {\"computeFault\": {\"message\": \"The server has either erred or is incapable of performing the requested operation.\", \"code\": 500}}\n> ERROR: The server has either erred or is incapable of performing the requested operation. (HTTP 500)\n> \n> \n> n-api:\n> \n> \n> nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/api/openstack/compute/images.py\", line 201, in detail\n> (nova.api.openstack): TRACE:     **page_params)\n> (nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 176, in detail\n> (nova.api.openstack): TRACE:     for image_meta in image_metas:\n> (nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 208, in _fetch_images\n> (nova.api.openstack): TRACE:     _reraise_translated_exception()\n> (nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 206, in _fetch_images\n> (nova.api.openstack): TRACE:     images = fetch_func(**kwargs)\n> (nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/client.py\", line 76, in get_images_detailed\n> (nova.api.openstack): TRACE:     res = self.do_request(\"GET\", \"/images/detail\", params=params)\n> (nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 58, in wrapped\n> (nova.api.openstack): TRACE:     return func(self, *args, **kwargs)\n> (nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 420, in do_request\n> (nova.api.openstack): TRACE:     headers=headers)\n> (nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 75, in wrapped\n> (nova.api.openstack): TRACE:     return func(self, method, url, body, headers)\n> (nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 538, in _do_request\n> (nova.api.openstack): TRACE:     raise exception.Forbidden(res.read())\n> (nova.api.openstack): TRACE: Forbidden: You are not authorized to complete this action.\n> (nova.api.openstack): TRACE: Details: 403 Forbidden\n> (nova.api.openstack): TRACE:\n> (nova.api.openstack): TRACE: Access was denied to this resource.\n> (nova.api.openstack): TRACE:\n> (nova.api.openstack): TRACE:\n> (nova.api.openstack): TRACE:\n> \n> ** Affects: nova\n>     Importance: Undecided\n>         Status: New\n> \n> -- \n> You received this bug notification because you are subscribed to\n> OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/965540\n> \n> Title:\n>  nova does not handle glance_exception.Forbidden\n> \n> Status in OpenStack Compute (Nova):\n>  New\n> \n> Bug description:\n>  Nova does not correctly handle glance not-authorized errors, so nova\n>  image-list gives a 500 under these conditions.\n> \n>  Step to reproduce:\n> \n>> run devstack\n>> modify glance/etc/policy.json so that all calls will be unauthorized:  \"default\": [[\"role:asd\"]]\n>> nova image-list\n> \n>  Expected:\n> \n>  An Unauthorized message\n> \n>  Actual:\n> \n>  {\"computeFault\": {\"message\": \"The server has either erred or is incapable of performing the requested operation.\", \"code\": 500}}\n>  ERROR: The server has either erred or is incapable of performing the requested operation. (HTTP 500)\n> \n> \n>  n-api:\n> \n> \n>  nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/api/openstack/compute/images.py\", line 201, in detail\n>  (nova.api.openstack): TRACE:     **page_params)\n>  (nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 176, in detail\n>  (nova.api.openstack): TRACE:     for image_meta in image_metas:\n>  (nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 208, in _fetch_images\n>  (nova.api.openstack): TRACE:     _reraise_translated_exception()\n>  (nova.api.openstack): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 206, in _fetch_images\n>  (nova.api.openstack): TRACE:     images = fetch_func(**kwargs)\n>  (nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/client.py\", line 76, in get_images_detailed\n>  (nova.api.openstack): TRACE:     res = self.do_request(\"GET\", \"/images/detail\", params=params)\n>  (nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 58, in wrapped\n>  (nova.api.openstack): TRACE:     return func(self, *args, **kwargs)\n>  (nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 420, in do_request\n>  (nova.api.openstack): TRACE:     headers=headers)\n>  (nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 75, in wrapped\n>  (nova.api.openstack): TRACE:     return func(self, method, url, body, headers)\n>  (nova.api.openstack): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 538, in _do_request\n>  (nova.api.openstack): TRACE:     raise exception.Forbidden(res.read())\n>  (nova.api.openstack): TRACE: Forbidden: You are not authorized to complete this action.\n>  (nova.api.openstack): TRACE: Details: 403 Forbidden\n>  (nova.api.openstack): TRACE:\n>  (nova.api.openstack): TRACE: Access was denied to this resource.\n>  (nova.api.openstack): TRACE:\n>  (nova.api.openstack): TRACE:\n>  (nova.api.openstack): TRACE:\n> \n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/nova/+bug/965540/+subscriptions\n\n", 
            "date_created": "2012-03-26 18:16:09+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/5838", 
            "date_created": "2012-03-26 21:52:49.168492+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/5838\nCommitted: http://github.com/openstack/nova/commit/42585a3b2559329f0e563bcd04ff6c8c19115439\nSubmitter: Jenkins\nBranch:    master\n\ncommit 42585a3b2559329f0e563bcd04ff6c8c19115439\nAuthor: Anthony Young <email address hidden>\nDate:   Mon Mar 26 14:50:17 2012 -0700\n\n    Handle Forbidden and NotAuthenticated glance exc.\n    \n     * Remove references to deprecated NotAuthorized exception\n     * Handle Forbidden and NotAuthenticated\n     * Fixes bug 965540\n    \n    Change-Id: Ib5eef3015239e0fafdb01c975a0f5d553f70519e\n", 
            "date_created": "2012-03-27 00:07:35.554933+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: milestone-proposed\nReview: https://review.openstack.org/5880", 
            "date_created": "2012-03-27 21:37:08.411523+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/5880\nCommitted: http://github.com/openstack/nova/commit/10f6a4297721b1f4ee3689835da52655efdf98b5\nSubmitter: Jenkins\nBranch:    milestone-proposed\n\ncommit 10f6a4297721b1f4ee3689835da52655efdf98b5\nAuthor: Anthony Young <email address hidden>\nDate:   Mon Mar 26 14:50:17 2012 -0700\n\n    Handle Forbidden and NotAuthenticated glance exc.\n    \n     * Remove references to deprecated NotAuthorized exception\n     * Handle Forbidden and NotAuthenticated\n     * Fixes bug 965540\n    \n    Change-Id: Ib5eef3015239e0fafdb01c975a0f5d553f70519e\n", 
            "date_created": "2012-03-28 12:10:11.595508+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-03-28 12:10:09.222806+00:00"
}