{
    "status": "Invalid", 
    "last_updated": "2015-03-30 14:20:34.377102+00:00", 
    "description": "This change:\n\nhttps://github.com/openstack/nova/commit/0e98f5a522c08b17c98ed108459a179d14eacd4a\n\nSets pci_devices.deleted.nullable=True which breaks with DB2 because that column is in a UniqueConstraint:\n\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/db/sqlalchemy/models.py#n1374\n\nAnd DB2 requires that columns in a UniqueConstraint are not nullable.\n\nWe get a trace like this:\n\n2014-07-28 03:40:33.511 7720 INFO migrate.versioning.api [-] 246 -> 247...\n2014-07-28 03:40:37.073 7720 CRITICAL nova [-] ProgrammingError: (ProgrammingError) ibm_db_dbi::ProgrammingError: Statement Execute Failed: [IBM][CLI Driver][DB2/LINUXX8664] SQL0542N  The column named \"DELETED\" cannot be a column of a primary key or unique key constraint because it can contain null values.  SQLSTATE=42831 SQLCODE=-542 '\\nALTER TABLE pci_devices ALTER COLUMN deleted DROP NOT NULL' ()\n2014-07-28 03:40:37.073 7720 TRACE nova Traceback (most recent call last):\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n2014-07-28 03:40:37.073 7720 TRACE nova     sys.exit(main())\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/cmd/manage.py\", line 1401, in main\n2014-07-28 03:40:37.073 7720 TRACE nova     ret = fn(*fn_args, **fn_kwargs)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/cmd/manage.py\", line 902, in sync\n2014-07-28 03:40:37.073 7720 TRACE nova     return migration.db_sync(version)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/migration.py\", line 29, in db_sync\n2014-07-28 03:40:37.073 7720 TRACE nova     return IMPL.db_sync(version=version)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/migration.py\", line 44, in db_sync\n2014-07-28 03:40:37.073 7720 TRACE nova     return versioning_api.upgrade(get_engine(), repository, version)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/api.py\", line 186, in upgrade\n2014-07-28 03:40:37.073 7720 TRACE nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"<string>\", line 2, in _migrate\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/util/__init__.py\", line 160, in with_engine\n2014-07-28 03:40:37.073 7720 TRACE nova     return f(*a, **kw)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/api.py\", line 366, in _migrate\n2014-07-28 03:40:37.073 7720 TRACE nova     schema.runchange(ver, change, changeset.step)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/schema.py\", line 93, in runchange\n2014-07-28 03:40:37.073 7720 TRACE nova     change.run(self.engine, step)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/script/py.py\", line 148, in run\n2014-07-28 03:40:37.073 7720 TRACE nova     script_func(engine)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/migrate_repo/versions/247_nullable_mismatch.py\", line 27, in upgrade\n2014-07-28 03:40:37.073 7720 TRACE nova     pci_devices.c.deleted.alter(nullable=True)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/schema.py\", line 534, in alter\n2014-07-28 03:40:37.073 7720 TRACE nova     return alter_column(self, *p, **k)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/schema.py\", line 141, in alter_column\n2014-07-28 03:40:37.073 7720 TRACE nova     engine._run_visitor(visitorcallable, delta)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 1479, in _run_visitor\n2014-07-28 03:40:37.073 7720 TRACE nova     conn._run_visitor(visitorcallable, element, **kwargs)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 1122, in _run_visitor\n2014-07-28 03:40:37.073 7720 TRACE nova     **kwargs).traverse_single(element)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/ansisql.py\", line 56, in traverse_single\n2014-07-28 03:40:37.073 7720 TRACE nova     ret = super(AlterTableVisitor, self).traverse_single(elem)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/sql/visitors.py\", line 122, in traverse_single\n2014-07-28 03:40:37.073 7720 TRACE nova     return meth(obj, **kw)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/databases/ibmdb2.py\", line 161, in visit_column\n2014-07-28 03:40:37.073 7720 TRACE nova     self._run_subvisit(delta, self._visit_column_nullable)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/databases/ibmdb2.py\", line 136, in _run_subvisit\n2014-07-28 03:40:37.073 7720 TRACE nova     self.execute()\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/ansisql.py\", line 44, in execute\n2014-07-28 03:40:37.073 7720 TRACE nova     return self.connection.execute(self.buffer.getvalue())\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 662, in execute\n2014-07-28 03:40:37.073 7720 TRACE nova     params)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 805, in _execute_text\n2014-07-28 03:40:37.073 7720 TRACE nova     statement, parameters\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 874, in _execute_context\n2014-07-28 03:40:37.073 7720 TRACE nova     context)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 1024, in _handle_dbapi_exception\n2014-07-28 03:40:37.073 7720 TRACE nova     exc_info\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/util/compat.py\", line 196, in raise_from_cause\n2014-07-28 03:40:37.073 7720 TRACE nova     reraise(type(exception), exception, tb=exc_tb)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 867, in _execute_context\n2014-07-28 03:40:37.073 7720 TRACE nova     context)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/ibm_db_sa/ibm_db.py\", line 104, in do_execute\n2014-07-28 03:40:37.073 7720 TRACE nova     cursor.execute(statement, parameters)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/ibm_db_dbi.py\", line 1335, in execute\n2014-07-28 03:40:37.073 7720 TRACE nova     self._execute_helper(parameters)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/ibm_db_dbi.py\", line 1247, in _execute_helper\n2014-07-28 03:40:37.073 7720 TRACE nova     raise self.messages[len(self.messages) - 1]\n2014-07-28 03:40:37.073 7720 TRACE nova ProgrammingError: (ProgrammingError) ibm_db_dbi::ProgrammingError: Statement Execute Failed: [IBM][CLI Driver][DB2/LINUXX8664] SQL0542N  The column named \"DELETED\" cannot be a column of a primary key or unique key constraint because it can contain null values.  SQLSTATE=42831 SQLCODE=-542 '\\nALTER TABLE pci_devices ALTER COLUMN deleted DROP NOT NULL' ()\n2014-07-28 03:40:37.073 7720 TRACE nova\n\nThis will need to be worked into blueprint db2-database.", 
    "tags": [
        "db", 
        "db2"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1349515", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1349515, 
    "index": 1321, 
    "openned": "2014-07-28 17:38:00.632755+00:00", 
    "created": "2014-07-28 17:38:00.632755+00:00", 
    "title": "Commit 0e98f5a breaks db migrations with DB2", 
    "comments": [
        {
            "content": "This change:\n\nhttps://github.com/openstack/nova/commit/0e98f5a522c08b17c98ed108459a179d14eacd4a\n\nSets pci_devices.deleted.nullable=True which breaks with DB2 because that column is in a UniqueConstraint:\n\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/db/sqlalchemy/models.py#n1374\n\nAnd DB2 requires that columns in a UniqueConstraint are not nullable.\n\nWe get a trace like this:\n\n2014-07-28 03:40:33.511 7720 INFO migrate.versioning.api [-] 246 -> 247...\n2014-07-28 03:40:37.073 7720 CRITICAL nova [-] ProgrammingError: (ProgrammingError) ibm_db_dbi::ProgrammingError: Statement Execute Failed: [IBM][CLI Driver][DB2/LINUXX8664] SQL0542N  The column named \"DELETED\" cannot be a column of a primary key or unique key constraint because it can contain null values.  SQLSTATE=42831 SQLCODE=-542 '\\nALTER TABLE pci_devices ALTER COLUMN deleted DROP NOT NULL' ()\n2014-07-28 03:40:37.073 7720 TRACE nova Traceback (most recent call last):\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n2014-07-28 03:40:37.073 7720 TRACE nova     sys.exit(main())\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/cmd/manage.py\", line 1401, in main\n2014-07-28 03:40:37.073 7720 TRACE nova     ret = fn(*fn_args, **fn_kwargs)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/cmd/manage.py\", line 902, in sync\n2014-07-28 03:40:37.073 7720 TRACE nova     return migration.db_sync(version)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/migration.py\", line 29, in db_sync\n2014-07-28 03:40:37.073 7720 TRACE nova     return IMPL.db_sync(version=version)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/migration.py\", line 44, in db_sync\n2014-07-28 03:40:37.073 7720 TRACE nova     return versioning_api.upgrade(get_engine(), repository, version)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/api.py\", line 186, in upgrade\n2014-07-28 03:40:37.073 7720 TRACE nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"<string>\", line 2, in _migrate\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/util/__init__.py\", line 160, in with_engine\n2014-07-28 03:40:37.073 7720 TRACE nova     return f(*a, **kw)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/api.py\", line 366, in _migrate\n2014-07-28 03:40:37.073 7720 TRACE nova     schema.runchange(ver, change, changeset.step)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/schema.py\", line 93, in runchange\n2014-07-28 03:40:37.073 7720 TRACE nova     change.run(self.engine, step)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/script/py.py\", line 148, in run\n2014-07-28 03:40:37.073 7720 TRACE nova     script_func(engine)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/migrate_repo/versions/247_nullable_mismatch.py\", line 27, in upgrade\n2014-07-28 03:40:37.073 7720 TRACE nova     pci_devices.c.deleted.alter(nullable=True)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/schema.py\", line 534, in alter\n2014-07-28 03:40:37.073 7720 TRACE nova     return alter_column(self, *p, **k)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/schema.py\", line 141, in alter_column\n2014-07-28 03:40:37.073 7720 TRACE nova     engine._run_visitor(visitorcallable, delta)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 1479, in _run_visitor\n2014-07-28 03:40:37.073 7720 TRACE nova     conn._run_visitor(visitorcallable, element, **kwargs)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 1122, in _run_visitor\n2014-07-28 03:40:37.073 7720 TRACE nova     **kwargs).traverse_single(element)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/ansisql.py\", line 56, in traverse_single\n2014-07-28 03:40:37.073 7720 TRACE nova     ret = super(AlterTableVisitor, self).traverse_single(elem)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/sql/visitors.py\", line 122, in traverse_single\n2014-07-28 03:40:37.073 7720 TRACE nova     return meth(obj, **kw)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/databases/ibmdb2.py\", line 161, in visit_column\n2014-07-28 03:40:37.073 7720 TRACE nova     self._run_subvisit(delta, self._visit_column_nullable)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/databases/ibmdb2.py\", line 136, in _run_subvisit\n2014-07-28 03:40:37.073 7720 TRACE nova     self.execute()\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/ansisql.py\", line 44, in execute\n2014-07-28 03:40:37.073 7720 TRACE nova     return self.connection.execute(self.buffer.getvalue())\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 662, in execute\n2014-07-28 03:40:37.073 7720 TRACE nova     params)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 805, in _execute_text\n2014-07-28 03:40:37.073 7720 TRACE nova     statement, parameters\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 874, in _execute_context\n2014-07-28 03:40:37.073 7720 TRACE nova     context)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 1024, in _handle_dbapi_exception\n2014-07-28 03:40:37.073 7720 TRACE nova     exc_info\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/util/compat.py\", line 196, in raise_from_cause\n2014-07-28 03:40:37.073 7720 TRACE nova     reraise(type(exception), exception, tb=exc_tb)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py\", line 867, in _execute_context\n2014-07-28 03:40:37.073 7720 TRACE nova     context)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib/python2.6/site-packages/ibm_db_sa/ibm_db.py\", line 104, in do_execute\n2014-07-28 03:40:37.073 7720 TRACE nova     cursor.execute(statement, parameters)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/ibm_db_dbi.py\", line 1335, in execute\n2014-07-28 03:40:37.073 7720 TRACE nova     self._execute_helper(parameters)\n2014-07-28 03:40:37.073 7720 TRACE nova   File \"/usr/lib64/python2.6/site-packages/ibm_db_dbi.py\", line 1247, in _execute_helper\n2014-07-28 03:40:37.073 7720 TRACE nova     raise self.messages[len(self.messages) - 1]\n2014-07-28 03:40:37.073 7720 TRACE nova ProgrammingError: (ProgrammingError) ibm_db_dbi::ProgrammingError: Statement Execute Failed: [IBM][CLI Driver][DB2/LINUXX8664] SQL0542N  The column named \"DELETED\" cannot be a column of a primary key or unique key constraint because it can contain null values.  SQLSTATE=42831 SQLCODE=-542 '\\nALTER TABLE pci_devices ALTER COLUMN deleted DROP NOT NULL' ()\n2014-07-28 03:40:37.073 7720 TRACE nova\n\nThis will need to be worked into blueprint db2-database.", 
            "date_created": "2014-07-28 17:38:00.632755+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This is being handled with a backend-specific condition in the 247 migration:\n\nhttps://review.openstack.org/#/c/69047/45/nova/db/sqlalchemy/migrate_repo/versions/247_nullable_mismatch.py", 
            "date_created": "2015-03-30 14:19:37.853958+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Tracked in the blueprint spec:\n\nhttps://blueprints.launchpad.net/nova/+spec/db2-database", 
            "date_created": "2015-03-30 14:20:33.854125+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }
    ], 
    "closed": "2015-03-30 14:20:20.795250+00:00"
}