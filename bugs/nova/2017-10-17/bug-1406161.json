{
    "status": "Fix Released", 
    "last_updated": "2015-08-10 17:40:22.696139+00:00", 
    "description": "this issue reproduce steps:\n1. nova boot vm1 base fcsan volume, this instance bdm table connection_info as following:\n{\"driver_volume_type\": \"fibre_channel\", \"serial\": \"63013f85-34fd-4040-a234-6ee57e1a8eeb\", \"data\": {\"device_path\": \"/dev/dm-11\", \"target_discovered\": false, \"devices\": [{\"device\": \"/dev/sdv\", \"host\": \"7\", \"id\": \"0\", \"channel\": \"0\", \"lun\": \"8\"}, {\"device\": \"/dev/sdx\", \"host\": \"8\", \"id\": \"0\", \"channel\": \"0\", \"lun\": \"8\"}], \"qos_specs\": null, \"volume_id\": \"63013f85-34fd-4040-a234-6ee57e1a8eeb\", \"target_lun\": 8, \"access_mode\": \"rw\", \"target_wwn\": [\"20014c09b4b04d0e\", \"20024c09b4b04d0e\", \"20034c09b4b04d0e\", \"20044c09b4b04d0e\", \"20014c09b4b04d18\", \"20024c09b4b04d18\", \"20034c09b4b04d18\", \"20044c09b4b04d18\"], \"multipath_id\": \"3500422790776c4d6\"}}\n2. run nova live-migration vm1 fininshed, vm1 was migrated another host, but this instance bdm table connection_info as following:\n{\"driver_volume_type\": \"fibre_channel\", \"serial\": \"63013f85-34fd-4040-a234-6ee57e1a8eeb\", \"data\": { \"target_discovered\": false,  \"qos_specs\": null, \"volume_id\": \"63013f85-34fd-4040-a234-6ee57e1a8eeb\", \"target_lun\": 9, \"access_mode\": \"rw\", \"target_wwn\": [\"20014c09b4b04d0e\", \"20024c09b4b04d0e\", \"20034c09b4b04d0e\", \"20044c09b4b04d0e\", \"20014c09b4b04d18\", \"20024c09b4b04d18\", \"20034c09b4b04d18\", \"20044c09b4b04d18\"], \"multipath_id\": \"3500422790776c4d6\"}}\n\nwe can find the key \"device_path\" and \"devices\"  was lost\n3.if we live-migration this vm1 again,will fail . Call chain are as follows:\n2014-12-16 05:19:12.039 9678 INFO nova.compute.manager [-] [instance: 5901a64a-32a6-448d-a535-5b03bb4df533] _post_live_migration() is started..\n2014-12-16 05:19:12.068 9678 INFO urllib3.connectionpool [-] Starting new HTTP connection (1): 10.43.177.244\n2014-12-16 05:19:12.139 9678 INFO nova.compute.manager [-] [instance: 5901a64a-32a6-448d-a535-5b03bb4df533] During sync_power_state the instance has a pending task. Skip.\n2014-12-16 05:19:12.512 9678 ERROR nova.openstack.common.loopingcall [-] in fixed duration looping call\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall Traceback (most recent call last):\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/loopingcall.py\", line 78, in _inner\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     self.f(*self.args, **self.kw)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4987, in wait_for_live_migration\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     migrate_data)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     payload)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     six.reraise(self.type_, self.value, self.tb)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     return f(self, context, *args, **kw)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 369, in decorated_function\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     e, sys.exc_info())\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     six.reraise(self.type_, self.value, self.tb)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 356, in decorated_function\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     return function(self, context, *args, **kwargs)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4824, in _post_live_migration\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     migrate_data)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 5188, in post_live_migration\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     disk_dev)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1213, in volume_driver_method\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     return method(connection_info, *args, **kwargs)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/lockutils.py\", line 249, in inner\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     return f(*args, **kwargs)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/volume.py\", line 1034, in disconnect_volume\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     devicespath = connection_info['data']['device_path']\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall KeyError: 'device_path'\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall \n2014-12-16 05:19:31.629 9678 AUDIT nova.compute.resource_tracker [req-30cd2379-2ece-4577-a118-7b9daf4ef350 None None] Auditing locally available compute resources", 
    "tags": [
        "live-migrate", 
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1406161", 
    "owner": "https://api.launchpad.net/1.0/~walter-boring", 
    "id": 1406161, 
    "index": 6617, 
    "openned": "2014-12-29 01:51:43.919351+00:00", 
    "created": "2014-12-29 01:51:43.919351+00:00", 
    "title": "boot from fcsan volume live migration caused bdm table lost connection_info value", 
    "comments": [
        {
            "content": "this issue reproduce steps:\n1. nova boot vm1 base fcsan volume, this instance bdm table connection_info as following:\n{\"driver_volume_type\": \"fibre_channel\", \"serial\": \"63013f85-34fd-4040-a234-6ee57e1a8eeb\", \"data\": {\"device_path\": \"/dev/dm-11\", \"target_discovered\": false, \"devices\": [{\"device\": \"/dev/sdv\", \"host\": \"7\", \"id\": \"0\", \"channel\": \"0\", \"lun\": \"8\"}, {\"device\": \"/dev/sdx\", \"host\": \"8\", \"id\": \"0\", \"channel\": \"0\", \"lun\": \"8\"}], \"qos_specs\": null, \"volume_id\": \"63013f85-34fd-4040-a234-6ee57e1a8eeb\", \"target_lun\": 8, \"access_mode\": \"rw\", \"target_wwn\": [\"20014c09b4b04d0e\", \"20024c09b4b04d0e\", \"20034c09b4b04d0e\", \"20044c09b4b04d0e\", \"20014c09b4b04d18\", \"20024c09b4b04d18\", \"20034c09b4b04d18\", \"20044c09b4b04d18\"], \"multipath_id\": \"3500422790776c4d6\"}}\n2. run nova live-migration vm1 fininshed, vm1 was migrated another host, but this instance bdm table connection_info as following:\n{\"driver_volume_type\": \"fibre_channel\", \"serial\": \"63013f85-34fd-4040-a234-6ee57e1a8eeb\", \"data\": { \"target_discovered\": false,  \"qos_specs\": null, \"volume_id\": \"63013f85-34fd-4040-a234-6ee57e1a8eeb\", \"target_lun\": 9, \"access_mode\": \"rw\", \"target_wwn\": [\"20014c09b4b04d0e\", \"20024c09b4b04d0e\", \"20034c09b4b04d0e\", \"20044c09b4b04d0e\", \"20014c09b4b04d18\", \"20024c09b4b04d18\", \"20034c09b4b04d18\", \"20044c09b4b04d18\"], \"multipath_id\": \"3500422790776c4d6\"}}\n\nwe can find the key \"device_path\" and \"devices\"  was lost\n3.if we live-migration this vm1 again,will fail . Call chain are as follows:\n2014-12-16 05:19:12.039 9678 INFO nova.compute.manager [-] [instance: 5901a64a-32a6-448d-a535-5b03bb4df533] _post_live_migration() is started..\n2014-12-16 05:19:12.068 9678 INFO urllib3.connectionpool [-] Starting new HTTP connection (1): 10.43.177.244\n2014-12-16 05:19:12.139 9678 INFO nova.compute.manager [-] [instance: 5901a64a-32a6-448d-a535-5b03bb4df533] During sync_power_state the instance has a pending task. Skip.\n2014-12-16 05:19:12.512 9678 ERROR nova.openstack.common.loopingcall [-] in fixed duration looping call\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall Traceback (most recent call last):\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/loopingcall.py\", line 78, in _inner\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     self.f(*self.args, **self.kw)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4987, in wait_for_live_migration\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     migrate_data)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     payload)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     six.reraise(self.type_, self.value, self.tb)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     return f(self, context, *args, **kw)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 369, in decorated_function\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     e, sys.exc_info())\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     six.reraise(self.type_, self.value, self.tb)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 356, in decorated_function\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     return function(self, context, *args, **kwargs)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4824, in _post_live_migration\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     migrate_data)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 5188, in post_live_migration\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     disk_dev)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1213, in volume_driver_method\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     return method(connection_info, *args, **kwargs)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/lockutils.py\", line 249, in inner\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     return f(*args, **kwargs)\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/volume.py\", line 1034, in disconnect_volume\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall     devicespath = connection_info['data']['device_path']\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall KeyError: 'device_path'\n2014-12-16 05:19:12.512 9678 TRACE nova.openstack.common.loopingcall \n2014-12-16 05:19:31.629 9678 AUDIT nova.compute.resource_tracker [req-30cd2379-2ece-4577-a118-7b9daf4ef350 None None] Auditing locally available compute resources", 
            "date_created": "2014-12-29 01:51:43.919351+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "we should at pre_live_migration save destination host's connection_info . so we can modify at /nova/virt/libvirt/driver.py   pre_live_migration :\nform :\n for vol in block_device_mapping:\n            connection_info = vol['connection_info']\n            disk_info = blockinfo.get_info_from_bdm(\n                CONF.libvirt.virt_type, vol)\n                self.volume_driver_method('connect_volume',\n                                           connection_info,\n                                           disk_info)\nto:\n  for vol in block_device_mapping:\n            connection_info = vol['connection_info']\n            disk_info = blockinfo.get_info_from_bdm(\n                CONF.libvirt.virt_type, vol)\n            cfg = self.volume_driver_method('connect_volume',\n                                           connection_info,\n                                           disk_info)\n            if 'data' in connection_info: \n                connection_info['data']['device_path'] = cfg.source_path\n                vol['connection_info'] = connection_info\n                vol.save(context)", 
            "date_created": "2014-12-29 01:56:51.434815+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "Hi, will you be filing a review? (https://wiki.openstack.org/wiki/How_To_Contribute)", 
            "date_created": "2015-02-27 16:16:55.954547+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Hi Davanum Srinivas:\n   I use icehouse version, I review the code in K version, this issue was also present. this issue affect fcsan live-migration. will this bug be confirmed? ", 
            "date_created": "2015-03-04 11:42:36.270220+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "Nova patch here:\nhttps://review.openstack.org/#/c/195350/\n\n\nos-brick patch here:\nhttps://review.openstack.org/#/c/195359/", 
            "date_created": "2015-06-24 23:37:25.332706+00:00", 
            "author": "https://api.launchpad.net/1.0/~walter-boring"
        }, 
        {
            "content": "Potentially related to bug 1419577.", 
            "date_created": "2015-07-01 16:31:42.215660+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/202826", 
            "date_created": "2015-07-16 23:13:34.097165+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/202826\nCommitted: https://git.openstack.org/cgit/openstack/os-brick/commit/?id=981b84c49c170b4289e2a9c3df7feb245f5803bc\nSubmitter: Jenkins\nBranch:    master\n\ncommit 981b84c49c170b4289e2a9c3df7feb245f5803bc\nAuthor: Walter A. Boring IV <email address hidden>\nDate:   Thu Jul 16 16:09:02 2015 -0700\n\n    FC discover existing devices for removal\n    \n    Due to the way Nova live migration works, we can't\n    rely on having the device path that was discovered at\n    connect_volume time existing in the device_info.\n    \n    This patch uses the existing connection_properties\n    to rediscover the existing volume paths on the system\n    at the time disconnect_volume is called.   This ensures\n    that whatever paths/devices are associated with at volume\n    at disconnect_volume time exists, they will be removed.\n    \n    Change-Id: I699fcff5dee595caa54ca7e80f67966edd1370ef\n    Closes-Bug: 1406161\n", 
            "date_created": "2015-07-20 16:53:34.199855+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Walter A. Boring IV (hemna) (<email address hidden>) on branch: master\nReview: https://review.openstack.org/195350\nReason: No longer needed in Liberty.", 
            "date_created": "2015-07-28 15:27:22.663889+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-08-10 17:40:20.142670+00:00"
}