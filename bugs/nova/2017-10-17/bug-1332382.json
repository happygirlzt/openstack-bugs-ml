{
    "status": "Fix Released", 
    "last_updated": "2015-03-13 00:53:37.332405+00:00", 
    "description": "\nWhen booting instances passing in block-device and increasing the volume size , instances can go in to error state if the volume takes longer to create than the hard code value set in:\n\nnova/compute/manager.py\n\n  def _await_block_device_map_created(self, context, vol_id, max_tries=180,\n                                        wait_between=1):\n\n\nHere is the command used to repro:\n\nnova boot --flavor ca8d889e-6a4e-48f8-81ce-0fa2d153db16 --image 438b3f1f-1b23-4b8d-84e1-786ffc73a298  \n--block-device source=image,id=438b3f1f-1b23-4b8d-84e1-786ffc73a298,dest=volume,size=128  \n--nic net-id=5f847661-edef-4dff-9f4b-904d1b3ac422 --security-groups d9ce9fe3-983f-42a8-899e-609c01977e32  \nTest_Image_Instance\n\nmax_retries should be made configurable.\n\nLooking through the different releases, Grizzly was 30, Havana was 60 , IceHouse is 180.\n\nHere is a traceback:\n\n2014-06-19 06:54:24.303 17578 ERROR nova.compute.manager [req-050fc984-cfa2-4c34-9cde-c8aeea65e6ed  \nd0b8f2c3cf70445baae994004e602e11 1e83429a8157489fb7ce087bd037f5d9] [instance:  \n74f612ea-9722-4796-956f-32defd417000] Instance failed block device setup\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nTraceback (most recent call last):\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nFile \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1394,  \nin _prep_block_device\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nself._await_block_device_map_created))\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nFile \"/usr/lib/python2.7/dist-packages/nova/virt/block_device.py\", line 283,  \nin attach_block_devices\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nblock_device_mapping)\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nFile \"/usr/lib/python2.7/dist-packages/nova/virt/block_device.py\", line 238,  \nin attach\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nwait_func(context, vol['id'])\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nFile \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 909,  \nin _await_block_device_map_created\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nattempts=attempts)\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nVolumeNotCreated: Volume 8489549e-d23e-45c2-ae6e-7fdb1a9c30d0 did not finish  \nbeing created even after we waited 65 seconds or 60 attempts.\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]", 
    "tags": [
        "compute", 
        "icehouse-backport-potential", 
        "in-stable-icehouse", 
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1332382", 
    "owner": "https://api.launchpad.net/1.0/~akashg1611", 
    "id": 1332382, 
    "index": 6201, 
    "openned": "2014-06-20 02:13:41.357342+00:00", 
    "created": "2014-06-20 02:13:41.357342+00:00", 
    "title": "block device mapping timeout in compute", 
    "comments": [
        {
            "content": "\nWhen booting instances passing in block-device and increasing the volume size , instances can go in to error state if the volume takes longer to create than the hard code value set in:\n\nnova/compute/manager.py\n\n  def _await_block_device_map_created(self, context, vol_id, max_tries=180,\n                                        wait_between=1):\n\n\nHere is the command used to repro:\n\nnova boot --flavor ca8d889e-6a4e-48f8-81ce-0fa2d153db16 --image 438b3f1f-1b23-4b8d-84e1-786ffc73a298  \n--block-device source=image,id=438b3f1f-1b23-4b8d-84e1-786ffc73a298,dest=volume,size=128  \n--nic net-id=5f847661-edef-4dff-9f4b-904d1b3ac422 --security-groups d9ce9fe3-983f-42a8-899e-609c01977e32  \nTest_Image_Instance\n\nmax_retries should be made configurable.\n\nLooking through the different releases, Grizzly was 30, Havana was 60 , IceHouse is 180.\n\nHere is a traceback:\n\n2014-06-19 06:54:24.303 17578 ERROR nova.compute.manager [req-050fc984-cfa2-4c34-9cde-c8aeea65e6ed  \nd0b8f2c3cf70445baae994004e602e11 1e83429a8157489fb7ce087bd037f5d9] [instance:  \n74f612ea-9722-4796-956f-32defd417000] Instance failed block device setup\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nTraceback (most recent call last):\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nFile \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1394,  \nin _prep_block_device\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nself._await_block_device_map_created))\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nFile \"/usr/lib/python2.7/dist-packages/nova/virt/block_device.py\", line 283,  \nin attach_block_devices\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nblock_device_mapping)\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nFile \"/usr/lib/python2.7/dist-packages/nova/virt/block_device.py\", line 238,  \nin attach\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nwait_func(context, vol['id'])\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nFile \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 909,  \nin _await_block_device_map_created\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nattempts=attempts)\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]  \nVolumeNotCreated: Volume 8489549e-d23e-45c2-ae6e-7fdb1a9c30d0 did not finish  \nbeing created even after we waited 65 seconds or 60 attempts.\n2014-06-19 06:54:24.303 17578 TRACE nova.compute.manager [instance: 74f612ea-9722-4796-956f-32defd417000]", 
            "date_created": "2014-06-20 02:13:41.357342+00:00", 
            "author": "https://api.launchpad.net/1.0/~jcherkas"
        }, 
        {
            "content": "Thanks for the bug report. I think we should make this timeout configurable so it can be set to a higher value than 60 seconds if it sometimes takes more time then that. ", 
            "date_created": "2014-06-20 05:11:55.086411+00:00", 
            "author": "https://api.launchpad.net/1.0/~arosen"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/102952", 
            "date_created": "2014-06-26 21:28:11.811712+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by akash (<email address hidden>) on branch: master\nReview: https://review.openstack.org/102952\nReason: Duplicate", 
            "date_created": "2014-06-26 21:42:12.883169+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Gerrit Review Link: https://review.openstack.org/#/c/102891/\n\nAwaiting +2", 
            "date_created": "2014-07-08 20:56:55.181621+00:00", 
            "author": "https://api.launchpad.net/1.0/~akashg1611"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/102891\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=66721eb2c0f53fc4260b2f0aa9a3811da0f7ddbd\nSubmitter: Jenkins\nBranch:    master\n\ncommit 66721eb2c0f53fc4260b2f0aa9a3811da0f7ddbd\nAuthor: Akash Gangil <email address hidden>\nDate:   Thu Jul 10 15:10:33 2014 -0700\n\n    Make the block device mapping retries configurable\n    \n    When booting instances passing in block-device and increasing the\n    volume size, instances can go in to error state if the volume takes\n    longer to create than the hard code value (max_tries(180)/wait_between(1))\n    set in nova/compute/manager.py\n    \n    def _await_block_device_map_created(self,\n                                        context,\n                                        vol_id,\n                                        max_tries=180,\n                                        wait_between=1):\n    \n    To fix this, max_retries/wait_between should be made configurable.\n    Looking through the different releases, Grizzly was 30, Havana was\n    60 , IceHouse is 180.\n    \n    This change adds two configuration options:\n    a)  `block_device_allocate_retries` which can be set in nova.conf\n    by the user to configure the number of block device mapping retries.\n    It defaults to 60 and replaces the max_tries argument in the above method.\n    b) `block_device_allocate_retries_interval` which allows the user\n    to specify the time interval between consecutive retries. It defaults to 3\n    and replaces wait_between argument in the above method.\n    \n    DocImpact\n    Closes-Bug: #1332382\n    Change-Id: I16e4cd1a572bc5c2cd91fc94be85e72f576a8c26\n", 
            "date_created": "2014-07-11 17:10:40.192256+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/129276", 
            "date_created": "2014-10-17 14:25:59.812733+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/129276\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=5ab042143db18bd597b2c141db6ddf6dd0575f2f\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 5ab042143db18bd597b2c141db6ddf6dd0575f2f\nAuthor: Akash Gangil <email address hidden>\nDate:   Thu Jul 10 15:10:33 2014 -0700\n\n    Make the block device mapping retries configurable\n    \n    When booting instances passing in block-device and increasing the\n    volume size, instances can go in to error state if the volume takes\n    longer to create than the hard code value (max_tries(180)/wait_between(1))\n    set in nova/compute/manager.py\n    \n    def _await_block_device_map_created(self,\n                                        context,\n                                        vol_id,\n                                        max_tries=180,\n                                        wait_between=1):\n    \n    To fix this, max_retries/wait_between should be made configurable.\n    Looking through the different releases, Grizzly was 30, Havana was\n    60 , IceHouse is 180.\n    \n    This change adds two configuration options:\n    a)  `block_device_allocate_retries` which can be set in nova.conf\n    by the user to configure the number of block device mapping retries.\n    It defaults to 180 and replaces the max_tries argument in the above method.\n    b) `block_device_allocate_retries_interval` which allows the user\n    to specify the time interval between consecutive retries. It defaults to 1\n    and replaces wait_between argument in the above method.\n    \n    The cherry-picked patch has been amended to set the default configuration\n    options to the same values that were previously hard-coded:\n      block_device_allocate_retries=180\n      block_device_allocate_retries_interval=1\n    \n    DocImpact\n    Closes-Bug: #1332382\n    Change-Id: I16e4cd1a572bc5c2cd91fc94be85e72f576a8c26\n    (cherry picked from commit 66721eb2c0f53fc4260b2f0aa9a3811da0f7ddbd)\n", 
            "date_created": "2014-10-29 17:09:37.226182+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-07-23 15:08:49.378112+00:00"
}