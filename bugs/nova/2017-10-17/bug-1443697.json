{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:50:43.134363+00:00", 
    "description": "Resize will fail if using 0 disk flavors in combination with images that have disks larger than 1 GB.  \n\nSteps to reproduce:\n1. Create two new flavors with disk sizes of 0.  tiny and small will do\n2. Create an image with a disk larger than 1 GB\n3. Boot this image with tiny.0\n4. Resize this image to small.0\n5. Notice Horizon says nothing and the resize does nothing\n6. An exception is in the Nova compute logs (stacktrace from Icehouse, but believe also an issue in Kilo)\n\n2015-04-13 23:32:10.676 9404 ERROR oslo.messaging.rpc.dispatcher [-] Exception during message handling: Resize error: Unable to shrink disk.\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 88, in wrapped\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     payload)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 71, in wrapped\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 282, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     pass\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 268, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 335, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     function(self, context, *args, **kwargs)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 256, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     migration.instance_uuid, exc_info=True)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 243, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 311, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     e, sys.exc_info())\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 298, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 3506, in resize_instance\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     self.instance_events.clear_events_for_instance(instance)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/contextlib.py\", line 35, in __exit__\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     self.gen.throw(type, value, traceback)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 5613, in _error_out_instance_on_exception\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     raise error.inner_exception\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher ResizeError: Resize error: Unable to shrink disk.\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher \n2015-04-13 23:32:10.678 9404 ERROR oslo.messaging._drivers.common [-] Returning exception Resize error: Unable to shrink disk. to caller\n\n\n\nIt appears that nova compute will throw an error when attempting to resize an instance _from_ a flavor with disk size of 0 _to_ a flavor with disk size 0.\n\nThe trick to reproducing this error is using any image that has a disk greater than 1 GB.  I initially tested with cirros, tiny-iso, etc which are all less than 1 GB.\n\nThe root cause of the problem is this code in vmops.py:1332\n\n        # Checks if the migration needs a disk resize down.\n        if (flavor['root_gb'] < instance['root_gb'] or\n            flavor['root_gb'] < vmdk.capacity_in_bytes / units.Gi):\n            reason = _(\"Unable to shrink disk.\")\n            raise exception.InstanceFaultRollback(\n                exception.ResizeError(reason=reason))\n\nDividing the capacity by 1 GB will result in 0 for any number less than 1 GB.  However anything larger will be a positive integer.  And the flavor size is always 0, so this exception is always raised in a resize of any image with capacity larger than 1 GB (which is most images).", 
    "tags": [
        "vmware"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1443697", 
    "owner": "https://api.launchpad.net/1.0/~ericwb", 
    "id": 1443697, 
    "index": 4218, 
    "openned": "2015-04-13 23:47:24.102026+00:00", 
    "created": "2015-04-13 23:47:24.102026+00:00", 
    "title": "VMware: resize always fails for image with capacity larger than 1 GB", 
    "comments": [
        {
            "content": "Resize will fail if using 0 disk flavors in combination with images that have disks larger than 1 GB.  \n\nSteps to reproduce:\n1. Create two new flavors with disk sizes of 0.  tiny and small will do\n2. Create an image with a disk larger than 1 GB\n3. Boot this image with tiny.0\n4. Resize this image to small.0\n5. Notice Horizon says nothing and the resize does nothing\n6. An exception is in the Nova compute logs (stacktrace from Icehouse, but believe also an issue in Kilo)\n\n2015-04-13 23:32:10.676 9404 ERROR oslo.messaging.rpc.dispatcher [-] Exception during message handling: Resize error: Unable to shrink disk.\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 88, in wrapped\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     payload)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 71, in wrapped\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 282, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     pass\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 268, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 335, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     function(self, context, *args, **kwargs)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 256, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     migration.instance_uuid, exc_info=True)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 243, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 311, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     e, sys.exc_info())\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 298, in decorated_function\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 3506, in resize_instance\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     self.instance_events.clear_events_for_instance(instance)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/contextlib.py\", line 35, in __exit__\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     self.gen.throw(type, value, traceback)\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 5613, in _error_out_instance_on_exception\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher     raise error.inner_exception\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher ResizeError: Resize error: Unable to shrink disk.\n2015-04-13 23:32:10.676 9404 TRACE oslo.messaging.rpc.dispatcher \n2015-04-13 23:32:10.678 9404 ERROR oslo.messaging._drivers.common [-] Returning exception Resize error: Unable to shrink disk. to caller\n\n\n\nIt appears that nova compute will throw an error when attempting to resize an instance _from_ a flavor with disk size of 0 _to_ a flavor with disk size 0.\n\nThe trick to reproducing this error is using any image that has a disk greater than 1 GB.  I initially tested with cirros, tiny-iso, etc which are all less than 1 GB.\n\nThe root cause of the problem is this code in vmops.py:1332\n\n        # Checks if the migration needs a disk resize down.\n        if (flavor['root_gb'] < instance['root_gb'] or\n            flavor['root_gb'] < vmdk.capacity_in_bytes / units.Gi):\n            reason = _(\"Unable to shrink disk.\")\n            raise exception.InstanceFaultRollback(\n                exception.ResizeError(reason=reason))\n\nDividing the capacity by 1 GB will result in 0 for any number less than 1 GB.  However anything larger will be a positive integer.  And the flavor size is always 0, so this exception is always raised in a resize of any image with capacity larger than 1 GB (which is most images).", 
            "date_created": "2015-04-13 23:47:24.102026+00:00", 
            "author": "https://api.launchpad.net/1.0/~ericwb"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/173170", 
            "date_created": "2015-04-14 04:59:17.328786+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/173170\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3a77c7c570acee40100f2fae77ef5b461997b78e\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3a77c7c570acee40100f2fae77ef5b461997b78e\nAuthor: Eric Brown <email address hidden>\nDate:   Mon Apr 13 21:58:20 2015 -0700\n\n    VMware: Don't raise exception on resize of 0 disk\n    \n    An exception should not be raised if someone resizes and instance\n    to a flavor with a zero disk size.\n    \n    Change-Id: I183740c974c2ba7e0608c28c05fa28a34a5e1966\n    Fixes-Bug: #1443697\n", 
            "date_created": "2015-06-10 04:10:09.067017+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-06-24 12:17:28.940369+00:00"
}