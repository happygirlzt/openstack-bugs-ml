{
    "status": "Invalid", 
    "last_updated": "2017-02-23 19:30:58.752571+00:00", 
    "description": "Nova API removed onSharedStorage parameter after v2.14, but we still have many users use API under v2.14. And we found that nova 100% fail to evacuate a server via novaclient, the error log as follows:\n\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher [req-b34b79d6-20ed-4488-b8d5-98f4007eb12e 681041a7364d4852930021d009c8dc2b bafaf53fac4346b9bcd6a77cf964b7af - - -] Exception during message handling: Invalid state of instance files on shared storage\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 138, in _dispatch_and_reply\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     incoming.message))\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 183, in _dispatch\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 127, in _do_dispatch\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/server.py\", line 150, in inner\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return func(*args, **kwargs)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 110, in wrapped\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     payload)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     self.force_reraise()\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 89, in wrapped\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 359, in decorated_function\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     LOG.warning(msg, e, instance=instance)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     self.force_reraise()\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 328, in decorated_function\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 409, in decorated_function\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 387, in decorated_function\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     self.force_reraise()\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 375, in decorated_function\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2809, in rebuild_instance\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     bdms, recreate, on_shared_storage, preserve_ephemeral)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2853, in _do_rebuild_instance_with_claim\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     self._do_rebuild_instance(*args, **kwargs)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2885, in _do_rebuild_instance\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     _(\"Invalid state of instance files on shared\"\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher InvalidSharedStorage: Invalid state of instance files on shared storage\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher\n\nI dug into the API source, and I found that the onSharedStorage will force to be converted to False value, even if in fact its value is None:\n\nhttps://github.com/openstack/nova/blob/master/nova/api/openstack/compute/evacuate.py#L43-L48\n\nIn other word, If we didn't pass this arguments, we will actually pass the False value. If we use shared-storage, it will not match the value getting from the backend driver.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1665548", 
    "owner": "None", 
    "id": 1665548, 
    "index": 7955, 
    "openned": "2017-02-17 06:25:30.858398+00:00", 
    "created": "2017-02-17 06:25:30.858398+00:00", 
    "title": "nova fail to evacuate as wrong onSharedStorarge parameter", 
    "comments": [
        {
            "content": "Nova API removed onSharedStorage parameter after v2.14, but we have many user to API under v2.14. And we found that nova 100% fail to evacuate a server via novaclient, the error log as follows:\n\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher [req-b34b79d6-20ed-4488-b8d5-98f4007eb12e 681041a7364d4852930021d009c8dc2b bafaf53fac4346b9bcd6a77cf964b7af - - -] Exception during message handling: Invalid state of instance files on shared storage\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 138, in _dispatch_and_reply\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     incoming.message))\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 183, in _dispatch\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 127, in _do_dispatch\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/server.py\", line 150, in inner\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return func(*args, **kwargs)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 110, in wrapped\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     payload)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     self.force_reraise()\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 89, in wrapped\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 359, in decorated_function\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     LOG.warning(msg, e, instance=instance)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     self.force_reraise()\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 328, in decorated_function\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 409, in decorated_function\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 387, in decorated_function\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     self.force_reraise()\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 375, in decorated_function\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2809, in rebuild_instance\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     bdms, recreate, on_shared_storage, preserve_ephemeral)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2853, in _do_rebuild_instance_with_claim\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     self._do_rebuild_instance(*args, **kwargs)\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2885, in _do_rebuild_instance\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher     _(\"Invalid state of instance files on shared\"\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher InvalidSharedStorage: Invalid state of instance files on shared storage\n2017-02-16 20:22:48.106 6144 ERROR oslo_messaging.rpc.dispatcher\n\nI dig into the API source, and I found that the onSharedStorage will force to be converted to False, even if in fact its value is None:\n\nhttps://github.com/openstack/nova/blob/master/nova/api/openstack/compute/evacuate.py#L43-L48\n\nIn other words, If we didn't pass this arguments, we will actually pass the False value. If we use shared-storage, it will not match the value from backend driver.", 
            "date_created": "2017-02-17 06:25:30.858398+00:00", 
            "author": "https://api.launchpad.net/1.0/~int32bit"
        }, 
        {
            "content": "Not sure I get your problem. Microversion 2.14 specifically removed onSharedStorage flag, but previous versions were having it mandatory on the API : https://github.com/openstack/nova/commit/c01d16e8\n\nNovaclient was defaulting the onSharedStorage to False previously (see https://github.com/openstack/python-novaclient/commit/5a3956c3 ) which meant that you needed to correctly provide the right flag value.\n\n\nYou say \"if we didn't pass this argument, we will pass the False value\": sure, that's what is attended for versions older than 2.14, so what's the problem ?\n\nJust in case you have shared storage and microversion older than 2.14, then you need to evacuate that way :\n\nnova evacuate --on-shared-storage true\n\n\nClosing the bug but feel free to reopen it if you consider I misunderstood the problem and then please explain it differently then.", 
            "date_created": "2017-02-23 19:30:47.265432+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }
    ], 
    "closed": "2017-02-23 19:30:57.117380+00:00"
}