{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:32:27.186022+00:00", 
    "description": "If your auth system isn't adding the service_catalog in the request headers, you get an unhandled exception in cinderclient.\n\n2012-09-10 14:44:55 INFO nova.api.openstack.wsgi [req-3ab60e8c-888d-4d63-b857-1de0db0e0ac8 account1 account1] POST http://localhost:8774/v1.1/account1/servers/5b92fa58-ab9c-4140-b841-64d0c41786c9/os-volume_attachments\n2012-09-10 14:44:55 AUDIT nova.api.openstack.compute.contrib.volumes [req-3ab60e8c-888d-4d63-b857-1de0db0e0ac8 account1 account1] Attach volume d7f55869-e888-4e1a-94f3-561725a4def6 to instance 5b92fa58-ab9c-4140-b841-64d0c41786c9 at /dev/vdf\n2012-09-10 14:44:55 DEBUG nova.openstack.common.rpc.amqp [-] Making asynchronous call on compute.nova ... from (pid=29457) multicall /opt/nova/nova/openstack/common/rpc/amqp.py:351\n2012-09-10 14:44:55 DEBUG nova.openstack.common.rpc.amqp [-] MSG_ID is e1918d3455b94332b78b55b5eea4fa10 from (pid=29457) multicall /opt/nova/nova/openstack/common/rpc/amqp.py:354\n2012-09-10 14:44:55 ERROR nova.api.openstack.wsgi [req-3ab60e8c-888d-4d63-b857-1de0db0e0ac8 account1 account1] Exception handling resource: 'NoneType' object is not iterable\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi Traceback (most recent call last):\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/api/openstack/wsgi.py\", line 925, in _process_stack\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     action_result = self.dispatch(meth, request, action_args)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/api/openstack/wsgi.py\", line 1013, in dispatch\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     return method(req=request, **action_args)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/api/openstack/compute/contrib/volumes.py\", line 392, in create\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     volume_id, device)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/compute/api.py\", line 114, in wrapped\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     return func(self, context, target, *args, **kwargs)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/compute/api.py\", line 104, in inner\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     return function(self, context, instance, *args, **kwargs)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/compute/api.py\", line 1750, in attach_volume\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     context, instance['uuid'], device)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     self.gen.next()\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/compute/api.py\", line 1742, in attach_volume\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     volume = self.volume_api.get(context, volume_id)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/volume/cinder.py\", line 135, in get\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     item = cinderclient(context).volumes.get(volume_id)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/volume/cinder.py\", line 59, in cinderclient\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     endpoint_type=endpoint_type)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/python-cinderclient/cinderclient/service_catalog.py\", line 53, in url_for\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     for service in catalog:\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi TypeError: 'NoneType' object is not iterable\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi\n2012-09-10 14:44:55 INFO nova.api.openstack.wsgi [req-3ab60e8c-888d-4d63-b857-1de0db0e0ac8 account1 account1] http://localhost:8774/v1.1/account1/servers/5b92fa58-ab9c-4140-b841-64d0c41786c9/os-volume_attachments returned with HTTP 400\n2012-09-10 14:44:55 INFO nova.osapi_compute.wsgi.server [req-3ab60e8c-888d-4d63-b857-1de0db0e0ac8 account1 account1] 127.0.0.1 - - [10/Sep/2012 14:44:55] \"POST /v1.1/account1/servers/5b92fa58-ab9c-4140-b841-64d0c41786c9/os-volume_attachments HTTP/1.1\" 400 338 0.274771\n\nI'd actually prefer to be able to set the cinder endpoint via a flag for two reasons.\n\n1) if you're using a reverse proxy, or another auth system, it may not be convenient or even make sense to add a copy of the service catalog to the request headers/context - the KeystoneContext middleware certainly seems to support the idea that it may not always be there.  Plus, glance uses flags afaict, and that works ok.\n2) There may be good reasons for the management endpoint that nova uses to talk to cinder to be different than the public endpoint, so the users catalog may not really help.  (e.g. public endpoint has os-volume_actions ext disabled to prevent user calling detach directly without updating nova)\n\nThe attached patch also happens to support noauth just cause it was \"right there\"", 
    "tags": [
        "cinder"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1048798", 
    "owner": "https://api.launchpad.net/1.0/~clay-gerrard", 
    "id": 1048798, 
    "index": 800, 
    "openned": "2012-09-10 20:27:37.230837+00:00", 
    "created": "2012-09-10 20:27:37.230837+00:00", 
    "title": "cinderclient service catalog lookup fails", 
    "comments": [
        {
            "content": "If your auth system isn't adding the service_catalog in the request headers, you get an unhandled exception in cinderclient.\n\n2012-09-10 14:44:55 INFO nova.api.openstack.wsgi [req-3ab60e8c-888d-4d63-b857-1de0db0e0ac8 account1 account1] POST http://localhost:8774/v1.1/account1/servers/5b92fa58-ab9c-4140-b841-64d0c41786c9/os-volume_attachments\n2012-09-10 14:44:55 AUDIT nova.api.openstack.compute.contrib.volumes [req-3ab60e8c-888d-4d63-b857-1de0db0e0ac8 account1 account1] Attach volume d7f55869-e888-4e1a-94f3-561725a4def6 to instance 5b92fa58-ab9c-4140-b841-64d0c41786c9 at /dev/vdf\n2012-09-10 14:44:55 DEBUG nova.openstack.common.rpc.amqp [-] Making asynchronous call on compute.nova ... from (pid=29457) multicall /opt/nova/nova/openstack/common/rpc/amqp.py:351\n2012-09-10 14:44:55 DEBUG nova.openstack.common.rpc.amqp [-] MSG_ID is e1918d3455b94332b78b55b5eea4fa10 from (pid=29457) multicall /opt/nova/nova/openstack/common/rpc/amqp.py:354\n2012-09-10 14:44:55 ERROR nova.api.openstack.wsgi [req-3ab60e8c-888d-4d63-b857-1de0db0e0ac8 account1 account1] Exception handling resource: 'NoneType' object is not iterable\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi Traceback (most recent call last):\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/api/openstack/wsgi.py\", line 925, in _process_stack\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     action_result = self.dispatch(meth, request, action_args)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/api/openstack/wsgi.py\", line 1013, in dispatch\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     return method(req=request, **action_args)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/api/openstack/compute/contrib/volumes.py\", line 392, in create\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     volume_id, device)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/compute/api.py\", line 114, in wrapped\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     return func(self, context, target, *args, **kwargs)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/compute/api.py\", line 104, in inner\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     return function(self, context, instance, *args, **kwargs)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/compute/api.py\", line 1750, in attach_volume\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     context, instance['uuid'], device)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     self.gen.next()\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/compute/api.py\", line 1742, in attach_volume\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     volume = self.volume_api.get(context, volume_id)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/volume/cinder.py\", line 135, in get\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     item = cinderclient(context).volumes.get(volume_id)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/nova/nova/volume/cinder.py\", line 59, in cinderclient\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     endpoint_type=endpoint_type)\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi   File \"/opt/python-cinderclient/cinderclient/service_catalog.py\", line 53, in url_for\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi     for service in catalog:\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi TypeError: 'NoneType' object is not iterable\n2012-09-10 14:44:55 TRACE nova.api.openstack.wsgi\n2012-09-10 14:44:55 INFO nova.api.openstack.wsgi [req-3ab60e8c-888d-4d63-b857-1de0db0e0ac8 account1 account1] http://localhost:8774/v1.1/account1/servers/5b92fa58-ab9c-4140-b841-64d0c41786c9/os-volume_attachments returned with HTTP 400\n2012-09-10 14:44:55 INFO nova.osapi_compute.wsgi.server [req-3ab60e8c-888d-4d63-b857-1de0db0e0ac8 account1 account1] 127.0.0.1 - - [10/Sep/2012 14:44:55] \"POST /v1.1/account1/servers/5b92fa58-ab9c-4140-b841-64d0c41786c9/os-volume_attachments HTTP/1.1\" 400 338 0.274771\n\nI'd actually prefer to be able to set the cinder endpoint via a flag for two reasons.\n\n1) if you're using a reverse proxy, or another auth system, it may not be convenient or even make sense to add a copy of the service catalog to the request headers/context - the KeystoneContext middleware certainly seems to support the idea that it may not always be there.  Plus, glance uses flags afaict, and that works ok.\n2) There may be good reasons for the management endpoint that nova uses to talk to cinder to be different than the public endpoint, so the users catalog may not really help.  (e.g. public endpoint has os-volume_actions ext disabled to prevent user calling detach directly without updating nova)\n\nThe attached patch also happens to support noauth just cause it was \"right there\"", 
            "date_created": "2012-09-10 20:27:37.230837+00:00", 
            "author": "https://api.launchpad.net/1.0/~clay-gerrard"
        }, 
        {
            "content": "", 
            "date_created": "2012-09-10 20:27:37.230837+00:00", 
            "author": "https://api.launchpad.net/1.0/~clay-gerrard"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/12748", 
            "date_created": "2012-09-11 00:39:57.775026+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/12748\nCommitted: http://github.com/openstack/nova/commit/0fa231f718662f2b83c11ffc39f977fdc8941107\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0fa231f718662f2b83c11ffc39f977fdc8941107\nAuthor: Clay Gerrard <email address hidden>\nDate:   Mon Sep 10 19:05:10 2012 -0500\n\n    Add flag cinder_endpoint_template to volume.cinder\n    \n    Add optional flag to allow cinder endpoint to be defined by flag rather\n    than extracted from the request context's service catalog.  No change to\n    default behavior.\n    \n    This flag allows deployers to use a seperate management endpoint for\n    cinder which compute can use exclusively to send messages to cinder, or\n    just use an auth system that doesn't add/forward the catalog along with\n    the request (e.g. noauth).\n    \n    Add python-cinderclient to tools/test-requires\n    \n    fix lp bug #1048798\n    \n    Change-Id: Icb416bf4df2a6e37024f1fbc866006d46d30bcf2\n", 
            "date_created": "2012-09-13 02:12:17.855450+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-09-19 06:35:18.846172+00:00"
}