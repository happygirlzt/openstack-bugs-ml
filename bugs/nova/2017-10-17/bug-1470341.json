{
    "status": "Fix Released", 
    "last_updated": "2016-09-02 01:16:17.851775+00:00", 
    "description": "Kilo code\n\nReproduce steps:\n\n1. Assuming that we have one nova-compute node named 'icm' which is added into one aggregate named 'zhaoqin'\n\n[root@icm ~]# nova aggregate-details zhaoqin\n+----+---------+-------------------+-------+--------------------------------+\n| Id | Name    | Availability Zone | Hosts | Metadata                       |\n+----+---------+-------------------+-------+--------------------------------+\n| 1  | zhaoqin | zhaoqin-az        | 'icm' | 'availability_zone=zhaoqin-az' |\n+----+---------+-------------------+-------+--------------------------------+\n[root@icm ~]# nova service-list\n+----+------------------+------+------------+---------+-------+----------------------------+-----------------+\n| Id | Binary           | Host | Zone       | Status  | State | Updated_at                 | Disabled Reason |\n+----+------------------+------+------------+---------+-------+----------------------------+-----------------+\n| 1  | nova-conductor   | icm  | internal   | enabled | up    | 2015-06-30T14:04:25.828383 | -               |\n| 3  | nova-scheduler   | icm  | internal   | enabled | up    | 2015-06-30T14:04:24.525474 | -               |\n| 4  | nova-consoleauth | icm  | internal   | enabled | up    | 2015-06-30T14:04:24.640657 | -               |\n| 5  | nova-compute     | icm  | zhaoqin-az | enabled | up    | 2015-06-30T14:04:19.865857 | -               |\n| 6  | nova-cert        | icm  | internal   | enabled | up    | 2015-06-30T14:04:25.080046 | -               |\n+----+------------------+------+------------+---------+-------+----------------------------+-----------------+\n\n\n2. Remove the nova-compute using service-delete command. However, the host is still in aggregate.\n\n[root@icm ~]# nova service-delete 5\n[root@icm ~]# nova service-list\n+----+------------------+------+----------+---------+-------+----------------------------+-----------------+\n| Id | Binary           | Host | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----+------------------+------+----------+---------+-------+----------------------------+-----------------+\n| 1  | nova-conductor   | icm  | internal | enabled | up    | 2015-06-30T14:05:35.826699 | -               |\n| 3  | nova-scheduler   | icm  | internal | enabled | up    | 2015-06-30T14:05:34.524507 | -               |\n| 4  | nova-consoleauth | icm  | internal | enabled | up    | 2015-06-30T14:05:34.638234 | -               |\n| 6  | nova-cert        | icm  | internal | enabled | up    | 2015-06-30T14:05:35.092009 | -               |\n+----+------------------+------+----------+---------+-------+----------------------------+-----------------+\n[root@icm ~]# nova aggregate-details zhaoqin\n+----+---------+-------------------+-------+--------------------------------+\n| Id | Name    | Availability Zone | Hosts | Metadata                       |\n+----+---------+-------------------+-------+--------------------------------+\n| 1  | zhaoqin | zhaoqin-az        | 'icm' | 'availability_zone=zhaoqin-az' |\n+----+---------+-------------------+-------+--------------------------------+\n\n\n3. Then, attempt to remove the host from aggregate, but fails. And we can not remove this aggregate either, because it is not empty.\n\n[root@icm ~]# nova aggregate-remove-host zhaoqin icm\nERROR (NotFound): Cannot remove host icm in aggregate 1: not found (HTTP 404) (Request-ID: req-b5024dbf-156a-44ee-b48e-fc53a331e05d)\n[root@icm ~]# nova aggregate-delete zhaoqin\nERROR (BadRequest): Cannot remove host from aggregate 1. Reason: Host aggregate is not empty. (HTTP 400) (Request-ID: req-a3c5346c-9a96-49f4-a76d-a7baa768a0ef)", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1470341", 
    "owner": "https://api.launchpad.net/1.0/~dinobot", 
    "id": 1470341, 
    "index": 4286, 
    "openned": "2015-07-01 05:16:36.873254+00:00", 
    "created": "2015-07-01 05:16:36.873254+00:00", 
    "title": "Cannot remove host from aggregate if host has been deleted", 
    "comments": [
        {
            "content": "Kilo code\n\nReproduce steps:\n\n1. Assuming that we have one nova-compute node named 'icm' which is added into one aggregate named 'zhaoqin'\n\n[root@icm ~]# nova aggregate-details zhaoqin\n+----+---------+-------------------+-------+--------------------------------+\n| Id | Name    | Availability Zone | Hosts | Metadata                       |\n+----+---------+-------------------+-------+--------------------------------+\n| 1  | zhaoqin | zhaoqin-az        | 'icm' | 'availability_zone=zhaoqin-az' |\n+----+---------+-------------------+-------+--------------------------------+\n[root@icm ~]# nova service-list\n+----+------------------+------+------------+---------+-------+----------------------------+-----------------+\n| Id | Binary           | Host | Zone       | Status  | State | Updated_at                 | Disabled Reason |\n+----+------------------+------+------------+---------+-------+----------------------------+-----------------+\n| 1  | nova-conductor   | icm  | internal   | enabled | up    | 2015-06-30T14:04:25.828383 | -               |\n| 3  | nova-scheduler   | icm  | internal   | enabled | up    | 2015-06-30T14:04:24.525474 | -               |\n| 4  | nova-consoleauth | icm  | internal   | enabled | up    | 2015-06-30T14:04:24.640657 | -               |\n| 5  | nova-compute     | icm  | zhaoqin-az | enabled | up    | 2015-06-30T14:04:19.865857 | -               |\n| 6  | nova-cert        | icm  | internal   | enabled | up    | 2015-06-30T14:04:25.080046 | -               |\n+----+------------------+------+------------+---------+-------+----------------------------+-----------------+\n\n\n2. Remove the nova-compute using service-delete command. However, the host is still in aggregate.\n\n[root@icm ~]# nova service-delete 5\n[root@icm ~]# nova service-list\n+----+------------------+------+----------+---------+-------+----------------------------+-----------------+\n| Id | Binary           | Host | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----+------------------+------+----------+---------+-------+----------------------------+-----------------+\n| 1  | nova-conductor   | icm  | internal | enabled | up    | 2015-06-30T14:05:35.826699 | -               |\n| 3  | nova-scheduler   | icm  | internal | enabled | up    | 2015-06-30T14:05:34.524507 | -               |\n| 4  | nova-consoleauth | icm  | internal | enabled | up    | 2015-06-30T14:05:34.638234 | -               |\n| 6  | nova-cert        | icm  | internal | enabled | up    | 2015-06-30T14:05:35.092009 | -               |\n+----+------------------+------+----------+---------+-------+----------------------------+-----------------+\n[root@icm ~]# nova aggregate-details zhaoqin\n+----+---------+-------------------+-------+--------------------------------+\n| Id | Name    | Availability Zone | Hosts | Metadata                       |\n+----+---------+-------------------+-------+--------------------------------+\n| 1  | zhaoqin | zhaoqin-az        | 'icm' | 'availability_zone=zhaoqin-az' |\n+----+---------+-------------------+-------+--------------------------------+\n\n\n3. Then, attempt to remove the host from aggregate, but fails. And we can not remove this aggregate either, because it is not empty.\n\n[root@icm ~]# nova aggregate-remove-host zhaoqin icm\nERROR (NotFound): Cannot remove host icm in aggregate 1: not found (HTTP 404) (Request-ID: req-b5024dbf-156a-44ee-b48e-fc53a331e05d)\n[root@icm ~]# nova aggregate-delete zhaoqin\nERROR (BadRequest): Cannot remove host from aggregate 1. Reason: Host aggregate is not empty. (HTTP 400) (Request-ID: req-a3c5346c-9a96-49f4-a76d-a7baa768a0ef)", 
            "date_created": "2015-07-01 05:16:36.873254+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhaoqin"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/262165", 
            "date_created": "2015-12-29 09:16:17.641123+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Michael Still (<email address hidden>) on branch: master\nReview: https://review.openstack.org/262165\nReason: As mentioned, I am abandoning this spec to clear out the review queue ready for Newton. That said, feel free to restore this change with an updated version when you're ready to proceed.", 
            "date_created": "2016-02-09 04:35:23.871124+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/306192", 
            "date_created": "2016-04-15 00:30:01.505003+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/306192\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=1abac25fd2967be00c4d584c06ba15ca4e8d04cc\nSubmitter: Jenkins\nBranch:    master\n\ncommit 1abac25fd2967be00c4d584c06ba15ca4e8d04cc\nAuthor: Danil Akhmetov <email address hidden>\nDate:   Fri Apr 29 11:45:28 2016 +0300\n\n    Remove compute host from all host aggregates when compute service is deleted\n    \n    Nova currently does not check if compute host included in host-aggregates\n    when user deletes compute service. It leads to inconsistency in nova host\n    aggregates, impossibility to remove compute host from host-aggregate or\n    remove host aggregate with invalid compute host.\n    \n    Change-Id: I8034da3827e47f3cd575e1f6ddf0e4be2f7dfecd\n    Closes-Bug: #1470341\n", 
            "date_created": "2016-07-17 22:51:52.955788+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Michael Still (<email address hidden>) on branch: master\nReview: https://review.openstack.org/197648\nReason: This code hasn't been updated in a long time, and is in merge conflict. I am going to abandon this review, but feel free to restore it if you're still working on this.", 
            "date_created": "2016-07-19 19:46:38.343798+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b3 development milestone.", 
            "date_created": "2016-09-02 01:16:17.153505+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-07-17 22:51:50.655726+00:00"
}