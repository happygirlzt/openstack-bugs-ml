{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:58:29.349819+00:00", 
    "description": "After Bug #907878  was resolved, migrations are failing against MySQL + InnoDB databases on precise:\n\n2012-01-16 00:33:12,574 INFO migrate.versioning.api [-] 63 -> 64... \n2012-01-16 00:33:12,643 DEBUG migrate.versioning.util [-] Disposing SQLAlchemy engine Engine(mysql://nova:<email address hidden>/nova) from (pid=4828) with_engine /usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py:162\nCommand failed, please check log for more info\n2012-01-16 00:33:12,645 CRITICAL nova [-] (OperationalError) (1025, \"Error on rename of './nova/#sql-1115_36' to './nova/instance_actions' (errno: 150)\") '\\nALTER TABLE instance_actions DROP COLUMN instance_id' ()\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/bin/nova-manage\", line 2382, in <module>\n(nova): TRACE:     main()\n(nova): TRACE:   File \"/usr/bin/nova-manage\", line 2370, in main\n(nova): TRACE:     fn(*fn_args, **fn_kwargs)\n(nova): TRACE:   File \"/usr/bin/nova-manage\", line 1207, in sync\n(nova): TRACE:     return migration.db_sync(version)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 35, in db_sync\n(nova): TRACE:     return IMPL.db_sync(version=version)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 51, in db_sync\n(nova): TRACE:     return versioning_api.upgrade(FLAGS.sql_connection, repo_path, version)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n(nova): TRACE:     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n(nova): TRACE:   File \"<string>\", line 2, in _migrate\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py\", line 159, in with_engine\n(nova): TRACE:     return f(*a, **kw)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 366, in _migrate\n(nova): TRACE:     schema.runchange(ver, change, changeset.step)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/schema.py\", line 91, in runchange\n(nova): TRACE:     change.run(self.engine, step)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/script/py.py\", line 145, in run\n(nova): TRACE:     script_func(engine)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migrate_repo/versions/064_change_instance_id_to_uuid_in_instance_actions.py\", line 52, in upgrade\n(nova): TRACE:     instance_actions.c.instance_id.drop()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/schema.py\", line 549, in drop\n(nova): TRACE:     engine._run_visitor(visitorcallable, self, connection, **kwargs)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 2234, in _run_visitor\n(nova): TRACE:     conn._run_visitor(visitorcallable, element, **kwargs)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1904, in _run_visitor\n(nova): TRACE:     **kwargs).traverse_single(element)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 53, in traverse_single\n(nova): TRACE:     ret = super(AlterTableVisitor, self).traverse_single(elem)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/sql/visitors.py\", line 86, in traverse_single\n(nova): TRACE:     return meth(obj, **kw)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 138, in visit_column\n(nova): TRACE:     self.execute()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 42, in execute\n(nova): TRACE:     return self.connection.execute(self.buffer.getvalue())\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1405, in execute\n(nova): TRACE:     params)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1582, in _execute_text\n(nova): TRACE:     statement, parameters\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1646, in _execute_context\n(nova): TRACE:     context)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1639, in _execute_context\n(nova): TRACE:     context)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 330, in do_execute\n(nova): TRACE:     cursor.execute(statement, parameters)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/MySQLdb/cursors.py\", line 174, in execute\n(nova): TRACE:     self.errorhandler(self, exc, value)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n(nova): TRACE:     raise errorclass, errorvalue\n(nova): TRACE: OperationalError: (OperationalError) (1025, \"Error on rename of './nova/#sql-1115_36' to './nova/instance_actions' (errno: 150)\") '\\nALTER TABLE instance_actions DROP COLUMN instance_id' ()\n(nova): TRACE: \n\nMySQL 5.5 on Precise has switched from using MyISAM as the default storage engine to InnoDB.  When InnoDB is configured as the default, migrations need to make sure FK constraints are removed.  This seems to only be an issue on systems that use InnoDB by default first. See  Bug #816236  and Bug #904888 .", 
    "tags": [], 
    "importance": "Critical", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/916992", 
    "owner": "https://api.launchpad.net/1.0/~zulcss", 
    "id": 916992, 
    "index": 45, 
    "openned": "2012-01-16 00:36:23.866906+00:00", 
    "created": "2012-01-16 00:35:14.194819+00:00", 
    "title": "Database migration v064 fails against MySQL 5.5 + InnoDB", 
    "comments": [
        {
            "content": "After Bug #907878  was resolved, migrations are failing against MySQL + InnoDB databases on precise:\n\n2012-01-16 00:33:12,574 INFO migrate.versioning.api [-] 63 -> 64... \n2012-01-16 00:33:12,643 DEBUG migrate.versioning.util [-] Disposing SQLAlchemy engine Engine(mysql://nova:<email address hidden>/nova) from (pid=4828) with_engine /usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py:162\nCommand failed, please check log for more info\n2012-01-16 00:33:12,645 CRITICAL nova [-] (OperationalError) (1025, \"Error on rename of './nova/#sql-1115_36' to './nova/instance_actions' (errno: 150)\") '\\nALTER TABLE instance_actions DROP COLUMN instance_id' ()\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/bin/nova-manage\", line 2382, in <module>\n(nova): TRACE:     main()\n(nova): TRACE:   File \"/usr/bin/nova-manage\", line 2370, in main\n(nova): TRACE:     fn(*fn_args, **fn_kwargs)\n(nova): TRACE:   File \"/usr/bin/nova-manage\", line 1207, in sync\n(nova): TRACE:     return migration.db_sync(version)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 35, in db_sync\n(nova): TRACE:     return IMPL.db_sync(version=version)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 51, in db_sync\n(nova): TRACE:     return versioning_api.upgrade(FLAGS.sql_connection, repo_path, version)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n(nova): TRACE:     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n(nova): TRACE:   File \"<string>\", line 2, in _migrate\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py\", line 159, in with_engine\n(nova): TRACE:     return f(*a, **kw)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 366, in _migrate\n(nova): TRACE:     schema.runchange(ver, change, changeset.step)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/schema.py\", line 91, in runchange\n(nova): TRACE:     change.run(self.engine, step)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/script/py.py\", line 145, in run\n(nova): TRACE:     script_func(engine)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migrate_repo/versions/064_change_instance_id_to_uuid_in_instance_actions.py\", line 52, in upgrade\n(nova): TRACE:     instance_actions.c.instance_id.drop()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/schema.py\", line 549, in drop\n(nova): TRACE:     engine._run_visitor(visitorcallable, self, connection, **kwargs)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 2234, in _run_visitor\n(nova): TRACE:     conn._run_visitor(visitorcallable, element, **kwargs)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1904, in _run_visitor\n(nova): TRACE:     **kwargs).traverse_single(element)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 53, in traverse_single\n(nova): TRACE:     ret = super(AlterTableVisitor, self).traverse_single(elem)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/sql/visitors.py\", line 86, in traverse_single\n(nova): TRACE:     return meth(obj, **kw)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 138, in visit_column\n(nova): TRACE:     self.execute()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 42, in execute\n(nova): TRACE:     return self.connection.execute(self.buffer.getvalue())\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1405, in execute\n(nova): TRACE:     params)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1582, in _execute_text\n(nova): TRACE:     statement, parameters\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1646, in _execute_context\n(nova): TRACE:     context)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1639, in _execute_context\n(nova): TRACE:     context)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 330, in do_execute\n(nova): TRACE:     cursor.execute(statement, parameters)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/MySQLdb/cursors.py\", line 174, in execute\n(nova): TRACE:     self.errorhandler(self, exc, value)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n(nova): TRACE:     raise errorclass, errorvalue\n(nova): TRACE: OperationalError: (OperationalError) (1025, \"Error on rename of './nova/#sql-1115_36' to './nova/instance_actions' (errno: 150)\") '\\nALTER TABLE instance_actions DROP COLUMN instance_id' ()\n(nova): TRACE: \n\nMySQL 5.5 on Precise has switched from using MyISAM as the default storage engine to InnoDB.  When InnoDB is configured as the default, migrations need to make sure FK constraints are removed.  This seems to only be an issue on systems that use InnoDB by default first. See  Bug #816236  and Bug #904888 .", 
            "date_created": "2012-01-16 00:35:14.194819+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/3110", 
            "date_created": "2012-01-17 19:26:49.259033+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/3110\nCommitted: http://github.com/openstack/nova/commit/35df99cf1dca5d9b0ca1cb09039845aa8bd3a49b\nSubmitter: Jenkins\nBranch:    master\n\ncommit 35df99cf1dca5d9b0ca1cb09039845aa8bd3a49b\nAuthor: Chuck Short <email address hidden>\nDate:   Tue Jan 17 14:24:09 2012 -0500\n\n    Drop FK constraint if it exists in migration 064\n    \n    Fixes LP bug 916992\n    \n    A workaround was originally applied to fix a FK constraint problem in migration\n    064.  The original bug only affected MySQL+InnoDB databases and was masked by\n    using MySQL+MyISAM.  Commit d503d6b1079f9eafe0430754214fc5b6d4e32c09 attempted\n    to improve the workaround, though it caused issues on databases not using\n    InnoDB, so it was reverted enitrely and we are back with the original bug.\n    \n    This change will attempt to drop the FK constraint only if it exists.  This\n    should now support MySQL installations that are configured both\n    default_storage_engine=MyISAM (oneiric) and default_storage_engine=InnoDB\n    (precise)\n    \n    Change-Id: Ie2cfa32d8f52b163f513679649da52a73fc501df\n    Signed-off-by: Adam Gandleman <email address hidden>\n    Signed-off-by: Chuck Short <email address hidden>\n", 
            "date_created": "2012-01-20 18:47:16.527813+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Status changed to 'Confirmed' because the bug affects multiple users.", 
            "date_created": "2012-01-23 16:06:53.220871+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ], 
    "closed": "2012-01-25 09:52:38.794498+00:00"
}