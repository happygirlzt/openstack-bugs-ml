{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:32:15.114081+00:00", 
    "description": "I ran the instance knowing that the compute node doesn't have sufficient RAM memory available. It shows errors in the nova-compute.log and the instance remains in pending state forever.\n\nnova-compute.log\n-------------------------------------------------------------\n[DEBUG:root:instance 1: starting...\nDEBUG:root:Running cmd (subprocess): ifconfig vlan101\nDEBUG:root:Result was 1\nDEBUG:root:Starting VLAN inteface vlan101\nDEBUG:root:Running cmd (subprocess): sudo vconfig set_name_type VLAN_PLUS_VID_NO_PAD\nDEBUG:root:Running cmd (subprocess): sudo vconfig add eth0 101\nDEBUG:root:Running cmd (subprocess): sudo ifconfig vlan101 up\nDEBUG:root:Running cmd (subprocess): ifconfig br101\nDEBUG:root:Result was 1\nDEBUG:root:Starting Bridge interface for vlan101\nDEBUG:root:Running cmd (subprocess): sudo brctl addbr br101\nDEBUG:root:Running cmd (subprocess): sudo brctl setfd br101 0\nDEBUG:root:Running cmd (subprocess): sudo brctl stp br101 off\nDEBUG:root:Running cmd (subprocess): sudo brctl addif br101 vlan101\nDEBUG:root:Running cmd (subprocess): sudo ifconfig br101 up\nDEBUG:root:Running cmd (subprocess): sudo iptables --delete FORWARD --in-interface br101 -j ACCEPT\nDEBUG:root:Result was 1\nDEBUG:root:Running cmd (subprocess): sudo iptables -I FORWARD --in-interface br101 -j ACCEPT\nDEBUG:root:Running cmd (subprocess): sudo iptables --delete FORWARD --out-interface br101 -j ACCEPT\nDEBUG:root:Result was 1\nDEBUG:root:Running cmd (subprocess): sudo iptables -I FORWARD --out-interface br101 -j ACCEPT\nDEBUG:root:instance instance-1165315330: starting toXML method\nDEBUG:root:instance instance-1165315330: finished toXML method\nDEBUG:root:Running cmd (subprocess): mkdir -p /home/tpatil/nova/nova/..//instances/instance-1165315330/\nDEBUG:root:Running cmd (subprocess): chmod 0777 /home/tpatil/nova/nova/..//instances/instance-1165315330/\nINFO:root:instance instance-1165315330: Creating image\nDEBUG:root:Running cmd (subprocess): /usr/bin/curl --fail --silent http://10.2.3.150:3333/_images/ami-tiny/image -H \"Date: Thu, 06 Jan 2011 21:49:39 GMT\" -H \"Authorization: AWS admin:admin:tg82sggZV1c1dPYNPK3cL49wDX0=\" -o /home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw\nDEBUG:root:Running cmd (subprocess): /usr/bin/curl --fail --silent http://10.2.3.150:3333/_images/aki-lucid/image -H \"Date: Thu, 06 Jan 2011 21:49:41 GMT\" -H \"Authorization: AWS admin:admin:sOXhKpkknKQk4aJ+LKf1BMyY+Qo=\" -o /home/tpatil/nova/nova/..//instances/instance-1165315330/kernel\nDEBUG:root:Running cmd (subprocess): /usr/bin/curl --fail --silent http://10.2.3.150:3333/_images/ari-lucid/image -H \"Date: Thu, 06 Jan 2011 21:49:41 GMT\" -H \"Authorization: AWS admin:admin:jnZiGj8T1zmMh9JyZxbzde+UUeo=\" -o /home/tpatil/nova/nova/..//instances/instance-1165315330/ramdisk\nINFO:root:instance instance-1165315330: injecting key into image ami-tiny\nDEBUG:root:Running cmd (subprocess): sudo losetup --find --show /home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw\nDEBUG:root:Running cmd (subprocess): sudo tune2fs -c 0 -i 0 /dev/loop2\nDEBUG:root:Running cmd (subprocess): sudo mount /dev/loop2 /tmp/tmpIejhuu\nDEBUG:root:Running cmd (subprocess): sudo mkdir -p /tmp/tmpIejhuu/root/.ssh\nDEBUG:root:Running cmd (subprocess): sudo chown root /tmp/tmpIejhuu/root/.ssh\nDEBUG:root:Running cmd (subprocess): sudo chmod 700 /tmp/tmpIejhuu/root/.ssh\nDEBUG:root:Running cmd (subprocess): sudo tee -a /tmp/tmpIejhuu/root/.ssh/authorized_keys\nDEBUG:root:Running cmd (subprocess): sudo umount /dev/loop2\nDEBUG:root:Running cmd (subprocess): rmdir /tmp/tmpIejhuu\nDEBUG:root:Running cmd (subprocess): sudo losetup --detach /dev/loop2\nDEBUG:root:Running cmd (subprocess): dd if=/dev/zero of=/home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw count=1 seek=20971519 bs=512\nDEBUG:root:Running cmd (subprocess): e2fsck -fp /home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw\nDEBUG:root:Result was 1\nDEBUG:root:Running cmd (subprocess): resize2fs /home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw\nDEBUG:root:Running cmd (subprocess): dd if=/dev/zero of=/home/tpatil/nova/nova/..//instances/instance-1165315330/disk count=1 seek=62 bs=512\nDEBUG:root:Running cmd (subprocess): parted --script /home/tpatil/nova/nova/..//instances/instance-1165315330/disk mklabel msdos\nDEBUG:root:Running cmd (subprocess): dd if=/home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw of=/home/tpatil/nova/nova/..//instances/instance-1165315330/disk bs=268435456 conv=notrunc,fsync oflag=append\nDEBUG:root:Running cmd (subprocess): parted --script /home/tpatil/nova/nova/..//instances/instance-1165315330/disk mkpart primary 63s 20971582s\nDEBUG:root:Running cmd (subprocess): dd if=/dev/zero of=/home/tpatil/nova/nova/..//instances/instance-1165315330/disk count=1 seek=188743742 bs=512\nDEBUG:root:Running cmd (subprocess): parted --script /home/tpatil/nova/nova/..//instances/instance-1165315330/disk mkpartfs primary ext2 20971583s 188743742s\nlibvir: QEMU error : internal error process exited while connecting to monitor: qemu: at most 2047 MB RAM can be simulated\nERROR:root:Uncaught exception\nTraceback (most recent call last):\n  File \"/home/tpatil/nova/nova/exception.py\", line 83, in _wrap\n    return f(*args, **kw)\n  File \"/home/tpatil/nova/nova/virt/libvirt_conn.py\", line 355, in spawn\n    self._conn.createXML(xml, 0)\n  File \"/usr/lib/python2.6/dist-packages/libvirt.py\", line 1289, in createXML\n    if ret is None:raise libvirtError('virDomainCreateXML() failed', conn=self)\nlibvirtError: internal error process exited while connecting to monitor: qemu: at most 2047 MB RAM can be simulated\n\nERROR:root:instance instance-1165315330: Failed to spawn\nTraceback (most recent call last):\n  File \"/home/tpatil/nova/nova/compute/manager.py\", line 146, in run_instance\n    self.driver.spawn(instance_ref)\n  File \"/home/tpatil/nova/nova/exception.py\", line 89, in _wrap\n    raise Error(str(e))\nError: internal error process exited while connecting to monitor: qemu: at most 2047 MB RAM can be simulated\n\nlibvir: QEMU error : Domain not found: no domain with matching name 'instance-1165315330'", 
    "tags": [], 
    "importance": "High", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/698336", 
    "owner": "https://api.launchpad.net/1.0/~blamar", 
    "id": 698336, 
    "index": 320, 
    "openned": "2011-01-06 21:58:00.369615+00:00", 
    "created": "2011-01-06 21:58:00.369615+00:00", 
    "title": "Insufficient resources (memory) causes instance to pending state forever", 
    "comments": [
        {
            "content": "I ran the instance knowing that the compute node doesn't have sufficient RAM memory available. It shows errors in the nova-compute.log and the instance remains in pending state forever.\n\nnova-compute.log\n-------------------------------------------------------------\n[DEBUG:root:instance 1: starting...\nDEBUG:root:Running cmd (subprocess): ifconfig vlan101\nDEBUG:root:Result was 1\nDEBUG:root:Starting VLAN inteface vlan101\nDEBUG:root:Running cmd (subprocess): sudo vconfig set_name_type VLAN_PLUS_VID_NO_PAD\nDEBUG:root:Running cmd (subprocess): sudo vconfig add eth0 101\nDEBUG:root:Running cmd (subprocess): sudo ifconfig vlan101 up\nDEBUG:root:Running cmd (subprocess): ifconfig br101\nDEBUG:root:Result was 1\nDEBUG:root:Starting Bridge interface for vlan101\nDEBUG:root:Running cmd (subprocess): sudo brctl addbr br101\nDEBUG:root:Running cmd (subprocess): sudo brctl setfd br101 0\nDEBUG:root:Running cmd (subprocess): sudo brctl stp br101 off\nDEBUG:root:Running cmd (subprocess): sudo brctl addif br101 vlan101\nDEBUG:root:Running cmd (subprocess): sudo ifconfig br101 up\nDEBUG:root:Running cmd (subprocess): sudo iptables --delete FORWARD --in-interface br101 -j ACCEPT\nDEBUG:root:Result was 1\nDEBUG:root:Running cmd (subprocess): sudo iptables -I FORWARD --in-interface br101 -j ACCEPT\nDEBUG:root:Running cmd (subprocess): sudo iptables --delete FORWARD --out-interface br101 -j ACCEPT\nDEBUG:root:Result was 1\nDEBUG:root:Running cmd (subprocess): sudo iptables -I FORWARD --out-interface br101 -j ACCEPT\nDEBUG:root:instance instance-1165315330: starting toXML method\nDEBUG:root:instance instance-1165315330: finished toXML method\nDEBUG:root:Running cmd (subprocess): mkdir -p /home/tpatil/nova/nova/..//instances/instance-1165315330/\nDEBUG:root:Running cmd (subprocess): chmod 0777 /home/tpatil/nova/nova/..//instances/instance-1165315330/\nINFO:root:instance instance-1165315330: Creating image\nDEBUG:root:Running cmd (subprocess): /usr/bin/curl --fail --silent http://10.2.3.150:3333/_images/ami-tiny/image -H \"Date: Thu, 06 Jan 2011 21:49:39 GMT\" -H \"Authorization: AWS admin:admin:tg82sggZV1c1dPYNPK3cL49wDX0=\" -o /home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw\nDEBUG:root:Running cmd (subprocess): /usr/bin/curl --fail --silent http://10.2.3.150:3333/_images/aki-lucid/image -H \"Date: Thu, 06 Jan 2011 21:49:41 GMT\" -H \"Authorization: AWS admin:admin:sOXhKpkknKQk4aJ+LKf1BMyY+Qo=\" -o /home/tpatil/nova/nova/..//instances/instance-1165315330/kernel\nDEBUG:root:Running cmd (subprocess): /usr/bin/curl --fail --silent http://10.2.3.150:3333/_images/ari-lucid/image -H \"Date: Thu, 06 Jan 2011 21:49:41 GMT\" -H \"Authorization: AWS admin:admin:jnZiGj8T1zmMh9JyZxbzde+UUeo=\" -o /home/tpatil/nova/nova/..//instances/instance-1165315330/ramdisk\nINFO:root:instance instance-1165315330: injecting key into image ami-tiny\nDEBUG:root:Running cmd (subprocess): sudo losetup --find --show /home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw\nDEBUG:root:Running cmd (subprocess): sudo tune2fs -c 0 -i 0 /dev/loop2\nDEBUG:root:Running cmd (subprocess): sudo mount /dev/loop2 /tmp/tmpIejhuu\nDEBUG:root:Running cmd (subprocess): sudo mkdir -p /tmp/tmpIejhuu/root/.ssh\nDEBUG:root:Running cmd (subprocess): sudo chown root /tmp/tmpIejhuu/root/.ssh\nDEBUG:root:Running cmd (subprocess): sudo chmod 700 /tmp/tmpIejhuu/root/.ssh\nDEBUG:root:Running cmd (subprocess): sudo tee -a /tmp/tmpIejhuu/root/.ssh/authorized_keys\nDEBUG:root:Running cmd (subprocess): sudo umount /dev/loop2\nDEBUG:root:Running cmd (subprocess): rmdir /tmp/tmpIejhuu\nDEBUG:root:Running cmd (subprocess): sudo losetup --detach /dev/loop2\nDEBUG:root:Running cmd (subprocess): dd if=/dev/zero of=/home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw count=1 seek=20971519 bs=512\nDEBUG:root:Running cmd (subprocess): e2fsck -fp /home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw\nDEBUG:root:Result was 1\nDEBUG:root:Running cmd (subprocess): resize2fs /home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw\nDEBUG:root:Running cmd (subprocess): dd if=/dev/zero of=/home/tpatil/nova/nova/..//instances/instance-1165315330/disk count=1 seek=62 bs=512\nDEBUG:root:Running cmd (subprocess): parted --script /home/tpatil/nova/nova/..//instances/instance-1165315330/disk mklabel msdos\nDEBUG:root:Running cmd (subprocess): dd if=/home/tpatil/nova/nova/..//instances/instance-1165315330/disk-raw of=/home/tpatil/nova/nova/..//instances/instance-1165315330/disk bs=268435456 conv=notrunc,fsync oflag=append\nDEBUG:root:Running cmd (subprocess): parted --script /home/tpatil/nova/nova/..//instances/instance-1165315330/disk mkpart primary 63s 20971582s\nDEBUG:root:Running cmd (subprocess): dd if=/dev/zero of=/home/tpatil/nova/nova/..//instances/instance-1165315330/disk count=1 seek=188743742 bs=512\nDEBUG:root:Running cmd (subprocess): parted --script /home/tpatil/nova/nova/..//instances/instance-1165315330/disk mkpartfs primary ext2 20971583s 188743742s\nlibvir: QEMU error : internal error process exited while connecting to monitor: qemu: at most 2047 MB RAM can be simulated\nERROR:root:Uncaught exception\nTraceback (most recent call last):\n  File \"/home/tpatil/nova/nova/exception.py\", line 83, in _wrap\n    return f(*args, **kw)\n  File \"/home/tpatil/nova/nova/virt/libvirt_conn.py\", line 355, in spawn\n    self._conn.createXML(xml, 0)\n  File \"/usr/lib/python2.6/dist-packages/libvirt.py\", line 1289, in createXML\n    if ret is None:raise libvirtError('virDomainCreateXML() failed', conn=self)\nlibvirtError: internal error process exited while connecting to monitor: qemu: at most 2047 MB RAM can be simulated\n\nERROR:root:instance instance-1165315330: Failed to spawn\nTraceback (most recent call last):\n  File \"/home/tpatil/nova/nova/compute/manager.py\", line 146, in run_instance\n    self.driver.spawn(instance_ref)\n  File \"/home/tpatil/nova/nova/exception.py\", line 89, in _wrap\n    raise Error(str(e))\nError: internal error process exited while connecting to monitor: qemu: at most 2047 MB RAM can be simulated\n\nlibvir: QEMU error : Domain not found: no domain with matching name 'instance-1165315330'", 
            "date_created": "2011-01-06 21:58:00.369615+00:00", 
            "author": "https://api.launchpad.net/1.0/~tpatil"
        }, 
        {
            "content": "With current code, the instance apparently goes to \"failed to spawn\" state. Are we supposed to recover from that ? How do we handle the case when the scheduler sends the request to a host that is already full (vcpu, memory...) ?", 
            "date_created": "2011-02-23 13:57:12.732801+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Currently it seems like the compute manager will throw away VMs which are in a failed state, which is even worse than what you described a month ago. \n\nThe '_poll_instance_states' method in nova/compute/manager.py will set the power_state of any VM which:\n    +has a database entry\n    +does not have a VM instance\n...to power_state.SHUTOFF.\n\nThe side effect of this is that every time compute manager polls for instance status it will actually set all power_state.FAILED VMs to power_state.SHUTOFF in the database and then call self.db.instance_destroy, effectively removing all history of the failed VM.\n\nIn an async system like nova, the failed VM should stick around IMO until it has been explicitly deleted. No automatic retries or anything else for the time being. That way a scheduler can get the 202 Accepted response, and then poll GET /servers/<id> until it sees a successful/error status.\n\nWhat my branch/fix covers:\n    1) Ensures '_poll_instance_states' does not clear out VMs which didn't get spawned correctly\n    2) Prettifies libvirt createXML error\n\nWhat it doesn't cover:\n    1) A method of getting the error back to the user/scheduler. You'll be able to see the VM failed, but without looking at the logs it's going to be impossible to tell why. This should be covered by the 'error-codes' blueprint which will be hopefully coming along for Diablo.\n    2) Automated tests for a scenario such as this\n\n", 
            "date_created": "2011-03-31 23:08:28.881440+00:00", 
            "author": "https://api.launchpad.net/1.0/~blamar"
        }, 
        {
            "content": "@Brian: are you actually working on that ? Or should we unassign you to let someone else take it ?", 
            "date_created": "2011-06-14 12:01:06.307760+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Is this still relevant? We recently added functionality to mark an instance that failed to start due to insufficient memory to the ERROR state. Also, _poll_instance_states seem to no longer exist.", 
            "date_created": "2011-09-29 15:55:20.350233+00:00", 
            "author": "https://api.launchpad.net/1.0/~aaron-lee"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/679\nCommitted: http://github.com/openstack/nova/commit/981f52794ed41b6f25dfc4a25b4b736e8f030a0f\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit 981f52794ed41b6f25dfc4a25b4b736e8f030a0f\nAuthor: Brian Lamar <email address hidden>\nDate:   Mon Sep 26 22:02:34 2011 -0400\n\n    Set error state on spawn error + integration test.\n    \n    This branch should at least be considered a partial fix for bug 698336.\n    \n    (Update) Grammar fix.\n    (Update) PEP8 fix.\n    (Update) Merged with origin/master\n    (Update) Fixed test (oops!) thanks comstud!\n    \n    Change-Id: I10d607fd40953e334670cc39040a9a00ff6919ac\n", 
            "date_created": "2011-10-04 17:25:36+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }
    ], 
    "closed": "2011-11-17 09:53:37.757758+00:00"
}