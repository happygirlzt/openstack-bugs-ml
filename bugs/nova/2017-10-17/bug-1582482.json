{
    "status": "Fix Released", 
    "last_updated": "2016-07-14 13:01:10.663518+00:00", 
    "description": "Description:\nlive-migration vm, the process raised exception in the function \"check_can_live_migrate_source\". Then, the vm looks like running and active. But, the bdm.connection_info lost 'device_path' key.\nreproduce:\n1. boot a vm from volume.\n2. In the /nova/virt/libvirt/driver.py  function \"check_can_live_migrate_source\" structure throws an exception.\n3. run nova live-migrate vm.\nthe nova-compute log as following:\n2016-05-17 08:56:53.003 11926 ERROR oslo_messaging.rpc.dispatcher [req-a29e2ad4-8b28-4075-9c79-966086f99946 95d365ac3e3948c9be554a33855c6e07 853481fe4d1e4d1eb0136c7ecf46e5e7 - - -] Exception during message handling: 2C5_10_DELL05 is not on shared storage: Live migration can not be used without shared storage.\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 8161, in check_can_live_migrate_source\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     dest_check_data)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     payload)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 405, in decorated_function\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 393, in decorated_function\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 6097, in check_can_live_migrate_source\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     block_device_info)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 5699, in check_can_live_migrate_source\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     raise exception.InvalidSharedStorage(reason=reason, path=source)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher InvalidSharedStorage: 2C5_10_DELL05 is not on shared storage: Live migration can not be used without shared storage.\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher \n2016-05-17 08:56:53.006 11926 ERROR oslo_messaging._drivers.common [req-a29e2ad4-8b28-4075-9c79-966086f99946 95d365ac3e3948c9be554a33855c6e07 853481fe4d1e4d1eb0136c7ecf46e5e7 - - -] Returning exception 2C5_10_DELL05 is not on shared storage: Live migration can not be used without shared storage. to caller\n4.check bdm information of the vm.\nBefore run live-migratin, the bdm infromation as following:\n{\"driver_volume_type\": \"iscsi\", \"connector\": {\"ip\": \"10.43.203.3\", \"host\": \"2C5_10_DELL05\", \"multipath\": true, \"initiator\": \"iqn.opencos.rh:995be1fac333\"}, \"serial\": \"78b80439-8bea-4900-aa7e-ddf2a9b0b8cf\", \"data\": {\"target_luns\": [3, 3, 3, 3, 3, 3, 3], \"target_iqns\": [\"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\"], \"device_path\": \"/dev/mapper/mpathdks\", \"target_discovered\": false, \"qos_specs\": null, \"target_iqn\": \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"target_portals\": [\"172.168.102.25:3260\", \"172.168.103.25:3260\", \"172.168.104.25:3260\", \"172.168.101.25:3260\", \"172.168.102.27:3260\", \"172.168.103.27:3260\", \"172.168.104.27:3260\"], \"volume_id\": \"78b80439-8bea-4900-aa7e-ddf2a9b0b8cf\", \"target_lun\": 3, \"access_mode\": \"rw\", \"multipath_id\": \"mpathdks\", \"target_portal\": \"172.168.102.25:3260\"}}\n\nAfter run live-migration, the bdm information as following:\n{\"driver_volume_type\": \"iscsi\", \"connector\": {\"ip\": \"10.43.203.3\", \"host\": \"2C5_10_DELL05\", \"multipath\": true, \"initiator\": \"iqn.opencos.rh:995be1fac333\"}, \"serial\": \"78b80439-8bea-4900-aa7e-ddf2a9b0b8cf\", \"data\": {\"target_luns\": [3, 3, 3, 3, 3, 3, 3], \"target_iqns\": [\"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\"], \"target_discovered\": false, \"qos_specs\": null, \"target_iqn\": \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"target_portals\": [\"172.168.102.25:3260\", \"172.168.103.25:3260\", \"172.168.104.25:3260\", \"172.168.101.25:3260\", \"172.168.102.27:3260\", \"172.168.103.27:3260\", \"172.168.104.27:3260\"], \"volume_id\": \"78b80439-8bea-4900-aa7e-ddf2a9b0b8cf\", \"target_lun\": 3, \"access_mode\": \"rw\", \"multipath_id\": \"mpathdks\", \"target_portal\": \"172.168.102.25:3260\"}}\nSo, the device_path key was lost.\n\nEnvironment:\nI use mitika version.", 
    "tags": [
        "live-migration"
    ], 
    "importance": "Medium", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1582482", 
    "owner": "https://api.launchpad.net/1.0/~zheng-yao1", 
    "id": 1582482, 
    "index": 4537, 
    "openned": "2016-05-17 03:09:26.832443+00:00", 
    "created": "2016-05-17 03:09:26.832443+00:00", 
    "title": "live-migration check source  disk failed caused bdm.device_path lost", 
    "comments": [
        {
            "content": "Description:\nlive-migration vm, the process raised exception in the function \"check_can_live_migrate_source\". Then, the vm looks like running and active. But, the bdm.connection_info lost 'device_path' key.\nreproduce:\n1. boot a vm from volume.\n2. In the /nova/virt/libvirt/driver.py  function \"check_can_live_migrate_source\" structure throws an exception.\n3. run nova live-migrate vm.\nthe nova-compute log as following:\n2016-05-17 08:56:53.003 11926 ERROR oslo_messaging.rpc.dispatcher [req-a29e2ad4-8b28-4075-9c79-966086f99946 95d365ac3e3948c9be554a33855c6e07 853481fe4d1e4d1eb0136c7ecf46e5e7 - - -] Exception during message handling: 2C5_10_DELL05 is not on shared storage: Live migration can not be used without shared storage.\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     executor_callback))\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     executor_callback)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 8161, in check_can_live_migrate_source\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     dest_check_data)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 88, in wrapped\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     payload)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 71, in wrapped\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 405, in decorated_function\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 393, in decorated_function\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 6097, in check_can_live_migrate_source\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     block_device_info)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 5699, in check_can_live_migrate_source\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher     raise exception.InvalidSharedStorage(reason=reason, path=source)\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher InvalidSharedStorage: 2C5_10_DELL05 is not on shared storage: Live migration can not be used without shared storage.\n2016-05-17 08:56:53.003 11926 TRACE oslo_messaging.rpc.dispatcher \n2016-05-17 08:56:53.006 11926 ERROR oslo_messaging._drivers.common [req-a29e2ad4-8b28-4075-9c79-966086f99946 95d365ac3e3948c9be554a33855c6e07 853481fe4d1e4d1eb0136c7ecf46e5e7 - - -] Returning exception 2C5_10_DELL05 is not on shared storage: Live migration can not be used without shared storage. to caller\n4.check bdm information of the vm.\nBefore run live-migratin, the bdm infromation as following:\n{\"driver_volume_type\": \"iscsi\", \"connector\": {\"ip\": \"10.43.203.3\", \"host\": \"2C5_10_DELL05\", \"multipath\": true, \"initiator\": \"iqn.opencos.rh:995be1fac333\"}, \"serial\": \"78b80439-8bea-4900-aa7e-ddf2a9b0b8cf\", \"data\": {\"target_luns\": [3, 3, 3, 3, 3, 3, 3], \"target_iqns\": [\"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\"], \"device_path\": \"/dev/mapper/mpathdks\", \"target_discovered\": false, \"qos_specs\": null, \"target_iqn\": \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"target_portals\": [\"172.168.102.25:3260\", \"172.168.103.25:3260\", \"172.168.104.25:3260\", \"172.168.101.25:3260\", \"172.168.102.27:3260\", \"172.168.103.27:3260\", \"172.168.104.27:3260\"], \"volume_id\": \"78b80439-8bea-4900-aa7e-ddf2a9b0b8cf\", \"target_lun\": 3, \"access_mode\": \"rw\", \"multipath_id\": \"mpathdks\", \"target_portal\": \"172.168.102.25:3260\"}}\n\nAfter run live-migration, the bdm information as following:\n{\"driver_volume_type\": \"iscsi\", \"connector\": {\"ip\": \"10.43.203.3\", \"host\": \"2C5_10_DELL05\", \"multipath\": true, \"initiator\": \"iqn.opencos.rh:995be1fac333\"}, \"serial\": \"78b80439-8bea-4900-aa7e-ddf2a9b0b8cf\", \"data\": {\"target_luns\": [3, 3, 3, 3, 3, 3, 3], \"target_iqns\": [\"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\", \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:91\"], \"target_discovered\": false, \"qos_specs\": null, \"target_iqn\": \"iqn.2099-01.cn.com.zte:usp.spr11-4c:09:b4:b0:55:90\", \"target_portals\": [\"172.168.102.25:3260\", \"172.168.103.25:3260\", \"172.168.104.25:3260\", \"172.168.101.25:3260\", \"172.168.102.27:3260\", \"172.168.103.27:3260\", \"172.168.104.27:3260\"], \"volume_id\": \"78b80439-8bea-4900-aa7e-ddf2a9b0b8cf\", \"target_lun\": 3, \"access_mode\": \"rw\", \"multipath_id\": \"mpathdks\", \"target_portal\": \"172.168.102.25:3260\"}}\nSo, the device_path key was lost.\n\nEnvironment:\nI use mitika version.", 
            "date_created": "2016-05-17 03:09:26.832443+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "Hi YaoZheng_ZTE: I noticed you've assigned this bug to yourself. If you are currently working on a patch, can you please change the status of this bug to In Progress? Otherwise, if you are not working on a patch, can you remove yourself as the assignee?", 
            "date_created": "2016-05-17 18:11:07.252198+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "Hi Augustina:\n   I'm working on a patch. I will change the status. Thank you!", 
            "date_created": "2016-05-18 03:30:42.366823+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/330944", 
            "date_created": "2016-06-17 08:21:03.571925+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/330944\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c2f57a126f135879b96947a6734db9b0e01c2ad3\nSubmitter: Jenkins\nBranch:    master\n\ncommit c2f57a126f135879b96947a6734db9b0e01c2ad3\nAuthor: zhengyao1 <email address hidden>\nDate:   Fri Jun 17 17:42:00 2016 +0800\n\n    live migration check source failed caused bdm.device_path lost\n    \n    Live migration vm, the process raised exception in the function\n    \"check_can_live_migrate_source\". Then, the vm looks like running\n    and active. But, the bdm.connection_info lost 'device_path' key.\n    \n    The reason is:the function check_can_live_migrate_source call\n    the function _get_instance_block_device_info to check\n    cinderclient, but this function will call cinder\n    initialize_connection api interface and update\n    BDM.connection_info, but cinder return connection_info has no\n    'device_path' key. So after that, 'device_path' key lost.\n    \n    modification scheme:as for vm has been connected the volume,\n    check in source host that is of small significance.\n    Unfortunately, this interface will trigger the volume add SAN\n    mapping group again.This interface call is very time consuming.\n    In addition, For some SAN, this behavior may trigger errors. So\n    this patch set the parameter 'refresh_conn_info' to false in\n    order to remove the interface initialize_connection call.\n    \n    Change-Id: Ice8882b0c0e838072526ed285648bb8840968072\n    Closes-Bug: #1582482\n", 
            "date_created": "2016-06-27 11:10:57.371300+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b2 development milestone.", 
            "date_created": "2016-07-14 13:01:09.889609+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }
    ], 
    "closed": "2016-06-27 11:10:54.727091+00:00"
}