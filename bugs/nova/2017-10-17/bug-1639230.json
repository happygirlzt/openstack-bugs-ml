{
    "status": "Fix Released", 
    "last_updated": "2017-07-28 22:58:16.201080+00:00", 
    "description": "Tried to create a server in a multi-host environment. The create failed on the first host that was attempted due to a ClientException raised by nova.volume.cinder.API.initialize_connection while trying to attach a volume. When the build was rescheduled on a different host, it should have realized that the network was already allocated by the first attempt and reused that, but the network_allocated=True from instance.system_metadata somehow disappeared, leading to the following exception that causes the reschedule to fail:\n\n2016-10-13 04:48:29.007 16273 WARNING nova.network.neutronv2.api [req-9b343ef7-e8d9-4a61-b86c-a61908afe4df 0688b01e6439ca32d698d20789d52169126fb41fb1a4ddafcebb97d854e836c9 94e1baed634145e0aade858973ae88e8 - - -] [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b] Neutron error creating port on network 5038a36b-cb1e-4a61-b26c-a05a80b37ed6\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b] Traceback (most recent call last):\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 392, in _create_port_minimal\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     port_response = port_client.create_port(port_req_body)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 98, in wrapper\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     ret = obj(*args, **kwargs)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 750, in create_port\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     return self.post(self.ports_path, body=body)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 98, in wrapper\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     ret = obj(*args, **kwargs)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 365, in post\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     headers=headers, params=params)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 98, in wrapper\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     ret = obj(*args, **kwargs)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 300, in do_request\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     self._handle_fault_response(status_code, replybody, resp)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 98, in wrapper\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     ret = obj(*args, **kwargs)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 275, in _handle_fault_response\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     exception_handler_v20(status_code, error_body)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 91, in exception_handler_v20\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     request_ids=request_ids)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b] Conflict: IP address 9.114.25.215 already allocated in subnet e2d1b84e-2308-48ab-9101-0d48721c9fd2\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b] Neutron server returns request_ids: ['req-682b2d6b-768f-413d-862c-32490cad5589']\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]\n\nfound in newton", 
    "tags": [
        "compute", 
        "mitaka-backport-potential", 
        "newton-rc-potential", 
        "unified-objects"
    ], 
    "importance": "High", 
    "heat": 52, 
    "link": "https://bugs.launchpad.net/nova/+bug/1639230", 
    "owner": "https://api.launchpad.net/1.0/~btang-d", 
    "id": 1639230, 
    "index": 2003, 
    "openned": "2016-11-04 12:57:45.940275+00:00", 
    "created": "2016-11-04 12:57:45.940275+00:00", 
    "title": "reschedule fails with ip already allocated error", 
    "comments": [
        {
            "content": "Tried to create a server in a multi-host environment. The create failed on the first host that was attempted due to a ClientException raised by nova.volume.cinder.API.initialize_connection while trying to attach a volume. When the build was rescheduled on a different host, it should have realized that the network was already allocated by the first attempt and reused that, but the network_allocated=True from instance.system_metadata somehow disappeared, leading to the following exception that causes the reschedule to fail:\n\n2016-10-13 04:48:29.007 16273 WARNING nova.network.neutronv2.api [req-9b343ef7-e8d9-4a61-b86c-a61908afe4df 0688b01e6439ca32d698d20789d52169126fb41fb1a4ddafcebb97d854e836c9 94e1baed634145e0aade858973ae88e8 - - -] [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b] Neutron error creating port on network 5038a36b-cb1e-4a61-b26c-a05a80b37ed6\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b] Traceback (most recent call last):\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 392, in _create_port_minimal\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     port_response = port_client.create_port(port_req_body)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 98, in wrapper\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     ret = obj(*args, **kwargs)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 750, in create_port\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     return self.post(self.ports_path, body=body)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 98, in wrapper\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     ret = obj(*args, **kwargs)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 365, in post\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     headers=headers, params=params)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 98, in wrapper\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     ret = obj(*args, **kwargs)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 300, in do_request\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     self._handle_fault_response(status_code, replybody, resp)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/nova/network/neutronv2/api.py\", line 98, in wrapper\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     ret = obj(*args, **kwargs)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 275, in _handle_fault_response\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     exception_handler_v20(status_code, error_body)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]   File \"/usr/lib/python2.7/site-packages/neutronclient/v2_0/client.py\", line 91, in exception_handler_v20\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]     request_ids=request_ids)\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b] Conflict: IP address 9.114.25.215 already allocated in subnet e2d1b84e-2308-48ab-9101-0d48721c9fd2\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b] Neutron server returns request_ids: ['req-682b2d6b-768f-413d-862c-32490cad5589']\n2016-10-13 04:48:29.007 16273 ERROR nova.network.neutronv2.api [instance: b85d6c6c-e385-4601-aa47-5c580f893c9b]\n\nfound in newton", 
            "date_created": "2016-11-04 12:57:45.940275+00:00", 
            "author": "https://api.launchpad.net/1.0/~edmondsw"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/393805", 
            "date_created": "2016-11-04 14:39:47.515034+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/393805\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=9345ed40e85e291d2f9e9aac24d468f40140ae0e\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9345ed40e85e291d2f9e9aac24d468f40140ae0e\nAuthor: Brent Tang <email address hidden>\nDate:   Fri Nov 4 07:35:25 2016 -0700\n\n    Instance obj_clone leaves metadata as changed\n    \n    When performing an obj_clone on an Instance object, it relies on the\n    base obj_clone's deep copy method which just goes through all of the\n    fields and duplicates them on the clone.  However, the Instance object\n    has internal tracking attributes for metadata and system_metadata that\n    keep track of which keys have changed.  Since these don't get copied\n    over on the deep copy, these will show up as having changed on the\n    cloned Instance (if they had metadata set originally) and on a save\n    on this cloned object will end up updating the metadata in the db\n    which if these have stale information will wipe out other changes.\n    \n    Such a scenario to this is occurring during build_instance where the\n    Claim constructor is saving off a clone of the Instance object\n    so that it will have the current copy.  In the case of a failure\n    during the build_instance, the claim will use this current copy\n    to then set the value of the host on the instance to None.  Since\n    the clone reflects that the system_metadata has changed, it will\n    as part of the save try to update the system_metadata in the db,\n    which since it is stale will wipe out changes made.\n    \n    In the case of the issue being fixed here, the value in the\n    system_metdata being wiped out is the network_allocated=True\n    attribute.  By this being wiped out then reschedules of that\n    build_instance fail in cases where the IP address has been\n    assigned to the instance.\n    \n    Change-Id: Ie49a90993fb9643c04d75402dbaaa933c6b5222e\n    Closes-Bug: #1639230\n", 
            "date_created": "2016-11-11 20:58:02.044965+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/396782", 
            "date_created": "2016-11-11 21:43:23.338214+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/396782\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=bc620681ff2d7aa6c40c961da76d598c9f23281d\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit bc620681ff2d7aa6c40c961da76d598c9f23281d\nAuthor: Brent Tang <email address hidden>\nDate:   Fri Nov 4 07:35:25 2016 -0700\n\n    Instance obj_clone leaves metadata as changed\n    \n    When performing an obj_clone on an Instance object, it relies on the\n    base obj_clone's deep copy method which just goes through all of the\n    fields and duplicates them on the clone.  However, the Instance object\n    has internal tracking attributes for metadata and system_metadata that\n    keep track of which keys have changed.  Since these don't get copied\n    over on the deep copy, these will show up as having changed on the\n    cloned Instance (if they had metadata set originally) and on a save\n    on this cloned object will end up updating the metadata in the db\n    which if these have stale information will wipe out other changes.\n    \n    Such a scenario to this is occurring during build_instance where the\n    Claim constructor is saving off a clone of the Instance object\n    so that it will have the current copy.  In the case of a failure\n    during the build_instance, the claim will use this current copy\n    to then set the value of the host on the instance to None.  Since\n    the clone reflects that the system_metadata has changed, it will\n    as part of the save try to update the system_metadata in the db,\n    which since it is stale will wipe out changes made.\n    \n    In the case of the issue being fixed here, the value in the\n    system_metdata being wiped out is the network_allocated=True\n    attribute.  By this being wiped out then reschedules of that\n    build_instance fail in cases where the IP address has been\n    assigned to the instance.\n    \n    Change-Id: Ie49a90993fb9643c04d75402dbaaa933c6b5222e\n    Closes-Bug: #1639230\n    (cherry picked from commit 9345ed40e85e291d2f9e9aac24d468f40140ae0e)\n", 
            "date_created": "2016-11-15 02:32:35.432162+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b1 development milestone.", 
            "date_created": "2016-11-17 13:11:43.912296+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.3 release.", 
            "date_created": "2016-12-19 12:02:22.432033+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-11-11 20:57:58.768420+00:00"
}