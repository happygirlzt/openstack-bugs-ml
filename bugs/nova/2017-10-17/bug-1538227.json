{
    "status": "Fix Released", 
    "last_updated": "2016-10-20 09:39:05.301429+00:00", 
    "description": "We're trying to upgrade to liberty using SaltStack \n(just for context, same issue running the command \nfrom a shell).\n\nAt one point `nova-manage db sync` is executed.\nBecause of #1511466 we get a *critical* error but\nthe command still returns an exitcode of 0.\nIn a somewhat POSIX environment this means\n\"everything is fine\" so the deployment just\ncontinues with an outdated database schema.\n\n          ID: nova-manage db sync\n    Function: cmd.run\n        Name: nova-manage db sync; sleep 15\n      Result: True\n     Comment: Command \"nova-manage db sync; sleep 15\" run\n     Started: 18:07:09.511897\n    Duration: 17747.739 ms\n     Changes:   \n              ----------\n              pid:\n                  18000\n              retcode:\n                  0\n              stderr:\n                  No handlers could be found for logger \"oslo_config.cfg\"\n                  2016-01-26 18:07:12.092 18001 DEBUG migrate.versioning.repository [-] Loading repository /usr/lib/python2.7/dist-packages/nova/db/sql\nalchemy/migrate_repo... __init__ /usr/lib/python2.7/dist-packages/migrate/versioning/repository.py:76\n                  2016-01-26 18:07:12.093 18001 DEBUG migrate.versioning.script.base [-] Loading script /usr/lib/python2.7/dist-packages/nova/db/sqlalc\nhemy/migrate_repo/versions/216_havana.py... __init__ /usr/lib/python2.7/dist-packages/migrate/versioning/script/base.py:27\n[...]\n[...]\n[...]\n                  2016-01-26 18:07:12.157 18001 INFO migrate.versioning.api [-] 290 -> 291... \n                  2016-01-26 18:07:12.167 18001 CRITICAL nova [-] ValidationError: There are still 3 unmigrated flavor records. Migration cannot conti$\nue until all instance flavor records have been migrated to the new format. Please run `nova-manage db migrate_flavor_data' first.\n                  2016-01-26 18:07:12.167 18001 ERROR nova Traceback (most recent call last):\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n                  2016-01-26 18:07:12.167 18001 ERROR nova     sys.exit(main())\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 1443, in main\n                  2016-01-26 18:07:12.167 18001 ERROR nova     ret = fn(*fn_args, **fn_kwargs)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 910, in sync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return migration.db_sync(version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 26, in db_sync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return IMPL.db_sync(version=version, database=database)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 106, in db_$\nync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"<string>\", line 2, in _migrate\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py\", line 160, in \nwith_engine\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return f(*a, **kw)\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return migration.db_sync(version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 26, in db_sync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return IMPL.db_sync(version=version, database=database)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 106, in db_s\nync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"<string>\", line 2, in _migrate\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py\", line 160, in \nwith_engine\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return f(*a, **kw)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 366, in _migrate\n                  2016-01-26 18:07:12.167 18001 ERROR nova     schema.runchange(ver, change, changeset.step)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/schema.py\", line 93, in runchan$\ne\n                  2016-01-26 18:07:12.167 18001 ERROR nova     change.run(self.engine, step)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/script/py.py\", line 148, in run\n                  2016-01-26 18:07:12.167 18001 ERROR nova     script_func(engine)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migrate_repo/versions/291_enfor$\ne_flavors_migrated.py\", line 35, in upgrade\n                  2016-01-26 18:07:12.167 18001 ERROR nova     raise exception.ValidationError(detail=msg)\n                  2016-01-26 18:07:12.167 18001 ERROR nova ValidationError: There are still 3 unmigrated flavor records. Migration cannot continue unt$\nl all instance flavor records have been migrated to the new format. Please run `nova-manage db migrate_flavor_data' first.\n                  2016-01-26 18:07:12.167 18001 ERROR nova\n              stdout:\n                  Command failed, please check log for more info\n----------\n \n\nroot@controller:~# dpkg -l | grep nova\nii  nova-api                            2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - API frontend\nii  nova-cert                           2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - certificate management\nii  nova-common                         2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - common files\nii  nova-conductor                      2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - conductor service\nii  nova-consoleauth                    2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - Console Authenticator\nii  nova-novncproxy                     2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - NoVNC proxy\nii  nova-scheduler                      2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - virtual machine scheduler\nii  nova-spiceproxy                     2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - spice html5 proxy\nii  python-nova                         2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute Python libraries\nii  python-novaclient                   2:2.30.1-1~cloud0                     all          client library for OpenStack Compute API\nroot@controller:~# \n\n\nHow to reproduce:\n* setup openstack < liberty\n* update pkgs to liberty \n* run `nova-manage db sync && echo \"you shouldn't see this because the prev cmd failed\" `\n(The error while running the command is topic of issue #1511466)\n\nExpected result:\nFailing `nova-manage db sync` returns a none-zero exitcode and thus signals a failure\nas any utility on a unix-like system should.\n\nActual result:\nFailing `nova-manage db sync` still returns an exitcode of 0 signaling successful\nupdate of database schemas to the running shell/command/automation tool of choice.", 
    "tags": [
        "nova-manage"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1538227", 
    "owner": "https://api.launchpad.net/1.0/~stephenfinucane", 
    "id": 1538227, 
    "index": 1870, 
    "openned": "2016-01-26 17:43:40.236480+00:00", 
    "created": "2016-01-26 17:43:40.236480+00:00", 
    "title": "Failed `nova-manage db sync` returns exitcode of 0", 
    "comments": [
        {
            "content": "We're trying to upgrade to liberty using SaltStack \n(just for context, same issue running the command \nfrom a shell).\n\nAt one point `nova-manage db sync` is executed.\nBecause of #1511466 we get a *critical* error but\nthe command still returns an exitcode of 0.\nIn a somewhat POSIX environment this means\n\"everything is fine\" so the deployment just\ncontinues with an outdated database schema.\n\n          ID: nova-manage db sync\n    Function: cmd.run\n        Name: nova-manage db sync; sleep 15\n      Result: True\n     Comment: Command \"nova-manage db sync; sleep 15\" run\n     Started: 18:07:09.511897\n    Duration: 17747.739 ms\n     Changes:   \n              ----------\n              pid:\n                  18000\n              retcode:\n                  0\n              stderr:\n                  No handlers could be found for logger \"oslo_config.cfg\"\n                  2016-01-26 18:07:12.092 18001 DEBUG migrate.versioning.repository [-] Loading repository /usr/lib/python2.7/dist-packages/nova/db/sql\nalchemy/migrate_repo... __init__ /usr/lib/python2.7/dist-packages/migrate/versioning/repository.py:76\n                  2016-01-26 18:07:12.093 18001 DEBUG migrate.versioning.script.base [-] Loading script /usr/lib/python2.7/dist-packages/nova/db/sqlalc\nhemy/migrate_repo/versions/216_havana.py... __init__ /usr/lib/python2.7/dist-packages/migrate/versioning/script/base.py:27\n[...]\n[...]\n[...]\n                  2016-01-26 18:07:12.157 18001 INFO migrate.versioning.api [-] 290 -> 291... \n                  2016-01-26 18:07:12.167 18001 CRITICAL nova [-] ValidationError: There are still 3 unmigrated flavor records. Migration cannot conti$\nue until all instance flavor records have been migrated to the new format. Please run `nova-manage db migrate_flavor_data' first.\n                  2016-01-26 18:07:12.167 18001 ERROR nova Traceback (most recent call last):\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n                  2016-01-26 18:07:12.167 18001 ERROR nova     sys.exit(main())\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 1443, in main\n                  2016-01-26 18:07:12.167 18001 ERROR nova     ret = fn(*fn_args, **fn_kwargs)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 910, in sync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return migration.db_sync(version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 26, in db_sync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return IMPL.db_sync(version=version, database=database)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 106, in db_$\nync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"<string>\", line 2, in _migrate\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py\", line 160, in \nwith_engine\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return f(*a, **kw)\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return migration.db_sync(version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 26, in db_sync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return IMPL.db_sync(version=version, database=database)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 106, in db_s\nync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"<string>\", line 2, in _migrate\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py\", line 160, in \nwith_engine\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return f(*a, **kw)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 366, in _migrate\n                  2016-01-26 18:07:12.167 18001 ERROR nova     schema.runchange(ver, change, changeset.step)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/schema.py\", line 93, in runchan$\ne\n                  2016-01-26 18:07:12.167 18001 ERROR nova     change.run(self.engine, step)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/script/py.py\", line 148, in run\n                  2016-01-26 18:07:12.167 18001 ERROR nova     script_func(engine)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migrate_repo/versions/291_enfor$\ne_flavors_migrated.py\", line 35, in upgrade\n                  2016-01-26 18:07:12.167 18001 ERROR nova     raise exception.ValidationError(detail=msg)\n                  2016-01-26 18:07:12.167 18001 ERROR nova ValidationError: There are still 3 unmigrated flavor records. Migration cannot continue unt$\nl all instance flavor records have been migrated to the new format. Please run `nova-manage db migrate_flavor_data' first.\n                  2016-01-26 18:07:12.167 18001 ERROR nova\n              stdout:\n                  Command failed, please check log for more info\n----------\n \n\nroot@controller:~# dpkg -l | grep nova\nii  nova-api                            2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - API frontend\nii  nova-cert                           2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - certificate management\nii  nova-common                         2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - common files\nii  nova-conductor                      2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - conductor service\nii  nova-consoleauth                    2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - Console Authenticator\nii  nova-novncproxy                     2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - NoVNC proxy\nii  nova-scheduler                      2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - virtual machine scheduler\nii  nova-spiceproxy                     2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute - spice html5 proxy\nii  python-nova                         2:12.0.0-0ubuntu2~cloud0              all          OpenStack Compute Python libraries\nii  python-novaclient                   2:2.30.1-1~cloud0                     all          client library for OpenStack Compute API\nroot@controller:~# \n\n\nHow to reproduce:\n* setup openstack < liberty\n* update pkgs to liberty \n* run `nova-manage db sync && echo \"you shouldn't see this because the prev cmd failed\" `\n(The error while running the command is topic of issue #1511466)\n\nExpected result:\nFailing `nova-manage db sync` returns a none-zero exitcode and thus signals a failure\nas any utility on a unix-like system should.\n\nActual result:\nFailing `nova-manage db sync` still returns an exitcode of 0 signaling successful\nupdate of database schemas to the running shell/command/automation tool of choice.", 
            "date_created": "2016-01-26 17:43:40.236480+00:00", 
            "author": "https://api.launchpad.net/1.0/~0xf10e"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/289308", 
            "date_created": "2016-03-07 12:51:00.188032+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/289309", 
            "date_created": "2016-03-07 12:51:10.323885+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/289308\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=173068d52449eb04e905b29da6e417ae69cd8055\nSubmitter: Jenkins\nBranch:    master\n\ncommit 173068d52449eb04e905b29da6e417ae69cd8055\nAuthor: Stephen Finucane <email address hidden>\nDate:   Mon Mar 7 12:34:47 2016 +0000\n\n    nova-manage: Print, not raise, exceptions\n    \n    Raising an exception means it is not possible to return a status code.\n    Seeing as the 'nova-manage' application is an interactive one, it's\n    viable to fix this by printing the exception rather than raising.\n    \n    Change-Id: Ifa3f80e4f7dccada439ffc9363e9f1504c8c2da1\n    Closes-bug: #1538227\n", 
            "date_created": "2016-03-08 19:16:44.469311+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Stephen Finucane (<email address hidden>) on branch: master\nReview: https://review.openstack.org/289309\nReason: There has to be a better way to do this", 
            "date_created": "2016-10-20 09:39:04.342683+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-03-08 19:16:41.959311+00:00"
}