{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:15:04.536873+00:00", 
    "description": "When cinder-volume is under heavy load, RPC call for terminate_connection of cinder volumes may take more time than RPC timeout.\nWhen the timeout occurs, nova gives up the detaching volume and recover the volume state to 'in-use', but doesn't reattach volumes.\nThis will make DB inconsistent state:\n\n  (1) libvirt is already detaches the volume from the instance\n  (2) cinder volume is disconnected from the host by terminate_connection RPC (but nova doesn't know this because of timeout)\n  (3) nova.block_device_mapping still remains because of timeout in (2)\n\nand the volume becomes impossible to re-attach or to detach completely.\nIf volume-detach is issued again, it will fail by the exception exception.DiskNotFound:\n\n\n2014-07-17 10:58:17.333 2586 AUDIT nova.compute.manager [req-e251f834-9653-47aa-969c-b9524d4a683d f8c2ac613325450fa6403a89d48ac644 4be531199d5240f79733fb071e090e46] [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb] Detach volume f7d90bc8-eb55-4d46-a2c4-294dc9c6a92a from mountpoint /dev/vdb\n2014-07-17 10:58:17.337 2586 ERROR nova.compute.manager [req-e251f834-9653-47aa-969c-b9524d4a683d f8c2ac613325450fa6403a89d48ac644 4be531199d5240f79733fb071e090e46] [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb] Failed to detach volume f7d90bc8-eb55-4d46-a2c4-294dc9c6a92a from /dev/vdb\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb] Traceback (most recent call last):\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb]   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 4169, in _detach_volume\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb]     encryption=encryption)\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb]   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1365, in detach_volume\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb]     raise exception.DiskNotFound(location=disk_dev)\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb] DiskNotFound: No disk at vdb\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb] \n\n\nWe should have the way to recover from this situation.\n\nFor instance, we need to have something like \"volume-detach --force\" which ignores the DiskNotFound exception and continues to delete nova.block_device_mapping entry.", 
    "tags": [
        "volumes"
    ], 
    "importance": "Low", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1367964", 
    "owner": "https://api.launchpad.net/1.0/~tsekiyama", 
    "id": 1367964, 
    "index": 1371, 
    "openned": "2014-09-10 23:14:01.579428+00:00", 
    "created": "2014-09-10 23:14:01.579428+00:00", 
    "title": "Unable to recover from timeout of detaching cinder volume", 
    "comments": [
        {
            "content": "When cinder-volume is under heavy load, RPC call for terminate_connection of cinder volumes may take more time than RPC timeout.\nWhen the timeout occurs, nova gives up the detaching volume and recover the volume state to 'in-use', but doesn't reattach volumes.\nThis will make DB inconsistent state:\n\n  (1) libvirt is already detaches the volume from the instance\n  (2) cinder volume is disconnected from the host by terminate_connection RPC (but nova doesn't know this because of timeout)\n  (3) nova.block_device_mapping still remains because of timeout in (2)\n\nand the volume becomes impossible to re-attach or to detach completely.\nIf volume-detach is issued again, it will fail by the exception exception.DiskNotFound:\n\n\n2014-07-17 10:58:17.333 2586 AUDIT nova.compute.manager [req-e251f834-9653-47aa-969c-b9524d4a683d f8c2ac613325450fa6403a89d48ac644 4be531199d5240f79733fb071e090e46] [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb] Detach volume f7d90bc8-eb55-4d46-a2c4-294dc9c6a92a from mountpoint /dev/vdb\n2014-07-17 10:58:17.337 2586 ERROR nova.compute.manager [req-e251f834-9653-47aa-969c-b9524d4a683d f8c2ac613325450fa6403a89d48ac644 4be531199d5240f79733fb071e090e46] [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb] Failed to detach volume f7d90bc8-eb55-4d46-a2c4-294dc9c6a92a from /dev/vdb\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb] Traceback (most recent call last):\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb]   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 4169, in _detach_volume\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb]     encryption=encryption)\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb]   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 1365, in detach_volume\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb]     raise exception.DiskNotFound(location=disk_dev)\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb] DiskNotFound: No disk at vdb\n2014-07-17 10:58:17.337 2586 TRACE nova.compute.manager [instance: 48c19bff-ec39-44c5-a63b-cac01ee813eb] \n\n\nWe should have the way to recover from this situation.\n\nFor instance, we need to have something like \"volume-detach --force\" which ignores the DiskNotFound exception and continues to delete nova.block_device_mapping entry.", 
            "date_created": "2014-09-10 23:14:01.579428+00:00", 
            "author": "https://api.launchpad.net/1.0/~tsekiyama"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/121262", 
            "date_created": "2014-09-12 22:59:59.863382+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/121262\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=14bc789107e1ab9650be934b6bf3f799bfb3e16a\nSubmitter: Jenkins\nBranch:    master\n\ncommit 14bc789107e1ab9650be934b6bf3f799bfb3e16a\nAuthor: Tomoki Sekiyama <email address hidden>\nDate:   Fri Sep 12 16:10:18 2014 -0400\n\n    Ignore DiskNotFound error on detaching volumes\n    \n    When volume_api.terminate_connection RPC calls fail due to timeout,\n    detaching volume will be impossible because it is already detached but\n    still have the volume mapping entry. To make it detachable completely\n    by retrying volume detach, this patch make it ignore DiskNotFound error\n    while detaching volumes and go through removing the mapping.\n    \n    Change-Id: I95077179160a2eb35436db2a5f7a5fbca64ec323\n    Closes-Bug: #1367964\n", 
            "date_created": "2014-10-30 03:19:52.364476+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-12-18 20:07:37.556423+00:00"
}