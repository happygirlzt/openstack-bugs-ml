{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 09:03:26.684576+00:00", 
    "description": "Nova version, output of 'git log -1':\n\u00a0\u00a0\u00a0\u00a0commit 676ba7bbc788a528b0fe4c87c1c4bf94b4bb6eb1\n\u00a0\u00a0\u00a0\u00a0Author: Dave McCowan <email address hidden>\n\u00a0\u00a0\u00a0\u00a0Date:   Tue Feb 24 21:35:48 2015 -0500\n\n\u00a0\u00a0\u00a0\u00a0Websocket Proxy should verify Origin header\n\n\u00a0\u00a0\u00a0\u00a0If the Origin HTTP header passed in the WebSocket handshake does\n\u00a0\u00a0\u00a0\u00a0not match the host, this could indicate an attempt at a\n\u00a0\u00a0\u00a0\u00a0cross-site attack.  This commit adds a check to verify\n\u00a0\u00a0\u00a0\u00a0the origin matches the host.\n\n\u00a0\u00a0\u00a0\u00a0Change-Id: Ica6ec23d6f69a236657d5ba0c3f51b693c633649\n\u00a0\u00a0\u00a0\u00a0Closes-Bug: 1409142\nReproduce steps:\n1. Enable soft delete via set reclaim_instance_interval in nova.conf.\n2. A normal project: ProjectA create a new instance and then delete it, then it's status change to SOFT_DELETED.\n3. Now restore the instance by admin user in project: admin, the instance back to ACTIVE, but the quota usage of project: admin  has changed, the flavor of that instance has added on admin project quota usage.", 
    "tags": [
        "nova", 
        "quotas"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1482444", 
    "owner": "https://api.launchpad.net/1.0/~zhengyue-5", 
    "id": 1482444, 
    "index": 1790, 
    "openned": "2015-08-07 01:21:24.465814+00:00", 
    "created": "2015-08-07 01:21:24.465814+00:00", 
    "title": "Abnormal changes of quota usage after instance restored by admin", 
    "comments": [
        {
            "content": "Nova version, output of 'git log -1':\n    commit 676ba7bbc788a528b0fe4c87c1c4bf94b4bb6eb1\n    Author: Dave McCowan <email address hidden>\n    Date:   Tue Feb 24 21:35:48 2015 -0500\n\n    Websocket Proxy should verify Origin header\n    \n    If the Origin HTTP header passed in the WebSocket handshake does\n    not match the host, this could indicate an attempt at a\n    cross-site attack.  This commit adds a check to verify\n    the origin matches the host.\n    \n    Change-Id: Ica6ec23d6f69a236657d5ba0c3f51b693c633649\n    Closes-Bug: 1409142\nReproduce steps:\n1. Enable soft delete via set reclaim_instance_interval in nova.conf. \n2. A normal project: ProjectA create a new instance and then delete it, then it's status change to SOFT_DELETED.\n3. Now restore the instance by admin user in project: admin, the instance back to ACTIVE, but the quota usage of project: admin  has changed.", 
            "date_created": "2015-08-07 01:21:24.465814+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengyue-5"
        }, 
        {
            "content": "I didn't reproduce this bug, maybe you can explain more.", 
            "date_created": "2015-08-11 02:57:59.194610+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengzhenyu"
        }, 
        {
            "content": "The projects in my environment\uff1a\n$ keystone tenant-list\n+-------------------------------------------------------+--------------------+---------+\n|                id                                                        |        name        | enabled |\n+-------------------------------------------------------+--------------------+---------+\n| ba4448bdba0540409d2ec7901b919b30 |       admin        |   True  |\n| 4065938305c847d3b72d89118935d1f0 |        demo        |   True  |\n\nDetail of reproduce steps:\n1. Enable soft delete set 'reclaim_instance_interval = 3600' in nova.conf;\n2. Create a instance in project: demo, get the instance: $ nova list --all-tenants:\n+--------------------------------------+------------------+----------------------------------+--------+------------+-------------+------------------+\n| ID                                   | Name             | Tenant ID                        | Status | Task State | Power State | Networks         |\n+--------------------------------------+------------------+----------------------------------+--------+------------+-------------+------------------+\n| acaacb74-3fdf-40a7-8f47-dd00b949254f | test_soft_delete | 4065938305c847d3b72d89118935d1f0 | ACTIVE | -          | Running     | private=10.0.0.2 |\n+--------------------------------------+------------------+----------------------------------+--------+------------+-------------+------------------+\n3. Show quota usage before action:\n(1). Usage of project admin (Don't care the current value, please focus on the comparison with results at later): \nnova limits --tenant ba4448bdba0540409d2ec7901b919b30\n+--------------------+------+-------+\n| Name               | Used | Max   |\n+--------------------+------+-------+\n| Cores              | 5    | 20    |\n| FloatingIps        | 0    | 10    |\n| ImageMeta          | -    | 128   |\n| Instances          | 5    | 10    |\n| Keypairs           | -    | 100   |\n| Personality        | -    | 5     |\n| Personality Size   | -    | 10240 |\n| RAM                | 2560 | 51200 |\n| SecurityGroupRules | -    | 20    |\n| SecurityGroups     | 0    | 10    |\n| Server Meta        | -    | 128   |\n| ServerGroupMembers | -    | 10    |\n| ServerGroups       | 0    | 10    |\n+--------------------+------+-------+\n (2). Usage of project demo:\nnova limits --tenant 4065938305c847d3b72d89118935d1f0\n+--------------------+------+-------+\n| Name               | Used | Max   |\n+--------------------+------+-------+\n| Cores              | 2    | 20    |\n| FloatingIps        | 0    | 10    |\n| ImageMeta          | -    | 128   |\n| Instances          | 2    | 10    |\n| Keypairs           | -    | 100   |\n| Personality        | -    | 5     |\n| Personality Size   | -    | 10240 |\n| RAM                | 1024 | 51200 |\n| SecurityGroupRules | -    | 20    |\n| SecurityGroups     | 1    | 10    |\n| Server Meta        | -    | 128   |\n| ServerGroupMembers | -    | 10    |\n| ServerGroups       | 0    | 10    |\n+--------------------+------+-------+\n4. Delete server belongs to project demo:\n$ nova delete acaacb74-3fdf-40a7-8f47-dd00b949254f\nRequest to delete server acaacb74-3fdf-40a7-8f47-dd00b949254f has been accepted.\n5. Check status of the instance in mysql:\nselect vm_state, power_state, deleted, task_state, uuid from instances;\n| soft-delete |           4 |       0 | NULL       | acaacb74-3fdf-40a7-8f47-dd00b949254f |\nOK, the vm_state of instance(acaacb74-3fdf-40a7-8f47-dd00b949254f) is 'soft-delete', now is correct .\n6. Restore the instance(acaacb74-3fdf-40a7-8f47-dd00b949254f) by user admin in project admin(ba4448bdba0540409d2ec7901b919b30):\nPOST: {\"restore\": null} to adminURL: http://200.21.101.173:8774/v2/ba4448bdba0540409d2ec7901b919b30/servers/acaacb74-3fdf-40a7-8f47-dd00b949254f/action\n7. Check status of instance(acaacb74-3fdf-40a7-8f47-dd00b949254f):\n$ nova list --all-tenants\n+--------------------------------------+------------------+----------------------------------+--------+------------+-------------+------------------+\n| ID                                   | Name             | Tenant ID                        | Status | Task State | Power State | Networks         |\n+--------------------------------------+------------------+----------------------------------+--------+------------+-------------+------------------+\n| acaacb74-3fdf-40a7-8f47-dd00b949254f | test_soft_delete | 4065938305c847d3b72d89118935d1f0 | ACTIVE | -          | Running     | private=10.0.0.2 |\n+--------------------------------------+------------------+----------------------------------+--------+------------+-------------+------------------+\n8. Check quota usage of each projects:\n(1). Usage of project admin : \nnova limits --tenant ba4448bdba0540409d2ec7901b919b30\n+--------------------+------+-------+\n| Name               | Used | Max   |\n+--------------------+------+-------+\n| Cores              | 6    | 20    |\n| FloatingIps        | 0    | 10    |\n| ImageMeta          | -    | 128   |\n| Instances          | 6    | 10    |\n| Keypairs           | -    | 100   |\n| Personality        | -    | 5     |\n| Personality Size   | -    | 10240 |\n| RAM                | 3072 | 51200 |\n| SecurityGroupRules | -    | 20    |\n| SecurityGroups     | 0    | 10    |\n| Server Meta        | -    | 128   |\n| ServerGroupMembers | -    | 10    |\n| ServerGroups       | 0    | 10    |\n+--------------------+------+-------+\n (2). Usage of project demo:\nnova limits --tenant 4065938305c847d3b72d89118935d1f0\n+--------------------+------+-------+\n| Name               | Used | Max   |\n+--------------------+------+-------+\n| Cores              | 1    | 20    |\n| FloatingIps        | 0    | 10    |\n| ImageMeta          | -    | 128   |\n| Instances          | 1    | 10    |\n| Keypairs           | -    | 100   |\n| Personality        | -    | 5     |\n| Personality Size   | -    | 10240 |\n| RAM                | 512  | 51200 |\n| SecurityGroupRules | -    | 20    |\n| SecurityGroups     | 1    | 10    |\n| Server Meta        | -    | 128   |\n| ServerGroupMembers | -    | 10    |\n| ServerGroups       | 0    | 10    |\n+--------------------+------+-------+\n9. Comparing the two results before action and after, the usage of project admin has increased, the floavor of isntance(acaacb74-3fdf-40a7-8f47-dd00b949254f) has added in admin's usage.", 
            "date_created": "2015-08-11 03:55:42.738156+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengyue-5"
        }, 
        {
            "content": "I think the reason of the problem is that the obtain of quota by context.\nThe code at nova/compute/api.py: \ndef _check_num_instances_quota(....\n    ...\n    quotas = objects.Quotas(context) // The context is admin\n    quotas.reserve(instances=max_count, cores=req_cores, ram=req_ram)", 
            "date_created": "2015-08-11 04:03:36.932946+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengyue-5"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/211432", 
            "date_created": "2015-08-11 06:07:40.180904+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/211432\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c474b44bdcdda223b0ec90b7fa1673501cf690e7\nSubmitter: Jenkins\nBranch:    master\n\ncommit c474b44bdcdda223b0ec90b7fa1673501cf690e7\nAuthor: Zheng Yue <email address hidden>\nDate:   Tue Aug 11 10:59:43 2015 +0800\n\n    Fix abnormal quota usage after restore by admin\n    \n    At environment which enabled soft delete at nova conf,\n    if one instance of normal project be restored by admin,\n    the usage of instance's flavor will be add to quota of admin.\n    The reason is that obtain of quota from admin context.\n    Now passing project_id and user_id which get from instance\n    to amend owner of quota.\n    \n    Change-Id: I0e0f6085a6b0a0b9d1072cc2daffd85f54830fff\n    Closes-bug: #1482444\n", 
            "date_created": "2015-09-15 04:05:18.633153+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-09-24 07:00:56.420016+00:00"
}