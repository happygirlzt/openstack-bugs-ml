{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:18:31.447108+00:00", 
    "description": "If instance is booted from volume, then shelving the instance sets the status as SHELVED_OFFLOADED, instance files are getting deleted properly from the base path. When you call the unshelve instance, it fails on the conductor with error \"Unshelve attempted but the image_id is not provided\", and instance goes in to error state.\n\nSteps to reproduce:\n-------------------\n\n1. Log in to Horizon, create a new volume.\n2. Create an Instance using newly created volume.\n3. Verify instance is in active state.\n$ source devstack/openrc demo demo\n$ nova list\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks         |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| dae3a13b-6aa8-4794-93cd-5ab7bf90f604 | nova | ACTIVE | -          | Running     | private=10.0.0.3 |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n\n4. Shelve the instance\n$ nova shelve <instance-uuid>\n\n5. Verify the status is SHELVED_OFFLOADED.\n$ nova list\n+--------------------------------------+------+-------------------+------------+-------------+------------------+\n| ID                                   | Name | Status            | Task State | Power State | Networks         |\n+--------------------------------------+------+-------------------+------------+-------------+------------------+\n| dae3a13b-6aa8-4794-93cd-5ab7bf90f604 | nova | SHELVED_OFFLOADED | -          | Shutdown    | private=10.0.0.3 |\n+--------------------------------------+------+-------------------+------------+-------------+------------------+\n\n6. Unshelve the instance.\n$ nova unshelve <instance-uuid>\n\nFollowing stack-trace logged in nova-conductor\n\n2014-12-19 02:55:59.634 ERROR nova.conductor.manager [req-a071fbc9-1c23-4e7a-8adf-7b3d0951aadf demo demo] [instance: dae3a13b-6aa8-4794-93cd-5ab7bf90f604] Unshelve attempted but the image_id is not provided\n2014-12-19 02:55:59.647 ERROR oslo.messaging.rpc.dispatcher [req-a071fbc9-1c23-4e7a-8adf-7b3d0951aadf demo demo] Exception during message handling: Error during unshelve instance dae3a13b-6aa8-4794-93cd-5ab7bf90f604: Unshelve attempted but the image_id is not provided\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 137, in _dispatch_and_reply\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 180, in _dispatch\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 126, in _do_dispatch\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/conductor/manager.py\", line 727, in unshelve_instance\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher     instance_id=instance.uuid, reason=reason)\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher UnshelveException: Error during unshelve instance dae3a13b-6aa8-4794-93cd-5ab7bf90f604: Unshelve attempted but the image_id is not provided\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher\n\n7. Instance goes into error state.\n$ nova list\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks         |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| dae3a13b-6aa8-4794-93cd-5ab7bf90f604 | nova | ERROR  | unshelving | Shutdown    | private=10.0.0.3 |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n\nNote:\n1. This issue is reproducible with admin as well as demo tenant.\n2. In all cases of shelved_offload_time values (-1, 0, > 0) this issue is reproducible.", 
    "tags": [
        "ntt"
    ], 
    "importance": "Medium", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1404801", 
    "owner": "https://api.launchpad.net/1.0/~pranali-deore", 
    "id": 1404801, 
    "index": 4123, 
    "openned": "2014-12-22 07:00:05.450999+00:00", 
    "created": "2014-12-22 07:00:05.450999+00:00", 
    "title": "Unshelve instance not working if instance is boot from volume", 
    "comments": [
        {
            "content": "If instance is booted from volume, then shelving the instance sets the status as SHELVED_OFFLOADED, instance files are getting deleted properly from the base path. When you call the unshelve instance, it fails on the conductor with error \"Unshelve attempted but the image_id is not provided\", and instance goes in to error state.\n\nSteps to reproduce:\n-------------------\n\n1. Log in to Horizon, create a new volume.\n2. Create an Instance using newly created volume.\n3. Verify instance is in active state.\n$ source devstack/openrc demo demo\n$ nova list\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks         |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| dae3a13b-6aa8-4794-93cd-5ab7bf90f604 | nova | ACTIVE | -          | Running     | private=10.0.0.3 |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n\n4. Shelve the instance\n$ nova shelve <instance-uuid>\n\n5. Verify the status is SHELVED_OFFLOADED.\n$ nova list\n+--------------------------------------+------+-------------------+------------+-------------+------------------+\n| ID                                   | Name | Status            | Task State | Power State | Networks         |\n+--------------------------------------+------+-------------------+------------+-------------+------------------+\n| dae3a13b-6aa8-4794-93cd-5ab7bf90f604 | nova | SHELVED_OFFLOADED | -          | Shutdown    | private=10.0.0.3 |\n+--------------------------------------+------+-------------------+------------+-------------+------------------+\n\n6. Unshelve the instance.\n$ nova unshelve <instance-uuid>\n\nFollowing stack-trace logged in nova-conductor\n\n2014-12-19 02:55:59.634 ERROR nova.conductor.manager [req-a071fbc9-1c23-4e7a-8adf-7b3d0951aadf demo demo] [instance: dae3a13b-6aa8-4794-93cd-5ab7bf90f604] Unshelve attempted but the image_id is not provided\n2014-12-19 02:55:59.647 ERROR oslo.messaging.rpc.dispatcher [req-a071fbc9-1c23-4e7a-8adf-7b3d0951aadf demo demo] Exception during message handling: Error during unshelve instance dae3a13b-6aa8-4794-93cd-5ab7bf90f604: Unshelve attempted but the image_id is not provided\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 137, in _dispatch_and_reply\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 180, in _dispatch\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 126, in _do_dispatch\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/conductor/manager.py\", line 727, in unshelve_instance\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher     instance_id=instance.uuid, reason=reason)\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher UnshelveException: Error during unshelve instance dae3a13b-6aa8-4794-93cd-5ab7bf90f604: Unshelve attempted but the image_id is not provided\n2014-12-19 02:55:59.647 TRACE oslo.messaging.rpc.dispatcher\n\n7. Instance goes into error state.\n$ nova list\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks         |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| dae3a13b-6aa8-4794-93cd-5ab7bf90f604 | nova | ERROR  | unshelving | Shutdown    | private=10.0.0.3 |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n\nNote:\n1. This issue is reproducible with admin as well as demo tenant.\n2. In all cases of shelved_offload_time values (-1, 0, > 0) this issue is reproducible.", 
            "date_created": "2014-12-22 07:00:05.450999+00:00", 
            "author": "https://api.launchpad.net/1.0/~abhishek-kekane"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/144582", 
            "date_created": "2014-12-31 06:07:22.351575+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/144582\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c944babe99657093cc8210478deaae0142c98e96\nSubmitter: Jenkins\nBranch:    master\n\ncommit c944babe99657093cc8210478deaae0142c98e96\nAuthor: PranaliDeore <email address hidden>\nDate:   Tue Dec 23 06:04:24 2014 -0800\n\n    Unshelving a volume backed instance doesn't work\n    \n    In case of volume backed instance, snapshot is not\n    taken when an instance is shelved, so shelve_image_id\n    key is not set to the instance system metadata.\n    If shelve_image_id is None, then it shouldn't raise UnshelveException.\n    \n    Closes-Bug: #1404801\n    Change-Id: I295e3e2b2c2d640684a5416c53fa1fed7e6297e2\n", 
            "date_created": "2015-01-07 09:20:14.631998+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/145725", 
            "date_created": "2015-01-08 08:56:47.251376+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/145725\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=2dec248dc767ed0a9e064c3a61429387b5740bac\nSubmitter: Jenkins\nBranch:    stable/juno\n\ncommit 2dec248dc767ed0a9e064c3a61429387b5740bac\nAuthor: PranaliDeore <email address hidden>\nDate:   Tue Dec 23 06:04:24 2014 -0800\n\n    Unshelving a volume backed instance doesn't work\n    \n    In case of volume backed instance, snapshot is not\n    taken when an instance is shelved, so shelve_image_id\n    key is not set to the instance system metadata.\n    If shelve_image_id is None, then it shouldn't raise UnshelveException.\n    \n    Note: The required unit-tests are manually added to the below path,\n    as new path for unit-tests is not present in stable/juno release.\n    nova/tests/conductor/test_conductor.py\n    \n    Conflicts:\n            nova/conductor/manager.py\n            nova/tests/unit/conductor/test_conductor.py\n    \n    Closes-Bug: #1404801\n    Change-Id: I295e3e2b2c2d640684a5416c53fa1fed7e6297e2\n    (cherry picked from commit c944babe99657093cc8210478deaae0142c98e96)\n", 
            "date_created": "2015-01-29 13:16:52.740168+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-02-05 20:17:18.441640+00:00"
}