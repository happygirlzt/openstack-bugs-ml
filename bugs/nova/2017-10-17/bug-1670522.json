{
    "status": "Fix Released", 
    "last_updated": "2017-04-14 09:23:21.682174+00:00", 
    "description": "Someone reported this in the nova IRC channel today using ocata with libvirt+xen:\n\nhttp://paste.openstack.org/raw/601670/\n\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [req-937dedd1-35a1-46e4-8516-fc53c99a8f48 - - - - -] [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c] Instance failed to spawn\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c] Traceback (most recent call last):\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2125, in _build_resources\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     yield resources\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1930, in _build_and_run_instance\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     block_device_info=block_device_info)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2683, in spawn\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     block_device_info=block_device_info)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4871, in _get_guest_xml\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     xml = conf.to_xml()\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 77, in to_xml\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     root = self.format_dom()\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 2161, in format_dom\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     self._format_devices(root)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 2119, in _format_devices\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     devices.append(dev.format_dom())\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 1636, in format_dom\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     dev = super(LibvirtConfigGuestChar, self).format_dom()\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 1622, in format_dom\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     dev.append(self.log.format_dom())\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 1665, in format_dom\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     log.set(\"file\", self.file)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"src/lxml/lxml.etree.pyx\", line 824, in lxml.etree._Element.set (src/lxml/lxml.etree.c:53073)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"src/lxml/apihelpers.pxi\", line 570, in lxml.etree._setAttributeValue (src/lxml/lxml.etree.c:23009)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"src/lxml/apihelpers.pxi\", line 1437, in lxml.etree._utf8 (src/lxml/lxml.etree.c:32414)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c] TypeError: Argument must be bytes or unicode, got 'NoneType'\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c] \n\nThe problem is when adding guest consoles to the domain xml during spawn, for libvirt+xen we go here:\n\nhttps://github.com/openstack/nova/blob/15.0.0/nova/virt/libvirt/driver.py#L4435\n\nAnd log_path=None in _create_pty_device:\n\nhttps://github.com/openstack/nova/blob/15.0.0/nova/virt/libvirt/driver.py#L4478\n\nCONF.serial_console.enabled is False and they have new enough libvirt/qemu for virtlogd support so they get here:\n\nhttps://github.com/openstack/nova/blob/15.0.0/nova/virt/libvirt/driver.py#L4510\n\nSo we set log.file to None here:\n\nhttps://github.com/openstack/nova/blob/15.0.0/nova/virt/libvirt/driver.py#L4489\n\nWhich blows up eventually because it's None.\n\nThe workaround for now is to set [serial_console]enabled=True in nova.conf.", 
    "tags": [
        "libvirt", 
        "ocata-backport-potential", 
        "xen"
    ], 
    "importance": "High", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1670522", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1670522, 
    "index": 2044, 
    "openned": "2017-03-06 23:39:03.159837+00:00", 
    "created": "2017-03-06 23:39:03.159837+00:00", 
    "title": "TypeError booting instance with libvirt+xen in _create_pty_device with libvirt>=1.3.3", 
    "comments": [
        {
            "content": "Someone reported this in the nova IRC channel today using ocata with libvirt+xen:\n\nhttp://paste.openstack.org/raw/601670/\n\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [req-937dedd1-35a1-46e4-8516-fc53c99a8f48 - - - - -] [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c] Instance failed to spawn\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c] Traceback (most recent call last):\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2125, in _build_resources\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     yield resources\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1930, in _build_and_run_instance\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     block_device_info=block_device_info)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2683, in spawn\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     block_device_info=block_device_info)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 4871, in _get_guest_xml\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     xml = conf.to_xml()\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 77, in to_xml\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     root = self.format_dom()\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 2161, in format_dom\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     self._format_devices(root)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 2119, in _format_devices\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     devices.append(dev.format_dom())\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 1636, in format_dom\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     dev = super(LibvirtConfigGuestChar, self).format_dom()\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 1622, in format_dom\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     dev.append(self.log.format_dom())\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py\", line 1665, in format_dom\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]     log.set(\"file\", self.file)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"src/lxml/lxml.etree.pyx\", line 824, in lxml.etree._Element.set (src/lxml/lxml.etree.c:53073)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"src/lxml/apihelpers.pxi\", line 570, in lxml.etree._setAttributeValue (src/lxml/lxml.etree.c:23009)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c]   File \"src/lxml/apihelpers.pxi\", line 1437, in lxml.etree._utf8 (src/lxml/lxml.etree.c:32414)\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c] TypeError: Argument must be bytes or unicode, got 'NoneType'\n2017-03-06 17:09:47.609 8530 ERROR nova.compute.manager [instance: a2ac1972-54c4-4a7b-ab34-04cce319806c] \n\nThe problem is when adding guest consoles to the domain xml during spawn, for libvirt+xen we go here:\n\nhttps://github.com/openstack/nova/blob/15.0.0/nova/virt/libvirt/driver.py#L4435\n\nAnd log_path=None in _create_pty_device:\n\nhttps://github.com/openstack/nova/blob/15.0.0/nova/virt/libvirt/driver.py#L4478\n\nCONF.serial_console.enabled is False and they have new enough libvirt/qemu for virtlogd support so they get here:\n\nhttps://github.com/openstack/nova/blob/15.0.0/nova/virt/libvirt/driver.py#L4510\n\nSo we set log.file to None here:\n\nhttps://github.com/openstack/nova/blob/15.0.0/nova/virt/libvirt/driver.py#L4489\n\nWhich blows up eventually because it's None.\n\nThe workaround for now is to set [serial_console]enabled=True in nova.conf.", 
            "date_created": "2017-03-06 23:39:03.159837+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "By the way we didn't catch this in xenproject CI because it's running an older libvirt (1.3.1):\n\nhttp://logs.openstack.xenproject.org/10/396210/5/check/dsvm-tempest-xen/d4ed0ef/logs/dpkg-l.txt.gz", 
            "date_created": "2017-03-06 23:39:54.506803+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/442209", 
            "date_created": "2017-03-07 00:05:00.144677+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/442550", 
            "date_created": "2017-03-07 15:12:37.076719+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/442209\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ac61abb7c74f1a8e3e9134bc045455fd9fdac0fa\nSubmitter: Jenkins\nBranch:    master\n\ncommit ac61abb7c74f1a8e3e9134bc045455fd9fdac0fa\nAuthor: Matt Riedemann <email address hidden>\nDate:   Mon Mar 6 19:00:31 2017 -0500\n\n    libvirt: pass log_path to _create_pty_device for non-kvm/qemu\n    \n    log_path is required in _create_pty_device if:\n    \n    1. serial consoles are disabled\n    2. libvirt/qemu are new enough that they support virtlogd\n    \n    This was working fine for kvm and qemu since _create_consoles_s390x\n    and _create_consoles_qemu_kvm pass in the log_path, but for the\n    non-kvm/qemu cases, like xen, the log_path wasn't provided.\n    \n    This wasn't caught by the XenProject CI since it's using libvirt\n    1.3.1 which does not have virtlogd support so this path was\n    not exercised and apparently not unit tested either.\n    \n    A release note is provided since this is a pretty severe bug if\n    you're running new enough libvirt/qemu and not using kvm/qemu as\n    the virt type because CONF.serial_console.enabled is False by\n    default so you're going to have failed server creates immediately\n    upon upgrading to Ocata.\n    \n    Change-Id: I7f60db1d243a75b90e3c0e53201cb6000ee95778\n    Closes-Bug: #1670522\n", 
            "date_created": "2017-03-07 16:16:47.124766+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/442550\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=30e604f57faa8321679881bdf6113f9389e80271\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit 30e604f57faa8321679881bdf6113f9389e80271\nAuthor: Matt Riedemann <email address hidden>\nDate:   Mon Mar 6 19:00:31 2017 -0500\n\n    libvirt: pass log_path to _create_pty_device for non-kvm/qemu\n    \n    log_path is required in _create_pty_device if:\n    \n    1. serial consoles are disabled\n    2. libvirt/qemu are new enough that they support virtlogd\n    \n    This was working fine for kvm and qemu since _create_consoles_s390x\n    and _create_consoles_qemu_kvm pass in the log_path, but for the\n    non-kvm/qemu cases, like xen, the log_path wasn't provided.\n    \n    This wasn't caught by the XenProject CI since it's using libvirt\n    1.3.1 which does not have virtlogd support so this path was\n    not exercised and apparently not unit tested either.\n    \n    A release note is provided since this is a pretty severe bug if\n    you're running new enough libvirt/qemu and not using kvm/qemu as\n    the virt type because CONF.serial_console.enabled is False by\n    default so you're going to have failed server creates immediately\n    upon upgrading to Ocata.\n    \n    Change-Id: I7f60db1d243a75b90e3c0e53201cb6000ee95778\n    Closes-Bug: #1670522\n    (cherry picked from commit ac61abb7c74f1a8e3e9134bc045455fd9fdac0fa)\n", 
            "date_created": "2017-03-08 12:30:19.856494+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.1 release.", 
            "date_created": "2017-03-15 11:15:41.025953+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b1 development milestone.", 
            "date_created": "2017-04-14 09:23:20.637485+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-03-07 16:16:44.251640+00:00"
}