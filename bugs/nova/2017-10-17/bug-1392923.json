{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:48:47.040476+00:00", 
    "description": "It is possible to create 'orphan' floating ip's (at least in devstack testing) through a sequence of:\ndelete vip\nassign vip\nremove vip\n\nAPI calls + timestamps from a test run:\n26101:[2014-11-14 17:18:57,446] mahmachine/INFO/stdout: 0x7f8833395250: delete floating ip id: 14\n26145:[2014-11-14 17:18:58,237] mahmachine/INFO/stdout: 0x7f88333e8810: assign floating ip: 172.24.4.14 || d4545f39-6a5c-40e3-99f4-f72c22d56fc7\n27333:[2014-11-14 17:19:25,144] mahmachine/INFO/stdout: 0x7f88333e8810: remove floating ip: 172.24.4.14 || d4545f39-6a5c-40e3-99f4-f72c22d56fc7\n\nThis results in floating ip addresses that are still listed as attached to an instance, yet are not owned (and are not removable) by the instance's owner.\n\nIn the database, the fixed_ip_id is not null (the server id), yet the project id is:\nthe 'host' column may or may not be populated, but the cause and effect appear to be the same regardless of this.\n\nselect id, address, fixed_ip_id, project_id, host from floating_ips where project_id IS NULL and fixed_ip_id IS NOT NULL;\n+----+-------------+-------------+------------+-------------+\n| id | address     | fixed_ip_id | project_id | host        |\n+----+-------------+-------------+------------+-------------+\n|  2 | 172.24.4.2  |           4 | NULL       | NULL        |\n|  7 | 172.24.4.7  |           4 | NULL       | mahmachine  |\n| 11 | 172.24.4.11 |           4 | NULL       | mahmachine  |\n|  6 | 172.24.4.6  |           7 | NULL       | mahmachine  |\n| 15 | 172.24.4.15 |           7 | NULL       | mahmachine  |\n|  3 | 172.24.4.3  |           8 | NULL       | mahmachine  |\n| 14 | 172.24.4.14 |          10 | NULL       | NULL        |\n+----+-------------+-------------+------------+-------------+", 
    "tags": [
        "compute", 
        "network"
    ], 
    "importance": "High", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1392923", 
    "owner": "https://api.launchpad.net/1.0/~mhorban", 
    "id": 1392923, 
    "index": 1650, 
    "openned": "2014-11-15 01:51:08.857491+00:00", 
    "created": "2014-11-15 01:51:08.857491+00:00", 
    "title": "Orphan floating ip's created via rapid delete/assign/remove operations", 
    "comments": [
        {
            "content": "It is possible to create 'orphan' floating ip's (at least in devstack testing) through a sequence of:\ndelete vip\nassign vip\nremove vip\n\nAPI calls + timestamps from a test run:\n26101:[2014-11-14 17:18:57,446] mahmachine/INFO/stdout: 0x7f8833395250: delete floating ip id: 14\n26145:[2014-11-14 17:18:58,237] mahmachine/INFO/stdout: 0x7f88333e8810: assign floating ip: 172.24.4.14 || d4545f39-6a5c-40e3-99f4-f72c22d56fc7\n27333:[2014-11-14 17:19:25,144] mahmachine/INFO/stdout: 0x7f88333e8810: remove floating ip: 172.24.4.14 || d4545f39-6a5c-40e3-99f4-f72c22d56fc7\n\nThis results in floating ip addresses that are still listed as attached to an instance, yet are not owned (and are not removable) by the instance's owner.\n\nIn the database, the fixed_ip_id is not null (the server id), yet the project id is:\nthe 'host' column may or may not be populated, but the cause and effect appear to be the same regardless of this.\n\nselect id, address, fixed_ip_id, project_id, host from floating_ips where project_id IS NULL and fixed_ip_id IS NOT NULL;\n+----+-------------+-------------+------------+-------------+\n| id | address     | fixed_ip_id | project_id | host        |\n+----+-------------+-------------+------------+-------------+\n|  2 | 172.24.4.2  |           4 | NULL       | NULL        |\n|  7 | 172.24.4.7  |           4 | NULL       | mahmachine  |\n| 11 | 172.24.4.11 |           4 | NULL       | mahmachine  |\n|  6 | 172.24.4.6  |           7 | NULL       | mahmachine  |\n| 15 | 172.24.4.15 |           7 | NULL       | mahmachine  |\n|  3 | 172.24.4.3  |           8 | NULL       | mahmachine  |\n| 14 | 172.24.4.14 |          10 | NULL       | NULL        |\n+----+-------------+-------------+------------+-------------+", 
            "date_created": "2014-11-15 01:51:08.857491+00:00", 
            "author": "https://api.launchpad.net/1.0/~patrick-crews"
        }, 
        {
            "content": "nova behavior with such floating ips:\n\npcrews@mahmachine:~/git/mahrepo$ nova list\n+--------------------------------------+-------------------------+--------+------------+-------------+--------------------------------------------------------------------+\n| ID                                   | Name                    | Status | Task State | Power State | Networks                                                           |\n+--------------------------------------+-------------------------+--------+------------+-------------+--------------------------------------------------------------------+\n| 9691031c-5fbe-437f-ae6d-90e7ae550175 | server-0x7f883335d350-0 | ACTIVE | -          | Running     | private=10.0.0.7, 172.24.4.3                                       |\n| 204f51ed-3baa-4c50-9227-391a7c5f7c47 | server-0x7f8833395890-0 | ACTIVE | -          | Running     | private=10.0.0.2                                                   |\n| 353dfff7-7ce2-4b0d-8cc1-111510c0008b | server-0x7f88333a7ad0-0 | ACTIVE | -          | Running     | private=10.0.0.4                                                   |\n| a062aa43-11ae-4ea3-9c35-3ed3766c1fdf | server-0x7f88333a7f50-0 | ACTIVE | -          | Running     | private=10.0.0.6, 172.24.4.6, 172.24.4.15                          |\n| 3344bb31-6441-41b5-9056-28afc27133d3 | server-0x7f88333e8a90-0 | ACTIVE | -          | Running     | private=10.0.0.5                                                   |\n| 74780a52-a389-4d5e-8a32-eaacf4849a6f | server-0x7f8833c15e90-0 | ACTIVE | -          | Running     | private=10.0.0.8                                                   |\n| f0dd2112-e948-4844-93dd-592e2207454d | server-0x7f8833c39c50-0 | ERROR  | -          | NOSTATE     | private=10.0.0.3, 172.24.4.2, 172.24.4.7, 172.24.4.11, 172.24.4.17 |\n| d4545f39-6a5c-40e3-99f4-f72c22d56fc7 | server-0x7f8833c39c50-1 | ACTIVE | -          | Running     | private=10.0.0.9, 172.24.4.9, 172.24.4.14, 172.24.4.16             |\n+--------------------------------------+-------------------------+--------+------------+-------------+--------------------------------------------------------------------+\npcrews@mahmachine:~/git/mahrepo$ nova floating-ip-list\n+-------------+--------------------------------------+----------+--------+\n| Ip          | Server Id                            | Fixed Ip | Pool   |\n+-------------+--------------------------------------+----------+--------+\n| 172.24.4.1  | -                                    | -        | public |\n| 172.24.4.4  | -                                    | -        | public |\n| 172.24.4.5  | -                                    | -        | public |\n| 172.24.4.8  | -                                    | -        | public |\n| 172.24.4.9  | d4545f39-6a5c-40e3-99f4-f72c22d56fc7 | 10.0.0.9 | public |\n| 172.24.4.10 | -                                    | -        | public |\n| 172.24.4.12 | -                                    | -        | public |\n| 172.24.4.13 | -                                    | -        | public |\n| 172.24.4.16 | d4545f39-6a5c-40e3-99f4-f72c22d56fc7 | 10.0.0.9 | public |\n| 172.24.4.17 | f0dd2112-e948-4844-93dd-592e2207454d | 10.0.0.3 | public |\n+-------------+--------------------------------------+----------+--------+\npcrews@mahmachine:~/git/mahrepo$ nova remove-floating-ip d4545f39-6a5c-40e3-99f4-f72c22d56fc7 172.24.4.14\nERROR (Forbidden): Access was denied to this resource. (HTTP 403) (Request-ID: req-2a2b83cf-bf76-4946-8c43-de0041bd94b3)\n", 
            "date_created": "2014-11-15 01:53:29.047643+00:00", 
            "author": "https://api.launchpad.net/1.0/~patrick-crews"
        }, 
        {
            "content": "I am not able to reproduce this issue.\nWhen I try to associate a second floating ip to an instance, I get the below error message.\nI am using neutron. Are you using nova network ?\n\n\n$ nova floating-ip-list\n+------------+-----------+----------+--------+\n| Ip         | Server Id | Fixed Ip | Pool   |\n+------------+-----------+----------+--------+\n| 172.24.4.5 | -         | 10.0.0.2 | public |\n| 172.24.4.6 | -         | -        | public |\n+------------+-----------+----------+--------+\n[vagrant@vagrant-fedora20 devstack]$ nova list\n+--------------------------------------+------+--------+------------+-------------+------------------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks                     |\n+--------------------------------------+------+--------+------------+-------------+------------------------------+\n| 70e4210b-bde5-44dc-82e5-89de4b8c83a4 | test | ACTIVE | -          | Running     | private=10.0.0.2, 172.24.4.5 |\n+--------------------------------------+------+--------+------------+-------------+------------------------------+\n[vagrant@vagrant-fedora20 devstack]$ nova floating-ip-associate test 172.24.4.6\nERROR (BadRequest): Unable to associate floating ip 172.24.4.6 to fixed ip 10.0.0.2 for instance 70e4210b-bde5-44dc-82e5-89de4b8c83a4. Error: Cannot associate floating IP 172.24.4.6 (ea005c03-9558-4e0e-9b00-200a35085ba6) with port fd0040ce-0118-4cdb-9213-ece2337a44d0 using fixed IP 10.0.0.2, as that fixed IP already has a floating IP on external network d448f95a-7903-4551-a348-66bb885b1f62. (HTTP 400) (Request-ID: req-893c15b9-b5f1-4c46-8833-048fb15a3b09)\n\n", 
            "date_created": "2014-11-15 06:09:52.048451+00:00", 
            "author": "https://api.launchpad.net/1.0/~numansiddique"
        }, 
        {
            "content": "My test is on the latest master", 
            "date_created": "2014-11-15 06:11:02.016508+00:00", 
            "author": "https://api.launchpad.net/1.0/~numansiddique"
        }, 
        {
            "content": "This is with nova network and it is not an issue of associating a second floating ip with an instance, just that some vips can get into a state where they are attached, but unowned by the instance user via the sequence I describe above.\n\nThe example I give is of an instance with multiple vips, but that was just for convenience.  The instance with 172.24.4.3 attached is in a similar state and that is the sole vip.  Apologies if this caused any confusion.", 
            "date_created": "2014-11-15 15:50:16.277310+00:00", 
            "author": "https://api.launchpad.net/1.0/~patrick-crews"
        }, 
        {
            "content": "Hi Patrick Crews,\nI tried to reproduce this bug on the latest sources. I haven't used neutron, but I used nova-network.\nAnd I could not reproduce this bug using CLI and using test script which uses HTTP API(I've attached it).\n\nMy steps using CLI were:\n1. get list of servers:\n$nova list\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks         |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| 6e1c4587-07ce-4ca1-90f4-06dbe279f28c | test | ACTIVE | -          | Running     | private=10.0.0.2 |\n| 8451c931-c967-4129-8b19-0863969dcb9a | test | ACTIVE | -          | Running     | private=10.0.0.3 |\n| c51bdca3-4ba4-44e4-ba44-7a8284d3d880 | test | ACTIVE | -          | Running     | private=10.0.0.4 |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n2. get floating IP list:\n$nova floating-ip-list\n+------------+-----------+----------+--------+\n| Ip         | Server Id | Fixed Ip | Pool   |\n+------------+-----------+----------+--------+\n| 172.24.4.1 | -         | -        | public |\n| 172.24.4.2 | -         | -        | public |\n| 172.24.4.4 | -         | -        | public |\n| 172.24.4.6 | -         | -        | public |\n| 172.24.4.7 | -         | -        | public |\n+------------+-----------+----------+--------+\n3. delete floating IP:\n$nova floating-ip-delete 172.24.4.4\n4. check floating IP list:\n$nova floating-ip-list\n+------------+-----------+----------+--------+\n| Ip         | Server Id | Fixed Ip | Pool   |\n+------------+-----------+----------+--------+\n| 172.24.4.1 | -         | -        | public |\n| 172.24.4.2 | -         | -        | public |\n| 172.24.4.6 | -         | -        | public |\n| 172.24.4.7 | -         | -        | public |\n+------------+-----------+----------+--------+\n5. associate deleted floating IP with server:\n$nova floating-ip-associate 6e1c4587-07ce-4ca1-90f4-06dbe279f28c 172.24.4.4\n6. check servers list:\n$nova list\n+--------------------------------------+------+--------+------------+-------------+------------------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks                     |\n+--------------------------------------+------+--------+------------+-------------+------------------------------+\n| 6e1c4587-07ce-4ca1-90f4-06dbe279f28c | test | ACTIVE | -          | Running     | private=10.0.0.2, 172.24.4.4 |\n| 8451c931-c967-4129-8b19-0863969dcb9a | test | ACTIVE | -          | Running     | private=10.0.0.3             |\n| c51bdca3-4ba4-44e4-ba44-7a8284d3d880 | test | ACTIVE | -          | Running     | private=10.0.0.4             |\n+--------------------------------------+------+--------+------------+-------------+------------------------------+\n7. disassociate deleted floating IP:\n$nova floating-ip-disassociate 6e1c4587-07ce-4ca1-90f4-06dbe279f28c 172.24.4.4\n8. check servers list:\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks         |\n+--------------------------------------+------+--------+------------+-------------+------------------+\n| 6e1c4587-07ce-4ca1-90f4-06dbe279f28c | test | ACTIVE | -          | Running     | private=10.0.0.2 |\n| 8451c931-c967-4129-8b19-0863969dcb9a | test | ACTIVE | -          | Running     | private=10.0.0.3 |\n| c51bdca3-4ba4-44e4-ba44-7a8284d3d880 | test | ACTIVE | -          | Running     | private=10.0.0.4 |\n+--------------------------------------+------+--------+------------+-------------+------------------+\nIt looks like everything OK using CLI.\n\nTo except any influences of CLI interface I wrote test script test_floating_ip_1392923.py to reproduce bug.\n./test_floating_ip_1392923.py --help\nUsage: test_floating_ip_1392923.py [options] tenant-name user password ip-address image-name\n\nOptions:\n  -h, --help            show this help message and exit\n  -f FLAVOR, --flavor=FLAVOR\n                        flavor id\nI've ran it:\n\t./test_floating_ip_1392923.py -f 1 admin admin 1 172.18.128.74 cirros-0.3.2-x86_64-uec\nThis script does following steps:\n1. Authenticate using user name, password and tenant name\n2. Launch server by given image name and flavor\n3. Create floating IP address\n4. Delete this floating IP address\n5. Associate floating IP address with created server\n6. Disassociate floating IP address\n7. Check server's detail if floating IP is disassociated\nWithout luck too.\n\nCould you please give me more details how to reproduce this bug?\n\nRegards, Marian", 
            "date_created": "2014-12-24 18:06:05.585701+00:00", 
            "author": "https://api.launchpad.net/1.0/~mhorban"
        }, 
        {
            "content": "", 
            "date_created": "2014-12-24 18:06:57.929569+00:00", 
            "author": "https://api.launchpad.net/1.0/~mhorban"
        }, 
        {
            "content": "Setting to high because race condition.", 
            "date_created": "2015-01-09 19:38:14.205523+00:00", 
            "author": "https://api.launchpad.net/1.0/~melwitt"
        }, 
        {
            "content": "To repeat / view this:\n1) git clone https://github.com/pcrews/rannsaka.git\n2) from ransakka/ransakka, use this command line: \n     python rannsaka.py --host=http://$KEYSTONE_IP_ADDR --requests 20000 -w 15 --test-file=locust_files/floating_ip_stress.py\n\nNOTE: This will run as-is against a devstack installation (assuming standard location of config files, etc0\n\nThis will execute a sequence of test actions that trigger the bug / create orphan ip's on my test system.", 
            "date_created": "2015-01-09 20:51:30.596305+00:00", 
            "author": "https://api.launchpad.net/1.0/~patrick-crews"
        }, 
        {
            "content": "Please switch this back to \"In Progress\" when there are active reviews.", 
            "date_created": "2015-03-04 13:14:05.464277+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Marian, Can you please confirm that this is the review for this bug?\nhttps://review.openstack.org/#/c/149358/\n\nthanks,\ndims", 
            "date_created": "2015-03-05 02:02:01.174742+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Davanum,\nRight you are, review in progress\nRegards, Marian ", 
            "date_created": "2015-03-05 08:15:27.581893+00:00", 
            "author": "https://api.launchpad.net/1.0/~mhorban"
        }
    ], 
    "closed": "2015-06-24 12:14:30.615305+00:00"
}