{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:38:43.841952+00:00", 
    "description": "qemu fails when booting an instance with the os_command_line on non ami images\n\n----------------------------------------------------------------------------\n\nTraceback (most recent call last):\n  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1066, in _build_instance\n    set_access_ip=set_access_ip)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 360, in decorated_function\n    return function(self, context, *args, **kwargs)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1476, in _spawn\n    LOG.exception(_('Instance failed to spawn'), instance=instance)\n  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1473, in _spawn\n    block_device_info)\n  File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 2237, in spawn\n    block_device_info)\n  File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3572, in _create_domain_and_network\n    domain = self._create_domain(xml, instance=instance, power_on=power_on)\n  File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3513, in _create_domain\n    domain.XMLDesc(0))\n  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3508, in _create_domain\n    domain.createWithFlags(launch_flags)\n  File \"/usr/lib/python2.6/site-packages/eventlet/tpool.py\", line 187, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/lib/python2.6/site-packages/eventlet/tpool.py\", line 147, in proxy_call\n    rv = execute(f,*args,**kwargs)\n  File \"/usr/lib/python2.6/site-packages/eventlet/tpool.py\", line 76, in tworker\n    rv = meth(*args,**kwargs)\n  File \"/usr/lib64/python2.6/site-packages/libvirt.py\", line 708, in createWithFlags\n    if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\nlibvirtError: internal error Process exited while reading console log output: char device redirected to /dev/pts/5\n-append only allowed with -kernel option\n\n----------------------------------------------------------------------------\n\nIs this the correct behaviour or should the instance be booted with a log warning that the os_command_line isn't considered since it only applies to ami images in qemu?\n\nThe easiest and least painful solution I could think of is to move the code in the kernel_id check, but I don't know how that would affect other hypervisors. Any comments by people with greater experience with the other hypervisors are more than welcome.", 
    "tags": [
        "libvirt"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1300861", 
    "owner": "https://api.launchpad.net/1.0/~vpopovic", 
    "id": 1300861, 
    "index": 3863, 
    "openned": "2014-04-01 15:51:38.714068+00:00", 
    "created": "2014-04-01 15:51:38.714068+00:00", 
    "title": "libvirt error when adding the os_command_line on non ami images", 
    "comments": [
        {
            "content": "qemu fails when booting an instance with the os_command_line on non ami images\n\n----------------------------------------------------------------------------\n\nTraceback (most recent call last):\n  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1066, in _build_instance\n    set_access_ip=set_access_ip)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 360, in decorated_function\n    return function(self, context, *args, **kwargs)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1476, in _spawn\n    LOG.exception(_('Instance failed to spawn'), instance=instance)\n  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1473, in _spawn\n    block_device_info)\n  File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 2237, in spawn\n    block_device_info)\n  File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3572, in _create_domain_and_network\n    domain = self._create_domain(xml, instance=instance, power_on=power_on)\n  File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3513, in _create_domain\n    domain.XMLDesc(0))\n  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/excutils.py\", line 68, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3508, in _create_domain\n    domain.createWithFlags(launch_flags)\n  File \"/usr/lib/python2.6/site-packages/eventlet/tpool.py\", line 187, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/lib/python2.6/site-packages/eventlet/tpool.py\", line 147, in proxy_call\n    rv = execute(f,*args,**kwargs)\n  File \"/usr/lib/python2.6/site-packages/eventlet/tpool.py\", line 76, in tworker\n    rv = meth(*args,**kwargs)\n  File \"/usr/lib64/python2.6/site-packages/libvirt.py\", line 708, in createWithFlags\n    if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\nlibvirtError: internal error Process exited while reading console log output: char device redirected to /dev/pts/5\n-append only allowed with -kernel option\n\n----------------------------------------------------------------------------\n\nIs this the correct behaviour or should the instance be booted with a log warning that the os_command_line isn't considered since it only applies to ami images in qemu?\n\nThe easiest and least painful solution I could think of is to move the code in the kernel_id check, but I don't know how that would affect other hypervisors. Any comments by people with greater experience with the other hypervisors are more than welcome.", 
            "date_created": "2014-04-01 15:51:38.714068+00:00", 
            "author": "https://api.launchpad.net/1.0/~vpopovic"
        }, 
        {
            "content": "It's worth noting that neither the original blueprint [1] or the commit message for the patch [2] that added this functionality mention any restrictions around image type, though the behaviour is understandable it should have been noted for documentation etc.\n\n[1] https://blueprints.launchpad.net/nova/+spec/enable-libvirt-driver-to-read-kernel-command-line-from-glance-image\n[2] https://review.openstack.org/#/c/65028/", 
            "date_created": "2014-04-01 16:33:54.845069+00:00", 
            "author": "https://api.launchpad.net/1.0/~sgordon"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/87329", 
            "date_created": "2014-04-14 17:19:38.248794+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/87329\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c6a6003a99c27c920ead194d5df6051800e8a9b4\nSubmitter: Jenkins\nBranch:    master\n\ncommit c6a6003a99c27c920ead194d5df6051800e8a9b4\nAuthor: Vladan Popovic <email address hidden>\nDate:   Mon Apr 14 13:04:13 2014 -0400\n\n    libvirt: Use os_command_line when kernel_id is set\n    \n    Patch Iad53c687053bdb5469baad4331ea55f428c170b0 breaks libvirt with\n    \"-append only allowed with -kernel option\" when using images without an\n    explicit boot kernel set because the -kernel option (kernel_id in nova)\n    isn't supplied for those image types.\n    \n    This patch reads the os_command_line property from the image metadata\n    only when using images with an explicit boot kernel set and ignores it\n    otherwise.\n    \n    Closes-bug: 1300861\n    \n    Change-Id: I06c2d9930e0f36a0d7057b6a0f5c9c591caac43f\n", 
            "date_created": "2014-06-12 10:38:51.005181+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-07-23 14:56:45.607663+00:00"
}