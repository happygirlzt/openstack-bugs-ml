{
    "status": "Fix Released", 
    "last_updated": "2011-02-07 13:53:38.006728+00:00", 
    "description": "When nova-compute starts, it tries to call nova.db.sqlalchemy.models.register_models, but it seems to have done this before loading the flags, so if you've set --sql_connection then it tries to create a sqlite database even when you're using MySQL.  If it's running somewhere that it can't create the sqlite database, then it spends a number of minutes repeatedly trying to create it before starting the service.\n\nWith this patch to print out the data store that is being used:\n\n--- nova/db/sqlalchemy/__init__.py      2011-01-03 22:08:52 +0000\n+++ nova/db/sqlalchemy/__init__.py      2011-01-07 01:06:12 +0000\n@@ -39,5 +39,6 @@\n         models.register_models()\n         break\n     except OperationalError:\n-        logging.exception(_(\"Data store is unreachable.\"\n-            \" Trying again in %d seconds.\") % FLAGS.sql_retry_interval)\n+        logging.exception(_(\"Data store %s is unreachable.\"\n+                            \" Trying again in %d seconds.\") %\n+                          (FLAGS.sql_connection, FLAGS.sql_retry_interval))\n\nI get this output:\n\nERROR:root:Data store sqlite:////usr/lib/python2.6/site-packages/nova/..//nova.s\nqlite is unreachable. Trying again in 10 seconds.\nTraceback (most recent call last):\n  File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/__init__.py\", line 3\n9, in <module>\n    models.register_models()\n  File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/models.py\", line 556\n, in register_models\n    model.metadata.create_all(engine)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/schema.py\", line 2147, in create_a\nll\n    bind.create(self, checkfirst=checkfirst, tables=tables)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/engine/base.py\", line 1698, in cre\nate\n    connection=connection, **kwargs)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/engine/base.py\", line 1735, in _ru\nn_visitor\n    conn = self.contextual_connect(close_with_result=False)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/engine/base.py\", line 1829, in con\ntextual_connect\n    self.pool.connect(),\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 192, in connect\n    agent = _ConnectionFairy(self)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 370, in __init__\n    rec = self._connection_record = pool.get()\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 214, in get\n    return self.do_get()\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 600, in do_get\n    c = self.create_connection()\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 148, in create_conn\nection\n    return _ConnectionRecord(self)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 254, in __init__\n    self.connection = self.__connect()\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 320, in __connect\n    connection = self.__pool._creator()\n  File \"build/bdist.linux-i686/egg/sqlalchemy/engine/strategies.py\", line 76, in\n connect\n    return dialect.connect(*cargs, **cparams)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/engine/default.py\", line 249, in c\nonnect\n    return self.dbapi.connect(*cargs, **cparams)\nOperationalError: (OperationalError) unable to open database file None None\nWARNING:root:Starting compute node\nDEBUG:root:Full set of FLAGS:\n...\nDEBUG:root:sql_connection : mysql://root:citrix@127.0.0.1/nova\n\nYou can see that in nova/db/sqlalchemy/__init__.py, FLAGS.sql_connection is the default (sqlite:////usr/lib/python2.6/site-packages/nova/..//nova.sqlite via 'sqlite:///$state_path/nova.sqlite') but that by the time it comes to log \"Full set of FLAGS\" the proper sql_connection value has been set.\n\nI had a quick look, and I can't see how this can be reordered, so any hints would be appreciated.", 
    "tags": [], 
    "importance": "Critical", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/699814", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 699814, 
    "index": 7, 
    "openned": "2011-01-07 13:00:46.674489+00:00", 
    "created": "2011-01-07 13:00:46.674489+00:00", 
    "title": "nova-compute tries to connect to the wrong database at startup", 
    "comments": [
        {
            "content": "When nova-compute starts, it tries to call nova.db.sqlalchemy.models.register_models, but it seems to have done this before loading the flags, so if you've set --sql_connection then it tries to create a sqlite database even when you're using MySQL.  If it's running somewhere that it can't create the sqlite database, then it spends a number of minutes repeatedly trying to create it before starting the service.\n\nWith this patch to print out the data store that is being used:\n\n--- nova/db/sqlalchemy/__init__.py      2011-01-03 22:08:52 +0000\n+++ nova/db/sqlalchemy/__init__.py      2011-01-07 01:06:12 +0000\n@@ -39,5 +39,6 @@\n         models.register_models()\n         break\n     except OperationalError:\n-        logging.exception(_(\"Data store is unreachable.\"\n-            \" Trying again in %d seconds.\") % FLAGS.sql_retry_interval)\n+        logging.exception(_(\"Data store %s is unreachable.\"\n+                            \" Trying again in %d seconds.\") %\n+                          (FLAGS.sql_connection, FLAGS.sql_retry_interval))\n\nI get this output:\n\nERROR:root:Data store sqlite:////usr/lib/python2.6/site-packages/nova/..//nova.s\nqlite is unreachable. Trying again in 10 seconds.\nTraceback (most recent call last):\n  File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/__init__.py\", line 3\n9, in <module>\n    models.register_models()\n  File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/models.py\", line 556\n, in register_models\n    model.metadata.create_all(engine)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/schema.py\", line 2147, in create_a\nll\n    bind.create(self, checkfirst=checkfirst, tables=tables)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/engine/base.py\", line 1698, in cre\nate\n    connection=connection, **kwargs)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/engine/base.py\", line 1735, in _ru\nn_visitor\n    conn = self.contextual_connect(close_with_result=False)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/engine/base.py\", line 1829, in con\ntextual_connect\n    self.pool.connect(),\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 192, in connect\n    agent = _ConnectionFairy(self)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 370, in __init__\n    rec = self._connection_record = pool.get()\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 214, in get\n    return self.do_get()\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 600, in do_get\n    c = self.create_connection()\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 148, in create_conn\nection\n    return _ConnectionRecord(self)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 254, in __init__\n    self.connection = self.__connect()\n  File \"build/bdist.linux-i686/egg/sqlalchemy/pool.py\", line 320, in __connect\n    connection = self.__pool._creator()\n  File \"build/bdist.linux-i686/egg/sqlalchemy/engine/strategies.py\", line 76, in\n connect\n    return dialect.connect(*cargs, **cparams)\n  File \"build/bdist.linux-i686/egg/sqlalchemy/engine/default.py\", line 249, in c\nonnect\n    return self.dbapi.connect(*cargs, **cparams)\nOperationalError: (OperationalError) unable to open database file None None\nWARNING:root:Starting compute node\nDEBUG:root:Full set of FLAGS:\n...\nDEBUG:root:sql_connection : mysql://root:citrix@127.0.0.1/nova\n\nYou can see that in nova/db/sqlalchemy/__init__.py, FLAGS.sql_connection is the default (sqlite:////usr/lib/python2.6/site-packages/nova/..//nova.sqlite via 'sqlite:///$state_path/nova.sqlite') but that by the time it comes to log \"Full set of FLAGS\" the proper sql_connection value has been set.\n\nI had a quick look, and I can't see how this can be reordered, so any hints would be appreciated.", 
            "date_created": "2011-01-07 13:00:46.674489+00:00", 
            "author": "https://api.launchpad.net/1.0/~ewanmellor"
        }, 
        {
            "content": "The issue is due to the reconnection code introduced in service.py.  I'll late import the method, but I'm generally annoyed by code that runs on import like we have in nova.db.sqlalchemy.__init__.py.  I think this should ultimately be done differently.", 
            "date_created": "2011-01-09 00:36:16.440422+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "nova-{compute,network,scheduler} are completely broken without this workaround.", 
            "date_created": "2011-01-10 13:58:28.882902+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }
    ], 
    "closed": "2011-02-07 13:53:35.074030+00:00"
}