{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:43:16.872378+00:00", 
    "description": "In my openstack compute node. a kvm-based vm exists and it has a iso image configured in the cdrom. The iso image path is /root/RHEL6.5-20131111.0-Server-x86_64-DVD1.iso.\nWhen deleting the nova instances, the following error happend in the /var/log/nova/compute.log. And this error caused that the resources could not be updated and the resources occupied by the deleted instances could not be released.  This error also happend when restaring the nova-compute service and so that nova-compute could not restarted successfully. \n\nWe should catch this exception for some existing libvirt instances otherwise all resources for nova instances could not be updated correctly.\n\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task Traceback (most recent call last):\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/periodic_task.py\", line 182, in run_periodic_tasks\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     task(self, context)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 5445, in update_available_resource\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     rt.update_available_resource(context)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 249, in inner\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     return f(*args, **kwargs)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/compute/resource_tracker.py\", line 293, in update_available_resource\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     resources = self.driver.get_available_resource(self.nodename)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 4142, in get_available_resource\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     stats = self.get_host_stats(refresh=True)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 4817, in get_host_stats\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     return self.host_state.get_host_stats(refresh=refresh)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 5218, in get_host_stats\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     self.update_status()\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 5261, in update_status\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     data['disk_available_least'] = _get_disk_available_least()\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 5234, in _get_disk_available_least\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     disk_over_committed = (self.driver.\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 4787, in get_disk_over_committed_size_total\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     self.get_instance_disk_info(i_name))\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 4759, in get_instance_disk_info\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     dk_size = int(os.path.getsize(path))\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib64/python2.6/genericpath.py\", line 49, in getsize\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     return os.stat(filename).st_size\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task OSError: [Errno 13] Permission denied: '/root/RHEL6.5-20131111.0-Server-x86_64-DVD1.iso'", 
    "tags": [
        "libvirt"
    ], 
    "importance": "Undecided", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1322467", 
    "owner": "https://api.launchpad.net/1.0/~zyouzhou", 
    "id": 1322467, 
    "index": 6135, 
    "openned": "2014-05-23 07:00:46.225353+00:00", 
    "created": "2014-05-23 07:00:46.225353+00:00", 
    "title": "Resource could not be updated when deleting instances", 
    "comments": [
        {
            "content": "In my openstack compute node. a kvm-based vm exists and it has a iso image configured in the cdrom. The iso image path is /root/RHEL6.5-20131111.0-Server-x86_64-DVD1.iso.\nWhen deleting the nova instances, the following error happend in the /var/log/nova/compute.log. And this error caused that the resources could not be updated and the resources occupied by the deleted instances could not be released.  This error also happend when restaring the nova-compute service and so that nova-compute could not restarted successfully. \n\nWe should catch this exception for some existing libvirt instances otherwise all resources for nova instances could not be updated correctly.\n\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task Traceback (most recent call last):\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/periodic_task.py\", line 182, in run_periodic_tasks\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     task(self, context)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 5445, in update_available_resource\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     rt.update_available_resource(context)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 249, in inner\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     return f(*args, **kwargs)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/compute/resource_tracker.py\", line 293, in update_available_resource\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     resources = self.driver.get_available_resource(self.nodename)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 4142, in get_available_resource\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     stats = self.get_host_stats(refresh=True)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 4817, in get_host_stats\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     return self.host_state.get_host_stats(refresh=refresh)\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 5218, in get_host_stats\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     self.update_status()\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 5261, in update_status\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     data['disk_available_least'] = _get_disk_available_least()\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 5234, in _get_disk_available_least\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     disk_over_committed = (self.driver.\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 4787, in get_disk_over_committed_size_total\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     self.get_instance_disk_info(i_name))\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 4759, in get_instance_disk_info\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     dk_size = int(os.path.getsize(path))\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task   File \"/usr/lib64/python2.6/genericpath.py\", line 49, in getsize\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task     return os.stat(filename).st_size\n2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task OSError: [Errno 13] Permission denied: '/root/RHEL6.5-20131111.0-Server-x86_64-DVD1.iso'", 
            "date_created": "2014-05-23 07:00:46.225353+00:00", 
            "author": "https://api.launchpad.net/1.0/~zyouzhou"
        }, 
        {
            "content": "2014-05-20 09:34:26.802 4061 TRACE nova.openstack.common.periodic_task OSError: [Errno 13] Permission denied: '/root/RHEL6.5-20131111.0-Server-x86_64-DVD1.iso'\n\nIt looks that deleted instance still occupied the iso file.\n(But the log say ' permission denied ')\nPlease tell me the way to reproduce it. I'll try to reproduce it in my environment.\nSo, just to make sure,  is 'the resources' iso image?\n\nI think following\n1. Boot the instance with iso image\n2. Delete the booted server\n3. Boot the instance again with same iso image\nDoes it correct?", 
            "date_created": "2014-06-16 08:00:53.943032+00:00", 
            "author": "https://api.launchpad.net/1.0/~s-iwata"
        }, 
        {
            "content": "re s-iwata, it is not the fact that the deleted instance occupied the iso file. Actually you can reproduce it with the following steps:\n\n1. Create an virtual machine using virsh tool and install the operating system using an iso image file for the virtual machine. It means that this virtual machine is not managed by nova.\n\n2. Install openstack on the same host.\n\n3. Boot multiple instances using nova boot.\n\n4. Try to delete one instance that managed by the nova and booted in step 3.\n\n5. you will see the error reported in the description. Nova could not access the disk path occupied by the virtual machine not managed by nova, which is created in the step 1. ", 
            "date_created": "2014-06-16 15:15:30.129415+00:00", 
            "author": "https://api.launchpad.net/1.0/~zyouzhou"
        }, 
        {
            "content": "Hi Eric\n\nThank you for reply!\nDo i have to use an iso image file in the step3 ?\n\nThank you.\nSaki", 
            "date_created": "2014-06-19 07:22:15.266531+00:00", 
            "author": "https://api.launchpad.net/1.0/~s-iwata"
        }, 
        {
            "content": "1. queme need to be started by root user to create VM in libvirt using an iso image file in /root dir.\nIn this case, the VM is owned by root user.\n \n2. In Nova, checking physical file of VM and attached iso image(periodic task), to check disk space.\nNormally Nova is started by nova user.\nTherefore, nova can't check the VM owned by root.\nI think, Permission Error caused by those reason.\n\nIn my local environment, i could see Permission Error without deleting VM.\n\nGiven these facts, Permission Error caused by that two VMs(created by virsh tool and nova boot) existing at the same time.\nIs my understanding correct?\n\nThanks.", 
            "date_created": "2014-06-24 05:37:11.638051+00:00", 
            "author": "https://api.launchpad.net/1.0/~s-iwata"
        }, 
        {
            "content": "Yes, correct.", 
            "date_created": "2014-06-24 07:06:44.152178+00:00", 
            "author": "https://api.launchpad.net/1.0/~zyouzhou"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/95105\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ebecfd496ec8aaef07a401d3c90e2e5da406d16f\nSubmitter: Jenkins\nBranch:    master\n\ncommit ebecfd496ec8aaef07a401d3c90e2e5da406d16f\nAuthor: ericzhou <email address hidden>\nDate:   Fri May 23 16:19:35 2014 +0800\n\n    Catch permission denied exception when update host\n    \n    When an existing non-openstack instance in the compute node contains\n    disk file which can not be accessed by nova non-root user, resources can\n    not be updated successfully when periodic task is running. Also the\n    nova-compute service could not be restared again. We should catch such\n    exception.\n    \n    Change-Id: I75195417e123f135252470cf1322843830556b0a\n    Closes-Bug: 1322467\n", 
            "date_created": "2014-06-24 14:02:03.810415+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/102862", 
            "date_created": "2014-06-26 15:29:10.391035+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Matthew Treinish (<email address hidden>) on branch: stable/icehouse\nReview: https://review.openstack.org/102862", 
            "date_created": "2014-10-02 03:06:13.095879+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-07-23 15:08:05.592382+00:00"
}