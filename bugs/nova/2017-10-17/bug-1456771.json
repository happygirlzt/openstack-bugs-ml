{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:49:44.873464+00:00", 
    "description": "Since May 15th 2015 I sometimes see failures in both check and gate pipelines with \"Failure prepping block device in the gate\" and the following common signature:\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJcImJsb2NrX2RldmljZV9vYmpba2V5XSA9IGRiX2Jsb2NrX2RldmljZVtrZXldXCIiLCJmaWVsZHMiOltdLCJvZmZzZXQiOjAsInRpbWVmcmFtZSI6IjYwNDgwMCIsImdyYXBobW9kZSI6ImNvdW50IiwidGltZSI6eyJ1c2VyX2ludGVydmFsIjowfSwic3RhbXAiOjE0MzIwNjE5OTMxOTZ9\n\nreq-843cf2f1-4d3a-4c1f-84f6-2c61abec72ac ListServersNegativeTestJSON-690147980 ListServersNegativeTestJSON-786232548] [instance: 76293503-6b94-4b80-8322-83b2ec6c898c] Failure prepping block device\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c] Traceback (most recent call last):\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2156, in _build_resources\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     block_device_mapping)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1676, in _default_block_device_names\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     root_bdm.save()\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/objects/base.py\", line 189, in wrapper\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     self._context, self, fn.__name__, args, kwargs)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/conductor/rpcapi.py\", line 266, in object_action\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     objmethod=objmethod, args=args, kwargs=kwargs)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 156, in call\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     retry=self.retry)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     timeout=timeout, retry=retry)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 350, in send\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     retry=retry)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 341, in _send\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     raise result\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c] TypeError: 'NoneType' object has no attribute '__getitem__'\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c] \n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/conductor/manager.py\", line 436, in _object_dispatch\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     return getattr(target, method)(*args, **kwargs)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/objects/base.py\", line 205, in wrapper\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     return fn(self, *args, **kwargs)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/objects/block_device.py\", line 175, in save\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     self._from_db_object(self._context, self, updated)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/objects/block_device.py\", line 89, in _from_db_object\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     block_device_obj[key] = db_block_device[key]\n\nAssigning to nova for now as the stack trace is in nova logs.", 
    "tags": [], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1456771", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1456771, 
    "index": 1748, 
    "openned": "2015-05-19 19:16:48.752798+00:00", 
    "created": "2015-05-19 19:16:48.752798+00:00", 
    "title": "Failure prepping block device in the gate", 
    "comments": [
        {
            "content": "Since May 15th 2015 I sometimes see failures in both check and gate pipelines with \"Failure prepping block device in the gate\" and the following common signature:\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJcImJsb2NrX2RldmljZV9vYmpba2V5XSA9IGRiX2Jsb2NrX2RldmljZVtrZXldXCIiLCJmaWVsZHMiOltdLCJvZmZzZXQiOjAsInRpbWVmcmFtZSI6IjYwNDgwMCIsImdyYXBobW9kZSI6ImNvdW50IiwidGltZSI6eyJ1c2VyX2ludGVydmFsIjowfSwic3RhbXAiOjE0MzIwNjE5OTMxOTZ9\n\nreq-843cf2f1-4d3a-4c1f-84f6-2c61abec72ac ListServersNegativeTestJSON-690147980 ListServersNegativeTestJSON-786232548] [instance: 76293503-6b94-4b80-8322-83b2ec6c898c] Failure prepping block device\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c] Traceback (most recent call last):\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2156, in _build_resources\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     block_device_mapping)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1676, in _default_block_device_names\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     root_bdm.save()\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/objects/base.py\", line 189, in wrapper\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     self._context, self, fn.__name__, args, kwargs)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/conductor/rpcapi.py\", line 266, in object_action\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     objmethod=objmethod, args=args, kwargs=kwargs)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 156, in call\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     retry=self.retry)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     timeout=timeout, retry=retry)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 350, in send\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     retry=retry)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 341, in _send\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     raise result\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c] TypeError: 'NoneType' object has no attribute '__getitem__'\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c] \n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/conductor/manager.py\", line 436, in _object_dispatch\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     return getattr(target, method)(*args, **kwargs)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/objects/base.py\", line 205, in wrapper\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     return fn(self, *args, **kwargs)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/objects/block_device.py\", line 175, in save\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     self._from_db_object(self._context, self, updated)\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]   File \"/opt/stack/new/nova/nova/objects/block_device.py\", line 89, in _from_db_object\n2015-05-19 18:46:14.544 15691 TRACE nova.compute.manager [instance: 76293503-6b94-4b80-8322-83b2ec6c898c]     block_device_obj[key] = db_block_device[key]\n\nAssigning to nova for now as the stack trace is in nova logs.", 
            "date_created": "2015-05-19 19:16:48.752798+00:00", 
            "author": "https://api.launchpad.net/1.0/~andrea-frittoli"
        }, 
        {
            "content": "Looks like https://review.openstack.org/145738 introduced a race where deleting an instance that is currently building might end up in this. This is what happens:\r\n\r\n1. Instance boot request\r\n2. Request is handed of to a compute host (note: until resources are claimed, host is not set)\r\n3. Instance delete request called, which ends up doing compute_api._local_delete() since host is not yet set\r\n4. Failure happens on compute host due to bdm no longer available when calling bdm.save() ", 
            "date_created": "2015-05-20 07:24:58.731558+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanlind"
        }, 
        {
            "content": "There is an e-r query patch here: https://review.openstack.org/#/c/184313/", 
            "date_created": "2015-05-20 17:30:06.831679+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/184554", 
            "date_created": "2015-05-20 17:36:31.077798+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/184554\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=1ba72081715869fe6d0ffba3436fb09ef9499335\nSubmitter: Jenkins\nBranch:    master\n\ncommit 1ba72081715869fe6d0ffba3436fb09ef9499335\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed May 20 17:36:21 2015 +0000\n\n    Revert \"Detach volume after deleting instance with no host\"\n    \n    This reverts commit d1baa9fe7eb342b63fc85cbb5ef70bb676de6566\n    \n    The change introduced a race on delete where there isn't a host while\n    prepping block devices and we hit a NoneType error in nova-compute.\n    \n    There was also a recheck grind on the original change showing it wasn't\n    safe and needs to be reworked.\n    \n    Change-Id: Id4e405e7579530ed1c1f22ccc972d45b6d185f41\n    Closes-Bug: #1456771\n    Related-Bug: #1448316\n", 
            "date_created": "2015-05-20 21:07:46.404987+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/184762", 
            "date_created": "2015-05-21 11:31:15.969824+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/184762\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=1998aea1f1fbaecdad51cc1f133edb3f626d7c69\nSubmitter: Jenkins\nBranch:    master\n\ncommit 1998aea1f1fbaecdad51cc1f133edb3f626d7c69\nAuthor: Hans Lindgren <email address hidden>\nDate:   Wed May 20 10:06:19 2015 +0200\n\n    Detect empty result when calling objects.BlockDeviceMapping.save()\n    \n    As shown in bug 1456771, calling save() on a block device mapping that\n    no longer exists results in a TypeError due to the db result being\n    empty. Instead, this should raise a NotFound exception to correctly\n    point out the problem.\n    \n    Change-Id: I64d725ebfb95bcd35001c7771a80829b0a7119e7\n    Related-Bug: #1456771\n", 
            "date_created": "2015-05-29 00:57:41.039292+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-06-24 12:15:57.630456+00:00"
}