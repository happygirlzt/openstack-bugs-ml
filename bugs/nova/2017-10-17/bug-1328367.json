{
    "status": "Invalid", 
    "last_updated": "2015-08-24 10:57:27.192574+00:00", 
    "description": "Control Node: 101.0.0.20(also has compute service , but do not use it)\nCompute Node:  101.0.0.30\n\nnova version:\n2014.1.b2-847-ga891e04\n\nin control node nova.conf\nallow_resize_to_same_host = True\nand\nin compute node nova.conf\nallow_resize_to_same_host = False\n\ndetail:\n1. boot an instance in compute node\nnova boot --image 51c4a908-c028-4ce2-bbd1-8b0e15d8d829 --flavor 84 --nic net-id=308840da-6440-4599-923a-2edd290971d3 --availability-zone nova:compute.localdomain migrate_test\n\n2. resize it to flavor type 1\nnova resize   migrate_test 1\n\n3.the instance has set to error state when resize failed.\n\n#nova list\n+--------------------------------------+----------+--------+-------------+-------------+-------------------+\n| a1424990-182a-4bc2-8c17-aa4808a49472 | migrate_test | ERROR  | resize_prep | Running     | private=20.0.0.15 |\n+--------------------------------------+----------+--------+-------------+-------------+-------------------+\n\n#nova show\n....\n| config_drive                         |                                                                                                                                                               |\n| created                              | 2014-06-09T09:31:35Z                                                                                                                                          |\n| fault                                | {\"message\": \"<class 'nova.exception.MigrationError'>\", \"code\": 500, \"details\": \"  File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 3104, in prep_resize |\n|                                      |     node)                                                                                                                                                     |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 3058, in _prep_resize                                                                                |\n|                                      |     raise exception.MigrationError(msg)                                                                                                                       |\n|                                      | \", \"created\": \"2014-06-10T03:54:39Z\"}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0|\n| flavor                               | m1.micro (84)                                                                                                                                                 |\n| hostId                               | f73013b029032929598a4a54586e4469c2c7cd676c147f6601f73c58\n....\n\nerror log in compute node:\n\n2014-06-10 11:54:48.372 ERROR nova.compute.manager [req-6a4ac25a-7d24-40c6-9f8d-435b4adb6fff admin admin] [instance: a1424990-182a\n-4bc2-8c17-aa4808a49472] Setting instance vm_state to ERROR\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472] Traceback (most recent call la\nst):\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]   File \"/opt/stack/nova/nova/c\nompute/manager.py\", line 5231, in _error_out_instance_on_exception\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]     yield\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]   File \"/opt/stack/nova/nova/c\nompute/manager.py\", line 3111, in prep_resize\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]     filter_properties)\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]   File \"/opt/stack/nova/nova/compute/manager.py\", line 3104, in prep_resize\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]     node)\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]   File \"/opt/stack/nova/nova/compute/manager.py\", line 3058, in _prep_resize\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]     raise exception.MigrationError(msg)\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472] MigrationError: destination same as source!\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]\n\nbug reason:\n1. nova-scheduler is allowed to scheduler to compute node (due to controller nova.conf)\n\n2. but nova-compute is not allowed to resize in same host (due to compute node nova.conf)\n\n3.\na)compute side _prep_resize() function set instance into error state:\n....\nself._set_instance_error_state(context, instance['uuid'])\n...\nthen raise exception\n\nb)\ncompute node reschedule the instance again, failed again\n....\nself._reschedule_resize_or_reraise(context, image, instance,\n\u00a0\u00a0\u00a0\u00a0\u00a0exc_info, instance_type, reservations, request_spec,\n\u00a0\u00a0\u00a0\u00a0\u00a0filter_properties)\n...\nc)compute store instance fault info\n....\ncompute_utils.add_instance_fault_from_exc(context, self.conductor_api,\n\u00a0\u00a0\u00a0\u00a0instance, exc_info[0], exc_info=exc_info)\n\nadditional:\nno matter what the scheduler filter is using, instance should not be set to ERROR status just because scheduler doesn't find a appropriate host to do resize.\nand we can not deal with  vm in ERROR state unless we change it's state in db", 
    "tags": [
        "compute", 
        "migration", 
        "resize"
    ], 
    "importance": "Low", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1328367", 
    "owner": "None", 
    "id": 1328367, 
    "index": 1280, 
    "openned": "2014-06-10 04:19:48.046035+00:00", 
    "created": "2014-06-10 04:19:48.046035+00:00", 
    "title": "Do not set vm  error state when raise MigrationError", 
    "comments": [
        {
            "content": "Control Node: 101.0.0.20(also has compute service , but do not use it)\nCompute Node:  101.0.0.30\n\nnova version:\n2014.1.b2-847-ga891e04\n\nin control node nova.conf \nallow_resize_to_same_host = True\nand \nin compute node nova.conf\nallow_resize_to_same_host = False\n\ndetail:\n1. boot an instance in compute node \nnova boot --image 51c4a908-c028-4ce2-bbd1-8b0e15d8d829 --flavor 84 --nic net-id=308840da-6440-4599-923a-2edd290971d3 --availability-zone nova:compute.localdomain migrate_test\n\n2. resize it to flavor type 1\nnova resize   migrate_test 1\n\n3.the instance has set to error state when resize failed.\n\n#nova list\n+--------------------------------------+----------+--------+-------------+-------------+-------------------+\n| a1424990-182a-4bc2-8c17-aa4808a49472 | migrate_test | ERROR  | resize_prep | Running     | private=20.0.0.15 |\n+--------------------------------------+----------+--------+-------------+-------------+-------------------+\n\n#nova show \n....\n| config_drive                         |                                                                                                                                                               |\n| created                              | 2014-06-09T09:31:35Z                                                                                                                                          |\n| fault                                | {\"message\": \"<class 'nova.exception.MigrationError'>\", \"code\": 500, \"details\": \"  File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 3104, in prep_resize |\n|                                      |     node)                                                                                                                                                     |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 3058, in _prep_resize                                                                                |\n|                                      |     raise exception.MigrationError(msg)                                                                                                                       |\n|                                      | \", \"created\": \"2014-06-10T03:54:39Z\"}                                                    \n                                                                     |\n| flavor                               | m1.micro (84)                                                                                                                                                 |\n| hostId                               | f73013b029032929598a4a54586e4469c2c7cd676c147f6601f73c58 \n....\n\nerror log in compute node:\n\n2014-06-10 11:54:48.372 ERROR nova.compute.manager [req-6a4ac25a-7d24-40c6-9f8d-435b4adb6fff admin admin] [instance: a1424990-182a\n-4bc2-8c17-aa4808a49472] Setting instance vm_state to ERROR\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472] Traceback (most recent call la\nst):  \n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]   File \"/opt/stack/nova/nova/c\nompute/manager.py\", line 5231, in _error_out_instance_on_exception\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]     yield\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]   File \"/opt/stack/nova/nova/c\nompute/manager.py\", line 3111, in prep_resize\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]     filter_properties)\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]   File \"/opt/stack/nova/nova/compute/manager.py\", line 3104, in prep_resize\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]     node)\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]   File \"/opt/stack/nova/nova/compute/manager.py\", line 3058, in _prep_resize\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]     raise exception.MigrationError(msg)\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472] MigrationError: destination same as source!\n2014-06-10 11:54:48.372 TRACE nova.compute.manager [instance: a1424990-182a-4bc2-8c17-aa4808a49472]\n\n\nbug reason:\n1. nova-scheduler is allowed to scheduler to compute node (due to controller nova.conf)\n\n2. but nova-compute is not allowed to resize in same host (due to compute node nova.conf)\n\n3.\na)compute side _prep_resize() function set instance into error state:\n....\nself._set_instance_error_state(context, instance['uuid'])\n...\nthen raise exception\n\nb)\ncompute node reschedule the instance again, failed again\n....\nself._reschedule_resize_or_reraise(context, image, instance,\n     exc_info, instance_type, reservations, request_spec,\n     filter_properties)\n...\nc)compute store instance fault info\n....\ncompute_utils.add_instance_fault_from_exc(context, self.conductor_api,\n    instance, exc_info[0], exc_info=exc_info)\n\n\nadditional:\nno matter what the scheduler filter is using, instance should not be set to ERROR status just because scheduler doesn't find a appropriate host to do resize.\nand we can not deal with  vm in ERROR state unless we change it state in db", 
            "date_created": "2014-06-10 04:19:48.046035+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhouxbj"
        }, 
        {
            "content": "You should be able to use the reset-state API to get it out of ERROR state, unless it's deleting in which case you've got bug 1299139.", 
            "date_created": "2014-06-11 16:55:33.572121+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "fyi, there's an effort to eliminate the flag - https://review.openstack.org/#/c/118604/", 
            "date_created": "2015-01-25 23:46:48.316614+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "The patch mentioned above are merged , I believe we can close the bug ? ", 
            "date_created": "2015-08-24 10:56:53.391170+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }
    ], 
    "closed": "2015-08-24 10:57:06.550310+00:00"
}