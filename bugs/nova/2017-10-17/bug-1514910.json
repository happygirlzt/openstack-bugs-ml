{
    "status": "Fix Released", 
    "last_updated": "2015-12-03 21:37:16.126532+00:00", 
    "description": "If volume detach fails after reconfiguring the VM to remove volume vmdk then it will not be possible to detach the volume again. Subsequent detach will fail with StorageError.\n\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 366, in decorated_function\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 4760, in detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     self._detach_volume(context, volume_id, instance)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 4743, in _detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     self._driver_detach_volume(context, instance, bdm)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 4698, in _driver_detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     self.volume_api.roll_detaching(context, volume_id)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 197, in __exit__\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 4686, in _driver_detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     encryption=encryption)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/vmwareapi/driver.py\", line 400, in detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     return self._volumeops.detach_volume(connection_info, instance)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/vmwareapi/volumeops.py\", line 581, in detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     self._detach_volume_vmdk(connection_info, instance)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/vmwareapi/volumeops.py\", line 526, in _detach_volume_vmdk\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     device = self._get_vmdk_backed_disk_device(vm_ref, data)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/vmwareapi/volumeops.py\", line 514, in _get_vmdk_backed_disk_device\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     raise exception.StorageError(reason=_(\"Unable to find volume\"))\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher StorageError: Storage error: Unable to find volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher", 
    "tags": [
        "vmware", 
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1514910", 
    "owner": "https://api.launchpad.net/1.0/~vbala", 
    "id": 1514910, 
    "index": 7104, 
    "openned": "2015-11-10 16:38:05.971359+00:00", 
    "created": "2015-11-10 16:38:05.971359+00:00", 
    "title": "VMware: Unable to detach volume after detach failure", 
    "comments": [
        {
            "content": "If volume detach fails after reconfiguring the VM to remove volume vmdk then it will not be possible to detach the volume again. Subsequent detach will fail with StorageError.\n\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 366, in decorated_function\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 4760, in detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     self._detach_volume(context, volume_id, instance)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 4743, in _detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     self._driver_detach_volume(context, instance, bdm)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 4698, in _driver_detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     self.volume_api.roll_detaching(context, volume_id)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 197, in __exit__\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/compute/manager.py\", line 4686, in _driver_detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     encryption=encryption)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/vmwareapi/driver.py\", line 400, in detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     return self._volumeops.detach_volume(connection_info, instance)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/vmwareapi/volumeops.py\", line 581, in detach_volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     self._detach_volume_vmdk(connection_info, instance)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/vmwareapi/volumeops.py\", line 526, in _detach_volume_vmdk\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     device = self._get_vmdk_backed_disk_device(vm_ref, data)\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/vmwareapi/volumeops.py\", line 514, in _get_vmdk_backed_disk_device\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher     raise exception.StorageError(reason=_(\"Unable to find volume\"))\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher StorageError: Storage error: Unable to find volume\n2015-11-10 14:34:52.989 TRACE oslo_messaging.rpc.dispatcher", 
            "date_created": "2015-11-10 16:38:05.971359+00:00", 
            "author": "https://api.launchpad.net/1.0/~vbala"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/243734", 
            "date_created": "2015-11-10 17:14:04.307392+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/243734\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=e34adabdf527768dc8dc526b513433332047a273\nSubmitter: Jenkins\nBranch:    master\n\ncommit e34adabdf527768dc8dc526b513433332047a273\nAuthor: Vipin Balachandran <email address hidden>\nDate:   Tue Nov 10 13:59:57 2015 +0530\n\n    VMware: Raise DiskNotFound for missing disk device\n    \n    If volume detach fails after reconfiguring the VM to remove volume\n    vmdk then it will not be possible to detach the volume again. This\n    is because the VMware driver fails the detach operation by raising\n    StorageError when it finds that the volume disk device is missing.\n    Due to this, the volume state will remain 'in-use'.\n    \n    The compute manager expects the driver to raise DiskNotFound if the\n    disk is missing during detach operation. It ignores the exception\n    and allows the detach to complete. This patch fixes the problem with\n    the VMware driver by throwing DiskNotFound instead of StorageError\n    if the volume disk device is missing.\n    \n    Change-Id: I4074d240a3468534c0a269f6cd160f399e8fa18c\n    Closes-Bug: #1514910\n", 
            "date_created": "2015-11-16 20:48:44.089694+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.0.0.0b1 development milestone.", 
            "date_created": "2015-12-02 16:17:10.561036+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }
    ], 
    "closed": "2015-12-03 21:37:14.368954+00:00"
}