{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:26:23.841454+00:00", 
    "description": "When running individual Nova tests or suites the database is no longer being initialized properly...\n\nTrying to run a random libvirt tests fails with the following exception:\n\n[dprince@dovetail nova]$ ./run_tests.sh test_libvirt:NWFilterTestCase.test_unfilter_instance_undefines_nwfilters\n\nNWFilterTestCase\n    test_unfilter_instance_undefines_nwfilters                   ERROR  0.22\n\n======================================================================\nERROR: test_unfilter_instance_undefines_nwfilters (test_libvirt.NWFilterTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/dprince/projects/nova/nova/tests/test_libvirt.py\", line 3192, in test_unfilter_instance_undefines_nwfilters\n    instance_ref = self._create_instance()\n  File \"/home/dprince/projects/nova/nova/tests/test_libvirt.py\", line 3096, in _create_instance\n    'instance_type_id': 1})\n  File \"/home/dprince/projects/nova/nova/db/api.py\", line 563, in instance_create\n    return IMPL.instance_create(context, values)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 131, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 1399, in instance_create\n    security_groups)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 1386, in _get_sec_group_models\n    session=session)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 3477, in security_group_ensure_default\n    columns_to_join=[], session=session)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 131, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 3406, in security_group_get_by_name\n    result = query.first()\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2156, in first\n    ret = list(self[0:1])\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2023, in __getitem__\n    return list(res)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2227, in __iter__\n    return self._execute_and_instances(context)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2242, in _execute_and_instances\n    result = conn.execute(querycontext.statement, self._params)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1449, in execute\n    params)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1584, in _execute_clauseelement\n    compiled_sql, distilled_params\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1698, in _execute_context\n    context)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1691, in _execute_context\n    context)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 331, in do_execute\n    cursor.execute(statement, parameters)\nOperationalError: (OperationalError) no such table: security_groups u'SELECT security_groups.created_at AS security_groups_created_at, security_groups.updated_at AS security_groups_updated_at, security_groups.deleted_at AS security_groups_deleted_at, security_groups.deleted AS security_groups_deleted, security_groups.id AS security_groups_id, security_groups.name AS security_groups_name, security_groups.description AS security_groups_description, security_groups.user_id AS security_groups_user_id, security_groups.project_id AS security_groups_project_id \\nFROM security_groups \\nWHERE security_groups.deleted = ? AND security_groups.project_id = ? AND security_groups.name = ?\\n LIMIT ? OFFSET ?' (0, 'fake', 'default', 1, 0)\n-------------------- >> begin captured stdout << ---------------------\nNWFilterTestCase: Setup called\n\n--------------------- >> end captured stdout << ----------------------\n-------------------- >> begin captured logging << --------------------\nnova.common.deprecated: WARNING: Deprecated Config: The root_helper option (which lets you specify a root wrapper different from nova-rootwrap, and defaults to using sudo) is now deprecated. You should use the rootwrap_config option instead.\n--------------------- >> end captured logging << ---------------------\n\nSlowest 1 tests took 0.22 secs:\n    0.22    NWFilterTestCase.test_unfilter_instance_undefines_nwfilters\n----------------------------------------------------------------------\nRan 1 test in 0.227s\n\nFAILED (errors=1)\n\n\n------\n\n\nWe should support running individual tests that require use of the SQLite database.", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1032738", 
    "owner": "https://api.launchpad.net/1.0/~dan-prince", 
    "id": 1032738, 
    "index": 745, 
    "openned": "2012-08-03 17:02:07.275434+00:00", 
    "created": "2012-08-03 17:02:07.275434+00:00", 
    "title": "DB is no longer recreated for individual tests", 
    "comments": [
        {
            "content": "When running individual Nova tests or suites the database is no longer being initialized properly...\n\nTrying to run a random libvirt tests fails with the following exception:\n\n[dprince@dovetail nova]$ ./run_tests.sh test_libvirt:NWFilterTestCase.test_unfilter_instance_undefines_nwfilters\n\nNWFilterTestCase\n    test_unfilter_instance_undefines_nwfilters                   ERROR  0.22\n\n======================================================================\nERROR: test_unfilter_instance_undefines_nwfilters (test_libvirt.NWFilterTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/dprince/projects/nova/nova/tests/test_libvirt.py\", line 3192, in test_unfilter_instance_undefines_nwfilters\n    instance_ref = self._create_instance()\n  File \"/home/dprince/projects/nova/nova/tests/test_libvirt.py\", line 3096, in _create_instance\n    'instance_type_id': 1})\n  File \"/home/dprince/projects/nova/nova/db/api.py\", line 563, in instance_create\n    return IMPL.instance_create(context, values)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 131, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 1399, in instance_create\n    security_groups)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 1386, in _get_sec_group_models\n    session=session)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 3477, in security_group_ensure_default\n    columns_to_join=[], session=session)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 131, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/dprince/projects/nova/nova/db/sqlalchemy/api.py\", line 3406, in security_group_get_by_name\n    result = query.first()\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2156, in first\n    ret = list(self[0:1])\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2023, in __getitem__\n    return list(res)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2227, in __iter__\n    return self._execute_and_instances(context)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2242, in _execute_and_instances\n    result = conn.execute(querycontext.statement, self._params)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1449, in execute\n    params)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1584, in _execute_clauseelement\n    compiled_sql, distilled_params\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1698, in _execute_context\n    context)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1691, in _execute_context\n    context)\n  File \"/home/dprince/projects/nova/.venv/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 331, in do_execute\n    cursor.execute(statement, parameters)\nOperationalError: (OperationalError) no such table: security_groups u'SELECT security_groups.created_at AS security_groups_created_at, security_groups.updated_at AS security_groups_updated_at, security_groups.deleted_at AS security_groups_deleted_at, security_groups.deleted AS security_groups_deleted, security_groups.id AS security_groups_id, security_groups.name AS security_groups_name, security_groups.description AS security_groups_description, security_groups.user_id AS security_groups_user_id, security_groups.project_id AS security_groups_project_id \\nFROM security_groups \\nWHERE security_groups.deleted = ? AND security_groups.project_id = ? AND security_groups.name = ?\\n LIMIT ? OFFSET ?' (0, 'fake', 'default', 1, 0)\n-------------------- >> begin captured stdout << ---------------------\nNWFilterTestCase: Setup called\n\n--------------------- >> end captured stdout << ----------------------\n-------------------- >> begin captured logging << --------------------\nnova.common.deprecated: WARNING: Deprecated Config: The root_helper option (which lets you specify a root wrapper different from nova-rootwrap, and defaults to using sudo) is now deprecated. You should use the rootwrap_config option instead.\n--------------------- >> end captured logging << ---------------------\n\nSlowest 1 tests took 0.22 secs:\n    0.22    NWFilterTestCase.test_unfilter_instance_undefines_nwfilters\n----------------------------------------------------------------------\nRan 1 test in 0.227s\n\nFAILED (errors=1)\n\n\n------\n\n\nWe should support running individual tests that require use of the SQLite database.", 
            "date_created": "2012-08-03 17:02:07.275434+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/10781", 
            "date_created": "2012-08-03 17:09:29.132827+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/10788", 
            "date_created": "2012-08-03 19:40:59.909920+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/10781\nCommitted: http://github.com/openstack/nova/commit/3356d55977a0ff091711dcf368d0cc13ae0567f8\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3356d55977a0ff091711dcf368d0cc13ae0567f8\nAuthor: Dan Prince <email address hidden>\nDate:   Fri Aug 3 13:07:47 2012 -0400\n\n    Update reset_db to call setup if _DB is None.\n    \n    This resolves issues when running individual tests that require\n    a database. With this fix I can once again run individual test\n    modules that make use of the database. For example:\n    \n      ./run_tests.sh test_libvirt\n    \n    Previously this would fail with database errors.\n    \n    Fixes LP Bug #1032738.\n    \n    Change-Id: Icce7ac9414f0e19eece44819a217634947de7f73\n", 
            "date_created": "2012-08-05 03:33:09.294493+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-08-16 07:34:11.488579+00:00"
}