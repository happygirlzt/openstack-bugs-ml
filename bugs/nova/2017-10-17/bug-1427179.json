{
    "status": "Confirmed", 
    "last_updated": "2016-03-06 16:05:22.010831+00:00", 
    "description": "\n1. Create a volume \"nova volume-create --display-name test_volume 1\"\n[root@controller51 nova(keystone_admin)]# nova volume-list\n+--------------------------------------+-----------+-------------------------+------+-------------+---------------------------------------------------------------------------+\n| ID                                   | Status    | Display Name            | Size | Volume Type | Attached to                                                               |\n+--------------------------------------+-----------+-------------------------+------+-------------+---------------------------------------------------------------------------+\n| a740ca7b-6881-4e28-9fdb-eb0d80336757 | available | test_volume             | 1    | None        |                                                                           |\n| 1f1c19c7-a5f9-4683-a1f6-e339f02e1410 | in-use    | NFVO_system_disk2       | 30   | None        | 6fa391f8-bd8b-483d-9286-3cebc9a93d55                                      |\n| d868710e-30d4-4095-bd8f-fea9f16fe8ea | in-use    | NFVO_data_software_disk | 30   | None        | a07abdd5-07a6-4b41-a285-9b825f7b5623;6fa391f8-bd8b-483d-9286-3cebc9a93d55 |\n| b03a39ca-ebc1-4472-9a04-58014e67b37c | in-use    | NFVO_system_disk1       | 30   | None        | a07abdd5-07a6-4b41-a285-9b825f7b5623                                      |\n+--------------------------------------+-----------+-------------------------+------+-------------+---------------------------------------------------------------------------+\n2. use The following command will boot a new instance and attach a volume at the same time\uff1a\n[root@controller51 nova(keystone_admin)]#  nova boot --flavor 1 --image 1736471c-3530-49f2-ad34-6ef7da285050 --block-device-mapping vdb=a740ca7b-6881-4e28-9fdb-eb0d80336757:blank:1:1 --nic net-id=31fce69e-16b9-4114-9fa9-589763e58fb0 test\n+--------------------------------------+-----------------------------------------------------------------------------------+\n| Property                             | Value                                                                             |\n+--------------------------------------+-----------------------------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                                            |\n| OS-EXT-AZ:availability_zone          | nova                                                                              |\n| OS-EXT-SRV-ATTR:host                 | -                                                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                                                 |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000082                                                                 |\n| OS-EXT-STS:power_state               | 0                                                                                 |\n| OS-EXT-STS:task_state                | scheduling                                                                        |\n| OS-EXT-STS:vm_state                  | building                                                                          |\n| OS-SRV-USG:launched_at               | -                                                                                 |\n| OS-SRV-USG:terminated_at             | -                                                                                 |\n| accessIPv4                           |                                                                                   |\n| accessIPv6                           |                                                                                   |\n| adminPass                            | sWTuKqzrpS32                                                                      |\n| config_drive                         |                                                                                   |\n| created                              | 2015-03-02T11:34:29Z                                                              |\n| flavor                               | m1.tiny (1)                                                                       |\n| hostId                               |                                                                                   |\n| id                                   | 868cfd12-eb36-4140-b7b3-98cfcec627cd                                              |\n| image                                | VMB_X86_64_LX_2.6.32_64_REL_2014_12_26.img (1736471c-3530-49f2-ad34-6ef7da285050) |\n| key_name                             | -                                                                                 |\n| metadata                             | {}                                                                                |\n| name                                 | test                                                                              |\n| os-extended-volumes:volumes_attached | [{\"id\": \"547aae0e-455e-4d18-9c3c-e86bdc6c62e7\"}]                                  |\n| progress                             | 0                                                                                 |\n| security_groups                      | default                                                                           |\n| serial_type                          | file                                                                              |\n| status                               | BUILD                                                                             |\n| tenant_id                            | df86efb4c5264f3c9bbe3df6717f8654                                                  |\n| updated                              | 2015-03-02T11:34:30Z                                                              |\n| user_id                              | 7d376e69fc5d4697a1edb2600815de3f                                                  |\n+--------------------------------------+-----------------------------------------------------------------------------------+\n3\u3001if the instance are scheduled the host1, but, if the host1 network service is inactive, then will reschedule the other host,\n    before reschedule ,as for create instance command the parameter delete-on-terminate is 1, so will run delete volume.\n    but, the issue is after reschedule another host, the volume is deleted ,the instance cannot build success.", 
    "tags": [
        "volumes"
    ], 
    "importance": "Low", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1427179", 
    "owner": "None", 
    "id": 1427179, 
    "index": 1570, 
    "openned": "2015-03-02 12:07:21.405831+00:00", 
    "created": "2015-03-02 12:07:21.405831+00:00", 
    "title": "boot from volume instance failed,because when reschedule delete the volume ", 
    "comments": [
        {
            "content": "\n1. Create a volume \"nova volume-create --display-name test_volume 1\"\n[root@controller51 nova(keystone_admin)]# nova volume-list\n+--------------------------------------+-----------+-------------------------+------+-------------+---------------------------------------------------------------------------+\n| ID                                   | Status    | Display Name            | Size | Volume Type | Attached to                                                               |\n+--------------------------------------+-----------+-------------------------+------+-------------+---------------------------------------------------------------------------+\n| a740ca7b-6881-4e28-9fdb-eb0d80336757 | available | test_volume             | 1    | None        |                                                                           |\n| 1f1c19c7-a5f9-4683-a1f6-e339f02e1410 | in-use    | NFVO_system_disk2       | 30   | None        | 6fa391f8-bd8b-483d-9286-3cebc9a93d55                                      |\n| d868710e-30d4-4095-bd8f-fea9f16fe8ea | in-use    | NFVO_data_software_disk | 30   | None        | a07abdd5-07a6-4b41-a285-9b825f7b5623;6fa391f8-bd8b-483d-9286-3cebc9a93d55 |\n| b03a39ca-ebc1-4472-9a04-58014e67b37c | in-use    | NFVO_system_disk1       | 30   | None        | a07abdd5-07a6-4b41-a285-9b825f7b5623                                      |\n+--------------------------------------+-----------+-------------------------+------+-------------+---------------------------------------------------------------------------+\n2. use The following command will boot a new instance and attach a volume at the same time\uff1a\n[root@controller51 nova(keystone_admin)]#  nova boot --flavor 1 --image 1736471c-3530-49f2-ad34-6ef7da285050 --block-device-mapping vdb=a740ca7b-6881-4e28-9fdb-eb0d80336757:blank:1:1 --nic net-id=31fce69e-16b9-4114-9fa9-589763e58fb0 test\n+--------------------------------------+-----------------------------------------------------------------------------------+\n| Property                             | Value                                                                             |\n+--------------------------------------+-----------------------------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                                            |\n| OS-EXT-AZ:availability_zone          | nova                                                                              |\n| OS-EXT-SRV-ATTR:host                 | -                                                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                                                 |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000082                                                                 |\n| OS-EXT-STS:power_state               | 0                                                                                 |\n| OS-EXT-STS:task_state                | scheduling                                                                        |\n| OS-EXT-STS:vm_state                  | building                                                                          |\n| OS-SRV-USG:launched_at               | -                                                                                 |\n| OS-SRV-USG:terminated_at             | -                                                                                 |\n| accessIPv4                           |                                                                                   |\n| accessIPv6                           |                                                                                   |\n| adminPass                            | sWTuKqzrpS32                                                                      |\n| config_drive                         |                                                                                   |\n| created                              | 2015-03-02T11:34:29Z                                                              |\n| flavor                               | m1.tiny (1)                                                                       |\n| hostId                               |                                                                                   |\n| id                                   | 868cfd12-eb36-4140-b7b3-98cfcec627cd                                              |\n| image                                | VMB_X86_64_LX_2.6.32_64_REL_2014_12_26.img (1736471c-3530-49f2-ad34-6ef7da285050) |\n| key_name                             | -                                                                                 |\n| metadata                             | {}                                                                                |\n| name                                 | test                                                                              |\n| os-extended-volumes:volumes_attached | [{\"id\": \"547aae0e-455e-4d18-9c3c-e86bdc6c62e7\"}]                                  |\n| progress                             | 0                                                                                 |\n| security_groups                      | default                                                                           |\n| serial_type                          | file                                                                              |\n| status                               | BUILD                                                                             |\n| tenant_id                            | df86efb4c5264f3c9bbe3df6717f8654                                                  |\n| updated                              | 2015-03-02T11:34:30Z                                                              |\n| user_id                              | 7d376e69fc5d4697a1edb2600815de3f                                                  |\n+--------------------------------------+-----------------------------------------------------------------------------------+\n3\u3001if the instance are scheduled the host1, but, if the host1 network service is inactive, then will reschedule the other host,\n    before reschedule ,as for create instance command the parameter delete-on-terminate is 1, so will run delete volume.\n    but, the issue is after reschedule another host, the volume is deleted ,the instance cannot build success.", 
            "date_created": "2015-03-02 12:07:21.405831+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "this bug is the parameter delete-on-terminate is 1, when scheduler one host allocate resources failed,then reschedule another host,the volume should not be deleted.", 
            "date_created": "2015-03-02 12:13:06.051576+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "The parameter delete-on-terminate:\"A boolean to indicate whether the volume should be deleted when the instance is terminated. True can be specified as True or 1. False can be specified as False or 0.\" ,so only when the instance will be terminated,the volume should be deleted. but now,when create instance, the schedule error first, then will reschedule another host, the volume  till need be used. so , should not delete the volume.", 
            "date_created": "2015-03-04 02:32:31.990721+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "I use icehouse2014.1.3 version, but I review code in  K version, this  issue is also present ", 
            "date_created": "2015-03-04 09:28:21.844525+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "I am wondering whether K release already fix this because the code delete the volume is \n\n2474     def _cleanup_volumes(self, context, instance_uuid, bdms, raise_exc=True):\n2475         exc_info = None\n2476\n2477         for bdm in bdms:\n2478             LOG.debug(\"terminating bdm %s\", bdm,\n2479                       instance_uuid=instance_uuid)\n2480             if bdm.volume_id and bdm.delete_on_termination:\n2481                 try:\n2482                     self.volume_api.delete(context, bdm.volume_id)\n\n\nthis function either be called when instance is deleted or build instance failed ,it will be used to clean the env\nI think current function _reschedule_or_error is not used so do you have a stack trace for kilo or \nwhere do you think the volume is deleted? Thanks ", 
            "date_created": "2015-03-06 20:57:31.855578+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "Hi jichenjc:\n I reviewed the latest version is kilo-2,  The code calls the relationship:\n _build_instance()------->_reschedule_or_error()-------->_cleanup_volumes()\nI added: Whether reschedule or not ,depending on Configuration item \"scheduler_max_attempts=3\",3 is default value.\n\ndef _build_instance(self, context, request_spec, filter_properties, requested_networks, injected_files, admin_password,                           is_first_time, node, instance, image_meta, legacy_bdm_in_spec):\n     original_context = context\n     context = context.elevated()\n\n     try:\n    \n     except Exception:\n         exc_info = sys.exc_info()\n         # try to re-schedule instance:\n         # Make sure the async call finishes\n         if network_info is not None:\n             network_info.wait(do_raise=False)\n             rescheduled = self._reschedule_or_error(original_context, instance,\n                    exc_info, requested_networks, admin_password,\n                    injected_files_orig, is_first_time, request_spec,\n                    filter_properties, bdms, legacy_bdm_in_spec)\n\ndef _reschedule_or_error(self, context, instance, exc_info,\n            requested_networks, admin_password, injected_files, is_first_time,\n            request_spec, filter_properties, bdms=None,\n            legacy_bdm_in_spec=True):\n        \"\"\"Try to re-schedule the build or re-raise the original build error to\n        error out the instance.\n        \"\"\"\n        original_context = context\n        context = context.elevated()\ntry:\n            LOG.debug(\"Clean up resource before rescheduling.\",\n                      instance=instance)\n            if bdms is None:\n                bdms = objects.BlockDeviceMappingList.get_by_instance_uuid(\n                        context, instance.uuid)\n\n            self._shutdown_instance(context, instance,\n                                    bdms, requested_networks)\n            self._cleanup_volumes(context, instance.uuid, bdms)\n        except Exception:\n            # do not attempt retry if clean up failed:\n            with excutils.save_and_reraise_exception():\n                self._log_original_error(exc_info, instance_uuid)\n\n      \n\n        ", 
            "date_created": "2015-03-12 11:18:04.798806+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "Looks like a race on the delete of the volume getting queued but not executed until the guest is started.", 
            "date_created": "2015-03-30 20:02:01.921103+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "ok, I got it , thanks YaoZheng_ZTE for your explanation bdm.delete_on_termination can't be always used here \n\nSean , I think it's not a race , we can' t delete the volume if it's going to be rescheduled otherwise next reschedule action will not be able to use the volume", 
            "date_created": "2015-03-30 20:49:22.962766+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/169097", 
            "date_created": "2015-03-30 21:34:54.231510+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi Sean :\n    \n    it's not a race, when reschedule action happened, if bdm.delete_on_termination is True, this question  will be sure to happen.", 
            "date_created": "2015-03-31 01:14:55.422042+00:00", 
            "author": "https://api.launchpad.net/1.0/~zheng-yao1"
        }, 
        {
            "content": "Change abandoned by jichenjc (<email address hidden>) on branch: master\nReview: https://review.openstack.org/169097\nReason: this whole function is gone, no need to update it now", 
            "date_created": "2015-08-10 14:59:47.444206+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "the whole function you talked about is gone now , should I submit a patch for Kilo instead? ", 
            "date_created": "2015-08-10 15:01:11.864774+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }
    ]
}