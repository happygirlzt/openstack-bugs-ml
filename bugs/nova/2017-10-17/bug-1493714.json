{
    "status": "In Progress", 
    "last_updated": "2017-08-01 10:04:29.154823+00:00", 
    "description": "It seems that to reproduce the problem we need a multi node deployment with at least two nova-compute service.\n\nTo reproduce it do the following:\n1) create a neutron port\n2) boot two instances in parallel with that port\nSometimes both instances become ACTIVE in nova which is clearly wrong.\n\n\nvagrant@controller:~/devstack$ neutron net-list\n+--------------------------------------+---------+----------------------------------------------------------+\n| id                                   | name    | subnets                                                  |\n+--------------------------------------+---------+----------------------------------------------------------+\n| fc257a00-d3bf-47e6-b91f-e2cef985c414 | public  | a610715c-614f-492c-8810-f51e03c5d383 2001:db8::/64       |\n|                                      |         | a923871f-90ad-4354-935d-db24861a5890 172.24.4.0/24       |\n| 7a057b12-0e69-4c31-859e-098263abeeba | private | 04f3b138-d7c6-48e1-98e3-7f70eb7ab4fe fda4:10b7:acaa::/64 |\n|                                      |         | ee70023c-f273-471a-8b84-cb25bb64fcf9 10.0.0.0/24         |\n+--------------------------------------+---------+----------------------------------------------------------+\nvagrant@controller:~/devstack$ neutron port-create 7a057b12-0e69-4c31-859e-098263abeeba\nCreated a new port:\n+-----------------------+-------------------------------------------------------------------------------------------------------------+\n| Field                 | Value                                                                                                       |\n+-----------------------+-------------------------------------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                                                        |\n| allowed_address_pairs |                                                                                                             |\n| binding:host_id       |                                                                                                             |\n| binding:profile       | {}                                                                                                          |\n| binding:vif_details   | {}                                                                                                          |\n| binding:vif_type      | unbound                                                                                                     |\n| binding:vnic_type     | normal                                                                                                      |\n| device_id             |                                                                                                             |\n| device_owner          |                                                                                                             |\n| fixed_ips             | {\"subnet_id\": \"ee70023c-f273-471a-8b84-cb25bb64fcf9\", \"ip_address\": \"10.0.0.4\"}                             |\n|                       | {\"subnet_id\": \"04f3b138-d7c6-48e1-98e3-7f70eb7ab4fe\", \"ip_address\": \"fda4:10b7:acaa:0:f816:3eff:fe0c:285d\"} |\n| id                    | f2da8f78-8ae4-49f0-bca0-5820588d33ea                                                                        |\n| mac_address           | fa:16:3e:0c:28:5d                                                                                           |\n| name                  |                                                                                                             |\n| network_id            | 7a057b12-0e69-4c31-859e-098263abeeba                                                                        |\n| port_security_enabled | True                                                                                                        |\n| security_groups       | 73853e74-a6c7-4b71-ba45-5b82b5e1ad81                                                                        |\n| status                | DOWN                                                                                                        |\n| tenant_id             | 16f8c1dbfa2d472da0d1335b8a70aee0                                                                            |\n+-----------------------+-------------------------------------------------------------------------------------------------------------+\nvagrant@controller:~/devstack$ nova boot --image cirros-0.3.4-x86_64-uec --flavor 42 --nic port-id=f2da8f78-8ae4-49f0-bca0-5820588d33ea vm1 & nova boot --image cirros-0.3.4-x86_64-uec --flavor 42 --nic port-id=f2da8f78-8ae4-49f0-bca0-5820588d33ea vm2 &\n[1] 18785\n[2] 18786\n\nvagrant@controller:~/devstack$ nova list\n+--------------------------------------+------+--------+------------+-------------+--------------------------------------------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks                                               |\n+--------------------------------------+------+--------+------------+-------------+--------------------------------------------------------+\n| 24e67346-18fe-4cfa-8b01-f017c915a111 | vm1  | ACTIVE | -          | Running     | private=fda4:10b7:acaa:0:f816:3eff:fe0c:285d, 10.0.0.4 |\n| d90292a2-5b8f-4566-a621-defdf7aa0246 | vm2  | ACTIVE | -          | Running     |                                                        |\n+--------------------------------------+------+--------+------------+-------------+--------------------------------------------------------+\n\nBased on the code we have an atomicity problem on the neutron REST API:\nAt https://github.com/openstack/nova/blob/1db33ca6c248613cc8a76dcbbf78758001ee02d8/nova/network/neutronv2/api.py#L611 nova will check if the device_id of the neutron port are empty or not. Then nova sets the current instance_uuid to the device_id later at https://github.com/openstack/nova/blob/1db33ca6c248613cc8a76dcbbf78758001ee02d8/nova/network/neutronv2/api.py#L692\n\nSo it is possible that two nova-compute processes check the port status before one of them sets the device_id, so as a result both nova-compute will think that the port are free to use and the slower nova-compute will overwrite the device_id of the port.", 
    "tags": [
        "neutron"
    ], 
    "importance": "Medium", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1493714", 
    "owner": "https://api.launchpad.net/1.0/~balazs-gibizer", 
    "id": 1493714, 
    "index": 4347, 
    "openned": "2015-09-09 07:58:05.519232+00:00", 
    "created": "2015-09-09 07:58:05.519232+00:00", 
    "title": "nova allows booting two instances with the same neutron port in parallel", 
    "comments": [
        {
            "content": "It seems that to reproduce the problem we need a multi node deployment with at least two nova-compute service.\n\nTo reproduce it do the following:\n1) create a neutron port\n2) boot two instances in parallel with that port\nSometimes both instances become ACTIVE in nova which is clearly wrong.\n\n\nvagrant@controller:~/devstack$ neutron net-list\n+--------------------------------------+---------+----------------------------------------------------------+\n| id                                   | name    | subnets                                                  |\n+--------------------------------------+---------+----------------------------------------------------------+\n| fc257a00-d3bf-47e6-b91f-e2cef985c414 | public  | a610715c-614f-492c-8810-f51e03c5d383 2001:db8::/64       |\n|                                      |         | a923871f-90ad-4354-935d-db24861a5890 172.24.4.0/24       |\n| 7a057b12-0e69-4c31-859e-098263abeeba | private | 04f3b138-d7c6-48e1-98e3-7f70eb7ab4fe fda4:10b7:acaa::/64 |\n|                                      |         | ee70023c-f273-471a-8b84-cb25bb64fcf9 10.0.0.0/24         |\n+--------------------------------------+---------+----------------------------------------------------------+\nvagrant@controller:~/devstack$ neutron port-create 7a057b12-0e69-4c31-859e-098263abeeba\nCreated a new port:\n+-----------------------+-------------------------------------------------------------------------------------------------------------+\n| Field                 | Value                                                                                                       |\n+-----------------------+-------------------------------------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                                                        |\n| allowed_address_pairs |                                                                                                             |\n| binding:host_id       |                                                                                                             |\n| binding:profile       | {}                                                                                                          |\n| binding:vif_details   | {}                                                                                                          |\n| binding:vif_type      | unbound                                                                                                     |\n| binding:vnic_type     | normal                                                                                                      |\n| device_id             |                                                                                                             |\n| device_owner          |                                                                                                             |\n| fixed_ips             | {\"subnet_id\": \"ee70023c-f273-471a-8b84-cb25bb64fcf9\", \"ip_address\": \"10.0.0.4\"}                             |\n|                       | {\"subnet_id\": \"04f3b138-d7c6-48e1-98e3-7f70eb7ab4fe\", \"ip_address\": \"fda4:10b7:acaa:0:f816:3eff:fe0c:285d\"} |\n| id                    | f2da8f78-8ae4-49f0-bca0-5820588d33ea                                                                        |\n| mac_address           | fa:16:3e:0c:28:5d                                                                                           |\n| name                  |                                                                                                             |\n| network_id            | 7a057b12-0e69-4c31-859e-098263abeeba                                                                        |\n| port_security_enabled | True                                                                                                        |\n| security_groups       | 73853e74-a6c7-4b71-ba45-5b82b5e1ad81                                                                        |\n| status                | DOWN                                                                                                        |\n| tenant_id             | 16f8c1dbfa2d472da0d1335b8a70aee0                                                                            |\n+-----------------------+-------------------------------------------------------------------------------------------------------------+\nvagrant@controller:~/devstack$ nova boot --image cirros-0.3.4-x86_64-uec --flavor 42 --nic port-id=f2da8f78-8ae4-49f0-bca0-5820588d33ea vm1 & nova boot --image cirros-0.3.4-x86_64-uec --flavor 42 --nic port-id=f2da8f78-8ae4-49f0-bca0-5820588d33ea vm2 &\n[1] 18785\n[2] 18786\n\nvagrant@controller:~/devstack$ nova list\n+--------------------------------------+------+--------+------------+-------------+--------------------------------------------------------+\n| ID                                   | Name | Status | Task State | Power State | Networks                                               |\n+--------------------------------------+------+--------+------------+-------------+--------------------------------------------------------+\n| 24e67346-18fe-4cfa-8b01-f017c915a111 | vm1  | ACTIVE | -          | Running     | private=fda4:10b7:acaa:0:f816:3eff:fe0c:285d, 10.0.0.4 |\n| d90292a2-5b8f-4566-a621-defdf7aa0246 | vm2  | ACTIVE | -          | Running     |                                                        |\n+--------------------------------------+------+--------+------------+-------------+--------------------------------------------------------+\n\nBased on the code we have an atomicity problem on the neutron REST API:\nAt https://github.com/openstack/nova/blob/1db33ca6c248613cc8a76dcbbf78758001ee02d8/nova/network/neutronv2/api.py#L611 nova will check if the device_id of the neutron port are empty or not. Then nova sets the current instance_uuid to the device_id later at https://github.com/openstack/nova/blob/1db33ca6c248613cc8a76dcbbf78758001ee02d8/nova/network/neutronv2/api.py#L692\n\nSo it is possible that two nova-compute processes check the port status before one of them sets the device_id, so as a result both nova-compute will think that the port are free to use and the slower nova-compute will overwrite the device_id of the port.", 
            "date_created": "2015-09-09 07:58:05.519232+00:00", 
            "author": "https://api.launchpad.net/1.0/~balazs-gibizer"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/221803", 
            "date_created": "2015-09-09 14:41:31.414058+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "We have a new feature in neutron that will really help us in this battle.", 
            "date_created": "2016-12-20 10:59:52.639075+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "Neutron feature is here: https://review.openstack.org/#/c/409577/", 
            "date_created": "2016-12-20 11:14:54.565309+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevinbenton"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/474383", 
            "date_created": "2017-06-14 22:41:44.860993+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/474383\nCommitted: https://git.openstack.org/cgit/openstack/neutron/commit/?id=9c0a0de556f8edafd153a7d4c1c0548dd4ff3129\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9c0a0de556f8edafd153a7d4c1c0548dd4ff3129\nAuthor: Kevin Benton <email address hidden>\nDate:   Wed Jun 14 15:36:55 2017 -0700\n\n    Manually increment revision numbers in revision plugin\n    \n    Don't rely on the SQLAlchemy revision_col flag to bump revision\n    numbers and instead bump them in a before_flush handler. This\n    will allow the follow-up patch to do enforcement on conditional\n    updates before the revision number is incremented.\n    \n    Partial-Bug: #1493714\n    Partially-Implements: blueprint push-notifications\n    Change-Id: I5feeec5b8385727eff53dc669363bc41db8ceaba\n", 
            "date_created": "2017-06-25 13:37:54.294258+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/409577\nCommitted: https://git.openstack.org/cgit/openstack/neutron/commit/?id=7f17b4759e41aa0a922ac27c2dabc595e7d2f67c\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7f17b4759e41aa0a922ac27c2dabc595e7d2f67c\nAuthor: Kevin Benton <email address hidden>\nDate:   Sun Dec 11 18:24:01 2016 -0800\n\n    API compare-and-swap updates based on revision_number\n    \n    Allows posting revision number matching in the If-Match header\n    so updates/deletes will only be satisfied if the current revision\n    number of the object matches.\n    \n    DocImpact: The Neutron API now supports conditional updates to resources\n               that contain the standard 'revision_number' attribute by\n               setting the revision_number in an HTTP If-Match header.\n    APIImpact\n    \n    Partial-Bug: #1493714\n    Partially-Implements: blueprint push-notifications\n    Change-Id: I7d97d6044378eb59cb2c7bdc788dc6c174783299\n", 
            "date_created": "2017-07-09 18:18:04.710742+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/482839", 
            "date_created": "2017-07-12 08:15:13.454687+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/482840", 
            "date_created": "2017-07-12 08:15:27.809765+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/482839\nCommitted: https://git.openstack.org/cgit/openstack/neutron-lib/commit/?id=6a2040fcdb62b44d63757f3fc9ac13a8f7537c82\nSubmitter: Jenkins\nBranch:    master\n\ncommit 6a2040fcdb62b44d63757f3fc9ac13a8f7537c82\nAuthor: Kevin Benton <email address hidden>\nDate:   Wed Jul 12 01:09:22 2017 -0700\n\n    Add interface to add a constraint to context\n    \n    This adds methods to the Context to add, remove, and get a\n    constraint on an object to be checked before a change is\n    made to that object.\n    \n    Related-Bug: #1493714\n    Change-Id: Id01c4dfb740f680e96349dc08b11b5bca6c59a74\n", 
            "date_created": "2017-07-14 23:12:54.171726+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/482840\nCommitted: https://git.openstack.org/cgit/openstack/neutron/commit/?id=9662e2b170a60c489f072410f976e3365e20f897\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9662e2b170a60c489f072410f976e3365e20f897\nAuthor: Kevin Benton <email address hidden>\nDate:   Wed Jul 12 01:08:48 2017 -0700\n\n    Use context interface for constraint\n    \n    Use the new constraint interface on the context rather than\n    setting an ugly attribute.\n    \n    Depends-On: I6bc2539a1ddbf7990164abeb8bb951ddcb45c993\n    \n    Related-Bug: #1493714\n    Change-Id: I9142ca96a40092b2a4c94920c4ded9bbc3a0b35b\n", 
            "date_created": "2017-07-20 01:12:40.604493+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Sean Dague (<email address hidden>) on branch: master\nReview: https://review.openstack.org/221803\nReason: This review is > 4 weeks without comment, and is not mergable in it's current state. We are abandoning this for now. Feel free to reactivate the review by pressing the restore button and leaving a 'recheck' comment to get fresh test results.", 
            "date_created": "2017-08-01 10:04:28.420218+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}