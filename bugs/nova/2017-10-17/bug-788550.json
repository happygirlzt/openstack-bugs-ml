{
    "status": "Fix Released", 
    "last_updated": "2011-09-22 13:36:24.297233+00:00", 
    "description": "I use Nova rev1113 with VMware hypervisor.\nI try to use pause/unpause command with OpenStack API, but VMware hypervisor doesn't support it, so it sends an APIError exception : \n\n2011-05-26 12:03:49,137 INFO nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] check_instance_lock: decorating: |<function pause_instance at 0x26da050>|\n2011-05-26 12:03:49,138 INFO nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x25ced50>| |<nova.context.RequestContext object at 0xbf71090>| |29|\n2011-05-26 12:03:49,202 INFO nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] check_instance_lock: locked: |False|\n2011-05-26 12:03:49,202 INFO nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] check_instance_lock: admin: |True|\n2011-05-26 12:03:49,202 INFO nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] check_instance_lock: executing: |<function pause_instance at 0x26da050>|\n2011-05-26 12:03:49,261 AUDIT nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] instance 29: pausing\n2011-05-26 12:03:49,809 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 87, in _wrap\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 105, in decorated_function\n(nova.exception): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 669, in pause_instance\n(nova.exception): TRACE:     lambda result: self._update_state_callback(self,\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/vmwareapi_conn.py\", line 145, in pause\n(nova.exception): TRACE:     self._vmops.pause(instance, callback)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/vmwareapi/vmops.py\", line 593, in pause\n(nova.exception): TRACE:     raise exception.APIError(\"pause not supported for vmwareapi\")\n(nova.exception): TRACE: AttributeError: 'module' object has no attribute 'APIError'\n(nova.exception): TRACE: \n2011-05-26 12:03:49,810 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/rpc.py\", line 198, in _receive\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 93, in _wrap\n(nova): TRACE:     raise Error(str(e))\n(nova): TRACE: Error: 'module' object has no attribute 'APIError'\n(nova): TRACE: \n\nThe instance still running (ping or ssh OK) but the instance status is pausing/BUILD for Nova:\n\n$ nova list                                                                                                                               \n+----+-----------+--------+-----------+------------+\n| ID |    Name   | Status | Public IP | Private IP |\n+----+-----------+--------+-----------+------------+\n| 29 | Server 29 | BUILD  |           | 172.16.1.4 |\n+----+-----------+--------+-----------+------------+\n\n$ euca-describe-instances \nRESERVATION     r-srnudn54      simple  default\nINSTANCE        i-0000001d      ami-00000001    172.16.1.4      172.16.1.4      pausing key (simple, p-novavmware)      0               m1.small        2011-05-26T08:59:16Z nova\n\n\nIn the same tenant, if an instance is running and if we try to resume it, nova-compute raise a InstanceResumeFailure exception :\n\n2011-05-26 12:17:17,837 INFO nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] check_instance_lock: decorating: |<function resume_instance at 0x26da578>|\n2011-05-26 12:17:17,838 INFO nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x25ced50>| |<nova.context.RequestContext object at 0x141fa990>| |29|\n2011-05-26 12:17:17,901 INFO nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] check_instance_lock: locked: |False|\n2011-05-26 12:17:17,901 INFO nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] check_instance_lock: admin: |True|\n2011-05-26 12:17:17,902 INFO nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] check_instance_lock: executing: |<function resume_instance at 0x26da578>|\n2011-05-26 12:17:17,962 AUDIT nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] instance 29: resuming\n2011-05-26 12:17:18,361 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 87, in _wrap\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 105, in decorated_function\n(nova.exception): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 728, in resume_instance\n(nova.exception): TRACE:     lambda result: self._update_state_callback(self,\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/vmwareapi_conn.py\", line 157, in resume\n(nova.exception): TRACE:     self._vmops.resume(instance, callback)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/vmwareapi/vmops.py\", line 641, in resume\n(nova.exception): TRACE:     raise exception.InstanceResumeFailure(reason=reason)\n(nova.exception): TRACE: InstanceResumeFailure: Failed to resume server: instance is not in a suspended state.\n(nova.exception): TRACE: \n2011-05-26 12:17:18,362 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/rpc.py\", line 198, in _receive\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 93, in _wrap\n(nova): TRACE:     raise Error(str(e))\n(nova): TRACE: Error: Failed to resume server: instance is not in a suspended state.\n\nThe instance still running (ping or ssh OK) but it is in state resuming/BUILD for Nova.", 
    "tags": [
        "low-hanging-fruit"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/788550", 
    "owner": "https://api.launchpad.net/1.0/~vivekys", 
    "id": 788550, 
    "index": 2414, 
    "openned": "2011-05-26 10:21:44.136956+00:00", 
    "created": "2011-05-26 10:21:44.136956+00:00", 
    "title": "Fix the APIError typo", 
    "comments": [
        {
            "content": "I use Nova rev1113 with VMware hypervisor.\nI try to use pause/unpause command with OpenStack API, but VMware hypervisor doesn't support it, so it sends an APIError exception : \n\n2011-05-26 12:03:49,137 INFO nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] check_instance_lock: decorating: |<function pause_instance at 0x26da050>|\n2011-05-26 12:03:49,138 INFO nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x25ced50>| |<nova.context.RequestContext object at 0xbf71090>| |29|\n2011-05-26 12:03:49,202 INFO nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] check_instance_lock: locked: |False|\n2011-05-26 12:03:49,202 INFO nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] check_instance_lock: admin: |True|\n2011-05-26 12:03:49,202 INFO nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] check_instance_lock: executing: |<function pause_instance at 0x26da050>|\n2011-05-26 12:03:49,261 AUDIT nova.compute.manager [TH1YE1-Y5KER904YBL1Y user1 simple] instance 29: pausing\n2011-05-26 12:03:49,809 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 87, in _wrap\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 105, in decorated_function\n(nova.exception): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 669, in pause_instance\n(nova.exception): TRACE:     lambda result: self._update_state_callback(self,\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/vmwareapi_conn.py\", line 145, in pause\n(nova.exception): TRACE:     self._vmops.pause(instance, callback)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/vmwareapi/vmops.py\", line 593, in pause\n(nova.exception): TRACE:     raise exception.APIError(\"pause not supported for vmwareapi\")\n(nova.exception): TRACE: AttributeError: 'module' object has no attribute 'APIError'\n(nova.exception): TRACE: \n2011-05-26 12:03:49,810 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/rpc.py\", line 198, in _receive\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 93, in _wrap\n(nova): TRACE:     raise Error(str(e))\n(nova): TRACE: Error: 'module' object has no attribute 'APIError'\n(nova): TRACE: \n\nThe instance still running (ping or ssh OK) but the instance status is pausing/BUILD for Nova:\n\n$ nova list                                                                                                                               \n+----+-----------+--------+-----------+------------+\n| ID |    Name   | Status | Public IP | Private IP |\n+----+-----------+--------+-----------+------------+\n| 29 | Server 29 | BUILD  |           | 172.16.1.4 |\n+----+-----------+--------+-----------+------------+\n\n$ euca-describe-instances \nRESERVATION     r-srnudn54      simple  default\nINSTANCE        i-0000001d      ami-00000001    172.16.1.4      172.16.1.4      pausing key (simple, p-novavmware)      0               m1.small        2011-05-26T08:59:16Z nova\n\n\nIn the same tenant, if an instance is running and if we try to resume it, nova-compute raise a InstanceResumeFailure exception :\n\n2011-05-26 12:17:17,837 INFO nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] check_instance_lock: decorating: |<function resume_instance at 0x26da578>|\n2011-05-26 12:17:17,838 INFO nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x25ced50>| |<nova.context.RequestContext object at 0x141fa990>| |29|\n2011-05-26 12:17:17,901 INFO nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] check_instance_lock: locked: |False|\n2011-05-26 12:17:17,901 INFO nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] check_instance_lock: admin: |True|\n2011-05-26 12:17:17,902 INFO nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] check_instance_lock: executing: |<function resume_instance at 0x26da578>|\n2011-05-26 12:17:17,962 AUDIT nova.compute.manager [2WRZ55G6B8H60I3C33QL user1 simple] instance 29: resuming\n2011-05-26 12:17:18,361 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 87, in _wrap\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 105, in decorated_function\n(nova.exception): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 728, in resume_instance\n(nova.exception): TRACE:     lambda result: self._update_state_callback(self,\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/vmwareapi_conn.py\", line 157, in resume\n(nova.exception): TRACE:     self._vmops.resume(instance, callback)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/vmwareapi/vmops.py\", line 641, in resume\n(nova.exception): TRACE:     raise exception.InstanceResumeFailure(reason=reason)\n(nova.exception): TRACE: InstanceResumeFailure: Failed to resume server: instance is not in a suspended state.\n(nova.exception): TRACE: \n2011-05-26 12:17:18,362 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/rpc.py\", line 198, in _receive\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 93, in _wrap\n(nova): TRACE:     raise Error(str(e))\n(nova): TRACE: Error: Failed to resume server: instance is not in a suspended state.\n\nThe instance still running (ping or ssh OK) but it is in state resuming/BUILD for Nova.", 
            "date_created": "2011-05-26 10:21:44.136956+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "The first exception referring to the APIError is actually just a typo. It should be \"ApiError\". Even when that is fixed, it appears we still dont support 'pause' on that hypervisor. \n\nAs for the second issue, an instance must have the status 'suspended' to be able to resume it.", 
            "date_created": "2011-05-26 12:34:19.440464+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "So I probably just reiterated things you already knew in my last comment :) The real bug here is that the instance statuses shouldn't be changing if nothing is happening, correct?", 
            "date_created": "2011-05-26 12:43:58.287222+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "yes, it's what I tried to explain but my poor English limits me :)\n\nI had just tested it with VMware hypervisor but perhaps, the problem is the same for the others.", 
            "date_created": "2011-05-26 13:33:09.704673+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "I try with libvirt/KVM hypervisor.\nI tested a unrescue a running instance, compute log said :\n\n2011-05-26 15:42:48,568 AUDIT nova.compute.manager [UJ9SK-JSU4BZ-FZFC5DY user1 simple] instance 30: unrescuing\n2011-05-26 15:42:48,628 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 87, in _wrap\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE: TypeError: unrescue() takes exactly 2 arguments (3 given)\n(nova.exception): TRACE: \n2011-05-26 15:42:48,628 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/rpc.py\", line 198, in _receive\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 87, in _wrap\n(nova): TRACE:     return f(*args, **kw)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 105, in decorated_function\n(nova): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 502, in unrescue_instance\n(nova): TRACE:     self.driver.unrescue(instance_ref, _update_state)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 93, in _wrap\n(nova): TRACE:     raise Error(str(e))\n(nova): TRACE: Error: unrescue() takes exactly 2 arguments (3 given)\n(nova): TRACE: \n\nThe instance passed to status 'unrescue' for few seconds and after logs :\n\n2011-05-26 15:43:24,014 INFO nova.compute.manager [-] Updating host status\n2011-05-26 15:43:24,047 INFO nova.compute.manager [-] DB/VM state mismatch. Changing state from '0' to '1'\n\nthe instance came back to status 'running'.\n\nI think there is typo error for the first exception, like you said. But nothing synchronize the db and instance status with the VMware hypervisor.", 
            "date_created": "2011-05-26 13:51:20.403601+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "So it seems that the pause/unpause and suspend/resume functionality is not implemented in our libvirt driver either, it isn't just the vmware driver. The bigger problem here is that the compute manager isn't handling error cases when its driver fails to complete an action (such as pause, unpause, etc). \n\nThis bug might be more useful as \"Fix the APIError typo\" and maybe file another bug to address \"Poor driver exception handling in compute manager\" with your examples from above.", 
            "date_created": "2011-05-26 13:55:48.157553+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "No, it's correctly handling by libvirt driver but not by VMware driver.\n\nDo you want I create a new bug ?\nCan I change the title of this bug ?", 
            "date_created": "2011-05-26 14:29:42.591050+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "I think that'll work. Nobody else seems to have anything to say, so I am going to assume that is the right way to handle it.", 
            "date_created": "2011-05-26 16:10:42.560771+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "@Edouard:\nI will rename this bug to \"Fix the APIError typo\" and triage it.\nCould you file a separate bug for \"Poor driver exception handling in compute manager\" with your examples from above ?\nThanks !", 
            "date_created": "2011-05-30 10:07:47.153527+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Ok, I opened this : https://bugs.launchpad.net/nova/+bug/790174", 
            "date_created": "2011-05-30 11:49:02.393417+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }
    ], 
    "closed": "2011-09-22 13:36:22.945041+00:00"
}