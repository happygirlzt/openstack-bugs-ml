{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 08:49:53.728615+00:00", 
    "description": "Hopefully this is not covered under a different bug.  What I'm seeing is that compute does not properly handle metadata in the \"aggregate\" class of API commands.  Specifically, after adding metadata and performing an add-host you get the following stacktrace exception:\n2013-09-27 17:48:44.396 DEBUG nova.openstack.common.rpc.amqp [-] received {u'_context_roles': [u'admin'], u'_context_request_id': u'req-643da000-e5ae-482c-ba01-027ee61f5085', u'_context_quota_class': None, u'_context_user_name': u'admin', u'_context_project_name': u'admin', u'_context_service_catalog': [{u'endpoints_links': [], u'endpoints': [{u'adminURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537', u'region': u'RegionOne', u'publicURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537', u'internalURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537', u'id': u'1733df26b558409ca93bb1ffe8851929'}], u'type': u'volume', u'name': u'cinder'}], u'_context_tenant': u'0fa0013cceb4430ba09e88a18d344537', u'_context_auth_token': '<SANITIZED>', u'args': {u'aggregate': {u'name': u'foo', u'availability_zone': u'nova', u'deleted': False, u'created_at': u'2013-09-27T17:47:24.000000', u'updated_at': None, u'hosts': [u'devstack2'], u'deleted_at': None, u'id': 2, u'metadata': {u'hypervisor': u'true', u'availability_zone': u'nova'}}, u'host': u'devstack2', u'slave_info': None}, u'namespace': None, u'_context_instance_lock_checked': False, u'_context_timestamp': u'2013-09-27T17:48:44.352804', u'_context_is_admin': True, u'version': u'2.14', u'_context_project_id': u'0fa0013cceb4430ba09e88a18d344537', u'_context_user': u'bd2e35f5cdfa4272b7f03d601c95a61d', u'_unique_id': u'13c5f2d81c484bbebdd8214574060ab3', u'_context_read_deleted': u'no', u'_context_user_id': u'bd2e35f5cdfa4272b7f03d601c95a61d', u'method': u'add_aggregate_host', u'_context_remote_address': u'172.24.4.10'} from (pid=10210) _safe_log /opt/stack/nova/nova/openstack/common/rpc/common.py:277\n013-09-27 17:48:44.397 DEBUG nova.openstack.common.rpc.amqp [-] unpacked context: {'read_deleted': u'no', 'project_name': u'admin', 'user_id': u'bd2e35f5cdfa4272b7f03d601c95a61d', 'roles': [u'admin'], 'timestamp': u'2013-09-27T17:48:44.352804', 'auth_token': '<SANITIZED>', 'remote_address': u'172.24.4.10', 'quota_class': None, 'is_admin': True, 'user': u'bd2e35f5cdfa4272b7f03d601c95a61d', 'service_catalog': [{u'endpoints': [{u'adminURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537', u'region': u'RegionOne', u'id': u'1733df26b558409ca93bb1ffe8851929', u'internalURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537', u'publicURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537'}], u'endpoints_links': [], u'type': u'volume', u'name': u'cinder'}], 'request_id': u'req-643da000-e5ae-482c-ba01-027ee61f5085', 'instance_lock_checked': False, 'project_id': u'0fa0013cceb4430ba09e88a18d344537', 'user_name': u'admin', 'tenant': u'0fa0013cceb4430ba09e88a18d344537'} from (pid=10210) _safe_log /opt/stack/nova/nova/openstack/common/rpc/common.py:277\n2013-09-27 17:48:44.400 ERROR nova.openstack.common.rpc.amqp [req-643da000-e5ae-482c-ba01-027ee61f5085 admin admin] Exception during message handling\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 90, in wrapped\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 73, in wrapped\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 4993, in add_aggregate_host\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     slave_info=slave_info)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 628, in add_to_aggregate\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     return self._pool.add_to_aggregate(context, aggregate, host, **kwargs)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/pool.py\", line 77, in add_to_aggregate\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     if not pool_states.is_hv_pool(aggregate['metadetails']):\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp KeyError: 'metadetails'\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp \n\n\nBased on evidence it looks like caller passing information with key metadata (change back in August?) while we are looking for it in the Xen code as metadetails.  The key name needs to change to correspond.\n\nThis was produced on a devstack with a commit of ab5a99bbca4d68002c887b5dd7b3741b57f650ee for nova.", 
    "tags": [
        "compute", 
        "havana-backport-potential", 
        "xenserver"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1232179", 
    "owner": "https://api.launchpad.net/1.0/~bob-ball", 
    "id": 1232179, 
    "index": 3625, 
    "openned": "2013-09-27 18:12:04.040378+00:00", 
    "created": "2013-09-27 18:12:04.040378+00:00", 
    "title": "Aggregate metadata is not correctly handled by compute", 
    "comments": [
        {
            "content": "Hopefully this is not covered under a different bug.  What I'm seeing is that compute does not properly handle metadata in the \"aggregate\" class of API commands.  Specifically, after adding metadata and performing an add-host you get the following stacktrace exception:\n2013-09-27 17:48:44.396 DEBUG nova.openstack.common.rpc.amqp [-] received {u'_context_roles': [u'admin'], u'_context_request_id': u'req-643da000-e5ae-482c-ba01-027ee61f5085', u'_context_quota_class': None, u'_context_user_name': u'admin', u'_context_project_name': u'admin', u'_context_service_catalog': [{u'endpoints_links': [], u'endpoints': [{u'adminURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537', u'region': u'RegionOne', u'publicURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537', u'internalURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537', u'id': u'1733df26b558409ca93bb1ffe8851929'}], u'type': u'volume', u'name': u'cinder'}], u'_context_tenant': u'0fa0013cceb4430ba09e88a18d344537', u'_context_auth_token': '<SANITIZED>', u'args': {u'aggregate': {u'name': u'foo', u'availability_zone': u'nova', u'deleted': False, u'created_at': u'2013-09-27T17:47:24.000000', u'updated_at': None, u'hosts': [u'devstack2'], u'deleted_at': None, u'id': 2, u'metadata': {u'hypervisor': u'true', u'availability_zone': u'nova'}}, u'host': u'devstack2', u'slave_info': None}, u'namespace': None, u'_context_instance_lock_checked': False, u'_context_timestamp': u'2013-09-27T17:48:44.352804', u'_context_is_admin': True, u'version': u'2.14', u'_context_project_id': u'0fa0013cceb4430ba09e88a18d344537', u'_context_user': u'bd2e35f5cdfa4272b7f03d601c95a61d', u'_unique_id': u'13c5f2d81c484bbebdd8214574060ab3', u'_context_read_deleted': u'no', u'_context_user_id': u'bd2e35f5cdfa4272b7f03d601c95a61d', u'method': u'add_aggregate_host', u'_context_remote_address': u'172.24.4.10'} from (pid=10210) _safe_log /opt/stack/nova/nova/openstack/common/rpc/common.py:277\n013-09-27 17:48:44.397 DEBUG nova.openstack.common.rpc.amqp [-] unpacked context: {'read_deleted': u'no', 'project_name': u'admin', 'user_id': u'bd2e35f5cdfa4272b7f03d601c95a61d', 'roles': [u'admin'], 'timestamp': u'2013-09-27T17:48:44.352804', 'auth_token': '<SANITIZED>', 'remote_address': u'172.24.4.10', 'quota_class': None, 'is_admin': True, 'user': u'bd2e35f5cdfa4272b7f03d601c95a61d', 'service_catalog': [{u'endpoints': [{u'adminURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537', u'region': u'RegionOne', u'id': u'1733df26b558409ca93bb1ffe8851929', u'internalURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537', u'publicURL': u'http://172.24.4.10:8776/v1/0fa0013cceb4430ba09e88a18d344537'}], u'endpoints_links': [], u'type': u'volume', u'name': u'cinder'}], 'request_id': u'req-643da000-e5ae-482c-ba01-027ee61f5085', 'instance_lock_checked': False, 'project_id': u'0fa0013cceb4430ba09e88a18d344537', 'user_name': u'admin', 'tenant': u'0fa0013cceb4430ba09e88a18d344537'} from (pid=10210) _safe_log /opt/stack/nova/nova/openstack/common/rpc/common.py:277\n2013-09-27 17:48:44.400 ERROR nova.openstack.common.rpc.amqp [req-643da000-e5ae-482c-ba01-027ee61f5085 admin admin] Exception during message handling\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 90, in wrapped\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 73, in wrapped\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 4993, in add_aggregate_host\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     slave_info=slave_info)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 628, in add_to_aggregate\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     return self._pool.add_to_aggregate(context, aggregate, host, **kwargs)\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/pool.py\", line 77, in add_to_aggregate\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp     if not pool_states.is_hv_pool(aggregate['metadetails']):\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp KeyError: 'metadetails'\n2013-09-27 17:48:44.400 TRACE nova.openstack.common.rpc.amqp \n\n\nBased on evidence it looks like caller passing information with key metadata (change back in August?) while we are looking for it in the Xen code as metadetails.  The key name needs to change to correspond.\n\nThis was produced on a devstack with a commit of ab5a99bbca4d68002c887b5dd7b3741b57f650ee for nova.", 
            "date_created": "2013-09-27 18:12:04.040378+00:00", 
            "author": "https://api.launchpad.net/1.0/~christopher-lefelhoc"
        }, 
        {
            "content": "I assume you are using xenapi?  Adding xenapi tag", 
            "date_created": "2013-10-01 16:45:04.307183+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Yeah, the impact here is that XenAPI pool is broken (again) in havana.\n\nI am proposing we pull this in Icehouse (or look to deprecate it, at least).\nNo one is stepping up to maintain and test this, it seems.", 
            "date_created": "2013-10-01 16:59:49.996391+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "Add this to the IceHouse discussions - I agree that we either need to test it or deprecate it, but we need a discussion about which we do.", 
            "date_created": "2013-10-02 08:45:31.631645+00:00", 
            "author": "https://api.launchpad.net/1.0/~bob-ball"
        }, 
        {
            "content": "Very interestingly I get this same stack trace from the latest Havana on a host that has not been joined to any aggregate - and I only see it on first run.\n\nIs the above error fatal, or do things continue to work?\nMy devstack VM continues to work as a single host even without this:\n\n2013-10-02 03:09:23.950 \u001b[01;31mERROR nova.openstack.common.rpc.amqp [\u001b[01;36mreq-23bdcc58-49c5-4dbd-918c-b97dd1ab16aa \u001b[00;36madmin admin\u001b[01;31m] \u001b[01;35m\u001b[01;31mException during message handling\u001b[00m\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00mTraceback (most recent call last):\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m  File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m    **args)\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m  File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m    result = getattr(proxyobj, method)(ctxt, **kwargs)\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m  File \"/opt/stack/nova/nova/exception.py\", line 90, in wrapped\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m    payload)\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m  File \"/opt/stack/nova/nova/exception.py\", line 73, in wrapped\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m    return f(self, context, *args, **kw)\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 5002, in add_aggregate_host\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m    slave_info=slave_info)\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m  File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 627, in add_to_aggregate\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m    return self._pool.add_to_aggregate(context, aggregate, host, **kwargs)\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m  File \"/opt/stack/nova/nova/virt/xenapi/pool.py\", line 77, in add_to_aggregate\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00m    if not pool_states.is_hv_pool(aggregate['metadetails']):\n\u001b[01;31m2013-10-02 03:09:23.950 TRACE nova.openstack.common.rpc.amqp \u001b[01;35m\u001b[00mKeyError: 'metadetails'\n", 
            "date_created": "2013-10-02 11:15:18.675988+00:00", 
            "author": "https://api.launchpad.net/1.0/~bob-ball"
        }, 
        {
            "content": "Broken by https://review.openstack.org/#/c/43157/ which added the translation from metadetails to metadata for the aggregate instance object.", 
            "date_created": "2013-10-02 16:06:55.902611+00:00", 
            "author": "https://api.launchpad.net/1.0/~bob-ball"
        }, 
        {
            "content": "We'll (Christopher to Add, John to discuss at summit) add a proposal blueprint for discussion in the next few days.", 
            "date_created": "2013-10-02 19:21:30.358294+00:00", 
            "author": "https://api.launchpad.net/1.0/~christopher-lefelhoc"
        }, 
        {
            "content": "Fixed by https://review.openstack.org/#/c/49400/ - not sure why the automatic link wasn't added", 
            "date_created": "2013-10-03 10:14:31.284538+00:00", 
            "author": "https://api.launchpad.net/1.0/~bob-ball"
        }, 
        {
            "content": "A better fix is at https://review.openstack.org/#/c/50466 - although the original (https://review.openstack.org/#/c/49400/) may be a simpler backport.", 
            "date_created": "2013-10-14 14:38:35.706437+00:00", 
            "author": "https://api.launchpad.net/1.0/~bob-ball"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/50466\nCommitted: http://github.com/openstack/nova/commit/f2f58eef93aec45e46a9a2ab06fc8b00a9420350\nSubmitter: Jenkins\nBranch:    master\n\ncommit f2f58eef93aec45e46a9a2ab06fc8b00a9420350\nAuthor: Dan Smith <email address hidden>\nDate:   Tue Oct 8 12:54:27 2013 -0700\n\n    Make XenAPI use Aggregate object\n    \n    This makes the XenAPI driver use the Aggregate object for its work,\n    and avoids the need to call back through virtapi to conductor\n    directly. It also allows us to convert the two aggregate-related\n    compute manager methods fully to new-world objects.\n    \n    Related to blueprint compute-manager-objects\n    Related to blueprint virt-objects\n    \n    Closes-bug: #1232179\n    Change-Id: Ib38ab0e4d6feefebda37888f150752167474b693\n", 
            "date_created": "2013-10-16 00:19:24.687601+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-12-04 10:08:15.268667+00:00"
}