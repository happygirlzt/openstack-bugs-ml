{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:39:54.393352+00:00", 
    "description": "In tempest test  test_allocate_floating_ip_from_nonexistent_pool an attempt is made to allocate a floating ip from a non existant pool. Nova correctly returns a 404, but leaves a stacktrace in the log files\n\n2013-04-17 11:25:54    DEBUG [routes.middleware] Matched POST /418618d2fea641f69e6966afafe33e0c/os-floating-ips\n2013-04-17 11:25:54    DEBUG [routes.middleware] Route path: '/{project_id}/os-floating-ips', defaults: {'action': u'crea\nte', 'controller': <nova.api.openstack.wsgi.Resource object at 0x31eaf10>}\n2013-04-17 11:25:54    DEBUG [routes.middleware] Match dict: {'action': u'create', 'controller': <nova.api.openstack.wsgi\n.Resource object at 0x31eaf10>, 'project_id': u'418618d2fea641f69e6966afafe33e0c'}\n2013-04-17 11:25:54    DEBUG [nova.api.openstack.wsgi] Action: 'create', body: <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<pool >non_exist_pool</pool>\n2013-04-17 11:25:54    DEBUG [nova.api.openstack.wsgi] Calling method <bound method FloatingIPController.create of <nova.\napi.openstack.compute.contrib.floating_ips.FloatingIPController object at 0x2f7bad0>>\n2013-04-17 11:25:54    DEBUG [nova.quota] Created reservations ['a2d9fde5-fd43-42be-9c8d-abd4c15d311e']\n2013-04-17 11:25:54    DEBUG [nova.quota] Rolled back reservations ['a2d9fde5-fd43-42be-9c8d-abd4c15d311e']\n2013-04-17 11:25:54    ERROR [nova.api.openstack] Caught error: Zero floating ips available.\nTraceback (most recent call last):\n  File \"/srv/compile/openstack/nova/nova/api/openstack/__init__.py\", line 81, in __call__\n    return req.get_response(self.application)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n    application, catch_exc_info=False)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n    app_iter = application(self.environ, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/opt/stack/python-keystoneclient/keystoneclient/middleware/auth_token.py\", line 451, in __call__\n    return self.app(env, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n    response = self.app(environ, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n   resp = self.call_func(req, *args, **self.kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n    return self.func(req, *args, **kwargs)\n  File \"/srv/compile/openstack/nova/nova/api/openstack/wsgi.py\", line 899, in __call__\n    content_type, body, accept)\n  File \"/srv/compile/openstack/nova/nova/api/openstack/wsgi.py\", line 951, in _process_stack\n    action_result = self.dispatch(meth, request, action_args)\n  File \"/srv/compile/openstack/nova/nova/api/openstack/wsgi.py\", line 1030, in dispatch\n    return method(req=request, **action_args)\n  File \"/srv/compile/openstack/nova/nova/api/openstack/compute/contrib/floating_ips.py\", line 161, in create\n    address = self.network_api.allocate_floating_ip(context, pool)\n  File \"/srv/compile/openstack/nova/nova/network/api.py\", line 90, in wrapped\n    return func(self, context, *args, **kwargs)\n  File \"/srv/compile/openstack/nova/nova/network/api.py\", line 212, in allocate_floating_ip\n    context.project_id, False, pool)\n  File \"/srv/compile/openstack/nova/nova/utils.py\", line 1349, in wrapper\n    return func(*args, **kwargs)\n  File \"/srv/compile/openstack/nova/nova/network/floating_ips.py\", line 240, in allocate_floating_ip\n    QUOTAS.rollback(context, reservations)\n  File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n    self.gen.next()\n  File \"/srv/compile/openstack/nova/nova/network/floating_ips.py\", line 227, in allocate_floating_ip\n    pool)\n  File \"/srv/compile/openstack/nova/nova/db/api.py\", line 257, in floating_ip_allocate_address\n    return IMPL.floating_ip_allocate_address(context, project_id, pool)\n  File \"/srv/compile/openstack/nova/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n    return f(*args, **kwargs)\n  File \"/srv/compile/openstack/nova/nova/db/sqlalchemy/api.py\", line 679, in floating_ip_allocate_address\n    raise exception.NoMoreFloatingIps()\nNoMoreFloatingIps: Zero floating ips available.\n2013-04-17 11:25:54     INFO [nova.api.openstack] http://192.168.1.18:8774/v2/418618d2fea641f69e6966afafe33e0c/os-floating-ips returned with HTTP 404\n2013-04-17 11:25:54    DEBUG [nova.api.openstack.wsgi] Returning 404 to user: NoMoreFloatingIps: Zero floating ips availa\ng-ips returned with HTTP 404\n2013-04-17 11:25:54    DEBUG [nova.api.openstack.wsgi] Returning 404 to user: NoMoreFloatingIps: Zero floating ips available. \n2013-04-17 11:25:54     INFO [nova.osapi_compute.wsgi.server] 192.168.1.18 \"POST /v2/418618d2fea641f69e6966afafe33e0c/os-floating-ips HTTP/1.1\" status: 404 len: 351 time: 0.0572748\n\nWe should catch the exception and raise an HTTPNotFound instead so we don't leave a confusing stack trace when in an expected code path", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1169811", 
    "owner": "https://api.launchpad.net/1.0/~cyeoh-0", 
    "id": 1169811, 
    "index": 4856, 
    "openned": "2013-04-17 03:31:31.856599+00:00", 
    "created": "2013-04-17 03:31:31.856599+00:00", 
    "title": "Translate NoMoreFloatingIps exception in floating ip create API ", 
    "comments": [
        {
            "content": "In tempest test  test_allocate_floating_ip_from_nonexistent_pool an attempt is made to allocate a floating ip from a non existant pool. Nova correctly returns a 404, but leaves a stacktrace in the log files\n\n2013-04-17 11:25:54    DEBUG [routes.middleware] Matched POST /418618d2fea641f69e6966afafe33e0c/os-floating-ips\n2013-04-17 11:25:54    DEBUG [routes.middleware] Route path: '/{project_id}/os-floating-ips', defaults: {'action': u'crea\nte', 'controller': <nova.api.openstack.wsgi.Resource object at 0x31eaf10>}\n2013-04-17 11:25:54    DEBUG [routes.middleware] Match dict: {'action': u'create', 'controller': <nova.api.openstack.wsgi\n.Resource object at 0x31eaf10>, 'project_id': u'418618d2fea641f69e6966afafe33e0c'}\n2013-04-17 11:25:54    DEBUG [nova.api.openstack.wsgi] Action: 'create', body: <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<pool >non_exist_pool</pool>\n2013-04-17 11:25:54    DEBUG [nova.api.openstack.wsgi] Calling method <bound method FloatingIPController.create of <nova.\napi.openstack.compute.contrib.floating_ips.FloatingIPController object at 0x2f7bad0>>\n2013-04-17 11:25:54    DEBUG [nova.quota] Created reservations ['a2d9fde5-fd43-42be-9c8d-abd4c15d311e']\n2013-04-17 11:25:54    DEBUG [nova.quota] Rolled back reservations ['a2d9fde5-fd43-42be-9c8d-abd4c15d311e']\n2013-04-17 11:25:54    ERROR [nova.api.openstack] Caught error: Zero floating ips available.\nTraceback (most recent call last):\n  File \"/srv/compile/openstack/nova/nova/api/openstack/__init__.py\", line 81, in __call__\n    return req.get_response(self.application)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n    application, catch_exc_info=False)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n    app_iter = application(self.environ, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/opt/stack/python-keystoneclient/keystoneclient/middleware/auth_token.py\", line 451, in __call__\n    return self.app(env, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n    response = self.app(environ, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n    return resp(environ, start_response)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n   resp = self.call_func(req, *args, **self.kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n    return self.func(req, *args, **kwargs)\n  File \"/srv/compile/openstack/nova/nova/api/openstack/wsgi.py\", line 899, in __call__\n    content_type, body, accept)\n  File \"/srv/compile/openstack/nova/nova/api/openstack/wsgi.py\", line 951, in _process_stack\n    action_result = self.dispatch(meth, request, action_args)\n  File \"/srv/compile/openstack/nova/nova/api/openstack/wsgi.py\", line 1030, in dispatch\n    return method(req=request, **action_args)\n  File \"/srv/compile/openstack/nova/nova/api/openstack/compute/contrib/floating_ips.py\", line 161, in create\n    address = self.network_api.allocate_floating_ip(context, pool)\n  File \"/srv/compile/openstack/nova/nova/network/api.py\", line 90, in wrapped\n    return func(self, context, *args, **kwargs)\n  File \"/srv/compile/openstack/nova/nova/network/api.py\", line 212, in allocate_floating_ip\n    context.project_id, False, pool)\n  File \"/srv/compile/openstack/nova/nova/utils.py\", line 1349, in wrapper\n    return func(*args, **kwargs)\n  File \"/srv/compile/openstack/nova/nova/network/floating_ips.py\", line 240, in allocate_floating_ip\n    QUOTAS.rollback(context, reservations)\n  File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n    self.gen.next()\n  File \"/srv/compile/openstack/nova/nova/network/floating_ips.py\", line 227, in allocate_floating_ip\n    pool)\n  File \"/srv/compile/openstack/nova/nova/db/api.py\", line 257, in floating_ip_allocate_address\n    return IMPL.floating_ip_allocate_address(context, project_id, pool)\n  File \"/srv/compile/openstack/nova/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n    return f(*args, **kwargs)\n  File \"/srv/compile/openstack/nova/nova/db/sqlalchemy/api.py\", line 679, in floating_ip_allocate_address\n    raise exception.NoMoreFloatingIps()\nNoMoreFloatingIps: Zero floating ips available.\n2013-04-17 11:25:54     INFO [nova.api.openstack] http://192.168.1.18:8774/v2/418618d2fea641f69e6966afafe33e0c/os-floating-ips returned with HTTP 404\n2013-04-17 11:25:54    DEBUG [nova.api.openstack.wsgi] Returning 404 to user: NoMoreFloatingIps: Zero floating ips availa\ng-ips returned with HTTP 404\n2013-04-17 11:25:54    DEBUG [nova.api.openstack.wsgi] Returning 404 to user: NoMoreFloatingIps: Zero floating ips available. \n2013-04-17 11:25:54     INFO [nova.osapi_compute.wsgi.server] 192.168.1.18 \"POST /v2/418618d2fea641f69e6966afafe33e0c/os-floating-ips HTTP/1.1\" status: 404 len: 351 time: 0.0572748\n\nWe should catch the exception and raise an HTTPNotFound instead so we don't leave a confusing stack trace when in an expected code path", 
            "date_created": "2013-04-17 03:31:31.856599+00:00", 
            "author": "https://api.launchpad.net/1.0/~cyeoh-0"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/27036", 
            "date_created": "2013-04-17 03:38:46.521916+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/27036\nCommitted: http://github.com/openstack/nova/commit/f9be01a42a513d7d579cc2424a439ae800ec6df6\nSubmitter: Jenkins\nBranch:    master\n\ncommit f9be01a42a513d7d579cc2424a439ae800ec6df6\nAuthor: Chris Yeoh <email address hidden>\nDate:   Wed Apr 17 13:02:02 2013 +0930\n\n    Translate NoMoreFloatingIps exception\n    \n    When the pool of floating ips is exhausted the NoMoreFloatingIps exception\n    is raised but not handled properly in the floating ips extension resulting\n    in the exception propagating further up and causing a stack trace to be logged.\n    \n    This change translates the exception explicitly into a HTTPNotFound, preserving the current\n    REST API behaviour. It fixes a bug where the pool name was not correctly inserted into\n    the message returned if allocation from a specific pool was requested.\n    \n    Fixes bug 1169811\n    \n    Part of blueprint no-stacktraces-in-logs\n    \n    Change-Id: I8f35d25d065bb1fa709cff6f59841ac8c86658bd\n", 
            "date_created": "2013-04-25 11:39:53.579511+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-05-29 10:21:12.274352+00:00"
}