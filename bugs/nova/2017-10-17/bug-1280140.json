{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:08:21.143099+00:00", 
    "description": "this is because the db  query is not including the deleted instance while\n_delete_instance_files() in libvirt driver.\n\nI can reproduce this bug both in master and stable havana.\nreproduce steps:\n1. create an instance\n2. stop nova-compute\n3. wait for nova-manage serivce list display xxx of nova-compute\n4. modify the running_deleted_instance_poll_interval=60\nrunning_deleted_instance_action = reap,\nand start nova-compute and wait for this clean up peroidic task\n5. a warnning will be given in the compute log:\n2014-02-14 16:22:25.917 WARNING nova.compute.manager [-] [instance: c32db267-21a0-41e7-9d50-931d8396d8cb] Periodic cleanup failed to delete instance: Instance c32db267-21a0-41e7-9d50-931d8396d8cb could not be found.\n\nthe debug trace is:\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1006)cleanup()\n   1005 block_device_mapping = driver.block_device_info_get_mapping(\n-> 1006 block_device_info)\n   1007 for vol in block_device_mapping:\n\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1007)cleanup()\n   1006 block_device_info)\n-> 1007 for vol in block_device_mapping:\n   1008 connection_info = vol['connection_info']\n\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1041)cleanup()\n   1040 \n-> 1041 if destroy_disks:\n   1042 self._delete_instance_files(instance)\n\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1042)cleanup()\n   1041 if destroy_disks:\n-> 1042 self._delete_instance_files(instance)\n   1043 \n\nipdb> s\n--Call--\n> /opt/stack/nova/nova/virt/libvirt/driver.py(4950)_delete_instance_files()\n   4949 \n-> 4950 def _delete_instance_files(self, instance):\n   4951 # NOTE(mikal): a shim to handle this file not using instance objects\n\n\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(4953)_delete_instance_files()\n   4952 # everywhere. Remove this when that conversion happens.\n\n-> 4953 context = nova_context.get_admin_context()\n   4954 inst_obj = instance_obj.Instance.get_by_uuid(context, instance['uuid'])\n\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(4954)_delete_instance_files()\n   4953 context = nova_context.get_admin_context()\n-> 4954 inst_obj = instance_obj.Instance.get_by_uuid(context, instance['uuid'])\n   4955 \n\nipdb> n\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/virt/libvirt/driver.py(4954)_delete_instance_files()\n   4953 context = nova_context.get_admin_context()\n-> 4954 inst_obj = instance_obj.Instance.get_by_uuid(context, instance['uuid'])\n   4955 \n\nipdb> n\n--Return--\nNone\n> /opt/stack/nova/nova/virt/libvirt/driver.py(4954)_delete_instance_files()\n   4953 context = nova_context.get_admin_context()\n-> 4954 inst_obj = instance_obj.Instance.get_by_uuid(context, instance['uuid'])\n   4955 \n\nipdb> n\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1042)cleanup()\n   1041 if destroy_disks:\n-> 1042 self._delete_instance_files(instance)\n   1043 \n\nipdb> n\n--Return--\nNone\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1042)cleanup()\n   1041 if destroy_disks:\n-> 1042 self._delete_instance_files(instance)\n   1043 \n\nipdb> n\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/virt/libvirt/driver.py(931)destroy()\n    930 self.cleanup(context, instance, network_info, block_device_info,\n--> 931 destroy_disks)\n    932 \n\nipdb> n\n--Return--\nNone\n> /opt/stack/nova/nova/virt/libvirt/driver.py(931)destroy()\n    930 self.cleanup(context, instance, network_info, block_device_info,\n--> 931 destroy_disks)\n    932 \n\nipdb> n\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/compute/manager.py(1905)_shutdown_instance()\n   1904 self.driver.destroy(context, instance, network_info,\n-> 1905 block_device_info)\n   1906 except exception.InstancePowerOffFailure:\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(1906)_shutdown_instance()\n   1905 block_device_info)\n-> 1906 except exception.InstancePowerOffFailure:\n   1907 # if the instance can't power off, don't release the ip\n\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(1910)_shutdown_instance()\n   1909 pass\n-> 1910 except Exception:\n   1911 with excutils.save_and_reraise_exception():\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(1911)_shutdown_instance()\n   1910 except Exception:\n-> 1911 with excutils.save_and_reraise_exception():\n   1912 # deallocate ip and fail without proceeding to\n\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(1914)_shutdown_instance()\n   1913 # volume api calls, preserving current behavior\n\n-> 1914 self._try_deallocate_network(context, instance,\n   1915 requested_networks)\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(1915)_shutdown_instance()\n   1914 self._try_deallocate_network(context, instance,\n-> 1915 requested_networks)\n   1916 \n\nipdb> n\n2014-02-14 16:22:02.701 DEBUG nova.compute.manager [-] [instance: c32db267-21a0-41e7-9d50-931d8396d8cb] Deallocating network for instance from (pid=19192) _deallocate_network /opt/stack/nova/nova/compute/manager.py:1531\n2014-02-14 16:22:02.704 DEBUG oslo.messaging._drivers.amqpdriver [-] MSG_ID is e529a4edb22b480cb0641a62718e9b04 from (pid=19192) _send /opt/stack/oslo.messaging/oslo/messaging/_drivers/amqpdriver.py:358\n2014-02-14 16:22:02.705 DEBUG oslo.messaging._drivers.amqp [-] UNIQUE_ID is aed682f94730441aaa14e43a37c86227. from (pid=19192) _add_unique_id /opt/stack/oslo.messaging/oslo/messaging/_drivers/amqp.py:333\n2014-02-14 16:22:02.718 WARNING nova.openstack.common.loopingcall [-] task run outlasted interval by 11.632922 sec\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/compute/manager.py(1915)_shutdown_instance()\n   1914 self._try_deallocate_network(context, instance,\n-> 1915 requested_networks)\n   1916 \n\nipdb> n\n--Return--\nNone\n> /opt/stack/nova/nova/compute/manager.py(1915)_shutdown_instance()\n   1914 self._try_deallocate_network(context, instance,\n-> 1915 requested_networks)\n   1916 \n\nipdb> l\n   1910 except Exception:\n   1911 with excutils.save_and_reraise_exception():\n   1912 # deallocate ip and fail without proceeding to\n\n   1913 # volume api calls, preserving current behavior\n\n   1914 self._try_deallocate_network(context, instance,\n-> 1915 requested_networks)\n   1916 \n   1917 self._try_deallocate_network(context, instance, requested_networks)\n   1918 \n   1919 for bdm in vol_bdms:\n   1920 try:\n\nipdb> n\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/compute/manager.py(5225)_cleanup_running_deleted_instances()\n   5224 self._shutdown_instance(context, instance, bdms,\n-> 5225 notify=False)\n   5226 self._cleanup_volumes(context, instance['uuid'], bdms)\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(5227)_cleanup_running_deleted_instances()\n   5226 self._cleanup_volumes(context, instance['uuid'], bdms)\n-> 5227 except Exception as e:\n   5228 LOG.warning(_(\"Periodic cleanup failed to delete \"\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(5228)_cleanup_running_deleted_instances()\n   5227 except Exception as e:\n-> 5228 LOG.warning(_(\"Periodic cleanup failed to delete \"\n   5229 \"instance: %s\"),\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(5230)_cleanup_running_deleted_instances()\n   5229 \"instance: %s\"),\n-> 5230 unicode(e), instance=instance)\n   5231 else:\n\nipdb> n\n2014-02-14 16:22:25.917 WARNING nova.compute.manager [-] [instance: c32db267-21a0-41e7-9d50-931d8396d8cb] Periodic cleanup failed to delete instance: Instance c32db267-21a0-41e7-9d50-931d8396d8cb could not be found.", 
    "tags": [
        "in-stable-havana"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1280140", 
    "owner": "https://api.launchpad.net/1.0/~hzwangpan", 
    "id": 1280140, 
    "index": 5826, 
    "openned": "2014-02-14 08:47:06.430879+00:00", 
    "created": "2014-02-14 08:47:06.430879+00:00", 
    "title": "cleanup_running_deleted_instances peroidic task failed with instance not found", 
    "comments": [
        {
            "content": "this is because the db  query is not including the deleted instance while\n_delete_instance_files() in libvirt driver.\n\nI can reproduce this bug both in master and stable havana.\nreproduce steps:\n1. create an instance\n2. stop nova-compute\n3. wait for nova-manage serivce list display xxx of nova-compute\n4. modify the running_deleted_instance_poll_interval=60\nrunning_deleted_instance_action = reap,\nand start nova-compute and wait for this clean up peroidic task\n5. a warnning will be given in the compute log:\n2014-02-14 16:22:25.917 WARNING nova.compute.manager [-] [instance: c32db267-21a0-41e7-9d50-931d8396d8cb] Periodic cleanup failed to delete instance: Instance c32db267-21a0-41e7-9d50-931d8396d8cb could not be found.\n\nthe debug trace is:\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1006)cleanup()\n   1005 block_device_mapping = driver.block_device_info_get_mapping(\n-> 1006 block_device_info)\n   1007 for vol in block_device_mapping:\n\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1007)cleanup()\n   1006 block_device_info)\n-> 1007 for vol in block_device_mapping:\n   1008 connection_info = vol['connection_info']\n\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1041)cleanup()\n   1040 \n-> 1041 if destroy_disks:\n   1042 self._delete_instance_files(instance)\n\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1042)cleanup()\n   1041 if destroy_disks:\n-> 1042 self._delete_instance_files(instance)\n   1043 \n\nipdb> s\n--Call--\n> /opt/stack/nova/nova/virt/libvirt/driver.py(4950)_delete_instance_files()\n   4949 \n-> 4950 def _delete_instance_files(self, instance):\n   4951 # NOTE(mikal): a shim to handle this file not using instance objects\n\n\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(4953)_delete_instance_files()\n   4952 # everywhere. Remove this when that conversion happens.\n\n-> 4953 context = nova_context.get_admin_context()\n   4954 inst_obj = instance_obj.Instance.get_by_uuid(context, instance['uuid'])\n\nipdb> n\n> /opt/stack/nova/nova/virt/libvirt/driver.py(4954)_delete_instance_files()\n   4953 context = nova_context.get_admin_context()\n-> 4954 inst_obj = instance_obj.Instance.get_by_uuid(context, instance['uuid'])\n   4955 \n\nipdb> n\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/virt/libvirt/driver.py(4954)_delete_instance_files()\n   4953 context = nova_context.get_admin_context()\n-> 4954 inst_obj = instance_obj.Instance.get_by_uuid(context, instance['uuid'])\n   4955 \n\nipdb> n\n--Return--\nNone\n> /opt/stack/nova/nova/virt/libvirt/driver.py(4954)_delete_instance_files()\n   4953 context = nova_context.get_admin_context()\n-> 4954 inst_obj = instance_obj.Instance.get_by_uuid(context, instance['uuid'])\n   4955 \n\nipdb> n\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1042)cleanup()\n   1041 if destroy_disks:\n-> 1042 self._delete_instance_files(instance)\n   1043 \n\nipdb> n\n--Return--\nNone\n> /opt/stack/nova/nova/virt/libvirt/driver.py(1042)cleanup()\n   1041 if destroy_disks:\n-> 1042 self._delete_instance_files(instance)\n   1043 \n\nipdb> n\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/virt/libvirt/driver.py(931)destroy()\n    930 self.cleanup(context, instance, network_info, block_device_info,\n--> 931 destroy_disks)\n    932 \n\nipdb> n\n--Return--\nNone\n> /opt/stack/nova/nova/virt/libvirt/driver.py(931)destroy()\n    930 self.cleanup(context, instance, network_info, block_device_info,\n--> 931 destroy_disks)\n    932 \n\nipdb> n\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/compute/manager.py(1905)_shutdown_instance()\n   1904 self.driver.destroy(context, instance, network_info,\n-> 1905 block_device_info)\n   1906 except exception.InstancePowerOffFailure:\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(1906)_shutdown_instance()\n   1905 block_device_info)\n-> 1906 except exception.InstancePowerOffFailure:\n   1907 # if the instance can't power off, don't release the ip\n\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(1910)_shutdown_instance()\n   1909 pass\n-> 1910 except Exception:\n   1911 with excutils.save_and_reraise_exception():\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(1911)_shutdown_instance()\n   1910 except Exception:\n-> 1911 with excutils.save_and_reraise_exception():\n   1912 # deallocate ip and fail without proceeding to\n\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(1914)_shutdown_instance()\n   1913 # volume api calls, preserving current behavior\n\n-> 1914 self._try_deallocate_network(context, instance,\n   1915 requested_networks)\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(1915)_shutdown_instance()\n   1914 self._try_deallocate_network(context, instance,\n-> 1915 requested_networks)\n   1916 \n\nipdb> n\n2014-02-14 16:22:02.701 DEBUG nova.compute.manager [-] [instance: c32db267-21a0-41e7-9d50-931d8396d8cb] Deallocating network for instance from (pid=19192) _deallocate_network /opt/stack/nova/nova/compute/manager.py:1531\n2014-02-14 16:22:02.704 DEBUG oslo.messaging._drivers.amqpdriver [-] MSG_ID is e529a4edb22b480cb0641a62718e9b04 from (pid=19192) _send /opt/stack/oslo.messaging/oslo/messaging/_drivers/amqpdriver.py:358\n2014-02-14 16:22:02.705 DEBUG oslo.messaging._drivers.amqp [-] UNIQUE_ID is aed682f94730441aaa14e43a37c86227. from (pid=19192) _add_unique_id /opt/stack/oslo.messaging/oslo/messaging/_drivers/amqp.py:333\n2014-02-14 16:22:02.718 WARNING nova.openstack.common.loopingcall [-] task run outlasted interval by 11.632922 sec\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/compute/manager.py(1915)_shutdown_instance()\n   1914 self._try_deallocate_network(context, instance,\n-> 1915 requested_networks)\n   1916 \n\nipdb> n\n--Return--\nNone\n> /opt/stack/nova/nova/compute/manager.py(1915)_shutdown_instance()\n   1914 self._try_deallocate_network(context, instance,\n-> 1915 requested_networks)\n   1916 \n\nipdb> l\n   1910 except Exception:\n   1911 with excutils.save_and_reraise_exception():\n   1912 # deallocate ip and fail without proceeding to\n\n   1913 # volume api calls, preserving current behavior\n\n   1914 self._try_deallocate_network(context, instance,\n-> 1915 requested_networks)\n   1916 \n   1917 self._try_deallocate_network(context, instance, requested_networks)\n   1918 \n   1919 for bdm in vol_bdms:\n   1920 try:\n\nipdb> n\nInstanceNotFound: Instance...found.',)\n> /opt/stack/nova/nova/compute/manager.py(5225)_cleanup_running_deleted_instances()\n   5224 self._shutdown_instance(context, instance, bdms,\n-> 5225 notify=False)\n   5226 self._cleanup_volumes(context, instance['uuid'], bdms)\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(5227)_cleanup_running_deleted_instances()\n   5226 self._cleanup_volumes(context, instance['uuid'], bdms)\n-> 5227 except Exception as e:\n   5228 LOG.warning(_(\"Periodic cleanup failed to delete \"\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(5228)_cleanup_running_deleted_instances()\n   5227 except Exception as e:\n-> 5228 LOG.warning(_(\"Periodic cleanup failed to delete \"\n   5229 \"instance: %s\"),\n\nipdb> n\n> /opt/stack/nova/nova/compute/manager.py(5230)_cleanup_running_deleted_instances()\n   5229 \"instance: %s\"),\n-> 5230 unicode(e), instance=instance)\n   5231 else:\n\nipdb> n\n2014-02-14 16:22:25.917 WARNING nova.compute.manager [-] [instance: c32db267-21a0-41e7-9d50-931d8396d8cb] Periodic cleanup failed to delete instance: Instance c32db267-21a0-41e7-9d50-931d8396d8cb could not be found.", 
            "date_created": "2014-02-14 08:47:06.430879+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/73540", 
            "date_created": "2014-02-14 08:51:42.223370+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/73540\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d835163759527a651f3c4f2109ca0fdc3e968d37\nSubmitter: Jenkins\nBranch:    master\n\ncommit d835163759527a651f3c4f2109ca0fdc3e968d37\nAuthor: Wangpan <email address hidden>\nDate:   Mon Feb 17 11:27:22 2014 +0800\n\n    Fix InstanceNotFound error in _delete_instance_files\n    \n    Currently the cleanup_running_deleted_instances peroidic task\n    failed with InstanceNotFound exception, this is because the\n    db query is not including the deleted instance while\n    _delete_instance_files() in libvirt driver.\n    \n    Closes-bug: #1280140\n    \n    Change-Id: Ie65ff255ad3c582a71db93b07304a21d4976a193\n", 
            "date_created": "2014-02-26 22:59:38.053837+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/80180", 
            "date_created": "2014-03-13 05:52:56.425064+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/80180\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c87a88f0a531effeff571c2aa014e629e8299564\nSubmitter: Jenkins\nBranch:    stable/havana\n\ncommit c87a88f0a531effeff571c2aa014e629e8299564\nAuthor: Wangpan <email address hidden>\nDate:   Mon Feb 17 11:27:22 2014 +0800\n\n    Fix InstanceNotFound error in _delete_instance_files\n    \n    Currently the cleanup_running_deleted_instances peroidic task\n    failed with InstanceNotFound exception, this is because the\n    db query is not including the deleted instance while\n    _delete_instance_files() in libvirt driver.\n    \n    Closes-bug: #1280140\n    \n    Change-Id: Ie65ff255ad3c582a71db93b07304a21d4976a193\n    (cherry picked from d835163759527a651f3c4f2109ca0fdc3e968d37)\n", 
            "date_created": "2014-03-18 01:47:33.083563+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-03-05 13:12:57.931087+00:00"
}