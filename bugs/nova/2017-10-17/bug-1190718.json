{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 12:04:30.211087+00:00", 
    "description": "Using Devstack\n\n*** USE MiniDNS driver ***\n\nadd instance_dns_manager=nova.network.minidns.MiniDNS to [default] section in /etc/nova/nova.conf\n\n*** CREATE PRIVATE DNS DOMAIN ***\n\nstack@test:~/devstack$ nova dns-create-private-domain --availability_zone nova foo.org\n\nstack@test:~/devstack$ nova dns-domains\n+---------+---------+---------+-------------------+\n| domain  | scope   | project | availability_zone |\n+---------+---------+---------+-------------------+\n| foo.org | private | None    | nova              |\n+---------+---------+---------+-------------------+\n\n*** BOOT AN INSTANCE ***\nstack@test:~/devstack$ nova boot --flavor 1 --image 5f789010-7e57-465f-950c-ed071c3b75ae \"test-instance\"\n\n** IMMEDIATELY GOES INTO ERROR STATE ***\n\nThe following is the error in nova-network\n\n2013-06-13 19:18:44.632 ERROR nova.openstack.common.rpc.amqp [req-53d54d74-d53c-49be-ac4b-f0ab9d4bc0fe admin admin] Exception during message handling\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 433, in _process_data\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/floating_ips.py\", line 188, in deallocate_for_instance\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     super(FloatingIP, self).deallocate_for_instance(context, **kwargs)\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/manager.py\", line 540, in deallocate_for_instance\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     self.deallocate_fixed_ip(context, fixed_ip['address'], host=host)\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/manager.py\", line 247, in deallocate_fixed_ip\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     address)\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/manager.py\", line 894, in deallocate_fixed_ip\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     if self._validate_instance_zone_for_dns_domain(context, instance):\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/manager.py\", line 802, in _validate_instance_zone_for_dns_domain\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     dns_zone = domainref.availability_zone\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp AttributeError: 'NoneType' object has no attribute 'availability_zone'\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1190718", 
    "owner": "https://api.launchpad.net/1.0/~jshepher", 
    "id": 1190718, 
    "index": 5016, 
    "openned": "2013-06-13 19:22:43.831231+00:00", 
    "created": "2013-06-13 19:22:43.831231+00:00", 
    "title": "manager.py : _validate_instance_zone_for_dns_domain throwing AttributeError: 'NoneType' object has no attribute 'availability_zone' error", 
    "comments": [
        {
            "content": "Using Devstack\n\n*** USE MiniDNS driver ***\n\nadd instance_dns_manager=nova.network.minidns.MiniDNS to [default] section in /etc/nova/nova.conf\n\n*** CREATE PRIVATE DNS DOMAIN ***\n\nstack@test:~/devstack$ nova dns-create-private-domain --availability_zone nova foo.org\n\nstack@test:~/devstack$ nova dns-domains\n+---------+---------+---------+-------------------+\n| domain  | scope   | project | availability_zone |\n+---------+---------+---------+-------------------+\n| foo.org | private | None    | nova              |\n+---------+---------+---------+-------------------+\n\n*** BOOT AN INSTANCE ***\nstack@test:~/devstack$ nova boot --flavor 1 --image 5f789010-7e57-465f-950c-ed071c3b75ae \"test-instance\"\n\n** IMMEDIATELY GOES INTO ERROR STATE ***\n\nThe following is the error in nova-network\n\n2013-06-13 19:18:44.632 ERROR nova.openstack.common.rpc.amqp [req-53d54d74-d53c-49be-ac4b-f0ab9d4bc0fe admin admin] Exception during message handling\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 433, in _process_data\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/floating_ips.py\", line 188, in deallocate_for_instance\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     super(FloatingIP, self).deallocate_for_instance(context, **kwargs)\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/manager.py\", line 540, in deallocate_for_instance\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     self.deallocate_fixed_ip(context, fixed_ip['address'], host=host)\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/manager.py\", line 247, in deallocate_fixed_ip\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     address)\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/manager.py\", line 894, in deallocate_fixed_ip\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     if self._validate_instance_zone_for_dns_domain(context, instance):\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/network/manager.py\", line 802, in _validate_instance_zone_for_dns_domain\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp     dns_zone = domainref.availability_zone\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp AttributeError: 'NoneType' object has no attribute 'availability_zone'\n2013-06-13 19:18:44.632 TRACE nova.openstack.common.rpc.amqp", 
            "date_created": "2013-06-13 19:22:43.831231+00:00", 
            "author": "https://api.launchpad.net/1.0/~jshepher"
        }, 
        {
            "content": "Looks like nova.network.manager is calling db.dnsdomain_get and passing 'instance.availability_zone' as the fqdn.\n\nhttps://github.com/openstack/nova/blob/master/nova/network/manager.py#L795-L800\nhttps://github.com/openstack/nova/blob/master/nova/db/sqlalchemy/api.py#L924-L937\n\n mysql -u root nova -e \"select * from dns_domains\"\n+---------------------+------------+------------+---------+---------+---------+-------------------+------------+\n| created_at          | updated_at | deleted_at | deleted | domain  | scope   | availability_zone | project_id |\n+---------------------+------------+------------+---------+---------+---------+-------------------+------------+\n| 2013-06-13 19:17:44 | NULL       | NULL       |       0 | foo.org | private | nova              | NULL       |\n+---------------------+------------+------------+---------+---------+---------+-------------------+------------+\n\nThis wont work.. as the fqdn for the domain is 'foo.org' not 'nova'.", 
            "date_created": "2013-06-13 19:25:01.839107+00:00", 
            "author": "https://api.launchpad.net/1.0/~jshepher"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/32966", 
            "date_created": "2013-06-13 21:51:34.894817+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/32966\nCommitted: http://github.com/openstack/nova/commit/9f4fa11f1069afcc0e643aa11e28c5a7e683a525\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9f4fa11f1069afcc0e643aa11e28c5a7e683a525\nAuthor: galstrom21 <email address hidden>\nDate:   Thu Jun 13 16:26:23 2013 -0500\n\n    Fixing dnsdomain_get call in nova.network.manager\n    \n      db.dnsdomain_get() was being passed an availability\n      zone instead of a domain.\n    \n    fixes: bug #1190718\n    \n    Change-Id: Ia8ccf6e84d4b181adaa3b0475e51e3897ac03bd2\n", 
            "date_created": "2013-07-25 01:18:39.878946+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-09-05 15:50:46.412376+00:00"
}