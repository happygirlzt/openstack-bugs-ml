{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 08:51:03.285025+00:00", 
    "description": "When port flavor_access tempest tests into v3, I found if the remove_tenant_access and add_tenant_access called as non admin user an  Unexpected API Error arose.\n\nI look into code, find out the issue is that flavors.add_flavor_access and flavors.remove_flavor_access require admin privilege in DB level but the policy doesn't require it. and the exception is not catched. I think there is the same issue in nova v2 api.\n\nI also think we should remove the privilege check in DB level, but it need more tests, and can be remove in another patch or blue-print.\n\nthe tempest log is:\n2013-08-28 11:56:08.154 2220 INFO tempest.common.rest_client [-] Request: POST http://192.168.1.101:8774/v3/flavors/155214353/action\n2013-08-28 11:56:08.154 2220 DEBUG tempest.common.rest_client [-] Request Headers: {'Content-Type': 'application/json', 'Accept': 'application/json', 'X-Auth-Token': '<Token omitted>'} _log_request /opt/stack/tempest/tempest/common/rest_client.py:295\n2013-08-28 11:56:08.154 2220 DEBUG tempest.common.rest_client [-] Request Body: {\"add_tenant_access\": {\"tenant_id\": \"9bfa07133a42464a8701e3cf367bbb4d\"}} _log_request /opt/stack/tempest/tempest/common/rest_client.py:299\n2013-08-28 11:56:08.169 2220 INFO tempest.common.rest_client [-] Response Status: 500\n2013-08-28 11:56:08.169 2220 DEBUG tempest.common.rest_client [-] Response Headers: {'date': 'Wed, 28 Aug 2013 03:56:08 GMT', 'content-length': '202', 'content-type': 'application/json; charset=UTF-8', 'x-compute-request-id': 'req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab'} _log_response /opt/stack/tempest/tempest/common/rest_client.py:310\n2013-08-28 11:56:08.169 2220 DEBUG tempest.common.rest_client [-] Response Body: {\"computeFault\": {\"message\": \"Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\\n<class 'nova.exception.AdminRequired'>\", \"code\": 500}} _log_response /opt/stack/tempest/tempest/common/rest_client.py:314\n\nthe nova log is:\n2013-08-28 11:56:08.165 DEBUG routes.middleware [-] Matched POST /flavors/155214353/action from (pid=12748) __call__ /usr/lib/python2.7/dist-packages/routes/middleware.py:100\n2013-08-28 11:56:08.166 DEBUG routes.middleware [-] Route path: '/flavors/:(id)/action', defaults: {'action': u'action', 'controller': <nova.api.openstack.wsgi.Resource object at 0x4e72050>} from (pid=12748) __call__ /usr/lib/python2.7/dist-packages/routes/middleware.py:102\n2013-08-28 11:56:08.166 DEBUG routes.middleware [-] Match dict: {'action': u'action', 'controller': <nova.api.openstack.wsgi.Resource object at 0x4e72050>, 'id': u'155214353'} from (pid=12748) __call__ /usr/lib/python2.7/dist-packages/routes/middleware.py:103\n2013-08-28 11:56:08.166 DEBUG nova.api.openstack.wsgi [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] Action: 'action', body: {\"add_tenant_access\": {\"tenant_id\": \"9bfa07133a42464a8701e3cf367bbb4d\"}} from (pid=12748) _process_stack /opt/stack/nova/nova/api/openstack/wsgi.py:927\n2013-08-28 11:56:08.166 DEBUG nova.api.openstack.wsgi [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] Calling method <bound method FlavorActionController._add_tenant_access of <nova.api.openstack.compute.plugins.v3.flavor_access.FlavorActionController object at 0x50f5f50>> from (pid=12748) _process_stack /opt/stack/nova/nova/api/openstack/wsgi.py:928\n2013-08-28 11:56:08.167 ERROR nova.api.openstack.extensions [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] Unexpected exception in API method\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions Traceback (most recent call last):\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 469, in wrapped\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/plugins/v3/flavor_access.py\", line 176, in _add_tenant_access\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     flavors.add_flavor_access(id, tenant, context)\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/flavors.py\", line 245, in add_flavor_access\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     return db.flavor_access_add(ctxt, flavorid, projectid)\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/api.py\", line 1424, in flavor_access_add\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     return IMPL.flavor_access_add(context, flavor_id, project_id)\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 106, in wrapper\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     nova.context.require_admin_context(args[0])\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/context.py\", line 195, in require_admin_context\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     raise exception.AdminRequired()\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions AdminRequired: User does not have admin privileges\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions\n2013-08-28 11:56:08.167 INFO nova.api.openstack.wsgi [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] HTTP exception thrown: Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.AdminRequired'>\n2013-08-28 11:56:08.168 DEBUG nova.api.openstack.wsgi [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] Returning 500 to user: Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.AdminRequired'> from (pid=12748) __call__ /opt/stack/nova/nova/api/openstack/wsgi.py:1188\n2013-08-28 11:56:08.168 INFO nova.osapi_compute.wsgi.server [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] 192.168.1.101 \"POST /v3/flavors/155214353/action HTTP/1.1\" status: 500 len: 409 time: 0.0126910", 
    "tags": [
        "api"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1217679", 
    "owner": "https://api.launchpad.net/1.0/~ivan-zhu", 
    "id": 1217679, 
    "index": 5286, 
    "openned": "2013-08-28 03:57:30.506431+00:00", 
    "created": "2013-08-28 03:57:30.506431+00:00", 
    "title": "there is an  Unexpected API Error when call remove_tenant_access action in nova v3 flavor_access api as an unadmin user", 
    "comments": [
        {
            "content": "When port flavor_access tempest tests into v3, I found if the remove_tenant_access and add_tenant_access called as non admin user an  Unexpected API Error arose.\n\nI look into code, find out the issue is that flavors.add_flavor_access and flavors.remove_flavor_access require admin privilege but the policy doesn't require it. and the exception is not catched. I think there is the same issue in nova v2 api.\n\n\nthe tempest log is:\n2013-08-28 11:56:08.154 2220 INFO tempest.common.rest_client [-] Request: POST http://192.168.1.101:8774/v3/flavors/155214353/action\n2013-08-28 11:56:08.154 2220 DEBUG tempest.common.rest_client [-] Request Headers: {'Content-Type': 'application/json', 'Accept': 'application/json', 'X-Auth-Token': '<Token omitted>'} _log_request /opt/stack/tempest/tempest/common/rest_client.py:295\n2013-08-28 11:56:08.154 2220 DEBUG tempest.common.rest_client [-] Request Body: {\"add_tenant_access\": {\"tenant_id\": \"9bfa07133a42464a8701e3cf367bbb4d\"}} _log_request /opt/stack/tempest/tempest/common/rest_client.py:299\n2013-08-28 11:56:08.169 2220 INFO tempest.common.rest_client [-] Response Status: 500\n2013-08-28 11:56:08.169 2220 DEBUG tempest.common.rest_client [-] Response Headers: {'date': 'Wed, 28 Aug 2013 03:56:08 GMT', 'content-length': '202', 'content-type': 'application/json; charset=UTF-8', 'x-compute-request-id': 'req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab'} _log_response /opt/stack/tempest/tempest/common/rest_client.py:310\n2013-08-28 11:56:08.169 2220 DEBUG tempest.common.rest_client [-] Response Body: {\"computeFault\": {\"message\": \"Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\\n<class 'nova.exception.AdminRequired'>\", \"code\": 500}} _log_response /opt/stack/tempest/tempest/common/rest_client.py:314\n\n\n\n\nthe nova log is:\n2013-08-28 11:56:08.165 DEBUG routes.middleware [-] Matched POST /flavors/155214353/action from (pid=12748) __call__ /usr/lib/python2.7/dist-packages/routes/middleware.py:100\n2013-08-28 11:56:08.166 DEBUG routes.middleware [-] Route path: '/flavors/:(id)/action', defaults: {'action': u'action', 'controller': <nova.api.openstack.wsgi.Resource object at 0x4e72050>} from (pid=12748) __call__ /usr/lib/python2.7/dist-packages/routes/middleware.py:102\n2013-08-28 11:56:08.166 DEBUG routes.middleware [-] Match dict: {'action': u'action', 'controller': <nova.api.openstack.wsgi.Resource object at 0x4e72050>, 'id': u'155214353'} from (pid=12748) __call__ /usr/lib/python2.7/dist-packages/routes/middleware.py:103\n2013-08-28 11:56:08.166 DEBUG nova.api.openstack.wsgi [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] Action: 'action', body: {\"add_tenant_access\": {\"tenant_id\": \"9bfa07133a42464a8701e3cf367bbb4d\"}} from (pid=12748) _process_stack /opt/stack/nova/nova/api/openstack/wsgi.py:927\n2013-08-28 11:56:08.166 DEBUG nova.api.openstack.wsgi [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] Calling method <bound method FlavorActionController._add_tenant_access of <nova.api.openstack.compute.plugins.v3.flavor_access.FlavorActionController object at 0x50f5f50>> from (pid=12748) _process_stack /opt/stack/nova/nova/api/openstack/wsgi.py:928\n2013-08-28 11:56:08.167 ERROR nova.api.openstack.extensions [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] Unexpected exception in API method\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions Traceback (most recent call last):\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 469, in wrapped\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/plugins/v3/flavor_access.py\", line 176, in _add_tenant_access\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     flavors.add_flavor_access(id, tenant, context)\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/flavors.py\", line 245, in add_flavor_access\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     return db.flavor_access_add(ctxt, flavorid, projectid)\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/api.py\", line 1424, in flavor_access_add\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     return IMPL.flavor_access_add(context, flavor_id, project_id)\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 106, in wrapper\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     nova.context.require_admin_context(args[0])\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/context.py\", line 195, in require_admin_context\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions     raise exception.AdminRequired()\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions AdminRequired: User does not have admin privileges\n2013-08-28 11:56:08.167 TRACE nova.api.openstack.extensions \n2013-08-28 11:56:08.167 INFO nova.api.openstack.wsgi [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] HTTP exception thrown: Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.AdminRequired'>\n2013-08-28 11:56:08.168 DEBUG nova.api.openstack.wsgi [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] Returning 500 to user: Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.AdminRequired'> from (pid=12748) __call__ /opt/stack/nova/nova/api/openstack/wsgi.py:1188\n2013-08-28 11:56:08.168 INFO nova.osapi_compute.wsgi.server [req-17649b30-e3a7-489f-98ab-8cf0ccb0e0ab demo demo] 192.168.1.101 \"POST /v3/flavors/155214353/action HTTP/1.1\" status: 500 len: 409 time: 0.0126910", 
            "date_created": "2013-08-28 03:57:30.506431+00:00", 
            "author": "https://api.launchpad.net/1.0/~ivan-zhu"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/43988\nCommitted: http://github.com/openstack/nova/commit/d6214f122feb99be74b6654bf86d1677926fa628\nSubmitter: Jenkins\nBranch:    master\n\ncommit d6214f122feb99be74b6654bf86d1677926fa628\nAuthor: ivan-zhu <email address hidden>\nDate:   Wed Aug 28 11:40:35 2013 +0800\n\n    fix the an Unexpected API Error issue in flavor API\n    \n    The flavors.add_flavor_access and flavors.remove_flavor_access\n    require admin privilege in DB level but the policy doesn't\n    require it and the exception isn't catched in the api. So the\n    bug arise. The privilege check in DB level is not necessary,\n    but it need more tests and can be remove in other patch or\n    blue-print.\n    \n    This use extension_authorizer instead of soft_extension_authorizer\n    in the action of flavor_access, in order to raise exception.\n    \n    Closes-Bug: #1217679\n    DocImpact\n    \n    Change-Id: I0b1231f47fffaf99f330de02956bfe8d7cd4b920\n", 
            "date_created": "2013-10-07 12:42:15.517615+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-12-04 10:33:02.912809+00:00"
}