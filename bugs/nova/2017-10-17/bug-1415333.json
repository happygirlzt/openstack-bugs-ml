{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:18:45.115202+00:00", 
    "description": "The current version of Libvirt in the gate doesn't support a memnode element in the numa tune configuration.\n When requesting guest topology the instance is crashing with\nthe following:\n\nInstance failed to spawn\n Traceback (most recent call last):\n   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2303, in _build_resources\n     yield resources\n   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2173, in _build_and_run_instance\n     flavor=flavor)\n   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 2320, in spawn\n     block_device_info=block_device_info)\n   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4231, in _create_domain_and_network\n     power_on=power_on)\n   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4164, in _create_domain\n     LOG.error(err)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 82, in __exit__\n     six.reraise(self.type_, self.value, self.tb)\n   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4148, in _create_domain\n     domain = self._conn.defineXML(xml)\n   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n     result = proxy_call(self._autowrap, f, *args, **kwargs)\n   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n     rv = execute(f, *args, **kwargs)\n   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n     six.reraise(c, e, tb)\n   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n     rv = meth(*args, **kwargs)\n   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 3240, in defineXML\n     if ret is None:raise libvirtError('virDomainDefineXML() failed', conn=self)\n libvirtError: XML error: unsupported XML element memnode", 
    "tags": [
        "libvirt"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1415333", 
    "owner": "https://api.launchpad.net/1.0/~vladik-romanovsky", 
    "id": 1415333, 
    "index": 4140, 
    "openned": "2015-01-28 05:52:48.211207+00:00", 
    "created": "2015-01-28 05:52:48.211207+00:00", 
    "title": "Memnode element is not supported on all versions of libvirt", 
    "comments": [
        {
            "content": "The current version of Libvirt in the gate doesn't support a memnode element in the numa tune configuration.\n When requesting guest topology the instance is crashing with\nthe following:\n\nInstance failed to spawn\n Traceback (most recent call last):\n   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2303, in _build_resources\n     yield resources\n   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 2173, in _build_and_run_instance\n     flavor=flavor)\n   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 2320, in spawn\n     block_device_info=block_device_info)\n   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4231, in _create_domain_and_network\n     power_on=power_on)\n   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4164, in _create_domain\n     LOG.error(err)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 82, in __exit__\n     six.reraise(self.type_, self.value, self.tb)\n   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 4148, in _create_domain\n     domain = self._conn.defineXML(xml)\n   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n     result = proxy_call(self._autowrap, f, *args, **kwargs)\n   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n     rv = execute(f, *args, **kwargs)\n   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n     six.reraise(c, e, tb)\n   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n     rv = meth(*args, **kwargs)\n   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 3240, in defineXML\n     if ret is None:raise libvirtError('virDomainDefineXML() failed', conn=self)\n libvirtError: XML error: unsupported XML element memnode", 
            "date_created": "2015-01-28 05:52:48.211207+00:00", 
            "author": "https://api.launchpad.net/1.0/~vladik-romanovsky"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/150694", 
            "date_created": "2015-01-28 06:02:35.114378+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/150694\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=cf3a1262ecf12f4345326309c273722ebc26b466\nSubmitter: Jenkins\nBranch:    master\n\ncommit cf3a1262ecf12f4345326309c273722ebc26b466\nAuthor: Vladik Romanovsky <email address hidden>\nDate:   Wed Jan 28 00:54:26 2015 -0500\n\n    libvirt: avoid setting the memnodes where when it's not a supported option\n    \n    The current version of Libvirt in the gate doesn't support a memnode element\n    in the numa tune configuration. When requesting guest topology the instance\n    is crashing. Not setting the numa tune memnodes option when libvirt version\n    is less than the required minimum.\n    \n    Change-Id: I99d0bb64bd6d698f2d5ce978cb3778bbad8eec91\n    Closes-Bug: #1415333\n", 
            "date_created": "2015-02-02 19:18:31.725659+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/152405", 
            "date_created": "2015-02-03 06:23:17.177607+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/152405\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=976dc9707b96de8ebf8b57ea645ff7755fbaa1ce\nSubmitter: Jenkins\nBranch:    master\n\ncommit 976dc9707b96de8ebf8b57ea645ff7755fbaa1ce\nAuthor: Vladik Romanovsky <email address hidden>\nDate:   Tue Feb 3 01:07:24 2015 -0500\n\n    libvirt: memnodes shuold be set to a list instead of None\n    \n    Currently, _get_guest_numa_tune_memnodes returns None,\n    when an installed version of Libvirt doesn't support a\n    memnode element in the numa tune configuration,\n    while it should always return a list.\n    \n    Related-Bug: #1415333\n    \n    Change-Id: I28a5a2c65aa703b0161ebca8659dc96a7b6c1bf6\n", 
            "date_created": "2015-02-13 13:34:02.690480+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/159106", 
            "date_created": "2015-02-25 12:55:45.801130+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/159106\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=945ab28df04e22f3c1b8948972f538ee6b5e7410\nSubmitter: Jenkins\nBranch:    master\n\ncommit 945ab28df04e22f3c1b8948972f538ee6b5e7410\nAuthor: Daniel P. Berrange <email address hidden>\nDate:   Wed Feb 25 10:11:14 2015 +0000\n\n    libvirt: fix disablement of NUMA & hugepages on unsupported platforms\n    \n    Two previous commits updated the libvirt XML config generator so\n    that it would omit the config elements for huge pages and NUMA\n    placement when running on old libvirt:\n    \n      commit cf3a1262ecf12f4345326309c273722ebc26b466\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Wed Jan 28 00:54:26 2015 -0500\n    \n        libvirt: avoid setting the memnodes where when it's not a supported option\n    \n      commit 3466e727546e0f7595378b8274254bed913f42ee\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Tue Jan 6 14:23:38 2015 -0500\n    \n        libvirt: not setting membacking when mempages are empty host topology\n    \n    The problem arising from this is that the hosts are still reporting\n    to the schedular that they can support NUMA and huge pages if\n    libvirt >= 1.0.4, but we are silently discarding the guest config\n    if libvirt < 1.2.7 (numa) or 1.2.8 (huge pages).\n    \n    The result is that the schedular thinks the host can support the\n    requested feature and so places the guest there, but the actual\n    guest that is launched is missing the feature. So the user is not\n    getting what they requested.\n    \n    The correct approach is to update the \"_get_host_numa_topology\"\n    method so that it does not report any NUMA topology in the first\n    place, if the host is incapable of having guests configured in\n    the way Nova requires. Likewise if the host cannot support the\n    huge page configuration method required, it should not report\n    availability of huge pages.\n    \n    In summary, we are moving the version checks added by the two\n    commits above to the point at which host capability reporting\n    is done. We add a fatal error check in the guest XML config\n    generator methods, so that if there is some future schedular\n    bug causing it to not honour host capabilities, we see a\n    clear error instead of silently starting guests with the\n    wrong config.\n    \n    There is a further mistake in that a version number check alone\n    is insufficient. We must also check that the hypervisor is\n    either QEMU or KVM, to prevent the code paths running on Xen\n    or LXC.\n    \n    Closes-bug: #1425115\n    Related-bug: #1408070\n    Related-bug: #1415333\n    \n    Change-Id: I8326596696cbb030ae95d17f3dd430d05279081a\n", 
            "date_created": "2015-04-05 14:52:12.073574+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/159106\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=945ab28df04e22f3c1b8948972f538ee6b5e7410\nSubmitter: Jenkins\nBranch:    master\n\ncommit 945ab28df04e22f3c1b8948972f538ee6b5e7410\nAuthor: Daniel P. Berrange <email address hidden>\nDate:   Wed Feb 25 10:11:14 2015 +0000\n\n    libvirt: fix disablement of NUMA & hugepages on unsupported platforms\n    \n    Two previous commits updated the libvirt XML config generator so\n    that it would omit the config elements for huge pages and NUMA\n    placement when running on old libvirt:\n    \n      commit cf3a1262ecf12f4345326309c273722ebc26b466\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Wed Jan 28 00:54:26 2015 -0500\n    \n        libvirt: avoid setting the memnodes where when it's not a supported option\n    \n      commit 3466e727546e0f7595378b8274254bed913f42ee\n      Author: Vladik Romanovsky <email address hidden>\n      Date:   Tue Jan 6 14:23:38 2015 -0500\n    \n        libvirt: not setting membacking when mempages are empty host topology\n    \n    The problem arising from this is that the hosts are still reporting\n    to the schedular that they can support NUMA and huge pages if\n    libvirt >= 1.0.4, but we are silently discarding the guest config\n    if libvirt < 1.2.7 (numa) or 1.2.8 (huge pages).\n    \n    The result is that the schedular thinks the host can support the\n    requested feature and so places the guest there, but the actual\n    guest that is launched is missing the feature. So the user is not\n    getting what they requested.\n    \n    The correct approach is to update the \"_get_host_numa_topology\"\n    method so that it does not report any NUMA topology in the first\n    place, if the host is incapable of having guests configured in\n    the way Nova requires. Likewise if the host cannot support the\n    huge page configuration method required, it should not report\n    availability of huge pages.\n    \n    In summary, we are moving the version checks added by the two\n    commits above to the point at which host capability reporting\n    is done. We add a fatal error check in the guest XML config\n    generator methods, so that if there is some future schedular\n    bug causing it to not honour host capabilities, we see a\n    clear error instead of silently starting guests with the\n    wrong config.\n    \n    There is a further mistake in that a version number check alone\n    is insufficient. We must also check that the hypervisor is\n    either QEMU or KVM, to prevent the code paths running on Xen\n    or LXC.\n    \n    Closes-bug: #1425115\n    Related-bug: #1408070\n    Related-bug: #1415333\n    \n    Change-Id: I8326596696cbb030ae95d17f3dd430d05279081a\n", 
            "date_created": "2015-04-05 14:52:19.537062+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-02-05 20:20:42.209026+00:00"
}