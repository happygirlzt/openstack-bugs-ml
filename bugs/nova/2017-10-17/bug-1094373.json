{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:03:58.213352+00:00", 
    "description": "Attempting to resize an image that is a whole disk:\n\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self.gen.next()2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 87, in wrapped2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 211, in decorated_function2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     pass2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self.gen.next()2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 197, in decorated_function2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 238, in decorated_function2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     kwargs['instance']['uuid'], e, sys.exc_info())2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self.gen.next()2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 226, in decorated_function2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 2046, in finish_resize2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self._set_instance_error_state(context, instance['uuid'])\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 2034, in finish_resize\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     disk_info, image)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 2002, in _finish_resize\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     block_device_info)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 112, in wrapped\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 87, in wrapped\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2946, in finish_migration\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     disk.can_resize_fs(info['path'], size, use_cow=True)):\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 136, in can_resize_fs\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     inject_data(image, use_cow=True)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 274, in inject_data\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     fs.setup()\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/disk/vfs/localfs.py\", line 84, in setup\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     raise e\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp Exception: Failed to mount image: Failed to mount filesystem: Unexpected error while running command.\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp Command: sudo nova-rootwrap /etc/nova/rootwrap.conf mount /dev/nbd2 /tmp/openstack-vfs-localfsvFKSfy\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp Exit code: 32\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp Stdout: ''\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp Stderr: 'mount: you must specify the filesystem type\\n'\n\n\nthe can_resize method shouldn't be failing if the mount doesn't work.\n\nVish", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1094373", 
    "owner": "https://api.launchpad.net/1.0/~mikal", 
    "id": 1094373, 
    "index": 3188, 
    "openned": "2012-12-28 22:48:14.419936+00:00", 
    "created": "2012-12-28 22:48:14.419936+00:00", 
    "title": "libvirt: resize of whole disk image fails", 
    "comments": [
        {
            "content": "Attempting to resize an image that is a whole disk:\n\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self.gen.next()2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 87, in wrapped2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 211, in decorated_function2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     pass2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self.gen.next()2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 197, in decorated_function2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 238, in decorated_function2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     kwargs['instance']['uuid'], e, sys.exc_info())2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self.gen.next()2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 226, in decorated_function2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 2046, in finish_resize2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self._set_instance_error_state(context, instance['uuid'])\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 2034, in finish_resize\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     disk_info, image)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 2002, in _finish_resize\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     block_device_info)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 112, in wrapped\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 87, in wrapped\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kw)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2946, in finish_migration\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     disk.can_resize_fs(info['path'], size, use_cow=True)):\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 136, in can_resize_fs\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     inject_data(image, use_cow=True)\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/disk/api.py\", line 274, in inject_data\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     fs.setup()\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/disk/vfs/localfs.py\", line 84, in setup\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp     raise e\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp Exception: Failed to mount image: Failed to mount filesystem: Unexpected error while running command.\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp Command: sudo nova-rootwrap /etc/nova/rootwrap.conf mount /dev/nbd2 /tmp/openstack-vfs-localfsvFKSfy\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp Exit code: 32\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp Stdout: ''\n2012-12-28 14:43:59 TRACE nova.openstack.common.rpc.amqp Stderr: 'mount: you must specify the filesystem type\\n'\n\n\nthe can_resize method shouldn't be failing if the mount doesn't work.\n\nVish", 
            "date_created": "2012-12-28 22:48:14.419936+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Vish -- this system should probably have guestfs installed, which would have meant this code path wasn't followed. I believe guestfs is more secure for this stuff.", 
            "date_created": "2012-12-29 08:24:46.670930+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/18743", 
            "date_created": "2012-12-29 08:24:47.411162+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/18743\nCommitted: http://github.com/openstack/nova/commit/2397c6b902174ef39bff5f9194a06f82c6746267\nSubmitter: Jenkins\nBranch:    master\n\ncommit 2397c6b902174ef39bff5f9194a06f82c6746267\nAuthor: Michael Still <email address hidden>\nDate:   Sat Dec 29 19:22:54 2012 +1100\n\n    Report failures to mount in localfs correctly.\n    \n    The wrong exception type was being thrown, which meant that the virt\n    disk api though the disk could be resized when it couldn't. I've\n    added two unit tests to cover regressions as well, but this code needs\n    more unit testing in general. Resolves bug 1094373.\n    \n    Change-Id: I9c974e138ff90e8b7a5a40f5b31dcdb25a59622d\n", 
            "date_created": "2013-01-02 19:17:48.814498+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/18872", 
            "date_created": "2013-01-03 13:56:32.277121+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/18872\nCommitted: http://github.com/openstack/nova/commit/54ee787d7ae1d7635bd5dac8efd985e3a93ad1c2\nSubmitter: Jenkins\nBranch:    master\n\ncommit 54ee787d7ae1d7635bd5dac8efd985e3a93ad1c2\nAuthor: P\u00e1draig Brady <email address hidden>\nDate:   Thu Jan 3 03:09:00 2013 +0000\n\n    fix resize of unpartitioned images with libguestfs\n    \n    Following on from I9c974e138ff90e8b7a5a40f5b31dcdb25a59622d\n    Ensure that the libguestfs path also throws a NovaException,\n    handled by can_resize_fs().\n    \n    * nova/virt/disk/vfs/guestfs.py (setup): Move the debug message\n    and guestfs handle outside the exception handler as we\n    don't want to map failure of those to a NovaException\n    that indicates an issue with the image as opposed to the\n    nova code or libguestfs installation.  Change to a more explicit\n    exception thrown by guestfs, so as to avoid masking other issues.\n    (teardown): Remove redundant calls to str().\n    * nova/virt/disk/api.py (can_resize_fs): Cleanup the debug messages,\n    and use the newer vfs API directly, rather than the slightly\n    hacky call to inject_data() with no data to inject.\n    \n    Fixes bug: 1094373\n    Change-Id: I3e1305cf6bb64278a8caf37e4c5005cb9683f632\n", 
            "date_created": "2013-01-04 10:05:39.537241+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-01-09 10:22:16.686959+00:00"
}