{
    "status": "Fix Released", 
    "last_updated": "2017-07-28 07:40:14.934167+00:00", 
    "description": "I noticed this in the devstack change testing multi-cell, in the neutron multinode job:\n\nhttp://logs.openstack.org/56/477556/3/check/gate-tempest-dsvm-neutron-multinode-full-ubuntu-xenial-nv/ee3e9b6/logs/screen-n-api.txt.gz?level=TRACE#_Jul_05_20_55_53_749696\n\nWe're getting migration not found because we're not targeted to a cell to find the migration:\n\nJul 05 20:55:53.749696 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions [None req-d4ca5b2e-140c-4331-88eb-50bae2de2230 service nova] Unexpected exception in API method: MigrationNotFound: Migration 15 could not be found.\nJul 05 20:55:53.749806 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions Traceback (most recent call last):\nJul 05 20:55:53.749888 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/extensions.py\", line 336, in wrapped\nJul 05 20:55:53.749965 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\nJul 05 20:55:53.750053 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/validation/__init__.py\", line 108, in wrapper\nJul 05 20:55:53.750134 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     return func(*args, **kwargs)\nJul 05 20:55:53.750222 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/server_external_events.py\", line 120, in create\nJul 05 20:55:53.750303 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     context, accepted_instances, mappings, accepted_events)\nJul 05 20:55:53.750438 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/compute/api.py\", line 4046, in external_instance_event\nJul 05 20:55:53.750564 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     for host in self._get_relevant_hosts(context, instance):\nJul 05 20:55:53.750647 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/compute/api.py\", line 4072, in _get_relevant_hosts\nJul 05 20:55:53.750722 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     migration = objects.Migration.get_by_id(context, migration_id)\nJul 05 20:55:53.750798 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 184, in wrapper\nJul 05 20:55:53.750873 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\nJul 05 20:55:53.750949 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/migration.py\", line 106, in get_by_id\nJul 05 20:55:53.751023 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     db_migration = db.migration_get(context, migration_id)\nJul 05 20:55:53.751107 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/api.py\", line 535, in migration_get\nJul 05 20:55:53.751187 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     return IMPL.migration_get(context, migration_id)\nJul 05 20:55:53.751264 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 265, in wrapped\nJul 05 20:55:53.751338 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     return f(context, *args, **kwargs)\nJul 05 20:55:53.751414 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 4719, in migration_get\nJul 05 20:55:53.751492 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     raise exception.MigrationNotFound(migration_id=id)\nJul 05 20:55:53.751568 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions MigrationNotFound: Migration 15 could not be found.\nJul 05 20:55:53.751640 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions \n\nhttps://github.com/openstack/nova/blob/56cd608d3a199dcb02ac2ae071ff3057241259da/nova/compute/api.py#L4301\n\nWe need to use the mappings dict passed to external_instance_event to mutate the context while looking up the migration.", 
    "tags": [
        "api", 
        "cells"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1702959", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1702959, 
    "index": 2100, 
    "openned": "2017-07-07 16:34:50.574004+00:00", 
    "created": "2017-07-07 16:34:50.574004+00:00", 
    "title": "MigrationNotFound in multi-cell setup doing server external events processing", 
    "comments": [
        {
            "content": "I noticed this in the devstack change testing multi-cell, in the neutron multinode job:\n\nhttp://logs.openstack.org/56/477556/3/check/gate-tempest-dsvm-neutron-multinode-full-ubuntu-xenial-nv/ee3e9b6/logs/screen-n-api.txt.gz?level=TRACE#_Jul_05_20_55_53_749696\n\nWe're getting migration not found because we're not targeted to a cell to find the migration:\n\nJul 05 20:55:53.749696 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions [None req-d4ca5b2e-140c-4331-88eb-50bae2de2230 service nova] Unexpected exception in API method: MigrationNotFound: Migration 15 could not be found.\nJul 05 20:55:53.749806 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions Traceback (most recent call last):\nJul 05 20:55:53.749888 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/extensions.py\", line 336, in wrapped\nJul 05 20:55:53.749965 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\nJul 05 20:55:53.750053 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/validation/__init__.py\", line 108, in wrapper\nJul 05 20:55:53.750134 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     return func(*args, **kwargs)\nJul 05 20:55:53.750222 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/server_external_events.py\", line 120, in create\nJul 05 20:55:53.750303 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     context, accepted_instances, mappings, accepted_events)\nJul 05 20:55:53.750438 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/compute/api.py\", line 4046, in external_instance_event\nJul 05 20:55:53.750564 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     for host in self._get_relevant_hosts(context, instance):\nJul 05 20:55:53.750647 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/compute/api.py\", line 4072, in _get_relevant_hosts\nJul 05 20:55:53.750722 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     migration = objects.Migration.get_by_id(context, migration_id)\nJul 05 20:55:53.750798 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 184, in wrapper\nJul 05 20:55:53.750873 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\nJul 05 20:55:53.750949 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/migration.py\", line 106, in get_by_id\nJul 05 20:55:53.751023 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     db_migration = db.migration_get(context, migration_id)\nJul 05 20:55:53.751107 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/api.py\", line 535, in migration_get\nJul 05 20:55:53.751187 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     return IMPL.migration_get(context, migration_id)\nJul 05 20:55:53.751264 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 265, in wrapped\nJul 05 20:55:53.751338 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     return f(context, *args, **kwargs)\nJul 05 20:55:53.751414 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 4719, in migration_get\nJul 05 20:55:53.751492 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions     raise exception.MigrationNotFound(migration_id=id)\nJul 05 20:55:53.751568 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions MigrationNotFound: Migration 15 could not be found.\nJul 05 20:55:53.751640 ubuntu-xenial-2-node-osic-cloud1-s3500-9668742 <email address hidden>[27811]: ERROR nova.api.openstack.extensions \n\nhttps://github.com/openstack/nova/blob/56cd608d3a199dcb02ac2ae071ff3057241259da/nova/compute/api.py#L4301\n\nWe need to use the mappings dict passed to external_instance_event to mutate the context while looking up the migration.", 
            "date_created": "2017-07-07 16:34:50.574004+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This may be fixed by this change:\n\nhttps://review.openstack.org/#/c/445142/\n\nSpecifically this part:\n\nhttps://review.openstack.org/#/c/445142/10/nova/compute/api.py@4263\n\nI'll add that as a dependency to the devstack 'fleetify' change to test it out:\n\nhttps://review.openstack.org/#/c/477556/", 
            "date_created": "2017-07-07 16:51:55.990129+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/445142\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b8be61eb39dc9f605ad853e5697a8f4bf73b025b\nSubmitter: Jenkins\nBranch:    master\n\ncommit b8be61eb39dc9f605ad853e5697a8f4bf73b025b\nAuthor: Matthew Booth <email address hidden>\nDate:   Mon Mar 13 18:28:17 2017 +0000\n\n    Fix and optimize external_events for multiple cells\n    \n    server_external_events was previously making an api db query and a\n    cell db query for every instance reference. We improve this by\n    making exactly 1 api db query to fetch all instance mappings, and then\n    1 cell db query per cell to fetch all relevant instances from that\n    cell. Further, it wasn't properly handling the case where events\n    were delivered in one request for multiple instances across cells,\n    which this also fixes.\n    \n    We also document an obtuse edge condition in\n    ComputeAPI.external_instance_event which will cause the current code\n    to break when we support migration between cells.\n    \n    Note this includes a tweak to the SingleCellSimple fixture to mock out\n    the new InstanceMappingList method we use, as well as a fix to the other\n    InstanceMapping mock, which was returning mappings with bogus instance\n    uuids. This patch relies on the results of those being realistic and\n    thus requires those changes.\n    \n    Closes-Bug: #1702959\n    \n    Co-Authored-By: Dan Smith <email address hidden>\n    \n    Change-Id: If59453f1899e99040c554bcb9ad54c8a506adc56\n", 
            "date_created": "2017-07-21 00:13:40.906650+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b3 development milestone.", 
            "date_created": "2017-07-28 07:40:14.473749+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-07-21 00:13:38.704771+00:00"
}