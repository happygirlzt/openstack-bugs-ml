{
    "status": "Invalid", 
    "last_updated": "2014-03-14 14:26:41.331982+00:00", 
    "description": "When I try and shelve an instance I get the following error on the compute node:\n\n2013-12-04 10:39:59.716 18800 ERROR nova.openstack.common.rpc.amqp [req-d87825e7-9c2f-4735-94e2-4c470ee0edab d9646718471b46aeb5fd94c702336ca9 0bdf024c921848c4b74d9e69af9edf08] Exception during message handling\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 90, in wrapped\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 73, in wrapped\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 243, in decorated_function\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     pass\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 229, in decorated_function\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 294, in decorated_function\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     function(self, context, *args, **kwargs)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 271, in decorated_function\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 258, in decorated_function\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 3336, in shelve_instance\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     current_period=True)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/conductor/api.py\", line 292, in notify_usage_exists\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     system_metadata, extra_usage_info)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 1094, in wrapper\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     return func(*args, **kwargs)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/conductor/manager.py\", line 486, in notify_usage_exists\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     system_metadata, extra_usage_info)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/utils.py\", line 295, in notify_usage_exists\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     system_metadata=system_metadata, extra_usage_info=extra_info)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/utils.py\", line 316, in notify_about_instance_usage\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     network_info, system_metadata, **extra_usage_info)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/notifications.py\", line 420, in info_from_instance\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     instance_info['metadata'] = utils.instance_meta(instance_ref)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 1044, in instance_meta\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     if isinstance(instance['metadata'], dict):\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp KeyError: 'metadata'\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp", 
    "tags": [
        "unified-objects"
    ], 
    "importance": "Undecided", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1257532", 
    "owner": "None", 
    "id": 1257532, 
    "index": 5619, 
    "openned": "2013-12-03 23:43:29.034893+00:00", 
    "created": "2013-12-03 23:43:29.034893+00:00", 
    "title": "Shelving fails with KeyError: 'metadata'", 
    "comments": [
        {
            "content": "When I try and shelve an instance I get the following error on the compute node:\n\n2013-12-04 10:39:59.716 18800 ERROR nova.openstack.common.rpc.amqp [req-d87825e7-9c2f-4735-94e2-4c470ee0edab d9646718471b46aeb5fd94c702336ca9 0bdf024c921848c4b74d9e69af9edf08] Exception during message handling\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 90, in wrapped\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 73, in wrapped\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 243, in decorated_function\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     pass\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 229, in decorated_function\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 294, in decorated_function\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     function(self, context, *args, **kwargs)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 271, in decorated_function\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 258, in decorated_function\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 3336, in shelve_instance\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     current_period=True)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/conductor/api.py\", line 292, in notify_usage_exists\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     system_metadata, extra_usage_info)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 1094, in wrapper\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     return func(*args, **kwargs)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/conductor/manager.py\", line 486, in notify_usage_exists\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     system_metadata, extra_usage_info)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/utils.py\", line 295, in notify_usage_exists\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     system_metadata=system_metadata, extra_usage_info=extra_info)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/utils.py\", line 316, in notify_about_instance_usage\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     network_info, system_metadata, **extra_usage_info)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/notifications.py\", line 420, in info_from_instance\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     instance_info['metadata'] = utils.instance_meta(instance_ref)\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 1044, in instance_meta\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp     if isinstance(instance['metadata'], dict):\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp KeyError: 'metadata'\n2013-12-04 10:39:59.716 18800 TRACE nova.openstack.common.rpc.amqp", 
            "date_created": "2013-12-03 23:43:29.034893+00:00", 
            "author": "https://api.launchpad.net/1.0/~sorrison"
        }, 
        {
            "content": "This seems to sometimes work and sometimes fail, debugging it sometimes the instance has metadata, sometimes it doesn't.\n\nIt seems to be in obj_base.obj_to_primitive(instance) where sometimes it doesn't set the metadata attribute", 
            "date_created": "2013-12-03 23:54:45.806243+00:00", 
            "author": "https://api.launchpad.net/1.0/~sorrison"
        }, 
        {
            "content": "OK no this is reproducible, it was due to my pdb debugging and accidentally lazy loading the metadata attribute.\n\nTo me this looks like a bug in obj_to_primitive where lazy loaded attributes don't make it in", 
            "date_created": "2013-12-04 00:02:55.035781+00:00", 
            "author": "https://api.launchpad.net/1.0/~sorrison"
        }, 
        {
            "content": "Sam, you opened this on 12/3, there were major objects bugs fixed since then, so I'm wondering if this (and the patches in the related bug(s)) resolve it for you now?\n\nhttps://review.openstack.org/#/c/58398/", 
            "date_created": "2013-12-16 17:20:57.628747+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This bug lacks the necessary information to effectively reproduce and fix it, therefore it has been closed. Feel free to reopen the bug by providing the requested information and set the bug status back to ''New''.", 
            "date_created": "2014-03-14 14:26:36.128426+00:00", 
            "author": "https://api.launchpad.net/1.0/~danms"
        }
    ], 
    "closed": "2014-03-14 14:26:38.209180+00:00"
}