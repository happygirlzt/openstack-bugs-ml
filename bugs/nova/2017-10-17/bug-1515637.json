{
    "status": "Fix Released", 
    "last_updated": "2016-01-21 13:44:00.935499+00:00", 
    "description": "If volume in 'detaching'  state and detach operation is called nova-api fails:\n\n2015-11-10 05:18:19.253 ERROR nova.api.openstack.extensions [req-05889195-e70d-4761-a5c6-a69ddfe05d62 tempest-ServerActionsTestJSON-653602906 tempest-ServerActionsTestJSON-743378399] Unexpected exception in API method\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions Traceback (most recent call last):\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/volumes.py\", line 395, in delete\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     self.compute_api.detach_volume(context, instance, volume)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 235, in wrapped\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return func(self, context, target, *args, **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 224, in inner\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return function(self, context, instance, *args, **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 205, in inner\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return f(self, context, instance, *args, **kw)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 3098, in detach_volume\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     self._detach_volume(context, instance, volume)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 3080, in _detach_volume\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     self.volume_api.begin_detaching(context, volume['id'])\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/volume/cinder.py\", line 235, in wrapper\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     six.reraise(exc_value, None, exc_trace)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/volume/cinder.py\", line 224, in wrapper\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     res = method(self, ctx, volume_id, *args, **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/volume/cinder.py\", line 335, in begin_detaching\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     cinderclient(context).volumes.begin_detaching(volume_id)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/cinderclient/v2/volumes.py\", line 454, in begin_detaching\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return self._action('os-begin_detaching', volume)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/cinderclient/v2/volumes.py\", line 402, in _action\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return self.api.client.post(url, body=body)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/cinderclient/client.py\", line 104, in post\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return self._cs_request(url, 'POST', **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/cinderclient/client.py\", line 98, in _cs_request\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return self.request(url, method, **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/cinderclient/client.py\", line 91, in request\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     raise exceptions.from_response(resp, body)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions InvalidInput: Invalid input received: Invalid volume: Unable to detach volume. Volume status must be 'in-use' and attach_status must be 'attached' to detach. Currently: status: 'detaching', attach_status: 'attached.' (HTTP 400) (Request-ID: req-f91e3713-7538-4285-af29-bfa7dbdbb2ab)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions\n\nIt could be easily reproduced with two consecutive detach volume operations.", 
    "tags": [
        "api", 
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1515637", 
    "owner": "https://api.launchpad.net/1.0/~mhorban", 
    "id": 1515637, 
    "index": 7114, 
    "openned": "2015-11-12 14:14:09.902434+00:00", 
    "created": "2015-11-12 14:14:09.902434+00:00", 
    "title": "Double detach volume causes server fault", 
    "comments": [
        {
            "content": "If volume in 'detaching'  state and detach operation is called nova-api fails:\n\n2015-11-10 05:18:19.253 ERROR nova.api.openstack.extensions [req-05889195-e70d-4761-a5c6-a69ddfe05d62 tempest-ServerActionsTestJSON-653602906 tempest-ServerActionsTestJSON-743378399] Unexpected exception in API method\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions Traceback (most recent call last):\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/volumes.py\", line 395, in delete\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     self.compute_api.detach_volume(context, instance, volume)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 235, in wrapped\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return func(self, context, target, *args, **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 224, in inner\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return function(self, context, instance, *args, **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 205, in inner\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return f(self, context, instance, *args, **kw)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 3098, in detach_volume\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     self._detach_volume(context, instance, volume)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 3080, in _detach_volume\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     self.volume_api.begin_detaching(context, volume['id'])\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/volume/cinder.py\", line 235, in wrapper\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     six.reraise(exc_value, None, exc_trace)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/volume/cinder.py\", line 224, in wrapper\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     res = method(self, ctx, volume_id, *args, **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/volume/cinder.py\", line 335, in begin_detaching\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     cinderclient(context).volumes.begin_detaching(volume_id)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/cinderclient/v2/volumes.py\", line 454, in begin_detaching\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return self._action('os-begin_detaching', volume)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/cinderclient/v2/volumes.py\", line 402, in _action\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return self.api.client.post(url, body=body)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/cinderclient/client.py\", line 104, in post\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return self._cs_request(url, 'POST', **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/cinderclient/client.py\", line 98, in _cs_request\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     return self.request(url, method, **kwargs)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/cinderclient/client.py\", line 91, in request\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions     raise exceptions.from_response(resp, body)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions InvalidInput: Invalid input received: Invalid volume: Unable to detach volume. Volume status must be 'in-use' and attach_status must be 'attached' to detach. Currently: status: 'detaching', attach_status: 'attached.' (HTTP 400) (Request-ID: req-f91e3713-7538-4285-af29-bfa7dbdbb2ab)\n2015-11-10 05:18:19.253 TRACE nova.api.openstack.extensions\n\nIt could be easily reproduced with two consecutive detach volume operations.", 
            "date_created": "2015-11-12 14:14:09.902434+00:00", 
            "author": "https://api.launchpad.net/1.0/~mhorban"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/244683", 
            "date_created": "2015-11-12 14:35:20.718712+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/244683\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8217a94aa2027eecb84e9ef5638de1b1fcf9b305\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8217a94aa2027eecb84e9ef5638de1b1fcf9b305\nAuthor: Marian Horban <email address hidden>\nDate:   Tue Nov 10 03:49:48 2015 -0500\n\n    Double detach volume causes server fault\n    \n    InvalidInput exception was handled\n    \n    Change-Id: Ia339b8a7a7e03d62f1568f771c3e3c57fee77f96\n    Closes-Bug: #1515637\n", 
            "date_created": "2015-12-04 23:18:41.112468+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "We changed the release management from a \"delayed-release\" to a \n\"direct-release\" model [1]. It seems that the fix for this bug merged\nin the timeframe where we made the transition to the new model and \ntherefore wasn't closed with \"Fix-Released\" at it should be. \n=> Manually closing this bug with \"Fix-Released\".\n\n[1] \"openstack-dev\" ML, 2015-11-23, Doug Hellmann,\n    \"[release] process change for closing bugs when patches merge\"\n    http://lists.openstack.org/pipermail/openstack-dev/2015-November/080288.html", 
            "date_created": "2015-12-09 09:34:36.569558+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.0.0.0b2 development milestone.", 
            "date_created": "2016-01-21 13:44:00.481836+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }
    ], 
    "closed": "2015-12-09 09:34:19.670216+00:00"
}