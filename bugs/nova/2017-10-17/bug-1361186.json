{
    "status": "Fix Released", 
    "last_updated": "2015-11-19 21:49:04.996659+00:00", 
    "description": "Nova service-delete fails for services on non-child (top) cell.\n\nHow to reproduce:\n\n$ nova --os-username admin service-list\n\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| Id             | Binary           | Host                | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| region!child@1 | nova-conductor   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:06:56.000000 | -               |\n| region!child@2 | nova-compute     | region!child@ubuntu | nova     | enabled | up    | 2014-08-18T06:06:55.000000 | -               |\n| region!child@3 | nova-cells       | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:06:59.000000 | -               |\n| region!child@4 | nova-scheduler   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:06:50.000000 | -               |\n| region@1       | nova-cells       | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:06:59.000000 | -               |\n| region@2       | nova-cert        | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:06:58.000000 | -               |\n| region@3       | nova-consoleauth | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:06:57.000000 | -               |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n\nStop one of the services on top cell (e.g. nova-cert).\n\n$ nova --os-username admin service-list\n\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| Id             | Binary           | Host                | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| region!child@1 | nova-conductor   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:09:26.000000 | -               |\n| region!child@2 | nova-compute     | region!child@ubuntu | nova     | enabled | up    | 2014-08-18T06:09:25.000000 | -               |\n| region!child@3 | nova-cells       | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:09:19.000000 | -               |\n| region!child@4 | nova-scheduler   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:09:20.000000 | -               |\n| region@1       | nova-cells       | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:09:19.000000 | -               |\n| region@2       | nova-cert        | region@ubuntu       | internal | enabled | down  | 2014-08-18T06:08:28.000000 | -               |\n| region@3       | nova-consoleauth | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:09:27.000000 | -               |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n\nNova service-delete:\n$ nova --os-username admin service-delete 'region@2'\n\nCheck the request id from nova-api.log:\n\n2014-08-18 15:10:23.491 INFO nova.osapi_compute.wsgi.server [req-e134d915-ad66-41ba-a6f8-33ec51b7daee admin demo] 192.168.101.31 \"DELETE /v2/d66804d2e78549cd8f5efcedd0abecb2/os-services/region@2 HTTP/1.1\" status: 204 len: 179 time: 0.1334069\n\nError log in n-cell-region service:\n\n2014-08-18 15:10:23.464 ERROR nova.cells.messaging [req-e134d915-ad66-41ba-a6f8-33ec51b7daee admin demo] Error locating next hop for message: 'NoneType' object has no attribute 'count'\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging Traceback (most recent call last):\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/cells/messaging.py\", line 406, in process\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging     next_hop = self._get_next_hop()\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/cells/messaging.py\", line 361, in _get_next_hop\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging     dest_hops = target_cell.count(_PATH_CELL_SEP)\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging AttributeError: 'NoneType' object has no attribute 'count'\n\n\nAppendix:\nIn case of services on child cell, no issues.\n\n$ nova --os-username admin service-list\n\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| Id             | Binary           | Host                | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| region!child@1 | nova-conductor   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:14:46.000000 | -               |\n| region!child@2 | nova-compute     | region!child@ubuntu | nova     | enabled | down  | 2014-08-18T06:13:15.000000 | -               |\n| region!child@3 | nova-cells       | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:14:49.000000 | -               |\n| region!child@4 | nova-scheduler   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:14:50.000000 | -               |\n| region@1       | nova-cells       | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:14:49.000000 | -               |\n| region@2       | nova-cert        | region@ubuntu       | internal | enabled | down  | 2014-08-18T06:08:28.000000 | -               |\n| region@3       | nova-consoleauth | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:14:47.000000 | -               |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n\nDelete child cell service:\n$ nova --os-username admin service-delete 'region!child@2'\n\n$ nova --os-username admin service-list\n\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| Id             | Binary           | Host                | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| region!child@1 | nova-conductor   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:15:46.000000 | -               |\n| region!child@3 | nova-cells       | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:15:39.000000 | -               |\n| region!child@4 | nova-scheduler   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:15:40.000000 | -               |\n| region@1       | nova-cells       | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:15:39.000000 | -               |\n| region@2       | nova-cert        | region@ubuntu       | internal | enabled | down  | 2014-08-18T06:08:28.000000 | -               |\n| region@3       | nova-consoleauth | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:15:47.000000 | -               |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+", 
    "tags": [
        "cells", 
        "ntt"
    ], 
    "importance": "Medium", 
    "heat": 34, 
    "link": "https://bugs.launchpad.net/nova/+bug/1361186", 
    "owner": "https://api.launchpad.net/1.0/~sdague", 
    "id": 1361186, 
    "index": 4003, 
    "openned": "2014-08-25 12:30:33.977371+00:00", 
    "created": "2014-08-25 12:30:33.977371+00:00", 
    "title": "nova service-delete fails for services on non-child (top) cell", 
    "comments": [
        {
            "content": "Nova service-delete fails for services on non-child (top) cell.\n\nHow to reproduce:\n\n$ nova --os-username admin service-list\n\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| Id             | Binary           | Host                | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| region!child@1 | nova-conductor   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:06:56.000000 | -               |\n| region!child@2 | nova-compute     | region!child@ubuntu | nova     | enabled | up    | 2014-08-18T06:06:55.000000 | -               |\n| region!child@3 | nova-cells       | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:06:59.000000 | -               |\n| region!child@4 | nova-scheduler   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:06:50.000000 | -               |\n| region@1       | nova-cells       | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:06:59.000000 | -               |\n| region@2       | nova-cert        | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:06:58.000000 | -               |\n| region@3       | nova-consoleauth | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:06:57.000000 | -               |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n\nStop one of the services on top cell (e.g. nova-cert).\n\n$ nova --os-username admin service-list\n\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| Id             | Binary           | Host                | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| region!child@1 | nova-conductor   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:09:26.000000 | -               |\n| region!child@2 | nova-compute     | region!child@ubuntu | nova     | enabled | up    | 2014-08-18T06:09:25.000000 | -               |\n| region!child@3 | nova-cells       | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:09:19.000000 | -               |\n| region!child@4 | nova-scheduler   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:09:20.000000 | -               |\n| region@1       | nova-cells       | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:09:19.000000 | -               |\n| region@2       | nova-cert        | region@ubuntu       | internal | enabled | down  | 2014-08-18T06:08:28.000000 | -               |\n| region@3       | nova-consoleauth | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:09:27.000000 | -               |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n\nNova service-delete:\n$ nova --os-username admin service-delete 'region@2'\n\nCheck the request id from nova-api.log:\n\n2014-08-18 15:10:23.491 INFO nova.osapi_compute.wsgi.server [req-e134d915-ad66-41ba-a6f8-33ec51b7daee admin demo] 192.168.101.31 \"DELETE /v2/d66804d2e78549cd8f5efcedd0abecb2/os-services/region@2 HTTP/1.1\" status: 204 len: 179 time: 0.1334069\n\nError log in n-cell-region service:\n\n2014-08-18 15:10:23.464 ERROR nova.cells.messaging [req-e134d915-ad66-41ba-a6f8-33ec51b7daee admin demo] Error locating next hop for message: 'NoneType' object has no attribute 'count'\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging Traceback (most recent call last):\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/cells/messaging.py\", line 406, in process\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging     next_hop = self._get_next_hop()\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/cells/messaging.py\", line 361, in _get_next_hop\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging     dest_hops = target_cell.count(_PATH_CELL_SEP)\n2014-08-18 15:10:23.464 TRACE nova.cells.messaging AttributeError: 'NoneType' object has no attribute 'count'\n\n\nAppendix:\nIn case of services on child cell, no issues.\n\n$ nova --os-username admin service-list\n\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| Id             | Binary           | Host                | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| region!child@1 | nova-conductor   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:14:46.000000 | -               |\n| region!child@2 | nova-compute     | region!child@ubuntu | nova     | enabled | down  | 2014-08-18T06:13:15.000000 | -               |\n| region!child@3 | nova-cells       | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:14:49.000000 | -               |\n| region!child@4 | nova-scheduler   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:14:50.000000 | -               |\n| region@1       | nova-cells       | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:14:49.000000 | -               |\n| region@2       | nova-cert        | region@ubuntu       | internal | enabled | down  | 2014-08-18T06:08:28.000000 | -               |\n| region@3       | nova-consoleauth | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:14:47.000000 | -               |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n\nDelete child cell service:\n$ nova --os-username admin service-delete 'region!child@2'\n\n$ nova --os-username admin service-list\n\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| Id             | Binary           | Host                | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+\n| region!child@1 | nova-conductor   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:15:46.000000 | -               |\n| region!child@3 | nova-cells       | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:15:39.000000 | -               |\n| region!child@4 | nova-scheduler   | region!child@ubuntu | internal | enabled | up    | 2014-08-18T06:15:40.000000 | -               |\n| region@1       | nova-cells       | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:15:39.000000 | -               |\n| region@2       | nova-cert        | region@ubuntu       | internal | enabled | down  | 2014-08-18T06:08:28.000000 | -               |\n| region@3       | nova-consoleauth | region@ubuntu       | internal | enabled | up    | 2014-08-18T06:15:47.000000 | -               |\n+----------------+------------------+---------------------+----------+---------+-------+----------------------------+-----------------+", 
            "date_created": "2014-08-25 12:30:33.977371+00:00", 
            "author": "https://api.launchpad.net/1.0/~rajesh-tailor"
        }, 
        {
            "content": "To my mind, this bug occurs because both cases \n1. When a service is to be deleted at the top level\n2. Deletion has to be initiated at the top level (A nova service-delete command for instance)\nare handled by the same function in the nova.compute.cells_api.HostAPI method\n\ndef service_delete(self, context, service_id):\n        \"\"\"Deletes the specified service.\"\"\"\n        self.cells_rpcapi.service_delete(context, service_id)\n\nThe method does the correct thing when the command is executed/initiated - Strips the cellname and service name and forwards the message to the concerned cell. The target cell on receiving the message calls appropriate method in nova.cells.messaging._TargetedMessageMethods \n\ndef service_delete(self, message, service_id):\n        \"\"\"Deletes the specified service.\"\"\"\n        self.host_api.service_delete(message.ctxt, service_id)\n\nFor child cells this is fine since self.host_api points to nova.compute.HostAPI but for an API cell the self.host_api is nova.compute.cells_api.HostAPI which initiated the message in the first place. The top level cell thus has no way of knowing that the user wants to delete a service on _this_ cell and forwards the request (like it did in the beginning).\n\nAs an example,If the service ID to delete is 'toplevel@4' i.e. in API cell, the API cell splits out the cell and service using cells.utils function and gets cell_name:toplevel, service_id:4. It then forwards the message to itself. On receiving this message it only gets service_id:4 and (again), tries to split it for forwarding. Now spliting returns a cell_name: None and hence the eroor occurs while trying to route the message.\n\nThe same problem exists in service_update method too.", 
            "date_created": "2014-08-26 14:56:52.924534+00:00", 
            "author": "https://api.launchpad.net/1.0/~dheeraj-gupta4"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/118674", 
            "date_created": "2014-09-03 16:03:55.388700+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/126851", 
            "date_created": "2014-10-08 09:46:45.509242+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Rajesh Tailor (<email address hidden>) on branch: master\nReview: https://review.openstack.org/118674\nReason: Similar patch has submitted to address this issue.\nplease refer: https://review.openstack.org/#/c/126851/", 
            "date_created": "2014-10-10 06:58:28.712537+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/126851\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b0feaba45ff53d20a93bc4b29936d13550d15bf6\nSubmitter: Jenkins\nBranch:    master\n\ncommit b0feaba45ff53d20a93bc4b29936d13550d15bf6\nAuthor: Dheeraj Gupta <email address hidden>\nDate:   Wed Oct 8 09:24:18 2014 +0000\n\n    Make service-delete work in API cells\n    \n    nova service-delete is handled by HostAPI.service_delete method.\n    Normally, it searches for relevant Service object in DB and calls\n    destroy() on it. However, in API cell it is over-ridden so that\n    service_delete message can be routed to appropriate cell. Once the\n    destination cell is reached, the message processor invokes\n    HostAPI.service_delete to perform the actual delete. This works in\n    case of child cells.\n    However in case of API cells, since HostAPI.service_delete has been\n    over-ridden, when the message processor invokes HostAPI.service_delete\n    to perform actual delete of the service, the API cell tries to again\n    route the message and fails in doing so with an AttributeError (as\n    the message is already at the destination cell and can not be further\n    routed).\n    This patch moves the object destroy() call to a separate function and\n    modifies the message processor to call the new function. The original\n    service_delete is modified to also call the new function.\n    \n    Change-Id: I9148d8ceb5cdeb858dc9741b24cf0e03487c9a62\n    Closes-Bug: 1361186\n", 
            "date_created": "2015-01-15 18:18:15.728356+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/147844", 
            "date_created": "2015-01-16 13:37:39.222031+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/147844\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3212242fc36ea501fb1d118c380f3e9c9105ec3a\nSubmitter: Jenkins\nBranch:    stable/juno\n\ncommit 3212242fc36ea501fb1d118c380f3e9c9105ec3a\nAuthor: Dheeraj Gupta <email address hidden>\nDate:   Wed Oct 8 09:24:18 2014 +0000\n\n    Make service-delete work in API cells\n    \n    nova service-delete is handled by HostAPI.service_delete method.\n    Normally, it searches for relevant Service object in DB and calls\n    destroy() on it. However, in API cell it is over-ridden so that\n    service_delete message can be routed to appropriate cell. Once the\n    destination cell is reached, the message processor invokes\n    HostAPI.service_delete to perform the actual delete. This works in\n    case of child cells.\n    However in case of API cells, since HostAPI.service_delete has been\n    over-ridden, when the message processor invokes HostAPI.service_delete\n    to perform actual delete of the service, the API cell tries to again\n    route the message and fails in doing so with an AttributeError (as\n    the message is already at the destination cell and can not be further\n    routed).\n    This patch moves the object destroy() call to a separate function and\n    modifies the message processor to call the new function. The original\n    service_delete is modified to also call the new function.\n    \n    Change-Id: I9148d8ceb5cdeb858dc9741b24cf0e03487c9a62\n    Closes-Bug: 1361186\n    (cherry picked from commit b0feaba45ff53d20a93bc4b29936d13550d15bf6)\n", 
            "date_created": "2015-07-20 22:44:51.283316+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-02-05 20:23:00.000954+00:00"
}