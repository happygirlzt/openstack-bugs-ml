{
    "status": "Fix Released", 
    "last_updated": "2011-04-15 08:32:54.036039+00:00", 
    "description": "When launching an instance using 2011.2~bzr757 I get the instances failing to spawn due to SQL syntax error:\n\n2011-03-03 10:19:08,357 DEBUG nova.utils [-] Running cmd (subprocess): qemu-img create -f qcow2 -o cluster_size=2M,backing_file=/var/lib/nova/instances/_base/ami-reey5wk5_sm /var/lib/nova/instances/instance-0000002a/disk from (pid=1327) execute /usr/lib/pymodules/python2.6/nova/utils.py:132\n2011-03-03 10:19:08,441 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 116, in _wrap\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/libvirt_conn.py\", line 410, in spawn\n(nova.exception): TRACE:     self._create_image(instance, xml)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/libvirt_conn.py\", line 610, in _create_image\n(nova.exception): TRACE:     type_data = instance_types.get_instance_type([inst['instance_type']])\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/instance_types.py\", line 110, in get_instance_type\n(nova.exception): TRACE:     inst_type = db.instance_type_get_by_name(ctxt, name)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/db/api.py\", line 1025, in instance_type_get_by_name\n(nova.exception): TRACE:     return IMPL.instance_type_get_by_name(context, name)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/db/sqlalchemy/api.py\", line 108, in wrapper\n(nova.exception): TRACE:     return f(*args, **kwargs)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/db/sqlalchemy/api.py\", line 2119, in instance_type_get_by_name\n(nova.exception): TRACE:     filter_by(name=name).\\\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1496, in first\n(nova.exception): TRACE:     ret = list(self[0:1])\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1405, in __getitem__\n(nova.exception): TRACE:     return list(res)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1565, in __iter__\n(nova.exception): TRACE:     return self._execute_and_instances(context)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1570, in _execute_and_instances\n(nova.exception): TRACE:     mapper=self._mapper_zero_or_none())\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 735, in execute\n(nova.exception): TRACE:     clause, params or {})\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1157, in execute\n(nova.exception): TRACE:     params)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n(nova.exception): TRACE:     return self.__execute_context(context)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n(nova.exception): TRACE:     context.parameters[0], context=context)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n(nova.exception): TRACE:     context)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n(nova.exception): TRACE:     context)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/default.py\", line 288, in do_execute\n(nova.exception): TRACE:     cursor.execute(statement, parameters)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/MySQLdb/cursors.py\", line 166, in execute\n(nova.exception): TRACE:     self.errorhandler(self, exc, value)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/MySQLdb/connections.py\", line 35, in defaulterrorhandler\n(nova.exception): TRACE:     raise errorclass, errorvalue\n(nova.exception): TRACE: ProgrammingError: (ProgrammingError) (1064, \"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ') \\n LIMIT 0, 1' at line 3\") 'SELECT instance_types.created_at AS instance_types_created_at, instance_types.updated_at AS instance_types_updated_at, instance_types.deleted_at AS instance_types_deleted_at, instance_types.deleted AS instance_types_deleted, instance_types.id AS instance_types_id, instance_types.name AS instance_types_name, instance_types.memory_mb AS instance_types_memory_mb, instance_types.vcpus AS instance_types_vcpus, instance_types.local_gb AS instance_types_local_gb, instance_types.flavorid AS instance_types_flavorid, instance_types.swap AS instance_types_swap, instance_types.rxtx_quota AS instance_types_rxtx_quota, instance_types.rxtx_cap AS instance_types_rxtx_cap \\nFROM instance_types \\nWHERE instance_types.name = %s \\n LIMIT 0, 1' (['m1.tiny'],)\n(nova.exception): TRACE: \n2011-03-03 10:19:08,481 ERROR nova.compute.manager [X56G6NWZ7B0FTO62PJE4 kevinj myproject] instance 42: Failed to spawn\n(nova.compute.manager): TRACE: Traceback (most recent call last):\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 213, in run_instance\n(nova.compute.manager): TRACE:     self.driver.spawn(instance_ref)\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 122, in _wrap\n(nova.compute.manager): TRACE:     raise Error(str(e))\n(nova.compute.manager): TRACE: Error: (ProgrammingError) (1064, \"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ') \\n LIMIT 0, 1' at line 3\") 'SELECT instance_types.created_at AS instance_types_created_at, instance_types.updated_at AS instance_types_updated_at, instance_types.deleted_at AS instance_types_deleted_at, instance_types.deleted AS instance_types_deleted, instance_types.id AS instance_types_id, instance_types.name AS instance_types_name, instance_types.memory_mb AS instance_types_memory_mb, instance_types.vcpus AS instance_types_vcpus, instance_types.local_gb AS instance_types_local_gb, instance_types.flavorid AS instance_types_flavorid, instance_types.swap AS instance_types_swap, instance_types.rxtx_quota AS instance_types_rxtx_quota, instance_types.rxtx_cap AS instance_types_rxtx_cap \\nFROM instance_types \\nWHERE instance_types.name = %s \\n LIMIT 0, 1' (['m1.tiny'],)", 
    "tags": [], 
    "importance": "Critical", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/728342", 
    "owner": "https://api.launchpad.net/1.0/~ttx", 
    "id": 728342, 
    "index": 14, 
    "openned": "2011-03-03 10:30:07.540577+00:00", 
    "created": "2011-03-03 10:30:07.540577+00:00", 
    "title": "Regression prevents to start any instance through libvirt", 
    "comments": [
        {
            "content": "When launching an instance using 2011.2~bzr757 I get the instances failing to spawn due to SQL syntax error:\n\n2011-03-03 10:19:08,357 DEBUG nova.utils [-] Running cmd (subprocess): qemu-img create -f qcow2 -o cluster_size=2M,backing_file=/var/lib/nova/instances/_base/ami-reey5wk5_sm /var/lib/nova/instances/instance-0000002a/disk from (pid=1327) execute /usr/lib/pymodules/python2.6/nova/utils.py:132\n2011-03-03 10:19:08,441 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 116, in _wrap\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/libvirt_conn.py\", line 410, in spawn\n(nova.exception): TRACE:     self._create_image(instance, xml)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/libvirt_conn.py\", line 610, in _create_image\n(nova.exception): TRACE:     type_data = instance_types.get_instance_type([inst['instance_type']])\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/instance_types.py\", line 110, in get_instance_type\n(nova.exception): TRACE:     inst_type = db.instance_type_get_by_name(ctxt, name)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/db/api.py\", line 1025, in instance_type_get_by_name\n(nova.exception): TRACE:     return IMPL.instance_type_get_by_name(context, name)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/db/sqlalchemy/api.py\", line 108, in wrapper\n(nova.exception): TRACE:     return f(*args, **kwargs)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/db/sqlalchemy/api.py\", line 2119, in instance_type_get_by_name\n(nova.exception): TRACE:     filter_by(name=name).\\\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1496, in first\n(nova.exception): TRACE:     ret = list(self[0:1])\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1405, in __getitem__\n(nova.exception): TRACE:     return list(res)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1565, in __iter__\n(nova.exception): TRACE:     return self._execute_and_instances(context)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1570, in _execute_and_instances\n(nova.exception): TRACE:     mapper=self._mapper_zero_or_none())\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 735, in execute\n(nova.exception): TRACE:     clause, params or {})\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1157, in execute\n(nova.exception): TRACE:     params)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n(nova.exception): TRACE:     return self.__execute_context(context)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n(nova.exception): TRACE:     context.parameters[0], context=context)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n(nova.exception): TRACE:     context)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n(nova.exception): TRACE:     context)\n(nova.exception): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/default.py\", line 288, in do_execute\n(nova.exception): TRACE:     cursor.execute(statement, parameters)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/MySQLdb/cursors.py\", line 166, in execute\n(nova.exception): TRACE:     self.errorhandler(self, exc, value)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/MySQLdb/connections.py\", line 35, in defaulterrorhandler\n(nova.exception): TRACE:     raise errorclass, errorvalue\n(nova.exception): TRACE: ProgrammingError: (ProgrammingError) (1064, \"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ') \\n LIMIT 0, 1' at line 3\") 'SELECT instance_types.created_at AS instance_types_created_at, instance_types.updated_at AS instance_types_updated_at, instance_types.deleted_at AS instance_types_deleted_at, instance_types.deleted AS instance_types_deleted, instance_types.id AS instance_types_id, instance_types.name AS instance_types_name, instance_types.memory_mb AS instance_types_memory_mb, instance_types.vcpus AS instance_types_vcpus, instance_types.local_gb AS instance_types_local_gb, instance_types.flavorid AS instance_types_flavorid, instance_types.swap AS instance_types_swap, instance_types.rxtx_quota AS instance_types_rxtx_quota, instance_types.rxtx_cap AS instance_types_rxtx_cap \\nFROM instance_types \\nWHERE instance_types.name = %s \\n LIMIT 0, 1' (['m1.tiny'],)\n(nova.exception): TRACE: \n2011-03-03 10:19:08,481 ERROR nova.compute.manager [X56G6NWZ7B0FTO62PJE4 kevinj myproject] instance 42: Failed to spawn\n(nova.compute.manager): TRACE: Traceback (most recent call last):\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 213, in run_instance\n(nova.compute.manager): TRACE:     self.driver.spawn(instance_ref)\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 122, in _wrap\n(nova.compute.manager): TRACE:     raise Error(str(e))\n(nova.compute.manager): TRACE: Error: (ProgrammingError) (1064, \"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ') \\n LIMIT 0, 1' at line 3\") 'SELECT instance_types.created_at AS instance_types_created_at, instance_types.updated_at AS instance_types_updated_at, instance_types.deleted_at AS instance_types_deleted_at, instance_types.deleted AS instance_types_deleted, instance_types.id AS instance_types_id, instance_types.name AS instance_types_name, instance_types.memory_mb AS instance_types_memory_mb, instance_types.vcpus AS instance_types_vcpus, instance_types.local_gb AS instance_types_local_gb, instance_types.flavorid AS instance_types_flavorid, instance_types.swap AS instance_types_swap, instance_types.rxtx_quota AS instance_types_rxtx_quota, instance_types.rxtx_cap AS instance_types_rxtx_cap \\nFROM instance_types \\nWHERE instance_types.name = %s \\n LIMIT 0, 1' (['m1.tiny'],)", 
            "date_created": "2011-03-03 10:30:07.540577+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-linuxservices"
        }, 
        {
            "content": "This would be wrong:\n\n=== modified file 'nova/virt/libvirt_conn.py'\n@@ -606,7 +607,7 @@\n                           user=user,\n                           project=project,\n                           size=size)\n-        type_data = instance_types.INSTANCE_TYPES[inst['instance_type']]\n+        type_data = instance_types.get_instance_type([inst['instance_type']])\n\nShould be:\ntype_data = instance_types.get_instance_type(inst['instance_type']) ??", 
            "date_created": "2011-03-03 11:31:12.541526+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "nova/virt/libvirt_conn.py already has that in line 610\n\n        self._cache_image(fn=self._fetch_image,\n    603                           target=basepath('disk'),\n    604                           fname=root_fname,\n    605                           cow=FLAGS.use_cow_images,\n    606                           image_id=disk_images['image_id'],\n    607                           user=user,\n    608                           project=project,\n    609                           size=size)\n    610         type_data = instance_types.get_instance_type([inst['instance_type']])\n\n-rw-r--r-- 1 root root 57239 2011-03-03 02:09 /usr/share/pyshared/nova/virt/libvirt_conn.py\n\n\n(Packages from PPA installed:\n\nDesired=Unknown/Install/Remove/Purge/Hold\n| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend\n|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)\n||/ Name                           Version                        Description\n+++-==============================-==============================-============================================================================\nii  nova-api                       2011.2~bzr757-0ubuntu0ppa1~mav OpenStack Compute - Nova - API frontend\nii  nova-common                    2011.2~bzr757-0ubuntu0ppa1~mav OpenStack Compute - Nova - common files\nii  nova-compute                   2011.2~bzr757-0ubuntu0ppa1~mav OpenStack Compute - Nova - compute node\nii  nova-network                   2011.2~bzr757-0ubuntu0ppa1~mav OpenStack Compute - Nova - Network thingamajig\nii  nova-objectstore               2011.2~bzr757-0ubuntu0ppa1~mav OpenStack Compute - Nova - object store\nii  nova-scheduler                 2011.2~bzr757-0ubuntu0ppa1~mav OpenStack Compute - Nova - Scheduler\n\n)", 
            "date_created": "2011-03-03 11:49:13.720262+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-linuxservices"
        }, 
        {
            "content": "nova/virt/libvirt_conn.py has the *erroneous* line at line 610 (the one with the extra pair of braces)", 
            "date_created": "2011-03-03 12:35:16.337355+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }
    ], 
    "closed": "2011-04-15 08:32:52.208065+00:00"
}