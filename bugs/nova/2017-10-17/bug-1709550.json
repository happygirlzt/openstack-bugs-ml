{
    "status": "Invalid", 
    "last_updated": "2017-09-05 08:28:46.468719+00:00", 
    "description": "Steps to reproduce\n==================\n1. Create instance with (for example) qemu as nova-compute backend.\n2. Change nova-compute backend to (for example) lxd.\n3. Restart nova-compute service\n\nExpected result\n===============\nI expected to see an error with something like this: \"You have to delete all your instances, which were created with old nova-compute driver. Use 'openstack server delete instance-name' on your controller node.\"\n\nActual result\n=============\nnova-compute service doesn't start and there is no clear explanation in nova-compute.log (see log below).\n\nEnvironment\n===========\n1. Version of OpenStack is Ocata:\nuser@compute ~> dpkg -l | grep nova\nrc  nova-api                                   2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - API frontend\nii  nova-common                                2:15.0.5-0ubuntu1~cloud0                     all          OpenStack Compute - common files\nii  nova-compute                               2:15.0.5-0ubuntu1~cloud0                     all          OpenStack Compute - compute node base\nrc  nova-compute-kvm                           2:15.0.5-0ubuntu1~cloud0                     all          OpenStack Compute - compute node (KVM)\nii  nova-compute-libvirt                       2:15.0.5-0ubuntu1~cloud0                     all          OpenStack Compute - compute node libvirt support\nii  nova-compute-lxd                           15.0.2-0ubuntu1~cloud0                       all          Openstack Compute - LXD container hypervisor support\nrc  nova-conductor                             2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - conductor service\nrc  nova-consoleauth                           2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - Console Authenticator\nrc  nova-novncproxy                            2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - NoVNC proxy\nrc  nova-placement-api                         2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - placement API frontend\nrc  nova-scheduler                             2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - virtual machine scheduler\nii  python-nova                                2:15.0.5-0ubuntu1~cloud0                     all          OpenStack Compute Python libraries\nii  python-nova-lxd                            15.0.2-0ubuntu1~cloud0                       all          OpenStack Compute Python libraries - LXD driver\nii  python-novaclient                          2:7.1.0-0ubuntu1~cloud0                      all          client library for OpenStack Compute API - Python 2.7\n\n\n2. Hypervisors: qemu and lxd\n\n3. Storage: lvm\n\n4. Networking type: Neutron with OpenVSwitch\n\nLog\n==============\nnova-compute.log:\n2017-08-08 16:18:51.112 29592 INFO nova.service [-] Starting compute node (version 15.0.5)\n2017-08-08 16:18:51.882 29592 INFO oslo.privsep.daemon [req-0777ab5e-8b64-4631-8690-3dcf94ab2118 - - - - -] Running privsep helper: ['sudo', 'nova-rootwrap', '/etc/nova/rootwrap.conf', 'privsep-helper', '--config-file', '/etc/nova/nova.conf', '--config-file', '/etc/nova/nova-compute.conf', '--privsep_context', 'vif_plug_linux_bridge.privsep.vif_plug', '--privsep_sock_path', '/tmp/tmpGK77AD/privsep.sock']\n2017-08-08 16:18:53.810 29592 INFO oslo.privsep.daemon [req-0777ab5e-8b64-4631-8690-3dcf94ab2118 - - - - -] Spawned new privsep daemon via rootwrap\n2017-08-08 16:18:53.812 29592 INFO oslo.privsep.daemon [-] privsep daemon starting\n2017-08-08 16:18:53.812 29592 INFO oslo.privsep.daemon [-] privsep process running with uid/gid: 0/0\n2017-08-08 16:18:53.813 29592 INFO oslo.privsep.daemon [-] privsep process running with capabilities (eff/prm/inh): CAP_NET_ADMIN/CAP_NET_ADMIN/none\n2017-08-08 16:18:53.813 29592 INFO oslo.privsep.daemon [-] privsep daemon running as pid 29634\n2017-08-08 16:18:53.957 29592 INFO os_vif [req-0777ab5e-8b64-4631-8690-3dcf94ab2118 - - - - -] Successfully plugged vif VIFBridge(active=True,address=fa:16:3e:ae:ba:06,bridge_name='brq3b3f3c75-8f',has_traffic_filtering=True,id=4a1e4eaa-17d3-4baa-a2c5-9f6a7369272c,network=Network(3b3f3c75-8f2b-4fe0-b91e-9c3dd53fe9ec),plugin='linux_bridge',port_profile=<?>,preserve_on_delete=False,vif_name='tap4a1e4eaa-17')\n2017-08-08 16:18:54.310 29592 INFO os_vif [req-0777ab5e-8b64-4631-8690-3dcf94ab2118 - - - - -] Successfully plugged vif VIFBridge(active=True,address=fa:16:3e:7e:a4:a1,bridge_name='brq3b3f3c75-8f',has_traffic_filtering=True,id=ae4b3102-ad58-474c-bfbf-da6b083eda9b,network=Network(3b3f3c75-8f2b-4fe0-b91e-9c3dd53fe9ec),plugin='linux_bridge',port_profile=<?>,preserve_on_delete=False,vif_name='tapae4b3102-ad')\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service [req-0777ab5e-8b64-4631-8690-3dcf94ab2118 - - - - -] Error starting thread.\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service Traceback (most recent call last):\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/oslo_service/service.py\", line 722, in run_service\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     service.start()\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 144, in start\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     self.manager.init_host()\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1152, in init_host\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     self._init_instance(context, instance)\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 862, in _init_instance\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     current_power_state = self._get_power_state(context, instance)\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1175, in _get_power_state\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     return self.driver.get_info(instance).state\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/virt/lxd/driver.py\", line 306, in get_info\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     container = self.client.containers.get(instance.name)\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/pylxd/models/container.py\", line 104, in get\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     response = client.api.containers[name].get()\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/pylxd/client.py\", line 103, in get\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     self._assert_response(response, stream=kwargs.get('stream', False))\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/pylxd/client.py\", line 68, in _assert_response\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     raise exceptions.NotFound(response)\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service NotFound: not found\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service", 
    "tags": [
        "lxd"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1709550", 
    "owner": "None", 
    "id": 1709550, 
    "index": 8245, 
    "openned": "2017-08-09 07:15:22.750568+00:00", 
    "created": "2017-08-09 07:15:22.750568+00:00", 
    "title": "nova-compute doesn't start if there is difference between current compute driver and driver which was used to create instance", 
    "comments": [
        {
            "content": "Steps to reproduce\n==================\n1. Create instance with (for example) qemu as nova-compute backend.\n2. Change nova-compute backend to (for example) lxd.\n3. Restart nova-compute service\n\nExpected result\n===============\nI expected to see an error with something like this: \"You have to delete all your instances, which were created with old nova-compute driver. Use 'openstack server delete instance-name' on your controller node.\"\n\nActual result\n=============\nnova-compute service doesn't start and there is no clear explanation in nova-compute.log (see log below).\n\nEnvironment\n===========\n1. Version of OpenStack is Ocata:\nuser@compute ~> dpkg -l | grep nova\nrc  nova-api                                   2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - API frontend\nii  nova-common                                2:15.0.5-0ubuntu1~cloud0                     all          OpenStack Compute - common files\nii  nova-compute                               2:15.0.5-0ubuntu1~cloud0                     all          OpenStack Compute - compute node base\nrc  nova-compute-kvm                           2:15.0.5-0ubuntu1~cloud0                     all          OpenStack Compute - compute node (KVM)\nii  nova-compute-libvirt                       2:15.0.5-0ubuntu1~cloud0                     all          OpenStack Compute - compute node libvirt support\nii  nova-compute-lxd                           15.0.2-0ubuntu1~cloud0                       all          Openstack Compute - LXD container hypervisor support\nrc  nova-conductor                             2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - conductor service\nrc  nova-consoleauth                           2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - Console Authenticator\nrc  nova-novncproxy                            2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - NoVNC proxy\nrc  nova-placement-api                         2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - placement API frontend\nrc  nova-scheduler                             2:15.0.2-0ubuntu1~cloud0                     all          OpenStack Compute - virtual machine scheduler\nii  python-nova                                2:15.0.5-0ubuntu1~cloud0                     all          OpenStack Compute Python libraries\nii  python-nova-lxd                            15.0.2-0ubuntu1~cloud0                       all          OpenStack Compute Python libraries - LXD driver\nii  python-novaclient                          2:7.1.0-0ubuntu1~cloud0                      all          client library for OpenStack Compute API - Python 2.7\n\n\n2. Hypervisors: qemu and lxd\n\n3. Storage: lvm\n\n4. Networking type: Neutron with OpenVSwitch\n\nLog\n==============\nnova-compute.log:\n2017-08-08 16:18:51.112 29592 INFO nova.service [-] Starting compute node (version 15.0.5)\n2017-08-08 16:18:51.882 29592 INFO oslo.privsep.daemon [req-0777ab5e-8b64-4631-8690-3dcf94ab2118 - - - - -] Running privsep helper: ['sudo', 'nova-rootwrap', '/etc/nova/rootwrap.conf', 'privsep-helper', '--config-file', '/etc/nova/nova.conf', '--config-file', '/etc/nova/nova-compute.conf', '--privsep_context', 'vif_plug_linux_bridge.privsep.vif_plug', '--privsep_sock_path', '/tmp/tmpGK77AD/privsep.sock']\n2017-08-08 16:18:53.810 29592 INFO oslo.privsep.daemon [req-0777ab5e-8b64-4631-8690-3dcf94ab2118 - - - - -] Spawned new privsep daemon via rootwrap\n2017-08-08 16:18:53.812 29592 INFO oslo.privsep.daemon [-] privsep daemon starting\n2017-08-08 16:18:53.812 29592 INFO oslo.privsep.daemon [-] privsep process running with uid/gid: 0/0\n2017-08-08 16:18:53.813 29592 INFO oslo.privsep.daemon [-] privsep process running with capabilities (eff/prm/inh): CAP_NET_ADMIN/CAP_NET_ADMIN/none\n2017-08-08 16:18:53.813 29592 INFO oslo.privsep.daemon [-] privsep daemon running as pid 29634\n2017-08-08 16:18:53.957 29592 INFO os_vif [req-0777ab5e-8b64-4631-8690-3dcf94ab2118 - - - - -] Successfully plugged vif VIFBridge(active=True,address=fa:16:3e:ae:ba:06,bridge_name='brq3b3f3c75-8f',has_traffic_filtering=True,id=4a1e4eaa-17d3-4baa-a2c5-9f6a7369272c,network=Network(3b3f3c75-8f2b-4fe0-b91e-9c3dd53fe9ec),plugin='linux_bridge',port_profile=<?>,preserve_on_delete=False,vif_name='tap4a1e4eaa-17')\n2017-08-08 16:18:54.310 29592 INFO os_vif [req-0777ab5e-8b64-4631-8690-3dcf94ab2118 - - - - -] Successfully plugged vif VIFBridge(active=True,address=fa:16:3e:7e:a4:a1,bridge_name='brq3b3f3c75-8f',has_traffic_filtering=True,id=ae4b3102-ad58-474c-bfbf-da6b083eda9b,network=Network(3b3f3c75-8f2b-4fe0-b91e-9c3dd53fe9ec),plugin='linux_bridge',port_profile=<?>,preserve_on_delete=False,vif_name='tapae4b3102-ad')\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service [req-0777ab5e-8b64-4631-8690-3dcf94ab2118 - - - - -] Error starting thread.\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service Traceback (most recent call last):\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/oslo_service/service.py\", line 722, in run_service\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     service.start()\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 144, in start\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     self.manager.init_host()\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1152, in init_host\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     self._init_instance(context, instance)\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 862, in _init_instance\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     current_power_state = self._get_power_state(context, instance)\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1175, in _get_power_state\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     return self.driver.get_info(instance).state\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/nova/virt/lxd/driver.py\", line 306, in get_info\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     container = self.client.containers.get(instance.name)\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/pylxd/models/container.py\", line 104, in get\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     response = client.api.containers[name].get()\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/pylxd/client.py\", line 103, in get\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     self._assert_response(response, stream=kwargs.get('stream', False))\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service   File \"/usr/lib/python2.7/dist-packages/pylxd/client.py\", line 68, in _assert_response\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service     raise exceptions.NotFound(response)\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service NotFound: not found\n2017-08-08 16:18:54.408 29592 ERROR oslo_service.service", 
            "date_created": "2017-08-09 07:15:22.750568+00:00", 
            "author": "https://api.launchpad.net/1.0/~deponian"
        }, 
        {
            "content": "This is a bug in the nova-lxd driver code, which manages bugs through some other launchpad project.", 
            "date_created": "2017-08-10 02:12:11.897231+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Tricky one this as the main nova driver has no knowledge of the nova-lxd driver (and as a result can interrogate the LXD daemon to figure things out).\n\nI'm pretty sure that this is an issue that's common to any of the drivers in Nova as well; it you can the driver after spinning up instances, you effectively island control of an instances created with the previous driver.", 
            "date_created": "2017-09-05 08:27:37.343218+00:00", 
            "author": "https://api.launchpad.net/1.0/~james-page"
        }, 
        {
            "content": "I'm marking this as Triaged and Low; I'm not sure how much we can realistically do being and out-of-tree driver, but this at least leaves a bug trail for anyone else tripping over this problem.", 
            "date_created": "2017-09-05 08:28:45.931034+00:00", 
            "author": "https://api.launchpad.net/1.0/~james-page"
        }
    ], 
    "closed": "2017-08-10 02:12:20.631791+00:00"
}