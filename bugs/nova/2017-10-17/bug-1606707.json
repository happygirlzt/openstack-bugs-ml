{
    "status": "Fix Released", 
    "last_updated": "2016-11-10 02:05:53.894689+00:00", 
    "description": "This is on a newton server deployed on 7/25 from master (newton).\n\nI set use_glance_v1=True in nova.conf on the compute node.\n\nI created a server from this image:\n\n+------------------+----------------------------------------------------------------------------------+\n| Property         | Value                                                                            |\n+------------------+----------------------------------------------------------------------------------+\n| checksum         | ee1eca47dc88f4879d8a229cc70a07c6                                                 |\n| container_format | bare                                                                             |\n| created_at       | 2016-07-06T17:25:08Z                                                             |\n| disk_format      | qcow2                                                                            |\n| id               | aac0314e-9bdf-4cee-a3d8-5f089008ea96                                             |\n| locations        | [{\"url\": \"file:///var/lib/glance/images/aac0314e-9bdf-4cee-a3d8-5f089008ea96\",   |\n|                  | \"metadata\": {}}]                                                                 |\n| min_disk         | 0                                                                                |\n| min_ram          | 0                                                                                |\n| name             | cirros                                                                           |\n| owner            | None                                                                             |\n| protected        | False                                                                            |\n| size             | 13287936                                                                         |\n| status           | active                                                                           |\n| tags             | []                                                                               |\n| updated_at       | 2016-07-06T17:25:09Z                                                             |\n| virtual_size     | None                                                                             |\n| visibility       | public                                                                           |\n+------------------+----------------------------------------------------------------------------------+\n\n\nI tried to snapshot the instance and it failed with this:\n\nhttp://paste.openstack.org/show/542180/\n\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd] Traceback (most recent call last):\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 231, in decorated_function\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     *args, **kwargs)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 3024, in snapshot_instance\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     task_states.IMAGE_SNAPSHOT)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 3054, in _snapshot_instance\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     update_task_state)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1482, in snapshot\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     snapshot = self._image_api.get(context, image_id)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/image/api.py\", line 93, in get\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     show_deleted=show_deleted)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/image/glance.py\", line 266, in show\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     include_locations=include_locations)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/image/glance.py\", line 878, in _translate_from_glance\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     image, include_locations=include_locations)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/image/glance.py\", line 968, in _extract_attributes\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     output[attr] = getattr(image, attr) or 0\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/glanceclient/openstack/common/apiclient/base.py\", line 491, in __getattr__\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     return self.__getattr__(k)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/glanceclient/openstack/common/apiclient/base.py\", line 493, in __getattr__\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     raise AttributeError(k)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd] AttributeError: size\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]\n\nLooking at that code, it looks like it assumes the 'size' attribute will be on the image, which it's not. Nova creates this image from the compute API:\n\nhttps://github.com/openstack/nova/blob/9326c1ed403477d627fa1b94e6937c99deed9ecd/nova/compute/api.py#L2165\n\nThe extra_properties in this case come from the REST API, and I'm not passing any in in my snapshot request.\n\nThe other properties come from the instance's system_metadata, of which image_size isn't set:\n\nmysql> select * from nova.instance_system_metadata where instance_uuid='85bcc918-4d00-4d21-82fe-65b13035adcd';\n+---------------------+------------+------------+----+--------------------------------------+------------------------+--------------------------------------+---------+\n| created_at          | updated_at | deleted_at | id | instance_uuid                        | key                    | value                                | deleted |\n+---------------------+------------+------------+----+--------------------------------------+------------------------+--------------------------------------+---------+\n| 2016-07-26 20:54:08 | NULL       | NULL       | 92 | 85bcc918-4d00-4d21-82fe-65b13035adcd | image_disk_format      | qcow2                                |       0 |\n| 2016-07-26 20:54:08 | NULL       | NULL       | 93 | 85bcc918-4d00-4d21-82fe-65b13035adcd | image_min_ram          | 0                                    |       0 |\n| 2016-07-26 20:54:08 | NULL       | NULL       | 94 | 85bcc918-4d00-4d21-82fe-65b13035adcd | image_min_disk         | 10                                   |       0 |\n| 2016-07-26 20:54:08 | NULL       | NULL       | 95 | 85bcc918-4d00-4d21-82fe-65b13035adcd | image_base_image_ref   | aac0314e-9bdf-4cee-a3d8-5f089008ea96 |       0 |\n| 2016-07-26 20:54:08 | NULL       | NULL       | 96 | 85bcc918-4d00-4d21-82fe-65b13035adcd | image_container_format | bare                                 |       0 |\n+---------------------+------------+------------+----+--------------------------------------+------------------------+--------------------------------------+---------+\n\nSo it looks like we shouldn't rely on image.size being set when using glance v1 and taking a snapshot.", 
    "tags": [
        "in-stable-mitaka", 
        "mitaka-backport-potential"
    ], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1606707", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1606707, 
    "index": 1954, 
    "openned": "2016-07-26 21:50:36.173982+00:00", 
    "created": "2016-07-26 21:50:36.173982+00:00", 
    "title": "instance snapshot fails with 'AttributeError: size' when using glance v1", 
    "comments": [
        {
            "content": "This is on a newton server deployed on 7/25 from master (newton).\n\nI set use_glance_v1=True in nova.conf on the compute node.\n\nI created a server from this image:\n\n+------------------+----------------------------------------------------------------------------------+\n| Property         | Value                                                                            |\n+------------------+----------------------------------------------------------------------------------+\n| checksum         | ee1eca47dc88f4879d8a229cc70a07c6                                                 |\n| container_format | bare                                                                             |\n| created_at       | 2016-07-06T17:25:08Z                                                             |\n| disk_format      | qcow2                                                                            |\n| id               | aac0314e-9bdf-4cee-a3d8-5f089008ea96                                             |\n| locations        | [{\"url\": \"file:///var/lib/glance/images/aac0314e-9bdf-4cee-a3d8-5f089008ea96\",   |\n|                  | \"metadata\": {}}]                                                                 |\n| min_disk         | 0                                                                                |\n| min_ram          | 0                                                                                |\n| name             | cirros                                                                           |\n| owner            | None                                                                             |\n| protected        | False                                                                            |\n| size             | 13287936                                                                         |\n| status           | active                                                                           |\n| tags             | []                                                                               |\n| updated_at       | 2016-07-06T17:25:09Z                                                             |\n| virtual_size     | None                                                                             |\n| visibility       | public                                                                           |\n+------------------+----------------------------------------------------------------------------------+\n\n\nI tried to snapshot the instance and it failed with this:\n\nhttp://paste.openstack.org/show/542180/\n\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd] Traceback (most recent call last):\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 231, in decorated_function\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     *args, **kwargs)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 3024, in snapshot_instance\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     task_states.IMAGE_SNAPSHOT)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 3054, in _snapshot_instance\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     update_task_state)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1482, in snapshot\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     snapshot = self._image_api.get(context, image_id)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/image/api.py\", line 93, in get\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     show_deleted=show_deleted)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/image/glance.py\", line 266, in show\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     include_locations=include_locations)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/image/glance.py\", line 878, in _translate_from_glance\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     image, include_locations=include_locations)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/nova/image/glance.py\", line 968, in _extract_attributes\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     output[attr] = getattr(image, attr) or 0\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/glanceclient/openstack/common/apiclient/base.py\", line 491, in __getattr__\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     return self.__getattr__(k)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]   File \"/opt/bbc/openstack-11.0-master/nova/local/lib/python2.7/site-packages/glanceclient/openstack/common/apiclient/base.py\", line 493, in __getattr__\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]     raise AttributeError(k)\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd] AttributeError: size\n2016-07-26 21:25:34.563 51383 ERROR nova.compute.manager [instance: 85bcc918-4d00-4d21-82fe-65b13035adcd]\n\nLooking at that code, it looks like it assumes the 'size' attribute will be on the image, which it's not. Nova creates this image from the compute API:\n\nhttps://github.com/openstack/nova/blob/9326c1ed403477d627fa1b94e6937c99deed9ecd/nova/compute/api.py#L2165\n\nThe extra_properties in this case come from the REST API, and I'm not passing any in in my snapshot request.\n\nThe other properties come from the instance's system_metadata, of which image_size isn't set:\n\nmysql> select * from nova.instance_system_metadata where instance_uuid='85bcc918-4d00-4d21-82fe-65b13035adcd';\n+---------------------+------------+------------+----+--------------------------------------+------------------------+--------------------------------------+---------+\n| created_at          | updated_at | deleted_at | id | instance_uuid                        | key                    | value                                | deleted |\n+---------------------+------------+------------+----+--------------------------------------+------------------------+--------------------------------------+---------+\n| 2016-07-26 20:54:08 | NULL       | NULL       | 92 | 85bcc918-4d00-4d21-82fe-65b13035adcd | image_disk_format      | qcow2                                |       0 |\n| 2016-07-26 20:54:08 | NULL       | NULL       | 93 | 85bcc918-4d00-4d21-82fe-65b13035adcd | image_min_ram          | 0                                    |       0 |\n| 2016-07-26 20:54:08 | NULL       | NULL       | 94 | 85bcc918-4d00-4d21-82fe-65b13035adcd | image_min_disk         | 10                                   |       0 |\n| 2016-07-26 20:54:08 | NULL       | NULL       | 95 | 85bcc918-4d00-4d21-82fe-65b13035adcd | image_base_image_ref   | aac0314e-9bdf-4cee-a3d8-5f089008ea96 |       0 |\n| 2016-07-26 20:54:08 | NULL       | NULL       | 96 | 85bcc918-4d00-4d21-82fe-65b13035adcd | image_container_format | bare                                 |       0 |\n+---------------------+------------+------------+----+--------------------------------------+------------------------+--------------------------------------+---------+\n\nSo it looks like we shouldn't rely on image.size being set when using glance v1 and taking a snapshot.", 
            "date_created": "2016-07-26 21:50:36.173982+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "If you change this line:\n\nhttps://github.com/openstack/nova/blob/9326c1ed403477d627fa1b94e6937c99deed9ecd/nova/image/glance.py#L968\n\nTo this:\n\n output[attr] = getattr(image, attr, 0) or 0\n\nIt works like a charm.", 
            "date_created": "2016-07-26 21:59:04.843729+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/347571", 
            "date_created": "2016-07-26 22:34:16.237774+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/347571\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7a16c754fb49615b802e6b8f3d886847c168bd2a\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7a16c754fb49615b802e6b8f3d886847c168bd2a\nAuthor: Matt Riedemann <email address hidden>\nDate:   Tue Jul 26 18:27:48 2016 -0400\n\n    Default image.size to 0 when extracting v1 image attributes\n    \n    When we snapshot a non-volume-backed instance, we create an\n    image in nova.compute.api.API._create_image and set some\n    values from the instance but 'size' isn't one of them.\n    \n    Later in the virt driver's snapshot method, at least for\n    libvirt, it gets the snapshot image from the image API (glance)\n    and when using glance v1 (use_glance_v1=True) the _extract_attributes\n    method in nova.image.glance pulls the attributes out of the v1 image\n    response to the form that nova expects. This code assumes that\n    the 'size' attribute is set on the image, which for a snapshot image\n    it might not be (yet anyway). This results in an AttributeError.\n    \n    This change defaults the size attribute value to 0 if it's not set.\n    If it is set, but to None, we still use 0 as before.\n    \n    Change-Id: I14b0e44a7268231c2b19f013b563f0b8f09c2e88\n    Closes-Bug: #1606707\n", 
            "date_created": "2016-08-03 11:20:55.197573+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/mitaka\nReview: https://review.openstack.org/359663", 
            "date_created": "2016-08-24 08:00:02.504778+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b3 development milestone.", 
            "date_created": "2016-09-02 01:15:27.982920+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/359663\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=056ab125c595aae42e60bb761a8324d9f245b1a4\nSubmitter: Jenkins\nBranch:    stable/mitaka\n\ncommit 056ab125c595aae42e60bb761a8324d9f245b1a4\nAuthor: Matt Riedemann <email address hidden>\nDate:   Tue Jul 26 18:27:48 2016 -0400\n\n    Default image.size to 0 when extracting v1 image attributes\n    \n    When we snapshot a non-volume-backed instance, we create an\n    image in nova.compute.api.API._create_image and set some\n    values from the instance but 'size' isn't one of them.\n    \n    Later in the virt driver's snapshot method, at least for\n    libvirt, it gets the snapshot image from the image API (glance)\n    and when using glance v1 (use_glance_v1=True) the _extract_attributes\n    method in nova.image.glance pulls the attributes out of the v1 image\n    response to the form that nova expects. This code assumes that\n    the 'size' attribute is set on the image, which for a snapshot image\n    it might not be (yet anyway). This results in an AttributeError.\n    \n    This change defaults the size attribute value to 0 if it's not set.\n    If it is set, but to None, we still use 0 as before.\n    \n    Conflicts:\n    \tnova/tests/unit/image/test_glance.py\n    \n    Original patch added test-case to TestExtractAttributes class,\n    but stable/mitaka doesn't have that class.\n    And that class used configurable value \"use_glance_v1\" that is\n    not contained in stable/mitaka.\n    So I added a test-case that tests fixed points to other existing\n    class.\n    \n    Change-Id: I14b0e44a7268231c2b19f013b563f0b8f09c2e88\n    Closes-Bug: #1606707\n    (cherry picked from commit 7a16c754fb49615b802e6b8f3d886847c168bd2a)\n", 
            "date_created": "2016-09-20 04:08:19.929256+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.1.2 release.", 
            "date_created": "2016-10-10 13:19:22.857722+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.1.2 release.", 
            "date_created": "2016-11-10 02:05:53.136062+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-08-03 11:20:51.302559+00:00"
}