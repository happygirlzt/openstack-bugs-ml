{
    "status": "Invalid", 
    "last_updated": "2016-03-07 11:04:56.625964+00:00", 
    "description": "I have a system with 32 cores (2 sockets, 8 cores, hyperthreading enabled).\nThe NUMA topology as follows:\n\nnumactl --hardware\n\navailable: 2 nodes (0-1)\nnode 0 cpus: 0 1 2 3 4 5 6 7 16 17 18 19 20 21 22 23\nnode 0 size: 65501 MB\nnode 0 free: 38562 MB\nnode 1 cpus: 8 9 10 11 12 13 14 15 24 25 26 27 28 29 30 31\nnode 1 size: 65535 MB\nnode 1 free: 63846 MB\nnode distances:\nnode   0   1\n\u00a0\u00a00:  10  20\n\u00a0\u00a01:  20  10\n\nI have defined an flavor in Openstack with 12 vcpus as follows:\nnova flavor-show c4.3xlarge\n+----------------------------+------------------------------------------------------+\n| Property                   | Value                                                |\n+----------------------------+------------------------------------------------------+\n| OS-FLV-DISABLED:disabled   | False                                                |\n| OS-FLV-EXT-DATA:ephemeral  | 0                                                    |\n| disk                       | 40                                                   |\n| extra_specs                | {\"hw:cpu_policy\": \"dedicated\", \"hw:numa_nodes\": \"1\"} |\n| id                         | 1d76a225-90c1-4f6f-a59b-000795c33e63                 |\n| name                       | c4.3xlarge                                           |\n| os-flavor-access:is_public | True                                                 |\n| ram                        | 24576                                                |\n| rxtx_factor                | 1.0                                                  |\n| swap                       | 8192                                                 |\n| vcpus                      | 12                                                   |\n+----------------------------+------------------------------------------------------+\n\nI expect to be able to launch two instances of this flavor on the 32 core host, one contained within each NUMA node.\n\nWhen I launch two instances, the first succeeds, but the second fails.  The instance xml is attached, along with the system capabilities.\n\nIf I change hw:numa_nodes = 2, then I can launch two copies of the instance.\n\nN.B for the purposes of testing I have disabled all vcpu_pin and isolcpu settings.\n\n\nThis was tested on RDO Kilo running on CentOS 7.\nI had to upgrade the hypervisor with packages from the ovirt master branch in order to support NUMA pinning.", 
    "tags": [
        "libvirt", 
        "numa"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1464286", 
    "owner": "https://api.launchpad.net/1.0/~stephenfinucane", 
    "id": 1464286, 
    "index": 1754, 
    "openned": "2015-06-11 14:50:02.310211+00:00", 
    "created": "2015-06-11 14:50:02.310211+00:00", 
    "title": "NumaTopololgyFilter Not behaving as expected (returns 0 hosts)", 
    "comments": [
        {
            "content": "I have a system with 32 cores (2 sockets, 8 cores, hyperthreading enabled).\nThe NUMA topology as follows:\n\nnumactl --hardware\n\navailable: 2 nodes (0-1)\nnode 0 cpus: 0 1 2 3 4 5 6 7 16 17 18 19 20 21 22 23\nnode 0 size: 65501 MB\nnode 0 free: 38562 MB\nnode 1 cpus: 8 9 10 11 12 13 14 15 24 25 26 27 28 29 30 31\nnode 1 size: 65535 MB\nnode 1 free: 63846 MB\nnode distances:\nnode   0   1 \n  0:  10  20 \n  1:  20  10 \n\nI have defined an flavor in Openstack with 12 vcpus as follows:\nnova flavor-show c4.3xlarge\n+----------------------------+------------------------------------------------------+\n| Property                   | Value                                                |\n+----------------------------+------------------------------------------------------+\n| OS-FLV-DISABLED:disabled   | False                                                |\n| OS-FLV-EXT-DATA:ephemeral  | 0                                                    |\n| disk                       | 40                                                   |\n| extra_specs                | {\"hw:cpu_policy\": \"dedicated\", \"hw:numa_nodes\": \"1\"} |\n| id                         | 1d76a225-90c1-4f6f-a59b-000795c33e63                 |\n| name                       | c4.3xlarge                                           |\n| os-flavor-access:is_public | True                                                 |\n| ram                        | 24576                                                |\n| rxtx_factor                | 1.0                                                  |\n| swap                       | 8192                                                 |\n| vcpus                      | 12                                                   |\n+----------------------------+------------------------------------------------------+\n\nI expect to be able to launch two instances of this flavor on the 32 core host, one contained within each NUMA node.\n\nWhen I launch two instances, the first succeeds, but the second fails.  The instance xml is attached, along with the system capabilities.\n\nIf I change hw:numa_nodes = 2, then I can launch two copies of the instance.\n\nN.B for the purposes of testing I have disabled all vcpu_pin and isolcpu settings.", 
            "date_created": "2015-06-11 14:50:02.310211+00:00", 
            "author": "https://api.launchpad.net/1.0/~dave-johnston"
        }, 
        {
            "content": "", 
            "date_created": "2015-06-11 14:50:02.310211+00:00", 
            "author": "https://api.launchpad.net/1.0/~dave-johnston"
        }, 
        {
            "content": "Some more info.\n\nWhen I  change hw:numa_nodes = 2 in my 12 vCPU flavor, I can launch 2 instances.\nI can also launch a 4vcpu flavor that has the following extra_specs:\n\n{\"hw:cpu_policy\": \"dedicated\", \"hw:numa_nodes\": \"2\"}\n\n\nIf then enable vcpu_pin_set in nova, with the following:\n    vcpu_pin_set = 2-7,16-23,10-15,24-31\n\ni.e. I want to pin to all vcpus apart from 0,1 and 8,,9 (the first two from each NUMA node).\n\nIf I now try to launch the two 12vCPU instances + 1 4 vCPU instance, the smaller instance fails.\n\nThe two 12 vCPU instances get the following pinning\n\n  <cputune>\n    <shares>12288</shares>\n    <vcpupin vcpu='0' cpuset='4'/>\n    <vcpupin vcpu='1' cpuset='20'/>\n    <vcpupin vcpu='2' cpuset='7'/>\n    <vcpupin vcpu='3' cpuset='23'/>\n    <vcpupin vcpu='4' cpuset='5'/>\n    <vcpupin vcpu='5' cpuset='21'/>\n    <vcpupin vcpu='6' cpuset='10'/>\n    <vcpupin vcpu='7' cpuset='26'/>\n    <vcpupin vcpu='8' cpuset='12'/>\n    <vcpupin vcpu='9' cpuset='28'/>\n    <vcpupin vcpu='10' cpuset='13'/>\n    <vcpupin vcpu='11' cpuset='29'/>\n    <emulatorpin cpuset='4-5,7,10,12-13,20-21,23,26,28-29'/>\n  </cputune>\n\n\nand \n\n\n  <cputune>\n    <shares>12288</shares>\n    <vcpupin vcpu='0' cpuset='4'/>\n    <vcpupin vcpu='1' cpuset='20'/>\n    <vcpupin vcpu='2' cpuset='7'/>\n    <vcpupin vcpu='3' cpuset='23'/>\n    <vcpupin vcpu='4' cpuset='5'/>\n    <vcpupin vcpu='5' cpuset='21'/>\n    <vcpupin vcpu='6' cpuset='10'/>\n    <vcpupin vcpu='7' cpuset='26'/>\n    <vcpupin vcpu='8' cpuset='12'/>\n    <vcpupin vcpu='9' cpuset='28'/>\n    <vcpupin vcpu='10' cpuset='13'/>\n    <vcpupin vcpu='11' cpuset='29'/>\n    <emulatorpin cpuset='4-5,7,10,12-13,20-21,23,26,28-29'/>\n  </cputune>\n\n\nI have excluded 0,1 and 8,9 but I belive 16,17 from NUMA node 1 and 24,25 from NUMA node 2 should still be available for the small instance.\n\n", 
            "date_created": "2015-06-11 15:19:38.423041+00:00", 
            "author": "https://api.launchpad.net/1.0/~dave-johnston"
        }, 
        {
            "content": "@Dave Johnston:\n\nIt's been over 2 months since you are set as assignee but without\na commit to solve this bug. To signalize to other contributors that \nthis is not in progress and can be worked on, I remove you as assignee.\nIf you still plan to work on this, please set yourself as assignee\nagain and provide a patch in Gerrit in the near future.\n\nPlease consider updating your Launchpad profile with your IRC nickname\nand hanging around in #openstack-nova on irc.freenode.net this makes\nit easier to communicate with each other (see [1] for more).\n\nIf you have any questions about this process, just ping me (markus_z) \nin IRC.\n\n[1] https://wiki.openstack.org/wiki/Nova/Mentoring#Top_Tips_for_working_with_the_Nova_community", 
            "date_created": "2015-10-16 13:00:53.336171+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Are you able to recreate this with Liberty?", 
            "date_created": "2015-11-26 16:43:22.789516+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "A recreate has been requested, move to incomplete", 
            "date_created": "2016-02-11 14:51:42.186244+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "So I have a system with 40 cores (2 sockets, 10 cores, hypethreading enabled).\nThe NUMA topology is as follows:\n\n    $ numactl --hardware\n    available: 2 nodes (0-1)\n    node 0 cpus: 0 1 2 3 4 5 6 7 8 9 20 21 22 23 24 25 26 27 28 29\n    node 0 size: 32083 MB\n    node 0 free: 16652 MB\n    node 1 cpus: 10 11 12 13 14 15 16 17 18 19 30 31 32 33 34 35 36 37 38 39\n    node 1 size: 32237 MB\n    node 1 free: 25386 MB\n    node distances:\n    node   0   1\n      0:  10  21\n      1:  21  10\n\nI'm using OpenStack provisioned by DevStack on a Fedora 23 host:\n\n    $ cat /etc/*-release*\n    Fedora release 23 (Twenty Three)\n    ...\n    $ uname -r\n    4.3.5-300.fc23.x86_64\n\n    $ cd /opt/stack/nova\n    $ git show --oneline\n    8bafc99 Merge \"remove the unnecessary parem of set_vm_state_and_notify\"\n\nI defined a flavor similar to yours, but without the unnecessary swap and\ndisk space and with a smaller RAM allocation (KISS?).\n\n    $ openstack flavor create bug.1464286 --id 100 --ram 8192 --disk 0 \\\n        --vcpus 12\n\n    $ openstack flavor set bug.1464286 \\\n        --property \"hw:cpu_policy=dedicated\" \\\n        --property \"hw:numa_nodes=1\"\n\n    $ openstack flavor show bug.1464286\n    +----------------------------+----------------------------------------------+\n    | Field                      | Value                                        |\n    +----------------------------+----------------------------------------------+\n    | OS-FLV-DISABLED:disabled   | False                                        |\n    | OS-FLV-EXT-DATA:ephemeral  | 0                                            |\n    | disk                       | 0                                            |\n    | id                         | 100                                          |\n    | name                       | bug.1464286                                  |\n    | os-flavor-access:is_public | True                                         |\n    | properties                 | hw:cpu_policy='dedicated', hw:numa_nodes='1' |\n    | ram                        | 8192                                         |\n    | rxtx_factor                | 1.0                                          |\n    | swap                       |                                              |\n    | vcpus                      | 12                                           |\n    +----------------------------+----------------------------------------------+\n\nI also modified the default quotas to allow allocation of more than 20 cores:\n\n    $ openstack quota set --cores 40 demo\n\nI boot one instance...\n\n    $ openstack server create --flavor=bug.1464286 \\\n        --image=cirros-0.3.4-x86_64-uec --wait test1\n\n    $ sudo virsh list\n     Id    Name                           State\n    ----------------------------------------------------\n     20    instance-00000010              running\n\n    $ sudo virsh dumpxml 20\n    <domain type='kvm' id='20'>\n      <name>instance-00000010</name>\n      ...\n      <vcpu placement='static'>12</vcpu>\n      <cputune>\n        <shares>12288</shares>\n        <vcpupin vcpu='0' cpuset='1'/>\n        <vcpupin vcpu='1' cpuset='21'/>\n        <vcpupin vcpu='2' cpuset='0'/>\n        <vcpupin vcpu='3' cpuset='20'/>\n        <vcpupin vcpu='4' cpuset='25'/>\n        <vcpupin vcpu='5' cpuset='5'/>\n        <vcpupin vcpu='6' cpuset='8'/>\n        <vcpupin vcpu='7' cpuset='28'/>\n        <vcpupin vcpu='8' cpuset='9'/>\n        <vcpupin vcpu='9' cpuset='29'/>\n        <vcpupin vcpu='10' cpuset='24'/>\n        <vcpupin vcpu='11' cpuset='4'/>\n        <emulatorpin cpuset='0-1,4-5,8-9,20-21,24-25,28-29'/>\n      </cputune>\n      <numatune>\n        <memory mode='strict' nodeset='0'/>\n        <memnode cellid='0' mode='strict' nodeset='0'/>\n      </numatune>\n      ...\n      <cpu>\n        <topology sockets='6' cores='1' threads='2'/>\n        <numa>\n          <cell id='0' cpus='0-11' memory='8388608' unit='KiB'/>\n        </numa>\n      </cpu>\n      ...\n    </domain>\n\nThen I boot another...\n\n    $ openstack server create --flavor=bug.1464286 \\\n        --image=cirros-0.3.4-x86_64-uec --wait test2\n\n    $ sudo virsh list\n     Id    Name                           State\n    ----------------------------------------------------\n     20    instance-00000010              running\n     21    instance-00000011              running\n\n    $ sudo virsh dumpxml 20\n    <domain type='kvm' id='20'>\n      <name>instance-00000010</name>\n      ...\n      <vcpu placement='static'>12</vcpu>\n      <cputune>\n        <shares>12288</shares>\n        <vcpupin vcpu='0' cpuset='35'/>\n        <vcpupin vcpu='1' cpuset='15'/>\n        <vcpupin vcpu='2' cpuset='10'/>\n        <vcpupin vcpu='3' cpuset='30'/>\n        <vcpupin vcpu='4' cpuset='16'/>\n        <vcpupin vcpu='5' cpuset='36'/>\n        <vcpupin vcpu='6' cpuset='11'/>\n        <vcpupin vcpu='7' cpuset='31'/>\n        <vcpupin vcpu='8' cpuset='32'/>\n        <vcpupin vcpu='9' cpuset='12'/>\n        <vcpupin vcpu='10' cpuset='17'/>\n        <vcpupin vcpu='11' cpuset='37'/>\n        <emulatorpin cpuset='10-12,15-17,30-32,35-37'/>\n      </cputune>\n      <numatune>\n        <memory mode='strict' nodeset='1'/>\n        <memnode cellid='0' mode='strict' nodeset='1'/>\n      </numatune>\n      ...\n      <cpu>\n        <topology sockets='6' cores='1' threads='2'/>\n        <numa>\n          <cell id='0' cpus='0-11' memory='8388608' unit='KiB'/>\n        </numa>\n      </cpu>\n      ...\n    </domain>\n\nJust for the laughs (figuratively speaking), I tried to boot another to ensure\nbug #1438253 was still in effect. It is:\n\n    $ openstack server create --flavor=bug.1464286 --image=cirros-0.3.4-x86_64-uec --wait test3\n    Error creating server: test3\n\n    Error creating server\n\n    $ openstack server delete test3\n\nSo, based on the above, it seems this bug has been resolved in Mitaka and no\nlonger applies. I have a rough idea which patches might have fixed this and\nthey were backported to Liberty (and Kilo) so there's a good chance that things\nare fixed there also. For now though, I'm going to close this as \"fixed\". We can\ntrace down the exact fix if necessary later.\n", 
            "date_created": "2016-03-07 10:49:38.240480+00:00", 
            "author": "https://api.launchpad.net/1.0/~stephenfinucane"
        }, 
        {
            "content": "Just to clarify, I think one of these commits fix this:\n\n* https://review.openstack.org/#/c/229574/\n* https://review.openstack.org/#/c/229575/", 
            "date_created": "2016-03-07 11:04:55.831774+00:00", 
            "author": "https://api.launchpad.net/1.0/~stephenfinucane"
        }
    ], 
    "closed": "2016-03-07 10:51:34.954511+00:00"
}