{
    "status": "Fix Released", 
    "last_updated": "2016-09-02 01:15:13.695888+00:00", 
    "description": "Description\n===========\nWhen I search instance with a wrong regx, such as '+', nova-api will return a 500 error.\n\nSteps to reproduce\n==================\nnova list --name +\n\nExpected result\n===============\nAfter the execution of the steps above, We can get a prompt of regx error message.\n\n\nActual result\n=============\nERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'oslo_db.exception.DBError'> (HTTP 500) (Request-ID: req-f6a78623-4db5-4f5b-94b1-8edb281b5e7a)\n\nThere are the nova-api.log:\n Traceback (most recent call last):\n   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/extensions.py\", line 478, in wrapped\n     return f(*args, **kwargs)\n   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/servers.py\", line 294, in detail\n     servers = self._get_servers(req, is_detail=True)\n   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/servers.py\", line 409, in _get_servers\n     sort_keys=sort_keys, sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 2128, in get_all\n     sort_keys=sort_keys, sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 2178, in _get_instances_by_filters\n     expected_attrs=fields, sort_keys=sort_keys, sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 181, in wrapper\n     result = fn(cls, context, *args, **kwargs)\n   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 1065, in get_by_filters\n     use_slave=use_slave, sort_keys=sort_keys, sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 285, in wrapper\n     return f(*args, **kwargs)\n   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 1049, in _get_by_filters_impl\n     sort_keys=sort_keys, sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/nova/db/api.py\", line 734, in instance_get_all_by_filters_sort\n     sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 229, in wrapper\n     return f(*args, **kwargs)\n   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 330, in wrapped\n     return f(context, *args, **kwargs)\n   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 2308, in instance_get_all_by_filters_sort\n     return _instances_fill_metadata(context, query_prefix.all(), manual_joins)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2588, in all\n     return list(self)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2736, in __iter__\n     return self._execute_and_instances(context)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2751, in _execute_and_instances\n     result = conn.execute(querycontext.statement, self._params)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 914, in execute\n     return meth(self, multiparams, params)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\n     return connection._execute_clauseelement(self, multiparams, params)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n     compiled_sql, distilled_params\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n     context)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1337, in _handle_dbapi_exception\n     util.raise_from_cause(newraise, exc_info)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/util/compat.py\", line 200, in raise_from_cause\n     reraise(type(exception), exception, tb=exc_tb)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n     context)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n     cursor.execute(statement, parameters)\n   File \"/usr/lib/python2.7/site-packages/pymysql/cursors.py\", line 146, in execute\n     result = self._query(query)\n   File \"/usr/lib/python2.7/site-packages/pymysql/cursors.py\", line 296, in _query\n     conn.query(q)\n   File \"/usr/lib/python2.7/site-packages/pymysql/connections.py\", line 781, in query\n     self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n   File \"/usr/lib/python2.7/site-packages/pymysql/connections.py\", line 942, in _read_query_result\n     result.read()\n   File \"/usr/lib/python2.7/site-packages/pymysql/connections.py\", line 1138, in read\n     first_packet = self.connection._read_packet()\n   File \"/usr/lib/python2.7/site-packages/pymysql/connections.py\", line 906, in _read_packet\n     packet.check_error()\n   File \"/usr/lib/python2.7/site-packages/pymysql/connections.py\", line 367, in check_error\n     err.raise_mysql_exception(self._data)\n   File \"/usr/lib/python2.7/site-packages/pymysql/err.py\", line 120, in raise_mysql_exception\n     _check_mysql_exception(errinfo)\n   File \"/usr/lib/python2.7/site-packages/pymysql/err.py\", line 115, in _check_mysql_exception\n     raise InternalError(errno, errorvalue)\n\nDBError: (pymysql.err.InternalError) (1139, u\"Got error 'nothing to repeat at offset 0' from regexp\")\n\nEnvironment\n===========\nopenstack-nova-api-13.1.0-1.el7.noarch\nLibvirt + KVM", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1603728", 
    "owner": "https://api.launchpad.net/1.0/~anton-kremenetsky", 
    "id": 1603728, 
    "index": 7599, 
    "openned": "2016-07-17 07:43:57.885189+00:00", 
    "created": "2016-07-17 07:43:57.885189+00:00", 
    "title": "search with error regex causes a 500 error", 
    "comments": [
        {
            "content": "Description\n===========\nWhen I search instance with a wrong regx, such as '+', nova-api will return a 500 error.\n\nSteps to reproduce\n==================\nnova list --name +\n\nExpected result\n===============\nAfter the execution of the steps above, We can get a prompt of regx error message.\n\n\nActual result\n=============\nERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'oslo_db.exception.DBError'> (HTTP 500) (Request-ID: req-f6a78623-4db5-4f5b-94b1-8edb281b5e7a)\n\nThere are the nova-api.log:\n Traceback (most recent call last):\n   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/extensions.py\", line 478, in wrapped\n     return f(*args, **kwargs)\n   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/servers.py\", line 294, in detail\n     servers = self._get_servers(req, is_detail=True)\n   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/servers.py\", line 409, in _get_servers\n     sort_keys=sort_keys, sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 2128, in get_all\n     sort_keys=sort_keys, sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 2178, in _get_instances_by_filters\n     expected_attrs=fields, sort_keys=sort_keys, sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 181, in wrapper\n     result = fn(cls, context, *args, **kwargs)\n   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 1065, in get_by_filters\n     use_slave=use_slave, sort_keys=sort_keys, sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 285, in wrapper\n     return f(*args, **kwargs)\n   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 1049, in _get_by_filters_impl\n     sort_keys=sort_keys, sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/nova/db/api.py\", line 734, in instance_get_all_by_filters_sort\n     sort_dirs=sort_dirs)\n   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 229, in wrapper\n     return f(*args, **kwargs)\n   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 330, in wrapped\n     return f(context, *args, **kwargs)\n   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 2308, in instance_get_all_by_filters_sort\n     return _instances_fill_metadata(context, query_prefix.all(), manual_joins)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2588, in all\n     return list(self)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2736, in __iter__\n     return self._execute_and_instances(context)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2751, in _execute_and_instances\n     result = conn.execute(querycontext.statement, self._params)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 914, in execute\n     return meth(self, multiparams, params)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\n     return connection._execute_clauseelement(self, multiparams, params)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n     compiled_sql, distilled_params\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n     context)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1337, in _handle_dbapi_exception\n     util.raise_from_cause(newraise, exc_info)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/util/compat.py\", line 200, in raise_from_cause\n     reraise(type(exception), exception, tb=exc_tb)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n     context)\n   File \"/usr/lib64/python2.7/site-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n     cursor.execute(statement, parameters)\n   File \"/usr/lib/python2.7/site-packages/pymysql/cursors.py\", line 146, in execute\n     result = self._query(query)\n   File \"/usr/lib/python2.7/site-packages/pymysql/cursors.py\", line 296, in _query\n     conn.query(q)\n   File \"/usr/lib/python2.7/site-packages/pymysql/connections.py\", line 781, in query\n     self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n   File \"/usr/lib/python2.7/site-packages/pymysql/connections.py\", line 942, in _read_query_result\n     result.read()\n   File \"/usr/lib/python2.7/site-packages/pymysql/connections.py\", line 1138, in read\n     first_packet = self.connection._read_packet()\n   File \"/usr/lib/python2.7/site-packages/pymysql/connections.py\", line 906, in _read_packet\n     packet.check_error()\n   File \"/usr/lib/python2.7/site-packages/pymysql/connections.py\", line 367, in check_error\n     err.raise_mysql_exception(self._data)\n   File \"/usr/lib/python2.7/site-packages/pymysql/err.py\", line 120, in raise_mysql_exception\n     _check_mysql_exception(errinfo)\n   File \"/usr/lib/python2.7/site-packages/pymysql/err.py\", line 115, in _check_mysql_exception\n     raise InternalError(errno, errorvalue)\n\nDBError: (pymysql.err.InternalError) (1139, u\"Got error 'nothing to repeat at offset 0' from regexp\")\n\nEnvironment\n===========\nopenstack-nova-api-13.1.0-1.el7.noarch\nLibvirt + KVM", 
            "date_created": "2016-07-17 07:43:57.885189+00:00", 
            "author": "https://api.launchpad.net/1.0/~wang19930902"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/344945", 
            "date_created": "2016-07-20 17:28:55.371756+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/344945\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d01695886f3fb6ec1ffe4204e7f4bc72737992cf\nSubmitter: Jenkins\nBranch:    master\n\ncommit d01695886f3fb6ec1ffe4204e7f4bc72737992cf\nAuthor: Anton Kremenetsky <email address hidden>\nDate:   Wed Jul 20 13:24:43 2016 -0400\n\n    Add server name verification in instance search\n    \n    There are Nova API calls that can accept a server name\n    as a regex parameter. For example, if the command\n    'nova list --name <some_pattern>' is invoked with\n    an incorrect value of the pattern, the nova-api makes\n    a request to database and returns Http 500 error. Seems\n    it's not convenient.\n    \n    This fix checks the pattern. If it isn't correct,\n    the nova-api returns error 400 with a prompt of a bad regex.\n    \n    Change-Id: Iad63c668d09ec6a82ace29700fb4949c1acfbe1c\n    Closes-Bug: #1603728\n", 
            "date_created": "2016-08-03 11:38:16.204784+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b3 development milestone.", 
            "date_created": "2016-09-02 01:15:13.045557+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-08-03 11:38:14.078264+00:00"
}