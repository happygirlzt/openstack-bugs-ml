{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 08:53:55.520003+00:00", 
    "description": "If specifying non-dict data(string, etc.) as metadata, \"create a vm\" API returns a HTTP500(Internal Server Error) response:\n\n$ curl -i http://192.168.0.30:8774/v2/248fcd6585b245dfa48d4dee51673f28/servers -X POST -H \"X-Auth-Project-Id: demo\" -H \"User-Agent: python-novaclient\" -H \"Content-Type: application/json\" -H \"Accept: application/json\" -H \"X-Auth-Token: MII[..]\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"42\", \"name\": \"vm02\", \"imageRef\": \"0483c08f-d4e7-414f-8847-f5855ad816df\", \"m\nax_count\": 1, \"metadata\": \"string\"}}'\nHTTP/1.1 500 Internal Server Error\nContent-Length: 128\nContent-Type: application/json; charset=UTF-8\nX-Compute-Request-Id: req-4148aefb-34d0-433a-aea4-b4268c8776ce\nDate: Thu, 10 Oct 2013 09:30:24 GMT\n\n{\"computeFault\": {\"message\": \"The server has either erred or is incapable of performing the requested operation.\", \"code\": 500}}\n$\n\nThe reason is that the API does not validate its metadata type.\n\n\nThe nova-api log is the following:\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/api/openstack/wsgi.py\", line 1057, in dispatch\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     return method(req=request, **action_args)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/api/openstack/compute/servers.py\", line 923, in create\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     legacy_bdm=legacy_bdm)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/hooks.py\", line 105, in inner\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     rv = f(*args, **kwargs)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 1220, in create\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     legacy_bdm=legacy_bdm)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 861, in _create_instance\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     block_device_mapping, auto_disk_config, reservation_id)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 672, in _validate_and_build_base_options\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     instance_type, metadata, injected_files)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 626, in _checks_for_create_and_rebuild\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     self._check_metadata_properties_quota(context, metadata)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 406, in _check_metadata_properties_quota\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     for k, v in metadata.iteritems():\n2013-10-10 18:30:24.226 TRACE nova.api.openstack AttributeError: 'unicode' object has no attribute 'iteritems'\n2013-10-10 18:30:24.226 TRACE nova.api.openstack", 
    "tags": [
        "havana-backport-potential"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1238344", 
    "owner": "https://api.launchpad.net/1.0/~oomichi", 
    "id": 1238344, 
    "index": 3645, 
    "openned": "2013-10-11 01:24:32.554723+00:00", 
    "created": "2013-10-11 01:24:32.554723+00:00", 
    "title": "not validate a metadata type when creating a vm instance", 
    "comments": [
        {
            "content": "If specifying non-dict data(string, etc.) as metadata, \"create a vm\" API returns a HTTP500(Internal Server Error) response:\n\n$ curl -i http://192.168.0.30:8774/v2/248fcd6585b245dfa48d4dee51673f28/servers -X POST -H \"X-Auth-Project-Id: demo\" -H \"User-Agent: python-novaclient\" -H \"Content-Type: application/json\" -H \"Accept: application/json\" -H \"X-Auth-Token: MII[..]\" -d '{\"server\": {\"min_count\": 1, \"flavorRef\": \"42\", \"name\": \"vm02\", \"imageRef\": \"0483c08f-d4e7-414f-8847-f5855ad816df\", \"m\nax_count\": 1, \"metadata\": \"string\"}}'\nHTTP/1.1 500 Internal Server Error\nContent-Length: 128\nContent-Type: application/json; charset=UTF-8\nX-Compute-Request-Id: req-4148aefb-34d0-433a-aea4-b4268c8776ce\nDate: Thu, 10 Oct 2013 09:30:24 GMT\n\n{\"computeFault\": {\"message\": \"The server has either erred or is incapable of performing the requested operation.\", \"code\": 500}}\n$\n\nThe reason is that the API does not validate its metadata type.\n\n\nThe nova-api log is the following:\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/api/openstack/wsgi.py\", line 1057, in dispatch\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     return method(req=request, **action_args)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/api/openstack/compute/servers.py\", line 923, in create\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     legacy_bdm=legacy_bdm)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/hooks.py\", line 105, in inner\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     rv = f(*args, **kwargs)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 1220, in create\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     legacy_bdm=legacy_bdm)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 861, in _create_instance\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     block_device_mapping, auto_disk_config, reservation_id)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 672, in _validate_and_build_base_options\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     instance_type, metadata, injected_files)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 626, in _checks_for_create_and_rebuild\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     self._check_metadata_properties_quota(context, metadata)\n2013-10-10 18:30:24.226 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 406, in _check_metadata_properties_quota\n2013-10-10 18:30:24.226 TRACE nova.api.openstack     for k, v in metadata.iteritems():\n2013-10-10 18:30:24.226 TRACE nova.api.openstack AttributeError: 'unicode' object has no attribute 'iteritems'\n2013-10-10 18:30:24.226 TRACE nova.api.openstack", 
            "date_created": "2013-10-11 01:24:32.554723+00:00", 
            "author": "https://api.launchpad.net/1.0/~oomichi"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/51085", 
            "date_created": "2013-10-11 01:25:28.800792+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This is a relatively small patch that removes a 500 server error scenario, so I think a havana backport for 2013.2.1 should be considered.", 
            "date_created": "2013-10-16 11:17:29.905595+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/51085\nCommitted: http://github.com/openstack/nova/commit/753bed08d1ff224427938c67a6f8922ebac376e4\nSubmitter: Jenkins\nBranch:    master\n\ncommit 753bed08d1ff224427938c67a6f8922ebac376e4\nAuthor: Ken'ichi Ohmichi <email address hidden>\nDate:   Fri Oct 11 09:54:38 2013 +0900\n\n    Add a metadata type validation when creating vm\n    \n    If specifying non-dict data(string, etc.) as metadata, \"create a vm\"\n    API returns a HTTP500(Internal Server Error) response because it does\n    not validate the metadata type.\n    \n    This patch adds the metadata type validation, and the API will return\n    a HTTP400(Bad Request) response. In addition, this patch removes log.WARNs\n    of bad incoming requests because they are just client-side problems not\n    server-side.\n    \n    Closes-Bug: 1238344\n    Change-Id: I8f1d5debf74891e67b17f8128cc0eb0ab7f5c3f5\n", 
            "date_created": "2013-10-30 23:26:24.311336+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-12-04 10:21:01.644827+00:00"
}