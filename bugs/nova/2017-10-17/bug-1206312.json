{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 12:13:30.160044+00:00", 
    "description": "\nI did the followig steps with a script.\n1) resize vm\n2) resize-revert vm\n3) goto 1)\n\nSometimes found resize failed with following error:\n[root@rhel8233 ~]# nova show vm1\n+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Property                            | Value                                                                                                                                                      |\n+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| status                              | ERROR                                                                                                                                                      |\n| updated                             | 2013-07-15T03:11:31Z                                                                                                                                       |\n| OS-EXT-STS:task_state               | None                                                                                                                                                       |\n| OS-EXT-SRV-ATTR:host                | rhel8234                                                                                                                                                   |\n| key_name                            | None                                                                                                                                                       |\n| image                               | cirros-0.3.0-x86_64 (9e66c9bb-ed95-42ab-b8f6-70a0f88b876a)                                                                                                 |\n| hostId                              | 0ddc9ca22d1deceff5ac4f83526f950fac6bb9b7c185c899985e60e1                                                                                                   |\n| OS-EXT-STS:vm_state                 | error                                                                                                                                                      |\n| OS-EXT-SRV-ATTR:instance_name       | instance-00000068                                                                                                                                          |\n| OS-SRV-USG:launched_at              | 2013-07-15T02:59:20.000000                                                                                                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | rhel8234                                                                                                                                                   |\n| flavor                              | m1.tiny (1)                                                                                                                                                |\n| id                                  | fb33fb20-260c-4096-9448-f4bdb5b2e617                                                                                                                       |\n| security_groups                     | [{u'name': u'default'}]                                                                                                                                    |\n| OS-SRV-USG:terminated_at            | None                                                                                                                                                       |\n| user_id                             | e18753eee1ec42349ef4d48f6a0cba01                                                                                                                           |\n| name                                | vm1                                                                                                                                                        |\n| created                             | 2013-07-15T02:45:22Z                                                                                                                                       |\n| tenant_id                           | 333416515ef44d51a3e6d03e003458ba                                                                                                                           |\n| OS-DCF:diskConfig                   | MANUAL                                                                                                                                                     |\n| metadata                            | {}                                                                                                                                                         |\n| accessIPv4                          |                                                                                                                                                            |\n| accessIPv6                          |                                                                                                                                                            |\n| fault                               | {u'message': u'OSError', u'code': 500, u'details': u'[Errno 2] No such file or directory: \\'/var/lib/nova/instances/fb33fb20-260c-4096-9448-f4bdb5b2e617\\' |\n|                                     |   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 238, in decorated_function                                                         |\n|                                     |     return function(self, context, *args, **kwargs)                                                                                                        |\n|                                     |   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2463, in finish_revert_resize                                                      |\n|                                     |     block_device_info, power_on)                                                                                                                           |\n|                                     |   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3892, in finish_revert_migration                                               |\n|                                     |     self._cleanup_failed_migration(inst_base)                                                                                                              |\n|                                     |   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3876, in _cleanup_failed_migration                                             |\n|                                     |     shutil.rmtree(inst_base)                                                                                                                               |\n|                                     |   File \"/usr/lib64/python2.6/shutil.py\", line 204, in rmtree                                                                                               |\n|                                     |     onerror(os.listdir, path, sys.exc_info())                                                                                                              |\n|                                     |   File \"/usr/lib64/python2.6/shutil.py\", line 202, in rmtree                                                                                               |\n|                                     |     names = os.listdir(path)                                                                                                                               |\n|                                     | ', u'created': u'2013-07-15T03:11:31Z'}                                                                                                                    |\n| OS-EXT-STS:power_state              | 1                                                                                                                                                          |\n| OS-EXT-AZ:availability_zone         | nova                                                                                                                                                       |\n| config_drive                        |                                                                                                                                                            |\n+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\nAfter some debug, found that in driver.py:: finish_revert_migration()\n\ndef finish_revert_migration(self, instance, network_info,\n                                block_device_info=None, power_on=True):\n        LOG.debug(_(\"Starting finish_revert_migration\"),\n                   instance=instance)\n\n        inst_base = libvirt_utils.get_instance_path(instance)\n        inst_base_resize = inst_base + \"_resize\"\n\n        # NOTE(danms): if we're recovering from a failed migration,\n        # make sure we don't have a left-over same-host base directory\n        # that would conflict. Also, don't fail on the rename if the\n        # failure happened early.\n        if os.path.exists(inst_base_resize):\n            if os.path.exists(inst_base): <<< This can sometimes be true even the inst_base has been destroyed in manager.py::revert_resize\n                self._cleanup_failed_migration(inst_base) <<< exception here, since inst_base cannot be found\n            utils.execute('mv', inst_base_resize, inst_base)", 
    "tags": [
        "libvirt"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1206312", 
    "owner": "https://api.launchpad.net/1.0/~jay-lau-513", 
    "id": 1206312, 
    "index": 5162, 
    "openned": "2013-07-30 00:23:59.175597+00:00", 
    "created": "2013-07-30 00:23:59.175597+00:00", 
    "title": "resize-revert might be failed when using slow NFS", 
    "comments": [
        {
            "content": "\nI did the followig steps with a script.\n1) resize vm\n2) resize-revert vm\n3) goto 1)\n\nSometimes found resize failed with following error:\n[root@rhel8233 ~]# nova show vm1\n+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Property                            | Value                                                                                                                                                      |\n+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| status                              | ERROR                                                                                                                                                      |\n| updated                             | 2013-07-15T03:11:31Z                                                                                                                                       |\n| OS-EXT-STS:task_state               | None                                                                                                                                                       |\n| OS-EXT-SRV-ATTR:host                | rhel8234                                                                                                                                                   |\n| key_name                            | None                                                                                                                                                       |\n| image                               | cirros-0.3.0-x86_64 (9e66c9bb-ed95-42ab-b8f6-70a0f88b876a)                                                                                                 |\n| hostId                              | 0ddc9ca22d1deceff5ac4f83526f950fac6bb9b7c185c899985e60e1                                                                                                   |\n| OS-EXT-STS:vm_state                 | error                                                                                                                                                      |\n| OS-EXT-SRV-ATTR:instance_name       | instance-00000068                                                                                                                                          |\n| OS-SRV-USG:launched_at              | 2013-07-15T02:59:20.000000                                                                                                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname | rhel8234                                                                                                                                                   |\n| flavor                              | m1.tiny (1)                                                                                                                                                |\n| id                                  | fb33fb20-260c-4096-9448-f4bdb5b2e617                                                                                                                       |\n| security_groups                     | [{u'name': u'default'}]                                                                                                                                    |\n| OS-SRV-USG:terminated_at            | None                                                                                                                                                       |\n| user_id                             | e18753eee1ec42349ef4d48f6a0cba01                                                                                                                           |\n| name                                | vm1                                                                                                                                                        |\n| created                             | 2013-07-15T02:45:22Z                                                                                                                                       |\n| tenant_id                           | 333416515ef44d51a3e6d03e003458ba                                                                                                                           |\n| OS-DCF:diskConfig                   | MANUAL                                                                                                                                                     |\n| metadata                            | {}                                                                                                                                                         |\n| accessIPv4                          |                                                                                                                                                            |\n| accessIPv6                          |                                                                                                                                                            |\n| fault                               | {u'message': u'OSError', u'code': 500, u'details': u'[Errno 2] No such file or directory: \\'/var/lib/nova/instances/fb33fb20-260c-4096-9448-f4bdb5b2e617\\' |\n|                                     |   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 238, in decorated_function                                                         |\n|                                     |     return function(self, context, *args, **kwargs)                                                                                                        |\n|                                     |   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2463, in finish_revert_resize                                                      |\n|                                     |     block_device_info, power_on)                                                                                                                           |\n|                                     |   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3892, in finish_revert_migration                                               |\n|                                     |     self._cleanup_failed_migration(inst_base)                                                                                                              |\n|                                     |   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3876, in _cleanup_failed_migration                                             |\n|                                     |     shutil.rmtree(inst_base)                                                                                                                               |\n|                                     |   File \"/usr/lib64/python2.6/shutil.py\", line 204, in rmtree                                                                                               |\n|                                     |     onerror(os.listdir, path, sys.exc_info())                                                                                                              |\n|                                     |   File \"/usr/lib64/python2.6/shutil.py\", line 202, in rmtree                                                                                               |\n|                                     |     names = os.listdir(path)                                                                                                                               |\n|                                     | ', u'created': u'2013-07-15T03:11:31Z'}                                                                                                                    |\n| OS-EXT-STS:power_state              | 1                                                                                                                                                          |\n| OS-EXT-AZ:availability_zone         | nova                                                                                                                                                       |\n| config_drive                        |                                                                                                                                                            |\n+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\nAfter some debug, found that in driver.py:: finish_revert_migration()\n\ndef finish_revert_migration(self, instance, network_info,\n                                block_device_info=None, power_on=True):\n        LOG.debug(_(\"Starting finish_revert_migration\"),\n                   instance=instance)\n\n        inst_base = libvirt_utils.get_instance_path(instance)\n        inst_base_resize = inst_base + \"_resize\"\n\n        # NOTE(danms): if we're recovering from a failed migration,\n        # make sure we don't have a left-over same-host base directory\n        # that would conflict. Also, don't fail on the rename if the\n        # failure happened early.\n        if os.path.exists(inst_base_resize):\n            if os.path.exists(inst_base): <<< This can sometimes be true even the inst_base has been destroyed in manager.py::revert_resize\n                self._cleanup_failed_migration(inst_base) <<< exception here, since inst_base cannot be found\n            utils.execute('mv', inst_base_resize, inst_base)", 
            "date_created": "2013-07-30 00:23:59.175597+00:00", 
            "author": "https://api.launchpad.net/1.0/~jay-lau-513"
        }, 
        {
            "content": "\nCheck nova compute log:\n\nresize target host report the VM was destroyed in 23:56:18\n2013-07-29 23:56:18.260 8105 INFO nova.virt.libvirt.driver [req-c7d7450a-e665-416f-a392-9b760f123fc9 2785a0d1141c4502b573155988382a27 1394848571b8408188a239da2a1bb351] [instance: 7bccaf62-ea4d-4e27-b4ff-d715fa2f9e9d] Deleting instance files /var/lib/nova/instances/7bccaf62-ea4d-4e27-b4ff-d715fa2f9e9d\n\nBut on source host of the VM, it can still detect that the os.path.exists(inst_base) is true. (inst_base:  /var/lib/nova/instances/7bccaf62-ea4d-4e27-b4ff-d715fa2f9e9d)\n2013-07-29 23:56:19.704 8365 ERROR nova.compute.manager [req-c7d7450a-e665-416f-a392-9b760f123fc9 2785a0d1141c4502b573155988382a27 1394848571b8408188a239da2a1bb351] [instance: 7bccaf62-ea4d-4e27-b4ff-d715fa2f9e9d] [Errno 2] No such file or directory: '/var/lib/nova/instances/7bccaf62-ea4d-4e27-b4ff-d715fa2f9e9d'. Setting instance vm_state to ERROR\n2013-07-29 23:56:20.003 8365 ERROR nova.openstack.common.rpc.amqp [req-c7d7450a-e665-416f-a392-9b760f123fc9 2785a0d1141c4502b573155988382a27 1394848571b8408188a239da2a1bb351] Exception during message handling\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py\", line 421, in _process_data\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 100, in wrapped\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 77, in wrapped\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 235, in decorated_function\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     pass\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 221, in decorated_function\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 286, in decorated_function\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     function(self, context, *args, **kwargs)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 263, in decorated_function\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 250, in decorated_function\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 2635, in finish_revert_resize\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     block_device_info, power_on)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3972, in finish_revert_migration\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     self._cleanup_failed_migration(inst_base)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/driver.py\", line 3955, in _cleanup_failed_migration\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     shutil.rmtree(inst_base)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib64/python2.6/shutil.py\", line 204, in rmtree\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     onerror(os.listdir, path, sys.exc_info())\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib64/python2.6/shutil.py\", line 202, in rmtree\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp     names = os.listdir(path)\n2013-07-29 23:56:20.003 8365 TRACE nova.openstack.common.rpc.amqp OSError: [Errno 2] No such file or directory: '/var/lib/nova/instances/7bccaf62-ea4d-4e27-b4ff-d715fa2f9e9d'\n\nI was using NFS for the VM image, and suspect it might be caused that the NFS did not respond on time when the image was deleted on target resize host, and the source host still think the image exist.\n\nA possible solution was add retry for finish_revert_migration()", 
            "date_created": "2013-07-30 00:27:32.364713+00:00", 
            "author": "https://api.launchpad.net/1.0/~jay-lau-513"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/39201", 
            "date_created": "2013-07-30 03:20:34.841438+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/39201\nCommitted: http://github.com/openstack/nova/commit/9ba82ba8c66561e00698700f00be1b953a0a5a99\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9ba82ba8c66561e00698700f00be1b953a0a5a99\nAuthor: Jay Lau <email address hidden>\nDate:   Tue Jul 30 11:13:14 2013 +0800\n\n    libvirt: ignore false exception due to slow NFS on resize-revert\n    \n    When resize revert one VM instance, if the NFS is slow, the NFS\n    mounted on source host might not respond quickly. This will cause\n    that even if the VM instance configuration files was deleted from\n    resize target host, the NFS on source host may still think the\n    files were not deleted. Then in driver.py::finish_revert_migration,\n    the driver try to delete the file again, this will lead nova compute\n    throw exception.\n    \n    The fix was ignore exception for such case: if failed to delete the\n    instance with error no as 2 (No such file or directory)\n    \n    Fix bug 1206312\n    \n    Change-Id: I89990c1750a7fd7f421cab03780e7704ee661de1\n", 
            "date_created": "2013-09-20 20:59:07.105170+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-10-03 07:59:40.128160+00:00"
}