{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:56:02.439758+00:00", 
    "description": "KVM block migration fails with an error that nova-compute cannot grab the base image from glance because of an authentication issue.\n\nThe command that I used was:\nnova-manage vm block_migration --ec2_id=i-00000001 --dest=compute1\n\nThe python trace reported in nova-compute is:\n\n012-03-07 15:50:13 ERROR nova.rpc.amqp [-] Exception during message handling(nova.rpc.amqp): TRACE: Traceback (most recent call last):(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/rpc/amqp.py\", line 252, in _process_data(nova.rpc.amqp): TRACE:     rval = node_func(context=ctxt, **node_args)(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/compute/manager.py\", line 1930, in pre_live_migration(nova.rpc.amqp): TRACE:     disk)(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 2016, in pre_block_migration\n(nova.rpc.amqp): TRACE:     size=info['disk_size'])(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 995, in _cache_image(nova.rpc.amqp): TRACE:     call_if_not_exists(base, fn, *args, **kwargs)(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/utils.py\", line 858, in inner(nova.rpc.amqp): TRACE:     retval = f(*args, **kwargs)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 992, in call_if_not_exists(nova.rpc.amqp): TRACE:     fn(target=base, *args, **kwargs)(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 264, in fetch_image(nova.rpc.amqp): TRACE:     images.fetch_to_raw(context, image_id, target, user_id, project_id)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/images.py\", line 71, in fetch_to_raw(nova.rpc.amqp): TRACE:     metadata = fetch(context, image_href, path_tmp, user_id, project_id)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/images.py\", line 65, in fetch\n(nova.rpc.amqp): TRACE:     (path, e.strerror))\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n(nova.rpc.amqp): TRACE:     self.gen.next()\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/images.py\", line 57, in fetch\n(nova.rpc.amqp): TRACE:     metadata = image_service.get(context, image_id, image_file)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 263, in get\n(nova.rpc.amqp): TRACE:     _reraise_translated_image_exception(image_id)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 261, in get\n(nova.rpc.amqp): TRACE:     image_id)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 145, in _call_retry\n(nova.rpc.amqp): TRACE:     return getattr(client, name)(*args, **kwargs)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/client.py\", line 90, in get_image\n(nova.rpc.amqp): TRACE:     res = self.do_request(\"GET\", \"/images/%s\" % image_id)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 58, in wrapped\n(nova.rpc.amqp): TRACE:     return func(self, *args, **kwargs)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 385, in do_request\n(nova.rpc.amqp): TRACE:     self._authenticate()\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 363, in _authenticate\n(nova.rpc.amqp): TRACE:     auth_plugin.authenticate()\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/common/auth.py\", line 119, in authenticate\n(nova.rpc.amqp): TRACE:     self.check_auth_params()\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/common/auth.py\", line 83, in check_auth_params\n(nova.rpc.amqp): TRACE:     raise exception.MissingCredentialError(required=required)\n(nova.rpc.amqp): TRACE: ImageNotAuthorized: Not authorized for image 9aeafd9b-3f8d-466b-914b-c47a455e01a9.\n(nova.rpc.amqp): TRACE:\n2012-03-07 15:50:13 ERROR nova.rpc.amqp [-] Returning exception Not authorized for image 9aeafd9b-3f8d-466b-914b-c47a455e01a9. to caller\n2012-03-07 15:50:13 ERROR nova.rpc.amqp [-] ['Traceback (most recent call last):\\n', '  File \"/opt/stack/nova/nova/rpc/amqp.py\", line 252, in _process_data\\n    rval = node_func(context=ctxt, **node_args)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 1930, in pre_live_migration\\n    disk)\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 2016, in pre_block_migration\\n    size=info[\\'disk_size\\'])\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 995, in _cache_image\\n    call_if_not_exists(base, fn, *args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/utils.py\", line 858, in inner\\n    retval = f(*args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 992, in call_if_not_exists\\n    fn(target=base, *args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 264, in fetch_image\\n    images.fetch_to_raw(context, image_id, target, user_id, project_id)\\n', '  File \"/opt/stack/nova/nova/virt/images.py\", line 71, in fetch_to_raw\\n    metadata = fetch(context, image_href, path_tmp, user_id, project_id)\\n', '  File \"/opt/stack/nova/nova/virt/images.py\", line 65, in fetch\\n    (path, e.strerror))\\n', '  File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\\n    self.gen.next()\\n', '  File \"/opt/stack/nova/nova/virt/images.py\", line 57, in fetch\\n    metadata = image_service.get(context, image_id, image_file)\\n', '  File \"/opt/stack/nova/nova/image/glance.py\", line 263, in get\\n    _reraise_translated_image_exception(image_id)\\n', '  File \"/opt/stack/nova/nova/image/glance.py\", line 261, in get\\n    image_id)\\n', '  File \"/opt/stack/nova/nova/image/glance.py\", line 145, in _call_retry\\n    return getattr(client, name)(*args, **kwargs)\\n', '  File \"/opt/stack/glance/glance/client.py\", line 90, in get_image\\n    res = self.do_request(\"GET\", \"/images/%s\" % image_id)\\n', '  File \"/opt/stack/glance/glance/common/client.py\", line 58, in wrapped\\n    return func(self, *args, **kwargs)\\n', '  File \"/opt/stack/glance/glance/common/client.py\", line 385, in do_request\\n    self._authenticate()\\n', '  File \"/opt/stack/glance/glance/common/client.py\", line 363, in _authenticate\\n    auth_plugin.authenticate()\\n', '  File \"/opt/stack/glance/glance/common/auth.py\", line 119, in authenticate\\n    self.check_auth_params()\\n', '  File \"/opt/stack/glance/glance/common/auth.py\", line 83, in check_auth_params\\n    raise exception.MissingCredentialError(required=required)\\n', 'ImageNotAuthorized: Not authorized for image 9aeafd9b-3f8d-466b-914b-c47a455e01a9.\\n']\n\nThe image does exist in glance\nbreu@controller:~/devstack$ nova image-list\n+--------------------------------------+-----------------------------------+--------+--------+\n|                  ID                  |                Name               | Status | Server |\n+--------------------------------------+-----------------------------------+--------+--------+\n| 4611e6f5-f36d-458e-8553-3ec0e86e07de | cirros-0.3.0-x86_64-blank-kernel  | ACTIVE |        |\n| 9aeafd9b-3f8d-466b-914b-c47a455e01a9 | cirros-0.3.0-x86_64-blank         | ACTIVE |        |\n| bfd1f0ac-89a1-4f9f-b060-6265484a04b5 | cirros-0.3.0-x86_64-blank-ramdisk | ACTIVE |        |\n+--------------------------------------+-----------------------------------+--------+--------+", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/949438", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 949438, 
    "index": 2793, 
    "openned": "2012-03-07 21:56:42.758049+00:00", 
    "created": "2012-03-07 21:56:42.758049+00:00", 
    "title": "kvm block_migration fails with ImageNotAuthorized error", 
    "comments": [
        {
            "content": "KVM block migration fails with an error that nova-compute cannot grab the base image from glance because of an authentication issue.\n\nThe command that I used was:\nnova-manage vm block_migration --ec2_id=i-00000001 --dest=compute1\n\nThe python trace reported in nova-compute is:\n\n012-03-07 15:50:13 ERROR nova.rpc.amqp [-] Exception during message handling(nova.rpc.amqp): TRACE: Traceback (most recent call last):(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/rpc/amqp.py\", line 252, in _process_data(nova.rpc.amqp): TRACE:     rval = node_func(context=ctxt, **node_args)(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/compute/manager.py\", line 1930, in pre_live_migration(nova.rpc.amqp): TRACE:     disk)(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 2016, in pre_block_migration\n(nova.rpc.amqp): TRACE:     size=info['disk_size'])(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 995, in _cache_image(nova.rpc.amqp): TRACE:     call_if_not_exists(base, fn, *args, **kwargs)(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/utils.py\", line 858, in inner(nova.rpc.amqp): TRACE:     retval = f(*args, **kwargs)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 992, in call_if_not_exists(nova.rpc.amqp): TRACE:     fn(target=base, *args, **kwargs)(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 264, in fetch_image(nova.rpc.amqp): TRACE:     images.fetch_to_raw(context, image_id, target, user_id, project_id)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/images.py\", line 71, in fetch_to_raw(nova.rpc.amqp): TRACE:     metadata = fetch(context, image_href, path_tmp, user_id, project_id)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/images.py\", line 65, in fetch\n(nova.rpc.amqp): TRACE:     (path, e.strerror))\n(nova.rpc.amqp): TRACE:   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n(nova.rpc.amqp): TRACE:     self.gen.next()\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/virt/images.py\", line 57, in fetch\n(nova.rpc.amqp): TRACE:     metadata = image_service.get(context, image_id, image_file)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 263, in get\n(nova.rpc.amqp): TRACE:     _reraise_translated_image_exception(image_id)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 261, in get\n(nova.rpc.amqp): TRACE:     image_id)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/nova/nova/image/glance.py\", line 145, in _call_retry\n(nova.rpc.amqp): TRACE:     return getattr(client, name)(*args, **kwargs)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/client.py\", line 90, in get_image\n(nova.rpc.amqp): TRACE:     res = self.do_request(\"GET\", \"/images/%s\" % image_id)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 58, in wrapped\n(nova.rpc.amqp): TRACE:     return func(self, *args, **kwargs)\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 385, in do_request\n(nova.rpc.amqp): TRACE:     self._authenticate()\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/common/client.py\", line 363, in _authenticate\n(nova.rpc.amqp): TRACE:     auth_plugin.authenticate()\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/common/auth.py\", line 119, in authenticate\n(nova.rpc.amqp): TRACE:     self.check_auth_params()\n(nova.rpc.amqp): TRACE:   File \"/opt/stack/glance/glance/common/auth.py\", line 83, in check_auth_params\n(nova.rpc.amqp): TRACE:     raise exception.MissingCredentialError(required=required)\n(nova.rpc.amqp): TRACE: ImageNotAuthorized: Not authorized for image 9aeafd9b-3f8d-466b-914b-c47a455e01a9.\n(nova.rpc.amqp): TRACE:\n2012-03-07 15:50:13 ERROR nova.rpc.amqp [-] Returning exception Not authorized for image 9aeafd9b-3f8d-466b-914b-c47a455e01a9. to caller\n2012-03-07 15:50:13 ERROR nova.rpc.amqp [-] ['Traceback (most recent call last):\\n', '  File \"/opt/stack/nova/nova/rpc/amqp.py\", line 252, in _process_data\\n    rval = node_func(context=ctxt, **node_args)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 1930, in pre_live_migration\\n    disk)\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 2016, in pre_block_migration\\n    size=info[\\'disk_size\\'])\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 995, in _cache_image\\n    call_if_not_exists(base, fn, *args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/utils.py\", line 858, in inner\\n    retval = f(*args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/connection.py\", line 992, in call_if_not_exists\\n    fn(target=base, *args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/utils.py\", line 264, in fetch_image\\n    images.fetch_to_raw(context, image_id, target, user_id, project_id)\\n', '  File \"/opt/stack/nova/nova/virt/images.py\", line 71, in fetch_to_raw\\n    metadata = fetch(context, image_href, path_tmp, user_id, project_id)\\n', '  File \"/opt/stack/nova/nova/virt/images.py\", line 65, in fetch\\n    (path, e.strerror))\\n', '  File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\\n    self.gen.next()\\n', '  File \"/opt/stack/nova/nova/virt/images.py\", line 57, in fetch\\n    metadata = image_service.get(context, image_id, image_file)\\n', '  File \"/opt/stack/nova/nova/image/glance.py\", line 263, in get\\n    _reraise_translated_image_exception(image_id)\\n', '  File \"/opt/stack/nova/nova/image/glance.py\", line 261, in get\\n    image_id)\\n', '  File \"/opt/stack/nova/nova/image/glance.py\", line 145, in _call_retry\\n    return getattr(client, name)(*args, **kwargs)\\n', '  File \"/opt/stack/glance/glance/client.py\", line 90, in get_image\\n    res = self.do_request(\"GET\", \"/images/%s\" % image_id)\\n', '  File \"/opt/stack/glance/glance/common/client.py\", line 58, in wrapped\\n    return func(self, *args, **kwargs)\\n', '  File \"/opt/stack/glance/glance/common/client.py\", line 385, in do_request\\n    self._authenticate()\\n', '  File \"/opt/stack/glance/glance/common/client.py\", line 363, in _authenticate\\n    auth_plugin.authenticate()\\n', '  File \"/opt/stack/glance/glance/common/auth.py\", line 119, in authenticate\\n    self.check_auth_params()\\n', '  File \"/opt/stack/glance/glance/common/auth.py\", line 83, in check_auth_params\\n    raise exception.MissingCredentialError(required=required)\\n', 'ImageNotAuthorized: Not authorized for image 9aeafd9b-3f8d-466b-914b-c47a455e01a9.\\n']\n\nThe image does exist in glance\nbreu@controller:~/devstack$ nova image-list\n+--------------------------------------+-----------------------------------+--------+--------+\n|                  ID                  |                Name               | Status | Server |\n+--------------------------------------+-----------------------------------+--------+--------+\n| 4611e6f5-f36d-458e-8553-3ec0e86e07de | cirros-0.3.0-x86_64-blank-kernel  | ACTIVE |        |\n| 9aeafd9b-3f8d-466b-914b-c47a455e01a9 | cirros-0.3.0-x86_64-blank         | ACTIVE |        |\n| bfd1f0ac-89a1-4f9f-b060-6265484a04b5 | cirros-0.3.0-x86_64-blank-ramdisk | ACTIVE |        |\n+--------------------------------------+-----------------------------------+--------+--------+", 
            "date_created": "2012-03-07 21:56:42.758049+00:00", 
            "author": "https://api.launchpad.net/1.0/~breu"
        }, 
        {
            "content": "Ok it looks like this is because you're migrating with nova-manage with a glance that is using keystone. Nova-manage knows nothing about credentials so this is bound to fail.\n\nThat said, there are a couple issues with block migration relating to context.  We can fix most of them with a little patch which I will submit, but there is one remaining limitation.\n\nCurrently, block migration will fail if it is based on a private image.  A workaround would be for an administrator to make the image public prior to migrating and set it back private afterwards, but that is pretty ugly.  I'm discussing with keystone how we can handle it better.", 
            "date_created": "2012-03-07 22:53:39.125484+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/5053", 
            "date_created": "2012-03-07 23:28:21.998678+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/5053\nCommitted: http://github.com/openstack/nova/commit/b0f1f1feb59bbca3196d9bba52cd32f46aa84b87\nSubmitter: Jenkins\nBranch:    master\n\ncommit b0f1f1feb59bbca3196d9bba52cd32f46aa84b87\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Wed Mar 7 15:02:13 2012 -0800\n\n    allow block migration to talk to glance/keystone\n    \n     * removes unnecessary get_admin_context()\n     * addresses bug 949438\n    \n    Change-Id: Iec9352f4c07179a39c796d235f0787ade30d5747\n", 
            "date_created": "2012-03-08 18:40:02.790602+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-03-20 08:44:09.928062+00:00"
}