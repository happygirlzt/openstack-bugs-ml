{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:15:45.410163+00:00", 
    "description": "Steps to reproduce:\n\n. devstack/openrc admin\nnova boot --flavor=m1.small --image=$IMAGEID testmachine\ncinder create 1\nnova volume-attach $INSTANCEID $VOLUMEID /dev/xvdb\nnova volume-detach $INSTANCEID $VOLUMEID\n\nStacktrace on n-cpu:\n\nAUDIT nova.compute.manager [req-27df4d59-8b96-432d-9c61-559e3311c05e admin demo] [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] Detach volume 3cbb15ba-a918-4240-be65-6444baf526f2 from mountpoint /dev/xvdb\nERROR nova.virt.xenapi.volume_utils [req-27df4d59-8b96-432d-9c61-559e3311c05e admin demo] ['HANDLE_INVALID', 'VBD', 'OpaqueRef:202022d2-babd-a1f6-afd8-b79389b761cf']\nTRACE nova.virt.xenapi.volume_utils Traceback (most recent call last):\nTRACE nova.virt.xenapi.volume_utils File \"/opt/stack/nova/nova/virt/xenapi/volume_utils.py\", line 173, in find_sr_from_vbd\nTRACE nova.virt.xenapi.volume_utils vdi_ref = session.call_xenapi(\"VBD.get_VDI\", vbd_ref)\nTRACE nova.virt.xenapi.volume_utils File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 709, in call_xenapi\nTRACE nova.virt.xenapi.volume_utils return session.xenapi_request(method, args)\nTRACE nova.virt.xenapi.volume_utils File \"/usr/local/lib/python2.7/dist-packages/XenAPI.py\", line 133, in xenapi_request\nTRACE nova.virt.xenapi.volume_utils result = _parse_result(getattr(self, methodname)(*full_params))\nTRACE nova.virt.xenapi.volume_utils File \"/usr/local/lib/python2.7/dist-packages/XenAPI.py\", line 203, in _parse_result\nTRACE nova.virt.xenapi.volume_utils raise Failure(result['ErrorDescription'])\nTRACE nova.virt.xenapi.volume_utils Failure: ['HANDLE_INVALID', 'VBD', 'OpaqueRef:202022d2-babd-a1f6-afd8-b79389b761cf']\nTRACE nova.virt.xenapi.volume_utils\nERROR nova.virt.xenapi.volumeops [req-27df4d59-8b96-432d-9c61-559e3311c05e admin demo] Unable to find SR from VBD OpaqueRef:202022d2-babd-a1f6-afd8-b79389b761cf\nTRACE nova.virt.xenapi.volumeops Traceback (most recent call last):\nTRACE nova.virt.xenapi.volumeops File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 146, in detach_volume\nTRACE nova.virt.xenapi.volumeops sr_ref = volume_utils.find_sr_from_vbd(self._session, vbd_ref)\nTRACE nova.virt.xenapi.volumeops File \"/opt/stack/nova/nova/virt/xenapi/volume_utils.py\", line 177, in find_sr_from_vbd\nTRACE nova.virt.xenapi.volumeops raise StorageError(_('Unable to find SR from VBD %s') % vbd_ref)\nTRACE nova.virt.xenapi.volumeops StorageError: Unable to find SR from VBD OpaqueRef:202022d2-babd-a1f6-afd8-b79389b761cf\nTRACE nova.virt.xenapi.volumeops\nERROR nova.compute.manager [req-27df4d59-8b96-432d-9c61-559e3311c05e admin demo] [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] Faild to detach volume 3cbb15ba-a918-4240-be65-6444baf526f2 from /dev/xvdb\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] Traceback (most recent call last):\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] File \"/opt/stack/nova/nova/compute/manager.py\", line 2558, in _detach_volume\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] mp)\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 370, in detach_volume\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] mountpoint)\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 150, in detach_volume\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] raise Exception(_('Error purging SR %s') % sr_ref)\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] UnboundLocalError: local variable 'sr_ref' referenced before assignment\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4]\nERROR nova.openstack.common.rpc.amqp [req-27df4d59-8b96-432d-9c61-559e3311c05e admin demo] Exception during message handling\nTRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\nTRACE nova.openstack.common.rpc.amqp rval = self.proxy.dispatch(ctxt, version, method, **args)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\nTRACE nova.openstack.common.rpc.amqp return getattr(proxyobj, method)(ctxt, **kwargs)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/exception.py\", line 110, in wrapped\nTRACE nova.openstack.common.rpc.amqp temp_level, payload)\nTRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nTRACE nova.openstack.common.rpc.amqp self.gen.next()\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/exception.py\", line 89, in wrapped\nTRACE nova.openstack.common.rpc.amqp return f(self, context, *args, **kw)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 206, in decorated_function\nTRACE nova.openstack.common.rpc.amqp pass\nTRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nTRACE nova.openstack.common.rpc.amqp self.gen.next()\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 192, in decorated_function\nTRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 233, in decorated_function\nTRACE nova.openstack.common.rpc.amqp kwargs['instance'], e, sys.exc_info())\nTRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nTRACE nova.openstack.common.rpc.amqp self.gen.next()\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 221, in decorated_function\nTRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 2593, in detach_volume\nTRACE nova.openstack.common.rpc.amqp self._detach_volume(context, instance, bdm)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 2565, in _detach_volume\nTRACE nova.openstack.common.rpc.amqp self.volume_api.roll_detaching(context, volume)\nTRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nTRACE nova.openstack.common.rpc.amqp self.gen.next()\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 2558, in _detach_volume\nTRACE nova.openstack.common.rpc.amqp mp)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 370, in detach_volume\nTRACE nova.openstack.common.rpc.amqp mountpoint)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 150, in detach_volume\nTRACE nova.openstack.common.rpc.amqp raise Exception(_('Error purging SR %s') % sr_ref)\nTRACE nova.openstack.common.rpc.amqp UnboundLocalError: local variable 'sr_ref' referenced before assignment\nTRACE nova.openstack.common.rpc.amqp\n\nSo 2 problems:\n- One for the volume detach error\n- One for the UnboundLocalError", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1101229", 
    "owner": "https://api.launchpad.net/1.0/~mate-lakat", 
    "id": 1101229, 
    "index": 4593, 
    "openned": "2013-01-18 14:54:07.145420+00:00", 
    "created": "2013-01-18 14:54:07.145420+00:00", 
    "title": "xenapi: error on volume detach StorageError: Unable to find SR from VBD", 
    "comments": [
        {
            "content": "Steps to reproduce:\n\n. devstack/openrc admin\nnova boot --flavor=m1.small --image=$IMAGEID testmachine\ncinder create 1\nnova volume-attach $INSTANCEID $VOLUMEID /dev/xvdb\nnova volume-detach $INSTANCEID $VOLUMEID\n\nStacktrace:\n\nAUDIT nova.compute.manager [req-27df4d59-8b96-432d-9c61-559e3311c05e admin demo] [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] Detach volume 3cbb15ba-a918-4240-be65-6444baf526f2 from mountpoint /dev/xvdb\nERROR nova.virt.xenapi.volume_utils [req-27df4d59-8b96-432d-9c61-559e3311c05e admin demo] ['HANDLE_INVALID', 'VBD', 'OpaqueRef:202022d2-babd-a1f6-afd8-b79389b761cf']\nTRACE nova.virt.xenapi.volume_utils Traceback (most recent call last):\nTRACE nova.virt.xenapi.volume_utils File \"/opt/stack/nova/nova/virt/xenapi/volume_utils.py\", line 173, in find_sr_from_vbd\nTRACE nova.virt.xenapi.volume_utils vdi_ref = session.call_xenapi(\"VBD.get_VDI\", vbd_ref)\nTRACE nova.virt.xenapi.volume_utils File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 709, in call_xenapi\nTRACE nova.virt.xenapi.volume_utils return session.xenapi_request(method, args)\nTRACE nova.virt.xenapi.volume_utils File \"/usr/local/lib/python2.7/dist-packages/XenAPI.py\", line 133, in xenapi_request\nTRACE nova.virt.xenapi.volume_utils result = _parse_result(getattr(self, methodname)(*full_params))\nTRACE nova.virt.xenapi.volume_utils File \"/usr/local/lib/python2.7/dist-packages/XenAPI.py\", line 203, in _parse_result\nTRACE nova.virt.xenapi.volume_utils raise Failure(result['ErrorDescription'])\nTRACE nova.virt.xenapi.volume_utils Failure: ['HANDLE_INVALID', 'VBD', 'OpaqueRef:202022d2-babd-a1f6-afd8-b79389b761cf']\nTRACE nova.virt.xenapi.volume_utils \nERROR nova.virt.xenapi.volumeops [req-27df4d59-8b96-432d-9c61-559e3311c05e admin demo] Unable to find SR from VBD OpaqueRef:202022d2-babd-a1f6-afd8-b79389b761cf\nTRACE nova.virt.xenapi.volumeops Traceback (most recent call last):\nTRACE nova.virt.xenapi.volumeops File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 146, in detach_volume\nTRACE nova.virt.xenapi.volumeops sr_ref = volume_utils.find_sr_from_vbd(self._session, vbd_ref)\nTRACE nova.virt.xenapi.volumeops File \"/opt/stack/nova/nova/virt/xenapi/volume_utils.py\", line 177, in find_sr_from_vbd\nTRACE nova.virt.xenapi.volumeops raise StorageError(_('Unable to find SR from VBD %s') % vbd_ref)\nTRACE nova.virt.xenapi.volumeops StorageError: Unable to find SR from VBD OpaqueRef:202022d2-babd-a1f6-afd8-b79389b761cf\nTRACE nova.virt.xenapi.volumeops \nERROR nova.compute.manager [req-27df4d59-8b96-432d-9c61-559e3311c05e admin demo] [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] Faild to detach volume 3cbb15ba-a918-4240-be65-6444baf526f2 from /dev/xvdb\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] Traceback (most recent call last):\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] File \"/opt/stack/nova/nova/compute/manager.py\", line 2558, in _detach_volume\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] mp)\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 370, in detach_volume\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] mountpoint)\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 150, in detach_volume\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] raise Exception(_('Error purging SR %s') % sr_ref)\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] UnboundLocalError: local variable 'sr_ref' referenced before assignment\nTRACE nova.compute.manager [instance: 3679b9d8-c8ea-4ddc-a13f-a5d0d630d6f4] \nERROR nova.openstack.common.rpc.amqp [req-27df4d59-8b96-432d-9c61-559e3311c05e admin demo] Exception during message handling\nTRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\nTRACE nova.openstack.common.rpc.amqp rval = self.proxy.dispatch(ctxt, version, method, **args)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\nTRACE nova.openstack.common.rpc.amqp return getattr(proxyobj, method)(ctxt, **kwargs)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/exception.py\", line 110, in wrapped\nTRACE nova.openstack.common.rpc.amqp temp_level, payload)\nTRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nTRACE nova.openstack.common.rpc.amqp self.gen.next()\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/exception.py\", line 89, in wrapped\nTRACE nova.openstack.common.rpc.amqp return f(self, context, *args, **kw)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 206, in decorated_function\nTRACE nova.openstack.common.rpc.amqp pass\nTRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nTRACE nova.openstack.common.rpc.amqp self.gen.next()\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 192, in decorated_function\nTRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 233, in decorated_function\nTRACE nova.openstack.common.rpc.amqp kwargs['instance'], e, sys.exc_info())\nTRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nTRACE nova.openstack.common.rpc.amqp self.gen.next()\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 221, in decorated_function\nTRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 2593, in detach_volume\nTRACE nova.openstack.common.rpc.amqp self._detach_volume(context, instance, bdm)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 2565, in _detach_volume\nTRACE nova.openstack.common.rpc.amqp self.volume_api.roll_detaching(context, volume)\nTRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\nTRACE nova.openstack.common.rpc.amqp self.gen.next()\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/compute/manager.py\", line 2558, in _detach_volume\nTRACE nova.openstack.common.rpc.amqp mp)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 370, in detach_volume\nTRACE nova.openstack.common.rpc.amqp mountpoint)\nTRACE nova.openstack.common.rpc.amqp File \"/opt/stack/nova/nova/virt/xenapi/volumeops.py\", line 150, in detach_volume\nTRACE nova.openstack.common.rpc.amqp raise Exception(_('Error purging SR %s') % sr_ref)\nTRACE nova.openstack.common.rpc.amqp UnboundLocalError: local variable 'sr_ref' referenced before assignment\nTRACE nova.openstack.common.rpc.amqp\n\nSo 2 problems:\n- One for the volume detach error\n- One for the UnboundLocalError", 
            "date_created": "2013-01-18 14:54:07.145420+00:00", 
            "author": "https://api.launchpad.net/1.0/~mate-lakat"
        }, 
        {
            "content": "This bug was introduced by:\nhttps://review.openstack.org/#/c/19219/\n\nThe problem, is that the vbd is already destroyed when we try to get hold of the sr", 
            "date_created": "2013-01-18 15:24:06.228365+00:00", 
            "author": "https://api.launchpad.net/1.0/~mate-lakat"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/20031", 
            "date_created": "2013-01-18 16:01:53.547410+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/20031\nCommitted: http://github.com/openstack/nova/commit/41848d419cc87f3344c2d071e42561bb52c0c577\nSubmitter: Jenkins\nBranch:    master\n\ncommit 41848d419cc87f3344c2d071e42561bb52c0c577\nAuthor: Mate Lakat <email address hidden>\nDate:   Fri Jan 18 15:12:15 2013 +0000\n\n    XenAPI: Fix volume detach\n    \n    fixes bug 1101229\n    \n    The code-cleanup and code-move changes from this patch:\n    https://review.openstack.org/#/c/19219/\n    introduced a problem: the volume_utils.find_sr_from_vbd method was\n    called after the vbd has already been destroyed. This change fixes the\n    issue by moving the sr discovery before the vbd destruction, and tests\n    the call order by using side effects.\n    \n    Change-Id: Ide4f8ac810f98bb192909f5f0408affc940e7446\n", 
            "date_created": "2013-01-23 18:02:56.927520+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-02-21 09:02:03.655340+00:00"
}