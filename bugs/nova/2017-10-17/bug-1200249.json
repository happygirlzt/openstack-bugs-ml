{
    "status": "Fix Released", 
    "last_updated": "2014-03-21 11:10:39.457181+00:00", 
    "description": "Repro steps:\n1) Deploy nova with force_raw_images=False and use_cow_images=False\n2) Boot an instance from a qcow2 image\n3) Wait until this instance is ACTIVE\n4) Issue a hard-reboot action on this instance\n\nOutcome:\nThe instance transitions to HARD_REBOOT like expected, but then to SHUTOFF. The underlying VM never starts after the hard reboot action is issued.\n\nExpected:\nThe instance should properly transition through HARD_REBOOT and back to ACTIVE. The VM should become reachable once that status transition has occurred.\n\n\n\nI was able to find the following log generated by nova-compute:\n\n2013-07-05 14:44:09.128 ERROR nova.compute.manager [req-8d0a3a55-8d5a-44c7-ac25-bb7dc57508ec bc7764aa97a647d19081586d69f5b444 46ef8994dca44846ae364165c4d13357] [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] Cannot reboot instance: 'NoneType' object has no attribute 'rfind'' in the nova-compute log\n\n\nI found the source of that log statement and logged at the 'exception' level rather than the 'error level to produce this traceback:\n\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1717, in reboot_instance\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] bad_volumes_callback=bad_volumes_callback)\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1303, in reboot\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] block_device_info)\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1379, in _hard_reboot\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] self._create_images_and_backing(context, instance, disk_info_json)\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 3265, in _create_images_and_backing\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] cache_name = os.path.basename(info['backing_file'])\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] File \"/usr/lib/python2.7/posixpath.py\", line 112, in basename\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] i = p.rfind('/') + 1\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] AttributeError: 'NoneType' object has no attribute 'rfind'\n\n\nI traced back through the code and ran this command:\n\n$ qemu-img info /mnt/instances/fbc0f8c2-6743-4ddc-832c-1861be0b49d9/disk\nimage: /mnt/instances/fbc0f8c2-6743-4ddc-832c-1861be0b49d9/disk\nfile format: qcow2\nvirtual size: 20G (21474836480 bytes)\ndisk size: 705M\ncluster_size: 65536\n\n\nSo it appears that Nova is expecting a backing_file key from all qcow2 images, yet when one happens  to set use_cow_images=False and force_raw_images=False that will not be true.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1200249", 
    "owner": "https://api.launchpad.net/1.0/~bcwaldon", 
    "id": 1200249, 
    "index": 5101, 
    "openned": "2013-07-11 14:32:21.055924+00:00", 
    "created": "2013-07-11 14:32:21.055924+00:00", 
    "title": "hard reboot fails when using force_raw_images=False and use_cow_images=False and ", 
    "comments": [
        {
            "content": "Repro steps:\n1) Deploy nova with force_raw_images=False and use_cow_images=False\n2) Boot an instance from a qcow2 image\n3) Wait until this instance is ACTIVE\n4) Issue a hard-reboot action on this instance\n\nOutcome:\nThe instance transitions to HARD_REBOOT like expected, but then to SHUTOFF. The underlying VM never starts after the hard reboot action is issued.\n\nExpected:\nThe instance should properly transition through HARD_REBOOT and back to ACTIVE. The VM should become reachable once that status transition has occurred.\n\n\n\nI was able to find the following log generated by nova-compute:\n\n2013-07-05 14:44:09.128 ERROR nova.compute.manager [req-8d0a3a55-8d5a-44c7-ac25-bb7dc57508ec bc7764aa97a647d19081586d69f5b444 46ef8994dca44846ae364165c4d13357] [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] Cannot reboot instance: 'NoneType' object has no attribute 'rfind'' in the nova-compute log\n\n\nI found the source of that log statement and logged at the 'exception' level rather than the 'error level to produce this traceback:\n\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1717, in reboot_instance\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] bad_volumes_callback=bad_volumes_callback)\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1303, in reboot\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] block_device_info)\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1379, in _hard_reboot\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] self._create_images_and_backing(context, instance, disk_info_json)\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 3265, in _create_images_and_backing\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] cache_name = os.path.basename(info['backing_file'])\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] File \"/usr/lib/python2.7/posixpath.py\", line 112, in basename\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] i = p.rfind('/') + 1\n2013-07-05 14:47:02.635 13318 TRACE nova.compute.manager [instance: fbc0f8c2-6743-4ddc-832c-1861be0b49d9] AttributeError: 'NoneType' object has no attribute 'rfind'\n\n\nI traced back through the code and ran this command:\n\n$ qemu-img info /mnt/instances/fbc0f8c2-6743-4ddc-832c-1861be0b49d9/disk\nimage: /mnt/instances/fbc0f8c2-6743-4ddc-832c-1861be0b49d9/disk\nfile format: qcow2\nvirtual size: 20G (21474836480 bytes)\ndisk size: 705M\ncluster_size: 65536\n\n\nSo it appears that Nova is expecting a backing_file key from all qcow2 images, yet when one happens  to set use_cow_images=False and force_raw_images=False that will not be true.", 
            "date_created": "2013-07-11 14:32:21.055924+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "The following patch allowed hard reboot actions to work as expected for me:\n\ndiff --git a/nova/virt/libvirt/driver.py b/nova/virt/libvirt/driver.py\nindex e81efcc..2810c06 100755\n--- a/nova/virt/libvirt/driver.py\n+++ b/nova/virt/libvirt/driver.py\n@@ -3260,7 +3260,7 @@ class LibvirtDriver(driver.ComputeDriver):\n             if not info['backing_file'] and not os.path.exists(instance_disk):\n                 libvirt_utils.create_image(info['type'], instance_disk,\n                                            info['disk_size'])\n- else:\n+ elif info['backing_file']:\n                 # Creating backing file follows same way as spawning instances.\n                 cache_name = os.path.basename(info['backing_file'])\n                 # Remove any size tags which the cache manages", 
            "date_created": "2013-07-11 14:33:19.763248+00:00", 
            "author": "https://api.launchpad.net/1.0/~bcwaldon"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/37290", 
            "date_created": "2013-07-16 16:58:47.119164+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/37290\nCommitted: http://github.com/openstack/nova/commit/879565efe51f19bd6f4d69d1b430b995f62106c8\nSubmitter: Jenkins\nBranch:    master\n\ncommit 879565efe51f19bd6f4d69d1b430b995f62106c8\nAuthor: Brian Waldon <email address hidden>\nDate:   Tue Jul 16 09:57:58 2013 -0700\n\n    Assert backing_file should exist before attempting to create it\n    \n    Fixes bug 1200249\n    \n    Change-Id: If7878361711f835247aaf64ce26f0058f8c4b5ba\n", 
            "date_created": "2013-07-17 09:55:09.855941+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/grizzly\nReview: https://review.openstack.org/48557", 
            "date_created": "2013-09-27 02:43:09.636759+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/48557\nCommitted: http://github.com/openstack/nova/commit/97aa6b4343bb1130727e8276c4cc2aa123677dfd\nSubmitter: Jenkins\nBranch:    stable/grizzly\n\ncommit 97aa6b4343bb1130727e8276c4cc2aa123677dfd\nAuthor: Brian Waldon <email address hidden>\nDate:   Tue Jul 16 09:57:58 2013 -0700\n\n    Assert backing_file should exist before attempting to create it\n    \n    Fixes bug 1200249\n    \n    Change-Id: If7878361711f835247aaf64ce26f0058f8c4b5ba\n    (cherry picked from commit 879565efe51f19bd6f4d69d1b430b995f62106c8)\n", 
            "date_created": "2013-10-07 18:47:24.588585+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-07-17 12:37:03.280085+00:00"
}