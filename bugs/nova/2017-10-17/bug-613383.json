{
    "status": "Fix Released", 
    "last_updated": "2016-03-25 09:47:36.543352+00:00", 
    "description": "I get the following exception:\n\n2010-08-04 11:42:36+0100 [-] (root): INFO Deleting instance files at /home/openstack/openstack/nova/data/instances/i-09mdf4sw\n2010-08-04 11:42:36+0100 [-] Unhandled error in Deferred:\n2010-08-04 11:42:36+0100 [-] Unhandled Error\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Traceback (most recent call last):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.6/dist-packages/twisted/internet/defer.py\", line 117, in maybeDeferred\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0result = f(*args, **kw)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/home/openstack/openstack/nova/trunk/nova/virt/libvirt_conn.py\", line 102, in _wait_for_shutdown\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0d.callback(None)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.6/dist-packages/twisted/internet/defer.py\", line 280, in callback\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self._startRunCallbacks(result)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.6/dist-packages/twisted/internet/defer.py\", line 354, in _startRunCallbacks\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self._runCallbacks()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0--- <exception caught here> ---\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.6/dist-packages/twisted/internet/defer.py\", line 371, in _runCallbacks\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.result = callback(self.result, *args, **kw)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/home/openstack/openstack/nova/trunk/nova/virt/libvirt_conn.py\", line 87, in <lambda>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0d.addCallback(lambda _: self._cleanup(instance))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/home/openstack/openstack/nova/trunk/nova/virt/libvirt_conn.py\", line 111, in _cleanup\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0shutil.rmtree(target)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.6/shutil.py\", line 208, in rmtree\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0onerror(os.listdir, path, sys.exc_info())\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.6/shutil.py\", line 206, in rmtree\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0names = os.listdir(path)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0exceptions.OSError: [Errno 2] No such file or directory: '~/openstack/nova/data/instances/i-09mdf4sw'\n\nWhen the directory of the instance I am trying to terminate no longer exist (or has never been created due to errors on startup). However, euca-describe-instances still shows the instance in the list. In order to work this around (and remove the instance from the list) I create an empty directory under 'instances' and launch euca-terminate-instances again. I then get the following output:\n\n2010-08-04 11:50:28+0100 [-] (root): DEBUG Got told to terminate instance i-09mdf4sw\n2010-08-04 11:50:28+0100 [-] (root): DEBUG Finished init of Instance with id of i-09mdf4sw\n2010-08-04 11:50:28+0100 [-] (root): INFO Deleting instance files at /home/openstack/openstack/nova/data/instances/i-09mdf4sw\n2010-08-04 11:50:28+0100 [-] (root): INFO Destroying datamodel for Instance i-09mdf4sw\n\nand the directory being removed under 'instances'", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/613383", 
    "owner": "None", 
    "id": 613383, 
    "index": 2191, 
    "openned": "2010-08-04 09:51:49.078074+00:00", 
    "created": "2010-08-04 09:51:49.078074+00:00", 
    "title": "euca-terminate-instances fails to remove instance", 
    "comments": [
        {
            "content": "I get the following exception:\n\n2010-08-04 11:42:36+0100 [-] (root): INFO Deleting instance files at /home/openstack/openstack/nova/data/instances/i-09mdf4sw\n2010-08-04 11:42:36+0100 [-] Unhandled error in Deferred:\n2010-08-04 11:42:36+0100 [-] Unhandled Error\n        Traceback (most recent call last):\n          File \"/usr/lib/python2.6/dist-packages/twisted/internet/defer.py\", line 117, in maybeDeferred\n            result = f(*args, **kw)\n          File \"/home/openstack/openstack/nova/trunk/nova/virt/libvirt_conn.py\", line 102, in _wait_for_shutdown\n            d.callback(None)\n          File \"/usr/lib/python2.6/dist-packages/twisted/internet/defer.py\", line 280, in callback\n            self._startRunCallbacks(result)\n          File \"/usr/lib/python2.6/dist-packages/twisted/internet/defer.py\", line 354, in _startRunCallbacks\n            self._runCallbacks()\n        --- <exception caught here> ---\n          File \"/usr/lib/python2.6/dist-packages/twisted/internet/defer.py\", line 371, in _runCallbacks\n            self.result = callback(self.result, *args, **kw)\n          File \"/home/openstack/openstack/nova/trunk/nova/virt/libvirt_conn.py\", line 87, in <lambda>\n            d.addCallback(lambda _: self._cleanup(instance))\n          File \"/home/openstack/openstack/nova/trunk/nova/virt/libvirt_conn.py\", line 111, in _cleanup\n            shutil.rmtree(target)\n          File \"/usr/lib/python2.6/shutil.py\", line 208, in rmtree\n            onerror(os.listdir, path, sys.exc_info())\n          File \"/usr/lib/python2.6/shutil.py\", line 206, in rmtree\n            names = os.listdir(path)\n        exceptions.OSError: [Errno 2] No such file or directory: '~/openstack/nova/data/instances/i-09mdf4sw'\n\nWhen the directory of the instance I am trying to terminate no longer exist (or has never been created due to errors on startup). However, euca-describe-instances still shows the instance in the list. In order to work this around (and remove the instance from the list) I create an empty directory under 'instances' and launch euca-terminate-instances again. I then get the following output:\n\n2010-08-04 11:50:28+0100 [-] (root): DEBUG Got told to terminate instance i-09mdf4sw\n2010-08-04 11:50:28+0100 [-] (root): DEBUG Finished init of Instance with id of i-09mdf4sw\n2010-08-04 11:50:28+0100 [-] (root): INFO Deleting instance files at /home/openstack/openstack/nova/data/instances/i-09mdf4sw\n2010-08-04 11:50:28+0100 [-] (root): INFO Destroying datamodel for Instance i-09mdf4sw\n\nand the directory being removed under 'instances'", 
            "date_created": "2010-08-04 09:51:49.078074+00:00", 
            "author": "https://api.launchpad.net/1.0/~armando-migliaccio"
        }, 
        {
            "content": "The current code in LibvirtConnection._cleanup() is:\n\n    def _cleanup(self, instance):\n        target = os.path.join(FLAGS.instances_path, instance['name'])\n        logging.info('instance %s: deleting instance files %s',\n            instance['name'], target)\n        if os.path.exists(target):\n            shutil.rmtree(target)\n\nWould you mind double-checking to see if this problem still exists, please, as it looks like the fix (checking for target directory existence before calling shutil.rmtree) is in trunk.  Thanks!", 
            "date_created": "2010-10-05 21:35:57.242007+00:00", 
            "author": "https://api.launchpad.net/1.0/~jaypipes"
        }, 
        {
            "content": "yup, I think we can close it", 
            "date_created": "2010-10-11 08:12:39.066746+00:00", 
            "author": "https://api.launchpad.net/1.0/~armando-migliaccio"
        }, 
        {
            "content": "k, thx!", 
            "date_created": "2010-10-11 13:20:23.106360+00:00", 
            "author": "https://api.launchpad.net/1.0/~jaypipes"
        }
    ], 
    "closed": "2010-10-25 20:23:56.238915+00:00"
}