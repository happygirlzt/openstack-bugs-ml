{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 09:33:49.585779+00:00", 
    "description": "I'm getting some libvirt test failures when using nova trunk:\n\n\n[dan.prince@dovetail trunk]$  ./run_tests.sh -N test_libvirt\nCacheConcurrencyTestCase\n    test_different_fname_concurrency                            OK  0.00\n    test_same_fname_concurrency                                 OK  0.00\nIptablesFirewallTestCase\n    test_do_refresh_security_group_rules                        OK  0.01\n    test_filters_for_instance_with_ip_v6                        OK  0.00\n    test_filters_for_instance_without_ip_v6                     OK  0.00\n    test_multinic_iptables                                      OK  0.03\n    test_provider_firewall_rules                                OK  0.07\n    test_static_filters                                         OK  0.37\n    test_unfilter_instance_undefines_nwfilter                   OK  0.05\nLibvirtConnTestCase\n    test_attach_invalid_device                                  OK  0.03\n    test_ensure_filtering_rules_for_instance_timeout            ERROR\nERROR\n    test_get_host_ip_addr                                       OK  0.01\n    test_get_instance_disk_info_works_correctly                 OK  0.02\n    test_live_migration_raises_exception                        OK  0.40\n    test_lxc_container_and_uri                                  OK  0.16\n    test_multi_nic                                              OK  0.08\n    test_pre_block_migration_works_correctly                    OK  0.02\n    test_preparing_xml_info                                     OK  0.14\n    test_snapshot                                               OK  0.01\n    test_snapshot_no_image_architecture                         OK  0.01\n    test_spawn_with_network_info                                FAIL\n    test_update_available_resource_works_correctly              OK  0.05\n    test_update_resource_info_no_compute_record_found           OK  0.01\n    test_volume_in_mapping                                      OK  0.01\n    test_xml_and_uri                                            OK  0.31\n    test_xml_and_uri_no_kernel                                  OK  0.30\n    test_xml_and_uri_no_ramdisk                                 OK  0.34\n    test_xml_and_uri_no_ramdisk_no_kernel                       OK  0.30\n    test_xml_and_uri_rescue                                     OK  0.39\nNWFilterTestCase\n    test_cidr_rule_nwfilter_xml                                 OK  0.21\n    test_create_network_filters                                 OK  0.01\n    test_creates_base_rule_first                                OK  0.39\n    test_unfilter_instance_undefines_nwfilters                  OK  0.36\n\n======================================================================\nERROR: test_ensure_filtering_rules_for_instance_timeout (nova.tests.test_libvirt.LibvirtConnTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/dan.prince/projects/nova/trunk/nova/tests/test_libvirt.py\", line 606, in test_ensure_filtering_rules_for_instance_timeout\n    network_info = _fake_network_info(self.stubs, 1)\n  File \"/home/dan.prince/projects/nova/trunk/nova/tests/fake_network.py\", line 142, in fake_get_instance_nw_info\n    network = network_manager.FlatManager(host=HOST)\n  File \"/home/dan.prince/projects/nova/trunk/nova/network/manager.py\", line 334, in __init__\n    self.compute_api = compute_api.API()\n  File \"/home/dan.prince/projects/nova/trunk/nova/compute/api.py\", line 102, in __init__\n    nova.image.get_default_image_service()\n  File \"/home/dan.prince/projects/nova/trunk/nova/image/__init__.py\", line 29, in get_default_image_service\n    return ImageService()\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 927, in Check\n    % (' '.join(sorted(still_needed))))\nAttributeError: No values given for arguments: import_str\n\n======================================================================\nERROR: test_ensure_filtering_rules_for_instance_timeout (nova.tests.test_libvirt.LibvirtConnTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/dan.prince/projects/nova/trunk/nova/test.py\", line 141, in tearDown\n    self.mox.VerifyAll()\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 284, in VerifyAll\n    mock_obj._Verify()\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 504, in _Verify\n    raise ExpectedMethodCallsError(self._expected_calls_queue)\nExpectedMethodCallsError: Verify: Expected methods never called:\n  0.  import_class.__call__(<IgnoreArg>) -> <class 'nova.tests.test_libvirt.FakeIptablesFirewallDriver'>\n  1.  import_class.__call__() -> None\n\n======================================================================\nFAIL: test_spawn_with_network_info (nova.tests.test_libvirt.LibvirtConnTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/dan.prince/projects/nova/trunk/nova/tests/test_libvirt.py\", line 790, in test_spawn_with_network_info\n    network_info = _fake_network_info(self.stubs, 1)\n  File \"/home/dan.prince/projects/nova/trunk/nova/tests/fake_network.py\", line 142, in fake_get_instance_nw_info\n    network = network_manager.FlatManager(host=HOST)\n  File \"/home/dan.prince/projects/nova/trunk/nova/network/manager.py\", line 332, in __init__\n    self.driver = utils.import_object(network_driver)\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 763, in __call__\n    return mock_method(*params, **named_params)\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 1000, in __call__\n    expected_method = self._VerifyMethodCall()\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 1047, in _VerifyMethodCall\n    expected = self._PopNextMethod()\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 1033, in _PopNextMethod\n    raise UnexpectedMethodCallError(self, None)\nUnexpectedMethodCallError: Unexpected method call import_object.__call__('nova.network.linux_net') -> None\n\n----------------------------------------------------------------------\nRan 33 tests in 5.130s\n\nFAILED (errors=2, failures=1)\nSlowest 5 tests took 1.90 secs:\n    0.40       test_live_migration_raises_exception (nova.tests.test_libvirt.LibvirtConnTestCase)\n    0.39       test_xml_and_uri_rescue (nova.tests.test_libvirt.LibvirtConnTestCase)\n    0.39       test_creates_base_rule_first (nova.tests.test_libvirt.NWFilterTestCase)\n    0.37       test_static_filters (nova.tests.test_libvirt.IptablesFirewallTestCase)\n    0.36       test_unfilter_instance_undefines_nwfilters (nova.tests.test_libvirt.NWFilterTestCase)\n\n---\n\nThe failures seem to stem from the fact that we are mocking out import_class and import_object. Using flags and fakes seems like a saner way to implement things in test_libvirt...", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/849329", 
    "owner": "https://api.launchpad.net/1.0/~dan-prince", 
    "id": 849329, 
    "index": 2557, 
    "openned": "2011-09-13 19:20:11.261555+00:00", 
    "created": "2011-09-13 19:20:11.261555+00:00", 
    "title": "test_libvirt shouldn't mock import_class/import_object", 
    "comments": [
        {
            "content": "I'm getting some libvirt test failures when using nova trunk:\n\n\n[dan.prince@dovetail trunk]$  ./run_tests.sh -N test_libvirt\nCacheConcurrencyTestCase\n    test_different_fname_concurrency                            OK  0.00\n    test_same_fname_concurrency                                 OK  0.00\nIptablesFirewallTestCase\n    test_do_refresh_security_group_rules                        OK  0.01\n    test_filters_for_instance_with_ip_v6                        OK  0.00\n    test_filters_for_instance_without_ip_v6                     OK  0.00\n    test_multinic_iptables                                      OK  0.03\n    test_provider_firewall_rules                                OK  0.07\n    test_static_filters                                         OK  0.37\n    test_unfilter_instance_undefines_nwfilter                   OK  0.05\nLibvirtConnTestCase\n    test_attach_invalid_device                                  OK  0.03\n    test_ensure_filtering_rules_for_instance_timeout            ERROR\nERROR\n    test_get_host_ip_addr                                       OK  0.01\n    test_get_instance_disk_info_works_correctly                 OK  0.02\n    test_live_migration_raises_exception                        OK  0.40\n    test_lxc_container_and_uri                                  OK  0.16\n    test_multi_nic                                              OK  0.08\n    test_pre_block_migration_works_correctly                    OK  0.02\n    test_preparing_xml_info                                     OK  0.14\n    test_snapshot                                               OK  0.01\n    test_snapshot_no_image_architecture                         OK  0.01\n    test_spawn_with_network_info                                FAIL\n    test_update_available_resource_works_correctly              OK  0.05\n    test_update_resource_info_no_compute_record_found           OK  0.01\n    test_volume_in_mapping                                      OK  0.01\n    test_xml_and_uri                                            OK  0.31\n    test_xml_and_uri_no_kernel                                  OK  0.30\n    test_xml_and_uri_no_ramdisk                                 OK  0.34\n    test_xml_and_uri_no_ramdisk_no_kernel                       OK  0.30\n    test_xml_and_uri_rescue                                     OK  0.39\nNWFilterTestCase\n    test_cidr_rule_nwfilter_xml                                 OK  0.21\n    test_create_network_filters                                 OK  0.01\n    test_creates_base_rule_first                                OK  0.39\n    test_unfilter_instance_undefines_nwfilters                  OK  0.36\n\n======================================================================\nERROR: test_ensure_filtering_rules_for_instance_timeout (nova.tests.test_libvirt.LibvirtConnTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/dan.prince/projects/nova/trunk/nova/tests/test_libvirt.py\", line 606, in test_ensure_filtering_rules_for_instance_timeout\n    network_info = _fake_network_info(self.stubs, 1)\n  File \"/home/dan.prince/projects/nova/trunk/nova/tests/fake_network.py\", line 142, in fake_get_instance_nw_info\n    network = network_manager.FlatManager(host=HOST)\n  File \"/home/dan.prince/projects/nova/trunk/nova/network/manager.py\", line 334, in __init__\n    self.compute_api = compute_api.API()\n  File \"/home/dan.prince/projects/nova/trunk/nova/compute/api.py\", line 102, in __init__\n    nova.image.get_default_image_service()\n  File \"/home/dan.prince/projects/nova/trunk/nova/image/__init__.py\", line 29, in get_default_image_service\n    return ImageService()\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 927, in Check\n    % (' '.join(sorted(still_needed))))\nAttributeError: No values given for arguments: import_str\n\n======================================================================\nERROR: test_ensure_filtering_rules_for_instance_timeout (nova.tests.test_libvirt.LibvirtConnTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/dan.prince/projects/nova/trunk/nova/test.py\", line 141, in tearDown\n    self.mox.VerifyAll()\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 284, in VerifyAll\n    mock_obj._Verify()\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 504, in _Verify\n    raise ExpectedMethodCallsError(self._expected_calls_queue)\nExpectedMethodCallsError: Verify: Expected methods never called:\n  0.  import_class.__call__(<IgnoreArg>) -> <class 'nova.tests.test_libvirt.FakeIptablesFirewallDriver'>\n  1.  import_class.__call__() -> None\n\n======================================================================\nFAIL: test_spawn_with_network_info (nova.tests.test_libvirt.LibvirtConnTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/dan.prince/projects/nova/trunk/nova/tests/test_libvirt.py\", line 790, in test_spawn_with_network_info\n    network_info = _fake_network_info(self.stubs, 1)\n  File \"/home/dan.prince/projects/nova/trunk/nova/tests/fake_network.py\", line 142, in fake_get_instance_nw_info\n    network = network_manager.FlatManager(host=HOST)\n  File \"/home/dan.prince/projects/nova/trunk/nova/network/manager.py\", line 332, in __init__\n    self.driver = utils.import_object(network_driver)\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 763, in __call__\n    return mock_method(*params, **named_params)\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 1000, in __call__\n    expected_method = self._VerifyMethodCall()\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 1047, in _VerifyMethodCall\n    expected = self._PopNextMethod()\n  File \"/usr/lib/python2.7/site-packages/mox.py\", line 1033, in _PopNextMethod\n    raise UnexpectedMethodCallError(self, None)\nUnexpectedMethodCallError: Unexpected method call import_object.__call__('nova.network.linux_net') -> None\n\n----------------------------------------------------------------------\nRan 33 tests in 5.130s\n\nFAILED (errors=2, failures=1)\nSlowest 5 tests took 1.90 secs:\n    0.40       test_live_migration_raises_exception (nova.tests.test_libvirt.LibvirtConnTestCase)\n    0.39       test_xml_and_uri_rescue (nova.tests.test_libvirt.LibvirtConnTestCase)\n    0.39       test_creates_base_rule_first (nova.tests.test_libvirt.NWFilterTestCase)\n    0.37       test_static_filters (nova.tests.test_libvirt.IptablesFirewallTestCase)\n    0.36       test_unfilter_instance_undefines_nwfilters (nova.tests.test_libvirt.NWFilterTestCase)\n\n---\n\nThe failures seem to stem from the fact that we are mocking out import_class and import_object. Using flags and fakes seems like a saner way to implement things in test_libvirt...", 
            "date_created": "2011-09-13 19:20:11.261555+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "> The failures seem to stem from the fact that we are mocking out\n> import_class and import_object. Using flags and fakes seems like a saner\n> way to implement things in test_libvirt...\n\nI have a branch awaiting review that does exactly this\n(~soren/nova/virt-test-improvements). It has a fakelibvirt\nimplementation that has an API identical to libvirt's, but doesn't\nactually do anything apart from bookkeeping.\n", 
            "date_created": "2011-09-14 16:40:41+00:00", 
            "author": "https://api.launchpad.net/1.0/~soren"
        }, 
        {
            "content": "Hey Soren,\n\nI like the refactoring you've done as well. What I did was much more specific to some test failures that crept in late last week. I was getting libvirt test failures all of a sudden. I did a bit of refactoring mostly targeted at removing the mocking of import_class and import_object.\n\nSorry. I missed that your branch was another possible solution here. Let me know if I can help merge any conflicts. If your tests are better it should just be a matter of overwritting the test_libvirt.py in trunk and moving forward.", 
            "date_created": "2011-09-14 17:23:39.929752+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }
    ], 
    "closed": "2011-11-17 09:55:40.452359+00:00"
}