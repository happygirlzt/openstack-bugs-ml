{
    "status": "Won't Fix", 
    "last_updated": "2015-10-06 23:37:31.313499+00:00", 
    "description": "tempest.thirdparty.boto.test_ec2_instance_run.InstanceRunTest creates an AMI image with kernel and ramdisk parameters, here are the values passed to n-api:\n\n2015-09-17 21:42:43.733 INFO nova.api.ec2 [req-66cd4f86-a320-4173-953b-0a5c441ae8f9 tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] 1.211148s 127.0.0.1 POST / CloudController:RegisterImage 200 [Boto/2.38.0 Python/2.7.6 Linux/3.13.0-63-generic] application/x-www-form-urlencoded text/xml\n2015-09-17 21:42:43.733 INFO nova.ec2.wsgi.server [req-66cd4f86-a320-4173-953b-0a5c441ae8f9 tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] 127.0.0.1 \"POST / HTTP/1.1\" status: 200 len: 299 time: 1.2117610\n2015-09-17 21:42:43.924 24107 DEBUG nova.ec2.wsgi.server [-] (24107) accepted ('127.0.0.1', 59659) server /usr/local/lib/python2.7/dist-packages/eventlet/wsgi.py:826\n2015-09-17 21:42:43.990 DEBUG nova.api.ec2 [req-c627bfe6-4fe2-4c5c-ad39-176d348626ce tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] action: RegisterImage __call__ /opt/stack/new/nova/nova/api/ec2/__init__.py:388\n2015-09-17 21:42:43.991 DEBUG nova.api.ec2 [req-c627bfe6-4fe2-4c5c-ad39-176d348626ce tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] arg: Name\t\tval: tempest-ami-name-277527092 __call__ /opt/stack/new/nova/nova/api/ec2/__init__.py:391\n2015-09-17 21:42:43.991 DEBUG nova.api.ec2 [req-c627bfe6-4fe2-4c5c-ad39-176d348626ce tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] arg: KernelId\t\tval: aki-00000013 __call__ /opt/stack/new/nova/nova/api/ec2/__init__.py:391\n2015-09-17 21:42:43.991 DEBUG nova.api.ec2 [req-c627bfe6-4fe2-4c5c-ad39-176d348626ce tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] arg: ImageLocation\t\tval: tempest-s3bucket-1592249957/cirros-0.3.4-x86_64-blank.img.manifest.xml __call__ /opt/stack/new/nova/nova/api/ec2/__init__.py:391\n2015-09-17 21:42:43.991 DEBUG nova.api.ec2 [req-c627bfe6-4fe2-4c5c-ad39-176d348626ce tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] arg: RamdiskId\t\tval: ari-00000014 __call__ /opt/stack/new/nova/nova/api/ec2/__init__.py:391\n\nDespite of that, KernelId and RamdiskId are ignored and image is created without these properties. In case of using Ironic driver, an image without kernel_id and ramdisk_id properties is considered a whole-disk image, and tempest.thirdparty.boto.test_ec2_instance_run.InstanceRunTest fails in gate, because nodes created by devstack have ephemeral_gb=1 and Ironic cannot deploy a whole-disk image when ephemeral or swap are set, which causes the following exception:\n\nn-cpu:\n2015-09-12 16:32:09.817 DEBUG nova.compute.manager [req-3e3492fa-056e-407f-acc4-bb8c85b16883 tempest-InstanceRunTest-21715614 tempest-InstanceRunTest-326056565] [instance: d09fb517-c17c-4405-9d29-13a1f92a669f] Build of instance d09fb517-c17c-4405-9d29-13a1f92a669f was re-scheduled: RPC do_node_deploy failed to validate deploy or power info. Error: Cannot deploy whole disk image with swap or ephemeral size set (HTTP 500) _do_build_and_run_instance /opt/stack/new/nova/nova/compute/manager.py:1923\n\nir-api:\n2015-09-12 16:32:08.808 22705 ERROR wsme.api [req-6840c2a2-3923-47dd-9ef6-451fa7c6e3f7 ] Server-side error: \"RPC do_node_deploy failed to validate deploy or power info. Error: Cannot deploy whole disk image with swap or ephemeral size set\nTraceback (most recent call last):\n\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 142, in inner\n\u00a0\u00a0\u00a0\u00a0return func(*args, **kwargs)\n\n\u00a0\u00a0File \"/opt/stack/new/ironic/ironic/conductor/manager.py\", line 732, in do_node_deploy\n\u00a0\u00a0\u00a0\u00a0\"power info. Error: %(msg)s\") % {'msg': e})\n\nInstanceDeployFailure: RPC do_node_deploy failed to validate deploy or power info. Error: Cannot deploy whole disk image with swap or ephemeral size set\n\". Detail:\nTraceback (most recent call last):\n\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/wsmeext/pecan.py\", line 84, in callfunction\n\u00a0\u00a0\u00a0\u00a0result = f(self, *args, **kwargs)\n\n\u00a0\u00a0File \"/opt/stack/new/ironic/ironic/api/controllers/v1/node.py\", line 479, in provision\n\u00a0\u00a0\u00a0\u00a0configdrive, topic)\n\n\u00a0\u00a0File \"/opt/stack/new/ironic/ironic/conductor/rpcapi.py\", line 303, in do_node_deploy\n\u00a0\u00a0\u00a0\u00a0rebuild=rebuild, configdrive=configdrive)\n\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 158, in call\n\u00a0\u00a0\u00a0\u00a0retry=self.retry)\n\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n\u00a0\u00a0\u00a0\u00a0timeout=timeout, retry=retry)\n\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 431, in send\n\u00a0\u00a0\u00a0\u00a0retry=retry)\n\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 422, in _send\n\u00a0\u00a0\u00a0\u00a0raise result\n\nInstanceDeployFailure_Remote: RPC do_node_deploy failed to validate deploy or power info. Error: Cannot deploy whole disk image with swap or ephemeral size set\nTraceback (most recent call last):\n\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 142, in inner\n\u00a0\u00a0\u00a0\u00a0return func(*args, **kwargs)\n\n\u00a0\u00a0File \"/opt/stack/new/ironic/ironic/conductor/manager.py\", line 732, in do_node_deploy\n\u00a0\u00a0\u00a0\u00a0\"power info. Error: %(msg)s\") % {'msg': e})\n\nInstanceDeployFailure: RPC do_node_deploy failed to validate deploy or power info. Error: Cannot deploy whole disk image with swap or ephemeral size set", 
    "tags": [
        "ec2", 
        "images", 
        "ironic", 
        "testing"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1498005", 
    "owner": "https://api.launchpad.net/1.0/~vdrok", 
    "id": 1498005, 
    "index": 7045, 
    "openned": "2015-09-21 13:43:26.069103+00:00", 
    "created": "2015-09-21 13:43:26.069103+00:00", 
    "title": "EC2 API RegisterImage method ignores KernelId and RamdiskId", 
    "comments": [
        {
            "content": "tempest.thirdparty.boto.test_ec2_instance_run.InstanceRunTest creates an AMI image with kernel and ramdisk parameters, here are the values passed to n-api:\n\n2015-09-17 21:42:43.733 INFO nova.api.ec2 [req-66cd4f86-a320-4173-953b-0a5c441ae8f9 tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] 1.211148s 127.0.0.1 POST / CloudController:RegisterImage 200 [Boto/2.38.0 Python/2.7.6 Linux/3.13.0-63-generic] application/x-www-form-urlencoded text/xml\n2015-09-17 21:42:43.733 INFO nova.ec2.wsgi.server [req-66cd4f86-a320-4173-953b-0a5c441ae8f9 tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] 127.0.0.1 \"POST / HTTP/1.1\" status: 200 len: 299 time: 1.2117610\n2015-09-17 21:42:43.924 24107 DEBUG nova.ec2.wsgi.server [-] (24107) accepted ('127.0.0.1', 59659) server /usr/local/lib/python2.7/dist-packages/eventlet/wsgi.py:826\n2015-09-17 21:42:43.990 DEBUG nova.api.ec2 [req-c627bfe6-4fe2-4c5c-ad39-176d348626ce tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] action: RegisterImage __call__ /opt/stack/new/nova/nova/api/ec2/__init__.py:388\n2015-09-17 21:42:43.991 DEBUG nova.api.ec2 [req-c627bfe6-4fe2-4c5c-ad39-176d348626ce tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] arg: Name\t\tval: tempest-ami-name-277527092 __call__ /opt/stack/new/nova/nova/api/ec2/__init__.py:391\n2015-09-17 21:42:43.991 DEBUG nova.api.ec2 [req-c627bfe6-4fe2-4c5c-ad39-176d348626ce tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] arg: KernelId\t\tval: aki-00000013 __call__ /opt/stack/new/nova/nova/api/ec2/__init__.py:391\n2015-09-17 21:42:43.991 DEBUG nova.api.ec2 [req-c627bfe6-4fe2-4c5c-ad39-176d348626ce tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] arg: ImageLocation\t\tval: tempest-s3bucket-1592249957/cirros-0.3.4-x86_64-blank.img.manifest.xml __call__ /opt/stack/new/nova/nova/api/ec2/__init__.py:391\n2015-09-17 21:42:43.991 DEBUG nova.api.ec2 [req-c627bfe6-4fe2-4c5c-ad39-176d348626ce tempest-InstanceRunTest-1462515106 tempest-InstanceRunTest-17803527] arg: RamdiskId\t\tval: ari-00000014 __call__ /opt/stack/new/nova/nova/api/ec2/__init__.py:391\n\nAlthough, KernelId and RamdiskId are ignored and image is created without these properties. In case of using Ironic driver, an image without kernel_id and ramdisk_id properties is considered a whole-disk image, and tempest.thirdparty.boto.test_ec2_instance_run.InstanceRunTest fails in gate, because nodes created by devstack have ephemeral_gb=1 and Ironic cannot deploy a whole-disk image when ephemeral or swap are set, which causes the following exception:\n\nn-cpu:\n2015-09-12 16:32:09.817 DEBUG nova.compute.manager [req-3e3492fa-056e-407f-acc4-bb8c85b16883 tempest-InstanceRunTest-21715614 tempest-InstanceRunTest-326056565] [instance: d09fb517-c17c-4405-9d29-13a1f92a669f] Build of instance d09fb517-c17c-4405-9d29-13a1f92a669f was re-scheduled: RPC do_node_deploy failed to validate deploy or power info. Error: Cannot deploy whole disk image with swap or ephemeral size set (HTTP 500) _do_build_and_run_instance /opt/stack/new/nova/nova/compute/manager.py:1923\n\nir-api:\n2015-09-12 16:32:08.808 22705 ERROR wsme.api [req-6840c2a2-3923-47dd-9ef6-451fa7c6e3f7 ] Server-side error: \"RPC do_node_deploy failed to validate deploy or power info. Error: Cannot deploy whole disk image with swap or ephemeral size set\nTraceback (most recent call last):\n  \n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 142, in inner\n    return func(*args, **kwargs)\n  \n  File \"/opt/stack/new/ironic/ironic/conductor/manager.py\", line 732, in do_node_deploy\n    \"power info. Error: %(msg)s\") % {'msg': e})\n  \nInstanceDeployFailure: RPC do_node_deploy failed to validate deploy or power info. Error: Cannot deploy whole disk image with swap or ephemeral size set\n\". Detail:\nTraceback (most recent call last):\n  \n  File \"/usr/local/lib/python2.7/dist-packages/wsmeext/pecan.py\", line 84, in callfunction\n    result = f(self, *args, **kwargs)\n  \n  File \"/opt/stack/new/ironic/ironic/api/controllers/v1/node.py\", line 479, in provision\n    configdrive, topic)\n  \n  File \"/opt/stack/new/ironic/ironic/conductor/rpcapi.py\", line 303, in do_node_deploy\n    rebuild=rebuild, configdrive=configdrive)\n  \n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 158, in call\n    retry=self.retry)\n  \n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n    timeout=timeout, retry=retry)\n  \n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 431, in send\n    retry=retry)\n  \n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 422, in _send\n    raise result\n  \nInstanceDeployFailure_Remote: RPC do_node_deploy failed to validate deploy or power info. Error: Cannot deploy whole disk image with swap or ephemeral size set\nTraceback (most recent call last):\n  \n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 142, in inner\n    return func(*args, **kwargs)\n  \n  File \"/opt/stack/new/ironic/ironic/conductor/manager.py\", line 732, in do_node_deploy\n    \"power info. Error: %(msg)s\") % {'msg': e})\n  \nInstanceDeployFailure: RPC do_node_deploy failed to validate deploy or power info. Error: Cannot deploy whole disk image with swap or ephemeral size set", 
            "date_created": "2015-09-21 13:43:26.069103+00:00", 
            "author": "https://api.launchpad.net/1.0/~vdrok"
        }, 
        {
            "content": "@ Vladyslav Drok:\n\nSince you are set as assignee and this seems to be a valid bug, I switch the status of it to \"In Progress\". Thanks for taking the effort to solve this.", 
            "date_created": "2015-09-22 08:02:53.537581+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/226229", 
            "date_created": "2015-09-22 09:57:29.826868+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "@Vladislav, what is a reason to use Nova's EC2, which is deprecated if favor of stackforge/ec2-api? That project doesn't have this bug. Moreover tempest behavior you mentioned (creating ami with aki & ari) was added due to that project (https://github.com/openstack/tempest/commit/2ba24d09d7a030e15ec47fd7ff0f52ebe08ee1a3).\r\n\r\nAnother question is why Ironic does not consider ramdisk_id and kernel_id parameters of create instance operation? As you can see (https://github.com/openstack/tempest/blob/master/tempest/thirdparty/boto/test_ec2_instance_run.py#L112-L113) these parameters are passed in. Libvirt over qemu considers them. So that i think that the problem is on Ironic side.", 
            "date_created": "2015-09-24 10:10:59.216628+00:00", 
            "author": "https://api.launchpad.net/1.0/~ftersin"
        }, 
        {
            "content": "As for complaint about Nova EC2 behavior, it's a duplicate of rejected https://bugs.launchpad.net/nova/+bug/954335", 
            "date_created": "2015-09-24 10:14:07.666094+00:00", 
            "author": "https://api.launchpad.net/1.0/~ftersin"
        }, 
        {
            "content": "Hi Feodor. As for Ironic behavour, I think reading kernel_id and ramdisk_id from image properties was done very long time ago, and it does make sense. And I agree, it seems that to using stackforge ec2 api in devstack-gate is the way to resolve this, thanks.", 
            "date_created": "2015-09-29 14:45:41.156240+00:00", 
            "author": "https://api.launchpad.net/1.0/~vdrok"
        }, 
        {
            "content": "Change abandoned by Vladyslav Drok (<email address hidden>) on branch: master\nReview: https://review.openstack.org/226229", 
            "date_created": "2015-09-29 14:46:28.775482+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-10-06 23:37:28.994030+00:00"
}