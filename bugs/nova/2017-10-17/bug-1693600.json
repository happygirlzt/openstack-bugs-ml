{
    "status": "Fix Released", 
    "last_updated": "2017-07-19 15:58:46.366165+00:00", 
    "description": "Reproduced here:\n\nhttp://logs.openstack.org/74/467674/2/check/gate-tempest-dsvm-neutron-full-ubuntu-xenial/414bb96/logs/screen-n-api.txt.gz?level=TRACE#_May_25_02_46_02_139728\n\nMay 25 02:46:02.139728 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api [req-4a040119-d445-4eb8-8d56-a29653bb6866 tempest-TestVolumeBootPattern-1408924396 tempest-TestVolumeBootPattern-1408924396] Failed BDM validation for volume: 4eb7a1cf-1f6d-4b7c-ae37-99688a0c1e6d\nMay 25 02:46:02.140058 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api Traceback (most recent call last):\nMay 25 02:46:02.140638 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1412, in _validate_bdm\nMay 25 02:46:02.140851 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     context, volume_id, instance)\nMay 25 02:46:02.141057 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/opt/stack/new/nova/nova/compute/api.py\", line 3711, in _check_attach_and_reserve_volume\nMay 25 02:46:02.141281 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     instance=instance)\nMay 25 02:46:02.141487 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/opt/stack/new/nova/nova/volume/cinder.py\", line 285, in check_availability_zone\nMay 25 02:46:02.141700 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     instance_az = az.get_instance_availability_zone(context, instance)\nMay 25 02:46:02.141997 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/opt/stack/new/nova/nova/availability_zones.py\", line 167, in get_instance_availability_zone\nMay 25 02:46:02.142308 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     host = instance.get('host')\nMay 25 02:46:02.142540 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 771, in get\nMay 25 02:46:02.142762 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     return getattr(self, key)\nMay 25 02:46:02.142978 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 67, in getter\nMay 25 02:46:02.143196 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     self.obj_load_attr(name)\nMay 25 02:46:02.143414 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 1029, in obj_load_attr\nMay 25 02:46:02.143636 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     reason='attribute %s not lazy-loadable' % attrname)\nMay 25 02:46:02.144016 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api ObjectActionError: Object action obj_load_attr failed because: attribute host not lazy-loadable\nMay 25 02:46:02.144244 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api \n\nThis is because the instance object here is not created from the database, it's created in the API code to be set in the BuildRequest object, and it doesn't have the host field set:\n\nhttps://github.com/openstack/nova/blob/4b732b5b3e7c1da63fa20af52028e7903986ba6a/nova/compute/api.py#L1023\n\nSo we need to handle the fact that 'host' might not be set in the instance object in this code.", 
    "tags": [
        "api", 
        "availability-zones"
    ], 
    "importance": "High", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1693600", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1693600, 
    "index": 2079, 
    "openned": "2017-05-25 19:32:49.541174+00:00", 
    "created": "2017-05-25 19:32:49.541174+00:00", 
    "title": "Boot from volume fails when cross_az_attach=False due to: ObjectActionError: Object action obj_load_attr failed because: attribute host not lazy-loadable", 
    "comments": [
        {
            "content": "Reproduced here:\n\nhttp://logs.openstack.org/74/467674/2/check/gate-tempest-dsvm-neutron-full-ubuntu-xenial/414bb96/logs/screen-n-api.txt.gz?level=TRACE#_May_25_02_46_02_139728\n\nMay 25 02:46:02.139728 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api [req-4a040119-d445-4eb8-8d56-a29653bb6866 tempest-TestVolumeBootPattern-1408924396 tempest-TestVolumeBootPattern-1408924396] Failed BDM validation for volume: 4eb7a1cf-1f6d-4b7c-ae37-99688a0c1e6d\nMay 25 02:46:02.140058 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api Traceback (most recent call last):\nMay 25 02:46:02.140638 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1412, in _validate_bdm\nMay 25 02:46:02.140851 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     context, volume_id, instance)\nMay 25 02:46:02.141057 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/opt/stack/new/nova/nova/compute/api.py\", line 3711, in _check_attach_and_reserve_volume\nMay 25 02:46:02.141281 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     instance=instance)\nMay 25 02:46:02.141487 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/opt/stack/new/nova/nova/volume/cinder.py\", line 285, in check_availability_zone\nMay 25 02:46:02.141700 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     instance_az = az.get_instance_availability_zone(context, instance)\nMay 25 02:46:02.141997 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/opt/stack/new/nova/nova/availability_zones.py\", line 167, in get_instance_availability_zone\nMay 25 02:46:02.142308 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     host = instance.get('host')\nMay 25 02:46:02.142540 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 771, in get\nMay 25 02:46:02.142762 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     return getattr(self, key)\nMay 25 02:46:02.142978 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 67, in getter\nMay 25 02:46:02.143196 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     self.obj_load_attr(name)\nMay 25 02:46:02.143414 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 1029, in obj_load_attr\nMay 25 02:46:02.143636 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api     reason='attribute %s not lazy-loadable' % attrname)\nMay 25 02:46:02.144016 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api ObjectActionError: Object action obj_load_attr failed because: attribute host not lazy-loadable\nMay 25 02:46:02.144244 ubuntu-xenial-infracloud-vanilla-8978830 nova-api[17948]: ERROR nova.compute.api \n\nThis is because the instance object here is not created from the database, it's created in the API code to be set in the BuildRequest object, and it doesn't have the host field set:\n\nhttps://github.com/openstack/nova/blob/4b732b5b3e7c1da63fa20af52028e7903986ba6a/nova/compute/api.py#L1023\n\nSo we need to handle the fact that 'host' might not be set in the instance object in this code.", 
            "date_created": "2017-05-25 19:32:49.541174+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "We stopped creating the instance in the API in Ocata so this has to go back to Ocata too.", 
            "date_created": "2017-05-25 19:33:24.365972+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/468147", 
            "date_created": "2017-05-25 19:51:49.166512+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/468147\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=91bd79058abf79978335010a325952f17729d7a5\nSubmitter: Jenkins\nBranch:    master\n\ncommit 91bd79058abf79978335010a325952f17729d7a5\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu May 25 15:46:22 2017 -0400\n\n    Avoid lazy-load error when getting instance AZ\n    \n    When [cinder]cross_az_attach=False (not the default) and doing\n    boot from volume, the API code validates the BDM by seeing if\n    the instance and the volume are in the same availability zone.\n    To get the AZ for the instance, the code is first trying to get\n    the instance.host value.\n    \n    In Ocata we stopped creating the instance in the API and moved that\n    to conductor for cells v2. So the Instance object in this case now\n    is created in the _provision_instances method and stored in the\n    BuildRequest object. Since there is no host to set on the instance\n    yet and the Instance object wasn't populated from DB values, which\n    before would set the host field on the instance object to None by\n    default, trying to get instance.host will lazy-load the field and\n    it blows up with ObjectActionError.\n    \n    The correct thing to do here is check if the host attribute is set\n    on the Instance object. There is clear intent to assume host is\n    not set in the instance since it was using instance.get('host'),\n    probably from way back in the days when the instance in this case\n    was a dict. So it's expecting to handle None, but we need to\n    modernize how that is checked.\n    \n    Change-Id: I0dccb6a416dfe0eae4f7c52dfc28786a449b17bd\n    Closes-Bug: #1693600\n", 
            "date_created": "2017-05-31 14:58:40.865954+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/469548", 
            "date_created": "2017-05-31 16:00:57.811838+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/469548\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=2868d52e42cccf539938afbb252650fb4ea4e3c5\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit 2868d52e42cccf539938afbb252650fb4ea4e3c5\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu May 25 15:46:22 2017 -0400\n\n    Avoid lazy-load error when getting instance AZ\n    \n    When [cinder]cross_az_attach=False (not the default) and doing\n    boot from volume, the API code validates the BDM by seeing if\n    the instance and the volume are in the same availability zone.\n    To get the AZ for the instance, the code is first trying to get\n    the instance.host value.\n    \n    In Ocata we stopped creating the instance in the API and moved that\n    to conductor for cells v2. So the Instance object in this case now\n    is created in the _provision_instances method and stored in the\n    BuildRequest object. Since there is no host to set on the instance\n    yet and the Instance object wasn't populated from DB values, which\n    before would set the host field on the instance object to None by\n    default, trying to get instance.host will lazy-load the field and\n    it blows up with ObjectActionError.\n    \n    The correct thing to do here is check if the host attribute is set\n    on the Instance object. There is clear intent to assume host is\n    not set in the instance since it was using instance.get('host'),\n    probably from way back in the days when the instance in this case\n    was a dict. So it's expecting to handle None, but we need to\n    modernize how that is checked.\n    \n    Change-Id: I0dccb6a416dfe0eae4f7c52dfc28786a449b17bd\n    Closes-Bug: #1693600\n    (cherry picked from commit 91bd79058abf79978335010a325952f17729d7a5)\n", 
            "date_created": "2017-06-06 14:50:59.394653+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b2 development milestone.", 
            "date_created": "2017-06-08 21:51:56.141415+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.6 release.", 
            "date_created": "2017-06-19 12:45:51.435903+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/485257", 
            "date_created": "2017-07-19 15:48:49.619489+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by David Moreau Simard (<email address hidden>) on branch: stable/newton\nReview: https://review.openstack.org/485257\nReason: Correct, this doesn't seem required for newton.", 
            "date_created": "2017-07-19 15:58:45.963489+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-05-31 14:58:37.115385+00:00"
}