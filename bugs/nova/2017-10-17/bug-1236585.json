{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 08:57:48.556156+00:00", 
    "description": "See: http://logs.openstack.org/69/49169/2/check/check-tempest-devstack-vm-full/473539f/console.html\n\n2013-10-07 18:57:09.859 | ======================================================================\n2013-10-07 18:57:09.859 | FAIL: tempest.api.compute.servers.test_list_servers_negative.ListServersNegativeTestJSON.test_list_servers_by_changes_since[gate]\n2013-10-07 18:57:09.860 | tempest.api.compute.servers.test_list_servers_negative.ListServersNegativeTestJSON.test_list_servers_by_changes_since[gate]\n2013-10-07 18:57:09.860 | ----------------------------------------------------------------------\n2013-10-07 18:57:09.860 | _StringException: Empty attachments:\n2013-10-07 18:57:09.861 |   stderr\n2013-10-07 18:57:09.861 |   stdout\n2013-10-07 18:57:09.861 | \n2013-10-07 18:57:09.862 | pythonlogging:'': {{{\n2013-10-07 18:57:09.862 | 2013-10-07 18:38:33,059 Request: GET http://127.0.0.1:8774/v2/3b02395d4eec44958ffcc10ac2673fd2/servers?changes-since=2013-10-07T18%3A38%3A31.034080\n2013-10-07 18:57:09.862 | 2013-10-07 18:38:33,490 Response Status: 200\n2013-10-07 18:57:09.863 | 2013-10-07 18:38:33,490 Nova request id: req-906f2cf2-6508-4cd2-bf62-3595b18d223a\n2013-10-07 18:57:09.863 | }}}\n2013-10-07 18:57:09.863 | \n2013-10-07 18:57:09.863 | Traceback (most recent call last):\n2013-10-07 18:57:09.864 |   File \"tempest/api/compute/servers/test_list_servers_negative.py\", line 191, in test_list_servers_by_changes_since\n2013-10-07 18:57:09.864 |     self.assertEqual(num_expected, len(body['servers']))\n2013-10-07 18:57:09.864 |   File \"/usr/local/lib/python2.7/dist-packages/testtools/testcase.py\", line 322, in assertEqual\n2013-10-07 18:57:09.865 |     self.assertThat(observed, matcher, message)\n2013-10-07 18:57:09.865 |   File \"/usr/local/lib/python2.7/dist-packages/testtools/testcase.py\", line 417, in assertThat\n2013-10-07 18:57:09.865 |     raise MismatchError(matchee, matcher, mismatch, verbose)\n2013-10-07 18:57:09.865 | MismatchError: 3 != 2", 
    "tags": [
        "api", 
        "db"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1236585", 
    "owner": "https://api.launchpad.net/1.0/~oomichi", 
    "id": 1236585, 
    "index": 1267, 
    "openned": "2013-10-07 20:56:45.659141+00:00", 
    "created": "2013-10-07 20:56:45.659141+00:00", 
    "title": "tempest.api.compute.servers.test_list_servers_negative.ListServersNegativeTestJSON.test_list_servers_by_changes_since fails sporadically", 
    "comments": [
        {
            "content": "See: http://logs.openstack.org/69/49169/2/check/check-tempest-devstack-vm-full/473539f/console.html\n\n2013-10-07 18:57:09.859 | ======================================================================\n2013-10-07 18:57:09.859 | FAIL: tempest.api.compute.servers.test_list_servers_negative.ListServersNegativeTestJSON.test_list_servers_by_changes_since[gate]\n2013-10-07 18:57:09.860 | tempest.api.compute.servers.test_list_servers_negative.ListServersNegativeTestJSON.test_list_servers_by_changes_since[gate]\n2013-10-07 18:57:09.860 | ----------------------------------------------------------------------\n2013-10-07 18:57:09.860 | _StringException: Empty attachments:\n2013-10-07 18:57:09.861 |   stderr\n2013-10-07 18:57:09.861 |   stdout\n2013-10-07 18:57:09.861 | \n2013-10-07 18:57:09.862 | pythonlogging:'': {{{\n2013-10-07 18:57:09.862 | 2013-10-07 18:38:33,059 Request: GET http://127.0.0.1:8774/v2/3b02395d4eec44958ffcc10ac2673fd2/servers?changes-since=2013-10-07T18%3A38%3A31.034080\n2013-10-07 18:57:09.862 | 2013-10-07 18:38:33,490 Response Status: 200\n2013-10-07 18:57:09.863 | 2013-10-07 18:38:33,490 Nova request id: req-906f2cf2-6508-4cd2-bf62-3595b18d223a\n2013-10-07 18:57:09.863 | }}}\n2013-10-07 18:57:09.863 | \n2013-10-07 18:57:09.863 | Traceback (most recent call last):\n2013-10-07 18:57:09.864 |   File \"tempest/api/compute/servers/test_list_servers_negative.py\", line 191, in test_list_servers_by_changes_since\n2013-10-07 18:57:09.864 |     self.assertEqual(num_expected, len(body['servers']))\n2013-10-07 18:57:09.864 |   File \"/usr/local/lib/python2.7/dist-packages/testtools/testcase.py\", line 322, in assertEqual\n2013-10-07 18:57:09.865 |     self.assertThat(observed, matcher, message)\n2013-10-07 18:57:09.865 |   File \"/usr/local/lib/python2.7/dist-packages/testtools/testcase.py\", line 417, in assertThat\n2013-10-07 18:57:09.865 |     raise MismatchError(matchee, matcher, mismatch, verbose)\n2013-10-07 18:57:09.865 | MismatchError: 3 != 2", 
            "date_created": "2013-10-07 20:56:45.659141+00:00", 
            "author": "https://api.launchpad.net/1.0/~peter-a-portante"
        }, 
        {
            "content": "Now we have additional debug message for this problem.\nThe debug message is the following:\n\nMismatchError: 3 != 2: Number of servers 3 is wrong in [{'link': {'href': '<a href='http://127.0.0.1:8774/a6f85b737f9e47e7ab7cebe30e028222/servers/6c5d0fa3-ae9a-4a94-b31f-ad3ca7d453db'>http://127.0.0.1:8774/a6f85b737f9e47e7ab7cebe30e028222/servers/6c5d0fa3-ae9a-4a94-b31f-ad3ca7d453db</a>', 'rel': 'bookmark'}, 'name': 'ListServersNegativeTestXML-instance-tempest-1601877588', 'id': '6c5d0fa3-ae9a-4a94-b31f-ad3ca7d453db'}, {'link': {'href': '<a href='http://127.0.0.1:8774/a6f85b737f9e47e7ab7cebe30e028222/servers/4c613cc8-6754-4f87-91cf-4aa2f6828a22'>http://127.0.0.1:8774/a6f85b737f9e47e7ab7cebe30e028222/servers/4c613cc8-6754-4f87-91cf-4aa2f6828a22</a>', 'rel': 'bookmark'}, 'name': 'ListServersNegativeTestXML-instance-tempest-569720341', 'id': '4c613cc8-6754-4f87-91cf-4aa2f6828a22'}]\n", 
            "date_created": "2013-12-03 08:23:51.039981+00:00", 
            "author": "https://api.launchpad.net/1.0/~oomichi"
        }, 
        {
            "content": "This test scenario is the following steps:\n\n1. Get a timestamp(TM01) which will be passed as \"changes-since\" parameter of list-server API.\n2. Create 1st server(VM01).\n3. Create 2nd server(VM02).\n4. Create 3rd server(VM03).\n5. Delete 3rd server.\n6. Call list-server API with the timestamp(TM01) as \"changes-since\" parameter.\n7. Check it is possible to get all servers(VM01, VM02, VM03).\n\nAccording to http://logs.openstack.org/93/59093/1/check/check-tempest-devstack-vm-full/20c041b/ ,\nwe could not get VM01 and this test failed on step 7.\n\nThis problem happens if VM01 creation(step 2.) finishes in the same second as TM01.\nFor example, the following timestamps is not problem.\n\n1. (20:21:19.247) Get a timestamp(TM01)\n2. (20:21:20.247) Create 1st server(VM01).\n\nHowever, this problem happens if the following timestamps:\n\n1. (20:21:19.247) Get a timestamp(TM01)\n2. (20:21:19.805) Create 1st server(VM01).\n\nThe above timestamps are the ones of http://logs.openstack.org/93/59093/1/check/check-tempest-devstack-vm-full/20c041b/ ,\nand step 1. and step 2. are in the same second(20:21:19).\n\nThe reason is Nova implementation of list-server API.\nchanges-since is implemented with the following code:\n\nnova/db/sqlalchemy/api.py\n 1877         query_prefix = query_prefix.\\\n 1878                             filter(models.Instance.updated_at > changes_since)\n\nIn addition, \"updated_at\" of \"instances\" table is defined as datetime from mysql.\n mysql> desc instances;\n +--------------------------+-----------------------+------+-----+---------+----------------+\n | Field                    | Type                  | Null | Key | Default | Extra          |\n +--------------------------+-----------------------+------+-----+---------+----------------+\n | created_at               | datetime              | YES  |     | NULL    |                |\n | updated_at               | datetime              | YES  |     | NULL    |                |\n [..]\n +--------------------------+-----------------------+------+-----+---------+----------------+\n\nThe data type does not contain millisecond.\nSo if step 1. and step 2. are in the same second, it is impossible to know the timestamp difference\nand \"filter(models.Instance.updated_at > changes_since)\" filters VM01.\n", 
            "date_created": "2013-12-05 06:36:30.148905+00:00", 
            "author": "https://api.launchpad.net/1.0/~oomichi"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/60158", 
            "date_created": "2013-12-05 07:00:07.546189+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The patch is in review process.\n\nhttps://review.openstack.org/#/c/60157/", 
            "date_created": "2013-12-05 12:34:41.960379+00:00", 
            "author": "https://api.launchpad.net/1.0/~oomichi"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/60157\nCommitted: http://github.com/openstack/nova/commit/d87bd44d0211a633efd545dc7b2027a613897b85\nSubmitter: Jenkins\nBranch:    master\n\ncommit d87bd44d0211a633efd545dc7b2027a613897b85\nAuthor: Ken'ichi Ohmichi <email address hidden>\nDate:   Thu Dec 5 23:43:32 2013 +0900\n\n    Fix changes-since filter for list-servers API\n    \n    On list-servers API, \"changes-since\" parameter filters out servers\n    which have been created at the same date as the specified timestamp.\n    For example, the following server is filtered out with \"changes-since=\n    2013-12-05T15:03:25\":\n    \n      mysql> select display_name, updated_at from instances;\n      +--------------+---------------------+\n      | display_name | updated_at          |\n      +--------------+---------------------+\n      | vm01         | 2013-12-05 15:03:25 |\n      +--------------+---------------------+\n    \n    This bug causes some Tempest test failures, if the timestamp of server\n    creations are the same as the \"changes-since\" timestamp in second unit.\n    In addition, the behavior would be wrong from the viewpoint of its name\n    which includes \"since\".\n    \n    This patch chanegs the server list for including the ones created at\n    the specified timestamp.\n    \n    Change-Id: Icc10a1363503b3553d810c6be20b86b3da7ac1a0\n    Closes-Bug: #1236585\n", 
            "date_created": "2013-12-07 07:40:33.177937+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/73231", 
            "date_created": "2014-02-13 10:35:38.970403+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/73231\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3f72ffb2109d286d9cff62dca79459b0a8036a1f\nSubmitter: Jenkins\nBranch:    stable/havana\n\ncommit 3f72ffb2109d286d9cff62dca79459b0a8036a1f\nAuthor: Ken'ichi Ohmichi <email address hidden>\nDate:   Thu Dec 5 23:43:32 2013 +0900\n\n    Fix changes-since filter for list-servers API\n    \n    On list-servers API, \"changes-since\" parameter filters out servers\n    which have been created at the same date as the specified timestamp.\n    For example, the following server is filtered out with \"changes-since=\n    2013-12-05T15:03:25\":\n    \n      mysql> select display_name, updated_at from instances;\n      +--------------+---------------------+\n      | display_name | updated_at          |\n      +--------------+---------------------+\n      | vm01         | 2013-12-05 15:03:25 |\n      +--------------+---------------------+\n    \n    This bug causes some Tempest test failures, if the timestamp of server\n    creations are the same as the \"changes-since\" timestamp in second unit.\n    In addition, the behavior would be wrong from the viewpoint of its name\n    which includes \"since\".\n    \n    This patch chanegs the server list for including the ones created at\n    the specified timestamp.\n    \n    Change-Id: Icc10a1363503b3553d810c6be20b86b3da7ac1a0\n    Closes-Bug: #1236585\n    (cherry picked from commit d87bd44d0211a633efd545dc7b2027a613897b85)\n", 
            "date_created": "2014-02-28 14:11:22.381990+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-01-22 16:18:50.409762+00:00"
}