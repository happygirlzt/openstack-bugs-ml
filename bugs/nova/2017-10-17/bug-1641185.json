{
    "status": "Confirmed", 
    "last_updated": "2017-06-05 06:01:08.809992+00:00", 
    "description": "Several nova db tables have duplicate indexes defined.  This behavior was deprecated in MySQL 5.6 and presumably will fail on some future MySQL/MariaDB version. There are further some redundant indexes that overlap the left-most prefix over other indexes. The extra indexes have maintenance overhead that does become bothersome at larger scales and seems to be low hanging fruit.\n\nThe duplicate indexes are almost always caused by both flagging a field as unique and also specifying a UniqueConstraint in nova.db.sqlalchemy.models.  As an example, there is nova.instances:\n\nclass Instance(BASE, NovaBase, models.SoftDeleteMixin):\n...\n        Index('uuid', 'uuid', unique=True),\n...\n        schema.UniqueConstraint('uuid', name='uniq_instances0uuid'),\n\nExamples below are from a 14.0.2 MariaDB 10.0.27 database.   I believe this also affects a Postgres backend.\n\nHere are some obvious candidates that are essentially exact duplicates.  Pulled using Percona's pt-duplicate-key-checker to make this a bit more obvious:\n\n# ########################################################################\n# nova.console_auth_tokens\n# ########################################################################\n\n# console_auth_tokens_token_hash_idx is a duplicate of uniq_console_auth_tokens0token_hash\n# Key definitions:\n#   KEY `console_auth_tokens_token_hash_idx` (`token_hash`)\n#   UNIQUE KEY `uniq_console_auth_tokens0token_hash` (`token_hash`),\n# Column types:\n#\t  `token_hash` varchar(255) not null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`console_auth_tokens` DROP INDEX `console_auth_tokens_token_hash_idx`;\n\n\n# ########################################################################\n# nova.instances\n# ########################################################################\n\n# Uniqueness of uniq_instances0uuid ignored because uuid is a duplicate constraint\n# uniq_instances0uuid is a duplicate of uuid\n# Key definitions:\n#   UNIQUE KEY `uniq_instances0uuid` (`uuid`),\n#   UNIQUE KEY `uuid` (`uuid`),\n# Column types:\n#         `uuid` varchar(36) not null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`instances` DROP INDEX `uniq_instances0uuid`;\n\n# ########################################################################\n# nova.inventories\n# ########################################################################\n\n# inventories_resource_provider_resource_class_idx is a duplicate of uniq_inventories0resource_provider_resource_class\n# Key definitions:\n#   KEY `inventories_resource_provider_resource_class_idx` (`resource_provider_id`,`resource_class_id`)\n#   UNIQUE KEY `uniq_inventories0resource_provider_resource_class` (`resource_provider_id`,`resource_class_id`),\n# Column types:\n#\t  `resource_provider_id` int(11) not null\n#\t  `resource_class_id` int(11) not null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`inventories` DROP INDEX `inventories_resource_provider_resource_class_idx`;\n\n\n# ########################################################################\n# nova.networks\n# ########################################################################\n\n# networks_vlan_deleted_idx is a duplicate of uniq_networks0vlan0deleted\n# Key definitions:\n#   KEY `networks_vlan_deleted_idx` (`vlan`,`deleted`)\n#   UNIQUE KEY `uniq_networks0vlan0deleted` (`vlan`,`deleted`),\n# Column types:\n#         `vlan` int(11) default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`networks` DROP INDEX `networks_vlan_deleted_idx`;\n\n\n# ########################################################################\n# nova.resource_providers\n# ########################################################################\n\n# resource_providers_name_idx is a duplicate of uniq_resource_providers0name\n# Key definitions:\n#   KEY `resource_providers_name_idx` (`name`)\n#   UNIQUE KEY `uniq_resource_providers0name` (`name`),\n# Column types:\n#         `name` varchar(200) character set utf8 default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`resource_providers` DROP INDEX `resource_providers_name_idx`;\n\n# resource_providers_uuid_idx is a duplicate of uniq_resource_providers0uuid\n# Key definitions:\n#   KEY `resource_providers_uuid_idx` (`uuid`),\n#   UNIQUE KEY `uniq_resource_providers0uuid` (`uuid`),\n# Column types:\n#         `uuid` varchar(36) not null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`resource_providers` DROP INDEX `resource_providers_uuid_idx`;\n\n\nAnd simply redundant indexes:\n\n# ########################################################################\n# nova.agent_builds\n# ########################################################################\n\n# agent_builds_hypervisor_os_arch_idx is a left-prefix of uniq_agent_builds0hypervisor0os0architecture0deleted\n# Key definitions:\n#   KEY `agent_builds_hypervisor_os_arch_idx` (`hypervisor`,`os`,`architecture`)\n#   UNIQUE KEY `uniq_agent_builds0hypervisor0os0architecture0deleted` (`hypervisor`,`os`,`architecture`,`deleted`),\n# Column types:\n#         `hypervisor` varchar(255) default null\n#         `os` varchar(255) default null\n#         `architecture` varchar(255) default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`agent_builds` DROP INDEX `agent_builds_hypervisor_os_arch_idx`;\n\n# ########################################################################\n# nova.block_device_mapping\n# ########################################################################\n\n# block_device_mapping_instance_uuid_idx is a left-prefix of block_device_mapping_instance_uuid_volume_id_idx\n# Key definitions:\n#   KEY `block_device_mapping_instance_uuid_idx` (`instance_uuid`),\n#   KEY `block_device_mapping_instance_uuid_volume_id_idx` (`instance_uuid`,`volume_id`),\n# Column types:\n#         `instance_uuid` varchar(36) default null\n#         `volume_id` varchar(36) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`block_device_mapping` DROP INDEX `block_device_mapping_instance_uuid_idx`;\n\n# ########################################################################\n# nova.fixed_ips\n# ########################################################################\n\n# address is a left-prefix of uniq_fixed_ips0address0deleted\n# Key definitions:\n#   KEY `address` (`address`),\n#   UNIQUE KEY `uniq_fixed_ips0address0deleted` (`address`,`deleted`),\n# Column types:\n#         `address` varchar(39) default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`fixed_ips` DROP INDEX `address`;\n\n# network_id is a left-prefix of fixed_ips_network_id_host_deleted_idx\n# Key definitions:\n#   KEY `network_id` (`network_id`),\n#   KEY `fixed_ips_network_id_host_deleted_idx` (`network_id`,`host`,`deleted`),\n# Column types:\n#         `network_id` int(11) default null\n#         `host` varchar(255) default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`fixed_ips` DROP INDEX `network_id`;\n\n# ########################################################################\n# nova.instance_type_extra_specs\n# ########################################################################\n\n# instance_type_extra_specs_instance_type_id_key_idx is a left-prefix of uniq_instance_type_extra_specs0instance_type_id0key0deleted\n# Key definitions:\n#   KEY `instance_type_extra_specs_instance_type_id_key_idx` (`instance_type_id`,`key`),\n#   UNIQUE KEY `uniq_instance_type_extra_specs0instance_type_id0key0deleted` (`instance_type_id`,`key`,`deleted`),\n# Column types:\n#         `instance_type_id` int(11) not null\n#         `key` varchar(255) collate utf8_bin default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`instance_type_extra_specs` DROP INDEX `instance_type_extra_specs_instance_type_id_key_idx`;\n\n# ########################################################################\n# nova.instance_type_projects\n# ########################################################################\n\n# instance_type_id is a left-prefix of uniq_instance_type_projects0instance_type_id0project_id0deleted\n# Key definitions:\n#   KEY `instance_type_id` (`instance_type_id`),\n#   UNIQUE KEY `uniq_instance_type_projects0instance_type_id0project_id0deleted` (`instance_type_id`,`project_id`,`deleted`),\n# Column types:\n#         `instance_type_id` int(11) not null\n#         `project_id` varchar(255) default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`instance_type_projects` DROP INDEX `instance_type_id`;\n\n# ########################################################################\n# nova.inventories\n# ########################################################################\n\n# inventories_resource_provider_id_idx is a left-prefix of uniq_inventories0resource_provider_resource_class\n# Key definitions:\n#   KEY `inventories_resource_provider_id_idx` (`resource_provider_id`),\n#   UNIQUE KEY `uniq_inventories0resource_provider_resource_class` (`resource_provider_id`,`resource_class_id`),\n# Column types:\n#         `resource_provider_id` int(11) not null\n#         `resource_class_id` int(11) not null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`inventories` DROP INDEX `inventories_resource_provider_id_idx`;", 
    "tags": [
        "db"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1641185", 
    "owner": "None", 
    "id": 1641185, 
    "index": 4673, 
    "openned": "2016-11-11 18:08:14.546206+00:00", 
    "created": "2016-11-11 18:08:14.546206+00:00", 
    "title": "Duplicate indexes in nova-db", 
    "comments": [
        {
            "content": "Several nova db tables have duplicate indexes defined.  This behavior was deprecated in MySQL 5.6 and presumably will fail on some future MySQL/MariaDB version. There are further some redundant indexes that overlap the left-most prefix over other indexes. The extra indexes have maintenance overhead that does become bothersome at larger scales and seems to be low hanging fruit.\n\nThe duplicate indexes are almost always caused by both flagging a field as unique and also specifying a UniqueConstraint in nova.db.sqlalchemy.models.  As an example, there is nova.instances:\n\nclass Instance(BASE, NovaBase, models.SoftDeleteMixin):\n...\n        Index('uuid', 'uuid', unique=True),\n...\n        schema.UniqueConstraint('uuid', name='uniq_instances0uuid'),\n\nExamples below are from a 14.0.2 MariaDB 10.0.27 database.   I believe this also affects a Postgres backend.\n\nHere are some obvious candidates that are essentially exact duplicates.  Pulled using Percona's pt-duplicate-key-checker to make this a bit more obvious:\n\n# ########################################################################\n# nova.console_auth_tokens\n# ########################################################################\n\n# console_auth_tokens_token_hash_idx is a duplicate of uniq_console_auth_tokens0token_hash\n# Key definitions:\n#   KEY `console_auth_tokens_token_hash_idx` (`token_hash`)\n#   UNIQUE KEY `uniq_console_auth_tokens0token_hash` (`token_hash`),\n# Column types:\n#\t  `token_hash` varchar(255) not null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`console_auth_tokens` DROP INDEX `console_auth_tokens_token_hash_idx`;\n\n\n# ########################################################################\n# nova.instances\n# ########################################################################\n\n# Uniqueness of uniq_instances0uuid ignored because uuid is a duplicate constraint\n# uniq_instances0uuid is a duplicate of uuid\n# Key definitions:\n#   UNIQUE KEY `uniq_instances0uuid` (`uuid`),\n#   UNIQUE KEY `uuid` (`uuid`),\n# Column types:\n#         `uuid` varchar(36) not null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`instances` DROP INDEX `uniq_instances0uuid`;\n\n# ########################################################################\n# nova.inventories\n# ########################################################################\n\n# inventories_resource_provider_resource_class_idx is a duplicate of uniq_inventories0resource_provider_resource_class\n# Key definitions:\n#   KEY `inventories_resource_provider_resource_class_idx` (`resource_provider_id`,`resource_class_id`)\n#   UNIQUE KEY `uniq_inventories0resource_provider_resource_class` (`resource_provider_id`,`resource_class_id`),\n# Column types:\n#\t  `resource_provider_id` int(11) not null\n#\t  `resource_class_id` int(11) not null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`inventories` DROP INDEX `inventories_resource_provider_resource_class_idx`;\n\n\n# ########################################################################\n# nova.networks\n# ########################################################################\n\n# networks_vlan_deleted_idx is a duplicate of uniq_networks0vlan0deleted\n# Key definitions:\n#   KEY `networks_vlan_deleted_idx` (`vlan`,`deleted`)\n#   UNIQUE KEY `uniq_networks0vlan0deleted` (`vlan`,`deleted`),\n# Column types:\n#         `vlan` int(11) default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`networks` DROP INDEX `networks_vlan_deleted_idx`;\n\n\n# ########################################################################\n# nova.resource_providers\n# ########################################################################\n\n# resource_providers_name_idx is a duplicate of uniq_resource_providers0name\n# Key definitions:\n#   KEY `resource_providers_name_idx` (`name`)\n#   UNIQUE KEY `uniq_resource_providers0name` (`name`),\n# Column types:\n#         `name` varchar(200) character set utf8 default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`resource_providers` DROP INDEX `resource_providers_name_idx`;\n\n# resource_providers_uuid_idx is a duplicate of uniq_resource_providers0uuid\n# Key definitions:\n#   KEY `resource_providers_uuid_idx` (`uuid`),\n#   UNIQUE KEY `uniq_resource_providers0uuid` (`uuid`),\n# Column types:\n#         `uuid` varchar(36) not null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`resource_providers` DROP INDEX `resource_providers_uuid_idx`;\n\n\nAnd simply redundant indexes:\n\n# ########################################################################\n# nova.agent_builds\n# ########################################################################\n\n# agent_builds_hypervisor_os_arch_idx is a left-prefix of uniq_agent_builds0hypervisor0os0architecture0deleted\n# Key definitions:\n#   KEY `agent_builds_hypervisor_os_arch_idx` (`hypervisor`,`os`,`architecture`)\n#   UNIQUE KEY `uniq_agent_builds0hypervisor0os0architecture0deleted` (`hypervisor`,`os`,`architecture`,`deleted`),\n# Column types:\n#         `hypervisor` varchar(255) default null\n#         `os` varchar(255) default null\n#         `architecture` varchar(255) default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`agent_builds` DROP INDEX `agent_builds_hypervisor_os_arch_idx`;\n\n# ########################################################################\n# nova.block_device_mapping\n# ########################################################################\n\n# block_device_mapping_instance_uuid_idx is a left-prefix of block_device_mapping_instance_uuid_volume_id_idx\n# Key definitions:\n#   KEY `block_device_mapping_instance_uuid_idx` (`instance_uuid`),\n#   KEY `block_device_mapping_instance_uuid_volume_id_idx` (`instance_uuid`,`volume_id`),\n# Column types:\n#         `instance_uuid` varchar(36) default null\n#         `volume_id` varchar(36) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`block_device_mapping` DROP INDEX `block_device_mapping_instance_uuid_idx`;\n\n# ########################################################################\n# nova.fixed_ips\n# ########################################################################\n\n# address is a left-prefix of uniq_fixed_ips0address0deleted\n# Key definitions:\n#   KEY `address` (`address`),\n#   UNIQUE KEY `uniq_fixed_ips0address0deleted` (`address`,`deleted`),\n# Column types:\n#         `address` varchar(39) default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`fixed_ips` DROP INDEX `address`;\n\n# network_id is a left-prefix of fixed_ips_network_id_host_deleted_idx\n# Key definitions:\n#   KEY `network_id` (`network_id`),\n#   KEY `fixed_ips_network_id_host_deleted_idx` (`network_id`,`host`,`deleted`),\n# Column types:\n#         `network_id` int(11) default null\n#         `host` varchar(255) default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`fixed_ips` DROP INDEX `network_id`;\n\n# ########################################################################\n# nova.instance_type_extra_specs\n# ########################################################################\n\n# instance_type_extra_specs_instance_type_id_key_idx is a left-prefix of uniq_instance_type_extra_specs0instance_type_id0key0deleted\n# Key definitions:\n#   KEY `instance_type_extra_specs_instance_type_id_key_idx` (`instance_type_id`,`key`),\n#   UNIQUE KEY `uniq_instance_type_extra_specs0instance_type_id0key0deleted` (`instance_type_id`,`key`,`deleted`),\n# Column types:\n#         `instance_type_id` int(11) not null\n#         `key` varchar(255) collate utf8_bin default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`instance_type_extra_specs` DROP INDEX `instance_type_extra_specs_instance_type_id_key_idx`;\n\n# ########################################################################\n# nova.instance_type_projects\n# ########################################################################\n\n# instance_type_id is a left-prefix of uniq_instance_type_projects0instance_type_id0project_id0deleted\n# Key definitions:\n#   KEY `instance_type_id` (`instance_type_id`),\n#   UNIQUE KEY `uniq_instance_type_projects0instance_type_id0project_id0deleted` (`instance_type_id`,`project_id`,`deleted`),\n# Column types:\n#         `instance_type_id` int(11) not null\n#         `project_id` varchar(255) default null\n#         `deleted` int(11) default null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`instance_type_projects` DROP INDEX `instance_type_id`;\n\n# ########################################################################\n# nova.inventories\n# ########################################################################\n\n# inventories_resource_provider_id_idx is a left-prefix of uniq_inventories0resource_provider_resource_class\n# Key definitions:\n#   KEY `inventories_resource_provider_id_idx` (`resource_provider_id`),\n#   UNIQUE KEY `uniq_inventories0resource_provider_resource_class` (`resource_provider_id`,`resource_class_id`),\n# Column types:\n#         `resource_provider_id` int(11) not null\n#         `resource_class_id` int(11) not null\n# To remove this duplicate index, execute:\nALTER TABLE `nova`.`inventories` DROP INDEX `inventories_resource_provider_id_idx`;", 
            "date_created": "2016-11-11 18:08:14.546206+00:00", 
            "author": "https://api.launchpad.net/1.0/~abg"
        }
    ]
}