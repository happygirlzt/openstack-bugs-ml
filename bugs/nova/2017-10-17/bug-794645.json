{
    "status": "Fix Released", 
    "last_updated": "2011-09-22 13:27:41.449949+00:00", 
    "description": "Nova revision \nXenServer 5.6\n\nWhen XenAPI driver need to create network VLAN for the first instance of a project, I've got this error:\n\n\n2011-06-08 18:11:08,448 DEBUG nova.rpc [-] received {u'_context_request_id': u'7X9Z6Q908NBVVSJ-SUXB', u'_context_read_deleted': False, u'args': {u'instance_id': 45, u'request_spec': {u'filter': u'nova.scheduler.host_filter.InstanceTypeFilter', u'instance_type': {u'rxtx_quota': 0, u'deleted_at': None, u'name': u'm1.small', u'deleted': False, u'created_at': None, u'updated_at': None, u'memory_mb': 2048, u'vcpus': 1, u'rxtx_cap': 0, u'swap': 0, u'flavorid': 2, u'id': 5,\n u'local_gb': 20}}, u'admin_password': None, u'injected_files': None, u'availability_zone': None}, u'_context_is_admin': None, u'_context_timestamp': u'2011-06-08T16:11:08Z', u'_context_user': u'user1', u'method': u'run_instance', u'_context_project': u'simple', u'_context_remote_address': u'10.193.118.30'} from \n(pid=29408) process_data /usr/lib/pymodules/python2.6/nova/rpc.py:202\n2011-06-08 18:11:08,448 DEBUG nova.rpc [-] unpacked context: {'timestamp': u'2011-06-08T16:11:08Z', 'msg_id': None, 'remote_address': u'10.193.118.30', 'proj\nect': u'simple', 'is_admin': None, 'user': u'user1', 'request_id': u'7X9Z6Q908NBVVSJ-SUXB', 'read_deleted': False} from (pid=29408) _unpack_context /usr/lib/pymodules/python2.6/nova/rpc.py:445\n2011-06-08 18:11:11,291 AUDIT nova.compute.manager [7X9Z6Q908NBVVSJ-SUXB user1 simple] instance 45: starting...\n2011-06-08 18:11:11,409 DEBUG nova.rpc [-] Making asynchronous call on network.p-hs22-12 ... from (pid=29408) multicall /usr/lib/pymodules/python2.6/nova/rpc\n.py:475\n2011-06-08 18:11:11,410 DEBUG nova.rpc [-] MSG_ID is 13d76ae28e8b41f1832245ebdecb3ed8 from (pid=29408) multicall /usr/lib/pymodules/python2.6/nova/rpc.py:478\n2011-06-08 18:11:11,749 DEBUG nova.xenapi_net [-] ENTERING ensure_vlan_bridge in xenapi net from (pid=29408) ensure_vlan_bridge /usr/lib/pymodules/python2.6/\nnova/network/xenapi_net.py:40\n2011-06-08 18:11:12,187 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 87, in _wrap\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 250, in run_instance\n(nova.exception): TRACE:     instance_id)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/network/manager.py\", line 531, in setup_compute_network\n(nova.exception): TRACE:     network_ref['bridge'])\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/network/xenapi_net.py\", line 61, in ensure_vlan_bridge\n(nova.exception): TRACE:     pifs = session.call_xenapi('PIF.get_all_records_where', expr)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/xenapi_conn.py\", line 368, in call_xenapi\n(nova.exception): TRACE:     return tpool.execute(f, *args)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/eventlet/tpool.py\", line 76, in tworker\n(nova.exception): TRACE:     rv = meth(*args,**kwargs)\n(nova.exception): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 229, in __call__\n(nova.exception): TRACE:     return self.__send(self.__name, args)\n(nova.exception): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 133, in xenapi_request\n(nova.exception): TRACE:     result = _parse_result(getattr(self, methodname)(*full_params))\n(nova.exception): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 203, in _parse_result\n(nova.exception): TRACE:     raise Failure(result['ErrorDescription'])\n(nova.exception): TRACE: Failure: ['INTERNAL_ERROR', 'Failure(\"lexing: empty token\")']\n(nova.exception): TRACE: \n2011-06-08 18:11:12,189 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/rpc.py\", line 232, in _process_data\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 93, in _wrap\n(nova): TRACE:     raise Error(str(e))\n(nova): TRACE: Error: ['INTERNAL_ERROR', 'Failure(\"lexing: empty token\")']\n(nova): TRACE: \n\n\nThe instance passed to state 'shutdown' and a network named 'br100' is created on XenServer but no NIC or VLAN are associate to it.\n\nAfter that, I can set manually through the XenCenter, the NIC and VLAN ID for the network and start a new instances in this project, no error are raised and the instances running and network connectivity works.", 
    "tags": [
        "vlan", 
        "xenapi", 
        "xenserver"
    ], 
    "importance": "Low", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/794645", 
    "owner": "https://api.launchpad.net/1.0/~salvatore-orlando", 
    "id": 794645, 
    "index": 193, 
    "openned": "2011-06-08 16:21:58.291152+00:00", 
    "created": "2011-06-08 16:21:58.291152+00:00", 
    "title": "XenServer ensure_vlan_bridge in VLAN mode", 
    "comments": [
        {
            "content": "Nova revision \nXenServer 5.6\n\nWhen XenAPI driver need to create network VLAN for the first instance of a project, I've got this error:\n\n\n2011-06-08 18:11:08,448 DEBUG nova.rpc [-] received {u'_context_request_id': u'7X9Z6Q908NBVVSJ-SUXB', u'_context_read_deleted': False, u'args': {u'instance_id': 45, u'request_spec': {u'filter': u'nova.scheduler.host_filter.InstanceTypeFilter', u'instance_type': {u'rxtx_quota': 0, u'deleted_at': None, u'name': u'm1.small', u'deleted': False, u'created_at': None, u'updated_at': None, u'memory_mb': 2048, u'vcpus': 1, u'rxtx_cap': 0, u'swap': 0, u'flavorid': 2, u'id': 5,\n u'local_gb': 20}}, u'admin_password': None, u'injected_files': None, u'availability_zone': None}, u'_context_is_admin': None, u'_context_timestamp': u'2011-06-08T16:11:08Z', u'_context_user': u'user1', u'method': u'run_instance', u'_context_project': u'simple', u'_context_remote_address': u'10.193.118.30'} from \n(pid=29408) process_data /usr/lib/pymodules/python2.6/nova/rpc.py:202\n2011-06-08 18:11:08,448 DEBUG nova.rpc [-] unpacked context: {'timestamp': u'2011-06-08T16:11:08Z', 'msg_id': None, 'remote_address': u'10.193.118.30', 'proj\nect': u'simple', 'is_admin': None, 'user': u'user1', 'request_id': u'7X9Z6Q908NBVVSJ-SUXB', 'read_deleted': False} from (pid=29408) _unpack_context /usr/lib/pymodules/python2.6/nova/rpc.py:445\n2011-06-08 18:11:11,291 AUDIT nova.compute.manager [7X9Z6Q908NBVVSJ-SUXB user1 simple] instance 45: starting...\n2011-06-08 18:11:11,409 DEBUG nova.rpc [-] Making asynchronous call on network.p-hs22-12 ... from (pid=29408) multicall /usr/lib/pymodules/python2.6/nova/rpc\n.py:475\n2011-06-08 18:11:11,410 DEBUG nova.rpc [-] MSG_ID is 13d76ae28e8b41f1832245ebdecb3ed8 from (pid=29408) multicall /usr/lib/pymodules/python2.6/nova/rpc.py:478\n2011-06-08 18:11:11,749 DEBUG nova.xenapi_net [-] ENTERING ensure_vlan_bridge in xenapi net from (pid=29408) ensure_vlan_bridge /usr/lib/pymodules/python2.6/\nnova/network/xenapi_net.py:40\n2011-06-08 18:11:12,187 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 87, in _wrap\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/compute/manager.py\", line 250, in run_instance\n(nova.exception): TRACE:     instance_id)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/network/manager.py\", line 531, in setup_compute_network\n(nova.exception): TRACE:     network_ref['bridge'])\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/network/xenapi_net.py\", line 61, in ensure_vlan_bridge\n(nova.exception): TRACE:     pifs = session.call_xenapi('PIF.get_all_records_where', expr)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/virt/xenapi_conn.py\", line 368, in call_xenapi\n(nova.exception): TRACE:     return tpool.execute(f, *args)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.6/eventlet/tpool.py\", line 76, in tworker\n(nova.exception): TRACE:     rv = meth(*args,**kwargs)\n(nova.exception): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 229, in __call__\n(nova.exception): TRACE:     return self.__send(self.__name, args)\n(nova.exception): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 133, in xenapi_request\n(nova.exception): TRACE:     result = _parse_result(getattr(self, methodname)(*full_params))\n(nova.exception): TRACE:   File \"/usr/local/lib/python2.6/dist-packages/XenAPI.py\", line 203, in _parse_result\n(nova.exception): TRACE:     raise Failure(result['ErrorDescription'])\n(nova.exception): TRACE: Failure: ['INTERNAL_ERROR', 'Failure(\"lexing: empty token\")']\n(nova.exception): TRACE: \n2011-06-08 18:11:12,189 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/rpc.py\", line 232, in _process_data\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/exception.py\", line 93, in _wrap\n(nova): TRACE:     raise Error(str(e))\n(nova): TRACE: Error: ['INTERNAL_ERROR', 'Failure(\"lexing: empty token\")']\n(nova): TRACE: \n\n\nThe instance passed to state 'shutdown' and a network named 'br100' is created on XenServer but no NIC or VLAN are associate to it.\n\nAfter that, I can set manually through the XenCenter, the NIC and VLAN ID for the network and start a new instances in this project, no error are raised and the instances running and network connectivity works.", 
            "date_created": "2011-06-08 16:21:58.291152+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "Hi Edouard, \n\nSorry for the delayed reply.\n\nlooking at the provided stack trace it seems xapi backend fails to evaluate the filter expression for PIFs. \nCan you confirm that FLAGS.vlan_interface is not empty on your system? (it shouldn't be, anyway).\n\nAlso, you could really help me reproducing the failure by posting a few more bits, namely:\n\n- version of XenServer/XCP/OSS Xen\n- networking stack (linux bridge/OVS)\n- complete set of flags for nova-compute\n\nThanks, \nSalvtore", 
            "date_created": "2011-06-15 08:59:29.264587+00:00", 
            "author": "https://api.launchpad.net/1.0/~salvatore-orlando"
        }, 
        {
            "content": "Apologies again I did not see you were using XenServer 5.6...", 
            "date_created": "2011-06-15 09:01:30.904130+00:00", 
            "author": "https://api.launchpad.net/1.0/~salvatore-orlando"
        }, 
        {
            "content": "Hi Salvatore,\n\nI use the XenServer 5.6 with nova revision 1158 on Ubuntu 10.04.2 and the Linux networking stack (for the moment).\n\nHere my Xenserver compute config :\n\n--verbose\n--logdir=/var/log/nova/\n--lock_path=/var/lib/nova/lockfiles/\n\n--sql_connection=mysql://root:nova@p-novamaster/nova\n--s3_host=p-novamaster\n--rabbit_host=p-novamaster\n--cc_host=p-novamaster\n--ec2_url=http://p-novamaster:8773/services/Cloud\n--auth_driver=nova.auth.dbdriver.DbDriver\n\n--connection_type=xenapi\n--xenapi_connection_url=https://p-hs22-13\n--xenapi_connection_username=root\n--xenapi_connection_password=orange\n--xenapi_inject_image=false\n--rescue_timeout=86400\n\n--network_driver=nova.network.xenapi_net\n--network_manager=nova.network.manager.VlanManager\n--routing_source_ip=10.193.175.154\n--dhcpbridge_flagfile=/etc/nova/nova.conf\n--vlan_interface=xenbr1\n--public_interface=xenbr0\n--dhcpbridge=/usr/bin/nova-dhcpbridge\n--ec2_dmz_host=10.193.175.44\n#--fixed_range=172.16.1.0/24\n--dmz_cidr=10.193.175.44/32\n\n--ca_path=/var/lib/nova/CA/\n--keys_path=/var/lib/nova/keys/\n--images_path=/media/data/Nova/images/\n--buckets_path=/media/data/Nova/buckets/\n--networks_path=/var/lib/nova/networks/\n--instances_path=/var/lib/nova/instances/\n\n\n--image_service=nova.image.glance.GlanceImageService\n--glance_api_server=p-novamaster\n\n--default_project=simple\n--allow_admin_api=True\n--allow_project_net_traffic=False\n\n--vpn_image_id=71\n--use_project_ca\n--cnt_vpn_clients=5\n\n--iscsi_ip_prefix=10.193.175.167\n", 
            "date_created": "2011-06-15 14:03:20.728070+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "Hi Edouard,\n\nI haven't yet tried to run nova using your conf, but this flag caught my eye:\n\n--vlan_interface=xenbr1\n\nvlan_interface is supposed to be physical ethernet device over which VLANs are created.\nFor xenapi, this should be a PIF, and therefore eth1 (which is usally associated with xenbr1). \n\nAs soon as I will run nova with your configuration I will be able to provide you with more detailed information.", 
            "date_created": "2011-06-15 16:58:30.017131+00:00", 
            "author": "https://api.launchpad.net/1.0/~salvatore-orlando"
        }, 
        {
            "content": "Hi Salvatore,\n\nYes, you are right. I must set 'vlan_interface' to eth1.\nI Tried it, but I always have the same problem.", 
            "date_created": "2011-06-16 09:21:43.351134+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "Hi Edouard, \n\nI apologise but I've been unable to reproduce the exception so far, even with your configuration. \nBasically the problem appears to be an internal xenapi failure when evaluating the filter expression for PIF.get_all_records_where operation. \n\nI'm afraid I have to ask you some more information:\n\n1) XenServer build number\n     (you can retrieve it by executing 'cat /etc/xensource-inventory | grep BUILD_NUMBER' at dom0 console)\n2) PIFs - are there only ethX PIFs or are there other PIFs as well? Do eth PIFs have the VLAN attribute set to '-1'?\n     (it would be great to have xe pif-list output, but I understand there might be privacy concerns).\n\nThanks,\nSalvatore\n\n\n\n", 
            "date_created": "2011-06-16 16:19:31.297513+00:00", 
            "author": "https://api.launchpad.net/1.0/~salvatore-orlando"
        }, 
        {
            "content": "Hi,\n\n1)\n# cat /etc/xensource-inventory | grep BUILD_NUMBER\nBUILD_NUMBER='47101p'\n\n2) No privacy problem to give the PIF output :\n\nxe pif-list\nuuid ( RO)                  : 40dbbf5f-ac4a-9c2d-311b-c16cc42a70f0\n                device ( RO): eth0\n    currently-attached ( RO): true\n                  VLAN ( RO): -1\n          network-uuid ( RO): 11ab40a2-6e1f-245c-1325-43c518b4f701\n\n\nuuid ( RO)                  : cd6264a5-66e4-513f-0923-19fd75b9255a\n                device ( RO): eth1\n    currently-attached ( RO): true\n                  VLAN ( RO): 100\n          network-uuid ( RO): a8476c27-5390-e86c-8191-f7d48867c27f\n\n\nuuid ( RO)                  : 9774dced-3d9f-f5b1-d4ec-ec0732c46c1e\n                device ( RO): eth1\n    currently-attached ( RO): true\n                  VLAN ( RO): -1\n          network-uuid ( RO): 88a9610a-cda1-1382-ac69-14fc9ce14d78\n", 
            "date_created": "2011-06-16 16:31:14.306187+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "Oops, just to say, I openned a question about XenServer and Glance here: https://answers.launchpad.net/nova/+question/161683\n\nPerhaps you can answer it.", 
            "date_created": "2011-06-16 16:33:05.034885+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "For the output command 'xe pif-list', the second entry correspond to a network of a Nova project (VLAN 100 I set manually).\nIf I haven't any network set for a Nova project, the output command is:\n\n<XenServer># xe pif-list\nuuid ( RO)                  : 40dbbf5f-ac4a-9c2d-311b-c16cc42a70f0\n                device ( RO): eth0\n    currently-attached ( RO): true\n                  VLAN ( RO): -1\n          network-uuid ( RO): 11ab40a2-6e1f-245c-1325-43c518b4f701\n\n\nuuid ( RO)                  : 9774dced-3d9f-f5b1-d4ec-ec0732c46c1e\n                device ( RO): eth1\n    currently-attached ( RO): true\n                  VLAN ( RO): -1\n          network-uuid ( RO): 88a9610a-cda1-1382-ac69-14fc9ce14d78\n\n", 
            "date_created": "2011-06-17 09:08:30.673278+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "I made a small patch.\n\nIf network doesn't exist, it create one and it gets all PIF and explores them to find the one with associated device is equal to flag 'vlan_interface' and VLAN to value '-1'. If found, create new PIF with project VLAN id and associate it to the new network. If doesn't found, it raises an exception.\n\n", 
            "date_created": "2011-06-17 12:54:08.333403+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "", 
            "date_created": "2011-06-17 12:54:48.029888+00:00", 
            "author": "https://api.launchpad.net/1.0/~ethuleau"
        }, 
        {
            "content": "Hi Edouard, \n\nI looked back at your initial bug report and I saw you found the error against rev 1158. \nLooking at changes in nova revs, I found out that the string for building the filter was slightly changed, replacing single quotes with double quotes and vice versa. \nThis caused the failure as xapi backend only accepts filter tokens enclosed in double quotes. \n\nI think the change was due to coding style consistency. I have reverted the string to the old style, and verified that the error does not occur anymore. The fix will be proposed for merge. \n\nIf the change gets rejected for coding style issues, I will propose a fix along the lines of the patch you supplied (btw, thanks for providing it). \n\nThanks, \nSalvatore", 
            "date_created": "2011-06-20 14:46:16.112290+00:00", 
            "author": "https://api.launchpad.net/1.0/~salvatore-orlando"
        }
    ], 
    "closed": "2011-09-22 13:27:40.217520+00:00"
}