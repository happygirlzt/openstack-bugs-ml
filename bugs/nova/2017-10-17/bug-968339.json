{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 11:09:32.281803+00:00", 
    "description": "Running a stress test that quickly creates and reboots many instances, the following error occurs in nova-compute. I don't know this code but it seems to be asking libvirt for a list of instances and then probing them. But what happens if the instance is no longer available when the code gets to its place on the list? \n\nThe Tempest stress test run that produced this has not yet been checked in but should be very soon.\n\n\n8653c4396d476289162d78fdf251f1] check_instance_lock: decorating: |<function reboot_instance at 0x158a1b8>|\n2012-03-29 11:02:17 INFO nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d\\\n8653c4396d476289162d78fdf251f1] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x7fb154a8b\\\nb50>| |<nova.rpc.amqp.RpcContext object at 0x3500f90>| |481133bb-3487-4ed2-acf3-8b1521f3c7e0|\n2012-03-29 11:02:17 DEBUG nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5\\\nd8653c4396d476289162d78fdf251f1] instance 481133bb-3487-4ed2-acf3-8b1521f3c7e0: getting locked state from (pid=1367) get_lo\\\nck /usr/lib/python2.7/dist-packages/nova/compute/manager.py:1596\n2012-03-29 11:02:17 INFO nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d\\\n8653c4396d476289162d78fdf251f1] check_instance_lock: locked: |False|\n2012-03-29 11:02:17 INFO nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d\\\n8653c4396d476289162d78fdf251f1] check_instance_lock: admin: |True|\n2012-03-29 11:02:17 INFO nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d\\\n8653c4396d476289162d78fdf251f1] check_instance_lock: executing: |<function reboot_instance at 0x158a1b8>|\n2012-03-29 11:02:17 AUDIT nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5\\\nd8653c4396d476289162d78fdf251f1] Rebooting instance 481133bb-3487-4ed2-acf3-8b1521f3c7e0\n2012-03-29 11:02:17 DEBUG nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5\\\nd8653c4396d476289162d78fdf251f1] [instance: 481133bb-3487-4ed2-acf3-8b1521f3c7e0] Checking state from (pid=1367) _get_power\\\n_state /usr/lib/python2.7/dist-packages/nova/compute/manager.py:260\n2012-03-29 11:02:18 DEBUG nova.rpc.amqp [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d8653c4\\\n396d476289162d78fdf251f1] Making asynchronous call on network ... from (pid=1367) multicall /usr/lib/python2.7/dist-package\\\ns/nova/rpc/amqp.py:321\n2012-03-29 11:02:18 DEBUG nova.rpc.amqp [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d8653c4\\\n396d476289162d78fdf251f1] MSG_ID is 6456ecf038464194bc5614763f033a2b from (pid=1367) multicall /usr/lib/python2.7/dist-pack\\\nages/nova/rpc/amqp.py:324\n2012-03-29 11:02:18 DEBUG nova.utils [-] Running cmd (subprocess): qemu-img info /var/lib/nova/instances/instance-00000017/\\\ndisk from (pid=1367) execute /usr/lib/python2.7/dist-packages/nova/utils.py:221\n2012-03-29 11:02:18 DEBUG nova.utils [req-bda58051-5080-4674-bd0b-b85fb5aefdb8 8d8b2da6dbef4362a779699cafde336c 5d8653c4396\\\nd476289162d78fdf251f1] Running cmd (subprocess): sudo nova-rootwrap iptables-restore from (pid=1367) execute /usr/lib/pytho\\\nn2.7/dist-packages/nova/utils.py:221\n2012-03-29 11:02:19 ERROR nova.manager [-] Error during ComputeManager.update_available_resource: Instance instance-0000001\\\n6 could not be found.\n(nova.manager): TRACE: Traceback (most recent call last):\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/manager.py\", line 155, in periodic_tasks\n(nova.manager): TRACE:     task(self, context)\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2402, in update_available_re\\\nsource\n(nova.manager): TRACE:     self.driver.update_available_resource(context, self.host)\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1931, in update_avai\\\nlable_resource\n(nova.manager): TRACE:     'disk_available_least': self.get_disk_available_least()}\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 2283, in get_disk_av\\\nailable_least\n(nova.manager): TRACE:     disk_infos = utils.loads(self.get_instance_disk_info(i_name))\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 2223, in get_instanc\\\ne_disk_info\n(nova.manager): TRACE:     virt_dom = self._lookup_by_name(instance_name)\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1567, in _lookup_by_\\\nname\n(nova.manager): TRACE:     raise exception.InstanceNotFound(instance_id=instance_name)\n(nova.manager): TRACE: InstanceNotFound: Instance instance-00000016 could not be found.\n(nova.m", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/968339", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 968339, 
    "index": 648, 
    "openned": "2012-03-29 15:47:14.982123+00:00", 
    "created": "2012-03-29 15:47:14.982123+00:00", 
    "title": "Race condition in LibVirtConnection.get_disk_available_least", 
    "comments": [
        {
            "content": "Running a stress test that quickly creates and reboots many instances, the following error occurs in nova-compute. I don't know this code but it seems to be asking libvirt for a list of instances and then probing them. But what happens if the instance is no longer available when the code gets to its place on the list? \n\nThe Tempest stress test run that produced this has not yet been checked in but should be very soon.\n\n\n8653c4396d476289162d78fdf251f1] check_instance_lock: decorating: |<function reboot_instance at 0x158a1b8>|\n2012-03-29 11:02:17 INFO nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d\\\n8653c4396d476289162d78fdf251f1] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x7fb154a8b\\\nb50>| |<nova.rpc.amqp.RpcContext object at 0x3500f90>| |481133bb-3487-4ed2-acf3-8b1521f3c7e0|\n2012-03-29 11:02:17 DEBUG nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5\\\nd8653c4396d476289162d78fdf251f1] instance 481133bb-3487-4ed2-acf3-8b1521f3c7e0: getting locked state from (pid=1367) get_lo\\\nck /usr/lib/python2.7/dist-packages/nova/compute/manager.py:1596\n2012-03-29 11:02:17 INFO nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d\\\n8653c4396d476289162d78fdf251f1] check_instance_lock: locked: |False|\n2012-03-29 11:02:17 INFO nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d\\\n8653c4396d476289162d78fdf251f1] check_instance_lock: admin: |True|\n2012-03-29 11:02:17 INFO nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d\\\n8653c4396d476289162d78fdf251f1] check_instance_lock: executing: |<function reboot_instance at 0x158a1b8>|\n2012-03-29 11:02:17 AUDIT nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5\\\nd8653c4396d476289162d78fdf251f1] Rebooting instance 481133bb-3487-4ed2-acf3-8b1521f3c7e0\n2012-03-29 11:02:17 DEBUG nova.compute.manager [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5\\\nd8653c4396d476289162d78fdf251f1] [instance: 481133bb-3487-4ed2-acf3-8b1521f3c7e0] Checking state from (pid=1367) _get_power\\\n_state /usr/lib/python2.7/dist-packages/nova/compute/manager.py:260\n2012-03-29 11:02:18 DEBUG nova.rpc.amqp [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d8653c4\\\n396d476289162d78fdf251f1] Making asynchronous call on network ... from (pid=1367) multicall /usr/lib/python2.7/dist-package\\\ns/nova/rpc/amqp.py:321\n2012-03-29 11:02:18 DEBUG nova.rpc.amqp [req-e0ac41dc-0790-43e8-97eb-153d8b7cb9a7 8d8b2da6dbef4362a779699cafde336c 5d8653c4\\\n396d476289162d78fdf251f1] MSG_ID is 6456ecf038464194bc5614763f033a2b from (pid=1367) multicall /usr/lib/python2.7/dist-pack\\\nages/nova/rpc/amqp.py:324\n2012-03-29 11:02:18 DEBUG nova.utils [-] Running cmd (subprocess): qemu-img info /var/lib/nova/instances/instance-00000017/\\\ndisk from (pid=1367) execute /usr/lib/python2.7/dist-packages/nova/utils.py:221\n2012-03-29 11:02:18 DEBUG nova.utils [req-bda58051-5080-4674-bd0b-b85fb5aefdb8 8d8b2da6dbef4362a779699cafde336c 5d8653c4396\\\nd476289162d78fdf251f1] Running cmd (subprocess): sudo nova-rootwrap iptables-restore from (pid=1367) execute /usr/lib/pytho\\\nn2.7/dist-packages/nova/utils.py:221\n2012-03-29 11:02:19 ERROR nova.manager [-] Error during ComputeManager.update_available_resource: Instance instance-0000001\\\n6 could not be found.\n(nova.manager): TRACE: Traceback (most recent call last):\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/manager.py\", line 155, in periodic_tasks\n(nova.manager): TRACE:     task(self, context)\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2402, in update_available_re\\\nsource\n(nova.manager): TRACE:     self.driver.update_available_resource(context, self.host)\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1931, in update_avai\\\nlable_resource\n(nova.manager): TRACE:     'disk_available_least': self.get_disk_available_least()}\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 2283, in get_disk_av\\\nailable_least\n(nova.manager): TRACE:     disk_infos = utils.loads(self.get_instance_disk_info(i_name))\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 2223, in get_instanc\\\ne_disk_info\n(nova.manager): TRACE:     virt_dom = self._lookup_by_name(instance_name)\n(nova.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1567, in _lookup_by_\\\nname\n(nova.manager): TRACE:     raise exception.InstanceNotFound(instance_id=instance_name)\n(nova.manager): TRACE: InstanceNotFound: Instance instance-00000016 could not be found.\n(nova.m", 
            "date_created": "2012-03-29 15:47:14.982123+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/5999", 
            "date_created": "2012-03-30 17:09:46.641182+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/5999\nCommitted: http://github.com/openstack/nova/commit/e1580f2f99e8900aabdb5a049198adcc5af86229\nSubmitter: Jenkins\nBranch:    master\n\ncommit e1580f2f99e8900aabdb5a049198adcc5af86229\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Fri Mar 30 10:05:45 2012 -0700\n\n    Handle not found in check for disk availability\n    \n     * includes failing test\n     * fixes bug 968339\n    \n    Change-Id: I92951a9d2f2027464e915608e8aaf205543f3c93\n", 
            "date_created": "2012-03-30 18:19:41.519383+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: milestone-proposed\nReview: https://review.openstack.org/6016", 
            "date_created": "2012-03-30 23:41:44.466570+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/6016\nCommitted: http://github.com/openstack/nova/commit/e54ad5a1ce1e02b6842a3197700eeeca33b1ca88\nSubmitter: Jenkins\nBranch:    milestone-proposed\n\ncommit e54ad5a1ce1e02b6842a3197700eeeca33b1ca88\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Fri Mar 30 10:05:45 2012 -0700\n\n    Handle not found in check for disk availability\n    \n     * includes failing test\n     * fixes bug 968339\n    \n    Change-Id: I92951a9d2f2027464e915608e8aaf205543f3c93\n", 
            "date_created": "2012-03-31 23:25:22.808936+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-03-31 23:25:21.472482+00:00"
}