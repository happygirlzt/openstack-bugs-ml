{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:45:34.000878+00:00", 
    "description": "This review:\n\nhttps://review.openstack.org/#/c/34949/3\n\nAdded a heartbeat config to kombu... however, kombu requires that you call heartbeat_check() periodically to verify that the heartbeats have been received.  No such call was added.\n\nThis results in kombu closing the connection every 60 seconds or so (the default heartbeat config) and causing a lot of tracebacks in logs when trying to consume messages.  kombu ends up raising 'Socket closed' and reconnecting:\n\n2013-07-10 22:01:04.822 13893 ERROR nova.openstack.common.rpc.common [-] Failed\nto consume message from queue: Socket closed\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common Traceback (most recent call last):\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/nova/openstack/common/rpc/impl_kombu.py\", line 589, in ensure\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     return method(*args, **kwargs)\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/nova/openstack/common/rpc/impl_kombu.py\", line 669, in _consume\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     return self.connection.drain_events(timeout=timeout)\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/kombu/connection.py\", line 281, in drain_events\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     return self.transport.drain_events(self.connection, **kwargs)\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/kombu/transport/pyamqp.py\", line 91, in drain_events\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     return connection.drain_events(**kwargs)\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/amqp/connection.py\", line 266, in drain_events\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     chanmap, None, timeout=timeout,\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/amqp/connection.py\", line 328, in _wait_multiple\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     channel, method_sig, args, content = read_timeout(timeout)\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/amqp/connection.py\", line 292, in read_timeout\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     return self.method_reader.read_method()\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/amqp/method_framing.py\", line 187, in read_method\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     raise m\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common IOError: Socket closed\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common\n2013-07-10 22:01:04.829 13893 INFO nova.openstack.common.rpc.common [-] Reconnecting to AMQP server on <foo>:5672", 
    "tags": [], 
    "importance": "Critical", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1200069", 
    "owner": "https://api.launchpad.net/1.0/~markmc", 
    "id": 1200069, 
    "index": 145, 
    "openned": "2013-07-11 05:42:01.284179+00:00", 
    "created": "2013-07-11 03:48:05.529337+00:00", 
    "title": "heartbeating is broken with kombu", 
    "comments": [
        {
            "content": "This review:\n\nhttps://review.openstack.org/#/c/34949/3\n\nAdded a heartbeat config to kombu... however, kombu requires that you call heartbeat_check() periodically to verify that the heartbeats have been received.  No such call was added.\n\nThis results in kombu closing the connection every 60 seconds or so (the default heartbeat config) and causing a lot of tracebacks in logs when trying to consume messages.  kombu ends up raising 'Socket closed' and reconnecting:\n\n2013-07-10 22:01:04.822 13893 ERROR nova.openstack.common.rpc.common [-] Failed\nto consume message from queue: Socket closed\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common Traceback (most recent call last):\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/nova/openstack/common/rpc/impl_kombu.py\", line 589, in ensure\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     return method(*args, **kwargs)\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/nova/openstack/common/rpc/impl_kombu.py\", line 669, in _consume\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     return self.connection.drain_events(timeout=timeout)\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/kombu/connection.py\", line 281, in drain_events\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     return self.transport.drain_events(self.connection, **kwargs)\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/kombu/transport/pyamqp.py\", line 91, in drain_events\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     return connection.drain_events(**kwargs)\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/amqp/connection.py\", line 266, in drain_events\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     chanmap, None, timeout=timeout,\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/amqp/connection.py\", line 328, in _wait_multiple\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     channel, method_sig, args, content = read_timeout(timeout)\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/amqp/connection.py\", line 292, in read_timeout\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     return self.method_reader.read_method()\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common   File \"/opt/nova/lib/python2.6/site-packages/amqp/method_framing.py\", line 187, in read_method\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common     raise m\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common IOError: Socket closed\n2013-07-10 22:01:04.822 13893 TRACE nova.openstack.common.rpc.common\n2013-07-10 22:01:04.829 13893 INFO nova.openstack.common.rpc.common [-] Reconnecting to AMQP server on <foo>:5672", 
            "date_created": "2013-07-11 03:48:05.529337+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbehrens"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/36606", 
            "date_created": "2013-07-11 05:43:37.304424+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Nova revert: https://review.openstack.org/36605", 
            "date_created": "2013-07-11 05:44:26.683862+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "I was wondering how we can avoid this kind of things to happen again in the future.\nMaybe for the change like that  one (enable a functionality on an external dependency) we should require a functional/integration test to prove that the feature is working as expected, but how we can do it?\n\nI think about tempest test, but we can't have a tempest test if the code has not been merged yet, so the right place to put these kind of tests is in the unit test?\n\nThanks\nPS: do we need to move this discussion on the mailing list?\n", 
            "date_created": "2013-07-11 08:26:24.965439+00:00", 
            "author": "https://api.launchpad.net/1.0/~andrea-rosa-m"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/36606\nCommitted: http://github.com/openstack/oslo-incubator/commit/f9f1b4f971f209feebb3bc6d32c397f4daa8ff1e\nSubmitter: Jenkins\nBranch:    master\n\ncommit f9f1b4f971f209feebb3bc6d32c397f4daa8ff1e\nAuthor: Mark McLoughlin <email address hidden>\nDate:   Thu Jul 11 05:43:29 2013 +0000\n\n    Revert \"Add support for heartbeating in the kombu RPC driver\"\n    \n    Fixes bug #1200069\n    \n    Looks like there's a serious issue with the kombu heartbeat implementation.\n    \n    This reverts commit c37f6aaab3ac00b7865dee18158114433350237e\n", 
            "date_created": "2013-07-11 10:35:06.179102+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "@andrea-rosa-m -- I don't think we should set a goal of never getting issues like this merged. External dependencies, like this one, are certainly not unit-testable (I'll try not to go on a rant about the definition of a unit test and their purpose here) and the quick revert markmc proposed is a good short/medium term solution.\n\nAs you mention, this is about functional testing and the lack of our ability to functionally test branches with different configurations before being merged. \n\nIMO *all* features being introduced, like this one, should be OFF by default until they have been functionally vetted. That might be a good middle ground? I think there was a blueprint/discussion about this not too long ago but I'm too lazy to look right now!", 
            "date_created": "2013-07-11 14:14:18.253915+00:00", 
            "author": "https://api.launchpad.net/1.0/~blamar"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/36605\nCommitted: http://github.com/openstack/nova/commit/557cccc4da5c334efc3d1cb8471cea7b83b59e63\nSubmitter: Jenkins\nBranch:    master\n\ncommit 557cccc4da5c334efc3d1cb8471cea7b83b59e63\nAuthor: Mark McLoughlin <email address hidden>\nDate:   Thu Jul 11 05:41:37 2013 +0000\n\n    Revert \"Sync latest rpc changes from oslo-incubator\"\n    \n    Fixes bug #1200069\n    \n    Looks like there's a serious issue with the kombu heartbeat implementation.\n    \n    This reverts commit 386a8c21ec6acbaa059eabd166dbf7feea2fad7d\n    \n    Change-Id: I354f5e3c5af110542a3c25d117b14e7be02f169b\n", 
            "date_created": "2013-07-11 22:20:39.166611+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-07-17 12:11:04.690028+00:00"
}