{
    "status": "In Progress", 
    "last_updated": "2017-06-27 15:54:45.724149+00:00", 
    "description": "Description\n===========\nWhen I run \"nova list --delete\" on our OpenStack environment(Mitaka(RHOSP9)), it failed due to the following error.\n------------\nERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.InstanceNotFound'> (HTTP 500) (Request-ID: req-f2ee67f2-2d81-4e6f-b707-d9a713383191)\n------------\n\n   Note: I reproduced it on our Newton(RHOSP10) environment too.\n\nAnd the following messages was outputted from nova-api.log.\n-----------------------------\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions [req-f2ee67f2-2d81-4e6f-b707-d9a713383191 48c0c48c3a284a909b5dd6aa20073ffa ebb9a4f3d9d845bdb984c18c1d8fae05 - - -] Unexpected exception in API method\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions Traceback (most recent call last):\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/extensions.py\", line 478, in wrapped\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/servers.py\", line 294, in detail\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     servers = self._get_servers(req, is_detail=True)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/servers.py\", line 421, in _get_servers\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     response = self._view_builder.detail(req, instance_list)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/views/servers.py\", line 150, in detail\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return self._list_view(self.show, request, instances, coll_name)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/views/servers.py\", line 162, in _list_view\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     server_list = [func(request, server)[\"server\"] for server in servers]\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/views/servers.py\", line 290, in show\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     \"flavor\": self._get_flavor(request, instance),\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/views/servers.py\", line 222, in _get_flavor\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     instance_type = instance.get_flavor()\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 932, in get_flavor\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return getattr(self, attr)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 67, in getter\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     self.obj_load_attr(name)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 917, in obj_load_attr\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     self._load_flavor()\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 793, in _load_flavor\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     expected_attrs=['flavor', 'system_metadata'])\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 181, in wrapper\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 399, in get_by_uuid\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     use_slave=use_slave)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 285, in wrapper\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 391, in _db_instance_get_by_uuid\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     columns_to_join=columns_to_join)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/api.py\", line 696, in instance_get_by_uuid\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return IMPL.instance_get_by_uuid(context, uuid, columns_to_join)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 229, in wrapper\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 330, in wrapped\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return f(context, *args, **kwargs)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 1970, in instance_get_by_uuid\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     columns_to_join=columns_to_join)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 1979, in _instance_get_by_uuid\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     raise exception.InstanceNotFound(instance_id=uuid)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions InstanceNotFound: Instance decfb2f4-d8a6-49dd-89f0-3aa2fdeb8b6e could not be found.\n-----------------------------\n\nI noticed that when this problem happened, there were 2 records about the\ninstance(decfb2f4-d8a6-49dd-89f0-3aa2fdeb8b6) that caused the error in \ninstance_extra table of nova DB. And one of their flavor is NULL.\n\n--------\n# mysql -u root nova -e \"select * from instance_extra where instance_uuid='decfb2f4-d8a6-49dd-89f0-3aa2fdeb8b6e'\\G\" \n*************************** 1. row ***************************\n        created_at: 2016-11-16 07:25:09\n        updated_at: 2016-11-16 07:27:24\n        deleted_at: 2016-11-16 07:27:26\n           deleted: 5837\n                id: 5837\n     instance_uuid: decfb2f4-d8a6-49dd-89f0-3aa2fdeb8b6e\n     numa_topology: NULL\n      pci_requests: []\n            flavor: {\"new\": null, \"old\": null, \"cur\": {\"nova_object.version\": \"1.1\", ....\n            .....\n*************************** 2. row ***************************\n        created_at: 2016-11-16 07:27:26\n        updated_at: NULL\n        deleted_at: NULL\n           deleted: 0\n                id: 5838\n     instance_uuid: decfb2f4-d8a6-49dd-89f0-3aa2fdeb8b6e\n     numa_topology: NULL\n      pci_requests: []\n            flavor: NULL\n            .....\n--------\n\nAccording to my investigating, in the current instance_extra_update_by_uuid(), \nwhen updating an instance, if there is no entry for an instance, nova create \na new entry for it. For somehow, if updating comes after the instance has been deleted \n(its entry would be soft-deleted), nova would create a new entry for \nthe deleted instance and keep its flavor being NULL. It causes instance_extra \nentry duplicate for the same instance_uuid. I think it cause this problem.\n\nSteps to reproduce\n==================\nI can reproduce the problem with the following steps.\n\n   Note: please notice it's timing problem. It doesn't alway heppen.\n         But once it happened, it can be reproduced always.\n         Unless you delete the duplicate entry from instance_extra table.\n\n1, Boot an instance. Meanwhile stop rabbitmq-server.\n2, Restart rabbitmq-server.\n3, Delete the instance.\n4, Run \"nova list --delete\".\n\nFor those deleted instance, I think we shouldn't \ncreate a new entry for it. It's better to just skip the \"updating\".", 
    "tags": [
        "db", 
        "openstack-version.mitaka"
    ], 
    "importance": "Undecided", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1651319", 
    "owner": "https://api.launchpad.net/1.0/~wei-fan", 
    "id": 1651319, 
    "index": 7855, 
    "openned": "2016-12-20 05:26:57.174284+00:00", 
    "created": "2016-12-20 05:26:57.174284+00:00", 
    "title": "'nova list --delete' failed due to InstanceNotFound exception", 
    "comments": [
        {
            "content": "Description\n===========\nWhen I run \"nova list --delete\" on our OpenStack environment(Mitaka(RHOSP9)), it failed due to the following error.\n------------\nERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.InstanceNotFound'> (HTTP 500) (Request-ID: req-f2ee67f2-2d81-4e6f-b707-d9a713383191)\n------------\n\n   Note: I reproduced it on our Newton(RHOSP10) environment too.\n\nAnd the following messages was outputted from nova-api.log.\n-----------------------------\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions [req-f2ee67f2-2d81-4e6f-b707-d9a713383191 48c0c48c3a284a909b5dd6aa20073ffa ebb9a4f3d9d845bdb984c18c1d8fae05 - - -] Unexpected exception in API method\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions Traceback (most recent call last):\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/extensions.py\", line 478, in wrapped\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/servers.py\", line 294, in detail\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     servers = self._get_servers(req, is_detail=True)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/servers.py\", line 421, in _get_servers\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     response = self._view_builder.detail(req, instance_list)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/views/servers.py\", line 150, in detail\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return self._list_view(self.show, request, instances, coll_name)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/views/servers.py\", line 162, in _list_view\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     server_list = [func(request, server)[\"server\"] for server in servers]\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/views/servers.py\", line 290, in show\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     \"flavor\": self._get_flavor(request, instance),\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/views/servers.py\", line 222, in _get_flavor\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     instance_type = instance.get_flavor()\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 932, in get_flavor\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return getattr(self, attr)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 67, in getter\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     self.obj_load_attr(name)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 917, in obj_load_attr\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     self._load_flavor()\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 793, in _load_flavor\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     expected_attrs=['flavor', 'system_metadata'])\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 181, in wrapper\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 399, in get_by_uuid\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     use_slave=use_slave)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 285, in wrapper\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 391, in _db_instance_get_by_uuid\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     columns_to_join=columns_to_join)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/api.py\", line 696, in instance_get_by_uuid\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return IMPL.instance_get_by_uuid(context, uuid, columns_to_join)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 229, in wrapper\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 330, in wrapped\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     return f(context, *args, **kwargs)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 1970, in instance_get_by_uuid\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     columns_to_join=columns_to_join)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions   File \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 1979, in _instance_get_by_uuid\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions     raise exception.InstanceNotFound(instance_id=uuid)\n2016-11-25 11:22:25.660 21809 ERROR nova.api.openstack.extensions InstanceNotFound: Instance decfb2f4-d8a6-49dd-89f0-3aa2fdeb8b6e could not be found.\n-----------------------------\n\nI noticed that when this problem happened, there were 2 records about the\ninstance(decfb2f4-d8a6-49dd-89f0-3aa2fdeb8b6) that caused the error in \ninstance_extra table of nova DB. And one of their flavor is NULL.\n\n--------\n# mysql -u root nova -e \"select * from instance_extra where instance_uuid='decfb2f4-d8a6-49dd-89f0-3aa2fdeb8b6e'\\G\" \n*************************** 1. row ***************************\n        created_at: 2016-11-16 07:25:09\n        updated_at: 2016-11-16 07:27:24\n        deleted_at: 2016-11-16 07:27:26\n           deleted: 5837\n                id: 5837\n     instance_uuid: decfb2f4-d8a6-49dd-89f0-3aa2fdeb8b6e\n     numa_topology: NULL\n      pci_requests: []\n            flavor: {\"new\": null, \"old\": null, \"cur\": {\"nova_object.version\": \"1.1\", ....\n            .....\n*************************** 2. row ***************************\n        created_at: 2016-11-16 07:27:26\n        updated_at: NULL\n        deleted_at: NULL\n           deleted: 0\n                id: 5838\n     instance_uuid: decfb2f4-d8a6-49dd-89f0-3aa2fdeb8b6e\n     numa_topology: NULL\n      pci_requests: []\n            flavor: NULL\n            .....\n--------\n\nAccording to my investigating, in the current instance_extra_update_by_uuid(), \nwhen updating an instance, if there is no entry for an instance, nova create \na new entry for it. For somehow, if updating comes after the instance has been deleted \n(its entry would be soft-deleted), nova would create a new entry for \nthe deleted instance and keep its flavor being NULL. It causes instance_extra \nentry duplicate for the same instance_uuid. I think it cause this problem.\n\nSteps to reproduce\n==================\nI can reproduce the problem with the following steps.\n\n   Note: please notice it's timing problem. It doesn't alway heppen.\n         But once it happened, it can be reproduced always.\n         Unless you delete the duplicate entry from instance_extra table.\n\n1, Boot an instance. Meanwhile stop rabbitmq-server.\n2, Restart rabbitmq-server.\n3, Delete the instance.\n4, Run \"nova list --delete\".\n\nFor those deleted instance, I think we shouldn't \ncreate a new entry for it. It's better to just skip the \"updating\".", 
            "date_created": "2016-12-20 05:26:57.174284+00:00", 
            "author": "https://api.launchpad.net/1.0/~wei-fan"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/412771", 
            "date_created": "2016-12-20 06:30:55.690784+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Automatically discovered version mitaka in description. If this is incorrect, please update the description to include 'nova version: ...'", 
            "date_created": "2017-06-27 15:54:45.091468+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}