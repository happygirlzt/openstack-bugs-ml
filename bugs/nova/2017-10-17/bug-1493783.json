{
    "status": "Expired", 
    "last_updated": "2015-11-09 04:17:34.816944+00:00", 
    "description": "We\u2019ve deployed OpenStack with Ceph as a storage (rbd). The instances are being boot using cinder volumes through Ceph too.\n\nSometimes the following ERROR appears at the nova-compute.log: [Errno 24] Too many open files\n\nIf we get the list of open files from any nova-compute process, we\u2019ll see the following:\n\nroot@qk-3:~# ps -auxwww | grep nova-compute\nnova     137430  2.4  0.0 2395468 106888 ?      Ssl  Sep07  65:54 /usr/bin/python /usr/bin/nova-compute --config-file=/etc/nova/nova.conf --config-file=/etc/nova/nova-compute.conf\n\nroot@qk-3:~# lsof -p 137430 | wc -l\n5406\n\nAlmost all open files is:\nnova-comp 137430 nova 5232r  FIFO                0,8      0t0 948057084 pipe\nnova-comp 137430 nova 5233u  unix 0xffff881ad3192300      0t0 948012913 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5234r  FIFO                0,8      0t0 948057088 pipe\nnova-comp 137430 nova 5235u  unix 0xffff881ad3192680      0t0 948057085 /var/run/ceph/guests/ceph-client.cinder.137430.35260960.asok\nnova-comp 137430 nova 5236r  FIFO                0,8      0t0 948073475 pipe\nnova-comp 137430 nova 5237u  unix 0xffff881ad3192d80      0t0 948073473 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5238r  FIFO                0,8      0t0 948073522 pipe\nnova-comp 137430 nova 5239u  unix 0xffff881ad3195080      0t0 948073476 /var/run/ceph/guests/ceph-client.cinder.137430.35361600.asok\nnova-comp 137430 nova 5240r  FIFO                0,8      0t0 948073526 pipe\nnova-comp 137430 nova 5241u  unix 0xffff881ad3197700      0t0 948073523 /var/run/ceph/guests/ceph-client.cinder.137430.35260960.asok\nnova-comp 137430 nova 5242r  FIFO                0,8      0t0 948073532 pipe\nnova-comp 137430 nova 5243u  unix 0xffff881ad3196c80      0t0 948073527 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5244r  FIFO                0,8      0t0 948073535 pipe\nnova-comp 137430 nova 5245u  unix 0xffff881ad3196580      0t0 948073533 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5246r  FIFO                0,8      0t0 948163602 pipe\nnova-comp 137430 nova 5247u  unix 0xffff881ad3195b00      0t0 948073536 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5248r  FIFO                0,8      0t0 948160472 pipe\nnova-comp 137430 nova 5249u  unix 0xffff88301f2ec600      0t0 948163603 /var/run/ceph/guests/ceph-client.cinder.137430.35260960.asok\nnova-comp 137430 nova 5250r  FIFO                0,8      0t0 948160475 pipe\nnova-comp 137430 nova 5251u  unix 0xffff881ad3190000      0t0 948160473 /var/run/ceph/guests/ceph-client.cinder.137430.35361600.asok\nnova-comp 137430 nova 5252r  FIFO                0,8      0t0 948160490 pipe\nnova-comp 137430 nova 5253u  unix 0xffff881ad3190380      0t0 948160476 /var/run/ceph/guests/ceph-client.cinder.137430.35260960.asok\nnova-comp 137430 nova 5254r  FIFO                0,8      0t0 948160493 pipe\nnova-comp 137430 nova 5255u  unix 0xffff881ad3195780      0t0 948160491 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5256r  FIFO                0,8      0t0 948160498 pipe\nnova-comp 137430 nova 5257u  unix 0xffff881fafe18000      0t0 948160494 /var/run/ceph/guests/ceph-client.cinder.137430.35260960.asok\nnova-comp 137430 nova 5258r  FIFO                0,8      0t0 948261835 pipe\nnova-comp 137430 nova 5259u  unix 0xffff881fafe18e00      0t0 948160499 /var/run/ceph/guests/ceph-client.cinder.137430.35666576.asok\nnova-comp 137430 nova 5260r  FIFO                0,8      0t0 948265362 pipe\nnova-comp 137430 nova 5261u  unix 0xffff881fafe19180      0t0 948261836 /var/run/ceph/guests/ceph-client.cinder.137430.35361600.asok\nnova-comp 137430 nova 5262r  FIFO                0,8      0t0 948265500 pipe\nnova-comp 137430 nova 5263u  unix 0xffff881fafe19500      0t0 948265363 /var/run/ceph/guests/ceph-client.cinder.137430.35318896.asok\n\nAnd:\nroot@qk-3:~# ls -la /var/run/ceph/guests/ceph-client.cinder.137430.33776880.asok\nls: cannot access /var/run/ceph/guests/ceph-client.cinder.137430.33776880.asok: No such file or directory\n\nAs you can realize, all of these files were already closed.\n\nIf we restart nova-compute process, the number of open file will be 140-150, but within a few days it grows up to 4000-5000-10000 files and we get the \u201dtoo many open files\" Error again.\n\nBelow is the ceph.conf from nova-compute node:\n\n[global]\nfsid = 91ef7ba7-463b-4410-8128-82217052d2dd\nmon_initial_members = ceph-1, ceph-2, ns\nmon_host = 192.168.2.4,192.168.2.5,192.168.2.6\nauth_cluster_required = cephx\nauth_service_required = cephx\nauth_client_required = cephx\nfilestore_xattr_use_omap = true\nosd_pool_default_size = 3\npublic_network = 192.168.2.0/24\ncluster_network = 192.168.1.0/24\n\n[client]\nrbd_cache = true\nrbd_cache_writethrough_until_flush = false\nrbd_cache_size = 2 GiB\nrbd_cache_max_dirty = 2 GiB\nrbd_cache_target_dirty = 256 MiB\nrbd_cache_max_dirty_age = 1.0\nadmin socket = /var/run/ceph/guests/$cluster-$type.$id.$pid.$cctid.asok\nlog file = /var/log/qemu/qemu-guest-$pid.log\nrbd concurrent management ops = 20\n\nPart of nova-compute:\ndisk_cachemodes=\"network=writeback\"\ninject_password = false\ninject_key = false\ninject_partition = -2\nhw_disk_discard = unmap\n\nroot@qk-3:~# dpkg -l | grep nova\nii  nova-common                         1:2015.1.0-0ubuntu1~cloud0            all          OpenStack Compute - common files\nii  nova-compute                        1:2015.1.0-0ubuntu1~cloud0            all          OpenStack Compute - compute node base\nii  nova-compute-kvm                    1:2015.1.0-0ubuntu1~cloud0            all          OpenStack Compute - compute node (KVM)\nii  nova-compute-libvirt                1:2015.1.0-0ubuntu1~cloud0            all          OpenStack Compute - compute node libvirt support\nii  python-nova                         1:2015.1.0-0ubuntu1~cloud0            all          OpenStack Compute Python libraries\nii  python-novaclient                   1:2.22.0-0ubuntu1~cloud0              all          client library for OpenStack Compute API", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1493783", 
    "owner": "None", 
    "id": 1493783, 
    "index": 7023, 
    "openned": "2015-09-09 10:17:57.698927+00:00", 
    "created": "2015-09-09 10:17:57.698927+00:00", 
    "title": "nova-compute ceph 'too many open files'", 
    "comments": [
        {
            "content": "We\u2019ve deployed OpenStack with Ceph as a storage (rbd). The instances are being boot using cinder volumes through Ceph too. \n\nSometimes the following ERROR appears at the nova-compute.log: [Errno 24] Too many open files\n\nIf we get the list of open files from any nova-compute process, we\u2019ll see the following:\n\nroot@qk-3:~# ps -auxwww | grep nova-compute\nnova     137430  2.4  0.0 2395468 106888 ?      Ssl  Sep07  65:54 /usr/bin/python /usr/bin/nova-compute --config-file=/etc/nova/nova.conf --config-file=/etc/nova/nova-compute.conf\n\nroot@qk-3:~# lsof -p 137430 | wc -l\n5406\n\nAlmost all open files is:\nnova-comp 137430 nova 5232r  FIFO                0,8      0t0 948057084 pipe\nnova-comp 137430 nova 5233u  unix 0xffff881ad3192300      0t0 948012913 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5234r  FIFO                0,8      0t0 948057088 pipe\nnova-comp 137430 nova 5235u  unix 0xffff881ad3192680      0t0 948057085 /var/run/ceph/guests/ceph-client.cinder.137430.35260960.asok\nnova-comp 137430 nova 5236r  FIFO                0,8      0t0 948073475 pipe\nnova-comp 137430 nova 5237u  unix 0xffff881ad3192d80      0t0 948073473 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5238r  FIFO                0,8      0t0 948073522 pipe\nnova-comp 137430 nova 5239u  unix 0xffff881ad3195080      0t0 948073476 /var/run/ceph/guests/ceph-client.cinder.137430.35361600.asok\nnova-comp 137430 nova 5240r  FIFO                0,8      0t0 948073526 pipe\nnova-comp 137430 nova 5241u  unix 0xffff881ad3197700      0t0 948073523 /var/run/ceph/guests/ceph-client.cinder.137430.35260960.asok\nnova-comp 137430 nova 5242r  FIFO                0,8      0t0 948073532 pipe\nnova-comp 137430 nova 5243u  unix 0xffff881ad3196c80      0t0 948073527 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5244r  FIFO                0,8      0t0 948073535 pipe\nnova-comp 137430 nova 5245u  unix 0xffff881ad3196580      0t0 948073533 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5246r  FIFO                0,8      0t0 948163602 pipe\nnova-comp 137430 nova 5247u  unix 0xffff881ad3195b00      0t0 948073536 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5248r  FIFO                0,8      0t0 948160472 pipe\nnova-comp 137430 nova 5249u  unix 0xffff88301f2ec600      0t0 948163603 /var/run/ceph/guests/ceph-client.cinder.137430.35260960.asok\nnova-comp 137430 nova 5250r  FIFO                0,8      0t0 948160475 pipe\nnova-comp 137430 nova 5251u  unix 0xffff881ad3190000      0t0 948160473 /var/run/ceph/guests/ceph-client.cinder.137430.35361600.asok\nnova-comp 137430 nova 5252r  FIFO                0,8      0t0 948160490 pipe\nnova-comp 137430 nova 5253u  unix 0xffff881ad3190380      0t0 948160476 /var/run/ceph/guests/ceph-client.cinder.137430.35260960.asok\nnova-comp 137430 nova 5254r  FIFO                0,8      0t0 948160493 pipe\nnova-comp 137430 nova 5255u  unix 0xffff881ad3195780      0t0 948160491 /var/run/ceph/guests/ceph-client.cinder.137430.35244752.asok\nnova-comp 137430 nova 5256r  FIFO                0,8      0t0 948160498 pipe\nnova-comp 137430 nova 5257u  unix 0xffff881fafe18000      0t0 948160494 /var/run/ceph/guests/ceph-client.cinder.137430.35260960.asok\nnova-comp 137430 nova 5258r  FIFO                0,8      0t0 948261835 pipe\nnova-comp 137430 nova 5259u  unix 0xffff881fafe18e00      0t0 948160499 /var/run/ceph/guests/ceph-client.cinder.137430.35666576.asok\nnova-comp 137430 nova 5260r  FIFO                0,8      0t0 948265362 pipe\nnova-comp 137430 nova 5261u  unix 0xffff881fafe19180      0t0 948261836 /var/run/ceph/guests/ceph-client.cinder.137430.35361600.asok\nnova-comp 137430 nova 5262r  FIFO                0,8      0t0 948265500 pipe\nnova-comp 137430 nova 5263u  unix 0xffff881fafe19500      0t0 948265363 /var/run/ceph/guests/ceph-client.cinder.137430.35318896.asok\n\nAnd:\nroot@qk-3:~# ls -la /var/run/ceph/guests/ceph-client.cinder.137430.33776880.asok\nls: cannot access /var/run/ceph/guests/ceph-client.cinder.137430.33776880.asok: No such file or directory\n\nAs you can realize, all of these files were already closed.\n\nIf we restart nova-compute process, the number of open file will be 140-150, but within a few days it grows up to 4000-500-10000 files and we get the \u201dtoo many open files\" Error again.\n\n\nBelow is the ceph.conf from nova-compute node:\n\n[global]\nfsid = 91ef7ba7-463b-4410-8128-82217052d2dd\nmon_initial_members = ceph-1, ceph-2, ns\nmon_host = 192.168.2.4,192.168.2.5,192.168.2.6\nauth_cluster_required = cephx\nauth_service_required = cephx\nauth_client_required = cephx\nfilestore_xattr_use_omap = true\nosd_pool_default_size = 3\npublic_network = 192.168.2.0/24\ncluster_network = 192.168.1.0/24\n\n[client]\nrbd_cache = true\nrbd_cache_writethrough_until_flush = false\nrbd_cache_size = 2 GiB\nrbd_cache_max_dirty = 2 GiB\nrbd_cache_target_dirty = 256 MiB\nrbd_cache_max_dirty_age = 1.0\nadmin socket = /var/run/ceph/guests/$cluster-$type.$id.$pid.$cctid.asok\nlog file = /var/log/qemu/qemu-guest-$pid.log\nrbd concurrent management ops = 20\n\nPart of nova-compute:\ndisk_cachemodes=\"network=writeback\"\ninject_password = false\ninject_key = false\ninject_partition = -2\nhw_disk_discard = unmap\n\nroot@qk-3:~# dpkg -l | grep nova\nii  nova-common                         1:2015.1.0-0ubuntu1~cloud0            all          OpenStack Compute - common files\nii  nova-compute                        1:2015.1.0-0ubuntu1~cloud0            all          OpenStack Compute - compute node base\nii  nova-compute-kvm                    1:2015.1.0-0ubuntu1~cloud0            all          OpenStack Compute - compute node (KVM)\nii  nova-compute-libvirt                1:2015.1.0-0ubuntu1~cloud0            all          OpenStack Compute - compute node libvirt support\nii  python-nova                         1:2015.1.0-0ubuntu1~cloud0            all          OpenStack Compute Python libraries\nii  python-novaclient                   1:2.22.0-0ubuntu1~cloud0              all          client library for OpenStack Compute API", 
            "date_created": "2015-09-09 10:17:57.698927+00:00", 
            "author": "https://api.launchpad.net/1.0/~vizvekov"
        }, 
        {
            "content": "Sounds like a problem on the ceph side, not nova - http://tracker.ceph.com/issues/11535", 
            "date_created": "2015-09-09 15:19:59.682174+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2015-11-09 04:17:31.989480+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ], 
    "closed": "2015-11-09 04:17:32.865923+00:00"
}