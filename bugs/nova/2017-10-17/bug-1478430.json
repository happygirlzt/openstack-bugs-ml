{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 09:04:22.872593+00:00", 
    "description": "I have a old version of nova, there is an instance running, when I upgrade to\nlastest upstream version of nova (commit 183cd88cb2f9781b53f71b6b161df401c286c9ff)\n\nafter sync db, I get 500 error when I try to list the old instance.\n\nnova-api get follow error:\n\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     sort_keys=sort_keys, sort_dirs=sort_dirs)\n2015-07-27 12:00:11.397 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 2083, in _get_instances_by_filters\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     expected_attrs=fields, sort_keys=sort_keys, sort_dirs=sort_dirs)\n2015-07-27 12:00:11.397 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/objects/base.py\", line 71, in wrapper\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     result = fn(cls, context, *args, **kwargs)\n2015-07-27 12:00:11.397 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/objects/instance.py\", line 1221, in get_by_filters\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     expected_attrs)\n2015-07-27 12:00:11.397 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/objects/instance.py\", line 1146, in _make_instance_list\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     expected_attrs=expected_attrs)\n2015-07-27 12:00:11.397 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/objects/instance.py\", line 505, in _from_db_object\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     if db_inst['info_cache'] is None:\n2015-07-27 12:00:11.397 TRACE nova.api.openstack KeyError: 'info_cache'\n2015-07-27 12:00:11.397 TRACE nova.api.openstack \n\n\nnova compute get follow error when restart:\n\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/queue.py\", line 117, in switch\n    self.greenlet.switch(value)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_service/service.py\", line 623, in run_service\n    service.start()\n  File \"/opt/stack/nova/nova/service.py\", line 158, in start\n    self.manager.init_host()\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 1261, in init_host\n    context, self.host, expected_attrs=['info_cache'])\n  File \"/opt/stack/nova/nova/objects/base.py\", line 69, in wrapper\n    args, kwargs)\n  File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 243, in object_class_action\n    objver=objver, args=args, kwargs=kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 158, in call\n    retry=self.retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n    timeout=timeout, retry=retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 431, in send\n    retry=retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 422, in _send\n    raise result\nKeyError: u'\\'info_cache\\'\\nTraceback (most recent call last):\\n\\n  File \"/opt/stack/nova/nova/conductor/manager.py\", line 440, in _object_dispatch\\n    return getattr(target, method)(*args, **kwargs)\\n\\n  File \"/opt/stack/nova/nova/objects/base.py\", line 71, in wrapper\\n    result = fn(cls, context, *args, **kwargs)\\n\\n  File \"/opt/stack/nova/nova/objects/instance.py\", line 1229, in get_by_host\\n    expected_attrs)\\n\\n  File \"/opt/stack/nova/nova/objects/instance.py\", line 1146, in _make_instance_list\\n    expected_attrs=expected_attrs)\\n\\n  File \"/opt/stack/nova/nova/objects/instance.py\", line 505, in _from_db_object\\n    if db_inst[\\'info_cache\\'] is None:\\n\\nKeyError: \\'info_cache\\'\\n'\n\n\n\nfor reference, the old db_inst is follow:\n\n{'vm_state': u'active', 'internal_id': None, 'availability_zone': None, 'terminated_at': None, 'ramdisk_id': u'd73b7b35-b89b-4e92-98fc-dc5a7929f214', 'instance_type_id': 2L, 'updated_at': datetime.datetime(2015, 7, 27, 3, 49, 29), 'cleaned': 0L, 'vm_mode': None, 'deleted_at': None, 'reservation_id': u'r-0s8p28s9', 'id': 76L, 'disable_terminate': False, 'user_id': u'bea64c5634ae4f079c1c69ed29a68242', 'uuid': u'25976bc8-cd6f-471f-a7d4-7ce7614f9b9e', 'default_swap_device': None, 'hostname': u'test2', 'launched_on': u'liyong', 'display_description': u'test2', 'key_data': None, 'deleted': 0L, 'power_state': 1L, 'default_ephemeral_device': None, 'progress': 0L, 'project_id': u'52a0ee83fb524376bd603547aea415a3', 'launched_at': datetime.datetime(2015, 7, 27, 3, 49, 29), 'scheduled_at': None, 'node': u'liyong', 'ephemeral_gb': 0L, 'access_ip_v6': None, 'access_ip_v4': None, 'kernel_id': u'712e417f-16ec-42fb-b2cb-ef8c316d9903', 'key_name': None, 'user_data': None, 'host': u'liyong', 'root_gb': 1L, 'architecture': None, 'display_name': u'test2', 'system_metadata': [<nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef724d0>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f1d0>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f310>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f3d0>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f490>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f550>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f610>], 'task_state': None, 'shutdown_terminate': False, 'cell_name': None, 'ephemeral_key_uuid': None, 'locked': False, 'name': 'instance-0000004c', 'created_at': datetime.datetime(2015, 7, 27, 3, 49, 18), 'locked_by': None, 'launch_index': 0L, 'metadata': [], 'memory_mb': 512L, 'vcpus': 1L, 'image_ref': u'93169d18-1bb2-45f7-861c-6735ef687db9', 'root_device_name': u'/dev/vda', 'auto_disk_config': False, 'os_type': None, 'config_drive': u''}", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1478430", 
    "owner": "https://api.launchpad.net/1.0/~taget-9", 
    "id": 1478430, 
    "index": 4304, 
    "openned": "2015-07-27 04:01:36.411795+00:00", 
    "created": "2015-07-27 04:01:36.411795+00:00", 
    "title": "nova failed to list old db instances", 
    "comments": [
        {
            "content": "I have a old version of nova, there is an instance running, when I upgrade to\nlastest upstream version of nova (commit 183cd88cb2f9781b53f71b6b161df401c286c9ff)\n\nafter sync db, I get 500 error when I try to list the old instance.\n\nnova-api get follow error:\n\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     sort_keys=sort_keys, sort_dirs=sort_dirs)\n2015-07-27 12:00:11.397 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/compute/api.py\", line 2083, in _get_instances_by_filters\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     expected_attrs=fields, sort_keys=sort_keys, sort_dirs=sort_dirs)\n2015-07-27 12:00:11.397 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/objects/base.py\", line 71, in wrapper\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     result = fn(cls, context, *args, **kwargs)\n2015-07-27 12:00:11.397 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/objects/instance.py\", line 1221, in get_by_filters\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     expected_attrs)\n2015-07-27 12:00:11.397 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/objects/instance.py\", line 1146, in _make_instance_list\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     expected_attrs=expected_attrs)\n2015-07-27 12:00:11.397 TRACE nova.api.openstack   File \"/opt/stack/nova/nova/objects/instance.py\", line 505, in _from_db_object\n2015-07-27 12:00:11.397 TRACE nova.api.openstack     if db_inst['info_cache'] is None:\n2015-07-27 12:00:11.397 TRACE nova.api.openstack KeyError: 'info_cache'\n2015-07-27 12:00:11.397 TRACE nova.api.openstack \n\n\nnova compute get follow error when restart:\n\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/queue.py\", line 117, in switch\n    self.greenlet.switch(value)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_service/service.py\", line 623, in run_service\n    service.start()\n  File \"/opt/stack/nova/nova/service.py\", line 158, in start\n    self.manager.init_host()\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 1261, in init_host\n    context, self.host, expected_attrs=['info_cache'])\n  File \"/opt/stack/nova/nova/objects/base.py\", line 69, in wrapper\n    args, kwargs)\n  File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 243, in object_class_action\n    objver=objver, args=args, kwargs=kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 158, in call\n    retry=self.retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n    timeout=timeout, retry=retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 431, in send\n    retry=retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 422, in _send\n    raise result\nKeyError: u'\\'info_cache\\'\\nTraceback (most recent call last):\\n\\n  File \"/opt/stack/nova/nova/conductor/manager.py\", line 440, in _object_dispatch\\n    return getattr(target, method)(*args, **kwargs)\\n\\n  File \"/opt/stack/nova/nova/objects/base.py\", line 71, in wrapper\\n    result = fn(cls, context, *args, **kwargs)\\n\\n  File \"/opt/stack/nova/nova/objects/instance.py\", line 1229, in get_by_host\\n    expected_attrs)\\n\\n  File \"/opt/stack/nova/nova/objects/instance.py\", line 1146, in _make_instance_list\\n    expected_attrs=expected_attrs)\\n\\n  File \"/opt/stack/nova/nova/objects/instance.py\", line 505, in _from_db_object\\n    if db_inst[\\'info_cache\\'] is None:\\n\\nKeyError: \\'info_cache\\'\\n'\n\n\n\nfor reference, the old db_inst is follow:\n\n{'vm_state': u'active', 'internal_id': None, 'availability_zone': None, 'terminated_at': None, 'ramdisk_id': u'd73b7b35-b89b-4e92-98fc-dc5a7929f214', 'instance_type_id': 2L, 'updated_at': datetime.datetime(2015, 7, 27, 3, 49, 29), 'cleaned': 0L, 'vm_mode': None, 'deleted_at': None, 'reservation_id': u'r-0s8p28s9', 'id': 76L, 'disable_terminate': False, 'user_id': u'bea64c5634ae4f079c1c69ed29a68242', 'uuid': u'25976bc8-cd6f-471f-a7d4-7ce7614f9b9e', 'default_swap_device': None, 'hostname': u'test2', 'launched_on': u'liyong', 'display_description': u'test2', 'key_data': None, 'deleted': 0L, 'power_state': 1L, 'default_ephemeral_device': None, 'progress': 0L, 'project_id': u'52a0ee83fb524376bd603547aea415a3', 'launched_at': datetime.datetime(2015, 7, 27, 3, 49, 29), 'scheduled_at': None, 'node': u'liyong', 'ephemeral_gb': 0L, 'access_ip_v6': None, 'access_ip_v4': None, 'kernel_id': u'712e417f-16ec-42fb-b2cb-ef8c316d9903', 'key_name': None, 'user_data': None, 'host': u'liyong', 'root_gb': 1L, 'architecture': None, 'display_name': u'test2', 'system_metadata': [<nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef724d0>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f1d0>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f310>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f3d0>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f490>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f550>, <nova.db.sqlalchemy.models.InstanceSystemMetadata object at 0x7ff3aef7f610>], 'task_state': None, 'shutdown_terminate': False, 'cell_name': None, 'ephemeral_key_uuid': None, 'locked': False, 'name': 'instance-0000004c', 'created_at': datetime.datetime(2015, 7, 27, 3, 49, 18), 'locked_by': None, 'launch_index': 0L, 'metadata': [], 'memory_mb': 512L, 'vcpus': 1L, 'image_ref': u'93169d18-1bb2-45f7-861c-6735ef687db9', 'root_device_name': u'/dev/vda', 'auto_disk_config': False, 'os_type': None, 'config_drive': u''}", 
            "date_created": "2015-07-27 04:01:36.411795+00:00", 
            "author": "https://api.launchpad.net/1.0/~taget-9"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/205917", 
            "date_created": "2015-07-27 06:50:37.175093+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "an update is:\n\nthe old version nova is a development version in Kilo, and the upgrade version target is a Liberty version.\ndo we support this kinds of upgrade?\n\ndo we need to first upgrade to Kilo release first and then upgrade from Kilo release to Liberty ??\n\nI mean the process is:\n\nKilo(development version) - > Kilo release -> Liberty (development version)?\n", 
            "date_created": "2015-08-04 01:13:24.030603+00:00", 
            "author": "https://api.launchpad.net/1.0/~taget-9"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/205917\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b111efe2f3541b8571a913d972601567901e094e\nSubmitter: Jenkins\nBranch:    master\n\ncommit b111efe2f3541b8571a913d972601567901e094e\nAuthor: Eli Qiao <email address hidden>\nDate:   Mon Jul 27 14:46:49 2015 +0800\n\n    Object: Fix KeyError when loading instance from db\n    \n    When migrate to latest version object, if there are old db instance objects,\n    nova object will be failed to load them from db and cause internal errors.\n    \n    This patch use get to avoid KeyError.\n    \n    Closes-Bug: #1478430\n    Change-Id: I30ddab33ebff14e695e7f2450eb5083544f9ba63\n", 
            "date_created": "2015-09-11 14:06:45.815898+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-09-24 07:02:29.364539+00:00"
}