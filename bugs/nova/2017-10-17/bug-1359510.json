{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:58:59.917859+00:00", 
    "description": "There is a race condition in linux_net.get_dhcp_opts when use_single_default_gateway is set. Because it makes multiple queries, if an instance is deleted while iterating through the list of fixed ips, it can cause an exception like the following:\n\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 1043, in update_dhcp\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     restart_dhcp(context, dev, network_ref)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/lockutils.py\", line 249, in inner\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     return f(*args, **kwargs)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 1096, in restart_dhcp\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     write_to_file(optsfile, get_dhcp_opts(context, network_ref))\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 1016, in get_dhcp_opts\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     context, instance_uuid)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/objects/base.py\", line 110, in wrapper\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     args, kwargs)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/conductor/rpcapi.py\", line 425, in object_class_action\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     objver=objver, args=args, kwargs=kwargs)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 150, in call\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     wait_for_reply=True, timeout=timeout)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     timeout=timeout)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 412, in send\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 405, in _send\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     raise result\n\nWhile the query could be fixed to catch the exception, this code is also horribly inefficient, so the logic needs to be fixed to only make one db query.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1359510", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 1359510, 
    "index": 3996, 
    "openned": "2014-08-21 02:52:52.447861+00:00", 
    "created": "2014-08-21 02:52:52.447861+00:00", 
    "title": "Network deallocation can fail with use_single_default_gateway", 
    "comments": [
        {
            "content": "There is a race condition in linux_net.get_dhcp_opts when use_single_default_gateway is set. Because it makes multiple queries, if an instance is deleted while iterating through the list of fixed ips, it can cause an exception like the following:\n\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 1043, in update_dhcp\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     restart_dhcp(context, dev, network_ref)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/lockutils.py\", line 249, in inner\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     return f(*args, **kwargs)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 1096, in restart_dhcp\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     write_to_file(optsfile, get_dhcp_opts(context, network_ref))\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 1016, in get_dhcp_opts\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     context, instance_uuid)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/objects/base.py\", line 110, in wrapper\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     args, kwargs)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/nova/conductor/rpcapi.py\", line 425, in object_class_action\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     objver=objver, args=args, kwargs=kwargs)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 150, in call\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     wait_for_reply=True, timeout=timeout)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     timeout=timeout)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 412, in send\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 405, in _send\n2014-08-20 19:44:31.371 10867 TRACE oslo.messaging.rpc.dispatcher     raise result\n\nWhile the query could be fixed to catch the exception, this code is also horribly inefficient, so the logic needs to be fixed to only make one db query.", 
            "date_created": "2014-08-21 02:52:52.447861+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/115859", 
            "date_created": "2014-08-21 03:48:45.737894+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/115859\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=407037418edc240cf4a3e96b88378f47a5c979be\nSubmitter: Jenkins\nBranch:    master\n\ncommit 407037418edc240cf4a3e96b88378f47a5c979be\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Wed Sep 3 10:23:24 2014 -0700\n\n    Fix race condition in update_dhcp\n    \n    This modifies linux_net to only make one query for the fixed ips.\n    Previously it was getting the list of fixed ips twice. It also\n    merges the convoluted logic around single_default_gateway into\n    the single query so that it doesn't make a db request per fixed ip.\n    This prevents a race condition that could lead to ips not allocating\n    properly if an instance is deleted while the dhcp config was being\n    updated. Also, e274c45dcd37f49d66cc3cce72c2fd97f444151c missed a\n    call to obj_make_compatible for instance version. This adds it\n    since it will be in a conflicting spot.\n    \n    Change-Id: Iffdc60063b26c9e3f6b8dbe5b67301cbc19b2564\n    Resolves-bug: #1359510\n", 
            "date_created": "2014-09-16 07:14:50.288616+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-10-01 07:44:08.066032+00:00"
}