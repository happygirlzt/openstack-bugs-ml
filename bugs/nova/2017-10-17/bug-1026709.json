{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:43:18.618776+00:00", 
    "description": "The quota reservations code acquires SQL locks inconsistently which can result in a deadlock.\n\nBecause of a bug in MySQLdb it can result in this exception:\n\n[...]\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/api/openstack/compute/servers.py\", line 707, in create\n2012-07-16 22:16:03 TRACE nova.api.openstack     scheduler_hints=scheduler_hints)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/compute/api.py\", line 780, in create\n2012-07-16 22:16:03 TRACE nova.api.openstack     scheduler_hints=scheduler_hints)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/compute/api.py\", line 372, in _create_instance\n2012-07-16 22:16:03 TRACE nova.api.openstack     context, instance_type, min_count, max_count)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/compute/api.py\", line 178, in _check_num_instances_quota\n2012-07-16 22:16:03 TRACE nova.api.openstack     cores=req_cores, ram=req_ram)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/quota.py\", line 695, in reserve\n2012-07-16 22:16:03 TRACE nova.api.openstack     expire=expire)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/quota.py\", line 338, in reserve\n2012-07-16 22:16:03 TRACE nova.api.openstack     FLAGS.until_refresh, FLAGS.max_age)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/db/api.py\", line 1050, in quota_reserve\n2012-07-16 22:16:03 TRACE nova.api.openstack     until_refresh, max_age)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/db/sqlalchemy/api.py\", line 132, in wrapper\n2012-07-16 22:16:03 TRACE nova.api.openstack     return f(*args, **kwargs)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/db/sqlalchemy/api.py\", line 2584, in quota_reserve\n2012-07-16 22:16:03 TRACE nova.api.openstack     usages = _get_quota_usages(context, session, deltas.keys())\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/db/sqlalchemy/api.py\", line 2572, in _get_quota_usages\n2012-07-16 22:16:03 TRACE nova.api.openstack     with_lockmode('update').\\\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1729, in all\n2012-07-16 22:16:03 TRACE nova.api.openstack     return list(self)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1953, in instances\n2012-07-16 22:16:03 TRACE nova.api.openstack     fetch = cursor.fetchall()\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 2979, in fetchall\n2012-07-16 22:16:03 TRACE nova.api.openstack     l = self.process_rows(self._fetchall_impl())\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 2948, in _fetchall_impl\n2012-07-16 22:16:03 TRACE nova.api.openstack     self._non_result()\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 2953, in _non_result\n2012-07-16 22:16:03 TRACE nova.api.openstack     \"This result object does not return rows. \"\n2012-07-16 22:16:03 TRACE nova.api.openstack ResourceClosedError: This result object does not return rows. It has been closed automatically.\n\nHowever, the real bug is a deadlock (hidden by the aforementioned MySQLdb bug), which should show as an OperationError similar to this:\n\n\"Deadlock found when trying to get lock; try restarting transaction\"\n\nThe problem is a result of the quota_reserve code acquiring the quota_usages lock before the reservations lock, whereas reservation_commit and reservation_rollback acquire the locks in reverse order.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1026709", 
    "owner": "https://api.launchpad.net/1.0/~johannes.erdfelt", 
    "id": 1026709, 
    "index": 4227, 
    "openned": "2012-07-19 17:11:35.160307+00:00", 
    "created": "2012-07-19 17:11:35.160307+00:00", 
    "title": "SQL deadlock in quota code", 
    "comments": [
        {
            "content": "The quota reservations code acquires SQL locks inconsistently which can result in a deadlock.\n\nBecause of a bug in SQLAlchemy (http://www.sqlalchemy.org/trac/ticket/2536) it can result in this exception:\n\n[...]\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/api/openstack/compute/servers.py\", line 707, in create\n2012-07-16 22:16:03 TRACE nova.api.openstack     scheduler_hints=scheduler_hints)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/compute/api.py\", line 780, in create\n2012-07-16 22:16:03 TRACE nova.api.openstack     scheduler_hints=scheduler_hints)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/compute/api.py\", line 372, in _create_instance\n2012-07-16 22:16:03 TRACE nova.api.openstack     context, instance_type, min_count, max_count)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/compute/api.py\", line 178, in _check_num_instances_quota\n2012-07-16 22:16:03 TRACE nova.api.openstack     cores=req_cores, ram=req_ram)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/quota.py\", line 695, in reserve\n2012-07-16 22:16:03 TRACE nova.api.openstack     expire=expire)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/quota.py\", line 338, in reserve\n2012-07-16 22:16:03 TRACE nova.api.openstack     FLAGS.until_refresh, FLAGS.max_age)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/db/api.py\", line 1050, in quota_reserve\n2012-07-16 22:16:03 TRACE nova.api.openstack     until_refresh, max_age)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/db/sqlalchemy/api.py\", line 132, in wrapper\n2012-07-16 22:16:03 TRACE nova.api.openstack     return f(*args, **kwargs)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/db/sqlalchemy/api.py\", line 2584, in quota_reserve\n2012-07-16 22:16:03 TRACE nova.api.openstack     usages = _get_quota_usages(context, session, deltas.keys())\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/nova/db/sqlalchemy/api.py\", line 2572, in _get_quota_usages\n2012-07-16 22:16:03 TRACE nova.api.openstack     with_lockmode('update').\\\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1729, in all\n2012-07-16 22:16:03 TRACE nova.api.openstack     return list(self)\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1953, in instances\n2012-07-16 22:16:03 TRACE nova.api.openstack     fetch = cursor.fetchall()\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 2979, in fetchall\n2012-07-16 22:16:03 TRACE nova.api.openstack     l = self.process_rows(self._fetchall_impl())\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 2948, in _fetchall_impl\n2012-07-16 22:16:03 TRACE nova.api.openstack     self._non_result()\n2012-07-16 22:16:03 TRACE nova.api.openstack   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 2953, in _non_result\n2012-07-16 22:16:03 TRACE nova.api.openstack     \"This result object does not return rows. \"\n2012-07-16 22:16:03 TRACE nova.api.openstack ResourceClosedError: This result object does not return rows. It has been closed automatically.\n\nHowever, the real bug is a deadlock (hidden by the aforementioned SQLAlchemy bug), which should show as an OperationError similar to this:\n\n\"Deadlock found when trying to get lock; try restarting transaction\"\n\nThe problem is a result of the quota_reserve code acquiring the quota_usages lock before the reservations lock, whereas quota_commit and quota_rollback acquire the locks in reverse order.", 
            "date_created": "2012-07-19 17:11:35.160307+00:00", 
            "author": "https://api.launchpad.net/1.0/~johannes.erdfelt"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/10026", 
            "date_created": "2012-07-19 17:21:45.003152+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/10026\nCommitted: http://github.com/openstack/nova/commit/b244f6fde2e4b85a01a8e0a340d12a1fa9073236\nSubmitter: Jenkins\nBranch:    master\n\ncommit b244f6fde2e4b85a01a8e0a340d12a1fa9073236\nAuthor: Johannes Erdfelt <email address hidden>\nDate:   Thu Jul 19 17:11:24 2012 +0000\n\n    Fix SQL deadlock in quota reservations\n    \n    Fixes bug 1026709\n    \n    The code in quota_reserve acquires SQL locks in a different order than\n    the code in reservation_commit/reservation_rollback. This can result in\n    an SQL deadlock under heavy load. Due to an (unrelated) bug in\n    SQLAlchemy, this can result in this exception:\n    \n    ResourceClosedError: This result object does not return rows. It has\n    been closed automatically.\n    \n    This patch reorganizes the code to always fetch (and thusly lock) the\n    quota_usages table before the reservations table.\n    \n    Change-Id: Ia364496a996870d754094915ea0501ff19052037\n", 
            "date_created": "2012-07-19 22:47:09.824525+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-08-16 07:44:10.527912+00:00"
}