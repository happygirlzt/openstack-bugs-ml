{
    "status": "Invalid", 
    "last_updated": "2015-08-02 23:28:01.123103+00:00", 
    "description": "Hi list,\n\nI'm trying to upgrade my set-up from Grizzly to Havana, I get an error when I upgrade my nova data base:\n\nnova-manage db sync\n\n    2013-11-01 14:50:44.197 36655 INFO migrate.versioning.api [-] 208 -> 209...\n    Command failed, please check log for more info\n    2013-11-01 14:50:44.583 36655 CRITICAL nova [-] (OperationalError) (1005, \"Can't create table 'nova.#sql-8a7f_5362' (errno: 121)\") 'ALTER TABLE compute_nodes ADD CONSTRAINT fk_compute_nodes_service_id FOREIGN KEY(service_id) REFERENCES services (id)' ()\n    2013-11-01 14:50:44.583 36655 TRACE nova Traceback (most recent call last):\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n    2013-11-01 14:50:44.583 36655 TRACE nova     sys.exit(main())\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/cmd/manage.py\", line 1377, in main\n    2013-11-01 14:50:44.583 36655 TRACE nova     ret = fn(*fn_args, **fn_kwargs)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/cmd/manage.py\", line 885, in sync\n    2013-11-01 14:50:44.583 36655 TRACE nova     return migration.db_sync(version)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/migration.py\", line 33, in db_sync\n    2013-11-01 14:50:44.583 36655 TRACE nova     return IMPL.db_sync(version=version)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/migration.py\", line 81, in db_sync\n    2013-11-01 14:50:44.583 36655 TRACE nova     return versioning_api.upgrade(get_engine(), repository, version)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/api.py\", line 186, in upgrade\n    2013-11-01 14:50:44.583 36655 TRACE nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"<string>\", line 2, in _migrate\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/migration.py\", line 40, in patched_with_engine\n    2013-11-01 14:50:44.583 36655 TRACE nova     return f(*a, **kw)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/api.py\", line 366, in _migrate\n    2013-11-01 14:50:44.583 36655 TRACE nova     schema.runchange(ver, change, changeset.step)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/schema.py\", line 91, in runchange\n    2013-11-01 14:50:44.583 36655 TRACE nova     change.run(self.engine, step)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/script/py.py\", line 145, in run\n    2013-11-01 14:50:44.583 36655 TRACE nova     script_func(engine)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/migrate_repo/versions/209_add_missing_foreign_keys.py\", line 63, in upgrade\n    2013-11-01 14:50:44.583 36655 TRACE nova     fkey.create()\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/constraint.py\", line 44, in create\n    2013-11-01 14:50:44.583 36655 TRACE nova     self.__do_imports('constraintgenerator', *a, **kw)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/constraint.py\", line 32, in __do_imports\n    2013-11-01 14:50:44.583 36655 TRACE nova     run_single_visitor(engine, visitorcallable, self, *a, **kw)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/databases/visitor.py\", line 75, in run_single_visitor\n    2013-11-01 14:50:44.583 36655 TRACE nova     fn(element, **kwargs)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/ansisql.py\", line 266, in visit_migrate_foreign_key_constraint\n    2013-11-01 14:50:44.583 36655 TRACE nova     self._visit_constraint(*p, **k)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/ansisql.py\", line 278, in _visit_constraint\n    2013-11-01 14:50:44.583 36655 TRACE nova     self.execute()\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/ansisql.py\", line 42, in execute\n    2013-11-01 14:50:44.583 36655 TRACE nova     return self.connection.execute(self.buffer.getvalue())\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/base.py\", line 662, in execute\n    2013-11-01 14:50:44.583 36655 TRACE nova     params)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/base.py\", line 805, in _execute_text\n    2013-11-01 14:50:44.583 36655 TRACE nova     statement, parameters\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/base.py\", line 874, in _execute_context\n    2013-11-01 14:50:44.583 36655 TRACE nova     context)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/base.py\", line 1024, in _handle_dbapi_exception\n    2013-11-01 14:50:44.583 36655 TRACE nova     exc_info\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/util/compat.py\", line 195, in raise_from_cause\n    2013-11-01 14:50:44.583 36655 TRACE nova     reraise(type(exception), exception, tb=exc_tb)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/base.py\", line 867, in _execute_context\n    2013-11-01 14:50:44.583 36655 TRACE nova     context)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/default.py\", line 324, in do_execute\n    2013-11-01 14:50:44.583 36655 TRACE nova     cursor.execute(statement, parameters)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/MySQLdb/cursors.py\", line 173, in execute\n    2013-11-01 14:50:44.583 36655 TRACE nova     self.errorhandler(self, exc, value)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n    2013-11-01 14:50:44.583 36655 TRACE nova     raise errorclass, errorvalue\n    2013-11-01 14:50:44.583 36655 TRACE nova OperationalError: (OperationalError) (1005, \"Can't create table 'nova.#sql-8a7f_5362' (errno: 121)\") 'ALTER TABLE compute_nodes ADD CONSTRAINT fk_compute_nodes_service_id FOREIGN KEY(service_id) REFERENCES services (id)' ()\n    2013-11-01 14:50:44.583 36655 TRACE nova\n\n\n\nAnyone can help me ??\n\nThanks. \n-chen", 
    "tags": [
        "db"
    ], 
    "importance": "Undecided", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1247727", 
    "owner": "None", 
    "id": 1247727, 
    "index": 5525, 
    "openned": "2013-11-04 05:32:35.835621+00:00", 
    "created": "2013-11-04 05:32:35.835621+00:00", 
    "title": "Can't create table error when upgrade nova database from Grizzly to Havana", 
    "comments": [
        {
            "content": "Hi list,\n\nI'm trying to upgrade my set-up from Grizzly to Havana, I get an error when I upgrade my nova data base:\n\nnova-manage db sync\n\n    2013-11-01 14:50:44.197 36655 INFO migrate.versioning.api [-] 208 -> 209...\n    Command failed, please check log for more info\n    2013-11-01 14:50:44.583 36655 CRITICAL nova [-] (OperationalError) (1005, \"Can't create table 'nova.#sql-8a7f_5362' (errno: 121)\") 'ALTER TABLE compute_nodes ADD CONSTRAINT fk_compute_nodes_service_id FOREIGN KEY(service_id) REFERENCES services (id)' ()\n    2013-11-01 14:50:44.583 36655 TRACE nova Traceback (most recent call last):\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n    2013-11-01 14:50:44.583 36655 TRACE nova     sys.exit(main())\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/cmd/manage.py\", line 1377, in main\n    2013-11-01 14:50:44.583 36655 TRACE nova     ret = fn(*fn_args, **fn_kwargs)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/cmd/manage.py\", line 885, in sync\n    2013-11-01 14:50:44.583 36655 TRACE nova     return migration.db_sync(version)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/migration.py\", line 33, in db_sync\n    2013-11-01 14:50:44.583 36655 TRACE nova     return IMPL.db_sync(version=version)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/migration.py\", line 81, in db_sync\n    2013-11-01 14:50:44.583 36655 TRACE nova     return versioning_api.upgrade(get_engine(), repository, version)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/api.py\", line 186, in upgrade\n    2013-11-01 14:50:44.583 36655 TRACE nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"<string>\", line 2, in _migrate\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/migration.py\", line 40, in patched_with_engine\n    2013-11-01 14:50:44.583 36655 TRACE nova     return f(*a, **kw)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/api.py\", line 366, in _migrate\n    2013-11-01 14:50:44.583 36655 TRACE nova     schema.runchange(ver, change, changeset.step)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/schema.py\", line 91, in runchange\n    2013-11-01 14:50:44.583 36655 TRACE nova     change.run(self.engine, step)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/versioning/script/py.py\", line 145, in run\n    2013-11-01 14:50:44.583 36655 TRACE nova     script_func(engine)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/migrate_repo/versions/209_add_missing_foreign_keys.py\", line 63, in upgrade\n    2013-11-01 14:50:44.583 36655 TRACE nova     fkey.create()\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/constraint.py\", line 44, in create\n    2013-11-01 14:50:44.583 36655 TRACE nova     self.__do_imports('constraintgenerator', *a, **kw)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/constraint.py\", line 32, in __do_imports\n    2013-11-01 14:50:44.583 36655 TRACE nova     run_single_visitor(engine, visitorcallable, self, *a, **kw)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/databases/visitor.py\", line 75, in run_single_visitor\n    2013-11-01 14:50:44.583 36655 TRACE nova     fn(element, **kwargs)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/ansisql.py\", line 266, in visit_migrate_foreign_key_constraint\n    2013-11-01 14:50:44.583 36655 TRACE nova     self._visit_constraint(*p, **k)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/ansisql.py\", line 278, in _visit_constraint\n    2013-11-01 14:50:44.583 36655 TRACE nova     self.execute()\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib/python2.6/site-packages/migrate/changeset/ansisql.py\", line 42, in execute\n    2013-11-01 14:50:44.583 36655 TRACE nova     return self.connection.execute(self.buffer.getvalue())\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/base.py\", line 662, in execute\n    2013-11-01 14:50:44.583 36655 TRACE nova     params)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/base.py\", line 805, in _execute_text\n    2013-11-01 14:50:44.583 36655 TRACE nova     statement, parameters\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/base.py\", line 874, in _execute_context\n    2013-11-01 14:50:44.583 36655 TRACE nova     context)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/base.py\", line 1024, in _handle_dbapi_exception\n    2013-11-01 14:50:44.583 36655 TRACE nova     exc_info\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/util/compat.py\", line 195, in raise_from_cause\n    2013-11-01 14:50:44.583 36655 TRACE nova     reraise(type(exception), exception, tb=exc_tb)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/base.py\", line 867, in _execute_context\n    2013-11-01 14:50:44.583 36655 TRACE nova     context)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/SQLAlchemy-0.8.2-py2.6-linux-x86_64.egg/sqlalchemy/engine/default.py\", line 324, in do_execute\n    2013-11-01 14:50:44.583 36655 TRACE nova     cursor.execute(statement, parameters)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/MySQLdb/cursors.py\", line 173, in execute\n    2013-11-01 14:50:44.583 36655 TRACE nova     self.errorhandler(self, exc, value)\n    2013-11-01 14:50:44.583 36655 TRACE nova   File \"/usr/lib64/python2.6/site-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n    2013-11-01 14:50:44.583 36655 TRACE nova     raise errorclass, errorvalue\n    2013-11-01 14:50:44.583 36655 TRACE nova OperationalError: (OperationalError) (1005, \"Can't create table 'nova.#sql-8a7f_5362' (errno: 121)\") 'ALTER TABLE compute_nodes ADD CONSTRAINT fk_compute_nodes_service_id FOREIGN KEY(service_id) REFERENCES services (id)' ()\n    2013-11-01 14:50:44.583 36655 TRACE nova\n\n\n\nAnyone can help me ??\n\nThanks. \n-chen", 
            "date_created": "2013-11-04 05:32:35.835621+00:00", 
            "author": "https://api.launchpad.net/1.0/~chen-li"
        }, 
        {
            "content": "This is no longer relevant for master, but I'll leave it targeted to havana in case someone can take a closer look.", 
            "date_created": "2014-02-08 17:24:42.634031+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "i stumbled on the same error any idea what i can do?", 
            "date_created": "2014-10-07 21:20:59.349379+00:00", 
            "author": "https://api.launchpad.net/1.0/~ramonskie"
        }, 
        {
            "content": "fixed my problem by doing the following\n\nlogin to your nova database\n\nuse nova\n\ndrop table dump_instance_actions;\ndrop table dump_compute_node_stats;\ndrop table dump_compute_nodes;\ndrop table dump_instance_actions_events;\ndrop table dump_instance_faults;\ndrop table dump_migrations;\n\nALTER TABLE compute_node_stats DROP FOREIGN KEY fk_compute_node_stats_compute_node_id;\nALTER TABLE compute_nodes DROP FOREIGN KEY fk_compute_nodes_service_id;\nALTER TABLE instance_actions DROP FOREIGN KEY fk_instance_actions_instance_uuid;\nALTER TABLE instance_faults DROP FOREIGN KEY fk_instance_faults_instance_uuid;\nALTER TABLE migrations DROP FOREIGN KEY fk_migrations_instance_uuid;\n\nrun \"nova-manage db sync\" again", 
            "date_created": "2014-10-07 22:34:07.173103+00:00", 
            "author": "https://api.launchpad.net/1.0/~ramonskie"
        }
    ], 
    "closed": "2014-02-08 17:24:49.285064+00:00"
}