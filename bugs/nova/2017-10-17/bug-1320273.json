{
    "status": "Invalid", 
    "last_updated": "2014-09-17 14:44:32.542773+00:00", 
    "description": "I configured my setup to work with preallocation. \nI resized instances and they fail to resize on disk space. \nwhen you destroy the instances the _resize file is not removed from the /var/lib/nova/instances dir:\n\n[root@orange-vdsf instances(keystone_admin)]# ls -l /var/lib/nova/instances/\ntotal 52\ndrwxr-xr-x 2 nova nova 4096 May 16 17:34 1a98eefe-ba41-49b7-931a-ebe54796e343\ndrwxr-xr-x 2 nova nova 4096 May 16 17:33 1a98eefe-ba41-49b7-931a-ebe54796e343_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:32 5f87fd7e-4f85-4c41-ab12-3bf680160281\ndrwxr-xr-x 2 nova nova 4096 May 16 17:29 5f87fd7e-4f85-4c41-ab12-3bf680160281_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:39 7610109e-b631-40a5-9fa0-1bf150560503\ndrwxr-xr-x 2 nova nova 4096 May 16 17:38 7610109e-b631-40a5-9fa0-1bf150560503_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:31 a4aefac9-feb8-40d7-9228-1df6a02d9e13\ndrwxr-xr-x 2 nova nova 4096 May 16 17:29 a4aefac9-feb8-40d7-9228-1df6a02d9e13_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 13:20 _base\n-rw-r--r-- 1 nova nova    0 May 16 17:48 compute_nodes\ndrwxr-xr-x 2 nova nova 4096 May 16 17:40 d1e28a92-3ba2-402e-a798-ff8ff9a6bd98\ndrwxr-xr-x 2 nova nova 4096 May 16 17:38 d1e28a92-3ba2-402e-a798-ff8ff9a6bd98_resize\ndrwxr-xr-x 2 nova nova 4096 May 15 11:09 locks\ndrwxr-xr-x 2 nova nova 4096 May 15 18:34 snapshots\n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# ls -l /var/lib/nova/instances/\ntotal 32\ndrwxr-xr-x 2 nova nova 4096 May 16 17:33 1a98eefe-ba41-49b7-931a-ebe54796e343_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:29 5f87fd7e-4f85-4c41-ab12-3bf680160281_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:38 7610109e-b631-40a5-9fa0-1bf150560503_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:29 a4aefac9-feb8-40d7-9228-1df6a02d9e13_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 13:20 _base\n-rw-r--r-- 1 nova nova    0 May 16 17:48 compute_nodes\ndrwxr-xr-x 2 nova nova 4096 May 16 17:38 d1e28a92-3ba2-402e-a798-ff8ff9a6bd98_resize\ndrwxr-xr-x 2 nova nova 4096 May 15 11:09 locks\ndrwxr-xr-x 2 nova nova 4096 May 15 18:34 snapshots\n[root@orange-vdsf instances(keystone_admin)]# \n\n\nrunning qemu-img info I can see that the disk is not deleted as well:\n\n[root@orange-vdsf instances(keystone_admin)]# qemu-img info /var/lib/nova/instances/1a98eefe-ba41-49b7-931a-ebe54796e343_resize/disk\nimage: /var/lib/nova/instances/1a98eefe-ba41-49b7-931a-ebe54796e343_resize/disk\nfile format: raw\nvirtual size: 1.0G (1073741824 bytes)\ndisk size: 1.0G\n[root@orange-vdsf instances(keystone_admin)]# \n\n(the instances were launched with tiny flavour which is 1GB).", 
    "tags": [
        "compute"
    ], 
    "importance": "Undecided", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1320273", 
    "owner": "None", 
    "id": 1320273, 
    "index": 6119, 
    "openned": "2014-05-16 15:01:30.109790+00:00", 
    "created": "2014-05-16 15:01:30.109790+00:00", 
    "title": "_resize files are not cleaned when we destroy instances after failed resize because of disk space", 
    "comments": [
        {
            "content": "I configured my setup to work with preallocation. \nI resized instances and they fail to resize on disk space. \nwhen you destroy the instances the _resize file is not removed from the /var/lib/nova/instances dir:\n\n[root@orange-vdsf instances(keystone_admin)]# ls -l /var/lib/nova/instances/\ntotal 52\ndrwxr-xr-x 2 nova nova 4096 May 16 17:34 1a98eefe-ba41-49b7-931a-ebe54796e343\ndrwxr-xr-x 2 nova nova 4096 May 16 17:33 1a98eefe-ba41-49b7-931a-ebe54796e343_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:32 5f87fd7e-4f85-4c41-ab12-3bf680160281\ndrwxr-xr-x 2 nova nova 4096 May 16 17:29 5f87fd7e-4f85-4c41-ab12-3bf680160281_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:39 7610109e-b631-40a5-9fa0-1bf150560503\ndrwxr-xr-x 2 nova nova 4096 May 16 17:38 7610109e-b631-40a5-9fa0-1bf150560503_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:31 a4aefac9-feb8-40d7-9228-1df6a02d9e13\ndrwxr-xr-x 2 nova nova 4096 May 16 17:29 a4aefac9-feb8-40d7-9228-1df6a02d9e13_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 13:20 _base\n-rw-r--r-- 1 nova nova    0 May 16 17:48 compute_nodes\ndrwxr-xr-x 2 nova nova 4096 May 16 17:40 d1e28a92-3ba2-402e-a798-ff8ff9a6bd98\ndrwxr-xr-x 2 nova nova 4096 May 16 17:38 d1e28a92-3ba2-402e-a798-ff8ff9a6bd98_resize\ndrwxr-xr-x 2 nova nova 4096 May 15 11:09 locks\ndrwxr-xr-x 2 nova nova 4096 May 15 18:34 snapshots\n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# \n[root@orange-vdsf instances(keystone_admin)]# ls -l /var/lib/nova/instances/\ntotal 32\ndrwxr-xr-x 2 nova nova 4096 May 16 17:33 1a98eefe-ba41-49b7-931a-ebe54796e343_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:29 5f87fd7e-4f85-4c41-ab12-3bf680160281_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:38 7610109e-b631-40a5-9fa0-1bf150560503_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 17:29 a4aefac9-feb8-40d7-9228-1df6a02d9e13_resize\ndrwxr-xr-x 2 nova nova 4096 May 16 13:20 _base\n-rw-r--r-- 1 nova nova    0 May 16 17:48 compute_nodes\ndrwxr-xr-x 2 nova nova 4096 May 16 17:38 d1e28a92-3ba2-402e-a798-ff8ff9a6bd98_resize\ndrwxr-xr-x 2 nova nova 4096 May 15 11:09 locks\ndrwxr-xr-x 2 nova nova 4096 May 15 18:34 snapshots\n[root@orange-vdsf instances(keystone_admin)]# \n\n\nrunning qemu-img info I can see that the disk is not deleted as well:\n\n[root@orange-vdsf instances(keystone_admin)]# qemu-img info /var/lib/nova/instances/1a98eefe-ba41-49b7-931a-ebe54796e343_resize/disk\nimage: /var/lib/nova/instances/1a98eefe-ba41-49b7-931a-ebe54796e343_resize/disk\nfile format: raw\nvirtual size: 1.0G (1073741824 bytes)\ndisk size: 1.0G\n[root@orange-vdsf instances(keystone_admin)]# \n\n(the instances were launched with tiny flavour which is 1GB).", 
            "date_created": "2014-05-16 15:01:30.109790+00:00", 
            "author": "https://api.launchpad.net/1.0/~dron-3"
        }, 
        {
            "content": "I resized instances and they failed to resize because of time out.\nI could reproduce this bug.\n\n1) nova resize\n2) nova delete test3\n\n\n1)\n$ nova resize --poll test3 m1.micro\nServer resizing... 0% complete\nError resizing server\nERROR (AttributeError): fault\n\n$ nova list\n+--------------------------------------+-------+--------+------------+-------------+--------------------+\n| ID                                   | Name  | Status | Task State | Power State | Networks           |\n+--------------------------------------+-------+--------+------------+-------------+--------------------+\n| f5352416-f736-46bd-8905-60ab0fcb0a07 | test3 | ERROR  | -          | Running     | public=172.24.4.14 |\n+--------------------------------------+-------+--------+------------+-------------+--------------------+\n\n$ ls -la /opt/stack/data/nova/instances/\ntotal 44\ndrwxr-xr-x 10 saki root     4096  6\u6708  5 22:13 .\ndrwxr-xr-x  7 saki root     4096  6\u6708  5 09:32 ..\ndrwxr-xr-x  2 saki libvirtd 4096  6\u6708  5 10:53 _base\n-rw-r--r--  1 saki libvirtd   29  6\u6708  5 22:53 compute_nodes\ndrwxr-xr-x  2 saki libvirtd 4096  6\u6708  5 22:13 f5352416-f736-46bd-8905-60ab0fcb0a07\ndrwxr-xr-x  2 saki libvirtd 4096  6\u6708  5 22:13 f5352416-f736-46bd-8905-60ab0fcb0a07_resize\ndrwxr-xr-x  2 saki libvirtd 4096  6\u6708  5 10:53 locks\n\n\n2)\n$ nova delete test3\nRequest to delete server test3 has been accepted.\n\n$ ls -la /opt/stack/data/nova/instances/\ntotal 44\ndrwxr-xr-x 10 saki root     4096  6\u6708  5 22:13 .\ndrwxr-xr-x  7 saki root     4096  6\u6708  5 09:32 ..\ndrwxr-xr-x  2 saki libvirtd 4096  6\u6708  5 10:53 _base\n-rw-r--r--  1 saki libvirtd   29  6\u6708  5 22:53 compute_nodes\ndrwxr-xr-x  2 saki libvirtd 4096  6\u6708  5 22:13 f5352416-f736-46bd-8905-60ab0fcb0a07\ndrwxr-xr-x  2 saki libvirtd 4096  6\u6708  5 22:13 f5352416-f736-46bd-8905-60ab0fcb0a07_resize\ndrwxr-xr-x  2 saki libvirtd 4096  6\u6708  5 10:53 locks", 
            "date_created": "2014-06-06 09:37:23.741025+00:00", 
            "author": "https://api.launchpad.net/1.0/~s-iwata"
        }, 
        {
            "content": "Dafna:\n\nWhich nova release are you using?  I have tried to reproduce the bug, but did not notice the _resize directory left in place after an error on resize.  This is what I did:\n1.   Create an instance\n2.   Max out my disk that is used to hold instances, e.g. /opt/stack/data/instances, using dd (e.g. dd if=/dev/zero of=/opt/stack/data/instances/junk bs=1024M count=40)\n3.  Resize the instance.\n\nI did notice the error: \ncp: writing `/opt/stack/data/nova/instances/07d1eb08-cb12-4ec6-b3e7-e355a801c264/disk': No space left on device\\n\"\n\nHowever, when I attempt to delete the instance, both the <instance_uuid>_resize and <instance_uuid> are deleted.  Looking at the code (master branch), if an Exception occurred during resize, the proper cleanup code would be run, which would remove the _resize directory.\n\n\ns-iwata:\nCould you explain how you created the timeout.  I could not force a timeout on resize.\n\n\nThank you.\nThang", 
            "date_created": "2014-06-11 02:38:38.938454+00:00", 
            "author": "https://api.launchpad.net/1.0/~thang-pham"
        }, 
        {
            "content": "I no longer have the same setup but I don't think anything changed between these packages we have on one of our servers and these ones below: \n\n[root@puma31 ~]# rpm -qa |grep nova\nopenstack-nova-cert-2014.1-3.el7ost.noarch\nopenstack-nova-novncproxy-2014.1-3.el7ost.noarch\npython-nova-2014.1-3.el7ost.noarch\nopenstack-nova-console-2014.1-3.el7ost.noarch\npython-novaclient-2.17.0-2.el7ost.noarch\nopenstack-nova-api-2014.1-3.el7ost.noarch\nopenstack-nova-compute-2014.1-3.el7ost.noarch\nopenstack-nova-conductor-2014.1-3.el7ost.noarch\nopenstack-nova-scheduler-2014.1-3.el7ost.noarch\nopenstack-nova-common-2014.1-3.el7ost.noarch\nopenstack-nova-network-2014.1-3.el7ost.noarch\n\nHowever, please note that we have differences in reproduction methods :) \nI did not max out the instance disk with an internal command such as dd (from within the instance) but rather ran an external command (resize) from nova itself so perhaps that is the problem?\n\n\n", 
            "date_created": "2014-06-11 11:10:53.916353+00:00", 
            "author": "https://api.launchpad.net/1.0/~dron-3"
        }, 
        {
            "content": "I ran dd on the nova-compute host, not inside the instance.  So when I attempt a resize, the copy should fail because there is no more storage on the host.  I wished I could reproduce your bug, but I do not know of any other way to do so.  Looking at the code, as well as attempting to reproduce the bug, I believe the _resize directory should have deleted.", 
            "date_created": "2014-06-11 13:54:29.907001+00:00", 
            "author": "https://api.launchpad.net/1.0/~thang-pham"
        }, 
        {
            "content": "well, I wrote very easy steps to reproduce :) \nchange nova to raw preallocated \nlaunch as many instances as you can\nresize the instances to a larger disk (they should fail for lack of space)\ndestroy instances. \n", 
            "date_created": "2014-06-11 17:41:15.431039+00:00", 
            "author": "https://api.launchpad.net/1.0/~dron-3"
        }, 
        {
            "content": "When you mean \"raw preallocated\", do you mean setting the following in nova.conf?\n    preallocate_images=space\n    use_cow_images = False\n", 
            "date_created": "2014-06-11 18:57:28.835262+00:00", 
            "author": "https://api.launchpad.net/1.0/~thang-pham"
        }, 
        {
            "content": "yes. \n\n\n\n\n", 
            "date_created": "2014-06-12 07:30:51.419634+00:00", 
            "author": "https://api.launchpad.net/1.0/~dron-3"
        }, 
        {
            "content": "Hi, Thang\n\nActually, i didn't do it on purpose.\nI only debugged in resize code.(perhaps, to spend too much time after migration_disk_amd_power_off)\nI retried now, but couldn't reproduce it...", 
            "date_created": "2014-06-12 09:07:58.028484+00:00", 
            "author": "https://api.launchpad.net/1.0/~s-iwata"
        }, 
        {
            "content": "I can reproduce the error.\n\n1. add a postscript to nova.conf\n preallocate_images = space\n use_cow_images = False\n2. $ nova boot --flavor m1.nano --image ae11fe32-5f3c-4360-9622-e4b69d4885f9 test\n3. dd if=/dev/zero of=junk bs=102M count=100\n4. $ nova resize test1 m1.tiny\n5. $ nova delete 96bb3d62-1983-4d60-afd7-9c0460b3562b\n\n\n$ nova boot --flavor m1.nano --image ae11fe32-5f3c-4360-9622-e4b69d4885f9 test1\n$ dd if=/dev/zero of=junk bs=102M count=100\n$ df -h\nFilesystem      Size  Used Avail Use% Mounted on\n/dev/sda1        38G   35G  558M  99% /\nudev            989M  4.0K  989M   1% /dev\ntmpfs           401M  888K  400M   1% /run\nnone            5.0M     0  5.0M   0% /run/lock\nnone           1002M  200K 1002M   1% /run/shm\ncgroup         1002M     0 1002M   0% /sys/fs/cgroup\n/dev/sr0         60M   60M     0 100% /media/VMware Tools\n\n$ nova resize test1 m1.tiny\n$ nova list\nERROR (InternalServerError): The server has either erred or is incapable of performing the requested operation. (HTTP 500) (Request-ID: req-c01ab7a3-dcf7-4971-b8eb-fc5e22476a49)\n$ df -h\nFilesystem      Size  Used Avail Use% Mounted on\n/dev/sda1        38G   36G     0 100% /\nudev            989M  4.0K  989M   1% /dev\ntmpfs           401M  872K  400M   1% /run\nnone            5.0M     0  5.0M   0% /run/lock\nnone           1002M  200K 1002M   1% /run/shm\ncgroup         1002M     0 1002M   0% /sys/fs/cgroup\n/dev/sr0         60M   60M     0 100% /media/VMware Tools\n\n$ rm junk\n$ df -h\nFilesystem      Size  Used Avail Use% Mounted on\n/dev/sda1        38G   26G   10G  72% /\nudev            989M  4.0K  989M   1% /dev\ntmpfs           401M  872K  400M   1% /run\nnone            5.0M     0  5.0M   0% /run/lock\nnone           1002M  200K 1002M   1% /run/shm\ncgroup         1002M     0 1002M   0% /sys/fs/cgroup\n/dev/sr0         60M   60M     0 100% /media/VMware Tools\n\n$ nova list\n+--------------------------------------+-------+--------+---------------+-------------+-------------------+\n| ID                                   | Name  | Status | Task State    | Power State | Networks          |\n+--------------------------------------+-------+--------+---------------+-------------+-------------------+\n| 96bb3d62-1983-4d60-afd7-9c0460b3562b | test1 | RESIZE | resize_finish | Running     | public=172.24.4.4 |\n+--------------------------------------+-------+--------+---------------+-------------+-------------------+\n\n/opt/stack/data/nova/instances$ ls -la\ntotal 28\ndrwxr-xr-x 6 saki root     4096  6\u6708 26 13:24 .\ndrwxr-xr-x 7 saki root     4096  6\u6708 26 12:03 ..\ndrwxr-xr-x 2 saki libvirtd 4096  6\u6708 26 13:24 96bb3d62-1983-4d60-afd7-9c0460b3562b\ndrwxr-xr-x 2 saki libvirtd 4096  6\u6708 26 13:19 96bb3d62-1983-4d60-afd7-9c0460b3562b_resize\ndrwxr-xr-x 2 saki libvirtd 4096  6\u6708 26 13:06 _base\n-rw-r--r-- 1 saki libvirtd   28  6\u6708 26 12:42 compute_nodes\ndrwxr-xr-x 2 saki libvirtd 4096  6\u6708 26 13:06 locks\n\n$ nova delete 96bb3d62-1983-4d60-afd7-9c0460b3562b\n/opt/stack/data/nova/instances$ ls -la\ntotal 24\ndrwxr-xr-x 5 saki root     4096  6\u6708 26 13:52 .\ndrwxr-xr-x 7 saki root     4096  6\u6708 26 12:03 ..\ndrwxr-xr-x 2 saki libvirtd 4096  6\u6708 26 13:19 96bb3d62-1983-4d60-afd7-9c0460b3562b_resize\ndrwxr-xr-x 2 saki libvirtd 4096  6\u6708 26 13:06 _base\n-rw-r--r-- 1 saki libvirtd   28  6\u6708 26 12:42 compute_nodes\ndrwxr-xr-x 2 saki libvirtd 4096  6\u6708 26 13:06 locks", 
            "date_created": "2014-06-26 05:42:22.669988+00:00", 
            "author": "https://api.launchpad.net/1.0/~s-iwata"
        }, 
        {
            "content": "@s-iwata: I attempted to reproduce this bug using similar steps to the ones you provided above.   However, I cannot reproduce the error seen in this bug.  I see the proper error message appear and the _resize directory was properly removed.  \n\nReturning exception Unexpected error while running command.\nCommand: cp /opt/stack/data/nova/instances/0ad228dd-affe-4a26-b875-73ba68bc8876_resize/disk /opt/stack/data/nova/instances/0ad228dd-affe-4a26-b875-73ba68bc8876/disk\nExit code: 1\nStdout: ''\nStderr: \"cp: writing `/opt/stack/data/nova/instances/0ad228dd-affe-4a26-b875-73ba68bc8876/disk': No space left on device\\n\ncp: failed to extend `/opt/stack/data/nova/instances/0ad228dd-affe-4a26-b875-73ba68bc8876/disk': No space left on device\\n\" to caller\n\nFeel free to assign this bug to yourself if you can confirm it.  Thanks!", 
            "date_created": "2014-07-11 02:18:38.688128+00:00", 
            "author": "https://api.launchpad.net/1.0/~thang-pham"
        }, 
        {
            "content": "no reproduce", 
            "date_created": "2014-09-17 14:44:31.961258+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ], 
    "closed": "2014-09-17 14:44:24.398023+00:00"
}