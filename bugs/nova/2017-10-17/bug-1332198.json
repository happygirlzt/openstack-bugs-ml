{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:37:40.634780+00:00", 
    "description": "When a build fails in the driver spawn method attached volumes are not detached.  If the instance goes to ERROR and is later deleted everything gets cleaned up appropriately.  If the instance is rescheduled then the next compute will fail with:\n\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad] Traceback (most recent call last):\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/compute/manager.py\", line 1786, in _prep_block_device\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     self.driver, self._await_block_device_map_created) +\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/virt/block_device.py\", line 368, in attach_block_devices\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     map(_log_and_attach, block_device_mapping)\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/virt/block_device.py\", line 366, in _log_and_attach\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     bdm.attach(*attach_args, **attach_kwargs)\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/virt/block_device.py\", line 45, in wrapped\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     ret_val = method(obj, context, *args, **kwargs)\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/virt/block_device.py\", line 218, in attach\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     volume_api.check_attach(context, volume, instance=instance)\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/volume/cinder.py\", line 249, in check_attach\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     raise exception.InvalidVolume(reason=msg)\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad] InvalidVolume: Invalid volume: status must be 'available'\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad] \n2014-06-18 20:09:02.002 11008 ERROR nova.compute.manager [req-e76e85f6-0520-4372-b47d-a80744c912a7 None] [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad] Failure prepping block device\n\nwhich stops the build and properly stops a reschedule.\n\nCinder volumes need to be detached on a build failure.", 
    "tags": [], 
    "importance": "High", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1332198", 
    "owner": "https://api.launchpad.net/1.0/~alaski", 
    "id": 1332198, 
    "index": 1518, 
    "openned": "2014-06-19 17:20:35.358992+00:00", 
    "created": "2014-06-19 17:20:35.358992+00:00", 
    "title": "Volumes are not detached when a build fails", 
    "comments": [
        {
            "content": "When a build fails in the driver spawn method attached volumes are not detached.  If the instance goes to ERROR and is later deleted everything gets cleaned up appropriately.  If the instance is rescheduled then the next compute will fail with:\n\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad] Traceback (most recent call last):\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/compute/manager.py\", line 1786, in _prep_block_device\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     self.driver, self._await_block_device_map_created) +\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/virt/block_device.py\", line 368, in attach_block_devices\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     map(_log_and_attach, block_device_mapping)\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/virt/block_device.py\", line 366, in _log_and_attach\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     bdm.attach(*attach_args, **attach_kwargs)\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/virt/block_device.py\", line 45, in wrapped\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     ret_val = method(obj, context, *args, **kwargs)\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/virt/block_device.py\", line 218, in attach\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     volume_api.check_attach(context, volume, instance=instance)\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]   File \"/opt/rackstack/806.0/nova/lib/python2.6/site-packages/nova/volume/cinder.py\", line 249, in check_attach\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad]     raise exception.InvalidVolume(reason=msg)\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad] InvalidVolume: Invalid volume: status must be 'available'\n2014-06-18 20:09:01.954 11008 TRACE nova.compute.manager [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad] \n2014-06-18 20:09:02.002 11008 ERROR nova.compute.manager [req-e76e85f6-0520-4372-b47d-a80744c912a7 None] [instance: be78cd0e-c67f-439c-bf30-885fb135d9ad] Failure prepping block device\n\nwhich stops the build and properly stops a reschedule.\n\nCinder volumes need to be detached on a build failure.", 
            "date_created": "2014-06-19 17:20:35.358992+00:00", 
            "author": "https://api.launchpad.net/1.0/~alaski"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/101335", 
            "date_created": "2014-06-19 21:38:18.443907+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/101335\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=5120c4f7c2670eaa71898fe6941029bbb0081949\nSubmitter: Jenkins\nBranch:    master\n\ncommit 5120c4f7c2670eaa71898fe6941029bbb0081949\nAuthor: Andrew Laski <email address hidden>\nDate:   Thu Jun 19 17:15:18 2014 -0400\n\n    Instance and volume cleanup when a build fails\n    \n    On failed builds the _shutdown_instance method used to get called which\n    would clean up leftover instance artifacts, volume attachments, and\n    networking.  This no longer happens which is causing volumes to be left\n    in an attached state when they're not attached to anything.\n    \n    Network deallocation is already handled in this code path so it should\n    not happen in _shutdown_instance.\n    \n    Change-Id: I899b64ac5941acc282ccae7e1963d6f714c01e8b\n    Closes-bug: #1332198\n", 
            "date_created": "2014-06-25 00:20:16.235454+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-07-23 14:54:10.742427+00:00"
}