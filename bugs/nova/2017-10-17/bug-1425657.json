{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:24:59.516379+00:00", 
    "description": "Creating a sever using a Glance image which has a long (~256 char) unicode property value fails with database truncation.\n\nThe root cause is the same as bug:\nhttps://bugs.launchpad.net/nova/+bug/1389102\nand fix:\nhttps://review.openstack.org/#/c/134597/\n\nWhat's happening is the nova.utils.get_system_metadata_from_image method is truncating the Glance property value to 255 characters and this is then later used downstream in the create to be written to system metadata.  Databases like PostgreSQL will throw an error because when the non-English locale string is encoded to be written to the DB it is greater than the 256 limit of the system metadata database table.\n\nA partial stack is:\n...\nFile \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/servers.py\", line 610, in create\n  check_server_group_quota=check_server_group_quota)\nFile \"/usr/lib/python2.7/site-packages/nova/hooks.py\", line 149, in inner\n  rv = f(*args, **kwargs)\nFile \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 1485, in create\n  check_server_group_quota=check_server_group_quota)\nFile \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 1127, in _create_instance\n  instance_group, check_server_group_quota)\nFile \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 965, in _provision_instances\n  quotas.rollback()\nFile \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 82, in __exit__\n  six.reraise(self.type_, self.value, self.tb)\nFile \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 928, in _provision_instances\n  num_instances, i, shutdown_terminate)\nFile \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 1385, in create_db_entry_for_new_instance\n  instance.create()\nFile \"/usr/lib/python2.7/site-packages/nova/objects/base.py\", line 206, in wrapper\n  return fn(self, ctxt, *args, **kwargs)\nFile \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 613, in create\n  db_inst = db.instance_create(context, updates)\nFile \"/usr/lib/python2.7/site-packages/nova/db/api.py\", line 636, in instance_create\n  return IMPL.instance_create(context, values)\nFile \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 145, in wrapper\n  return f(*args, **kwargs)\nFile \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 1595, in instance_create\n....\n\n\nThe fix for this defect will likely be taking the fix from https://review.openstack.org/#/c/134597/ and making a utility method in nova.utils to do safe truncation.  This utility method could then be called from  nova.utils.get_system_metadata_from_image method and its existing location in nova/compute/utils.py\n\nFound in Nova Kilo.", 
    "tags": [
        "quotas"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1425657", 
    "owner": "https://api.launchpad.net/1.0/~smatzek", 
    "id": 1425657, 
    "index": 1559, 
    "openned": "2015-02-25 19:33:03.616400+00:00", 
    "created": "2015-02-25 19:33:03.616400+00:00", 
    "title": "Create server with an image containing a long unicode property value fails", 
    "comments": [
        {
            "content": "Creating a sever using a Glance image which has a long (~256 char) unicode property value fails with database truncation.\n\nThe root cause is the same as bug:\nhttps://bugs.launchpad.net/nova/+bug/1389102\nand fix:\nhttps://review.openstack.org/#/c/134597/\n\nWhat's happening is the nova.utils.get_system_metadata_from_image method is truncating the Glance property value to 255 characters and this is then later used downstream in the create to be written to system metadata.  Databases like PostgreSQL will throw an error because when the non-English locale string is encoded to be written to the DB it is greater than the 256 limit of the system metadata database table.\n\nA partial stack is:\n...\nFile \"/usr/lib/python2.7/site-packages/nova/api/openstack/compute/servers.py\", line 610, in create\n  check_server_group_quota=check_server_group_quota)\nFile \"/usr/lib/python2.7/site-packages/nova/hooks.py\", line 149, in inner\n  rv = f(*args, **kwargs)\nFile \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 1485, in create\n  check_server_group_quota=check_server_group_quota)\nFile \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 1127, in _create_instance\n  instance_group, check_server_group_quota)\nFile \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 965, in _provision_instances\n  quotas.rollback()\nFile \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 82, in __exit__\n  six.reraise(self.type_, self.value, self.tb)\nFile \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 928, in _provision_instances\n  num_instances, i, shutdown_terminate)\nFile \"/usr/lib/python2.7/site-packages/nova/compute/api.py\", line 1385, in create_db_entry_for_new_instance\n  instance.create()\nFile \"/usr/lib/python2.7/site-packages/nova/objects/base.py\", line 206, in wrapper\n  return fn(self, ctxt, *args, **kwargs)\nFile \"/usr/lib/python2.7/site-packages/nova/objects/instance.py\", line 613, in create\n  db_inst = db.instance_create(context, updates)\nFile \"/usr/lib/python2.7/site-packages/nova/db/api.py\", line 636, in instance_create\n  return IMPL.instance_create(context, values)\nFile \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 145, in wrapper\n  return f(*args, **kwargs)\nFile \"/usr/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 1595, in instance_create\n....\n\n\nThe fix for this defect will likely be taking the fix from https://review.openstack.org/#/c/134597/ and making a utility method in nova.utils to do safe truncation.  This utility method could then be called from  nova.utils.get_system_metadata_from_image method and its existing location in nova/compute/utils.py\n\nFound in Nova Kilo.", 
            "date_created": "2015-02-25 19:33:03.616400+00:00", 
            "author": "https://api.launchpad.net/1.0/~smatzek"
        }, 
        {
            "content": "Samuel, will you be filing a review?", 
            "date_created": "2015-02-26 22:00:46.897701+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "I plan to file a bug fix / code review for this along the lines of what I describe in the bug description.  I will probably get to this next week.", 
            "date_created": "2015-02-27 17:04:54.749325+00:00", 
            "author": "https://api.launchpad.net/1.0/~smatzek"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/161549", 
            "date_created": "2015-03-05 02:36:46.985550+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/161549\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8ec6a73fef7d26301481935dcd5999c7cd419cba\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8ec6a73fef7d26301481935dcd5999c7cd419cba\nAuthor: Samuel Matzek <email address hidden>\nDate:   Wed Mar 4 20:17:08 2015 -0600\n\n    Truncate encoded instance sys meta to 255 or less\n    \n    In nova/utils.py function get_system_metadata_from_image converts\n    image metadata into instance system metadata.  Since Nova's DB\n    column is limited to 255 characters for system metadata, the image\n    properties are truncated to 255 characters.  However, the Glance\n    image may have non-English unicode property values that are longer\n    than 255 after being encoded to bytes.  We need to truncate the\n    encoded byte property value to 255 or fewer bytes in order to ensure\n    the DB insert operation succeeds.  The same encoding and truncation\n    issue was fixed for the instance fault table under change id\n    I62fa2830b22e367eb9486d09d3c8818a18ebd20d.  This fix refactors\n    that code fix into a utility method and uses it to fix both problems.\n    \n    Change-Id: Ie1051777dd09a2fb91afbadad3728956f83452cf\n    Closes-Bug: #1425657\n    Related-Bug: #1389102\n", 
            "date_created": "2015-03-12 02:15:13.546363+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-03-20 07:42:16.630176+00:00"
}