{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:51:17.797765+00:00", 
    "description": "If a delete request gets past some checks to perform a local delete, but then has a host set on it before the local delete finishes it will fail a db constraint check and spew this to the logs:\n\n2015-05-13 11:14:58.666 ERROR nova.api.openstack [req-cb52db9a-d313-49c4-acce-b627b778ccd1 ListServersNegativeTestJSON-1942377486 ListServersNegativeTestJSON-625281866] Caught error: Object action destroy failed because: host changed\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack Traceback (most recent call last):\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/__init__.py\", line 125, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return req.get_response(self.application)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1317, in send\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     application, catch_exc_info=False)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1281, in call_application\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return resp(environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/keystonemiddleware/auth_token/__init__.py\", line 639, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return self._call_app(env, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/keystonemiddleware/auth_token/__init__.py\", line 559, in _call_app\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return self._app(env, _fake_start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return resp(environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return resp(environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/routes/middleware.py\", line 136, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return resp(environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 756, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     content_type, body, accept)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 821, in _process_stack\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 911, in dispatch\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return method(req=request, **action_args)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/compute/servers.py\", line 833, in delete\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     self._delete(req.environ['nova.context'], req, id)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/compute/servers.py\", line 668, in _delete\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     self.compute_api.delete(context, instance)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/compute/cells_api.py\", line 212, in delete\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     self._handle_cell_delete(context, instance, 'delete')\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/compute/cells_api.py\", line 226, in _handle_cell_delete\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     self._do_delete)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1766, in _local_delete\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     instance.destroy()\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/objects/base.py\", line 205, in wrapper\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return fn(self, *args, **kwargs)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 648, in destroy\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     reason='host changed')\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack ObjectActionError: Object action destroy failed because: host changed\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack \n\n\nThis should be fixed.", 
    "tags": [
        "cells"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1454839", 
    "owner": "https://api.launchpad.net/1.0/~alaski", 
    "id": 1454839, 
    "index": 4254, 
    "openned": "2015-05-13 20:45:28.713097+00:00", 
    "created": "2015-05-13 20:45:28.713097+00:00", 
    "title": "cells: error if deleting an instance while host is being set", 
    "comments": [
        {
            "content": "If a delete request gets past some checks to perform a local delete, but then has a host set on it before the local delete finishes it will fail a db constraint check and spew this to the logs:\n\n2015-05-13 11:14:58.666 ERROR nova.api.openstack [req-cb52db9a-d313-49c4-acce-b627b778ccd1 ListServersNegativeTestJSON-1942377486 ListServersNegativeTestJSON-625281866] Caught error: Object action destroy failed because: host changed\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack Traceback (most recent call last):\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/__init__.py\", line 125, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return req.get_response(self.application)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1317, in send\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     application, catch_exc_info=False)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1281, in call_application\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return resp(environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/keystonemiddleware/auth_token/__init__.py\", line 639, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return self._call_app(env, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/keystonemiddleware/auth_token/__init__.py\", line 559, in _call_app\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return self._app(env, _fake_start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return resp(environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return resp(environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/routes/middleware.py\", line 136, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return resp(environ, start_response)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 756, in __call__\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     content_type, body, accept)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 821, in _process_stack\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/wsgi.py\", line 911, in dispatch\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return method(req=request, **action_args)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/compute/servers.py\", line 833, in delete\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     self._delete(req.environ['nova.context'], req, id)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/api/openstack/compute/servers.py\", line 668, in _delete\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     self.compute_api.delete(context, instance)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/compute/cells_api.py\", line 212, in delete\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     self._handle_cell_delete(context, instance, 'delete')\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/compute/cells_api.py\", line 226, in _handle_cell_delete\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     self._do_delete)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/compute/api.py\", line 1766, in _local_delete\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     instance.destroy()\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/objects/base.py\", line 205, in wrapper\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     return fn(self, *args, **kwargs)\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 648, in destroy\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack     reason='host changed')\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack ObjectActionError: Object action destroy failed because: host changed\n2015-05-13 11:14:58.666 15399 TRACE nova.api.openstack \n\n\nThis should be fixed.", 
            "date_created": "2015-05-13 20:45:28.713097+00:00", 
            "author": "https://api.launchpad.net/1.0/~alaski"
        }, 
        {
            "content": "This is one of the remaining cells job failures.", 
            "date_created": "2015-05-14 14:45:15.528900+00:00", 
            "author": "https://api.launchpad.net/1.0/~alaski"
        }, 
        {
            "content": "Patch is here: https://review.openstack.org/#/c/182772/\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJtZXNzYWdlOlwiT2JqZWN0QWN0aW9uRXJyb3I6IE9iamVjdCBhY3Rpb24gZGVzdHJveSBmYWlsZWQgYmVjYXVzZTogaG9zdCBjaGFuZ2VkXCIgQU5EIHRhZ3M6XCJzY3JlZW4tbi1hcGkudHh0XCIiLCJmaWVsZHMiOltdLCJvZmZzZXQiOjAsInRpbWVmcmFtZSI6IjYwNDgwMCIsImdyYXBobW9kZSI6ImNvdW50IiwidGltZSI6eyJ1c2VyX2ludGVydmFsIjowfSwic3RhbXAiOjE0MzE2Mjk4MzI0NTUsIm1vZGUiOiIiLCJhbmFseXplX2ZpZWxkIjoiIn0=", 
            "date_created": "2015-05-14 18:57:53.832304+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/182772\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d34e0ce254e25d864fec4b19e618660972da6846\nSubmitter: Jenkins\nBranch:    master\n\ncommit d34e0ce254e25d864fec4b19e618660972da6846\nAuthor: Andrew Laski <email address hidden>\nDate:   Wed May 13 13:53:34 2015 -0400\n\n    Retry a cell delete if host constraint fails\n    \n    The instance.destroy method has a constraint that fails during a local\n    delete if the host is not None, because it should be in that case.\n    Cells calls local_delete when there's no cell_name on the instance, but\n    when this fails it's likely that we have a host and cell_name now so the\n    delete method should be attempted again.\n    \n    Closes-Bug: 1454839\n    Change-Id: I412fab6f43cf2c64239a0292946c6c3bb9837110\n", 
            "date_created": "2015-05-14 22:35:36.150344+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-06-24 12:18:15.428182+00:00"
}