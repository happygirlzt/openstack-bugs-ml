{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:09:08.266562+00:00", 
    "description": "I try to live block migrate on nova trunk with xenapi as virt driver and I see this stacktrace in the scheduler log:\n\n2013-02-07 05:18:02.768 ERROR nova.openstack.common.rpc.amqp [req-33d5b197-0db2-48f3-b1f6-c2ddd60b0855 YWg4YWB8q9aDwKbdC4lR4DAY YWg4YWB8q9aDwKbdC4lR4DAY] Exception during message handling\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/scheduler/manager.py\", line 99, in live_migration\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     context, ex, {})\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/scheduler/manager.py\", line 94, in live_migration\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     block_migration, disk_over_commit)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/scheduler/driver.py\", line 170, in schedule_live_migration\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     context, instance, dest, block_migration, disk_over_commit)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/rpcapi.py\", line 225, in check_can_live_migrate_destination\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     ctxt, destination, None))\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/proxy.py\", line 80, in call\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     return rpc.call(context, self._get_topic(topic), msg, timeout)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/__init__.py\", line 109, in call\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     return _get_impl().call(cfg.CONF, context, topic, msg, timeout)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/impl_kombu.py\", line 765, in call\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     rpc_amqp.get_connection_pool(conf, Connection))\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 379, in call\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     rv = list(rv)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 347, in __iter__\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     raise result\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp AttributeError: 'NoneType' object has no attribute 'update'\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 109, in wrapped\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 88, in wrapped\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2657, in check_can_live_migrate_destination\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     migrate_data.update(dest_check_data['migrate_data'])\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp AttributeError: 'NoneType' object has no attribute 'update'\n\nI narrowed it down to the fact that \n\nhttps://github.com/openstack/nova/blob/master/nova/virt/xenapi/driver.py#L443\n\ndoes not return dest_check_data.", 
    "tags": [
        "xenserver"
    ], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1118491", 
    "owner": "https://api.launchpad.net/1.0/~armando-migliaccio", 
    "id": 1118491, 
    "index": 956, 
    "openned": "2013-02-07 16:08:12.650658+00:00", 
    "created": "2013-02-07 16:08:12.650658+00:00", 
    "title": "check_can_live_migrate_source does not return data (xenapi)", 
    "comments": [
        {
            "content": "I try to live block migrate on nova trunk with xenapi as virt driver and I see this stacktrace in the scheduler log:\n\n2013-02-07 05:18:02.768 ERROR nova.openstack.common.rpc.amqp [req-33d5b197-0db2-48f3-b1f6-c2ddd60b0855 YWg4YWB8q9aDwKbdC4lR4DAY YWg4YWB8q9aDwKbdC4lR4DAY] Exception during message handling\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/scheduler/manager.py\", line 99, in live_migration\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     context, ex, {})\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/scheduler/manager.py\", line 94, in live_migration\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     block_migration, disk_over_commit)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/scheduler/driver.py\", line 170, in schedule_live_migration\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     context, instance, dest, block_migration, disk_over_commit)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/rpcapi.py\", line 225, in check_can_live_migrate_destination\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     ctxt, destination, None))\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/proxy.py\", line 80, in call\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     return rpc.call(context, self._get_topic(topic), msg, timeout)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/__init__.py\", line 109, in call\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     return _get_impl().call(cfg.CONF, context, topic, msg, timeout)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/impl_kombu.py\", line 765, in call\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     rpc_amqp.get_connection_pool(conf, Connection))\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 379, in call\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     rv = list(rv)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 347, in __iter__\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     raise result\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp AttributeError: 'NoneType' object has no attribute 'update'\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 109, in wrapped\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 88, in wrapped\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2657, in check_can_live_migrate_destination\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp     migrate_data.update(dest_check_data['migrate_data'])\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp\n2013-02-07 05:18:02.768 10466 TRACE nova.openstack.common.rpc.amqp AttributeError: 'NoneType' object has no attribute 'update'\n\nI narrowed it down to the fact that \n\nhttps://github.com/openstack/nova/blob/master/nova/virt/xenapi/driver.py#L443\n\ndoes not return dest_check_data.", 
            "date_created": "2013-02-07 16:08:12.650658+00:00", 
            "author": "https://api.launchpad.net/1.0/~armando-migliaccio"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/21449", 
            "date_created": "2013-02-07 18:47:25.379260+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi Armando,\n\nI tried to reproduce the problem, and ran into another one. \n\nnova boot --flavor m1.tiny --image d5f2be40-fc6a-439d-a0d2-fa8b0d23377e somemachine\nnova show c0f06b42-fc5e-419a-a829-e7cffb3e45ac\n...\nOS-EXT-SRV-ATTR:host                | DevStackComputeSlave\n...\nstack@DevStackOSDomU:~/devstack$ nova-manage service list\nBinary           Host                                 Zone             Status     State Updated_At\nnova-compute     DevStackComputeSlave                 nova             enabled    :-)   2013-02-08 16:06:36\nnova-network     DevStackComputeSlave                 internal         enabled    :-)   2013-02-08 16:06:33\nnova-compute     DevStackOSDomU                       nova             enabled    :-)   2013-02-08 16:06:36\nnova-network     DevStackOSDomU                       internal         enabled    :-)   2013-02-08 16:06:35\n\nnova live-migration c0f06b42-fc5e-419a-a829-e7cffb3e45ac DevStackOSDomU --block-migrate\n\n2013-02-08 16:09:28.794 ERROR nova.compute [req-467ae35b-3446-415f-8ef8-3e2e411ff189 admin demo] No db access allowed in nova-compu\nte:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenpool.py\", line 80, in _spawn_n_impl\n    func(*args, **kwargs)\n  File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 276, in _process_data\n    rval = self.proxy.dispatch(ctxt, version, method, **args)\n  File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\n    return getattr(proxyobj, method)(ctxt, **kwargs)\n  File \"/opt/stack/nova/nova/exception.py\", line 88, in wrapped\n    return f(self, context, *args, **kw)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 2732, in check_can_live_migrate_source\n    None)\n  File \"/opt/stack/nova/nova/compute/api.py\", line 2349, in is_volume_backed_instance\n    bdms = bdms or self.get_instance_bdms(context, instance)\n  File \"/opt/stack/nova/nova/compute/api.py\", line 2346, in get_instance_bdms\n    instance['uuid'])\n  File \"/opt/stack/nova/nova/db/api.py\", line 1095, in block_device_mapping_get_all_by_instance\n    instance_uuid)\n  File \"/opt/stack/nova/bin/nova-compute\", line 65, in __call__\n    stacktrace = \"\".join(traceback.format_stack())\n\nI am a bit confused, although it seems, that live block migration is broken.\n\n", 
            "date_created": "2013-02-08 16:17:48.387224+00:00", 
            "author": "https://api.launchpad.net/1.0/~mate-lakat"
        }, 
        {
            "content": "Well since nova-conductor was added, you nova-compute shouldn't be making any db calls, so that could well be something that hasn't been sorted yet!", 
            "date_created": "2013-02-08 16:36:53.136966+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "I was surprised Armando haven't seen that message.", 
            "date_created": "2013-02-08 16:39:05.393187+00:00", 
            "author": "https://api.launchpad.net/1.0/~mate-lakat"
        }, 
        {
            "content": "Mate, I am afraid I don't see that message; I believe compute calls go through nova-conductor. Are you running trunk? I am slightly behind.", 
            "date_created": "2013-02-09 11:19:34.251613+00:00", 
            "author": "https://api.launchpad.net/1.0/~armando-migliaccio"
        }, 
        {
            "content": "A code change went in right around when the patch for this was proposed which breaks the db access.  I filed a bug for it at https://bugs.launchpad.net/nova/+bug/1122432.  So while the patch addresses the reported issue there is now another one that also needs to be fixed.", 
            "date_created": "2013-02-11 21:28:19.574140+00:00", 
            "author": "https://api.launchpad.net/1.0/~alaski"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/21449\nCommitted: http://github.com/openstack/nova/commit/70c6882763116ef6515090f136fc0769698a6816\nSubmitter: Jenkins\nBranch:    master\n\ncommit 70c6882763116ef6515090f136fc0769698a6816\nAuthor: Armando Migliaccio <email address hidden>\nDate:   Thu Feb 7 18:45:46 2013 +0000\n\n    Return dest_check_data as expected by the Scheduler\n    \n    the scheduler driver expects data in return when\n    calling compute_rcp.check_can_live_migrate_destination\n    in method 'schedule_live_migration'.\n    \n    In turn check_can_live_migrate_destination calls\n    check_can_live_migrate_source that also expects data\n    returned from the driver.\n    \n    Fixes bug #1118491\n    \n    Change-Id: I3dbfa716d5d9bc849c1f67005e7bb1b8ba1ccd30\n", 
            "date_created": "2013-02-14 04:27:38.301239+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-02-21 08:51:09.776563+00:00"
}