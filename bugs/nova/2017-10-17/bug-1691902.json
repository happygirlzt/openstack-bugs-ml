{
    "status": "In Progress", 
    "last_updated": "2017-07-31 11:34:41.192795+00:00", 
    "description": "Currently, the default behavior of neutron when list security groups is: if you are \"admin\", response everything we have in the env, and if the user uses a security group from other project to boot a server, Nova will show no error in API layer check but error raised in compute layer:\n\nStep1:\nget security groups list using admin role:\n\nroot@zhenyu-dev:/var/log/nova# neutron security-group-list\n+--------------------------------------+---------+----------------------------------+----------------------------------------------------------------------+\n| id                                   | name    | tenant_id                        | security_group_rules                                                 |\n+--------------------------------------+---------+----------------------------------+----------------------------------------------------------------------+\n| 361efa37-1af0-43b2-8fa2-3cc8eccd18c9 | default | 1af7848eeb924fed851dd21bb23bb7c3 | egress, IPv4                                                         |\n|                                      |         |                                  | egress, IPv6                                                         |\n|                                      |         |                                  | ingress, IPv4, remote_group_id: 361efa37-1af0-43b2-8fa2-3cc8eccd18c9 |\n|                                      |         |                                  | ingress, IPv6, remote_group_id: 361efa37-1af0-43b2-8fa2-3cc8eccd18c9 |\n| 74a120bb-e8d3-4337-bebe-d77fa848f55c | default | 16cad1bf21ce4874896c8dc88c89c997 | egress, IPv4                                                         |\n|                                      |         |                                  | egress, IPv6                                                         |\n|                                      |         |                                  | ingress, IPv4, remote_group_id: 74a120bb-e8d3-4337-bebe-d77fa848f55c |\n|                                      |         |                                  | ingress, IPv6, remote_group_id: 74a120bb-e8d3-4337-bebe-d77fa848f55c |\n| e152865b-fc99-4cc7-b9e6-584a800d71bc | default |                                  | egress, IPv4                                                         |\n|                                      |         |                                  | egress, IPv6                                                         |\n|                                      |         |                                  | ingress, IPv4, remote_group_id: e152865b-fc99-4cc7-b9e6-584a800d71bc |\n|                                      |         |                                  | ingress, IPv6, remote_group_id: e152865b-fc99-4cc7-b9e6-584a800d71bc |\n| e1cf0509-65c0-4213-9bc4-391554ab1a4a | default | 009f69811d5c40e9968c8d1fda7e222b | egress, IPv4                                                         |\n|                                      |         |                                  | egress, IPv6                                                         |\n|                                      |         |                                  | ingress, IPv4, remote_group_id: e1cf0509-65c0-4213-9bc4-391554ab1a4a |\n|                                      |         |                                  | ingress, IPv6, remote_group_id: e1cf0509-65c0-4213-9bc4-391554ab1a4a |\n+--------------------------------------+---------+----------------------------------+----------------------------------------------------------------------+\n\nStep 2:\nchose a security group from other project to boot a server:\n\nroot@zhenyu-dev:/var/log/nova# nova boot --image 572a29b0-7a22-4359-87b1-d30944d7c659 --security-groups 361efa37-1af0-43b2-8fa2-3cc8eccd18c9 --nic net-id=c248898a-4dd4-491a-a8a9-01810ea338a2 --flavor 1 test\n\n| Property                             | Value                                                           |\n+--------------------------------------+-----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                          |\n| OS-EXT-AZ:availability_zone          |                                                                 |\n| OS-EXT-SRV-ATTR:host                 | -                                                               |\n| OS-EXT-SRV-ATTR:hostname             | test                                                            |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                               |\n| OS-EXT-SRV-ATTR:instance_name        |                                                                 |\n| OS-EXT-SRV-ATTR:kernel_id            |                                                                 |\n| OS-EXT-SRV-ATTR:launch_index         | 0                                                               |\n| OS-EXT-SRV-ATTR:ramdisk_id           |                                                                 |\n| OS-EXT-SRV-ATTR:reservation_id       | r-e9ny6bfb                                                      |\n| OS-EXT-SRV-ATTR:root_device_name     | -                                                               |\n| OS-EXT-SRV-ATTR:user_data            | -                                                               |\n| OS-EXT-STS:power_state               | 0                                                               |\n| OS-EXT-STS:task_state                | scheduling                                                      |\n| OS-EXT-STS:vm_state                  | building                                                        |\n| OS-SRV-USG:launched_at               | -                                                               |\n| OS-SRV-USG:terminated_at             | -                                                               |\n| accessIPv4                           |                                                                 |\n| accessIPv6                           |                                                                 |\n| adminPass                            | w5p9NErq77Fn                                                    |\n| config_drive                         |                                                                 |\n| created                              | 2017-05-19T01:03:43Z                                            |\n| description                          | -                                                               |\n| flavor                               | m1.tiny (1)                                                     |\n| hostId                               |                                                                 |\n| host_status                          |                                                                 |\n| id                                   | b8ed1fae-93a3-425c-a4e9-d75c0d1631cd                            |\n| image                                | cirros-0.3.5-x86_64-disk (572a29b0-7a22-4359-87b1-d30944d7c659) |\n| key_name                             | -                                                               |\n| locked                               | False                                                           |\n| metadata                             | {}                                                              |\n| name                                 | test                                                            |\n| os-extended-volumes:volumes_attached | []                                                              |\n| progress                             | 0                                                               |\n| security_groups                      | 361efa37-1af0-43b2-8fa2-3cc8eccd18c9                            |\n| status                               | BUILD                                                           |\n| tags                                 | []                                                              |\n| tenant_id                            | 16cad1bf21ce4874896c8dc88c89c997                                |\n| updated                              | 2017-05-19T01:03:43Z                                            |\n| user_id                              | 597ee5c1ea82482ca8aec10b1a688359                                |\n+--------------------------------------+-----------------------------------------------------------------+\n\nStep3:\ncheck the server again:\nroot@zhenyu-dev:/var/log/nova# nova list\n+--------------------------------------+------+--------+------------+-------------+----------+\n| ID                                   | Name | Status | Task State | Power State | Networks |\n+--------------------------------------+------+--------+------------+-------------+----------+\n| b8ed1fae-93a3-425c-a4e9-d75c0d1631cd | test | ERROR  | -          | NOSTATE     |          |\n+--------------------------------------+------+--------+------------+-------------+----------+\n\nInstance in Error state due to:\n\nNova compute Log:\n\n2017-05-19 09:17:13.734 DEBUG nova.notifications.objects.base [req-e9870e63-2388-4259-977e-4eab0ae64975 admin admin] Defaulting the value of the field 'projects' to None i\n...skipping...\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     self.wait()\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/network/model.py\", line 573, in wait\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     self[:] = self._gt.wait()\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\"\n, line 175, in wait\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     return self._exit_event.wait()\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line\n 125, in wait\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     current.throw(*self._exc)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\"\n, line 214, in main\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     result = function(*args, **kwargs)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/utils.py\", line 1056, in context_wrapper\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     return func(*args, **kwargs)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1415, in _alloca\nte_network_async\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     six.reraise(*exc_info)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1398, in _alloca\nte_network_async\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     bind_host_id=bind_host_id)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 855, in al\nlocate_for_instance\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     instance, neutron, security_groups)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 653, in _p\nrocess_security_groups\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     security_group_id=security_group)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed] SecurityGroupNotFound: Security group 361efa37-1af0-43b2-8fa2-3cc8eccd1\n8c9 not found.\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed] \n2017-05-19 09:17:15.021 INFO nova.compute.manager [req-e9870e63-2388-4259-977e-4eab0ae64975 admin admin] [instance: 8668778e-84e3-4935-b428-eb8d907db9ed] Terminating insta\nnce\n\nThis inconsistancy is caused by:\nIn API layer, we checked security groups using\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/network/security_group/neutron_driver.py#n145\nit is a \"show\" API and since we are using admin context, it will get the response\n\nBut in compute layer:\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/network/neutronv2/api.py#n623\nwe are getting security group info by \"list\" API and filtering with instance.project_id and\nobviously we cannot get what we want.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1691902", 
    "owner": "https://api.launchpad.net/1.0/~zhengzhenyu", 
    "id": 1691902, 
    "index": 4826, 
    "openned": "2017-05-19 01:28:23.000938+00:00", 
    "created": "2017-05-19 01:28:23.000938+00:00", 
    "title": "Should not allow security group from other project pass API layer check when booting", 
    "comments": [
        {
            "content": "Currently, the default behavior of neutron when list security groups is: if you are \"admin\", response everything we have in the env, and if the user uses a security group from other project to boot a server, Nova will show no error in API layer check but error raised in compute layer:\n\nStep1:\nget security groups list using admin role:\n\nroot@zhenyu-dev:/var/log/nova# neutron security-group-list\n+--------------------------------------+---------+----------------------------------+----------------------------------------------------------------------+\n| id                                   | name    | tenant_id                        | security_group_rules                                                 |\n+--------------------------------------+---------+----------------------------------+----------------------------------------------------------------------+\n| 361efa37-1af0-43b2-8fa2-3cc8eccd18c9 | default | 1af7848eeb924fed851dd21bb23bb7c3 | egress, IPv4                                                         |\n|                                      |         |                                  | egress, IPv6                                                         |\n|                                      |         |                                  | ingress, IPv4, remote_group_id: 361efa37-1af0-43b2-8fa2-3cc8eccd18c9 |\n|                                      |         |                                  | ingress, IPv6, remote_group_id: 361efa37-1af0-43b2-8fa2-3cc8eccd18c9 |\n| 74a120bb-e8d3-4337-bebe-d77fa848f55c | default | 16cad1bf21ce4874896c8dc88c89c997 | egress, IPv4                                                         |\n|                                      |         |                                  | egress, IPv6                                                         |\n|                                      |         |                                  | ingress, IPv4, remote_group_id: 74a120bb-e8d3-4337-bebe-d77fa848f55c |\n|                                      |         |                                  | ingress, IPv6, remote_group_id: 74a120bb-e8d3-4337-bebe-d77fa848f55c |\n| e152865b-fc99-4cc7-b9e6-584a800d71bc | default |                                  | egress, IPv4                                                         |\n|                                      |         |                                  | egress, IPv6                                                         |\n|                                      |         |                                  | ingress, IPv4, remote_group_id: e152865b-fc99-4cc7-b9e6-584a800d71bc |\n|                                      |         |                                  | ingress, IPv6, remote_group_id: e152865b-fc99-4cc7-b9e6-584a800d71bc |\n| e1cf0509-65c0-4213-9bc4-391554ab1a4a | default | 009f69811d5c40e9968c8d1fda7e222b | egress, IPv4                                                         |\n|                                      |         |                                  | egress, IPv6                                                         |\n|                                      |         |                                  | ingress, IPv4, remote_group_id: e1cf0509-65c0-4213-9bc4-391554ab1a4a |\n|                                      |         |                                  | ingress, IPv6, remote_group_id: e1cf0509-65c0-4213-9bc4-391554ab1a4a |\n+--------------------------------------+---------+----------------------------------+----------------------------------------------------------------------+\n\nStep 2:\nchose a security group from other project to boot a server:\n\nroot@zhenyu-dev:/var/log/nova# nova boot --image 572a29b0-7a22-4359-87b1-d30944d7c659 --security-groups 361efa37-1af0-43b2-8fa2-3cc8eccd18c9 --nic net-id=c248898a-4dd4-491a-a8a9-01810ea338a2 --flavor 1 test\n\n| Property                             | Value                                                           |\n+--------------------------------------+-----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                          |\n| OS-EXT-AZ:availability_zone          |                                                                 |\n| OS-EXT-SRV-ATTR:host                 | -                                                               |\n| OS-EXT-SRV-ATTR:hostname             | test                                                            |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                               |\n| OS-EXT-SRV-ATTR:instance_name        |                                                                 |\n| OS-EXT-SRV-ATTR:kernel_id            |                                                                 |\n| OS-EXT-SRV-ATTR:launch_index         | 0                                                               |\n| OS-EXT-SRV-ATTR:ramdisk_id           |                                                                 |\n| OS-EXT-SRV-ATTR:reservation_id       | r-e9ny6bfb                                                      |\n| OS-EXT-SRV-ATTR:root_device_name     | -                                                               |\n| OS-EXT-SRV-ATTR:user_data            | -                                                               |\n| OS-EXT-STS:power_state               | 0                                                               |\n| OS-EXT-STS:task_state                | scheduling                                                      |\n| OS-EXT-STS:vm_state                  | building                                                        |\n| OS-SRV-USG:launched_at               | -                                                               |\n| OS-SRV-USG:terminated_at             | -                                                               |\n| accessIPv4                           |                                                                 |\n| accessIPv6                           |                                                                 |\n| adminPass                            | w5p9NErq77Fn                                                    |\n| config_drive                         |                                                                 |\n| created                              | 2017-05-19T01:03:43Z                                            |\n| description                          | -                                                               |\n| flavor                               | m1.tiny (1)                                                     |\n| hostId                               |                                                                 |\n| host_status                          |                                                                 |\n| id                                   | b8ed1fae-93a3-425c-a4e9-d75c0d1631cd                            |\n| image                                | cirros-0.3.5-x86_64-disk (572a29b0-7a22-4359-87b1-d30944d7c659) |\n| key_name                             | -                                                               |\n| locked                               | False                                                           |\n| metadata                             | {}                                                              |\n| name                                 | test                                                            |\n| os-extended-volumes:volumes_attached | []                                                              |\n| progress                             | 0                                                               |\n| security_groups                      | 361efa37-1af0-43b2-8fa2-3cc8eccd18c9                            |\n| status                               | BUILD                                                           |\n| tags                                 | []                                                              |\n| tenant_id                            | 16cad1bf21ce4874896c8dc88c89c997                                |\n| updated                              | 2017-05-19T01:03:43Z                                            |\n| user_id                              | 597ee5c1ea82482ca8aec10b1a688359                                |\n+--------------------------------------+-----------------------------------------------------------------+\n\nStep3:\ncheck the server again:\nroot@zhenyu-dev:/var/log/nova# nova list\n+--------------------------------------+------+--------+------------+-------------+----------+\n| ID                                   | Name | Status | Task State | Power State | Networks |\n+--------------------------------------+------+--------+------------+-------------+----------+\n| b8ed1fae-93a3-425c-a4e9-d75c0d1631cd | test | ERROR  | -          | NOSTATE     |          |\n+--------------------------------------+------+--------+------------+-------------+----------+\n\nInstance in Error state due to:\n\nNova compute Log:\n\n2017-05-19 09:17:13.734 DEBUG nova.notifications.objects.base [req-e9870e63-2388-4259-977e-4eab0ae64975 admin admin] Defaulting the value of the field 'projects' to None i\n...skipping...\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     self.wait()\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/network/model.py\", line 573, in wait\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     self[:] = self._gt.wait()\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\"\n, line 175, in wait\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     return self._exit_event.wait()\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line\n 125, in wait\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     current.throw(*self._exc)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\"\n, line 214, in main\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     result = function(*args, **kwargs)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/utils.py\", line 1056, in context_wrapper\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     return func(*args, **kwargs)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1415, in _alloca\nte_network_async\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     six.reraise(*exc_info)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1398, in _alloca\nte_network_async\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     bind_host_id=bind_host_id)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 855, in al\nlocate_for_instance\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     instance, neutron, security_groups)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 653, in _p\nrocess_security_groups\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed]     security_group_id=security_group)\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed] SecurityGroupNotFound: Security group 361efa37-1af0-43b2-8fa2-3cc8eccd1\n8c9 not found.\n2017-05-19 09:17:15.020 TRACE nova.compute.manager [instance: 8668778e-84e3-4935-b428-eb8d907db9ed] \n2017-05-19 09:17:15.021 INFO nova.compute.manager [req-e9870e63-2388-4259-977e-4eab0ae64975 admin admin] [instance: 8668778e-84e3-4935-b428-eb8d907db9ed] Terminating insta\nnce\n\nThis inconsistancy is caused by:\nIn API layer, we checked security groups using\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/network/security_group/neutron_driver.py#n145\nit is a \"show\" API and since we are using admin context, it will get the response\n\nBut in compute layer:\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/network/neutronv2/api.py#n623\nwe are getting security group info by \"list\" API and filtering with instance.project_id and\nobviously we cannot get what we want.", 
            "date_created": "2017-05-19 01:28:23.000938+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengzhenyu"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/466160", 
            "date_created": "2017-05-19 02:57:32.709688+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}