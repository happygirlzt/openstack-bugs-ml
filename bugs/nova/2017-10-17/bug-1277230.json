{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:40:25.968960+00:00", 
    "description": "If you create two overlapping availability zones, the get availability zones command returns odd information.\n\nRepro:\n\n$ nova --os-username admin --os-tenant-name admin --os-password secrete aggregate-create foo foo\n+----+------+-------------------+-------+----------+\n| Id | Name | Availability Zone | Hosts | Metadata |\n+----+------+-------------------+-------+----------+\n| 2  | foo  | foo               |       |          |\n+----+------+-------------------+-------+----------+\n\n$ nova --os-username admin --os-tenant-name admin --os-password secrete aggregate-add-host 2 node001-cont001\nAggregate 2 has been successfully updated.\n+----+------+-------------------+----------------------+--------------------------------+\n| Id | Name | Availability Zone | Hosts                | Metadata                       |\n+----+------+-------------------+----------------------+--------------------------------+\n| 2  | foo  | foo               | [u'node001-cont001'] | {u'availability_zone': u'foo'} |\n+----+------+-------------------+----------------------+--------------------------------+\n\n$ nova availability-zone-list\n+-------------+-----------+\n| Name        | Status    |\n+-------------+-----------+\n| zone001     | available |\n| zone001,foo | available |\n+-------------+-----------+\n\nExpected:\n+---------+-----------+\n| Name    | Status    |\n+---------+-----------+\n| zone001 | available |\n| foo     | available |\n+---------+-----------+\n\nThe admin view is a little more useful:\n\n$ nova --os-username admin --os-tenant-name admin --os-password secrete availability-zone-list\n+-----------------------+----------------------------------------+\n| Name                  | Status                                 |\n+-----------------------+----------------------------------------+\n| internal              | available                              |\n...\n| zone001               | available                              |\n| |- node005-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:31.000000 |\n| |- node007-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n| |- node009-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:25.000000 |\n| |- node003-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n| zone001,foo           | available                              |\n| |- node001-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n+-----------------------+----------------------------------------+\n\nbut it could easily show two copies of the node that is in two zones:\n\n+-----------------------+----------------------------------------+\n| Name                  | Status                                 |\n+-----------------------+----------------------------------------+\n| internal              | available                              |\n...\n| zone001               | available                              |\n| |- node005-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:31.000000 |\n| |- node007-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n| |- node009-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:25.000000 |\n| |- node003-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n| |- node001-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n| foo                   | available                              |\n| |- node001-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n+-----------------------+----------------------------------------+", 
    "tags": [
        "low-hanging-fruit"
    ], 
    "importance": "Low", 
    "heat": 20, 
    "link": "https://bugs.launchpad.net/nova/+bug/1277230", 
    "owner": "https://api.launchpad.net/1.0/~sylvain-bauza", 
    "id": 1277230, 
    "index": 1153, 
    "openned": "2014-02-06 19:24:16.697453+00:00", 
    "created": "2014-02-06 19:24:16.697453+00:00", 
    "title": "Overlapping availability zones don't display properly", 
    "comments": [
        {
            "content": "If you create two overlapping availability zones, the get availability zones command returns odd information.\n\nRepro:\n\n$ nova --os-username admin --os-tenant-name admin --os-password secrete aggregate-create foo foo\n+----+------+-------------------+-------+----------+\n| Id | Name | Availability Zone | Hosts | Metadata |\n+----+------+-------------------+-------+----------+\n| 2  | foo  | foo               |       |          |\n+----+------+-------------------+-------+----------+\n\n$ nova --os-username admin --os-tenant-name admin --os-password secrete aggregate-add-host 2 node001-cont001\nAggregate 2 has been successfully updated.\n+----+------+-------------------+----------------------+--------------------------------+\n| Id | Name | Availability Zone | Hosts                | Metadata                       |\n+----+------+-------------------+----------------------+--------------------------------+\n| 2  | foo  | foo               | [u'node001-cont001'] | {u'availability_zone': u'foo'} |\n+----+------+-------------------+----------------------+--------------------------------+\n\n$ nova availability-zone-list\n+-------------+-----------+\n| Name        | Status    |\n+-------------+-----------+\n| zone001     | available |\n| zone001,foo | available |\n+-------------+-----------+\n\nExpected:\n+---------+-----------+\n| Name    | Status    |\n+---------+-----------+\n| zone001 | available |\n| foo     | available |\n+---------+-----------+\n\nThe admin view is a little more useful:\n\n$ nova --os-username admin --os-tenant-name admin --os-password secrete availability-zone-list\n+-----------------------+----------------------------------------+\n| Name                  | Status                                 |\n+-----------------------+----------------------------------------+\n| internal              | available                              |\n...\n| zone001               | available                              |\n| |- node005-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:31.000000 |\n| |- node007-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n| |- node009-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:25.000000 |\n| |- node003-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n| zone001,foo           | available                              |\n| |- node001-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n+-----------------------+----------------------------------------+\n\nbut it could easily show two copies of the node that is in two zones:\n\n+-----------------------+----------------------------------------+\n| Name                  | Status                                 |\n+-----------------------+----------------------------------------+\n| internal              | available                              |\n...\n| zone001               | available                              |\n| |- node005-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:31.000000 |\n| |- node007-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n| |- node009-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:25.000000 |\n| |- node003-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n| |- node001-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n| foo                   | available                              |\n| |- node001-cont001    |                                        |\n| | |- nova-compute     | enabled :-) 2014-02-06T19:18:27.000000 |\n+-----------------------+----------------------------------------+", 
            "date_created": "2014-02-06 19:24:16.697453+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "This line should be modified to return the zones as a list instead of joining them using ',':\n\nhttps://github.com/openstack/nova/blob/e9788089173f03f9a25e69b61346e56af045eccf/nova/availability_zones.py#L73\n\nThe call sites of set_availability_zones should be converted to do the comma join if necessary, and to simply deal with processing a list in other cases.\n\nFor example, to fix the issue above:\n\nhttps://github.com/openstack/nova/blob/e9788089173f03f9a25e69b61346e56af045eccf/nova/availability_zones.py#L118\n\nand\n\nhttps://github.com/openstack/nova/blob/e9788089173f03f9a25e69b61346e56af045eccf/nova/availability_zones.py#L129\n\ncan be modified to have another iteration through the zones when creating the list\n\nfor zone_list in zones:\n--> for zone in zone_list:\n-------> if zone not in not_available_zones:\n", 
            "date_created": "2014-02-06 19:33:05.897787+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "due to this issue the boot command fails in create instance during the validation of availability zone.\n\nsince instead of returning a list of all available zones we get a  list like\n\n[u'ZoneA,nova', u'ZoneB,nova', 'internal']\"\n\nand the boot zone is nova by default which does not match so the validation fails.\n\nAs suggested above a function returning a list is what is needed.", 
            "date_created": "2014-03-26 18:25:01.732111+00:00", 
            "author": "https://api.launchpad.net/1.0/~singhs"
        }, 
        {
            "content": "This is affecting us w/ havana also.  Can we get a backport when fixed in trunk?", 
            "date_created": "2014-04-01 22:28:07.936512+00:00", 
            "author": "https://api.launchpad.net/1.0/~breu"
        }, 
        {
            "content": "I can't reproduce the bug on my devstack... When specifying an az in nova.conf for compute host, I can see it :\n\nbauzas@climate-devstack-ctrl:~$ nova availability-zone-list\n+--------------------------+----------------------------------------+\n| Name                     | Status                                 |\n+--------------------------+----------------------------------------+\n| internal                 | available                              |\n(...)\n| nova                     | available                              |\n| |- climate-devstack-ctrl |                                        |\n| | |- nova-compute        | enabled :-) 2014-04-03T12:00:30.000000 |\n+--------------------------+----------------------------------------+\n\nI then created an aggregate with AZ both set to foo : \nbauzas@climate-devstack-ctrl:~$ nova aggregate-list\n+----+----------+-------------------+\n| Id | Name     | Availability Zone |\n+----+----------+-------------------+\n| 10 | foo      | foo               |\n| 12 | nova     | nova              |\n+----+----------+-------------------+\n\nBut when adding the host in foo, it overrides the default AZ :\nbauzas@climate-devstack-ctrl:~$ nova aggregate-add-host foo climate-devstack-ctrl\nAggregate 10 has been successfully updated.\n+----+------+-------------------+-------------------------+-------------------------+\n| Id | Name | Availability Zone | Hosts                   | Metadata                |\n+----+------+-------------------+-------------------------+-------------------------+\n| 10 | foo  | foo               | 'climate-devstack-ctrl' | 'availability_zone=foo' |\n+----+------+-------------------+-------------------------+-------------------------+\n\nbauzas@climate-devstack-ctrl:~$ nova availability-zone-list\n+--------------------------+----------------------------------------+\n| Name                     | Status                                 |\n+--------------------------+----------------------------------------+\n| internal                 | available                              |\n(...)\n| foo                      | available                              |\n| |- climate-devstack-ctrl |                                        |\n| | |- nova-compute        | enabled :-) 2014-04-03T12:08:30.000000 |\n+--------------------------+----------------------------------------+\n\n\nBesides this, Nova API prevents adding the same host in a second AZ :\n\nbauzas@climate-devstack-ctrl:~$ nova aggregate-list\n+----+----------+-------------------+\n| Id | Name     | Availability Zone |\n+----+----------+-------------------+\n| 10 | foo      | foo               |\n| 11 | foo2     | foo2              |\n| 12 | nova     | nova              |\n+----+----------+-------------------+\n\nbauzas@climate-devstack-ctrl:~$ nova aggregate-add-host foo2 climate-devstack-ctrl\nERROR: Cannot perform action 'add_host_to_aggregate' on aggregate 11. Reason: Host already in availability zone foo. (HTTP 409) (Request-ID: req-120e0b7a-8005-4137-97d3-952375ed6f5c)\n\nThis is due to https://github.com/openstack/nova/blob/9d45e9cef624a4a972c24c47c7abd57a72d74432/nova/compute/api.py#L3378\n\n\nCould someone share his config with me to know how to add the same host in two AZs ?", 
            "date_created": "2014-04-03 13:10:43.264215+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "I can add an host to two availability zones by creating an  aggregate without an availability zone, adding an host to it and then using aggregate-update to set the availability zone.\n\nProbably it is a bug, but it works.", 
            "date_created": "2014-04-03 13:37:59.750496+00:00", 
            "author": "https://api.launchpad.net/1.0/~venza"
        }, 
        {
            "content": "Thanks Daniele for the comment.\n\nI'll open a discussion on openstack-dev because I need clarifications. If Nova API is preventing to have 2 AZs for the same host, we should fix the possibility to update an aggregate with setting an AZ if the hosts mapped to this AZ are already part of another AZ.\n\nIn other words, this bug should not be fixed, but rather the missing coverage when updating an aggregate.\nAnyway, I can't reproduce the bug as reported.\n\nComments welcome. ", 
            "date_created": "2014-04-03 13:44:07.258854+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "http://lists.openstack.org/pipermail/openstack-dev/2014-April/031775.html for discussing about what to do", 
            "date_created": "2014-04-03 14:07:06.975514+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/85961", 
            "date_created": "2014-04-08 09:11:08.888629+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/88283", 
            "date_created": "2014-04-17 13:16:03.539543+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/85961\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0ad5a64dc9ac4b1cfb8038f9171b6385fdf07f28\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0ad5a64dc9ac4b1cfb8038f9171b6385fdf07f28\nAuthor: Sylvain Bauza <email address hidden>\nDate:   Tue Apr 8 11:00:40 2014 +0200\n\n    Fix AvailabilityZone check for hosts in multiple aggregates\n    \n    Check for multiple AZ was distinct when adding an host to an aggregate\n    and when updating an aggregate (or its metadata), which was leading to\n    possible corner-cases where logics were different.\n    \n    This patch proposes a single way for checking for both API methods and\n    also adds an extra control on the possibility to have an aggregate with\n    its metadata AZ set to the configuration default value (eg. 'nova') and\n    where it was possible to subsequently have one host in two disctinct AZs\n    Fixed that scenerio as it is a gap, Nova as of now preventing to have\n    one host in two distinct AZs.\n    \n    Change-Id: Ida6aa507f34f36a436adaafe1f7609963c59a9bc\n    Partial-Bug: #1277230\n", 
            "date_created": "2014-05-21 10:55:13.060300+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/88283\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=a2af1101fe94744ab87f30016def333405713287\nSubmitter: Jenkins\nBranch:    master\n\ncommit a2af1101fe94744ab87f30016def333405713287\nAuthor: Sylvain Bauza <email address hidden>\nDate:   Thu Apr 17 14:37:00 2014 +0200\n\n    Improve performance for checking hosts AZs\n    \n    When updating aggregate metadata or when adding a host into aggregate,\n    a check is done to make sure that hosts can't be in multiple AZs.\n    \n    In order to do the check, the routine was looping over each host to look\n    in the DB which AZs the host is part of.\n    As it's quite hungry in terms of DB accesses, here the proposal is to\n    extend the helper method for getting all AZs by also having their hosts,\n    and so only do memory iterations.\n    \n    Partial-Bug: #1277230\n    \n    Change-Id: I7c5bc980acb17f0a0e1f8c1403dac66c305866fb\n", 
            "date_created": "2014-06-20 18:57:16.406732+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Is this bug closed now?  All reviews are merged though they are marked partial.  what else is needed?", 
            "date_created": "2014-07-16 16:40:53.483706+00:00", 
            "author": "https://api.launchpad.net/1.0/~tjones-i"
        }, 
        {
            "content": "Well,  sort of ;-) These patches are fixing the flaw where it was possible to add a host into 2 AZs, so now it's no longer possible to have the reporter's scenario.\n\n", 
            "date_created": "2014-07-17 08:25:01.828376+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }
    ], 
    "closed": "2014-07-23 15:02:34.362573+00:00"
}