{
    "status": "Fix Released", 
    "last_updated": "2011-04-15 08:39:44.491264+00:00", 
    "description": "1. pulled trunk\n2. started nova screen session\n3. euca-run-instances -k test -t m1.tiny ami-tiny\n4. get the following in the compute worker output/logs:\n\nDEBUG:root:instance 1: starting...\nDEBUG:root:Asking xapi to fetch http://10.127.4.133:3333/_images/ami-tiny/image as admin:admin\nINFO:root:Task [Async.host.call_plugin] OpaqueRef:cfd9ecce-8119-d184-b4f8-48b48fc9af5e status: success    <value>5a076be8-0221-4a4b-9d68-3f3e306c7c02</value>\nDEBUG:root:Asking xapi to fetch http://10.127.4.133:3333/_images/aki-lucid/image as admin:admin\nINFO:root:Task [Async.host.call_plugin] OpaqueRef:13d1feb3-984a-3f9d-2786-dc191ed38fc0 status: success    <value>/boot/guest/_images/aki-lucid/image</value>\nERROR:root:in looping call\nTraceback (most recent call last):\n  File \"/home/trey/openstack/novascript/nova/nova/utils.py\", line 323, in _inner\n    self.f(*self.args, **self.kw)\n  File \"/home/trey/openstack/novascript/nova/nova/virt/xenapi_conn.py\", line 257, in _poll_task\n    db.instance_action_create(context.get_admin_context(), action)\n  File \"/home/trey/openstack/novascript/nova/nova/db/api.py\", line 383, in instance_action_create\n    return IMPL.instance_action_create(context, values)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/api.py\", line 108, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/api.py\", line 855, in instance_action_create\n    action_ref.save(session=session)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/models.py\", line 57, in save\n    session.flush()\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 1346, in flush\n    self._flush(objects)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 1427, in _flush\n    flush_context.execute()\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 299, in execute\n    rec.execute(self)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 443, in execute\n    uow\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/mapper.py\", line 1833, in _save_obj\n    execute(statement, params)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1157, in execute\n    params)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n    return self.__execute_context(context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n    context.parameters[0], context=context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n    context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n    context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/default.py\", line 288, in do_execute\n    cursor.execute(statement, parameters)\nIntegrityError: (IntegrityError) PRIMARY KEY must be unique u'INSERT INTO instance_actions (created_at, updated_at, deleted_at, deleted, id, instance_id, action, error) VALUES (?, ?, ?, ?, ?, ?, ?, ?)' ('2010-12-30 05:18:01.935480', None, None, False, 0, None, 'Async.host.call_plugin', None)\n\nDEBUG:root:Asking xapi to fetch http://10.127.4.133:3333/_images/ari-lucid/image as admin:admin\nINFO:root:Task [Async.host.call_plugin] OpaqueRef:2fc0cacd-fb81-8751-725f-b9f02b056c09 status: success    <value>/boot/guest/_images/ari-lucid/image</value>\nERROR:root:in looping call\nTraceback (most recent call last):\n  File \"/home/trey/openstack/novascript/nova/nova/utils.py\", line 323, in _inner\n    self.f(*self.args, **self.kw)\n  File \"/home/trey/openstack/novascript/nova/nova/virt/xenapi_conn.py\", line 257, in _poll_task\n    db.instance_action_create(context.get_admin_context(), action)\n  File \"/home/trey/openstack/novascript/nova/nova/db/api.py\", line 383, in instance_action_create\n    return IMPL.instance_action_create(context, values)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/api.py\", line 108, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/api.py\", line 855, in instance_action_create\n    action_ref.save(session=session)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/models.py\", line 57, in save\n    session.flush()\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 1346, in flush\n    self._flush(objects)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 1427, in _flush\n    flush_context.execute()\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 299, in execute\n    rec.execute(self)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 443, in execute\n    uow\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/mapper.py\", line 1833, in _save_obj\n    execute(statement, params)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1157, in execute\n    params)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n    return self.__execute_context(context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n    context.parameters[0], context=context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n    context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n    context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/default.py\", line 288, in do_execute\n    cursor.execute(statement, parameters)\nIntegrityError: (IntegrityError) PRIMARY KEY must be unique u'INSERT INTO instance_actions (created_at, updated_at, deleted_at, deleted, id, instance_id, action, error) VALUES (?, ?, ?, ?, ?, ?, ?, ?)' ('2010-12-30 05:18:02.755981', None, None, False, 0, None, 'Async.host.call_plugin', None)\n\nDEBUG:root:Created VM instance-137521447...\nDEBUG:root:Created VM instance-137521447 as OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa.\nDEBUG:root:Creating VBD for VM OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa, VDI OpaqueRef:603743d5-6cc6-a69a-95a0-680b249ad153 ...\nDEBUG:root:Created VBD OpaqueRef:b708f65a-df73-5f4b-8427-872755fcf6d0 for VM OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa, VDI OpaqueRef:603743d5-6cc6-a69a-95a0-680b249ad153.\nDEBUG:root:Creating VIF for VM OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa, network OpaqueRef:eff1853c-a45d-fa66-bced-50c1c3e286a2.\nDEBUG:root:Created VIF OpaqueRef:6d07708c-71bc-47c2-941e-b4c77a8bf57a for VM OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa, network OpaqueRef:eff1853c-a45d-fa66-bced-50c1c3e286a2.\nDEBUG:root:Starting VM OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa...\nINFO:root:Spawning VM instance-137521447 created OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa.\nINFO:root:(VM_UTILS) xenserver vm state -> |Running|\nINFO:root:(VM_UTILS) xenapi power_state -> |1|\nDEBUG:root:Instance instance-137521447: booted\nINFO:root:(VM_UTILS) xenserver vm state -> |Running|\nINFO:root:(VM_UTILS) xenapi power_state -> |1|\n\n\nThe instance is running and works. I was able to test locking, pause, unpause etc successfully.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/695587", 
    "owner": "https://api.launchpad.net/1.0/~jk0", 
    "id": 695587, 
    "index": 3247, 
    "openned": "2010-12-30 05:23:37.367892+00:00", 
    "created": "2010-12-30 05:23:37.367892+00:00", 
    "title": "Instance action recording fails with 'primary key must be unique' error", 
    "comments": [
        {
            "content": "1. pulled trunk\n2. started nova screen session\n3. euca-run-instances -k test -t m1.tiny ami-tiny\n4. get the following in the compute worker output/logs:\n\nDEBUG:root:instance 1: starting...\nDEBUG:root:Asking xapi to fetch http://10.127.4.133:3333/_images/ami-tiny/image as admin:admin\nINFO:root:Task [Async.host.call_plugin] OpaqueRef:cfd9ecce-8119-d184-b4f8-48b48fc9af5e status: success    <value>5a076be8-0221-4a4b-9d68-3f3e306c7c02</value>\nDEBUG:root:Asking xapi to fetch http://10.127.4.133:3333/_images/aki-lucid/image as admin:admin\nINFO:root:Task [Async.host.call_plugin] OpaqueRef:13d1feb3-984a-3f9d-2786-dc191ed38fc0 status: success    <value>/boot/guest/_images/aki-lucid/image</value>\nERROR:root:in looping call\nTraceback (most recent call last):\n  File \"/home/trey/openstack/novascript/nova/nova/utils.py\", line 323, in _inner\n    self.f(*self.args, **self.kw)\n  File \"/home/trey/openstack/novascript/nova/nova/virt/xenapi_conn.py\", line 257, in _poll_task\n    db.instance_action_create(context.get_admin_context(), action)\n  File \"/home/trey/openstack/novascript/nova/nova/db/api.py\", line 383, in instance_action_create\n    return IMPL.instance_action_create(context, values)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/api.py\", line 108, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/api.py\", line 855, in instance_action_create\n    action_ref.save(session=session)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/models.py\", line 57, in save\n    session.flush()\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 1346, in flush\n    self._flush(objects)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 1427, in _flush\n    flush_context.execute()\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 299, in execute\n    rec.execute(self)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 443, in execute\n    uow\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/mapper.py\", line 1833, in _save_obj\n    execute(statement, params)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1157, in execute\n    params)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n    return self.__execute_context(context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n    context.parameters[0], context=context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n    context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n    context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/default.py\", line 288, in do_execute\n    cursor.execute(statement, parameters)\nIntegrityError: (IntegrityError) PRIMARY KEY must be unique u'INSERT INTO instance_actions (created_at, updated_at, deleted_at, deleted, id, instance_id, action, error) VALUES (?, ?, ?, ?, ?, ?, ?, ?)' ('2010-12-30 05:18:01.935480', None, None, False, 0, None, 'Async.host.call_plugin', None)\n\nDEBUG:root:Asking xapi to fetch http://10.127.4.133:3333/_images/ari-lucid/image as admin:admin\nINFO:root:Task [Async.host.call_plugin] OpaqueRef:2fc0cacd-fb81-8751-725f-b9f02b056c09 status: success    <value>/boot/guest/_images/ari-lucid/image</value>\nERROR:root:in looping call\nTraceback (most recent call last):\n  File \"/home/trey/openstack/novascript/nova/nova/utils.py\", line 323, in _inner\n    self.f(*self.args, **self.kw)\n  File \"/home/trey/openstack/novascript/nova/nova/virt/xenapi_conn.py\", line 257, in _poll_task\n    db.instance_action_create(context.get_admin_context(), action)\n  File \"/home/trey/openstack/novascript/nova/nova/db/api.py\", line 383, in instance_action_create\n    return IMPL.instance_action_create(context, values)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/api.py\", line 108, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/api.py\", line 855, in instance_action_create\n    action_ref.save(session=session)\n  File \"/home/trey/openstack/novascript/nova/nova/db/sqlalchemy/models.py\", line 57, in save\n    session.flush()\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 1346, in flush\n    self._flush(objects)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 1427, in _flush\n    flush_context.execute()\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 299, in execute\n    rec.execute(self)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 443, in execute\n    uow\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/mapper.py\", line 1833, in _save_obj\n    execute(statement, params)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1157, in execute\n    params)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n    return self.__execute_context(context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n    context.parameters[0], context=context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n    context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n    context)\n  File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/default.py\", line 288, in do_execute\n    cursor.execute(statement, parameters)\nIntegrityError: (IntegrityError) PRIMARY KEY must be unique u'INSERT INTO instance_actions (created_at, updated_at, deleted_at, deleted, id, instance_id, action, error) VALUES (?, ?, ?, ?, ?, ?, ?, ?)' ('2010-12-30 05:18:02.755981', None, None, False, 0, None, 'Async.host.call_plugin', None)\n\nDEBUG:root:Created VM instance-137521447...\nDEBUG:root:Created VM instance-137521447 as OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa.\nDEBUG:root:Creating VBD for VM OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa, VDI OpaqueRef:603743d5-6cc6-a69a-95a0-680b249ad153 ...\nDEBUG:root:Created VBD OpaqueRef:b708f65a-df73-5f4b-8427-872755fcf6d0 for VM OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa, VDI OpaqueRef:603743d5-6cc6-a69a-95a0-680b249ad153.\nDEBUG:root:Creating VIF for VM OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa, network OpaqueRef:eff1853c-a45d-fa66-bced-50c1c3e286a2.\nDEBUG:root:Created VIF OpaqueRef:6d07708c-71bc-47c2-941e-b4c77a8bf57a for VM OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa, network OpaqueRef:eff1853c-a45d-fa66-bced-50c1c3e286a2.\nDEBUG:root:Starting VM OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa...\nINFO:root:Spawning VM instance-137521447 created OpaqueRef:2e4954fb-1443-4540-e6fc-59f85c6700fa.\nINFO:root:(VM_UTILS) xenserver vm state -> |Running|\nINFO:root:(VM_UTILS) xenapi power_state -> |1|\nDEBUG:root:Instance instance-137521447: booted\nINFO:root:(VM_UTILS) xenserver vm state -> |Running|\nINFO:root:(VM_UTILS) xenapi power_state -> |1|\n\n\nThe instance is running and works. I was able to test locking, pause, unpause etc successfully.", 
            "date_created": "2010-12-30 05:23:37.367892+00:00", 
            "author": "https://api.launchpad.net/1.0/~tr3buchet"
        }, 
        {
            "content": "Also wanted to note that similar error cropped up all over the place while i was testing, but everything still worked.", 
            "date_created": "2010-12-30 05:24:12.967458+00:00", 
            "author": "https://api.launchpad.net/1.0/~tr3buchet"
        }, 
        {
            "content": "The instance_actions table has \"id\" as primary key, but \"id\" is not set in the dict at ./virt/xenapi_conn.py:243, so it defaults to 0... subsequent tries to record an instance action with id=0 will fail with \"primary key must be unique\" INSERT error.\r\n\r\nNot sure how Josh intended to make that id field unique, apparently instance_actions are only used in xenapi_conn.py:243 so far.", 
            "date_created": "2011-01-05 10:11:44.233721+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "It should be set automatically. I don't know why that isn't happening, so I'll investigate and put out a fix.", 
            "date_created": "2011-01-05 15:55:43.026624+00:00", 
            "author": "https://api.launchpad.net/1.0/~jk0"
        }, 
        {
            "content": "I am unable to reproduce this. To test, I wiped the database, pulled down trunk, created a new user/project/etc and fired up a brand new instance. The actions are being recorded as as expected:\n\nmysql> select * from instance_actions;\n+---------------------+------------+------------+---------+----+-------------+------------------------+-----------------------------------------------------------------------------------------------+\n| created_at          | updated_at | deleted_at | deleted | id | instance_id | action                 | error                                                                                         |\n+---------------------+------------+------------+---------+----+-------------+------------------------+-----------------------------------------------------------------------------------------------+\n| 2011-01-05 17:16:10 | NULL       | NULL       |       0 |  1 |           1 | Async.host.call_plugin | NULL                                                                                          |\n| 2011-01-05 17:16:11 | NULL       | NULL       |       0 |  2 |           1 | Async.host.call_plugin | NULL                                                                                          |\n| 2011-01-05 17:16:12 | NULL       | NULL       |       0 |  3 |           1 | Async.host.call_plugin | NULL                                                                                          |\n| 2011-01-05 17:17:18 | NULL       | NULL       |       0 |  4 |           1 | Async.VM.clean_reboot  | ['VM_BAD_POWER_STATE', 'OpaqueRef:1b3c13c6-b74a-f276-99f7-60c29160cb30', 'running', 'halted'] |\n| 2011-01-05 17:18:12 | NULL       | NULL       |       0 |  5 |           1 | Async.VM.clean_reboot  | ['VM_BAD_POWER_STATE', 'OpaqueRef:1b3c13c6-b74a-f276-99f7-60c29160cb30', 'running', 'halted'] |\n+---------------------+------------+------------+---------+----+-------------+------------------------+-----------------------------------------------------------------------------------------------+\n5 rows in set (0.00 sec)\n\nThe id column is populated automatically my SQLAlchemy.", 
            "date_created": "2011-01-05 17:31:48.826883+00:00", 
            "author": "https://api.launchpad.net/1.0/~jk0"
        }, 
        {
            "content": "i was using sqlite. Maybe that's the issue?", 
            "date_created": "2011-01-10 23:22:20.834722+00:00", 
            "author": "https://api.launchpad.net/1.0/~tr3buchet"
        }, 
        {
            "content": "Josh: could this be linked to Trey's usage of sqlite ?", 
            "date_created": "2011-01-24 16:54:51.386543+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "@jk0: any chance you could answer the above question, so that we unblock this bug ?", 
            "date_created": "2011-03-16 10:57:53.048826+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Thierry,\n\nSorry for the late response (this somehow escaped my attention). The fix for this was actually included in my XS-Rescue work that landed a week or two ago, making the instance_id optional (set to None by default).\n\nI will mark this as Fix Committed.", 
            "date_created": "2011-03-29 16:07:55.066201+00:00", 
            "author": "https://api.launchpad.net/1.0/~jk0"
        }
    ], 
    "closed": "2011-04-15 08:39:43.006359+00:00"
}