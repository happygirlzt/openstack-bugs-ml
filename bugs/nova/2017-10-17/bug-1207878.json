{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 12:00:04.469490+00:00", 
    "description": "Creating an instance on a network having a subnet without gateway fails with KeyError: 'gateway'.\n\nSteps to reproduce:\n1. Create a network\n2. Add a subnet without gateway\n3. Create an instance with config_drive enabled and use the previously created network.\n\nFor reference, nova-compute logs:\n\n2013-08-02 19:21:56.773 ERROR nova.compute.manager [req-b5d72291-1832-4cc0-be40-9be595ec9dd0 f366381eb11145e6b00559e6fba71cf2 5e20e1de6f344c1792e62354720051c4] [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] Instance failed to spawn\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] Traceback (most recent call last):\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1103, in _spawn\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]     block_device_info)\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1521, in spawn\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]     admin_pass=admin_password)\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1865, in _create_image\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]     content=files, extra_md=extra_md)\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]   File \"/usr/lib/python2.7/dist-packages/nova/api/metadata/base.py\", line 146, in __init__\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]     cfg = netutils.get_injected_network_template(network_info)\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]   File \"/usr/lib/python2.7/dist-packages/nova/virt/netutils.py\", line 100, in get_injected_network_template\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]     'gateway': mapping['gateway'],\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] KeyError: 'gateway'\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]\n2013-08-02 19:21:57.631 32237 ERROR nova.virt.libvirt.driver [-] [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] During wait destroy, instance disappeared.\n2013-08-02 19:21:57.787 ERROR nova.compute.manager [req-b5d72291-1832-4cc0-be40-9be595ec9dd0 f366381eb11145e6b00559e6fba71cf2 5e20e1de6f344c1792e62354720051c4] [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] Error: ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 848, in _run_instance\\n    set_access_ip=set_access_ip)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1107, in _spawn\\n    LOG.exception(_(\\'Instance failed to spawn\\'), instance=instance)\\n', '  File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\\n    self.gen.next()\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1103, in _spawn\\n    block_device_info)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1521, in spawn\\n    admin_pass=admin_password)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1865, in _create_image\\n    content=files, extra_md=extra_md)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/api/metadata/base.py\", line 146, in __init__\\n    cfg = netutils.get_injected_network_template(network_info)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/virt/netutils.py\", line 100, in get_injected_network_template\\n    \\'gateway\\': mapping[\\'gateway\\'],\\n', \"KeyError: 'gateway'\\n\"]", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1207878", 
    "owner": "https://api.launchpad.net/1.0/~mgagne", 
    "id": 1207878, 
    "index": 5183, 
    "openned": "2013-08-02 19:26:36.549169+00:00", 
    "created": "2013-08-02 19:26:36.549169+00:00", 
    "title": "Cannot create an instance on a subnet without gateway", 
    "comments": [
        {
            "content": "Creating an instance on a network having a subnet without gateway fails with KeyError: 'gateway'.\n\n2013-08-02 19:21:56.773 ERROR nova.compute.manager [req-b5d72291-1832-4cc0-be40-9be595ec9dd0 f366381eb11145e6b00559e6fba71cf2 5e20e1de6f344c1792e62354720051c4] [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] Instance failed to spawn\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] Traceback (most recent call last):\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1103, in _spawn\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]     block_device_info)\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1521, in spawn\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]     admin_pass=admin_password)\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1865, in _create_image\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]     content=files, extra_md=extra_md)\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]   File \"/usr/lib/python2.7/dist-packages/nova/api/metadata/base.py\", line 146, in __init__\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]     cfg = netutils.get_injected_network_template(network_info)\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]   File \"/usr/lib/python2.7/dist-packages/nova/virt/netutils.py\", line 100, in get_injected_network_template\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34]     'gateway': mapping['gateway'],\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] KeyError: 'gateway'\n2013-08-02 19:21:56.773 32237 TRACE nova.compute.manager [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] \n2013-08-02 19:21:57.631 32237 ERROR nova.virt.libvirt.driver [-] [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] During wait destroy, instance disappeared.\n2013-08-02 19:21:57.787 ERROR nova.compute.manager [req-b5d72291-1832-4cc0-be40-9be595ec9dd0 f366381eb11145e6b00559e6fba71cf2 5e20e1de6f344c1792e62354720051c4] [instance: 85df5518-24db-40e8-8f4d-d18ee8857d34] Error: ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 848, in _run_instance\\n    set_access_ip=set_access_ip)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1107, in _spawn\\n    LOG.exception(_(\\'Instance failed to spawn\\'), instance=instance)\\n', '  File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\\n    self.gen.next()\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1103, in _spawn\\n    block_device_info)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1521, in spawn\\n    admin_pass=admin_password)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 1865, in _create_image\\n    content=files, extra_md=extra_md)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/api/metadata/base.py\", line 146, in __init__\\n    cfg = netutils.get_injected_network_template(network_info)\\n', '  File \"/usr/lib/python2.7/dist-packages/nova/virt/netutils.py\", line 100, in get_injected_network_template\\n    \\'gateway\\': mapping[\\'gateway\\'],\\n', \"KeyError: 'gateway'\\n\"]", 
            "date_created": "2013-08-02 19:26:36.549169+00:00", 
            "author": "https://api.launchpad.net/1.0/~mgagne"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/34937\nCommitted: http://github.com/openstack/nova/commit/27fc4648b7cc3f748f7d6a56a778e61b1baf799f\nSubmitter: Jenkins\nBranch:    master\n\ncommit 27fc4648b7cc3f748f7d6a56a778e61b1baf799f\nAuthor: Mathieu Mitchell <email address hidden>\nDate:   Fri Jun 28 12:31:54 2013 -0400\n\n    Support networks without gateway\n    \n    Launching an instance when using network injection on a network\n    containing a subnet that has no gateway fails in scheduling with\n    a KeyError when using a legacy network_info provider and generates\n    an invalid network file for the others.\n    \n    The following changes were done:\n    \n    * The legacy transformer for network_info now always provides\n      a gateway/gateway_v6 field, with a value of None if no gateway\n      is available (this is similar to the other fields that are empty).\n    * The interfaces template was modified to include the gateway line\n      only if a gateway is provided for the interface.\n    \n    Fixes: bug #1207878\n    Change-Id: I887757a6bcba528059ace8831a7d23a31b08c630\n", 
            "date_created": "2013-08-20 23:11:34.805796+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-09-05 15:44:23.103892+00:00"
}