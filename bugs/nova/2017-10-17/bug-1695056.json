{
    "status": "In Progress", 
    "last_updated": "2017-09-04 10:43:44.018830+00:00", 
    "description": "Trying to use this feature on newton,\nhttps://specs.openstack.org/openstack/nova-specs/specs/mitaka/implemented/libvirt-real-time.html\n\nIs low latency (realtime) kernel a requirement?\nAnyway, I'm using 4.4.0-78-lowlatency now, following failed\n(It worked if I manually copy out the portion before <devices> into virsh xml with addition of <memtune>)\n\n  <memtune>\n    <hard_limit unit='KiB'>20971520</hard_limit>\n  </memtune>\n\nwarning: host doesn't support requested feature: CPUID.01H:EDX.ds [bit 21]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.acpi [bit 22]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.ht [bit 28]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.tm [bit 29]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.pbe [bit 31]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.dtes64 [bit 2]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.monitor [bit 3]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.ds_cpl [bit 4]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.smx [bit 6]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.est [bit 7]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.tm2 [bit 8]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.xtpr [bit 14]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.pdcm [bit 15]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.dca [bit 18]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.osxsave [bit 27]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.ds [bit 21]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.acpi [bit 22]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.ht [bit 28]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.tm [bit 29]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.pbe [bit 31]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.dtes64 [bit 2]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.monitor [bit 3]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.ds_cpl [bit 4]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.smx [bit 6]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.est [bit 7]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.tm2 [bit 8]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.xtpr [bit 14]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.pdcm [bit 15]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.dca [bit 18]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.osxsave [bit 27]\nmlockall: Cannot allocate memory\n2017-06-01T14:47:43.122805Z qemu-system-x86_64: locking memory failed\n\n\n>>>> this is generated by openstack\n<domain type='kvm' id='13'>\n  <name>instance-0000005f</name>\n  <uuid>de8a2358-f5cb-426a-ad2b-840f5f6ddfcf</uuid>\n  <metadata>\n    <nova:instance xmlns:nova=\"http://openstack.org/xmlns/libvirt/nova/1.0\">\n      <nova:package version=\"14.0.4\"/>\n      <nova:name>vlns1_pfe</nova:name>\n      <nova:creationTime>2017-06-01 13:33:29</nova:creationTime>\n      <nova:flavor name=\"vfpfl\">\n        <nova:memory>12288</nova:memory>\n        <nova:disk>4</nova:disk>\n        <nova:swap>0</nova:swap>\n        <nova:ephemeral>0</nova:ephemeral>\n        <nova:vcpus>12</nova:vcpus>\n      </nova:flavor>\n      <nova:owner>\n        <nova:user uuid=\"50f2aa60006047198e8181e5d1ff2173\">admin</nova:user>\n        <nova:project uuid=\"3f79af00c3bc455f99adcde0826ca1ce\">admin</nova:project>\n      </nova:owner>\n      <nova:root type=\"image\" uuid=\"0d954553-8d39-402b-9190-8fc034b38351\"/>\n    </nova:instance>\n  </metadata>\n  <memory unit='KiB'>12582912</memory>\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <memoryBacking>\n    <hugepages>\n      <page size='2048' unit='KiB' nodeset='0'/>\n    </hugepages>\n    <nosharepages/>\n    <locked/>\n  </memoryBacking>\n  <vcpu placement='static'>12</vcpu>\n  <cputune>\n    <shares>12288</shares>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='17'/>\n    <vcpupin vcpu='2' cpuset='0'/>\n    <vcpupin vcpu='3' cpuset='16'/>\n    <vcpupin vcpu='4' cpuset='3'/>\n    <vcpupin vcpu='5' cpuset='19'/>\n    <vcpupin vcpu='6' cpuset='6'/>\n    <vcpupin vcpu='7' cpuset='22'/>\n    <vcpupin vcpu='8' cpuset='4'/>\n    <vcpupin vcpu='9' cpuset='20'/>\n    <vcpupin vcpu='10' cpuset='7'/>\n    <vcpupin vcpu='11' cpuset='23'/>\n    <emulatorpin cpuset='1'/>\n    <vcpusched vcpus='1-11' scheduler='fifo' priority='1'/>\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n    <memnode cellid='0' mode='strict' nodeset='0'/>\n  </numatune>\n  <resource>\n    <partition>/machine</partition>\n  </resource>\n  <sysinfo type='smbios'>\n    <system>\n      <entry name='manufacturer'>OpenStack Foundation</entry>\n      <entry name='product'>OpenStack Nova</entry>\n      <entry name='version'>14.0.4</entry>\n      <entry name='serial'>06b68615-3f83-4484-b195-0d68d5d67077</entry>\n      <entry name='uuid'>de8a2358-f5cb-426a-ad2b-840f5f6ddfcf</entry>\n      <entry name='family'>Virtual Machine</entry>\n    </system>\n  </sysinfo>\n  <os>\n    <type arch='x86_64' machine='pc-i440fx-xenial'>hvm</type>\n    <boot dev='hd'/>\n    <smbios mode='sysinfo'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n  </features>\n  <cpu mode='host-model'>\n    <model fallback='allow'/>\n    <topology sockets='6' cores='1' threads='2'/>\n    <numa>\n      <cell id='0' cpus='0-11' memory='12582912' unit='KiB' memAccess='shared'/>\n    </numa>\n  </cpu>\n  <clock offset='utc'>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <devices>\n    <emulator>/usr/bin/kvm-spice</emulator>\n    <disk type='network' device='disk'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <auth username='nova'>\n        <secret type='ceph' uuid='f8d2c231-1e4b-4fe3-8f55-eef652966ec5'/>\n      </auth>\n      <source protocol='rbd' name='vms/de8a2358-f5cb-426a-ad2b-840f5f6ddfcf_disk'>\n        <host name='192.168.30.111' port='6789'/>\n        <host name='192.168.30.112' port='6789'/>\n        <host name='192.168.30.113' port='6789'/>\n      </source>\n      <backingStore/>\n      <target dev='hda' bus='ide'/>\n      <alias name='ide0-0-0'/>\n      <address type='drive' controller='0' bus='0' target='0' unit='0'/>\n    </disk>\n    <disk type='network' device='cdrom'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <auth username='nova'>\n        <secret type='ceph' uuid='f8d2c231-1e4b-4fe3-8f55-eef652966ec5'/>\n      </auth>\n      <source protocol='rbd' name='vms/de8a2358-f5cb-426a-ad2b-840f5f6ddfcf_disk.config'>\n        <host name='192.168.30.111' port='6789'/>\n        <host name='192.168.30.112' port='6789'/>\n        <host name='192.168.30.113' port='6789'/>\n      </source>\n      <backingStore/>\n      <target dev='hdb' bus='ide'/>\n      <readonly/>\n      <alias name='ide0-0-1'/>\n      <address type='drive' controller='0' bus='0' target='0' unit='1'/>\n    </disk>\n    <controller type='usb' index='0'>\n      <alias name='usb'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/>\n    </controller>\n    <controller type='pci' index='0' model='pci-root'>\n      <alias name='pci.0'/>\n    </controller>\n    <controller type='ide' index='0'>\n      <alias name='ide'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/>\n    </controller>\n    <interface type='bridge'>\n      <mac address='fa:16:3e:bc:b1:33'/>\n      <source bridge='br-int'/>\n      <virtualport type='openvswitch'>\n        <parameters interfaceid='24dbd5a2-84cd-48d9-b987-7f0def3bd2bf'/>\n      </virtualport>\n      <target dev='tap24dbd5a2-84'/>\n      <model type='virtio'/>\n      <alias name='net0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </interface>\n    <interface type='bridge'>\n      <mac address='fa:16:3e:e9:b5:61'/>\n      <source bridge='br-int'/>\n      <virtualport type='openvswitch'>\n        <parameters interfaceid='619b47e3-d60c-4bce-8404-843cb3c2867f'/>\n      </virtualport>\n      <target dev='tap619b47e3-d6'/>\n      <model type='virtio'/>\n      <alias name='net1'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </interface>\n    <interface type='hostdev' managed='yes'>\n      <mac address='fa:16:3e:31:30:b4'/>\n      <driver name='vfio'/>\n      <source>\n        <address type='pci' domain='0x0000' bus='0x02' slot='0x10' function='0x2'/>\n      </source>\n      <vlan>\n        <tag id='31'/>\n      </vlan>\n      <alias name='hostdev0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>\n    </interface>\n    <interface type='hostdev' managed='yes'>\n      <mac address='fa:16:3e:6a:cd:d7'/>\n      <driver name='vfio'/>\n      <source>\n        <address type='pci' domain='0x0000' bus='0x02' slot='0x10' function='0x0'/>\n      </source>\n      <vlan>\n        <tag id='32'/>\n      </vlan>\n      <alias name='hostdev1'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>\n    </interface>\n    <serial type='tcp'>\n      <source mode='bind' host='127.0.0.1' service='10000'/>\n      <protocol type='raw'/>\n      <target port='0'/>\n      <alias name='serial0'/>\n    </serial>\n    <serial type='pty'>\n      <target port='1'/>\n      <alias name='serial1'/>\n    </serial>\n    <console type='tcp'>\n      <source mode='bind' host='127.0.0.1' service='10000'/>\n      <protocol type='raw'/>\n      <target type='serial' port='0'/>\n      <alias name='serial0'/>\n    </console>\n    <input type='tablet' bus='usb'>\n      <alias name='input0'/>\n    </input>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n    <graphics type='vnc' port='5902' autoport='yes' listen='0.0.0.0' keymap='en-us'>\n      <listen type='address' address='0.0.0.0'/>\n    </graphics>\n    <video>\n      <model type='cirrus' vram='16384' heads='1'/>\n      <alias name='video0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>\n    </video>\n    <memballoon model='virtio'>\n      <stats period='10'/>\n      <alias name='balloon0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>\n    </memballoon>\n  </devices>\n  <seclabel type='dynamic' model='apparmor' relabel='yes'>\n    <label>libvirt-de8a2358-f5cb-426a-ad2b-840f5f6ddfcf</label>\n    <imagelabel>libvirt-de8a2358-f5cb-426a-ad2b-840f5f6ddfcf</imagelabel>\n  </seclabel>\n</domain>\n\n\n>>>>> this tested good with addition of memtune\n<domain type='kvm' id='4'>\n  <name>vlns-pfe</name>\n  <uuid>9d5e4b00-ffac-4e9d-9d97-70ad3ac1de2c</uuid>\n  <memory unit='KiB'>12582912</memory>\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <memtune>\n    <hard_limit unit='KiB'>20971520</hard_limit>\n  </memtune>\n  <memoryBacking>\n    <hugepages>\n      <page size='2048' unit='KiB' nodeset='0'/>\n    </hugepages>\n    <nosharepages/>\n    <locked/>\n  </memoryBacking>\n  <vcpu placement='static'>12</vcpu>\n  <cputune>\n    <shares>12288</shares>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='17'/>\n    <vcpupin vcpu='2' cpuset='0'/>\n    <vcpupin vcpu='3' cpuset='16'/>\n    <vcpupin vcpu='4' cpuset='3'/>\n    <vcpupin vcpu='5' cpuset='19'/>\n    <vcpupin vcpu='6' cpuset='6'/>\n    <vcpupin vcpu='7' cpuset='22'/>\n    <vcpupin vcpu='8' cpuset='4'/>\n    <vcpupin vcpu='9' cpuset='20'/>\n    <vcpupin vcpu='10' cpuset='7'/>\n    <vcpupin vcpu='11' cpuset='23'/>\n    <emulatorpin cpuset='1'/>\n    <vcpusched vcpus='1-11' scheduler='fifo' priority='1'/>\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n    <memnode cellid='0' mode='strict' nodeset='0'/>\n  </numatune>\n  <resource>\n    <partition>/machine</partition>\n  </resource>\n  <os>\n    <type arch='x86_64' machine='pc-i440fx-xenial'>hvm</type>\n    <boot dev='hd'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n  </features>\n  <cpu mode='host-model'>\n    <model fallback='allow'/>\n    <topology sockets='6' cores='1' threads='2'/>\n    <numa>\n      <cell id='0' cpus='0-11' memory='12582912' unit='KiB' memAccess='shared'/>\n    </numa>\n  </cpu>\n  <clock offset='utc'>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>", 
    "tags": [
        "libvirt", 
        "openstack-version.newton"
    ], 
    "importance": "Undecided", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1695056", 
    "owner": "https://api.launchpad.net/1.0/~sahid-ferdjaoui", 
    "id": 1695056, 
    "index": 8143, 
    "openned": "2017-06-01 18:06:48.300400+00:00", 
    "created": "2017-06-01 18:06:48.300400+00:00", 
    "title": "nova version: newton , libvirt realtime feature mlockall: Cannot allocate memory", 
    "comments": [
        {
            "content": "Trying to use this feature on newton,\nhttps://specs.openstack.org/openstack/nova-specs/specs/mitaka/implemented/libvirt-real-time.html\n\nIs low latency (realtime) kernel a requirement?\nAnyway, I'm using 4.4.0-78-lowlatency now, following failed\n(It worked if I manually copy out the portion before <devices> into virsh xml with addition of <memtune>)\n\n  <memtune>\n    <hard_limit unit='KiB'>20971520</hard_limit>\n  </memtune>\n\nwarning: host doesn't support requested feature: CPUID.01H:EDX.ds [bit 21]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.acpi [bit 22]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.ht [bit 28]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.tm [bit 29]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.pbe [bit 31]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.dtes64 [bit 2]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.monitor [bit 3]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.ds_cpl [bit 4]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.smx [bit 6]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.est [bit 7]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.tm2 [bit 8]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.xtpr [bit 14]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.pdcm [bit 15]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.dca [bit 18]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.osxsave [bit 27]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.ds [bit 21]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.acpi [bit 22]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.ht [bit 28]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.tm [bit 29]\nwarning: host doesn't support requested feature: CPUID.01H:EDX.pbe [bit 31]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.dtes64 [bit 2]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.monitor [bit 3]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.ds_cpl [bit 4]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.smx [bit 6]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.est [bit 7]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.tm2 [bit 8]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.xtpr [bit 14]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.pdcm [bit 15]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.dca [bit 18]\nwarning: host doesn't support requested feature: CPUID.01H:ECX.osxsave [bit 27]\nmlockall: Cannot allocate memory\n2017-06-01T14:47:43.122805Z qemu-system-x86_64: locking memory failed\n\n\n>>>> this is generated by openstack\n<domain type='kvm' id='13'>\n  <name>instance-0000005f</name>\n  <uuid>de8a2358-f5cb-426a-ad2b-840f5f6ddfcf</uuid>\n  <metadata>\n    <nova:instance xmlns:nova=\"http://openstack.org/xmlns/libvirt/nova/1.0\">\n      <nova:package version=\"14.0.4\"/>\n      <nova:name>vlns1_pfe</nova:name>\n      <nova:creationTime>2017-06-01 13:33:29</nova:creationTime>\n      <nova:flavor name=\"vfpfl\">\n        <nova:memory>12288</nova:memory>\n        <nova:disk>4</nova:disk>\n        <nova:swap>0</nova:swap>\n        <nova:ephemeral>0</nova:ephemeral>\n        <nova:vcpus>12</nova:vcpus>\n      </nova:flavor>\n      <nova:owner>\n        <nova:user uuid=\"50f2aa60006047198e8181e5d1ff2173\">admin</nova:user>\n        <nova:project uuid=\"3f79af00c3bc455f99adcde0826ca1ce\">admin</nova:project>\n      </nova:owner>\n      <nova:root type=\"image\" uuid=\"0d954553-8d39-402b-9190-8fc034b38351\"/>\n    </nova:instance>\n  </metadata>\n  <memory unit='KiB'>12582912</memory>\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <memoryBacking>\n    <hugepages>\n      <page size='2048' unit='KiB' nodeset='0'/>\n    </hugepages>\n    <nosharepages/>\n    <locked/>\n  </memoryBacking>\n  <vcpu placement='static'>12</vcpu>\n  <cputune>\n    <shares>12288</shares>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='17'/>\n    <vcpupin vcpu='2' cpuset='0'/>\n    <vcpupin vcpu='3' cpuset='16'/>\n    <vcpupin vcpu='4' cpuset='3'/>\n    <vcpupin vcpu='5' cpuset='19'/>\n    <vcpupin vcpu='6' cpuset='6'/>\n    <vcpupin vcpu='7' cpuset='22'/>\n    <vcpupin vcpu='8' cpuset='4'/>\n    <vcpupin vcpu='9' cpuset='20'/>\n    <vcpupin vcpu='10' cpuset='7'/>\n    <vcpupin vcpu='11' cpuset='23'/>\n    <emulatorpin cpuset='1'/>\n    <vcpusched vcpus='1-11' scheduler='fifo' priority='1'/>\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n    <memnode cellid='0' mode='strict' nodeset='0'/>\n  </numatune>\n  <resource>\n    <partition>/machine</partition>\n  </resource>\n  <sysinfo type='smbios'>\n    <system>\n      <entry name='manufacturer'>OpenStack Foundation</entry>\n      <entry name='product'>OpenStack Nova</entry>\n      <entry name='version'>14.0.4</entry>\n      <entry name='serial'>06b68615-3f83-4484-b195-0d68d5d67077</entry>\n      <entry name='uuid'>de8a2358-f5cb-426a-ad2b-840f5f6ddfcf</entry>\n      <entry name='family'>Virtual Machine</entry>\n    </system>\n  </sysinfo>\n  <os>\n    <type arch='x86_64' machine='pc-i440fx-xenial'>hvm</type>\n    <boot dev='hd'/>\n    <smbios mode='sysinfo'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n  </features>\n  <cpu mode='host-model'>\n    <model fallback='allow'/>\n    <topology sockets='6' cores='1' threads='2'/>\n    <numa>\n      <cell id='0' cpus='0-11' memory='12582912' unit='KiB' memAccess='shared'/>\n    </numa>\n  </cpu>\n  <clock offset='utc'>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <devices>\n    <emulator>/usr/bin/kvm-spice</emulator>\n    <disk type='network' device='disk'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <auth username='nova'>\n        <secret type='ceph' uuid='f8d2c231-1e4b-4fe3-8f55-eef652966ec5'/>\n      </auth>\n      <source protocol='rbd' name='vms/de8a2358-f5cb-426a-ad2b-840f5f6ddfcf_disk'>\n        <host name='192.168.30.111' port='6789'/>\n        <host name='192.168.30.112' port='6789'/>\n        <host name='192.168.30.113' port='6789'/>\n      </source>\n      <backingStore/>\n      <target dev='hda' bus='ide'/>\n      <alias name='ide0-0-0'/>\n      <address type='drive' controller='0' bus='0' target='0' unit='0'/>\n    </disk>\n    <disk type='network' device='cdrom'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <auth username='nova'>\n        <secret type='ceph' uuid='f8d2c231-1e4b-4fe3-8f55-eef652966ec5'/>\n      </auth>\n      <source protocol='rbd' name='vms/de8a2358-f5cb-426a-ad2b-840f5f6ddfcf_disk.config'>\n        <host name='192.168.30.111' port='6789'/>\n        <host name='192.168.30.112' port='6789'/>\n        <host name='192.168.30.113' port='6789'/>\n      </source>\n      <backingStore/>\n      <target dev='hdb' bus='ide'/>\n      <readonly/>\n      <alias name='ide0-0-1'/>\n      <address type='drive' controller='0' bus='0' target='0' unit='1'/>\n    </disk>\n    <controller type='usb' index='0'>\n      <alias name='usb'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/>\n    </controller>\n    <controller type='pci' index='0' model='pci-root'>\n      <alias name='pci.0'/>\n    </controller>\n    <controller type='ide' index='0'>\n      <alias name='ide'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/>\n    </controller>\n    <interface type='bridge'>\n      <mac address='fa:16:3e:bc:b1:33'/>\n      <source bridge='br-int'/>\n      <virtualport type='openvswitch'>\n        <parameters interfaceid='24dbd5a2-84cd-48d9-b987-7f0def3bd2bf'/>\n      </virtualport>\n      <target dev='tap24dbd5a2-84'/>\n      <model type='virtio'/>\n      <alias name='net0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </interface>\n    <interface type='bridge'>\n      <mac address='fa:16:3e:e9:b5:61'/>\n      <source bridge='br-int'/>\n      <virtualport type='openvswitch'>\n        <parameters interfaceid='619b47e3-d60c-4bce-8404-843cb3c2867f'/>\n      </virtualport>\n      <target dev='tap619b47e3-d6'/>\n      <model type='virtio'/>\n      <alias name='net1'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </interface>\n    <interface type='hostdev' managed='yes'>\n      <mac address='fa:16:3e:31:30:b4'/>\n      <driver name='vfio'/>\n      <source>\n        <address type='pci' domain='0x0000' bus='0x02' slot='0x10' function='0x2'/>\n      </source>\n      <vlan>\n        <tag id='31'/>\n      </vlan>\n      <alias name='hostdev0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>\n    </interface>\n    <interface type='hostdev' managed='yes'>\n      <mac address='fa:16:3e:6a:cd:d7'/>\n      <driver name='vfio'/>\n      <source>\n        <address type='pci' domain='0x0000' bus='0x02' slot='0x10' function='0x0'/>\n      </source>\n      <vlan>\n        <tag id='32'/>\n      </vlan>\n      <alias name='hostdev1'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>\n    </interface>\n    <serial type='tcp'>\n      <source mode='bind' host='127.0.0.1' service='10000'/>\n      <protocol type='raw'/>\n      <target port='0'/>\n      <alias name='serial0'/>\n    </serial>\n    <serial type='pty'>\n      <target port='1'/>\n      <alias name='serial1'/>\n    </serial>\n    <console type='tcp'>\n      <source mode='bind' host='127.0.0.1' service='10000'/>\n      <protocol type='raw'/>\n      <target type='serial' port='0'/>\n      <alias name='serial0'/>\n    </console>\n    <input type='tablet' bus='usb'>\n      <alias name='input0'/>\n    </input>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n    <graphics type='vnc' port='5902' autoport='yes' listen='0.0.0.0' keymap='en-us'>\n      <listen type='address' address='0.0.0.0'/>\n    </graphics>\n    <video>\n      <model type='cirrus' vram='16384' heads='1'/>\n      <alias name='video0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>\n    </video>\n    <memballoon model='virtio'>\n      <stats period='10'/>\n      <alias name='balloon0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>\n    </memballoon>\n  </devices>\n  <seclabel type='dynamic' model='apparmor' relabel='yes'>\n    <label>libvirt-de8a2358-f5cb-426a-ad2b-840f5f6ddfcf</label>\n    <imagelabel>libvirt-de8a2358-f5cb-426a-ad2b-840f5f6ddfcf</imagelabel>\n  </seclabel>\n</domain>\n\n\n>>>>> this tested good with addition of memtune\n<domain type='kvm' id='4'>\n  <name>vlns-pfe</name>\n  <uuid>9d5e4b00-ffac-4e9d-9d97-70ad3ac1de2c</uuid>\n  <memory unit='KiB'>12582912</memory>\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <memtune>\n    <hard_limit unit='KiB'>20971520</hard_limit>\n  </memtune>\n  <memoryBacking>\n    <hugepages>\n      <page size='2048' unit='KiB' nodeset='0'/>\n    </hugepages>\n    <nosharepages/>\n    <locked/>\n  </memoryBacking>\n  <vcpu placement='static'>12</vcpu>\n  <cputune>\n    <shares>12288</shares>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='17'/>\n    <vcpupin vcpu='2' cpuset='0'/>\n    <vcpupin vcpu='3' cpuset='16'/>\n    <vcpupin vcpu='4' cpuset='3'/>\n    <vcpupin vcpu='5' cpuset='19'/>\n    <vcpupin vcpu='6' cpuset='6'/>\n    <vcpupin vcpu='7' cpuset='22'/>\n    <vcpupin vcpu='8' cpuset='4'/>\n    <vcpupin vcpu='9' cpuset='20'/>\n    <vcpupin vcpu='10' cpuset='7'/>\n    <vcpupin vcpu='11' cpuset='23'/>\n    <emulatorpin cpuset='1'/>\n    <vcpusched vcpus='1-11' scheduler='fifo' priority='1'/>\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n    <memnode cellid='0' mode='strict' nodeset='0'/>\n  </numatune>\n  <resource>\n    <partition>/machine</partition>\n  </resource>\n  <os>\n    <type arch='x86_64' machine='pc-i440fx-xenial'>hvm</type>\n    <boot dev='hd'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n  </features>\n  <cpu mode='host-model'>\n    <model fallback='allow'/>\n    <topology sockets='6' cores='1' threads='2'/>\n    <numa>\n      <cell id='0' cpus='0-11' memory='12582912' unit='KiB' memAccess='shared'/>\n    </numa>\n  </cpu>\n  <clock offset='utc'>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>", 
            "date_created": "2017-06-01 18:06:48.300400+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Which version of libvirt / qemu do you have installed?", 
            "date_created": "2017-06-02 12:48:15.616790+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "root@TS01:~# libvirtd --version\nlibvirtd (libvirt) 1.3.1\nroot@TS01:~# kvm --version\nQEMU emulator version 2.5.0 (Debian 1:2.5+dfsg-5ubuntu10.14), Copyright (c) 2003-2008 Fabrice Bellard\n", 
            "date_created": "2017-06-02 13:27:38.732877+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "It's a limitation of your host, when using hugepages the memory is locked, reserved, you can consider setting this limit in /etc/security/limits.conf", 
            "date_created": "2017-06-02 14:28:54.651617+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "My main intention for this feature is to secure emulator pin, not the locked memory but it cannot be disabled,\n\nI have it set to unlimited, didn't help here,\n\nlibvirt-qemu     -       memlock         unlimited\nroot             -       memlock         unlimited\n\nAlso according to Redhat doc, \nWhen setting locked, a hard_limit must be set in the <memtune> element to the maximum memory configured for the guest, plus any memory consumed by the process itself.\n\nhttps://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/Virtualization_Tuning_and_Optimization_Guide/index.html", 
            "date_created": "2017-06-02 16:51:15.200672+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Went over a bug in redhat with similar symptom, seems <memtune><hard_limit> needs to be exposed in order for <locked> to function well in this feature,\n\n\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1316774", 
            "date_created": "2017-06-06 13:27:52.223866+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Default hard_limit is unlimited, but VM couldn't start as it needs real numbers, allocating 12G for guest with two vfio NIC, so had to set hard_limit to 15G to make it work,\nSince I'm using HEAT to provision the VM, is there method to preset these values?\n\nBefore,\nvroot@TS01:~# virsh memtune vlns-pfe\nhard_limit     : unlimited\nsoft_limit     : unlimited\nswap_hard_limit: unlimited\n\nAfter,\nroot@TS01:~# virsh memtune vlns-pfe\nhard_limit     : 15000000\nsoft_limit     : unlimited\nswap_hard_limit: unlimited", 
            "date_created": "2017-06-07 13:30:54.076923+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Hi Sahid,\n\nWondering if there is concern to disable these in driver.py as a temporary workaround? I have hugepage enabled for KVM, with KSM disabled.\n\n        if wantsrealtime:\n            if not membacking:\n                membacking = vconfig.LibvirtConfigGuestMemoryBacking()\n            #membacking.locked = True\n            #membacking.sharedpages = False\n\nMeanwhile wondering if there can be enhancement to not enforce locked option if openstack flavor already has hugepage enabled, otherwise this feature doesnt work with newer libvirt,\n\n\"hw:mem_page_size\": \"2048\", \n\"hw:numa_nodes\": \"1\", \n\"hw:cpu_realtime_mask\": \"^0\", \n\"hw:cpu_realtime\": \"yes\"\n\n", 
            "date_created": "2017-06-07 14:20:04.420876+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "I don't think it something we want, even if you have disable KSM it's not a generality. For realtime we want reduce the latency not the memory consumption.\n\nWhat we need to do is to specifically set the hard limit when using locked memory.", 
            "date_created": "2017-06-08 07:28:40.790930+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Wei Zhu, can you test this and let me know the result?\n\n\ndiff --git a/nova/virt/libvirt/driver.py b/nova/virt/libvirt/driver.py\nindex 18005ec..cade2ee 100644\n--- a/nova/virt/libvirt/driver.py\n+++ b/nova/virt/libvirt/driver.py\n@@ -4736,6 +4736,9 @@ class LibvirtDriver(driver.ComputeDriver):\n             instance.numa_topology,\n             guest_numa_config.numatune,\n             flavor)\n+        if guest.membacking and guest.membacking.locked:\n+            guest.memtune = vconfig.LibvirtConfigGuestMemoryTune()\n+            guest.memtune.hard_limit = guest.memory\n \n         guest.metadata.append(self._get_guest_config_meta(instance))\n         guest.idmaps = self._get_guest_idmaps()", 
            "date_created": "2017-06-08 08:50:12.444703+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "https://paste.fedoraproject.org/paste/4EQYNVchSp-gvHKivpqp6l5M1UNdIGYhyRLivL9gydE=", 
            "date_created": "2017-06-08 08:51:42.072568+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Thanks Sahid, so the hard-limit is set to guest memory,\nIn my previous example, guest memory is 12288, I have two vfio host interfaces I read somewhere they need 1g memory each, so I had to make hard-limit 15000 even 14000 didnt work.\nCan we expose hard-limit as a new flavor key?\n\n\nlocked\nWhen set and supported by the hypervisor, memory pages belonging to the domain will be locked in host's memory and the host will not be allowed to swap them out, which might be required for some workloads such as real-time. For QEMU/KVM guests, the memory used by the QEMU process itself will be locked too: unlike guest memory, this is an amount libvirt has no way of figuring out in advance, so it has to remove the limit on locked memory altogether. Thus, enabling this option opens up to a potential security risk: the host will be unable to reclaim the locked memory back from the guest when it's running out of memory, which means a malicious guest allocating large amounts of locked memory could cause a denial-of-service attach on the host. Because of this, using this option is discouraged unless your workload demands it; even then, it's highly recommended to set an hard_limit (see memory tuning) on memory allocation suitable for the specific environment at the same time to mitigate the risks described above. Since 1.0.6", 
            "date_created": "2017-06-08 10:31:19.676250+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "I made the change per comment #9, VM couldn't start as hard_limit is not enough (comment #11)\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <memtune>\n    <hard_limit unit='KiB'>12582912</hard_limit>\n  </memtune>\n\nSo hardcoded hard_limit in driver.py instead and VM starts well\n   guest.memtune.hard_limit = 20000000\n\nHere is the full xml\n\n<domain type='kvm' id='43'>\n  <name>instance-000000a7</name>\n  <uuid>b4b9e187-3df3-4b0c-bbb2-ccb11a90c58e</uuid>\n  <metadata>\n    <nova:instance xmlns:nova=\"http://openstack.org/xmlns/libvirt/nova/1.0\">\n      <nova:package version=\"14.0.4\"/>\n      <nova:name>vlns1_pfe</nova:name>\n      <nova:creationTime>2017-06-08 12:32:47</nova:creationTime>\n      <nova:flavor name=\"vfpfl\">\n        <nova:memory>12288</nova:memory>\n        <nova:disk>4</nova:disk>\n        <nova:swap>0</nova:swap>\n        <nova:ephemeral>0</nova:ephemeral>\n        <nova:vcpus>12</nova:vcpus>\n      </nova:flavor>\n      <nova:owner>\n        <nova:user uuid=\"50f2aa60006047198e8181e5d1ff2173\">admin</nova:user>\n        <nova:project uuid=\"3f79af00c3bc455f99adcde0826ca1ce\">admin</nova:project>\n      </nova:owner>\n      <nova:root type=\"image\" uuid=\"0d954553-8d39-402b-9190-8fc034b38351\"/>\n    </nova:instance>\n  </metadata>\n  <memory unit='KiB'>12582912</memory>\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <memtune>\n    <hard_limit unit='KiB'>20000000</hard_limit>\n  </memtune>\n  <memoryBacking>\n    <hugepages>\n      <page size='2048' unit='KiB' nodeset='0'/>\n    </hugepages>\n    <nosharepages/>\n    <locked/>\n  </memoryBacking>\n  <vcpu placement='static'>12</vcpu>\n  <cputune>\n    <shares>12288</shares>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='17'/>\n    <vcpupin vcpu='2' cpuset='0'/>\n    <vcpupin vcpu='3' cpuset='16'/>\n    <vcpupin vcpu='4' cpuset='3'/>\n    <vcpupin vcpu='5' cpuset='19'/>\n    <vcpupin vcpu='6' cpuset='6'/>\n    <vcpupin vcpu='7' cpuset='22'/>\n    <vcpupin vcpu='8' cpuset='4'/>\n    <vcpupin vcpu='9' cpuset='20'/>\n    <vcpupin vcpu='10' cpuset='7'/>\n    <vcpupin vcpu='11' cpuset='23'/>\n    <emulatorpin cpuset='1'/>\n    <vcpusched vcpus='1-11' scheduler='fifo' priority='1'/>\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n    <memnode cellid='0' mode='strict' nodeset='0'/>\n  </numatune>\n  <resource>\n    <partition>/machine</partition>\n  </resource>\n  <sysinfo type='smbios'>\n    <system>\n      <entry name='manufacturer'>OpenStack Foundation</entry>\n      <entry name='product'>OpenStack Nova</entry>\n      <entry name='version'>14.0.4</entry>\n      <entry name='serial'>06b68615-3f83-4484-b195-0d68d5d67077</entry>\n      <entry name='uuid'>b4b9e187-3df3-4b0c-bbb2-ccb11a90c58e</entry>\n      <entry name='family'>Virtual Machine</entry>\n    </system>\n  </sysinfo>\n  <os>\n    <type arch='x86_64' machine='pc-i440fx-xenial'>hvm</type>\n    <boot dev='hd'/>\n    <smbios mode='sysinfo'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n  </features>\n  <cpu mode='host-model'>\n    <model fallback='allow'/>\n    <topology sockets='6' cores='1' threads='2'/>\n    <numa>\n      <cell id='0' cpus='0-11' memory='12582912' unit='KiB' memAccess='shared'/>\n    </numa>\n  </cpu>\n  <clock offset='utc'>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <devices>\n    <emulator>/usr/bin/kvm-spice</emulator>\n    <disk type='network' device='disk'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <auth username='nova'>\n        <secret type='ceph' uuid='f8d2c231-1e4b-4fe3-8f55-eef652966ec5'/>\n      </auth>\n      <source protocol='rbd' name='vms/b4b9e187-3df3-4b0c-bbb2-ccb11a90c58e_disk'>\n        <host name='192.168.30.111' port='6789'/>\n        <host name='192.168.30.112' port='6789'/>\n        <host name='192.168.30.113' port='6789'/>\n      </source>\n      <backingStore/>\n      <target dev='hda' bus='ide'/>\n      <alias name='ide0-0-0'/>\n      <address type='drive' controller='0' bus='0' target='0' unit='0'/>\n    </disk>\n    <disk type='network' device='cdrom'>\n      <driver name='qemu' type='raw' cache='none'/>\n      <auth username='nova'>\n        <secret type='ceph' uuid='f8d2c231-1e4b-4fe3-8f55-eef652966ec5'/>\n      </auth>\n      <source protocol='rbd' name='vms/b4b9e187-3df3-4b0c-bbb2-ccb11a90c58e_disk.config'>\n        <host name='192.168.30.111' port='6789'/>\n        <host name='192.168.30.112' port='6789'/>\n        <host name='192.168.30.113' port='6789'/>\n      </source>\n      <backingStore/>\n      <target dev='hdb' bus='ide'/>\n      <readonly/>\n      <alias name='ide0-0-1'/>\n      <address type='drive' controller='0' bus='0' target='0' unit='1'/>\n    </disk>\n    <controller type='usb' index='0'>\n      <alias name='usb'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/>\n    </controller>\n    <controller type='pci' index='0' model='pci-root'>\n      <alias name='pci.0'/>\n    </controller>\n    <controller type='ide' index='0'>\n      <alias name='ide'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/>\n    </controller>\n    <interface type='bridge'>\n      <mac address='fa:16:3e:37:3a:fa'/>\n      <source bridge='br-int'/>\n      <virtualport type='openvswitch'>\n        <parameters interfaceid='91bdd768-e8fd-478c-be9a-6604d4b9d01c'/>\n      </virtualport>\n      <target dev='tap91bdd768-e8'/>\n      <model type='virtio'/>\n      <alias name='net0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </interface>\n    <interface type='bridge'>\n      <mac address='fa:16:3e:a4:a2:3e'/>\n      <source bridge='br-int'/>\n      <virtualport type='openvswitch'>\n        <parameters interfaceid='ab90a692-0bd8-448a-9a27-30a725d4af10'/>\n      </virtualport>\n      <target dev='tapab90a692-0b'/>\n      <model type='virtio'/>\n      <alias name='net1'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </interface>\n    <interface type='hostdev' managed='yes'>\n      <mac address='fa:16:3e:7e:d0:ce'/>\n      <driver name='vfio'/>\n      <source>\n        <address type='pci' domain='0x0000' bus='0x02' slot='0x10' function='0x6'/>\n      </source>\n      <vlan>\n        <tag id='31'/>\n      </vlan>\n      <alias name='hostdev0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>\n    </interface>\n    <interface type='hostdev' managed='yes'>\n      <mac address='fa:16:3e:54:ca:77'/>\n      <driver name='vfio'/>\n      <source>\n        <address type='pci' domain='0x0000' bus='0x02' slot='0x10' function='0x4'/>\n      </source>\n      <vlan>\n        <tag id='32'/>\n      </vlan>\n      <alias name='hostdev1'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>\n    </interface>\n    <serial type='tcp'>\n      <source mode='bind' host='127.0.0.1' service='10000'/>\n      <protocol type='raw'/>\n      <target port='0'/>\n      <alias name='serial0'/>\n    </serial>\n    <serial type='pty'>\n      <source path='/dev/pts/14'/>\n      <target port='1'/>\n      <alias name='serial1'/>\n    </serial>\n    <console type='tcp'>\n      <source mode='bind' host='127.0.0.1' service='10000'/>\n      <protocol type='raw'/>\n      <target type='serial' port='0'/>\n      <alias name='serial0'/>\n    </console>\n    <input type='tablet' bus='usb'>\n      <alias name='input0'/>\n    </input>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n    <graphics type='vnc' port='5902' autoport='yes' listen='0.0.0.0' keymap='en-us'>\n      <listen type='address' address='0.0.0.0'/>\n    </graphics>\n    <video>\n      <model type='cirrus' vram='16384' heads='1'/>\n      <alias name='video0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>\n    </video>\n    <memballoon model='virtio'>\n      <stats period='10'/>\n      <alias name='balloon0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>\n    </memballoon>\n  </devices>\n</domain>\n", 
            "date_created": "2017-06-08 12:55:25.752358+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "So nothing is really clear on how to configure this element. Someone says from #virt that we can set it to the host memory size but there is a security concern; QEMU might be compromised or have memory leak and so host itself could crash.", 
            "date_created": "2017-06-08 14:09:24.681819+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Wei Zhu, can you try with a recent version libvirt (3.2.0 at least) it seems that now libvirt automatically set the limit to unlimited when using locked?", 
            "date_created": "2017-06-08 14:16:07.802854+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "https://www.redhat.com/archives/libvir-list/2017-March/msg01089.html", 
            "date_created": "2017-06-08 14:18:45.813126+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Very hard to make libvirt 3.2.1 work on ubuntu 16.04, existing latest package is 1.3.1.\nIs it possible to expose hard_limit as a flavor key, or to disable /locked as an alternative flavor key? My understanding with hugepage, memory cannot be swapped, so no need for /locked.", 
            "date_created": "2017-06-08 21:00:39.811852+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/472633", 
            "date_created": "2017-06-09 10:43:56.522394+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Wei Zhu can you try that patch [0]? Basically it's what libvirt is doing start to 3.1.0 [1]\n\n[0] https://review.openstack.org/472633\n[1] https://www.redhat.com/archives/libvir-list/2017-March/msg01092.html", 
            "date_created": "2017-06-09 10:45:36.322688+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Using newton, my fakelibvirt.py file content is a bit different, driver.py is fine,\n\nThis doesn't work I guess the value is too big, so I hardcoded HARD_LIMIT_UNLIMITED = 9007199254740988 instead,\n\n>>> print sys.maxint >> 10\n9007199254740991\n\nFollowing is default hard_limit when VM starts,\nroot@TS01:/usr/lib/python2.7/dist-packages/nova/virt/libvirt# virsh memtune 1\nhard_limit     : 9007199254740988\nsoft_limit     : 9007199254740988\n\n", 
            "date_created": "2017-06-09 12:33:40.785776+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "With kernel 3.18 (since commit 3e32cb2e0a12b6915056ff04601cf1bb9b44f967) the\n\"unlimited\" value for cgroup memory limits has changed once again as its byte\nvalue is now computed from a page counter.\nThe new \"unlimited\" value reported by the cgroup fs is therefore 2**51-1 pages\nwhich is (VIR_DOMAIN_MEMORY_PARAM_UNLIMITED - 3072). This results e.g. in virsh\nmemtune displaying 9007199254740988 instead of unlimited for the limits.\n\nThis patch deals with the rounding issue by scaling the byte values reported\nby the kernel and the PARAM_UNLIMITED value to page size and comparing those.\n\nSee also libvirt commit 231656bbeb9e4d3bedc44362784c35eee21cf0f4 for the\nhistory for kernel 3.12 and before.", 
            "date_created": "2017-06-09 21:03:51.381994+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Sahid, Can we use \"HARD_LIMIT_UNLIMITED = (sys.maxint >> 10) - 3\" instead? I tested good.\n\n", 
            "date_created": "2017-06-13 14:06:51.712270+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "What exactly is the error ? can you share the traceback so at least I can explain the problem on the fix as a side note.\n\nThanks", 
            "date_created": "2017-06-13 15:26:15.078234+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "It's basically same mlock error as memtune option is not there, I think due to the value of sys.maxint >> 10 is too big. When I hardcoded smaller value or used \"sys.maxint >> 10 - 3\" then memtune option appeared.", 
            "date_created": "2017-06-13 15:41:52.710510+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Here with HARD_LIMIT_UNLIMITED = sys.maxint >> 10 <memtune> option is missed,\n\n2017-06-13 11:49:38.907 12189 ERROR nova.virt.libvirt.guest [req-c831c761-f4d8-4582-a083-72e4f24fb95d 50f2aa60006047198e8181e5d1ff2173 3f79af00c3bc455f99adcde0826ca1ce - - -] Error launching a defined domain with XML: <domain type='kvm'>\n  <name>instance-000000dd</name>\n  <uuid>630614b5-f29b-4e15-9a73-f13b52743d5a</uuid>\n  <metadata>\n    <nova:instance xmlns:nova=\"http://openstack.org/xmlns/libvirt/nova/1.0\">\n      <nova:package version=\"14.0.5\"/>\n      <nova:name>vlns1_pfe</nova:name>\n      <nova:creationTime>2017-06-13 15:49:31</nova:creationTime>\n      <nova:flavor name=\"vfpfl\">\n        <nova:memory>12288</nova:memory>\n        <nova:disk>4</nova:disk>\n        <nova:swap>0</nova:swap>\n        <nova:ephemeral>0</nova:ephemeral>\n        <nova:vcpus>12</nova:vcpus>\n      </nova:flavor>\n      <nova:owner>\n        <nova:user uuid=\"50f2aa60006047198e8181e5d1ff2173\">admin</nova:user>\n        <nova:project uuid=\"3f79af00c3bc455f99adcde0826ca1ce\">admin</nova:project>\n      </nova:owner>\n      <nova:root type=\"image\" uuid=\"36d52e83-3d91-4368-955b-0259cdb5367e\"/>\n    </nova:instance>\n  </metadata>\n  <memory unit='KiB'>12582912</memory>\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <memoryBacking>\n    <hugepages>\n      <page size='2048' unit='KiB' nodeset='0'/>\n    </hugepages>\n    <nosharepages/>\n    <locked/>\n  </memoryBacking>\n  <vcpu placement='static'>12</vcpu>\n  <cputune>\n    <shares>12288</shares>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='17'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='19'/>\n    <vcpupin vcpu='4' cpuset='6'/>\n    <vcpupin vcpu='5' cpuset='22'/>\n    <vcpupin vcpu='6' cpuset='4'/>\n    <vcpupin vcpu='7' cpuset='20'/>\n    <vcpupin vcpu='8' cpuset='7'/>\n    <vcpupin vcpu='9' cpuset='23'/>\n    <vcpupin vcpu='10' cpuset='5'/>\n    <vcpupin vcpu='11' cpuset='21'/>\n    <emulatorpin cpuset='1'/>\n    <vcpusched vcpus='1-11' scheduler='fifo' priority='1'/>\n  </cputune>", 
            "date_created": "2017-06-13 15:51:29.742030+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "With HARD_LIMIT_UNLIMITED = (sys.maxint >> 10) -3 , it works with correct memtune and hard_limit\n\n  <memory unit='KiB'>12582912</memory>\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <memtune>\n    <hard_limit unit='KiB'>9007199254740988</hard_limit>\n  </memtune>\n  <memoryBacking>\n    <hugepages>\n      <page size='2048' unit='KiB' nodeset='0'/>\n    </hugepages>\n    <nosharepages/>\n    <locked/>\n  </memoryBacking>\n  <vcpu placement='static'>12</vcpu>\n  <cputune>\n    <shares>12288</shares>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='17'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='19'/>\n    <vcpupin vcpu='4' cpuset='6'/>\n    <vcpupin vcpu='5' cpuset='22'/>\n    <vcpupin vcpu='6' cpuset='4'/>\n    <vcpupin vcpu='7' cpuset='20'/>\n    <vcpupin vcpu='8' cpuset='7'/>\n    <vcpupin vcpu='9' cpuset='23'/>\n    <vcpupin vcpu='10' cpuset='5'/>\n    <vcpupin vcpu='11' cpuset='21'/>\n    <emulatorpin cpuset='1'/>\n    <vcpusched vcpus='1-11' scheduler='fifo' priority='1'/>\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n    <memnode cellid='0' mode='strict' nodeset='0'/>\n  </numatune>", 
            "date_created": "2017-06-13 15:55:36.878159+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Sahid, seems kmem max is 2**53 - 3 instead of 2**53 -1?", 
            "date_created": "2017-06-15 18:08:31.674622+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "sorry 2**53 - 4 instead.", 
            "date_created": "2017-06-15 20:47:39.163678+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Ok I think we should set it to -1 so libvirt will take care of using the unlimited value by reading the cgroup. I'm going to update the patch and make some tests. Can you do the same in your side ? to ensure that is well working?", 
            "date_created": "2017-06-16 08:41:40.355613+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Ok so that does not work with -1 which is strange since that is working with virsh.\n\n virsh memtune dom --hard-limit -1 --live\n\n\nute[9794]: INFO nova.virt.libvirt.driver [None req-389bfc12-d0fd-4039-94de-f44b8acaf0cf demo admin] [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94] Deletion of /opt/stack/data/nova/instances/\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [None req-389bfc12-d0fd-4039-94de-f44b8acaf0cf demo admin] [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94] Instance failed to spawn: libvirtError: XML er\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94] Traceback (most recent call last):\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/opt/stack/nova/nova/compute/manager.py\", line 2154, in _build_resources\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     yield resources\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/opt/stack/nova/nova/compute/manager.py\", line 1960, in _build_and_run_instance\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     block_device_info=block_device_info)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2781, in spawn\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     destroy_disks_on_failure=True)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5226, in _create_domain_and_network\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     destroy_disks_on_failure)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     self.force_reraise()\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     six.reraise(self.type_, self.value, self.tb)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5195, in _create_domain_and_network\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     post_xml_callback=post_xml_callback)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5106, in _create_domain\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     guest = libvirt_guest.Guest.create(xml, self._host)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 131, in create\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     encodeutils.safe_decode(xml))\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     self.force_reraise()\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     six.reraise(self.type_, self.value, self.tb)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 127, in create\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     guest = host.write_instance_config(xml)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/opt/stack/nova/nova/virt/libvirt/host.py\", line 840, in write_instance_config\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     domain = self.get_connection().defineXML(xml)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 186, in doit\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     result = proxy_call(self._autowrap, f, *args, **kwargs)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 144, in proxy_call\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     rv = execute(f, *args, **kwargs)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 125, in execute\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     six.reraise(c, e, tb)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 83, in tworker\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     rv = meth(*args, **kwargs)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]   File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 3780, in defineXML\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94]     if ret is None:raise libvirtError('virDomainDefineXML() failed', conn=self)\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94] libvirtError: XML error: Invalid value '-1' for element or attribute './memtune/hard_limit[1]'\nJun 16 05:16:45 localhost.localdomain nova-compute[9794]: ERROR nova.compute.manager [instance: 1bcc5575-60e4-4f91-951c-68e3b102cc94] \n[stack@localhost nova]$ git status\n\nIt seems that there is a bug in libvirt: [0]. So I'm going to hardcode the value to 9007199254740988\n\n[0] http://libvirt.org/git/?p=libvirt.git;a=blob;f=src/conf/domain_conf.c;h=0507ec172a001c6a2cece550beacc683d7d51508;hb=HEAD#l17374", 
            "date_created": "2017-06-16 09:27:58.008804+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Oh actually virsh is taking care of that value when we pass -1 so it's not a bug of libvirt.", 
            "date_created": "2017-06-16 09:34:50.569244+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "HARD_LIMIT_UNLIMITED =  -1\n\n2017-06-16 07:47:16.572 13881 ERROR nova.virt.libvirt.guest [req-c4728dee-aa4d-4995-9f5c-7e466d10e74c 50f2aa60006047198e8181e5d1ff2173 3f79af00c3bc455f99adcde0826ca1ce - - -] Error defining a domain with XML: <domain type=\"kvm\">\n  <uuid>f83666bd-90d3-4c02-a5d5-a59b73a1bc14</uuid>\n  <name>instance-000000e7</name>\n  <memory>12582912</memory>\n  <memoryBacking>\n    <hugepages>\n      <page size=\"2048\" nodeset=\"0\" unit=\"KiB\"/>\n    </hugepages>\n    <nosharepages/>\n    <locked/>\n  </memoryBacking>\n  <memtune>\n    <hard_limit units=\"K\">-1</hard_limit>\n  </memtune>", 
            "date_created": "2017-06-16 11:48:22.007878+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "when using memtune hard-limit =-1, it removed the memtune portion, later VM crashed\n\n2017-06-16T12:05:41.234284Z qemu-system-x86_64: terminating on signal 15 from pid 3407\n2017-06-16 12:05:42.035+0000: shutting down\n\nroot@TS01:/usr/lib/python2.7/dist-packages/nova/virt/libvirt# virsh dumpxml 37\n<domain type='kvm' id='37'>\n  <name>instance-000000f3</name>\n  <uuid>ee2bb7ec-fc23-453e-8104-09cbfad08370</uuid>\n  <metadata>\n    <nova:instance xmlns:nova=\"http://openstack.org/xmlns/libvirt/nova/1.0\">\n      <nova:package version=\"14.0.5\"/>\n      <nova:name>vlns1_pfe</nova:name>\n      <nova:creationTime>2017-06-16 11:55:12</nova:creationTime>\n      <nova:flavor name=\"vfpfl\">\n        <nova:memory>12288</nova:memory>\n        <nova:disk>4</nova:disk>\n        <nova:swap>0</nova:swap>\n        <nova:ephemeral>0</nova:ephemeral>\n        <nova:vcpus>12</nova:vcpus>\n      </nova:flavor>\n      <nova:owner>\n        <nova:user uuid=\"50f2aa60006047198e8181e5d1ff2173\">admin</nova:user>\n        <nova:project uuid=\"3f79af00c3bc455f99adcde0826ca1ce\">admin</nova:project>\n      </nova:owner>\n      <nova:root type=\"image\" uuid=\"36d52e83-3d91-4368-955b-0259cdb5367e\"/>\n    </nova:instance>\n  </metadata>\n  <memory unit='KiB'>12582912</memory>\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <memtune>\n    <hard_limit unit='KiB'>9007199254740988</hard_limit>\n  </memtune>\n\nroot@TS01:/usr/lib/python2.7/dist-packages/nova/virt/libvirt# virsh memtune 37 --hard-limit=-1 --live\n\nroot@TS01:/usr/lib/python2.7/dist-packages/nova/virt/libvirt# virsh dumpxml 37\n<domain type='kvm' id='37'>\n  <name>instance-000000f3</name>\n  <uuid>ee2bb7ec-fc23-453e-8104-09cbfad08370</uuid>\n  <metadata>\n    <nova:instance xmlns:nova=\"http://openstack.org/xmlns/libvirt/nova/1.0\">\n      <nova:package version=\"14.0.5\"/>\n      <nova:name>vlns1_pfe</nova:name>\n      <nova:creationTime>2017-06-16 11:55:12</nova:creationTime>\n      <nova:flavor name=\"vfpfl\">\n        <nova:memory>12288</nova:memory>\n        <nova:disk>4</nova:disk>\n        <nova:swap>0</nova:swap>\n        <nova:ephemeral>0</nova:ephemeral>\n        <nova:vcpus>12</nova:vcpus>\n      </nova:flavor>\n      <nova:owner>\n        <nova:user uuid=\"50f2aa60006047198e8181e5d1ff2173\">admin</nova:user>\n        <nova:project uuid=\"3f79af00c3bc455f99adcde0826ca1ce\">admin</nova:project>\n      </nova:owner>\n      <nova:root type=\"image\" uuid=\"36d52e83-3d91-4368-955b-0259cdb5367e\"/>\n    </nova:instance>\n  </metadata>\n  <memory unit='KiB'>12582912</memory>\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <memoryBacking>\n    <hugepages>\n      <page size='2048' unit='KiB' nodeset='0'/>\n    </hugepages>\n    <nosharepages/>\n    <locked/>\n  </memoryBacking>\n  <vcpu placement='static'>12</vcpu>\n  <cputune>", 
            "date_created": "2017-06-16 12:08:04.570787+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "This works good, using maximum system avaiable physical memory\n\nHARD_LIMIT_UNLIMITED =  os.sysconf('SC_PAGE_SIZE') * os.sysconf('SC_AVPHYS_PAGES') >> 10\n\n", 
            "date_created": "2017-06-16 12:54:27.566196+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Sahid, is it possible to use system physical memory instead?", 
            "date_created": "2017-06-19 16:12:33.806316+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Hi Sahid, just trying to follow up, much appreciated.", 
            "date_created": "2017-06-26 13:10:28.061682+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Wei, can you elaborate little bit more why you would do that ? at the end it's going to be the same behavior or do I missed something.", 
            "date_created": "2017-06-26 14:21:27.039977+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "HARD_LIMIT_UNLIMITED = -1  didn't work, just wondering any other value to use and get it worked around.", 
            "date_created": "2017-06-26 14:36:42.343648+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "The current patch upstream [0] is proposing to hardcode a value which should be considered as unlimited for most of the cases, then libvirt in its version 3.1.0 is going to take care of that automatically.\n\nI think we are good even if you have more concerns ?\n\n[0] https://review.openstack.org/#/c/472633/", 
            "date_created": "2017-06-27 07:08:31.533352+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Works great, thank you!", 
            "date_created": "2017-06-27 14:07:45.441106+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "Automatically discovered version newton in description. If this is incorrect, please update the description to include 'nova version: ...'", 
            "date_created": "2017-06-27 16:05:16.422002+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "can this be merged into ocata?", 
            "date_created": "2017-07-11 12:38:26.199258+00:00", 
            "author": "https://api.launchpad.net/1.0/~slackwei"
        }, 
        {
            "content": "I don't know it seems to be blocked by a developer preference...", 
            "date_created": "2017-07-11 13:16:42.707401+00:00", 
            "author": "https://api.launchpad.net/1.0/~sahid-ferdjaoui"
        }, 
        {
            "content": "Change abandoned by sahid (<email address hidden>) on branch: master\nReview: https://review.openstack.org/472633\nReason: Blocked for no real reason", 
            "date_created": "2017-09-04 10:43:43.616456+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}