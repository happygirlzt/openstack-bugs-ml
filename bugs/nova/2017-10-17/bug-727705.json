{
    "status": "Invalid", 
    "last_updated": "2012-05-16 17:52:06.423859+00:00", 
    "description": "When an instance is terminated, eventually its fixed ip is disassociated, too. However, if there's a floating ip assigned, too, the next time the fixed ip is assigned to an instance, it'll inherit the floating ip. Sort of. It won't actually work, because the plumbing was correctly torn down by the network manager, but it'll still be in the DescribeInstances output.", 
    "tags": [], 
    "importance": "Low", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/727705", 
    "owner": "None", 
    "id": 727705, 
    "index": 117, 
    "openned": "2011-03-02 10:42:06.119111+00:00", 
    "created": "2011-03-02 10:42:06.119111+00:00", 
    "title": "Floating ip's do not get disassociated from fixed ip's when the fixed ip's are disassociated from instances", 
    "comments": [
        {
            "content": "When an instance is terminated, eventually its fixed ip is disassociated, too. However, if there's a floating ip assigned, too, the next time the fixed ip is assigned to an instance, it'll inherit the floating ip. Sort of. It won't actually work, because the plumbing was correctly torn down by the network manager, but it'll still be in the DescribeInstances output.", 
            "date_created": "2011-03-02 10:42:06.119111+00:00", 
            "author": "https://api.launchpad.net/1.0/~soren"
        }, 
        {
            "content": "Update: The problem was the create floating address was specified with wrong hostnames\n\n\nMy environment:\n\nnova1 (running api,network,compute,scheduler,objectstore)\nnova2 (running compute)\n\nPrior to creating any instances I ran the following (note cloud1 as the hostname isn't part of my environment and recreates this bug - so user error):\n\n$ sudo nova-manage floating create cloud1 172.241.0.0/25\n\n********\n1. euca-run-instances $emi -k key -t m1.tiny\n2. euca-describe-instances             (see floating public_ip associated)\n\nRESERVATION\tr-8fs20ghi\tmyproject\tdefault\nINSTANCE\ti-00000015\tami-zwxz6oe8\t172.241.0.4\t10.0.0.4\trunning\topenstack (myproject, nova1)\t0\t\tm1.tiny\t2011-03-02T10:49:18Z\tnova\t\t\n\n3. Looked at nova database\n\nmysql> select * from floating_ips where address=\"172.241.0.4\";\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+--------+\n| created_at          | updated_at          | deleted_at | deleted | id  | address     | fixed_ip_id | project_id | host   |\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+--------+\n| 2011-03-01 15:24:12 | 2011-03-01 16:32:10 | NULL       |       0 | 261 | 172.241.0.4 |         389 | NULL       | cloud1 |\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+--------+\n1 row in set (0.00 sec)\n\nmysql> select * from fixed_ips where id=\"389\";\n+---------------------+---------------------+------------+---------+-----+----------+------------+-------------+-----------+--------+----------+\n| created_at          | updated_at          | deleted_at | deleted | id  | address  | network_id | instance_id | allocated | leased | reserved |\n+---------------------+---------------------+------------+---------+-----+----------+------------+-------------+-----------+--------+----------+\n| 2011-03-01 14:58:46 | 2011-03-02 10:58:06 | NULL       |       0 | 389 | 10.0.0.4 |          6 |          21 |         1 |      1 |        0 |\n+---------------------+---------------------+------------+---------+-----+----------+------------+-------------+-----------+--------+----------+\n1 row in set (0.00 sec)\n\n4. I then terminated instance\n\nmysql> select * from floating_ips where address=\"172.241.0.4\";\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+--------+\n| created_at          | updated_at          | deleted_at | deleted | id  | address     | fixed_ip_id | project_id | host   |\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+--------+\n| 2011-03-01 15:24:12 | 2011-03-01 16:32:10 | NULL       |       0 | 261 | 172.241.0.4 |         389 | NULL       | cloud1 |\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+--------+\n1 row in set (0.00 sec)\n\nmysql> select * from fixed_ips where id=\"389\";\n+---------------------+---------------------+------------+---------+-----+----------+------------+-------------+-----------+--------+----------+\n| created_at          | updated_at          | deleted_at | deleted | id  | address  | network_id | instance_id | allocated | leased | reserved |\n+---------------------+---------------------+------------+---------+-----+----------+------------+-------------+-----------+--------+----------+\n| 2011-03-01 14:58:46 | 2011-03-02 11:09:22 | NULL       |       0 | 389 | 10.0.0.4 |          6 |          24 |         0 |      1 |        0 |\n+---------------------+---------------------+------------+---------+-----+----------+------------+-------------+-----------+--------+----------+\n1 row in set (0.00 sec)\n\n\n5. (Spun up 3 instances to get same floating_ip 172.241.0.4 to keep consistency with troubleshooting)\n6. euca-describe-instances\n\nRESERVATION\tr-ns49da1b\tmyproject\tdefault\nINSTANCE\ti-00000018\tami-zwxz6oe8\t172.241.0.4\t10.0.0.4\tlaunching\topenstack (myproject, nova1)\t0\t\tm1.tiny2011-03-02T11:02:55Z\tnova\t\t\n\n\n\nPING 172.241.0.4 (172.241.0.4) 56(84) bytes of data.\nFrom 172.241.0.100 icmp_seq=1 Destination Host Unreachable\nFrom 172.241.0.100 icmp_seq=2 Destination Host Unreachable\nFrom 172.241.0.100 icmp_seq=3 Destination Host Unreachable\n^C\n--- 172.241.0.4 ping statistics ---\n6 packets transmitted, 0 received, +3 errors, 100% packet loss, time 5017ms\n\n\n**** Problem was the host entry in the floating_ips table was NOT nova1 where the instances where running ****\n**** So corrected this to test: ******\n\n7. update floating_ips set host=\"nova1\";\n8. euca-run-instances...\n9. euca-describe-instances\n\nRESERVATION\tr-fa5px5e4\tmyproject\tdefault\nINSTANCE\ti-00000019\tami-zwxz6oe8\t172.241.0.3\t10.0.0.3\tlaunching\topenstack (myproject, nova1)\t0\t\tm1.tiny2011-03-02T11:11:31Z\tnova\t\t\n\n10. View the nova. tables \n\nmysql> select * from floating_ips where address=\"172.241.0.3\";\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+-------+\n| created_at          | updated_at          | deleted_at | deleted | id  | address     | fixed_ip_id | project_id | host  |\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+-------+\n| 2011-03-01 15:24:12 | 2011-03-02 10:42:07 | NULL       |       0 | 260 | 172.241.0.3 |         388 | NULL       | nova1 |\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+-------+\n1 row in set (0.01 sec)\n\nmysql> select * from fixed_ips where id=\"388\";\n+---------------------+---------------------+------------+---------+-----+----------+------------+-------------+-----------+--------+----------+\n| created_at          | updated_at          | deleted_at | deleted | id  | address  | network_id | instance_id | allocated | leased | reserved |\n+---------------------+---------------------+------------+---------+-----+----------+------------+-------------+-----------+--------+----------+\n| 2011-03-01 14:58:46 | 2011-03-02 11:19:39 | NULL       |       0 | 388 | 10.0.0.3 |          6 |          25 |         1 |      1 |        0 |\n+---------------------+---------------------+------------+---------+-----+----------+------------+-------------+-----------+--------+----------+\n1 row in set (0.00 sec)\n\n11. euca-terminate-instances i-0000019\n12. View tables showing correct removal of floating ip (no fixed_ip_id)\n\nmysql> select * from floating_ips where address=\"172.241.0.3\";\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+-------+\n| created_at          | updated_at          | deleted_at | deleted | id  | address     | fixed_ip_id | project_id | host  |\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+-------+\n| 2011-03-01 15:24:12 | 2011-03-02 11:27:44 | NULL       |       0 | 260 | 172.241.0.3 |        NULL | NULL       | nova1 |\n+---------------------+---------------------+------------+---------+-----+-------------+-------------+------------+-------+\n1 row in set (0.02 sec)\n\n", 
            "date_created": "2011-03-02 11:44:30.452928+00:00", 
            "author": "https://api.launchpad.net/1.0/~kevin-linuxservices"
        }, 
        {
            "content": "11:46 <+soren> ah, worked it out.\n11:46 <+soren> Heh.\n11:48 <+soren> When you call euca-associate-address, it calls the AssociateAddress method call in the EC2 API, which calls the internal compute api's associate_floating_ip, which calls the network api's associate_floating_ip, which sends an rpc call to the network manager on the host corresponding to the fixed_ip.\n11:50 <+soren> When you call euca-disassociate-address, it calls the DisssociateAddress method call in the EC2 API, which calls the internal network api's disassociate_floating_ip, which sends an rpc call to the network manager on the host corresponding to the fixed_ip of the floating_ip.\n11:50 <+soren> However...\n11:53 <+soren> When you call euca-terminate-instance, it calls the TerminateInstance method call in the EC2 API, which calls the internal compute api's delete method, which sends an \"terminate_instance\" rpc call to the compute manager, which sends a \"disassociate_floating_address\" to the network manager on the host corresponding to the floating_ip itself.\n11:53 <+soren> \"the network manager on the host corresponding to the floating_ip itself\" is the key.\n11:54 <+soren> Because that's that \"cloud1\" thing you set with nova-manage.\n11:54 <+soren> Everywhere else, we seem to look up floating_ip->fixed_ip->host, which is fine.\n11:54 <+soren> floating_ip->host is screwed.\n", 
            "date_created": "2011-03-02 11:56:16.194305+00:00", 
            "author": "https://api.launchpad.net/1.0/~soren"
        }, 
        {
            "content": "Thinking about this a bit.  I need to do some investigation with some large use cases and find out if it is possible to have a set of ips that can be shared across clusters.  If that is fairly easy, then I think we can safely remove the host field from floating ips and always stick the floating ip on the network host of the fixed ip (that would mean changing terminate).  If this isn't possible in all cases, then we probably need to keep the field.\n\nThe second point raises another issue (which I will likely file as a separate bug).  If we have multiple network hosts, there is no way for the hosts to route between their private assigned subnets.  In flatdhcp mode this isn't that much of an issue, because you can probably just set up specific rules for each of the other hosts manually, but It starts to get more complex in vlan mode.  Hopefully there is an easy way to do this and this is a solved problem in networking.  /me goes to find a network genius.", 
            "date_created": "2011-03-02 17:24:27.491114+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Is this bug still valid?", 
            "date_created": "2012-05-16 12:25:54.111205+00:00", 
            "author": "https://api.launchpad.net/1.0/~fifieldt"
        }, 
        {
            "content": "nope, out of date and old", 
            "date_created": "2012-05-16 17:51:53.163179+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }
    ], 
    "closed": "2012-05-16 17:52:05.326218+00:00"
}