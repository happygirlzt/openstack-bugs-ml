{
    "status": "In Progress", 
    "last_updated": "2016-09-02 20:42:50.177256+00:00", 
    "description": "Description:\n============\n\nBooting a guest with a neutron port of type 'direct-physical' will cause nova to allocate a PCI passthrough device for the port.  The MAC address of the PCI passthrough device in the guest is not a virtual MAC address (fa:16:...) but the MAC address of the physical device since the full device is allocated to the guest (compared to SR-IOV where a virtual MAC address is arbitrarily chosen for the port).\n\nWhen resizing the guest (to another flavor), nova will allocate a new PCI device for the guest.  After the resize, the guest will be bound to another PCI device which has a different MAC address.  However the MAC address on the neutron port is not updated, causing DHCP to not work because the MAC address is unknown.\n\nThe same issue can be observed when migrating a guest to another host.\n\nSteps to reproduce:\n===================\n\n1- Configure a compute with two NICs PCI passthrough devices\n\n2- Create a neutron port of type 'direct-physical':\nPORTID=`neutron port-create $NETID --binding:vnic_type direct-physical | grep \"\\ id\\ \" | awk '{ print $4 }'`\n\n3- Boot a guest with the port-id:\nnova boot guest --image=ubuntu --nic port-id=$PORTID --flavor=m1.medium\n\n4- Note the MAC address of the neutron port:\n\n[centos@IronPass-2 devstack]$ neutron port-show 657990ce-3446-40a2-bc33-8040a32cb72b\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n| Field                 | Value                                                                                                     |\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                                                      |\n| allowed_address_pairs |                                                                                                           |\n| binding:vnic_type     | direct-physical                                                                                           |\n| created_at            | 2016-08-26T14:57:07                                                                                       |\n| description           |                                                                                                           |\n| device_id             | f1005ec2-1875-4345-af01-58afaee7e68d                                                                      |\n| device_owner          | compute:None                                                                                              |\n| extra_dhcp_opts       |                                                                                                           |\n| fixed_ips             | {\"subnet_id\": \"8e6aaf8e-78e8-42d7-9b59-f96789728abc\", \"ip_address\": \"10.0.0.12\"}                          |\n|                       | {\"subnet_id\": \"4210fe1c-b156-4ecb-a896-922c87f85c3f\", \"ip_address\": \"fdab:2588:f4:0:f816:3eff:fe37:acba\"} |\n| id                    | 657990ce-3446-40a2-bc33-8040a32cb72b                                                                      |\n| mac_address           | 90:e2:ba:48:27:ed                                                                                         |\n| name                  | sriov_port                                                                                                |\n| network_id            | dfdff739-a27b-4160-9e40-c4824e8a351d                                                                      |\n| port_security_enabled | True                                                                                                      |\n| revision              | 57                                                                                                        |\n| security_groups       | 8c7b8173-f050-480d-968a-33e0b75332fc                                                                      |\n| status                | ACTIVE                                                                                                    |\n| tenant_id             | a11cb2aece1943c2a86ee0a55e1bd8f7                                                                          |\n| updated_at            | 2016-08-26T17:33:12                                                                                       |\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n\n5- Log in the guest and get a DHCP address for the interface.\n\nip link add link eth1 name eth1.451 type vlan id 451\nip link set eth1.451 up\ndhclient eth1.451\n\nNote the MAC address of the interface:\n\n4: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP qlen 1000\n    link/ether 90:e2:ba:48:27:ed brd ff:ff:ff:ff:ff:ff\n    inet6 fe80::92e2:baff:fe48:27ed/64 scope link \n       valid_lft forever preferred_lft forever\n5: eth1.451@eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP \n    link/ether 90:e2:ba:48:27:ed brd ff:ff:ff:ff:ff:ff\n    inet 10.0.0.12/24 brd 10.0.0.255 scope global eth1.451\n       valid_lft forever preferred_lft forever\n    inet6 fdab:2588:f4:0:92e2:baff:fe48:27ed/64 scope global dynamic \n       valid_lft 86396sec preferred_lft 14396sec\n    inet6 fe80::92e2:baff:fe48:27ed/64 scope link \n       valid_lft forever preferred_lft forever\n\n6- Resize the guest\n\n7- Note the MAC address of the neutron port (after resize):\n\n[centos@IronPass-2 devstack]$ neutron port-show 657990ce-3446-40a2-bc33-8040a32cb72b\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n| Field                 | Value                                                                                                     |\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                                                      |\n| allowed_address_pairs |                                                                                                           |\n| binding:vnic_type     | direct-physical                                                                                           |\n| created_at            | 2016-08-26T14:57:07                                                                                       |\n| description           |                                                                                                           |\n| device_id             | f1005ec2-1875-4345-af01-58afaee7e68d                                                                      |\n| device_owner          | compute:None                                                                                              |\n| extra_dhcp_opts       |                                                                                                           |\n| fixed_ips             | {\"subnet_id\": \"8e6aaf8e-78e8-42d7-9b59-f96789728abc\", \"ip_address\": \"10.0.0.12\"}                          |\n|                       | {\"subnet_id\": \"4210fe1c-b156-4ecb-a896-922c87f85c3f\", \"ip_address\": \"fdab:2588:f4:0:f816:3eff:fe37:acba\"} |\n| id                    | 657990ce-3446-40a2-bc33-8040a32cb72b                                                                      |\n| mac_address           | 90:e2:ba:48:27:ed                                                                                         |\n| name                  | sriov_port                                                                                                |\n| network_id            | dfdff739-a27b-4160-9e40-c4824e8a351d                                                                      |\n| port_security_enabled | True                                                                                                      |\n| revision              | 59                                                                                                        |\n| security_groups       | 8c7b8173-f050-480d-968a-33e0b75332fc                                                                      |\n| status                | ACTIVE                                                                                                    |\n| tenant_id             | a11cb2aece1943c2a86ee0a55e1bd8f7                                                                          |\n| updated_at            | 2016-08-26T17:38:30                                                                                       |\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n\nNotice that it's still hasn't changed: 90:e2:ba:48:27:ed\n\n8- Log in the guest and get a DHCP address for the interface.\n\nip link add link eth1 name eth1.451 type vlan id 451\nip link set eth1.451 up\ndhclient eth1.451\n\nNote the MAC address of the interface has changed:\n\n4: eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP qlen 1000\n    link/ether 00:1e:67:51:36:71 brd ff:ff:ff:ff:ff:ff\n    inet6 fe80::21e:67ff:fe51:3671/64 scope link \n       valid_lft forever preferred_lft forever\n5: eth2.451@eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP \n    link/ether 00:1e:67:51:36:71 brd ff:ff:ff:ff:ff:ff\n    inet6 fe80::21e:67ff:fe51:3671/64 scope link \n       valid_lft forever preferred_lft forever\n\nAlso note that the DHCP client wasn't successful in getting a DHCP address.\n\n9- From the dnsmasq host file, we can also see that it hasn't been updated:\n\ncat /opt/stack/data/neutron/dhcp/dfdff739-a27b-4160-9e40-c4824e8a351d/host\nfa:16:3e:e5:e0:c9,host-10-0-0-2.openstacklocal,10.0.0.2\n90:e2:ba:48:27:ed,host-10-0-0-12.openstacklocal,10.0.0.12\nfa:16:3e:99:c8:b9,host-10-0-0-5.openstacklocal,10.0.0.5\n\n\nEnvironment:\n============\n\nLatest master\n\ncommit 7500bef94f526a82392400415f07f744700324a9\nMerge: 8d5aff7 39fb302\nAuthor: Jenkins <email address hidden>\nDate:   Fri Aug 26 05:03:48 2016 +0000\n\n    Merge \"Revert \"Optional separate database for placement API\"\"", 
    "tags": [
        "pci"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1617429", 
    "owner": "https://api.launchpad.net/1.0/~ludovic-beliveau", 
    "id": 1617429, 
    "index": 4610, 
    "openned": "2016-08-26 19:33:05.091854+00:00", 
    "created": "2016-08-26 19:33:05.091854+00:00", 
    "title": "pci: Can't get DHCP address after resize with port type 'direct-physical'", 
    "comments": [
        {
            "content": "Description:\n============\n\nBooting a guest with a neutron port of type 'direct-physical' will cause nova to allocate a PCI passthrough device for the port.  The MAC address of the PCI passthrough device in the guest is not a virtual MAC address (fa:16:...) but the MAC address of the physical device since the full device is allocated to the guest (compared to SR-IOV where a virtual MAC address is arbitrarily chosen for the port).\n\nWhen resizing the guest (to another flavor), nova will allocate a new PCI device for the guest.  After the resize, the guest will be bound to another PCI device which has a different MAC address.  However the MAC address on the neutron port is not updated, causing DHCP to not work because the MAC address is unknown.\n\nThe same issue can be observed when migrating a guest to another host.\n\nSteps to reproduce:\n===================\n\n1- Configure a compute with two NICs PCI passthrough devices\n\n2- Create a neutron port of type 'direct-physical':\nPORTID=`neutron port-create $NETID --binding:vnic_type direct-physical | grep \"\\ id\\ \" | awk '{ print $4 }'`\n\n3- Boot a guest with the port-id:\nnova boot guest --image=ubuntu --nic port-id=$PORTID --flavor=m1.medium\n\n4- Note the MAC address of the neutron port:\n\n[centos@IronPass-2 devstack]$ neutron port-show 657990ce-3446-40a2-bc33-8040a32cb72b\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n| Field                 | Value                                                                                                     |\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                                                      |\n| allowed_address_pairs |                                                                                                           |\n| binding:vnic_type     | direct-physical                                                                                           |\n| created_at            | 2016-08-26T14:57:07                                                                                       |\n| description           |                                                                                                           |\n| device_id             | f1005ec2-1875-4345-af01-58afaee7e68d                                                                      |\n| device_owner          | compute:None                                                                                              |\n| extra_dhcp_opts       |                                                                                                           |\n| fixed_ips             | {\"subnet_id\": \"8e6aaf8e-78e8-42d7-9b59-f96789728abc\", \"ip_address\": \"10.0.0.12\"}                          |\n|                       | {\"subnet_id\": \"4210fe1c-b156-4ecb-a896-922c87f85c3f\", \"ip_address\": \"fdab:2588:f4:0:f816:3eff:fe37:acba\"} |\n| id                    | 657990ce-3446-40a2-bc33-8040a32cb72b                                                                      |\n| mac_address           | 90:e2:ba:48:27:ed                                                                                         |\n| name                  | sriov_port                                                                                                |\n| network_id            | dfdff739-a27b-4160-9e40-c4824e8a351d                                                                      |\n| port_security_enabled | True                                                                                                      |\n| revision              | 57                                                                                                        |\n| security_groups       | 8c7b8173-f050-480d-968a-33e0b75332fc                                                                      |\n| status                | ACTIVE                                                                                                    |\n| tenant_id             | a11cb2aece1943c2a86ee0a55e1bd8f7                                                                          |\n| updated_at            | 2016-08-26T17:33:12                                                                                       |\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n\n5- Log in the guest and get a DHCP address for the interface.\n\nip link add link eth1 name eth1.451 type vlan id 451\nip link set eth1.451 up\ndhclient eth1.451\n\nNote the MAC address of the interface:\n\n4: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP qlen 1000\n    link/ether 90:e2:ba:48:27:ed brd ff:ff:ff:ff:ff:ff\n    inet6 fe80::92e2:baff:fe48:27ed/64 scope link \n       valid_lft forever preferred_lft forever\n5: eth1.451@eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP \n    link/ether 90:e2:ba:48:27:ed brd ff:ff:ff:ff:ff:ff\n    inet 10.0.0.12/24 brd 10.0.0.255 scope global eth1.451\n       valid_lft forever preferred_lft forever\n    inet6 fdab:2588:f4:0:92e2:baff:fe48:27ed/64 scope global dynamic \n       valid_lft 86396sec preferred_lft 14396sec\n    inet6 fe80::92e2:baff:fe48:27ed/64 scope link \n       valid_lft forever preferred_lft forever\n\n6- Resize the guest\n\n7- Note the MAC address of the neutron port (after resize):\n\n[centos@IronPass-2 devstack]$ neutron port-show 657990ce-3446-40a2-bc33-8040a32cb72b\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n| Field                 | Value                                                                                                     |\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n| admin_state_up        | True                                                                                                      |\n| allowed_address_pairs |                                                                                                           |\n| binding:vnic_type     | direct-physical                                                                                           |\n| created_at            | 2016-08-26T14:57:07                                                                                       |\n| description           |                                                                                                           |\n| device_id             | f1005ec2-1875-4345-af01-58afaee7e68d                                                                      |\n| device_owner          | compute:None                                                                                              |\n| extra_dhcp_opts       |                                                                                                           |\n| fixed_ips             | {\"subnet_id\": \"8e6aaf8e-78e8-42d7-9b59-f96789728abc\", \"ip_address\": \"10.0.0.12\"}                          |\n|                       | {\"subnet_id\": \"4210fe1c-b156-4ecb-a896-922c87f85c3f\", \"ip_address\": \"fdab:2588:f4:0:f816:3eff:fe37:acba\"} |\n| id                    | 657990ce-3446-40a2-bc33-8040a32cb72b                                                                      |\n| mac_address           | 90:e2:ba:48:27:ed                                                                                         |\n| name                  | sriov_port                                                                                                |\n| network_id            | dfdff739-a27b-4160-9e40-c4824e8a351d                                                                      |\n| port_security_enabled | True                                                                                                      |\n| revision              | 59                                                                                                        |\n| security_groups       | 8c7b8173-f050-480d-968a-33e0b75332fc                                                                      |\n| status                | ACTIVE                                                                                                    |\n| tenant_id             | a11cb2aece1943c2a86ee0a55e1bd8f7                                                                          |\n| updated_at            | 2016-08-26T17:38:30                                                                                       |\n+-----------------------+-----------------------------------------------------------------------------------------------------------+\n\nNotice that it's still hasn't changed: 90:e2:ba:48:27:ed\n\n8- Log in the guest and get a DHCP address for the interface.\n\nip link add link eth1 name eth1.451 type vlan id 451\nip link set eth1.451 up\ndhclient eth1.451\n\nNote the MAC address of the interface has changed:\n\n4: eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP qlen 1000\n    link/ether 00:1e:67:51:36:71 brd ff:ff:ff:ff:ff:ff\n    inet6 fe80::21e:67ff:fe51:3671/64 scope link \n       valid_lft forever preferred_lft forever\n5: eth2.451@eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP \n    link/ether 00:1e:67:51:36:71 brd ff:ff:ff:ff:ff:ff\n    inet6 fe80::21e:67ff:fe51:3671/64 scope link \n       valid_lft forever preferred_lft forever\n\nAlso note that the DHCP client wasn't successful in getting a DHCP address.\n\n9- From the dnsmasq host file, we can also see that it hasn't been updated:\n\ncat /opt/stack/data/neutron/dhcp/dfdff739-a27b-4160-9e40-c4824e8a351d/host\nfa:16:3e:e5:e0:c9,host-10-0-0-2.openstacklocal,10.0.0.2\n90:e2:ba:48:27:ed,host-10-0-0-12.openstacklocal,10.0.0.12\nfa:16:3e:99:c8:b9,host-10-0-0-5.openstacklocal,10.0.0.5\n\n\nEnvironment:\n============\n\nLatest master\n\ncommit 7500bef94f526a82392400415f07f744700324a9\nMerge: 8d5aff7 39fb302\nAuthor: Jenkins <email address hidden>\nDate:   Fri Aug 26 05:03:48 2016 +0000\n\n    Merge \"Revert \"Optional separate database for placement API\"\"", 
            "date_created": "2016-08-26 19:33:05.091854+00:00", 
            "author": "https://api.launchpad.net/1.0/~ludovic-beliveau"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/361438", 
            "date_created": "2016-08-30 16:49:39.134782+00:00", 
            "author": "https://api.launchpad.net/1.0/~ludovic-beliveau"
        }
    ]
}