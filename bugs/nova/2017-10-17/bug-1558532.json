{
    "status": "Fix Released", 
    "last_updated": "2016-06-02 19:33:07.331409+00:00", 
    "description": "1. version\nkilo 2015.1.0\n\n2.Relevant log files:\nnova-scheduler.log\n\uff08Log contains \u201c========\u201d  is added by myself\uff09\n\n2016-03-17 17:54:23.092 15208 DEBUG nova.scheduler.filters.affinity_filter [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] ================group_hosts: '[u'SBCJNailSlot3', u'sbcj-chenling-02-slot11']' host_passes /usr/lib/python2.7/site-packages/nova/scheduler/filters/affinity_filter.py:98\n2016-03-17 17:54:23.093 15208 DEBUG nova.scheduler.filters.affinity_filter [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] Group anti affinity: check if sbcj-chenling-02-slot11 not in [u'SBCJNailSlot3', u'sbcj-chenling-02-slot11'] host_passes /usr/lib/python2.7/site-packages/nova/scheduler/filters/affinity_filter.py:101\n2016-03-17 17:54:23.094 15208 DEBUG nova.scheduler.filters.affinity_filter [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] ================group_hosts: '[u'SBCJNailSlot3', u'sbcj-chenling-02-slot11']' host_passes /usr/lib/python2.7/site-packages/nova/scheduler/filters/affinity_filter.py:98\n2016-03-17 17:54:23.094 15208 DEBUG nova.scheduler.filters.affinity_filter [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] Group anti affinity: check if SBCJNailSlot3 not in [u'SBCJNailSlot3', u'sbcj-chenling-02-slot11'] host_passes /usr/lib/python2.7/site-packages/nova/scheduler/filters/affinity_filter.py:101\n2016-03-17 17:54:23.094 15208 INFO nova.filters [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] Filter ServerGroupAntiAffinityFilter returned 0 hosts for instance c48ee7d6-451e-4b96-ac39-261082f8950e\n2016-03-17 17:54:23.095 15208 DEBUG nova.scheduler.filter_scheduler [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] There are 0 hosts available but 1 instances requested to build. select_destinations /usr/lib/python2.7/site-packages/nova/scheduler/filter_scheduler.py:77\n\n3.Reproduce steps:\n*3.1\ncreate a anti-affinity group with policy 'anti-affinity' named \"antiaffinitygroup\"\nboot two vms using \"antiaffinitygroup\",named \"test_wzz1\" and \"test_wzz2\"\n\nresults:\n[root@sbcj-chenling-02-slot11 ~(keystone_admin)]# nova list\n+--------------------------------------+-----------+--------+------------+-------------+-------------------+\n| ID                                   | Name      | Status | Task State | Power State | Networks          |\n+--------------------------------------+-----------+--------+------------+-------------+-------------------+\n| c48ee7d6-451e-4b96-ac39-261082f8950e | test_wzz1 | ACTIVE | -          | Running     | test0301=3.3.3.60 |\n| 55107de8-38bc-4b3a-8681-df17746e4f11 | test_wzz2 | ACTIVE | -          | Running     | test0301=3.3.3.61 |\n+--------------------------------------+-----------+--------+------------+-------------+-------------------+\n\n[root@sbcj-chenling-02-slot11 ~(keystone_admin)]# nova server-group-list\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n| Id                                   | Name              | Policies           | Members                                                                            | Metadata |\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n| 79ebfbfc-6e7c-4bf0-97c5-14d7fca22e96 | antiaffinitygroup | [u'anti-affinity'] | [u'55107de8-38bc-4b3a-8681-df17746e4f11', u'c48ee7d6-451e-4b96-ac39-261082f8950e'] | {}       |\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n\n*3.2\nI have two compute nodes\uff1asbcj-chenling-02-slot11\uff0cSBCJNailSlot3.\nThe vm test_wzz1 in SBCJNailSlot3,and the test_wzz2 in sbcj-chenling-02-slot11,because of the anti-affinity group\n Then set allow_resize_to_same_host=true,and add ServerGroupAntiAffinityFilter in scheduler_default_filters in nova.conf,and restart services.\n\n*3.3\n now\uff0cexecute the command : nova resize test_wzz1 m1.small\n\nExample\uff1a\n[root@sbcj-chenling-02-slot11 ~(keystone_admin)]# nova resize test_wzz1 m1.small\n\nExpected result:\nvm resize to the same host successfully.\n\nActual result:\nERROR (BadRequest): No valid host was found. No valid host found for resize: No valid host was found. There are not enough hosts available. (HTTP 400) (Request-ID: req-3612987d-bef8-4727-811f-1dd668ac3328)\nRelevant log files: See section 2\n\n4.Bonus points for reproducing shell script / test:\nOperation cold-migration has the same problem.\nIt seems  test_wzz1 anti-affinity against to itself,so resize failed although we allow vm resize to same host.\nThis is unreasonable.", 
    "tags": [
        "resize", 
        "scheduler"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1558532", 
    "owner": "https://api.launchpad.net/1.0/~hanrong", 
    "id": 1558532, 
    "index": 7374, 
    "openned": "2016-03-17 12:39:24.981908+00:00", 
    "created": "2016-03-17 12:39:24.981908+00:00", 
    "title": "AntiAffinity policy problems with resize and migrate to same host", 
    "comments": [
        {
            "content": "1. version\nkilo 2015.1.0\n\n2.Relevant log files:\nnova-scheduler.log\n\uff08Log contains \u201c========\u201d  is added by myself\uff09\n\n2016-03-17 17:54:23.092 15208 DEBUG nova.scheduler.filters.affinity_filter [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] ================group_hosts: '[u'SBCJNailSlot3', u'sbcj-chenling-02-slot11']' host_passes /usr/lib/python2.7/site-packages/nova/scheduler/filters/affinity_filter.py:98\n2016-03-17 17:54:23.093 15208 DEBUG nova.scheduler.filters.affinity_filter [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] Group anti affinity: check if sbcj-chenling-02-slot11 not in [u'SBCJNailSlot3', u'sbcj-chenling-02-slot11'] host_passes /usr/lib/python2.7/site-packages/nova/scheduler/filters/affinity_filter.py:101\n2016-03-17 17:54:23.094 15208 DEBUG nova.scheduler.filters.affinity_filter [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] ================group_hosts: '[u'SBCJNailSlot3', u'sbcj-chenling-02-slot11']' host_passes /usr/lib/python2.7/site-packages/nova/scheduler/filters/affinity_filter.py:98\n2016-03-17 17:54:23.094 15208 DEBUG nova.scheduler.filters.affinity_filter [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] Group anti affinity: check if SBCJNailSlot3 not in [u'SBCJNailSlot3', u'sbcj-chenling-02-slot11'] host_passes /usr/lib/python2.7/site-packages/nova/scheduler/filters/affinity_filter.py:101\n2016-03-17 17:54:23.094 15208 INFO nova.filters [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] Filter ServerGroupAntiAffinityFilter returned 0 hosts for instance c48ee7d6-451e-4b96-ac39-261082f8950e\n2016-03-17 17:54:23.095 15208 DEBUG nova.scheduler.filter_scheduler [req-3612987d-bef8-4727-811f-1dd668ac3328 eae626536b034af1a3635a36645dc54a 4d054614f49644c1935bdade9703c99b - - -] There are 0 hosts available but 1 instances requested to build. select_destinations /usr/lib/python2.7/site-packages/nova/scheduler/filter_scheduler.py:77\n\n3.Reproduce steps:\n*3.1\ncreate a anti-affinity group with policy 'anti-affinity' named \"antiaffinitygroup\"\nboot two vms using \"antiaffinitygroup\",named \"test_wzz1\" and \"test_wzz2\"\n\nresults:\n[root@sbcj-chenling-02-slot11 ~(keystone_admin)]# nova list\n+--------------------------------------+-----------+--------+------------+-------------+-------------------+\n| ID                                   | Name      | Status | Task State | Power State | Networks          |\n+--------------------------------------+-----------+--------+------------+-------------+-------------------+\n| c48ee7d6-451e-4b96-ac39-261082f8950e | test_wzz1 | ACTIVE | -          | Running     | test0301=3.3.3.60 |\n| 55107de8-38bc-4b3a-8681-df17746e4f11 | test_wzz2 | ACTIVE | -          | Running     | test0301=3.3.3.61 |\n+--------------------------------------+-----------+--------+------------+-------------+-------------------+\n\n[root@sbcj-chenling-02-slot11 ~(keystone_admin)]# nova server-group-list\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n| Id                                   | Name              | Policies           | Members                                                                            | Metadata |\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n| 79ebfbfc-6e7c-4bf0-97c5-14d7fca22e96 | antiaffinitygroup | [u'anti-affinity'] | [u'55107de8-38bc-4b3a-8681-df17746e4f11', u'c48ee7d6-451e-4b96-ac39-261082f8950e'] | {}       |\n+--------------------------------------+-------------------+--------------------+------------------------------------------------------------------------------------+----------+\n\n*3.2\nI have two compute nodes\uff1asbcj-chenling-02-slot11\uff0cSBCJNailSlot3.\nThe vm test_wzz1 in SBCJNailSlot3,and the test_wzz2 in sbcj-chenling-02-slot11,because of the anti-affinity group\n Then set allow_resize_to_same_host=true,and add ServerGroupAntiAffinityFilter in scheduler_default_filters in nova.conf,and restart services.\n\n*3.3\n now\uff0cexecute the command : nova resize test_wzz1 m1.small\n\nExample\uff1a\n[root@sbcj-chenling-02-slot11 ~(keystone_admin)]# nova resize test_wzz1 m1.small\n\nExpected result:\nvm resize to the same host successfully.\n\nActual result:\nERROR (BadRequest): No valid host was found. No valid host found for resize: No valid host was found. There are not enough hosts available. (HTTP 400) (Request-ID: req-3612987d-bef8-4727-811f-1dd668ac3328)\nRelevant log files: See section 2\n\n4.Bonus points for reproducing shell script / test:\nOperation cold-migration has the same problem.\nIt seems  test_wzz1 anti-affinity against to itself,so resize failed although we allow vm resize to same host.\nThis is unreasonable.", 
            "date_created": "2016-03-17 12:39:24.981908+00:00", 
            "author": "https://api.launchpad.net/1.0/~wang-zengzhi"
        }, 
        {
            "content": "Have you reproduced this on the latest master branch code or newton rc1?", 
            "date_created": "2016-03-17 14:42:59.033974+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I reproduced this in the latest master branche code.\n[tecs@tecs-OpenStack-Nova devstack(keystone_admin)]$ git log -1\ncommit 0a2a7ae8471575d887a19b9bf8b7375ea1fd7f45\nMerge: 467dbf7 8ff298a\nAuthor: Jenkins <email address hidden>\nDate:   Fri Mar 18 20:24:03 2016 +0000\n\n    Merge \"Updated deprecated keystone_authtoken option\"\n[tecs@tecs-OpenStack-Nova devstack(keystone_admin)]$ \n\n", 
            "date_created": "2016-03-29 02:27:23.980267+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "Only one compute node.\n\n1. create anti-affinity group\n$ nova server-group-create --policy anti-affinity antiaffinitygroup\nWARNING: Option \"--policy\" is deprecated; use positional parameters; this option will be removed in novaclient 3.3.0.\n+--------------------------------------+-------------------+----------------------------------+----------------------------------+--------------------+---------+----------+\n| Id                                   | Name              | Project Id                       | User Id                          | Policies           | Members | Metadata |\n+--------------------------------------+-------------------+----------------------------------+----------------------------------+--------------------+---------+----------+\n| 107174bc-9694-43cd-a6de-b4eb98cc8435 | antiaffinitygroup | 5c4790fed10549fcaf1f3f47a2b3ab7e | 823805f0ade648ac9a69803d7f1d8cfc | [u'anti-affinity'] | []      | {}       |\n+--------------------------------------+-------------------+----------------------------------+----------------------------------+--------------------+---------+----------+\n\n2. boot a instance in this group\n$ nova boot --flavor 1 --image 425846b1-4fc8-428a-ac8a-3251a88ba7c8 --nic net-id=274d04e3-fbfc-497c-b3b2-3ce6d07c290b --hint group=107174bc-9694-43cd-a6de-b4eb98cc8435 hanrong_in_gourp1\n\n3. nova list\n+--------------------------------------+-------------------+--------+------------+-------------+--------------------------------+\n| ID                                   | Name              | Status | Task State | Power State | Networks                       |\n+--------------------------------------+-------------------+--------+------------+-------------+--------------------------------+\n| 7a03f518-8726-4348-9caa-7ad5e8b67c92 | hanrong_in_gourp1 | ACTIVE | -          | Running     | public=2001:db8::5, 172.24.4.5 |\n+--------------------------------------+-------------------+--------+------------+-------------+--------------------------------+\n\n4. $ nova flavor-create hanrong 111 512 1 2\n+-----+---------+-----------+------+-----------+------+-------+-------------+-----------+\n| ID  | Name    | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |\n+-----+---------+-----------+------+-----------+------+-------+-------------+-----------+\n| 111 | hanrong | 512       | 1    | 0         |      | 2     | 1.0         | True      |\n+-----+---------+-----------+------+-----------+------+-------+-------------+-----------+\n\n5.  nova resize 7a03f518-8726-4348-9caa-7ad5e8b67c92 111\nERROR (BadRequest): No valid host was found. No valid host found for resize (HTTP 400) (Request-ID: req-23bd6d72-15ea-40a9-8cb0-b87dfee9a7ac)\n\n\n6.  log: n-sch.log\n2016-03-29 10:22:28.060 ^[[00;36mINFO nova.filters [^[[01;36mreq-23bd6d72-15ea-40a9-8cb0-b87dfee9a7ac ^[[00;36madmin admin^[[00;36m] ^[[01;35m^[[00;36mFilter ServerGroupAntiAffinityFilter returned 0 hosts^[[00m\n2016-03-29 10:22:28.060 ^[[00;32mDEBUG nova.filters [^[[01;36mreq-23bd6d72-15ea-40a9-8cb0-b87dfee9a7ac ^[[00;36madmin admin^[[00;32m] ^[[01;35m^[[00;32mFiltering removed all hosts for the request with instance ID '7a03f518-8726-4348-9caa-7ad5e8b67c92'. Filter results: [('RetryFilter', [(u'tecs-OpenStack-Nova', u'tecs-OpenStack-Nova')]), ('AvailabilityZoneFilter', [(u'tecs-OpenStack-Nova', u'tecs-OpenStack-Nova')]), ('RamFilter', [(u'tecs-OpenStack-Nova', u'tecs-OpenStack-Nova')]), ('DiskFilter', [(u'tecs-OpenStack-Nova', u'tecs-OpenStack-Nova')]), ('ComputeFilter', [(u'tecs-OpenStack-Nova', u'tecs-OpenStack-Nova')]), ('ComputeCapabilitiesFilter', [(u'tecs-OpenStack-Nova', u'tecs-OpenStack-Nova')]), ('ImagePropertiesFilter', [(u'tecs-OpenStack-Nova', u'tecs-OpenStack-Nova')]), ('ServerGroupAntiAffinityFilter', None)]^[[00m ^[[00;33mfrom (pid=4768) get_filtered_objects /opt/stack/nova/nova/filters.py:129^[[00m\n2016-03-29 10:22:28.061 ^[[00;36mINFO nova.filters [^[[01;36mreq-23bd6d72-15ea-40a9-8cb0-b87dfee9a7ac ^[[00;36madmin admin^[[00;36m] ^[[01;35m^[[00;36mFiltering removed all hosts for the request with instance ID '7a03f518-8726-4348-9caa-7ad5e8b67c92'. Filter results: ['RetryFilter: (start: 1, end: 1)', 'AvailabilityZoneFilter: (start: 1, end: 1)', 'RamFilter: (start: 1, end: 1)', 'DiskFilter: (start: 1, end: 1)', 'ComputeFilter: (start: 1, end: 1)', 'ComputeCapabilitiesFilter: (start: 1, end: 1)', 'ImagePropertiesFilter: (start: 1, end: 1)', 'ServerGroupAntiAffinityFilter: (start: 1, end: 0)']^[[00m\n\n('ServerGroupAntiAffinityFilter', None)", 
            "date_created": "2016-03-29 02:39:14.566498+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/299045", 
            "date_created": "2016-03-30 00:41:29.433820+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/299045\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=609adcd38cdcc8e1906d8b4f93a72b7fa2032817\nSubmitter: Jenkins\nBranch:    master\n\ncommit 609adcd38cdcc8e1906d8b4f93a72b7fa2032817\nAuthor: zte-hanrong <email address hidden>\nDate:   Tue Mar 29 20:19:01 2016 +0800\n\n    Fix resize to same host failed using anti-affinity group\n    \n    ServerGroupAntiAffinityFilter selects host which is not in in the\n    hosts of the members of the group. An instance does not have\n    anti-affinity with itself.\n    The current code has problem when select hosts, the instance's\n    current host will be filtered out by ServerGroupAntiAffinityFilter.\n    This can lead to failure when resize an instance with anti-affinity\n    group to the same host.\n    \n    In this patch, ServerGroupAntiAffinityFite is modified.\n    \n    Change-Id: Ie016f59f5b98bb9c70b3e33556bd747f79fc77bd\n    Closes-Bug:#1558532\n", 
            "date_created": "2016-05-23 15:38:58.561644+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b1 development milestone.", 
            "date_created": "2016-06-02 19:33:06.625530+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }
    ], 
    "closed": "2016-05-23 15:38:55.940808+00:00"
}