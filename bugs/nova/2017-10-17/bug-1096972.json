{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:01:25.131711+00:00", 
    "description": "Using the latest Nova Grizzly nova code (a2f260f). I'm seeing the following Exception in /var/log/nova/compute.log on Fedora 17:\n\n2013-01-07 12:23:15 ERROR nova.manager [req-73d075a9-fd5b-4c9a-b4ad-efcd6125217f None None] Error during ComputeManager._sync_power_states: Instance 5aadd494-9a15-40be-b351-f8899f03c3e6 could not be found.\n2013-01-07 12:23:15 27683 TRACE nova.manager Traceback (most recent call last):\n2013-01-07 12:23:15 27683 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/nova/manager.py\", line 229, in periodic_tasks\n2013-01-07 12:23:15 27683 TRACE nova.manager     task(self, context)\n2013-01-07 12:23:15 27683 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 3174, in _sync_power_states\n2013-01-07 12:23:15 27683 TRACE nova.manager     db_instance['uuid'])\n2013-01-07 12:23:15 27683 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/api.py\", line 83, in instance_get_by_uuid\n2013-01-07 12:23:15 27683 TRACE nova.manager     return self._manager.instance_get_by_uuid(context, instance_uuid)\n2013-01-07 12:23:15 27683 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/api.py\", line 62, in wrapper\n2013-01-07 12:23:15 27683 TRACE nova.manager     raise (e._exc_info[1], None, e._exc_info[2])\n2013-01-07 12:23:15 27683 TRACE nova.manager InstanceNotFound: Instance 5aadd494-9a15-40be-b351-f8899f03c3e6 could not be found.\n\n----\n\nThe issue seems to be that in commit (d22b0ca2402d9625cea7460050e3fc77e7e2ea85) we moved all the instance_get_*() over to use conductor functions. The issue seems to be that the new queries (all of which eventually use instance_get_all_by_filters in the DB api) now include deleted records by default.\n\nPreviously the calls ultimately use the DB API's query_model call which used the context to determine whether deleted records should be used.\n\nWe either need to:\n\n-update the new calls to use the context for backwards compatability with the old function.\n-update the new calls to explicitly pass 'deleted' in all the cases that they should (sync_power_states would need to do this for example)", 
    "tags": [], 
    "importance": "Critical", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1096972", 
    "owner": "https://api.launchpad.net/1.0/~dan-prince", 
    "id": 1096972, 
    "index": 107, 
    "openned": "2013-01-07 17:49:14.967724+00:00", 
    "created": "2013-01-07 17:49:14.967724+00:00", 
    "title": "sync_power_states fails because it queries for deleted instances", 
    "comments": [
        {
            "content": "Using the latest Nova Grizzly nova code (a2f260f). I'm seeing the following Exception in /var/log/nova/compute.log on Fedora 17:\n\n2013-01-07 12:23:15 ERROR nova.manager [req-73d075a9-fd5b-4c9a-b4ad-efcd6125217f None None] Error during ComputeManager._sync_power_states: Instance 5aadd494-9a15-40be-b351-f8899f03c3e6 could not be found.\n2013-01-07 12:23:15 27683 TRACE nova.manager Traceback (most recent call last):\n2013-01-07 12:23:15 27683 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/nova/manager.py\", line 229, in periodic_tasks\n2013-01-07 12:23:15 27683 TRACE nova.manager     task(self, context)\n2013-01-07 12:23:15 27683 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 3174, in _sync_power_states\n2013-01-07 12:23:15 27683 TRACE nova.manager     db_instance['uuid'])\n2013-01-07 12:23:15 27683 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/api.py\", line 83, in instance_get_by_uuid\n2013-01-07 12:23:15 27683 TRACE nova.manager     return self._manager.instance_get_by_uuid(context, instance_uuid)\n2013-01-07 12:23:15 27683 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/api.py\", line 62, in wrapper\n2013-01-07 12:23:15 27683 TRACE nova.manager     raise (e._exc_info[1], None, e._exc_info[2])\n2013-01-07 12:23:15 27683 TRACE nova.manager InstanceNotFound: Instance 5aadd494-9a15-40be-b351-f8899f03c3e6 could not be found.\n\n----\n\nThe issue seems to be that in commit (d22b0ca2402d9625cea7460050e3fc77e7e2ea85) we moved all the instance_get_*() over to use conductor functions. The issue seems to be that the new queries (all of which eventually use instance_get_all_by_filters in the DB api) now include deleted records by default.\n\nPreviously the calls ultimately use the DB API's query_model call which used the context to determine whether deleted records should be used.\n\nWe either need to:\n\n-update the new calls to use the context for backwards compatability with the old function.\n-update the new calls to explicitly pass 'deleted' in all the cases that they should (sync_power_states would need to do this for example)", 
            "date_created": "2013-01-07 17:49:14.967724+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/19113", 
            "date_created": "2013-01-07 18:22:37.672754+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/19113\nCommitted: http://github.com/openstack/nova/commit/0ca44e958461ee140b97d074fcf7866cc6ac6645\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0ca44e958461ee140b97d074fcf7866cc6ac6645\nAuthor: Dan Prince <email address hidden>\nDate:   Mon Jan 7 13:19:03 2013 -0500\n\n    Conductor instance_get_all replaces _by_filters\n    \n    Updates the Nova conductor so that it uses instance_get_all()\n    and instance_get_all_by_host() from the Nova DB API to\n    implement its own like named functions.\n    \n    This fixes a regression that occured in d22b0ca where we switched\n    from using the DB API's instance_get_all_by_host and instance_get_all\n    methods over to the DB APIs instance_get_all_by_filters.\n    \n    This caused some subtle regressions due to the fact that\n    instance_get_all_by_filters has different defaults for\n    deleted records.\n    \n    The previously used (prior to d22b0ca) instance_get_all() and\n    instance_get_all_by_host() functions rely on the context.read_deleted\n    and also handle the display of deleted and soft deleted records differently.\n    \n    Fixes LP Bug #1096972.\n    \n    Change-Id: Icb587ef169d1d7dd86cf6ee682e74bd4e84c37e2\n", 
            "date_created": "2013-01-08 19:44:30.750373+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-01-09 10:19:39.601490+00:00"
}