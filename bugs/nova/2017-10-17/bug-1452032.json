{
    "status": "Invalid", 
    "last_updated": "2016-07-12 10:46:57.294946+00:00", 
    "description": "[Environment]\n\nOpenStack Kilo\nTrusty 14.04.4\n\n[Description]\n\nif the attached multipath devices doesn't have same iqn like regular lvm+iscsi backend, in_use will be false.\n\nIn that case,_disconnect_volume_multipath_iscsi() returns without calling _remove_multipath_device_descriptor().\n\n[Reproduction]\n\n1) Enable cinder LVM ISCSI on /etc/cinder/cinder.conf\n\nvolume_driver=cinder.volume.drivers.lvm.LVMISCSIDriver\n\n2) Enable iscsi_use_multipath on /etc/nova/nova.conf on your compute nodes:\n\niscsi_use_multipath = True\n\n3) Create 3 cinder volumes\n\n$ cinder create 1\n$ cinder create 1\n$ cinder create 1\n\n$ cinder list\n\nubuntu@niedbalski2-bastion:~/specs/1374999$ cinder list\n+--------------------------------------+----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |  Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+----------+--------------+------+-------------+----------+--------------------------------------+\n| 10844be6-8f86-414f-a10e-e1a31e2ba6e7 |  in-use  |     None     |  1   |     None    |  false   | b0a14447-5740-408a-b96f-a1e904b229e5 |\n| 1648d24c-0d65-4377-9fa5-6d3aeb8b1291 |  in-use  |     None     |  1   |     None    |  false   | b0a14447-5740-408a-b96f-a1e904b229e5 |\n| 53d6bb4e-2ca2-45ab-9ed1-887b1df2ff8f |  in-use  |     None     |  1   |     None    |  false   | b0a14447-5740-408a-b96f-a1e904b229e5 |\n+--------------------------------------+----------+--------------+------+-------------+----------+--------------------------------------+\n\n4) Attach them to nova\n\n$ nova volume-attach instance_id 10844be6-8f86-414f-a10e-e1a31e2ba6e7\n$ nova volume-attach instance_id 1648d24c-0d65-4377-9fa5-6d3aeb8b1291\n$ nova volume-attach instance_id 53d6bb4e-2ca2-45ab-9ed1-887b1df2ff8f\n\n5) Check on the nova-compute unit for the current multipath/session status\n\ntcp: [1] 10.5.1.43:3260,1 iqn.2010-10.org.openstack:volume-10844be6-8f86-414f-a10e-e1a31e2ba6e7\ntcp: [2] 10.5.1.43:3260,1 iqn.2010-10.org.openstack:volume-1648d24c-0d65-4377-9fa5-6d3aeb8b1291\ntcp: [3] 10.5.1.43:3260,1 iqn.2010-10.org.openstack:volume-53d6bb4e-2ca2-45ab-9ed1-887b1df2ff8f\n\nMultipath:\n\nroot@juju-1374999-machine-10:/home/ubuntu# multipath -ll\n33000000300000001 dm-2 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n\u00a0\u00a0`- 10:0:0:1 sdb 8:16   active ready  running\n33000000100000001 dm-0 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n\u00a0\u00a0`- 8:0:0:1  sdg 8:96   active ready  running\n33000000200000001 dm-1 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n\u00a0\u00a0`- 9:0:0:1  sda 8:0    active ready  running\n\n6) Detach the current volumes.\n\nFirst.\n\nubuntu@niedbalski2-bastion:~/specs/1374999$ nova volume-detach b0a14447-5740-408a-b96f-a1e904b229e5 10844be6-8f86-414f-a10e-e1a31e2ba6e7\n\nubuntu@niedbalski2-bastion:~/specs/1374999$ juju ssh 10 \"sudo multipath -ll\"\n33000000300000001 dm-2 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n\u00a0\u00a0`- 10:0:0:1 sdb 8:16   active ready  running\n33000000100000001 dm-0 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n\u00a0\u00a0`- #:#:#:#  -   #:#    active faulty running\n33000000200000001 dm-1 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n\u00a0\u00a0`- 9:0:0:1  sda 8:0    active ready  running\n\nSecond raises the faulty state\n\n33000000300000001 dm-2 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n\u00a0\u00a0`- 10:0:0:1 sdb 8:16   active ready  running\n33000000100000001 dm-0 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n\u00a0\u00a0`- #:#:#:#  -   #:#    active faulty running\n33000000200000001 dm-1 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n\u00a0\u00a0`- #:#:#:#  -   #:#    active faulty running\n\nThird, raises the faulty state also\n\nsudo: unable to resolve host juju-1374999-machine-10\n33000000300000001 dm-2 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n\u00a0\u00a0`- #:#:#:# -   #:#    active faulty running\n33000000100000001 dm-0 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n\u00a0\u00a0`- #:#:#:# -   #:#    active faulty running\n33000000200000001 dm-1 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n\u00a0\u00a0`- #:#:#:# -   #:#    active faulty running\n\n\nManual fix.\n\nroot@juju-1374999-machine-10:/home/ubuntu# multipath -F 33000000300000001\nroot@juju-1374999-machine-10:/home/ubuntu# multipath -F 33000000100000001\nroot@juju-1374999-machine-10:/home/ubuntu# multipath -F 33000000200000001", 
    "tags": [
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1452032", 
    "owner": "https://api.launchpad.net/1.0/~niedbalski", 
    "id": 1452032, 
    "index": 6791, 
    "openned": "2015-05-05 21:29:37.146598+00:00", 
    "created": "2015-05-05 21:29:37.146598+00:00", 
    "title": "Device descriptor not removed with different iqn and multipath enabled.", 
    "comments": [
        {
            "content": "[Environment]\n\nOpenStack Kilo\nTrusty 14.04.4\n\n[Description]\n\nif the attached multipath devices doesn't have same iqn like regular lvm+iscsi backend, in_use will be false. \n\nIn that case,_disconnect_volume_multipath_iscsi() returns without calling _remove_multipath_device_descriptor().\n\n[Reproduction]\n\n1) Enable cinder LVM ISCSI on /etc/cinder/cinder.conf \n\nvolume_driver=cinder.volume.drivers.lvm.LVMISCSIDriver\n\n\n2) Enable iscsi_use_multipath on /etc/nova/nova.conf on your compute nodes:\n\niscsi_use_multipath = True\n\n\n3) Create 3 cinder volumes  \n\n$ cinder create 1\n$ cinder create 1\n$ cinder create 1\n\n$ cinder list\n\nubuntu@niedbalski2-bastion:~/specs/1374999$ cinder list\n+--------------------------------------+----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |  Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+----------+--------------+------+-------------+----------+--------------------------------------+\n| 10844be6-8f86-414f-a10e-e1a31e2ba6e7 |  in-use  |     None     |  1   |     None    |  false   | b0a14447-5740-408a-b96f-a1e904b229e5 |\n| 1648d24c-0d65-4377-9fa5-6d3aeb8b1291 |  in-use  |     None     |  1   |     None    |  false   | b0a14447-5740-408a-b96f-a1e904b229e5 |\n| 53d6bb4e-2ca2-45ab-9ed1-887b1df2ff8f |  in-use  |     None     |  1   |     None    |  false   | b0a14447-5740-408a-b96f-a1e904b229e5 |\n+--------------------------------------+----------+--------------+------+-------------+----------+--------------------------------------+\n\n\n4) Attach them to nova\n\n$ nova volume-attach instance_id 10844be6-8f86-414f-a10e-e1a31e2ba6e7\n$ nova volume-attach instance_id 1648d24c-0d65-4377-9fa5-6d3aeb8b1291\n$ nova volume-attach instance_id 53d6bb4e-2ca2-45ab-9ed1-887b1df2ff8f \n\n5) Check on the nova-compute unit for the current multipath/session status\n\ntcp: [1] 10.5.1.43:3260,1 iqn.2010-10.org.openstack:volume-10844be6-8f86-414f-a10e-e1a31e2ba6e7\ntcp: [2] 10.5.1.43:3260,1 iqn.2010-10.org.openstack:volume-1648d24c-0d65-4377-9fa5-6d3aeb8b1291\ntcp: [3] 10.5.1.43:3260,1 iqn.2010-10.org.openstack:volume-53d6bb4e-2ca2-45ab-9ed1-887b1df2ff8f\n\nMultipath:\n\nroot@juju-1374999-machine-10:/home/ubuntu# multipath -ll\n33000000300000001 dm-2 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n  `- 10:0:0:1 sdb 8:16   active ready  running\n33000000100000001 dm-0 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n  `- 8:0:0:1  sdg 8:96   active ready  running\n33000000200000001 dm-1 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n  `- 9:0:0:1  sda 8:0    active ready  running\n\n6) Detach the current volumes.\n\nFirst.\n\nubuntu@niedbalski2-bastion:~/specs/1374999$ nova volume-detach b0a14447-5740-408a-b96f-a1e904b229e5 10844be6-8f86-414f-a10e-e1a31e2ba6e7\n\n\nubuntu@niedbalski2-bastion:~/specs/1374999$ juju ssh 10 \"sudo multipath -ll\"\n33000000300000001 dm-2 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n  `- 10:0:0:1 sdb 8:16   active ready  running\n33000000100000001 dm-0 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n  `- #:#:#:#  -   #:#    active faulty running\n33000000200000001 dm-1 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n  `- 9:0:0:1  sda 8:0    active ready  running\n\nSecond raises the faulty state\n\n33000000300000001 dm-2 IET,VIRTUAL-DISK\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=1 status=active\n  `- 10:0:0:1 sdb 8:16   active ready  running\n33000000100000001 dm-0 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n  `- #:#:#:#  -   #:#    active faulty running\n33000000200000001 dm-1 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n  `- #:#:#:#  -   #:#    active faulty running\n\nThird, raises the faulty state also\n\nsudo: unable to resolve host juju-1374999-machine-10\n33000000300000001 dm-2 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n  `- #:#:#:# -   #:#    active faulty running\n33000000100000001 dm-0 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n  `- #:#:#:# -   #:#    active faulty running\n33000000200000001 dm-1 ,\nsize=1.0G features='0' hwhandler='0' wp=rw\n`-+- policy='round-robin 0' prio=0 status=active\n  `- #:#:#:# -   #:#    active faulty running", 
            "date_created": "2015-05-05 21:29:37.146598+00:00", 
            "author": "https://api.launchpad.net/1.0/~niedbalski"
        }, 
        {
            "content": "This issue seems same as bug 1374999, which has a patch by Felipe Reyes: \nhttps://review.openstack.org/135382\n\nThe issue may be solved by the patch.", 
            "date_created": "2015-05-07 09:13:30.427584+00:00", 
            "author": "https://api.launchpad.net/1.0/~k-keiichi"
        }, 
        {
            "content": "Looks like this is invalid now os-brick has merged.", 
            "date_created": "2015-08-05 14:22:19.089160+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "@johngarbutt,\n\nI think this is still affecting stable releases.", 
            "date_created": "2015-08-05 14:49:52.179226+00:00", 
            "author": "https://api.launchpad.net/1.0/~niedbalski"
        }, 
        {
            "content": "Change abandoned by Michael Still (<email address hidden>) on branch: master\nReview: https://review.openstack.org/135382\nReason: It sounds like this patch is now obsolete. Please restore it if that isn't the case.", 
            "date_created": "2015-11-16 04:03:14.246993+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "So to fix this on stable releases, the bug should be targeted for that stable release.this is still invalid for master.", 
            "date_created": "2016-07-12 10:46:41.478678+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }
    ], 
    "closed": "2016-07-12 10:46:54.516608+00:00"
}