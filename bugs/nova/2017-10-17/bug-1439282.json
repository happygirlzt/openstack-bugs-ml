{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:28:24.763864+00:00", 
    "description": "A user reports:\n\nNova's Block device mappings can become invalid/inconsistent if errors are encountered while calling for Cinder to attach a volume. \n\n2014-12-18 11:14:41.594 19473 ERROR nova.compute.manager [req-6f65b7d5-0930-4adf-9b5f-dd20eb1a707e 96612f5455c44e95960e733c48eaccc9 1076a7e653b3465295131c495e7d4ae4] [instance: 463dbedc-00f4-4c66-a00-139a4d79a46e] Instance failed block device setup\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e] Traceback (most recent call last):\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 1706, in _prep_block\n_device\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     self.driver, self._await_block_device_map_created))\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 367, in attach_blo\nck_devices\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     map(_log_and_attach, block_device_mapping)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 365, in _log_and_a\nttach\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     bdm.attach(*attach_args, **attach_kwargs)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 322, in attach\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     volume_api, virt_driver)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 44, in wrapped\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     ret_val = method(obj, context, *args, **kwargs)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 255, in attach\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     self['mount_device'], mode=mode)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/volume/cinder.py\", line 173, in wrapper\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     res = method(self, ctx, volume_id, *args, **kwargs)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/volume/cinder.py\", line 262, in attach\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     mountpoint, mode=mode)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/cinderclient/v1/volumes.py\", line 266, in attach\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     'mode': mode})\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/cinderclient/v1/volumes.py\", line 250, in _action\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     return self.api.client.post(url, body=body)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 223, in post\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     return self._cs_request(url, 'POST', **kwargs)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 212, in _cs_request\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     raise exceptions.ConnectionError(msg)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e] ConnectionError: Unable to establish connection: HTTPConnectionPool(): Max retries exceeded with url: /v1/1076a7e653b3465295131c495e7d4ae4/volumes/d827b809-e069-4be5-a27c-264e7bcafa65/action\n\nFor example, the above trace led to Nova's block device mapping table listing the volume as being unattached , while Cinder lists the volume as attached.\n\nAs a result the volume is not removed when removing the instance as while the mapping is present the volume_id is NULL :\n\n2014-12-18 11:46:17.830 19473 WARNING nova.compute.manager [req-ec9207f8-5553-46da-ad3c-ec18805fa343 96612f5455c44e95960e733c48eaccc9 1076a7e653b3465295131c495e7d4ae4] [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e] Ignoring VolumeNotFound: Volume None could not be found.\n\nFinally even direct manual removal via the Cinder CLI is blocked as the volume is still listed as attached. The only workaround is to hack the DB to reset the attach_state of the volume.", 
    "tags": [
        "volumes"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1439282", 
    "owner": "https://api.launchpad.net/1.0/~ndipanov", 
    "id": 1439282, 
    "index": 4210, 
    "openned": "2015-04-01 15:46:42.389186+00:00", 
    "created": "2015-04-01 15:46:42.389186+00:00", 
    "title": "Cinder API errors and timeouts can cause Nova to not save data about volumes", 
    "comments": [
        {
            "content": "A user reports:\n\nNova's Block device mappings can become invalid/inconsistent if errors are encountered while calling for Cinder to attach a volume. \n\n2014-12-18 11:14:41.594 19473 ERROR nova.compute.manager [req-6f65b7d5-0930-4adf-9b5f-dd20eb1a707e 96612f5455c44e95960e733c48eaccc9 1076a7e653b3465295131c495e7d4ae4] [instance: 463dbedc-00f4-4c66-a00-139a4d79a46e] Instance failed block device setup\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e] Traceback (most recent call last):\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 1706, in _prep_block\n_device\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     self.driver, self._await_block_device_map_created))\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 367, in attach_blo\nck_devices\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     map(_log_and_attach, block_device_mapping)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 365, in _log_and_a\nttach\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     bdm.attach(*attach_args, **attach_kwargs)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 322, in attach\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     volume_api, virt_driver)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 44, in wrapped\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     ret_val = method(obj, context, *args, **kwargs)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/virt/block_device.py\", line 255, in attach\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     self['mount_device'], mode=mode)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/volume/cinder.py\", line 173, in wrapper\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     res = method(self, ctx, volume_id, *args, **kwargs)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/nova/volume/cinder.py\", line 262, in attach\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     mountpoint, mode=mode)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/cinderclient/v1/volumes.py\", line 266, in attach\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     'mode': mode})\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/cinderclient/v1/volumes.py\", line 250, in _action\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     return self.api.client.post(url, body=body)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 223, in post\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     return self._cs_request(url, 'POST', **kwargs)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]   File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 212, in _cs_request\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e]     raise exceptions.ConnectionError(msg)\n2014-12-18 11:14:41.594 19473 TRACE nova.compute.manager [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e] ConnectionError: Unable to establish connection: HTTPConnectionPool(): Max retries exceeded with url: /v1/1076a7e653b3465295131c495e7d4ae4/volumes/d827b809-e069-4be5-a27c-264e7bcafa65/action\n\nFor example, the above trace led to Nova's block device mapping table listing the volume as being unattached , while Cinder lists the volume as attached.\n\nAs a result the volume is not removed when removing the instance as while the mapping is present the volume_id is NULL :\n\n2014-12-18 11:46:17.830 19473 WARNING nova.compute.manager [req-ec9207f8-5553-46da-ad3c-ec18805fa343 96612f5455c44e95960e733c48eaccc9 1076a7e653b3465295131c495e7d4ae4] [instance: 463dbedc-00f4-4c66-a020-139a4d79a46e] Ignoring VolumeNotFound: Volume None could not be found.\n\nFinally even direct manual removal via the Cinder CLI is blocked as the volume is still listed as attached. The only workaround is to hack the DB to reset the attach_state of the volume.", 
            "date_created": "2015-04-01 15:46:42.389186+00:00", 
            "author": "https://api.launchpad.net/1.0/~ndipanov"
        }, 
        {
            "content": "Note that the attached state is due to the attach request actually succeeding on the cinder side, but the proxy/loadbalancer dropping the response due to a low timeout set.\n\nStill the way we handle this in nova code is not ideal:\n\nWhen we create a volume on cinder side, be it from a snapshot, or from an image - we really want to make sure the creted volume information is persisted immediately, before we proceed to do anything else that might cause an exception and data to not be recorded.", 
            "date_created": "2015-04-01 15:57:15.433022+00:00", 
            "author": "https://api.launchpad.net/1.0/~ndipanov"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/170087", 
            "date_created": "2015-04-02 11:31:19.736536+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/170088", 
            "date_created": "2015-04-02 11:31:29.354268+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/170087\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=746843d710b97db87ac12935eb5907d2c6f7d93b\nSubmitter: Jenkins\nBranch:    master\n\ncommit 746843d710b97db87ac12935eb5907d2c6f7d93b\nAuthor: Nikola Dipanov <email address hidden>\nDate:   Thu Apr 2 12:15:25 2015 +0100\n\n    virt: Fix block_device tests\n    \n    Several tests were not running (and would have been failing), and some\n    paths were not tested at all.\n    \n    Related-bug: #1439282\n    \n    Change-Id: I0f6bbfbb526fdefd372b1036aaef2c1dc1fcd21e\n", 
            "date_created": "2015-04-02 17:40:51.157716+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/170088\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c083743062e2044ff9af0b7d7ccb19a935b448e2\nSubmitter: Jenkins\nBranch:    master\n\ncommit c083743062e2044ff9af0b7d7ccb19a935b448e2\nAuthor: Nikola Dipanov <email address hidden>\nDate:   Thu Apr 2 12:28:16 2015 +0100\n\n    virt: Make sure block device info is persisted\n    \n    There are several methods that we wrap with a @update_db decorator,\n    which is to say that we want the data that changed on the object to be\n    persisted once the method has done it's work.\n    \n    However in case of exceptions, we would do some local cleanup and\n    propagate the exception to through the stack, which would cause the db\n    save to not happen (due to the way the 'update_db' decorator was\n    written).\n    \n    This is not ideal since some of those methods such as 'attach()' do\n    several interaction (with the Cinder API and libvirt for example), and\n    making sure that results of successfull ones are persisted in case of\n    a non immediate failure is important for later cleanup, and keeping\n    the system in a consistent state.\n    \n    This patch makes sure that we persist data to the DB at all times.\n    \n    Change-Id: Icf8dbe4e3b7fd65b3c7a5eb479d6be15ee504253\n    Closes-bug: #1439282\n", 
            "date_created": "2015-04-03 20:18:33.340145+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-04-10 09:21:45.247328+00:00"
}