{
    "status": "Fix Released", 
    "last_updated": "2017-02-03 19:08:15.426240+00:00", 
    "description": "Telemetry tests with postgres found a bug in the sql used to filter resource providers that is breaking their gate:\n\nhttp://logs.openstack.org/82/405682/8/check/gate-ceilometer-dsvm-tempest-plugin-postgresql-ubuntu-xenial/02f896f/logs/apache/placement-api.txt.gz?level=ERROR\n\nThe fix appears to be adding to the group_by on the usage join:\n\n         usage = usage.group_by(_ALLOC_TBL.c.resource_provider_id,\n-                               _ALLOC_TBL.c.resource_class_id)\n+                               _ALLOC_TBL.c.resource_class_id,\n+                               _ALLOC_TBL.c.consumer_id)\n\nNot sure about the ordering.\n\n(full log example below)\n\n\n\n\n\n\n\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler [req-f0c425b6-bd71-44ae-ae33-46ce688d53dd service placement] Uncaught exception\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler Traceback (most recent call last):\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/api/openstack/placement/handler.py\", line 195, in __call__\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return dispatch(environ, start_response, self._map)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/api/openstack/placement/handler.py\", line 122, in dispatch\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return handler(environ, start_response)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     resp = self.call_func(req, *args, **self.kwargs)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return self.func(req, *args, **kwargs)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/api/openstack/placement/util.py\", line 55, in decorated_function\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return f(req)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/api/openstack/placement/handlers/resource_provider.py\", line 305, in list_resource_providers\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     context, filters)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/objects/resource_provider.py\", line 695, in get_all_by_filters\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     resource_providers = cls._get_all_by_filters_from_db(context, filters)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/enginefacade.py\", line 894, in wrapper\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return fn(*args, **kwargs)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/objects/resource_provider.py\", line 675, in _get_all_by_filters_from_db\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return query.all()\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2613, in all\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return list(self)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2761, in __iter__\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return self._execute_and_instances(context)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2776, in _execute_and_instances\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     result = conn.execute(querycontext.statement, self._params)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 914, in execute\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return meth(self, multiparams, params)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return connection._execute_clauseelement(self, multiparams, params)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     compiled_sql, distilled_params\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     context)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1337, in _handle_dbapi_exception\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     util.raise_from_cause(newraise, exc_info)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 203, in raise_from_cause\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     reraise(type(exception), exception, tb=exc_tb, cause=cause)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     context)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     cursor.execute(statement, parameters)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler DBError: (psycopg2.ProgrammingError) column \"allocations.consumer_id\" must appear in the GROUP BY clause or be used in an aggregate function\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler LINE 2: ...ons.resource_provider_id AS resource_provider_id, allocation...\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler                                                              ^\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler  [SQL: 'SELECT resource_providers.created_at AS resource_providers_created_at, resource_providers.updated_at AS resource_providers_updated_at, resource_providers.id AS resource_providers_id, resource_providers.uuid AS resource_providers_uuid, resource_providers.name AS resource_providers_name, resource_providers.generation AS resource_providers_generation, resource_providers.can_host AS resource_providers_can_host \\\\nFROM resource_providers JOIN inventories ON resource_providers.id = inventories.resource_provider_id LEFT OUTER JOIN (SELECT allocations.resource_provider_id AS resource_provider_id, allocations.consumer_id AS consumer_id, allocations.resource_class_id AS resource_class_id, sum(allocations.used) AS used \\\\nFROM allocations \\\\nWHERE allocations.resource_class_id IN (%(resource_class_id_1)s, %(resource_class_id_2)s) GROUP BY allocations.resource_provider_id, allocations.resource_class_id) AS usage ON usage.resource_provider_id = inventories.resource_provider_id AND usage.resource_class_id = inventories.resource_class_id \\\\nWHERE resource_providers.can_host = %(can_host_1)s AND (inventories.resource_class_id = %(resource_class_id_3)s AND coalesce(usage.used, %(param_1)s) + %(coalesce_1)s <= (inventories.total - inventories.reserved) * inventories.allocation_ratio AND inventories.min_unit <= %(min_unit_1)s AND inventories.max_unit >= %(max_unit_1)s AND %(step_size_1)s %% inventories.step_size = %(param_2)s OR inventories.resource_class_id = %(resource_class_id_4)s AND coalesce(usage.used, %(param_3)s) + %(coalesce_2)s <= (inventories.total - inventories.reserved) * inventories.allocation_ratio AND inventories.min_unit <= %(min_unit_2)s AND inventories.max_unit >= %(max_unit_2)s AND %(step_size_2)s %% inventories.step_size = %(param_4)s) GROUP BY resource_providers.uuid \\\\nHAVING count(DISTINCT inventories.resource_class_id) = %(count_1)s'] [parameters: {'coalesce_2': 64, 'step_size_1': 1, 'count_1': 2, 'coalesce_1': 1, 'param_4': 0, 'step_size_2': 64, 'param_1': 0, 'param_3': 0, 'param_2': 0, 'can_host_1': 0, 'max_unit_2': 64, 'max_unit_1': 1, 'resource_class_id_1': 0, 'resource_class_id_3': 0, 'resource_class_id_2': 1, 'min_unit_2': 64, 'resource_class_id_4': 1, 'min_unit_1': 1}]", 
    "tags": [
        "db", 
        "placement", 
        "postgresql", 
        "scheduler"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1660959", 
    "owner": "https://api.launchpad.net/1.0/~sileht", 
    "id": 1660959, 
    "index": 2030, 
    "openned": "2017-02-01 12:36:21.484699+00:00", 
    "created": "2017-02-01 12:36:21.484699+00:00", 
    "title": "placement resource provider filtering does not work with postgres", 
    "comments": [
        {
            "content": "Telemetry tests with postgres found a bug in the sql used to filter resource providers that is breaking their gate:\n\nhttp://logs.openstack.org/82/405682/8/check/gate-ceilometer-dsvm-tempest-plugin-postgresql-ubuntu-xenial/02f896f/logs/apache/placement-api.txt.gz?level=ERROR\n\nThe fix appears to be adding to the group_by on the usage join:\n\n         usage = usage.group_by(_ALLOC_TBL.c.resource_provider_id,\n-                               _ALLOC_TBL.c.resource_class_id)\n+                               _ALLOC_TBL.c.resource_class_id,\n+                               _ALLOC_TBL.c.consumer_id)\n\nNot sure about the ordering.\n\n(full log example below)\n\n\n\n\n\n\n\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler [req-f0c425b6-bd71-44ae-ae33-46ce688d53dd service placement] Uncaught exception\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler Traceback (most recent call last):\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/api/openstack/placement/handler.py\", line 195, in __call__\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return dispatch(environ, start_response, self._map)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/api/openstack/placement/handler.py\", line 122, in dispatch\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return handler(environ, start_response)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     resp = self.call_func(req, *args, **self.kwargs)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return self.func(req, *args, **kwargs)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/api/openstack/placement/util.py\", line 55, in decorated_function\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return f(req)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/api/openstack/placement/handlers/resource_provider.py\", line 305, in list_resource_providers\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     context, filters)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/objects/resource_provider.py\", line 695, in get_all_by_filters\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     resource_providers = cls._get_all_by_filters_from_db(context, filters)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/enginefacade.py\", line 894, in wrapper\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return fn(*args, **kwargs)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/opt/stack/new/nova/nova/objects/resource_provider.py\", line 675, in _get_all_by_filters_from_db\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return query.all()\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2613, in all\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return list(self)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2761, in __iter__\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return self._execute_and_instances(context)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/query.py\", line 2776, in _execute_and_instances\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     result = conn.execute(querycontext.statement, self._params)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 914, in execute\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return meth(self, multiparams, params)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     return connection._execute_clauseelement(self, multiparams, params)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     compiled_sql, distilled_params\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     context)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1337, in _handle_dbapi_exception\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     util.raise_from_cause(newraise, exc_info)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 203, in raise_from_cause\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     reraise(type(exception), exception, tb=exc_tb, cause=cause)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     context)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler   File \"/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler     cursor.execute(statement, parameters)\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler DBError: (psycopg2.ProgrammingError) column \"allocations.consumer_id\" must appear in the GROUP BY clause or be used in an aggregate function\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler LINE 2: ...ons.resource_provider_id AS resource_provider_id, allocation...\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler                                                              ^\n2017-02-01 10:20:33.543 8670 ERROR nova.api.openstack.placement.handler  [SQL: 'SELECT resource_providers.created_at AS resource_providers_created_at, resource_providers.updated_at AS resource_providers_updated_at, resource_providers.id AS resource_providers_id, resource_providers.uuid AS resource_providers_uuid, resource_providers.name AS resource_providers_name, resource_providers.generation AS resource_providers_generation, resource_providers.can_host AS resource_providers_can_host \\\\nFROM resource_providers JOIN inventories ON resource_providers.id = inventories.resource_provider_id LEFT OUTER JOIN (SELECT allocations.resource_provider_id AS resource_provider_id, allocations.consumer_id AS consumer_id, allocations.resource_class_id AS resource_class_id, sum(allocations.used) AS used \\\\nFROM allocations \\\\nWHERE allocations.resource_class_id IN (%(resource_class_id_1)s, %(resource_class_id_2)s) GROUP BY allocations.resource_provider_id, allocations.resource_class_id) AS usage ON usage.resource_provider_id = inventories.resource_provider_id AND usage.resource_class_id = inventories.resource_class_id \\\\nWHERE resource_providers.can_host = %(can_host_1)s AND (inventories.resource_class_id = %(resource_class_id_3)s AND coalesce(usage.used, %(param_1)s) + %(coalesce_1)s <= (inventories.total - inventories.reserved) * inventories.allocation_ratio AND inventories.min_unit <= %(min_unit_1)s AND inventories.max_unit >= %(max_unit_1)s AND %(step_size_1)s %% inventories.step_size = %(param_2)s OR inventories.resource_class_id = %(resource_class_id_4)s AND coalesce(usage.used, %(param_3)s) + %(coalesce_2)s <= (inventories.total - inventories.reserved) * inventories.allocation_ratio AND inventories.min_unit <= %(min_unit_2)s AND inventories.max_unit >= %(max_unit_2)s AND %(step_size_2)s %% inventories.step_size = %(param_4)s) GROUP BY resource_providers.uuid \\\\nHAVING count(DISTINCT inventories.resource_class_id) = %(count_1)s'] [parameters: {'coalesce_2': 64, 'step_size_1': 1, 'count_1': 2, 'coalesce_1': 1, 'param_4': 0, 'step_size_2': 64, 'param_1': 0, 'param_3': 0, 'param_2': 0, 'can_host_1': 0, 'max_unit_2': 64, 'max_unit_1': 1, 'resource_class_id_1': 0, 'resource_class_id_3': 0, 'resource_class_id_2': 1, 'min_unit_2': 64, 'resource_class_id_4': 1, 'min_unit_1': 1}]", 
            "date_created": "2017-02-01 12:36:21.484699+00:00", 
            "author": "https://api.launchpad.net/1.0/~cdent"
        }, 
        {
            "content": "Adding link to in progress code: https://review.openstack.org/#/c/427667/\n\nThe bug link in the commit wasn't in the first go, so didn't register.", 
            "date_created": "2017-02-01 13:40:56.637665+00:00", 
            "author": "https://api.launchpad.net/1.0/~cdent"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/427667\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=03eced19f5d6665724a4fa432401be742383f8cf\nSubmitter: Jenkins\nBranch:    master\n\ncommit 03eced19f5d6665724a4fa432401be742383f8cf\nAuthor: Mehdi Abaakouk <email address hidden>\nDate:   Wed Feb 1 13:31:38 2017 +0100\n\n    placement-api: fix ResourceProviderList query\n    \n    The ResourceProviderList query use groupby without all grouped columns.\n    This works on mysql with unpredicable result, but don't for other RDBMS.\n    \n    For example, postgresql gating jobs dsvm that use nova are currently\n    broken.\n    \n    This change removes the unused consumer_id on first query,\n    and uses the primary key 'id' instead of 'uuid' the second groupby.\n    (Because groupby in postgresql requires a PK or all non-primary columns)\n    \n    The fix is tested by gate-ceilometer-dsvm-tempest-plugin-postgresql-ubuntu-xenial job\n    here: https://review.openstack.org/#/c/427668/\n    \n    closes-bug: #1660959\n    Change-Id: I6cc93ba0dd569d56696c9210d38dd2d77b4157c1\n", 
            "date_created": "2017-02-02 00:06:38.510258+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0rc1 release candidate.", 
            "date_created": "2017-02-03 19:08:14.798077+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-02-02 00:06:36.413807+00:00"
}