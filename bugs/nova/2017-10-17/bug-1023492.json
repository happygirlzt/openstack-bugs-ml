{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:27:41.597781+00:00", 
    "description": "how to reproduce: boot from an iso image, then take a snapshot. error:\n\n2012-07-11 11:48:39 TRACE nova.openstack.common.rpc.amqp Command: qemu-img convert -f qcow2 -O iso -s fb623355936c473fba1f805d097fb1db /opt/stack/nova/instances/instance-00000004/disk /opt/stack/nova/instances/snapshots/tmpBaLThN/fb623355936c473fba1f805d097fb1db\n2012-07-11 11:48:39 TRACE nova.openstack.common.rpc.amqp Exit code: 1\n2012-07-11 11:48:39 TRACE nova.openstack.common.rpc.amqp Stdout: ''\n2012-07-11 11:48:39 TRACE nova.openstack.common.rpc.amqp Stderr: \"qemu-img: Unknown file format 'iso'\\n\"\n2012-07-11 11:48:39 TRACE nova.openstack.common.rpc.amqp\n\nIt tries to snapshot the root device which is the iso file.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1023492", 
    "owner": "https://api.launchpad.net/1.0/~markmc", 
    "id": 1023492, 
    "index": 2969, 
    "openned": "2012-07-11 16:02:12.210447+00:00", 
    "created": "2012-07-11 16:02:12.210447+00:00", 
    "title": "boot from iso doesn't work with snapshot with libvirt", 
    "comments": [
        {
            "content": "how to reproduce: boot from an iso image, then take a snapshot. error:\n\n2012-07-11 11:48:39 TRACE nova.openstack.common.rpc.amqp Command: qemu-img convert -f qcow2 -O iso -s fb623355936c473fba1f805d097fb1db /opt/stack/nova/instances/instance-00000004/disk /opt/stack/nova/instances/snapshots/tmpBaLThN/fb623355936c473fba1f805d097fb1db\n2012-07-11 11:48:39 TRACE nova.openstack.common.rpc.amqp Exit code: 1\n2012-07-11 11:48:39 TRACE nova.openstack.common.rpc.amqp Stdout: ''\n2012-07-11 11:48:39 TRACE nova.openstack.common.rpc.amqp Stderr: \"qemu-img: Unknown file format 'iso'\\n\"\n2012-07-11 11:48:39 TRACE nova.openstack.common.rpc.amqp\n\nIt tries to snapshot the root device which is the iso file.", 
            "date_created": "2012-07-11 16:02:12.210447+00:00", 
            "author": "https://api.launchpad.net/1.0/~yunmao"
        }, 
        {
            "content": "We are having the same issue right now, we built CentOS 6.2 64-bit from an ISO image, I try to snapshot it as a baseline image and I get the following:\n2012-07-12 10:10:04 AUDIT nova.compute.manager [req-86422db7-f199-4870-a1b6-66cd26a27c43 b814182cb2ef4649add2f4194401cb8e 35dd40c123c74d90841c9802b1061229] instance 80aa96a7-405e-4231-a91a-ac8ca943541a: snapshotting\n2012-07-12 10:11:09 WARNING nova.compute.manager [-] Found 1 in the database and 0 on the hypervisor.\n2012-07-12 10:11:11 INFO nova.virt.libvirt.connection [-] Compute_service record updated for artim-cloud01.td.teradata.com \n2012-07-12 10:11:11 INFO nova.compute.manager [-] Updating host status\n2012-07-12 10:11:15 ERROR nova.rpc.amqp [req-86422db7-f199-4870-a1b6-66cd26a27c43 b814182cb2ef4649add2f4194401cb8e 35dd40c123c74d90841c9802b1061229] Exception during message handling\n2012-07-12 10:11:15 TRACE nova.rpc.amqp Traceback (most recent call last):\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/rpc/amqp.py\", line 253, in _process_data\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     rval = node_func(context=ctxt, **node_args)\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 114, in wrapped\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     return f(*args, **kw)\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 183, in decorated_function\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     sys.exc_info())\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     self.gen.next()\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 177, in decorated_function\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     return function(self, context, instance_uuid, *args, **kwargs)\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 952, in snapshot_instance\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     self.driver.snapshot(context, instance_ref, image_id)\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/exception.py\", line 114, in wrapped\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     return f(*args, **kw)\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/connection.py\", line 708, in snapshot\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     image_format)\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/utils.py\", line 223, in extract_snapshot\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     execute(*qemu_img_cmd)\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/virt/libvirt/utils.py\", line 35, in execute\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     return utils.execute(*args, **kwargs)\n2012-07-12 10:11:15 TRACE nova.rpc.amqp   File \"/usr/lib/python2.6/site-packages/nova/utils.py\", line 243, in execute\n2012-07-12 10:11:15 TRACE nova.rpc.amqp     cmd=' '.join(cmd))\n2012-07-12 10:11:15 TRACE nova.rpc.amqp ProcessExecutionError: Unexpected error while running command.\n2012-07-12 10:11:15 TRACE nova.rpc.amqp Command: qemu-img convert -f qcow2 -O iso -s 115b87f7c3d74374bb9d926e9b7971a7 /var/lib/nova/instances/artim-cloud-instance-0000001a/disk /tmp/tmplv5E0Y/115b87f7c3d74374bb9d926e9b7971a7\n2012-07-12 10:11:15 TRACE nova.rpc.amqp Exit code: 1\n2012-07-12 10:11:15 TRACE nova.rpc.amqp Stdout: ''\n2012-07-12 10:11:15 TRACE nova.rpc.amqp Stderr: \"qemu-img: Unknown file format 'iso'\\n\"\n2012-07-12 10:11:15 TRACE nova.rpc.amqp \n\nAlso kvm restarted the machine but dashboard, nova list, and euca-describe-instances still shows the machine as \"shut off\"\n\n[root@artim-cloud01 nova]# euca-describe-instances \nRESERVATION\tr-jqgr8cur\t35dd40c123c74d90841c9802b1061229\tdefault\nINSTANCE\ti-0000001a\tami-00000005\tserver-26\tserver-26\tshutoff\tkey (35dd40c123c74d90841c9802b1061229, artim-cloud01.td.teradata.com)\t0\t\tm1.small\t2012-07-12T13:43:09.000Z\tnova\t\n\n[root@artim-cloud01 nova]# nova list\n+--------------------------------------+-----------+---------+----------------------+\n|                  ID                  |    Name   |  Status |       Networks       |\n+--------------------------------------+-----------+---------+----------------------+\n| 80aa96a7-405e-4231-a91a-ac8ca943541a | Server 26 | SHUTOFF | private=172.65.184.4 |\n+--------------------------------------+-----------+---------+----------------------+\n\n", 
            "date_created": "2012-07-12 14:18:34.492404+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-maske-r"
        }, 
        {
            "content": "Hi,\n\ndid you mean to mark this as affecting the qemu-kvm package, or the project?  (To mark it as affecting qemu-kvm package, choose 'Also affects distribution' and pick distribution Ubuntu and project qemu-kvm).\n\nHowever, since qemu-kvm does not support an 'iso' output format for snapshots, I'm not sure that was your intent (so I won't do it for you as I'd likely be doing the wrong thing :).", 
            "date_created": "2012-07-12 20:33:13.429144+00:00", 
            "author": "https://api.launchpad.net/1.0/~serge-hallyn"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/10530", 
            "date_created": "2012-07-30 12:49:11.536227+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/10530\nCommitted: http://github.com/openstack/nova/commit/af0651946010e6bcc966005aa9fc2a1f38d3748a\nSubmitter: Jenkins\nBranch:    master\n\ncommit af0651946010e6bcc966005aa9fc2a1f38d3748a\nAuthor: Mark McLoughlin <email address hidden>\nDate:   Mon Jul 30 13:03:39 2012 +0100\n\n    Avoid error during snapshot of ISO booted instance\n    \n    Fixes bug #1023492\n    \n    If you boot an instance from an image with disk_format=iso and then\n    attempt to snapshot (i.e. nova image-create) you currently get a\n    traceback because we do:\n    \n      qemu-img convert -f qcow2 -O iso -s $snap $disk $out\n    \n    and 'iso' is not a format that qemu-img knows anything about.\n    \n    When booting the image, we use qemu-img to detect that the file is\n    a raw image so we avoid having to special case disk_format=iso\n    there. However, there's no way of avoiding the special casing when\n    extracting a snapshot.\n    \n    Note 1 - it's not very clever to take a snapshot of a read-only\n    disk downloaded from glance and upload it back to glance again.\n    Adding such smarts would be a nice enhancement.\n    \n    Note 2 - only the destination format is important here because\n    we can only be extracting from a qcow2 image since snapshots\n    only work where use_cow_images=True. See also #1030844.\n    \n    Change-Id: I21ff6db8ebb59a83d27f224283fb76f582c38a0e\n", 
            "date_created": "2012-07-30 19:06:24.117698+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-08-16 07:36:03.738725+00:00"
}