{
    "status": "Invalid", 
    "last_updated": "2015-11-05 07:05:07.338367+00:00", 
    "description": "I was tried to block live migrate a VM with a attached volume.  It was failed as expected due to change in bug https://bugs.launchpad.net/nova/+bug/1398999\nHowever, after the migration failed, the volume connection to the destination host is not terminated. This result in that the volume is not able to be deleted after attached from the VM(VNX is used a cinder backend).\n\nLog at the Destination host:\nException that made the live migration failed\n2015-05-20 23:01:43.644 ERROR oslo_messaging._drivers.common [req-ac891c95-e958-4166-9eb6-a459f05356f0 admin admin] ['Traceback (most recent call last):\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\\n    executor_callback))\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\\n    executor_callback)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\\n    result = func(ctxt, **new_args)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 6681, in pre_live_migration\\n    disk, migrate_data=migrate_data)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 443, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/exception.py\", line 88, in wrapped\\n    payload)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 85, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/opt/stack/nova/nova/exception.py\", line 71, in wrapped\\n    return f(self, context, *args, **kw)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 355, in decorated_function\\n    kwargs[\\'instance\\'], e, sys.exc_info())\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 85, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 343, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 5163, in pre_live_migration\\n    migrate_data)\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5825, in pre_live_migration\\n    raise exception.MigrationError(reason=msg)\\n', 'MigrationError: Migration error: Cannot block migrate instance 728f053b-0333-4594-b25b-1c104be66313 with mapped volumes\\n']\n\nThere is log to initialize the connection between the volume and the target host\nstack@ubuntu-server12:/opt/stack/logs/screen$ grep req-ac891c95-e958-4166-9eb6-a459f05356f0 screen-n-cpu.log | grep initialize\n2015-05-20 23:01:39.379 DEBUG keystoneclient.session [req-ac891c95-e958-4166-9eb6-a459f05356f0 admin admin] REQ: curl -g -i -X POST http://192.168.1.12:8776/v2/e6c8e065eee54e369a0fe7bca2759213/volumes/b895ded9-d337-45a0-8eb8-658faabf3e7e/action -H \"User-Agent: python-cinderclient\" -H \"Content-Type: application/json\" -H \"Accept: application/json\" -H \"X-Auth-Token: {SHA1}7f619e45d624a874185329f549070513a45eb324\" -d '{\"os-initialize_connection\": {\"connector\": {\"ip\": \"192.168.1.12\", \"host\": \"ubuntu-server12\", \"wwnns\": [\"20000090fa534685\", \"20000090fa534684\"], \"initiator\": \"iqn.1993-08.org.debian:01:f261dc5728b2\", \"wwpns\": [\"10000090fa534685\", \"10000090fa534684\"]}}}' _http_log_request /usr/local/lib/python2.7/dist-packages/keystoneclient/session.py:195\n\nBut there is no request to terminate the connection between the volume and the target host\nstack@ubuntu-server12:/opt/stack/logs/screen$ grep req-ac891c95-e958-4166-9eb6-a459f05356f0 screen-n-cpu.log | grep terminate_connection\n\nIn the cinder api log, the last request about the volume is initialize connection to the target host. There is no terminate connection request after that.\nstack@ubuntu-server12:/opt/stack/logs/screen$ grep b895ded9-d337-45a0-8eb8-658faabf3e7e screen-c-api.log\n........\n2015-05-20 23:01:39.444 INFO cinder.api.openstack.wsgi [req-43a51010-2cb9-4cae-8684-3fa5f82c71de admin] POST http://192.168.1.12:8776/v2/e6c8e065eee54e369a0fe7bca2759213/volumes/b895ded9-d337-45a0-8eb8-658faabf3e7e/action\n2015-05-20 23:01:39.484 DEBUG cinder.volume.api [req-43a51010-2cb9-4cae-8684-3fa5f82c71de admin] initialize connection for volume-id: b895ded9-d337-45a0-8eb8-658faabf3e7e, and connector: {u'ip': u'192.168.1.12', u'host': u'ubuntu-server12', u'wwnns': [u'20000090fa534685', u'20000090fa534684'], u'initiator': u'iqn.1993-08.org.debian:01:f261dc5728b2', u'wwpns': [u'10000090fa534685', u'10000090fa534684']}. initialize_connection /opt/stack/cinder/cinder/volume/api.py:563\n2015-05-20 23:01:41.205 INFO cinder.api.openstack.wsgi [req-43a51010-2cb9-4cae-8684-3fa5f82c71de admin] http://192.168.1.12:8776/v2/e6c8e065eee54e369a0fe7bca2759213/volumes/b895ded9-d337-45a0-8eb8-658faabf3e7e/action returned with HTTP 200\n2015-05-20 23:01:41.206 INFO eventlet.wsgi.server [req-43a51010-2cb9-4cae-8684-3fa5f82c71de admin] 192.168.1.12 - - [20/May/2015 23:01:41] \"POST /v2/e6c8e065eee54e369a0fe7bca2759213/volumes/b895ded9-d337-45a0-8eb8-658faabf3e7e/action HTTP/1.1\" 200 503 1.824016\nstack@ubuntu-server12:/opt/stack/logs/screen$\n\nMy reproduce Steps:\n\u00a01. Shared storage is not used between 2 compute nodes.\n\n\u00a02. KVM is used as hyperviser  and libvirt dirver is used. And VNX is used as Cinder back end\n\n\u00a03. Create a VM with image specified.\n\u00a0\u00a0\u00a0\u00a0stack@ubuntu-server12:/opt/stack/logs/screen$ nova boot --image 7cbaae55-0c68-4776-a6df-0d5fcfa32f0f --flavor 1 VM3\n\u00a0stack@ubuntu-server12:/opt/stack/logs/screen$ nova show 728f053b-0333-4594-b25b-1c104be66313 | grep host\n\u00a0\u00a0\u00a0\u00a0| OS-EXT-SRV-ATTR:host                 | ubuntu-server13                                                 |\n\u00a0\u00a0\u00a0\u00a0| OS-EXT-SRV-ATTR:hypervisor_hostname  | ubuntu-server13                                                 |\n\u00a0\u00a0\u00a0\u00a0| hostId                               | cc27ab91a64a466dff1a6e8d1a2ccd2ae2e146ee2c553e88289e4dec        |\n\n\u00a04. Create a volume and attach it to the VM created in step 3.\n\u00a0\u00a0\u00a0\u00a0stack@ubuntu-server12:/opt/stack/logs/screen$ nova volume-attach 728f053b-0333-4594-b25b-1c104be66313 b895ded9-d337-45a0-8eb8-658faabf3e7e\n\u00a0\u00a0\u00a0\u00a0+----------+--------------------------------------+\n\u00a0\u00a0\u00a0\u00a0| Property | Value                                |\n\u00a0\u00a0\u00a0\u00a0+----------+--------------------------------------+\n\u00a0\u00a0\u00a0\u00a0| device   | /dev/vdb                             |\n\u00a0\u00a0\u00a0\u00a0| id       | b895ded9-d337-45a0-8eb8-658faabf3e7e |\n\u00a0\u00a0\u00a0\u00a0| serverId | 728f053b-0333-4594-b25b-1c104be66313 |\n\u00a0\u00a0\u00a0\u00a0| volumeId | b895ded9-d337-45a0-8eb8-658faabf3e7e |\n\u00a0\u00a0\u00a0\u00a0+----------+--------------------------------------+\n\n\u00a0\u00a05. Live migrate the VM to another host\n\u00a0\u00a0stack@ubuntu-server12:/opt/stack/logs/screen$ nova live-migration --block-migrate 728f053b-0333-4594-b25b-1c104be66313 ubuntu-server12\n\u00a0\u00a0stack@ubuntu-server12:/opt/stack/logs/screen$ nova show 728f053b-0333-4594-b25b-1c104be66313\n+--------------------------------------+-----------------------------------------------------------------+\n| Property                             | Value                                                           |\n+--------------------------------------+-----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                          |\n| OS-EXT-AZ:availability_zone          | nova                                                            |\n| OS-EXT-SRV-ATTR:host                 | ubuntu-server13                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | ubuntu-server13                                                 |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000003                                               |\n| OS-EXT-STS:power_state               | 1                                                               |\n| OS-EXT-STS:task_state                | -                                                               |\n| OS-EXT-STS:vm_state                  | active                                                          |\n| OS-SRV-USG:launched_at               | 2015-05-21T02:58:47.000000                                      |\n| OS-SRV-USG:terminated_at             | -                                                               |\n| accessIPv4                           |                                                                 |\n| accessIPv6                           |                                                                 |\n| config_drive                         |                                                                 |\n| created                              | 2015-05-21T02:58:29Z                                            |\n| flavor                               | m1.tiny (1)                                                     |\n| hostId                               | cc27ab91a64a466dff1a6e8d1a2ccd2ae2e146ee2c553e88289e4dec        |\n| id                                   | 728f053b-0333-4594-b25b-1c104be66313                            |\n| image                                | cirros-0.3.1-x86_64-disk (7cbaae55-0c68-4776-a6df-0d5fcfa32f0f) |\n| key_name                             | -                                                               |\n| metadata                             | {}                                                              |\n| name                                 | VM3                                                             |\n| os-extended-volumes:volumes_attached | [{\"id\": \"b895ded9-d337-45a0-8eb8-658faabf3e7e\"}]                |\n| progress                             | 0                                                               |\n| public network                       | 172.24.4.5                                                      |\n| security_groups                      | default                                                         |\n| status                               | ACTIVE                                                          |\n| tenant_id                            | e6c8e065eee54e369a0fe7bca2759213                                |\n| updated                              | 2015-05-21T03:01:44Z                                            |\n| user_id                              | f1f912916ac04f5eb18855f1c7795d0c                                |\n+--------------------------------------+-----------------------------------------------------------------+\n\n\u00a0\u00a0\u00a06. The migration is failed, the VM is till on the original host. However on the destination host the volume connection is not terminated.\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Which caused the volume cannot be deleted after detached from the VM3.\n\u00a0\u00a0\u00a0stack@ubuntu-server12:/opt/stack/logs/screen$ nova volume-detach VM3 b895ded9-d337-45a0-8eb8-658faabf3e7e\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0stack@ubuntu-server12:/opt/stack/logs/screen$ cinder list\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0+--------------------------------------+-----------+----------+------+-------------+----------+--------------------------------------+\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0|                  ID                  |   Status  |   Name   | Size | Volume Type | Bootable |             Attached to              |\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0+--------------------------------------+-----------+----------+------+-------------+----------+--------------------------------------+\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0| b895ded9-d337-45a0-8eb8-658faabf3e7e | available |   vol3   |  1   |     None    |  false   |                                      |\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0+--------------------------------------+-----------+----------+------+-------------+----------+--------------------------------------+\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0stack@ubuntu-server12:/opt/stack/logs/screen$ cinder delete b895ded9-d337-45a0-8eb8-658faabf3e7e\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0stack@ubuntu-server12:/opt/stack/logs/screen$ cinder list\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0+--------------------------------------+----------------+----------+------+-------------+----------+--------------------------------------+\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0|                  ID                  |     Status     |   Name   | Size | Volume Type | Bootable |             Attached to              |\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0+--------------------------------------+----------------+----------+------+-------------+----------+--------------------------------------+\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0| b895ded9-d337-45a0-8eb8-658faabf3e7e | error_deleting |   vol3   |  1   |     None    |  false   |                                      |\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0+--------------------------------------+----------------+----------+------+-------------+----------+--------------------------------------+\n\n==== Version =====\nstack@ubuntu-server12:/opt/stack/nova$ git status\nOn branch stable/kilo\nYour branch is up-to-date with 'origin/stable/kilo'.\n\nnothing to commit, working directory clean\nstack@ubuntu-server12:/opt/stack/nova$ git log -1\ncommit 36fb00291d819b65f46d530eefbf07b883ca8a29\nMerge: 0c60aca 8e9ecf7\nAuthor: Jenkins <email address hidden>\nDate:   Fri May 15 16:16:00 2015 +0000\n\n\u00a0\u00a0\u00a0\u00a0Merge \"Libvirt: Use tpool to invoke guestfs api\" into stable/kilo", 
    "tags": [
        "live-migrate"
    ], 
    "importance": "Undecided", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1457291", 
    "owner": "None", 
    "id": 1457291, 
    "index": 6816, 
    "openned": "2015-05-21 03:43:17.668457+00:00", 
    "created": "2015-05-21 03:43:17.668457+00:00", 
    "title": "Volume connection to destination host is not terminated after failed to  block live migrate a VM with attached volume", 
    "comments": [
        {
            "content": "I was tried to block live migrate a VM with a attached volume.  It was failed as change in bug https://bugs.launchpad.net/nova/+bug/1398999\nHowever, after the migration failed, the volume connection to the destination host is not terminated. This result in that the volume is not able to be deleted after attached from the VM(VNX is used a cinder backend).\n\nLog at the Destination host:\nException that live migration\n2015-05-20 23:01:43.644 ERROR oslo_messaging._drivers.common [req-ac891c95-e958-4166-9eb6-a459f05356f0 admin admin] ['Traceback (most recent call last):\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\\n    executor_callback))\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\\n    executor_callback)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\\n    result = func(ctxt, **new_args)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 6681, in pre_live_migration\\n    disk, migrate_data=migrate_data)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 443, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/exception.py\", line 88, in wrapped\\n    payload)\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 85, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/opt/stack/nova/nova/exception.py\", line 71, in wrapped\\n    return f(self, context, *args, **kw)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 355, in decorated_function\\n    kwargs[\\'instance\\'], e, sys.exc_info())\\n', '  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 85, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 343, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n', '  File \"/opt/stack/nova/nova/compute/manager.py\", line 5163, in pre_live_migration\\n    migrate_data)\\n', '  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5825, in pre_live_migration\\n    raise exception.MigrationError(reason=msg)\\n', 'MigrationError: Migration error: Cannot block migrate instance 728f053b-0333-4594-b25b-1c104be66313 with mapped volumes\\n']\n\nThere is log to initialize the connection between the volume and the target host\nstack@ubuntu-server12:/opt/stack/logs/screen$ grep req-ac891c95-e958-4166-9eb6-a459f05356f0 screen-n-cpu.log | grep initialize\n2015-05-20 23:01:39.379 DEBUG keystoneclient.session [req-ac891c95-e958-4166-9eb6-a459f05356f0 admin admin] REQ: curl -g -i -X POST http://192.168.1.12:8776/v2/e6c8e065eee54e369a0fe7bca2759213/volumes/b895ded9-d337-45a0-8eb8-658faabf3e7e/action -H \"User-Agent: python-cinderclient\" -H \"Content-Type: application/json\" -H \"Accept: application/json\" -H \"X-Auth-Token: {SHA1}7f619e45d624a874185329f549070513a45eb324\" -d '{\"os-initialize_connection\": {\"connector\": {\"ip\": \"192.168.1.12\", \"host\": \"ubuntu-server12\", \"wwnns\": [\"20000090fa534685\", \"20000090fa534684\"], \"initiator\": \"iqn.1993-08.org.debian:01:f261dc5728b2\", \"wwpns\": [\"10000090fa534685\", \"10000090fa534684\"]}}}' _http_log_request /usr/local/lib/python2.7/dist-packages/keystoneclient/session.py:195\n\nBut there is no request to terminate the connection between the volume and the target host\nstack@ubuntu-server12:/opt/stack/logs/screen$ grep req-ac891c95-e958-4166-9eb6-a459f05356f0 screen-n-cpu.log | grep terminate_connection\n\nIn the cinder api log, the last request to about the volume is initialize connection to the target host. There is no terminate connection request after that.\nstack@ubuntu-server12:/opt/stack/logs/screen$ grep b895ded9-d337-45a0-8eb8-658faabf3e7e screen-c-api.log\n........\n2015-05-20 23:01:39.444 INFO cinder.api.openstack.wsgi [req-43a51010-2cb9-4cae-8684-3fa5f82c71de admin] POST http://192.168.1.12:8776/v2/e6c8e065eee54e369a0fe7bca2759213/volumes/b895ded9-d337-45a0-8eb8-658faabf3e7e/action\n2015-05-20 23:01:39.484 DEBUG cinder.volume.api [req-43a51010-2cb9-4cae-8684-3fa5f82c71de admin] initialize connection for volume-id: b895ded9-d337-45a0-8eb8-658faabf3e7e, and connector: {u'ip': u'192.168.1.12', u'host': u'ubuntu-server12', u'wwnns': [u'20000090fa534685', u'20000090fa534684'], u'initiator': u'iqn.1993-08.org.debian:01:f261dc5728b2', u'wwpns': [u'10000090fa534685', u'10000090fa534684']}. initialize_connection /opt/stack/cinder/cinder/volume/api.py:563\n2015-05-20 23:01:41.205 INFO cinder.api.openstack.wsgi [req-43a51010-2cb9-4cae-8684-3fa5f82c71de admin] http://192.168.1.12:8776/v2/e6c8e065eee54e369a0fe7bca2759213/volumes/b895ded9-d337-45a0-8eb8-658faabf3e7e/action returned with HTTP 200\n2015-05-20 23:01:41.206 INFO eventlet.wsgi.server [req-43a51010-2cb9-4cae-8684-3fa5f82c71de admin] 192.168.1.12 - - [20/May/2015 23:01:41] \"POST /v2/e6c8e065eee54e369a0fe7bca2759213/volumes/b895ded9-d337-45a0-8eb8-658faabf3e7e/action HTTP/1.1\" 200 503 1.824016\nstack@ubuntu-server12:/opt/stack/logs/screen$\n\n\n\nMy reproduce Steps:\n 1. Shared storage is not used between 2 compute nodes.\n \n 2. KVM is used as hyperviser  and libvirt dirver is used. And VNX is used as Cinder back end\n \n 3. Create a VM with image specified.\n    stack@ubuntu-server12:/opt/stack/logs/screen$ nova boot --image 7cbaae55-0c68-4776-a6df-0d5fcfa32f0f --flavor 1 VM3\n\tstack@ubuntu-server12:/opt/stack/logs/screen$ nova show 728f053b-0333-4594-b25b-1c104be66313 | grep host\n    | OS-EXT-SRV-ATTR:host                 | ubuntu-server13                                                 |\n    | OS-EXT-SRV-ATTR:hypervisor_hostname  | ubuntu-server13                                                 |\n    | hostId                               | cc27ab91a64a466dff1a6e8d1a2ccd2ae2e146ee2c553e88289e4dec        |\n\n \n 4. Create a volume and attach it to the VM created in step 3.\n    stack@ubuntu-server12:/opt/stack/logs/screen$ nova volume-attach 728f053b-0333-4594-b25b-1c104be66313 b895ded9-d337-45a0-8eb8-658faabf3e7e\n    +----------+--------------------------------------+\n    | Property | Value                                |\n    +----------+--------------------------------------+\n    | device   | /dev/vdb                             |\n    | id       | b895ded9-d337-45a0-8eb8-658faabf3e7e |\n    | serverId | 728f053b-0333-4594-b25b-1c104be66313 |\n    | volumeId | b895ded9-d337-45a0-8eb8-658faabf3e7e |\n    +----------+--------------------------------------+\n\n  5. Live migrate the VM to another host\n  stack@ubuntu-server12:/opt/stack/logs/screen$ nova live-migration --block-migrate 728f053b-0333-4594-b25b-1c104be66313 ubuntu-server12\n  stack@ubuntu-server12:/opt/stack/logs/screen$ nova show 728f053b-0333-4594-b25b-1c104be66313\n+--------------------------------------+-----------------------------------------------------------------+\n| Property                             | Value                                                           |\n+--------------------------------------+-----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                          |\n| OS-EXT-AZ:availability_zone          | nova                                                            |\n| OS-EXT-SRV-ATTR:host                 | ubuntu-server13                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | ubuntu-server13                                                 |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000003                                               |\n| OS-EXT-STS:power_state               | 1                                                               |\n| OS-EXT-STS:task_state                | -                                                               |\n| OS-EXT-STS:vm_state                  | active                                                          |\n| OS-SRV-USG:launched_at               | 2015-05-21T02:58:47.000000                                      |\n| OS-SRV-USG:terminated_at             | -                                                               |\n| accessIPv4                           |                                                                 |\n| accessIPv6                           |                                                                 |\n| config_drive                         |                                                                 |\n| created                              | 2015-05-21T02:58:29Z                                            |\n| flavor                               | m1.tiny (1)                                                     |\n| hostId                               | cc27ab91a64a466dff1a6e8d1a2ccd2ae2e146ee2c553e88289e4dec        |\n| id                                   | 728f053b-0333-4594-b25b-1c104be66313                            |\n| image                                | cirros-0.3.1-x86_64-disk (7cbaae55-0c68-4776-a6df-0d5fcfa32f0f) |\n| key_name                             | -                                                               |\n| metadata                             | {}                                                              |\n| name                                 | VM3                                                             |\n| os-extended-volumes:volumes_attached | [{\"id\": \"b895ded9-d337-45a0-8eb8-658faabf3e7e\"}]                |\n| progress                             | 0                                                               |\n| public network                       | 172.24.4.5                                                      |\n| security_groups                      | default                                                         |\n| status                               | ACTIVE                                                          |\n| tenant_id                            | e6c8e065eee54e369a0fe7bca2759213                                |\n| updated                              | 2015-05-21T03:01:44Z                                            |\n| user_id                              | f1f912916ac04f5eb18855f1c7795d0c                                |\n+--------------------------------------+-----------------------------------------------------------------+\n\n   6. The migration is failed, the VM is till on the original host. However on the destination host the volume connection is not terminated.\n      Which caused the volume cannot be deleted after detached from the VM3.\n\t  stack@ubuntu-server12:/opt/stack/logs/screen$ nova volume-detach VM3 b895ded9-d337-45a0-8eb8-658faabf3e7e\n      stack@ubuntu-server12:/opt/stack/logs/screen$ cinder list\n      +--------------------------------------+-----------+----------+------+-------------+----------+--------------------------------------+\n      |                  ID                  |   Status  |   Name   | Size | Volume Type | Bootable |             Attached to              |\n      +--------------------------------------+-----------+----------+------+-------------+----------+--------------------------------------+\n      | b895ded9-d337-45a0-8eb8-658faabf3e7e | available |   vol3   |  1   |     None    |  false   |                                      |\n      +--------------------------------------+-----------+----------+------+-------------+----------+--------------------------------------+\n      stack@ubuntu-server12:/opt/stack/logs/screen$ cinder delete b895ded9-d337-45a0-8eb8-658faabf3e7e\n      stack@ubuntu-server12:/opt/stack/logs/screen$ cinder list\n      +--------------------------------------+----------------+----------+------+-------------+----------+--------------------------------------+\n      |                  ID                  |     Status     |   Name   | Size | Volume Type | Bootable |             Attached to              |\n      +--------------------------------------+----------------+----------+------+-------------+----------+--------------------------------------+\n      | b895ded9-d337-45a0-8eb8-658faabf3e7e | error_deleting |   vol3   |  1   |     None    |  false   |                                      | \n      +--------------------------------------+----------------+----------+------+-------------+----------+--------------------------------------+\n\n\n==== Version =====\nstack@ubuntu-server12:/opt/stack/nova$ git status\nOn branch stable/kilo\nYour branch is up-to-date with 'origin/stable/kilo'.\n\nnothing to commit, working directory clean\nstack@ubuntu-server12:/opt/stack/nova$ git log -1\ncommit 36fb00291d819b65f46d530eefbf07b883ca8a29\nMerge: 0c60aca 8e9ecf7\nAuthor: Jenkins <email address hidden>\nDate:   Fri May 15 16:16:00 2015 +0000\n\n    Merge \"Libvirt: Use tpool to invoke guestfs api\" into stable/kilo", 
            "date_created": "2015-05-21 03:43:17.668457+00:00", 
            "author": "https://api.launchpad.net/1.0/~tina-tang"
        }, 
        {
            "content": "Tina:\nAn update from  mine, on nova master branch, I can not reproduce with your steps:\n\ncommit 183cd88cb2f9781b53f71b6b161df401c286c9ff\nMerge: 3ee98a6 2833f8c\nAuthor: Jenkins <email address hidden>\nDate:   Sun Jul 26 13:34:34 2015 +0000\n\n    Merge \"remove _rescan_iscsi from disconnect_volume_multipath_iscsi\"\n\n\ntaget@liyong:/opt/stack/nova$ nova show test1\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| 192_net network                      | 192.168.0.22                                                   |\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-SRV-ATTR:host                 | liyong2                                                        |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | liyong2                                                        |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000057                                              |\n| OS-EXT-STS:power_state               | 1                                                              |\n| OS-EXT-STS:task_state                | -                                                              |\n| OS-EXT-STS:vm_state                  | active                                                         |\n| OS-SRV-USG:launched_at               | 2015-08-13T10:21:57.000000                                     |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| config_drive                         |                                                                |\n| created                              | 2015-08-13T10:21:47Z                                           |\n| flavor                               | m1.tiny (1)                                                    |\n| hostId                               | 7a2a33df86ec0a0aa08ab1337c6adf00e80573c5cefd403b05a02ceb       |\n| id                                   | fd00c30b-c280-4e77-9757-fc5e39165ae7                           |\n| image                                | cirros-0.3.2-x86_64-uec (93169d18-1bb2-45f7-861c-6735ef687db9) |\n| key_name                             | -                                                              |\n| metadata                             | {}                                                             |\n| name                                 | test1                                                          |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | default                                                        |\n| status                               | ACTIVE                                                         |\n| tenant_id                            | 52a0ee83fb524376bd603547aea415a3                               |\n| updated                              | 2015-08-13T10:21:57Z                                           |\n| user_id                              | bea64c5634ae4f079c1c69ed29a68242                               |\n+--------------------------------------+----------------------------------------------------------------+\n\n\ntaget@liyong:/opt/stack/nova$ nova volume-attach test1 1af540a1-67d2-4fe5-a14b-b608148e4ff4\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdb                             |\n| id       | 1af540a1-67d2-4fe5-a14b-b608148e4ff4 |\n| serverId | fd00c30b-c280-4e77-9757-fc5e39165ae7 |\n| volumeId | 1af540a1-67d2-4fe5-a14b-b608148e4ff4 |\n+----------+--------------------------------------+\n\ntaget@liyong:/opt/stack/nova$ nova live-migration  test1 liyong --block-migrate\n\n\nI can see \n\n2015-08-13 20:16:49.746 TRACE oslo_messaging.rpc.dispatcher   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5853, in pre_live_migration\n2015-08-13 20:16:49.746 TRACE oslo_messaging.rpc.dispatcher     raise exception.MigrationError(reason=msg)\n2015-08-13 20:16:49.746 TRACE oslo_messaging.rpc.dispatcher \n2015-08-13 20:16:49.746 TRACE oslo_messaging.rpc.dispatcher MigrationError: Migration error: Cannot block migrate instance fd00c30b-c280-4e77-9757-fc5e39165ae7 with mapped volumes\n\n\nbut the vm is still running on origin host\n\nI detach the volume from it and I can delete that volume\ntaget@liyong:/opt/stack/nova$ cinder list\n+--------------------------------------+--------+------+------+-------------+----------+-------------+--------------------------------------+\n|                  ID                  | Status | Name | Size | Volume Type | Bootable | Multiattach |             Attached to              |\n+--------------------------------------+--------+------+------+-------------+----------+-------------+--------------------------------------+\n| 1af540a1-67d2-4fe5-a14b-b608148e4ff4 | in-use |  -   |  2   | lvmdriver-1 |  false   |    False    | fd00c30b-c280-4e77-9757-fc5e39165ae7 |\n+--------------------------------------+--------+------+------+-------------+----------+-------------+--------------------------------------+\ntaget@liyong:/opt/stack/nova$ cinder^C\ntaget@liyong:/opt/stack/nova$ nova volume-detach test1 1af540a1-67d2-4fe5-a14b-b608148e4ff4\ntaget@liyong:/opt/stack/nova$ cinder list\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+-------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable | Multiattach | Attached to |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+-------------+\n| 1af540a1-67d2-4fe5-a14b-b608148e4ff4 | available |  -   |  2   | lvmdriver-1 |  false   |    False    |             |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+-------------+\n\ntaget@liyong:/opt/stack/nova$ cinder delete 1af540a1-67d2-4fe5-a14b-b608148e4ff4\ntaget@liyong:/opt/stack/nova$ cinder list\n+--------------------------------------+----------+------+------+-------------+----------+-------------+-------------+\n|                  ID                  |  Status  | Name | Size | Volume Type | Bootable | Multiattach | Attached to |\n+--------------------------------------+----------+------+------+-------------+----------+-------------+-------------+\n| 1af540a1-67d2-4fe5-a14b-b608148e4ff4 | deleting |  -   |  2   | lvmdriver-1 |  false   |    False    |             |\n+--------------------------------------+----------+------+------+-------------+----------+-------------+-------------+\ntaget@liyong:/opt/stack/nova$ cinder list\n+----+--------+------+------+-------------+----------+-------------+-------------+\n| ID | Status | Name | Size | Volume Type | Bootable | Multiattach | Attached to |\n+----+--------+------+------+-------------+----------+-------------+-------------+\n+----+--------+------+------+-------------+----------+-------------+-------------+\n\n", 
            "date_created": "2015-08-13 12:24:20.281110+00:00", 
            "author": "https://api.launchpad.net/1.0/~taget-9"
        }, 
        {
            "content": "Hi Eli\n\nYou are using LVM driver. I am not sure whether a LVM volume could be deleted if has initialize_connection to a host.  \nIf possible, when the live migration failed and before you detach the volume from the vm, can you check whether the terminate_connection of the volume to the destination host is invoked?  For example, we can use below command to check whether there is terminate_connection request for volume  b0affaa8-576f-4d31-9196-b3d8242d2578 in a devstack environment.\n\nfor req in `grep b0affaa8-576f-4d31-9196-b3d8242d2578 /opt/stack/screen/screen-c-api.log | awk '{print $5}' | sed 's/\\[//g' | uniq`; do    grep $req screen-c-api.log | grep 'terminate_connection'; done\n\nTo avoid other operations affect the result, please ensure a new volume is used, and the command it run right after the live migration failed.\n  \n\nI will retry the test and post result here with the latest code in the Master branch.  I may need sometime as my test environment was just broken.\n\nStay tuned please.\n\nThanks,\nTina", 
            "date_created": "2015-08-14 02:46:32.299371+00:00", 
            "author": "https://api.launchpad.net/1.0/~tina-tang"
        }, 
        {
            "content": "Tina, thanks for your reply, \n\nyou are saying \u201cYou are using LVM driver\u201d, I  don't get you yet.\ndo you mean cinder back_end is LVM ?(maybe I think)\n\nbut could you tell. what's your driver you are using?\n\nI'v file another patch, to raise this exception in REST API , by doing that, live-migration won't call pre_live_migration to connect volume.\n\nthis bug is reported here https://bugs.launchpad.net/nova/+bug/1484830 and I have already made a patch(don't send for reviewing yet)\n\nlooking forward for your testing result on latest code.", 
            "date_created": "2015-08-15 04:47:14.808181+00:00", 
            "author": "https://api.launchpad.net/1.0/~taget-9"
        }, 
        {
            "content": "Hi Eli,\r\n\r\nYou are right, when I say \"suing LVM driver\", it means cinder back_end is LVM.  I was using VNX as cinder back_end, which doesn't allow to delete a volume which is initialized connection to some host .\r\n\r\nThanks,\r\nTina\r\n", 
            "date_created": "2015-08-17 03:36:13+00:00", 
            "author": "https://api.launchpad.net/1.0/~tina-tang"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/214434", 
            "date_created": "2015-08-19 03:12:30.279984+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change back to new because I  don't try VNX  for cinder back_end.", 
            "date_created": "2015-08-19 05:40:11.458050+00:00", 
            "author": "https://api.launchpad.net/1.0/~taget-9"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/214434\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7735902f6eaab907929efead53aa98428457c42d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7735902f6eaab907929efead53aa98428457c42d\nAuthor: Eli Qiao <email address hidden>\nDate:   Mon Aug 17 07:34:59 2015 +0800\n\n    Raise exception.Migration earlier in REST API layer\n    \n    If user requires live-migration with block migrate and mapped volumes, Nova-api\n    won't get an exception in nova-api. This exception will be raised in nova-compute\n    node, so user needs to check log on compute node to tell why\n    he/she trigger a live-migration but the instance is still in running state.\n    Livirt driver will raise exception like this:\n    \n    Migration error: Cannot block migrate instance  with mapped volumes\n    \n    We can make this happen earlier when doing can-live-migration-source,\n    by doing this, user will get the exception in nova-api this will bring good\n    user experience, and besides if we raise this exception early , then nova\n    won't do pre-live-migration and _rollback_live_migration.\n    \n    Before this patch gets applied, no state changes on instance, and no errors\n    will return to user, the exception message can only be found in log of\n    nova-compute.\n    \n    After this patch gets applied, user will get MigrationPreCheckError in REST\n    api if requires live-migration with block migrate and mapped volumes.\n    \n    Closes-Bug: #1484830\n    Related-Bug: #1457291\n    Change-Id: I671c57ca61ff3a62a2ad8935d809ff47542b526c\n", 
            "date_created": "2015-09-23 13:44:00.774349+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This has been fixed in Liberty - https://review.openstack.org/214434. Because kilo is security-supported only marking this one as invalid.", 
            "date_created": "2015-11-05 07:04:49.137929+00:00", 
            "author": "https://api.launchpad.net/1.0/~pawel-koniszewski"
        }
    ], 
    "closed": "2015-11-05 07:05:05.687801+00:00"
}