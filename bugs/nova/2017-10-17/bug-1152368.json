{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:39:12.096302+00:00", 
    "description": "Under some circumstances the Hyper-V driver may boot the wrong image.  The following steps should reproduce the problem:\n\n1. Create an OpenStack environment using stack.sh.\n2. Create a Hyper-V compute node for that environment.\n3. Boot an instance on the Hyper-V node.\n4. Re-run stack.sh without removing the instance.\n5. Stop and delete the instance through Hyper-V manager.  By default this does not remove the disk images associated with the instance.\n6. Attempt to boot a different image from OpenStack.  Because Nova will try to use the same instance name due to the re-stack, and a disk image already exists in that location, the old image will actually be booted.\n\nThis is primarily a development and test issue since those are the environments where this is most likely to happen.  Even so, Nova should ensure that when a new instance is booted it comes up with the correct image.", 
    "tags": [
        "hyper-v"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1152368", 
    "owner": "https://api.launchpad.net/1.0/~dperaza", 
    "id": 1152368, 
    "index": 4755, 
    "openned": "2013-03-07 23:21:10.467278+00:00", 
    "created": "2013-03-07 23:21:10.467278+00:00", 
    "title": "Hyper-V driver fails to boot instance if root.vhd already exists", 
    "comments": [
        {
            "content": "Under some circumstances the Hyper-V driver may boot the wrong image.  The following steps should reproduce the problem:\n\n1. Create an OpenStack environment using stack.sh.\n2. Create a Hyper-V compute node for that environment.\n3. Boot an instance on the Hyper-V node.\n4. Re-run stack.sh without removing the instance.\n5. Stop and delete the instance through Hyper-V manager.  By default this does not remove the disk images associated with the instance.\n6. Attempt to boot a different image from OpenStack.  Because Nova will try to use the same instance name due to the re-stack, and a disk image already exists in that location, the old image will actually be booted.\n\nThis is primarily a development and test issue since those are the environments where this is most likely to happen.  Even so, Nova should ensure that when a new instance is booted it comes up with the correct image.", 
            "date_created": "2013-03-07 23:21:10.467278+00:00", 
            "author": "https://api.launchpad.net/1.0/~bnemec"
        }, 
        {
            "content": "Can please provide a log with debug enabled?\n\nThe root.vhd is overwritten in case of CoW and non CoW images.\n", 
            "date_created": "2013-03-08 19:12:12.872108+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }, 
        {
            "content": "I just discovered that the system we observed this behavior on is running older Nova code, and I have been unable to reproduce the problem exactly on the current code.  However, I'm still seeing an error under these circumstances when using CoW images.  If the root.vhd file already exists before I try to create an instance, I get the following error:\n\n2013-03-08 15:39:10.157 DEBUG nova.virt.hyperv.vmops [req-e4298c99-404f-452e-aabf-41e58c7f3d5a eeb764567e7945f58123196b35737f69 47be21d8aef645e7ada283c79ddc0b98] Creating differencing VHD. Parent: c:\\openstack\\instances\\_base\\f19c7112-de54-44e7-852f-18bb141b304d.vhd, Target: c:\\openstack\\instances\\instance-0000002c\\root.vhd _create_boot_vhd C:\\files\\nova\\nova\\virt\\hyperv\\vmops.py:122\n2013-03-08 15:39:10.299 ERROR nova.compute.manager [req-e4298c99-404f-452e-aabf-41e58c7f3d5a eeb764567e7945f58123196b35737f69 47be21d8aef645e7ada283c79ddc0b98] [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386] Instance failed to spawn\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386] Traceback (most recent call last):\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]   File \"C:\\files\\nova\\nova\\compute\\manager.py\", line 1052, in _spawn\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]     block_device_info)\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]   File \"C:\\files\\nova\\nova\\virt\\hyperv\\driver.py\", line 54, in spawn\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]     admin_password, network_info, block_device_info)\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]   File \"C:\\files\\nova\\nova\\virt\\hyperv\\vmops.py\", line 147, in spawn\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]     boot_vhd_path = self._create_boot_vhd(context, instance)\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]   File \"C:\\files\\nova\\nova\\virt\\hyperv\\vmops.py\", line 124, in _create_boot_vhd\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]     base_vhd_path)\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]   File \"C:\\files\\nova\\nova\\virt\\hyperv\\vhdutils.py\", line 39, in create_differencing_vhd\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]     self._vmutils.check_ret_val(ret_val, job_path)\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]   File \"C:\\files\\nova\\nova\\virt\\hyperv\\vmutils.py\", line 364, in check_ret_val\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]     self._wait_for_job(job_path)\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]   File \"C:\\files\\nova\\nova\\virt\\hyperv\\vmutils.py\", line 394, in _wait_for_job\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386]     \"%(error)s\") % locals())\n2013-03-08 15:39:10.299 34004 TRACE nova.compute.manager [instance: 7a2bd904-d476-440d-8d4b-4b62d70b6386] HyperVException: WMI job failed with status 10. Error details: <INSTANCE CLASSNAME=\"Msvm_Error\"><PROPERTY NAME=\"CIMStatusCode\" TYPE=\"uint32\"><VALUE>1</VALUE></PROPERTY><PROPERTY NAME=\"CIMStatusCodeDescription\" TYPE=\"string\"></PROPERTY><PROPERTY NAME=\"ErrorSource\" TYPE=\"string\"></PROPERTY><PROPERTY NAME=\"ErrorSourceFormat\" TYPE=\"uint16\"><VALUE>0</VALUE></PROPERTY><PROPERTY NAME=\"ErrorType\" TYPE=\"uint16\"><VALUE>4</VALUE></PROPERTY><PROPERTY NAME=\"Message\" TYPE=\"string\"><VALUE>Failed to create the virtual hard disk.</VALUE></PROPERTY><PROPERTY.ARRAY NAME=\"MessageArguments\" TYPE=\"string\"><VALUE.ARRAY></VALUE.ARRAY></PROPERTY.ARRAY><PROPERTY NAME=\"MessageID\" TYPE=\"string\"><VALUE>15266</VALUE></PROPERTY><PROPERTY NAME=\"OtherErrorSourceFormat\" TYPE=\"string\"></PROPERTY><PROPERTY NAME=\"OtherErrorType\" TYPE=\"string\"></PROPERTY><PROPERTY NAME=\"OwningEntity\" TYPE=\"string\"><VALUE>Microsoft-Windows-Hyper-V-VMMS</VALUE></PROPERTY><PROPERTY NAME=\"PerceivedSeverity\" TYPE=\"uint16\"><VALUE>3</VALUE></PROPERTY><PROPERTY NAME=\"ProbableCause\" TYPE=\"uint16\"><VALUE>0</VALUE></PROPERTY><PROPERTY NAME=\"ProbableCauseDescription\" TYPE=\"string\"></PROPERTY><PROPERTY.ARRAY NAME=\"RecommendedActions\" TYPE=\"string\"></PROPERTY.ARRAY></INSTANCE>", 
            "date_created": "2013-03-08 22:02:59.658579+00:00", 
            "author": "https://api.launchpad.net/1.0/~bnemec"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/24336", 
            "date_created": "2013-03-13 16:49:53.989992+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/24336\nCommitted: http://github.com/openstack/nova/commit/4a6a9da8e7d283b781ceee1b20a7f6f25144de57\nSubmitter: Jenkins\nBranch:    master\n\ncommit 4a6a9da8e7d283b781ceee1b20a7f6f25144de57\nAuthor: Ben Nemec <email address hidden>\nDate:   Thu Mar 7 23:00:03 2013 +0000\n\n    Fix Hyper V instance conflicts\n    \n    Fixes bug 1152368\n    \n    If the hyperv driver attempts to boot an instance and a previous\n    instance with the same name was not properly removed, the boot will\n    fail due to an error creating root.vhd.  This only happens when\n    using CoW images.  This fix deletes the instance directory before\n    creating the new instance so that there will never be an old image\n    to interfere with creation of the new one.\n    \n    This is most likely to be an issue in development and test\n    environments that toggle between versions of nova with no migration\n    path.\n    \n    Change-Id: I21eab01590c426234b4b9a55abec4b2d2df0e168\n", 
            "date_created": "2013-03-26 12:41:10.471847+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-05-29 10:20:04.625065+00:00"
}