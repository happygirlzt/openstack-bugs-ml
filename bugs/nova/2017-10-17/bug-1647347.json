{
    "status": "Invalid", 
    "last_updated": "2017-03-14 00:09:26.455950+00:00", 
    "description": "we had some problem when migrate from older release from L to N (it's not kvm driver)\n\n\nwe had this error in virt layer in finish_migration function when we use following code in virt layer's finish_migration\n\nimage_meta = self._image_api.get(context, image_meta.id)\n\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     self.obj_load_attr(name)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]   File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 627, in obj_load_attr\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     _(\"Cannot load '%s' in the base class\") % attrname)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416] NotImplementedError: Cannot load 'id' in the base class\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]\n\nso the problem is seems we didn't have image_meta.id set if it's an old instance because old instance image_meta comes from system_metadata, I think this image.id should be set when we create ImageMeta in any case?\n\ne.g \nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L4006", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1647347", 
    "owner": "None", 
    "id": 1647347, 
    "index": 7836, 
    "openned": "2016-12-05 12:47:05.787560+00:00", 
    "created": "2016-12-05 12:47:05.787560+00:00", 
    "title": "image_meta code migration in finish_migraiton  from older release", 
    "comments": [
        {
            "content": "we had some problem when migrate from older release from L to N (it's not kvm driver)\n\n\nwe had this error in virt layer in finish_migration function when we use following code in virt layer's finish_migration\n\nimage_meta = self._image_api.get(context, image_meta.id)\n\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     self.obj_load_attr(name)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]   File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 627, in obj_load_attr\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     _(\"Cannot load '%s' in the base class\") % attrname)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416] NotImplementedError: Cannot load 'id' in the base class\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]\n\nso the problem is seems we didn't have image_meta.id set if it's an old instance because old instance image_meta comes from system_metadata, I think this image.id should be set when we create ImageMeta in any case?\n\ne.g \nhttps://github.com/openstack/nova/blob/master/nova/compute/manager.py#L4006", 
            "date_created": "2016-12-05 12:47:05.787560+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "see some legacy handling for image property, not sure it's related, any suggestion/comments are welcome", 
            "date_created": "2016-12-05 12:48:32.376112+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "Is the compute node liberty or newton where you're hitting this? Is the image_meta in this case from the liberty side coming from the instance's system_metadata and if so, can you check the database to see if the image meta in system_metadata for that instance has the id field set? I think the image_meta is pulled from the instance system_metadata here:\n\nhttps://github.com/openstack/nova/blob/stable/newton/nova/utils.py#L1160\n\nAnd converted/stored here:\n\nhttps://github.com/openstack/nova/blob/stable/newton/nova/utils.py#L1132", 
            "date_created": "2016-12-07 20:37:52.600156+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Also, I'm assuming this is the zVM virt driver? Do you have the full stack trace from the compute manager when this fails?", 
            "date_created": "2016-12-07 20:38:23.757809+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "right this is zvm driver , the problem is image_meta is object now and some info we needed can't be passed (filtered at https://github.com/openstack/nova/blob/master/nova/objects/image_meta.py#L481), so we have to request from glance again as we need those info \n\nso we use this line in virt layer \nimage_meta = self._image_api.get(context, image_meta.id)\n\nand we had this issue now (we upgrade from liberty to newton, but we do have db sync etc operations)\n\n2016-12-01 07:09:09.560 35918 INFO nova.network.neutronv2.api [req-06bdfbf6-a42e-4026-a84a-e8e9446391c4 7641e26afcd449278e6c7423a22d3490 bbec598cb601462a9d018c7b67dc396e - - -] [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416] Updating port b4ed7463-b3b4-46bd-be37-0ec9ee46fdee with attributes {'binding:host_id': u'opnstk2'}\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [req-06bdfbf6-a42e-4026-a84a-e8e9446391c4 7641e26afcd449278e6c7423a22d3490 bbec598cb601462a9d018c7b67dc396e - - -] [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416] Setting instance vm_state to ERROR\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416] Traceback (most recent call last):\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 3945, in finish_resize\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     disk_info, image_meta)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 3910, in _finish_resize\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     old_instance_type)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     self.force_reraise()\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     six.reraise(self.type_, self.value, self.tb)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 3905, in _finish_resize\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     block_device_info, power_on)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]   File \"/usr/lib/python2.7/site-packages/nova/virt/zvm/driver.py\", line 1536, in finish_migration\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     image_meta = self._image_api.get(context, image_meta.id)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]   File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 67, in getter\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     self.obj_load_attr(name)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]   File \"/usr/lib/python2.7/site-packages/oslo_versionedobjects/base.py\", line 627, in obj_load_attr\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]     _(\"Cannot load '%s' in the base class\") % attrname)\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416] NotImplementedError: Cannot load 'id' in the base class\n2016-12-01 07:09:14.600 35918 ERROR nova.compute.manager [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416]\n2016-12-01 07:09:15.036 35918 INFO nova.compute.manager [req-06bdfbf6-a42e-4026-a84a-e8e9446391c4 7641e26afcd449278e6c7423a22d3490 bbec598cb601462a9d018c7b67dc396e - - -] [instance: c7c2adff-6e33-4b3f-b5e3-74327ea80416] Successfully reverted task state from resize_finish on failure for instance.", 
            "date_created": "2016-12-08 10:47:52.893456+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": " The root cause is image id not saved in nova_api.request_spec\n\nwe added this in our migration scripts to solve the problem\n\ndef add_image_id_into_request_specs(context, max_count):\n    attrs = ['system_metadata']\n    instances = objects.InstanceList.get_by_filters(context,\n                                                    filters={'deleted': False}\n                                                    sort_key='created_at',\n                                                    sort_dir='asc',\n                                                    limit=max_count,\n                                                    expected_attrs=attrs)\n\n    count_all = 0\n    count_hit = 0\n    for instance in instances:\n        try:\n            req_spec = objects.RequestSpec.get_by_instance_uuid(context,\n                                                                instance.uuid)\n        except exception.RequestSpecNotFound:\n            # If not run online database update yet, no request_spec exist\n            # Nothing need to do in this case\n            continue\n        if not req_spec.image.obj_attr_is_set('id'):\n            count_all += 1\n            req_spec.image.id = instance.image_ref\n            req_spec.save()\n            count_hit += 1\n\n    return count_all, count_hit", 
            "date_created": "2016-12-08 10:55:23.868124+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "It should be noted that upgrading from liberty to newton, skipping mitaka, is not supported. You could be skipping something that's required or done during the upgrade to mitaka. Have you tried to recreate this by doing an upgrade from liberty->mitaka->newton and see if you hit the same issue?", 
            "date_created": "2017-03-14 00:04:08.772284+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "And to be clear, you have custom image metadata properties that are not part of the ImageMetaProps object? That's why they get filtered out of the object.\n\nAlso, this is in the zvm virt driver right?\n\nimage_meta = self._image_api.get(context, image_meta.id)\n\nAnd that's specifically because the zvm driver needs to get the full image with your custom metadata properties because the ImageMetaProps object filters them out because they aren't \"registered\" as properties we (upstream nova) know about.\n\nIn that case, I'm going to close this. If you need to get the image metadata properties into the ImageMetaProps object you'd have to propose that upstream, but it might be hard to justify for an out of tree driver.", 
            "date_created": "2017-03-14 00:09:16.224918+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }
    ], 
    "closed": "2017-03-14 00:09:24.947680+00:00"
}