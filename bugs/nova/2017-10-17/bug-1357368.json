{
    "status": "Fix Released", 
    "last_updated": "2016-07-04 09:59:57.517257+00:00", 
    "description": "[Impact]\n\nWhen a volume is attached to a VM in the source compute node through multipath, the related files in /dev/disk/by-path/ are like this\n\nstack@ubuntu-server12:~/devstack$ ls /dev/disk/by-path/*24\n/dev/disk/by-path/ip-192.168.3.50:3260-iscsi-iqn.1992-04.com.emc:cx.fnm00124500890.a5-lun-24\n/dev/disk/by-path/ip-192.168.4.51:3260-iscsi-iqn.1992-04.com.emc:cx.fnm00124500890.b4-lun-24\n\nThe information on its corresponding multipath device is like this\nstack@ubuntu-server12:~/devstack$ sudo multipath -l 3600601602ba03400921130967724e411\n3600601602ba03400921130967724e411 dm-3 DGC,VRAID\nsize=1.0G features='1 queue_if_no_path' hwhandler='1 alua' wp=rw\n|-+- policy='round-robin 0' prio=-1 status=active\n| `- 19:0:0:24 sdl 8:176 active undef running\n`-+- policy='round-robin 0' prio=-1 status=enabled\n\u00a0\u00a0`- 18:0:0:24 sdj 8:144 active undef running\n\nBut when the VM is migrated to the destination, the related information is like the following example since we CANNOT guarantee that all nodes are able to access the same iSCSI portals and the same target LUN number. And the information is used to overwrite connection_info in the DB before the post live migration logic is executed.\n\nstack@ubuntu-server13:~/devstack$ ls /dev/disk/by-path/*24\n/dev/disk/by-path/ip-192.168.3.51:3260-iscsi-iqn.1992-04.com.emc:cx.fnm00124500890.b5-lun-100\n/dev/disk/by-path/ip-192.168.4.51:3260-iscsi-iqn.1992-04.com.emc:cx.fnm00124500890.b4-lun-100\n\nstack@ubuntu-server13:~/devstack$ sudo multipath -l 3600601602ba03400921130967724e411\n3600601602ba03400921130967724e411 dm-3 DGC,VRAID\nsize=1.0G features='1 queue_if_no_path' hwhandler='1 alua' wp=rw\n|-+- policy='round-robin 0' prio=-1 status=active\n| `- 19:0:0:100 sdf 8:176 active undef running\n`-+- policy='round-robin 0' prio=-1 status=enabled\n\u00a0\u00a0`- 18:0:0:100 sdg 8:144 active undef running\n\nAs a result, if post live migration in source side uses <IP>, <IQN> and <TARGET LUN Number> to find the devices to clean up, it may use 192.168.3.51, iqn.1992-04.com.emc:cx.fnm00124500890.a5 and 100.\nHowever, the correct one should be 192.168.3.50, iqn.1992-04.com.emc:cx.fnm00124500890.a5 and 24.\n\nSimilar philosophy in (https://bugs.launchpad.net/nova/+bug/1327497) can be used to fix it: Leverage the unchanged multipath_id to find correct devices to delete.\n\n[Test Case]\n\nLive migrate an instance which uses iSCSI multipath. Verify the correct target is removed on source hypervisor.\n\n[Regression Potential]\n\nNot much, its included in the next release (Juno). The change introduces a check to use a field already used by fiber multipath connections which was not used by iscsi multipath code path on cleanup. If it fails it would keep remaining behavior of not cleaning up iscsi sessions/paths.", 
    "tags": [
        "in-stable-juno", 
        "verification-done"
    ], 
    "importance": "Undecided", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1357368", 
    "owner": "https://api.launchpad.net/1.0/~jeegn-chen", 
    "id": 1357368, 
    "index": 6348, 
    "openned": "2014-08-15 13:20:21.824218+00:00", 
    "created": "2014-08-15 13:20:21.824218+00:00", 
    "title": "Source side post Live Migration Logic cannot disconnect multipath iSCSI devices cleanly", 
    "comments": [
        {
            "content": "When a volume is attached to a VM in the source compute node through multipath, the related files in /dev/disk/by-path/ are like this\n\nstack@ubuntu-server12:~/devstack$ ls /dev/disk/by-path/*24\n/dev/disk/by-path/ip-192.168.3.50:3260-iscsi-iqn.1992-04.com.emc:cx.fnm00124500890.a5-lun-24\n/dev/disk/by-path/ip-192.168.4.51:3260-iscsi-iqn.1992-04.com.emc:cx.fnm00124500890.b4-lun-24\n\nThe information on its corresponding multipath device is like this\nstack@ubuntu-server12:~/devstack$ sudo multipath -l 3600601602ba03400921130967724e411\n3600601602ba03400921130967724e411 dm-3 DGC,VRAID\nsize=1.0G features='1 queue_if_no_path' hwhandler='1 alua' wp=rw\n|-+- policy='round-robin 0' prio=-1 status=active\n| `- 19:0:0:24 sdl 8:176 active undef running\n`-+- policy='round-robin 0' prio=-1 status=enabled\n  `- 18:0:0:24 sdj 8:144 active undef running\n\n\nBut when the VM is migrated to the destination, the related information is like the following example since we CANNOT guarantee that all nodes are able to access the same iSCSI portals and the same target LUN number. And the information is used to overwrite connection_info in the DB before the post live migration logic is executed.\n\nstack@ubuntu-server13:~/devstack$ ls /dev/disk/by-path/*24\n/dev/disk/by-path/ip-192.168.3.51:3260-iscsi-iqn.1992-04.com.emc:cx.fnm00124500890.b5-lun-100\n/dev/disk/by-path/ip-192.168.4.51:3260-iscsi-iqn.1992-04.com.emc:cx.fnm00124500890.b4-lun-100\n\nstack@ubuntu-server12:~/devstack$ sudo multipath -l 3600601602ba03400921130967724e411\n3600601602ba03400921130967724e411 dm-3 DGC,VRAID\nsize=1.0G features='1 queue_if_no_path' hwhandler='1 alua' wp=rw\n|-+- policy='round-robin 0' prio=-1 status=active\n| `- 19:0:0:100 sdf 8:176 active undef running\n`-+- policy='round-robin 0' prio=-1 status=enabled\n  `- 18:0:0:100 sdg 8:144 active undef running\n\nAs a result, if post live migration in source side uses <IP>, <IQN> and <TARGET LUN Number> to find the devices to clean up, it may use 192.168.3.51, iqn.1992-04.com.emc:cx.fnm00124500890.a5 and 100.\nHowever, the correct one should be 192.168.3.50, iqn.1992-04.com.emc:cx.fnm00124500890.a5 and 24.\n\nSimilar philosophy in (https://bugs.launchpad.net/nova/+bug/1327497) can be used to fix it: Leverage the unchanged multipath_id to find correct devices to delete.", 
            "date_created": "2014-08-15 13:20:21.824218+00:00", 
            "author": "https://api.launchpad.net/1.0/~jeegn-chen"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/114539", 
            "date_created": "2014-08-15 14:07:38.335947+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/114539\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=aa9104ccedb3ff13cc34a498b11f5e8ff100fd99\nSubmitter: Jenkins\nBranch:    master\n\ncommit aa9104ccedb3ff13cc34a498b11f5e8ff100fd99\nAuthor: Jeegn Chen <email address hidden>\nDate:   Fri Aug 15 21:40:14 2014 +0800\n\n    Clean up iSCSI multipath devices in Post Live Migration\n    \n    When a volume is attached to a VM in the source compute node through\n    multipath, the related files in /dev/disk/by-path/ are like this\n    \n    stack@ubuntu-server12:~/devstack$ ls /dev/disk/by-path/*24\n    /dev/disk/by-path/ip-192.168.3.50:3260-iscsi-iqn.1992-04.com.emc:cx.\n    fnm00124500890.a5-lun-24\n    /dev/disk/by-path/ip-192.168.4.51:3260-iscsi-iqn.1992-04.com.emc:cx.\n    fnm00124500890.b4-lun-24\n    \n    The information on its corresponding multipath device is like this\n    stack@ubuntu-server12:~/devstack$ sudo multipath -l 3600601602ba034\n    00921130967724e411\n    3600601602ba03400921130967724e411 dm-3 DGC,VRAID\n    size=1.0G features='1 queue_if_no_path' hwhandler='1 alua' wp=rw\n    |-+- policy='round-robin 0' prio=-1 status=active\n    | `- 19:0:0:24 sdl 8:176 active undef running\n    `-+- policy='round-robin 0' prio=-1 status=enabled\n      `- 18:0:0:24 sdj 8:144 active undef running\n    \n    But when the VM is migrated to the destination, the related information is\n    like the following example since we CANNOT guarantee that all nodes are able\n    to access the same iSCSI portals and the same target LUN number. And the\n    information is used to overwrite connection_info in the DB before the post\n    live migration logic is executed.\n    \n    stack@ubuntu-server13:~/devstack$ ls /dev/disk/by-path/*24\n    /dev/disk/by-path/ip-192.168.3.51:3260-iscsi-iqn.1992-04.com.emc:cx.\n    fnm00124500890.b5-lun-100\n    /dev/disk/by-path/ip-192.168.4.51:3260-iscsi-iqn.1992-04.com.emc:cx.\n    fnm00124500890.b4-lun-100\n    \n    stack@ubuntu-server13:~/devstack$ sudo multipath -l 3600601602ba034\n    00921130967724e411\n    3600601602ba03400921130967724e411 dm-3 DGC,VRAID\n    size=1.0G features='1 queue_if_no_path' hwhandler='1 alua' wp=rw\n    |-+- policy='round-robin 0' prio=-1 status=active\n    | `- 19:0:0:100 sdf 8:176 active undef running\n    `-+- policy='round-robin 0' prio=-1 status=enabled\n      `- 18:0:0:100 sdg 8:144 active undef running\n    \n    As a result, if post live migration in source side uses <IP>, <IQN> and\n    <TARGET LUN Number> to find the devices to clean up, it may use 192.168.3.51,\n    iqn.1992-04.com.emc:cx.fnm00124500890.a5 and 100.\n    However, the correct one should be 192.168.3.50, iqn.1992-04.com.emc:cx.\n    fnm00124500890.a5 and 24.\n    \n    Similar philosophy in (https://bugs.launchpad.net/nova/+bug/1327497) can be\n    used to fix it: Leverage the unchanged multipath_id to find correct devices\n    to delete.\n    \n    Change-Id: I875293c3ade9423caa2b8afe9eca25a74606d262\n    Closes-Bug: #1357368\n", 
            "date_created": "2014-10-30 08:54:53.419542+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/134116", 
            "date_created": "2014-11-13 05:38:48.809887+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/134116\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=9c3ec16576e2f7c9d5aff6e4b620d708e6636568\nSubmitter: Jenkins\nBranch:    stable/juno\n\ncommit 9c3ec16576e2f7c9d5aff6e4b620d708e6636568\nAuthor: Jeegn Chen <email address hidden>\nDate:   Fri Aug 15 21:40:14 2014 +0800\n\n    Clean up iSCSI multipath devices in Post Live Migration\n    \n    When a volume is attached to a VM in the source compute node through\n    multipath, the related files in /dev/disk/by-path/ are like this\n    \n    stack@ubuntu-server12:~/devstack$ ls /dev/disk/by-path/*24\n    /dev/disk/by-path/ip-192.168.3.50:3260-iscsi-iqn.1992-04.com.emc:cx.\n    fnm00124500890.a5-lun-24\n    /dev/disk/by-path/ip-192.168.4.51:3260-iscsi-iqn.1992-04.com.emc:cx.\n    fnm00124500890.b4-lun-24\n    \n    The information on its corresponding multipath device is like this\n    stack@ubuntu-server12:~/devstack$ sudo multipath -l 3600601602ba034\n    00921130967724e411\n    3600601602ba03400921130967724e411 dm-3 DGC,VRAID\n    size=1.0G features='1 queue_if_no_path' hwhandler='1 alua' wp=rw\n    |-+- policy='round-robin 0' prio=-1 status=active\n    | `- 19:0:0:24 sdl 8:176 active undef running\n    `-+- policy='round-robin 0' prio=-1 status=enabled\n      `- 18:0:0:24 sdj 8:144 active undef running\n    \n    But when the VM is migrated to the destination, the related information is\n    like the following example since we CANNOT guarantee that all nodes are able\n    to access the same iSCSI portals and the same target LUN number. And the\n    information is used to overwrite connection_info in the DB before the post\n    live migration logic is executed.\n    \n    stack@ubuntu-server13:~/devstack$ ls /dev/disk/by-path/*24\n    /dev/disk/by-path/ip-192.168.3.51:3260-iscsi-iqn.1992-04.com.emc:cx.\n    fnm00124500890.b5-lun-100\n    /dev/disk/by-path/ip-192.168.4.51:3260-iscsi-iqn.1992-04.com.emc:cx.\n    fnm00124500890.b4-lun-100\n    \n    stack@ubuntu-server13:~/devstack$ sudo multipath -l 3600601602ba034\n    00921130967724e411\n    3600601602ba03400921130967724e411 dm-3 DGC,VRAID\n    size=1.0G features='1 queue_if_no_path' hwhandler='1 alua' wp=rw\n    |-+- policy='round-robin 0' prio=-1 status=active\n    | `- 19:0:0:100 sdf 8:176 active undef running\n    `-+- policy='round-robin 0' prio=-1 status=enabled\n      `- 18:0:0:100 sdg 8:144 active undef running\n    \n    As a result, if post live migration in source side uses <IP>, <IQN> and\n    <TARGET LUN Number> to find the devices to clean up, it may use 192.168.3.51,\n    iqn.1992-04.com.emc:cx.fnm00124500890.a5 and 100.\n    However, the correct one should be 192.168.3.50, iqn.1992-04.com.emc:cx.\n    fnm00124500890.a5 and 24.\n    \n    Similar philosophy in (https://bugs.launchpad.net/nova/+bug/1327497) can be\n    used to fix it: Leverage the unchanged multipath_id to find correct devices\n    to delete.\n    \n    Change-Id: I875293c3ade9423caa2b8afe9eca25a74606d262\n    Closes-Bug: #1357368\n    (cherry picked from commit aa9104ccedb3ff13cc34a498b11f5e8ff100fd99)\n", 
            "date_created": "2014-11-13 22:20:44.301012+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "There is an SRU waiting in the trusty-proposed queue for this. Please clarify in which  Ubuntu release(s) this is already fixed, or upload the fix to yakkety, so that the trusty SRU can proceed.", 
            "date_created": "2016-05-18 09:44:50.492088+00:00", 
            "author": "https://api.launchpad.net/1.0/~pitti"
        }, 
        {
            "content": "Hi Martin. This was fixed upstream in nova for OpenStack Juno which mapped to Utopic. So it is already fixed in Utopic and all releases after that.", 
            "date_created": "2016-05-18 13:14:12.937949+00:00", 
            "author": "https://api.launchpad.net/1.0/~corey.bryant"
        }, 
        {
            "content": "Hello Jeegn, or anyone else affected,\n\nAccepted nova into trusty-proposed. The package will build now and be available at https://launchpad.net/ubuntu/+source/nova/1:2014.1.5-0ubuntu1.5 in a few hours, and then in the -proposed repository.\n\nPlease help us by testing this new package.  See https://wiki.ubuntu.com/Testing/EnableProposed for documentation how to enable and use -proposed.  Your feedback will aid us getting this update out to other Ubuntu users.\n\nIf this package fixes the bug for you, please add a comment to this bug, mentioning the version of the package you tested, and change the tag from verification-needed to verification-done. If it does not fix the bug for you, please add a comment stating that, and change the tag to verification-failed.  In either case, details of your testing will help us make a better decision.\n\nFurther information regarding the verification process can be found at https://wiki.ubuntu.com/QATeam/PerformingSRUVerification .  Thank you in advance!", 
            "date_created": "2016-05-24 21:41:37.886873+00:00", 
            "author": "https://api.launchpad.net/1.0/~pitti"
        }, 
        {
            "content": "The verification of the Stable Release Update for nova has completed successfully and the package has now been released to -updates.  Subsequently, the Ubuntu Stable Release Updates Team is being unsubscribed and will not receive messages about this bug report.  In the event that you encounter a regression using the package from -updates please report a new bug using ubuntu-bug and tag the bug report regression-update so we can easily find any regressions.", 
            "date_created": "2016-07-04 09:57:53.230761+00:00", 
            "author": "https://api.launchpad.net/1.0/~pitti"
        }, 
        {
            "content": "This bug was fixed in the package nova - 1:2014.1.5-0ubuntu1.5\n\n---------------\nnova (1:2014.1.5-0ubuntu1.5) trusty; urgency=medium\n\n  * Fix live migration usage of the wrong connector (LP: #1475411)\n    - d/p/Fix-live-migrations-usage-of-the-wrong-connector-inf.patch\n  * Fix wrong used ProcessExecutionError exception (LP: #1308839)\n    - d/p/Fix-wrong-used-ProcessExecutionError-exception.patch\n  * Clean up iSCSI multipath devices in Post Live Migration (LP: #1357368)\n    - d/p/Clean-up-iSCSI-multipath-devices-in-Post-Live-Migrat.patch\n  * Detach iSCSI latest path for latest disk (LP: #1374999)\n    - d/p/Detach-iSCSI-latest-path-for-latest-disk.patch\n\n -- Billy Olsen <email address hidden>  Fri, 29 Apr 2016 15:35:01 -0700", 
            "date_created": "2016-07-04 09:59:50.483997+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ], 
    "closed": "2014-12-18 20:10:43.598633+00:00"
}