{
    "status": "Opinion", 
    "last_updated": "2016-02-17 15:29:19.516920+00:00", 
    "description": "Version:\nKilo\nLiberty\n\nWhen I was trying to build instance with sriov port on my child cell, I used the following command:\nnova boot --image 6df3b3d4-3c9e-4772-9f18-b6f42c6a9c77 --flavor 3 --nic port-id=61c20d21-43fe-487d-9296-893172cb725f --hint target_cell='api_cell!child_cell' sr-vxlan_vm30\n\nBut spawning failed on child_cell compute node. Here are error information in nova-compute.log:\n\n2016-01-14 11:00:17.246 2908 ERROR nova.compute.manager [req-9d7fafab-ea2a-43c3-a201-4234db29c572 8a9704e00c44452590c6c8d014ed028a 452b30922b3f42b59743158f695264c9 - - -] [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c] Instance failed to spawn\n016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c] Traceback (most recent call last):\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2660, in _build_resources\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     yield resources\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2532, in _build_and_run_instance\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     block_device_info=block_device_info)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2879, in spawn\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     write_to_disk=True)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4844, in _get_guest_xml\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     memory_backup_file=memory_backup_file)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4675, in _get_guest_config\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     network_info, virt_type)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4818, in _get_guest_vif_config\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     instance, vif, image_meta, flavor, virt_type)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/vif.py\", line 376, in get_config\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     inst_type, virt_type)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/vif.py\", line 292, in get_config_hw_veb\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     conf, net_type, profile[\"pci_slot\"],\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c] KeyError: 'pci_slot'\n\n\n\nIn function _create_instances_here() in nova/cells/scheduler.py of Kilo and Liberty, I found this:\n\n        # FIXME(danms): The instance was brutally serialized before being\n        # sent over RPC to us. Thus, the pci_requests value wasn't really\n        # sent in a useful form. Since it was getting ignored for cells\n        # before it was part of the Instance, skip it now until cells RPC\n        # is sending proper instance objects.\n        instance_values.pop('pci_requests', None)\n\nThe \"pci_requests\" is discarded by cell scheduler, because of unuseful instance form.This is the causation of above error.", 
    "tags": [
        "cells", 
        "pci"
    ], 
    "importance": "Wishlist", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1540764", 
    "owner": "https://api.launchpad.net/1.0/~li-kun130", 
    "id": 1540764, 
    "index": 3049, 
    "openned": "2016-02-02 06:30:49.561995+00:00", 
    "created": "2016-02-02 06:30:49.561995+00:00", 
    "title": "build instance fail with sriov port on child cell", 
    "comments": [
        {
            "content": "Version:\nKilo\nLiberty\n\nWhen I was trying to build instance with sriov port on my child cell, I used the following command:\nnova boot --image 6df3b3d4-3c9e-4772-9f18-b6f42c6a9c77 --flavor 3 --nic port-id=61c20d21-43fe-487d-9296-893172cb725f --hint target_cell='api_cell!child_cell' sr-vxlan_vm30\n\nBut spawning failed on child_cell compute node. Here are error information in nova-compute.log:\n\n2016-01-14 11:00:17.246 2908 ERROR nova.compute.manager [req-9d7fafab-ea2a-43c3-a201-4234db29c572 8a9704e00c44452590c6c8d014ed028a 452b30922b3f42b59743158f695264c9 - - -] [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c] Instance failed to spawn\n016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c] Traceback (most recent call last):\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2660, in _build_resources\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     yield resources\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2532, in _build_and_run_instance\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     block_device_info=block_device_info)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2879, in spawn\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     write_to_disk=True)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4844, in _get_guest_xml\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     memory_backup_file=memory_backup_file)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4675, in _get_guest_config\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     network_info, virt_type)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4818, in _get_guest_vif_config\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     instance, vif, image_meta, flavor, virt_type)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/vif.py\", line 376, in get_config\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     inst_type, virt_type)\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/vif.py\", line 292, in get_config_hw_veb\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c]     conf, net_type, profile[\"pci_slot\"],\n2016-01-14 11:00:17.246 2908 TRACE nova.compute.manager [instance: b91305de-5501-4083-9a0e-0f4bfc942f5c] KeyError: 'pci_slot'\n\n\n\nIn function _create_instances_here() in nova/cells/scheduler.py of Kilo and Liberty, I found this:\n\n        # FIXME(danms): The instance was brutally serialized before being\n        # sent over RPC to us. Thus, the pci_requests value wasn't really\n        # sent in a useful form. Since it was getting ignored for cells\n        # before it was part of the Instance, skip it now until cells RPC\n        # is sending proper instance objects.\n        instance_values.pop('pci_requests', None)\n\nThe \"pci_requests\" is discarded by cell scheduler, because of unuseful instance form.This is the causation of above error.", 
            "date_created": "2016-02-02 06:30:49.561995+00:00", 
            "author": "https://api.launchpad.net/1.0/~li-kun130"
        }, 
        {
            "content": "I believe the issue is just that Cells does not support PCI pass through. Cells v1 is frozen, and only regressions will be fixed. So this is getting marked as Opinion as a future feature which will likely not ever be done on cells v1.", 
            "date_created": "2016-02-17 15:29:19.043906+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ], 
    "closed": "2016-02-17 15:28:23.114319+00:00"
}