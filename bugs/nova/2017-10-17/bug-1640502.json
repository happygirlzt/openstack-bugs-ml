{
    "status": "Fix Released", 
    "last_updated": "2017-01-27 00:51:36.044271+00:00", 
    "description": "Description\n===========\n\nWhen the /etc/machine-id file is empty on host, unit tests rescue in Libvirt driver case are failing with NovaException. It seems that this file shall be generated by systemd (https://www.freedesktop.org/software/systemd/man/machine-id.html), but it is not present/set on all platforms by default (like 'ubuntu:xenial' container). It may be potentially problematic on some CI/dev-environments that are testing if unit-tests are passing.\n\nSteps to reproduce\n==================\n\n* Launch Docker container 'ubuntu:xenial'\n* Setup repository and install build-dep for Nova\n* Clone Nova from Github\n* Run: tox -e py27 'nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase'\n\nExpected result\n===============\n\nThe unit tests shall be platform-independent, right?\nTherefore in nova/tests/unit/virt/libvirt/test_driver.py there should be a mock for /etc/machine-id file.\n\nActual result\n=============\n\nThe tests nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase.test_rescue_config_drive and nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase.test_rescue are failing due to '**nova.exception.NovaException: Unable to get host UUID: /etc/machine-id is empty**'.\n\nEnvironment\n===========\n\nClean 'ubuntu:xenial' Docker container with just build-deps for Nova from cloud-archive.\n\nLogs & Configs\n==============\n\nFor nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase.test_rescue:\n```\nCaptured traceback:\n~~~~~~~~~~~~~~~~~~~\n\u00a0\u00a0\u00a0\u00a0Traceback (most recent call last):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16387, in test_rescue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0backend, doc = self._test_rescue(instance)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/TEST/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1305, in patched\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return func(*args, **keywargs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16379, in _test_rescue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0network_info, image_meta, rescue_password)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 2527, in rescue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0unrescue_xml = self._get_existing_domain_xml(instance, network_info)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 1270, in _get_existing_domain_xml\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0block_device_info=block_device_info)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 4677, in _get_guest_xml\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0context)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 4494, in _get_guest_config\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0root_device_name)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 4299, in _configure_guest_by_virt_type\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0guest.sysinfo = self._get_guest_config_sysinfo(instance)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 3596, in _get_guest_config_sysinfo\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0sysinfo.system_serial = self._sysinfo_serial_func()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 3585, in _get_host_sysinfo_serial_auto\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return self._get_host_sysinfo_serial_os()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 3579, in _get_host_sysinfo_serial_os\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise exception.NovaException(msg)\n\u00a0\u00a0\u00a0\u00a0nova.exception.NovaException: Unable to get host UUID: /etc/machine-id is empty\n\n```\n\nFor nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase.test_rescue_config_drive:\n```\nCaptured traceback:\n~~~~~~~~~~~~~~~~~~~\n\u00a0\u00a0\u00a0\u00a0Traceback (most recent call last):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/TEST/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1305, in patched\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return func(*args, **keywargs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16426, in test_rescue_config_drive\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0instance, exists=lambda name: name != 'disk.config.rescue')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/TEST/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1305, in patched\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return func(*args, **keywargs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16379, in _test_rescue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0network_info, image_meta, rescue_password)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 2527, in rescue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0unrescue_xml = self._get_existing_domain_xml(instance, network_info)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 1270, in _get_existing_domain_xml\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0block_device_info=block_device_info)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 4677, in _get_guest_xml\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0context)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 4494, in _get_guest_config\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0root_device_name)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 4299, in _configure_guest_by_virt_type\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0guest.sysinfo = self._get_guest_config_sysinfo(instance)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 3596, in _get_guest_config_sysinfo\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0sysinfo.system_serial = self._sysinfo_serial_func()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 3585, in _get_host_sysinfo_serial_auto\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return self._get_host_sysinfo_serial_os()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"nova/virt/libvirt/driver.py\", line 3579, in _get_host_sysinfo_serial_os\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise exception.NovaException(msg)\n\u00a0\u00a0\u00a0\u00a0nova.exception.NovaException: Unable to get host UUID: /etc/machine-id is empty\n```", 
    "tags": [
        "machine-id", 
        "systemd"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1640502", 
    "owner": "https://api.launchpad.net/1.0/~slaweq", 
    "id": 1640502, 
    "index": 4670, 
    "openned": "2016-11-09 14:57:46.597166+00:00", 
    "created": "2016-11-09 14:57:46.597166+00:00", 
    "title": "Empty /etc/machine-id causes failure in unit tests", 
    "comments": [
        {
            "content": "Description\n===========\n\nWhen there is /etc/machine-id file missing on host, unit tests rescue in Libvirt driver case are failing with NovaException. It seems that this file shall be generated by systemd (https://www.freedesktop.org/software/systemd/man/machine-id.html), but it is not present on all platforms by default (like 'ubuntu:xenial' container). It may be potentially problematic on some CI/dev-environments that are testing if unit-tests are passing.\n\n\nSteps to reproduce\n==================\n\n* Launch Docker container 'ubuntu:xenial'\n* Setup repository and install build-dep for Nova\n* Clone Nova from Github\n* Run: tox -e py27 'nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase'\n\n\nExpected result\n===============\n\nThe unit tests shall be platform-independent, right? \nTherefore in nova/tests/unit/virt/libvirt/test_driver.py there should be a mock for /etc/machine-id file. \n\n\nActual result\n=============\n\nThe tests nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase.test_rescue_config_drive and nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase.test_rescue are failing due to 'nova.exception.NovaException: Unable to get host UUID: /etc/machine-id is empty'.\n\n\nEnvironment\n===========\n\nClean 'ubuntu:xenial' Docker container with just build-deps for Nova from cloud-archive.\n\n\nLogs & Configs\n==============\n\nFor nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase.test_rescue:\n```\nCaptured traceback:\n~~~~~~~~~~~~~~~~~~~\n    Traceback (most recent call last):\n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16387, in test_rescue\n        backend, doc = self._test_rescue(instance)\n      File \"/TEST/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1305, in patched\n        return func(*args, **keywargs)\n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16379, in _test_rescue\n        network_info, image_meta, rescue_password)\n      File \"nova/virt/libvirt/driver.py\", line 2527, in rescue\n        unrescue_xml = self._get_existing_domain_xml(instance, network_info)\n      File \"nova/virt/libvirt/driver.py\", line 1270, in _get_existing_domain_xml\n        block_device_info=block_device_info)\n      File \"nova/virt/libvirt/driver.py\", line 4677, in _get_guest_xml\n        context)\n      File \"nova/virt/libvirt/driver.py\", line 4494, in _get_guest_config\n        root_device_name)\n      File \"nova/virt/libvirt/driver.py\", line 4299, in _configure_guest_by_virt_type\n        guest.sysinfo = self._get_guest_config_sysinfo(instance)\n      File \"nova/virt/libvirt/driver.py\", line 3596, in _get_guest_config_sysinfo\n        sysinfo.system_serial = self._sysinfo_serial_func()\n      File \"nova/virt/libvirt/driver.py\", line 3585, in _get_host_sysinfo_serial_auto\n        return self._get_host_sysinfo_serial_os()\n      File \"nova/virt/libvirt/driver.py\", line 3579, in _get_host_sysinfo_serial_os\n        raise exception.NovaException(msg)\n    nova.exception.NovaException: Unable to get host UUID: /etc/machine-id is empty\n\n```\n\nFor nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase.test_rescue_config_drive:\n```\nCaptured traceback:\n~~~~~~~~~~~~~~~~~~~\n    Traceback (most recent call last):\n      File \"/TEST/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1305, in patched\n        return func(*args, **keywargs)\n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16426, in test_rescue_config_drive\n        instance, exists=lambda name: name != 'disk.config.rescue')\n      File \"/TEST/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1305, in patched\n        return func(*args, **keywargs)\n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16379, in _test_rescue\n        network_info, image_meta, rescue_password)\n      File \"nova/virt/libvirt/driver.py\", line 2527, in rescue\n        unrescue_xml = self._get_existing_domain_xml(instance, network_info)\n      File \"nova/virt/libvirt/driver.py\", line 1270, in _get_existing_domain_xml\n        block_device_info=block_device_info)\n      File \"nova/virt/libvirt/driver.py\", line 4677, in _get_guest_xml\n        context)\n      File \"nova/virt/libvirt/driver.py\", line 4494, in _get_guest_config\n        root_device_name)\n      File \"nova/virt/libvirt/driver.py\", line 4299, in _configure_guest_by_virt_type\n        guest.sysinfo = self._get_guest_config_sysinfo(instance)\n      File \"nova/virt/libvirt/driver.py\", line 3596, in _get_guest_config_sysinfo\n        sysinfo.system_serial = self._sysinfo_serial_func()\n      File \"nova/virt/libvirt/driver.py\", line 3585, in _get_host_sysinfo_serial_auto\n        return self._get_host_sysinfo_serial_os()\n      File \"nova/virt/libvirt/driver.py\", line 3579, in _get_host_sysinfo_serial_os\n        raise exception.NovaException(msg)\n    nova.exception.NovaException: Unable to get host UUID: /etc/machine-id is empty\n```", 
            "date_created": "2016-11-09 14:57:46.597166+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdatko"
        }, 
        {
            "content": "Set this in the nova.tests.unit.virt.libvirt.fakelibvirt.FakeLibvirtFixture fixture:\n\nself.flags(sysinfo_serial='none', group='libvirt')\n\nThat should disable that code path by default globally in all of the unit tests that use the libvirt driver. Tests that rely on sysinfo_serial='auto' will need to set that explicitly.", 
            "date_created": "2016-11-09 15:07:17.403128+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/420176", 
            "date_created": "2017-01-13 20:49:47.087529+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "@Matt: I tried to do fix it according to Your advice but FakeLibfirtFixture inherits from fixture.Fixture and don't have \"flags()\" method.\nThis method is defined in nova.test.TestCase class but I'm not sure if FakeLibvirtFixture should inherits from this TestCase class.\nI can use directly CONF.set_override() method in this fixture class if You wan't but I don't know if it's best solution. What You think?\n\nFor now I pushed patch with setting this flag in nova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase - can You review it and tell me if that will be ok for You?", 
            "date_created": "2017-01-14 08:26:05.046873+00:00", 
            "author": "https://api.launchpad.net/1.0/~slaweq"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/420176\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=e0a8582c8dfe6894bdf9efe9e7c6eda4f637440f\nSubmitter: Jenkins\nBranch:    master\n\ncommit e0a8582c8dfe6894bdf9efe9e7c6eda4f637440f\nAuthor: S\u0142awek Kap\u0142o\u0144ski <email address hidden>\nDate:   Fri Jan 13 20:38:20 2017 +0000\n\n    Set sysinfo_serial=\"none\" in LibvirtDriverTestCase\n    \n    Some tests, like test_rescue was failing when on host was\n    empty file /etc/machine-id\n    Setting config option sysinfo_serial to \"none\" in those tests\n    disable code which is trying to get host sysinfo serial which\n    which is not needed in tests and makes unit tests passing in\n    case when /etc/machine-id is empty.\n    \n    Change-Id: I5877b313649d9ba52cd28ff4deb849eead0b770f\n    Closes-Bug: #1640502\n", 
            "date_created": "2017-01-24 12:00:25.411489+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b3 development milestone.", 
            "date_created": "2017-01-27 00:51:34.757431+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-01-24 12:00:23.000171+00:00"
}