{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:45:14.074644+00:00", 
    "description": "Running nova 2013.1 from ubuntu packages...\n\nIn grizzly we have the ability to set glance metadata for an image but the VC driver does not honor hw_vif_model.\n\nSee http://bugs.launchpad.net/openstack-manuals/+bug/1153470\n\nexample:\n# glance image-update \\\n--property hw_disk_bus=ide \\\n--property hw_cdrom_bus=ide \\\n--property hw_vif_model=e1000 \\\nf16-x86_64-openstack-sda\n\nCreated an image in glance and set hw_vif_model=e1000.\n\nglance image-show 0545467e-b4e8-4161-88f4-f8042c092d10\n+-------------------------------+--------------------------------------+\n| Property                      | Value                                |\n+-------------------------------+--------------------------------------+\n| Property 'hw_vif_model'       | e1000                                |\n| Property 'hypervisor_type'    | vmware                               |\n| Property 'vmware_adaptertype' | lsiLogic                             |\n| Property 'vmware_disktype'    | preallocated                         |\n| Property 'vmware_ostype'      | ubuntu64Guest                        |\n| checksum                      | 6a8dfdd18bb2d6dfcac8c3dd7ced9971     |\n| container_format              | ovf                                  |\n| created_at                    | 2013-05-09T00:41:47                  |\n| deleted                       | False                                |\n| disk_format                   | vmdk                                 |\n| id                            | 0545467e-b4e8-4161-88f4-f8042c092d10 |\n| is_public                     | False                                |\n| min_disk                      | 0                                    |\n| min_ram                       | 0                                    |\n| name                          | ESXi5.0                              |\n| owner                         | 26af345b8c5b4cf881a68eb3151febd9     |\n| protected                     | False                                |\n| size                          | 17179869184                          |\n| status                        | active                               |\n| updated_at                    | 2013-05-16T21:02:02                  |\n+-------------------------------+--------------------------------------+\n\nDeploy an instance of this image and set nova-compute to debug.\n\nIn nova-compute.log:\n\n, {u'instance_uuid': u'72\n58c294-f72b-4374-a70b-6e71733618b3', u'deleted': 0, u'created_at': u'2013-05-22T22:49:28.000000', u'updated_at': None, u'value': u'vmware', u'key': u'image_hypervisor_typ\ne', u'deleted_at': None, u'id': 18692}, {u'instance_uuid': u'7258c294-f72b-4374-a70b-6e71733618b3', u'deleted': 0, u'created_at': u'2013-05-22T22:49:28.000000', u'updated_at': None, u'value': u'e1000', u'key': u'image_hw_vif_model', \n\nWe can see that the metadata is passed to nova-compute as expected.\n\nLooking on ESX host that the instance gets deployed on, the Adapter Type is always set to Flexible.", 
    "tags": [
        "vmware"
    ], 
    "importance": "Critical", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1183192", 
    "owner": "https://api.launchpad.net/1.0/~heut2008", 
    "id": 1183192, 
    "index": 138, 
    "openned": "2013-05-23 05:00:35.037796+00:00", 
    "created": "2013-05-23 05:00:35.037796+00:00", 
    "title": "VMware VC Driver does not honor hw_vif_model from glance", 
    "comments": [
        {
            "content": "Running nova 2013.1 from ubuntu packages...\n\nIn grizzly we have the ability to set glance metadata for an image but the VC driver does not honor hw_vif_model.\n\nSee http://bugs.launchpad.net/openstack-manuals/+bug/1153470\n\nexample:\n# glance image-update \\\n--property hw_disk_bus=ide \\\n--property hw_cdrom_bus=ide \\\n--property hw_vif_model=e1000 \\\nf16-x86_64-openstack-sda\n\nCreated an image in glance and set hw_vif_model=e1000.\n\nglance image-show 0545467e-b4e8-4161-88f4-f8042c092d10\n+-------------------------------+--------------------------------------+\n| Property                      | Value                                |\n+-------------------------------+--------------------------------------+\n| Property 'hw_vif_model'       | e1000                                |\n| Property 'hypervisor_type'    | vmware                               |\n| Property 'vmware_adaptertype' | lsiLogic                             |\n| Property 'vmware_disktype'    | preallocated                         |\n| Property 'vmware_ostype'      | ubuntu64Guest                        |\n| checksum                      | 6a8dfdd18bb2d6dfcac8c3dd7ced9971     |\n| container_format              | ovf                                  |\n| created_at                    | 2013-05-09T00:41:47                  |\n| deleted                       | False                                |\n| disk_format                   | vmdk                                 |\n| id                            | 0545467e-b4e8-4161-88f4-f8042c092d10 |\n| is_public                     | False                                |\n| min_disk                      | 0                                    |\n| min_ram                       | 0                                    |\n| name                          | ESXi5.0                              |\n| owner                         | 26af345b8c5b4cf881a68eb3151febd9     |\n| protected                     | False                                |\n| size                          | 17179869184                          |\n| status                        | active                               |\n| updated_at                    | 2013-05-16T21:02:02                  |\n+-------------------------------+--------------------------------------+\n\nDeploy an instance of this image and set nova-compute to debug.\n\nIn nova-compute.log:\n\n, {u'instance_uuid': u'72\n58c294-f72b-4374-a70b-6e71733618b3', u'deleted': 0, u'created_at': u'2013-05-22T22:49:28.000000', u'updated_at': None, u'value': u'vmware', u'key': u'image_hypervisor_typ\ne', u'deleted_at': None, u'id': 18692}, {u'instance_uuid': u'7258c294-f72b-4374-a70b-6e71733618b3', u'deleted': 0, u'created_at': u'2013-05-22T22:49:28.000000', u'updated_at': None, u'value': u'e1000', u'key': u'image_hw_vif_model', \n\nWe can see that the metadata is passed to nova-compute as expected.\n\nLooking on ESX host that the instance gets deployed on, the Adapter Type is always set to Flexible.", 
            "date_created": "2013-05-23 05:00:35.037796+00:00", 
            "author": "https://api.launchpad.net/1.0/~jcherkas"
        }, 
        {
            "content": "Looking at the code for the vmware driver,  I think the issue is in the way the VirtualMachineConfigSpec is created.\nThe networking part of the spec only creates a \"VirtualPCNet32\" type network adapter and does not look at the adapter type configuration in this case the \"e1000\" type. So this means every time a VM is created on an ESXi it will be done with the nic of type \"VirtualPCNet32\"\n\nhttps://github.com/openstack/nova/blob/master/nova/virt/vmwareapi/vm_util.py#L121  - method responsible for creating the network related spec \n \nhttps://github.com/openstack/nova/blob/master/nova/virt/vmwareapi/vm_util.py#L130  - Code that always create the \"VirtualPCNet32\" type of adapter.\n\nCan you confirm if for the VMs created on the ESXi they all have the adapter type set as \"VirtualPCNet32\" for the NIC?\n\n\n", 
            "date_created": "2013-05-23 22:56:36.944665+00:00", 
            "author": "https://api.launchpad.net/1.0/~ssurana"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/30384", 
            "date_created": "2013-05-24 03:58:26.817952+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Looking at the vmx file that gets generated the ethernet type actually doesnt even get set.\n\nWhat we need to see in the vmx file is ethernet0.virtualDev = \"e1000\".  If virtualDev is never set then the default adapter type is \nset to Flexible and running lspci in the guest we can see that its\n\n02:00.0 Ethernet controller: Advanced Micro Devices [AMD] 79c970 [PCnet32 LANCE] (rev 10).\n\nHere is the Nova generated vmx file.\n\n.encoding = \"UTF-8\"\nconfig.version = \"8\"\nvirtualHW.version = \"9\"\npciBridge0.present = \"true\"\npciBridge4.present = \"true\"\npciBridge4.virtualDev = \"pcieRootPort\"\npciBridge4.functions = \"8\"\npciBridge5.present = \"true\"\npciBridge5.virtualDev = \"pcieRootPort\"\npciBridge5.functions = \"8\"\npciBridge6.present = \"true\"\npciBridge6.virtualDev = \"pcieRootPort\"\npciBridge6.functions = \"8\"\npciBridge7.present = \"true\"\npciBridge7.virtualDev = \"pcieRootPort\"\npciBridge7.functions = \"8\"\nvmci0.present = \"true\"\nhpet0.present = \"true\"\nnvram = \"instance-00000dd8.nvram\"\nvirtualHW.productCompatibility = \"hosted\"\npowerType.powerOff = \"soft\"\npowerType.powerOn = \"hard\"\npowerType.suspend = \"hard\"\npowerType.reset = \"soft\"\ndisplayName = \"instance-00000dd8\"\nextendedConfigFile = \"instance-00000dd8.vmxf\"\nmemsize = \"2048\"\nethernet0.present = \"true\"\nethernet0.dvs.switchId = \"f1 0d 08 50 c3 85 76 d8-5b b8 4c 28 7c 2c 35 98\"\nethernet0.dvs.portId = \"258\"\nethernet0.dvs.portgroupId = \"dvportgroup-38\"\nethernet0.dvs.connectionId = \"1973291629\"\nethernet0.addressType = \"static\"\nethernet0.address = \"fa:16:3e:b7:6d:ca\"\nethernet1.present = \"true\"\nethernet1.dvs.switchId = \"f1 0d 08 50 c3 85 76 d8-5b b8 4c 28 7c 2c 35 98\"\nethernet1.dvs.portId = \"257\"\nethernet1.dvs.portgroupId = \"dvportgroup-38\"\nethernet1.dvs.connectionId = \"1973298296\"\nethernet1.addressType = \"static\"\nethernet1.address = \"fa:16:3e:49:6c:57\"\nguestOS = \"other\"\nuuid.bios = \"42 08 ab 2a b4 73 9d 97-fd 4d 89 be ee 34 55 27\"\nvc.uuid = \"50 08 29 08 f9 df 64 af-3a 4f 38 c2 fc 0a ed 6f\"\nnvp.vm-uuid = \"09a16348-9fba-40b9-9c46-5c4a258f8977\"\nnvp.iface-id.0 = \"9a1b7c53-73e8-4f17-af92-ac97a97a26c0\"\nnvp.iface-id.1 = \"291f2cf7-61e6-49fa-9c4f-8c7f715abb0c\"\nRemoteDisplay.vnc.enabled = \"true\"\nRemoteDisplay.vnc.port = \"5989\"\nRemoteDisplay.vnc.password = \"nicira\"\nscsi0.present = \"TRUE\"\nscsi0.sharedBus = \"none\"\nscsi0.virtualDev = \"lsilogic\"\nscsi0:0.present = \"TRUE\"\nscsi0:0.fileName = \"instance-00000dd8.vmdk\"\nscsi0:0.deviceType = \"scsi-hardDisk\"\nRemoteDisplay.vnc.key = \"CjskCREyAwwLLAwjMzoAITwdCQIHOA0hFwcBAh4iCBUHGycABR8oBBMYJCQrLgEGNDs8AA8pARIfIxIQOiUFEzUzEAIiFywAKRsgMDwMOAAzNCghHh0gChojOCA5GQIjOSYZGiU3AAMuDhEQNCwIDTYkBRAXFhIMLykIJRUTMCQ=\"\nfloppy0.present = \"FALSE\"\nscsi0.pciSlotNumber = \"16\"\nethernet0.pciSlotNumber = \"32\"\nethernet1.pciSlotNumber = \"33\"\nvmci0.id = \"-298560217\"\nvmci0.pciSlotNumber = \"34\"\nuuid.location = \"56 4d 1b ff 93 c3 1f f0-16 2a f2 e3 23 30 16 55\"\ncleanShutdown = \"FALSE\"\nreplay.supported = \"FALSE\"\nsched.swap.derivedName = \"/vmfs/volumes/73cb9e0e-73f74c4b/instance-00000dd8/instance-00000dd8-420a3fbd.vswp\"\nreplay.filename = \"\"\nscsi0:0.redo = \"\"\npciBridge0.pciSlotNumber = \"17\"\npciBridge4.pciSlotNumber = \"21\"\npciBridge5.pciSlotNumber = \"22\"\npciBridge6.pciSlotNumber = \"23\"\npciBridge7.pciSlotNumber = \"24\"\nvmotion.checkpointFBSize = \"4194304\"\nsoftPowerOff = \"FALSE\"\n\nI can try Yaguang's patch tomorrow and report back.\n", 
            "date_created": "2013-05-24 04:47:22.036104+00:00", 
            "author": "https://api.launchpad.net/1.0/~jcherkas"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/30384\nCommitted: http://github.com/openstack/nova/commit/088995fc2c792d6d029abd0e45d5c0cf09a5125a\nSubmitter: Jenkins\nBranch:    master\n\ncommit 088995fc2c792d6d029abd0e45d5c0cf09a5125a\nAuthor: Yaguang Tang <email address hidden>\nDate:   Fri May 24 11:50:43 2013 +0800\n\n    Fix VMware Hyper can't honor hw_vif_model image property.\n    \n    Support setting instance vif model through image property,\n    change default vif model to e1000. Available vif model options\n    for VMware Hyperv is \"VirtualE1000, VirtualPCNet32, VirtualVmxnet\".\n    \n    DocImpact\n    Fix bug #1183192\n    \n    Change-Id: I3a98bc26df7e2252bf043a71acbba2a158e213b8\n", 
            "date_created": "2013-06-14 19:08:40.117126+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/grizzly\nReview: https://review.openstack.org/33679", 
            "date_created": "2013-06-19 17:24:00.091675+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/33679\nCommitted: http://github.com/openstack/nova/commit/19c443bc58f5cdc9623bc6f7e41d9c4cf588a4aa\nSubmitter: Jenkins\nBranch:    stable/grizzly\n\ncommit 19c443bc58f5cdc9623bc6f7e41d9c4cf588a4aa\nAuthor: Yaguang Tang <email address hidden>\nDate:   Fri May 24 11:50:43 2013 +0800\n\n    Fix VMware Hyper can't honor hw_vif_model image property.\n    \n    Support setting instance vif model through image property,\n    change default vif model to e1000. Available vif model options\n    for VMware Hyperv is \"VirtualE1000, VirtualPCNet32, VirtualVmxnet\".\n    Also this patch removes the unused list_interface method and tests.\n    \n    DocImpact\n    Fix bug #1183192\n    Fix bug #1187251\n    \n    Change-Id: I3a98bc26df7e2252bf043a71acbba2a158e213b8\n    (cherry picked from commit 088995fc2c792d6d029abd0e45d5c0cf09a5125a)\n", 
            "date_created": "2013-06-19 21:27:35.003722+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-07-17 12:06:05.652076+00:00"
}