{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:20:13.817070+00:00", 
    "description": "In the case a nova-scheduler service dies during processing (see below how to reproduce it), the message is not rescheduled to another one in a HA setup.\n\nOslo messaging raises a timeout in the conductor:\n\n2014-12-11 07:49:53.565 ERROR nova.scheduler.driver [req-f866a584-ba67-42a8-aec7-5500b631708e admin admin] Exception during scheduler.run_instance\n\u00a0Traceback (most recent call last):\n\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/conductor/manager.py\", line 640, in build_instances\n\u00a0\u00a0\u00a0\u00a0\u00a0request_spec, filter_properties)\n\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/scheduler/client/__init__.py\", line 49, in select_destinations\n\u00a0\u00a0\u00a0\u00a0\u00a0context, request_spec, filter_properties)\n\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/scheduler/client/__init__.py\", line 35, in __run_method\n\u00a0\u00a0\u00a0\u00a0\u00a0return getattr(self.instance, __name)(*args, **kwargs)\n\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/scheduler/client/query.py\", line 34, in select_destinations\n\u00a0\u00a0\u00a0\u00a0\u00a0context, request_spec, filter_properties)\n\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/scheduler/rpcapi.py\", line 118, in select_destinations\n\u00a0\u00a0\u00a0\u00a0\u00a0request_spec=request_spec, filter_properties=filter_properties)\n\u00a0\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 152, in call\n\u00a0\u00a0\u00a0\u00a0\u00a0retry=self.retry)\n\u00a0\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n\u00a0\u00a0\u00a0\u00a0\u00a0timeout=timeout, retry=retry)\n\u00a0\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 436, in send\n\u00a0\u00a0\u00a0\u00a0\u00a0retry=retry)\n\u00a0\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 425, in _send\n\u00a0\u00a0\u00a0\u00a0\u00a0result = self._waiter.wait(msg_id, timeout)\n\u00a0\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 315, in wait\n\u00a0\u00a0\u00a0\u00a0\u00a0reply, ending = self._poll_connection(msg_id, timer)\n\u00a0\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 264, in _poll_connection\n\u00a0\u00a0\u00a0\u00a0\u00a0% msg_id)\n\u00a0MessagingTimeout: Timed out waiting for a reply to message ID aec640c6da0f4cf383b5100ba2441331\n\nThe proper behavior would be to at least try once again, even in a single machine setup - the message will be picked up by another server or the same one when it restarts.\n\nThe Oslo messaging architecture doesn't support this being handled by the AMQP server, so message rescheduling has to be implemented in Nova (by the application logic).\n\nTo reproduce the error, I added ipdb.set_trace() in nova/scheduler/filter_scheduler.py:287 before returning selected_hosts in the _schedule method.", 
    "tags": [
        "nova-conductor", 
        "nova-scheduler"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1402574", 
    "owner": "https://api.launchpad.net/1.0/~xek", 
    "id": 1402574, 
    "index": 6591, 
    "openned": "2014-12-15 10:01:29.300801+00:00", 
    "created": "2014-12-15 10:01:29.300801+00:00", 
    "title": "No fault-tolerance in nova-scheduler", 
    "comments": [
        {
            "content": "In the case a nova-scheduler server dies during processing (see below how I reproduce it), the message is not rescheduled to another one in a HA setup.\n\nOslo messaging raises a timeout in the conductor:\n\n2014-12-11 07:49:53.565 ERROR nova.scheduler.driver [req-f866a584-ba67-42a8-aec7-5500b631708e admin admin] Exception during scheduler.run_instance\n Traceback (most recent call last):\n   File \"/opt/stack/nova/nova/conductor/manager.py\", line 640, in build_instances\n     request_spec, filter_properties)\n   File \"/opt/stack/nova/nova/scheduler/client/__init__.py\", line 49, in select_destinations\n     context, request_spec, filter_properties)\n   File \"/opt/stack/nova/nova/scheduler/client/__init__.py\", line 35, in __run_method\n     return getattr(self.instance, __name)(*args, **kwargs) \n   File \"/opt/stack/nova/nova/scheduler/client/query.py\", line 34, in select_destinations\n     context, request_spec, filter_properties)\n   File \"/opt/stack/nova/nova/scheduler/rpcapi.py\", line 118, in select_destinations\n     request_spec=request_spec, filter_properties=filter_properties)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 152, in call\n     retry=self.retry)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n     timeout=timeout, retry=retry)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 436, in send\n     retry=retry)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 425, in _send\n     result = self._waiter.wait(msg_id, timeout)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 315, in wait\n     reply, ending = self._poll_connection(msg_id, timer)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 264, in _poll_connection\n     % msg_id)\n MessagingTimeout: Timed out waiting for a reply to message ID aec640c6da0f4cf383b5100ba2441331\n\nThe proper behavior would be to at least try once again, even in a single machine setup - the message will be picked up by another server or the same one when it restarts.\n\nThe Oslo messaging architecture doesn't support this being handled by the AMQP server, so message rescheduling has to be implemented in Nova (by the application logic).\n\n\nTo reproduce the error, I added ipdb.set_trace() in nova/scheduler/filter_scheduler.py:287 before returning selected_hosts in the _schedule method.", 
            "date_created": "2014-12-15 10:01:29.300801+00:00", 
            "author": "https://api.launchpad.net/1.0/~xek"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/142124", 
            "date_created": "2014-12-16 14:57:01.665342+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/142124\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8ba2d8ea527e6d3b4699482ff4567010c1cdc990\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8ba2d8ea527e6d3b4699482ff4567010c1cdc990\nAuthor: Grzegorz Grasza <email address hidden>\nDate:   Tue Dec 16 07:42:14 2014 +0100\n\n    Reschedule queries to nova-scheduler after a timeout occurs\n    \n    In case the nova-scheduler service dies, try sending the message\n    once again. The message will be picked up by another server or\n    the same one when it restarts.\n    \n    Change-Id: I2b891bf6d0a3d8f45fd98ca54a665ae78eab78b3\n    Closes-Bug: 1402574\n", 
            "date_created": "2015-01-23 01:17:32.712091+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-02-05 20:24:06.159388+00:00"
}