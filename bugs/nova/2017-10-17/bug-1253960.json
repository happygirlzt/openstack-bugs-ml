{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 08:48:31.853724+00:00", 
    "description": "devstack, `nova --version` reports 2.15.0.81\nVIRT_DRIVER=docker\ndatabase: PostgreSQL\n\nwhen starting nova-compute I'm getting an exception:\n\n2013-11-20 11:41:27.413 DEBUG nova.openstack.common.lockutils [-] Semaphore / lock released \"update_available_resource\" from (pid=15320) inner /opt/stack/nova/nova/openstack/common/lockutils.py:251\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/queue.py\", line 107, in switch\n    self.greenlet.switch(value)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/openstack/common/service.py\", line 448, in run_service\n    service.start()\n  File \"/opt/stack/nova/nova/service.py\", line 164, in start\n    self.manager.pre_start_hook()\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 788, in pre_start_hook\n    self.update_available_resource(nova.context.get_admin_context())\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 5065, in update_available_resource\n    rt.update_available_resource(context)\n  File \"/opt/stack/nova/nova/openstack/common/lockutils.py\", line 248, in inner\n    return f(*args, **kwargs)\n  File \"/opt/stack/nova/nova/compute/resource_tracker.py\", line 326, in update_available_resource\n    self._sync_compute_node(context, resources)\n  File \"/opt/stack/nova/nova/compute/resource_tracker.py\", line 349, in _sync_compute_node\n    self._create(context, resources)\n  File \"/opt/stack/nova/nova/compute/resource_tracker.py\", line 365, in _create\n    values)\n  File \"/opt/stack/nova/nova/conductor/api.py\", line 236, in compute_node_create\n    return self._manager.compute_node_create(context, values)\n  File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 356, in compute_node_create\n    return cctxt.call(context, 'compute_node_create', values=values)\n  File \"/opt/stack/nova/nova/rpcclient.py\", line 85, in call\n    return self._invoke(self.proxy.call, ctxt, method, **kwargs)\n  File \"/opt/stack/nova/nova/rpcclient.py\", line 63, in _invoke\n    return cast_or_call(ctxt, msg, **self.kwargs)\n  File \"/opt/stack/nova/nova/openstack/common/rpc/proxy.py\", line 126, in call\n    result = rpc.call(context, real_topic, msg, timeout)\n  File \"/opt/stack/nova/nova/openstack/common/rpc/__init__.py\", line 139, in call\n    return _get_impl().call(CONF, context, topic, msg, timeout)\n  File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 816, in call\n    rpc_amqp.get_connection_pool(conf, Connection))\n  File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 574, in call\n    rv = list(rv)\n  File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 539, in __iter__\n    raise result\nRemoteError: Remote error: DBError (DataError) invalid input syntax for integer: \"1.0\"\nLINE 1: ...L, NULL, 0, 5, 1, 11953, 54, 0, 512, 0, 'docker', '1.0', 'hg...\n                                                             ^\n\n(should be in fixed-width font, the circumflex accent points to '1.0')\n\nThis appears to be the same issue as #1195139  but with docker driver.  Also related to https://blueprints.launchpad.net/nova/+spec/save-hypervisor-version-as-string\n\nnova-compute starts up OK after applying a similar change as for #1195139 :\n\n--- nova/virt/docker/driver.py.orig\n+++ nova/virt/docker/driver.py\n@@ -159,7 +159,7 @@\n             'local_gb_used': disk['used'] / unit.Gi,\n             'disk_available_least': disk['available'] / unit.Gi,\n             'hypervisor_type': 'docker',\n-            'hypervisor_version': '1.0',\n+            'hypervisor_version': utils.convert_version_to_int('1.0'),\n             'hypervisor_hostname': self._nodename,\n             'cpu_info': '?',\n             'supported_instances': jsonutils.dumps([", 
    "tags": [
        "docker", 
        "powervm"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1253960", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1253960, 
    "index": 1325, 
    "openned": "2013-11-22 09:52:39.749013+00:00", 
    "created": "2013-11-22 09:52:39.749013+00:00", 
    "title": "docker driver reports hypervisor version in wrong format", 
    "comments": [
        {
            "content": "devstack, `nova --version` reports 2.15.0.81\nVIRT_DRIVER=docker\ndatabase: PostgreSQL\n\nwhen starting nova-compute I'm getting an exception:\n\n2013-11-20 11:41:27.413 DEBUG nova.openstack.common.lockutils [-] Semaphore / lock released \"update_available_resource\" from (pid=15320) inner /opt/stack/nova/nova/openstack/common/lockutils.py:251\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/queue.py\", line 107, in switch\n    self.greenlet.switch(value)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/openstack/common/service.py\", line 448, in run_service\n    service.start()\n  File \"/opt/stack/nova/nova/service.py\", line 164, in start\n    self.manager.pre_start_hook()\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 788, in pre_start_hook\n    self.update_available_resource(nova.context.get_admin_context())\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 5065, in update_available_resource\n    rt.update_available_resource(context)\n  File \"/opt/stack/nova/nova/openstack/common/lockutils.py\", line 248, in inner\n    return f(*args, **kwargs)\n  File \"/opt/stack/nova/nova/compute/resource_tracker.py\", line 326, in update_available_resource\n    self._sync_compute_node(context, resources)\n  File \"/opt/stack/nova/nova/compute/resource_tracker.py\", line 349, in _sync_compute_node\n    self._create(context, resources)\n  File \"/opt/stack/nova/nova/compute/resource_tracker.py\", line 365, in _create\n    values)\n  File \"/opt/stack/nova/nova/conductor/api.py\", line 236, in compute_node_create\n    return self._manager.compute_node_create(context, values)\n  File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 356, in compute_node_create\n    return cctxt.call(context, 'compute_node_create', values=values)\n  File \"/opt/stack/nova/nova/rpcclient.py\", line 85, in call\n    return self._invoke(self.proxy.call, ctxt, method, **kwargs)\n  File \"/opt/stack/nova/nova/rpcclient.py\", line 63, in _invoke\n    return cast_or_call(ctxt, msg, **self.kwargs)\n  File \"/opt/stack/nova/nova/openstack/common/rpc/proxy.py\", line 126, in call\n    result = rpc.call(context, real_topic, msg, timeout)\n  File \"/opt/stack/nova/nova/openstack/common/rpc/__init__.py\", line 139, in call\n    return _get_impl().call(CONF, context, topic, msg, timeout)\n  File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 816, in call\n    rpc_amqp.get_connection_pool(conf, Connection))\n  File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 574, in call\n    rv = list(rv)\n  File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 539, in __iter__\n    raise result\nRemoteError: Remote error: DBError (DataError) invalid input syntax for integer: \"1.0\"\nLINE 1: ...L, NULL, 0, 5, 1, 11953, 54, 0, 512, 0, 'docker', '1.0', 'hg...\n                                                             ^\n\n(should be in fixed-width font, the circumflex accent points to '1.0')\n\nThis appears to be the same issue as #1195139  but with docker driver.  Also related to https://blueprints.launchpad.net/nova/+spec/save-hypervisor-version-as-string\n\nnova-compute starts up OK after applying a similar change as for #1195139 :\n\n--- nova/virt/docker/driver.py.orig\n+++ nova/virt/docker/driver.py\n@@ -159,7 +159,7 @@\n             'local_gb_used': disk['used'] / unit.Gi,\n             'disk_available_least': disk['available'] / unit.Gi,\n             'hypervisor_type': 'docker',\n-            'hypervisor_version': '1.0',\n+            'hypervisor_version': utils.convert_version_to_int('1.0'),\n             'hypervisor_hostname': self._nodename,\n             'cpu_info': '?',\n             'supported_instances': jsonutils.dumps([", 
            "date_created": "2013-11-22 09:52:39.749013+00:00", 
            "author": "https://api.launchpad.net/1.0/~mig.hg"
        }, 
        {
            "content": "So if the powervm driver doesn't die, this also impacts the powervm driver.", 
            "date_created": "2013-11-23 21:55:06.792403+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Not that anyone is using it in production, but the fake virt driver in nova has this issue also.", 
            "date_created": "2013-11-23 22:04:13.055143+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/58110", 
            "date_created": "2013-11-23 23:24:16.049201+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/58110\nCommitted: http://github.com/openstack/nova/commit/1588de2714a0f28a0da219f319d6a7ac6c1f9bab\nSubmitter: Jenkins\nBranch:    master\n\ncommit 1588de2714a0f28a0da219f319d6a7ac6c1f9bab\nAuthor: Matt Riedemann <email address hidden>\nDate:   Sat Nov 23 14:00:48 2013 -0800\n\n    docker: return hypervisor_version as an int rather than a string\n    \n    The compute_nodes.hypervisor_version type in the database is an integer\n    so the docker driver needs to return the hypervisor_version as an\n    integer rather than a string.\n    \n    Also adds the missing unit test for get_available_resource.\n    \n    Closes-Bug: #1253960\n    \n    Change-Id: I4e2ac13f9203b54e71f1f5cd8e15311921dd85c5\n", 
            "date_created": "2013-11-26 22:14:19.853906+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-12-04 10:05:18.299928+00:00"
}