{
    "status": "Fix Released", 
    "last_updated": "2017-02-03 19:08:13.931425+00:00", 
    "description": "http://logs.openstack.org/91/426991/1/check/gate-tempest-dsvm-neutron-full-ubuntu-xenial/f218227/console.html#_2017-02-01_02_06_33_592237\n\n2017-02-01 02:06:33.592237 | tempest.api.compute.servers.test_servers_negative.ServersNegativeTestJSON.test_reboot_deleted_server[id-581a397d-5eab-486f-9cf9-1014bbd4c984,negative]\n2017-02-01 02:06:33.592305 | ------------------------------------------------------------------------------------------------------------------------------------------------------\n2017-02-01 02:06:33.592321 | \n2017-02-01 02:06:33.592340 | Captured traceback:\n2017-02-01 02:06:33.592367 | ~~~~~~~~~~~~~~~~~~~\n2017-02-01 02:06:33.592398 |     Traceback (most recent call last):\n2017-02-01 02:06:33.592453 |       File \"tempest/api/compute/servers/test_servers_negative.py\", line 190, in test_reboot_deleted_server\n2017-02-01 02:06:33.593010 |         server['id'], type='SOFT')\n2017-02-01 02:06:33.593072 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 485, in assertRaises\n2017-02-01 02:06:33.593110 |         self.assertThat(our_callable, matcher)\n2017-02-01 02:06:33.593162 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 496, in assertThat\n2017-02-01 02:06:33.593205 |         mismatch_error = self._matchHelper(matchee, matcher, message, verbose)\n2017-02-01 02:06:33.593266 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 547, in _matchHelper\n2017-02-01 02:06:33.593294 |         mismatch = matcher.match(matchee)\n2017-02-01 02:06:33.593345 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/matchers/_exception.py\", line 108, in match\n2017-02-01 02:06:33.593388 |         mismatch = self.exception_matcher.match(exc_info)\n2017-02-01 02:06:33.593443 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/matchers/_higherorder.py\", line 62, in match\n2017-02-01 02:06:33.593468 |         mismatch = matcher.match(matchee)\n2017-02-01 02:06:33.593515 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 475, in match\n2017-02-01 02:06:33.593544 |         reraise(*matchee)\n2017-02-01 02:06:33.593597 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/matchers/_exception.py\", line 101, in match\n2017-02-01 02:06:33.593618 |         result = matchee()\n2017-02-01 02:06:33.593667 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 1049, in __call__\n2017-02-01 02:06:33.593699 |         return self._callable_object(*self._args, **self._kwargs)\n2017-02-01 02:06:33.593736 |       File \"tempest/lib/services/compute/servers_client.py\", line 236, in reboot_server\n2017-02-01 02:06:33.593777 |         return self.action(server_id, 'reboot', **kwargs)\n2017-02-01 02:06:33.593814 |       File \"tempest/lib/services/compute/servers_client.py\", line 186, in action\n2017-02-01 02:06:33.594170 |         post_body)\n2017-02-01 02:06:33.594219 |       File \"tempest/lib/common/rest_client.py\", line 275, in post\n2017-02-01 02:06:33.594261 |         return self.request('POST', url, extra_headers, headers, body, chunked)\n2017-02-01 02:06:33.594298 |       File \"tempest/lib/services/compute/base_compute_client.py\", line 48, in request\n2017-02-01 02:06:33.594328 |         method, url, extra_headers, headers, body, chunked)\n2017-02-01 02:06:33.594360 |       File \"tempest/lib/common/rest_client.py\", line 663, in request\n2017-02-01 02:06:33.594392 |         self._error_checker(resp, resp_body)\n2017-02-01 02:06:33.594449 |       File \"tempest/lib/common/rest_client.py\", line 775, in _error_checker\n2017-02-01 02:06:33.594496 |         raise exceptions.Conflict(resp_body, resp=resp)\n2017-02-01 02:06:33.594555 |     tempest.lib.exceptions.Conflict: An object with that identifier already exists\n2017-02-01 02:06:33.594641 |     Details: {u'code': 409, u'message': u\"Cannot 'reboot' instance d9978a80-0349-4cb8-84fa-46aa0b8eaa16 while it is in vm_state building\"}\n\nhttp://logs.openstack.org/91/426991/1/check/gate-tempest-dsvm-neutron-full-ubuntu-xenial/f218227/logs/screen-n-api.txt.gz#_2017-02-01_01_25_02_367\n\nThe test creates a server, then deletes the server and waits for it to be gone and then tries to reboot it and expects a 404 but gets a 409 because the instance is building.\n\nWe're probably hitting a window of time between when we have a build request and a real instance due to the recent change of moving instance creation from nova-api to nova-conductor.\n\nLooks like this started on 1/27:\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22Cannot%20'reboot'%20instance%5C%22%20AND%20message%3A%5C%22while%20it%20is%20in%20vm_state%20building%5C%22%20AND%20tags%3A%5C%22screen-n-api.txt%5C%22&from=7d\n\nWhich is when this merged: https://review.openstack.org/#/c/319379/", 
    "tags": [
        "cells"
    ], 
    "importance": "High", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1660878", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1660878, 
    "index": 2029, 
    "openned": "2017-02-01 03:15:19.665803+00:00", 
    "created": "2017-02-01 03:15:19.665803+00:00", 
    "title": "test_reboot_deleted_server fails with 409 'Cannot 'reboot' instance while it is in vm_state building'", 
    "comments": [
        {
            "content": "http://logs.openstack.org/91/426991/1/check/gate-tempest-dsvm-neutron-full-ubuntu-xenial/f218227/console.html#_2017-02-01_02_06_33_592237\n\n2017-02-01 02:06:33.592237 | tempest.api.compute.servers.test_servers_negative.ServersNegativeTestJSON.test_reboot_deleted_server[id-581a397d-5eab-486f-9cf9-1014bbd4c984,negative]\n2017-02-01 02:06:33.592305 | ------------------------------------------------------------------------------------------------------------------------------------------------------\n2017-02-01 02:06:33.592321 | \n2017-02-01 02:06:33.592340 | Captured traceback:\n2017-02-01 02:06:33.592367 | ~~~~~~~~~~~~~~~~~~~\n2017-02-01 02:06:33.592398 |     Traceback (most recent call last):\n2017-02-01 02:06:33.592453 |       File \"tempest/api/compute/servers/test_servers_negative.py\", line 190, in test_reboot_deleted_server\n2017-02-01 02:06:33.593010 |         server['id'], type='SOFT')\n2017-02-01 02:06:33.593072 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 485, in assertRaises\n2017-02-01 02:06:33.593110 |         self.assertThat(our_callable, matcher)\n2017-02-01 02:06:33.593162 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 496, in assertThat\n2017-02-01 02:06:33.593205 |         mismatch_error = self._matchHelper(matchee, matcher, message, verbose)\n2017-02-01 02:06:33.593266 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 547, in _matchHelper\n2017-02-01 02:06:33.593294 |         mismatch = matcher.match(matchee)\n2017-02-01 02:06:33.593345 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/matchers/_exception.py\", line 108, in match\n2017-02-01 02:06:33.593388 |         mismatch = self.exception_matcher.match(exc_info)\n2017-02-01 02:06:33.593443 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/matchers/_higherorder.py\", line 62, in match\n2017-02-01 02:06:33.593468 |         mismatch = matcher.match(matchee)\n2017-02-01 02:06:33.593515 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 475, in match\n2017-02-01 02:06:33.593544 |         reraise(*matchee)\n2017-02-01 02:06:33.593597 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/matchers/_exception.py\", line 101, in match\n2017-02-01 02:06:33.593618 |         result = matchee()\n2017-02-01 02:06:33.593667 |       File \"/opt/stack/new/tempest/.tox/tempest/local/lib/python2.7/site-packages/testtools/testcase.py\", line 1049, in __call__\n2017-02-01 02:06:33.593699 |         return self._callable_object(*self._args, **self._kwargs)\n2017-02-01 02:06:33.593736 |       File \"tempest/lib/services/compute/servers_client.py\", line 236, in reboot_server\n2017-02-01 02:06:33.593777 |         return self.action(server_id, 'reboot', **kwargs)\n2017-02-01 02:06:33.593814 |       File \"tempest/lib/services/compute/servers_client.py\", line 186, in action\n2017-02-01 02:06:33.594170 |         post_body)\n2017-02-01 02:06:33.594219 |       File \"tempest/lib/common/rest_client.py\", line 275, in post\n2017-02-01 02:06:33.594261 |         return self.request('POST', url, extra_headers, headers, body, chunked)\n2017-02-01 02:06:33.594298 |       File \"tempest/lib/services/compute/base_compute_client.py\", line 48, in request\n2017-02-01 02:06:33.594328 |         method, url, extra_headers, headers, body, chunked)\n2017-02-01 02:06:33.594360 |       File \"tempest/lib/common/rest_client.py\", line 663, in request\n2017-02-01 02:06:33.594392 |         self._error_checker(resp, resp_body)\n2017-02-01 02:06:33.594449 |       File \"tempest/lib/common/rest_client.py\", line 775, in _error_checker\n2017-02-01 02:06:33.594496 |         raise exceptions.Conflict(resp_body, resp=resp)\n2017-02-01 02:06:33.594555 |     tempest.lib.exceptions.Conflict: An object with that identifier already exists\n2017-02-01 02:06:33.594641 |     Details: {u'code': 409, u'message': u\"Cannot 'reboot' instance d9978a80-0349-4cb8-84fa-46aa0b8eaa16 while it is in vm_state building\"}\n\nhttp://logs.openstack.org/91/426991/1/check/gate-tempest-dsvm-neutron-full-ubuntu-xenial/f218227/logs/screen-n-api.txt.gz#_2017-02-01_01_25_02_367\n\nThe test creates a server, then deletes the server and waits for it to be gone and then tries to reboot it and expects a 404 but gets a 409 because the instance is building.\n\nWe're probably hitting a window of time between when we have a build request and a real instance due to the recent change of moving instance creation from nova-api to nova-conductor.\n\nLooks like this started on 1/27:\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22Cannot%20'reboot'%20instance%5C%22%20AND%20message%3A%5C%22while%20it%20is%20in%20vm_state%20building%5C%22%20AND%20tags%3A%5C%22screen-n-api.txt%5C%22&from=7d\n\nWhich is when this merged: https://review.openstack.org/#/c/319379/", 
            "date_created": "2017-02-01 03:15:19.665803+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Looks like it's more than just that test:\n\nhttp://logs.openstack.org/48/426448/2/gate/gate-tempest-dsvm-neutron-full-ubuntu-xenial/ecb3d0a/console.html#_2017-01-31_14_47_05_827109\n\nDetails: {u'code': 409, u'message': u\"Cannot 'rebuild' instance b7279ba1-1847-4942-912c-d1f148f00ca3 while it is in vm_state building\"}", 
            "date_created": "2017-02-01 03:24:02.025358+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/427544", 
            "date_created": "2017-02-01 04:03:01.991955+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I have a debug patch up which shows that before we create the instance in conductor, the build request is already deleted:\n\nhttp://logs.openstack.org/44/427544/2/check/gate-tempest-dsvm-neutron-multinode-full-ubuntu-xenial-nv/f50a5ee/logs/screen-n-cond.txt#_2017-02-01_04_49_11_702", 
            "date_created": "2017-02-01 14:51:52.630490+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/427775", 
            "date_created": "2017-02-01 15:39:12.731568+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Matt Riedemann (<email address hidden>) on branch: master\nReview: https://review.openstack.org/427544\nReason: We have patches up for the real fix now.", 
            "date_created": "2017-02-01 20:09:02.317244+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/427782\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=466769e588dc44d11987430b54ca1bd7188abffb\nSubmitter: Jenkins\nBranch:    master\n\ncommit 466769e588dc44d11987430b54ca1bd7188abffb\nAuthor: Dan Smith <email address hidden>\nDate:   Wed Feb 1 07:58:25 2017 -0800\n\n    Remove pre-cellsv2 short circuit in instance get\n    \n    This removes a couple short circuits around instance cell mapping,\n    which were in place for pre-cellsv2 code. Now, they defeat some of\n    our atomic logic around what should be done in and around deletes.\n    These were TODOs to remove once people had to be on cellsv2, which\n    is now the case.\n    \n    Note that the api samples tests were depending on these in order to\n    work at all (which is a good demonstration of why they need to\n    be removed). This patch also extends the SingleCellSimple fixture\n    with a couple more mocks to make them happily take the same path\n    as the rest of the code. Since the default in that fixture is\n    now to make instances look mapped all the time, we also need a flag\n    so the tests that check for yet-to-be-mapped instances can still\n    function.\n    \n    Related-Bug: #1660878\n    Change-Id: I7eb4b41fd2f33e8a63e329adbafc47d149e31552\n", 
            "date_created": "2017-02-02 01:34:26.454614+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I'm still seeing a significant failure rate in the gate due to this bug over last 8 hours. Is there a reasonable chance https://review.openstack.org/#/c/427775/ would help?\n", 
            "date_created": "2017-02-02 10:31:33.156541+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-lewis"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/427775\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8ba92778fe14b47ad4ff5b53022e0550a93f37d3\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8ba92778fe14b47ad4ff5b53022e0550a93f37d3\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Feb 1 10:35:32 2017 -0500\n\n    Ensure build request exists before creating instance\n    \n    When creating instances in conductor, the build requests are\n    coming from the compute API and might be stale by the time\n    the instance is created, i.e. the build request might have\n    been deleted from the database before the instance is actually\n    created in a cell.\n    \n    This is trivial to recreate; all you need to do is create a\n    server and then immediately delete it, then try to perform\n    some kind of action on the server expecting it to be deleted\n    but the action might not return a 404 for a missing instance.\n    We're seeing this in Tempest runs where the expected 404 for\n    the deleted instance is a 409 because the test is trying to\n    perform an action on a server while it's building, which is\n    generally not allowed.\n    \n    This fixes the issue by making a last-second check to make\n    sure the build request still exists before the instance is\n    created in a cell.\n    \n    Change-Id: I6c32d5a4086a227d59ad7b1f6f50e7e532c74c84\n    Closes-Bug: #1660878\n", 
            "date_created": "2017-02-02 16:44:34.398497+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0rc1 release candidate.", 
            "date_created": "2017-02-03 19:08:13.349528+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-02-02 16:44:30.527411+00:00"
}