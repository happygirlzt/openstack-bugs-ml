{
    "status": "Fix Released", 
    "last_updated": "2016-11-17 13:14:43.645174+00:00", 
    "description": "Description\n===========\n\nCurrent nova api documentation states the following about disk=0 in flavor:\n\nThe size of the root disk that will be created in GiB. If 0 the\nroot disk will be set to exactly the size of the image used to\ndeploy the instance. [1]\n\nHowever scheduler does not check the actual image size during select destintation and also resource tracker does not calculate the used space properly.\n\n\n[1] https://github.com/openstack/nova/blob/master/api-ref/source/parameters.yaml#L1548-L1555 \n\n\nSteps to reproduce\n==================\n1. Create a sizeable image. e.g. 8GB\n+------------------+--------------------------------------+\n| Property         | Value                                |\n+------------------+--------------------------------------+\n| checksum         | bde0b00c072a8b5ab28ac58a3b8ea6ed     |\n| container_format | bare                                 |\n| created_at       | 2016-07-07T09:25:33Z                 |\n| disk_format      | qcow2                                |\n| id               | ea14a784-252a-4193-9129-a311f64c01f4 |\n| min_disk         | 0                                    |\n| min_ram          | 0                                    |\n| name             | my_image                             |\n| owner            | 0878b2a9a9fa4c538931df5d67708b51     |\n| protected        | False                                |\n| size             | 8591507456                           |\n| status           | active                               |\n| tags             | []                                   |\n| updated_at       | 2016-07-07T09:29:35Z                 |\n| virtual_size     | None                                 |\n| visibility       | private                              |\n+------------------+--------------------------------------+\n\n2. Check the current host-describe output to see the available and used space\nvagrant@controller:~$ nova host-describe controller\n+------------+----------------------------------+-----+-----------+---------+\n| HOST       | PROJECT                          | cpu | memory_mb | disk_gb |\n+------------+----------------------------------+-----+-----------+---------+\n| controller | (total)                          | 8   | 7794      | 39      |\n| controller | (used_now)                       | 0   | 512       | 0       |\n| controller | (used_max)                       | 0   | 64        | 0       |\n+------------+----------------------------------+-----+-----------+---------+\n\n3. boot a vm with a flavor disk=0\nvagrant@controller:/opt/stack/nova/nova/scheduler/filters$ nova flavor-list\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| 1  | m1.tiny   | 512       | 1    | 0         |      | 1     | 1.0         | True      |\n| 2  | m1.small  | 2048      | 20   | 0         |      | 1     | 1.0         | True      |\n| 3  | m1.medium | 4096      | 40   | 0         |      | 2     | 1.0         | True      |\n| 4  | m1.large  | 8192      | 80   | 0         |      | 4     | 1.0         | True      |\n| 42 | m1.nano   | 64        | 0    | 0         |      | 1     | 1.0         | True      |\n| 5  | m1.xlarge | 16384     | 160  | 0         |      | 8     | 1.0         | True      |\n| 84 | m1.micro  | 128       | 0    | 0         |      | 1     | 1.0         | True      |\n| c1 | cirros256 | 256       | 0    | 0         |      | 1     | 1.0         | True      |\n| d1 | ds512M    | 512       | 5    | 0         |      | 1     | 1.0         | True      |\n| d2 | ds1G      | 1024      | 10   | 0         |      | 1     | 1.0         | True      |\n| d3 | ds2G      | 2048      | 10   | 0         |      | 2     | 1.0         | True      |\n| d4 | ds4G      | 4096      | 20   | 0         |      | 4     | 1.0         | True      |\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\nvagrant@controller:~$ nova boot --image ea14a784-252a-4193-9129-a311f64c01f4 --flavor 42  vm2 --poll\n+--------------------------------------+-------------------------------------------------+\n| Property                             | Value                                           |\n+--------------------------------------+-------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                          |\n| OS-EXT-AZ:availability_zone          |                                                 |\n| OS-EXT-SRV-ATTR:host                 | -                                               |\n| OS-EXT-SRV-ATTR:hostname             | vm2                                             |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                               |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000002                               |\n| OS-EXT-SRV-ATTR:kernel_id            |                                                 |\n| OS-EXT-SRV-ATTR:launch_index         | 0                                               |\n| OS-EXT-SRV-ATTR:ramdisk_id           |                                                 |\n| OS-EXT-SRV-ATTR:reservation_id       | r-5c032r0o                                      |\n| OS-EXT-SRV-ATTR:root_device_name     | -                                               |\n| OS-EXT-SRV-ATTR:user_data            | -                                               |\n| OS-EXT-STS:power_state               | 0                                               |\n| OS-EXT-STS:task_state                | scheduling                                      |\n| OS-EXT-STS:vm_state                  | building                                        |\n| OS-SRV-USG:launched_at               | -                                               |\n| OS-SRV-USG:terminated_at             | -                                               |\n| accessIPv4                           |                                                 |\n| accessIPv6                           |                                                 |\n| adminPass                            | MmVFaJr7B5Rp                                    |\n| config_drive                         |                                                 |\n| created                              | 2016-07-07T09:32:14Z                            |\n| description                          | -                                               |\n| flavor                               | m1.nano (42)                                    |\n| hostId                               |                                                 |\n| host_status                          |                                                 |\n| id                                   | 16c2e302-62f9-4ce3-b603-e8c98115fd13            |\n| image                                | my_image (ea14a784-252a-4193-9129-a311f64c01f4) |\n| key_name                             | -                                               |\n| locked                               | False                                           |\n| metadata                             | {}                                              |\n| name                                 | vm2                                             |\n| os-extended-volumes:volumes_attached | []                                              |\n| progress                             | 0                                               |\n| security_groups                      | default                                         |\n| status                               | BUILD                                           |\n| tags                                 | []                                              |\n| tenant_id                            | 0878b2a9a9fa4c538931df5d67708b51                |\n| updated                              | 2016-07-07T09:32:14Z                            |\n| user_id                              | d2046b30b0e6459ebe02b67aba2b11d4                |\n+--------------------------------------+-------------------------------------------------+\n\nServer building... 0% complete\nServer building... 0% complete\nServer building... 100% complete\nFinished\nvagrant@controller:~$ \n\n4. Check the host-describe output again.\nvagrant@controller:~$ nova host-describe controller\n+------------+----------------------------------+-----+-----------+---------+\n| HOST       | PROJECT                          | cpu | memory_mb | disk_gb |\n+------------+----------------------------------+-----+-----------+---------+\n| controller | (total)                          | 8   | 7794      | 39      |\n| controller | (used_now)                       | 1   | 576       | 0       |\n| controller | (used_max)                       | 1   | 64        | 0       |\n| controller | 0878b2a9a9fa4c538931df5d67708b51 | 1   | 64        | 0       |\n+------------+----------------------------------+-----+-----------+---------+\n\nTo see the data used by the scheduler decision you shall add an extra log line to the disk_filter.py\n\nvagrant@controller:/opt/stack/nova$ git diff\ndiff --git a/nova/scheduler/filters/disk_filter.py b/nova/scheduler/filters/disk_filter.py\nindex 3476ace..d16dcbf 100644\n--- a/nova/scheduler/filters/disk_filter.py\n+++ b/nova/scheduler/filters/disk_filter.py\n@@ -37,6 +37,8 @@ class DiskFilter(filters.BaseHostFilter):\n                                   spec_obj.ephemeral_gb) +\n                           spec_obj.swap)\n \n+        LOG.error('requested_disk' + str(requested_disk))\n+\n         free_disk_mb = host_state.free_disk_mb\n         total_usable_disk_mb = host_state.total_usable_disk_gb * 1024\n \n\nThen in the scheduler log you will see that during the boot the requested_disk is 0 and not 8G as expected based on the documentation.\n\n2016-07-07 09:19:18.480 ERROR nova.scheduler.filters.disk_filter [req-c7410319-c65f-4274-88b8-a0c68e0bc7ff admin admin] requested_disk0\n\n\n\nExpected result\n===============\nThe documentation correctly states that disk=0 means that the scheduler will not select the host based on image size.\n\nEnvironment\n===========\nDevstack on master.\n\nvagrant@controller:/opt/stack/nova$ git log -1\ncommit 2d551ce83d186ad70ca69b1a6f9454906b4b3448\nMerge: 94c96f2 7451862\nAuthor: Jenkins <email address hidden>\nDate:   Mon Jul 4 15:40:25 2016 +0000\n\n    Merge \"Improve the help text for configdrive options\"", 
    "tags": [
        "doc"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1599787", 
    "owner": "https://api.launchpad.net/1.0/~balazs-gibizer", 
    "id": 1599787, 
    "index": 2039, 
    "openned": "2016-07-07 10:01:55.821911+00:00", 
    "created": "2016-07-07 10:01:55.821911+00:00", 
    "title": "The documentation of disk=0 in flavor is misleading", 
    "comments": [
        {
            "content": "Description\n===========\n\nCurrent nova api documentation states the following about disk=0 in flavor:\n\nThe size of the root disk that will be created in GiB. If 0 the\nroot disk will be set to exactly the size of the image used to\ndeploy the instance. [1]\n\nHowever scheduler does not check the actual image size during select destintation and also resource tracker does not calculate the used space properly.\n\n\n[1] https://github.com/openstack/nova/blob/master/api-ref/source/parameters.yaml#L1548-L1555 \n\n\nSteps to reproduce\n==================\n1. Create a sizeable image. e.g. 8GB\n+------------------+--------------------------------------+\n| Property         | Value                                |\n+------------------+--------------------------------------+\n| checksum         | bde0b00c072a8b5ab28ac58a3b8ea6ed     |\n| container_format | bare                                 |\n| created_at       | 2016-07-07T09:25:33Z                 |\n| disk_format      | qcow2                                |\n| id               | ea14a784-252a-4193-9129-a311f64c01f4 |\n| min_disk         | 0                                    |\n| min_ram          | 0                                    |\n| name             | my_image                             |\n| owner            | 0878b2a9a9fa4c538931df5d67708b51     |\n| protected        | False                                |\n| size             | 8591507456                           |\n| status           | active                               |\n| tags             | []                                   |\n| updated_at       | 2016-07-07T09:29:35Z                 |\n| virtual_size     | None                                 |\n| visibility       | private                              |\n+------------------+--------------------------------------+\n\n2. Check the current host-describe output to see the available and used space\nvagrant@controller:~$ nova host-describe controller\n+------------+----------------------------------+-----+-----------+---------+\n| HOST       | PROJECT                          | cpu | memory_mb | disk_gb |\n+------------+----------------------------------+-----+-----------+---------+\n| controller | (total)                          | 8   | 7794      | 39      |\n| controller | (used_now)                       | 0   | 512       | 0       |\n| controller | (used_max)                       | 0   | 64        | 0       |\n+------------+----------------------------------+-----+-----------+---------+\n\n3. boot a vm with a flavor disk=0\nvagrant@controller:/opt/stack/nova/nova/scheduler/filters$ nova flavor-list\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| 1  | m1.tiny   | 512       | 1    | 0         |      | 1     | 1.0         | True      |\n| 2  | m1.small  | 2048      | 20   | 0         |      | 1     | 1.0         | True      |\n| 3  | m1.medium | 4096      | 40   | 0         |      | 2     | 1.0         | True      |\n| 4  | m1.large  | 8192      | 80   | 0         |      | 4     | 1.0         | True      |\n| 42 | m1.nano   | 64        | 0    | 0         |      | 1     | 1.0         | True      |\n| 5  | m1.xlarge | 16384     | 160  | 0         |      | 8     | 1.0         | True      |\n| 84 | m1.micro  | 128       | 0    | 0         |      | 1     | 1.0         | True      |\n| c1 | cirros256 | 256       | 0    | 0         |      | 1     | 1.0         | True      |\n| d1 | ds512M    | 512       | 5    | 0         |      | 1     | 1.0         | True      |\n| d2 | ds1G      | 1024      | 10   | 0         |      | 1     | 1.0         | True      |\n| d3 | ds2G      | 2048      | 10   | 0         |      | 2     | 1.0         | True      |\n| d4 | ds4G      | 4096      | 20   | 0         |      | 4     | 1.0         | True      |\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\nvagrant@controller:~$ nova boot --image ea14a784-252a-4193-9129-a311f64c01f4 --flavor 42  vm2 --poll\n+--------------------------------------+-------------------------------------------------+\n| Property                             | Value                                           |\n+--------------------------------------+-------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                          |\n| OS-EXT-AZ:availability_zone          |                                                 |\n| OS-EXT-SRV-ATTR:host                 | -                                               |\n| OS-EXT-SRV-ATTR:hostname             | vm2                                             |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                               |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000002                               |\n| OS-EXT-SRV-ATTR:kernel_id            |                                                 |\n| OS-EXT-SRV-ATTR:launch_index         | 0                                               |\n| OS-EXT-SRV-ATTR:ramdisk_id           |                                                 |\n| OS-EXT-SRV-ATTR:reservation_id       | r-5c032r0o                                      |\n| OS-EXT-SRV-ATTR:root_device_name     | -                                               |\n| OS-EXT-SRV-ATTR:user_data            | -                                               |\n| OS-EXT-STS:power_state               | 0                                               |\n| OS-EXT-STS:task_state                | scheduling                                      |\n| OS-EXT-STS:vm_state                  | building                                        |\n| OS-SRV-USG:launched_at               | -                                               |\n| OS-SRV-USG:terminated_at             | -                                               |\n| accessIPv4                           |                                                 |\n| accessIPv6                           |                                                 |\n| adminPass                            | MmVFaJr7B5Rp                                    |\n| config_drive                         |                                                 |\n| created                              | 2016-07-07T09:32:14Z                            |\n| description                          | -                                               |\n| flavor                               | m1.nano (42)                                    |\n| hostId                               |                                                 |\n| host_status                          |                                                 |\n| id                                   | 16c2e302-62f9-4ce3-b603-e8c98115fd13            |\n| image                                | my_image (ea14a784-252a-4193-9129-a311f64c01f4) |\n| key_name                             | -                                               |\n| locked                               | False                                           |\n| metadata                             | {}                                              |\n| name                                 | vm2                                             |\n| os-extended-volumes:volumes_attached | []                                              |\n| progress                             | 0                                               |\n| security_groups                      | default                                         |\n| status                               | BUILD                                           |\n| tags                                 | []                                              |\n| tenant_id                            | 0878b2a9a9fa4c538931df5d67708b51                |\n| updated                              | 2016-07-07T09:32:14Z                            |\n| user_id                              | d2046b30b0e6459ebe02b67aba2b11d4                |\n+--------------------------------------+-------------------------------------------------+\n\nServer building... 0% complete\nServer building... 0% complete\nServer building... 100% complete\nFinished\nvagrant@controller:~$ \n\n4. Check the host-describe output again.\nvagrant@controller:~$ nova host-describe controller\n+------------+----------------------------------+-----+-----------+---------+\n| HOST       | PROJECT                          | cpu | memory_mb | disk_gb |\n+------------+----------------------------------+-----+-----------+---------+\n| controller | (total)                          | 8   | 7794      | 39      |\n| controller | (used_now)                       | 1   | 576       | 0       |\n| controller | (used_max)                       | 1   | 64        | 0       |\n| controller | 0878b2a9a9fa4c538931df5d67708b51 | 1   | 64        | 0       |\n+------------+----------------------------------+-----+-----------+---------+\n\nTo see the data used by the scheduler decision you shall add an extra log line to the disk_filter.py\n\nvagrant@controller:/opt/stack/nova$ git diff\ndiff --git a/nova/scheduler/filters/disk_filter.py b/nova/scheduler/filters/disk_filter.py\nindex 3476ace..d16dcbf 100644\n--- a/nova/scheduler/filters/disk_filter.py\n+++ b/nova/scheduler/filters/disk_filter.py\n@@ -37,6 +37,8 @@ class DiskFilter(filters.BaseHostFilter):\n                                   spec_obj.ephemeral_gb) +\n                           spec_obj.swap)\n \n+        LOG.error('requested_disk' + str(requested_disk))\n+\n         free_disk_mb = host_state.free_disk_mb\n         total_usable_disk_mb = host_state.total_usable_disk_gb * 1024\n \n\nThen in the scheduler log you will see that during the boot the requested_disk is 0 and not 8G as expected based on the documentation.\n\n2016-07-07 09:19:18.480 ERROR nova.scheduler.filters.disk_filter [req-c7410319-c65f-4274-88b8-a0c68e0bc7ff admin admin] requested_disk0\n\n\n\nExpected result\n===============\nThe documentation correctly states that disk=0 means that the scheduler will not select the host based on image size.\n\nEnvironment\n===========\nDevstack on master.\n\nvagrant@controller:/opt/stack/nova$ git log -1\ncommit 2d551ce83d186ad70ca69b1a6f9454906b4b3448\nMerge: 94c96f2 7451862\nAuthor: Jenkins <email address hidden>\nDate:   Mon Jul 4 15:40:25 2016 +0000\n\n    Merge \"Improve the help text for configdrive options\"", 
            "date_created": "2016-07-07 10:01:55.821911+00:00", 
            "author": "https://api.launchpad.net/1.0/~balazs-gibizer"
        }, 
        {
            "content": "Hmm, so disk=0 should only be used for testing really.\n\nMaybe thats what the documentation should be updated to say?\n\nThe fact the resource tracker doesn't report correctly is a separate bug that should be fixed. I don't think it totally makes sense to fix up the scheduler in this case.", 
            "date_created": "2016-07-07 13:18:28.709610+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "It seems that disk=0 is needed for volume booted VM. ", 
            "date_created": "2016-07-07 14:22:01.509012+00:00", 
            "author": "https://api.launchpad.net/1.0/~balazs-gibizer"
        }, 
        {
            "content": "Fix proposed in https://review.openstack.org/#/c/339034", 
            "date_created": "2016-07-07 14:39:04.951386+00:00", 
            "author": "https://api.launchpad.net/1.0/~balazs-gibizer"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/339034\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=9d08e805a8889d84ff1076da2373c37057670f23\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9d08e805a8889d84ff1076da2373c37057670f23\nAuthor: Balazs Gibizer <email address hidden>\nDate:   Thu Jul 7 16:28:10 2016 +0200\n\n    doc: fix disk=0 use case in flavor doc\n    \n    The 0 value of the disk parameter of the flavor is only meaningfull\n    if the instance is booted from volume as in any other case the\n    instance will use local disk and the scheduler will not be\n    able to select the hosts based on the real image size as that\n    information is not available for the scheduler.\n    \n    Change-Id: I6b3ba2fb323341071eae6b9e9f54ef833fdbaff7\n    Closes-Bug: #1599787\n    DocImpact: admin guide\n", 
            "date_created": "2016-09-19 16:38:20.598131+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b1 development milestone.", 
            "date_created": "2016-11-17 13:14:42.987568+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-09-19 16:38:11.002204+00:00"
}