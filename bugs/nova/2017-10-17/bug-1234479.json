{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 15:10:14.382692+00:00", 
    "description": "baremetal nodes are failing to boot for me:\n\n2013-10-03 01:55:15,392.392 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpMxP1Xr power on execute /opt/stack/venvs/nova/local/lib/pyt\nhon2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:15,573.573 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power Control: Up/On\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:15,707.707 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpRYI8dn power status execute /opt/stack/venvs/nova/local/lib\n/python2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:15,890.890 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power is off\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n\n\nNote the gap between up and status checking is only 200ms (from IPMI return to status check) but in that interval this hardware doesn't toggle to on.\n\nAfter the deploy fails, a manual check with\nipmitool -I lanplus -H 10.10.16.40 -U Administrator -P <password> chassis power status\nreturns\nChassis Power is on", 
    "tags": [
        "baremetal"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1234479", 
    "owner": "https://api.launchpad.net/1.0/~jogo", 
    "id": 1234479, 
    "index": 1261, 
    "openned": "2013-10-03 02:02:44.931376+00:00", 
    "created": "2013-10-03 02:02:44.931376+00:00", 
    "title": "ipmi power probing is too fast", 
    "comments": [
        {
            "content": "baremetal nodes are failing to boot for me:\n\n2013-10-03 01:55:15,392.392 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpMxP1Xr power on execute /opt/stack/venvs/nova/local/lib/pyt\nhon2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:15,573.573 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power Control: Up/On\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:15,707.707 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpRYI8dn power status execute /opt/stack/venvs/nova/local/lib\n/python2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:15,890.890 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power is off\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n\n\nNote the gap between up and status checking is only 200ms (from IPMI return to status check) but in that interval this hardware doesn't toggle to on.\n\nAfter the deploy fails, a manual check with\nipmitool -I lanplus -H 10.10.16.40 -U Administrator -P <password> chassis power status\nreturns\nChassis Power is on", 
            "date_created": "2013-10-03 02:02:44.931376+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Full trace:\n2013-10-03 01:55:15,114.114 7354 DEBUG nova.openstack.common.rpc.amqp [-] UNIQUE_ID is 165698139cd7474598b27a01932974c4. _add_unique_id /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/openstack/common/rpc/amqp.py:\n341\n2013-10-03 01:55:15,207.207 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmppgqG40 power status execute /opt/stack/venvs/nova/local/lib\n/python2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:15,391.391 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power is off\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:15,392.392 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpMxP1Xr power on execute /opt/stack/venvs/nova/local/lib/pyt\nhon2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:15,573.573 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power Control: Up/On\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:15,707.707 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpRYI8dn power status execute /opt/stack/venvs/nova/local/lib\n/python2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:15,890.890 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power is off\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:15,891.891 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmp6FRuex power on execute /opt/stack/venvs/nova/local/lib/pyt\nhon2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:16,069.069 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power Control: Up/On\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:16,207.207 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmp5k3q5r power status execute /opt/stack/venvs/nova/local/lib\n/python2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:16,432.432 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power is off\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:16,433.433 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpFCSyJk power on execute /opt/stack/venvs/nova/local/lib/pyt\nhon2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:16,613.613 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power Control: Up/On\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:16,707.707 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpiGxWbD power status execute /opt/stack/venvs/nova/local/lib\n/python2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:16,891.891 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power is off\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:16,891.891 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpOJV5MU power on execute /opt/stack/venvs/nova/local/lib/pyt\nhon2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:17,068.068 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power Control: Up/On\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:17,207.207 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpio9Q9V power status execute /opt/stack/venvs/nova/local/lib\n/python2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:17,390.390 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power is off\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:17,391.391 7354 ERROR nova.virt.baremetal.ipmi [-] IPMI power on failed after 5 tries\n2013-10-03 01:55:17,392.392 7354 ERROR nova.virt.baremetal.driver [req-5e2f8022-bc85-49bc-8730-b2f0f61df705 2de96ce5da994575a08447c93bcafd53 4956c533154c476799c688eda7ed65ab] Error deploying instance f88aae15-5e0e-4ede-92a7-a6\n782d6950bd on baremetal node f6c8dc91-da4a-4771-bed6-2849a6a94726.\n2013-10-03 01:55:17,440.440 7354 DEBUG nova.openstack.common.processutils [-] Running cmd (subprocess): ipmitool -I lanplus -H 10.10.16.27 -U Administrator -f /tmp/tmpbUahdy power status execute /opt/stack/venvs/nova/local/lib\n/python2.7/site-packages/nova/openstack/common/processutils.py:147\n2013-10-03 01:55:17,640.640 7354 DEBUG nova.virt.baremetal.ipmi [-] ipmitool stdout: 'Chassis Power is off\n', stderr: '' _exec_ipmitool /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/ipmi.py:136\n2013-10-03 01:55:17,872.872 7354 DEBUG nova.virt.baremetal.vif_driver [req-5e2f8022-bc85-49bc-8730-b2f0f61df705 2de96ce5da994575a08447c93bcafd53 4956c533154c476799c688eda7ed65ab] ", 
            "date_created": "2013-10-03 02:09:05.295117+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Here is the (abbreviated) code in nova/virt/baremetal/ipmi.py:\n\n141     def _power_on(self):\n144         def _wait_for_power_on():\n147             if self.is_power_on():\n148                 self.state = baremetal_states.ACTIVE\n149                 raise loopingcall.LoopingCallDone()\n...\n155             try:\n156                 self.retries += 1\n157                 self._exec_ipmitool(\"power on\")\n...\n162         timer = loopingcall.FixedIntervalLoopingCall(_wait_for_power_on)\n163         timer.start(interval=0.5).wait()\n\nI'm wondering whether FixedIntervalLoopingCall is able to do sub-second timing. Perhaps changing the interval to 1 would alleviate this issue.", 
            "date_created": "2013-10-03 03:46:09.996581+00:00", 
            "author": "https://api.launchpad.net/1.0/~devananda"
        }, 
        {
            "content": "So the 0.2 second difference is another issue.\n\nthe _wait_for_power_on call, which is called in a loop.  Checks if the power is on each time.  And if not re-issues a power on command (https://github.com/openstack/nova/blob/master/nova/virt/baremetal/ipmi.py#L157).   So you need to measure the time between power on calls not between power status and power on.  It turns out that the difference is a bout 0.5 seconds if not longer.\n\n I don't know enough about IPMI to say what happens when we keep issuing 'ipmi power on every 0.5 seconds' but that *may* not be good?\n\nAlso I don't know what the average time for IPMI to respond is, but I think slowing down the polling interval to 1 second can't hurt.  Also we may want to bump up the default value for CONF.baremetal.ipmi_power_retry", 
            "date_created": "2013-10-03 23:44:43.565531+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "After some testing it looks like ipmi doesn't like being bombarded with 'power on/off' every 0.5 seconds.\n\nIt looks like power on takes <0.5 seconds and power off takes around 4 seconds so I propose a multi prong fix: \n\n* move power on/off to befor the loop\n* bump interval to 1 second and loop for 10 seconds, as why not play things a little safer (for the 4 second power off especially).\n", 
            "date_created": "2013-10-04 00:36:46.854418+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/49658", 
            "date_created": "2013-10-04 00:52:59.362950+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I think power on and off can both be slow - my log shows 5+seconds for\npower on; agree on the changes.\n\nOn 4 October 2013 13:36, Joe Gordon <email address hidden> wrote:\n> After some testing it looks like ipmi doesn't like being bombarded with\n> 'power on/off' every 0.5 seconds.\n>\n> It looks like power on takes <0.5 seconds and power off takes around 4\n> seconds so I propose a multi prong fix:\n>\n> * move power on/off to befor the loop\n> * bump interval to 1 second and loop for 10 seconds, as why not play things a little safer (for the 4 second power off especially).\n>\n>\n> ** Changed in: nova\n>      Assignee: (unassigned) => Joe Gordon (jogo)\n>\n> --\n> You received this bug notification because you are subscribed to the bug\n> report.\n> https://bugs.launchpad.net/bugs/1234479\n>\n> Title:\n>   ipmi power probing is too fast\n>\n> To manage notifications about this bug go to:\n> https://bugs.launchpad.net/ironic/+bug/1234479/+subscriptions\n\n\n\n-- \nRobert Collins <email address hidden>\nDistinguished Technologist\nHP Converged Cloud\n", 
            "date_created": "2013-10-04 00:50:41+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/49658\nCommitted: http://github.com/openstack/nova/commit/6e30bbc126a1ad4eb87e735c812832f4fcc0054e\nSubmitter: Jenkins\nBranch:    master\n\ncommit 6e30bbc126a1ad4eb87e735c812832f4fcc0054e\nAuthor: Joe Gordon <email address hidden>\nDate:   Thu Oct 3 17:48:13 2013 -0700\n\n    Baremetal: Be more patient with IPMI and BMC\n    \n    Before we called 'power status; power on' in a loop which made the\n    IPMI/BMCs not behave well.  Also the total time we would wait (2.5\n    seconds wasn't always enough).  So make sure power on/off is only called\n    once and wait up to 10 seconds for the power state change to go into\n    effect.\n    \n    This patch has been tested on real baremetal using\n    https://wiki.openstack.org/wiki/TripleO/TripleOCloud\n    \n    This bug is also linked to ironic so the change will be made there as\n    well.\n    \n    Change-Id: I5a4d7c84ebdf9c1f7d8d0570dbc31764c31f1fc6\n    Closes-Bug: #1234479\n", 
            "date_created": "2013-10-07 23:08:20.067272+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: milestone-proposed\nReview: https://review.openstack.org/50935", 
            "date_created": "2013-10-10 14:21:22.497440+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/50935\nCommitted: http://github.com/openstack/nova/commit/c965c2b590a877994604d9163cd52446e0bd4c8a\nSubmitter: Jenkins\nBranch:    milestone-proposed\n\ncommit c965c2b590a877994604d9163cd52446e0bd4c8a\nAuthor: Joe Gordon <email address hidden>\nDate:   Thu Oct 3 17:48:13 2013 -0700\n\n    Baremetal: Be more patient with IPMI and BMC\n    \n    Before we called 'power status; power on' in a loop which made the\n    IPMI/BMCs not behave well.  Also the total time we would wait (2.5\n    seconds wasn't always enough).  So make sure power on/off is only called\n    once and wait up to 10 seconds for the power state change to go into\n    effect.\n    \n    This patch has been tested on real baremetal using\n    https://wiki.openstack.org/wiki/TripleO/TripleOCloud\n    \n    This bug is also linked to ironic so the change will be made there as\n    well.\n    \n    Change-Id: I5a4d7c84ebdf9c1f7d8d0570dbc31764c31f1fc6\n    Closes-Bug: #1234479\n    (cherry picked from commit 6e30bbc126a1ad4eb87e735c812832f4fcc0054e)\n", 
            "date_created": "2013-10-10 21:03:37.817369+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This bug also affects ironic/drivers/modules/ipmitool.py. The port should be fairly straight forward as the code is only slightly modified from Nova's baremetal ipmi driver.", 
            "date_created": "2013-10-17 19:38:30.602525+00:00", 
            "author": "https://api.launchpad.net/1.0/~devananda"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/52492", 
            "date_created": "2013-10-17 19:49:09.425221+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/52492\nCommitted: http://github.com/openstack/ironic/commit/d5c72d122504a8d6684c9d464c1b7e3d3b4a192d\nSubmitter: Jenkins\nBranch:    master\n\ncommit d5c72d122504a8d6684c9d464c1b7e3d3b4a192d\nAuthor: Devananda van der Veen <email address hidden>\nDate:   Thu Oct 17 12:45:55 2013 -0700\n\n    Be more patient with IPMI and BMC\n    \n    Before the ipmitool driver called 'power status; power on' in a loop\n    which made the IPMI/BMCs not behave well.  Also the total time we would\n    wait (5 seconds) wasn't always enough.  So make sure power on/off is\n    only called once and wait up to 10 seconds for the power state change to\n    go into effect.\n    \n    This is a port of change-id I5a4d7c84ebdf9c1f7d8d0570dbc31764c31f1fc6\n    \n    Change-Id: I50982b24e5443b34d5597581ea2947a0301d35c9\n    Closes-Bug: #1234479\n", 
            "date_created": "2013-10-22 17:25:29.923948+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-10-10 21:03:34.941235+00:00"
}