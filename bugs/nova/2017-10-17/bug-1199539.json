{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:51:06.802259+00:00", 
    "description": "When booting from volume via Horizon webui, the block device mapping that is passed down to nova contains \"volume_size\": \"\", which causes a DB integrity error later:\n\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack Traceback (most recent call last):\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/api/openstack/__init__.py\", line 81, in __call__\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     return req.get_response(self.application)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/webob/request.py\", line 1296, in send\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     application, catch_exc_info=False)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/webob/request.py\", line 1260, in call_application\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/keystoneclient/middleware/auth_token.py\", line 457, in __call__\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     return self.app(env, start_response)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/routes/middleware.py\", line 131, in __call__\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/webob/dec.py\", line 144, in __call__\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/webob/dec.py\", line 130, in __call__\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/webob/dec.py\", line 195, in call_func\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/api/openstack/wsgi.py\", line 890, in __call__\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     content_type, body, accept)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/api/openstack/wsgi.py\", line 942, in _process_stack\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     action_result = self.dispatch(meth, request, action_args)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/api/openstack/wsgi.py\", line 1022, in dispatch\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     return method(req=request, **action_args)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/api/openstack/compute/servers.py\", line 898, in create\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     scheduler_hints=scheduler_hints)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/hooks.py\", line 85, in inner\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     rv = f(*args, **kwargs)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/compute/api.py\", line 961, in create\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     scheduler_hints=scheduler_hints)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/compute/api.py\", line 675, in _create_instance\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     reservation_id, scheduler_hints)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/compute/api.py\", line 633, in _validate_and_provision_instance\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     QUOTAS.rollback(context, quota_reservations)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     self.gen.next()\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/compute/api.py\", line 615, in _validate_and_provision_instance\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     num_instances, i)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/compute/api.py\", line 910, in create_db_entry_for_new_instance\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     instance_type, image, block_device_mapping)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/compute/api.py\", line 806, in _populate_instance_for_bdm\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     instance_type, instance_uuid, mapping)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/compute/api.py\", line 772, in _update_block_device_mapping\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     values)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/db/api.py\", line 1032, in block_device_mapping_update_or_create\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     return IMPL.block_device_mapping_update_or_create(context, values)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/db/sqlalchemy/api.py\", line 113, in wrapper\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     return f(*args, **kwargs)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/db/sqlalchemy/api.py\", line 2962, in block_device_mapping_update_or_create\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     bdm_ref.save(session=session)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/openstack/common/db/sqlalchemy/models.py\", line 54, in save\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     session.flush()\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack   File \"/usr/lib64/python2.6/site-packages/nova/openstack/common/db/sqlalchemy/session.py\", line 437, in _wrap\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack     raise exception.DBError(e)\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack DBError: (DataError) invalid input syntax for integer: \"\"\n2013-07-10 12:54:03.089 4920 TRACE nova.api.openstack LINE 1: ...LL, NULL, '6d6ad4f0-2ce9-49ab-a94f-71fc1b74ec7f', '', NULL, ...\n\n\n\nthe volume_size parameter should be validated to be usefol. for compatibility, the empty volume_size parameter should be ignored, as in the case of boot from volume it is not used anyway.", 
    "tags": [
        "db", 
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1199539", 
    "owner": "https://api.launchpad.net/1.0/~dripton", 
    "id": 1199539, 
    "index": 5095, 
    "openned": "2013-07-09 22:03:04.920952+00:00", 
    "created": "2013-07-09 22:03:04.920952+00:00", 
    "title": "Nova fails to boot from volume", 
    "comments": [
        {
            "content": "When booting from volume via Horizon webui, the block device mapping that is passed down to nova contains \"volume_size\": \"\", which causes a DB integrity error later: \n\n2013-07-04 13:01:03.098 4581 TRACE nova.api.openstack     raise\nexception.DBError(e)\n2013-07-04 13:01:03.098 4581 TRACE nova.api.openstack DBError: (DataError)\ninvalid input syntax for integer: \"\"\n2013-07-04 13:01:03.098 4581 TRACE nova.api.openstack LINE 1: ...LL, NULL,\n'13317d0d-381d-4a32-af2a-b0764b7569a2', '', NULL, ...\n2013-07-04 13:01:03.098 4581 TRACE nova.api.openstack                          \n                 ^\n2013-07-04 13:01:03.098 4581 TRACE nova.api.openstack  'INSERT INTO\nblock_device_mapping (created_at, updated_at, deleted_at, deleted,\ninstance_uuid, device_name, delete_on_termination, virtual_name, snapshot_id,\nvolume_id, volume_size, no_device, connection_info) VALUES (%(created_at)s,\n%(updated_at)s, %(deleted_at)s, %(deleted)s, %(instance_uuid)s,\n%(device_name)s, %(delete_on_termination)s, %(virtual_name)s, %(snapshot_id)s,\n%(volume_id)s, %(volume_size)s, %(no_device)s, %(connection_info)s) RETURNING\nblock_device_mapping.id' {'instance_uuid':\n'd5d2b657-33cd-4b71-8d05-753c1f55bfdb', 'virtual_name': None,\n'delete_on_termination': False, 'no_device': None, 'deleted': 0, 'created_at':\ndatetime.datetime(2013, 7, 4, 13, 1, 3, 76958), 'volume_id':\nu'13317d0d-381d-4a32-af2a-b0764b7569a2', 'updated_at': None, 'device_name':\nu'vda', 'connection_info': None, 'snapshot_id': None, 'deleted_at': None,\n'volume_size': u''}\n2013-07-04 13:01:03.098 4581 TRACE nova.api.openstack\n\n\nthe volume_size parameter should be validated to be usefol. for compatibility, the empty volume_size parameter should be ignored, as in the case of boot from volume it is not used anyway.", 
            "date_created": "2013-07-09 22:03:04.920952+00:00", 
            "author": "https://api.launchpad.net/1.0/~dmllr"
        }, 
        {
            "content": "I'm not sure if this should be routed to Horizon to validate this or as something to validate in the API, but it is failing on bad data, so to fix, just don't use the bad data (which is one way to resolve this bug).  The thing about this is I'm not sure what precedent there is for validating user input on data types in the UI (or via CLI to the APIs for that matter).", 
            "date_created": "2013-07-14 19:43:42.710503+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I sent a note to the developer mailing list to get some opinions on how to handle this.", 
            "date_created": "2013-07-14 19:47:48.284811+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This should absolutely be caught before it raises a database error. A useful, human-friendly error message should be returned via the API. Obviously anything using the API (such as Horizon) should do its best to pre-validate the input, but if invalid input is sent it should be handled well. The best way to let Horizon devs know what the problem is is for the API to return an intelligent failure.", 
            "date_created": "2013-07-15 03:25:27.073328+00:00", 
            "author": "https://api.launchpad.net/1.0/~gabriel-hurley"
        }, 
        {
            "content": "It is not an error in Horizon, Horizon is just triggering the problem by using Novaclient. In the case of Boot from Volume the Volume Size is not used (it is by definition the size of the volume), so Horizon is correct in not passing it down Novaclient. \n\nhttps://review.openstack.org/#/c/34769/\n\nhttps://review.openstack.org/#/c/34749/\n\n\n", 
            "date_created": "2013-07-15 07:44:16.157009+00:00", 
            "author": "https://api.launchpad.net/1.0/~dmllr"
        }, 
        {
            "content": "Is this actually a novaclient problem, or is it a nova problem? I've seen these kinds of issues before when we make assumptions about how mysql does type conversions.", 
            "date_created": "2013-07-15 12:00:54.846873+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "The server-side error is #1171190, which I fixed in 188a94c898bcf0, which was merged to Havana mainline on May 10.  I think it was only a problem in PostgreSQL, which is more strongly typed than MySQL or SQLite.\n\nSo I think this is a duplicate.", 
            "date_created": "2013-07-16 18:23:52.424972+00:00", 
            "author": "https://api.launchpad.net/1.0/~dripton"
        }, 
        {
            "content": "I don't think we need to fix anything in novaclient for this.  The bug was on the server side.", 
            "date_created": "2013-07-16 18:25:47.757541+00:00", 
            "author": "https://api.launchpad.net/1.0/~dripton"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/34749\nCommitted: http://github.com/openstack/nova/commit/3ff667620c2d735536b26c024691dfb9193975a2\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3ff667620c2d735536b26c024691dfb9193975a2\nAuthor: Dirk Mueller <email address hidden>\nDate:   Thu Jun 27 17:23:41 2013 +0200\n\n    Validate volume_size in block_device_mapping\n    \n    Reject invalid values for volume_size upfront.\n    For compatibility with old python-novaclient, an\n    empty volume_size is ignored.\n    \n    Create a common _validate_int_value() function for\n    validating that a parameter is an integer in a given\n    range. Use it also for min_count/max_count to share code.\n    \n    Fixes LP Bug#1199539\n    \n    Change-Id: I18ac285d5b3c8200d7706c7d577809b15d6ab9e8\n", 
            "date_created": "2013-07-17 01:27:53.253915+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/34769\nCommitted: http://github.com/openstack/python-novaclient/commit/f50ff361e27a8ca688c0f1ba448bbc8bfb284905\nSubmitter: Jenkins\nBranch:    master\n\ncommit f50ff361e27a8ca688c0f1ba448bbc8bfb284905\nAuthor: Dirk Mueller <email address hidden>\nDate:   Thu Jun 27 19:13:01 2013 +0200\n\n    Skip setting volume_size if not given\n    \n    When the block-device parameters skip volume_size,\n    don't set it. Setting to an empty volume_size\n    would be invalid as it has to be an integer,\n    and Nova API will reject the request if api validation\n    is implemented. (proposed e.g. at\n    https://review.openstack.org/#/c/34749/)\n    \n    Fixes bug LP #1199539\n    \n    Change-Id: I7ab518886abf8d449caf1c70563a79a990d7765e\n", 
            "date_created": "2013-07-23 01:01:38.723191+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-07-17 12:25:37.974185+00:00"
}