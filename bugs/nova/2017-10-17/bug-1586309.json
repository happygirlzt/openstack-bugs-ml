{
    "status": "Fix Released", 
    "last_updated": "2016-10-07 09:55:20.121060+00:00", 
    "description": "Environment\n===========\nstable/mitaka\n\nSteps to reproduce\n==================\n* I did boot a instance in compute node of SBCJSlot5Rack2Centos7, instance uuid was 00bc72d0-0778-4e69-bfee-b58b87dd1532.\n* Then I did resize this instance, resize failed on finish_resize function on destination compute node SBCJSlot3Rack2Centos7.\n\n[stack@SBCJSlot5Rack2Centos7 ~]$ openstack server show 00bc72d0-0778-4e69-bfee-b58b87dd1532.\n+--------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+\n| Field                                | Value                                                                                                                                  |\n+--------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+\n| OS-DCF:diskConfig                    | AUTO                                                                                                                                   |\n| OS-EXT-AZ:availability_zone          | nova                                                                                                                                   |\n| OS-EXT-SRV-ATTR:host                 | SBCJSlot3Rack2Centos7                                                                                                                  |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | SBCJSlot3Rack2Centos7                                                                                                                  |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000014                                                                                                                      |\n| OS-EXT-STS:power_state               | 1                                                                                                                                      |\n| OS-EXT-STS:task_state                | None                                                                                                                                   |\n| OS-EXT-STS:vm_state                  | error                                                                                                                                  |\n| OS-SRV-USG:launched_at               | 2016-05-27T02:28:07.000000                                                                                                             |\n| OS-SRV-USG:terminated_at             | None                                                                                                                                   |\n| accessIPv4                           |                                                                                                                                        |\n| accessIPv6                           |                                                                                                                                        |\n| addresses                            | public=2001:db8::6, 10.43.239.76                                                                                                       |\n| config_drive                         | True                                                                                                                                   |\n| created                              | 2016-05-27T02:27:56Z                                                                                                                   |\n| fault                                | {u'message': u'Unexpected vif_type=binding_failed', u'code': 500, u'details': u'  File \"/opt/stack/nova/nova/compute/manager.py\", line |\n|                                      | 375, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n  File \"/opt/stack/nova/nova/compute/manager.py\",     |\n|                                      | line 4054, in finish_resize\\n    self._set_instance_obj_error_state(context, instance)\\n  File \"/usr/lib/python2.7/site-               |\n|                                      | packages/oslo_utils/excutils.py\", line 220, in __exit__\\n    self.force_reraise()\\n  File \"/usr/lib/python2.7/site-                    |\n|                                      | packages/oslo_utils/excutils.py\", line 196, in force_reraise\\n    six.reraise(self.type_, self.value, self.tb)\\n  File                 |\n|                                      | \"/opt/stack/nova/nova/compute/manager.py\", line 4042, in finish_resize\\n    disk_info, image_meta)\\n  File                             |\n|                                      | \"/opt/stack/nova/nova/compute/manager.py\", line 4007, in _finish_resize\\n    old_instance_type)\\n  File \"/usr/lib/python2.7/site-      |\n|                                      | packages/oslo_utils/excutils.py\", line 220, in __exit__\\n    self.force_reraise()\\n  File \"/usr/lib/python2.7/site-                    |\n|                                      | packages/oslo_utils/excutils.py\", line 196, in force_reraise\\n    six.reraise(self.type_, self.value, self.tb)\\n  File                 |\n|                                      | \"/opt/stack/nova/nova/compute/manager.py\", line 4002, in _finish_resize\\n    block_device_info, power_on)\\n  File                      |\n|                                      | \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 7405, in finish_migration\\n    write_to_disk=True)\\n  File                         |\n|                                      | \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4718, in _get_guest_xml\\n    context)\\n  File                                      |\n|                                      | \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4584, in _get_guest_config\\n    flavor, virt_type, self._host)\\n  File             |\n|                                      | \"/opt/stack/nova/nova/virt/libvirt/vif.py\", line 447, in get_config\\n    _(\"Unexpected vif_type=%s\") % vif_type)\\n', u'created':       |\n|                                      | u'2016-05-27T03:17:57Z'}                                                                                                               |\n| flavor                               | m1.tiny (1)                                                                                                                            |\n| hostId                               | 7642c4dc55a8bc40c8a0fe2197a1b5333e5d0f028119be752c4098a0                                                                               |\n| id                                   | 00bc72d0-0778-4e69-bfee-b58b87dd1532                                                                                                   |\n| image                                | cirros-0.3.4-x86_64-uec (f19c4e53-d6f6-43bb-b983-b77b0c68f509)                                                                         |\n| key_name                             | None                                                                                                                                   |\n| name                                 | hanrong_az                                                                                                                             |\n| os-extended-volumes:volumes_attached | []                                                                                                                                     |\n| project_id                           | 4d6e4e79ea1f4ec392475308e11a895d                                                                                                       |\n| properties                           |                                                                                                                                        |\n| security_groups                      | [{u'name': u'default'}]                                                                                                                |\n| status                               | ERROR                                                                                                                                  |\n| updated                              | 2016-05-27T03:17:57Z                                                                                                                   |\n| user_id                              | 2903b30f6d9f4c4eb99421e3b4e51796                                                                                                       |\n+--------------------------------------+-------------------------------------------------------------------\n\nMariaDB [nova]> select source_compute,source_compute,status,instance_uuid,instance_uuid from migrations where instance_uuid='00bc72d0-0778-4e69-bfee-b58b87dd1532';\n+-----------------------+-----------------------+--------+--------------------------------------+--------------------------------------+\n| source_compute        | source_compute        | status | instance_uuid                        | instance_uuid                        |\n+-----------------------+-----------------------+--------+--------------------------------------+--------------------------------------+\n| SBCJSlot5Rack2Centos7 | SBCJSlot5Rack2Centos7 | error  | 00bc72d0-0778-4e69-bfee-b58b87dd1532 | 00bc72d0-0778-4e69-bfee-b58b87dd1532 |\n+-----------------------+-----------------------+--------+--------------------------------------+--------------------------------------\n\n* then I did delete this instance successfully. But the instance's data is not cleared on source compute node.\n[stack@SBCJSlot5Rack2Centos7 instances]$ ll\ndrwxrwxr-x 2 stack libvirtd 4096 May 27 10:27 00bc72d0-0778-4e69-bfee-b58b87dd1532_resize\n\n[stack@SBCJSlot5Rack2Centos7 instances]$ sudo virsh list --all\n Id    Name                           State\n----------------------------------------------------\n -     instance-00000014              shut off\n\nExpected result\n===============\nInstance's data is cleared after it had been deleted.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1586309", 
    "owner": "https://api.launchpad.net/1.0/~hanrong", 
    "id": 1586309, 
    "index": 4545, 
    "openned": "2016-05-27 08:47:46.835136+00:00", 
    "created": "2016-05-27 08:47:46.835136+00:00", 
    "title": "Delete a instance after this instance resized failed, source resource is not cleared.", 
    "comments": [
        {
            "content": "Environment\n===========\nstable/mitaka\n\nSteps to reproduce\n==================\n* I did boot a instance in compute node of SBCJSlot5Rack2Centos7, instance uuid was 00bc72d0-0778-4e69-bfee-b58b87dd1532.\n* Then I did resize this instance, resize failed on finish_resize function on destination compute node SBCJSlot3Rack2Centos7.\n\n[stack@SBCJSlot5Rack2Centos7 ~]$ openstack server show 00bc72d0-0778-4e69-bfee-b58b87dd1532.\n+--------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+\n| Field                                | Value                                                                                                                                  |\n+--------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+\n| OS-DCF:diskConfig                    | AUTO                                                                                                                                   |\n| OS-EXT-AZ:availability_zone          | nova                                                                                                                                   |\n| OS-EXT-SRV-ATTR:host                 | SBCJSlot3Rack2Centos7                                                                                                                  |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | SBCJSlot3Rack2Centos7                                                                                                                  |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000014                                                                                                                      |\n| OS-EXT-STS:power_state               | 1                                                                                                                                      |\n| OS-EXT-STS:task_state                | None                                                                                                                                   |\n| OS-EXT-STS:vm_state                  | error                                                                                                                                  |\n| OS-SRV-USG:launched_at               | 2016-05-27T02:28:07.000000                                                                                                             |\n| OS-SRV-USG:terminated_at             | None                                                                                                                                   |\n| accessIPv4                           |                                                                                                                                        |\n| accessIPv6                           |                                                                                                                                        |\n| addresses                            | public=2001:db8::6, 10.43.239.76                                                                                                       |\n| config_drive                         | True                                                                                                                                   |\n| created                              | 2016-05-27T02:27:56Z                                                                                                                   |\n| fault                                | {u'message': u'Unexpected vif_type=binding_failed', u'code': 500, u'details': u'  File \"/opt/stack/nova/nova/compute/manager.py\", line |\n|                                      | 375, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n  File \"/opt/stack/nova/nova/compute/manager.py\",     |\n|                                      | line 4054, in finish_resize\\n    self._set_instance_obj_error_state(context, instance)\\n  File \"/usr/lib/python2.7/site-               |\n|                                      | packages/oslo_utils/excutils.py\", line 220, in __exit__\\n    self.force_reraise()\\n  File \"/usr/lib/python2.7/site-                    |\n|                                      | packages/oslo_utils/excutils.py\", line 196, in force_reraise\\n    six.reraise(self.type_, self.value, self.tb)\\n  File                 |\n|                                      | \"/opt/stack/nova/nova/compute/manager.py\", line 4042, in finish_resize\\n    disk_info, image_meta)\\n  File                             |\n|                                      | \"/opt/stack/nova/nova/compute/manager.py\", line 4007, in _finish_resize\\n    old_instance_type)\\n  File \"/usr/lib/python2.7/site-      |\n|                                      | packages/oslo_utils/excutils.py\", line 220, in __exit__\\n    self.force_reraise()\\n  File \"/usr/lib/python2.7/site-                    |\n|                                      | packages/oslo_utils/excutils.py\", line 196, in force_reraise\\n    six.reraise(self.type_, self.value, self.tb)\\n  File                 |\n|                                      | \"/opt/stack/nova/nova/compute/manager.py\", line 4002, in _finish_resize\\n    block_device_info, power_on)\\n  File                      |\n|                                      | \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 7405, in finish_migration\\n    write_to_disk=True)\\n  File                         |\n|                                      | \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4718, in _get_guest_xml\\n    context)\\n  File                                      |\n|                                      | \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4584, in _get_guest_config\\n    flavor, virt_type, self._host)\\n  File             |\n|                                      | \"/opt/stack/nova/nova/virt/libvirt/vif.py\", line 447, in get_config\\n    _(\"Unexpected vif_type=%s\") % vif_type)\\n', u'created':       |\n|                                      | u'2016-05-27T03:17:57Z'}                                                                                                               |\n| flavor                               | m1.tiny (1)                                                                                                                            |\n| hostId                               | 7642c4dc55a8bc40c8a0fe2197a1b5333e5d0f028119be752c4098a0                                                                               |\n| id                                   | 00bc72d0-0778-4e69-bfee-b58b87dd1532                                                                                                   |\n| image                                | cirros-0.3.4-x86_64-uec (f19c4e53-d6f6-43bb-b983-b77b0c68f509)                                                                         |\n| key_name                             | None                                                                                                                                   |\n| name                                 | hanrong_az                                                                                                                             |\n| os-extended-volumes:volumes_attached | []                                                                                                                                     |\n| project_id                           | 4d6e4e79ea1f4ec392475308e11a895d                                                                                                       |\n| properties                           |                                                                                                                                        |\n| security_groups                      | [{u'name': u'default'}]                                                                                                                |\n| status                               | ERROR                                                                                                                                  |\n| updated                              | 2016-05-27T03:17:57Z                                                                                                                   |\n| user_id                              | 2903b30f6d9f4c4eb99421e3b4e51796                                                                                                       |\n+--------------------------------------+-------------------------------------------------------------------\n\nMariaDB [nova]> select source_compute,source_compute,status,instance_uuid,instance_uuid from migrations where instance_uuid='00bc72d0-0778-4e69-bfee-b58b87dd1532';\n+-----------------------+-----------------------+--------+--------------------------------------+--------------------------------------+\n| source_compute        | source_compute        | status | instance_uuid                        | instance_uuid                        |\n+-----------------------+-----------------------+--------+--------------------------------------+--------------------------------------+\n| SBCJSlot5Rack2Centos7 | SBCJSlot5Rack2Centos7 | error  | 00bc72d0-0778-4e69-bfee-b58b87dd1532 | 00bc72d0-0778-4e69-bfee-b58b87dd1532 |\n+-----------------------+-----------------------+--------+--------------------------------------+--------------------------------------\n\n* then I did delete this instance successfully. But the instance's data is not cleared on source compute node.\n[stack@SBCJSlot5Rack2Centos7 instances]$ ll\ndrwxrwxr-x 2 stack libvirtd 4096 May 27 10:27 00bc72d0-0778-4e69-bfee-b58b87dd1532_resize\n\n[stack@SBCJSlot5Rack2Centos7 instances]$ sudo virsh list --all\n Id    Name                           State\n----------------------------------------------------\n -     instance-00000014              shut off\n\nExpected result\n===============\nInstance's data is cleared after it had been deleted.", 
            "date_created": "2016-05-27 08:47:46.835136+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "Resize failed on finish_resize, it has no rollback process, I think we could modify this point.", 
            "date_created": "2016-05-27 09:29:17.377136+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "Hi Charlotte, \n\nThere is a periodic task \"_cleanup_incomplete_migrations\" which takes care of instance files on source/destination compute node (which should be other than instance.host). \n\nThis periodic task runs at interval of times configured for 'instance_delete_interval' parameter, default value for which is 300. \n\nFor your scenario, you can check instance files on destination compute node, once this periodic task runs successfully on destination compute node. IMO this periodic task should delete instance files, if not than this is a valid bug.", 
            "date_created": "2016-06-03 09:49:48.814802+00:00", 
            "author": "https://api.launchpad.net/1.0/~ratailor"
        }, 
        {
            "content": "Hi, Rajesh\nThank you for reminding me.\n\nThe _cleanup_incomplete_migrations execute deleteing files again on destination compute node, and migration.status was set failed.\n\nBut the files on source node still exists..\n\n[stack@SBCJSlot5Rack2Centos7 instances]$ ll\ndrwxrwxr-x 2 stack libvirtd 4096 May 27 10:27 00bc72d0-0778-4e69-bfee-b58b87dd1532_resize\n\n[stack@SBCJSlot5Rack2Centos7 instances]$ sudo virsh list --all\n Id Name State\n----------------------------------------------------\n - instance-00000014 shut off", 
            "date_created": "2016-06-05 01:01:45.882359+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "I think periodic task \"_run_pending_deletes\" can resolve cleanup instance's resources on instance.host which may  on source or destination compute node.\n\nSo the periodic task of  cleanup_incomplete_migrations could be resolve cleanup instance's resources on source or destination compute node which is not equal to instance.host.", 
            "date_created": "2016-06-05 01:34:31.560757+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "I looked at the comment of unit test for periodic task \"cleanup_incomplete_migrations\", I found the Unit Test Cases are due to delete resource on source or destination node which not is instance.host.\n\nBut the test scene is not correct. I report that:\nhttps://bugs.launchpad.net/nova/+bug/1589181", 
            "date_created": "2016-06-05 02:37:46.236218+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/325635", 
            "date_created": "2016-06-05 06:34:04.068693+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi Charlotte,\n\nIMO the periodic task \"cleanup_incomplete_migrations\" will take care of deleting instance files from host (which is not instance host) and since you have executed delete request on instance, then it is the job of delete api to delete instance files from instance host. \n\nSo in that case, IMO the periodic task is doing its job correctly.", 
            "date_created": "2016-06-07 06:16:30.929726+00:00", 
            "author": "https://api.launchpad.net/1.0/~ratailor"
        }, 
        {
            "content": "Change abandoned by Rong Han (<email address hidden>) on branch: master\nReview: https://review.openstack.org/325635\nReason: https://review.openstack.org/#/c/326262 is merged", 
            "date_created": "2016-06-12 00:58:47.170229+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "https://review.openstack.org/#/c/326262/", 
            "date_created": "2016-06-12 01:16:37.045982+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "As we use the \"direct-release\" model in Nova we don't use the\n\"Fix Comitted\" status for merged bug fixes anymore. I'm setting\nthis manually to \"Fix Released\" to be consistent.\n\n[1] \"[openstack-dev] [release][all] bugs will now close automatically\n    when patches merge\"; Doug Hellmann; 2015-12-07;\n    http://lists.openstack.org/pipermail/openstack-dev/2015-December/081612.html", 
            "date_created": "2016-10-07 09:55:07.812810+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }
    ], 
    "closed": "2016-10-07 09:55:17.235488+00:00"
}