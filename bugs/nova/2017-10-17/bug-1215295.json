{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 12:09:38.481487+00:00", 
    "description": "Now it is allowed that the flavor with specified name was deleted, and later a new flavor is created with the same name, by this way, you can there are two records in the DB (table \"instance_types\") with the same name but different id/flavorid.\n\nBut if you are going to retrieve all flavors via nova.compute.flavors:get_all_flavors(inactive=True), you would find that only the last flavor which has the same name can be fetched. This is because that all instance types retrieved from DB will be set into a dict and the 'name' is used as the key.\n\n+---------------------+---------------------+---------------------+-------------+----+-----------+-------+------+-------------+----------+-------------+---------+--------------+----------+-----------+---------+\n| created_at          | updated_at          | deleted_at          | name        | id | memory_mb | vcpus | swap | vcpu_weight | flavorid | rxtx_factor | root_gb | ephemeral_gb | disabled | is_public | deleted |\n+---------------------+---------------------+---------------------+-------------+----+-----------+-------+------+-------------+----------+-------------+---------+--------------+----------+-----------+---------+\n| NULL                | NULL                | NULL                | m1.medium   |  1 |      4096 |     2 |    0 |        NULL | 3        |           1 |      40 |            0 |        0 |         1 |       0 |\n| NULL                | NULL                | NULL                | m1.tiny     |  2 |       512 |     1 |    0 |        NULL | 1        |           1 |       1 |            0 |        0 |         1 |       0 |\n| NULL                | NULL                | NULL                | m1.large    |  3 |      8192 |     4 |    0 |        NULL | 4        |           1 |      80 |            0 |        0 |         1 |       0 |\n| NULL                | NULL                | NULL                | m1.xlarge   |  4 |     16384 |     8 |    0 |        NULL | 5        |           1 |     160 |            0 |        0 |         1 |       0 |\n| NULL                | NULL                | NULL                | m1.small    |  5 |      2048 |     1 |    0 |        NULL | 2        |           1 |      20 |            0 |        0 |         1 |       0 |\n| 2013-08-21 23:31:35 | 2013-08-21 23:31:49 | 2013-08-21 23:31:49 | test_flavor |  6 |       512 |     1 |    0 |        NULL | 20       |           1 |       0 |            0 |        0 |         1 |       6 |\n| 2013-08-21 23:36:04 | 2013-08-21 23:37:12 | 2013-08-21 23:37:12 | test_flavor |  7 |      4598 |     1 |    0 |        NULL | 22       |           1 |       0 |            0 |        0 |         1 |       7 |\n| 2013-08-21 23:37:23 | 2013-08-21 23:37:29 | 2013-08-21 23:37:29 | test_flavor |  8 |      1916 |     1 |    0 |        NULL | 22       |           1 |       0 |            0 |        0 |         1 |       8 |\n| 2013-08-21 23:37:36 | 2013-08-21 23:38:30 | 2013-08-21 23:38:30 | tmp         |  9 |       512 |     1 |    0 |        NULL | 20       |           1 |       0 |            0 |        0 |         1 |       9 |\n| 2013-08-22 01:41:48 | 2013-08-22 01:42:42 | 2013-08-22 01:42:42 | tmp         | 10 |      1024 |     8 |    0 |        NULL | 20       |           1 |       0 |            0 |        0 |         1 |      10 |\n| 2013-08-22 01:43:00 | 2013-08-22 01:45:11 | 2013-08-22 01:45:11 | tmp         | 11 |      1024 |     3 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      11 |\n| 2013-08-22 01:45:13 | 2013-08-22 01:47:14 | 2013-08-22 01:47:14 | tmp         | 12 |      1024 |     3 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      12 |\n| 2013-08-22 01:47:17 | 2013-08-22 01:49:18 | 2013-08-22 01:49:18 | tmp         | 13 |      1024 |     3 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      13 |\n| 2013-08-22 01:49:20 | 2013-08-22 01:51:26 | 2013-08-22 01:51:26 | tmp         | 14 |      1024 |     9 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      14 |\n| 2013-08-22 01:51:29 | 2013-08-22 01:53:30 | 2013-08-22 01:53:30 | tmp         | 15 |      1024 |     9 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      15 |\n| 2013-08-22 01:53:32 | 2013-08-22 01:55:32 | 2013-08-22 01:55:32 | tmp         | 16 |      1024 |     9 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      16 |\n| 2013-08-22 01:55:57 | 2013-08-22 01:56:28 | 2013-08-22 01:56:28 | tmp         | 17 |      1024 |     8 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      17 |\n+---------------------+---------------------+---------------------+-------------+----+-----------+-------+------+-------------+----------+-------------+---------+-------------\n\nflavor_refs = flavors.get_all_flavors(self.ctxt, inactive=True)\n\n(Pdb) for flavor in flavor_refs.values(): flavor['id']\n1L\n17L\n5L\n3L\n2L\n4L\n8L\n(Pdb) flavor_refs.keys()\n[u'm1.medium', u'tmp', u'm1.small', u'm1.large', u'm1.tiny', u'm1.xlarge', u'test_flavor']", 
    "tags": [
        "db"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1215295", 
    "owner": "https://api.launchpad.net/1.0/~joshua.hesketh", 
    "id": 1215295, 
    "index": 3533, 
    "openned": "2013-08-22 07:19:30.291434+00:00", 
    "created": "2013-08-22 07:19:30.291434+00:00", 
    "title": "get_all_flavor cannot return all flavors if the deleted flavor has same name", 
    "comments": [
        {
            "content": "Now it is allowed that the flavor with specified name was deleted, and later a new flavor is created with the same name, by this way, you can there are two records in the DB (table \"instance_types\") with the same name but different id/flavorid.\n\nBut if you are going to retrieve all flavors via nova.compute.flavors:get_all_flavors(inactive=True), you would find that only the last flavor which has the same name can be fetched. This is because that all instance types retrieved from DB will be set into a dict and the 'name' is used as the key.\n\n+---------------------+---------------------+---------------------+-------------+----+-----------+-------+------+-------------+----------+-------------+---------+--------------+----------+-----------+---------+\n| created_at          | updated_at          | deleted_at          | name        | id | memory_mb | vcpus | swap | vcpu_weight | flavorid | rxtx_factor | root_gb | ephemeral_gb | disabled | is_public | deleted |\n+---------------------+---------------------+---------------------+-------------+----+-----------+-------+------+-------------+----------+-------------+---------+--------------+----------+-----------+---------+\n| NULL                | NULL                | NULL                | m1.medium   |  1 |      4096 |     2 |    0 |        NULL | 3        |           1 |      40 |            0 |        0 |         1 |       0 |\n| NULL                | NULL                | NULL                | m1.tiny     |  2 |       512 |     1 |    0 |        NULL | 1        |           1 |       1 |            0 |        0 |         1 |       0 |\n| NULL                | NULL                | NULL                | m1.large    |  3 |      8192 |     4 |    0 |        NULL | 4        |           1 |      80 |            0 |        0 |         1 |       0 |\n| NULL                | NULL                | NULL                | m1.xlarge   |  4 |     16384 |     8 |    0 |        NULL | 5        |           1 |     160 |            0 |        0 |         1 |       0 |\n| NULL                | NULL                | NULL                | m1.small    |  5 |      2048 |     1 |    0 |        NULL | 2        |           1 |      20 |            0 |        0 |         1 |       0 |\n| 2013-08-21 23:31:35 | 2013-08-21 23:31:49 | 2013-08-21 23:31:49 | test_flavor |  6 |       512 |     1 |    0 |        NULL | 20       |           1 |       0 |            0 |        0 |         1 |       6 |\n| 2013-08-21 23:36:04 | 2013-08-21 23:37:12 | 2013-08-21 23:37:12 | test_flavor |  7 |      4598 |     1 |    0 |        NULL | 22       |           1 |       0 |            0 |        0 |         1 |       7 |\n| 2013-08-21 23:37:23 | 2013-08-21 23:37:29 | 2013-08-21 23:37:29 | test_flavor |  8 |      1916 |     1 |    0 |        NULL | 22       |           1 |       0 |            0 |        0 |         1 |       8 |\n| 2013-08-21 23:37:36 | 2013-08-21 23:38:30 | 2013-08-21 23:38:30 | tmp         |  9 |       512 |     1 |    0 |        NULL | 20       |           1 |       0 |            0 |        0 |         1 |       9 |\n| 2013-08-22 01:41:48 | 2013-08-22 01:42:42 | 2013-08-22 01:42:42 | tmp         | 10 |      1024 |     8 |    0 |        NULL | 20       |           1 |       0 |            0 |        0 |         1 |      10 |\n| 2013-08-22 01:43:00 | 2013-08-22 01:45:11 | 2013-08-22 01:45:11 | tmp         | 11 |      1024 |     3 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      11 |\n| 2013-08-22 01:45:13 | 2013-08-22 01:47:14 | 2013-08-22 01:47:14 | tmp         | 12 |      1024 |     3 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      12 |\n| 2013-08-22 01:47:17 | 2013-08-22 01:49:18 | 2013-08-22 01:49:18 | tmp         | 13 |      1024 |     3 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      13 |\n| 2013-08-22 01:49:20 | 2013-08-22 01:51:26 | 2013-08-22 01:51:26 | tmp         | 14 |      1024 |     9 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      14 |\n| 2013-08-22 01:51:29 | 2013-08-22 01:53:30 | 2013-08-22 01:53:30 | tmp         | 15 |      1024 |     9 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      15 |\n| 2013-08-22 01:53:32 | 2013-08-22 01:55:32 | 2013-08-22 01:55:32 | tmp         | 16 |      1024 |     9 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      16 |\n| 2013-08-22 01:55:57 | 2013-08-22 01:56:28 | 2013-08-22 01:56:28 | tmp         | 17 |      1024 |     8 |    0 |        NULL | 6        |           1 |       0 |            0 |        0 |         1 |      17 |\n+---------------------+---------------------+---------------------+-------------+----+-----------+-------+------+-------------+----------+-------------+---------+-------------\n\nflavor_refs = flavors.get_all_flavors(self.ctxt, inactive=True)\n\n(Pdb) for flavor in flavor_refs.values(): flavor['id']\n1L\n17L\n5L\n3L\n2L\n4L\n8L\n(Pdb) flavor_refs.keys()\n[u'm1.medium', u'tmp', u'm1.small', u'm1.large', u'm1.tiny', u'm1.xlarge', u'test_flavor']", 
            "date_created": "2013-08-22 07:19:30.291434+00:00", 
            "author": "https://api.launchpad.net/1.0/~chieh-chu"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/45819", 
            "date_created": "2013-09-10 07:04:06.621910+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/45819\nCommitted: http://github.com/openstack/nova/commit/3dc84154db18f1112f2023e75a5472bcf28b8f84\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3dc84154db18f1112f2023e75a5472bcf28b8f84\nAuthor: Joshua Hesketh <email address hidden>\nDate:   Tue Sep 10 17:00:30 2013 +1000\n\n    Ensure get_all_flavors returns deleted items\n    \n    When a flavor is deleted a new one may be created with the same name.\n    However when calling flavors.get_all_flavors(inactive=True) only the\n    latest flavor with the same name is returned. When inactive=True all\n    flavors should be returned regardless of their name or replacement\n    state.\n    \n    Change the key used in the returned dictionary from\n    flavors.get_all_flavors() to the flavorid rather than the name. This\n    allows multiple flavors with the same name to be returned.\n    \n    Fixes bug 1215295\n    Change-Id: I1b0c93b3e12714a5c0798aa87c9e3fe9bc14519a\n", 
            "date_created": "2013-09-24 00:30:18.600751+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Setting this back to triaged because I disagree with the fix. Both name and flavorid are unique string keys, so you have just swapped one for the other.  Now get_all_flavors will only return the latest version of a deleted flavor with the same flavorid. If you really want all copies the key needs to be 'id' which is autoinc and unique across all rows.", 
            "date_created": "2013-09-25 16:39:04.185564+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Well caught Vish.\n\nI've set the dictionary to 'id' here https://review.openstack.org/#/c/48570/\n\nSorry for the mistake!", 
            "date_created": "2013-09-27 03:44:17.129120+00:00", 
            "author": "https://api.launchpad.net/1.0/~joshua.hesketh"
        }
    ], 
    "closed": "2013-10-03 07:52:58.251584+00:00"
}