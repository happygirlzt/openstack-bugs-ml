{
    "status": "Fix Released", 
    "last_updated": "2013-01-22 16:07:01.820886+00:00", 
    "description": "With flatDHCP, nova-network deletes default route, then deletes the ip, puts the ip on bridge and adds default route. But then it deletes the IP on the bridge interface and re-adds the same IP to the same interface. Problem is that once this IP is deleted, route is deleted too. By just adding the IP back again, default route isn't recovered. Example:\n\n\n2011-09-26 13:50:06,787 DEBUG nova.linux_net [-] Starting Bridge interface for eth0 from (pid=909) ensure_bridge /usr/lib/python2.7/dist-packages/nova/network/linux_net.py:919\n2011-09-26 13:50:06,787 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl addbr br100 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:06,854 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl setfd br100 0 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:06,903 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl stp br100 off from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:06,960 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip link set br100 up from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:06,989 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl addif br100 eth0 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,010 DEBUG nova.utils [-] Running cmd (subprocess): sudo route -n from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,029 DEBUG nova.utils [-] Running cmd (subprocess): sudo route del default gw 192.168.69.1 dev eth0 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,060 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr show dev eth0 scope global from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,081 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr del 192.168.69.107/24 brd 192.168.69.255 scope global dev eth0 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,102 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr add 192.168.69.107/24 brd 192.168.69.255 scope global dev br100 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,122 DEBUG nova.utils [-] Running cmd (subprocess): sudo route add default gw 192.168.69.1 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,134 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr show dev br100 scope global from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,156 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr del 192.168.69.107/24 brd 192.168.69.255 scope global dev br100 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,166 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr add 10.10.0.1/24 brd 10.10.0.255 dev br100 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,191 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr add 192.168.69.107/24 brd 192.168.69.255 scope global dev br100 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n\nLook at the last five lines.", 
    "tags": [
        "verification-done"
    ], 
    "importance": "High", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/859587", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 859587, 
    "index": 497, 
    "openned": "2011-09-26 12:11:02.058707+00:00", 
    "created": "2011-09-26 12:11:02.058707+00:00", 
    "title": "nova-network deletes default route", 
    "comments": [
        {
            "content": "With flatDHCP, nova-network deletes default route, then deletes the ip, puts the ip on bridge and adds default route. But then it deletes the IP on the bridge interface and re-adds the same IP to the same interface. Problem is that once this IP is deleted, route is deleted too. By just adding the IP back again, default route isn't recovered. Example:\n\n\n2011-09-26 13:50:06,787 DEBUG nova.linux_net [-] Starting Bridge interface for eth0 from (pid=909) ensure_bridge /usr/lib/python2.7/dist-packages/nova/network/linux_net.py:919\n2011-09-26 13:50:06,787 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl addbr br100 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:06,854 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl setfd br100 0 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:06,903 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl stp br100 off from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:06,960 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip link set br100 up from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:06,989 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl addif br100 eth0 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,010 DEBUG nova.utils [-] Running cmd (subprocess): sudo route -n from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,029 DEBUG nova.utils [-] Running cmd (subprocess): sudo route del default gw 192.168.69.1 dev eth0 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,060 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr show dev eth0 scope global from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,081 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr del 192.168.69.107/24 brd 192.168.69.255 scope global dev eth0 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,102 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr add 192.168.69.107/24 brd 192.168.69.255 scope global dev br100 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,122 DEBUG nova.utils [-] Running cmd (subprocess): sudo route add default gw 192.168.69.1 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,134 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr show dev br100 scope global from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,156 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr del 192.168.69.107/24 brd 192.168.69.255 scope global dev br100 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,166 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr add 10.10.0.1/24 brd 10.10.0.255 dev br100 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 13:50:07,191 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr add 192.168.69.107/24 brd 192.168.69.255 scope global dev br100 from (pid=909) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n\nLook at the last five lines.", 
            "date_created": "2011-09-26 12:11:02.058707+00:00", 
            "author": "https://api.launchpad.net/1.0/~ivoks"
        }, 
        {
            "content": "I can confirm that proposed fix solves the problem for me:\n\n2011-09-26 14:05:24,098 DEBUG nova.linux_net [-] Starting Bridge interface for eth0 from (pid=890) ensure_bridge /usr/lib/python2.7/dist-packages/nova/network/linux_net.py:931\n2011-09-26 14:05:24,098 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl addbr br100 from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,108 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl setfd br100 0 from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,138 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl stp br100 off from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,169 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip link set br100 up from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,191 DEBUG nova.utils [-] Running cmd (subprocess): sudo brctl addif br100 eth0 from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,203 DEBUG nova.utils [-] Running cmd (subprocess): sudo route -n from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,214 DEBUG nova.utils [-] Running cmd (subprocess): sudo route del default gw 192.168.69.1 dev eth0 from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,229 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr show dev eth0 scope global from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,243 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr del 192.168.69.107/24 brd 192.168.69.255 scope global dev eth0 from (pid=890) execute /usr/lib/python2.7/dist-p\nackages/nova/utils.py:165\n2011-09-26 14:05:24,282 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr add 192.168.69.107/24 brd 192.168.69.255 scope global dev br100 from (pid=890) execute /usr/lib/python2.7/dist-\npackages/nova/utils.py:165\n2011-09-26 14:05:24,292 DEBUG nova.utils [-] Running cmd (subprocess): sudo route add default gw 192.168.69.1 from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,302 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr show dev br100 scope global from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,313 DEBUG nova.utils [-] Running cmd (subprocess): sudo route -n from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,325 DEBUG nova.utils [-] Running cmd (subprocess): sudo route del default gw 192.168.69.1 dev br100 from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n2011-09-26 14:05:24,353 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr del 192.168.69.107/24 brd 192.168.69.255 scope global dev br100 from (pid=890) execute /usr/lib/python2.7/dist-\npackages/nova/utils.py:165\n2011-09-26 14:05:24,374 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr add 10.10.0.1/24 brd 10.10.0.255 dev br100 from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.p\ny:165\n2011-09-26 14:05:24,384 DEBUG nova.utils [-] Running cmd (subprocess): sudo ip addr add 192.168.69.107/24 brd 192.168.69.255 scope global dev br100 from (pid=890) execute /usr/lib/python2.7/dist-\npackages/nova/utils.py:165\n2011-09-26 14:05:24,394 DEBUG nova.utils [-] Running cmd (subprocess): sudo route add default gw 192.168.69.1 from (pid=890) execute /usr/lib/python2.7/dist-packages/nova/utils.py:165\n\nRoute is re-added as a last step.", 
            "date_created": "2011-09-26 12:19:14.771559+00:00", 
            "author": "https://api.launchpad.net/1.0/~ivoks"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/647\nCommitted: http://github.com/openstack/nova/commit/569b310b003c1c96151a3e3d448ddf5fe4e9299a\nSubmitter: Jenkins\nBranch:    master\n\n status fixcommitted\n done\n\ncommit 569b310b003c1c96151a3e3d448ddf5fe4e9299a\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Mon Sep 26 05:14:39 2011 -0700\n\n    Makes sure to recreate gateway for moved ip\n    \n    If nova moves an ip when setting up dhcp, make sure to reset\n    the default gateway.  Fixes bug 859587\n    \n    Change-Id: I9f2b7bc5ede142717df6cb1653043b4f5c09959a\n", 
            "date_created": "2011-09-26 14:53:16+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "This bug was fixed in the package nova - 2011.3-0ubuntu3\n\n---------------\nnova (2011.3-0ubuntu3) oneiric; urgency=low\n\n  [Adam Gandelman]\n  * debian/nova-common.postinst: Create 'nova' group, add user to it\n    (LP: #856530)\n  * debian/nova.conf, debian/nova-compute.upstart.in: Move reference of\n    nova-compute.conf from nova.conf to nova-compute's argv. (LP: #839796)\n\n  [Chuck Short]\n  * debian/patches/backport-recreate-gateway-using-dhcp.patch:\n    Makes sure to recreate gateway for moved ip. (LP: #859587)\n  * debian/control: Update Vcs info.\n\n  [ Scott Moser ]\n  * debian/patches/fqdn-in-local-hostname-of-ec2-metadata.patch\n    Make the 'local-hostname' in the EC2 Metadata service contain\n    the domainname also. (LP: #854614)\n -- Chuck Short <email address hidden>   Tue, 27 Sep 2011 14:56:59 -0400", 
            "date_created": "2011-09-27 20:07:47.716881+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/933\nCommitted: http://github.com/openstack/nova/commit/1c8fedc82c4b388b0a3a876a54c7f14d3c2a8342\nSubmitter: Jenkins\nBranch:    stable/diablo\n\n status fixcommitted\n done\n\ncommit 1c8fedc82c4b388b0a3a876a54c7f14d3c2a8342\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Mon Sep 26 05:14:39 2011 -0700\n\n    Makes sure to recreate gateway for moved ip\n    \n    If nova moves an ip when setting up dhcp, make sure to reset\n    the default gateway.  Fixes bug 859587\n    \n    (cherry picked from commit 569b310b003c1c96151a3e3d448ddf5fe4e9299a)\n    \n    Change-Id: I6dd1fb9d80c9635a8a721e77386938684cdd8f53\n", 
            "date_created": "2011-10-19 07:52:21+00:00", 
            "author": "https://api.launchpad.net/1.0/~openstack-gerrit"
        }, 
        {
            "content": "Hello Ante, or anyone else affected,\n\nAccepted nova into oneiric-proposed, the package will build now and be available in a few hours. Please test and give feedback here. See https://wiki.ubuntu.com/Testing/EnableProposed for documentation how to enable and use -proposed. Thank you in advance!", 
            "date_created": "2011-12-19 14:56:04.927873+00:00", 
            "author": "https://api.launchpad.net/1.0/~pitti"
        }
    ], 
    "closed": "2011-11-17 09:54:04.227607+00:00"
}