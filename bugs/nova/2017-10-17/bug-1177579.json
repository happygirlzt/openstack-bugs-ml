{
    "status": "Fix Released", 
    "last_updated": "2015-11-24 16:01:58.258168+00:00", 
    "description": "Used a script to get a token, use that token to delete a server, then delete the token (in an effort to cleanup). The server deletion got stuck, and the following error was logged:\n\nunsupported operand type(s) for +: 'NoneType' and 'str'\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 231, in decorated_function\n\u00a0\u00a0\u00a0 return function(self, context, *args, **kwargs)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1401, in terminate_instance\n\u00a0\u00a0\u00a0 do_terminate_instance(instance, bdms)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 242, in inner\n\u00a0\u00a0\u00a0 retval = f(*args, **kwargs)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1393, in do_terminate_instance\n\u00a0\u00a0\u00a0 reservations=reservations)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/hooks.py\", line 88, in inner\n\u00a0\u00a0\u00a0 rv = f(*args, **kwargs)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1356, in _delete_instance\n\u00a0\u00a0\u00a0 project_id=project_id)\n\u00a0 File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n\u00a0\u00a0\u00a0 self.gen.next()\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1329, in _delete_instance\n\u00a0\u00a0\u00a0 self._shutdown_instance(context, instance, bdms)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1254, in _shutdown_instance\n\u00a0\u00a0\u00a0 network_info = self._get_instance_nw_info(context, instance)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 691, in _get_instance_nw_info\n\u00a0\u00a0\u00a0 instance, conductor_api=self.conductor_api)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/network/quantumv2/api.py\", line 363, in get_instance_nw_info\n\u00a0\u00a0\u00a0 result = self._get_instance_nw_info(context, instance, networks)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/network/quantumv2/api.py\", line 371, in _get_instance_nw_info\n\u00a0\u00a0\u00a0 nw_info = self._build_network_info_model(context, instance, networks)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/network/quantumv2/ibmpowervm_api.py\", line 27, in _build_network_info_model\n\u00a0\u00a0\u00a0 networks)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/network/quantumv2/api.py\", line 794, in _build_network_info_model\n\u00a0\u00a0\u00a0 instance['project_id'])\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/network/quantumv2/api.py\", line 118, in _get_available_networks\n\u00a0\u00a0\u00a0 nets = quantum.list_networks(**search_opts).get('networks', [])\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 108, in with_params\n\u00a0\u00a0\u00a0 ret = self.function(instance, *args, **kwargs)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 294, in list_networks\n\u00a0\u00a0\u00a0 **_params)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 1002, in list\n\u00a0\u00a0\u00a0 for r in self._pagination(collection, path, **params):\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 1015, in _pagination\n\u00a0\u00a0\u00a0 res = self.get(path, params=params)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 988, in get\n\u00a0\u00a0\u00a0 headers=headers, params=params)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 973, in retry_request\n\u00a0\u00a0\u00a0 headers=headers, params=params)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 907, in do_request\n\u00a0\u00a0\u00a0 resp, replybody = self.httpclient.do_request(action, method, body=body)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/client.py\", line 154, in do_request\n\u00a0\u00a0\u00a0 self.authenticate()\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/client.py\", line 183, in authenticate\n\u00a0\u00a0\u00a0 token_url = self.auth_url + \"/tokens\"\n\nDeleting the token when the client is done with it should not cause a problem. If OpenStack needs a token internally, it should get one itself. And indeed we found that the code tried to do just that when the token created by the test script stopped working, but the reauthentication code is flawed... it does not have the auth_url, which led to the error shown in the stacktrace.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1177579", 
    "owner": "https://api.launchpad.net/1.0/~stanislaw-pitucha", 
    "id": 1177579, 
    "index": 4905, 
    "openned": "2013-05-08 19:22:26.167433+00:00", 
    "created": "2013-05-07 22:19:35.841095+00:00", 
    "title": "deletion of token for client causes failure", 
    "comments": [
        {
            "content": "Used a script to get a token, use that token to delete a server, then delete the token (in an effort to cleanup). The server deletion got stuck, and the following error was logged:\n\nunsupported operand type(s) for +: 'NoneType' and 'str'\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 231, in decorated_function\n\u00a0\u00a0\u00a0 return function(self, context, *args, **kwargs)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1401, in terminate_instance\n\u00a0\u00a0\u00a0 do_terminate_instance(instance, bdms)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 242, in inner\n\u00a0\u00a0\u00a0 retval = f(*args, **kwargs)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1393, in do_terminate_instance\n\u00a0\u00a0\u00a0 reservations=reservations)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/hooks.py\", line 88, in inner\n\u00a0\u00a0\u00a0 rv = f(*args, **kwargs)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1356, in _delete_instance\n\u00a0\u00a0\u00a0 project_id=project_id)\n\u00a0 File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n\u00a0\u00a0\u00a0 self.gen.next()\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1329, in _delete_instance\n\u00a0\u00a0\u00a0 self._shutdown_instance(context, instance, bdms)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 1254, in _shutdown_instance\n\u00a0\u00a0\u00a0 network_info = self._get_instance_nw_info(context, instance)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 691, in _get_instance_nw_info\n\u00a0\u00a0\u00a0 instance, conductor_api=self.conductor_api)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/network/quantumv2/api.py\", line 363, in get_instance_nw_info\n\u00a0\u00a0\u00a0 result = self._get_instance_nw_info(context, instance, networks)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/network/quantumv2/api.py\", line 371, in _get_instance_nw_info\n\u00a0\u00a0\u00a0 nw_info = self._build_network_info_model(context, instance, networks)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/network/quantumv2/ibmpowervm_api.py\", line 27, in _build_network_info_model\n\u00a0\u00a0\u00a0 networks)\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/network/quantumv2/api.py\", line 794, in _build_network_info_model\n\u00a0\u00a0\u00a0 instance['project_id'])\n\u00a0 File \"/usr/lib/python2.6/site-packages/nova/network/quantumv2/api.py\", line 118, in _get_available_networks\n\u00a0\u00a0\u00a0 nets = quantum.list_networks(**search_opts).get('networks', [])\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 108, in with_params\n\u00a0\u00a0\u00a0 ret = self.function(instance, *args, **kwargs)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 294, in list_networks\n\u00a0\u00a0\u00a0 **_params)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 1002, in list\n\u00a0\u00a0\u00a0 for r in self._pagination(collection, path, **params):\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 1015, in _pagination\n\u00a0\u00a0\u00a0 res = self.get(path, params=params)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 988, in get\n\u00a0\u00a0\u00a0 headers=headers, params=params)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 973, in retry_request\n\u00a0\u00a0\u00a0 headers=headers, params=params)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/v2_0/client.py\", line 907, in do_request\n\u00a0\u00a0\u00a0 resp, replybody = self.httpclient.do_request(action, method, body=body)\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/client.py\", line 154, in do_request\n\u00a0\u00a0\u00a0 self.authenticate()\n\u00a0 File \"/usr/lib/python2.6/site-packages/quantumclient/client.py\", line 183, in authenticate\n\u00a0\u00a0\u00a0 token_url = self.auth_url + \"/tokens\"\n\nDeleting the token when the client is done with it should not cause a problem. If OpenStack needs a token internally, it should get one itself. And indeed we found that the code tried to do just that when the token created by the test script stopped working, but the reauthentication code is flawed... it does not have the auth_url, which led to the error shown in the stacktrace.", 
            "date_created": "2013-05-07 22:19:35.841095+00:00", 
            "author": "https://api.launchpad.net/1.0/~philnel"
        }, 
        {
            "content": "Adding the bug to Nova since it's the Quantum driver in Nova that is throwing the error.", 
            "date_created": "2013-05-08 19:23:02.147057+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmcclain"
        }, 
        {
            "content": "When the quantum client instantiated by the nova quantum driver goes to list networks, auth fails as the token has been deleted. Quantum client has logic to try authenticating when Unauthorized is raised but quantum driver doesn't give params: username, password, tenant_name, auth_url required for the client to achieve this when it creates the client object.", 
            "date_created": "2013-05-09 00:37:50.444289+00:00", 
            "author": "https://api.launchpad.net/1.0/~melwitt"
        }, 
        {
            "content": "I could not reproduce the issue in my local environment. Could you please provide me the detailed steps you followed to reproduce the issue.", 
            "date_created": "2013-05-14 14:55:46.746123+00:00", 
            "author": "https://api.launchpad.net/1.0/~satya-patibandla"
        }, 
        {
            "content": "The tester created a script which gets a token, runs a rest call to delete a server and then deletes the token.  They do this several times quickly and by the time quantum needs to do it's thing, the token is invalid so it fails and can't re-authenticate because the auth_url isn't passed down to the client.  I believe this is the fix (I created this from stable/grizzly 2013.1.1 but it should be the same for master):\n\ndiff --git a/nova/network/quantumv2/__init__.py b/nova/network/quantumv2/__init__.py\nindex bda0392..f14d007 100644\n--- a/nova/network/quantumv2/__init__.py\n+++ b/nova/network/quantumv2/__init__.py\n@@ -51,6 +51,7 @@\n         'endpoint_url': CONF.quantum_url,\n         'timeout': CONF.quantum_url_timeout,\n         'insecure': CONF.quantum_api_insecure,\n+        'auth_url': CONF.quantum_admin_auth_url,\n     }\n     if token:\n         params['token'] = token", 
            "date_created": "2013-05-14 15:26:27.394313+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/29402", 
            "date_created": "2013-05-16 16:36:06.523416+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The nova side of this problem is fixed by this change:\n\nhttps://review.openstack.org/#/c/23198/\n\nI worked with Phil on a patch for that change to verify it resolves this bug.\n\nThat change is for this blueprint in havana: https://blueprints.launchpad.net/nova/+spec/fewer-networking-token-checks", 
            "date_created": "2013-05-21 21:38:00.684585+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/23198\nCommitted: http://github.com/openstack/nova/commit/dd9c27f999221001bae9faa03571645824d2a681\nSubmitter: Jenkins\nBranch:    master\n\ncommit dd9c27f999221001bae9faa03571645824d2a681\nAuthor: Stanislaw Pitucha <email address hidden>\nDate:   Thu Feb 28 19:50:21 2013 +0000\n\n    Delegate authentication to quantumclient\n    \n    Quantumclient can deal with authentication, getting the token and\n    refreshing it when needed. There should be no need for nova to do\n    those explicitly. Additionally nova can save some time not having\n    to recreate the Client object on each request.\n    \n    Fix a couple of places that relied on the exceptions module being\n    imported inside quantumv2.\n    \n    Part of blueprint fewer-networking-token-checks\n    Fixed bug 1177579\n    \n    Change-Id: I007cef1f0bd688036fa45d79792e6e350c145f05\n", 
            "date_created": "2013-05-29 23:59:47.316574+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-07-17 12:31:49.400394+00:00"
}