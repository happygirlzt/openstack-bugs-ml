{
    "status": "Fix Released", 
    "last_updated": "2017-05-08 22:25:51.290501+00:00", 
    "description": "(openstack) console log show chenrui_vm\nUnexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<type 'exceptions.UnboundLocalError'> (HTTP 500) (Request-ID: req-26d4eed4-316f-4d3c-9d2f-040f855ee940)\n(openstack) server list\n+--------------------------------------+------------+---------+--------------------------------------------------------+--------------------------+\n| ID                                   | Name       | Status  | Networks                                               | Image Name               |\n+--------------------------------------+------------+---------+--------------------------------------------------------+--------------------------+\n| 2cf68078-52f7-4f15-92dc-7333927220f1 | chenrui_vm | SHUTOFF | private=fdb4:4f0f:960b:0:f816:3eff:fe4b:25c3, 10.0.0.8 | cirros-0.3.5-x86_64-disk |\n+--------------------------------------+------------+---------+--------------------------------------------------------+--------------------------+\n\nn-cpu.log\n\nnd /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:473\n2017-04-06 16:19:09.814 17016 DEBUG oslo_messaging._drivers.amqpdriver [req-26d4eed4-316f-4d3c-9d2f-040f855ee940 admin admin] CAST unique_id: ada9ebc67fe04118b1c191362bf53d7b NOTIFY exchange 'nova' topic 'versioned_notifications.error' _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:473\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server [req-26d4eed4-316f-4d3c-9d2f-040f855ee940 admin admin] Exception during message handling\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server Traceback (most recent call last):\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 157, in _process_incoming\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     res = self.dispatcher.dispatch(message)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 213, in dispatch\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     return self._do_dispatch(endpoint, method, ctxt, args)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 183, in _do_dispatch\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     result = func(ctxt, **new_args)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 229, in inner\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     return func(*args, **kwargs)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/exception_wrapper.py\", line 77, in wrapped\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     function_name, call_dict, binary)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/exception_wrapper.py\", line 68, in wrapped\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     return f(self, context, *args, **kw)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 214, in decorated_function\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     kwargs['instance'], e, sys.exc_info())\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 202, in decorated_function\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     return function(self, context, *args, **kwargs)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 4543, in get_console_output\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     output = self.driver.get_console_output(context, instance)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2801, in get_console_output\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     data = self._flush_libvirt_console(pty)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server UnboundLocalError: local variable 'pty' referenced before assignment\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server\n2017-04-06 16:19:09.817 17016 DEBUG oslo_messaging._drivers.amqpdriver [req-26d4eed4-316f-4d3c-9d2f-040f855ee940 admin admin] sending reply msg_id: 9f78f1c6f0af419ca73ae288b2082902 reply queue: reply_d1293bd1e962444caa9999b71ff92cf2 time elapsed: 0.602079593111s _send_reply /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:90\n\n\nstack@szxbzci0004 ~/logs $ virsh list --all\n Id    Name                           State\n----------------------------------------------------\n -     instance-00000006              shut off\n\nstack@szxbzci0004 ~/logs $ virsh dumpxml instance-00000006\n...\n    <interface type='bridge'>\n      <mac address='fa:16:3e:4b:25:c3'/>\n      <source bridge='qbr86d9c781-31'/>\n      <target dev='tap86d9c781-31'/>\n      <model type='virtio'/>\n      <driver name='qemu'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </interface>\n    <serial type='pty'>\n      <log file='/opt/stack/data/nova/instances/2cf68078-52f7-4f15-92dc-7333927220f1/console.log' append='off'/>\n      <target port='0'/>\n    </serial>\n    <console type='pty'>\n      <log file='/opt/stack/data/nova/instances/2cf68078-52f7-4f15-92dc-7333927220f1/console.log' append='off'/>\n      <target type='serial' port='0'/>\n    </console>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n\n...\n\nstack@szxbzci0004 ~/logs $ virsh version\nCompiled against library: libvirt 2.5.0\nUsing library: libvirt 2.5.0\nUsing API: QEMU 2.5.0\nRunning hypervisor: QEMU 2.8.0\n\nstack@szxbzci0004 ~/nova (master) $ git log -1\ncommit 53296a07027ea434cdae90709c7298ad2fb346c6\nMerge: 7660d0c f828f6d\nAuthor: Jenkins <email address hidden>\nDate:   Wed Apr 5 22:08:00 2017 +0000\n\n    Merge \"docs: update description for AggregateInstanceExtraSpecsFilter\"", 
    "tags": [
        "console", 
        "in-stable-newton", 
        "in-stable-ocata", 
        "libvirt"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1680363", 
    "owner": "https://api.launchpad.net/1.0/~zhengzhenyu", 
    "id": 1680363, 
    "index": 2061, 
    "openned": "2017-04-06 08:25:36.791562+00:00", 
    "created": "2017-04-06 08:25:36.791562+00:00", 
    "title": "Raise Unexpected API Error when get console log from stopped instance", 
    "comments": [
        {
            "content": "(openstack) console log show chenrui_vm\nUnexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<type 'exceptions.UnboundLocalError'> (HTTP 500) (Request-ID: req-26d4eed4-316f-4d3c-9d2f-040f855ee940)\n(openstack) server list\n+--------------------------------------+------------+---------+--------------------------------------------------------+--------------------------+\n| ID                                   | Name       | Status  | Networks                                               | Image Name               |\n+--------------------------------------+------------+---------+--------------------------------------------------------+--------------------------+\n| 2cf68078-52f7-4f15-92dc-7333927220f1 | chenrui_vm | SHUTOFF | private=fdb4:4f0f:960b:0:f816:3eff:fe4b:25c3, 10.0.0.8 | cirros-0.3.5-x86_64-disk |\n+--------------------------------------+------------+---------+--------------------------------------------------------+--------------------------+\n\nn-cpu.log\n\nnd /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:473\n2017-04-06 16:19:09.814 17016 DEBUG oslo_messaging._drivers.amqpdriver [req-26d4eed4-316f-4d3c-9d2f-040f855ee940 admin admin] CAST unique_id: ada9ebc67fe04118b1c191362bf53d7b NOTIFY exchange 'nova' topic 'versioned_notifications.error' _send /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:473\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server [req-26d4eed4-316f-4d3c-9d2f-040f855ee940 admin admin] Exception during message handling\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server Traceback (most recent call last):\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 157, in _process_incoming\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     res = self.dispatcher.dispatch(message)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 213, in dispatch\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     return self._do_dispatch(endpoint, method, ctxt, args)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 183, in _do_dispatch\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     result = func(ctxt, **new_args)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/server.py\", line 229, in inner\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     return func(*args, **kwargs)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/exception_wrapper.py\", line 77, in wrapped\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     function_name, call_dict, binary)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/exception_wrapper.py\", line 68, in wrapped\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     return f(self, context, *args, **kw)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 214, in decorated_function\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     kwargs['instance'], e, sys.exc_info())\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 202, in decorated_function\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     return function(self, context, *args, **kwargs)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/compute/manager.py\", line 4543, in get_console_output\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     output = self.driver.get_console_output(context, instance)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2801, in get_console_output\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server     data = self._flush_libvirt_console(pty)\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server UnboundLocalError: local variable 'pty' referenced before assignment\n2017-04-06 16:19:09.816 17016 ERROR oslo_messaging.rpc.server\n2017-04-06 16:19:09.817 17016 DEBUG oslo_messaging._drivers.amqpdriver [req-26d4eed4-316f-4d3c-9d2f-040f855ee940 admin admin] sending reply msg_id: 9f78f1c6f0af419ca73ae288b2082902 reply queue: reply_d1293bd1e962444caa9999b71ff92cf2 time elapsed: 0.602079593111s _send_reply /usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py:90\n\n\nstack@szxbzci0004 ~/logs $ virsh list --all\n Id    Name                           State\n----------------------------------------------------\n -     instance-00000006              shut off\n\nstack@szxbzci0004 ~/logs $ virsh dumpxml instance-00000006\n...\n    <interface type='bridge'>\n      <mac address='fa:16:3e:4b:25:c3'/>\n      <source bridge='qbr86d9c781-31'/>\n      <target dev='tap86d9c781-31'/>\n      <model type='virtio'/>\n      <driver name='qemu'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </interface>\n    <serial type='pty'>\n      <log file='/opt/stack/data/nova/instances/2cf68078-52f7-4f15-92dc-7333927220f1/console.log' append='off'/>\n      <target port='0'/>\n    </serial>\n    <console type='pty'>\n      <log file='/opt/stack/data/nova/instances/2cf68078-52f7-4f15-92dc-7333927220f1/console.log' append='off'/>\n      <target type='serial' port='0'/>\n    </console>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n\n...\n\nstack@szxbzci0004 ~/logs $ virsh version\nCompiled against library: libvirt 2.5.0\nUsing library: libvirt 2.5.0\nUsing API: QEMU 2.5.0\nRunning hypervisor: QEMU 2.8.0\n\nstack@szxbzci0004 ~/nova (master) $ git log -1\ncommit 53296a07027ea434cdae90709c7298ad2fb346c6\nMerge: 7660d0c f828f6d\nAuthor: Jenkins <email address hidden>\nDate:   Wed Apr 5 22:08:00 2017 +0000\n\n    Merge \"docs: update description for AggregateInstanceExtraSpecsFilter\"", 
            "date_created": "2017-04-06 08:25:36.791562+00:00", 
            "author": "https://api.launchpad.net/1.0/~kiwik-chenrui"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/455183", 
            "date_created": "2017-04-10 09:36:36.652650+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Looks like this is just a latent bug that's always been there if we don't find what we're looking for with pty consoles, even going back to mitaka:\n\nhttps://github.com/openstack/nova/blob/stable/mitaka/nova/virt/libvirt/driver.py#L2869", 
            "date_created": "2017-04-11 16:27:35.621914+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/456713", 
            "date_created": "2017-04-13 17:24:09.173006+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/455183\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0c2b73e80141c6bef309097d1cbd0129d6ca094d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0c2b73e80141c6bef309097d1cbd0129d6ca094d\nAuthor: Kevin_Zheng <email address hidden>\nDate:   Mon Apr 10 17:28:33 2017 +0800\n\n    Fix HTTP 500 raised for getConsoleLog for stopped instance\n    \n    Stopped instances with pty console will not contain\n    `source_node` information, and in the current\n    implementation the pty variable used later will\n    result in an UnboundLocalError, which results in a\n    500 error out of the API.\n    \n    Closes-bug: #1680363\n    \n    Change-Id: I4dffba959e2292254dc757f22c3f7893d2da72f9\n", 
            "date_created": "2017-04-13 21:44:07.464328+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/456770", 
            "date_created": "2017-04-13 22:08:10.556602+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b1 development milestone.", 
            "date_created": "2017-04-14 09:21:54.061707+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/456713\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=1c6eab183ffe175f2ba99e5dd522227aa66fcc48\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit 1c6eab183ffe175f2ba99e5dd522227aa66fcc48\nAuthor: Kevin_Zheng <email address hidden>\nDate:   Mon Apr 10 17:28:33 2017 +0800\n\n    Fix HTTP 500 raised for getConsoleLog for stopped instance\n    \n    Stopped instances with pty console will not contain\n    `source_node` information, and in the current\n    implementation the pty variable used later will\n    result in an UnboundLocalError, which results in a\n    500 error out of the API.\n    \n    Closes-bug: #1680363\n    \n    Change-Id: I4dffba959e2292254dc757f22c3f7893d2da72f9\n    (cherry picked from commit 0c2b73e80141c6bef309097d1cbd0129d6ca094d)\n", 
            "date_created": "2017-04-25 21:18:01.943486+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/456770\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=4aa5a3bec564ccfe1ee5327069d1441c9e352d6b\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 4aa5a3bec564ccfe1ee5327069d1441c9e352d6b\nAuthor: Kevin_Zheng <email address hidden>\nDate:   Mon Apr 10 17:28:33 2017 +0800\n\n    Fix HTTP 500 raised for getConsoleLog for stopped instance\n    \n    Stopped instances with pty console will not contain\n    `source_node` information, and in the current\n    implementation the pty variable used later will\n    result in an UnboundLocalError, which results in a\n    500 error out of the API.\n    \n    Closes-bug: #1680363\n    \n    Change-Id: I4dffba959e2292254dc757f22c3f7893d2da72f9\n    (cherry picked from commit 0c2b73e80141c6bef309097d1cbd0129d6ca094d)\n    (cherry picked from commit 1c6eab183ffe175f2ba99e5dd522227aa66fcc48)\n", 
            "date_created": "2017-04-26 21:24:50.211783+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.4 release.", 
            "date_created": "2017-05-08 22:10:22.919925+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.6 release.", 
            "date_created": "2017-05-08 22:25:50.694959+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-04-13 21:44:04.332706+00:00"
}