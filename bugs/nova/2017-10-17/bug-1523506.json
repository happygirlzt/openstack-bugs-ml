{
    "status": "Invalid", 
    "last_updated": "2016-03-07 07:48:11.050023+00:00", 
    "description": "There have been a lot of bug fixes related to this topic, but it still exists somehow. Some previous fix-released bugs for example:\nhttps://bugs.launchpad.net/nova/+bug/1200479\nhttps://bugs.launchpad.net/nova/+bug/1196893\nhttps://bugs.launchpad.net/nova/+bug/1277230\n\nThe mailing list has already decided not to allow hosts in different AZs (http://lists.openstack.org/pipermail/openstack-dev/2014-April/031803.html), but it can still be reproduced by following 3 steps:\n\n#### start repro ####\n\n1) create two host aggregates \"foo\", \"bar\" to the default AZ:\n$ nova aggregate-create foo\n+----+------+-------------------+-------+----------+\n| Id | Name | Availability Zone | Hosts | Metadata |\n+----+------+-------------------+-------+----------+\n| 58 | foo  | -                 |       |          |\n+----+------+-------------------+-------+----------+\n$ nova aggregate-create bar\n+----+------+-------------------+-------+----------+\n| Id | Name | Availability Zone | Hosts | Metadata |\n+----+------+-------------------+-------+----------+\n| 59 | bar  | -                 |       |          |\n+----+------+-------------------+-------+----------+\n\n\n2) assign a host \"node2\" to both aggregates\n$ nova aggregate-add-host foo node2\n+----+------+-------------------+---------+----------+\n| Id | Name | Availability Zone | Hosts   | Metadata |\n+----+------+-------------------+---------+----------+\n| 58 | foo  | -                 | 'node2' |          |\n+----+------+-------------------+---------+----------+\n$ nova aggregate-add-host bar node2\n+----+------+-------------------+---------+----------+\n| Id | Name | Availability Zone | Hosts   | Metadata |\n+----+------+-------------------+---------+----------+\n| 59 | bar  | -                 | 'node2' |          |\n+----+------+-------------------+---------+----------+\n\n\n3) change \"foo\" to a named AZ called \"az\"\n$ nova aggregate-update foo foo az\nAggregate 58 has been successfully updated.\n+----+------+-------------------+---------+------------------------+\n| Id | Name | Availability Zone | Hosts   | Metadata               |\n+----+------+-------------------+---------+------------------------+\n| 58 | foo  | az                | 'node2' | 'availability_zone=az' |\n+----+------+-------------------+---------+------------------------+\n\n\n#### end repro ####\n\nThe third step should NOT happen because it causes \"node2\" belong to both default AZ and \"az\" AZ, logically:\n$ nova aggregate-details foo\n+----+------+-------------------+---------+------------------------+\n| Id | Name | Availability Zone | Hosts   | Metadata               |\n+----+------+-------------------+---------+------------------------+\n| 58 | foo  | az                | 'node2' | 'availability_zone=az' |\n+----+------+-------------------+---------+------------------------+\n$ nova aggregate-details bar\n+----+------+-------------------+---------+----------+\n| Id | Name | Availability Zone | Hosts   | Metadata |\n+----+------+-------------------+---------+----------+\n| 59 | bar  | -                 | 'node2' |          |\n+----+------+-------------------+---------+----------+\n\n\nInteresting thing is, \"node2\" is actually only belong to the availibility zone \"az\" if we list all the AZs. Thanks to the previous bug fixings:\n$ nova availability-zone-list\n+-----------------------+----------------------------------------+\n| Name                  | Status                                 |\n+-----------------------+----------------------------------------+\n| internal              | available                              |\n| |- node1              |                                        |\n| | |- nova-conductor   | enabled :-) 2015-12-07T13:45:59.000000 |\n| | |- nova-consoleauth | enabled :-) 2015-12-07T13:45:59.000000 |\n| | |- nova-scheduler   | enabled :-) 2015-12-07T13:46:02.000000 |\n| | |- nova-cert        | enabled :-) 2015-12-07T13:46:01.000000 |\n| az                    | available                              |\n| |- node2              |                                        |\n| | |- nova-compute     | enabled :-) 2015-12-07T13:46:04.000000 |\n+-----------------------+----------------------------------------+", 
    "tags": [
        "scheduler"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1523506", 
    "owner": "https://api.launchpad.net/1.0/~cyx1231st", 
    "id": 1523506, 
    "index": 7153, 
    "openned": "2015-12-07 13:52:47.887085+00:00", 
    "created": "2015-12-07 13:52:47.887085+00:00", 
    "title": "hosts within two availability zones", 
    "comments": [
        {
            "content": "There have been a lot of bug fixes related to this topic, but it still exists somehow. Some previous fix-released bugs for example:\nhttps://bugs.launchpad.net/nova/+bug/1200479\nhttps://bugs.launchpad.net/nova/+bug/1196893\nhttps://bugs.launchpad.net/nova/+bug/1277230\n\nThe mailing list has already decided not to allow hosts in different AZs (http://lists.openstack.org/pipermail/openstack-dev/2014-April/031803.html), but it can still be reproduced by following 3 steps:\n\n#### start repro ####\n\n1) create two host aggregates \"foo\", \"bar\" to the default AZ:\n$ nova aggregate-create foo\n+----+------+-------------------+-------+----------+\n| Id | Name | Availability Zone | Hosts | Metadata |\n+----+------+-------------------+-------+----------+\n| 58 | foo  | -                 |       |          |\n+----+------+-------------------+-------+----------+\n$ nova aggregate-create bar\n+----+------+-------------------+-------+----------+\n| Id | Name | Availability Zone | Hosts | Metadata |\n+----+------+-------------------+-------+----------+\n| 59 | bar  | -                 |       |          |\n+----+------+-------------------+-------+----------+\n\n\n2) assign a host \"node2\" to both aggregates\n$ nova aggregate-add-host foo node2\n+----+------+-------------------+---------+----------+\n| Id | Name | Availability Zone | Hosts   | Metadata |\n+----+------+-------------------+---------+----------+\n| 58 | foo  | -                 | 'node2' |          |\n+----+------+-------------------+---------+----------+\n$ nova aggregate-add-host bar node2\n+----+------+-------------------+---------+----------+\n| Id | Name | Availability Zone | Hosts   | Metadata |\n+----+------+-------------------+---------+----------+\n| 59 | bar  | -                 | 'node2' |          |\n+----+------+-------------------+---------+----------+\n\n\n3) change \"foo\" to a named AZ called \"az\"\n$ nova aggregate-update foo foo az\nAggregate 58 has been successfully updated.\n+----+------+-------------------+---------+------------------------+\n| Id | Name | Availability Zone | Hosts   | Metadata               |\n+----+------+-------------------+---------+------------------------+\n| 58 | foo  | az                | 'node2' | 'availability_zone=az' |\n+----+------+-------------------+---------+------------------------+\n\n\n#### end repro ####\n\nThe third step should NOT happen because it causes \"node2\" belong to both default AZ and \"az\" AZ, logically:\n$ nova aggregate-details foo\n+----+------+-------------------+---------+------------------------+\n| Id | Name | Availability Zone | Hosts   | Metadata               |\n+----+------+-------------------+---------+------------------------+\n| 58 | foo  | az                | 'node2' | 'availability_zone=az' |\n+----+------+-------------------+---------+------------------------+\n$ nova aggregate-details bar\n+----+------+-------------------+---------+----------+\n| Id | Name | Availability Zone | Hosts   | Metadata |\n+----+------+-------------------+---------+----------+\n| 59 | bar  | -                 | 'node2' |          |\n+----+------+-------------------+---------+----------+\n\n\nInteresting thing is, \"node2\" is actually only belong to the availibility zone \"az\" if we list all the AZs. Thanks to the previous bug fixings:\n$ nova availability-zone-list\n+-----------------------+----------------------------------------+\n| Name                  | Status                                 |\n+-----------------------+----------------------------------------+\n| internal              | available                              |\n| |- node1              |                                        |\n| | |- nova-conductor   | enabled :-) 2015-12-07T13:45:59.000000 |\n| | |- nova-consoleauth | enabled :-) 2015-12-07T13:45:59.000000 |\n| | |- nova-scheduler   | enabled :-) 2015-12-07T13:46:02.000000 |\n| | |- nova-cert        | enabled :-) 2015-12-07T13:46:01.000000 |\n| az                    | available                              |\n| |- node2              |                                        |\n| | |- nova-compute     | enabled :-) 2015-12-07T13:46:04.000000 |\n+-----------------------+----------------------------------------+", 
            "date_created": "2015-12-07 13:52:47.887085+00:00", 
            "author": "https://api.launchpad.net/1.0/~cyx1231st"
        }, 
        {
            "content": "I don't really understand what the problem is. Nova only thinks this is in one az. It can still be in multiple aggregates.", 
            "date_created": "2016-02-11 18:54:59.132155+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "What I'm doing is to successfully make the host\"node2\" to two different AZs: the default AZ and another AZ named \"az\".\n\n\nHost \"node2\" is belonging to two different aggregates \"foo\" and \"bar\", however, \"foo\" belongs to AZ \"az\", but \"bar\" belongs to AZ \"default\".  That's why I think this is a bug.", 
            "date_created": "2016-02-19 03:11:25.871702+00:00", 
            "author": "https://api.launchpad.net/1.0/~cyx1231st"
        }, 
        {
            "content": "I believe everything works as expected. Where I think your reasoning is wrong is what you think makes a host belong to the default AZ.\n\nAs I see things \"bar\" does not belong to an AZ at all, only aggregates that explicitly define the AZ attribute \"belongs\" to an AZ (strictly speaking, only hosts in that aggregate belong to the AZ, but anyway).\n\nWhat makes a host belong to the default AZ? Simply that none of the aggregates it has been added to has the AZ attribute set. So, from your steps above, up until 3) node2 belongs to the default AZ and after 3) it only belongs to the AZ named \"az\", which also is what the \"nova availability-zone-list\" command shows.", 
            "date_created": "2016-02-21 13:58:02.969824+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanlind"
        }, 
        {
            "content": "As a newbie of OpenStack, I see the documentation[1] says that \"Host aggregates can be regarded as a mechanism to further partition an availability zone\". So it makes me believe that a host aggregate must belong to an availability zone in order to partition an AZ. \n\nAnd what you said \"the aggregate does not belong to an AZ at all if its AZ attribute is unset\" confuses me.\n\nYes, the internal representation shows that 'node2' is actually belongs to the AZ named \"az\". But I think the scheduler behavior in step 3) should be treated as a bug. It should be fixed by returning error in executing `nova aggregate-update foo foo az`, or by updating the AZ field of aggregate \"bar\" to \"az\".\n\n\n[1] http://docs.openstack.org/developer/nova/aggregates.html\n\n", 
            "date_created": "2016-02-21 14:56:53.088978+00:00", 
            "author": "https://api.launchpad.net/1.0/~cyx1231st"
        }, 
        {
            "content": "So, Hans is right but the model is maybe a bit confusing. Let me explain :\n\nThe default AZ (eg. \"nova\") defined by the default_availability_zone Opt is only for allowing the AZ REST resource to show all the hosts behind a single AZ if not set. That doesn't imply that the host is attached to an aggregate explicitely defined as an AZ for partitioning.\n\n", 
            "date_created": "2016-02-23 08:20:06.884138+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }
    ], 
    "closed": "2016-03-07 07:48:08.672251+00:00"
}