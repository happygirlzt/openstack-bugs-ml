{
    "status": "Won't Fix", 
    "last_updated": "2017-04-20 16:19:07.822185+00:00", 
    "description": "NOTE: (in comment #9) there is a proposed solution to fix this about dropping foreign keys. This will result in a broken data model that will prevent upgrade to Newton. Please use the solution in comment #8.\n\n\nHi everyone,\n\nI'm currently upgrading my openstack installation from kilo to liberty on Ubuntu 14.04 LTS.\n\nI have upgraded all packets fine and tried to update database:\nnova-manage db sync\n\nwhich fails complaining about the flavor not been migrated and so that I should run nova-manage db migrate_flavor_data before.\n\nI runned this command but then nova-manage complains that migrate_data_flavor is not a valid command.\n\nIs this a real bug ? Am I missing something ?\n\nFor the upgrade, I removed the kilo sources definition in /etc/apt/sources.list.d and then I add the apt repository using the command provided in the install documentation, after what I did an update, upgrade and dist-upgrade, forcing dpkg to keep old config.\n\nIf you need more informations, feel free to ask.\n\nI'll post more detailed informations by tomorrow.\n\nthanks in advance for your responses and sorry for not following the guidelines.", 
    "tags": [], 
    "importance": "Critical", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1511466", 
    "owner": "None", 
    "id": 1511466, 
    "index": 264, 
    "openned": "2015-10-29 16:59:00.103828+00:00", 
    "created": "2015-10-29 16:59:00.103828+00:00", 
    "title": "Kilo to Liberty: migrate flavor data impossible", 
    "comments": [
        {
            "content": "Hi everyone,\n\nI'm currently upgrading my openstack installation from kilo to liberty on Ubuntu 14.04 LTS.\n\nI have upgraded all packets fine and tried to update database:\nnova-manage db sync \n\nwhich fails complaining about the flavor not been migrated and so that I should run nova-manage db migrate_flavor_data before.\n\nI runned this command but then nova-manage complains that migrate_data_flavor is not a valid command.\n\nIs this a real bug ? Am I missing something ?\n\nFor the upgrade, I removed the kilo sources definition in /etc/apt/sources.list.d and then I add the apt repository using the command provided in the install documentation, after what I did an update, upgrade and dist-upgrade, forcing dpkg to keep old config.\n\nIf you need more informations, feel free to ask.\n\nI'll post more detailed informations by tomorrow.\n\nthanks in advance for your responses and sorry for not following the guidelines.", 
            "date_created": "2015-10-29 16:59:00.103828+00:00", 
            "author": "https://api.launchpad.net/1.0/~axellinkgm"
        }, 
        {
            "content": "Hi,\n\nsome informations :\n\n# dpkg -l | grep nova\nii  nova-api                            2:12.0.0-0ubuntu2~cloud0         all          OpenStack Compute - API frontend\nii  nova-cert                           2:12.0.0-0ubuntu2~cloud0         all          OpenStack Compute - certificate management\nii  nova-common                         2:12.0.0-0ubuntu2~cloud0         all          OpenStack Compute - common files\nii  nova-conductor                      2:12.0.0-0ubuntu2~cloud0         all          OpenStack Compute - conductor service\nii  nova-consoleauth                    2:12.0.0-0ubuntu2~cloud0         all          OpenStack Compute - Console Authenticator\nii  nova-scheduler                      2:12.0.0-0ubuntu2~cloud0         all          OpenStack Compute - virtual machine scheduler\nii  python-nova                         2:12.0.0-0ubuntu2~cloud0         all          OpenStack Compute Python libraries\nii  python-novaclient                   2:2.30.1-1~cloud0                all          client library for OpenStack Compute API\n\n# nova-mange db sync\n2015-10-30 09:06:46.364 4920 INFO migrate.versioning.api [-] 290 -> 291... \nCommand failed, please check log for more info\n2015-10-30 09:06:46.585 4920 CRITICAL nova [-] ValidationError: There are still 2 unmigrated flavor records. Migration cannot continue until all instance flavor records have been migrated to the new format. Please run `nova-manage db migrate_flavor_data' first.\n2015-10-30 09:06:46.585 4920 ERROR nova Traceback (most recent call last):\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n2015-10-30 09:06:46.585 4920 ERROR nova     sys.exit(main())\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 1443, in main\n2015-10-30 09:06:46.585 4920 ERROR nova     ret = fn(*fn_args, **fn_kwargs)\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 910, in sync\n2015-10-30 09:06:46.585 4920 ERROR nova     return migration.db_sync(version)\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 26, in db_sync\n2015-10-30 09:06:46.585 4920 ERROR nova     return IMPL.db_sync(version=version, database=database)\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 106, in db_sync\n2015-10-30 09:06:46.585 4920 ERROR nova     version)\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n2015-10-30 09:06:46.585 4920 ERROR nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"<string>\", line 2, in _migrate\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py\", line 160, in with_engine\n2015-10-30 09:06:46.585 4920 ERROR nova     return f(*a, **kw)\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 366, in _migrate\n2015-10-30 09:06:46.585 4920 ERROR nova     schema.runchange(ver, change, changeset.step)\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/schema.py\", line 93, in runchange\n2015-10-30 09:06:46.585 4920 ERROR nova     change.run(self.engine, step)\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/script/py.py\", line 148, in run\n2015-10-30 09:06:46.585 4920 ERROR nova     script_func(engine)\n2015-10-30 09:06:46.585 4920 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migrate_repo/versions/291_enforce_flavors_migrated.py\", line 35, in upgrade\n2015-10-30 09:06:46.585 4920 ERROR nova     raise exception.ValidationError(detail=msg)\n2015-10-30 09:06:46.585 4920 ERROR nova ValidationError: There are still 2 unmigrated flavor records. Migration cannot continue until all instance flavor records have been migrated to the new format. Please run `nova-manage db migrate_flavor_data' first.\n2015-10-30 09:06:46.585 4920 ERROR nova \n\n# nova-manage db migrate_flavor_data\nusage: nova-manage db [-h]\n                      {archive_deleted_rows,contract,expand,migrate,null_instance_uuid_scan,sync,version}\n                      ...\nnova-manage db: error: argument action: invalid choice: 'migrate_flavor_data' (choose from 'archive_deleted_rows', 'contract', 'expand', 'migrate', 'null_instance_uuid_scan', 'sync', 'version')\n", 
            "date_created": "2015-10-30 08:07:56.660762+00:00", 
            "author": "https://api.launchpad.net/1.0/~axellinkgm"
        }, 
        {
            "content": "Axel,\n\nreading the following:\nhttp://openstack.markmail.org/search/?q=migrate_flavor_data+order%3Adate-backward\nhttps://review.openstack.org/#/c/196911/\nhttps://review.openstack.org/#/c/198060/\n\nI believe, you should first get the controller to latest stable/kilo, run \"nova db migrate_flavor_data\" and THEN upgrade the code to Liberty.", 
            "date_created": "2015-11-08 17:30:55.608151+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "I did it, before going to upgrade I runned the migrate_flavor_data and made sure there was no instance left to upgrade. But as you can see in the error, there is still two instances that have to be migrated after update.\n\nThe solution for that was to delete every instances with the deleted state after the migrate_flavor_update and before going to liberty. Looks like two of the deleted VMs were not ignored by the db sync or completely ignored by migrate_flavor_data, I don't know how it is supposed to work.", 
            "date_created": "2015-11-09 07:34:00.029332+00:00", 
            "author": "https://api.launchpad.net/1.0/~axellinkgm"
        }, 
        {
            "content": "I see the same error:\n\n          ID: nova-manage db sync\n    Function: cmd.run\n        Name: nova-manage db sync; sleep 15\n      Result: True\n     Comment: Command \"nova-manage db sync; sleep 15\" run\n     Started: 18:07:09.511897\n    Duration: 17747.739 ms\n     Changes:   \n              ----------\n              pid:\n                  18000\n              retcode:\n                  0\n              stderr:\n                  No handlers could be found for logger \"oslo_config.cfg\"\n                  2016-01-26 18:07:12.092 18001 DEBUG migrate.versioning.repository [-] Loading repository /usr/lib/python2.7/dist-packages/nova/db/sql\nalchemy/migrate_repo... __init__ /usr/lib/python2.7/dist-packages/migrate/versioning/repository.py:76\n                  2016-01-26 18:07:12.093 18001 DEBUG migrate.versioning.script.base [-] Loading script /usr/lib/python2.7/dist-packages/nova/db/sqlalc\nhemy/migrate_repo/versions/216_havana.py... __init__ /usr/lib/python2.7/dist-packages/migrate/versioning/script/base.py:27\n[...]\n[...]\n[...]\n                  2016-01-26 18:07:12.157 18001 INFO migrate.versioning.api [-] 290 -> 291... \n                  2016-01-26 18:07:12.167 18001 CRITICAL nova [-] ValidationError: There are still 3 unmigrated flavor records. Migration cannot conti$\nue until all instance flavor records have been migrated to the new format. Please run `nova-manage db migrate_flavor_data' first.\n                  2016-01-26 18:07:12.167 18001 ERROR nova Traceback (most recent call last):\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n                  2016-01-26 18:07:12.167 18001 ERROR nova     sys.exit(main())\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 1443, in main\n                  2016-01-26 18:07:12.167 18001 ERROR nova     ret = fn(*fn_args, **fn_kwargs)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 910, in sync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return migration.db_sync(version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 26, in db_sync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return IMPL.db_sync(version=version, database=database)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 106, in db_$\nync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"<string>\", line 2, in _migrate\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py\", line 160, in \nwith_engine\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return f(*a, **kw)\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return migration.db_sync(version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 26, in db_sync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return IMPL.db_sync(version=version, database=database)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 106, in db_s\nync\n                  2016-01-26 18:07:12.167 18001 ERROR nova     version)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"<string>\", line 2, in _migrate\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/util/__init__.py\", line 160, in \nwith_engine\n                  2016-01-26 18:07:12.167 18001 ERROR nova     return f(*a, **kw)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 366, in _migrate\n                  2016-01-26 18:07:12.167 18001 ERROR nova     schema.runchange(ver, change, changeset.step)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/schema.py\", line 93, in runchan$\ne\n                  2016-01-26 18:07:12.167 18001 ERROR nova     change.run(self.engine, step)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/script/py.py\", line 148, in run\n                  2016-01-26 18:07:12.167 18001 ERROR nova     script_func(engine)\n                  2016-01-26 18:07:12.167 18001 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migrate_repo/versions/291_enfor$\ne_flavors_migrated.py\", line 35, in upgrade\n                  2016-01-26 18:07:12.167 18001 ERROR nova     raise exception.ValidationError(detail=msg)\n                  2016-01-26 18:07:12.167 18001 ERROR nova ValidationError: There are still 3 unmigrated flavor records. Migration cannot continue unt$\nl all instance flavor records have been migrated to the new format. Please run `nova-manage db migrate_flavor_data' first.\n                  2016-01-26 18:07:12.167 18001 ERROR nova\n              stdout:\n                  Command failed, please check log for more info\n----------\n \nUbuntu 14.04, cloud-archive:liberty.", 
            "date_created": "2016-01-26 17:25:09.548606+00:00", 
            "author": "https://api.launchpad.net/1.0/~0xf10e"
        }, 
        {
            "content": "By the way: There is no `nova-manage db migrate_flavor_data`:\n\nroot@controller:~# nova-manage db migrate_flavor_data\nNo handlers could be found for logger \"oslo_config.cfg\"\nusage: nova-manage db [-h]\n                      {archive_deleted_rows,contract,expand,migrate,null_instance_uuid_scan,sync,version}\n                      ...\nnova-manage db: error: argument action: invalid choice: 'migrate_flavor_data' (choose from 'archive_deleted_rows', 'contract', 'expand', 'migrate', 'null_instance_uuid_scan', 'sync', 'version')\nroot@controller:~# \n\n\nSo I tried :\nroot@controller:~# nova-manage db migrate\n[...]\n2016-01-26 19:03:43.055 19522 ERROR nova DatabaseMigrationError: Database migration failed: expand phase still has operations that need to be executed\n2016-01-26 19:03:43.055 19522 ERROR nova \nroot@controller:~# echo $?\n1\n\n\nSooo: \nroot@controller:~# nova-manage db expand\n[...]\n2016-01-26 19:05:16.959 19572 ERROR nova DatabaseMigrationError: Database migration failed: Cannot run 'db sync' until 'db contract' is run\n2016-01-26 19:05:16.959 19572 ERROR nova \nCommand failed, please check log for more info\nroot@controller:~#\n\n\nBUT:\nroot@controller:~# nova-manage db contract\nNo handlers could be found for logger \"oslo_config.cfg\"\nThe \"contract\" command is experimental and potentially dangerous. As such, it is disabled by default. Enable using \"--force-experimental\".\n\nroot@controller:~# nova-manage db  contract --force-experimental\n[...]\n2016-01-26 19:06:14.357 19618 INFO alembic.runtime.migration [-] Context impl MySQLImpl.\n2016-01-26 19:06:14.357 19618 INFO alembic.runtime.migration [-] Will assume non-transactional DDL.\nCommand failed, please check log for more info\n2016-01-26 19:06:15.449 19618 CRITICAL nova [-] TypeError: expected string or buffer\n2016-01-26 19:06:15.449 19618 ERROR nova Traceback (most recent call last):\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n2016-01-26 19:06:15.449 19618 ERROR nova     sys.exit(main())\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 1443, in main\n2016-01-26 19:06:15.449 19618 ERROR nova     ret = fn(*fn_args, **fn_kwargs)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 932, in contract\n2016-01-26 19:06:15.449 19618 ERROR nova     return migration.db_contract(dry_run)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 41, in db_contract\n2016-01-26 19:06:15.449 19618 ERROR nova     return IMPL.db_contract(dryrun=dryrun, database=database)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 1069, in db_contract\n2016-01-26 19:06:15.449 19618 ERROR nova     _set_db_sync_version(repository, repository.latest)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 87, in _set_db_sync_version\n2016-01-26 19:06:15.449 19618 ERROR nova     values(version=version).execute()\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/sql/base.py\", line 386, in execute\n2016-01-26 19:06:15.449 19618 ERROR nova     return e._execute_clauseelement(self, multiparams, params)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1998, in _execute_clauseelement\n2016-01-26 19:06:15.449 19618 ERROR nova     return connection._execute_clauseelement(elem, multiparams, params)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n2016-01-26 19:06:15.449 19618 ERROR nova     compiled_sql, distilled_params\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n2016-01-26 19:06:15.449 19618 ERROR nova     context)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1337, in _handle_dbapi_exception\n2016-01-26 19:06:15.449 19618 ERROR nova     util.raise_from_cause(newraise, exc_info)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 199, in raise_from_cause\n2016-01-26 19:06:15.449 19618 ERROR nova     reraise(type(exception), exception, tb=exc_tb)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n2016-01-26 19:06:15.449 19618 ERROR nova     context)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n2016-01-26 19:06:15.449 19618 ERROR nova     cursor.execute(statement, parameters)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/pymysql/cursors.py\", line 130, in execute\n2016-01-26 19:06:15.449 19618 ERROR nova     query = query % self._escape_args(args, conn)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/pymysql/cursors.py\", line 96, in _escape_args\n2016-01-26 19:06:15.449 19618 ERROR nova     return tuple(conn.escape(arg) for arg in args)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/pymysql/cursors.py\", line 96, in <genexpr>\n2016-01-26 19:06:15.449 19618 ERROR nova     return tuple(conn.escape(arg) for arg in args)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/pymysql/connections.py\", line 690, in escape\n2016-01-26 19:06:15.449 19618 ERROR nova     return escape_item(obj, self.charset)\n2016-01-26 19:06:15.449 19618 ERROR nova   File \"/usr/lib/python2.7/dist-packages/pymysql/converters.py\", line 24, in escape_item\n2016-01-26 19:06:15.449 19618 ERROR nova     encoder = encoders[type(val)]\n2016-01-26 19:06:15.449 19618 ERROR nova TypeError: expected string or buffer\n2016-01-26 19:06:15.449 19618 ERROR nova \nroot@controller:~#\n\nKnown 'workarounds\":\n * delete the offending flavors by hand\n * drop the whole nova DB", 
            "date_created": "2016-01-26 18:22:13.102522+00:00", 
            "author": "https://api.launchpad.net/1.0/~0xf10e"
        }, 
        {
            "content": "This is a curious situation:\n\nWe are upgrading so server is not 'bootable' but we should be done:\n\nnova db migrate_flavor_data\n\n@Florian is not nova-manage one. I suppose he's referring to nova db command. But I'm not sure.\n\nBut the migration tool is not able to handle the migration. M\n\nThere are still 12 unmigrated flavor records. Migration cannot continue until all instance flavor records have been migrated to the new format. Please run `nova-manage db migrate_flavor_data' first.\n\nThe message is for this command:\nnova-manage db migrate_flavor_data\n\nusage: nova-manage db [-h]\n                      {archive_deleted_rows,null_instance_uuid_scan,online_data_migrations,sync,version}\n                      ...\nnova-manage db: error: argument action: invalid choice: 'migrate_flavor_data' (choose from 'archive_deleted_rows', 'null_instance_uuid_scan', 'online_data_migrations', 'sync', 'version')\n\n", 
            "date_created": "2016-04-18 00:00:30.862827+00:00", 
            "author": "https://api.launchpad.net/1.0/~gad-aguilardelgado"
        }, 
        {
            "content": "Hi I found this:\nhttp://www.danplanet.com/blog/2015/06/26/upgrading-nova-to-kilo-with-minimal-downtime/\n\nIn fact it should be without the db but is not working either...", 
            "date_created": "2016-04-18 00:04:20.348168+00:00", 
            "author": "https://api.launchpad.net/1.0/~gad-aguilardelgado"
        }, 
        {
            "content": "Hi again, \n\nThis is what I did. I cloned nova kilo from source repository. \n\nI copied the directory nova and all its contents to the controller node machine. \nI moved the original nova libs from /usr/lib/python2.7/dist-packages/nova to /usr/lib/python2.7/dist-packages/nova.mitaka\nAnd linked /home/ubuntu/nova /usr/lib/python2.7/dist-packages/nova\n\nthen I ran the command and voil\u00e0:\n\n\nroot@jb4ja:/usr/lib/python2.7/dist-packages# su -s /bin/sh -c \"nova-manage db migrate_flavor_data\" nova\n/usr/lib/python2.7/dist-packages/sqlalchemy/sql/compiler.py:572: SAWarning: Can't resolve label reference 'deleted'; converting to text() (this warning may be suppressed after 10 occurrences)\n  util.ellipses_string(element.element))\n/usr/lib/python2.7/dist-packages/sqlalchemy/sql/compiler.py:572: SAWarning: Can't resolve label reference 'id'; converting to text() (this warning may be suppressed after 10 occurrences)\n  util.ellipses_string(element.element))\n12 instances matched query, 12 completed\n\nThen I reverted the change from nova.mitaka to nova. \n\nIt seems that sync can continue now...", 
            "date_created": "2016-04-18 00:21:50.978672+00:00", 
            "author": "https://api.launchpad.net/1.0/~gad-aguilardelgado"
        }, 
        {
            "content": "The solution from Axel Vanzaghi worked also for me. \n\nHowever to delete the rows I had to disable FOREIGN_KEY_CHECKS\n\nSET FOREIGN_KEY_CHECKS=0;\ndelete from instances where vm_state='deleted';\nSET FOREIGN_KEY_CHECKS=1;\n\nIf anyone has a more clean solution for this, please share :)\n\nSaverio", 
            "date_created": "2016-09-08 08:57:46.660370+00:00", 
            "author": "https://api.launchpad.net/1.0/~zioproto"
        }, 
        {
            "content": "For those that will find this bug and wonder why you should delete instances in 'deleted' state, I found that our issue was related to rows/instances that were manually deleted in the database by setting the deleted field to 0 instead of the instance id.\n\nThe sanity check assumes that instances are deleted if instances.deleted=instances.id and fails if it finds occurrences that doesn't match this expectation.\n\nYou can find those occurrences with this query:\n\nSELECT instances.uuid,\n       instances.id,\n       instances.deleted\nFROM instances,\n     instance_system_metadata\nWHERE instances.uuid = instance_system_metadata.instance_uuid\n  AND instance_system_metadata.key = 'instance_type_id'\n  AND instance_system_metadata.deleted != instance_system_metadata.id\n  AND instances.deleted != instances.id\n  AND instances.deleted != 0;\n\nAll you need to do is update the affected rows (only) accordingly by setting instances.deleted=instances.id\n\nFriendly reminder, make sure you run the flavor migration (nova-manage db migrate_flavor_data) BEFORE updating to OpenStack Liberty or later as the command no longer exist in OpenStack Liberty and later, despite the error message suggesting to run it.", 
            "date_created": "2017-03-14 17:19:21.951067+00:00", 
            "author": "https://api.launchpad.net/1.0/~mgagne"
        }, 
        {
            "content": "In fact, you should make sure all instances.deleted==instances.id if instances.deleted != 0, not just the ones affected by the flavor migration sanity check.", 
            "date_created": "2017-03-14 17:23:29.656924+00:00", 
            "author": "https://api.launchpad.net/1.0/~mgagne"
        }, 
        {
            "content": "For anyone who applied the change in comment #9 to their database, you have broken the data model severely and will in all likelihood set yourself up for bug 1684861, among others. If you haven't yet done it DO NOT DO IT.", 
            "date_created": "2017-04-20 15:57:54.017840+00:00", 
            "author": "https://api.launchpad.net/1.0/~danms"
        }, 
        {
            "content": "Closing this out because it's a Liberty issue, which we can't fix any more.", 
            "date_created": "2017-04-20 16:19:06.745667+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ], 
    "closed": "2017-04-20 16:18:27.885888+00:00"
}