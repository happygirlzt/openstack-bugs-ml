{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 09:04:49.417294+00:00", 
    "description": "The exception occurs when trying to create/delete an instance that is using a network that is not owned by the admin tenant. This prevents the deletion of the instance.\n\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 90, in wrapped\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 73, in wrapped\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 243, in decorated_function\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     pass\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 229, in decorated_function\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 294, in decorated_function\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     function(self, context, *args, **kwargs)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 271, in decorated_function\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 258, in decorated_function\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1616, in run_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     do_run_instance()\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/lockutils.py\", line 246, in inner\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kwargs)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1615, in do_run_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     legacy_bdm_in_spec)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 965, in _run_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     notify(\"error\", msg=unicode(e))  # notify that build failed\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 949, in _run_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     instance, image_meta, legacy_bdm_in_spec)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1078, in _build_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     filter_properties, bdms, legacy_bdm_in_spec)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1122, in _reschedule_or_error\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     self._log_original_error(exc_info, instance_uuid)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1117, in _reschedule_or_error\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     bdms, requested_networks)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1642, in _shutdown_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     network_info = self._get_instance_nw_info(context, instance)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 879, in _get_instance_nw_info\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     instance)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 455, in get_instance_nw_info\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     result = self._get_instance_nw_info(context, instance, networks)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 463, in _get_instance_nw_info\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     nw_info = self._build_network_info_model(context, instance, networks)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 1009, in _build_network_info_model\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     subnets)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 962, in _nw_info_build_network\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     label=network_name,\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp UnboundLocalError: local variable 'network_name' referenced before assignment", 
    "tags": [
        "havana-backport-potential", 
        "in-stable-havana"
    ], 
    "importance": "High", 
    "heat": 136, 
    "link": "https://bugs.launchpad.net/nova/+bug/1246258", 
    "owner": "https://api.launchpad.net/1.0/~garyk", 
    "id": 1246258, 
    "index": 1292, 
    "openned": "2013-10-30 10:53:53.083569+00:00", 
    "created": "2013-10-30 10:53:53.083569+00:00", 
    "title": "UnboundLocalError: local variable 'network_name' referenced before assignment", 
    "comments": [
        {
            "content": "The exception occurs when trying to create/delete an instance that is using a network that is not owned by the admin tenant. This prevents the deletion of the instance.\n\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 90, in wrapped\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 73, in wrapped\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 243, in decorated_function\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     pass\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 229, in decorated_function\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 294, in decorated_function\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     function(self, context, *args, **kwargs)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 271, in decorated_function\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 258, in decorated_function\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1616, in run_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     do_run_instance()\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/lockutils.py\", line 246, in inner\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     return f(*args, **kwargs)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1615, in do_run_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     legacy_bdm_in_spec)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 965, in _run_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     notify(\"error\", msg=unicode(e))  # notify that build failed\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 949, in _run_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     instance, image_meta, legacy_bdm_in_spec)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1078, in _build_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     filter_properties, bdms, legacy_bdm_in_spec)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1122, in _reschedule_or_error\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     self._log_original_error(exc_info, instance_uuid)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1117, in _reschedule_or_error\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     bdms, requested_networks)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1642, in _shutdown_instance\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     network_info = self._get_instance_nw_info(context, instance)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 879, in _get_instance_nw_info\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     instance)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 455, in get_instance_nw_info\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     result = self._get_instance_nw_info(context, instance, networks)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 463, in _get_instance_nw_info\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     nw_info = self._build_network_info_model(context, instance, networks)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 1009, in _build_network_info_model\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     subnets)\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 962, in _nw_info_build_network\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp     label=network_name,\n2013-10-29 00:51:36.173 18588 TRACE nova.openstack.common.rpc.amqp UnboundLocalError: local variable 'network_name' referenced before assignment", 
            "date_created": "2013-10-30 10:53:53.083569+00:00", 
            "author": "https://api.launchpad.net/1.0/~garyk"
        }, 
        {
            "content": "https://review.openstack.org/#/c/54521/", 
            "date_created": "2013-10-30 11:24:39.276660+00:00", 
            "author": "https://api.launchpad.net/1.0/~garyk"
        }, 
        {
            "content": "Workaround?", 
            "date_created": "2013-11-07 10:49:06.986012+00:00", 
            "author": "https://api.launchpad.net/1.0/~sheldonh"
        }, 
        {
            "content": "This trap is really easy to fall into, because neutron net-create doesn't seem to validate the --tenant-id argument:\n\n# neutron net-create --tenant-id admin                            demo-net\nCreated a new network:\n+---------------------------+--------------------------------------+\n| Field                     | Value                                |\n+---------------------------+--------------------------------------+\n| admin_state_up            | True                                 |\n| id                        | 427d4260-b246-4789-b543-58ce1e86b51c |\n| name                      | demo-net                             |\n| provider:network_type     | gre                                  |\n| provider:physical_network |                                      |\n| provider:segmentation_id  | 1                                    |\n| shared                    | False                                |\n| status                    | ACTIVE                               |\n| subnets                   |                                      |\n| tenant_id                 | admin                                |\n+---------------------------+--------------------------------------+\n\nSo you end up with a poison network that breaks the metadata service. Recovery isn't an obvious process. You have to start by deleting the ports that connect affected instances into the poison network. Then you can delete the subnet and finally the network.", 
            "date_created": "2013-11-07 11:57:38.208775+00:00", 
            "author": "https://api.launchpad.net/1.0/~sheldonh"
        }, 
        {
            "content": "Does this bug manifest when the instance is connected to a network in a correctly identified tenant that is not the admin tenant, or is it only when the network is not in a correctly identified tenant (as per comment #3)?", 
            "date_created": "2013-11-08 11:02:09.398828+00:00", 
            "author": "https://api.launchpad.net/1.0/~sheldonh"
        }, 
        {
            "content": "Here simple patch which allow to remove instances with incorrect network interconnection.\n\nProblem splited into two pieces:\n1) Disallow using other tenant's networks for different tenant's instances.\n2) Allow gracefully remove them.\n\nThis patch fix only 2nd problem.", 
            "date_created": "2014-01-23 21:41:55.737012+00:00", 
            "author": "https://api.launchpad.net/1.0/~george-shuklin"
        }, 
        {
            "content": "... and I think this bug should be backported to havanna, because any guy who play with API can stuck with undeletable instances.", 
            "date_created": "2014-01-23 21:42:56.998865+00:00", 
            "author": "https://api.launchpad.net/1.0/~george-shuklin"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/54521\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b12da559b6a40fba4e4431d74372b5e350047525\nSubmitter: Jenkins\nBranch:    master\n\ncommit b12da559b6a40fba4e4431d74372b5e350047525\nAuthor: Gary Kotton <email address hidden>\nDate:   Wed Oct 30 04:21:53 2013 -0700\n\n    Fix bug for neutron network-name\n    \n    There may be cases when the network-name is not updated correctly\n    due to the requested networks not being owned by the tenant.\n    \n    In the case when there is no matched network we use the details\n    from the used port.\n    \n    A failed deletion of a port will raise an exception. If the\n    port is not found no exception will be raised.\n    \n    Co-authored-by: Evgeny Fedoruk <email address hidden>\n    \n    Change-Id: Ie28e88ec9a9c7a180410ae5e57f84b1f653bbffc\n    Closes-Bug: #1246258\n", 
            "date_created": "2014-01-26 05:17:54.072501+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/69289", 
            "date_created": "2014-01-27 06:51:24.746559+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/69289\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=5b0a13146d736adf5ca70649c7e17037b14a3d7d\nSubmitter: Jenkins\nBranch:    stable/havana\n\ncommit 5b0a13146d736adf5ca70649c7e17037b14a3d7d\nAuthor: Gary Kotton <email address hidden>\nDate:   Wed Oct 30 04:21:53 2013 -0700\n\n    Fix bug for neutron network-name\n    \n    There may be cases when the network-name is not updated correctly\n    due to the requested networks not being owned by the tenant.\n    \n    In the case when there is no matched network we use the details\n    from the used port.\n    \n    A failed deletion of a port will raise an exception. If the\n    port is not found no exception will be raised.\n    \n    Co-authored-by: Evgeny Fedoruk <email address hidden>\n    \n    Closes-Bug: #1246258\n    (cherry picked from commit b12da559b6a40fba4e4431d74372b5e350047525)\n    \n    Conflicts:\n    \tnova/tests/network/test_neutronv2.py\n    \n    Change-Id: Ie28e88ec9a9c7a180410ae5e57f84b1f653bbffc\n", 
            "date_created": "2014-01-30 14:25:53.930098+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-03-05 13:07:29.473119+00:00"
}