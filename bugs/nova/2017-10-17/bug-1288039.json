{
    "status": "Fix Released", 
    "last_updated": "2016-01-21 23:19:38.014264+00:00", 
    "description": "When nova goes to cleanup _post_live_migration on the source host, the block_device_mapping has incorrect data.\n\nI can reproduce this 100% of the time with a cinder iSCSI backend, such as 3PAR.  \n\nThis is a Fresh install on 2 new servers with no attached storage from Cinder and no VMs.\nI create a cinder volume from an image. \nI create a VM booted from that Cinder volume.  That vm shows up on host1 with a LUN id of 0.\nI live migrate that vm.   The vm moves to host 2 and has a LUN id of 0.   The LUN on host1 is now gone.\n\nI create another cinder volume from image.\nI create another VM booted from the 2nd cinder volume.  The vm shows up on host1 with a LUN id of 0.  \nI live migrate that vm.  The VM moves to host 2 and has a LUN id of 1.  \n_post_live_migrate is called on host1 to clean up, and gets failures, because it's asking cinder to delete the volume\non host1 with a target_lun id of 1, which doesn't exist.  It's supposed to be asking cinder to detach LUN 0.\n\nFirst migrate\nHOST2\n2014-03-04 19:02:07.870 WARNING nova.compute.manager [req-24521cb1-8719-4bc5-b488-73a4980d7110 admin admin] pre_live_migrate: {'block_device_mapping': [{'guest_format': None, 'boot_index': 0, 'mount_device': u'vda', 'connection_info': {u'd\nriver_volume_type': u'iscsi', 'serial': u'83fb6f13-905e-45f8-a465-508cb343b721', u'data': {u'target_discovered': True, u'qos_specs': None, u'target_iqn': u'iqn.2000-05.com.3pardata:20810002ac00383d', u'target_portal': u'10.10.120.253:3260'\n, u'target_lun': 0, u'access_mode': u'rw'}}, 'disk_bus': u'virtio', 'device_type': u'disk', 'delete_on_termination': False}]}\nHOST1\n2014-03-04 19:02:16.775 WARNING nova.compute.manager [-] _post_live_migration: block_device_info {'block_device_mapping': [{'guest_format': None, 'boot_index': 0, 'mount_device': u'vda', 'connection_info': {u'driver_volume_type': u'iscsi',\n u'serial': u'83fb6f13-905e-45f8-a465-508cb343b721', u'data': {u'target_discovered': True, u'qos_specs': None, u'target_iqn': u'iqn.2000-05.com.3pardata:20810002ac00383d', u'target_portal': u'10.10.120.253:3260', u'target_lun': 0, u'access_mode': u'rw'}}, 'disk_bus': u'virtio', 'device_type': u'disk', 'delete_on_termination': False}]}\n\n\n\n\n\nSecond Migration\nThis is in _post_live_migration on the host1.  It calls libvirt's driver.py post_live_migration with the volume information returned from the new volume on host2, hence the target_lun = 1.   It should be calling libvirt's driver.py to clean up the original volume on the source host, which has a target_lun = 0.\n2014-03-04 19:24:51.626 WARNING nova.compute.manager [-] _post_live_migration: block_device_info {'block_device_mapping': [{'guest_format': None, 'boot_index': 0, 'mount_device': u'vda', 'connection_info': {u'driver_volume_type': u'iscsi', u'serial': u'f0087595-804d-4bdb-9bad-0da2166313ea', u'data': {u'target_discovered': True, u'qos_specs': None, u'target_iqn': u'iqn.2000-05.com.3pardata:20810002ac00383d', u'target_portal': u'10.10.120.253:3260', u'target_lun': 1, u'access_mode': u'rw'}}, 'disk_bus': u'virtio', 'device_type': u'disk', 'delete_on_termination': False}]}", 
    "tags": [
        "compute", 
        "in-stable-juno", 
        "in-stable-kilo", 
        "libvirt", 
        "live-migrate", 
        "migration", 
        "volumes"
    ], 
    "importance": "High", 
    "heat": 32, 
    "link": "https://bugs.launchpad.net/nova/+bug/1288039", 
    "owner": "https://api.launchpad.net/1.0/~anthony-mic-lee", 
    "id": 1288039, 
    "index": 1413, 
    "openned": "2014-03-05 03:45:21.204506+00:00", 
    "created": "2014-03-05 03:45:21.204506+00:00", 
    "title": "live-migration cinder boot volume target_lun id incorrect", 
    "comments": [
        {
            "content": "When nova goes to cleanup _post_live_migration on the source host, the block_device_mapping has incorrect data.\n\nI can reproduce this 100% of the time with a cinder iSCSI backend, such as 3PAR.  \n\nThis is a Fresh install on 2 new servers with no attached storage from Cinder and no VMs.\nI create a cinder volume from an image. \nI create a VM booted from that Cinder volume.  That vm shows up on host1 with a LUN id of 0.\nI live migrate that vm.   The vm moves to host 2 and has a LUN id of 0.   The LUN on host1 is now gone.\n\nI create another cinder volume from image.\nI create another VM booted from the 2nd cinder volume.  The vm shows up on host1 with a LUN id of 0.  \nI live migrate that vm.  The VM moves to host 2 and has a LUN id of 1.  \n_post_live_migrate is called on host1 to clean up, and gets failures, because it's asking cinder to delete the volume\non host1 with a target_lun id of 1, which doesn't exist.  It's supposed to be asking cinder to detach LUN 0.\n\nFirst migrate\nHOST2\n2014-03-04 19:02:07.870 WARNING nova.compute.manager [req-24521cb1-8719-4bc5-b488-73a4980d7110 admin admin] pre_live_migrate: {'block_device_mapping': [{'guest_format': None, 'boot_index': 0, 'mount_device': u'vda', 'connection_info': {u'd\nriver_volume_type': u'iscsi', 'serial': u'83fb6f13-905e-45f8-a465-508cb343b721', u'data': {u'target_discovered': True, u'qos_specs': None, u'target_iqn': u'iqn.2000-05.com.3pardata:20810002ac00383d', u'target_portal': u'10.10.120.253:3260'\n, u'target_lun': 0, u'access_mode': u'rw'}}, 'disk_bus': u'virtio', 'device_type': u'disk', 'delete_on_termination': False}]}\nHOST1\n2014-03-04 19:02:16.775 WARNING nova.compute.manager [-] _post_live_migration: block_device_info {'block_device_mapping': [{'guest_format': None, 'boot_index': 0, 'mount_device': u'vda', 'connection_info': {u'driver_volume_type': u'iscsi',\n u'serial': u'83fb6f13-905e-45f8-a465-508cb343b721', u'data': {u'target_discovered': True, u'qos_specs': None, u'target_iqn': u'iqn.2000-05.com.3pardata:20810002ac00383d', u'target_portal': u'10.10.120.253:3260', u'target_lun': 0, u'access_mode': u'rw'}}, 'disk_bus': u'virtio', 'device_type': u'disk', 'delete_on_termination': False}]}\n\n\n\n\n\nSecond Migration\nThis is in _post_live_migration on the host1.  It calls libvirt's driver.py post_live_migration with the volume information returned from the new volume on host2, hence the target_lun = 1.   It should be calling libvirt's driver.py to clean up the original volume on the source host, which has a target_lun = 0.\n2014-03-04 19:24:51.626 WARNING nova.compute.manager [-] _post_live_migration: block_device_info {'block_device_mapping': [{'guest_format': None, 'boot_index': 0, 'mount_device': u'vda', 'connection_info': {u'driver_volume_type': u'iscsi', u'serial': u'f0087595-804d-4bdb-9bad-0da2166313ea', u'data': {u'target_discovered': True, u'qos_specs': None, u'target_iqn': u'iqn.2000-05.com.3pardata:20810002ac00383d', u'target_portal': u'10.10.120.253:3260', u'target_lun': 1, u'access_mode': u'rw'}}, 'disk_bus': u'virtio', 'device_type': u'disk', 'delete_on_termination': False}]}", 
            "date_created": "2014-03-05 03:45:21.204506+00:00", 
            "author": "https://api.launchpad.net/1.0/~walter-boring"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/79368", 
            "date_created": "2014-03-10 17:02:29.832611+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi Walt,\n\nI am not able to reproduce this issue with the latest master code. Is it still reproducible ?", 
            "date_created": "2014-09-15 14:13:40.044490+00:00", 
            "author": "https://api.launchpad.net/1.0/~ankitagrawal"
        }, 
        {
            "content": "Change abandoned by Sean Dague (<email address hidden>) on branch: master\nReview: https://review.openstack.org/79368\nReason: This review is > 4 weeks without comment, and failed Jenkins the last time it was checked. We are abandoning this for now. Feel free to reactivate the review by pressing the restore button and leaving a 'recheck' comment to get fresh test results.", 
            "date_created": "2014-11-20 15:26:02.731912+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/211051", 
            "date_created": "2015-08-10 09:03:27.317511+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/202770\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8b649aa86fb26e998d66e75e5cebfd19c396942d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8b649aa86fb26e998d66e75e5cebfd19c396942d\nAuthor: Anthony Lee <email address hidden>\nDate:   Thu Jul 16 13:02:00 2015 -0700\n\n    Fix live-migrations usage of the wrong connector information\n    \n    During the post_live_migration step for the Nova libvirt driver\n    an incorrect assumption is being made about the connector\n    information being sent to _disconnect_volume. It is assumed that\n    the connection information on the source and destination is the\n    same but that is not always the case. The BDM, where the\n    connector information is being retrieved from only contains the\n    connection information for the destination. This will not work\n    when trying to disconnect volumes from the source during live\n    migration as the properties such as the target_lun and\n    initiator_target_map could be different. This ends up leaving\n    behind dangling LUNs and possibly removing the incorrect\n    volume's LUNs.\n    \n    The solution proposed here utilizes the connection_info that\n    can be retrieved for a host from Cinder's initialize_connection\n    API. This connection information contains the correct data for\n    the source host and allows volume LUNs to be removed properly.\n    \n    Change-Id: I3dfb75eb58dfbc66b218bcee473af4c2ac282eb6\n    Closes-Bug: #1475411\n    Closes-Bug: #1288039\n    Closes-Bug: #1423772\n", 
            "date_created": "2015-08-10 11:30:17.775163+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/211051\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=587092c909e15e983f7aef31d7bc0862271a32c7\nSubmitter: Jenkins\nBranch:    stable/kilo\n\ncommit 587092c909e15e983f7aef31d7bc0862271a32c7\nAuthor: Anthony Lee <email address hidden>\nDate:   Thu Jul 16 13:02:00 2015 -0700\n\n    Fix live-migrations usage of the wrong connector information\n    \n    During the post_live_migration step for the Nova libvirt driver\n    an incorrect assumption is being made about the connector\n    information being sent to _disconnect_volume. It is assumed that\n    the connection information on the source and destination is the\n    same but that is not always the case. The BDM, where the\n    connector information is being retrieved from only contains the\n    connection information for the destination. This will not work\n    when trying to disconnect volumes from the source during live\n    migration as the properties such as the target_lun and\n    initiator_target_map could be different. This ends up leaving\n    behind dangling LUNs and possibly removing the incorrect\n    volume's LUNs.\n    \n    The solution proposed here utilizes the connection_info that\n    can be retrieved for a host from Cinder's initialize_connection\n    API. This connection information contains the correct data for\n    the source host and allows volume LUNs to be removed properly.\n    \n    --\n    \n    NOTE(sahid): The TODO comment in the original change on master is\n    omitted here since os-brick wasn't used by nova in kilo so leaving\n    it in the backport would be confusing.\n    \n    Change-Id: I3dfb75eb58dfbc66b218bcee473af4c2ac282eb6\n    Closes-Bug: #1475411\n    Closes-Bug: #1288039\n    Closes-Bug: #1423772\n", 
            "date_created": "2015-08-19 00:44:22.391925+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/228517", 
            "date_created": "2015-09-28 16:06:03.945743+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/228517\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=9d2abbd9ab60ca873650759feaba98b4d8d35566\nSubmitter: Jenkins\nBranch:    stable/juno\n\ncommit 9d2abbd9ab60ca873650759feaba98b4d8d35566\nAuthor: Anthony Lee <email address hidden>\nDate:   Thu Jul 16 13:02:00 2015 -0700\n\n    Fix live-migrations usage of the wrong connector information\n    \n    During the post_live_migration step for the Nova libvirt driver\n    an incorrect assumption is being made about the connector\n    information being sent to _disconnect_volume. It is assumed that\n    the connection information on the source and destination is the\n    same but that is not always the case. The BDM, where the\n    connector information is being retrieved from only contains the\n    connection information for the destination. This will not work\n    when trying to disconnect volumes from the source during live\n    migration as the properties such as the target_lun and\n    initiator_target_map could be different. This ends up leaving\n    behind dangling LUNs and possibly removing the incorrect\n    volume's LUNs.\n    \n    The solution proposed here utilizes the connection_info that\n    can be retrieved for a host from Cinder's initialize_connection\n    API. This connection information contains the correct data for\n    the source host and allows volume LUNs to be removed properly.\n    \n    Conflicts:\n            nova/tests/unit/virt/libvirt/test_driver.py\n    \n    NOTE(mriedem): The conflicts are due to the tests being moved\n    in Kilo and 41f80226e0a1f73af76c7968617ebfda0aeb40b1 not being\n    in stable/juno (renamed conn var to drvr in libvirt tests).\n    \n    Change-Id: I3dfb75eb58dfbc66b218bcee473af4c2ac282eb6\n    Closes-Bug: #1475411\n    Closes-Bug: #1288039\n    Closes-Bug: #1423772\n    (cherry picked from commit 587092c909e15e983f7aef31d7bc0862271a32c7)\n", 
            "date_created": "2015-09-28 19:20:02.241636+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-09-03 11:43:03.617123+00:00"
}