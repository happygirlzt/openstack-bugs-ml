{
    "status": "Invalid", 
    "last_updated": "2015-06-12 20:59:50.846030+00:00", 
    "description": "When using keystone V3 authentication for cinder and nova (see comment #3), I got error \"BadRequest: Malformed request url (HTTP 400)\".\nI am testing on Juno release, my keystone v3 env is like this,\n\nexport OS_USERNAME=\"admin\"\nexport OS_PASSWORD=\"password\"\nexport OS_DOMAIN_NAME=default\nexport OS_AUTH_URL=\"http://$MY_HOST:35357/v3\"\nexport OS_IDENTITY_API_VERSION=3\n\nMy endpoint of cinder public URL is like http://**.**.**.**:8776/v1/cbe4b1d87fbb4318be379a79a570b7ec (I hided the real IP)\nWhen run command \"openstack --debug volume list\" or \"openstack --debug volume create --size 1 jin\", I got this BadRequest error. From debug info, this error comes from cinder server. I added log in cinder/api/openstack/wsgi.py function _process_stack(), found the context.project_id is None while project_id has a value, here return the error.\n\nif (context and project_id and (project_id != context.project_id)):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0msg = _(\"Malformed request url\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return Fault(webob.exc.HTTPBadRequest(explanation=msg))\n\nI compared with another keystone V2 authentication server, the context.project_id is same as project_id. Maybe this is difference, in v2 server the REQ has one more Project-id like \"curl -i -H \"X-Auth-Project-Id: admin\".\nI found the cinder.context maybe come from cinder/api/middleware/auth.py, the project_id in cinder.context may not be assigned a value in keystone v3 authentication scenario.\n\nERROR log is as below:\n\nREQ: curl -i http://**.**.**.**:8776/v1/cbe4b1d87fbb4318be379a79a570b7ec/volumes/detail -X GET -H \"User-Agent: python-cinderclient\" -H \"Accept: application/json\" -H \"X-Auth-Token: e883e05a887144d4ae70151c976ce666\"\n\nINFO: requests.packages.urllib3.connectionpool Starting new HTTP connection (1): **.**.**.**\nDEBUG: requests.packages.urllib3.connectionpool \"GET /v1/cbe4b1d87fbb4318be379a79a570b7ec/volumes/detail HTTP/1.1\" 400 65\nDEBUG: cinderclient.client RESP: [400] {'date': 'Thu, 09 Apr 2015 00:35:30 GMT', 'content-length': '65', 'content-type': 'application/json; charset=UTF-8', 'x-compute-request-id': 'req-39a96150-b9ab-4753-8b02-d5730492b288', 'x-openstack-request-id': 'req-39a96150-b9ab-4753-8b02-d5730492b288'}\nRESP BODY: {\"badRequest\": {\"message\": \"Malformed request url\", \"code\": 400}}\n\nERROR: openstack Malformed request url (HTTP 400) (Request-ID: req-39a96150-b9ab-4753-8b02-d5730492b288)\nTraceback (most recent call last):\n\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/cliff/app.py\", line 280, in run_subcommand\n\u00a0\u00a0\u00a0\u00a0result = cmd.run(parsed_args)\n\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/cliff/display.py\", line 91, in run\n\u00a0\u00a0\u00a0\u00a0column_names, data = self.take_action(parsed_args)\n\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/openstackclient/volume/v1/volume.py\", line 255, in take_action\n\u00a0\u00a0\u00a0\u00a0data = volume_client.volumes.list(search_opts=search_opts)\n\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/cinderclient/v1/volumes.py\", line 220, in list\n\u00a0\u00a0\u00a0\u00a0\"volumes\")\n\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/cinderclient/base.py\", line 70, in _list\n\u00a0\u00a0\u00a0\u00a0resp, body = self.api.client.get(url)\n\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 302, in get\n\u00a0\u00a0\u00a0\u00a0return self._cs_request(url, 'GET', **kwargs)\n\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 269, in _cs_request\n\u00a0\u00a0\u00a0\u00a0**kwargs)\n\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 252, in request\n\u00a0\u00a0\u00a0\u00a0raise exceptions.from_response(resp, body)\nBadRequest: Malformed request url (HTTP 400) (Request-ID: req-39a96150-b9ab-4753-8b02-d5730492b288)", 
    "tags": [
        "api", 
        "low-hanging-fruit"
    ], 
    "importance": "Low", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1441922", 
    "owner": "None", 
    "id": 1441922, 
    "index": 1676, 
    "openned": "2015-04-10 17:11:49.196759+00:00", 
    "created": "2015-04-09 01:03:44.250438+00:00", 
    "title": "Keystone V3 authentication return BadRequest: Malformed request url", 
    "comments": [
        {
            "content": "When using keystone V3 authentication for cinder, I got error \"BadRequest: Malformed request url (HTTP 400)\".\nI am testing on Juno release, my keystone v3 env is like this,\n\nexport OS_USERNAME=\"admin\"\nexport OS_PASSWORD=\"password\"\nexport OS_DOMAIN_NAME=default\nexport OS_AUTH_URL=\"http://$MY_HOST:35357/v3\"\nexport OS_IDENTITY_API_VERSION=3\n\nMy endpoint of cinder public URL is like http://**.**.**.**:8776/v1/cbe4b1d87fbb4318be379a79a570b7ec (I hided the real IP)\nWhen run command \"openstack --debug volume list\" or \"openstack --debug volume create --size 1 jin\", I got this BadRequest error. From debug info, this error comes from cinder server. I added log in cinder/api/openstack/wsgi.py function _process_stack(), found the context.project_id is None while project_id has a value, here return the error.\n\nif (context and project_id and (project_id != context.project_id)):\n            msg = _(\"Malformed request url\")\n            return Fault(webob.exc.HTTPBadRequest(explanation=msg))\n\nI compared with another keystone V2 authentication server, the context.project_id is same as project_id. Maybe this is difference, in v2 server the REQ has one more Project-id like \"curl -i -H \"X-Auth-Project-Id: admin\".\nI found the cinder.context maybe come from cinder/api/middleware/auth.py, the project_id in cinder.context may not be assigned a value in keystone v3 authentication scenario.\n\nERROR log is as below:\n\nREQ: curl -i http://**.**.**.**:8776/v1/cbe4b1d87fbb4318be379a79a570b7ec/volumes/detail -X GET -H \"User-Agent: python-cinderclient\" -H \"Accept: application/json\" -H \"X-Auth-Token: e883e05a887144d4ae70151c976ce666\"\n\nINFO: requests.packages.urllib3.connectionpool Starting new HTTP connection (1): **.**.**.**\nDEBUG: requests.packages.urllib3.connectionpool \"GET /v1/cbe4b1d87fbb4318be379a79a570b7ec/volumes/detail HTTP/1.1\" 400 65\nDEBUG: cinderclient.client RESP: [400] {'date': 'Thu, 09 Apr 2015 00:35:30 GMT', 'content-length': '65', 'content-type': 'application/json; charset=UTF-8', 'x-compute-request-id': 'req-39a96150-b9ab-4753-8b02-d5730492b288', 'x-openstack-request-id': 'req-39a96150-b9ab-4753-8b02-d5730492b288'}\nRESP BODY: {\"badRequest\": {\"message\": \"Malformed request url\", \"code\": 400}}\n\nERROR: openstack Malformed request url (HTTP 400) (Request-ID: req-39a96150-b9ab-4753-8b02-d5730492b288)\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/site-packages/cliff/app.py\", line 280, in run_subcommand\n    result = cmd.run(parsed_args)\n  File \"/usr/lib/python2.7/site-packages/cliff/display.py\", line 91, in run\n    column_names, data = self.take_action(parsed_args)\n  File \"/usr/lib/python2.7/site-packages/openstackclient/volume/v1/volume.py\", line 255, in take_action\n    data = volume_client.volumes.list(search_opts=search_opts)\n  File \"/usr/lib/python2.7/site-packages/cinderclient/v1/volumes.py\", line 220, in list\n    \"volumes\")\n  File \"/usr/lib/python2.7/site-packages/cinderclient/base.py\", line 70, in _list\n    resp, body = self.api.client.get(url)\n  File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 302, in get\n    return self._cs_request(url, 'GET', **kwargs)\n  File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 269, in _cs_request\n    **kwargs)\n  File \"/usr/lib/python2.7/site-packages/cinderclient/client.py\", line 252, in request\n    raise exceptions.from_response(resp, body)\nBadRequest: Malformed request url (HTTP 400) (Request-ID: req-39a96150-b9ab-4753-8b02-d5730492b288)", 
            "date_created": "2015-04-09 01:03:44.250438+00:00", 
            "author": "https://api.launchpad.net/1.0/~jin-t"
        }, 
        {
            "content": "Add full log before REQ,\n\n # openstack --debug volume list\nDEBUG: openstackclient.shell compute API version 2, cmd group openstack.compute.v2\nDEBUG: openstackclient.shell network API version 2, cmd group openstack.network.v2\nDEBUG: openstackclient.shell image API version 1, cmd group openstack.image.v1\nDEBUG: openstackclient.shell volume API version 1, cmd group openstack.volume.v1\nDEBUG: openstackclient.shell identity API version 3, cmd group openstack.identity.v3\nDEBUG: openstackclient.shell object_store API version 1, cmd group openstack.object_store.v1\nDEBUG: stevedore.extension found extension EntryPoint.parse('table = cliff.formatters.table:TableFormatter')\nDEBUG: stevedore.extension found extension EntryPoint.parse('csv = cliff.formatters.commaseparated:CSVLister')\nDEBUG: openstackclient.shell prepare_to_run_command ListVolume\nDEBUG: openstackclient.shell validating authentication options\nDEBUG: openstackclient.identity.client Instantiating identity client: <class 'keystoneclient.v3.client.Client'>\nDEBUG: openstackclient.identity.client Using password auth\nDEBUG: keystoneclient.auth.identity.v3 Making authentication request to http://**.**.**.**:35357/v3/auth/tokens\nINFO: requests.packages.urllib3.connectionpool Starting new HTTP connection (1): **.**.**.**\nDEBUG: requests.packages.urllib3.connectionpool \"POST /v3/auth/tokens HTTP/1.1\" 201 4434\nDEBUG: openstackclient.volume.v1.volume.ListVolume take_action(Namespace(all_projects=False, columns=[], formatter='table', long=False, max_width=0, name=None, quote_mode='nonnumeric', status=None))\nDEBUG: openstackclient.volume.client Instantiating volume client: <class 'cinderclient.v1.client.Client'>\nDEBUG: cinderclient.client \nREQ: curl -i http://**.**.**.**:8776/v1/cbe4b1d87fbb4318be379a79a570b7ec/volumes/detail -X GET -H \"User-Agent: python-cinderclient\" -H \"Accept: application/json\" -H \"X-Auth-Token: 53a14c48b0db4023a9dc454dfc661e70\"\n", 
            "date_created": "2015-04-09 17:27:58.802823+00:00", 
            "author": "https://api.launchpad.net/1.0/~jin-t"
        }, 
        {
            "content": "When delete the piece code of project_id checking in wsgi.py, my \"openstack volume create\" and \"openstack volume list\" all completed successfully. I suggest we may need handle both keystone v2 and v3 authentication well. Here is the print of request.environ in wsgi.py for reference.\n\nHTTP_X_TENANT_NAME': None\n'HTTP_X_ROLE': u'admin'\n'HTTP_X_USER_ID': u'e3b7f7511f234afa926d8b905478ff85'\n'HTTP_X_AUTH_TOKEN': '9902e483ac944b99836cd9592dbe0cdb'\n'HTTP_X_DOMAIN_NAME': u'Default'\n'HTTP_X_DOMAIN_ID': u'default'\n'HTTP_X_PROJECT_DOMAIN_ID': None\n'HTTP_X_TENANT_ID': None\n'HTTP_X_PROJECT_DOMAIN_NAME': None\n'HTTP_X_USER_DOMAIN_NAME': u'Default'\n'HTTP_X_TENANT': None\n'HTTP_X_USER': u'admin'\n'HTTP_X_USER_DOMAIN_ID': u'default'\n'HTTP_X_PROJECT_NAME': None\n'HTTP_X_PROJECT_ID': None\n'HTTP_X_USER_NAME': u'admin'\n", 
            "date_created": "2015-04-09 19:51:13.797472+00:00", 
            "author": "https://api.launchpad.net/1.0/~jin-t"
        }, 
        {
            "content": "When run \"openstack server list\", I got similar ERROR. There's also project_id check in nova/api/openstack/wsgi.py function _process_stack().\n\nError log is as below,\n\n# openstack --debug server list\nDEBUG: openstackclient.shell compute API version 2, cmd group openstack.compute.v2\nDEBUG: openstackclient.shell network API version 2, cmd group openstack.network.v2\nDEBUG: openstackclient.shell image API version 1, cmd group openstack.image.v1\nDEBUG: openstackclient.shell volume API version 1, cmd group openstack.volume.v1\nDEBUG: openstackclient.shell identity API version 3, cmd group openstack.identity.v3\nDEBUG: openstackclient.shell object_store API version 1, cmd group openstack.object_store.v1\nDEBUG: stevedore.extension found extension EntryPoint.parse('table = cliff.formatters.table:TableFormatter')\nDEBUG: stevedore.extension found extension EntryPoint.parse('csv = cliff.formatters.commaseparated:CSVLister')\nDEBUG: openstackclient.shell prepare_to_run_command ListServer\nDEBUG: openstackclient.shell validating authentication options\nDEBUG: openstackclient.identity.client Instantiating identity client: <class 'keystoneclient.v3.client.Client'>\nDEBUG: openstackclient.identity.client Using password auth\nDEBUG: keystoneclient.auth.identity.v3 Making authentication request to http://**.**.**.**:35357/v3/auth/tokens\nINFO: requests.packages.urllib3.connectionpool Starting new HTTP connection (1): **.**.**.**\nDEBUG: requests.packages.urllib3.connectionpool \"POST /v3/auth/tokens HTTP/1.1\" 201 4444\nDEBUG: openstackclient.compute.v2.server.ListServer take_action(Namespace(all_projects=False, columns=[], flavor=None, formatter='table', host=None, image=None, instance_name=None, ip=None, ip6=None, long=False, max_width=0, name=None, quote_mode='nonnumeric', reservation_id=None, status=None))\nDEBUG: openstackclient.compute.client Instantiating compute client: <class 'novaclient.v1_1.client.Client'>\nDEBUG: openstackclient.compute.v2.server.ListServer search options: {'instance_name': None, 'status': None, 'host': None, 'ip6': None, 'name': None, 'ip': None, 'flavor': None, 'reservation_id': None, 'image': None, 'all_tenants': False}\nREQ: curl -i 'http://**.**.**.**:8774/v2/b5167e1a791d4cd8af0855603f73b9a0/servers/detail' -X GET -H \"Accept: application/json\" -H \"User-Agent: python-novaclient\" -H \"X-Auth-Token: {SHA1}03aa4227ca578761f60664e623f490be33a79ff9\"\nRESP: [400] {'date': 'Fri, 10 Apr 2015 17:09:20 GMT', 'content-length': '160', 'content-type': 'application/json; charset=UTF-8', 'x-compute-request-id': 'req-c4ab0444-21f0-49a4-8223-dce1b9d22a1e'}\nRESP BODY: null\n\nERROR: openstack Malformed request URL: URL's project_id 'b5167e1a791d4cd8af0855603f73b9a0' doesn't match Context's project_id 'None' (HTTP 400) (Request-ID: req-c4ab0444-21f0-49a4-8223-dce1b9d22a1e)\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/site-packages/cliff/app.py\", line 280, in run_subcommand\n    result = cmd.run(parsed_args)\n  File \"/usr/lib/python2.7/site-packages/cliff/display.py\", line 91, in run\n    column_names, data = self.take_action(parsed_args)\n  File \"/usr/lib/python2.7/site-packages/openstackclient/compute/v2/server.py\", line 579, in take_action\n    data = compute_client.servers.list(search_opts=search_opts)\n  File \"/usr/lib/python2.7/site-packages/novaclient/v1_1/servers.py\", line 603, in list\n    return self._list(\"/servers%s%s\" % (detail, query_string), \"servers\")\n  File \"/usr/lib/python2.7/site-packages/novaclient/base.py\", line 67, in _list\n    _resp, body = self.api.client.get(url)\n  File \"/usr/lib/python2.7/site-packages/novaclient/client.py\", line 487, in get\n    return self._cs_request(url, 'GET', **kwargs)\n  File \"/usr/lib/python2.7/site-packages/novaclient/client.py\", line 465, in _cs_request\n    resp, body = self._time_request(url, method, **kwargs)\n  File \"/usr/lib/python2.7/site-packages/novaclient/client.py\", line 439, in _time_request\n    resp, body = self.request(url, method, **kwargs)\n  File \"/usr/lib/python2.7/site-packages/novaclient/client.py\", line 433, in request\n    raise exceptions.from_response(resp, body, url, method)\nBadRequest: Malformed request URL: URL's project_id 'b5167e1a791d4cd8af0855603f73b9a0' doesn't match Context's project_id 'None' (HTTP 400) (Request-ID: req-c4ab0444-21f0-49a4-8223-dce1b9d22a1e)\n", 
            "date_created": "2015-04-10 17:16:50.031563+00:00", 
            "author": "https://api.launchpad.net/1.0/~jin-t"
        }, 
        {
            "content": "Relate error in Nova flavor, caused by None project_id\n\n# openstack flavor list\nERROR: openstack The server could not comply with the request since it is either malformed or otherwise incorrect. (HTTP 400) (Request-ID: req-b129987e-2902-421d-b7e4-e6d44dd3f669)\n\nPart of the error log:\n\n2015-04-10 19:42:14.629 504 TRACE nova.api.openstack.wsgi   File \"/usr/lib/python2.7/site-packages/nova/api/openstack/common.py\", line 504, in _get_project_id\n2015-04-10 19:42:14.629 504 TRACE nova.api.openstack.wsgi     if project_id in request.url:\n2015-04-10 19:42:14.629 504 TRACE nova.api.openstack.wsgi TypeError: 'in <string>' requires string as left operand, not NoneType\n", 
            "date_created": "2015-04-10 20:57:34.234671+00:00", 
            "author": "https://api.launchpad.net/1.0/~jin-t"
        }, 
        {
            "content": "I have a workaround now, if I don't put \"export OS_DOMAIN_NAME=default\" in ENV, instead add domain in CLI like this,\n\n# openstack --debug --os-project-name admin --os-project-domain-name default --os-user-domain-name default server list\n\n# openstack --debug --os-project-name admin --os-project-domain-name default --os-user-domain-name default volume list\n\nI got all commands working and finally boot VM successfully in keystone V3 authentication.\n", 
            "date_created": "2015-04-23 19:26:29.077212+00:00", 
            "author": "https://api.launchpad.net/1.0/~jin-t"
        }, 
        {
            "content": "Some updates, we made keystone v3 working fine either using cli or horizon.\nWe figured out what parameters required in openstackclient command line. Using example in this ticket,\n# openstack volume list \n# openstack server list\nActually these two commands need OS_PROJECT_NAME env or --os-project-name in command line. Export OS_DOMAIN_NAME will not help. Basically OS_PROJECT_NAME is needed for most services(nova/cinder/neutron etc) except Identity. Identity requires OS_DOMAIN_NAME.\nYou may think export OS_PROJECT_NAME and OS_DOMAIN_NAME together. But openstackclient will complain when you do both,\n\"ERROR: openstack Authentication cannot be scoped to multiple targets. Pick one of: project, domain or trust\".\n\nYou can find extra info about policy.json from this article https://www.mirantis.com/blog/manage-openstack-projects-using-domains-havana/", 
            "date_created": "2015-05-07 19:38:42.659070+00:00", 
            "author": "https://api.launchpad.net/1.0/~jin-t"
        }, 
        {
            "content": "Code change is not needed on Cinder/Nova server, just some conf to use keystone v3 authentication.", 
            "date_created": "2015-05-07 19:58:17.390228+00:00", 
            "author": "https://api.launchpad.net/1.0/~jin-t"
        }, 
        {
            "content": "Hello Jin,\n\nIs this still a bug in OpenStack Compute Nova that needs a fix?\n\nThank you,", 
            "date_created": "2015-05-16 23:05:43.019090+00:00", 
            "author": "https://api.launchpad.net/1.0/~djbchepe"
        }
    ], 
    "closed": "2015-06-12 20:59:48.224130+00:00"
}