{
    "status": "Expired", 
    "last_updated": "2016-04-09 04:17:24.080417+00:00", 
    "description": "This is a problem I'm seeing in a 3 node DevStack system, stacked today (14th October 2015).  I click on Hypervisors in the System section of the Horizon UI, to see hypervisor information.  Horizon shows an error box \"Unable to retrieve hypervisor information\".\n\n/var/log/apache2/horizon_error.log includes this:\n\n2015-10-14 11:04:00.379206 REQ: curl -g -i 'http://calico-vm18:8774/v2.1/3c8d3e6c106c44b6ad37140023b92df8/os-hypervisors/detail' -X GET -H \"Accept: application/json\" -H \"User-Agent: python-novaclient\" -H \"X-Auth-Project-Id: 3c8d3e6c106c44b6ad37140023b92df8\" -H \"X-Auth-Token: {SHA1}db34b44f5be5800c12f48ab59251dc8277eb0b0c\"\n2015-10-14 11:04:00.420325 RESP: [500] {'content-length': '208', 'x-compute-request-id': 'req-6881cfe9-5962-4105-bf46-2d164ef4451c', 'vary': 'X-OpenStack-Nova-API-Version', 'connection': 'keep-alive', 'x-openstack-nova-api-version': '2.1', 'date': 'Wed, 14 Oct 2015 11:04:00 GMT', 'content-type': 'application/json; charset=UTF-8'}\n2015-10-14 11:04:00.420358 RESP BODY: {\"computeFault\": {\"message\": \"Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\\\\n<class 'nova.exception.ComputeHostNotFound'>\", \"code\": 500}}\n2015-10-14 11:04:00.420365\n2015-10-14 11:04:00.420842 Recoverable error: Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n\nOtherwise the cluster appears to be working; for example I've successfully launched 10 cirros instances, across the 3 available compute nodes.\n\nubuntu@calico-vm18:/opt/stack/nova$ git log -1\ncommit 1d97b0e7308975cd4a912dda00df8726ba776fe7\nMerge: 7200b6a 11e20dd\nAuthor: Jenkins <email address hidden>\nDate:   Wed Oct 14 08:50:59 2015 +0000\n\n    Merge \"Ignore errorcode=4 when executing `cryptsetup remove` command\"", 
    "tags": [
        "compute"
    ], 
    "importance": "Undecided", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1506054", 
    "owner": "None", 
    "id": 1506054, 
    "index": 7076, 
    "openned": "2015-10-14 13:02:04.146757+00:00", 
    "created": "2015-10-14 13:02:04.146757+00:00", 
    "title": "Nova tries to connect to deleted VM causing API error and Horizon error", 
    "comments": [
        {
            "content": "This is a problem I'm seeing in a 3 node DevStack system, stacked today (14th October 2015).  I click on Hypervisors in the System section of the Horizon UI, to see hypervisor information.  Horizon shows an error box \"Unable to retrieve hypervisor information\".\n\n/var/log/apache2/horizon_error.log includes this:\n\n2015-10-14 11:04:00.379206 REQ: curl -g -i 'http://calico-vm18:8774/v2.1/3c8d3e6c106c44b6ad37140023b92df8/os-hypervisors/detail' -X GET -H \"Accept: application/json\" -H \"User-Agent: python-novaclient\" -H \"X-Auth-Project-Id: 3c8d3e6c106c44b6ad37140023b92df8\" -H \"X-Auth-Token: {SHA1}db34b44f5be5800c12f48ab59251dc8277eb0b0c\"\n2015-10-14 11:04:00.420325 RESP: [500] {'content-length': '208', 'x-compute-request-id': 'req-6881cfe9-5962-4105-bf46-2d164ef4451c', 'vary': 'X-OpenStack-Nova-API-Version', 'connection': 'keep-alive', 'x-openstack-nova-api-version': '2.1', 'date': 'Wed, 14 Oct 2015 11:04:00 GMT', 'content-type': 'application/json; charset=UTF-8'}\n2015-10-14 11:04:00.420358 RESP BODY: {\"computeFault\": {\"message\": \"Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\\\\n<class 'nova.exception.ComputeHostNotFound'>\", \"code\": 500}}\n2015-10-14 11:04:00.420365\n2015-10-14 11:04:00.420842 Recoverable error: Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n\nOtherwise the cluster appears to be working; for example I've successfully launched 10 cirros instances, across the 3 available compute nodes.\n\nubuntu@calico-vm18:/opt/stack/nova$ git log -1\ncommit 1d97b0e7308975cd4a912dda00df8726ba776fe7\nMerge: 7200b6a 11e20dd\nAuthor: Jenkins <email address hidden>\nDate:   Wed Oct 14 08:50:59 2015 +0000\n\n    Merge \"Ignore errorcode=4 when executing `cryptsetup remove` command\"", 
            "date_created": "2015-10-14 13:02:04.146757+00:00", 
            "author": "https://api.launchpad.net/1.0/~neil-jerram"
        }, 
        {
            "content": "The n-api.log includes several instances of this:\n\n2015-10-14 12:45:41.416 DEBUG nova.api.openstack.wsgi [req-722ba30b-5b9d-4f57-95dd-c6173f8d427c admin admin] Calling method '<bound method HypervisorsController.detail of <nova.api.openstack.compute.hypervisors.HypervisorsController object at 0x7fd447b7eed0>>' _process_stack /opt/stack/nova/nova/api/openstack/wsgi.py:792\n2015-10-14 12:45:41.432 ERROR nova.api.openstack.extensions [req-722ba30b-5b9d-4f57-95dd-c6173f8d427c admin admin] Unexpected exception in API method\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions Traceback (most recent call last):\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/hypervisors.py\", line 101, in detail\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions     for hyp in compute_nodes])\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/api.py\", line 3478, in service_get_by_compute_host\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions     return objects.Service.get_by_compute_host(context, host_name)\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 171, in wrapper\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/service.py\", line 223, in get_by_compute_host\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions     db_service = db.service_get_by_compute_host(context, host)\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/api.py\", line 145, in service_get_by_compute_host\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions     use_slave=use_slave)\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 512, in service_get_by_compute_host\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions     raise exception.ComputeHostNotFound(host=host)\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions ComputeHostNotFound: Compute host calico-vm23 could not be found.\n2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions\n2015-10-14 12:45:41.488 INFO nova.api.openstack.wsgi [req-722ba30b-5b9d-4f57-95dd-c6173f8d427c admin admin] HTTP exception thrown: Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.ComputeHostNotFound'>\n2015-10-14 12:45:41.488 DEBUG nova.api.openstack.wsgi [req-722ba30b-5b9d-4f57-95dd-c6173f8d427c admin admin] Returning 500 to user: Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.\n<class 'nova.exception.ComputeHostNotFound'> __call__ /opt/stack/nova/nova/api/openstack/wsgi.py:1175\n\ncalico-vm23 is a node that was previously set up as a compute node (actually from a stacking a couple of weeks ago) but has now been wiped.\n\nSo I guess the question is: how do I get Nova on the controller to stop trying to communicate with calico-vm23 ?\n", 
            "date_created": "2015-10-14 13:07:20.057214+00:00", 
            "author": "https://api.launchpad.net/1.0/~neil-jerram"
        }, 
        {
            "content": "The important information is this one, I guess:\n\n    2015-10-14 12:45:41.432 8564 ERROR nova.api.openstack.extensions \n    ComputeHostNotFound: Compute host calico-vm23 could not be found.\n\n    calico-vm23 is a node that was previously set up as a compute node \n    (actually from a stacking a couple of weeks ago) but has now been \n    wiped.\n\n    So I guess the question is: how do I get Nova on the controller to\n    stop trying to communicate with calico-vm23 ?\n\n\nThe \"nova/compute/manager.py\" has a periodic task which should cleanup\nthis king of things, IIUC:\n\n    @periodic_task.periodic_task(spacing=CONF.update_resources_interval)\n    def update_available_resource(self, context):\n        \"\"\"See driver.get_available_resource()\n\n        Periodic process that keeps that the compute host's understanding of\n        resource availability and usage in sync with the underlying hypervisor.\n\n        :param context: security context\n        \"\"\"\n        new_resource_tracker_dict = {}\n\n        compute_nodes_in_db = self._get_compute_nodes_in_db(context,\n                                                            use_slave=True)\n        nodenames = set(self.driver.get_available_nodes())\n        for nodename in nodenames:\n            rt = self._get_resource_tracker(nodename)\n            try:\n                rt.update_available_resource(context)\n            except exception.ComputeHostNotFound:\n                # NOTE(comstud): We can get to this case if a node was\n                # marked 'deleted' in the DB and then re-added with a\n                # different auto-increment id. The cached resource\n                # tracker tried to update a deleted record and failed.\n                # Don't add this resource tracker to the new dict, so\n                # that this will resolve itself on the next run.\n                LOG.info(_LI(\"Compute node '%s' not found in \"\n                             \"update_available_resource.\"), nodename)\n                continue\n            except Exception as e:\n                LOG.error(_LE(\"Error updating resources for node \"\n                              \"%(node)s: %(e)s\"),\n                          {'node': nodename, 'e': e})\n            new_resource_tracker_dict[nodename] = rt\n\n        # NOTE(comstud): Replace the RT cache before looping through\n        # compute nodes to delete below, as we can end up doing greenthread\n        # switches there. Best to have everyone using the newest cache\n        # ASAP.\n        self._resource_tracker_dict = new_resource_tracker_dict\n\n        # Delete orphan compute node not reported by driver but still in db\n        for cn in compute_nodes_in_db:\n            if cn.hypervisor_hostname not in nodenames:\n                LOG.info(_LI(\"Deleting orphan compute node %s\") % cn.id)\n                cn.destroy()\n\nThat's at least the only occurance of the \"ComputeNode\"'s method\n\"destroy()\" which should remove this entry from the database. I didn't\nfind a REST API to trigger this as end user.", 
            "date_created": "2015-10-15 12:23:59.081660+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Hi Neil, I just wanted to follow up to see if you're still experiencing this error? If so it's possible the Computer manager cleanup didn't happen as it should have and we can look into it further. If however you are no longer experiencing this, then maybe you can provide some info (if you still remember or have it handy) as to how long it took Nova to stop trying to connect to the deleted VM? Thanks!", 
            "date_created": "2016-02-03 22:02:07.157649+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "fwiw, I've just started looking into exactly same problem as described above - same symptoms, same stacktraces in the logs - in this case, a three node Ubuntu Wily based stack.", 
            "date_created": "2016-02-04 10:48:05.264318+00:00", 
            "author": "https://api.launchpad.net/1.0/~ross-golder"
        }, 
        {
            "content": "@Augustina - No, I'm not still seeing this myself.  I think it originally occurred when one of my compute node installs failed in some way, and I've since improved my automation so that that kind of failure doesn't happen.", 
            "date_created": "2016-02-05 17:15:08.912194+00:00", 
            "author": "https://api.launchpad.net/1.0/~neil-jerram"
        }, 
        {
            "content": "@Ross+@Neil: Maybe the same node exists twice in the database but with different IDs. Could you add the contents of the nova db \"instances\" table?", 
            "date_created": "2016-02-08 17:43:45.091858+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2016-04-09 04:17:20.497168+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ], 
    "closed": "2016-04-09 04:17:21.558564+00:00"
}