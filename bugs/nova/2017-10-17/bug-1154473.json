{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:18:10.028177+00:00", 
    "description": "Nova used to recover gracefully if libvirt was restarted out from under it, this is no longer the case.  Steps to reproduce:\n\n1. Start libvirtd (I am using version 1.0.2)\n2. Start nova-compute (tested using master branch as of 3/13/2013)\n3. Observe that everything functions normally\n4. Restart libvirtd\n5. nova-compute will now throw exceptions for every subsequent operation (nova.manager libvirtError: internal error client socket is closed)\n\nThis is a serious issue, as nova-compute will not recover on its own without being restarted.", 
    "tags": [
        "folsom-backport-potential"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1154473", 
    "owner": "https://api.launchpad.net/1.0/~russellb", 
    "id": 1154473, 
    "index": 1013, 
    "openned": "2013-03-13 08:15:47.450356+00:00", 
    "created": "2013-03-13 08:15:47.450356+00:00", 
    "title": "Nova no longer reconnects if libvirt is restarted", 
    "comments": [
        {
            "content": "Nova used to recover gracefully if libvirt was restarted out from under it, this is no longer the case.  Steps to reproduce:\n\n1. Start libvirtd (I am using version 1.0.2)\n2. Start nova-compute (tested using master branch as of 3/13/2013)\n3. Observe that everything functions normally\n4. Restart libvirtd\n5. nova-compute will now throw exceptions for every subsequent operation (nova.manager libvirtError: internal error client socket is closed)\n\nThis is a serious issue, as nova-compute will not recover on its own without being restarted.", 
            "date_created": "2013-03-13 08:15:47.450356+00:00", 
            "author": "https://api.launchpad.net/1.0/~rkhardalian"
        }, 
        {
            "content": "2013-03-13 09:41:40.865 DEBUG nova.virt.libvirt.driver [-] Updating host stats from (pid=25201) update_status /opt/stack/nova/nova/virt/libvirt/driver.py:3681\n2013-03-13 09:41:40.865 DEBUG nova.virt.libvirt.driver [-] Connecting to libvirt: qemu:///system from (pid=25201) _get_connection /opt/stack/nova/nova/virt/libvirt/driver.py:553\nlibvir: XML-RPC error : Failed to connect socket to '/var/run/libvirt/libvirt-sock': No such file or directory\n2013-03-13 09:41:40.866 ERROR nova.virt.libvirt.driver [-] Connection to libvirt failed: Failed to connect socket to '/var/run/libvirt/libvirt-sock': No such file or directory\n2013-03-13 09:41:40.866 TRACE nova.virt.libvirt.driver Traceback (most recent call last):\n2013-03-13 09:41:40.866 TRACE nova.virt.libvirt.driver   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 626, in _connect\n2013-03-13 09:41:40.866 TRACE nova.virt.libvirt.driver     return libvirt.openAuth(uri, auth, 0)\n2013-03-13 09:41:40.866 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 102, in openAuth\n2013-03-13 09:41:40.866 TRACE nova.virt.libvirt.driver     if ret is None:raise libvirtError('virConnectOpenAuth() failed')\n2013-03-13 09:41:40.866 TRACE nova.virt.libvirt.driver libvirtError: Failed to connect socket to '/var/run/libvirt/libvirt-sock': No such file or directory\n2013-03-13 09:41:40.866 TRACE nova.virt.libvirt.driver \n2013-03-13 09:41:40.868 DEBUG nova.virt.libvirt.driver [-] Registering for lifecycle events <nova.virt.libvirt.driver.LibvirtDriver object at 0x2a2b910> from (pid=25201) _get_connection /opt/stack/nova/nova/virt/libvirt/driver.py:563\n2013-03-13 09:41:40.868 WARNING nova.virt.libvirt.driver [-] URI qemu:///system does not support events\n2013-03-13 09:41:40.868 ERROR nova.manager [-] Error during ComputeManager._report_driver_status: 'NoneType' object has no attribute 'getInfo'\n2013-03-13 09:41:40.868 TRACE nova.manager Traceback (most recent call last):\n2013-03-13 09:41:40.868 TRACE nova.manager   File \"/opt/stack/nova/nova/manager.py\", line 241, in periodic_tasks\n2013-03-13 09:41:40.868 TRACE nova.manager     task(self, context)\n2013-03-13 09:41:40.868 TRACE nova.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 3597, in _report_driver_status\n2013-03-13 09:41:40.868 TRACE nova.manager     capabilities = self.driver.get_host_stats(refresh=True)\n2013-03-13 09:41:40.868 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3381, in get_host_stats\n2013-03-13 09:41:40.868 TRACE nova.manager     return self.host_state.get_host_stats(refresh=refresh)\n2013-03-13 09:41:40.868 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3676, in get_host_stats\n2013-03-13 09:41:40.868 TRACE nova.manager     self.update_status()\n2013-03-13 09:41:40.868 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3683, in update_status\n2013-03-13 09:41:40.868 TRACE nova.manager     data[\"vcpus\"] = self.driver.get_vcpu_total()\n2013-03-13 09:41:40.868 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2514, in get_vcpu_total\n2013-03-13 09:41:40.868 TRACE nova.manager     return self._conn.getInfo()[2]\n2013-03-13 09:41:40.868 TRACE nova.manager AttributeError: 'NoneType' object has no attribute 'getInfo'\n2013-03-13 09:41:40.868 TRACE nova.manager \n", 
            "date_created": "2013-03-13 13:44:37.701691+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "@rmk, i see the above in the logs, however a subsequent launch works fine\n\n\"nova boot --image cirros-0.3.0-x86_64 --flavor m1.small my-first-server-2\"\n\ndims@dims-desktop:~$ libvirtd --version\nlibvirtd (libvirt) 0.9.13\n", 
            "date_created": "2013-03-13 13:47:24.170986+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Testing on Fedora 18.  After restarting libvirtd, once the next periodic task that uses libvirt runs, I get:\n\nlibvir: XML-RPC error : internal error client socket is closed\n2013-03-13 14:43:55.577 WARNING nova.virt.libvirt.driver [-] Cannot get the number of cpu, because this function is \nnot implemented for this platform. \nlibvir: XML-RPC error : internal error client socket is closed\n2013-03-13 14:43:55.578 ERROR nova.manager [-] Error during ComputeManager._report_driver_status: internal error cli\nent socket is closed\n2013-03-13 14:43:55.578 TRACE nova.manager Traceback (most recent call last):\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/opt/stack/nova/nova/manager.py\", line 241, in periodic_tasks\n2013-03-13 14:43:55.578 TRACE nova.manager     task(self, context)\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 3529, in _report_driver_status\n2013-03-13 14:43:55.578 TRACE nova.manager     capability['host_ip'] = CONF.my_ip\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3367, in get_host_stats\n2013-03-13 14:43:55.578 TRACE nova.manager     return self.host_state.get_host_stats(refresh=refresh)\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3662, in get_host_stats\n2013-03-13 14:43:55.578 TRACE nova.manager     self.update_status()\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 3670, in update_status\n2013-03-13 14:43:55.578 TRACE nova.manager     data[\"vcpus_used\"] = self.driver.get_vcpu_used()\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2551, in get_vcpu_used\n2013-03-13 14:43:55.578 TRACE nova.manager     dom_ids = self.list_instance_ids()\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 656, in list_instance_ids\n2013-03-13 14:43:55.578 TRACE nova.manager     if self._conn.numOfDomains() == 0:\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 552, in _get_connection\n2013-03-13 14:43:55.578 TRACE nova.manager     if not self._wrapped_conn or not self._test_connection():\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 579, in _test_connection\n2013-03-13 14:43:55.578 TRACE nova.manager     self._wrapped_conn.getLibVersion()\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 187, in doit\n2013-03-13 14:43:55.578 TRACE nova.manager     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 147, in proxy_call\n2013-03-13 14:43:55.578 TRACE nova.manager     rv = execute(f,*args,**kwargs)\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 76, in tworker\n2013-03-13 14:43:55.578 TRACE nova.manager     rv = meth(*args,**kwargs)\n2013-03-13 14:43:55.578 TRACE nova.manager   File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 3352, in getLibVersion\n2013-03-13 14:43:55.578 TRACE nova.manager     if ret == -1: raise libvirtError ('virConnectGetLibVersion() failed', conn=self)\n2013-03-13 14:43:55.578 TRACE nova.manager libvirtError: internal error client socket is closed\n2013-03-13 14:43:55.578 TRACE nova.manager \n\n\n\nAfter that, it doesn't recover.  I get that exception on every attempt to talk to libvirt.\n\nlibvirt-0.10.2.3-1.fc18.x86_64", 
            "date_created": "2013-03-13 14:46:00.302890+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/24323", 
            "date_created": "2013-03-13 15:06:43.829955+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "rmk pointed out that this commit may have led to the change in behavior here:\n\nhttps://github.com/openstack/nova/commit/ec3d7e4cb882eff42fa8f1e5f8f52723fb909b0e", 
            "date_created": "2013-03-13 15:09:53.924332+00:00", 
            "author": "https://api.launchpad.net/1.0/~russellb"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/24323\nCommitted: http://github.com/openstack/nova/commit/956be49d0dd266be26673b05480523be55bd6267\nSubmitter: Jenkins\nBranch:    master\n\ncommit 956be49d0dd266be26673b05480523be55bd6267\nAuthor: Russell Bryant <email address hidden>\nDate:   Wed Mar 13 11:03:42 2013 -0400\n\n    Fix reconnecting to libvirt.\n    \n    The right logic was in place for dealing with losing a connection to\n    libvirt and reconnecting.  However, it was observed that we actually get\n    VIR_ERR_INTERNAL_ERROR, VIR_FROM_RPC after restarting libvirtd.  The\n    code is just updated to deal with INTERNAL_ERROR.\n    \n    Fix bug 1154473.\n    \n    Change-Id: Idf4abf3fe485cf534f1732e4340fc35652fec003\n", 
            "date_created": "2013-03-13 16:06:27.667138+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-03-20 16:08:01.825792+00:00"
}