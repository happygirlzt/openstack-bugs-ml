{
    "status": "Fix Released", 
    "last_updated": "2011-09-22 13:38:25.956080+00:00", 
    "description": "iscsiadm call fails in multiple different scenarios possibly due to wrong parameter format passed to _run_iscsiadm:\n\n2011-07-27 21:10:47,141 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2011-04.org.zadara:vsa-00000005:volume-00000005 -p 10.0.0.19:3260 ('--op', 'new') from (pid=28764) execute /mnt/share/d-cloud-Vlad/nova/utils.py:143\n2011-07-27 21:10:47,153 DEBUG nova.utils [-] Result was 255 from (pid=28764) execute /mnt/share/d-cloud-Vlad/nova/utils.py:161\n2011-07-27 21:10:47,153 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/rpc.py\", line 232, in _process_data\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/compute/manager.py\", line 113, in decorated_function\n(nova): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/compute/manager.py\", line 1055, in attach_volume\n(nova): TRACE:     volume_id)\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/volume/manager.py\", line 234, in setup_compute_volume\n(nova): TRACE:     path = self.driver.discover_volume(context, volume_ref)\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/volume/driver.py\", line 510, in discover_volume\n(nova): TRACE:     self._run_iscsiadm(iscsi_properties, ('--op', 'new'))\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/volume/driver.py\", line 495, in _run_iscsiadm\n(nova): TRACE:     iscsi_command)\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/utils.py\", line 169, in execute\n(nova): TRACE:     cmd=' '.join(cmd))\n(nova): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova): TRACE: Command: sudo iscsiadm -m node -T iqn.2011-04.org.zadara:vsa-00000005:volume-00000005 -p 10.0.0.19:3260 ('--op', 'new')\n(nova): TRACE: Exit code: 255\n(nova): TRACE: Stdout: ''\n(nova): TRACE: Stderr: 'iscsiadm: no records found!\\n'\n(nova): TRACE:\n\n(Same code with '--op=new' works good)\n\nor...\n\n2011-08-22 23:38:01,922 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-000000d8 -p 10.0.0.11:3260 ('--op', 'delete') from (pid=2366) execute /mnt/share/d-cloud-Vlad/nova/utils.py:164\n2011-08-22 23:38:01,938 DEBUG nova.volume.driver [-] iscsiadm ('--op', 'delete'): stdout=# BEGIN RECORD 2.0-871\nnode.name = iqn.2010-10.org.openstack:volume-000000d8\nnode.tpgt = 1\nnode.startup = manual\niface.hwaddress = <empty>\niface.ipaddress = <empty>\niface.iscsi_ifacename = default\niface.net_ifacename = <empty>\niface.transport_name = tcp\niface.initiatorname = <empty>\nnode.discovery_address = ubuntu-alex-srv\nnode.discovery_port = 3260\nnode.discovery_type = send_targets\nnode.session.initial_cmdsn = 0\nnode.session.initial_login_retry_max = 8\nnode.session.xmit_thread_priority = -20\nnode.session.cmds_max = 128\nnode.session.queue_depth = 32\nnode.session.auth.authmethod = None\nnode.session.auth.username = <empty>\nnode.session.auth.password = <empty>\nnode.session.auth.username_in = <empty>\nnode.session.auth.password_in = <empty>\nnode.session.timeo.replacement_timeout = 120\nnode.session.err_timeo.abort_timeout = 15\nnode.session.err_timeo.lu_reset_timeout = 20\nnode.session.err_timeo.host_reset_timeout = 60\nnode.session.iscsi.FastAbort = Yes\nnode.session.iscsi.InitialR2T = No\nnode.session.iscsi.ImmediateData = Yes\nnode.session.iscsi.FirstBurstLength = 262144\nnode.session.iscsi.MaxBurstLength = 16776192\nnode.session.iscsi.DefaultTime2Retain = 0\nnode.session.iscsi.DefaultTime2Wait = 2\nnode.session.iscsi.MaxConnections = 1\nnode.session.iscsi.MaxOutstandingR2T = 1\nnode.session.iscsi.ERL = 0\nnode.conn[0].address = 10.0.0.11\nnode.conn[0].port = 3260\nnode.conn[0].startup = manual\nnode.conn[0].tcp.window_size = 524288\nnode.conn[0].tcp.type_of_service = 0\nnode.conn[0].timeo.logout_timeout = 15\nnode.conn[0].timeo.login_timeout = 15\nnode.conn[0].timeo.auth_timeout = 45\nnode.conn[0].timeo.noop_out_interval = 5\nnode.conn[0].timeo.noop_out_timeout = 5\nnode.conn[0].iscsi.MaxRecvDataSegmentLength = 262144\n\nnode.conn[0].iscsi.HeaderDigest = None\nnode.conn[0].iscsi.DataDigest = None\nnode.conn[0].iscsi.IFMarker = No\nnode.conn[0].iscsi.OFMarker = No\n# END RECORD\n\u00a0stderr= from (pid=2366) _run_iscsiadm /mnt/share/d-cloud-Vlad/nova/volume/driver.py:506\n\n\nAs a result iscsiadm doing nothing.\n\n\nFor op new & delete we can probably change the code to pass something like '--op=new' and '--op=delete' instead of ('--op', 'new') & ('--op', 'delete'), but update receives multiple params.\n\nPossible workaround might be also to add something like that within _run_iscsiadm:\n\niscsi_command=map(str, iscsi_command)", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/832200", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 832200, 
    "index": 2524, 
    "openned": "2011-08-23 17:18:15.314183+00:00", 
    "created": "2011-08-23 17:18:15.314183+00:00", 
    "title": "iscsiadm cmd failure", 
    "comments": [
        {
            "content": "iscsiadm call fails in multiple different scenarios possibly due to wrong parameter format passed to _run_iscsiadm:\n\n\n2011-07-27 21:10:47,141 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2011-04.org.zadara:vsa-00000005:volume-00000005 -p 10.0.0.19:3260 ('--op', 'new') from (pid=28764) execute /mnt/share/d-cloud-Vlad/nova/utils.py:143\n2011-07-27 21:10:47,153 DEBUG nova.utils [-] Result was 255 from (pid=28764) execute /mnt/share/d-cloud-Vlad/nova/utils.py:161\n2011-07-27 21:10:47,153 ERROR nova [-] Exception during message handling\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/rpc.py\", line 232, in _process_data\n(nova): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/compute/manager.py\", line 113, in decorated_function\n(nova): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/compute/manager.py\", line 1055, in attach_volume\n(nova): TRACE:     volume_id)\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/volume/manager.py\", line 234, in setup_compute_volume\n(nova): TRACE:     path = self.driver.discover_volume(context, volume_ref)\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/volume/driver.py\", line 510, in discover_volume\n(nova): TRACE:     self._run_iscsiadm(iscsi_properties, ('--op', 'new'))\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/volume/driver.py\", line 495, in _run_iscsiadm\n(nova): TRACE:     iscsi_command)\n(nova): TRACE:   File \"/mnt/share/d-cloud-Vlad/nova/utils.py\", line 169, in execute\n(nova): TRACE:     cmd=' '.join(cmd))\n(nova): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova): TRACE: Command: sudo iscsiadm -m node -T iqn.2011-04.org.zadara:vsa-00000005:volume-00000005 -p 10.0.0.19:3260 ('--op', 'new')\n(nova): TRACE: Exit code: 255\n(nova): TRACE: Stdout: ''\n(nova): TRACE: Stderr: 'iscsiadm: no records found!\\n'\n(nova): TRACE:\n\nor...\n\n\n2011-08-22 23:38:01,922 DEBUG nova.utils [-] Running cmd (subprocess): sudo iscsiadm -m node -T iqn.2010-10.org.openstack:volume-000000d8 -p 10.0.0.11:3260 ('--op', 'delete') from (pid=2366) execute /mnt/share/d-cloud-Vlad/nova/utils.py:164\n2011-08-22 23:38:01,938 DEBUG nova.volume.driver [-] iscsiadm ('--op', 'delete'): stdout=# BEGIN RECORD 2.0-871\nnode.name = iqn.2010-10.org.openstack:volume-000000d8\nnode.tpgt = 1\nnode.startup = manual\niface.hwaddress = <empty>\niface.ipaddress = <empty>\niface.iscsi_ifacename = default\niface.net_ifacename = <empty>\niface.transport_name = tcp\niface.initiatorname = <empty>\nnode.discovery_address = ubuntu-alex-srv\nnode.discovery_port = 3260\nnode.discovery_type = send_targets\nnode.session.initial_cmdsn = 0\nnode.session.initial_login_retry_max = 8\nnode.session.xmit_thread_priority = -20\nnode.session.cmds_max = 128\nnode.session.queue_depth = 32\nnode.session.auth.authmethod = None\nnode.session.auth.username = <empty>\nnode.session.auth.password = <empty>\nnode.session.auth.username_in = <empty>\nnode.session.auth.password_in = <empty>\nnode.session.timeo.replacement_timeout = 120\nnode.session.err_timeo.abort_timeout = 15\nnode.session.err_timeo.lu_reset_timeout = 20\nnode.session.err_timeo.host_reset_timeout = 60\nnode.session.iscsi.FastAbort = Yes\nnode.session.iscsi.InitialR2T = No\nnode.session.iscsi.ImmediateData = Yes\nnode.session.iscsi.FirstBurstLength = 262144\nnode.session.iscsi.MaxBurstLength = 16776192\nnode.session.iscsi.DefaultTime2Retain = 0\nnode.session.iscsi.DefaultTime2Wait = 2\nnode.session.iscsi.MaxConnections = 1\nnode.session.iscsi.MaxOutstandingR2T = 1\nnode.session.iscsi.ERL = 0\nnode.conn[0].address = 10.0.0.11\nnode.conn[0].port = 3260\nnode.conn[0].startup = manual\nnode.conn[0].tcp.window_size = 524288\nnode.conn[0].tcp.type_of_service = 0\nnode.conn[0].timeo.logout_timeout = 15\nnode.conn[0].timeo.login_timeout = 15\nnode.conn[0].timeo.auth_timeout = 45\nnode.conn[0].timeo.noop_out_interval = 5\nnode.conn[0].timeo.noop_out_timeout = 5\nnode.conn[0].iscsi.MaxRecvDataSegmentLength = 262144\n\nnode.conn[0].iscsi.HeaderDigest = None\nnode.conn[0].iscsi.DataDigest = None\nnode.conn[0].iscsi.IFMarker = No\nnode.conn[0].iscsi.OFMarker = No\n# END RECORD\n stderr= from (pid=2366) _run_iscsiadm /mnt/share/d-cloud-Vlad/nova/volume/driver.py:506\n\nAs a result iscsiadm doing nothing\n\nFor op new & delete we can probably change the code to pass something like '--op=new' and '--op=delete' instead of ('--op', 'new') & ('--op', 'delete'), but update receives multiple params.\n\nPossible workaround might be also to add something like that within _run_iscsiadm:\n\niscsi_command=map(str, iscsi_command)", 
            "date_created": "2011-08-23 17:18:15.314183+00:00", 
            "author": "https://api.launchpad.net/1.0/~vladimir.p"
        }, 
        {
            "content": "I fixed this in my cleanup volume branch by changing the call to execute to unpack the tuple using an asterix:\n*iscsi_command", 
            "date_created": "2011-08-23 17:38:30.962767+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "missed changing all run_iscsiadm commands to use tuples.\n", 
            "date_created": "2011-08-25 22:10:42.846694+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }
    ], 
    "closed": "2011-09-22 13:38:24.967788+00:00"
}