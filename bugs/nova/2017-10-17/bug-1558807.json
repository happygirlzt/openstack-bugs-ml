{
    "status": "Invalid", 
    "last_updated": "2016-12-09 12:46:15.719420+00:00", 
    "description": "When booting a node with config drive then attaching a cinder volume we see conflicting information about where the cinder volume is attached. In this case the config drive is at /dev/vdb, the cinder volume is at /dev/vdc but volume show reports the cinder volume to be at /dev/vdb.\n\nThis shows how one can get nova/cinder in this state using openstackclient (assuming that config drives attach to /dev/vdb):\n\n$ OS_CLIENT_CONFIG_FILE=../vexxhost/vexx.yaml venv/bin/openstack --os-cloud openstackci-vexxhost server create --config-drive True --key-name clarkb-work --image ubuntu-trusty --flavor v1-standard-2 clarkb-test\n+--------------------------------------+------------------------------------------------------+\n| Field                                | Value                                                |\n+--------------------------------------+------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                               |\n| OS-EXT-AZ:availability_zone          |                                                      |\n| OS-EXT-STS:power_state               | 0                                                    |\n| OS-EXT-STS:task_state                | scheduling                                           |\n| OS-EXT-STS:vm_state                  | building                                             |\n| OS-SRV-USG:launched_at               | None                                                 |\n| OS-SRV-USG:terminated_at             | None                                                 |\n| accessIPv4                           |                                                      |\n| accessIPv6                           |                                                      |\n| addresses                            |                                                      |\n| adminPass                            | redacted                                             |\n| config_drive                         | True                                                 |\n| created                              | 2016-03-17T21:12:38Z                                 |\n| flavor                               | v1-standard-2 (ca2a6e9c-2236-4107-8905-7ae9427132ff) |\n| hostId                               |                                                      |\n| id                                   | cdaf7671-5a5c-4118-a422-d8aae096bd1e                 |\n| image                                | ubuntu-trusty (d42c4ce4-3fa0-4dcb-877e-1d66a05a4f8d) |\n| key_name                             | clarkb-work                                          |\n| name                                 | clarkb-test                                          |\n| os-extended-volumes:volumes_attached | []                                                   |\n| progress                             | 0                                                    |\n| project_id                           | projectid                                            |\n| properties                           |                                                      |\n| security_groups                      | [{u'name': u'default'}]                              |\n| status                               | BUILD                                                |\n| updated                              | 2016-03-17T21:12:38Z                                 |\n| user_id                              | userid                                               |\n+--------------------------------------+------------------------------------------------------+\n$ OS_CLIENT_CONFIG_FILE=../vexxhost/vexx.yaml venv/bin/openstack --os-cloud openstackci-vexxhost volume create --size 100 clarkb-test\n+---------------------+--------------------------------------+\n| Field               | Value                                |\n+---------------------+--------------------------------------+\n| attachments         | []                                   |\n| availability_zone   | ca-ymq-2                             |\n| bootable            | false                                |\n| consistencygroup_id | None                                 |\n| created_at          | 2016-03-17T21:13:13.683882           |\n| description         | None                                 |\n| encrypted           | False                                |\n| id                  | a2bba82c-ef08-48fe-9c3c-eafc8644207c |\n| multiattach         | False                                |\n| name                | clarkb-test                          |\n| properties          |                                      |\n| replication_status  | disabled                             |\n| size                | 100                                  |\n| snapshot_id         | None                                 |\n| source_volid        | None                                 |\n| status              | creating                             |\n| type                | None                                 |\n| user_id             | userid                               |\n+---------------------+--------------------------------------+\n$ OS_CLIENT_CONFIG_FILE=../vexxhost/vexx.yaml venv/bin/openstack --os-cloud openstackci-vexxhost server add volume clarkb-test clarkb-test\n$ OS_CLIENT_CONFIG_FILE=../vexxhost/vexx.yaml venv/bin/openstack --os-cloud openstackci-vexxhost volume show clarkb-test\n+---------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+\n| Field                                 | Value                                                                                                                                              |\n+---------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+\n| attachments                           | [{u'server_id': u'cdaf7671-5a5c-4118-a422-d8aae096bd1e', u'attachment_id': u'18f184b3-123e-4b5c-af66-d5c5b93af5ed', u'host_name': None,            |\n|                                       | u'volume_id': u'a2bba82c-ef08-48fe-9c3c-eafc8644207c', u'device': u'/dev/vdb', u'id': u'a2bba82c-ef08-48fe-9c3c-eafc8644207c'}]                    |\n| availability_zone                     | ca-ymq-2                                                                                                                                           |\n| bootable                              | false                                                                                                                                              |\n| consistencygroup_id                   | None                                                                                                                                               |\n| created_at                            | 2016-03-17T21:13:13.000000                                                                                                                         |\n| description                           | None                                                                                                                                               |\n| encrypted                             | False                                                                                                                                              |\n| id                                    | a2bba82c-ef08-48fe-9c3c-eafc8644207c                                                                                                               |\n| multiattach                           | False                                                                                                                                              |\n| name                                  | clarkb-test                                                                                                                                        |\n| os-vol-tenant-attr:tenant_id          | tenantid                                                                                                                                           |\n| os-volume-replication:driver_data     | None                                                                                                                                               |\n| os-volume-replication:extended_status | None                                                                                                                                               |\n| properties                            | attached_mode='rw', readonly='False'                                                                                                               |\n| replication_status                    | disabled                                                                                                                                           |\n| size                                  | 100                                                                                                                                                |\n| snapshot_id                           | None                                                                                                                                               |\n| source_volid                          | None                                                                                                                                               |\n| status                                | in-use                                                                                                                                             |\n| type                                  | None                                                                                                                                               |\n| user_id                               | userid                                                                                                                                             |\n+---------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+\n$ ssh ubuntu@199.19.213.70 ls -l /dev/disk/by-id\ntotal 0\nlrwxrwxrwx 1 root root 9 Mar 17 21:13 virtio-a2bba82c-ef08-48fe-9 -> ../../vdc\n$ ssh ubuntu@199.19.213.70 ls -l /dev/disk/by-label\ntotal 0\nlrwxrwxrwx 1 root root 10 Mar 17 21:12 cloudimg-rootfs -> ../../vda1\nlrwxrwxrwx 1 root root  9 Mar 17 21:12 config-2 -> ../../vdb\n\n\nAs a workaround we have specified the device path when attaching the volume but this is apparently deprecated and not expected to work properly. Therefore it is important that volume show report the correct device path.\n\nOne possible option here if libvirt cannot provide this info reliably is that cinder/nova seem to reliably use /dev/by-id/virtio-someportionofvolumeuuidhere. The api could possibly return this path instead since it is deterministic.", 
    "tags": [
        "libvirt", 
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1558807", 
    "owner": "None", 
    "id": 1558807, 
    "index": 7379, 
    "openned": "2016-03-17 21:47:14.190753+00:00", 
    "created": "2016-03-17 21:47:14.190753+00:00", 
    "title": "Volume attached at different path than reported by nova/cinder when using config drive", 
    "comments": [
        {
            "content": "When booting a node with config drive then attaching a cinder volume we see conflicting information about where the cinder volume is attached. In this case the config drive is at /dev/vdb, the cinder volume is at /dev/vdc but volume show reports the cinder volume to be at /dev/vdb.\n\nThis shows how one can get nova/cinder in this state using openstackclient (assuming that config drives attach to /dev/vdb):\n\n$ OS_CLIENT_CONFIG_FILE=../vexxhost/vexx.yaml venv/bin/openstack --os-cloud openstackci-vexxhost server create --config-drive True --key-name clarkb-work --image ubuntu-trusty --flavor v1-standard-2 clarkb-test\n+--------------------------------------+------------------------------------------------------+\n| Field                                | Value                                                |\n+--------------------------------------+------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                               |\n| OS-EXT-AZ:availability_zone          |                                                      |\n| OS-EXT-STS:power_state               | 0                                                    |\n| OS-EXT-STS:task_state                | scheduling                                           |\n| OS-EXT-STS:vm_state                  | building                                             |\n| OS-SRV-USG:launched_at               | None                                                 |\n| OS-SRV-USG:terminated_at             | None                                                 |\n| accessIPv4                           |                                                      |\n| accessIPv6                           |                                                      |\n| addresses                            |                                                      |\n| adminPass                            | redacted                                             |\n| config_drive                         | True                                                 |\n| created                              | 2016-03-17T21:12:38Z                                 |\n| flavor                               | v1-standard-2 (ca2a6e9c-2236-4107-8905-7ae9427132ff) |\n| hostId                               |                                                      |\n| id                                   | cdaf7671-5a5c-4118-a422-d8aae096bd1e                 |\n| image                                | ubuntu-trusty (d42c4ce4-3fa0-4dcb-877e-1d66a05a4f8d) |\n| key_name                             | clarkb-work                                          |\n| name                                 | clarkb-test                                          |\n| os-extended-volumes:volumes_attached | []                                                   |\n| progress                             | 0                                                    |\n| project_id                           | projectid                                            |\n| properties                           |                                                      |\n| security_groups                      | [{u'name': u'default'}]                              |\n| status                               | BUILD                                                |\n| updated                              | 2016-03-17T21:12:38Z                                 |\n| user_id                              | userid                                               |\n+--------------------------------------+------------------------------------------------------+\n$ OS_CLIENT_CONFIG_FILE=../vexxhost/vexx.yaml venv/bin/openstack --os-cloud openstackci-vexxhost volume create --size 100 clarkb-test\n+---------------------+--------------------------------------+\n| Field               | Value                                |\n+---------------------+--------------------------------------+\n| attachments         | []                                   |\n| availability_zone   | ca-ymq-2                             |\n| bootable            | false                                |\n| consistencygroup_id | None                                 |\n| created_at          | 2016-03-17T21:13:13.683882           |\n| description         | None                                 |\n| encrypted           | False                                |\n| id                  | a2bba82c-ef08-48fe-9c3c-eafc8644207c |\n| multiattach         | False                                |\n| name                | clarkb-test                          |\n| properties          |                                      |\n| replication_status  | disabled                             |\n| size                | 100                                  |\n| snapshot_id         | None                                 |\n| source_volid        | None                                 |\n| status              | creating                             |\n| type                | None                                 |\n| user_id             | userid                               |\n+---------------------+--------------------------------------+\n$ OS_CLIENT_CONFIG_FILE=../vexxhost/vexx.yaml venv/bin/openstack --os-cloud openstackci-vexxhost server add volume clarkb-test clarkb-test\n$ OS_CLIENT_CONFIG_FILE=../vexxhost/vexx.yaml venv/bin/openstack --os-cloud openstackci-vexxhost volume show clarkb-test\n+---------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+\n| Field                                 | Value                                                                                                                                              |\n+---------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+\n| attachments                           | [{u'server_id': u'cdaf7671-5a5c-4118-a422-d8aae096bd1e', u'attachment_id': u'18f184b3-123e-4b5c-af66-d5c5b93af5ed', u'host_name': None,            |\n|                                       | u'volume_id': u'a2bba82c-ef08-48fe-9c3c-eafc8644207c', u'device': u'/dev/vdb', u'id': u'a2bba82c-ef08-48fe-9c3c-eafc8644207c'}]                    |\n| availability_zone                     | ca-ymq-2                                                                                                                                           |\n| bootable                              | false                                                                                                                                              |\n| consistencygroup_id                   | None                                                                                                                                               |\n| created_at                            | 2016-03-17T21:13:13.000000                                                                                                                         |\n| description                           | None                                                                                                                                               |\n| encrypted                             | False                                                                                                                                              |\n| id                                    | a2bba82c-ef08-48fe-9c3c-eafc8644207c                                                                                                               |\n| multiattach                           | False                                                                                                                                              |\n| name                                  | clarkb-test                                                                                                                                        |\n| os-vol-tenant-attr:tenant_id          | tenantid                                                                                                                                           |\n| os-volume-replication:driver_data     | None                                                                                                                                               |\n| os-volume-replication:extended_status | None                                                                                                                                               |\n| properties                            | attached_mode='rw', readonly='False'                                                                                                               |\n| replication_status                    | disabled                                                                                                                                           |\n| size                                  | 100                                                                                                                                                |\n| snapshot_id                           | None                                                                                                                                               |\n| source_volid                          | None                                                                                                                                               |\n| status                                | in-use                                                                                                                                             |\n| type                                  | None                                                                                                                                               |\n| user_id                               | userid                                                                                                                                             |\n+---------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+\n$ ssh ubuntu@199.19.213.70 ls -l /dev/disk/by-id\ntotal 0\nlrwxrwxrwx 1 root root 9 Mar 17 21:13 virtio-a2bba82c-ef08-48fe-9 -> ../../vdc\n$ ssh ubuntu@199.19.213.70 ls -l /dev/disk/by-label\ntotal 0\nlrwxrwxrwx 1 root root 10 Mar 17 21:12 cloudimg-rootfs -> ../../vda1\nlrwxrwxrwx 1 root root  9 Mar 17 21:12 config-2 -> ../../vdb\n\n\nAs a workaround we have specified the device path when attaching the volume but this is apparently deprecated and not expected to work properly. Therefore it is important that volume show report the correct device path.\n\nOne possible option here if libvirt cannot provide this info reliably is that cinder/nova seem to reliably use /dev/by-id/virtio-someportionofvolumeuuidhere. The api could possibly return this path instead since it is deterministic.", 
            "date_created": "2016-03-17 21:47:14.190753+00:00", 
            "author": "https://api.launchpad.net/1.0/~cboylan"
        }, 
        {
            "content": "Possibly related to https://bugs.launchpad.net/nova/+bug/1558343/comments/2", 
            "date_created": "2016-03-18 08:35:20.143765+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "Nevermind my previous comment #1", 
            "date_created": "2016-03-18 08:36:08.816942+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "Hmm, might be that when nova attaches the volume it's assuming /dev/vdb is available and that's what it tells cinder it's going to attach to:\n\nhttps://github.com/openstack/nova/blob/a023c32c70b5ddbae122636c26ed32e5dcba66b2/nova/virt/block_device.py#L304\n\nBut the block_device_info code isn't taking into account the config drive?  Probably need ndipanov to look at this.", 
            "date_created": "2016-03-18 21:28:27.824093+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Appears to be an issue on the Nova side, but marking Cinder as Invalid for now instead of removing it in case there are any changes required on the Cinder side to address this.", 
            "date_created": "2016-03-20 21:53:22.707380+00:00", 
            "author": "https://api.launchpad.net/1.0/~sean-mcginnis"
        }, 
        {
            "content": "Note that in liberty, the libvirt driver should be ignoring any user-requested device name:\n\nhttps://review.openstack.org/#/c/189632/\n\nSo I'm not sure how you can workaround this by specifying a device name.", 
            "date_created": "2016-03-21 15:54:18.834061+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Nova's libvirt driver has code that is trying to account for the presence of a config drive, but looking at it - it will always give it the highest letter on it's bus, so volumes will come before it.\n\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/virt/libvirt/blockinfo.py?id=f03bbbab68408e0b3a311256962211b4f5d2cd1e#n599\n\nIf this does not match with the behavior libvirt exhibits - it could be a bug in Nova (we try to mimic libvirt), or it may be down to libvirt having changed something.\n\nIt would be really good to know the version of libvirt this was tested against.", 
            "date_created": "2016-03-21 17:19:40.260236+00:00", 
            "author": "https://api.launchpad.net/1.0/~ndipanov"
        }, 
        {
            "content": "Clark, could you provide the version of libvirt? Thanks!", 
            "date_created": "2016-03-29 23:52:03.407330+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "No I cannot because I do not run the cloud I am merely a cloud user. But I can ask the folks at vexxhost to provide this info if they are able.", 
            "date_created": "2016-03-30 00:02:17.791650+00:00", 
            "author": "https://api.launchpad.net/1.0/~cboylan"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2016-05-29 04:18:19.663088+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }, 
        {
            "content": "I am currently experiencing this problem and would like to add more information.\n\nI have a Mitaka installation that exhibits this behavior when attaching a volume to a running instance with a config drive. The config drive is attached as /dev/vdb, and the requested volume is correctly attached at /dev/vdc. However, the attach point for the volume reported in horizon and in the openstack client is /dev/vdb, the same device as the config drive.\n\nlibvirt version:\n libvirtd (libvirt) 1.2.9.3\n", 
            "date_created": "2016-09-10 22:51:15.066260+00:00", 
            "author": "https://api.launchpad.net/1.0/~jimt"
        }, 
        {
            "content": "This was moved to \"New\" status because the missing libvirt version info has now been provided. Clark confirmed this was a sufficient update to his original bug report.", 
            "date_created": "2016-09-14 17:53:29.395517+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "I propose we close this as invalid because:\n\n1. We're not going to fix it (and can't for things like KVM)\n2. We've discussed removing it from the API in a microversion because it's usually a lie\n3. We have other (imperfect, but better) ways of exposing this as of newton (i.e. device metadata)\n\nThe use case here is, of course, completely valid and the concerns over not being able to identify devices that are attached (volumes, nics, etc) are very important. The device metadata work set out to fix that, and largely has, IMHO, modulo the unchangeably static nature of configdrive.", 
            "date_created": "2016-09-14 18:53:40.549581+00:00", 
            "author": "https://api.launchpad.net/1.0/~danms"
        }
    ], 
    "closed": "2016-12-09 12:46:11.631857+00:00"
}