{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:52:16.351925+00:00", 
    "description": "Steps to reproduce:\n\n* Create volume vol-1 \n* Create instance vm-1\n* Attach vol-1 to vm-1\n\nAssuming both are created in local datastore ds-1 accessible to esx host h-1\n\n* Migrate vm-1 to a different esx host h-2 and datastore ds-2\n* Now detach vol-1", 
    "tags": [], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1425486", 
    "owner": "https://api.launchpad.net/1.0/~vbala", 
    "id": 1425486, 
    "index": 1554, 
    "openned": "2015-02-25 12:06:08.316082+00:00", 
    "created": "2015-02-25 12:06:08.316082+00:00", 
    "title": "VMware: Detach volume fails with 'Unable to access the virtual machine configuration: Unable to access file'", 
    "comments": [
        {
            "content": "Steps to reproduce:\n\n* Create volume vol-1 \n* Create instance vm-1\n* Attach vol-1 to vm-1\n\nAssuming both are created in local datastore ds-1 accessible to esx host h-1\n\n* Migrate vm-1 to a different esx host h-2 and datastore ds-2\n* Now detach vol-1", 
            "date_created": "2015-02-25 12:06:08.316082+00:00", 
            "author": "https://api.launchpad.net/1.0/~vbala"
        }, 
        {
            "content": "2015-02-25 17:13:43.949 INFO nova.virt.vmwareapi.volumeops [req-b68251a2-7761-4005-a486-dfcc9ddad69f admin demo] The volume's backing has been relocated to [datastore3] 1f04baca-e30a-45d8-899f-5dafe1eff671/1f04baca-e30a-45d8-899f-5dafe1eff671_3.vmdk. Need to consolidate backing disk file.\n2015-02-25 17:13:43.949 DEBUG oslo_vmware.api [req-b68251a2-7761-4005-a486-dfcc9ddad69f admin demo] Waiting for function _invoke_api to return. from (pid=19982) func /opt/stack/oslo.vmware/oslo_vmware/api.py:121\n2015-02-25 17:13:43.964 DEBUG oslo_vmware.api [req-b68251a2-7761-4005-a486-dfcc9ddad69f admin demo] Waiting for function _invoke_api to return. from (pid=19982) func /opt/stack/oslo.vmware/oslo_vmware/api.py:121\n2015-02-25 17:13:43.976 DEBUG oslo_vmware.api [req-b68251a2-7761-4005-a486-dfcc9ddad69f admin demo] Waiting for function _invoke_api to return. from (pid=19982) func /opt/stack/oslo.vmware/oslo_vmware/api.py:121\n2015-02-25 17:13:43.989 DEBUG oslo_vmware.api [req-b68251a2-7761-4005-a486-dfcc9ddad69f admin demo] Waiting for function _invoke_api to return. from (pid=19982) func /opt/stack/oslo.vmware/oslo_vmware/api.py:121\n2015-02-25 17:13:44.010 DEBUG oslo_vmware.api [req-b68251a2-7761-4005-a486-dfcc9ddad69f admin demo] Waiting for the task: (returnval){\n   value = \"task-3895\"\n   _type = \"Task\"\n } to complete. from (pid=19982) wait_for_task /opt/stack/oslo.vmware/oslo_vmware/api.py:379\n2015-02-25 17:13:44.011 DEBUG oslo_vmware.api [-] Invoking VIM API to read info of task: (returnval){\n   value = \"task-3895\"\n   _type = \"Task\"\n }. from (pid=19982) _poll_task /opt/stack/oslo.vmware/oslo_vmware/api.py:391\n2015-02-25 17:13:44.011 DEBUG oslo_vmware.api [-] Waiting for function _invoke_api to return. from (pid=19982) func /opt/stack/oslo.vmware/oslo_vmware/api.py:121\n2015-02-25 17:13:44.512 DEBUG oslo_vmware.api [-] Invoking VIM API to read info of task: (returnval){\n   value = \"task-3895\"\n   _type = \"Task\"\n }. from (pid=19982) _poll_task /opt/stack/oslo.vmware/oslo_vmware/api.py:391\n2015-02-25 17:13:44.512 DEBUG oslo_vmware.api [-] Waiting for function _invoke_api to return. from (pid=19982) func /opt/stack/oslo.vmware/oslo_vmware/api.py:121\n2015-02-25 17:13:44.530 DEBUG oslo_vmware.exceptions [-] Fault CannotAccessVmConfig not matched. from (pid=19982) get_fault_class /opt/stack/oslo.vmware/oslo_vmware/exceptions.py:250\n2015-02-25 17:13:44.530 ERROR oslo_vmware.common.loopingcall [-] in fixed duration looping call\n2015-02-25 17:13:44.530 TRACE oslo_vmware.common.loopingcall Traceback (most recent call last):\n2015-02-25 17:13:44.530 TRACE oslo_vmware.common.loopingcall   File \"/opt/stack/oslo.vmware/oslo_vmware/common/loopingcall.py\", line 76, in _inner\n2015-02-25 17:13:44.530 TRACE oslo_vmware.common.loopingcall     self.f(*self.args, **self.kw)\n2015-02-25 17:13:44.530 TRACE oslo_vmware.common.loopingcall   File \"/opt/stack/oslo.vmware/oslo_vmware/api.py\", line 417, in _poll_task\n2015-02-25 17:13:44.530 TRACE oslo_vmware.common.loopingcall     raise task_ex\n2015-02-25 17:13:44.530 TRACE oslo_vmware.common.loopingcall VMwareDriverException: Unable to access the virtual machine configuration: Unable to access file [datastore3]\n2015-02-25 17:13:44.530 TRACE oslo_vmware.common.loopingcall \n2015-02-25 17:13:44.531 ERROR nova.compute.manager [req-b68251a2-7761-4005-a486-dfcc9ddad69f admin demo] [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671] Failed to detach volume fbf3b31d-3224-4fa8-aedb-8643afaf0663 from /dev/sdb\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671] Traceback (most recent call last):\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/opt/stack/nova/nova/compute/manager.py\", line 4678, in _detach_volume\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     encryption=encryption)\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/opt/stack/nova/nova/virt/vmwareapi/driver.py\", line 487, in detach_volume\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     instance)\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/opt/stack/nova/nova/virt/vmwareapi/volumeops.py\", line 527, in detach_volume\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     self._detach_volume_vmdk(connection_info, instance)\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/opt/stack/nova/nova/virt/vmwareapi/volumeops.py\", line 492, in _detach_volume_vmdk\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     disk_type=vmdk.disk_type)\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/opt/stack/nova/nova/virt/vmwareapi/volumeops.py\", line 443, in _consolidate_vmdk_volume\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     self._relocate_vmdk_volume(volume_ref, res_pool, datastore)\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/opt/stack/nova/nova/virt/vmwareapi/volumeops.py\", line 382, in _relocate_vmdk_volume\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     self._session._wait_for_task(task)\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/opt/stack/nova/nova/virt/vmwareapi/driver.py\", line 673, in _wait_for_task\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     return self.wait_for_task(task_ref)\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/opt/stack/oslo.vmware/oslo_vmware/api.py\", line 380, in wait_for_task\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     return evt.wait()\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 121, in wait\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     return hubs.get_hub().switch()\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 294, in switch\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     return self.greenlet.switch()\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/opt/stack/oslo.vmware/oslo_vmware/common/loopingcall.py\", line 76, in _inner\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     self.f(*self.args, **self.kw)\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]   File \"/opt/stack/oslo.vmware/oslo_vmware/api.py\", line 417, in _poll_task\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671]     raise task_ex\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671] VMwareDriverException: Unable to access the virtual machine configuration: Unable to access file [datastore3]\n2015-02-25 17:13:44.531 TRACE nova.compute.manager [instance: 1f04baca-e30a-45d8-899f-5dafe1eff671] \n", 
            "date_created": "2015-02-25 12:36:18.872685+00:00", 
            "author": "https://api.launchpad.net/1.0/~vbala"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/159737", 
            "date_created": "2015-02-27 07:42:12.254053+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/159737\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7ec3d2b0a7b7981bce92f1c5358863f445806cf5\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7ec3d2b0a7b7981bce92f1c5358863f445806cf5\nAuthor: Vipin Balachandran <email address hidden>\nDate:   Wed Feb 4 15:29:58 2015 +0530\n\n    VMware: Fix volume relocate during detach\n    \n    During volume detach, volume's shadow VM might need to be\n    relocated if storage DRS moved the Nova instance along with\n    volume's vmdk. The shadow VM is relocated to the current\n    datastore of instance and it's virtual disk is updated. For\n    relocate, we are not setting the destination host and it\n    defaults to source host. This can result in relocate failure\n    if this host cannot access the destination datastore. This\n    patch sets the destination host correctly to that of instance.\n    \n    Change-Id: If51bbef6e2ca811e2fffdca906645cc963c27a3e\n    Closes-Bug: #1425486\n", 
            "date_created": "2015-04-15 00:12:16.600584+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-06-24 12:20:14.809151+00:00"
}