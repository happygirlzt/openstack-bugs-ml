{
    "status": "Fix Released", 
    "last_updated": "2013-01-22 16:06:56.771765+00:00", 
    "description": "Now that nova-rootwrap is returning real return codes, ensure_metadata_ip() is failing on return code 2 when creating the metadata ip, because it already exists:\n\n2012-02-08 15:30:13,309 DEBUG nova.utils [-] Running cmd (subprocess): sudo nova-rootwrap ip addr add 169.254.169.254/32 scope link dev lo from (pid=8942) execute /usr/lib/python2.7/dist-packages/nova/utils.py:208\n2012-02-08 15:30:13,339 DEBUG nova.utils [-] Result was 2 from (pid=8942) execute /usr/lib/python2.7/dist-packages/nova/utils.py:224\n2012-02-08 15:30:13,340 CRITICAL nova [-] Unexpected error while running command.\nCommand: sudo nova-rootwrap ip addr add 169.254.169.254/32 scope link dev lo\nExit code: 2\nStdout: ''\nStderr: 'RTNETLINK answers: File exists\\n'\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/bin/nova-network\", line 49, in <module>\n(nova): TRACE:     service.wait()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 414, in wait\n(nova): TRACE:     _launcher.wait()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 134, in wait\n(nova): TRACE:     service.wait()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 166, in wait\n(nova): TRACE:     return self._exit_event.wait()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/event.py\", line 116, in wait\n(nova): TRACE:     return hubs.get_hub().switch()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n(nova): TRACE:     return self.greenlet.switch()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n(nova): TRACE:     result = function(*args, **kwargs)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 104, in run_server\n(nova): TRACE:     server.start()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 164, in start\n(nova): TRACE:     self.manager.init_host()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1558, in init_host\n(nova): TRACE:     self.l3driver.initialize()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/l3.py\", line 81, in initialize\n(nova): TRACE:     linux_net.ensure_metadata_ip()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 479, in ensure_metadata_ip\n(nova): TRACE:     run_as_root=True, check_exit_code=[0, 254])\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 839, in _execute\n(nova): TRACE:     return utils.execute(*cmd, **kwargs)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 232, in execute\n(nova): TRACE:     cmd=' '.join(cmd))\n(nova): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova): TRACE: Command: sudo nova-rootwrap ip addr add 169.254.169.254/32 scope link dev lo\n(nova): TRACE: Exit code: 2\n(nova): TRACE: Stdout: ''\n(nova): TRACE: Stderr: 'RTNETLINK answers: File exists\\n'\n(nova): TRACE:\n\nThere seems to have been a change upstream wrt return codes from iproute:\n\nroot@ip-10-252-15-139:~# dpkg -l | grep iproute\nii  iproute                             20110629-1                              networking and traffic control tools\nroot@ip-10-252-15-139:~# sudo ip addr add 169.254.169.254/32 scope link dev lo  ; echo $?\nRTNETLINK answers: File exists\n254\n\nProcessing triggers for man-db ...\nSetting up iproute (20111117-1ubuntu1) ...\nroot@ip-10-252-15-139:~# sudo ip addr add 169.254.169.254/32 scope link dev lo  ; echo $?\nRTNETLINK answers: File exists\n2\n\nUpdate, the correct upstream commit:\nhttp://git.kernel.org/?p=linux/kernel/git/shemminger/iproute2.git;a=commit;h=7397944de6c11519a5951fc1bcff20225e71c4bd\n\n\nSeems like a crazy change, but in any case, precise is now on this version and nova-network should check for both 2 and 254.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/929127", 
    "owner": "https://api.launchpad.net/1.0/~gandelman-a", 
    "id": 929127, 
    "index": 3812, 
    "openned": "2012-02-08 21:31:52.268324+00:00", 
    "created": "2012-02-08 21:31:52.268324+00:00", 
    "title": "linux_net.ensure_metadata_ip() fails on precise", 
    "comments": [
        {
            "content": "\nNow that nova-rootwrap is returning real return codes, ensure_metadata_ip() is failing on return code 2 when creating the metadata ip, because it already exists:\n\n2012-02-08 15:30:13,309 DEBUG nova.utils [-] Running cmd (subprocess): sudo nova-rootwrap ip addr add 169.254.169.254/32 scope link dev lo from (pid=8942) execute /usr/lib/python2.7/dist-packages/nova/utils.py:208\n2012-02-08 15:30:13,339 DEBUG nova.utils [-] Result was 2 from (pid=8942) execute /usr/lib/python2.7/dist-packages/nova/utils.py:224\n2012-02-08 15:30:13,340 CRITICAL nova [-] Unexpected error while running command.\nCommand: sudo nova-rootwrap ip addr add 169.254.169.254/32 scope link dev lo\nExit code: 2\nStdout: ''\nStderr: 'RTNETLINK answers: File exists\\n'\n(nova): TRACE: Traceback (most recent call last):\n(nova): TRACE:   File \"/usr/bin/nova-network\", line 49, in <module>\n(nova): TRACE:     service.wait()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 414, in wait\n(nova): TRACE:     _launcher.wait()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 134, in wait\n(nova): TRACE:     service.wait()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 166, in wait\n(nova): TRACE:     return self._exit_event.wait()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/event.py\", line 116, in wait\n(nova): TRACE:     return hubs.get_hub().switch()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n(nova): TRACE:     return self.greenlet.switch()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n(nova): TRACE:     result = function(*args, **kwargs)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 104, in run_server\n(nova): TRACE:     server.start()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 164, in start\n(nova): TRACE:     self.manager.init_host()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1558, in init_host\n(nova): TRACE:     self.l3driver.initialize()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/l3.py\", line 81, in initialize\n(nova): TRACE:     linux_net.ensure_metadata_ip()\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 479, in ensure_metadata_ip\n(nova): TRACE:     run_as_root=True, check_exit_code=[0, 254])\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 839, in _execute\n(nova): TRACE:     return utils.execute(*cmd, **kwargs)\n(nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 232, in execute\n(nova): TRACE:     cmd=' '.join(cmd))\n(nova): TRACE: ProcessExecutionError: Unexpected error while running command.\n(nova): TRACE: Command: sudo nova-rootwrap ip addr add 169.254.169.254/32 scope link dev lo\n(nova): TRACE: Exit code: 2\n(nova): TRACE: Stdout: ''\n(nova): TRACE: Stderr: 'RTNETLINK answers: File exists\\n'\n(nova): TRACE: \n\nThere seems to have been a change upstream wrt return codes from iproute: \n\nroot@ip-10-252-15-139:~# dpkg -l | grep iproute\nii  iproute                             20110629-1                              networking and traffic control tools\nroot@ip-10-252-15-139:~# sudo ip addr add 169.254.169.254/32 scope link dev lo  ; echo $?\nRTNETLINK answers: File exists\n254\n\nProcessing triggers for man-db ...\nSetting up iproute (20111117-1ubuntu1) ...\nroot@ip-10-252-15-139:~# sudo ip addr add 169.254.169.254/32 scope link dev lo  ; echo $?\nRTNETLINK answers: File exists\n2\n\nSeems this has changed in upstream iproute2  - http://git.jauu.net/?p=iproute2.git;a=commitdiff;h=7397944de6c11519a5951fc1bcff20225e71c4bd\n\nSeems like a crazy change, but in any case, precise is now on this version and nova-network should check for both 2 and 254.", 
            "date_created": "2012-02-08 21:31:52.268324+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/3934", 
            "date_created": "2012-02-08 22:21:54.601198+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/3934\nCommitted: http://github.com/openstack/nova/commit/4804690ba401a23d62df489875da6c546d3224bb\nSubmitter: Jenkins\nBranch:    master\n\ncommit 4804690ba401a23d62df489875da6c546d3224bb\nAuthor: Adam Gandelman <email address hidden>\nDate:   Wed Feb 8 14:16:08 2012 -0800\n\n    linux_net: Also ignore shell error 2 from ip addr\n    \n    Ignores error code 2 from 'ip addr {add, del}' which, in recent\n    versions of iproute2, means the address has already been removed\n    or added.\n    \n    Fixes bug 929127\n    \n    Change-Id: I09274454847ff834ac3da0e38022b30a7a7f1676\n", 
            "date_created": "2012-02-10 23:14:02.247213+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This bug was fixed in the package nova - 2012.1~e4~20120217.12709-0ubuntu1\n\n---------------\nnova (2012.1~e4~20120217.12709-0ubuntu1) precise; urgency=low\n\n  [ Dave Walker (Daviey) ]\n  * New upstream snapshot\n  * debian/patches/temp_fix_linux_net.patch:\n    - Dropped, applied upstream. LP: #929127\n  * debian/patches/libvirt-use-console-pipe.patch:\n    - Rebased against latest trunk\n\n  [ Chuck Short ]\n  * debian/nova.conf: Re-enable default iscsi_helper.\n  * debian/nova.conf: More fixups.\n  * debian/control: Dont depend and conflicts on nova-compute-\n    hypervisor. (LP: #923681)\n  * debian/patches/libvirt-us-console-pipe.patch: Refreshed.\n  * Temporarily disable console patch. (LP: #932787)\n  * New usptream version.\n -- Chuck Short <email address hidden>   Fri, 17 Feb 2012 10:59:59 -0500", 
            "date_created": "2012-02-17 16:05:12.772383+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ], 
    "closed": "2012-02-29 10:26:34.392856+00:00"
}