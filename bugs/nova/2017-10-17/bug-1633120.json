{
    "status": "Confirmed", 
    "last_updated": "2017-06-27 15:59:12.415583+00:00", 
    "description": "Upon trying to create VM instance (Say A) with one QAT VF, it fails with the following error i.e., \u201cRequested operation is not valid: PCI device 0000:88:04.7 is in use by driver QEMU, domain instance-00000081\u201d. Please note that, PCI device 0000:88:04.7 is already being assigned to another VM (Say B) .  We have installed openstack-mitaka release on CentO7 system. It has two Intel QAT devices. There are 32 VF devices available per QAT Device/DH895xCC device Out of 64 VFs, only 8 VFs are allocated (to VM instances) and rest should be available.\nBut the nova scheduler tries to assign an already-in-use SRIOV VF to a new instance and instance fails. It appears that the nova database is not tracking which VF's have already been taken. But if I shut down VM B instance, then other instance VM A boots up and vice-versa. Note that, both the VM instances cannot run simultaneously because of the aforesaid issue.     \n\nWe should always be able to create as many instances with the requested PCI devices as there are available VFs.\n\nPlease feel free to let me know if additional information is needed. Can anyone please suggest why it tries to assign same PCI device which has been assigned already? Is there any way to resolve this issue? Thank you in advance for your support and help.\n\n[root@localhost ~(keystone_admin)]# lspci -d:435\n83:00.0 Co-processor: Intel Corporation DH895XCC Series QAT\n88:00.0 Co-processor: Intel Corporation DH895XCC Series QAT\n[root@localhost ~(keystone_admin)]#\n\n\n[root@localhost ~(keystone_admin)]# lspci -d:443 | grep \"QAT Virtual Function\" | wc -l\n64\n[root@localhost ~(keystone_admin)]#\n \n \n[root@localhost ~(keystone_admin)]# mysql -u root nova -e \"SELECT hypervisor_hostname, address, instance_uuid, status FROM pci_devices JOIN compute_nodes oncompute_nodes.id=compute_node_id\" | grep 0000:88:04.7\nlocalhost  0000:88:04.7    e10a76f3-e58e-4071-a4dd-7a545e8000de    allocated\nlocalhost  0000:88:04.7    c3dbac90-198d-4150-ba0f-a80b912d8021    allocated\nlocalhost  0000:88:04.7    c7f6adad-83f0-4881-b68f-6d154d565ce3    allocated\nlocalhost.nfv.benunets.com 0000:88:04.7    0c3c11a5-f9a4-4f0d-b120-40e4dde843d4    allocated\n[root@localhost ~(keystone_admin)]#\n \n[root@localhost ~(keystone_admin)]# grep -r e10a76f3-e58e-4071-a4dd-7a545e8000de /etc/libvirt/qemu\n/etc/libvirt/qemu/instance-00000081.xml:  <uuid>e10a76f3-e58e-4071-a4dd-7a545e8000de</uuid>\n/etc/libvirt/qemu/instance-00000081.xml:      <entry name='uuid'>e10a76f3-e58e-4071-a4dd-7a545e8000de</entry>\n/etc/libvirt/qemu/instance-00000081.xml:      <source file='/var/lib/nova/instances/e10a76f3-e58e-4071-a4dd-7a545e8000de/disk'/>\n/etc/libvirt/qemu/instance-00000081.xml:      <source path='/var/lib/nova/instances/e10a76f3-e58e-4071-a4dd-7a545e8000de/console.log'/>\n/etc/libvirt/qemu/instance-00000081.xml:      <source path='/var/lib/nova/instances/e10a76f3-e58e-4071-a4dd-7a545e8000de/console.log'/>\n[root@localhost ~(keystone_admin)]#\n[root@localhost ~(keystone_admin)]# grep -r 0c3c11a5-f9a4-4f0d-b120-40e4dde843d4 /etc/libvirt/qemu\n/etc/libvirt/qemu/instance-000000ab.xml:  <uuid>0c3c11a5-f9a4-4f0d-b120-40e4dde843d4</uuid>\n/etc/libvirt/qemu/instance-000000ab.xml:      <entry name='uuid'>0c3c11a5-f9a4-4f0d-b120-40e4dde843d4</entry>\n/etc/libvirt/qemu/instance-000000ab.xml:      <source file='/var/lib/nova/instances/0c3c11a5-f9a4-4f0d-b120-40e4dde843d4/disk'/>\n/etc/libvirt/qemu/instance-000000ab.xml:      <source path='/var/lib/nova/instances/0c3c11a5-f9a4-4f0d-b120-40e4dde843d4/console.log'/>\n/etc/libvirt/qemu/instance-000000ab.xml:      <source path='/var/lib/nova/instances/0c3c11a5-f9a4-4f0d-b120-40e4dde843d4/console.log'/>\n[root@localhost ~(keystone_admin)]#\n \nOn the controller, , it appears there are duplicate PCI device entries in the Database:\n \nMariaDB [nova]> select hypervisor_hostname,address,count(*) from pci_devices JOIN compute_nodes on compute_nodes.id=compute_node_id group by hypervisor_hostname,address having count(*) > 1;\n+---------------------+--------------+----------+\n| hypervisor_hostname | address      | count(*) |\n+---------------------+--------------+----------+\n| localhost              | 0000:05:00.0 |        3 |\n| localhost              | 0000:05:00.1 |        3 |\n| localhost              | 0000:83:01.0 |        3 |\n| localhost              | 0000:83:01.1 |        3 |\n| localhost              | 0000:83:01.2 |        3 |\n| localhost              | 0000:83:01.3 |        3 |\n| localhost              | 0000:83:01.4 |        3 |\n| localhost              | 0000:83:01.5 |        3 |\n| localhost              | 0000:83:01.6 |        3 |\n| localhost              | 0000:83:01.7 |        3 |\n| localhost              | 0000:83:02.0 |        3 |\n| localhost              | 0000:83:02.1 |        3 |\n| localhost              | 0000:83:02.2 |        3 |\n| localhost              | 0000:83:02.3 |        3 |\n| localhost              | 0000:83:02.4 |        3 |\n| localhost              | 0000:83:02.5 |        3 |\n| localhost              | 0000:83:02.6 |        3 |\n| localhost              | 0000:83:02.7 |        3 |\n| localhost              | 0000:83:03.0 |        3 |\n| localhost              | 0000:83:03.1 |        3 |\n| localhost              | 0000:83:03.2 |        3 |\n| localhost              | 0000:83:03.3 |        3 |\n| localhost              | 0000:83:03.4 |        3 |\n| localhost              | 0000:83:03.5 |        3 |\n| localhost              | 0000:83:03.6 |        3 |\n| localhost              | 0000:83:03.7 |        3 |\n| localhost              | 0000:83:04.0 |        3 |\n| localhost              | 0000:83:04.1 |        3 |\n| localhost              | 0000:83:04.2 |        3 |\n| localhost              | 0000:83:04.3 |        3 |\n| localhost              | 0000:83:04.4 |        3 |\n| localhost              | 0000:83:04.5 |        3 |\n| localhost              | 0000:83:04.6 |        3 |\n| localhost              | 0000:83:04.7 |        3 |\n| localhost              | 0000:88:01.0 |        3 |\n| localhost              | 0000:88:01.1 |        3 |\n| localhost              | 0000:88:01.2 |        3 |\n| localhost              | 0000:88:01.3 |        3 |\n| localhost              | 0000:88:01.4 |        3 |\n| localhost              | 0000:88:01.5 |        3 |\n| localhost              | 0000:88:01.6 |        3 |\n| localhost              | 0000:88:01.7 |        3 |\n| localhost              | 0000:88:02.0 |        3 |\n| localhost              | 0000:88:02.1 |        3 |\n| localhost              | 0000:88:02.2 |        3 |\n| localhost              | 0000:88:02.3 |        3 |\n| localhost              | 0000:88:02.4 |        3 |\n| localhost              | 0000:88:02.5 |        3 |\n| localhost              | 0000:88:02.6 |        3 |\n| localhost              | 0000:88:02.7 |        3 |\n| localhost              | 0000:88:03.0 |        3 |\n| localhost              | 0000:88:03.1 |        3 |\n| localhost              | 0000:88:03.2 |        3 |\n| localhost              | 0000:88:03.3 |        3 |\n| localhost              | 0000:88:03.4 |        3 |\n| localhost              | 0000:88:03.5 |        3 |\n| localhost              | 0000:88:03.6 |        3 |\n| localhost              | 0000:88:03.7 |        3 |\n| localhost              | 0000:88:04.0 |        3 |\n| localhost              | 0000:88:04.1 |        3 |\n| localhost              | 0000:88:04.2 |        3 |\n| localhost              | 0000:88:04.3 |        3 |\n| localhost              | 0000:88:04.4 |        3 |\n| localhost              | 0000:88:04.5 |        3 |\n| localhost              | 0000:88:04.6 |        3 |\n| localhost              | 0000:88:04.7 |        3 |\n+---------------------+--------------+----------+\n66 rows in set (0.00 sec)\n \nMariaDB [nova]>", 
    "tags": [
        "openstack-version.mitaka", 
        "pci"
    ], 
    "importance": "Undecided", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/1633120", 
    "owner": "None", 
    "id": 1633120, 
    "index": 7749, 
    "openned": "2016-10-13 15:37:09.348390+00:00", 
    "created": "2016-10-13 15:37:09.348390+00:00", 
    "title": "Nova scheduler tries to assign an already-in-use SRIOV QAT VF to a new instance", 
    "comments": [
        {
            "content": "Upon trying to create VM instance (Say A) with one QAT VF, it fails with the following error i.e., \u201cRequested operation is not valid: PCI device 0000:88:04.7 is in use by driver QEMU, domain instance-00000081\u201d. Please note that, PCI device 0000:88:04.7 is already being assigned to another VM (Say B) .  We have installed openstack-mitaka release on CentO7 system. It has two Intel QAT devices. There are 32 VF devices available per QAT Device/DH895xCC device Out of 64 VFs, only 8 VFs are allocated (to VM instances) and rest should be available.\nBut the nova scheduler tries to assign an already-in-use SRIOV VF to a new instance and instance fails. It appears that the nova database is not tracking which VF's have already been taken. But if I shut down VM B instance, then other instance VM A boots up and vice-versa. Note that, both the VM instances cannot run simultaneously because of the aforesaid issue.     \n\nWe should always be able to create as many instances with the requested PCI devices as there are available VFs.\n\nPlease feel free to let me know if additional information is needed. Can anyone please suggest why it tries to assign same PCI device which has been assigned already? Is there any way to resolve this issue? Thank you in advance for your support and help.\n\n[root@localhost ~(keystone_admin)]# lspci -d:435\n83:00.0 Co-processor: Intel Corporation DH895XCC Series QAT\n88:00.0 Co-processor: Intel Corporation DH895XCC Series QAT\n[root@localhost ~(keystone_admin)]#\n\n\n[root@localhost ~(keystone_admin)]# lspci -d:443 | grep \"QAT Virtual Function\" | wc -l\n64\n[root@localhost ~(keystone_admin)]#\n \n \n[root@localhost ~(keystone_admin)]# mysql -u root nova -e \"SELECT hypervisor_hostname, address, instance_uuid, status FROM pci_devices JOIN compute_nodes oncompute_nodes.id=compute_node_id\" | grep 0000:88:04.7\nlocalhost  0000:88:04.7    e10a76f3-e58e-4071-a4dd-7a545e8000de    allocated\nlocalhost  0000:88:04.7    c3dbac90-198d-4150-ba0f-a80b912d8021    allocated\nlocalhost  0000:88:04.7    c7f6adad-83f0-4881-b68f-6d154d565ce3    allocated\nlocalhost.nfv.benunets.com 0000:88:04.7    0c3c11a5-f9a4-4f0d-b120-40e4dde843d4    allocated\n[root@localhost ~(keystone_admin)]#\n \n[root@localhost ~(keystone_admin)]# grep -r e10a76f3-e58e-4071-a4dd-7a545e8000de /etc/libvirt/qemu\n/etc/libvirt/qemu/instance-00000081.xml:  <uuid>e10a76f3-e58e-4071-a4dd-7a545e8000de</uuid>\n/etc/libvirt/qemu/instance-00000081.xml:      <entry name='uuid'>e10a76f3-e58e-4071-a4dd-7a545e8000de</entry>\n/etc/libvirt/qemu/instance-00000081.xml:      <source file='/var/lib/nova/instances/e10a76f3-e58e-4071-a4dd-7a545e8000de/disk'/>\n/etc/libvirt/qemu/instance-00000081.xml:      <source path='/var/lib/nova/instances/e10a76f3-e58e-4071-a4dd-7a545e8000de/console.log'/>\n/etc/libvirt/qemu/instance-00000081.xml:      <source path='/var/lib/nova/instances/e10a76f3-e58e-4071-a4dd-7a545e8000de/console.log'/>\n[root@localhost ~(keystone_admin)]#\n[root@localhost ~(keystone_admin)]# grep -r 0c3c11a5-f9a4-4f0d-b120-40e4dde843d4 /etc/libvirt/qemu\n/etc/libvirt/qemu/instance-000000ab.xml:  <uuid>0c3c11a5-f9a4-4f0d-b120-40e4dde843d4</uuid>\n/etc/libvirt/qemu/instance-000000ab.xml:      <entry name='uuid'>0c3c11a5-f9a4-4f0d-b120-40e4dde843d4</entry>\n/etc/libvirt/qemu/instance-000000ab.xml:      <source file='/var/lib/nova/instances/0c3c11a5-f9a4-4f0d-b120-40e4dde843d4/disk'/>\n/etc/libvirt/qemu/instance-000000ab.xml:      <source path='/var/lib/nova/instances/0c3c11a5-f9a4-4f0d-b120-40e4dde843d4/console.log'/>\n/etc/libvirt/qemu/instance-000000ab.xml:      <source path='/var/lib/nova/instances/0c3c11a5-f9a4-4f0d-b120-40e4dde843d4/console.log'/>\n[root@localhost ~(keystone_admin)]#\n \nOn the controller, , it appears there are duplicate PCI device entries in the Database:\n \nMariaDB [nova]> select hypervisor_hostname,address,count(*) from pci_devices JOIN compute_nodes on compute_nodes.id=compute_node_id group by hypervisor_hostname,address having count(*) > 1;\n+---------------------+--------------+----------+\n| hypervisor_hostname | address      | count(*) |\n+---------------------+--------------+----------+\n| localhost              | 0000:05:00.0 |        3 |\n| localhost              | 0000:05:00.1 |        3 |\n| localhost              | 0000:83:01.0 |        3 |\n| localhost              | 0000:83:01.1 |        3 |\n| localhost              | 0000:83:01.2 |        3 |\n| localhost              | 0000:83:01.3 |        3 |\n| localhost              | 0000:83:01.4 |        3 |\n| localhost              | 0000:83:01.5 |        3 |\n| localhost              | 0000:83:01.6 |        3 |\n| localhost              | 0000:83:01.7 |        3 |\n| localhost              | 0000:83:02.0 |        3 |\n| localhost              | 0000:83:02.1 |        3 |\n| localhost              | 0000:83:02.2 |        3 |\n| localhost              | 0000:83:02.3 |        3 |\n| localhost              | 0000:83:02.4 |        3 |\n| localhost              | 0000:83:02.5 |        3 |\n| localhost              | 0000:83:02.6 |        3 |\n| localhost              | 0000:83:02.7 |        3 |\n| localhost              | 0000:83:03.0 |        3 |\n| localhost              | 0000:83:03.1 |        3 |\n| localhost              | 0000:83:03.2 |        3 |\n| localhost              | 0000:83:03.3 |        3 |\n| localhost              | 0000:83:03.4 |        3 |\n| localhost              | 0000:83:03.5 |        3 |\n| localhost              | 0000:83:03.6 |        3 |\n| localhost              | 0000:83:03.7 |        3 |\n| localhost              | 0000:83:04.0 |        3 |\n| localhost              | 0000:83:04.1 |        3 |\n| localhost              | 0000:83:04.2 |        3 |\n| localhost              | 0000:83:04.3 |        3 |\n| localhost              | 0000:83:04.4 |        3 |\n| localhost              | 0000:83:04.5 |        3 |\n| localhost              | 0000:83:04.6 |        3 |\n| localhost              | 0000:83:04.7 |        3 |\n| localhost              | 0000:88:01.0 |        3 |\n| localhost              | 0000:88:01.1 |        3 |\n| localhost              | 0000:88:01.2 |        3 |\n| localhost              | 0000:88:01.3 |        3 |\n| localhost              | 0000:88:01.4 |        3 |\n| localhost              | 0000:88:01.5 |        3 |\n| localhost              | 0000:88:01.6 |        3 |\n| localhost              | 0000:88:01.7 |        3 |\n| localhost              | 0000:88:02.0 |        3 |\n| localhost              | 0000:88:02.1 |        3 |\n| localhost              | 0000:88:02.2 |        3 |\n| localhost              | 0000:88:02.3 |        3 |\n| localhost              | 0000:88:02.4 |        3 |\n| localhost              | 0000:88:02.5 |        3 |\n| localhost              | 0000:88:02.6 |        3 |\n| localhost              | 0000:88:02.7 |        3 |\n| localhost              | 0000:88:03.0 |        3 |\n| localhost              | 0000:88:03.1 |        3 |\n| localhost              | 0000:88:03.2 |        3 |\n| localhost              | 0000:88:03.3 |        3 |\n| localhost              | 0000:88:03.4 |        3 |\n| localhost              | 0000:88:03.5 |        3 |\n| localhost              | 0000:88:03.6 |        3 |\n| localhost              | 0000:88:03.7 |        3 |\n| localhost              | 0000:88:04.0 |        3 |\n| localhost              | 0000:88:04.1 |        3 |\n| localhost              | 0000:88:04.2 |        3 |\n| localhost              | 0000:88:04.3 |        3 |\n| localhost              | 0000:88:04.4 |        3 |\n| localhost              | 0000:88:04.5 |        3 |\n| localhost              | 0000:88:04.6 |        3 |\n| localhost              | 0000:88:04.7 |        3 |\n+---------------------+--------------+----------+\n66 rows in set (0.00 sec)\n \nMariaDB [nova]>", 
            "date_created": "2016-10-13 15:37:09.348390+00:00", 
            "author": "https://api.launchpad.net/1.0/~ckdwibedy"
        }, 
        {
            "content": "I ran into a very similar issue with GPU passthrough (satble/mitaka from ubuntu cloudarchive on 14.04).\n\nIn my case there was a config management bug on my end which removed the active devices from the nova DB and then when the config was fixed nova created new \"available\" records for all the devices including the ones currently in use.\n\nI think nova should check if duplicate \"deleted\" records exist and undletete them checking if the assinged instance if there is one still exists, if it does  leave it assigned if it doesn't mark the resource as available in addition to undeleting.\n\nexample DB state:\n> SELECT created_at,deleted_at,deleted,id,compute_node_id,address,status,instance_uuid FROM pci_devices WHERE address='0000:09:00.0';\n+---------------------+---------------------+---------+----+-----------------+--------------+-----------+--------------------------------------+\n| created_at          | deleted_at          | deleted | id | compute_node_id | address      | status    | instance_uuid                        |\n+---------------------+---------------------+---------+----+-----------------+--------------+-----------+--------------------------------------+\n| 2016-07-06 00:12:30 | 2016-10-13 21:04:53 |       4 |  4 |              90 | 0000:09:00.0 | allocated | 9269391a-4ce4-4c8d-993d-5ad7a9c3879b |\n| 2016-10-18 18:01:35 | NULL                |       0 | 12 |              90 | 0000:09:00.0 | available | NULL                                 |\n+---------------------+---------------------+---------+----+-----------------+--------------+-----------+--------------------------------------+\n\nIn this case instance ID 9269391a-4ce4-4c8d-993d-5ad7a9c3879b did exist and was using PCI 09:00.0 but it was associated in the deleted row.\n\nI only had three devices which were affected by this (and in use) so could relatively easily fix by hand.  I wonder the SRIOV issue is the same.", 
            "date_created": "2016-10-19 14:10:18.926882+00:00", 
            "author": "https://api.launchpad.net/1.0/~jproulx"
        }, 
        {
            "content": "I believe the current Nova PCI implementation is susceptible to becoming out of sync in multiple scenarios, we have seen this too and suspect rows ended up in 'deleted' state because of lost messages and/or other operational events occurring at the same time as instance life cycle events took place.\n\nTracking down all the places this disconnect might happen seems like a impossible task, and I believe we should focus on:\n\na) means for operator to force refresh of PCI devices from a compute node that could easily be back-ported to previous OpenStack versions\n\nb) improve handling of instance PCI attachements in periodic refresh of compute nodes", 
            "date_created": "2017-06-02 09:24:08.995023+00:00", 
            "author": "https://api.launchpad.net/1.0/~fnordahl"
        }, 
        {
            "content": "Automatically discovered version mitaka in description. If this is incorrect, please update the description to include 'nova version: ...'", 
            "date_created": "2017-06-27 15:59:11.604240+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}