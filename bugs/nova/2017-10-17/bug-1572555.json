{
    "status": "Fix Released", 
    "last_updated": "2016-07-14 13:02:00.116118+00:00", 
    "description": "this is on latest devstack master and might be related to bug 1572472\n\nReproduce\n\n1. deploy Ironic+Nova in DevStack as usual, 3 VMs x 1cpu,1024MB RAM,10GB disk posing as Ironic nodes\nironic node-list\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n| UUID                                 | Name   | Instance UUID | Power State | Provisioning State | Maintenance |\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n| bb785191-e548-4a6d-820e-bf2c5cdba922 | node-0 | None          | power off   | available          | False       |\n| 2a508e69-08ab-4b0e-abaa-39e4e268bd47 | node-1 | None          | power off   | available          | False       |\n| 9e0763d9-6f96-4327-a189-3bf12f5856ac | node-2 | None          | power off   | available          | False       |\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n\n2. check nova hypervisor-stats and nova hypervisor-show <node-uuid>\n    for all hypervisors nova reports memory_mb=1024, local_gb=10\n\nnova hypervisor-stats\n+----------------------+-------+\n| Property             | Value |\n+----------------------+-------+\n| count                | 3     |\n| current_workload     | 0     |\n| disk_available_least | 30    |\n| free_disk_gb         | 30    |\n| free_ram_mb          | 3072  |\n| local_gb             | 30    |\n| local_gb_used        | 0     |\n| memory_mb            | 3072  |\n| memory_mb_used       | 0     |\n| running_vms          | 0     |\n| vcpus                | 3     |\n| vcpus_used           | 0     |\n+----------------------+-------+\n\n3. put two ironic nodes into maintenance\nironic node-set-maintenance node-1 on\nironic node-set-maintenance node-2 on\nironic node-list\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n| UUID                                 | Name   | Instance UUID | Power State | Provisioning State | Maintenance |\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n| bb785191-e548-4a6d-820e-bf2c5cdba922 | node-0 | None          | power off   | available          | False       |\n| 2a508e69-08ab-4b0e-abaa-39e4e268bd47 | node-1 | None          | power off   | available          | True        |\n| 9e0763d9-6f96-4327-a189-3bf12f5856ac | node-2 | None          | power off   | available          | True        |\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n\n4. wait for nova hypervisor-stats to be updated\n\nExpected result:\n    total memory_mb is 1024, total local_gb is 10\n\nActual result:\n    total memory_mb is 0, total local_gb is 0\nnova hypervisor-stats\n+----------------------+-------+\n| Property             | Value |\n+----------------------+-------+\n| count                | 3     |\n| current_workload     | 0     |\n| disk_available_least | 10    |\n| free_disk_gb         | 10    |\n| free_ram_mb          | 1024  |\n| local_gb             | 0     |\n| local_gb_used        | 0     |\n| memory_mb            | 0     |\n| memory_mb_used       | 0     |\n| running_vms          | 0     |\n| vcpus                | 0     |\n| vcpus_used           | 0     |\n+----------------------+-------+\n\nalso hypervisor-show shows these values as 0:\n\nnova hypervisor-show bb785191-e548-4a6d-820e-bf2c5cdba922\n+-------------------------+--------------------------------------+\n| Property                | Value                                |\n+-------------------------+--------------------------------------+\n| cpu_info                |                                      |\n| current_workload        | 0                                    |\n| disk_available_least    | 10                                   |\n| free_disk_gb            | 10                                   |\n| free_ram_mb             | 1024                                 |\n| host_ip                 | 192.168.100.12                       |\n| hypervisor_hostname     | bb785191-e548-4a6d-820e-bf2c5cdba922 |\n| hypervisor_type         | ironic                               |\n| hypervisor_version      | 1                                    |\n| id                      | 1                                    |\n| local_gb                | 0                                    |\n| local_gb_used           | 0                                    |\n| memory_mb               | 0                                    |\n| memory_mb_used          | 0                                    |\n| running_vms             | 0                                    |\n| service_disabled_reason | None                                 |\n| service_host            | ironic                               |\n| service_id              | 8                                    |\n| state                   | up                                   |\n| status                  | enabled                              |\n| vcpus                   | 0                                    |\n| vcpus_used              | 0                                    |\n+-------------------------+--------------------------------------+\n\nAlso, when \"watch\"ing hypervisor-stats I had a glimpse at correct values that immediately jumped to zero on next query.\n\nDue to this bug the instance is failing to be scheduled to the actually\navailable Ironic node due to Nova scheduler's RamFilter removing all hosts", 
    "tags": [
        "ironic"
    ], 
    "importance": "High", 
    "heat": 30, 
    "link": "https://bugs.launchpad.net/nova/+bug/1572555", 
    "owner": "https://api.launchpad.net/1.0/~jaypipes", 
    "id": 1572555, 
    "index": 1915, 
    "openned": "2016-04-20 12:53:02.126560+00:00", 
    "created": "2016-04-20 12:53:02.126560+00:00", 
    "title": "Nova reports memory_mb=0 for available Ironic node", 
    "comments": [
        {
            "content": "this is on latest devstack master and might be related to bug 1572472\n\nReproduce\n\n1. deploy Ironic+Nova in DevStack as usual, 3 VMs x 1cpu,1024MB RAM,10GB disk posing as Ironic nodes\nironic node-list\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n| UUID                                 | Name   | Instance UUID | Power State | Provisioning State | Maintenance |\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n| bb785191-e548-4a6d-820e-bf2c5cdba922 | node-0 | None          | power off   | available          | False       |\n| 2a508e69-08ab-4b0e-abaa-39e4e268bd47 | node-1 | None          | power off   | available          | False       |\n| 9e0763d9-6f96-4327-a189-3bf12f5856ac | node-2 | None          | power off   | available          | False       |\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n\n2. check nova hypervisor-stats and nova hypervisor-show <node-uuid>\n    for all hypervisors nova reports memory_mb=1024, local_gb=10\n\nnova hypervisor-stats\n+----------------------+-------+\n| Property             | Value |\n+----------------------+-------+\n| count                | 3     |\n| current_workload     | 0     |\n| disk_available_least | 30    |\n| free_disk_gb         | 30    |\n| free_ram_mb          | 3072  |\n| local_gb             | 30    |\n| local_gb_used        | 0     |\n| memory_mb            | 3072  |\n| memory_mb_used       | 0     |\n| running_vms          | 0     |\n| vcpus                | 3     |\n| vcpus_used           | 0     |\n+----------------------+-------+\n\n3. put two ironic nodes into maintenance\nironic node-set-maintenance node-1 on\nironic node-set-maintenance node-2 on\nironic node-list\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n| UUID                                 | Name   | Instance UUID | Power State | Provisioning State | Maintenance |\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n| bb785191-e548-4a6d-820e-bf2c5cdba922 | node-0 | None          | power off   | available          | False       |\n| 2a508e69-08ab-4b0e-abaa-39e4e268bd47 | node-1 | None          | power off   | available          | True        |\n| 9e0763d9-6f96-4327-a189-3bf12f5856ac | node-2 | None          | power off   | available          | True        |\n+--------------------------------------+--------+---------------+-------------+--------------------+-------------+\n\n4. wait for nova hypervisor-stats to be updated\n\nExpected result:\n    total memory_mb is 1024, total local_gb is 10\n\nActual result:\n    total memory_mb is 0, total local_gb is 0\nnova hypervisor-stats\n+----------------------+-------+\n| Property             | Value |\n+----------------------+-------+\n| count                | 3     |\n| current_workload     | 0     |\n| disk_available_least | 10    |\n| free_disk_gb         | 10    |\n| free_ram_mb          | 1024  |\n| local_gb             | 0     |\n| local_gb_used        | 0     |\n| memory_mb            | 0     |\n| memory_mb_used       | 0     |\n| running_vms          | 0     |\n| vcpus                | 0     |\n| vcpus_used           | 0     |\n+----------------------+-------+\n\nalso hypervisor-show shows these values as 0:\n\nnova hypervisor-show bb785191-e548-4a6d-820e-bf2c5cdba922\n+-------------------------+--------------------------------------+\n| Property                | Value                                |\n+-------------------------+--------------------------------------+\n| cpu_info                |                                      |\n| current_workload        | 0                                    |\n| disk_available_least    | 10                                   |\n| free_disk_gb            | 10                                   |\n| free_ram_mb             | 1024                                 |\n| host_ip                 | 192.168.100.12                       |\n| hypervisor_hostname     | bb785191-e548-4a6d-820e-bf2c5cdba922 |\n| hypervisor_type         | ironic                               |\n| hypervisor_version      | 1                                    |\n| id                      | 1                                    |\n| local_gb                | 0                                    |\n| local_gb_used           | 0                                    |\n| memory_mb               | 0                                    |\n| memory_mb_used          | 0                                    |\n| running_vms             | 0                                    |\n| service_disabled_reason | None                                 |\n| service_host            | ironic                               |\n| service_id              | 8                                    |\n| state                   | up                                   |\n| status                  | enabled                              |\n| vcpus                   | 0                                    |\n| vcpus_used              | 0                                    |\n+-------------------------+--------------------------------------+\n\nAlso, when \"watch\"ing hypervisor-stats I had a glimpse at correct values that immediately jumped to zero on next query.\n\nDue to this bug the instance is failing to be scheduled to the actually\navailable Ironic node due to Nova scheduler's RamFilter removing all hosts", 
            "date_created": "2016-04-20 12:53:02.126560+00:00", 
            "author": "https://api.launchpad.net/1.0/~pshchelo"
        }, 
        {
            "content": "The following change introduce the issue https://review.openstack.org/#/c/279313/", 
            "date_created": "2016-05-11 16:08:50.791019+00:00", 
            "author": "https://api.launchpad.net/1.0/~vsaienko"
        }, 
        {
            "content": "I can confirm that this behavior was introduced by the https://review.openstack.org/#/c/279313/ change", 
            "date_created": "2016-05-12 16:08:06.510914+00:00", 
            "author": "https://api.launchpad.net/1.0/~lucasagomes"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/316031", 
            "date_created": "2016-05-13 11:20:17.598010+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/325436", 
            "date_created": "2016-06-03 17:44:27.922932+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Jay Pipes (<email address hidden>) on branch: master\nReview: https://review.openstack.org/325436\nReason: I'm splitting the inventory join revert from the revert of ComputeNode.update_inventory()...", 
            "date_created": "2016-06-06 17:46:15.148226+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/326100", 
            "date_created": "2016-06-06 19:10:03.989387+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/326100\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3988911ba7a923a247d64914b4209ad5f7d0d295\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3988911ba7a923a247d64914b4209ad5f7d0d295\nAuthor: Jay Pipes <email address hidden>\nDate:   Mon Jun 6 15:06:14 2016 -0400\n\n    Remove code referencing inventory table in cell DB\n    \n    The ComputeNode.save() and create() methods were still looking for\n    fields that began with the prefix inv_ and treating those differently.\n    Those fields are no longer in the return from compute_node_get() since\n    the last patch reverted the code that joins compute_nodes to allocations\n    and inventories within the cell DB.\n    \n    This patch undoes the calls to compute_node_get() that were done to grab\n    that inventory information which should reduce the number of DB calls\n    when compute nodes are saved or created.\n    \n    Change-Id: I5856c9e52c74e4f4530846f76f0a9d2735af23dc\n    Closes-bug: #1572555\n", 
            "date_created": "2016-06-06 21:33:25.543287+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Anton Arefiev (<email address hidden>) on branch: master\nReview: https://review.openstack.org/316031\nReason: inventories were reverted", 
            "date_created": "2016-06-07 11:31:16.336235+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/316031\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=824569a480f5c57ac1185319cbe65a60c766ce13\nSubmitter: Jenkins\nBranch:    master\n\ncommit 824569a480f5c57ac1185319cbe65a60c766ce13\nAuthor: Anton Arefiev <email address hidden>\nDate:   Fri May 13 13:51:57 2016 +0300\n\n    Fix update inventory for multiple providers\n    \n    DB call method get_all_by_resource_provider_uuid queries all\n    Inventories and filters them by provider's uuid from ResourceProvider,\n    but query list is not valid (contains inventories for all providers),\n    the correct way to load ResourceProvider is to use query join. Replace\n    joinedload with contains_eager to avoid redundant joins.\n    \n    As result last updated provider overwrites all provider's inventories\n    with wrong data.\n    \n    Closes-Bug: #1572555\n    Change-Id: I49fb1bf63400280635c202dea8f870d727a91e81\n", 
            "date_created": "2016-06-10 05:07:25.333978+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b2 development milestone.", 
            "date_created": "2016-07-14 13:01:48.252249+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b2 development milestone.", 
            "date_created": "2016-07-14 13:01:59.569908+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }
    ], 
    "closed": "2016-06-06 21:33:22.850082+00:00"
}