{
    "status": "Confirmed", 
    "last_updated": "2017-08-23 14:04:20.581853+00:00", 
    "description": "Description\n===========\nVirtuozzo storage mounts invalid state after Openstack Nova Compute service restart.\n\n==================\nRunning Openstack Ocata release with Virtuozzo KVM hypervisor on Vstorage backed by Cinder. A restart of the openstack-nova-compute service causes vzstorage mounts to be unreachable. The restart keeps VMs running using the mount but the filesystem is unreachable.\n\nBefore restart:\n[user@node ~]$ sudo systemctl status  -l openstack-nova-compute.service\n\u25cf openstack-nova-compute.service - OpenStack Nova Compute Server\n\u00a0\u00a0\u00a0Loaded: loaded (/usr/lib/systemd/system/openstack-nova-compute.service; enabled; vendor preset: disabled)\n\u00a0\u00a0\u00a0Active: active (running) since Mon 2017-08-14 13:47:00 CEST; 1 day 23h ago\n\u00a0Main PID: 3932 (nova-compute)\n\u00a0\u00a0\u00a0CGroup: /system.slice/openstack-nova-compute.service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u251c\u25003932 /usr/bin/python2 /usr/bin/nova-compute\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u251c\u25004251 /usr/bin/python2 /bin/privsep-helper --config-file /usr/share/nova/nova-dist.conf --config-file /etc/nova/nova.conf --privsep_context vif_plug_linux_bridge.privsep.vif_plug --privsep_sock_path /tmp/tmpe2LS_d/privsep.sock\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u251c\u25004454 /usr/bin/python2 /bin/privsep-helper --config-file /usr/share/nova/nova-dist.conf --config-file /etc/nova/nova.conf --privsep_context os_brick.privileged.default --privsep_sock_path /tmp/tmpOXZxyO/privsep.sock\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2514\u25004498 pstorage-mount -c openstackpoc -u nova -g root -m 0770 -l /var/log/vstorage/nova-openstackpoc.log.gz /var/lib/nova/mnt/b2b894afb0fb3e47348888c87ad01eee\n\nWe restart the service :\nsudo systemctl restart openstack-nova-compute.service\n\nAfter this we see:\n\n[user@node ~]$ sudo systemctl status  -l openstack-nova-compute.service\n\u25cf openstack-nova-compute.service - OpenStack Nova Compute Server\n\u00a0\u00a0\u00a0Loaded: loaded (/usr/lib/systemd/system/openstack-nova-compute.service; enabled; vendor preset: disabled)\n\u00a0\u00a0\u00a0Active: active (running) since Wed 2017-08-16 13:15:26 CEST; 50s ago\n\u00a0Main PID: 199753 (nova-compute)\n\u00a0\u00a0\u00a0CGroup: /system.slice/openstack-nova-compute.service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u251c\u2500199753 /usr/bin/python2 /usr/bin/nova-compute\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2514\u2500199798 /usr/bin/python2 /bin/privsep-helper --config-file /usr/share/nova/nova-dist.conf --config-file /etc/nova/nova.conf --privsep_context vif_plug_linux_bridge.privsep.vif_plug --privsep_sock_path /tmp/tmpjDaH7y/privsep.sock\n\nThe vstorage-mount is not reinitialised by nova-compute.\n\nExpected result\n===============\nThe vstorage-mount is available after nova-compute restart.\n\nActual result\n=============\nThe vstorage-mount is not reinitialised by nova-compute.\n\nNova mounts do not disappear after restart but are unreachable:\n\n[user@node ~]$ sudo lsof | grep /var/lib/nova/mnt/b2b894afb0fb3e47348888c87ad01eee\nlsof: WARNING: can't stat() fuse.vstorage file system /var/lib/nova/mnt/b2b894afb0fb3e47348888c87ad01eee\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Output information may be incomplete.\nqemu-kvm    7366                   root   18u  unknown                                          /var/lib/nova/mnt/b2b894afb0fb3e47348888c87ad01eee/volume-7d555095-f36e-4673-ad10-30786d105270 (stat: Transport endpoint is not connected)\nqemu-kvm    7366   7370            root   18u  unknown                                          /var/lib/nova/mnt/b2b894afb0fb3e47348888c87ad01eee/volume-7d555095-f36e-4673-ad10-30786d105270 (stat: Transport endpoint is not connected)\n\nWe currently implemented a workaround by adding\n\nKillMode=process\n\nto the openstack nova compute unit file override. This leave open the vzstorage mounts and keeps the VMs running.\n\nEnvironment\n===========\n1. Openstack Ocata release 15.0.3-2.el7\n\n2. Which hypervisor did you use?\n\nqemu-kvm-vz 2.6.0-28.3.9.vz7.56.1\n\n2. Which storage type did you use?\n\nVstorage, 7.4.106-1\n\n3. Which networking type did you use?\nNeutron with Linuxbridge", 
    "tags": [
        "libvirt", 
        "ocata-backport-potential", 
        "virtuozzo"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1711547", 
    "owner": "https://api.launchpad.net/1.0/~mnestratov", 
    "id": 1711547, 
    "index": 8255, 
    "openned": "2017-08-18 09:25:15.843521+00:00", 
    "created": "2017-08-18 09:25:15.843521+00:00", 
    "title": "Nova service restart disconnects vzstorage volumes", 
    "comments": [
        {
            "content": "Description\n===========\nVirtuozzo storage mounts invalid state after Openstack Nova Compute service restart. \n\n==================\nRunning Openstack Ocata release with Virtuozzo KVM hypervisor on Vstorage backed by Cinder. A restart of the openstack-nova-compute service causes vzstorage mounts to be unreachable. The restart keeps VMs running using the mount but the filesystem is unreachable.\n\nBefore restart:\n[user@node ~]$ sudo systemctl status  -l openstack-nova-compute.service\n\u25cf openstack-nova-compute.service - OpenStack Nova Compute Server\n   Loaded: loaded (/usr/lib/systemd/system/openstack-nova-compute.service; enabled; vendor preset: disabled)\n   Active: active (running) since Mon 2017-08-14 13:47:00 CEST; 1 day 23h ago\n Main PID: 3932 (nova-compute)\n   CGroup: /system.slice/openstack-nova-compute.service\n           \u251c\u25003932 /usr/bin/python2 /usr/bin/nova-compute\n           \u251c\u25004251 /usr/bin/python2 /bin/privsep-helper --config-file /usr/share/nova/nova-dist.conf --config-file /etc/nova/nova.conf --privsep_context vif_plug_linux_bridge.privsep.vif_plug --privsep_sock_path /tmp/tmpe2LS_d/privsep.sock\n           \u251c\u25004454 /usr/bin/python2 /bin/privsep-helper --config-file /usr/share/nova/nova-dist.conf --config-file /etc/nova/nova.conf --privsep_context os_brick.privileged.default --privsep_sock_path /tmp/tmpOXZxyO/privsep.sock\n           \u2514\u25004498 pstorage-mount -c openstackpoc -u nova -g root -m 0770 -l /var/log/vstorage/nova-openstackpoc.log.gz /var/lib/nova/mnt/b2b894afb0fb3e47348888c87ad01eee\n\nWe restart the service :\nsudo systemctl restart openstack-nova-compute.service\n\nAfter this we see:\n\n[user@node ~]$ sudo systemctl status  -l openstack-nova-compute.service\n\u25cf openstack-nova-compute.service - OpenStack Nova Compute Server\n   Loaded: loaded (/usr/lib/systemd/system/openstack-nova-compute.service; enabled; vendor preset: disabled)\n   Active: active (running) since Wed 2017-08-16 13:15:26 CEST; 50s ago\n Main PID: 199753 (nova-compute)\n   CGroup: /system.slice/openstack-nova-compute.service\n           \u251c\u2500199753 /usr/bin/python2 /usr/bin/nova-compute\n           \u2514\u2500199798 /usr/bin/python2 /bin/privsep-helper --config-file /usr/share/nova/nova-dist.conf --config-file /etc/nova/nova.conf --privsep_context vif_plug_linux_bridge.privsep.vif_plug --privsep_sock_path /tmp/tmpjDaH7y/privsep.sock\n\nThe pstorage-mount is not reinitialised by nova-compute.\n\n\nExpected result\n===============\nThe pstorage-mount is available after nova-compute restart.\n\nActual result\n=============\nThe pstorage-mount is not reinitialised by nova-compute.\n\nNova mounts do not disappear after restart but are unreachable:\n\n[user@node ~]$ sudo lsof | grep /var/lib/nova/mnt/b2b894afb0fb3e47348888c87ad01eee\nlsof: WARNING: can't stat() fuse.vstorage file system /var/lib/nova/mnt/b2b894afb0fb3e47348888c87ad01eee\n      Output information may be incomplete.\nqemu-kvm    7366                   root   18u  unknown                                          /var/lib/nova/mnt/b2b894afb0fb3e47348888c87ad01eee/volume-7d555095-f36e-4673-ad10-30786d105270 (stat: Transport endpoint is not connected)\nqemu-kvm    7366   7370            root   18u  unknown                                          /var/lib/nova/mnt/b2b894afb0fb3e47348888c87ad01eee/volume-7d555095-f36e-4673-ad10-30786d105270 (stat: Transport endpoint is not connected)\n\nWe currently implemented a workaround by adding\n\nKillMode=process\n\nto the openstack nova compute unit file override. This leave open the vzstorage mounts and keeps the VMs running.\n\n\nEnvironment\n===========\n1. Openstack Ocata release 15.0.3-2.el7\n\n2. Which hypervisor did you use?\n\nqemu-kvm-vz 2.6.0-28.3.9.vz7.56.1\n\n2. Which storage type did you use?\n\nVstorage, 7.4.106-1\n\n3. Which networking type did you use?\nNeutron with Linuxbridge", 
            "date_created": "2017-08-18 09:25:15.843521+00:00", 
            "author": "https://api.launchpad.net/1.0/~cbaijens"
        }
    ]
}