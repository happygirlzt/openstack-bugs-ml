{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:12:16.706784+00:00", 
    "description": "Environment: nova stable/diablo in two machine cluster, one controller and one compute node.\n\nProblem: After rebooting the controller and trying to launch a new VM (a few minutes after the controller is back up),  the launched VM goes into an error state.  If retry launching VM again it works.\n\nStack Trace from nova-compute.log file:\n\n\n2012-01-03 17:14:18,624 AUDIT nova.compute.manager [6b505190-e161-466e-b6ad-4b61358fda20 nova project_503] instance 32: starting...\n2012-01-03 17:14:18,680 DEBUG nova.rpc [6b505190-e161-466e-b6ad-4b61358fda20 nova project_503] Making asynchronous call on network ... from (pid=21128) multicall /usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:730\n2012-01-03 17:14:18,680 DEBUG nova.rpc [6b505190-e161-466e-b6ad-4b61358fda20 nova project_503] MSG_ID is 1b804a7965464cbca5ab63e42760a0f6 from (pid=21128) multicall /usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:733\n2012-01-03 17:14:18,681 ERROR nova.compute.manager [6b505190-e161-466e-b6ad-4b61358fda20 nova project_503] Instance '32' failed network setup.\n(nova.compute.manager): TRACE: Traceback (most recent call last):\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/compute/manager.py\", line 411, in _logging_error\n(nova.compute.manager): TRACE:     yield\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/compute/manager.py\", line 442, in _run_instance\n(nova.compute.manager): TRACE:     network_info = _make_network_info()\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/compute/manager.py\", line 378, in _make_network_info(nova.compute.manager): TRACE:     requested_networks=requested_networks)(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/network/api.py\", line 162, in allocate_for_instance\n(nova.compute.manager): TRACE:     'args': args})(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/__init__.py\", line 45, in call\n(nova.compute.manager): TRACE:     return get_impl().call(context, topic, msg)\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 746, in call\n(nova.compute.manager): TRACE:     rv = multicall(context, topic, msg)(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 738, in multicall(nova.compute.manager): TRACE:     conn.declare_direct_consumer(msg_id, wait_msg)\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 449, in declare_direct_consumer\n(nova.compute.manager): TRACE:     self.declare_consumer(DirectConsumer, topic, callback)\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 394, in declare_consumer\n(nova.compute.manager): TRACE:     self.consumer_num.next())\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 140, in __init__\n(nova.compute.manager): TRACE:     **options)\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 61, in __init__\n(nova.compute.manager): TRACE:     self.reconnect(channel)\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 68, in reconnect\n(nova.compute.manager): TRACE:     self.queue.declare()\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/entity.py\", line 359, in declare(nova.compute.manager): TRACE:     return (self.name and self.exchange.declare(nowait),\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/entity.py\", line 151, in declare\n(nova.compute.manager): TRACE:     nowait=nowait)\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/syn.py\", line 14, in blocking\n(nova.compute.manager): TRACE:     return __sync_current(fun, *args, **kwargs)\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/syn.py\", line 40, in __eblocking__\n(nova.compute.manager): TRACE:     return spawn(fun, *args, **kwargs).wait()\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 166, in wait\n(nova.compute.manager): TRACE:     return self._exit_event.wait()\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 116, in wait(nova.compute.manager): TRACE:     return hubs.get_hub().switch()\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n(nova.compute.manager): TRACE:     return self.greenlet.switch()\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n(nova.compute.manager): TRACE:     result = function(*args, **kwargs)\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.7/amqplib/client_0_8/channel.py\", line 843, in exchange_declare\n(nova.compute.manager): TRACE:     (40, 11),    # Channel.exchange_declare_ok\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.7/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n(nova.compute.manager): TRACE:     self.channel_id, allowed_methods)\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.7/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n(nova.compute.manager): TRACE:     self.wait()\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.7/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n(nova.compute.manager): TRACE:     return amqp_method(self, args)\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.7/amqplib/client_0_8/connection.py\", line 367, in _close\n(nova.compute.manager): TRACE:     raise AMQPConnectionException(reply_code, reply_text, (class_id, method_id))\n(nova.compute.manager): TRACE: AMQPConnectionException: (320, u\"CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'\", (0, 0), '')\n(nova.compute.manager): TRACE:", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/911559", 
    "owner": "None", 
    "id": 911559, 
    "index": 3732, 
    "openned": "2012-01-04 01:54:41.487631+00:00", 
    "created": "2012-01-04 01:54:41.487631+00:00", 
    "title": "AMQPConnectionException on launch VM  after restart controller", 
    "comments": [
        {
            "content": "Environment: nova stable/diablo in two machine cluster, one controller and one compute node.\n\nProblem: After rebooting the controller and trying to launch a new VM (a few minutes after the controller is back up),  the launched VM goes into an error state.  If retry launching VM again it works.\n\nStack Trace from nova-compute.log file:\n\n\n2012-01-03 17:14:18,624 AUDIT nova.compute.manager [6b505190-e161-466e-b6ad-4b61358fda20 nova project_503] instance 32: starting...\n2012-01-03 17:14:18,680 DEBUG nova.rpc [6b505190-e161-466e-b6ad-4b61358fda20 nova project_503] Making asynchronous call on network ... from (pid=21128) multicall /usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:730\n2012-01-03 17:14:18,680 DEBUG nova.rpc [6b505190-e161-466e-b6ad-4b61358fda20 nova project_503] MSG_ID is 1b804a7965464cbca5ab63e42760a0f6 from (pid=21128) multicall /usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:733\n2012-01-03 17:14:18,681 ERROR nova.compute.manager [6b505190-e161-466e-b6ad-4b61358fda20 nova project_503] Instance '32' failed network setup.\n(nova.compute.manager): TRACE: Traceback (most recent call last):\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/compute/manager.py\", line 411, in _logging_error\n(nova.compute.manager): TRACE:     yield\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/compute/manager.py\", line 442, in _run_instance\n(nova.compute.manager): TRACE:     network_info = _make_network_info()\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/compute/manager.py\", line 378, in _make_network_info(nova.compute.manager): TRACE:     requested_networks=requested_networks)(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/network/api.py\", line 162, in allocate_for_instance\n(nova.compute.manager): TRACE:     'args': args})(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/__init__.py\", line 45, in call\n(nova.compute.manager): TRACE:     return get_impl().call(context, topic, msg)\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 746, in call\n(nova.compute.manager): TRACE:     rv = multicall(context, topic, msg)(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 738, in multicall(nova.compute.manager): TRACE:     conn.declare_direct_consumer(msg_id, wait_msg)\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 449, in declare_direct_consumer\n(nova.compute.manager): TRACE:     self.declare_consumer(DirectConsumer, topic, callback)\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 394, in declare_consumer\n(nova.compute.manager): TRACE:     self.consumer_num.next())\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 140, in __init__\n(nova.compute.manager): TRACE:     **options)\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 61, in __init__\n(nova.compute.manager): TRACE:     self.reconnect(channel)\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 68, in reconnect\n(nova.compute.manager): TRACE:     self.queue.declare()\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/entity.py\", line 359, in declare(nova.compute.manager): TRACE:     return (self.name and self.exchange.declare(nowait),\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/entity.py\", line 151, in declare\n(nova.compute.manager): TRACE:     nowait=nowait)\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/syn.py\", line 14, in blocking\n(nova.compute.manager): TRACE:     return __sync_current(fun, *args, **kwargs)\n(nova.compute.manager): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/syn.py\", line 40, in __eblocking__\n(nova.compute.manager): TRACE:     return spawn(fun, *args, **kwargs).wait()\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 166, in wait\n(nova.compute.manager): TRACE:     return self._exit_event.wait()\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/event.py\", line 116, in wait(nova.compute.manager): TRACE:     return hubs.get_hub().switch()\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n(nova.compute.manager): TRACE:     return self.greenlet.switch()\n(nova.compute.manager): TRACE:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n(nova.compute.manager): TRACE:     result = function(*args, **kwargs)\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.7/amqplib/client_0_8/channel.py\", line 843, in exchange_declare\n(nova.compute.manager): TRACE:     (40, 11),    # Channel.exchange_declare_ok\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.7/amqplib/client_0_8/abstract_channel.py\", line 89, in wait\n(nova.compute.manager): TRACE:     self.channel_id, allowed_methods)\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.7/amqplib/client_0_8/connection.py\", line 218, in _wait_method\n(nova.compute.manager): TRACE:     self.wait()\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.7/amqplib/client_0_8/abstract_channel.py\", line 105, in wait\n(nova.compute.manager): TRACE:     return amqp_method(self, args)\n(nova.compute.manager): TRACE:   File \"/usr/lib/pymodules/python2.7/amqplib/client_0_8/connection.py\", line 367, in _close\n(nova.compute.manager): TRACE:     raise AMQPConnectionException(reply_code, reply_text, (class_id, method_id))\n(nova.compute.manager): TRACE: AMQPConnectionException: (320, u\"CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'\", (0, 0), '')\n(nova.compute.manager): TRACE:", 
            "date_created": "2012-01-04 01:54:41.487631+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "I tried to reproduce this on essex master by rebooting rabbit and did not see the same behavior.  I will try with stable/diablo", 
            "date_created": "2012-02-02 21:44:02.677608+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Ok i can repro the error on stable/diablo so apparently one of the recent changes to the rpc code has fixed this.  I don't know if it is worth the effort to\na) find the commit that fixes it\nand\nb) backport the relevant changes.  I think we can mark it fixed in trunk though", 
            "date_created": "2012-02-02 21:49:26.836938+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "So this will just stay as known bug in diablo?", 
            "date_created": "2012-02-02 22:59:35.849075+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }
    ], 
    "closed": "2012-02-29 10:25:00.183329+00:00"
}