{
    "status": "Fix Released", 
    "last_updated": "2015-11-19 21:50:59.182490+00:00", 
    "description": "Tempest test ServerActionsTestJSON:test_resize_server_confirm_from_stopped and other similaire test from_stopped may fail with libvirt-xen driver due to the test timing out on waiting the instance to be SHUTOFF, but nova is reporting the instance to be ACTIVE.\n\nTraceback (most recent call last):\n  File \"/opt/stack/tempest/tempest/api/compute/servers/test_server_actions.py\", line 230, in test_resize_server_confirm_from_stopped\n    self._test_resize_server_confirm(stop=True)\n  File \"/opt/stack/tempest/tempest/api/compute/servers/test_server_actions.py\", line 209, in _test_resize_server_confirm\n    self.client.wait_for_server_status(self.server_id, expected_status)\n  File \"/opt/stack/tempest/tempest/services/compute/json/servers_client.py\", line 183, in wait_for_server_status\n    ready_wait=ready_wait)\n  File \"/opt/stack/tempest/tempest/common/waiters.py\", line 93, in wait_for_server_status\n    raise exceptions.TimeoutException(message)\ntempest.exceptions.TimeoutException: Request timed out\nDetails: (ServerActionsTestJSON:test_resize_server_confirm_from_stopped) Server a0f07187-4e08-4664-ad48-a03cffb87873 failed to reach SHUTOFF status and task state \"None\" within the required time (196 s). Current status: ACTIVE. Current task state: None.\n\n\nFrom nova log, I could see \"VM Started (Lifecycle Event)\" being reported while the instance is shutdown and being resized.\n\nAfter tracking done this bug, the issue may comes from the Change-Id I690d3d700ab4d057554350da143ff77d78b509c6, Delay STOPPED lifecycle event for Xen domains.\n\nA way to reproduce would be to run this script on a Xen machine using a small Cirros instance:\nnova boot --image 'cirros-0.3.2-x86_64-uec' --flavor 42 instance\nnova stop instance\n# wait sometime (around 20s) so we start with SHUTDOWN state\nnova start instance\nnova stop instance\nnova resize instance 84\nnova resize-confirm instance\n# check new state, should be shutoff.", 
    "tags": [
        "in-stable-juno", 
        "libvirt", 
        "xen"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1433049", 
    "owner": "https://api.launchpad.net/1.0/~anthony-perard", 
    "id": 1433049, 
    "index": 4181, 
    "openned": "2015-03-17 11:46:56.716285+00:00", 
    "created": "2015-03-17 11:46:56.716285+00:00", 
    "title": "libvirt-xen: Instance status in nova may be different than real status", 
    "comments": [
        {
            "content": "Tempest test ServerActionsTestJSON:test_resize_server_confirm_from_stopped and other similaire test from_stopped may fail with libvirt-xen driver due to the test timing out on waiting the instance to be SHUTOFF, but nova is reporting the instance to be ACTIVE.\n\nTraceback (most recent call last):\n  File \"/opt/stack/tempest/tempest/api/compute/servers/test_server_actions.py\", line 230, in test_resize_server_confirm_from_stopped\n    self._test_resize_server_confirm(stop=True)\n  File \"/opt/stack/tempest/tempest/api/compute/servers/test_server_actions.py\", line 209, in _test_resize_server_confirm\n    self.client.wait_for_server_status(self.server_id, expected_status)\n  File \"/opt/stack/tempest/tempest/services/compute/json/servers_client.py\", line 183, in wait_for_server_status\n    ready_wait=ready_wait)\n  File \"/opt/stack/tempest/tempest/common/waiters.py\", line 93, in wait_for_server_status\n    raise exceptions.TimeoutException(message)\ntempest.exceptions.TimeoutException: Request timed out\nDetails: (ServerActionsTestJSON:test_resize_server_confirm_from_stopped) Server a0f07187-4e08-4664-ad48-a03cffb87873 failed to reach SHUTOFF status and task state \"None\" within the required time (196 s). Current status: ACTIVE. Current task state: None.\n\n\nFrom nova log, I could see \"VM Started (Lifecycle Event)\" being reported while the instance is shutdown and being resized.\n\nAfter tracking done this bug, the issue may comes from the Change-Id I690d3d700ab4d057554350da143ff77d78b509c6, Delay STOPPED lifecycle event for Xen domains.\n\nA way to reproduce would be to run this script on a Xen machine using a small Cirros instance:\nnova boot --image 'cirros-0.3.2-x86_64-uec' --flavor 42 instance\nnova stop instance\n# wait sometime (around 20s) so we start with SHUTDOWN state\nnova start instance\nnova stop instance\nnova resize instance 84\nnova resize-confirm instance\n# check new state, should be shutoff.", 
            "date_created": "2015-03-17 11:46:56.716285+00:00", 
            "author": "https://api.launchpad.net/1.0/~anthony-perard"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/166184", 
            "date_created": "2015-03-20 11:57:07.689491+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This seems to cause Xen+Libvirt serious problems, so raising the priority to medium.\n\nIts blocking their testing, so adding rc tag", 
            "date_created": "2015-03-26 09:27:32.170134+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/166184\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b5a9c4e4d04d011c59fca5306be651906792f411\nSubmitter: Jenkins\nBranch:    master\n\ncommit b5a9c4e4d04d011c59fca5306be651906792f411\nAuthor: Anthony PERARD <email address hidden>\nDate:   Thu Mar 19 17:46:25 2015 +0000\n\n    libvirt: Delay only STOPPED event for Xen domain.\n    \n    This fix change bd8329b34098436d18441a8129f3f20af53c2b91 (Delay STOPPED\n    lifecycle event for Xen domains)\n    \n    Without this patch, a STOPPED event could be ignore if it was following a\n    STARTED event.\n    \n    A scenario that have the issue on tempest is\n    ServerActionsTestJSON:test_resize_server_confirm_from_stopped, and it\n    happens as follow:\n    - instance is stopped\n    nova start instance\n    - libvirt STARTED event received and delayed\n    nova stop instance\n    - libvirt STOPPED event received and ignored as there is a delayed event\n    nova resize instance 42\n    - resize finished\n    - the delayed STARTED event is emited\n    nova confirme-resize instance\n    nova show instance\n    - instance is show as ACTIVE, but should be SHUTOFF\n    \n    Also fix unit tests.\n    \n    Change-Id: If340f9b849b930c34238c5681018a29bc826798d\n    Closes-Bug: #1433049\n", 
            "date_created": "2015-03-26 19:47:53.876384+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Backport proposed in a squash commit to stable/juno here: https://review.openstack.org/#/c/163378/", 
            "date_created": "2015-04-13 21:39:34.305503+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/163378\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=f60214b4fdbfb56c8428808a29b9cf911c0b1aa2\nSubmitter: Jenkins\nBranch:    stable/juno\n\ncommit f60214b4fdbfb56c8428808a29b9cf911c0b1aa2\nAuthor: Thomas Bechtold <email address hidden>\nDate:   Tue Aug 19 17:41:57 2014 +0200\n\n    Delay STOPPED lifecycle event for Xen domains\n    \n    When using libvirt, a reboot from inside of a kvm VM doesn't trigger\n    any libvirt lifecycle event. That's fine. But rebooting a Xen VM leads\n    to the events VIR_DOMAIN_EVENT_STOPPED and VIR_DOMAIN_EVENT_STARTED.\n    Nova compute manager catches these events and tries to sync the power\n    state of the VM with the power state in the database. In the case the VM\n    state is ACTIVE but the power state is something that doesn't fit, the\n    stop API call is executed to trigger all stop hooks. This leads to the\n    problem that a reboot of a Xen VM without using the API isn't possible.\n    To fix it, delay the emission of the STOPPED lifecycle event a couple of\n    seconds. If a VIR_DOMAIN_EVENT_STARTED event is received while the STOPPED\n    event is pending, cancel the pending STOPPED lifecycle event so the VM\n    can continue to run.\n    \n    Closes-Bug: #1293480\n    (cherry picked from commit bd8329b34098436d18441a8129f3f20af53c2b91)\n    \n    ----\n    NOTE(mriedem): The fix for bug 1293480 introduced bug 1433049 so we\n    have to backport both together, hence the squashed commits.\n    ----\n    \n    libvirt: Delay only STOPPED event for Xen domain.\n    \n    This fix change bd8329b34098436d18441a8129f3f20af53c2b91 (Delay STOPPED\n    lifecycle event for Xen domains)\n    \n    Without this patch, a STOPPED event could be ignore if it was following a\n    STARTED event.\n    \n    A scenario that have the issue on tempest is\n    ServerActionsTestJSON:test_resize_server_confirm_from_stopped, and it\n    happens as follow:\n    - instance is stopped\n    nova start instance\n    - libvirt STARTED event received and delayed\n    nova stop instance\n    - libvirt STOPPED event received and ignored as there is a delayed event\n    nova resize instance 42\n    - resize finished\n    - the delayed STARTED event is emited\n    nova confirme-resize instance\n    nova show instance\n    - instance is show as ACTIVE, but should be SHUTOFF\n    \n    Also fix unit tests.\n    \n    Conflicts:\n            nova/tests/unit/virt/libvirt/test_host.py\n            nova/virt/libvirt/host.py\n    \n    NOTE(mriedem): The conflicts are due to the code being moved to the\n    nova.virt.libvirt.host module in Kilo.\n    \n    Closes-Bug: #1433049\n    Change-Id: If340f9b849b930c34238c5681018a29bc826798d\n    (cherry picked from commit b5a9c4e4d04d011c59fca5306be651906792f411)\n    \n    --\n    \n    Change-Id: I690d3d700ab4d057554350da143ff77d78b509c6\n", 
            "date_created": "2015-04-21 01:22:24.789371+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-04-10 09:21:04.332289+00:00"
}