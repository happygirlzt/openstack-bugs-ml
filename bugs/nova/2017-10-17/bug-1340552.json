{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:57:17.355044+00:00", 
    "description": "Tested Environment\n--------------------------\nOS: Ubuntu 14.04 LST\nCinder NFS driver:\nvolume_driver=cinder.volume.drivers.nfs.NfsDriver\n\nError description\n--------------------------\nI used NFS as the cinder storage backend and successfully attached multiple volumes to nova instances.\nHowever, when I tried to detach one them, I found following error on nova-compute.log.\n\n-----------Error log------\n2014-07-07 17:48:46.175 3195 ERROR nova.virt.libvirt.volume [req-a07d077f-2ad1-4558-91fa-ab1895ca4914 c8ac60023a794aed8cec8552110d5f12 fdd538eb5dbf48a98d08e6d64def73d7] Couldn't unmount the NFS share 172.23.58.245:/NFSThinLun2\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume Traceback (most recent call last):\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume   File \"/usr/local/lib/python2.7/dist-packages/nova/virt/libvirt/volume.py\", line 675, in disconnect_volume\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume     utils.execute('umount', mount_path, run_as_root=True)\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume   File \"/usr/local/lib/python2.7/dist-packages/nova/utils.py\", line 164, in execute\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume     return processutils.execute(*cmd, **kwargs)\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume   File \"/usr/local/lib/python2.7/dist-packages/nova/openstack/common/processutils.py\", line 193, in execute\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume     cmd=' '.join(cmd))\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume ProcessExecutionError: Unexpected error while running command.\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume Command: sudo nova-rootwrap /etc/nova/rootwrap.conf umount /var/lib/nova/mnt/16a381ac60f3e130cf26e7d6eb832cb6\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume Exit code: 16\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume Stdout: ''\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume Stderr: 'umount.nfs: /var/lib/nova/mnt/16a381ac60f3e130cf26e7d6eb832cb6: device is busy\\numount.nfs: /var/lib/nova/mnt/16a381ac60f3e130cf26e7d6eb832cb6: device is busy\\n'\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume\n\n-----------End of the Log--\n\n\nFor NFS volumes, every time you detach a volume, nova tries to umount the device path.\n/nova/virt/libvirt/volume.py in\nLine 632: class LibvirtNFSVolumeDriver(LibvirtBaseVolumeDriver):\nLine 653: \tdef disconnect_volume(self, connection_info, disk_dev):\nLine 661:\t\tutils.execute('umount', mount_path, run_as_root=True)\n\nThis works when the device path is not busy.\nIf the device path is busy (or in use), it should output a message to log and continue.\nThe problem is, Instead of output a log message, it raise exception and that cause the above error.\n\nI think the reason is, the \u2018if\u2019 statement at Line 663 fails to catch the device busy massage from the content of the exc.message. It looking for the \u2018target is busy\u2019 in the exc.message, but umount error code returns \u2018device is busy\u2019.\nTherefore, current code skip the \u2018if\u2019 statement and run the \u2018else\u2019 and raise the exception.\n\nHow to reproduce\n--------------------------\n(1)\tPrepare a NFS share storage and set it as the storage backend of you cinder\n(refer http://docs.openstack.org/grizzly/openstack-block-storage/admin/content/NFS-driver.html)\nIn cinder.conf\nvolume_driver=cinder.volume.drivers.nfs.NfsDriver\nnfs_shares_config=<path to your nfs share list file>\n(2)\tCreate 2 empty volumes from cinder\n(3)\tCreate a nova instance and attach above 2 volumes\n(4)\tThen, try to detach one of them.\nYou will get the error in nova-compute.log \u201cCouldn't unmount the NFS share <your NFS mount path on nova-compute>\u201d\n\nProposed Fix\n--------------------------\nI\u2019m not sure about any other OSs who outputs the \u2018target is busy\u2019 in the umount error code.\nTherefore, first fix comes to my mind is fix the \u2018if\u2019 statement to:\nBefore fix;\nif 'target is busy' in exc.message:\nAfter fix;\nif 'device is busy' in exc.message:", 
    "tags": [
        "icehouse-backport-potential", 
        "volumes"
    ], 
    "importance": "Undecided", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1340552", 
    "owner": "https://api.launchpad.net/1.0/~sampath-priyankara", 
    "id": 1340552, 
    "index": 6258, 
    "openned": "2014-07-11 07:17:03.057723+00:00", 
    "created": "2014-07-11 07:17:03.057723+00:00", 
    "title": "Volume detach error when use NFS as the cinder backend", 
    "comments": [
        {
            "content": "Tested Environment\n--------------------------\nOS: Ubuntu 14.04 LST\nCinder NFS driver: \nvolume_driver=cinder.volume.drivers.nfs.NfsDriver\n\nError description\n--------------------------\nI used NFS as the cinder storage backend and successfully attached multiple volumes to nova instances.\nHowever, when I tried to detach one them, I found following error on nova-compute.log.\n\n2014-07-07 17:48:46.175 3195 ERROR nova.virt.libvirt.volume [req-a07d077f-2ad1-4558-91fa-ab1895ca4914 c8ac60023a794aed8cec8552110d5f12 fdd538eb5dbf48a98d08e6d64def73d7] Couldn't unmount the NFS share 172.23.58.245:/NFSThinLun2\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume Traceback (most recent call last):\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume   File \"/usr/local/lib/python2.7/dist-packages/nova/virt/libvirt/volume.py\", line 675, in disconnect_volume\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume     utils.execute('umount', mount_path, run_as_root=True)\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume   File \"/usr/local/lib/python2.7/dist-packages/nova/utils.py\", line 164, in execute\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume     return processutils.execute(*cmd, **kwargs)\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume   File \"/usr/local/lib/python2.7/dist-packages/nova/openstack/common/processutils.py\", line 193, in execute\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume     cmd=' '.join(cmd))\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume ProcessExecutionError: Unexpected error while running command.\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume Command: sudo nova-rootwrap /etc/nova/rootwrap.conf umount /var/lib/nova/mnt/16a381ac60f3e130cf26e7d6eb832cb6\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume Exit code: 16\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume Stdout: ''\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume Stderr: 'umount.nfs: /var/lib/nova/mnt/16a381ac60f3e130cf26e7d6eb832cb6: device is busy\\numount.nfs: /var/lib/nova/mnt/16a381ac60f3e130cf26e7d6eb832cb6: device is busy\\n'\n2014-07-07 17:48:46.175 3195 TRACE nova.virt.libvirt.volume\n\nFor NFS volumes, every time you detach a volume, nova tries to umount the device path.\n/nova/virt/libvirt/volume.py in \nLine 632: class LibvirtNFSVolumeDriver(LibvirtBaseVolumeDriver):\nLine 653: \tdef disconnect_volume(self, connection_info, disk_dev):\nLine 661:\t\tutils.execute('umount', mount_path, run_as_root=True)\n \nThis works when the device path is not busy.\nIf the device path is busy (or in use), it should output a message to log and continue.\nThe problem is, Instead of output a log message, it raise exception and that cause the above error.\n\nI think the reason is, the \u2018if\u2019 statement at Line 663 fails to catch the device busy massage from the content of the exc.message. It looking for the \u2018target is busy\u2019 in the exc.message, but umount error code returns \u2018device is busy\u2019.\nTherefore, current code skip the \u2018if\u2019 statement and run the \u2018else\u2019 and raise the exception.\n\nHow to reproduce\n--------------------------\n(1)\tPrepare a NFS share storage and set it as the storage backend of you cinder\n(refer http://docs.openstack.org/grizzly/openstack-block-storage/admin/content/NFS-driver.html)\nIn cinder.conf\nvolume_driver=cinder.volume.drivers.nfs.NfsDriver\nnfs_shares_config=<path to your nfs share list file>\n(2)\tCreate 2 empty volumes from cinder\n(3)\tCreate a nova instance and attach above 2 volumes\n(4)\tThen, try to detach one of them.\nYou will get the error in nova-compute.log \u201cCouldn't unmount the NFS share <your NFS mount path on nova-compute>\u201d\n\nProposed Fix\n--------------------------\nI\u2019m not sure about any other OSs who outputs the \u2018target is busy\u2019 in the umount error code. \nTherefore, first fix comes to my mind is fix the \u2018if\u2019 statement to:\nBefore fix; \nif 'target is busy' in exc.message:\nAfter fix;\nif 'device is busy' in exc.message:", 
            "date_created": "2014-07-11 07:17:03.057723+00:00", 
            "author": "https://api.launchpad.net/1.0/~sampath-priyankara"
        }, 
        {
            "content": "The feature above was put in by this commit: https://github.com/openstack/nova/commit/dc716bd0ce77b56f4aabe54d6633b7f3bf9b0a5d.  I agree with your proposed fix.  Most of the time, I see \"device is busy\" and not \"target is busy\".  This should be a quick fix.", 
            "date_created": "2014-07-11 14:20:25.187134+00:00", 
            "author": "https://api.launchpad.net/1.0/~thang-pham"
        }, 
        {
            "content": "Re-assigning this bug to Sam, since he asked to fixed it.", 
            "date_created": "2014-07-11 19:27:48.229773+00:00", 
            "author": "https://api.launchpad.net/1.0/~thang-pham"
        }, 
        {
            "content": "Thanks Thang, I will push the fix", 
            "date_created": "2014-07-11 19:41:36.777640+00:00", 
            "author": "https://api.launchpad.net/1.0/~sampath-priyankara"
        }, 
        {
            "content": "add link manually, since not posted automatically\nHere are the codes,\nhttps://review.openstack.org/#/c/111553/", 
            "date_created": "2014-08-17 05:12:43.679484+00:00", 
            "author": "https://api.launchpad.net/1.0/~sampath-priyankara"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/111553\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=bd5c5d5bbd808b4f83da58dce433cac711575bee\nSubmitter: Jenkins\nBranch:    master\n\ncommit bd5c5d5bbd808b4f83da58dce433cac711575bee\nAuthor: Sampath Priyankara <email address hidden>\nDate:   Sun Aug 3 15:23:23 2014 +0900\n\n    Fix for volume detach error when use NFS as the cinder backend\n    \n    For NFS volumes, every time you detach a volume, nova tries to umount\n    the device path. If the device path is busy (or in use), it should\n    output a message to log and continue.\n    In current code, if the device is busy, it cannot catch the \u2018device is busy\u2019\n    message returned by umount, because it looking for the \u2018target is busy\u2019.\n     Therefore, current code skip the \u2018if\u2019 statement and run the \u2018else\u2019 and\n    raise the exception.\n    Fix: Add \u2018device is busy\u2019 to if statement.\n    \n    Add a mock test to check the behaviour of the\n    virt.libvirt.volume.LibvirtNFSVolumeDriver.disconnect_volume\n    when it has umount errors.\n    \n    Closes-Bug: #1340552\n    \n    Change-Id: Iac946c37064c5f5bf5a102305de40d21d16846c1\n", 
            "date_created": "2014-09-13 15:26:14.538810+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-10-01 07:41:23.315955+00:00"
}