{
    "status": "Confirmed", 
    "last_updated": "2017-08-01 10:46:40.689533+00:00", 
    "description": "Description\n===========\nSwapping encrypted volumes via `nova volume-update` currently results in the new volume being attached to the instance still encrypted and the original volume still connected to the host.\n\nSteps to reproduce\n==================\n\n# cinder type-create LUKS\n# cinder encryption-type-create --cipher aes-xts-plain64 \\\n      --key_size 512  --control_location front-end LUKS  \\\n      nova.volume.encryptors.luks.LuksEncryptor\n# cinder create --volume-type LUKS 1\n# cinder create --volume-type LUKS 1\n# nova boot --image cirros-0.3.5-x86_64-disk --flavor 2 test\n\n# nova volume-attach 445a811f-ca80-49d3-b3bd-156cb492c96c \\\n                     d7c43bc8-dbc4-4668-950a-a57397af7cbf\n# nova volume-update 445a811f-ca80-49d3-b3bd-156cb492c96c \\\n                     d7c43bc8-dbc4-4668-950a-a57397af7cbf \\\n                     f998a062-8227-41b4-8400-d82a0f223ec3\n\nExpected result\n===============\n\nThe original volume is disconnected from the host, the new volume is decrypted and attached to the instance.\n\nActual result\n=============\n\nf998a062, the new volume is now attached to the instance but without being decrypted :\n\n$ sudo virsh domblklist 445a811f-ca80-49d3-b3bd-156cb492c96c                                                                                                                                                             \nTarget     Source\n------------------------------------------------\nvda        /opt/stack/data/nova/instances/445a811f-ca80-49d3-b3bd-156cb492c96c/disk\nvdb        /dev/disk/by-path/ip-192.168.122.224:3260-iscsi-iqn.2010-10.org.openstack:volume-f998a062-8227-41b4-8400-d82a0f223ec3-lun-1\n\n\nd7c43bc8, the original volumes is still connected and decrypted on the host :\n\n$ iscsiadm -m session\ntcp: [5] 192.168.122.224:3260,1 iqn.2010-10.org.openstack:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf (non-flash)\ntcp: [6] 192.168.122.224:3260,1 iqn.2010-10.org.openstack:volume-f998a062-8227-41b4-8400-d82a0f223ec3 (non-flash)\n$ ll /dev/disk/by-path/ip-192.168.122.224\\:3260-iscsi-iqn.2010-10.org.openstack\\:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf-lun-1 \nlrwxrwxrwx. 1 root root 123 Apr 24 12:39 /dev/disk/by-path/ip-192.168.122.224:3260-iscsi-iqn.2010-10.org.openstack:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf-lun-1 -> /dev/mapper/crypt-ip-192.168.122.224:3260-iscsi-iqn.2010-10.org.openstack:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf-lun-1\n$ ll /dev/mapper/crypt*\nlrwxrwxrwx. 1 root root 7 Apr 24 12:40 /dev/mapper/crypt-ip-192.168.122.224:3260-iscsi-iqn.2010-10.org.openstack:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf-lun-1 -> ../dm-2\n\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n   list for all releases: http://docs.openstack.org/releases/\n\n$ git rev-parse HEAD\n0039231719d2a02c59e7cd76631e2ff03cc86b0d\n\n\n2. Which hypervisor did you use?\n   (For example: Libvirt + KVM, Libvirt + XEN, Hyper-V, PowerKVM, ...)\n   What's the version of that?\n\nLibvirt + KVM\n\n2. Which storage type did you use?\n   (For example: Ceph, LVM, GPFS, ...)\n   What's the version of that?\n\nLVM/iSCSI\n\n3. Which networking type did you use?\n   (For example: nova-network, Neutron with OpenVSwitch, ...)\n\nN/A\n\nLogs & Configs\n==============\n\nn-cpu.log\n\n2017-04-24 12:41:00.740 ERROR nova.compute.manager [req-95448809-bf98-4468-82cf-f4681678a8a4 admin admin] [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c] Failed to swap volume d7c43bc                                                      8-dbc4-4668-950a-a57397af7cbf for f998a062-8227-41b4-8400-d82a0f223ec3\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c] Traceback (most recent call last):\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/opt/stack/nova/nova/compute/manager.py\", line 4936, in _swap_volume\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     resize_to)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1328, in swap_volume\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     self._disconnect_volume(old_connection_info, disk_dev) \n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1176, in _disconnect_volume\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     vol_driver.disconnect_volume(connection_info, disk_dev)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/opt/stack/nova/nova/virt/libvirt/volume/iscsi.py\", line 74, in disconnect_volume\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     self.connector.disconnect_volume(connection_info['data'], None)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/os_brick/utils.py\", line 150, in trace_logging_wrapper\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     result = f(*args, **kwargs)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/oslo_concurrency/lockutils.py\", line 271, in inner\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     return f(*args, **kwargs)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/os_brick/initiator/connectors/iscsi.py\", line 502, in disconnect_volume\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     self._disconnect_volume_iscsi(props)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/os_brick/initiator/connectors/iscsi.py\", line 523, in _disconnect_volume_                        iscsi\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     self._linuxscsi.wait_for_volume_removal(host_device)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/os_brick/utils.py\", line 61, in _wrapper\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     return r.call(f, *args, **kwargs)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/retrying.py\", line 212, in call\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     raise attempt.get()\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/retrying.py\", line 247, in get\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     six.reraise(self.value[0], self.value[1], self.value[2])\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/retrying.py\", line 200, in call \n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     attempt = Attempt(fn(*args, **kwargs), attempt_number, False)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/os_brick/initiator/linuxscsi.py\", line 81, in wait_for_volume_removal\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     volume_path=volume_path)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c] VolumePathNotRemoved: Volume path /dev/disk/by-path/ip-192.168.122.224:3260-iscsi-iqn.2010-10.org.openstack:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf-lun-1 was not removed in time.\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]", 
    "tags": [
        "volumes"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1685875", 
    "owner": "None", 
    "id": 1685875, 
    "index": 4808, 
    "openned": "2017-04-24 18:05:17.888601+00:00", 
    "created": "2017-04-24 18:05:17.888601+00:00", 
    "title": "Swapping encrypted volumes leaves an encrypted volume attached to the instance", 
    "comments": [
        {
            "content": "Description\n===========\nSwapping encrypted volumes via `nova volume-update` currently results in the new volume being attached to the instance still encrypted and the original volume still connected to the host.\n\nSteps to reproduce\n==================\n\n# cinder type-create LUKS\n# cinder encryption-type-create --cipher aes-xts-plain64 \\\n      --key_size 512  --control_location front-end LUKS  \\\n      nova.volume.encryptors.luks.LuksEncryptor\n# cinder create --volume-type LUKS 1\n# cinder create --volume-type LUKS 1\n# nova boot --image cirros-0.3.5-x86_64-disk --flavor 2 test\n\n# nova volume-attach 445a811f-ca80-49d3-b3bd-156cb492c96c \\\n                     d7c43bc8-dbc4-4668-950a-a57397af7cbf\n# nova volume-update 445a811f-ca80-49d3-b3bd-156cb492c96c \\\n                     d7c43bc8-dbc4-4668-950a-a57397af7cbf \\\n                     f998a062-8227-41b4-8400-d82a0f223ec3\n\nExpected result\n===============\n\nThe original volume is disconnected from the host, the new volume is decrypted and attached to the instance.\n\nActual result\n=============\n\nf998a062, the new volume is now attached to the instance but without being decrypted :\n\n$ sudo virsh domblklist 445a811f-ca80-49d3-b3bd-156cb492c96c                                                                                                                                                             \nTarget     Source\n------------------------------------------------\nvda        /opt/stack/data/nova/instances/445a811f-ca80-49d3-b3bd-156cb492c96c/disk\nvdb        /dev/disk/by-path/ip-192.168.122.224:3260-iscsi-iqn.2010-10.org.openstack:volume-f998a062-8227-41b4-8400-d82a0f223ec3-lun-1\n\n\nd7c43bc8, the original volumes is still connected and decrypted on the host :\n\n$ iscsiadm -m session\ntcp: [5] 192.168.122.224:3260,1 iqn.2010-10.org.openstack:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf (non-flash)\ntcp: [6] 192.168.122.224:3260,1 iqn.2010-10.org.openstack:volume-f998a062-8227-41b4-8400-d82a0f223ec3 (non-flash)\n$ ll /dev/disk/by-path/ip-192.168.122.224\\:3260-iscsi-iqn.2010-10.org.openstack\\:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf-lun-1 \nlrwxrwxrwx. 1 root root 123 Apr 24 12:39 /dev/disk/by-path/ip-192.168.122.224:3260-iscsi-iqn.2010-10.org.openstack:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf-lun-1 -> /dev/mapper/crypt-ip-192.168.122.224:3260-iscsi-iqn.2010-10.org.openstack:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf-lun-1\n$ ll /dev/mapper/crypt*\nlrwxrwxrwx. 1 root root 7 Apr 24 12:40 /dev/mapper/crypt-ip-192.168.122.224:3260-iscsi-iqn.2010-10.org.openstack:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf-lun-1 -> ../dm-2\n\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n   list for all releases: http://docs.openstack.org/releases/\n\n$ git rev-parse HEAD\n0039231719d2a02c59e7cd76631e2ff03cc86b0d\n\n\n2. Which hypervisor did you use?\n   (For example: Libvirt + KVM, Libvirt + XEN, Hyper-V, PowerKVM, ...)\n   What's the version of that?\n\nLibvirt + KVM\n\n2. Which storage type did you use?\n   (For example: Ceph, LVM, GPFS, ...)\n   What's the version of that?\n\nLVM/iSCSI\n\n3. Which networking type did you use?\n   (For example: nova-network, Neutron with OpenVSwitch, ...)\n\nN/A\n\nLogs & Configs\n==============\n\nn-cpu.log\n\n2017-04-24 12:41:00.740 ERROR nova.compute.manager [req-95448809-bf98-4468-82cf-f4681678a8a4 admin admin] [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c] Failed to swap volume d7c43bc                                                      8-dbc4-4668-950a-a57397af7cbf for f998a062-8227-41b4-8400-d82a0f223ec3\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c] Traceback (most recent call last):\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/opt/stack/nova/nova/compute/manager.py\", line 4936, in _swap_volume\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     resize_to)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1328, in swap_volume\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     self._disconnect_volume(old_connection_info, disk_dev) \n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1176, in _disconnect_volume\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     vol_driver.disconnect_volume(connection_info, disk_dev)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/opt/stack/nova/nova/virt/libvirt/volume/iscsi.py\", line 74, in disconnect_volume\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     self.connector.disconnect_volume(connection_info['data'], None)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/os_brick/utils.py\", line 150, in trace_logging_wrapper\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     result = f(*args, **kwargs)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/oslo_concurrency/lockutils.py\", line 271, in inner\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     return f(*args, **kwargs)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/os_brick/initiator/connectors/iscsi.py\", line 502, in disconnect_volume\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     self._disconnect_volume_iscsi(props)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/os_brick/initiator/connectors/iscsi.py\", line 523, in _disconnect_volume_                        iscsi\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     self._linuxscsi.wait_for_volume_removal(host_device)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/os_brick/utils.py\", line 61, in _wrapper\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     return r.call(f, *args, **kwargs)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/retrying.py\", line 212, in call\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     raise attempt.get()\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/retrying.py\", line 247, in get\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     six.reraise(self.value[0], self.value[1], self.value[2])\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/retrying.py\", line 200, in call \n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     attempt = Attempt(fn(*args, **kwargs), attempt_number, False)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]   File \"/usr/lib/python2.7/site-packages/os_brick/initiator/linuxscsi.py\", line 81, in wait_for_volume_removal\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]     volume_path=volume_path)\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c] VolumePathNotRemoved: Volume path /dev/disk/by-path/ip-192.168.122.224:3260-iscsi-iqn.2010-10.org.openstack:volume-d7c43bc8-dbc4-4668-950a-a57397af7cbf-lun-1 was not removed in time.\n2017-04-24 12:41:00.740 TRACE nova.compute.manager [instance: 445a811f-ca80-49d3-b3bd-156cb492c96c]", 
            "date_created": "2017-04-24 18:05:17.888601+00:00", 
            "author": "https://api.launchpad.net/1.0/~lyarwood"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/460244", 
            "date_created": "2017-04-26 17:55:58.149391+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Sean Dague (<email address hidden>) on branch: master\nReview: https://review.openstack.org/460244\nReason: This review is > 4 weeks without comment, and is not mergable in it's current state. We are abandoning this for now. Feel free to reactivate the review by pressing the restore button and leaving a 'recheck' comment to get fresh test results.", 
            "date_created": "2017-08-01 09:54:26.877963+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "There are no currently open reviews on this bug, changing the status back to the previous state and unassigning. If there are active reviews related to this bug, please include links in comments. ", 
            "date_created": "2017-08-01 10:16:15.962118+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}