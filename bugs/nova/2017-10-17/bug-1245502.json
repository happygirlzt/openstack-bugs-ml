{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 08:52:59.595132+00:00", 
    "description": "I was running Ubuntu 13.04 and upgraded to 13.10.  I was running the Ubuntu Precise 1:2013.1.3-0ubuntu1.1 on 13.04 and am now on 13.10's provided 1:2013.2~rc2-0ubuntu1.\n\nAfter getting the box up, migrating the nova database failed with the below error.  I am using MySQL.\n\n\n# nova-manage -v db sync\n2013-10-27 01:47:03.615 24457 INFO migrate.versioning.api [-] 161 -> 162...\n2013-10-27 01:47:03.673 24457 INFO migrate.versioning.api [-] done\n...\n...\n2013-10-27 01:47:16.373 24457 INFO migrate.versioning.api [-] 184 -> 185...\nCommand failed, please check log for more info\n2013-10-27 01:47:17.835 24457 CRITICAL nova [-] (OperationalError) (1553, \"Cannot drop index 'instance_uuid': needed in a foreign key constraint\") 'ALTER TABLE instance_info_caches DROP INDEX instance_uuid' ()\n2013-10-27 01:47:17.835 24457 TRACE nova Traceback (most recent call last):\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n2013-10-27 01:47:17.835 24457 TRACE nova     sys.exit(main())\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 1377, in main\n2013-10-27 01:47:17.835 24457 TRACE nova     ret = fn(*fn_args, **fn_kwargs)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 885, in sync\n2013-10-27 01:47:17.835 24457 TRACE nova     return migration.db_sync(version)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 33, in db_sync\n2013-10-27 01:47:17.835 24457 TRACE nova     return IMPL.db_sync(version=version)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 75, in db_sync\n2013-10-27 01:47:17.835 24457 TRACE nova     return versioning_api.upgrade(get_engine(), repository, version)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n2013-10-27 01:47:17.835 24457 TRACE nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"<string>\", line 2, in _migrate\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 40, in patched_with_engine\n2013-10-27 01:47:17.835 24457 TRACE nova     return f(*a, **kw)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 366, in _migrate\n2013-10-27 01:47:17.835 24457 TRACE nova     schema.runchange(ver, change, changeset.step)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/schema.py\", line 91, in runchange\n2013-10-27 01:47:17.835 24457 TRACE nova     change.run(self.engine, step)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/script/py.py\", line 145, in run\n2013-10-27 01:47:17.835 24457 TRACE nova     script_func(engine)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migrate_repo/versions/185_rename_unique_constraints.py\", line 129, in upgrade\n2013-10-27 01:47:17.835 24457 TRACE nova     return _uc_rename(migrate_engine, upgrade=True)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migrate_repo/versions/185_rename_unique_constraints.py\", line 112, in _uc_rename\n2013-10-27 01:47:17.835 24457 TRACE nova     old_name, *(columns))\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/utils.py\", line 197, in drop_unique_constraint\n2013-10-27 01:47:17.835 24457 TRACE nova     uc.drop()\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/constraint.py\", line 59, in drop\n2013-10-27 01:47:17.835 24457 TRACE nova self.__do_imports('constraintdropper', *a, **kw)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/constraint.py\", line 32, in __do_imports\n2013-10-27 01:47:17.835 24457 TRACE nova     run_single_visitor(engine, visitorcallable, self, *a, **kw)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/databases/visitor.py\", line 75, in run_single_visitor\n2013-10-27 01:47:17.835 24457 TRACE nova     fn(element, **kwargs)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 272, in visit_migrate_unique_constraint\n2013-10-27 01:47:17.835 24457 TRACE nova     self._visit_constraint(*p, **k)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 284, in _visit_constraint\n2013-10-27 01:47:17.835 24457 TRACE nova     self.execute()\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 42, in execute\n2013-10-27 01:47:17.835 24457 TRACE nova     return self.connection.execute(self.buffer.getvalue())\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 662, in execute\n2013-10-27 01:47:17.835 24457 TRACE nova     params)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 805, in _execute_text\n2013-10-27 01:47:17.835 24457 TRACE nova     statement, parameters\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 874, in _execute_context\n2013-10-27 01:47:17.835 24457 TRACE nova     context)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1024, in _handle_dbapi_exception\n2013-10-27 01:47:17.835 24457 TRACE nova     exc_info\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 195, in raise_from_cause\n2013-10-27 01:47:17.835 24457 TRACE nova     reraise(type(exception), exception, tb=exc_tb)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 867, in _execute_context\n2013-10-27 01:47:17.835 24457 TRACE nova     context)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 324, in do_execute\n2013-10-27 01:47:17.835 24457 TRACE nova     cursor.execute(statement, parameters)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/MySQLdb/cursors.py\", line 174, in execute\n2013-10-27 01:47:17.835 24457 TRACE nova     self.errorhandler(self, exc, value)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n2013-10-27 01:47:17.835 24457 TRACE nova     raise errorclass, errorvalue\n2013-10-27 01:47:17.835 24457 TRACE nova OperationalError: (OperationalError) (1553, \"Cannot drop index 'instance_uuid': needed in a foreign key constraint\") 'ALTER TABLE instance_info_caches DROP INDEX instance_uuid' ()\n2013-10-27 01:47:17.835 24457 TRACE nova\n\n\nmysql> show create table instance_info_caches \\G\n*************************** 1. row ***************************\n       Table: instance_info_caches\nCreate Table: CREATE TABLE `instance_info_caches` (\n  `created_at` datetime DEFAULT NULL,\n  `updated_at` datetime DEFAULT NULL,\n  `deleted_at` datetime DEFAULT NULL,\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `network_info` mediumtext,\n  `instance_uuid` varchar(36) NOT NULL,\n  `deleted` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `instance_uuid` (`instance_uuid`),\n  CONSTRAINT `instance_info_caches_ibfk_1` FOREIGN KEY (`instance_uuid`) REFERENCES `instances` (`uuid`)\n) ENGINE=InnoDB AUTO_INCREMENT=202 DEFAULT CHARSET=utf8\n1 row in set (0.00 sec) \n\n\nDiscussed on the OpenStack mailing list and confirmed here:\n\nhttp://lists.openstack.org/pipermail/openstack/2013-October/002414.html", 
    "tags": [
        "in-stable-havana"
    ], 
    "importance": "Undecided", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1245502", 
    "owner": "https://api.launchpad.net/1.0/~joshua.hesketh", 
    "id": 1245502, 
    "index": 5505, 
    "openned": "2013-10-28 13:58:24.028395+00:00", 
    "created": "2013-10-28 13:58:24.028395+00:00", 
    "title": "Grizzly -> Havana nova upgrade failure: Cannot drop index 'instance_uuid'", 
    "comments": [
        {
            "content": "I was running Ubuntu 13.04 and upgraded to 13.10.  I was running the Ubuntu Precise 1:2013.1.3-0ubuntu1.1 on 13.04 and am now on 13.10's provided 1:2013.2~rc2-0ubuntu1.\n\nAfter getting the box up, migrating the nova database failed with the below error.  I am using MySQL.\n\n\n# nova-manage -v db sync\n2013-10-27 01:47:03.615 24457 INFO migrate.versioning.api [-] 161 -> 162...\n2013-10-27 01:47:03.673 24457 INFO migrate.versioning.api [-] done\n...\n...\n2013-10-27 01:47:16.373 24457 INFO migrate.versioning.api [-] 184 -> 185...\nCommand failed, please check log for more info\n2013-10-27 01:47:17.835 24457 CRITICAL nova [-] (OperationalError) (1553, \"Cannot drop index 'instance_uuid': needed in a foreign key constraint\") 'ALTER TABLE instance_info_caches DROP INDEX instance_uuid' ()\n2013-10-27 01:47:17.835 24457 TRACE nova Traceback (most recent call last):\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/bin/nova-manage\", line 10, in <module>\n2013-10-27 01:47:17.835 24457 TRACE nova     sys.exit(main())\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 1377, in main\n2013-10-27 01:47:17.835 24457 TRACE nova     ret = fn(*fn_args, **fn_kwargs)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/cmd/manage.py\", line 885, in sync\n2013-10-27 01:47:17.835 24457 TRACE nova     return migration.db_sync(version)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/migration.py\", line 33, in db_sync\n2013-10-27 01:47:17.835 24457 TRACE nova     return IMPL.db_sync(version=version)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 75, in db_sync\n2013-10-27 01:47:17.835 24457 TRACE nova     return versioning_api.upgrade(get_engine(), repository, version)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 186, in upgrade\n2013-10-27 01:47:17.835 24457 TRACE nova     return _migrate(url, repository, version, upgrade=True, err=err, **opts)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"<string>\", line 2, in _migrate\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migration.py\", line 40, in patched_with_engine\n2013-10-27 01:47:17.835 24457 TRACE nova     return f(*a, **kw)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/api.py\", line 366, in _migrate\n2013-10-27 01:47:17.835 24457 TRACE nova     schema.runchange(ver, change, changeset.step)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/schema.py\", line 91, in runchange\n2013-10-27 01:47:17.835 24457 TRACE nova     change.run(self.engine, step)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/versioning/script/py.py\", line 145, in run\n2013-10-27 01:47:17.835 24457 TRACE nova     script_func(engine)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migrate_repo/versions/185_rename_unique_constraints.py\", line 129, in upgrade\n2013-10-27 01:47:17.835 24457 TRACE nova     return _uc_rename(migrate_engine, upgrade=True)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/migrate_repo/versions/185_rename_unique_constraints.py\", line 112, in _uc_rename\n2013-10-27 01:47:17.835 24457 TRACE nova     old_name, *(columns))\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/utils.py\", line 197, in drop_unique_constraint\n2013-10-27 01:47:17.835 24457 TRACE nova     uc.drop()\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/constraint.py\", line 59, in drop\n2013-10-27 01:47:17.835 24457 TRACE nova self.__do_imports('constraintdropper', *a, **kw)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/constraint.py\", line 32, in __do_imports\n2013-10-27 01:47:17.835 24457 TRACE nova     run_single_visitor(engine, visitorcallable, self, *a, **kw)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/databases/visitor.py\", line 75, in run_single_visitor\n2013-10-27 01:47:17.835 24457 TRACE nova     fn(element, **kwargs)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 272, in visit_migrate_unique_constraint\n2013-10-27 01:47:17.835 24457 TRACE nova     self._visit_constraint(*p, **k)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 284, in _visit_constraint\n2013-10-27 01:47:17.835 24457 TRACE nova     self.execute()\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/migrate/changeset/ansisql.py\", line 42, in execute\n2013-10-27 01:47:17.835 24457 TRACE nova     return self.connection.execute(self.buffer.getvalue())\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 662, in execute\n2013-10-27 01:47:17.835 24457 TRACE nova     params)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 805, in _execute_text\n2013-10-27 01:47:17.835 24457 TRACE nova     statement, parameters\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 874, in _execute_context\n2013-10-27 01:47:17.835 24457 TRACE nova     context)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 1024, in _handle_dbapi_exception\n2013-10-27 01:47:17.835 24457 TRACE nova     exc_info\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/util/compat.py\", line 195, in raise_from_cause\n2013-10-27 01:47:17.835 24457 TRACE nova     reraise(type(exception), exception, tb=exc_tb)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py\", line 867, in _execute_context\n2013-10-27 01:47:17.835 24457 TRACE nova     context)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py\", line 324, in do_execute\n2013-10-27 01:47:17.835 24457 TRACE nova     cursor.execute(statement, parameters)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/MySQLdb/cursors.py\", line 174, in execute\n2013-10-27 01:47:17.835 24457 TRACE nova     self.errorhandler(self, exc, value)\n2013-10-27 01:47:17.835 24457 TRACE nova   File \"/usr/lib/python2.7/dist-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n2013-10-27 01:47:17.835 24457 TRACE nova     raise errorclass, errorvalue\n2013-10-27 01:47:17.835 24457 TRACE nova OperationalError: (OperationalError) (1553, \"Cannot drop index 'instance_uuid': needed in a foreign key constraint\") 'ALTER TABLE instance_info_caches DROP INDEX instance_uuid' ()\n2013-10-27 01:47:17.835 24457 TRACE nova\n\n\nmysql> show create table instance_info_caches \\G\n*************************** 1. row ***************************\n       Table: instance_info_caches\nCreate Table: CREATE TABLE `instance_info_caches` (\n  `created_at` datetime DEFAULT NULL,\n  `updated_at` datetime DEFAULT NULL,\n  `deleted_at` datetime DEFAULT NULL,\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `network_info` mediumtext,\n  `instance_uuid` varchar(36) NOT NULL,\n  `deleted` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `instance_uuid` (`instance_uuid`),\n  CONSTRAINT `instance_info_caches_ibfk_1` FOREIGN KEY (`instance_uuid`) REFERENCES `instances` (`uuid`)\n) ENGINE=InnoDB AUTO_INCREMENT=202 DEFAULT CHARSET=utf8\n1 row in set (0.00 sec) \n\n\nDiscussed on the OpenStack mailing list and confirmed here:\n\nhttp://lists.openstack.org/pipermail/openstack/2013-October/002414.html", 
            "date_created": "2013-10-28 13:58:24.028395+00:00", 
            "author": "https://api.launchpad.net/1.0/~blair"
        }, 
        {
            "content": "This is odd, but known behavior of MySQL: it doesn't allow one to drop a unique constraint if one or more columns of the latter are used a FK. So the solution is to drop the FK first, drop the unique and then recreate the FK. And this is what migration 185 does.\n\nThe problem with this particular migration is that your FK name doesn't correspond the one we have in the original Folsom migration (133_folsom.py): instance_info_caches_ibfk_1 vs  instance_info_caches_instance_uuid_fkey. The name instance_info_caches_ibfk_1 comes from the Essex initial migration (082_essex.py).\n\nDid you upgrade this installation from Folsom  to Grizzly before? \n\nFrom what I see, we have a bug in migration 133_folsom.py, which accidentally changed the name of the FK constraint when all pre-folsom migrations were compacted.", 
            "date_created": "2013-10-28 14:42:10.799266+00:00", 
            "author": "https://api.launchpad.net/1.0/~rpodolyaka"
        }, 
        {
            "content": "Yes, this install started with 2012.2.1 at a minimum and I've been upgrading it through releases.\n\nSo would renaming instance_info_caches_ibfk_1 to instance_info_caches_instance_uuid_fkey and then rerunning 'db sync' work?\n", 
            "date_created": "2013-10-28 15:45:23.028401+00:00", 
            "author": "https://api.launchpad.net/1.0/~blair"
        }, 
        {
            "content": "*Takes a deep breath* I have the same issue and we update from cactus to disablo to essex to folsom to grizzly to havana... ", 
            "date_created": "2013-10-28 15:59:31.268952+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-hill-ubisoft"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/54212", 
            "date_created": "2013-10-29 00:06:15.665223+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "@Blair\n\nYes, renaming of the FK constraint and rerunning 'db sync' should help.", 
            "date_created": "2013-10-29 07:41:21.638894+00:00", 
            "author": "https://api.launchpad.net/1.0/~rpodolyaka"
        }, 
        {
            "content": "I asked Svetlana Shturm to take a look at this one. She's been working hard on writing a test for finding differences between two DB schemas. I hope, using this test we can fix all the variances the compacted migrations brought, so pre-Grizzly ->  Havana upgrade could be done. ", 
            "date_created": "2013-10-29 08:34:54.514803+00:00", 
            "author": "https://api.launchpad.net/1.0/~rpodolyaka"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/54212\nCommitted: http://github.com/openstack/nova/commit/c620cafb700ca195db0bd0ef9d62a0c9459bdc38\nSubmitter: Jenkins\nBranch:    master\n\ncommit c620cafb700ca195db0bd0ef9d62a0c9459bdc38\nAuthor: Joshua Hesketh <email address hidden>\nDate:   Tue Oct 29 09:40:41 2013 +1100\n\n    Fix migration 185 to work with old fkey names\n    \n    Migration 133_folsom.py accidentally changed the name of the FK\n    constraint on instance_info_caches from instance_info_caches_ibfk_1\n    to instance_info_caches_instance_uuid_fkey and on virtual_interfaces\n    from virtual_interfaces_ibfk_1 to\n    virtual_interfaces_instance_uuid_fkey meaning databases who have\n    upgraded from before folsom have the old fkey.\n    \n    This patch adds a check for those with the old fkey name to make sure\n    it is dropped before changing unique constraints (as is required by\n    MySQL). It also fixes the fkey name to be as defined in 133 if it\n    wasn't before (which will persist on downgrade being consistent with\n    those who have come in after folsom).\n    \n    Closes-Bug: #1245502\n    \n    Change-Id: Ib0dcd04fcb9ed776c76d40561181abad2e14f76f\n", 
            "date_created": "2013-11-13 03:33:26.560483+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/56149", 
            "date_created": "2013-11-13 05:20:55.244365+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hey, I'm very sorry for such a late response, but it's better late than never...\n\nOk, so Svetlana did the deep investigation of this bug. Despite I was sure, we had a problem with initial folsom migration (133_folsom.py), it looks like the actual problem is more subtle. It turns out that during Essex release cycle we had a migration that created the FKs mentioned above WITHOUT specifying names for them. In this case it's up to RDBMS  to choose a name for a constraint. It seems that at that time we had a different release of MySQL which had a different algorithms for choosing names for FKs. So Dan's tests for comparing migrations are actually OK and the compacted migration is OK.\n\nSo here is problem. Depending on the concrete version of MySQL users had when they upgraded from Essex to Folsom, they ended up with different names for the same FK constraints... This means that we don't have a consistent state of our DB schema when we run migrations scripts.\n\nIn order to fix this, we must fix every migration, that touches such FKs/etc. Joshua has already fixed one. Thank you for undertaking this task!\n\nSo, affected users, you can actually help by providing us with the dumps of your DB SCHEMAS (without data, of course) before upgades to Grizzly or Havana. In this case, we could compare your DB schemas with the ones we expect to see, and fix all the differences by patching existing migrations.", 
            "date_created": "2013-11-13 12:38:33.402021+00:00", 
            "author": "https://api.launchpad.net/1.0/~rpodolyaka"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/56149\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=bd724fbb78f37c19d2cd265f19194684cc265575\nSubmitter: Jenkins\nBranch:    stable/havana\n\ncommit bd724fbb78f37c19d2cd265f19194684cc265575\nAuthor: Joshua Hesketh <email address hidden>\nDate:   Tue Oct 29 09:40:41 2013 +1100\n\n    Fix migration 185 to work with old fkey names\n    \n    Due to different versions of MySQL it is possible to end up with\n    different FK's then what is expected. For example the FK constraint\n    on instance_info_caches changed from instance_info_caches_ibfk_1\n    to instance_info_caches_instance_uuid_fkey and on virtual_interfaces\n    from virtual_interfaces_ibfk_1 to\n    virtual_interfaces_instance_uuid_fkey meaning databases who have\n    upgraded from before folsom may have the old fkey.\n    \n    This patch adds a check for those with the old fkey name to make sure\n    it is dropped before changing unique constraints (as is required by\n    MySQL). It also fixes the fkey name to be as defined in 133 if it\n    wasn't before (which will persist on downgrade being consistent with\n    those who have come in after folsom).\n    \n    Closes-Bug: #1245502\n    \n    Change-Id: Ib0dcd04fcb9ed776c76d40561181abad2e14f76f\n    (cherry picked from commit c620cafb700ca195db0bd0ef9d62a0c9459bdc38)\n", 
            "date_created": "2014-01-01 15:49:51.552508+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I see error for instance_type_projects while upgrading from grizzly->havana. Also, this is seen only in cases where db existed since folsom.\n\nHere is the error - \nCannot drop index 'uniq_instance_type_id_x_project_id_x_deleted': needed in a\nforeign key constraint\") 'ALTER TABLE instance_type_projects DROP INDEX\nuniq_instance_type_id_x_project_id_x_deleted' ()\n\nHere is how the table looks:\n| instance_type_projects | CREATE TABLE `instance_type_projects` (\n  `created_at` datetime DEFAULT NULL,\n  `updated_at` datetime DEFAULT NULL,\n  `deleted_at` datetime DEFAULT NULL,\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `instance_type_id` int(11) NOT NULL,\n  `project_id` varchar(255) DEFAULT NULL,\n  `deleted` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uniq_instance_type_id_x_project_id_x_deleted` (`instance_type_id`,`project_id`,`deleted`),\n  CONSTRAINT `instance_type_projects_ibfk_1` FOREIGN KEY (`instance_type_id`) REFERENCES `instance_types` (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 |\n\nIn order to get past this, I had to run following steps:\nmysql> ALTER TABLE instance_type_projects DROP FOREIGN KEY instance_type_projects_ibfk_1;\n\nand then run nova-manage db sync 185.\n\nThis is the new state after the migration:\n| instance_type_projects | CREATE TABLE `instance_type_projects` (\n  `created_at` datetime DEFAULT NULL,\n  `updated_at` datetime DEFAULT NULL,\n  `deleted_at` datetime DEFAULT NULL,\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `instance_type_id` int(11) NOT NULL,\n  `project_id` varchar(255) DEFAULT NULL,\n  `deleted` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uniq_instance_type_projects0instance_type_id0project_id0deleted` (`instance_type_id`,`project_id`,`deleted`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 |\n\n\nIs this correct?", 
            "date_created": "2014-03-12 22:11:07.500275+00:00", 
            "author": "https://api.launchpad.net/1.0/~meghalgosalia"
        }, 
        {
            "content": "Should not the script create the foreign key?", 
            "date_created": "2014-03-12 22:13:51.503712+00:00", 
            "author": "https://api.launchpad.net/1.0/~meghalgosalia"
        }
    ], 
    "closed": "2013-12-04 10:36:56.291029+00:00"
}