{
    "status": "Invalid", 
    "last_updated": "2012-10-23 23:19:04.131381+00:00", 
    "description": "After restarting libvirtd the nova-compute service looks broken. Creating a new instance is not working anymore. After restarting nova-compute everything is fine.\n\n2012-05-01 19:30:51 ERROR nova.rpc.amqp [req-66bb865c-b0e8-41d4-ac05-059206056bbf abfcc21cbd184dd9b6a8e861580997f1 47da4a2dfc6b41aa88bfa4bb79ff7622] Exception during message handling\n2012-05-01 19:30:51 TRACE nova.rpc.amqp Traceback (most recent call last):\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/rpc/amqp.py\", line 252, in _process_data\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     rval = node_func(context=ctxt, **node_args)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/exception.py\", line 114, in wrapped\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     return f(*args, **kw)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 177, in decorated_function\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     sys.exc_info())\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self.gen.next()\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 171, in decorated_function\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     return function(self, context, instance_uuid, *args, **kwargs)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 651, in run_instance\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     do_run_instance()\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/utils.py\", line 945, in inner\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     retval = f(*args, **kwargs)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 650, in do_run_instance\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self._run_instance(context, instance_uuid, **kwargs)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 451, in _run_instance\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self._set_instance_error_state(context, instance_uuid)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self.gen.next()\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 432, in _run_instance\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self._deallocate_network(context, instance)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self.gen.next()\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 429, in _run_instance\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     injected_files, admin_password)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 592, in _spawn\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self._legacy_nw_info(network_info), block_device_info)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/exception.py\", line 114, in wrapped\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     return f(*args, **kw)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/virt/libvirt/connection.py\", line 899, in spawn\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self.firewall_driver.setup_basic_filtering(instance, network_info)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/virt/libvirt/firewall.py\", line 231, in setup_basic_filtering\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self.nwfilter.setup_basic_filtering(instance, network_info)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/virt/libvirt/firewall.py\", line 113, in setup_basic_filtering\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     [base_filter]))\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/virt/libvirt/firewall.py\", line 150, in _define_filter\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     tpool.execute(self._conn.nwfilterDefineXML, xml)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/eventlet/tpool.py\", line 76, in tworker\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     rv = meth(*args,**kwargs)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/libvirt.py\", line 2638, in nwfilterDefineXML\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     if ret is None:raise libvirtError('virNWFilterDefineXML() failed', conn=self)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp libvirtError: Cannot write data: Broken pipe\n2012-05-01 19:30:51 TRACE nova.rpc.amqp", 
    "tags": [], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/992740", 
    "owner": "None", 
    "id": 992740, 
    "index": 549, 
    "openned": "2012-05-01 17:33:01.747006+00:00", 
    "created": "2012-05-01 17:33:01.747006+00:00", 
    "title": "nova-compute broken after restarting libvirt", 
    "comments": [
        {
            "content": "After restarting libvirtd the nova-compute service looks broken. Creating a new instance is not working anymore. After restarting nova-compute everything is fine.\n\n2012-05-01 19:30:51 ERROR nova.rpc.amqp [req-66bb865c-b0e8-41d4-ac05-059206056bbf abfcc21cbd184dd9b6a8e861580997f1 47da4a2dfc6b41aa88bfa4bb79ff7622] Exception during message handling\n2012-05-01 19:30:51 TRACE nova.rpc.amqp Traceback (most recent call last):\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/rpc/amqp.py\", line 252, in _process_data\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     rval = node_func(context=ctxt, **node_args)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/exception.py\", line 114, in wrapped\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     return f(*args, **kw)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 177, in decorated_function\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     sys.exc_info())\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self.gen.next()\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 171, in decorated_function\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     return function(self, context, instance_uuid, *args, **kwargs)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 651, in run_instance\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     do_run_instance()\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/utils.py\", line 945, in inner\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     retval = f(*args, **kwargs)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 650, in do_run_instance\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self._run_instance(context, instance_uuid, **kwargs)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 451, in _run_instance\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self._set_instance_error_state(context, instance_uuid)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self.gen.next()\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 432, in _run_instance\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self._deallocate_network(context, instance)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/contextlib.py\", line 23, in __exit__\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self.gen.next()\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 429, in _run_instance\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     injected_files, admin_password)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/compute/manager.py\", line 592, in _spawn\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self._legacy_nw_info(network_info), block_device_info)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/exception.py\", line 114, in wrapped\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     return f(*args, **kw)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/virt/libvirt/connection.py\", line 899, in spawn\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self.firewall_driver.setup_basic_filtering(instance, network_info)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/virt/libvirt/firewall.py\", line 231, in setup_basic_filtering\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     self.nwfilter.setup_basic_filtering(instance, network_info)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/virt/libvirt/firewall.py\", line 113, in setup_basic_filtering\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     [base_filter]))\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/nova/virt/libvirt/firewall.py\", line 150, in _define_filter\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     tpool.execute(self._conn.nwfilterDefineXML, xml)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/eventlet/tpool.py\", line 76, in tworker\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     rv = meth(*args,**kwargs)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp   File \"/usr/lib64/python2.6/site-packages/libvirt.py\", line 2638, in nwfilterDefineXML\n2012-05-01 19:30:51 TRACE nova.rpc.amqp     if ret is None:raise libvirtError('virNWFilterDefineXML() failed', conn=self)\n2012-05-01 19:30:51 TRACE nova.rpc.amqp libvirtError: Cannot write data: Broken pipe\n2012-05-01 19:30:51 TRACE nova.rpc.amqp", 
            "date_created": "2012-05-01 17:33:01.747006+00:00", 
            "author": "https://api.launchpad.net/1.0/~berendt"
        }, 
        {
            "content": "works for me. please see http://paste.openstack.org/show/22155/ - lines 50 to 73 show the call stack when i stopped libvirtd. Then i restarted libvirtd and deployed a fresh instance and it came up fine.", 
            "date_created": "2012-10-23 23:19:01.781498+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }
    ], 
    "closed": "2012-10-23 23:19:02.929921+00:00"
}