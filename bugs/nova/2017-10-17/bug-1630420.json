{
    "status": "Fix Released", 
    "last_updated": "2016-11-17 13:12:51.717060+00:00", 
    "description": "I was running unit tests on a bare bones vm that didn't have genisoimage installed and the test_rescue_config_drive test failed.\n\n==============================\nFailed 1 tests - output below:\n==============================\n\nnova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase.test_rescue_config_drive\n---------------------------------------------------------------------------------------\n\nCaptured traceback:\n~~~~~~~~~~~~~~~~~~~\n    Traceback (most recent call last):\n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16420, in test_rescue_config_drive\n        instance, exists=lambda name: name != 'disk.config.rescue')\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1305, in patched\n        return func(*args, **keywargs)\n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16374, in _test_rescue\n        network_info, image_meta, rescue_password)\n      File \"nova/virt/libvirt/driver.py\", line 2531, in rescue\n        self._create_domain(xml, post_xml_callback=gen_confdrive)\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1062, in __call__\n        return _mock_self._mock_call(*args, **kwargs)\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1128, in _mock_call\n        ret_val = effect(*args, **kwargs)\n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16368, in fake_create_domain\n        post_xml_callback()\n      File \"nova/virt/libvirt/driver.py\", line 3130, in _create_configdrive\n        cdb.make_drive(config_drive_local_path)\n      File \"nova/virt/configdrive.py\", line 143, in make_drive\n        self._make_iso9660(path, tmpdir)\n      File \"nova/virt/configdrive.py\", line 97, in _make_iso9660\n        run_as_root=False)\n      File \"nova/utils.py\", line 296, in execute\n        return processutils.execute(*cmd, **kwargs)\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/oslo_concurrency/processutils.py\", line 363, in execute\n        env=env_variables)\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/eventlet/green/subprocess.py\", line 54, in __init__\n        subprocess_orig.Popen.__init__(self, args, 0, *argss, **kwds)\n      File \"/usr/lib/python2.7/subprocess.py\", line 711, in __init__\n        errread, errwrite)\n      File \"/usr/lib/python2.7/subprocess.py\", line 1343, in _execute_child\n        raise child_exception\n    OSError: [Errno 2] No such file or directory\n\n\nWhen I installed genisoimage, the test passed.\n\ngenisoimage is the default value for mkisofs_cmd (configurable). It's called in the _make_iso9660 method for creating an image. Besides the issue of shelling out to a process going beyond the scope of what a unit test should cover, this also creates a hard dependency on genisoimage.\n\nOther areas in the code mock the call to genisoimage. This test should do something similar.\nhttps://github.com/openstack/nova/blob/master/nova/tests/unit/test_configdrive2.py#L49", 
    "tags": [
        "libvirt", 
        "testing"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1630420", 
    "owner": "https://api.launchpad.net/1.0/~diana-clarke", 
    "id": 1630420, 
    "index": 2094, 
    "openned": "2016-10-05 01:23:29.248303+00:00", 
    "created": "2016-10-05 01:23:29.248303+00:00", 
    "title": "config_drive unit tests (libvirt driver) aren't mocking genisoimage", 
    "comments": [
        {
            "content": "I was running unit tests on a bare bones vm that didn't have genisoimage installed and the test_rescue_config_drive test failed.\n\n==============================\nFailed 1 tests - output below:\n==============================\n\nnova.tests.unit.virt.libvirt.test_driver.LibvirtDriverTestCase.test_rescue_config_drive\n---------------------------------------------------------------------------------------\n\nCaptured traceback:\n~~~~~~~~~~~~~~~~~~~\n    Traceback (most recent call last):\n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16420, in test_rescue_config_drive\n        instance, exists=lambda name: name != 'disk.config.rescue')\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1305, in patched\n        return func(*args, **keywargs)\n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16374, in _test_rescue\n        network_info, image_meta, rescue_password)\n      File \"nova/virt/libvirt/driver.py\", line 2531, in rescue\n        self._create_domain(xml, post_xml_callback=gen_confdrive)\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1062, in __call__\n        return _mock_self._mock_call(*args, **kwargs)\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1128, in _mock_call\n        ret_val = effect(*args, **kwargs)\n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 16368, in fake_create_domain\n        post_xml_callback()\n      File \"nova/virt/libvirt/driver.py\", line 3130, in _create_configdrive\n        cdb.make_drive(config_drive_local_path)\n      File \"nova/virt/configdrive.py\", line 143, in make_drive\n        self._make_iso9660(path, tmpdir)\n      File \"nova/virt/configdrive.py\", line 97, in _make_iso9660\n        run_as_root=False)\n      File \"nova/utils.py\", line 296, in execute\n        return processutils.execute(*cmd, **kwargs)\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/oslo_concurrency/processutils.py\", line 363, in execute\n        env=env_variables)\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/eventlet/green/subprocess.py\", line 54, in __init__\n        subprocess_orig.Popen.__init__(self, args, 0, *argss, **kwds)\n      File \"/usr/lib/python2.7/subprocess.py\", line 711, in __init__\n        errread, errwrite)\n      File \"/usr/lib/python2.7/subprocess.py\", line 1343, in _execute_child\n        raise child_exception\n    OSError: [Errno 2] No such file or directory\n\n\nWhen I installed genisoimage, the test passed.\n\ngenisoimage is the default value for mkisofs_cmd (configurable). It's called in the _make_iso9660 method for creating an image. Besides the issue of shelling out to a process going beyond the scope of what a unit test should cover, this also creates a hard dependency on genisoimage.\n\nOther areas in the code mock the call to genisoimage. This test should do something similar.\nhttps://github.com/openstack/nova/blob/master/nova/tests/unit/test_configdrive2.py#L49", 
            "date_created": "2016-10-05 01:23:29.248303+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "Also see: https://bugs.launchpad.net/nova/+bug/1629555\n\"Allow the usage of mkisofs instead of genisoimage\"", 
            "date_created": "2016-10-05 01:24:44.626312+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "Followed up with mdbooth and verified that this should be mocked, so marking as confirmed.\n\nIt was also suggested that we need to add functional test coverage that does call genisoimage. I'm working separately to figure out the best course of action there, but am leaning towards wanting the functional test coverage to be limited to just making sure it handles an ISO image rather than calling out to a specific program to generate it. I think we should depend on integration test coverage for actually calling out to specific utilities.", 
            "date_created": "2016-10-05 18:11:00.149472+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "Functional test coverage is another issue and there's a bigger question of whether this should even be a configurable value. I need to gather more information but will propose a spec or bug regarding this issue once I have more info. In the meantime, this bug is just focused on mocking the call to genisoimage.", 
            "date_created": "2016-10-05 18:33:51.246335+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "Found another one:\ntest_spawn_with_config_drive\n\nnova.tests.unit.virt.libvirt.test_driver.LibvirtConnTestCase.test_spawn_with_config_drive\n-----------------------------------------------------------------------------------------\n                                                \nCaptured pythonlogging:                         \n~~~~~~~~~~~~~~~~~~~~~~~                         \n    2016-10-05 23:36:46,652 WARNING [nova.virt.libvirt.firewall] Libvirt module could not be loaded. NWFilterFirewall will not work correctly.\n    2016-10-05 23:36:46,653 INFO [os_brick.initiator.connectors.disco] Init DISCO connector\n    2016-10-05 23:36:46,654 WARNING [os_brick.initiator.connectors.remotefs] Connection details not present. RemoteFsClient may not initialize properly.                                              \n    2016-10-05 23:36:46,655 INFO [nova.virt.libvirt.driver] Creating image\n    2016-10-05 23:36:46,750 INFO [nova.virt.libvirt.driver] Using config drive\n    2016-10-05 23:36:46,798 INFO [nova.virt.libvirt.driver] Creating config drive at /tmp/tmppwqIMN/tmpxHedSY/32dfcb37-5af1-552b-357c-be8c3aa38310/disk.config                                        \n                                                \n                                                \nCaptured traceback:                             \n~~~~~~~~~~~~~~~~~~~                             \n    Traceback (most recent call last):          \n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1305, in patched\n        return func(*args, **keywargs)          \n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 10149, in test_spawn_with_config_drive\n        image_meta, [], None)                   \n      File \"nova/virt/libvirt/driver.py\", line 2593, in spawn\n        post_xml_callback=gen_confdrive)        \n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1062, in __call__\n        return _mock_self._mock_call(*args, **kwargs)\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/mock/mock.py\", line 1128, in _mock_call\n        ret_val = effect(*args, **kwargs)       \n      File \"nova/tests/unit/virt/libvirt/test_driver.py\", line 10139, in fake_create_domain_and_network\n        post_xml_callback()                     \n      File \"nova/virt/libvirt/driver.py\", line 3130, in _create_configdrive\n        cdb.make_drive(config_drive_local_path) \n      File \"nova/virt/configdrive.py\", line 143, in make_drive\n        self._make_iso9660(path, tmpdir)        \n      File \"nova/virt/configdrive.py\", line 97, in _make_iso9660\n        run_as_root=False)                      \n      File \"nova/utils.py\", line 296, in execute\n        return processutils.execute(*cmd, **kwargs)\n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/oslo_concurrency/processutils.py\", line 363, in execute\n        env=env_variables)                      \n      File \"/home/auggy/nova/.tox/py27/local/lib/python2.7/site-packages/eventlet/green/subprocess.py\", line 54, in __init__\n        subprocess_orig.Popen.__init__(self, args, 0, *argss, **kwds)\n      File \"/usr/lib/python2.7/subprocess.py\", line 711, in __init__\n        errread, errwrite)                      \n      File \"/usr/lib/python2.7/subprocess.py\", line 1343, in _execute_child\n        raise child_exception                   \n    OSError: [Errno 2] No such file or directory\n", 
            "date_created": "2016-10-05 23:47:34.246082+00:00", 
            "author": "https://api.launchpad.net/1.0/~auggy"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/383524\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b90df7c9c7042d2a8f104f66220f81ecb2951597\nSubmitter: Jenkins\nBranch:    master\n\ncommit b90df7c9c7042d2a8f104f66220f81ecb2951597\nAuthor: Diana Clarke <email address hidden>\nDate:   Thu Oct 6 21:52:03 2016 -0400\n\n    Patch mkisofs calls\n    \n    The nova unit tests recently started to fail on systems lacking mkisofs\n    (like mac osx). Skip these mkisofs calls by patching _make_iso9660.\n    \n    Change-Id: I350aafa878616f74df506c1bc9ee5f26ea06fe97\n    Closes-Bug: #1630420\n", 
            "date_created": "2016-10-07 20:46:49.105463+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b1 development milestone.", 
            "date_created": "2016-11-17 13:12:50.390481+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-10-07 20:46:46.300043+00:00"
}