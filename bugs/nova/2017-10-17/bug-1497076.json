{
    "status": "Fix Released", 
    "last_updated": "2015-12-03 21:36:52.490488+00:00", 
    "description": "I am trying to delete an instance (UUID 78d874ef-a9ec-4ede-9489-ff00903eb7fc), but this is failing due to corrupt data in nova's database tables.\nI have no idea how this corruption arose, and I don't think it's possible to find out in order to reproduce this issue. Therefore, this bug report is not about preventing the DB corruption. Instead, it's about making Nova degrade more gracefully  in the presence of such corruption.\n\n1. We are running Juno partially upgraded to Kilo (we are mid-way through an in-place upgrade of Juno to Kilo).\n\n2. Relevant log files and other data will be attached shortly\n\n3. Steps to reproduce\n\n3.1. Install a federated multi-cell OpenStack cloud (NeCTAR)\n3.2. Use it for years, progressively upgrading it to successive OpenStack releases and meanwhile performing many operations which modify the database, one of which was (I suppose) a partially-failed creation of an instance with the given UUID\n3.3. Attempt to delete the half-existing instance by executing:\nnova --debug force-delete 78d874ef-a9ec-4ede-9489-ff00903eb7fc\n\nExpected results:\n\n- All traces of the existence of the given instance shall be removed, apart perhaps from historical data, such as records with column 'deleted' non-zero, or records in shadow tables, or log files\n- The client shall receive a 200 (success) HTTP status from the server\n\nActual results:\n\n- The remains of the instance (eg DB records) are not removed. I will upload partial table dumps.\n- The client receives a 404. I will upload console output.\n- The nova-cells service attempts to violate a DB foreign key constraint and outputs a stack backtrace to its log file, which again I will upload shortly.", 
    "tags": [
        "cells", 
        "db", 
        "terminate"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1497076", 
    "owner": "None", 
    "id": 1497076, 
    "index": 7041, 
    "openned": "2015-09-18 02:50:11.475730+00:00", 
    "created": "2015-09-18 02:50:11.475730+00:00", 
    "title": "Unable to delete an instance due to foreign key violation", 
    "comments": [
        {
            "content": "I am trying to delete an instance (UUID 78d874ef-a9ec-4ede-9489-ff00903eb7fc), but this is failing due to corrupt data in nova's database tables.\nI have no idea how this corruption arose, and I don't think it's possible to find out in order to reproduce this issue. Therefore, this bug report is not about preventing the DB corruption. Instead, it's about making Nova degrade more gracefully  in the presence of such corruption.\n\n1. We are running Juno partially upgraded to Kilo (we are mid-way through an in-place upgrade of Juno to Kilo).\n\n2. Relevant log files and other data will be attached shortly\n\n3. Steps to reproduce\n\n3.1. Install a federated multi-cell OpenStack cloud (NeCTAR)\n3.2. Use it for years, progressively upgrading it to successive OpenStack releases and meanwhile performing many operations which modify the database, one of which was (I suppose) a partially-failed creation of an instance with the given UUID\n3.3. Attempt to delete the half-existing instance by executing:\nnova --debug force-delete 78d874ef-a9ec-4ede-9489-ff00903eb7fc\n\nExpected results:\n\n- All traces of the existence of the given instance shall be removed, apart perhaps from historical data, such as records with column 'deleted' non-zero, or records in shadow tables, or log files\n- The client shall receive a 200 (success) HTTP status from the server\n\nActual results:\n\n- The remains of the instance (eg DB records) are not removed. I will upload partial table dumps.\n- The client receives a 404. I will upload console output.\n- The nova-cells service attempts to violate a DB foreign key constraint and outputs a stack backtrace to its log file, which again I will upload shortly.", 
            "date_created": "2015-09-18 02:50:11.475730+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "Output of 'nova show':\n\n$ nova show 78d874ef-a9ec-4ede-9489-ff00903eb7fc\n+--------------------------------------+-------------------------------------------------------+\n| Property                             | Value                                                 |\n+--------------------------------------+-------------------------------------------------------+\n| OS-DCF:diskConfig                    | AUTO                                                  |\n| OS-EXT-AZ:availability_zone          | NCI                                                   |\n| OS-EXT-SRV-ATTR:host                 | -                                                     |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                     |\n| OS-EXT-SRV-ATTR:instance_name        |                                                       |\n| OS-EXT-STS:power_state               | 0                                                     |\n| OS-EXT-STS:task_state                | scheduling                                            |\n| OS-EXT-STS:vm_state                  | building                                              |\n| OS-SRV-USG:launched_at               | -                                                     |\n| OS-SRV-USG:terminated_at             | -                                                     |\n| accessIPv4                           |                                                       |\n| accessIPv6                           |                                                       |\n| config_drive                         |                                                       |\n| created                              | 2014-10-24T00:28:36Z                                  |\n| flavor                               | m1.small (0)                                          |\n| hostId                               |                                                       |\n| id                                   | 78d874ef-a9ec-4ede-9489-ff00903eb7fc                  |\n| image                                | MichaelDMmusic (020a18a4-1fc0-4e8d-9044-cad39c2805b8) |\n| key_name                             | -                                                     |\n| metadata                             | {}                                                    |\n| name                                 | MichaelDM_Enumerate.....                              |\n| os-extended-volumes:volumes_attached | []                                                    |\n| progress                             | 0                                                     |\n| security_groups                      | UofA-Windows-Access, default                          |\n| status                               | BUILD                                                 |\n| tenant_id                            | 7105f56ece3443ae8d6026f321d1a7a0                      |\n| updated                              | 2014-10-24T06:10:16Z                                  |\n| user_id                              | b1a4ab9db3e047afa1842f17a2528359                      |\n+--------------------------------------+-------------------------------------------------------+\n$", 
            "date_created": "2015-09-18 02:55:06.664877+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "Console output of an attempt to delete (not force-delete) this instance.\nNote request ID of DELETE operation below - req-1ca741c1-3e09-47c1-adef-26859a3547a7\n\n$ nova --debug delete 78d874ef-a9ec-4ede-9489-ff00903eb7fc\nDEBUG (session:195) REQ: curl -g -i -X GET https://keystone.rc.nectar.org.au:5000/v2.0/ -H \"Accept: application/json\" -H \"User-Agent: python-keystoneclient\"\nINFO (connectionpool:754) Starting new HTTPS connection (1): keystone.rc.nectar.org.au\nDEBUG (connectionpool:385) \"GET /v2.0/ HTTP/1.1\" 200 436\nDEBUG (session:224) RESP: [200] Date: Fri, 18 Sep 2015 02:55:45 GMT Vary: X-Auth-Token Content-Length: 436 Content-Type: application/json Connection: keep-alive \nRESP BODY: {\"version\": {\"status\": \"stable\", \"updated\": \"2014-04-17T00:00:00Z\", \"media-types\": [{\"base\": \"application/json\", \"type\": \"application/vnd.openstack.identity-v2.0+json\"}, {\"base\": \"application/xml\", \"type\": \"application/vnd.openstack.identity-v2.0+xml\"}], \"id\": \"v2.0\", \"links\": [{\"href\": \"https://keystone.rc.nectar.org.au:5000/v2.0/\", \"rel\": \"self\"}, {\"href\": \"http://docs.openstack.org/\", \"type\": \"text/html\", \"rel\": \"describedby\"}]}}\n\nDEBUG (v2:76) Making authentication request to https://keystone.rc.nectar.org.au:5000/v2.0/tokens\nDEBUG (connectionpool:385) \"POST /v2.0/tokens HTTP/1.1\" 200 11316\nDEBUG (iso8601:184) Parsed 2015-09-18T08:55:45Z into {'tz_sign': None, 'second_fraction': None, 'hour': u'08', 'daydash': u'18', 'tz_hour': None, 'month': None, 'timezone': u'Z', 'second': u'45', 'tz_minute': None, 'year': u'2015', 'separator': u'T', 'monthdash': u'09', 'day': None, 'minute': u'55'} with default timezone <iso8601.iso8601.Utc object at 0x7f2e88c71c90>\nDEBUG (iso8601:140) Got u'2015' for 'year' with default None\nDEBUG (iso8601:140) Got u'09' for 'monthdash' with default 1\nDEBUG (iso8601:140) Got 9 for 'month' with default 9\nDEBUG (iso8601:140) Got u'18' for 'daydash' with default 1\nDEBUG (iso8601:140) Got 18 for 'day' with default 18\nDEBUG (iso8601:140) Got u'08' for 'hour' with default None\nDEBUG (iso8601:140) Got u'55' for 'minute' with default None\nDEBUG (iso8601:140) Got u'45' for 'second' with default None\nDEBUG (session:195) REQ: curl -g -i -X GET https://nova.rc.nectar.org.au:8774/v1.1/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc -H \"User-Agent: python-novaclient\" -H \"Accept: application/json\" -H \"X-Auth-Token: {SHA1}d9a1566f66ae29098696f73c7b2f5656ec74a57d\"\nINFO (connectionpool:754) Starting new HTTPS connection (1): nova.rc.nectar.org.au\nDEBUG (connectionpool:385) \"GET /v1.1/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc HTTP/1.1\" 200 1412\nDEBUG (session:224) RESP: [200] Date: Fri, 18 Sep 2015 02:55:46 GMT Connection: keep-alive Content-Type: application/json Content-Length: 1412 X-Compute-Request-Id: req-e7d881ef-2c81-4181-a237-cc2b7a3cdc82 \nRESP BODY: {\"server\": {\"status\": \"BUILD\", \"updated\": \"2014-10-24T06:10:16Z\", \"hostId\": \"\", \"OS-EXT-SRV-ATTR:host\": null, \"addresses\": {}, \"links\": [{\"href\": \"http://nova.rc.nectar.org.au:8774/v1.1/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc\", \"rel\": \"self\"}, {\"href\": \"http://nova.rc.nectar.org.au:8774/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc\", \"rel\": \"bookmark\"}], \"key_name\": null, \"image\": {\"id\": \"020a18a4-1fc0-4e8d-9044-cad39c2805b8\", \"links\": [{\"href\": \"http://nova.rc.nectar.org.au:8774/1/images/020a18a4-1fc0-4e8d-9044-cad39c2805b8\", \"rel\": \"bookmark\"}]}, \"OS-EXT-STS:task_state\": \"scheduling\", \"OS-EXT-STS:vm_state\": \"building\", \"OS-EXT-SRV-ATTR:instance_name\": \"\", \"OS-SRV-USG:launched_at\": null, \"OS-EXT-SRV-ATTR:hypervisor_hostname\": null, \"flavor\": {\"id\": \"0\", \"links\": [{\"href\": \"http://nova.rc.nectar.org.au:8774/1/flavors/0\", \"rel\": \"bookmark\"}]}, \"id\": \"78d874ef-a9ec-4ede-9489-ff00903eb7fc\", \"security_groups\": [{\"name\": \"default\"}, {\"name\": \"UofA-Windows-Access\"}], \"OS-SRV-USG:terminated_at\": null, \"OS-EXT-AZ:availability_zone\": \"NCI\", \"user_id\": \"b1a4ab9db3e047afa1842f17a2528359\", \"name\": \"MichaelDM_Enumerate.....\", \"created\": \"2014-10-24T00:28:36Z\", \"tenant_id\": \"7105f56ece3443ae8d6026f321d1a7a0\", \"OS-DCF:diskConfig\": \"AUTO\", \"os-extended-volumes:volumes_attached\": [], \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"progress\": 0, \"OS-EXT-STS:power_state\": 0, \"config_drive\": \"\", \"metadata\": {}}}\n\nDEBUG (iso8601:184) Parsed 2015-09-18T08:55:45Z into {'tz_sign': None, 'second_fraction': None, 'hour': u'08', 'daydash': u'18', 'tz_hour': None, 'month': None, 'timezone': u'Z', 'second': u'45', 'tz_minute': None, 'year': u'2015', 'separator': u'T', 'monthdash': u'09', 'day': None, 'minute': u'55'} with default timezone <iso8601.iso8601.Utc object at 0x7f2e88c71c90>\nDEBUG (iso8601:140) Got u'2015' for 'year' with default None\nDEBUG (iso8601:140) Got u'09' for 'monthdash' with default 1\nDEBUG (iso8601:140) Got 9 for 'month' with default 9\nDEBUG (iso8601:140) Got u'18' for 'daydash' with default 1\nDEBUG (iso8601:140) Got 18 for 'day' with default 18\nDEBUG (iso8601:140) Got u'08' for 'hour' with default None\nDEBUG (iso8601:140) Got u'55' for 'minute' with default None\nDEBUG (iso8601:140) Got u'45' for 'second' with default None\nDEBUG (iso8601:184) Parsed 2015-09-18T08:55:45Z into {'tz_sign': None, 'second_fraction': None, 'hour': u'08', 'daydash': u'18', 'tz_hour': None, 'month': None, 'timezone': u'Z', 'second': u'45', 'tz_minute': None, 'year': u'2015', 'separator': u'T', 'monthdash': u'09', 'day': None, 'minute': u'55'} with default timezone <iso8601.iso8601.Utc object at 0x7f2e88c71c90>\nDEBUG (iso8601:140) Got u'2015' for 'year' with default None\nDEBUG (iso8601:140) Got u'09' for 'monthdash' with default 1\nDEBUG (iso8601:140) Got 9 for 'month' with default 9\nDEBUG (iso8601:140) Got u'18' for 'daydash' with default 1\nDEBUG (iso8601:140) Got 18 for 'day' with default 18\nDEBUG (iso8601:140) Got u'08' for 'hour' with default None\nDEBUG (iso8601:140) Got u'55' for 'minute' with default None\nDEBUG (iso8601:140) Got u'45' for 'second' with default None\nDEBUG (session:195) REQ: curl -g -i -X DELETE https://nova.rc.nectar.org.au:8774/v1.1/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc -H \"User-Agent: python-novaclient\" -H \"Accept: application/json\" -H \"X-Auth-Token: {SHA1}d9a1566f66ae29098696f73c7b2f5656ec74a57d\"\nDEBUG (connectionpool:385) \"DELETE /v1.1/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc HTTP/1.1\" 500 128\nDEBUG (session:224) RESP:\nThe server has either erred or is incapable of performing the requested operation. (HTTP 500) (Request-ID: req-1ca741c1-3e09-47c1-adef-26859a3547a7)\nDEBUG (shell:914) Unable to delete the specified server(s).\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/dist-packages/novaclient/shell.py\", line 911, in main\n    OpenStackComputeShell().main(argv)\n  File \"/usr/lib/python2.7/dist-packages/novaclient/shell.py\", line 838, in main\n    args.func(self.cs, args)\n  File \"/usr/lib/python2.7/dist-packages/novaclient/v2/shell.py\", line 1884, in do_delete\n    _(\"Unable to delete the specified server(s).\"))\n  File \"/usr/lib/python2.7/dist-packages/novaclient/utils.py\", line 313, in do_action_on_many\n    raise exceptions.CommandError(error_msg)\nCommandError: Unable to delete the specified server(s).\nERROR (CommandError): Unable to delete the specified server(s).\n$", 
            "date_created": "2015-09-18 03:02:08.184180+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "Details of nova-cells package:\n\n# dpkg -p nova-cells\nPackage: nova-cells\nPriority: extra\nSection: net\nInstalled-Size: 82\nMaintainer: Ubuntu Developers <email address hidden>\nArchitecture: all\nSource: nova\nVersion: 1:2015.1.1+a65~g4c3ea46+trusty-6\nDepends: nova-common (= 1:2015.1.1+a65~g4c3ea46+trusty-6), init-system-helpers (>= 1.13~), sysv-rc (>= 2.88dsf-24) | file-rc (>= 0.8.16), python:any\nSize: 26358\nDescription: Openstack Compute - cells\n OpenStack is a reliable cloud infrastructure. Its mission is to produce\n the ubiquitous cloud computing platform that will meet the needs of public\n and private cloud providers regardless of size, by being simple to implement\n and massively scalable.\n .\n OpenStack Compute, codenamed Nova, is a cloud computing fabric controller. In\n addition to its \"native\" API (the OpenStack API), it also supports the Amazon\n EC2 API.\n .\n Nova is intended to be modular and easy to extend and adapt. It supports many\n different hypervisors (KVM and Xen to name a few), different database backends\n (SQLite, MySQL, and PostgreSQL, for instance), different types of user\n databases (LDAP or SQL), etc.\n .\n This is the Nova cells component.\nHomepage: http://launchpad.net/nova\nOriginal-Maintainer: Openstack Maintainers <email address hidden>\n#", 
            "date_created": "2015-09-18 03:04:51.058554+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "Console output of attempt to force-delete this instance.\nI cannot see any occurrences of the request ID req-898fd34a-1e86-4016-9f0b-2a8f98b74bd5 in any of the log files.\n\n$ nova --debug force-delete 78d874ef-a9ec-4ede-9489-ff00903eb7fc\nDEBUG (session:195) REQ: curl -g -i -X GET https://keystone.rc.nectar.org.au:5000/v2.0/ -H \"Accept: application/json\" -H \"User-Agent: python-keystoneclient\"\nINFO (connectionpool:754) Starting new HTTPS connection (1): keystone.rc.nectar.org.au\nDEBUG (connectionpool:385) \"GET /v2.0/ HTTP/1.1\" 200 436\nDEBUG (session:224) RESP: [200] Date: Fri, 18 Sep 2015 04:36:05 GMT Vary: X-Auth-Token Content-Length: 436 Content-Type: application/json Connection: keep-alive \nRESP BODY: {\"version\": {\"status\": \"stable\", \"updated\": \"2014-04-17T00:00:00Z\", \"media-types\": [{\"base\": \"application/json\", \"type\": \"application/vnd.openstack.identity-v2.0+json\"}, {\"base\": \"application/xml\", \"type\": \"application/vnd.openstack.identity-v2.0+xml\"}], \"id\": \"v2.0\", \"links\": [{\"href\": \"https://keystone.rc.nectar.org.au:5000/v2.0/\", \"rel\": \"self\"}, {\"href\": \"http://docs.openstack.org/\", \"type\": \"text/html\", \"rel\": \"describedby\"}]}}\n\nDEBUG (v2:76) Making authentication request to https://keystone.rc.nectar.org.au:5000/v2.0/tokens\nDEBUG (connectionpool:385) \"POST /v2.0/tokens HTTP/1.1\" 200 11316\nDEBUG (iso8601:184) Parsed 2015-09-18T10:36:06Z into {'tz_sign': None, 'second_fraction': None, 'hour': u'10', 'daydash': u'18', 'tz_hour': None, 'month': None, 'timezone': u'Z', 'second': u'06', 'tz_minute': None, 'year': u'2015', 'separator': u'T', 'monthdash': u'09', 'day': None, 'minute': u'36'} with default timezone <iso8601.iso8601.Utc object at 0x7fba6c577c90>\nDEBUG (iso8601:140) Got u'2015' for 'year' with default None\nDEBUG (iso8601:140) Got u'09' for 'monthdash' with default 1\nDEBUG (iso8601:140) Got 9 for 'month' with default 9\nDEBUG (iso8601:140) Got u'18' for 'daydash' with default 1\nDEBUG (iso8601:140) Got 18 for 'day' with default 18\nDEBUG (iso8601:140) Got u'10' for 'hour' with default None\nDEBUG (iso8601:140) Got u'36' for 'minute' with default None\nDEBUG (iso8601:140) Got u'06' for 'second' with default None\nDEBUG (session:195) REQ: curl -g -i -X GET https://nova.rc.nectar.org.au:8774/v1.1/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc -H \"User-Agent: python-novaclient\" -H \"Accept: application/json\" -H \"X-Auth-Token: {SHA1}2306cd730f8cc6278661545a24f220dc96f886d9\"\nINFO (connectionpool:754) Starting new HTTPS connection (1): nova.rc.nectar.org.au\nDEBUG (connectionpool:385) \"GET /v1.1/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc HTTP/1.1\" 200 1412\nDEBUG (session:224) RESP: [200] Date: Fri, 18 Sep 2015 04:36:06 GMT Connection: keep-alive Content-Type: application/json Content-Length: 1412 X-Compute-Request-Id: req-959e80df-a9e5-439c-98ef-6baf998e96c6 \nRESP BODY: {\"server\": {\"status\": \"BUILD\", \"updated\": \"2014-10-24T06:10:16Z\", \"hostId\": \"\", \"OS-EXT-SRV-ATTR:host\": null, \"addresses\": {}, \"links\": [{\"href\": \"http://nova.rc.nectar.org.au:8774/v1.1/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc\", \"rel\": \"self\"}, {\"href\": \"http://nova.rc.nectar.org.au:8774/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc\", \"rel\": \"bookmark\"}], \"key_name\": null, \"image\": {\"id\": \"020a18a4-1fc0-4e8d-9044-cad39c2805b8\", \"links\": [{\"href\": \"http://nova.rc.nectar.org.au:8774/1/images/020a18a4-1fc0-4e8d-9044-cad39c2805b8\", \"rel\": \"bookmark\"}]}, \"OS-EXT-STS:task_state\": \"scheduling\", \"OS-EXT-STS:vm_state\": \"building\", \"OS-EXT-SRV-ATTR:instance_name\": \"\", \"OS-SRV-USG:launched_at\": null, \"OS-EXT-SRV-ATTR:hypervisor_hostname\": null, \"flavor\": {\"id\": \"0\", \"links\": [{\"href\": \"http://nova.rc.nectar.org.au:8774/1/flavors/0\", \"rel\": \"bookmark\"}]}, \"id\": \"78d874ef-a9ec-4ede-9489-ff00903eb7fc\", \"security_groups\": [{\"name\": \"default\"}, {\"name\": \"UofA-Windows-Access\"}], \"OS-SRV-USG:terminated_at\": null, \"OS-EXT-AZ:availability_zone\": \"NCI\", \"user_id\": \"b1a4ab9db3e047afa1842f17a2528359\", \"name\": \"MichaelDM_Enumerate.....\", \"created\": \"2014-10-24T00:28:36Z\", \"tenant_id\": \"7105f56ece3443ae8d6026f321d1a7a0\", \"OS-DCF:diskConfig\": \"AUTO\", \"os-extended-volumes:volumes_attached\": [], \"accessIPv4\": \"\", \"accessIPv6\": \"\", \"progress\": 0, \"OS-EXT-STS:power_state\": 0, \"config_drive\": \"\", \"metadata\": {}}}\n\nDEBUG (iso8601:184) Parsed 2015-09-18T10:36:06Z into {'tz_sign': None, 'second_fraction': None, 'hour': u'10', 'daydash': u'18', 'tz_hour': None, 'month': None, 'timezone': u'Z', 'second': u'06', 'tz_minute': None, 'year': u'2015', 'separator': u'T', 'monthdash': u'09', 'day': None, 'minute': u'36'} with default timezone <iso8601.iso8601.Utc object at 0x7fba6c577c90>\nDEBUG (iso8601:140) Got u'2015' for 'year' with default None\nDEBUG (iso8601:140) Got u'09' for 'monthdash' with default 1\nDEBUG (iso8601:140) Got 9 for 'month' with default 9\nDEBUG (iso8601:140) Got u'18' for 'daydash' with default 1\nDEBUG (iso8601:140) Got 18 for 'day' with default 18\nDEBUG (iso8601:140) Got u'10' for 'hour' with default None\nDEBUG (iso8601:140) Got u'36' for 'minute' with default None\nDEBUG (iso8601:140) Got u'06' for 'second' with default None\nDEBUG (iso8601:184) Parsed 2015-09-18T10:36:06Z into {'tz_sign': None, 'second_fraction': None, 'hour': u'10', 'daydash': u'18', 'tz_hour': None, 'month': None, 'timezone': u'Z', 'second': u'06', 'tz_minute': None, 'year': u'2015', 'separator': u'T', 'monthdash': u'09', 'day': None, 'minute': u'36'} with default timezone <iso8601.iso8601.Utc object at 0x7fba6c577c90>\nDEBUG (iso8601:140) Got u'2015' for 'year' with default None\nDEBUG (iso8601:140) Got u'09' for 'monthdash' with default 1\nDEBUG (iso8601:140) Got 9 for 'month' with default 9\nDEBUG (iso8601:140) Got u'18' for 'daydash' with default 1\nDEBUG (iso8601:140) Got 18 for 'day' with default 18\nDEBUG (iso8601:140) Got u'10' for 'hour' with default None\nDEBUG (iso8601:140) Got u'36' for 'minute' with default None\nDEBUG (iso8601:140) Got u'06' for 'second' with default None\nDEBUG (session:195) REQ: curl -g -i -X POST https://nova.rc.nectar.org.au:8774/v1.1/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc/action -H \"User-Agent: python-novaclient\" -H \"Content-Type: application/json\" -H \"Accept: application/json\" -H \"X-Auth-Token: {SHA1}2306cd730f8cc6278661545a24f220dc96f886d9\" -d '{\"forceDelete\": null}'\nDEBUG (connectionpool:385) \"POST /v1.1/1/servers/78d874ef-a9ec-4ede-9489-ff00903eb7fc/action HTTP/1.1\" 404 78\nDEBUG (session:224) RESP:\nDEBUG (shell:914) The resource could not be found. (HTTP 404) (Request-ID: req-898fd34a-1e86-4016-9f0b-2a8f98b74bd5)\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/dist-packages/novaclient/shell.py\", line 911, in main\n    OpenStackComputeShell().main(argv)\n  File \"/usr/lib/python2.7/dist-packages/novaclient/shell.py\", line 838, in main\n    args.func(self.cs, args)\n  File \"/usr/lib/python2.7/dist-packages/novaclient/v2/contrib/deferred_delete.py\", line 22, in do_force_delete\n    utils.find_resource(cs.servers, args.server).force_delete()\n  File \"/usr/lib/python2.7/dist-packages/novaclient/v2/servers.py\", line 152, in force_delete\n    self.manager.force_delete(self)\n  File \"/usr/lib/python2.7/dist-packages/novaclient/v2/servers.py\", line 725, in force_delete\n    return self._action('forceDelete', server, None)\n  File \"/usr/lib/python2.7/dist-packages/novaclient/v2/servers.py\", line 1238, in _action\n    return self.api.client.post(url, body=body)\n  File \"/usr/lib/python2.7/dist-packages/keystoneclient/adapter.py\", line 176, in post\n    return self.request(url, 'POST', **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/novaclient/client.py\", line 96, in request\n    raise exceptions.from_response(resp, body, url, method)\nNotFound: The resource could not be found. (HTTP 404) (Request-ID: req-898fd34a-1e86-4016-9f0b-2a8f98b74bd5)\nERROR (NotFound): The resource could not be found. (HTTP 404) (Request-ID: req-898fd34a-1e86-4016-9f0b-2a8f98b74bd5)\n$ \n", 
            "date_created": "2015-09-18 04:37:43.447917+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "There are no records for this instance in either instances or instance_extra, but there is a record in instance_id_mappings:\n\nMariaDB [nova]> select * from instances where uuid='78d874ef-a9ec-4ede-9489-ff00903eb7fc';\nEmpty set (0.00 sec)\n\nMariaDB [nova]> select * from instance_extra where instance_uuid='78d874ef-a9ec-4ede-9489-ff00903eb7fc';\nEmpty set (0.00 sec)\n\nMariaDB [nova]> select * from instance_id_mappings where uuid='78d874ef-a9ec-4ede-9489-ff00903eb7fc';\n+---------------------+------------+------------+---------+--------------------------------------+---------+\n| created_at          | updated_at | deleted_at | id      | uuid                                 | deleted |\n+---------------------+------------+------------+---------+--------------------------------------+---------+\n| 2014-10-24 00:29:38 | NULL       | NULL       | 1247046 | 78d874ef-a9ec-4ede-9489-ff00903eb7fc |       0 |\n+---------------------+------------+------------+---------+--------------------------------------+---------+\n1 row in set (0.00 sec)\n\nMariaDB [nova]>", 
            "date_created": "2015-09-18 04:40:58.188796+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "The previous DB query was run on the child cell's Nova schema.\nLooking at the Nova schema at the top-level cell, things are different:\n\nMariaDB [nova]> select * from instances where uuid='78d874ef-a9ec-4ede-9489-ff00903eb7fc';\n+---------------------+---------------------+------------+---------+-------------+----------------------------------+----------------------------------+--------------------------------------+-----------+------------+--------------+----------+----------+-------------+----------+-----------+-------+----------------------+------+-----------+----------------+--------------+-------------+---------------+--------------------------+----------------------+-------------------+--------+---------+-------------+------------------+---------+--------------------------------------+--------------+------------------+--------------+--------------+--------------+------------+--------------------------+---------------------+----------+------------------+--------------------+-------------------+---------+--------------+-----------+------+---------+-----------+---------+--------------------+\n| created_at          | updated_at          | deleted_at | id      | internal_id | user_id                          | project_id                       | image_ref                            | kernel_id | ramdisk_id | launch_index | key_name | key_data | power_state | vm_state | memory_mb | vcpus | hostname             | host | user_data | reservation_id | scheduled_at | launched_at | terminated_at | display_name             | display_description  | availability_zone | locked | os_type | launched_on | instance_type_id | vm_mode | uuid                                 | architecture | root_device_name | access_ip_v4 | access_ip_v6 | config_drive | task_state | default_ephemeral_device | default_swap_device | progress | auto_disk_config | shutdown_terminate | disable_terminate | root_gb | ephemeral_gb | cell_name | node | deleted | locked_by | cleaned | ephemeral_key_uuid |\n+---------------------+---------------------+------------+---------+-------------+----------------------------------+----------------------------------+--------------------------------------+-----------+------------+--------------+----------+----------+-------------+----------+-----------+-------+----------------------+------+-----------+----------------+--------------+-------------+---------------+--------------------------+----------------------+-------------------+--------+---------+-------------+------------------+---------+--------------------------------------+--------------+------------------+--------------+--------------+--------------+------------+--------------------------+---------------------+----------+------------------+--------------------+-------------------+---------+--------------+-----------+------+---------+-----------+---------+--------------------+\n| 2014-10-24 00:28:36 | 2014-10-24 06:10:16 | NULL       | 1299828 |        NULL | b1a4ab9db3e047afa1842f17a2528359 | 7105f56ece3443ae8d6026f321d1a7a0 | 020a18a4-1fc0-4e8d-9044-cad39c2805b8 |           |            |            0 | NULL     | NULL     |           0 | building |      4096 |     1 | michaeldm-enumerate5 | NULL | NULL      | r-tatb327i     | NULL         | NULL        | NULL          | MichaelDM_Enumerate..... | MichaelDM_Enumerate5 | NCI               |      0 | NULL    | NULL        |                7 | NULL    | 78d874ef-a9ec-4ede-9489-ff00903eb7fc | NULL         | /dev/vda         | NULL         | NULL         |              | scheduling | NULL                     | NULL                |        0 |                1 |                  0 |                 0 |      10 |           30 | NULL      | NULL |       0 | NULL      |       0 | NULL               |\n+---------------------+---------------------+------------+---------+-------------+----------------------------------+----------------------------------+--------------------------------------+-----------+------------+--------------+----------+----------+-------------+----------+-----------+-------+----------------------+------+-----------+----------------+--------------+-------------+---------------+--------------------------+----------------------+-------------------+--------+---------+-------------+------------------+---------+--------------------------------------+--------------+------------------+--------------+--------------+--------------+------------+--------------------------+---------------------+----------+------------------+--------------------+-------------------+---------+--------------+-----------+------+---------+-----------+---------+--------------------+\n1 row in set (0.00 sec)\n\nMariaDB [nova]> select * from instance_id_mappings where uuid='78d874ef-a9ec-4ede-9489-ff00903eb7fc';\n+---------------------+------------+------------+---------+--------------------------------------+---------+\n| created_at          | updated_at | deleted_at | id      | uuid                                 | deleted |\n+---------------------+------------+------------+---------+--------------------------------------+---------+\n| 2014-10-24 00:28:36 | NULL       | NULL       | 1247046 | 78d874ef-a9ec-4ede-9489-ff00903eb7fc |       0 |\n+---------------------+------------+------------+---------+--------------------------------------+---------+\n1 row in set (0.00 sec)\n\nMariaDB [nova]>", 
            "date_created": "2015-09-21 03:27:38.273054+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "I suspect that manually re-inserting a row into the child cell's instances table might permit 'nova delete' or 'nova force-delete' to clean up these data. But rather than trying to work around this, I'm happy to leave it broken in order to investigate a fix a bit more, at least for now.", 
            "date_created": "2015-09-21 03:30:20.635733+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "Do you have a stack trace of the foreign key constraint failure in the nova logs when the delete fails there?", 
            "date_created": "2015-09-24 17:22:43.270147+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Nevermind comment 8, I guess that's the attachment in comment 2.  Is that the parent cell or the child cell?", 
            "date_created": "2015-09-24 17:24:53.318136+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "https://launchpadlibrarian.net/218238506/nova-cells.log shows the fkey failure is between the instances and instance_extra table.  The instance_id_mappings table shouldn't have anything to do with this, it doesn't have a fkey to any other table:\n\nhttps://github.com/openstack/nova/blob/stable/kilo/nova/db/sqlalchemy/models.py#L1313\n\nAlso, are the parent and child cells both running the same level of code (kilo in this case?).", 
            "date_created": "2015-09-24 17:29:13.298589+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "It sounds like bug 1462128 could be related here, but that would be to prevent the failed delete in the first place so you don't get into this state.  That was fixed in liberty but probably could be backported to stable/kilo.  For now you might just have to do some manual db purging to clean this up.", 
            "date_created": "2015-09-24 17:36:57.429234+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Here is the kilo backport of the fix for bug 1462128: https://review.openstack.org/#/c/227451/", 
            "date_created": "2015-09-24 18:48:47.380546+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "The attachment in comment 2 is from the child cell. Both child and parent cells are running Kilo nova. The upgrade of the other components is ongoing.", 
            "date_created": "2015-09-25 00:37:45.688112+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "Yep, I think I'll need to clean these records up manually. But I help off on doing that, because didn't want to destroy any data that could be useful for debugging, at least not until I'd posted some of it here. In any case, I'll back up the DBs involved before I manually modify any data.\n\nI have some misgivings about the handling of the similar foreign-key violation in the linked bug #1462128. The change there causes an attempt to violate a foreign key constraint to get turned into a claim that an instance doesn't exist. But I'd have thought that the attempt to violate the foreign key is a bug, either in the schema or in the Python code. So the client should see a 500 Internal Server Error explaining that the server is broken (which it is, in this circumstance), rather than a 404 claiming that some instance or other doesn't exist. The only correct 'handling' for this case is thinking and debugging, and status 500 indicates that fact more accurately than 404.", 
            "date_created": "2015-09-25 00:59:55.868837+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/228660", 
            "date_created": "2015-09-28 23:13:15.481071+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/228660\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=881488c5d5d9d52cf0b38c35cb929cffa0bcd70d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 881488c5d5d9d52cf0b38c35cb929cffa0bcd70d\nAuthor: melanie witt <email address hidden>\nDate:   Mon Sep 28 20:22:37 2015 +0000\n\n    Check DBReferenceError foreign key in Instance.save\n    \n    In commit 5f869d0c04271d4fa058843eebe56e0bd524b12b handling of\n    DBReferenceError from oslo.db was added to raise InstanceNotFound.\n    However, if the target row has foreign key constraints to other\n    tables, the DBReferenceError raised doesn't necessarily imply that\n    the instance row is missing.\n    \n    This change adds a check on the key attribute in the DBReferenceError\n    exception object and raises InstanceNotFound only if the key is\n    'instance_uuid' -- otherwise, it reraises DBReferenceError.\n    \n    Related-Bug: #1462128\n    Related-Bug: #1497076\n    \n    Change-Id: I131dbc27639626e89735ac0591dc266f35e6ac80\n", 
            "date_created": "2015-10-06 00:27:57.978265+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The approach taken in 881488c5d5d9d52cf0b38c35cb929cffa0bcd70d looks good to me, assuming that the DBReferenceError will result in an HTTP 500 status. I can't think of anything better Nova can do in this situation.", 
            "date_created": "2015-10-09 05:58:52.645904+00:00", 
            "author": "https://api.launchpad.net/1.0/~mattsanu"
        }, 
        {
            "content": "Based on comment #17 and feedback from Melanie Witt on IRC today I guess it's sane to say this bug can be considered as fixed. Reopen and provide a reasoning if you disagree.", 
            "date_created": "2015-12-02 17:46:08.060225+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }
    ], 
    "closed": "2015-12-03 21:36:50.762108+00:00"
}