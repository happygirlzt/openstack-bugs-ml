{
    "status": "Confirmed", 
    "last_updated": "2016-03-24 19:29:19.992773+00:00", 
    "description": "Discovered with the experimental libvirt-lxc tempest gate job initially, but pared down to an easier test using Devstack and a node like that which is used in our CI for devstack-gate tests. Here's an etherpad with many details: https://etherpad.openstack.org/p/lxc_driver_devstack_gate.\n\nThe gist of it is there appears to be a bug where trying to hard reboot a libvirtLXC instance in nova, when using LVM storage backend, when nova goes to try and mount the LV, and it will sometimes fail with:\n\n```\nTraceback (most recent call last):\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 138, in _dispatch_and_reply\n\u00a0\u00a0\u00a0\u00a0incoming.message))\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 183, in _dispatch\n\u00a0\u00a0\u00a0\u00a0return self._do_dispatch(endpoint, method, ctxt, args)\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 127, in _do_dispatch\n\u00a0\u00a0\u00a0\u00a0result = func(ctxt, **new_args)\n\u00a0\u00a0File \"/opt/stack/nova/nova/exception.py\", line 110, in wrapped\n\u00a0\u00a0\u00a0\u00a0payload)\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n\u00a0\u00a0\u00a0\u00a0self.force_reraise()\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n\u00a0\u00a0\u00a0\u00a0six.reraise(self.type_, self.value, self.tb)\n\u00a0\u00a0File \"/opt/stack/nova/nova/exception.py\", line 89, in wrapped\n\u00a0\u00a0\u00a0\u00a0return f(self, context, *args, **kw)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 359, in decorated_function\n\u00a0\u00a0\u00a0\u00a0LOG.warning(msg, e, instance=instance)\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n\u00a0\u00a0\u00a0\u00a0self.force_reraise()\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n\u00a0\u00a0\u00a0\u00a0six.reraise(self.type_, self.value, self.tb)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 328, in decorated_function\n\u00a0\u00a0\u00a0\u00a0return function(self, context, *args, **kwargs)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 409, in decorated_function\n\u00a0\u00a0\u00a0\u00a0return function(self, context, *args, **kwargs)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 387, in decorated_function\n\u00a0\u00a0\u00a0\u00a0kwargs['instance'], e, sys.exc_info())\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n\u00a0\u00a0\u00a0\u00a0self.force_reraise()\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n\u00a0\u00a0\u00a0\u00a0six.reraise(self.type_, self.value, self.tb)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 375, in decorated_function\n\u00a0\u00a0\u00a0\u00a0return function(self, context, *args, **kwargs)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 3061, in reboot_instance\n\u00a0\u00a0\u00a0\u00a0self._set_instance_obj_error_state(context, instance)\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n\u00a0\u00a0\u00a0\u00a0self.force_reraise()\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n\u00a0\u00a0\u00a0\u00a0six.reraise(self.type_, self.value, self.tb)\n\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 3042, in reboot_instance\n\u00a0\u00a0\u00a0\u00a0bad_volumes_callback=bad_volumes_callback)\n\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2404, in reboot\n\u00a0\u00a0\u00a0\u00a0block_device_info)\n\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2501, in _hard_reboot\n\u00a0\u00a0\u00a0\u00a0vifs_already_plugged=True)\n\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4904, in _create_domain_and_network\n\u00a0\u00a0\u00a0\u00a0block_device_info, disk_info):\n\u00a0\u00a0File \"/usr/lib/python2.7/contextlib.py\", line 17, in __enter__\n\u00a0\u00a0\u00a0\u00a0return self.gen.next()\n\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4814, in _lxc_disk_handler\n\u00a0\u00a0\u00a0\u00a0block_device_info, disk_info)\n\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4764, in _create_domain_setup_lxc\n\u00a0\u00a0\u00a0\u00a0container_dir=container_dir)\n\u00a0\u00a0File \"/opt/stack/nova/nova/virt/disk/api.py\", line 428, in setup_container\n\u00a0\u00a0\u00a0\u00a0raise exception.NovaException(img.errors)\nNovaException:\n--\nFailed to mount filesystem: Unexpected error while running command.\nCommand: sudo nova-rootwrap /etc/nova/rootwrap.conf mount /dev/stack-volumes-default/692321ba-dd42-4c31-84af-10ca2f10324d_disk /opt/stack/data/nova/instances/692321ba-dd42-4c31-84af-10ca2f10324d/rootfs\nExit code: 32\nStdout: u''\nStderr: u'mount: /dev/mapper/stack--volumes--default-692321ba--dd42--4c31--84af--10ca2f10324d_disk already mounted or /opt/stack/data/nova/instances/692321ba-dd42-4c31-84af-10ca2f10324d/rootfs busy\\n'\n```\n\nI can recreate this fairly consistently in devstack using the same form factor as nodes in our CI devstack-gate:\n\nlocal.conf:\n```\n[[local|localrc]]\nLIBVIRT_TYPE=lxc\nNOVA_BACKEND=LVM\n```\n\n```\n$ ./stack.sh\n```\n...\n\n```\n$ source openrc\n$ for i in `seq 1 1 10`; do ( nova boot --image \"cirros-0.3.4-x86_64-rootfs\" --flavor 42 test$i & ); done\n$ for i in `seq 1 1 10`; do ( nova reboot --hard test$i & ); done\n```\n\nAfter doing so, some of the instances should go into ERROR with the Traceback above in the compute log. The volume of instances is meant to perturb the issue more reliably. This doesn't always happen, however it has happened several times when I've just spun up one instance and tried.\n\nI am running HEAD in Devstack when I see this problem.\n\nNote: On this set up, nova's soft reboot is falling through to hard reboot, I believe due to this bug: https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1536280.", 
    "tags": [
        "lxc"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1552740", 
    "owner": "None", 
    "id": 1552740, 
    "index": 4471, 
    "openned": "2016-03-03 14:54:50.087685+00:00", 
    "created": "2016-03-03 14:54:50.087685+00:00", 
    "title": "Nova hard reboot fails to mount logical volume (LVM + libvirt-lxc)", 
    "comments": [
        {
            "content": "Discovered with the experimental libvirt-lxc tempest gate job initially, but pared down to an easier test using Devstack and a node like that which is used in our CI for devstack-gate tests. Here's an etherpad with many details: https://etherpad.openstack.org/p/lxc_driver_devstack_gate.\n\nThe gist of it is there appears to be a bug where trying to hard reboot a libvirtLXC instance in nova, when using LVM storage backend, when nova goes to try and mount the LV, and it will sometimes fail with: \n\n```\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 138, in _dispatch_and_reply\n    incoming.message))\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 183, in _dispatch\n    return self._do_dispatch(endpoint, method, ctxt, args)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 127, in _do_dispatch\n    result = func(ctxt, **new_args)\n  File \"/opt/stack/nova/nova/exception.py\", line 110, in wrapped\n    payload)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/exception.py\", line 89, in wrapped\n    return f(self, context, *args, **kw)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 359, in decorated_function\n    LOG.warning(msg, e, instance=instance)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 328, in decorated_function\n    return function(self, context, *args, **kwargs)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 409, in decorated_function\n    return function(self, context, *args, **kwargs)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 387, in decorated_function\n    kwargs['instance'], e, sys.exc_info())\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 375, in decorated_function\n    return function(self, context, *args, **kwargs)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 3061, in reboot_instance\n    self._set_instance_obj_error_state(context, instance)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n    self.force_reraise()\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 3042, in reboot_instance\n    bad_volumes_callback=bad_volumes_callback)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2404, in reboot\n    block_device_info)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2501, in _hard_reboot\n    vifs_already_plugged=True)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4904, in _create_domain_and_network\n    block_device_info, disk_info):\n  File \"/usr/lib/python2.7/contextlib.py\", line 17, in __enter__\n    return self.gen.next()\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4814, in _lxc_disk_handler\n    block_device_info, disk_info)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4764, in _create_domain_setup_lxc\n    container_dir=container_dir)\n  File \"/opt/stack/nova/nova/virt/disk/api.py\", line 428, in setup_container\n    raise exception.NovaException(img.errors)\nNovaException:\n--\nFailed to mount filesystem: Unexpected error while running command.\nCommand: sudo nova-rootwrap /etc/nova/rootwrap.conf mount /dev/stack-volumes-default/692321ba-dd42-4c31-84af-10ca2f10324d_disk /opt/stack/data/nova/instances/692321ba-dd42-4c31-84af-10ca2f10324d/rootfs\nExit code: 32\nStdout: u''\nStderr: u'mount: /dev/mapper/stack--volumes--default-692321ba--dd42--4c31--84af--10ca2f10324d_disk already mounted or /opt/stack/data/nova/instances/692321ba-dd42-4c31-84af-10ca2f10324d/rootfs busy\\n'\n```\n\nI can recreate this fairly consistently in devstack using the same form factor as nodes in our CI devstack-gate:\n\nlocal.conf:\n```\n[[local|localrc]]\nLIBVIRT_TYPE=lxc\nNOVA_BACKEND=LVM\n```\n\n```\n$ ./stack.sh\n```\n...\n\n```\n$ source openrc\n$ for i in `seq 1 1 10`; do ( nova boot --image \"cirros-0.3.4-x86_64-rootfs\" --flavor 42 test$i & ); done\n$ for i in `seq 1 1 10`; do ( nova reboot test$i & ); done\n```\n\nAfter doing so, some of the instances should go into ERROR with the Traceback above in the compute log. The volume of instances is meant to perturb the issue more reliably. This doesn't always happen, however it has happened several times when I've just spun up one instance and tried.\n\nI am running HEAD in Devstack when I see this problem.\n\nSome nuances:\n\n1. On this set up, nova reboot is falling through to hard reboot, I believe due to this bug: https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1536280.\n2.", 
            "date_created": "2016-03-03 14:54:50.087685+00:00", 
            "author": "https://api.launchpad.net/1.0/~thomas-maddox"
        }
    ]
}