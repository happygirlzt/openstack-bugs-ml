{
    "status": "Confirmed", 
    "last_updated": "2017-07-28 13:16:05.861209+00:00", 
    "description": "Description\n===========\n\nCurrently\uff0c the compute manager does not update the instance_info_caches of the instance again after the instance spawning successfully. so the status of port is also down in this time. Depending on the period task _heal_instance_info_cache to synchronize the port status. If the instances in the host are many, maybe the time for synchronizing the status of port is long. If evacuate operation is triggered for the instance\uff0c the network-vif-plugged event will send to the source host, then the new instance will spawn failed in destination host because of waiting for network-vif-plugged event timeout. The probability of this question is big relatively.\n\nSteps to reproduce\n==================\n\n1. Booting 5 or more instance in one host.\n2. After instances were spawning successfully\uff0c power off the host at once.\n3. Then evacuate the instance in this host.\n4. execute 'nova migration-list' to search failed records\n\nExpected result\n===============\ninstances will be evacuated successfully.\n\nActual result\n=============\nSome instance will be evacuated failed because of waiting for network-vif-plugged event timeout.", 
    "tags": [
        "evacuate", 
        "neutron", 
        "nova"
    ], 
    "importance": "Low", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1652735", 
    "owner": "None", 
    "id": 1652735, 
    "index": 2140, 
    "openned": "2016-12-27 08:02:31.561452+00:00", 
    "created": "2016-12-27 08:02:31.561452+00:00", 
    "title": "evacuate fails because port synchronization takes a long time", 
    "comments": [
        {
            "content": "Description\n===========\n\nCurrently\uff0c the compute manager does not update the instance_info_caches of the instance again after the instance spawning successfully. so the status of port is also down in this time. Depending on the period task _heal_instance_info_cache to synchronize the port status. If the instances in the host are many, maybe the time for synchronizing the status of port is long. If evacuate operation is triggered for the instance\uff0c the network-vif-plugged event will send to the source host, then the new instance will spawn failed in destination host because of waiting for network-vif-plugged event timeout. The probability of this question is big relatively.\n\nSteps to reproduce\n==================\n\n1. Booting 5 or more instance in one host.\n2. After instances were spawning successfully\uff0c power off the host at once.\n3. Then evacuate the instance in this host.\n4. execute 'nova migration-list' to search failed records\n\nExpected result\n===============\ninstances will be evacuated successfully.\n\nActual result\n=============\nSome instance will be evacuated failed because of waiting for network-vif-plugged event timeout.", 
            "date_created": "2016-12-27 08:02:31.561452+00:00", 
            "author": "https://api.launchpad.net/1.0/~eric-litao"
        }, 
        {
            "content": "I think when the vif was plugged successfully, the neutron will send two events: network-vif-plugged and network-changed. The first event told the spawning to continue and the second event told nova to update instance_info_cache. But    \nneutron only send the first event.", 
            "date_created": "2016-12-27 08:51:05.294548+00:00", 
            "author": "https://api.launchpad.net/1.0/~eric-litao"
        }, 
        {
            "content": "Failed Logs:\nVirtual Interface creation failed notify_about_instance_usage /usr/lib/python2.7/site-packages/nova/compute/utils.py:284\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [req-a471cc44-296b-463f-b1e3-c99d88f814e0 - - - - -] [instance: bd106fcf-494d-414f-a48f-6313ba387f0e] Setting instance vm_state to ERROR\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e] Traceback (most recent call last):\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 6556, in _error_out_instance_on_exception\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]     yield\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2769, in rebuild_instance\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]     bdms, recreate, on_shared_storage, preserve_ephemeral)\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2813, in _do_rebuild_instance_with_claim\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]     self._do_rebuild_instance(*args, **kwargs)\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2929, in _do_rebuild_instance\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]     self._rebuild_default_impl(**kwargs)\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2694, in _rebuild_default_impl\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]     block_device_info=new_block_device_info)\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2780, in spawn\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]     block_device_info=block_device_info)\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4946, in _create_domain_and_network\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e]     raise exception.VirtualInterfaceCreateException()\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e] VirtualInterfaceCreateException: Virtual Interface creation failed\n2016-12-24 14:26:43.689 36457 ERROR nova.compute.manager [instance: bd106fcf-494d-414f-a48f-6313ba387f0e] \n2016-12-24 14:26:44.068 36457 INFO nova.compute.manager [req-a471cc44-296b-463f-b1e3-c99d88f814e0 - - - - -] [instance: bd106fcf-494d-414f-a48f-6313ba387f0e] Successfully reverted task state from rebuild_spawning on failure for instance.\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server [req-a471cc44-296b-463f-b1e3-c99d88f814e0 - - - - -] Exception during message handling\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server Traceback (most recent call last):\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/server.py\", line 155, in _process_incoming\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     res = self.dispatcher.dispatch(message)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 222, in dispatch\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     return self._do_dispatch(endpoint, method, ctxt, args)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 192, in _do_dispatch\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     result = func(ctxt, **new_args)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/server.py\", line 218, in inner\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     return func(*args, **kwargs)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 110, in wrapped\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     payload)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 89, in wrapped\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     return f(self, context, *args, **kw)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 359, in decorated_function\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     LOG.warning(msg, e, instance=instance)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 328, in decorated_function\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     return function(self, context, *args, **kwargs)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 409, in decorated_function\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     return function(self, context, *args, **kwargs)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 387, in decorated_function\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     kwargs['instance'], e, sys.exc_info())\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     self.force_reraise()\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     six.reraise(self.type_, self.value, self.tb)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 375, in decorated_function\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     return function(self, context, *args, **kwargs)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2769, in rebuild_instance\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     bdms, recreate, on_shared_storage, preserve_ephemeral)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2813, in _do_rebuild_instance_with_claim\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     self._do_rebuild_instance(*args, **kwargs)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2929, in _do_rebuild_instance\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     self._rebuild_default_impl(**kwargs)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2694, in _rebuild_default_impl\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     block_device_info=new_block_device_info)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2780, in spawn\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     block_device_info=block_device_info)\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4946, in _create_domain_and_network\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server     raise exception.VirtualInterfaceCreateException()\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server VirtualInterfaceCreateException: Virtual Interface creation failed\n2016-12-24 14:26:44.090 36457 ERROR oslo_messaging.rpc.server ", 
            "date_created": "2016-12-27 08:55:11.813536+00:00", 
            "author": "https://api.launchpad.net/1.0/~eric-litao"
        }
    ]
}