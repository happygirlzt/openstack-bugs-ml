{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:01:02.887559+00:00", 
    "description": "The compute API in nova Essex now throws InstanceInvalidState exceptions when an instance is in the wrong state for the selected action.\n\nTrying to delete a server in build (or resize) will cause HTTP 500 exceptions to occur. This is incorrect API behaviour as the SPEC says that HTTP 409 buildInProgress should be returned.\n\nAdditionally, the API log files include a full stack trace when the exceptions occur (these are user generated via the API):\n\n3d527481b 75cf5a01f13c4ef09cf4e1601f0c16c6 7535afc6ccc4449b804f7c06e8ebd98e] Caught error: Instance 3beb9aa8-9081-4398-b3a8-55cd1d77b1fd in vm_state building. Cannot delete while the instance is in this state.\n(nova.api.openstack.v2): TRACE: Traceback (most recent call last):\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/__init__.py\", line 59, in __call__\n(nova.api.openstack.v2): TRACE:     return req.get_response(self.application)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1053, in get_response\n(nova.api.openstack.v2): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1022, in call_application\n(nova.api.openstack.v2): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 330, in __call__\n(nova.api.openstack.v2): TRACE:     return self._forward_request(env, start_response, proxy_headers)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 541, in _forward_request\n(nova.api.openstack.v2): TRACE:     return self.app(env, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack.v2): TRACE:     return resp(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 147, in __call__\n(nova.api.openstack.v2): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 208, in call_func\n(nova.api.openstack.v2): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 568, in __call__\n(nova.api.openstack.v2): TRACE:     action_result = self.dispatch(request, action, args)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 600, in dispatch\n(nova.api.openstack.v2): TRACE:     return controller_method(req=request, **action_args)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 52, in new_f\n(nova.api.openstack.v2): TRACE:     ret = f(*args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/scheduler/api.py\", line 401, in new_f\n(nova.api.openstack.v2): TRACE:     return f(*args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/servers.py\", line 575, in delete\n(nova.api.openstack.v2): TRACE:     self._delete(req.environ['nova.context'], id)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/servers.py\", line 437, in _delete\n(nova.api.openstack.v2): TRACE:     self.compute_api.delete(context, instance)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/api.py\", line 77, in inner\n(nova.api.openstack.v2): TRACE:     method=f.__name__)\n(nova.api.openstack.v2): TRACE: InstanceInvalidState: Instance 3beb9aa8-9081-4398-b3a8-55cd1d77b1fd in vm_state building. Cannot delete while the instance is in this state.\n\n----\n\nGiven the compute API is throwing a new type of exception it appears we need to review the Openstack and EC2 APIs to make sure these exceptions are handled properly.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/911879", 
    "owner": "https://api.launchpad.net/1.0/~blamar", 
    "id": 911879, 
    "index": 2700, 
    "openned": "2012-01-04 17:08:54.137717+00:00", 
    "created": "2012-01-04 17:08:54.137717+00:00", 
    "title": "Update OSAPI and EC2's to properly handle InstanceInvalidState exceptions", 
    "comments": [
        {
            "content": "The compute API in nova Essex now throws InstanceInvalidState exceptions when an instance is in the wrong state for the selected action.\n\nTrying to delete a server in build (or resize) will cause HTTP 500 exceptions to occur. This is incorrect API behaviour as the SPEC says that HTTP 409 buildInProgress should be returned.\n\nAdditionally, the API log files include a full stack trace when the exceptions occur (these are user generated via the API):\n\n3d527481b 75cf5a01f13c4ef09cf4e1601f0c16c6 7535afc6ccc4449b804f7c06e8ebd98e] Caught error: Instance 3beb9aa8-9081-4398-b3a8-55cd1d77b1fd in vm_state building. Cannot delete while the instance is in this state.\n(nova.api.openstack.v2): TRACE: Traceback (most recent call last):\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/__init__.py\", line 59, in __call__\n(nova.api.openstack.v2): TRACE:     return req.get_response(self.application)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1053, in get_response\n(nova.api.openstack.v2): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1022, in call_application\n(nova.api.openstack.v2): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 330, in __call__\n(nova.api.openstack.v2): TRACE:     return self._forward_request(env, start_response, proxy_headers)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 541, in _forward_request\n(nova.api.openstack.v2): TRACE:     return self.app(env, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack.v2): TRACE:     return resp(environ, start_response)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 147, in __call__\n(nova.api.openstack.v2): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 208, in call_func\n(nova.api.openstack.v2): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 568, in __call__\n(nova.api.openstack.v2): TRACE:     action_result = self.dispatch(request, action, args)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 600, in dispatch\n(nova.api.openstack.v2): TRACE:     return controller_method(req=request, **action_args)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 52, in new_f\n(nova.api.openstack.v2): TRACE:     ret = f(*args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/scheduler/api.py\", line 401, in new_f\n(nova.api.openstack.v2): TRACE:     return f(*args, **kwargs)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/servers.py\", line 575, in delete\n(nova.api.openstack.v2): TRACE:     self._delete(req.environ['nova.context'], id)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/v2/servers.py\", line 437, in _delete\n(nova.api.openstack.v2): TRACE:     self.compute_api.delete(context, instance)\n(nova.api.openstack.v2): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/api.py\", line 77, in inner\n(nova.api.openstack.v2): TRACE:     method=f.__name__)\n(nova.api.openstack.v2): TRACE: InstanceInvalidState: Instance 3beb9aa8-9081-4398-b3a8-55cd1d77b1fd in vm_state building. Cannot delete while the instance is in this state.\n\n----\n\nGiven the compute API is throwing a new type of exception it appears we need to review the Openstack and EC2 APIs to make sure these exceptions are handled properly.", 
            "date_created": "2012-01-04 17:08:54.137717+00:00", 
            "author": "https://api.launchpad.net/1.0/~dan-prince"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/2846", 
            "date_created": "2012-01-05 16:49:19.132129+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2846\nCommitted: http://github.com/openstack/nova/commit/18f72f29a92733e56d8641e48b2099df1b8b30f4\nSubmitter: Jenkins\nBranch:    master\n\ncommit 18f72f29a92733e56d8641e48b2099df1b8b30f4\nAuthor: Brian Lamar <email address hidden>\nDate:   Wed Jan 4 18:54:45 2012 -0500\n\n    Return 409s instead of 500s when deleting certain instances.\n    \n    Fixes bug 911879\n    \n    Change-Id: Ib2ae875ec2d1eeea21d15a756b96c27047b12bee\n", 
            "date_created": "2012-01-05 17:03:28.857317+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/2992", 
            "date_created": "2012-01-12 06:59:30.449123+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/2992\nCommitted: http://github.com/openstack/nova/commit/475691a4bd5795feb50b5c9ccfe98e6487390e58\nSubmitter: Jenkins\nBranch:    master\n\ncommit 475691a4bd5795feb50b5c9ccfe98e6487390e58\nAuthor: Chris Behrens <email address hidden>\nDate:   Wed Jan 11 20:25:23 2012 -0800\n\n    catch InstanceInvalidState in more places\n    \n    Further fixes to bug 911879\n    \n    500s or 400s are returned in the OS API when actions are denied due\n    to being in an invalid state.  409 should be returned, instead.  A\n    previous review (2846) fixed the delete case and this fixes more.\n    \n    When writing tests, I found a number of exceptions that are not raised\n    anymore, and they were being incorrectly used in tests still.  I fixed\n    those up.\n    \n    Change-Id: I0d5b1ed52e0cc9766be8e2a7de84c8601f4bdf26\n", 
            "date_created": "2012-01-12 15:13:56.300664+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-01-25 09:55:06.226232+00:00"
}