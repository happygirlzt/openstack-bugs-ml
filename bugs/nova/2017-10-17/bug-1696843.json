{
    "status": "Fix Released", 
    "last_updated": "2017-07-28 07:41:53.054330+00:00", 
    "description": "http://logs.openstack.org/94/436094/33/check/gate-tempest-dsvm-neutron-full-ubuntu-xenial/bed0e6a/logs/screen-n-api.txt.gz#_Jun_08_18_36_06_589590\n\nJun 08 18:36:06.549748 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]: DEBUG nova.api.metadata.handler [-] Using cached metadata for instance 6cd26f78-9c8a-4b37-8c62-38ad003a095f {{(pid=18770) get_metadata_by_instance_id /opt/stack/new/nova/nova/api/metadata/handler.py:78}}\nJun 08 18:36:06.589590 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]: INFO nova.metadata.wsgi.server [None req-97c06652-908d-4603-a84d-40f818726b5d None None] Traceback (most recent call last):\nJun 08 18:36:06.589719 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 490, in handle_one_response\nJun 08 18:36:06.589804 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     result = self.application(self.environ, start_response)\nJun 08 18:36:06.589911 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/paste/urlmap.py\", line 216, in __call__\nJun 08 18:36:06.590006 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return app(environ, start_response)\nJun 08 18:36:06.590090 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 131, in __call__\nJun 08 18:36:06.590179 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     resp = self.call_func(req, *args, **self.kwargs)\nJun 08 18:36:06.590270 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 196, in call_func\nJun 08 18:36:06.590351 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return self.func(req, *args, **kwargs)\nJun 08 18:36:06.590428 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/oslo_middleware/base.py\", line 125, in __call__\nJun 08 18:36:06.590508 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     response = req.get_response(self.application)\nJun 08 18:36:06.590585 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1316, in send\nJun 08 18:36:06.590661 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     application, catch_exc_info=False)\nJun 08 18:36:06.590742 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1280, in call_application\nJun 08 18:36:06.590824 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     app_iter = application(self.environ, start_response)\nJun 08 18:36:06.590906 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 131, in __call__\nJun 08 18:36:06.590983 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     resp = self.call_func(req, *args, **self.kwargs)\nJun 08 18:36:06.591060 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 196, in call_func\nJun 08 18:36:06.591136 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return self.func(req, *args, **kwargs)\nJun 08 18:36:06.591212 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/api/metadata/handler.py\", line 121, in __call__\nJun 08 18:36:06.591287 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return data(req, meta_data)\nJun 08 18:36:06.591370 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/api/metadata/password.py\", line 70, in handle_password\nJun 08 18:36:06.591446 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     instance = objects.Instance.get_by_uuid(ctxt, meta_data.uuid)\nJun 08 18:36:06.591531 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 184, in wrapper\nJun 08 18:36:06.591610 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     result = fn(cls, context, *args, **kwargs)\nJun 08 18:36:06.591687 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 463, in get_by_uuid\nJun 08 18:36:06.591763 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     use_slave=use_slave)\nJun 08 18:36:06.591839 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 236, in wrapper\nJun 08 18:36:06.591914 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return f(*args, **kwargs)\nJun 08 18:36:06.592000 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 455, in _db_instance_get_by_uuid\nJun 08 18:36:06.592069 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     columns_to_join=columns_to_join)\nJun 08 18:36:06.592159 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/api.py\", line 745, in instance_get_by_uuid\nJun 08 18:36:06.592253 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return IMPL.instance_get_by_uuid(context, uuid, columns_to_join)\nJun 08 18:36:06.592339 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 180, in wrapper\nJun 08 18:36:06.592420 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return f(*args, **kwargs)\nJun 08 18:36:06.592501 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 281, in wrapped\nJun 08 18:36:06.592582 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return f(context, *args, **kwargs)\nJun 08 18:36:06.592664 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1921, in instance_get_by_uuid\nJun 08 18:36:06.592745 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     columns_to_join=columns_to_join)\nJun 08 18:36:06.593201 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1930, in _instance_get_by_uuid\nJun 08 18:36:06.593299 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     raise exception.InstanceNotFound(instance_id=uuid)\nJun 08 18:36:06.593384 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]: InstanceNotFound: Instance 6cd26f78-9c8a-4b37-8c62-38ad003a095f could not be found.\nJun 08 18:36:06.593487 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]: : InstanceNotFound: Instance 6cd26f78-9c8a-4b37-8c62-38ad003a095f could not be found.\nJun 08 18:36:06.594103 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]: INFO nova.metadata.wsgi.server [None req-97c06652-908d-4603-a84d-40f818726b5d None None] 10.1.0.11,10.40.184.140 \"POST /openstack/2013-10-17/password HTTP/1.1\" status: 500 len: 139 time: 0.0445061: InstanceNotFound: Instance 6cd26f78-9c8a-4b37-8c62-38ad003a095f could not be found.\n\nThis was seen on this change:\n\nhttps://review.openstack.org/#/c/436094/\n\nThe tempest test creates a server, then POSTs the password from the guest to the metadata service, which should update the instance.system_metadata with the password. Then Tempest calls the os-server-password REST API to get the password and verify they are the same, but it's not getting set during the metadata POST, and it looks like because when the metadata handler is looking up the instance it's not targeted to a cell.", 
    "tags": [
        "api", 
        "cells"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1696843", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1696843, 
    "index": 2089, 
    "openned": "2017-06-08 19:42:45.534946+00:00", 
    "created": "2017-06-08 19:42:45.534946+00:00", 
    "title": "metadata: POST /openstack/2013-10-17/password fails with InstanceNotFound", 
    "comments": [
        {
            "content": "http://logs.openstack.org/94/436094/33/check/gate-tempest-dsvm-neutron-full-ubuntu-xenial/bed0e6a/logs/screen-n-api.txt.gz#_Jun_08_18_36_06_589590\n\nJun 08 18:36:06.549748 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]: DEBUG nova.api.metadata.handler [-] Using cached metadata for instance 6cd26f78-9c8a-4b37-8c62-38ad003a095f {{(pid=18770) get_metadata_by_instance_id /opt/stack/new/nova/nova/api/metadata/handler.py:78}}\nJun 08 18:36:06.589590 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]: INFO nova.metadata.wsgi.server [None req-97c06652-908d-4603-a84d-40f818726b5d None None] Traceback (most recent call last):\nJun 08 18:36:06.589719 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/eventlet/wsgi.py\", line 490, in handle_one_response\nJun 08 18:36:06.589804 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     result = self.application(self.environ, start_response)\nJun 08 18:36:06.589911 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/paste/urlmap.py\", line 216, in __call__\nJun 08 18:36:06.590006 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return app(environ, start_response)\nJun 08 18:36:06.590090 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 131, in __call__\nJun 08 18:36:06.590179 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     resp = self.call_func(req, *args, **self.kwargs)\nJun 08 18:36:06.590270 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 196, in call_func\nJun 08 18:36:06.590351 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return self.func(req, *args, **kwargs)\nJun 08 18:36:06.590428 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/oslo_middleware/base.py\", line 125, in __call__\nJun 08 18:36:06.590508 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     response = req.get_response(self.application)\nJun 08 18:36:06.590585 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1316, in send\nJun 08 18:36:06.590661 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     application, catch_exc_info=False)\nJun 08 18:36:06.590742 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/request.py\", line 1280, in call_application\nJun 08 18:36:06.590824 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     app_iter = application(self.environ, start_response)\nJun 08 18:36:06.590906 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 131, in __call__\nJun 08 18:36:06.590983 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     resp = self.call_func(req, *args, **self.kwargs)\nJun 08 18:36:06.591060 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/webob/dec.py\", line 196, in call_func\nJun 08 18:36:06.591136 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return self.func(req, *args, **kwargs)\nJun 08 18:36:06.591212 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/api/metadata/handler.py\", line 121, in __call__\nJun 08 18:36:06.591287 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return data(req, meta_data)\nJun 08 18:36:06.591370 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/api/metadata/password.py\", line 70, in handle_password\nJun 08 18:36:06.591446 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     instance = objects.Instance.get_by_uuid(ctxt, meta_data.uuid)\nJun 08 18:36:06.591531 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 184, in wrapper\nJun 08 18:36:06.591610 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     result = fn(cls, context, *args, **kwargs)\nJun 08 18:36:06.591687 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 463, in get_by_uuid\nJun 08 18:36:06.591763 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     use_slave=use_slave)\nJun 08 18:36:06.591839 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 236, in wrapper\nJun 08 18:36:06.591914 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return f(*args, **kwargs)\nJun 08 18:36:06.592000 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 455, in _db_instance_get_by_uuid\nJun 08 18:36:06.592069 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     columns_to_join=columns_to_join)\nJun 08 18:36:06.592159 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/api.py\", line 745, in instance_get_by_uuid\nJun 08 18:36:06.592253 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return IMPL.instance_get_by_uuid(context, uuid, columns_to_join)\nJun 08 18:36:06.592339 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 180, in wrapper\nJun 08 18:36:06.592420 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return f(*args, **kwargs)\nJun 08 18:36:06.592501 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 281, in wrapped\nJun 08 18:36:06.592582 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     return f(context, *args, **kwargs)\nJun 08 18:36:06.592664 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1921, in instance_get_by_uuid\nJun 08 18:36:06.592745 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     columns_to_join=columns_to_join)\nJun 08 18:36:06.593201 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1930, in _instance_get_by_uuid\nJun 08 18:36:06.593299 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]:     raise exception.InstanceNotFound(instance_id=uuid)\nJun 08 18:36:06.593384 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]: InstanceNotFound: Instance 6cd26f78-9c8a-4b37-8c62-38ad003a095f could not be found.\nJun 08 18:36:06.593487 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]: : InstanceNotFound: Instance 6cd26f78-9c8a-4b37-8c62-38ad003a095f could not be found.\nJun 08 18:36:06.594103 ubuntu-xenial-osic-cloud1-s3700-9216660 nova-api[18643]: INFO nova.metadata.wsgi.server [None req-97c06652-908d-4603-a84d-40f818726b5d None None] 10.1.0.11,10.40.184.140 \"POST /openstack/2013-10-17/password HTTP/1.1\" status: 500 len: 139 time: 0.0445061: InstanceNotFound: Instance 6cd26f78-9c8a-4b37-8c62-38ad003a095f could not be found.\n\nThis was seen on this change:\n\nhttps://review.openstack.org/#/c/436094/\n\nThe tempest test creates a server, then POSTs the password from the guest to the metadata service, which should update the instance.system_metadata with the password. Then Tempest calls the os-server-password REST API to get the password and verify they are the same, but it's not getting set during the metadata POST, and it looks like because when the metadata handler is looking up the instance it's not targeted to a cell.", 
            "date_created": "2017-06-08 19:42:45.534946+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "The problem is here:\n\nhttps://github.com/openstack/nova/blob/b535c7432d02366f11fad7d1b1a3e3a8b8ac5415/nova/api/metadata/password.py#L70\n\nWe don't have the Instance.get_by_uuid lookup targeted to the cell context. We could lookup the instance mapping in the API DB by the uuid to get the cell, but it sounds like the metadata service is supposed to be in the cell and not in the top-level layer, which is confusing to me.", 
            "date_created": "2017-06-08 19:46:29.270626+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/472405", 
            "date_created": "2017-06-08 20:36:52.736136+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/472405\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=6739fa6110ea837da567ba8a40b17fe673bddef4\nSubmitter: Jenkins\nBranch:    master\n\ncommit 6739fa6110ea837da567ba8a40b17fe673bddef4\nAuthor: Dan Smith <email address hidden>\nDate:   Thu Jun 8 13:35:47 2017 -0700\n\n    Fix lookup of instance mapping in metadata set-password\n    \n    The set-password function in metadata may try to lookup the instance\n    by uuid without proper cell targeting. This fixes that.\n    \n    Change-Id: I8f27e4d89f0ec69b79e03a114570bedc37563cbe\n    Closes-Bug: #1696843\n", 
            "date_created": "2017-06-09 10:02:04.344574+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b3 development milestone.", 
            "date_created": "2017-07-28 07:41:52.540319+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-06-09 10:02:01.415310+00:00"
}