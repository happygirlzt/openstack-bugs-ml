{
    "status": "Fix Released", 
    "last_updated": "2013-04-22 08:05:14.272345+00:00", 
    "description": "Description:\n\nThe error message that appears when quota of instances allocated for a project is exceeded is not proper. THe is a mismatch between the number of instances that are shown in nova list and that the error message indicates.( This behaviour is intermitent. Not reproducible always)\n\nEnvironment: Folsom single and multi node.\n\nLOG:\n---------\n\nSINGLE NODE:\n\nrajalakshmi_ganesan@ubuntu:~$ nova --debug list\n\nREQ: curl -i http://15.184.83.251:8774/v2/637fefbe43a34998a1f583b1ce4b3bd7/servers/detail -X GET -H \"X-Auth-Project-Id: nova_auto_project\" -H \"User-Agent: python-novaclient\" -H \"Accept: application/json\" -H \"X-Auth-Token: d495b30babc14f3792d118f768ae7cf0\"\n\nconnect: (15.184.83.251, 8774)\nsend: 'GET /v2/637fefbe43a34998a1f583b1ce4b3bd7/servers/detail HTTP/1.1\\r\\nHost: 15.184.83.251:8774\\r\\nx-auth-project-id: nova_auto_project\\r\\nx-auth-token: d495b30babc14f3792d118f768ae7cf0\\r\\naccept-encoding: gzip, deflate\\r\\naccept: application/json\\r\\nuser-agent: python-novaclient\\r\\n\\r\\n'\nreply: 'HTTP/1.1 200 OK\\r\\n'\nheader: X-Compute-Request-Id: req-fb30fc19-b904-4431-9c74-841969c77cb2\nheader: Content-Type: application/json\nheader: Content-Length: 15\nheader: Date: Wed, 05 Sep 2012 09:38:03 GMT\nRESP:{'status': '200', 'content-length': '15', 'content-location': 'http://15.184.83.251:8774/v2/637fefbe43a34998a1f583b1ce4b3bd7/servers/detail', 'x-compute-request-id': 'req-fb30fc19-b904-4431-9c74-841969c77cb2', 'date': 'Wed, 05 Sep 2012 09:38:03 GMT', 'content-type': 'application/json'} {\"servers\": []}\n\n\nrajalakshmi_ganesan@ubuntu:~$ nova boot --image 49775afa-52f5-40e7-acf9-0ed8c64ca18b --flavor 1 test-1\nERROR: Quota exceeded for instances: Requested 1, but already used 12 of 10 instances (HTTP 413) (Request-ID: req-be253057-5e3f-4448-a78c-41116f8272ac)\nrajalakshmi_ganesan@ubuntu:~$\n\nTHERE ARE NO SERVERS DISPLAYED IN NOVA LIST....STILL IT SAYS \"Requested 1, but already used 12 of 10 instances \"\n\nMULTI NODE:\n------------------\n\nrajalakshmi_ganesan@ubuntu:~$ nova list\n+--------------------------------------+---------------------------------------+--------+-------------------+\n| ID                                   | Name                                  | Status | Networks          |\n+--------------------------------------+---------------------------------------+--------+-------------------+\n| b81f4fd0-84b5-45ba-bf2d-14f26fa013a6 | auto_nonexist_server_metadata         | ACTIVE | private=10.0.0.41 |\n| c33913a0-841d-496a-85e4-40665ede44c8 | auto_nonexist_server_test_list_image  | ACTIVE | private=10.0.0.39 |\n| 737ef9b7-7b34-452f-a0ec-01c51e1529c6 | auto_server_image_create              | ACTIVE | private=10.0.0.27 |\n| 4b665253-6b4e-4785-b50a-5f6f7a98eb78 | auto_server_test_delete_image         | ACTIVE | private=10.0.0.28 |\n| 782f4c23-9fa7-462a-813f-5938509688e3 | auto_test_server_delete_metadata_item | ACTIVE | private=10.0.0.37 |\n| 317d823c-5ab6-461d-be9e-d0ca9a151ef4 | auto_test_server_get_image_details    | ACTIVE | private=10.0.0.29 |\n| 57270ea4-bbf6-4fd7-88e5-4b659ca40b4a | auto_test_server_list_image           | ACTIVE | private=10.0.0.30 |\n| 6d08f8ba-7880-415d-8372-f03735b65179 | server_for_vol_attach                 | ACTIVE | private=10.0.0.22 |\n| 379a0302-6a76-48c5-ba38-f4de8bb20557 | server_invalid_url                    | ACTIVE | private=10.0.0.33 |\n| 4ef2c987-942e-4914-91bf-63970d6edf12 | server_invalid_url_xml_volume         | ACTIVE | private=10.0.0.36 |\n| 337780df-274d-482b-b7dd-b3d5db858fcd | server_metadata_invalid_url           | ACTIVE | private=10.0.0.31 |\n| 022a527b-3b81-4aef-9ad9-2d865de42249 | server_metadata_update_invalid_url    | ACTIVE | private=10.0.0.32 |\n| f6a422a6-0dbb-4b5e-b67d-375d755179be | server_metadata_update_xml            | ACTIVE | private=10.0.0.35 |\n| b538e207-fc49-4b6d-89e0-b0ea3582a767 | server_metadata_xml                   | ACTIVE | private=10.0.0.34 |\n| 31e2b85e-e19e-43b8-9f00-e8a6ae1a912a | test_floatingip_ACTIVE                | ACTIVE | private=10.0.0.24 |\n| 7c6a1286-f203-4f67-9920-1d7c4e6e3b66 | test_floatingip_HARD_REBOOT           | ACTIVE | private=10.0.0.26 |\n| 294ebd3e-d3b6-4ff7-ad2a-ec43ff8d3de8 | test_floatingip_REBOOT                | ACTIVE | private=10.0.0.25 |\n| fc917e20-c532-45f3-a12f-78f8d1387c76 | test_get_console_output               | ACTIVE | private=10.0.0.23 |\n| dd40a5e4-ba11-4dae-bb1d-05f3b83ba2cc | test_list_server_metadata             | ACTIVE | private=10.0.0.40 |\n| 7e863497-d000-4d0c-bf0b-3374a628e81f | test_server_metadata                  | ACTIVE | private=10.0.0.38 |\n| acecbb30-b322-4a76-99e5-14c1660bfe12 | test_set_server_metadata              | ACTIVE | private=10.0.0.42 |\n+--------------------------------------+---------------------------------------+--------+-------------------+\nrajalakshmi_ganesan@ubuntu:~$ nova boot --image 170158af-9248-417a-8c26-865502cc05a6 --flavor 1 test-12\nERROR: Quota exceeded for instances: Requested 1, but already used 16 of 10 instances (HTTP 413) (Request-ID: req-f3517177-2812-4cda-82ef-6e7257a02b63)\n\n\n\nTHERE ARE 21 SERVERS DISPLAYED IN NOVA LIST....STILL IT SAYS \"Requested 1, but already used 16 of 10 instances \"", 
    "tags": [], 
    "importance": "High", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1046236", 
    "owner": "https://api.launchpad.net/1.0/~eglynn", 
    "id": 1046236, 
    "index": 788, 
    "openned": "2012-09-05 09:50:01.905074+00:00", 
    "created": "2012-09-05 09:50:01.905074+00:00", 
    "title": "Folsom - Quota exceeded error messages for instance quota exceeded are not proper", 
    "comments": [
        {
            "content": "Description:\n\nThe error message that appears when quota of instances allocated for a project is exceeded is not proper. THe is a mismatch between the number of instances that are shown in nova list and that the error message indicates.( This behaviour is intermitent. Not reproducible always)\n\nEnvironment: Folsom single and multi node.\n\nLOG:\n---------\n\nSINGLE NODE:\n\nrajalakshmi_ganesan@ubuntu:~$ nova --debug list\n\nREQ: curl -i http://15.184.83.251:8774/v2/637fefbe43a34998a1f583b1ce4b3bd7/servers/detail -X GET -H \"X-Auth-Project-Id: nova_auto_project\" -H \"User-Agent: python-novaclient\" -H \"Accept: application/json\" -H \"X-Auth-Token: d495b30babc14f3792d118f768ae7cf0\"\n\nconnect: (15.184.83.251, 8774)\nsend: 'GET /v2/637fefbe43a34998a1f583b1ce4b3bd7/servers/detail HTTP/1.1\\r\\nHost: 15.184.83.251:8774\\r\\nx-auth-project-id: nova_auto_project\\r\\nx-auth-token: d495b30babc14f3792d118f768ae7cf0\\r\\naccept-encoding: gzip, deflate\\r\\naccept: application/json\\r\\nuser-agent: python-novaclient\\r\\n\\r\\n'\nreply: 'HTTP/1.1 200 OK\\r\\n'\nheader: X-Compute-Request-Id: req-fb30fc19-b904-4431-9c74-841969c77cb2\nheader: Content-Type: application/json\nheader: Content-Length: 15\nheader: Date: Wed, 05 Sep 2012 09:38:03 GMT\nRESP:{'status': '200', 'content-length': '15', 'content-location': 'http://15.184.83.251:8774/v2/637fefbe43a34998a1f583b1ce4b3bd7/servers/detail', 'x-compute-request-id': 'req-fb30fc19-b904-4431-9c74-841969c77cb2', 'date': 'Wed, 05 Sep 2012 09:38:03 GMT', 'content-type': 'application/json'} {\"servers\": []}\n\n\nrajalakshmi_ganesan@ubuntu:~$ nova boot --image 49775afa-52f5-40e7-acf9-0ed8c64ca18b --flavor 1 test-1\nERROR: Quota exceeded for instances: Requested 1, but already used 12 of 10 instances (HTTP 413) (Request-ID: req-be253057-5e3f-4448-a78c-41116f8272ac)\nrajalakshmi_ganesan@ubuntu:~$\n\nTHERE ARE NO SERVERS DISPLAYED IN NOVA LIST....STILL IT SAYS \"Requested 1, but already used 12 of 10 instances \"\n\nMULTI NODE:\n------------------\n\nrajalakshmi_ganesan@ubuntu:~$ nova list\n+--------------------------------------+---------------------------------------+--------+-------------------+\n| ID                                   | Name                                  | Status | Networks          |\n+--------------------------------------+---------------------------------------+--------+-------------------+\n| b81f4fd0-84b5-45ba-bf2d-14f26fa013a6 | auto_nonexist_server_metadata         | ACTIVE | private=10.0.0.41 |\n| c33913a0-841d-496a-85e4-40665ede44c8 | auto_nonexist_server_test_list_image  | ACTIVE | private=10.0.0.39 |\n| 737ef9b7-7b34-452f-a0ec-01c51e1529c6 | auto_server_image_create              | ACTIVE | private=10.0.0.27 |\n| 4b665253-6b4e-4785-b50a-5f6f7a98eb78 | auto_server_test_delete_image         | ACTIVE | private=10.0.0.28 |\n| 782f4c23-9fa7-462a-813f-5938509688e3 | auto_test_server_delete_metadata_item | ACTIVE | private=10.0.0.37 |\n| 317d823c-5ab6-461d-be9e-d0ca9a151ef4 | auto_test_server_get_image_details    | ACTIVE | private=10.0.0.29 |\n| 57270ea4-bbf6-4fd7-88e5-4b659ca40b4a | auto_test_server_list_image           | ACTIVE | private=10.0.0.30 |\n| 6d08f8ba-7880-415d-8372-f03735b65179 | server_for_vol_attach                 | ACTIVE | private=10.0.0.22 |\n| 379a0302-6a76-48c5-ba38-f4de8bb20557 | server_invalid_url                    | ACTIVE | private=10.0.0.33 |\n| 4ef2c987-942e-4914-91bf-63970d6edf12 | server_invalid_url_xml_volume         | ACTIVE | private=10.0.0.36 |\n| 337780df-274d-482b-b7dd-b3d5db858fcd | server_metadata_invalid_url           | ACTIVE | private=10.0.0.31 |\n| 022a527b-3b81-4aef-9ad9-2d865de42249 | server_metadata_update_invalid_url    | ACTIVE | private=10.0.0.32 |\n| f6a422a6-0dbb-4b5e-b67d-375d755179be | server_metadata_update_xml            | ACTIVE | private=10.0.0.35 |\n| b538e207-fc49-4b6d-89e0-b0ea3582a767 | server_metadata_xml                   | ACTIVE | private=10.0.0.34 |\n| 31e2b85e-e19e-43b8-9f00-e8a6ae1a912a | test_floatingip_ACTIVE                | ACTIVE | private=10.0.0.24 |\n| 7c6a1286-f203-4f67-9920-1d7c4e6e3b66 | test_floatingip_HARD_REBOOT           | ACTIVE | private=10.0.0.26 |\n| 294ebd3e-d3b6-4ff7-ad2a-ec43ff8d3de8 | test_floatingip_REBOOT                | ACTIVE | private=10.0.0.25 |\n| fc917e20-c532-45f3-a12f-78f8d1387c76 | test_get_console_output               | ACTIVE | private=10.0.0.23 |\n| dd40a5e4-ba11-4dae-bb1d-05f3b83ba2cc | test_list_server_metadata             | ACTIVE | private=10.0.0.40 |\n| 7e863497-d000-4d0c-bf0b-3374a628e81f | test_server_metadata                  | ACTIVE | private=10.0.0.38 |\n| acecbb30-b322-4a76-99e5-14c1660bfe12 | test_set_server_metadata              | ACTIVE | private=10.0.0.42 |\n+--------------------------------------+---------------------------------------+--------+-------------------+\nrajalakshmi_ganesan@ubuntu:~$ nova boot --image 170158af-9248-417a-8c26-865502cc05a6 --flavor 1 test-12\nERROR: Quota exceeded for instances: Requested 1, but already used 16 of 10 instances (HTTP 413) (Request-ID: req-f3517177-2812-4cda-82ef-6e7257a02b63)\n\n\n\nTHERE ARE 21 SERVERS DISPLAYED IN NOVA LIST....STILL IT SAYS \"Requested 1, but already used 16 of 10 instances \"", 
            "date_created": "2012-09-05 09:50:01.905074+00:00", 
            "author": "https://api.launchpad.net/1.0/~rajalakshmi-ganesan"
        }, 
        {
            "content": "Something does look incorrect here.", 
            "date_created": "2012-09-10 21:23:36.276421+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Hi Rajalakshmi,\n\nWhat exact version of Folsom are you using?\n\nDo you have a current case where this issue is showing up?\n\nIf so, can you confirm the relevant data in the quota_usages table, e.g.:\n\n  echo \"select * from quota_usages where project_id = '637fefbe43a34998a1f583b1ce4b3bd7' and resource = 'instances'\" | mysql -u root -p<password> nova\n\nAlso, can you confirm whether the instance quota threshold was changed previously? (e.g. increased to 20, then decreased back to 10)\n\nFinally, other than booting instances, what other instance operations have been carried out before the issue manifests? (e.g. resizing, deleting etc.)\n\nThanks in advance for the information.", 
            "date_created": "2012-09-11 22:00:15.849686+00:00", 
            "author": "https://api.launchpad.net/1.0/~eglynn"
        }, 
        {
            "content": "OK, here we have at least two separate unexpected states in the quota accounting:\n\n(a) the usage count exceeding the quota threshold (e.g. 16 > 10 instances)\n\n(b) the usage count not matching the actual resource consumption (e.g. 16 < 21 instances)\n\nUntil the bug reporter indicates otherwise, the obvious cause for (a) is that the quota threshold was reduced via an administrative action (this does not take into account current usage and allows negative headroom to result).\n\nFor the multi-node case at least, I suspect that the mismatch in (b) is related to bug #1046188.\n\nIf an exception is raised during the nova-compute node's instance termination logic *before* the instance is evicted from the DB (e.g. in the network teardown), then the task_state is reverted back to None by the reverts_task_state decorator.\n\nHence the instance continues to be reported as ACTIVE, and a subsequent attempt to delete the same instance results in the usage count being decremented a second time.\n\nThis occurs despite https://github.com/openstack/nova/commit/aaccb0a9 as that fix depends on the the VM task state continuing to be DELETING. That logic was undermined in https://github.com/openstack/nova/commit/d8d7100f which caused the task state to be reverted on the successful or unsuccessful conclusion of the action on the compute node.\n\nNow, the motivation for https://github.com/openstack/nova/commit/d8d7100f was to avoid the VM getting stuck with a task state that prevented any further action other than deletion. However in the case of a deletion already being requested, this protection is unnecessary and counter-productive.", 
            "date_created": "2012-09-12 15:47:37.695569+00:00", 
            "author": "https://api.launchpad.net/1.0/~eglynn"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/12887", 
            "date_created": "2012-09-12 16:33:01.256871+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/12887\nCommitted: http://github.com/openstack/nova/commit/5f4d20ef439fe04e5d7ab7e1d4610b739222ce6b\nSubmitter: Jenkins\nBranch:    master\n\ncommit 5f4d20ef439fe04e5d7ab7e1d4610b739222ce6b\nAuthor: Eoghan Glynn <email address hidden>\nDate:   Wed Sep 12 17:20:13 2012 +0100\n\n    Avoid VM task state revert on instance termination\n    \n    Related to bug 1046236.\n    \n    Previously, if an exception is raised during the nova-compute node's\n    instance termination logic *before* the instance is evicted from the DB\n    (e.g. in the network teardown), then the task_state is reverted back to\n    None by the reverts_task_state decorator, so the instance continues\n    to be reported as ACTIVE with no outstanding task.\n    \n    A subsequent attempt to delete the same instance results in the\n    quota_usages in_use count being decremented a second time.\n    \n    This occurs despite I91a70ada as that fix depends on the VM task state\n    continuing to be DELETING. That logic was undermined in Id4358c50 which\n    caused the task state to be reverted on the successful or unsuccessful\n    conclusion of the action on the compute node.\n    \n    Now, the motivation for Id4358c50 was to avoid the VM getting stuck with\n    a task state that prevents any further action other than deletion.\n    However in the case of a deletion already having been requested, this\n    protection is unnecessary and counter-productive. Hence we remove the\n    task state reversion from the terminate_instance action.\n    \n    Change-Id: Ie5701e5c12f6241a203423d29d05df1858406c56\n", 
            "date_created": "2012-09-12 21:38:56.571676+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "We still encountered this problem in folsom, I don't know how to reproduce it yet though. It could be because of our customizations to Folsom.\n\nI've verified that the patch: https://review.openstack.org/12887 is applied to our code base and that we are still encountering this.", 
            "date_created": "2013-04-22 08:05:13.552820+00:00", 
            "author": "https://api.launchpad.net/1.0/~sammiestoel"
        }
    ], 
    "closed": "2012-09-19 06:34:52.524592+00:00"
}