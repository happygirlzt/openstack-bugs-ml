{
    "status": "In Progress", 
    "last_updated": "2017-06-07 10:14:54.327847+00:00", 
    "description": "Using nova to boot UEFI instances in certain circumstances the nvram is cleared\n\ne.g. on a deployed node my nvram is set too boot from the grub installed on the EFI partition\n\n[root@t1 boot]# efibootmgr \nTimeout: 0 seconds\nBootOrder: 0004,0002,0000,0001,0003\nBoot0000* EFI Floppy\nBoot0001* EFI Floppy 1\nBoot0002* EFI Hard Drive\nBoot0003* EFI Network\nBoot0004* centos\n\n\nThis is working I can run \n> nova reboot dbdc6b36-1f17-4722-89e5-117986b10059\n\nbut if I run a nova reboot --hard or a combination of nova stop/start then the libvirt domain is redefined, as part of this process the nvram is reset, the boot process stalls at the boot menu and I have to select boot from file\n\n[root@t1 boot]# efibootmgr \nTimeout: 0 seconds\nBootOrder: 0002,0000,0001,0003\nBoot0000* EFI Floppy\nBoot0001* EFI Floppy 1\nBoot0002* EFI Hard Drive\nBoot0003* EFI Network", 
    "tags": [
        "libvirt", 
        "uefi"
    ], 
    "importance": "Undecided", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1633447", 
    "owner": "https://api.launchpad.net/1.0/~falseuser", 
    "id": 1633447, 
    "index": 7751, 
    "openned": "2016-10-14 12:02:33.158092+00:00", 
    "created": "2016-10-14 12:02:33.158092+00:00", 
    "title": "nova stop/start or reboot --hard resets uefi nvram", 
    "comments": [
        {
            "content": "Using nova to boot UEFI instances in certain circumstances the nvram is cleared\n\ne.g. on a deployed node my nvram is set too boot from the grub installed on the EFI partition\n\n[root@t1 boot]# efibootmgr \nTimeout: 0 seconds\nBootOrder: 0004,0002,0000,0001,0003\nBoot0000* EFI Floppy\nBoot0001* EFI Floppy 1\nBoot0002* EFI Hard Drive\nBoot0003* EFI Network\nBoot0004* centos\n\n\nThis is working I can run \n> nova reboot dbdc6b36-1f17-4722-89e5-117986b10059\n\nbut if I run a nova reboot --hard or a combination of nova stop/start then the libvirt domain is redefined, as part of this process the nvram is reset, the boot process stalls at the boot menu and I have to select boot from file\n\n[root@t1 boot]# efibootmgr \nTimeout: 0 seconds\nBootOrder: 0002,0000,0001,0003\nBoot0000* EFI Floppy\nBoot0001* EFI Floppy 1\nBoot0002* EFI Hard Drive\nBoot0003* EFI Network", 
            "date_created": "2016-10-14 12:02:33.158092+00:00", 
            "author": "https://api.launchpad.net/1.0/~derekh"
        }, 
        {
            "content": "Related bug https://bugs.launchpad.net/ironic-python-agent/+bug/1632637", 
            "date_created": "2016-10-14 12:03:45.882794+00:00", 
            "author": "https://api.launchpad.net/1.0/~derekh"
        }, 
        {
            "content": "Are these baremetal instances? Should this really be an Ironic issue?", 
            "date_created": "2016-12-09 15:09:17.222377+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "No these are nova instances (I just happened to be testing ironic at the time)\n\nAny instance booted with UEFI has its nvram reset when you do a \"nova stop\" then \"nova start\" as the libvirt domain gets redefined along with a new nvram.", 
            "date_created": "2016-12-09 16:57:37.706213+00:00", 
            "author": "https://api.launchpad.net/1.0/~derekh"
        }, 
        {
            "content": "There is a similar issue for me. I boot a instance using UEFI on aarch64 arm server successfully, but I can't delete it. There is error in nova compute service log.\n\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [req-49fb4cc9-485e-4861-8cb3-610fc41ec317 cf6960596f614a6caad26d12c38e4b0f a26a8a0692744742beccb71b2f319d75 - - -] [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace] Setting instance vm_state to ERROR\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace] Traceback (most recent call last):\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 2420, in do_terminate_instance\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     self._delete_instance(context, instance, bdms, quotas)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/hooks.py\", line 154, in inner\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     rv = f(*args, **kwargs)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 2383, in _delete_instance\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     quotas.rollback()\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     self.force_reraise()\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     six.reraise(self.type_, self.value, self.tb)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 2347, in _delete_instance\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     self._shutdown_instance(context, instance, bdms)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 2249, in _shutdown_instance\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     requested_networks)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     self.force_reraise()\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     six.reraise(self.type_, self.value, self.tb)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 2236, in _shutdown_instance\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     block_device_info)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 891, in destroy\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     destroy_disks, migrate_data)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1005, in cleanup\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     self._undefine_domain(instance)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 903, in _undefine_domain\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     {'errcode': errcode, 'e': e}, instance=instance)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     self.force_reraise()\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     six.reraise(self.type_, self.value, self.tb)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 897, in _undefine_domain\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     guest.delete_configuration()\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/nova/virt/libvirt/guest.py\", line 273, in delete_configuration\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     self._domain.undefine()\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 186, in doit\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 144, in proxy_call\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     rv = execute(f, *args, **kwargs)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 125, in execute\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     six.reraise(c, e, tb)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/eventlet/tpool.py\", line 83, in tworker\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     rv = meth(*args, **kwargs)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]   File \"/home/venusource/src/openstack/nova/.venv/local/lib/python2.7/site-packages/libvirt.py\", line 2837, in undefine\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace]     if ret == -1: raise libvirtError ('virDomainUndefine() failed', dom=self)\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace] libvirtError: Requested operation is not valid\uff1acannot delete inactive domain with nvram\n2016-12-09 12:05:12.705 9467 ERROR nova.compute.manager [instance: 6a1b9579-e9f4-43c1-aff9-d55af0c00ace] \n\nAccording to this bug record https://bugzilla.redhat.com/show_bug.cgi?id=1175120, this is correct for libvirt. Nova should provide --nvram parameter to undefine a domain with nvram.", 
            "date_created": "2016-12-28 03:32:16.241335+00:00", 
            "author": "https://api.launchpad.net/1.0/~samsong8610"
        }, 
        {
            "content": "We have 0 CI testing for libvirt + uefi scenarios so while it was accepted as a feature a couple of releases ago, it's not validated in any meaningful way anywhere in our integration test system. So I wouldn't be surprised that there are bugs. Patches are welcome from those interested in making this work.", 
            "date_created": "2017-03-13 23:53:31.616222+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/471706", 
            "date_created": "2017-06-07 10:14:53.962532+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ]
}