{
    "status": "Fix Released", 
    "last_updated": "2014-04-17 08:55:22.323969+00:00", 
    "description": "The flavor extra spec API  extension (os-extra_specs) fails with \"HTTP 500\" when content-type application/xml is requested if the extra spec key contains a colon.\n\nFor example:\n\ncurl [endpoint]/flavors/[ID]/os-extra_specs -H \"Accept: application/json\" -H \"X-Auth-Token: $TOKEN\"\n{\"extra_specs\": {\"foo:bar\": \"999\"}}\n\ncurl -i [endpoint]/flavors/[ID]/os-extra_specs -H \"Accept: application/xml\" -H \"X-Auth-Token: $TOKEN\"\n{\"extra_specs\": {\"foo:bar\": \"999\"}}\nHTTP/1.1 500 Internal Server Error\n\nThe stack trace shows that the XML parser tries to interpret the \":\"  in key as if it would be a XML namespace, which fails, as the namespace is not valid:\n\n2013-08-19 13:08:14.374 27521 DEBUG nova.api.openstack.wsgi [req-afe0c3c8-e7d6-48c5-84f1-782260850e6b redacted redacted] Calling method <bound method FlavorExtraSpecsController.index of <nova.api.openstack.compute.contrib.flavorextraspecs.FlavorExtraSpecsController object at 0x2c01b90>> _process_stack /usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py:927\n2013-08-19 13:08:14.377 27521 ERROR nova.api.openstack [req-afe0c3c8-e7d6-48c5-84f1-782260850e6b redacted redacted] Caught error: Invalid tag name u'foo:bar'\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack Traceback (most recent call last):\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/__init__.py\", line 110, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return req.get_response(self.application)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     application, catch_exc_info=False)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/hp/middleware/cs_auth_token.py\", line 160, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return super(CsAuthProtocol, self).__call__(env, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/keystoneclient/middleware/auth_token.py\", line 461, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return self.app(env, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 903, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     content_type, body, accept)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 992, in _process_stack\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     self.default_serializers)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 603, in serialize\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     response.body = serializer.serialize(self.obj)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 590, in serialize\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     elem = self.make_tree(obj)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 618, in make_tree\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return self._serialize(None, obj, siblings, nsmap)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 573, in _serialize\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     self._serialize(elem, datum, nieces)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 554, in _serialize\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     elems = siblings[0].render(parent, obj, siblings[1:], nsmap)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 426, in render\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     elems.append((self._render(parent, datum, patches, nsmap), datum))\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 369, in _render\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     elem = etree.Element(tagname, nsmap=nsmap)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"lxml.etree.pyx\", line 2568, in lxml.etree.Element (src/lxml/lxml.etree.c:52878)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"apihelpers.pxi\", line 126, in lxml.etree._makeElement (src/lxml/lxml.etree.c:11497)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"apihelpers.pxi\", line 1542, in lxml.etree._tagValidOrRaise (src/lxml/lxml.etree.c:23956)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack ValueError: Invalid tag name u'foo:bar'\n\nThe issue affects tempest as well, as the test for this does not setup the extra spec using a colon in it, which is what the ComputeCapabilitiesFilter  in the scheduler expects.", 
    "tags": [
        "api"
    ], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1213927", 
    "owner": "https://api.launchpad.net/1.0/~guohliu", 
    "id": 1213927, 
    "index": 949, 
    "openned": "2013-08-19 13:38:47.687054+00:00", 
    "created": "2013-08-19 13:38:47.687054+00:00", 
    "title": "flavor extra spec api fails with XML content type if key contains a colon", 
    "comments": [
        {
            "content": "The flavor extra spec API  extension (os-extra_specs) fails with \"HTTP 500\" when content-type application/xml is requested if the extra spec key contains a colon.\n\nFor example:\n\ncurl [endpoint]/flavors/[ID]/os-extra_specs -H \"Accept: application/json\" -H \"X-Auth-Token: $TOKEN\"\n{\"extra_specs\": {\"foo:bar\": \"999\"}}\n\ncurl -i [endpoint]/flavors/[ID]/os-extra_specs -H \"Accept: application/xml\" -H \"X-Auth-Token: $TOKEN\"\n{\"extra_specs\": {\"foo:bar\": \"999\"}}\nHTTP/1.1 500 Internal Server Error\n\nThe stack trace shows that the XML parser tries to interpret the \":\"  in key as if it would be a XML namespace, which fails, as the namespace is not valid:\n\n2013-08-19 13:08:14.374 27521 DEBUG nova.api.openstack.wsgi [req-afe0c3c8-e7d6-48c5-84f1-782260850e6b redacted redacted] Calling method <bound method FlavorExtraSpecsController.index of <nova.api.openstack.compute.contrib.flavorextraspecs.FlavorExtraSpecsController object at 0x2c01b90>> _process_stack /usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py:927\n2013-08-19 13:08:14.377 27521 ERROR nova.api.openstack [req-afe0c3c8-e7d6-48c5-84f1-782260850e6b redacted redacted] Caught error: Invalid tag name u'foo:bar'\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack Traceback (most recent call last):\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/__init__.py\", line 110, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return req.get_response(self.application)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     application, catch_exc_info=False)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/hp/middleware/cs_auth_token.py\", line 160, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return super(CsAuthProtocol, self).__call__(env, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/keystoneclient/middleware/auth_token.py\", line 461, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return self.app(env, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 903, in __call__\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     content_type, body, accept)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 992, in _process_stack\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     self.default_serializers)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 603, in serialize\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     response.body = serializer.serialize(self.obj)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 590, in serialize\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     elem = self.make_tree(obj)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 618, in make_tree\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     return self._serialize(None, obj, siblings, nsmap)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 573, in _serialize\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     self._serialize(elem, datum, nieces)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 554, in _serialize\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     elems = siblings[0].render(parent, obj, siblings[1:], nsmap)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 426, in render\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     elems.append((self._render(parent, datum, patches, nsmap), datum))\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/xmlutil.py\", line 369, in _render\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack     elem = etree.Element(tagname, nsmap=nsmap)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"lxml.etree.pyx\", line 2568, in lxml.etree.Element (src/lxml/lxml.etree.c:52878)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"apihelpers.pxi\", line 126, in lxml.etree._makeElement (src/lxml/lxml.etree.c:11497)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack   File \"apihelpers.pxi\", line 1542, in lxml.etree._tagValidOrRaise (src/lxml/lxml.etree.c:23956)\n2013-08-19 13:08:14.377 27521 TRACE nova.api.openstack ValueError: Invalid tag name u'foo:bar'\n\nThe issue affects tempest as well, as the test for this does not setup the extra spec using a colon in it, which is what the ComputeCapabilitiesFilter  in the scheduler expects.", 
            "date_created": "2013-08-19 13:38:47.687054+00:00", 
            "author": "https://api.launchpad.net/1.0/~andrea-frittoli"
        }, 
        {
            "content": " Hi Andrea,\n\nI cannot reproduce this issue with your steps.\n\nREQ: curl -i http://192.168.0.106:8774/v2/33d982fa68a44289af94978544eb790d/flavors/1/os-extra_specs -X POST -H \"X-Auth-Project-Id: admin\" -H \"User-Agent: python-novaclient\" -H \"Content-Type: application/json\" -H \"Accept: application/json\" -H \"X-Auth-Token: 14126dcd29474f69b6283a563f5d0696\" -d '{\"extra_specs\": {\"foo:bar\": \"100\"}}'\n \nRESP: [200] CaseInsensitiveDict({'date': 'Mon, 19 Aug 2013 14:26:35 GMT', 'content-length': '35', 'content-type': 'application/json', 'x-compute-request-id': 'req-e4837622-40a9-4330-9720-f05618448ded'})\nRESP BODY: {\"extra_specs\": {\"foo:bar\": \"100\"}}\n \nroot@jake1:~# nova flavor-show 1\n+----------------------------+----------------------+\n| Property                   | Value                |\n+----------------------------+----------------------+\n| name                       | m1.tiny              |\n| ram                        | 512                  |\n| OS-FLV-DISABLED:disabled   | False                |\n| vcpus                      | 1                    |\n| extra_specs                | {u'foo:bar': u'100'} |\n| swap                       |                      |\n| os-flavor-access:is_public | True                 |\n| rxtx_factor                | 1.0                  |\n| OS-FLV-EXT-DATA:ephemeral  | 0                    |\n| disk                       | 1                    |\n| id                         | 1                    |\n+----------------------------+----------------------+\n\nWhich version are you using? I was using devstack from latest code. Thanks.", 
            "date_created": "2013-08-19 14:27:54.946268+00:00", 
            "author": "https://api.launchpad.net/1.0/~jake-liu"
        }, 
        {
            "content": "Oops, my fault, you are using XML while I was using Json.", 
            "date_created": "2013-08-19 14:29:30.526488+00:00", 
            "author": "https://api.launchpad.net/1.0/~jake-liu"
        }, 
        {
            "content": "Exactly, the issue is specific to XML only.", 
            "date_created": "2013-08-19 14:44:36.006013+00:00", 
            "author": "https://api.launchpad.net/1.0/~andrea-frittoli"
        }, 
        {
            "content": "capabilities has a similar problem. Should try to make the fix consistent (which probably means breaking backward compatibility, perhaps for the V3 API only) https://bugs.launchpad.net/nova/+bug/1205983", 
            "date_created": "2013-09-12 07:15:16.325172+00:00", 
            "author": "https://api.launchpad.net/1.0/~cyeoh-0"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/46718", 
            "date_created": "2013-09-16 11:44:55.885529+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I don't think there is a fix to make in tempest for this so once the problem is resolved on the nova side it should fix any test issues in tempest, right?", 
            "date_created": "2013-10-11 18:36:02.699078+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/46718\nCommitted: http://github.com/openstack/nova/commit/80b11279ba9853a9ab743ec6987c3229fff0b5e4\nSubmitter: Jenkins\nBranch:    master\n\ncommit 80b11279ba9853a9ab743ec6987c3229fff0b5e4\nAuthor: guohliu <email address hidden>\nDate:   Mon Sep 16 19:21:26 2013 +0800\n\n    Fixes Invalid tag name error when using k:v tagname\n    \n    This patch fixes the invalid tag name error when k:v type\n    tagname appears in response of api during xml serialization,\n    the tagname which contains colon couldn't be supported by\n    default since it is reserved by xml namespace, this patch\n    solve it by adding the k of k:v tagname into namespace.\n    \n    Fixes bug: #1213927\n    \n    Change-Id: Ib20efb378425cbe5deef45fbac561955cbe0f7bc\n", 
            "date_created": "2013-10-23 07:45:56.382234+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/53528", 
            "date_created": "2013-10-24 06:28:47.357208+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/53528\nCommitted: http://github.com/openstack/nova/commit/51cfd40f97e509d78c3981689ac2d81ed3ba6457\nSubmitter: Jenkins\nBranch:    stable/havana\n\ncommit 51cfd40f97e509d78c3981689ac2d81ed3ba6457\nAuthor: guohliu <email address hidden>\nDate:   Mon Sep 16 19:21:26 2013 +0800\n\n    Fixes Invalid tag name error when using k:v tagname\n    \n    This patch fixes the invalid tag name error when k:v type\n    tagname appears in response of api during xml serialization,\n    the tagname which contains colon couldn't be supported by\n    default since it is reserved by xml namespace, this patch\n    solve it by adding the k of k:v tagname into namespace.\n    \n    Fixes bug: #1213927\n    \n    Change-Id: Ib20efb378425cbe5deef45fbac561955cbe0f7bc\n    (cherry picked from commit 80b11279ba9853a9ab743ec6987c3229fff0b5e4)\n", 
            "date_created": "2013-11-18 07:09:12.359134+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-12-04 10:32:58.626946+00:00"
}