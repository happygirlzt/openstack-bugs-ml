{
    "status": "Invalid", 
    "last_updated": "2013-03-08 19:45:16.666228+00:00", 
    "description": "I've been going through the unit tests and auditing uses of 'except Exception' to see if they are buggy since they are often too liberal with the exceptions they catch and hide real bugs.\n\nThe test_live_migration_with_target_failure unit test is obfuscating either a real bug or a testing bug.\n\nRemoving the try/except block ends up with this confusing set of exceptions:\n\n======================================================================\nERROR: test_live_migration_with_target_failure (nova.tests.test_hypervapi.HyperVAPITestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/test_hypervapi.py\", line 299, in test_live_migration_with_target_failure\n    self._live_migration(dest_server)\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/test_hypervapi.py\", line 321, in _live_migration\n    dest_server, fake_post_method, fake_recover_method)\n  File \"/home/johannes/openstack/nova/trunk/nova/virt/hyperv/driver.py\", line 166, in live_migration\n    post_method, recover_method, block_migration)\n  File \"/home/johannes/openstack/nova/trunk/nova/virt/hyperv/livemigrationops.py\", line 131, in live_migration\n    recover_method(context, instance_ref, dest, block_migration)\n  File \"/usr/lib/python2.6/contextlib.py\", line 23, in __exit__\n    self.gen.next()\n  File \"/home/johannes/openstack/nova/trunk/nova/virt/hyperv/livemigrationops.py\", line 97, in live_migration\n    moniker='//' + dest + '/root/virtualization/v2')\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/mockproxy.py\", line 88, in newfunc\n    return self._get_next_ret_value(name, params)\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/mockproxy.py\", line 72, in _get_next_ret_value\n    return self._values[name][params][c]\nKeyError: '\\'(\\\\\\'(\\\\\\\\\\\\\\'()\\\\\\\\\\\\\\', \"{\\\\\\\\\\\\\\'moniker\\\\\\\\\\\\\\': \\\\\\\\\\\\\\'//nonexistingserver/root/virtualization/v2\\\\\\\\\\\\\\'}\")\\\\\\', \\\\\\'{}\\\\\\')\\'\\n-------------------- >> begin captured logging << --------------------\\nnova.virt.hyperv.vmops: INFO: Created disk for openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d\\nnova.virt.hyperv.vmops: INFO: Created nic for openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d \\nnova.virt.hyperv.vmops: INFO: Successfully changed vm state of openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d to Enabled\\nnova.virt.hyperv.vmops: INFO: Started VM openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d \\n--------------------- >> end captured logging << ---------------------'\n\n======================================================================\nERROR: test_live_migration_with_target_failure (nova.tests.test_hypervapi.HyperVAPITestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/test_hypervapi.py\", line 139, in tearDown\n    self._hypervutils.remove_vm(self._instance_data[\"name\"])\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/hypervutils.py\", line 176, in remove_vm\n    self._remove_vm(vm_name, self._conn, self._conn_cimv2)\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/hypervutils.py\", line 179, in _remove_vm\n    vm = self._get_vm(vm_name, conn)\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/hypervutils.py\", line 96, in _get_vm\n    return vml[0]\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/mockproxy.py\", line 103, in __getitem__\n    return self._get_next_ret_value('__getitem__', str(key))\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/mockproxy.py\", line 72, in _get_next_ret_value\n    return self._values[name][params][c]\nKeyError: \"'__getitem__'\\n-------------------- >> begin captured logging << --------------------\\nnova.virt.hyperv.vmops: INFO: Created disk for openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d\\nnova.virt.hyperv.vmops: INFO: Created nic for openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d \\nnova.virt.hyperv.vmops: INFO: Successfully changed vm state of openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d to Enabled\\nnova.virt.hyperv.vmops: INFO: Started VM openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d \\n--------------------- >> end captured logging << ---------------------\"\n\n\nThe 'except Exception' was catching the KeyError exception and treating it as a success, which is not the intended result. From the comments in the test, it appears that a pythoncom.com_error exception is raised, but it cannot be caught with assertRaises()? I don't know what that exception is (it's not referenced in any other code) and not sure why it can't be used with assertRaises().\n\nI spent some time trying to fix this test, but got mired in too much weird code to make much headway.", 
    "tags": [
        "hyperv"
    ], 
    "importance": "Medium", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1053540", 
    "owner": "None", 
    "id": 1053540, 
    "index": 3070, 
    "openned": "2012-09-20 17:48:24.843750+00:00", 
    "created": "2012-09-20 17:48:24.843750+00:00", 
    "title": "Hyper-V test_live_migration_with_target_failure unit test is broken", 
    "comments": [
        {
            "content": "I've been going through the unit tests and auditing uses of 'except Exception' to see if they are buggy since they are often too liberal with the exceptions they catch and hide real bugs.\n\nThe test_live_migration_with_target_failure unit test is obfuscating either a real bug or a testing bug.\n\nRemoving the try/except block ends up with this confusing set of exceptions:\n\n======================================================================\nERROR: test_live_migration_with_target_failure (nova.tests.test_hypervapi.HyperVAPITestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/test_hypervapi.py\", line 299, in test_live_migration_with_target_failure\n    self._live_migration(dest_server)\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/test_hypervapi.py\", line 321, in _live_migration\n    dest_server, fake_post_method, fake_recover_method)\n  File \"/home/johannes/openstack/nova/trunk/nova/virt/hyperv/driver.py\", line 166, in live_migration\n    post_method, recover_method, block_migration)\n  File \"/home/johannes/openstack/nova/trunk/nova/virt/hyperv/livemigrationops.py\", line 131, in live_migration\n    recover_method(context, instance_ref, dest, block_migration)\n  File \"/usr/lib/python2.6/contextlib.py\", line 23, in __exit__\n    self.gen.next()\n  File \"/home/johannes/openstack/nova/trunk/nova/virt/hyperv/livemigrationops.py\", line 97, in live_migration\n    moniker='//' + dest + '/root/virtualization/v2')\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/mockproxy.py\", line 88, in newfunc\n    return self._get_next_ret_value(name, params)\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/mockproxy.py\", line 72, in _get_next_ret_value\n    return self._values[name][params][c]\nKeyError: '\\'(\\\\\\'(\\\\\\\\\\\\\\'()\\\\\\\\\\\\\\', \"{\\\\\\\\\\\\\\'moniker\\\\\\\\\\\\\\': \\\\\\\\\\\\\\'//nonexistingserver/root/virtualization/v2\\\\\\\\\\\\\\'}\")\\\\\\', \\\\\\'{}\\\\\\')\\'\\n-------------------- >> begin captured logging << --------------------\\nnova.virt.hyperv.vmops: INFO: Created disk for openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d\\nnova.virt.hyperv.vmops: INFO: Created nic for openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d \\nnova.virt.hyperv.vmops: INFO: Successfully changed vm state of openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d to Enabled\\nnova.virt.hyperv.vmops: INFO: Started VM openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d \\n--------------------- >> end captured logging << ---------------------'\n\n======================================================================\nERROR: test_live_migration_with_target_failure (nova.tests.test_hypervapi.HyperVAPITestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/test_hypervapi.py\", line 139, in tearDown\n    self._hypervutils.remove_vm(self._instance_data[\"name\"])\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/hypervutils.py\", line 176, in remove_vm\n    self._remove_vm(vm_name, self._conn, self._conn_cimv2)\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/hypervutils.py\", line 179, in _remove_vm\n    vm = self._get_vm(vm_name, conn)\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/hypervutils.py\", line 96, in _get_vm\n    return vml[0]\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/mockproxy.py\", line 103, in __getitem__\n    return self._get_next_ret_value('__getitem__', str(key))\n  File \"/home/johannes/openstack/nova/trunk/nova/tests/hyperv/mockproxy.py\", line 72, in _get_next_ret_value\n    return self._values[name][params][c]\nKeyError: \"'__getitem__'\\n-------------------- >> begin captured logging << --------------------\\nnova.virt.hyperv.vmops: INFO: Created disk for openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d\\nnova.virt.hyperv.vmops: INFO: Created nic for openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d \\nnova.virt.hyperv.vmops: INFO: Successfully changed vm state of openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d to Enabled\\nnova.virt.hyperv.vmops: INFO: Started VM openstack_unit_test_vm_f2e6c57f-64d1-4a6c-823f-276a8bdcc16d \\n--------------------- >> end captured logging << ---------------------\"\n\n\nThe 'except Exception' was catching the KeyError exception and treating it as a success, which is not the intended result. From the comments in the test, it appears that a pythoncom.com_error exception is raised, but it cannot be caught with assertRaises()? I don't know what that exception is (it's not referenced in any other code) and not sure why it can't be used with assertRaises().\n\nI spent some time trying to fix this test, but got mired in too much weird code to make much headway.", 
            "date_created": "2012-09-20 17:48:24.843750+00:00", 
            "author": "https://api.launchpad.net/1.0/~johannes.erdfelt"
        }, 
        {
            "content": "This bug refers to the unit testing infrastructure used before the Grizzly refactory. \nIt doesn't apply to the current codebase. ", 
            "date_created": "2013-03-08 19:45:15.928316+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexpilotti"
        }
    ], 
    "closed": "2013-03-08 19:43:36.272563+00:00"
}