{
    "status": "Invalid", 
    "last_updated": "2016-10-12 14:44:03.489197+00:00", 
    "description": "The SRIO functionality in Mitaka seems broken, all configuration options we evaluated lead to\n\n\u00a0NovaException: Unexpected vif_type=binding_failed\n\nerrors, stack following.\nWe are currently using this code base, along with SRIOV configuration posted here\n\nNova SHA 611efbe77c712d9ac35904f659d28dd0f0c1b3ff # HEAD of \"stable/mitaka\" as of 08.09.2016\nNeutron SHA c73269fa480a8a955f440570fc2fa6c347e3bb3c # HEAD of \"stable/mitaka\" as of 08.09.2016\n\nStack :\n\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa] Traceback (most recent call last):\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/compute/manager.py\", line 2218, in _build_resources\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     yield resources\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/compute/manager.py\", line 2064, in _build_and_run_instance\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     block_device_info=block_device_info)\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2776, in spawn\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     write_to_disk=True)\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4729, in _get_guest_xml\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     context)\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4595, in _get_guest_config\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     flavor, virt_type, self._host)\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/virt/libvirt/vif.py\", line 447, in get_config\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     _(\"Unexpected vif_type=%s\") % vif_type)\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa] NovaException: Unexpected vif_type=binding_failed\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]\n\nInterestingly the nova resource tracker seem to be able to create a list of all available sriov devices and they show up correctly inside the database as pci_device table entries\n\n2016-09-27 16:13:52.175 10248 INFO nova.compute.resource_tracker [req-284a7832-3794-4597-b939-273ea75d45f7 - - - - -] Total usable vcpus: 32, total allocated vcpus: 0\n2016-09-27 16:13:52.175 10248 INFO nova.compute.resource_tracker [req-284a7832-3794-4597-b939-273ea75d45f7 - - - - -] Final resource view: name=compute01 phys_ram=257777\nMB used_ram=2048MB phys_disk=1935GB used_disk=2GB total_vcpus=32 used_vcpus=0 pci_stats=[PciDevicePool(count=15,numa_node=None,product_id='10ed',tags={dev_type='type-VF',physical_network='physnet1'},vendor\n_id='8086'), PciDevicePool(count=2,numa_node=None,product_id='10fb',tags={dev_type='type-PF',physical_network='physnet1'},vendor_id='8086')]\n\nAvailable ports inside DB:\n+-----------------+--------------+------------+-----------+----------+------------------+-----------+\n| compute_node_id | address      | product_id | vendor_id | dev_type | dev_id           | status    |\n+-----------------+--------------+------------+-----------+----------+------------------+-----------+\n|               5 | 0000:88:10.1 | 10ed       | 8086      | type-VF  | pci_0000_88_10_1 | available |\n|               5 | 0000:88:10.3 | 10ed       | 8086      | type-VF  | pci_0000_88_10_3 | available |\n|               5 | 0000:88:10.5 | 10ed       | 8086      | type-VF  | pci_0000_88_10_5 | available |\n|               5 | 0000:88:10.7 | 10ed       | 8086      | type-VF  | pci_0000_88_10_7 | available |\n|               5 | 0000:88:11.1 | 10ed       | 8086      | type-VF  | pci_0000_88_11_1 | available |\n|               5 | 0000:88:11.3 | 10ed       | 8086      | type-VF  | pci_0000_88_11_3 | available |\n|               5 | 0000:88:11.5 | 10ed       | 8086      | type-VF  | pci_0000_88_11_5 | available |\n|               5 | 0000:88:11.7 | 10ed       | 8086      | type-VF  | pci_0000_88_11_7 | available |\n|               5 | 0000:88:12.1 | 10ed       | 8086      | type-VF  | pci_0000_88_12_1 | available |\n|               5 | 0000:88:12.3 | 10ed       | 8086      | type-VF  | pci_0000_88_12_3 | available |\n|               5 | 0000:88:12.5 | 10ed       | 8086      | type-VF  | pci_0000_88_12_5 | available |\n|               5 | 0000:88:12.7 | 10ed       | 8086      | type-VF  | pci_0000_88_12_7 | available |\n|               5 | 0000:88:13.1 | 10ed       | 8086      | type-VF  | pci_0000_88_13_1 | available |\n|               5 | 0000:88:13.3 | 10ed       | 8086      | type-VF  | pci_0000_88_13_3 | available |\n|               5 | 0000:88:13.5 | 10ed       | 8086      | type-VF  | pci_0000_88_13_5 | available |\n|               5 | 0000:88:00.0 | 10fb       | 8086      | type-PF  | pci_0000_88_00_0 | available |\n|               5 | 0000:88:00.1 | 10fb       | 8086      | type-PF  | pci_0000_88_00_1 | available |\n|               2 | 0000:88:11.5 | 10ed       | 8086      | type-VF  | pci_0000_88_11_5 | available |\n|               2 | 0000:88:10.5 | 10ed       | 8086      | type-VF  | pci_0000_88_10_5 | available |\n|               2 | 0000:88:11.1 | 10ed       | 8086      | type-VF  | pci_0000_88_11_1 | available |\n|               2 | 0000:88:10.7 | 10ed       | 8086      | type-VF  | pci_0000_88_10_7 | available |\n|               2 | 0000:88:10.1 | 10ed       | 8086      | type-VF  | pci_0000_88_10_1 | available |\n|               2 | 0000:88:10.3 | 10ed       | 8086      | type-VF  | pci_0000_88_10_3 | available |\n|               2 | 0000:88:11.3 | 10ed       | 8086      | type-VF  | pci_0000_88_11_3 | available |\n+-----------------+--------------+------------+-----------+----------+------------------+-----------+\n\nAlso the NICs seem to be available just fine :\n\n# lspci -nnnn | grep 'Virtual Function'\n88:10.1 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:10.3 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:10.5 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:10.7 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:11.1 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:11.3 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:11.5 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:11.7 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:12.1 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:12.3 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:12.5 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:12.7 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:13.1 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:13.3 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:13.5 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n\nVFs:\nip link show dev p4p2\n11: p4p2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\n\u00a0\u00a0\u00a0\u00a0link/ether 14:02:ec:68:49:65 brd ff:ff:ff:ff:ff:ff\n\u00a0\u00a0\u00a0\u00a0vf 0 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 1 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 2 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 3 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 4 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 5 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 6 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 7 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 8 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 9 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 10 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 11 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 12 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 13 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\u00a0\u00a0\u00a0\u00a0vf 14 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\niommu:\n[    0.000000] ACPI: DMAR 000000007b7fd000 000332 (v01 INTEL  INTEL ID 00000001    ? 00000001)\n[    0.096499] dmar: Host address width 46\n[    0.096502] dmar: DRHD base: 0x000000fbffc000 flags: 0x0\n[    0.096508] dmar: IOMMU 0: reg_base_addr fbffc000 ver 1:0 cap d2078c106f0466 ecap f020df\n[    0.096510] dmar: DRHD base: 0x000000c7ffc000 flags: 0x1\n[    0.096515] dmar: IOMMU 1: reg_base_addr c7ffc000 ver 1:0 cap d2078c106f0466 ecap f020df\n[    0.096517] dmar: RMRR base: 0x0000007916d000 end: 0x0000007916ffff\n[    0.096518] dmar: RMRR base: 0x000000791eb000 end: 0x000000791eefff\n[    0.096520] dmar: RMRR base: 0x000000791db000 end: 0x000000791eafff\n[    0.096521] dmar: RMRR base: 0x000000791c8000 end: 0x000000791d8fff\n[    0.096523] dmar: RMRR base: 0x000000791d9000 end: 0x000000791dafff\n[    0.096524] dmar: RMRR base: 0x0000005a7a1000 end: 0x0000005a7e0fff\n[    1.488485] DMAR: No ATSR found\n\ngrep -i \"Enabled IRQ\" /var/log/dmesg\n[    0.097126] Enabled IRQ remapping in x2apic mode\n\nThe neutron-sriov-nic-agent seems to be only doing\n\n2016-09-27 18:15:01.951 14081 DEBUG neutron.agent.linux.utils [req-0b259e93-97fc-45fa-8d2f-d0e408cc08dd - - - - -] Running command: ['sudo', '/openstack/venvs/neutron-13.3.4/bin/neutron-rootwrap', '/etc/neutron/rootwrap.conf', 'ip', 'link', 'show'] create_process /openstack/venvs/neutron-13.3.4/lib/python2.7/site-packages/neutron/agent/linux/utils.py:84\n2016-09-27 18:15:02.003 14081 DEBUG neutron.agent.linux.utils [req-0b259e93-97fc-45fa-8d2f-d0e408cc08dd - - - - -] Exit code: 0 execute /openstack/venvs/neutron-13.3.4/lib/python2.7/site-packages/neutron/agent/linux/utils.py:142\n\nin a loop which maybe ok, considering that the code mostly container check conditions.\n\n/etc/nova/nova.conf:\n[DEFAULT]\npci_passthrough_whitelist = { \"address\":\"*:88:*\", \"physical_network\": \"physnet1\" }\n\n/etc/neutron/plugins/ml2/ml2_conf.ini:\n\u00a0[ml2]\n\u00a0type_drivers = flat,vlan,vxlan,local\n\u00a0tenant_network_types = vxlan,vlan\n\u00a0mechanism_drivers = linuxbridge,l2population,sriovnicswitch\n\u00a0extension_drivers = port_security\n\n\u00a0[m2_sriov]\n\u00a0supported_pci_vendor_devs = 8086:10ed\n\u00a0agent_required = True\n\n/etc/neutron/plugins/ml2/sriov_agent.ini\n\u00a0[DEFAULT]\n\u00a0verbose = True\n\u00a0debug = True\n\n\u00a0[securitygroup]\n\u00a0firewall_driver = neutron.agent.firewall.NoopFirewallDriver\n\n\u00a0[sriov_nic]\n\u00a0physical_device_mappings = physnet1:p4p2\n\u00a0exclude_devices =\n\n\u00a0[m2_sriov]\n\u00a0supported_pci_vendor_devs = 8086:10ed\n\u00a0agent_required = True\n\nSample network configuration:\n\nneutron net-create --provider:physical_network=physnet1 --provider:network_type=vlan --provider:segmentation_id=123 --shared INSIDE_NET\n\nneutron subnet-create INSIDE_NET 1.2.3.0/22 --name INSIDE_SUBNET1 --gateway=1.2.3.1 --allocation-pool start=1.2.3.11,end=1.2.6.254 --dns-nameservers list=true 8.8.8.8 8.8.4.4\n\nport_id=`neutron port-create INSIDE_NET --name sriov_port1 --binding:vnic_type direct --device_owner nova-compute | awk '/ id / { print $4 }'`\n\nAfterwards we tried to boot a simple instance with --nic port-id $port_id parameter, leading to the error above.", 
    "tags": [
        "sriov"
    ], 
    "importance": "Undecided", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1628301", 
    "owner": "None", 
    "id": 1628301, 
    "index": 7724, 
    "openned": "2016-09-27 22:16:45.772604+00:00", 
    "created": "2016-09-27 22:16:45.772604+00:00", 
    "title": "SR-IOV not working in Mitaka and Intel X series NIC", 
    "comments": [
        {
            "content": "\nThe SRIO functionality in Mitaka seems broken, all configuration options we evaluated lead to \n\n NovaException: Unexpected vif_type=binding_failed\n\nerrors, stack following.\nWe are currently using this code base, along with SRIOV configuration posted here\n\nNova SHA 611efbe77c712d9ac35904f659d28dd0f0c1b3ff # HEAD of \"stable/mitaka\" as of 08.09.2016\nNeutron SHA c73269fa480a8a955f440570fc2fa6c347e3bb3c # HEAD of \"stable/mitaka\" as of 08.09.2016\n\n\nStack :\n\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa] Traceback (most recent call last):\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/compute/manager.py\", line 2218, in _build_resources\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     yield resources\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/compute/manager.py\", line 2064, in _build_and_run_instance\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     block_device_info=block_device_info)\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2776, in spawn\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     write_to_disk=True)\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4729, in _get_guest_xml\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     context)\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4595, in _get_guest_config\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     flavor, virt_type, self._host)\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]   File \"/openstack/venvs/nova-13.3.4/lib/python2.7/site-packages/nova/virt/libvirt/vif.py\", line 447, in get_config\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]     _(\"Unexpected vif_type=%s\") % vif_type)\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa] NovaException: Unexpected vif_type=binding_failed\n2016-09-27 16:09:09.156 10248 ERROR nova.compute.manager [instance: 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa]\n\nInterestingly the nova resource tracker seem to be able to create a list of all available sriov devices and they show up correctly inside the database as pci_device table entries\n\n\n2016-09-27 16:13:52.175 10248 INFO nova.compute.resource_tracker [req-284a7832-3794-4597-b939-273ea75d45f7 - - - - -] Total usable vcpus: 32, total allocated vcpus: 0\n2016-09-27 16:13:52.175 10248 INFO nova.compute.resource_tracker [req-284a7832-3794-4597-b939-273ea75d45f7 - - - - -] Final resource view: name=compute01 phys_ram=257777\nMB used_ram=2048MB phys_disk=1935GB used_disk=2GB total_vcpus=32 used_vcpus=0 pci_stats=[PciDevicePool(count=15,numa_node=None,product_id='10ed',tags={dev_type='type-VF',physical_network='physnet1'},vendor\n_id='8086'), PciDevicePool(count=2,numa_node=None,product_id='10fb',tags={dev_type='type-PF',physical_network='physnet1'},vendor_id='8086')]\n\n\n\nAvailable ports inside DB:\n+-----------------+--------------+------------+-----------+----------+------------------+-----------+\n| compute_node_id | address      | product_id | vendor_id | dev_type | dev_id           | status    |\n+-----------------+--------------+------------+-----------+----------+------------------+-----------+\n|               5 | 0000:88:10.1 | 10ed       | 8086      | type-VF  | pci_0000_88_10_1 | available |\n|               5 | 0000:88:10.3 | 10ed       | 8086      | type-VF  | pci_0000_88_10_3 | available |\n|               5 | 0000:88:10.5 | 10ed       | 8086      | type-VF  | pci_0000_88_10_5 | available |\n|               5 | 0000:88:10.7 | 10ed       | 8086      | type-VF  | pci_0000_88_10_7 | available |\n|               5 | 0000:88:11.1 | 10ed       | 8086      | type-VF  | pci_0000_88_11_1 | available |\n|               5 | 0000:88:11.3 | 10ed       | 8086      | type-VF  | pci_0000_88_11_3 | available |\n|               5 | 0000:88:11.5 | 10ed       | 8086      | type-VF  | pci_0000_88_11_5 | available |\n|               5 | 0000:88:11.7 | 10ed       | 8086      | type-VF  | pci_0000_88_11_7 | available |\n|               5 | 0000:88:12.1 | 10ed       | 8086      | type-VF  | pci_0000_88_12_1 | available |\n|               5 | 0000:88:12.3 | 10ed       | 8086      | type-VF  | pci_0000_88_12_3 | available |\n|               5 | 0000:88:12.5 | 10ed       | 8086      | type-VF  | pci_0000_88_12_5 | available |\n|               5 | 0000:88:12.7 | 10ed       | 8086      | type-VF  | pci_0000_88_12_7 | available |\n|               5 | 0000:88:13.1 | 10ed       | 8086      | type-VF  | pci_0000_88_13_1 | available |\n|               5 | 0000:88:13.3 | 10ed       | 8086      | type-VF  | pci_0000_88_13_3 | available |\n|               5 | 0000:88:13.5 | 10ed       | 8086      | type-VF  | pci_0000_88_13_5 | available |\n|               5 | 0000:88:00.0 | 10fb       | 8086      | type-PF  | pci_0000_88_00_0 | available |\n|               5 | 0000:88:00.1 | 10fb       | 8086      | type-PF  | pci_0000_88_00_1 | available |\n|               2 | 0000:88:11.5 | 10ed       | 8086      | type-VF  | pci_0000_88_11_5 | available |\n|               2 | 0000:88:10.5 | 10ed       | 8086      | type-VF  | pci_0000_88_10_5 | available |\n|               2 | 0000:88:11.1 | 10ed       | 8086      | type-VF  | pci_0000_88_11_1 | available |\n|               2 | 0000:88:10.7 | 10ed       | 8086      | type-VF  | pci_0000_88_10_7 | available |\n|               2 | 0000:88:10.1 | 10ed       | 8086      | type-VF  | pci_0000_88_10_1 | available |\n|               2 | 0000:88:10.3 | 10ed       | 8086      | type-VF  | pci_0000_88_10_3 | available |\n|               2 | 0000:88:11.3 | 10ed       | 8086      | type-VF  | pci_0000_88_11_3 | available |\n+-----------------+--------------+------------+-----------+----------+------------------+-----------+\n\n\nAlso the NICs seem to be available just fine :\n\n\n# lspci -nnnn | grep 'Virtual Function'\n88:10.1 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:10.3 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:10.5 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:10.7 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:11.1 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:11.3 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:11.5 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:11.7 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:12.1 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:12.3 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:12.5 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:12.7 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:13.1 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:13.3 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n88:13.5 Ethernet controller [0200]: Intel Corporation 82599 Ethernet Controller Virtual Function [8086:10ed] (rev 01)\n\n\nVFs:\nip link show dev p4p2\n11: p4p2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\n    link/ether 14:02:ec:68:49:65 brd ff:ff:ff:ff:ff:ff\n    vf 0 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 1 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 2 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 3 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 4 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 5 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 6 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 7 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 8 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 9 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 10 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 11 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 12 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 13 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n    vf 14 MAC 00:00:00:00:00:00, spoof checking on, link-state auto\n\niommu:\n[    0.000000] ACPI: DMAR 000000007b7fd000 000332 (v01 INTEL  INTEL ID 00000001    ? 00000001)\n[    0.096499] dmar: Host address width 46\n[    0.096502] dmar: DRHD base: 0x000000fbffc000 flags: 0x0\n[    0.096508] dmar: IOMMU 0: reg_base_addr fbffc000 ver 1:0 cap d2078c106f0466 ecap f020df\n[    0.096510] dmar: DRHD base: 0x000000c7ffc000 flags: 0x1\n[    0.096515] dmar: IOMMU 1: reg_base_addr c7ffc000 ver 1:0 cap d2078c106f0466 ecap f020df\n[    0.096517] dmar: RMRR base: 0x0000007916d000 end: 0x0000007916ffff\n[    0.096518] dmar: RMRR base: 0x000000791eb000 end: 0x000000791eefff\n[    0.096520] dmar: RMRR base: 0x000000791db000 end: 0x000000791eafff\n[    0.096521] dmar: RMRR base: 0x000000791c8000 end: 0x000000791d8fff\n[    0.096523] dmar: RMRR base: 0x000000791d9000 end: 0x000000791dafff\n[    0.096524] dmar: RMRR base: 0x0000005a7a1000 end: 0x0000005a7e0fff\n[    1.488485] DMAR: No ATSR found\n\ngrep -i \"Enabled IRQ\" /var/log/dmesg\n[    0.097126] Enabled IRQ remapping in x2apic mode\n\n\nThe neutron-sriov-nic-agent seems to be only doing\n\n2016-09-27 18:15:01.951 14081 DEBUG neutron.agent.linux.utils [req-0b259e93-97fc-45fa-8d2f-d0e408cc08dd - - - - -] Running command: ['sudo', '/openstack/venvs/neutron-13.3.4/bin/neutron-rootwrap', '/etc/neutron/rootwrap.conf', 'ip', 'link', 'show'] create_process /openstack/venvs/neutron-13.3.4/lib/python2.7/site-packages/neutron/agent/linux/utils.py:84\n2016-09-27 18:15:02.003 14081 DEBUG neutron.agent.linux.utils [req-0b259e93-97fc-45fa-8d2f-d0e408cc08dd - - - - -] Exit code: 0 execute /openstack/venvs/neutron-13.3.4/lib/python2.7/site-packages/neutron/agent/linux/utils.py:142\n\nin a loop which maybe ok, considering that the code mostly container check conditions.\n\n\n\n/etc/neutron/plugins/ml2/ml2_conf.ini:\n\t[ml2]\n\ttype_drivers = flat,vlan,vxlan,local\n\ttenant_network_types = vxlan,vlan\n\tmechanism_drivers = linuxbridge,l2population,sriovnicswitch\n\textension_drivers = port_security\n\n\t[m2_sriov]\n\tsupported_pci_vendor_devs = 8086:10ed\n\tagent_required = True\n\n/etc/neutron/plugins/ml2/sriov_agent.ini\n\t[DEFAULT]\n\tverbose = True\n\tdebug = True\n\n\t[securitygroup]\n\tfirewall_driver = neutron.agent.firewall.NoopFirewallDriver\n\n\t[sriov_nic]\n\tphysical_device_mappings = physnet1:p4p2\n\texclude_devices =\n\n\t[m2_sriov]\n\tsupported_pci_vendor_devs = 8086:10ed\n\tagent_required = True\n\n\nSample network configuration:\n\nneutron net-create --provider:physical_network=physnet1 --provider:network_type=vlan --provider:segmentation_id=123 --shared INSIDE_NET\n\nneutron subnet-create INSIDE_NET 1.2.3.0/22 --name INSIDE_SUBNET1 --gateway=1.2.3.1 --allocation-pool start=1.2.3.11,end=1.2.6.254 --dns-nameservers list=true 8.8.8.8 8.8.4.4\n\nport_id=`neutron port-create INSIDE_NET --name sriov_port1 --binding:vnic_type direct --device_owner nova-compute | awk '/ id / { print $4 }'`\n\nAfterwards we tried to boot a simple instance with --nic port-id $port_id parameter, leading to the error above.", 
            "date_created": "2016-09-27 22:16:45.772604+00:00", 
            "author": "https://api.launchpad.net/1.0/~bjoern-teipel"
        }, 
        {
            "content": "", 
            "date_created": "2016-09-27 22:18:34.346379+00:00", 
            "author": "https://api.launchpad.net/1.0/~bjoern-teipel"
        }, 
        {
            "content": "Can we also get the neutron logs pertaining to 00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa ?", 
            "date_created": "2016-09-28 06:40:48.383483+00:00", 
            "author": "https://api.launchpad.net/1.0/~o-tony"
        }, 
        {
            "content": "+1 Tony's comment here, Nova is getting a binding failure from Neutron here. Neutron logs should say why that is happening, with a bit of luck.\n\nThat port create cmd looks wrong:\nneutron port-create INSIDE_NET --name sriov_port1 --binding:vnic_type direct --device_owner nova-compute\n\nWhy are you setting a device_owner on that? I though you are not meant to set that as a user. Its possible that is contributing towards the binding issues, but I am not sure. Its certainly not set in these examples:\nhttp://docs.openstack.org/mitaka/networking-guide/config-sriov.html\nIt might make no different, but I think its worth ruling that out.\n\nIt doesn't look like you have set the firewall_driver in the nova.conf to be the NoOpFirewall driver, unsure if that is required.\n\nThe whitelist seems very large:\npci_passthrough_whitelist = { \"address\":\"*:88:*\", \"physical_network\": \"physnet1\" }\nWe have made changes to what happens if a physical function is in that list, but I don't remember the details, its worth double checking that is correct.", 
            "date_created": "2016-09-28 08:44:32.265593+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "Oops, that link above should be:\nhttp://docs.openstack.org/mitaka/networking-guide/config-sriov.html#creating-instances-with-sr-iov-ports", 
            "date_created": "2016-09-28 08:45:33.025769+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "I tried with two ports one owned by nova-compute the other not, because I found conflicting documentation. In the end the result is the same.\n\nAlso I'm aware about the white listing, that it is large but that was on purpose for the test and no other PCI devices match it anyways.\n\nIn regards to neutron you actually don't see much other than the errors you see in nova already :\n\n\n/var/log/neutron/neutron-dhcp-agent.log:2016-09-27 16:09:09.010 7839 INFO neutron.agent.dhcp.agent [req-036aa2dc-6e30-4556-96e4-14d021d43702 9584b48c566a401aac1f26fc9c5c9b3d 860f390f22614eb9867f20e96f085ce5 - - -] Trigger reload_allocations for port admin_state_up=True, allowed_address_pairs=[], binding:host_id=compute01, binding:profile=pci_slot=0000:88:13.5, pci_vendor_info=8086:10ed, physical_network=physnet1, binding:vif_details=, binding:vif_type=binding_failed, binding:vnic_type=direct, created_at=2016-09-27T03:50:58, description=, device_id=00c620f0-1b5d-43c2-89f6-d5a5c4ce98fa, device_owner=compute:nova, extra_dhcp_opts=[], fixed_ips=[{u'subnet_id': u'c1f6e104-6161-4cc6-9bd4-179007bfeefe', u'ip_address': u'1.2.3.14'}], id=f79879e5-2102-4e55-ae79-379ab99b9afb, mac_address=fa:16:3e:8f:59:b0, name=sriov_port1, network_id=25c38495-ac57-4930-8a41-99cd05d04f78, port_security_enabled=True, security_groups=[u'03b751d0-abd3-4169-a7d3-ce1a8585f838'], status=DOWN, tenant_id=51aa45b3a177491a81d81236d9405525, updated_at=2016-09-27T20:09:08\n\nInterestingly I looked at the pci_device table while the build request was going on and I did see that the VF changed into allocated, right before it failed.\n", 
            "date_created": "2016-09-28 15:16:07.338751+00:00", 
            "author": "https://api.launchpad.net/1.0/~bjoern-teipel"
        }, 
        {
            "content": "Adding Neutron since I believe the issue is the neutron-sriov-nic-agent not building the port so that nova can allocate it for the instance.", 
            "date_created": "2016-09-30 15:35:19.247649+00:00", 
            "author": "https://api.launchpad.net/1.0/~bjoern-teipel"
        }, 
        {
            "content": "So where are l2 agent and neutron-server logs?", 
            "date_created": "2016-10-03 13:36:52.282284+00:00", 
            "author": "https://api.launchpad.net/1.0/~ihar-hrachyshka"
        }, 
        {
            "content": "As updated per comment #5 those messages were the only errors I saw outside of the 10 nova attempts to bind the port.\nI looked at it more yesterday and I think the issues seems related to the intel kernel driver. (https://bugs.launchpad.net/neutron/+bug/1614564) once I updated the driver I saw finally progress that the pci passthrough config made it into the libvirt.xml but libvirt failed with FLA_VF_INFO netlink errors which indicated it still is a kernel/driver/libvirt issue. I keep this issue updated with findings.", 
            "date_created": "2016-10-05 14:46:23.733131+00:00", 
            "author": "https://api.launchpad.net/1.0/~bjoern-teipel"
        }, 
        {
            "content": "marking incomplete without the requested neutron logs", 
            "date_created": "2016-10-12 10:47:56.947494+00:00", 
            "author": "https://api.launchpad.net/1.0/~john-davidge"
        }, 
        {
            "content": "Closing this out, after updating the ixgbe and ixgbevf driver I was able \"attach\" VF ports on nova instances.", 
            "date_created": "2016-10-12 14:28:09.856816+00:00", 
            "author": "https://api.launchpad.net/1.0/~bjoern-teipel"
        }, 
        {
            "content": "Thanks Bjoern.", 
            "date_created": "2016-10-12 14:44:01.954490+00:00", 
            "author": "https://api.launchpad.net/1.0/~john-davidge"
        }
    ], 
    "closed": "2016-10-12 14:33:02.221919+00:00"
}