{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:57:47.099507+00:00", 
    "description": "In nova cells environment, when try to force-delete an instance which is in 'active' state, the instance gets deleted successfully, but in nova-cells service in compute cell (n-cell-child), it throws the following error:\nInvalidRequestError: Object '<Instance at 0x7fc5fcf581d0>' is already attached to session '75' (this is '79')\n\nReproduction steps:\n1) Create instance.\n2) Wait until instance becomes 'active'.\n3) Try to force-delete the instance.\n$ nova force-delete <instance_id>\n\nFound this error in nova-cells service in compute cell (n-cell-child service):\n\n2014-10-15 01:59:36.742 ERROR nova.cells.messaging [req-7c1615ad-491d-4af8-88d7-ff83563ef429 admin admin] Error processing message locally: Object '<Ins\ntance at 0x7fc5fcf581d0>' is already attached to session '75' (this is '79')\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging Traceback (most recent call last):\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/cells/messaging.py\", line 199, in _process_locally\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     resp_value = self.msg_runner._process_message_locally(self)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/cells/messaging.py\", line 1293, in _process_message_locally\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     return fn(message, **message.method_kwargs)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/cells/messaging.py\", line 698, in run_compute_api_method\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     return fn(message.ctxt, *args, **method_info['method_kwargs'])\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 219, in wrapped\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     return func(self, context, target, *args, **kwargs)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 209, in inner\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     return function(self, context, instance, *args, **kwargs)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 190, in inner\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     return f(self, context, instance, *args, **kw)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 1836, in force_delete\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     self._delete_instance(context, instance)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 1790, in _delete_instance2014-10-15 01:59:36.742 TRACE nova.cells.messaging     task_state=task_states.DELETING)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 1622, in _delete\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     quotas.rollback()\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/oslo/utils/excutils.py\", line 82, in __exit__\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     six.reraise(self.type_, self.value, self.tb)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 1550, in _delete\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     instance.save()\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/db/sqlalchemy/models.py\", line 52, in save\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     super(NovaBase, self).save(session=session)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/models.py\", line 47, in save\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     session.add(self)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1399, in add\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     self._save_or_update_state(state)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1411, in _save_or_update_state\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     self._save_or_update_impl(state)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1667, in _save_or_update_impl\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     self._update_impl(state)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1661, in _update_impl\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     self._attach(state)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1749, in _attach\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     state.session_id, self.hash_key))\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging InvalidRequestError: Object '<Instance at 0x7fc5fcf581d0>' is already attached to session '75' (this is '79')\n\nNote: This issue occurs intermitently.", 
    "tags": [
        "cells"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1381425", 
    "owner": "https://api.launchpad.net/1.0/~rajesh-tailor", 
    "id": 1381425, 
    "index": 4083, 
    "openned": "2014-10-15 09:31:01.060491+00:00", 
    "created": "2014-10-15 09:31:01.060491+00:00", 
    "title": "nova cells, force-delete VM throws error even if VM gets deleted", 
    "comments": [
        {
            "content": "In nova cells environment, when try to force-delete an instance whose vm_state is 'active', the \ninstance gets deleted successfully, but in nova-cells service in compute cell (n-cell-child), it throws the following error:\nInvalidRequestError: Object '<Instance at 0x7fc5fcf581d0>' is already attached to session '75' (this is '79') \n\nReproduction steps:\n1) Create instance.\t\n2) Wait until instance becomes 'active'.\n3) Try to force-delete the instance.\n$ nova force-delete <instance_id>\n\nFound this error in nova-cells service in compute cell (n-cell-child service):\n\n2014-10-15 01:59:36.742 ERROR nova.cells.messaging [req-7c1615ad-491d-4af8-88d7-ff83563ef429 admin admin] Error processing message locally: Object '<Ins\ntance at 0x7fc5fcf581d0>' is already attached to session '75' (this is '79')\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging Traceback (most recent call last):\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/cells/messaging.py\", line 199, in _process_locally\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     resp_value = self.msg_runner._process_message_locally(self)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/cells/messaging.py\", line 1293, in _process_message_locally\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     return fn(message, **message.method_kwargs)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/cells/messaging.py\", line 698, in run_compute_api_method\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     return fn(message.ctxt, *args, **method_info['method_kwargs'])\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 219, in wrapped\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     return func(self, context, target, *args, **kwargs)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 209, in inner\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     return function(self, context, instance, *args, **kwargs)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 190, in inner\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     return f(self, context, instance, *args, **kw)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 1836, in force_delete\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     self._delete_instance(context, instance)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 1790, in _delete_instance2014-10-15 01:59:36.742 TRACE nova.cells.messaging     task_state=task_states.DELETING)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 1622, in _delete\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     quotas.rollback()\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/oslo/utils/excutils.py\", line 82, in __exit__\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     six.reraise(self.type_, self.value, self.tb)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/compute/api.py\", line 1550, in _delete\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     instance.save()\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/opt/stack/nova/nova/db/sqlalchemy/models.py\", line 52, in save\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     super(NovaBase, self).save(session=session)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/models.py\", line 47, in save\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     session.add(self)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1399, in add\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     self._save_or_update_state(state)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1411, in _save_or_update_state\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     self._save_or_update_impl(state)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1667, in _save_or_update_impl\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     self._update_impl(state)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1661, in _update_impl\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     self._attach(state)\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging   File \"/usr/lib/python2.7/dist-packages/sqlalchemy/orm/session.py\", line 1749, in _attach\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging     state.session_id, self.hash_key))\n2014-10-15 01:59:36.742 TRACE nova.cells.messaging InvalidRequestError: Object '<Instance at 0x7fc5fcf581d0>' is already attached to session '75' (this is '79')\n\nNote: This issue occurs intermitently.", 
            "date_created": "2014-10-15 09:31:01.060491+00:00", 
            "author": "https://api.launchpad.net/1.0/~rajesh-tailor"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/135202", 
            "date_created": "2014-11-18 09:49:28.535690+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/135202\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=580e8f6a5e8721b0535ea5fb1d414f6e9ede3070\nSubmitter: Jenkins\nBranch:    master\n\ncommit 580e8f6a5e8721b0535ea5fb1d414f6e9ede3070\nAuthor: Rajesh Tailor <email address hidden>\nDate:   Fri Oct 17 05:46:41 2014 -0700\n\n    Remove cell api overrides for force-delete\n    \n    The force_delete method of nova/compute/cells_api module is actually\n    not needed, as this method handle objects and is triggered when\n    force-delete api is used for instance deletion in cells environment.\n    \n    It actually causes a race condition with instance deletion as it\n    triggers 2 instance deletion from a compute cell for single\n    force-delete request.\n    \n    Modified delete-api implementation so that force-delete request\n    triggers single instance deletion call in cells environment.\n    \n    Change-Id: I812f27761fc4d4f64563d79f793c484d03aa641f\n    Closes-Bug: #1381425\n", 
            "date_created": "2015-08-12 03:09:50.110781+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-09-03 11:44:30.422389+00:00"
}