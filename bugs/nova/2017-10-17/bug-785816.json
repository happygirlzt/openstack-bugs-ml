{
    "status": "Fix Released", 
    "last_updated": "2011-09-22 13:26:52.973834+00:00", 
    "description": "2011-05-20 18:50:06,693 routes.middleware: Matched GET /servers/detail\n2011-05-20 18:50:06,693 routes.middleware: Route path: '/servers/detail', defaults: {'action': u'detail', 'controller': <nova.api.openstack.servers.ControllerV10 object at 0x1f71890>}\n2011-05-20 18:50:06,694 routes.middleware: Match dict: {'action': u'detail', 'controller': <nova.api.openstack.servers.ControllerV10 object at 0x1f71890>}\n2011-05-20 18:50:06,694 nova.wsgi: GET http://172.16.128.236:8774/v1.0/servers/detail?fresh=1305903006.65\n2011-05-20 18:50:06,833 nova.api.openstack: Caught error: Parent instance <Instance at 0x29a4ed0> is not bound to a Session; lazy load operation of attribute 'metadata' cannot proceed\n(nova.api.openstack): TRACE: Traceback (most recent call last):\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/__init__.py\", line 59, in __call__\n(nova.api.openstack): TRACE:     return req.get_response(self.application)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/request.py\", line 919, in get_response\n(nova.api.openstack): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/request.py\", line 887, in call_application\n(nova.api.openstack): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack): TRACE:     return resp(environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack): TRACE:     return resp(environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack): TRACE:     return resp(environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/routes/middleware.py\", line 131, in __call__\n(nova.api.openstack): TRACE:     response = self.app(environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack): TRACE:     return resp(environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 147, in __call__\n(nova.api.openstack): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 208, in call_func\n(nova.api.openstack): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/wsgi.py\", line 361, in __call__\n(nova.api.openstack): TRACE:     result = method(**arg_dict)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/servers.py\", line 76, in detail\n(nova.api.openstack): TRACE:     return self._items(req, is_detail=True)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/servers.py\", line 102, in _items\n(nova.api.openstack): TRACE:     for inst in limited_list]\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/views/servers.py\", line 45, in build\n(nova.api.openstack): TRACE:     server = self._build_detail(inst)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/views/servers.py\", line 86, in _build_detail\n(nova.api.openstack): TRACE:     for item in inst.get('metadata', []):\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/models.py\", line 77, in get\n(nova.api.openstack): TRACE:     return getattr(self, key, default)\n(nova.api.openstack): TRACE:   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/orm/attributes.py\", line 163, in __get__\n(nova.api.openstack): TRACE:     instance_dict(instance))\n(nova.api.openstack): TRACE:   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/orm/attributes.py\", line 383, in get\n(nova.api.openstack): TRACE:     value = callable_(passive=passive)\n(nova.api.openstack): TRACE:   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/orm/strategies.py\", line 595, in __call__\n(nova.api.openstack): TRACE:     (mapperutil.state_str(state), self.key)\n(nova.api.openstack): TRACE: DetachedInstanceError: Parent instance <Instance at 0x29a4ed0> is not bound to a Session; lazy load operation of attribute 'metadata' cannot proceed\n(nova.api.openstack): TRACE:", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 20, 
    "link": "https://bugs.launchpad.net/nova/+bug/785816", 
    "owner": "https://api.launchpad.net/1.0/~openstack-gd", 
    "id": 785816, 
    "index": 2410, 
    "openned": "2011-05-20 14:56:38.403393+00:00", 
    "created": "2011-05-20 14:56:38.403393+00:00", 
    "title": "lazy load operation of attribute 'metadata' cannot proceed ", 
    "comments": [
        {
            "content": "2011-05-20 18:50:06,693 routes.middleware: Matched GET /servers/detail\n2011-05-20 18:50:06,693 routes.middleware: Route path: '/servers/detail', defaults: {'action': u'detail', 'controller': <nova.api.openstack.servers.ControllerV10 object at 0x1f71890>}\n2011-05-20 18:50:06,694 routes.middleware: Match dict: {'action': u'detail', 'controller': <nova.api.openstack.servers.ControllerV10 object at 0x1f71890>}\n2011-05-20 18:50:06,694 nova.wsgi: GET http://172.16.128.236:8774/v1.0/servers/detail?fresh=1305903006.65\n2011-05-20 18:50:06,833 nova.api.openstack: Caught error: Parent instance <Instance at 0x29a4ed0> is not bound to a Session; lazy load operation of attribute 'metadata' cannot proceed\n(nova.api.openstack): TRACE: Traceback (most recent call last):\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/__init__.py\", line 59, in __call__\n(nova.api.openstack): TRACE:     return req.get_response(self.application)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/request.py\", line 919, in get_response\n(nova.api.openstack): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/request.py\", line 887, in call_application\n(nova.api.openstack): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack): TRACE:     return resp(environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack): TRACE:     return resp(environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack): TRACE:     return resp(environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/routes/middleware.py\", line 131, in __call__\n(nova.api.openstack): TRACE:     response = self.app(environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n(nova.api.openstack): TRACE:     return resp(environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 147, in __call__\n(nova.api.openstack): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 208, in call_func\n(nova.api.openstack): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/wsgi.py\", line 361, in __call__\n(nova.api.openstack): TRACE:     result = method(**arg_dict)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/servers.py\", line 76, in detail\n(nova.api.openstack): TRACE:     return self._items(req, is_detail=True)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/servers.py\", line 102, in _items\n(nova.api.openstack): TRACE:     for inst in limited_list]\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/views/servers.py\", line 45, in build\n(nova.api.openstack): TRACE:     server = self._build_detail(inst)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/views/servers.py\", line 86, in _build_detail\n(nova.api.openstack): TRACE:     for item in inst.get('metadata', []):\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/models.py\", line 77, in get\n(nova.api.openstack): TRACE:     return getattr(self, key, default)\n(nova.api.openstack): TRACE:   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/orm/attributes.py\", line 163, in __get__\n(nova.api.openstack): TRACE:     instance_dict(instance))\n(nova.api.openstack): TRACE:   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/orm/attributes.py\", line 383, in get\n(nova.api.openstack): TRACE:     value = callable_(passive=passive)\n(nova.api.openstack): TRACE:   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/orm/strategies.py\", line 595, in __call__\n(nova.api.openstack): TRACE:     (mapperutil.state_str(state), self.key)\n(nova.api.openstack): TRACE: DetachedInstanceError: Parent instance <Instance at 0x29a4ed0> is not bound to a Session; lazy load operation of attribute 'metadata' cannot proceed\n(nova.api.openstack): TRACE:", 
            "date_created": "2011-05-20 14:56:38.403393+00:00", 
            "author": "https://api.launchpad.net/1.0/~reldan"
        }, 
        {
            "content": "@Eldar: could you precise the conditions to reproduce the bug ? If you're working on this, could you set the bug status to 'In progress' ?", 
            "date_created": "2011-05-20 15:29:32.033902+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "It looks to be https://bugs.launchpad.net/nova/+bug/757293 error in OpenStack API in servers/detail", 
            "date_created": "2011-05-20 15:53:15.733026+00:00", 
            "author": "https://api.launchpad.net/1.0/~reldan"
        }, 
        {
            "content": "Hey Eldar, I'm getting this error a lot and before looking at it myself I'm curious if you've made any progress on this.  Thanks!", 
            "date_created": "2011-06-08 15:22:07.868319+00:00", 
            "author": "https://api.launchpad.net/1.0/~blamar"
        }, 
        {
            "content": "This should be an easy fix. Basically, the instance_ref returned from some function needs to have a session object bound to it. Look around line 102 in nova/api/openstack/servers.py for whereever the \"limited_list\" variable is populated. That function is returning a list of instance objects, and those instance objects need to have a session bound to them. To bind a session to the object, you just need to do:\n\nobject.session = some_session_object\n\nsome_session_object is typically an optional parameter to most of the sqlalchemy db api calls, and if None, the get_session() function returns a new session object.\n\nHope this helps...\n-jay", 
            "date_created": "2011-06-08 17:11:30.060848+00:00", 
            "author": "https://api.launchpad.net/1.0/~jaypipes"
        }, 
        {
            "content": "Hey Jay, I'm afraid it might not be quite as simple as that. This bug is intermittent, so I'm a bit baffled where the session is being lost as it works some times and doesn't work other times. ", 
            "date_created": "2011-06-08 20:27:38.761047+00:00", 
            "author": "https://api.launchpad.net/1.0/~blamar"
        }, 
        {
            "content": "Generally this is due to a missing joinedload statement in the query.  To get data from a related table, it must be loaded in the initial query, since our objects no longer have a sesssion attached when they return from the db layer.  So somehow the instance is getting retrieved from the db without the joinedload.  We had a similar issue at one point in the ec2_metadata server because it was using instance_get_all instead of instance_get which didn't have the proper joinedload.  Could this be a similar issue?\n\nVish\n\nOn Jun 8, 2011, at 1:27 PM, Brian Lamar wrote:\n\n> Hey Jay, I'm afraid it might not be quite as simple as that. This bug is\n> intermittent, so I'm a bit baffled where the session is being lost as it\n> works some times and doesn't work other times.\n> \n> -- \n> You received this bug notification because you are a member of Nova Bug\n> Team, which is subscribed to OpenStack Compute (nova).\n> https://bugs.launchpad.net/bugs/785816\n> \n> Title:\n>  lazy load operation of attribute 'metadata' cannot proceed\n> \n> Status in OpenStack Compute (Nova):\n>  In Progress\n> \n> Bug description:\n>  2011-05-20 18:50:06,693 routes.middleware: Matched GET /servers/detail\n>  2011-05-20 18:50:06,693 routes.middleware: Route path: '/servers/detail', defaults: {'action': u'detail', 'controller': <nova.api.openstack.servers.ControllerV10 object at 0x1f71890>}\n>  2011-05-20 18:50:06,694 routes.middleware: Match dict: {'action': u'detail', 'controller': <nova.api.openstack.servers.ControllerV10 object at 0x1f71890>}\n>  2011-05-20 18:50:06,694 nova.wsgi: GET http://172.16.128.236:8774/v1.0/servers/detail?fresh=1305903006.65\n>  2011-05-20 18:50:06,833 nova.api.openstack: Caught error: Parent instance <Instance at 0x29a4ed0> is not bound to a Session; lazy load operation of attribute 'metadata' cannot proceed\n>  (nova.api.openstack): TRACE: Traceback (most recent call last):\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/__init__.py\", line 59, in __call__\n>  (nova.api.openstack): TRACE:     return req.get_response(self.application)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/request.py\", line 919, in get_response\n>  (nova.api.openstack): TRACE:     application, catch_exc_info=False)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/request.py\", line 887, in call_application\n>  (nova.api.openstack): TRACE:     app_iter = application(self.environ, start_response)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n>  (nova.api.openstack): TRACE:     return resp(environ, start_response)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n>  (nova.api.openstack): TRACE:     return resp(environ, start_response)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n>  (nova.api.openstack): TRACE:     return resp(environ, start_response)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/routes/middleware.py\", line 131, in __call__\n>  (nova.api.openstack): TRACE:     response = self.app(environ, start_response)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 159, in __call__\n>  (nova.api.openstack): TRACE:     return resp(environ, start_response)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 147, in __call__\n>  (nova.api.openstack): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/webob/dec.py\", line 208, in call_func\n>  (nova.api.openstack): TRACE:     return self.func(req, *args, **kwargs)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/wsgi.py\", line 361, in __call__\n>  (nova.api.openstack): TRACE:     result = method(**arg_dict)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/servers.py\", line 76, in detail\n>  (nova.api.openstack): TRACE:     return self._items(req, is_detail=True)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/servers.py\", line 102, in _items\n>  (nova.api.openstack): TRACE:     for inst in limited_list]\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/views/servers.py\", line 45, in build\n>  (nova.api.openstack): TRACE:     server = self._build_detail(inst)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/api/openstack/views/servers.py\", line 86, in _build_detail\n>  (nova.api.openstack): TRACE:     for item in inst.get('metadata', []):\n>  (nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/site-packages/nova/db/sqlalchemy/models.py\", line 77, in get\n>  (nova.api.openstack): TRACE:     return getattr(self, key, default)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/orm/attributes.py\", line 163, in __get__\n>  (nova.api.openstack): TRACE:     instance_dict(instance))\n>  (nova.api.openstack): TRACE:   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/orm/attributes.py\", line 383, in get\n>  (nova.api.openstack): TRACE:     value = callable_(passive=passive)\n>  (nova.api.openstack): TRACE:   File \"/usr/lib64/python2.6/site-packages/sqlalchemy/orm/strategies.py\", line 595, in __call__\n>  (nova.api.openstack): TRACE:     (mapperutil.state_str(state), self.key)\n>  (nova.api.openstack): TRACE: DetachedInstanceError: Parent instance <Instance at 0x29a4ed0> is not bound to a Session; lazy load operation of attribute 'metadata' cannot proceed\n>  (nova.api.openstack): TRACE:\n\n", 
            "date_created": "2011-06-08 22:08:15+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Looks like instance_get_all() in sqlalchemy.api is using joinedload on metadata:\n\n\nreturn session.query(models.Instance).\\\n                   options(joinedload_all('fixed_ip.floating_ips')).\\\n                   options(joinedload('security_groups')).\\\n                   options(joinedload_all('fixed_ip.network')).\\\n                   options(joinedload('metadata')).\\\n                   options(joinedload('instance_type')).\\\n                   filter_by(deleted=can_read_deleted(context)).\\\n                   all()\n\n\nI have no idea where to even start looking for the root cause of this bug.", 
            "date_created": "2011-06-09 18:47:59.728470+00:00", 
            "author": "https://api.launchpad.net/1.0/~blamar"
        }
    ], 
    "closed": "2011-09-22 13:26:51.839805+00:00"
}