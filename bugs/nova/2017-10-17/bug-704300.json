{
    "status": "Fix Released", 
    "last_updated": "2011-04-15 08:33:08.975216+00:00", 
    "description": "When rebooting instance , firewall rules which have been applied to that instance are not restored. \n\nrevision: lp:nova 572\n \n\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): INFO [IUIZZRCSWQTQT9POCBHE admin admin] check_instance_lock: decorating: |<function reboot_instance at 0x2ef4c80>|\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): INFO [IUIZZRCSWQTQT9POCBHE admin admin] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x2edc250>| |<nova.context.RequestContext object at 0x42d0ed0>| |1|\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): DEBUG [IUIZZRCSWQTQT9POCBHE admin admin] instance 1: getting locked state from MainProcess (pid=11825) get_lock /opt/openstack/nova/nova/compute/manager.py:493\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): INFO [IUIZZRCSWQTQT9POCBHE admin admin] check_instance_lock: locked: |False|\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): INFO [IUIZZRCSWQTQT9POCBHE admin admin] check_instance_lock: admin: |True|\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): INFO [IUIZZRCSWQTQT9POCBHE admin admin] check_instance_lock: executing: |<function reboot_instance at 0x2ef4c80>|\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): AUDIT [IUIZZRCSWQTQT9POCBHE admin admin] Rebooting instance 1\nlibvir: QEMU error : Domain not found: no domain with matching name 'instance-00000001'\n(nova.root 2011.1-LOCALBRANCH:LOCALREVISION): INFO [N/A] new_filter: # Generated by iptables-save v1.4.4 on Tue Jan 18 16:38:10 2011\n*filter\n:INPUT ACCEPT [114826:171358827]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [12474:761315]\n:nova-fallback - [0:0]\n:nova-local - [0:0]\n-A nova-fallback -j DROP\n-A FORWARD -j nova-local\n-A FORWARD -o br100 -j ACCEPT\n-A FORWARD -i br100 -j ACCEPT\nCOMMIT\n# Completed on Tue Jan 18 16:38:10 2011\n\n(nova.root 2011.1-LOCALBRANCH:LOCALREVISION): INFO [N/A] new_filter: # Generated by ip6tables-save v1.4.4 on Tue Jan 18 16:38:10 2011\n*filter\n:INPUT ACCEPT [8:768]\n:FORWARD ACCEPT [11:912]\n:OUTPUT ACCEPT [12:748]\n:nova-fallback - [0:0]\n:nova-local - [0:0]\n-A nova-fallback -j DROP\n-A FORWARD -j nova-local\nCOMMIT\n# Completed on Tue Jan 18 16:38:10 2011\n\n(nova.virt.libvirt_conn 2011.1-LOCALBRANCH:LOCALREVISION): DEBUG [N/A] instance instance-00000001: starting toXML method from MainProcess (pid=11825) to_xml /opt/openstack/nova/nova/virt/libvirt_conn.py:647\n(nova.virt.libvirt_conn 2011.1-LOCALBRANCH:LOCALREVISION): DEBUG [N/A] instance instance-00000001: starting toXML method from MainProcess (pid=11825) to_xml /opt/openstack/nova/nova/virt/libvirt_conn.py:650\n(nova.virt.libvirt_conn 2011.1-LOCALBRANCH:LOCALREVISION): DEBUG [N/A] instance instance-00000001: finished toXML method from MainProcess (pid=11825) to_xml /opt/openstack/nova/nova/virt/libvirt_conn.py:717\n(nova.virt.libvirt_conn 2011.1-LOCALBRANCH:LOCALREVISION): DEBUG [N/A] instance instance-00000001: rebooted from MainProcess (pid=11825) _wait_for_reboot /opt/openstack/nova/nova/virt/libvirt_conn.py:317", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/704300", 
    "owner": "https://api.launchpad.net/1.0/~tpatil", 
    "id": 704300, 
    "index": 330, 
    "openned": "2011-01-18 07:49:10.134560+00:00", 
    "created": "2011-01-18 07:49:10.134560+00:00", 
    "title": "reboot instance does not restore security group rules", 
    "comments": [
        {
            "content": "When rebooting instance , firewall rules which have been applied to that instance are not restored. \n\nrevision: lp:nova 572\n \n\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): INFO [IUIZZRCSWQTQT9POCBHE admin admin] check_instance_lock: decorating: |<function reboot_instance at 0x2ef4c80>|\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): INFO [IUIZZRCSWQTQT9POCBHE admin admin] check_instance_lock: arguments: |<nova.compute.manager.ComputeManager object at 0x2edc250>| |<nova.context.RequestContext object at 0x42d0ed0>| |1|\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): DEBUG [IUIZZRCSWQTQT9POCBHE admin admin] instance 1: getting locked state from MainProcess (pid=11825) get_lock /opt/openstack/nova/nova/compute/manager.py:493\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): INFO [IUIZZRCSWQTQT9POCBHE admin admin] check_instance_lock: locked: |False|\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): INFO [IUIZZRCSWQTQT9POCBHE admin admin] check_instance_lock: admin: |True|\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): INFO [IUIZZRCSWQTQT9POCBHE admin admin] check_instance_lock: executing: |<function reboot_instance at 0x2ef4c80>|\n(nova.compute.manager 2011.1-LOCALBRANCH:LOCALREVISION): AUDIT [IUIZZRCSWQTQT9POCBHE admin admin] Rebooting instance 1\nlibvir: QEMU error : Domain not found: no domain with matching name 'instance-00000001'\n(nova.root 2011.1-LOCALBRANCH:LOCALREVISION): INFO [N/A] new_filter: # Generated by iptables-save v1.4.4 on Tue Jan 18 16:38:10 2011\n*filter\n:INPUT ACCEPT [114826:171358827]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [12474:761315]\n:nova-fallback - [0:0]\n:nova-local - [0:0]\n-A nova-fallback -j DROP\n-A FORWARD -j nova-local\n-A FORWARD -o br100 -j ACCEPT\n-A FORWARD -i br100 -j ACCEPT\nCOMMIT\n# Completed on Tue Jan 18 16:38:10 2011\n\n(nova.root 2011.1-LOCALBRANCH:LOCALREVISION): INFO [N/A] new_filter: # Generated by ip6tables-save v1.4.4 on Tue Jan 18 16:38:10 2011\n*filter\n:INPUT ACCEPT [8:768]\n:FORWARD ACCEPT [11:912]\n:OUTPUT ACCEPT [12:748]\n:nova-fallback - [0:0]\n:nova-local - [0:0]\n-A nova-fallback -j DROP\n-A FORWARD -j nova-local\nCOMMIT\n# Completed on Tue Jan 18 16:38:10 2011\n\n(nova.virt.libvirt_conn 2011.1-LOCALBRANCH:LOCALREVISION): DEBUG [N/A] instance instance-00000001: starting toXML method from MainProcess (pid=11825) to_xml /opt/openstack/nova/nova/virt/libvirt_conn.py:647\n(nova.virt.libvirt_conn 2011.1-LOCALBRANCH:LOCALREVISION): DEBUG [N/A] instance instance-00000001: starting toXML method from MainProcess (pid=11825) to_xml /opt/openstack/nova/nova/virt/libvirt_conn.py:650\n(nova.virt.libvirt_conn 2011.1-LOCALBRANCH:LOCALREVISION): DEBUG [N/A] instance instance-00000001: finished toXML method from MainProcess (pid=11825) to_xml /opt/openstack/nova/nova/virt/libvirt_conn.py:717\n(nova.virt.libvirt_conn 2011.1-LOCALBRANCH:LOCALREVISION): DEBUG [N/A] instance instance-00000001: rebooted from MainProcess (pid=11825) _wait_for_reboot /opt/openstack/nova/nova/virt/libvirt_conn.py:317", 
            "date_created": "2011-01-18 07:49:10.134560+00:00", 
            "author": "https://api.launchpad.net/1.0/~iida-koji"
        }, 
        {
            "content": "That's a bit ancient revision, lots of changes have happened in that area since. Any chance you could test and reproduce with the released Bexar, or with the current Cactus trunk ?", 
            "date_created": "2011-02-23 13:42:56.638493+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Yes, I got same result with rev 728.\n\nlibvirt_conn.py:reboot()\n----\n    def reboot(self, instance):\n        self.destroy(instance, False)\n        xml = self.to_xml(instance)\n        self._conn.createXML(xml, 0)\n        timer = utils.LoopingCall(f=None)\n----\n\nself.destroy() called from reboot() deletes iptables rule of this instance. But reboot() function does not re-create iptables rule for this instance.\nThat is why iptables rules are disappeared when instance is rebooted.\n\n\nHere are output of iptables-save before and after euca-reboot-instance.\n\nroot@usv401:/opt/openstack# euca-run-instances -g secgrp1 -k test -t m1.tiny ami-tiny\nRESERVATION     r-8xkekwbe      admin   secgrp1\nINSTANCE        i-00000001      ami-tiny                        scheduling      test (admin, None)      0               m1.tiny 2011-02-24T07:04:48Z    unknown zone\nroot@usv401:/opt/openstack# euca-describe-instances\nRESERVATION     r-8xkekwbe      admin   secgrp1\nINSTANCE        i-00000001      ami-tiny        10.0.0.3        10.0.0.3        running test (admin, usv401)    0               m1.tiny 2011-02-24T07:04:48Z    nova\nroot@usv401:/opt/openstack#  iptables-save\n# Generated by iptables-save v1.4.4 on Thu Feb 24 16:06:42 2011\n*nat\n:PREROUTING ACCEPT [4:939]\n:POSTROUTING ACCEPT [25:1500]\n:OUTPUT ACCEPT [27:2186]\n:SNATTING - [0:0]\n-A PREROUTING -d 192.168.6.41/32 -p udp -m udp --dport 2000 -j DNAT --to-destination 10.0.0.2:1194\n-A PREROUTING -d 169.254.169.254/32 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.6.41:8773\n-A POSTROUTING -s 10.0.0.0/8 -d 10.0.0.0/8 -j ACCEPT\n-A POSTROUTING -s 10.0.0.0/8 -d 10.128.0.0/24 -j ACCEPT\n-A POSTROUTING -j SNATTING\n-A SNATTING -s 10.0.0.0/8 -j SNAT --to-source 192.168.6.41\nCOMMIT\n# Completed on Thu Feb 24 16:06:42 2011\n# Generated by iptables-save v1.4.4 on Thu Feb 24 16:06:42 2011\n*filter\n:INPUT ACCEPT [28696:167045505]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [28707:167053799]\n:nova-fallback - [0:0]\n:nova-inst-1 - [0:0]\n:nova-local - [0:0]\n:nova-sg-2 - [0:0]\n-A FORWARD -j nova-local\n-A FORWARD -o br100 -j ACCEPT\n-A FORWARD -i br100 -j ACCEPT\n-A FORWARD -d 10.0.0.2/32 -p udp -m udp --dport 1194 -j ACCEPT\n-A OUTPUT -j nova-local\n-A nova-fallback -j DROP\n-A nova-inst-1 -m state --state INVALID -j DROP\n-A nova-inst-1 -m state --state RELATED,ESTABLISHED -j ACCEPT\n-A nova-inst-1 -j nova-sg-2\n-A nova-inst-1 -s 10.0.0.1/32 -p udp -m udp --sport 67 --dport 68 -j ACCEPT\n-A nova-inst-1 -s 10.0.0.0/27 -j ACCEPT\n-A nova-inst-1 -j nova-fallback\n-A nova-local -d 10.0.0.3/32 -j nova-inst-1\nCOMMIT\n# Completed on Thu Feb 24 16:06:42 2011\nroot@usv401:/opt/openstack# euca-reboot-instances i-00000001\nINSTANCE        i-00000001\nroot@usv401:/opt/openstack# euca-describe-instances\nRESERVATION     r-8xkekwbe      admin   secgrp1\nINSTANCE        i-00000001      ami-tiny        10.0.0.3        10.0.0.3        running test (admin, usv401)    0               m1.tiny 2011-02-24T07:04:48Z    nova\nroot@usv401:/opt/openstack# iptables-save\n# Generated by iptables-save v1.4.4 on Thu Feb 24 16:08:04 2011\n*nat\n:PREROUTING ACCEPT [5:1247]\n:POSTROUTING ACCEPT [30:1800]\n:OUTPUT ACCEPT [33:2829]\n:SNATTING - [0:0]\n-A PREROUTING -d 192.168.6.41/32 -p udp -m udp --dport 2000 -j DNAT --to-destination 10.0.0.2:1194\n-A PREROUTING -d 169.254.169.254/32 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.6.41:8773\n-A POSTROUTING -s 10.0.0.0/8 -d 10.0.0.0/8 -j ACCEPT\n-A POSTROUTING -s 10.0.0.0/8 -d 10.128.0.0/24 -j ACCEPT\n-A POSTROUTING -j SNATTING\n-A SNATTING -s 10.0.0.0/8 -j SNAT --to-source 192.168.6.41\nCOMMIT\n# Completed on Thu Feb 24 16:08:04 2011\n# Generated by iptables-save v1.4.4 on Thu Feb 24 16:08:04 2011\n*filter\n:INPUT ACCEPT [7621:502667]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [7638:507563]\n:nova-fallback - [0:0]\n:nova-local - [0:0]\n-A FORWARD -j nova-local\n-A FORWARD -o br100 -j ACCEPT\n-A FORWARD -i br100 -j ACCEPT\n-A FORWARD -d 10.0.0.2/32 -p udp -m udp --dport 1194 -j ACCEPT\n-A OUTPUT -j nova-local\n-A nova-fallback -j DROP\nCOMMIT\n# Completed on Thu Feb 24 16:08:04 2011\n\n\n\n\n", 
            "date_created": "2011-02-24 08:01:57.970981+00:00", 
            "author": "https://api.launchpad.net/1.0/~iida-koji"
        }
    ], 
    "closed": "2011-04-15 08:33:07.489557+00:00"
}