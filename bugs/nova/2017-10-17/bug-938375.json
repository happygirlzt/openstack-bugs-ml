{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:33:47.432987+00:00", 
    "description": "With a new account in keystone upon the first nova request a 500 is retuned. Account creation through the shim succeeds, but the actual request fails. All subsequent requests are fine.\n\nit seems that in the _build_mc_key method there is a string join, if one of the components is unicode the whole string becomes unicode.\n\n(nova.api.openstack): TRACE: \n(nova.api.openstack): TRACE: Traceback (most recent call last):\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/api/openstack/__init__.py\", line 64, in __call__\n(nova.api.openstack): TRACE:     return req.get_response(self.application)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/request.py\", line 1053, in get_response\n(nova.api.openstack): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/request.py\", line 1022, in call_application\n(nova.api.openstack): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/keystone/middleware/auth_token.py\", line 212, in __call__\n(nova.api.openstack): TRACE:     return self._forward_request(env, start_response, proxy_headers)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/keystone/middleware/auth_token.py\", line 344, in _forward_request\n(nova.api.openstack): TRACE:     return self.app(env, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 147, in __call__\n(nova.api.openstack): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 208, in call_func\n(nova.api.openstack): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/keystone/middleware/nova_auth_token.py\", line 73, in __call__\n(nova.api.openstack): TRACE:     if user_ref.is_admin() != is_admin:\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 134, in is_admin\n(nova.api.openstack): TRACE:     return AuthManager().is_admin(self)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 376, in is_admin\n(nova.api.openstack): TRACE:     if self.is_superuser(user):\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 362, in is_superuser\n(nova.api.openstack): TRACE:     if self.has_role(user, role):\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 433, in has_role\n(nova.api.openstack): TRACE:     None)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 394, in _has_role\n(nova.api.openstack): TRACE:     rslt = self.mc.get(mc_key)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/memcache.py\", line 698, in get\n(nova.api.openstack): TRACE:     check_key(key)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/memcache.py\", line 985, in check_key\n(nova.api.openstack): TRACE:     raise Client.MemcachedStringEncodingError, (\"Keys must be str()'s, not \"\n(nova.api.openstack): TRACE: MemcachedStringEncodingError: Keys must be str()'s, not unicode.  Convert your unicode strings using mystring.encode(charset)!\n(nova.api.openstack): TRACE:", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/938375", 
    "owner": "https://api.launchpad.net/1.0/~russell-sim", 
    "id": 938375, 
    "index": 3871, 
    "openned": "2012-02-22 03:34:11.699815+00:00", 
    "created": "2012-02-22 03:34:11.699815+00:00", 
    "title": "enabling the keystone shim causes memcache error on account creation", 
    "comments": [
        {
            "content": "With a new account in keystone upon the first nova request a 500 is retuned. Account creation through the shim succeeds, but the actual request fails. All subsequent requests are fine.\n\nit seems that in the _build_mc_key method there is a string join, if one of the components is unicode the whole string becomes unicode.\n\n(nova.api.openstack): TRACE: \n(nova.api.openstack): TRACE: Traceback (most recent call last):\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/api/openstack/__init__.py\", line 64, in __call__\n(nova.api.openstack): TRACE:     return req.get_response(self.application)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/request.py\", line 1053, in get_response\n(nova.api.openstack): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/request.py\", line 1022, in call_application\n(nova.api.openstack): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/keystone/middleware/auth_token.py\", line 212, in __call__\n(nova.api.openstack): TRACE:     return self._forward_request(env, start_response, proxy_headers)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/keystone/middleware/auth_token.py\", line 344, in _forward_request\n(nova.api.openstack): TRACE:     return self.app(env, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 147, in __call__\n(nova.api.openstack): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 208, in call_func\n(nova.api.openstack): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/keystone/middleware/nova_auth_token.py\", line 73, in __call__\n(nova.api.openstack): TRACE:     if user_ref.is_admin() != is_admin:\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 134, in is_admin\n(nova.api.openstack): TRACE:     return AuthManager().is_admin(self)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 376, in is_admin\n(nova.api.openstack): TRACE:     if self.is_superuser(user):\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 362, in is_superuser\n(nova.api.openstack): TRACE:     if self.has_role(user, role):\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 433, in has_role\n(nova.api.openstack): TRACE:     None)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 394, in _has_role\n(nova.api.openstack): TRACE:     rslt = self.mc.get(mc_key)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/memcache.py\", line 698, in get\n(nova.api.openstack): TRACE:     check_key(key)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/memcache.py\", line 985, in check_key\n(nova.api.openstack): TRACE:     raise Client.MemcachedStringEncodingError, (\"Keys must be str()'s, not \"\n(nova.api.openstack): TRACE: MemcachedStringEncodingError: Keys must be str()'s, not unicode.  Convert your unicode strings using mystring.encode(charset)!\n(nova.api.openstack): TRACE:", 
            "date_created": "2012-02-22 03:34:11.699815+00:00", 
            "author": "https://api.launchpad.net/1.0/~russell-sim"
        }, 
        {
            "content": "this affects the diablo release, i have added a fix to gerrit https://review.openstack.org/#change,4380", 
            "date_created": "2012-02-22 04:56:31.657512+00:00", 
            "author": "https://api.launchpad.net/1.0/~russell-sim"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/4483", 
            "date_created": "2012-02-24 02:52:23.815674+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/4483\nCommitted: http://github.com/openstack/nova/commit/5a080e5b46436e82472687d370c0fd72e750baf8\nSubmitter: Jenkins\nBranch:    master\n\ncommit 5a080e5b46436e82472687d370c0fd72e750baf8\nAuthor: Russell Sim <email address hidden>\nDate:   Fri Feb 24 13:50:34 2012 +1100\n\n    fix unicode triggered failure in AuthManager\n    \n    * Always return a string from AuthManager._build_mc_key()\n    * Fixes bug 938375\n    \n    Change-Id: Iffceffab8ae62830202de07e3237230dab4e5a60\n", 
            "date_created": "2012-02-25 01:34:28.336615+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-02-29 10:36:52.710744+00:00"
}