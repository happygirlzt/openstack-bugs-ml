{
    "status": "Fix Released", 
    "last_updated": "2014-10-16 08:40:15.279868+00:00", 
    "description": "Steps are as following:\n1) Create one VM\n2) Attach volume to the VM\n3) pause the VM\n4) detach the volume\n5) unpause the VM\n6) re-attch the VM to same device, nova compute throw exception\n\n2013-10-20 23:21:22.520 DEBUG amqp [-] Channel open from (pid=19728) _open_ok /usr/local/lib/python2.7/dist-packages/amqp-1.0.12-py2.7.egg/amqp/channel.py:420\n2013-10-20 23:21:22.520 ERROR nova.openstack.common.rpc.amqp [req-5f0d786e-1273-4611-b0a5-a787754c6bc8 admin admin] Exception during message handling\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 90, in wrapped\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 73, in wrapped\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 244, in decorated_function\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     pass\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 230, in decorated_function\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 272, in decorated_function\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 259, in decorated_function\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 3649, in attach_volume\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     context, instance, mountpoint)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 3644, in attach_volume\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     mountpoint, instance)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 3690, in _attach_volume\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     connector)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 3680, in _attach_volume\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     encryption=encryption)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1107, in attach_volume\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     raise exception.DeviceIsBusy(device=disk_dev)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp DeviceIsBusy: The supplied device (vdb) is busy.\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp \n^C2013-10-20 23:21:24.871 INFO nova.openstack.common.service [-] Caught SIGINT, exiting", 
    "tags": [
        "icehouse-backport-potential", 
        "in-stable-icehouse", 
        "libvirt", 
        "volumes"
    ], 
    "importance": "Low", 
    "heat": 28, 
    "link": "https://bugs.launchpad.net/nova/+bug/1242366", 
    "owner": "https://api.launchpad.net/1.0/~thang-pham", 
    "id": 1242366, 
    "index": 1043, 
    "openned": "2013-10-20 15:23:42.906826+00:00", 
    "created": "2013-10-20 15:23:42.906826+00:00", 
    "title": "volume attach failed if attach again to an pause to active VM", 
    "comments": [
        {
            "content": "Steps are as following:\n1) Create one VM\n2) Attach volume to the VM\n3) pause the VM\n4) detach the volume\n5) unpause the VM\n6) re-attch the VM to same device, nova compute throw exception\n\n2013-10-20 23:21:22.520 DEBUG amqp [-] Channel open from (pid=19728) _open_ok /usr/local/lib/python2.7/dist-packages/amqp-1.0.12-py2.7.egg/amqp/channel.py:420\n2013-10-20 23:21:22.520 ERROR nova.openstack.common.rpc.amqp [req-5f0d786e-1273-4611-b0a5-a787754c6bc8 admin admin] Exception during message handling\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 90, in wrapped\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     payload)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 73, in wrapped\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 244, in decorated_function\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     pass\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 230, in decorated_function\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 272, in decorated_function\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     e, sys.exc_info())\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 259, in decorated_function\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 3649, in attach_volume\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     context, instance, mountpoint)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 3644, in attach_volume\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     mountpoint, instance)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 3690, in _attach_volume\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     connector)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 3680, in _attach_volume\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     encryption=encryption)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1107, in attach_volume\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp     raise exception.DeviceIsBusy(device=disk_dev)\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp DeviceIsBusy: The supplied device (vdb) is busy.\n2013-10-20 23:21:22.520 TRACE nova.openstack.common.rpc.amqp \n^C2013-10-20 23:21:24.871 INFO nova.openstack.common.service [-] Caught SIGINT, exiting", 
            "date_created": "2013-10-20 15:23:42.906826+00:00", 
            "author": "https://api.launchpad.net/1.0/~jay-lau-513"
        }, 
        {
            "content": "I do not believe this bug can be easily fixed.\n\nThe reason you are getting the DeviceIsBusy exception is because Linux sysfs did not receive the hotplug event (uevent) when the volume/device was detached.  Since the instance was paused, no uevents could be created and so, Linux still believes the device is still there.  When cinder attempts to hotplug the volume, the device name that nova chooses is found using by a database lookup of which devices are attached to the instance and selecting the next available device name to use.  The device nova picks is /dev/vdb, the same one Linux sysfs believes is still attached to it.  Therefore, device hotplug fails.\n\nA possible workaround is to reboot Linux in order to force a sysfs refresh and free up the device name.\n\nA possible solution is to prevent users from trying to hotplug/unplug to a paused/suspended instance, since it would corrupt sysfs.\n\nAny thoughts?", 
            "date_created": "2014-04-16 20:19:58.145573+00:00", 
            "author": "https://api.launchpad.net/1.0/~thang-pham"
        }, 
        {
            "content": "I have the same problem in a different scenario. It is described here: https://bugs.launchpad.net/nova/+bug/1313760", 
            "date_created": "2014-04-29 11:05:30.201307+00:00", 
            "author": "https://api.launchpad.net/1.0/~yrabl"
        }, 
        {
            "content": "Looking at this a bit more - I agree that we should disable it. What libvirt driiver currently does is issue attachDeviceFlags but without the VIR_DOMAIN_AFFECT_LIVE flag meaning that only the persistant domain configuration will be affected.\n\nI still need to try this but likely attaching the volume and then rebooting the instance will make it visible to the instance, however that completely defeats the purpose of pausing. so it should likely be disabled.", 
            "date_created": "2014-04-29 18:31:59.174453+00:00", 
            "author": "https://api.launchpad.net/1.0/~ndipanov"
        }, 
        {
            "content": "I experimented with using the VIR_DOMAIN_AFFECT_LIVE when attaching and detaching a volume from a paused instance.  It turns out that it works!", 
            "date_created": "2014-05-10 02:45:57.102892+00:00", 
            "author": "https://api.launchpad.net/1.0/~thang-pham"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/93190", 
            "date_created": "2014-05-10 17:19:20.999527+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Please handle for the situation in bug #1330800, thanks~", 
            "date_created": "2014-06-17 04:13:59.167147+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzguanqiang"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/93190\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ead9cfca93c9b5ca55e3ba269213c98d5e6e1d38\nSubmitter: Jenkins\nBranch:    master\n\ncommit ead9cfca93c9b5ca55e3ba269213c98d5e6e1d38\nAuthor: Thang Pham <email address hidden>\nDate:   Sat May 10 01:41:31 2014 -0400\n\n    libvirt: Use VIR_DOMAIN_AFFECT_LIVE for paused instances\n    \n    When a volume is attached to a paused instance, it does not\n    appear in the instance's block devices list (i.e. lsblk)\n    after the instance has resumed. A similar situation\n    happens when detaching a volume from a paused instance; the\n    block device continues to exists in the block devices list,\n    where it should not.  It was found that the volume is only\n    persisted in the domain's config settings and not its active\n    settings, since only the VIR_DOMAIN_AFFECT_CONFIG flag was used\n    on attach and detach volume.  In order to affect the active\n    settings, the VIR_DOMAIN_AFFECT_LIVE flag has to be added when\n    attaching and detaching volumes.\n    \n    Change-Id: I9c90a410a7ecb91f5a4de28acee21fe7da49242c\n    Closes-Bug: #1242366\n    Related-Bug: #1299331\n", 
            "date_created": "2014-06-25 00:14:08.329851+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/102456", 
            "date_created": "2014-06-25 07:47:20.884089+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/102456\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=520aa4c0829da9ba4b2beb8f90995f4bdec9b1f2\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 520aa4c0829da9ba4b2beb8f90995f4bdec9b1f2\nAuthor: Thang Pham <email address hidden>\nDate:   Sat May 10 01:41:31 2014 -0400\n\n    libvirt: Use VIR_DOMAIN_AFFECT_LIVE for paused instances\n    \n    When a volume is attached to a paused instance, it does not\n    appear in the instance's block devices list (i.e. lsblk)\n    after the instance has resumed. A similar situation\n    happens when detaching a volume from a paused instance; the\n    block device continues to exists in the block devices list,\n    where it should not.  It was found that the volume is only\n    persisted in the domain's config settings and not its active\n    settings, since only the VIR_DOMAIN_AFFECT_CONFIG flag was used\n    on attach and detach volume.  In order to affect the active\n    settings, the VIR_DOMAIN_AFFECT_LIVE flag has to be added when\n    attaching and detaching volumes.\n    \n    This change adjusts little about the unit test:\n    add two imports.\n    \n    Change-Id: I9c90a410a7ecb91f5a4de28acee21fe7da49242c\n    Closes-Bug: #1242366\n    Related-Bug: #1299331\n    (cherry picked from commit ead9cfca93c9b5ca55e3ba269213c98d5e6e1d38)\n", 
            "date_created": "2014-09-26 14:30:22.509565+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-07-23 14:59:59.045017+00:00"
}