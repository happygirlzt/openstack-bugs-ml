{
    "status": "Fix Released", 
    "last_updated": "2017-08-12 00:37:49.892151+00:00", 
    "description": "Upgrading the deployment from Mitaka to Newton.\nThis bug blocks people from upgrading to Ocata because the database migration for nova fails.\n\nRunning nova newton 14.0.5, the database is 334\n\nroot@moby:/backups# nova-manage db online_data_migrations\nOption \"verbose\" from group \"DEFAULT\" is deprecated for removal.  Its value may be silently ignored in the future.\nRunning batches of 50 until complete\n50 rows matched query migrate_flavors, 50 migrated\n20 rows matched query migrate_flavors, 20 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n30 rows matched query migrate_instances_add_request_spec, 30 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n/usr/lib/python2.7/dist-packages/pkg_resources/__init__.py:188: RuntimeWarning: You have iterated over the result of pkg_resources.parse_version. This is a legacy behavior which is inconsistent with the new version class introduced in setuptools 8.0. In most cases, conversion to a tuple is unnecessary. For comparison of versions, sort the Version instances directly. If you have another use case requiring the tuple, please file a bug with the setuptools project describing that need.\n  stacklevel=1,\n50 rows matched query migrate_instances_add_request_spec, 5 migrated\n2017-04-20 14:48:36.586 396 ERROR nova.objects.keypair [req-565cbe62-030b-4b00-b9db-5ee82117889b - - - - -] Some instances are still missing keypair information. Unable to run keypair migration at this time.\n5 rows matched query migrate_aggregates, 5 migrated\n5 rows matched query migrate_instance_groups_to_api_db, 5 migrated\n2 rows matched query delete_build_requests_with_no_instance_uuid, 2 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 0 migrated\n2017-04-20 14:48:40.620 396 ERROR nova.objects.keypair [req-565cbe62-030b-4b00-b9db-5ee82117889b - - - - -] Some instances are still missing keypair information. Unable to run keypair migration at this time.\nroot@moby:/backups#\n\nAdding a 'raise' after https://github.com/openstack/nova/blob/stable/newton/nova/cmd/manage.py#L896\nyou can see:\n\nroot@moby:/backups# nova-manage db online_data_migrations\nOption \"verbose\" from group \"DEFAULT\" is deprecated for removal.  Its value may be silently ignored in the future.\nRunning batches of 50 until complete\nError attempting to run <function migrate_instance_keypairs at 0x7fb45132ab90>\nerror: 'NoneType' object has no attribute 'key_name'", 
    "tags": [
        "in-stable-newton", 
        "in-stable-ocata"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1684861", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1684861, 
    "index": 4804, 
    "openned": "2017-04-20 15:24:46.624162+00:00", 
    "created": "2017-04-20 15:24:46.624162+00:00", 
    "title": "Mitaka -> Newton: Database online_data_migrations in newton fail due to missing keypairs", 
    "comments": [
        {
            "content": "Upgrading the deployment from Mitaka to Newton.\nThis bug blocks people from upgrading to Ocata because the database migration for nova fails.\n\nRunning nova newton 14.0.5, the database is 334\n\nroot@moby:/backups# nova-manage db online_data_migrations\nOption \"verbose\" from group \"DEFAULT\" is deprecated for removal.  Its value may be silently ignored in the future.\nRunning batches of 50 until complete\n50 rows matched query migrate_flavors, 50 migrated\n20 rows matched query migrate_flavors, 20 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n30 rows matched query migrate_instances_add_request_spec, 30 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 50 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n/usr/lib/python2.7/dist-packages/pkg_resources/__init__.py:188: RuntimeWarning: You have iterated over the result of pkg_resources.parse_version. This is a legacy behavior which is inconsistent with the new version class introduced in setuptools 8.0. In most cases, conversion to a tuple is unnecessary. For comparison of versions, sort the Version instances directly. If you have another use case requiring the tuple, please file a bug with the setuptools project describing that need.\n  stacklevel=1,\n50 rows matched query migrate_instances_add_request_spec, 5 migrated\n2017-04-20 14:48:36.586 396 ERROR nova.objects.keypair [req-565cbe62-030b-4b00-b9db-5ee82117889b - - - - -] Some instances are still missing keypair information. Unable to run keypair migration at this time.\n5 rows matched query migrate_aggregates, 5 migrated\n5 rows matched query migrate_instance_groups_to_api_db, 5 migrated\n2 rows matched query delete_build_requests_with_no_instance_uuid, 2 migrated\nError attempting to run <function migrate_instance_keypairs at 0x7f3373c58b90>\n50 rows matched query migrate_instances_add_request_spec, 0 migrated\n2017-04-20 14:48:40.620 396 ERROR nova.objects.keypair [req-565cbe62-030b-4b00-b9db-5ee82117889b - - - - -] Some instances are still missing keypair information. Unable to run keypair migration at this time.\nroot@moby:/backups#\n\nAdding a 'raise' after https://github.com/openstack/nova/blob/stable/newton/nova/cmd/manage.py#L896\nyou can see:\n\nroot@moby:/backups# nova-manage db online_data_migrations\nOption \"verbose\" from group \"DEFAULT\" is deprecated for removal.  Its value may be silently ignored in the future.\nRunning batches of 50 until complete\nError attempting to run <function migrate_instance_keypairs at 0x7fb45132ab90>\nerror: 'NoneType' object has no attribute 'key_name'", 
            "date_created": "2017-04-20 15:24:46.624162+00:00", 
            "author": "https://api.launchpad.net/1.0/~zioproto"
        }, 
        {
            "content": "This will probably happen to all those operators that in the upgrade Kilo to Liberty did follow this workaround here:\nhttps://bugs.launchpad.net/nova/+bug/1511466", 
            "date_created": "2017-04-20 15:51:23.643789+00:00", 
            "author": "https://api.launchpad.net/1.0/~zioproto"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/458564", 
            "date_created": "2017-04-20 15:53:47.772051+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Unfortunately, this bug seems to have been triggered by the \"workaround\" offered in bug 1511466, which disabled FK constraints and broke the model linkage between InstanceExtra and Instance. Doing so breaks a lot of code that assumes this linkage, and this bug is one manifestation of the problem.\n\nThe referenced change to this bug does not fix the problem, but logs a warning to the user explaining what is going on. To get yourself out of the jam, you need to delete the orphaned instance_extra records (i.e. the ones that have instance_uuid that does not reference something in the instances table).", 
            "date_created": "2017-04-20 15:59:39.356646+00:00", 
            "author": "https://api.launchpad.net/1.0/~danms"
        }, 
        {
            "content": "If you messed up the database during the upgrade from Kilo to Liberty following the workaround of bug 1511466 (comments #3 and #9) you can use this python script to fix your database:\n\nimport MySQLdb\nconn = MySQLdb.connect(host = '127.0.0.1', user = 'nova', passwd = 'my-secret-pw', db = 'nova')\ncursor = conn.cursor()\n\ncursor.execute(\"select instance_uuid from instance_extra;\")\ninstance_extra_t = cursor.fetchall()\ncursor.execute(\"select uuid from instances;\")\ninstances_t = cursor.fetchall()\n\ntodelete_list = []\n\nfor extra in instance_extra_t:\n    if extra not in instances_t:\n        todelete_list.append(extra)\n\nfor uuid in todelete_list:\n    cmd = \"delete from instance_extra where instance_uuid='%s';\" % uuid\n    result = cursor.execute(cmd)\n    conn.commit()", 
            "date_created": "2017-04-25 07:48:27.756457+00:00", 
            "author": "https://api.launchpad.net/1.0/~zioproto"
        }, 
        {
            "content": "If you messed up the database during the upgrade from Kilo to Liberty following the workaround of bug 1511466 (comments #3 and #9) you can fix with this query:\n\n\n    DELETE from instance_extra where instance_uuid not in (select uuid from instances);\n\n\nSorry the python script in comment #4 is way too complex ! you can do the same with a 1 line SQL query", 
            "date_created": "2017-04-26 06:54:14.500615+00:00", 
            "author": "https://api.launchpad.net/1.0/~zioproto"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/458564\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=2cee5bb4d14a5ad6a037857bd3624833317cd931\nSubmitter: Jenkins\nBranch:    master\n\ncommit 2cee5bb4d14a5ad6a037857bd3624833317cd931\nAuthor: Dan Smith <email address hidden>\nDate:   Thu Apr 20 09:12:45 2017 -0700\n\n    Warn the user about orphaned extra records during keypair migration\n    \n    Operators who have manually deleted Instance records with FK constraints\n    disabled may have orphaned InstanceExtra records which will prevent the\n    keypair migration from running. Normally, this violation of the data\n    model would be something that earns no sympathy. However, that solution\n    was (incorrectly) offered up as a workaround in bug 1511466 and multiple\n    deployments have broken their data as a result. Since the experience\n    is a unhelpful error message and a blocked migration, this patch attempts\n    to at least highlight the problem, even though it is on the operator to\n    actually fix the problem.\n    \n    Change-Id: I0c8bf2c495a98c412eb93e19f832948a779bca11\n    Related-Bug: #1684861\n", 
            "date_created": "2017-05-07 22:37:33.950170+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/463364", 
            "date_created": "2017-05-08 16:25:36.720613+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: stable/newton\nReview: https://review.openstack.org/463366", 
            "date_created": "2017-05-08 16:26:06.231136+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/463364\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=593e7081148b2b15f5923a8d7c609ae71dcbdbb6\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit 593e7081148b2b15f5923a8d7c609ae71dcbdbb6\nAuthor: Dan Smith <email address hidden>\nDate:   Thu Apr 20 09:12:45 2017 -0700\n\n    Warn the user about orphaned extra records during keypair migration\n    \n    Operators who have manually deleted Instance records with FK constraints\n    disabled may have orphaned InstanceExtra records which will prevent the\n    keypair migration from running. Normally, this violation of the data\n    model would be something that earns no sympathy. However, that solution\n    was (incorrectly) offered up as a workaround in bug 1511466 and multiple\n    deployments have broken their data as a result. Since the experience\n    is a unhelpful error message and a blocked migration, this patch attempts\n    to at least highlight the problem, even though it is on the operator to\n    actually fix the problem.\n    \n    Change-Id: I0c8bf2c495a98c412eb93e19f832948a779bca11\n    Related-Bug: #1684861\n    (cherry picked from commit 2cee5bb4d14a5ad6a037857bd3624833317cd931)\n", 
            "date_created": "2017-06-12 16:19:41.018069+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Found open reviews for this bug in gerrit, setting to In Progress. \n\nreview: https://review.openstack.org/463366 in branch: stable/newton\n", 
            "date_created": "2017-06-29 11:43:38.854366+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/463366\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7b29a5cf9e19ef5885759259aab439473d01a6b5\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 7b29a5cf9e19ef5885759259aab439473d01a6b5\nAuthor: Dan Smith <email address hidden>\nDate:   Thu Apr 20 09:12:45 2017 -0700\n\n    Warn the user about orphaned extra records during keypair migration\n    \n    Operators who have manually deleted Instance records with FK constraints\n    disabled may have orphaned InstanceExtra records which will prevent the\n    keypair migration from running. Normally, this violation of the data\n    model would be something that earns no sympathy. However, that solution\n    was (incorrectly) offered up as a workaround in bug 1511466 and multiple\n    deployments have broken their data as a result. Since the experience\n    is a unhelpful error message and a blocked migration, this patch attempts\n    to at least highlight the problem, even though it is on the operator to\n    actually fix the problem.\n    \n    Change-Id: I0c8bf2c495a98c412eb93e19f832948a779bca11\n    Related-Bug: #1684861\n    (cherry picked from commit 2cee5bb4d14a5ad6a037857bd3624833317cd931)\n", 
            "date_created": "2017-08-12 00:37:49.504786+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-08-11 19:32:29.935447+00:00"
}