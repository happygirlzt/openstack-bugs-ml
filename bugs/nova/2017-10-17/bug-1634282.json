{
    "status": "Fix Released", 
    "last_updated": "2017-06-26 08:35:54.599211+00:00", 
    "description": "I am trying to perform \"ping-pong\" host evacuation - take down ungracefully host A, evacuate host A to host B, take down ungracefully host B and evacuate to host A. The second evacuation fails at following error:\n[Errno 13] Permission denied: '/var/lib/nova/instances/e17a325c-f0da-4f2f-aad3-4b1c098f295f/console.log'\n\nTraceback:\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9] Traceback (most recent call last):\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 6566, in _error_out_instance_on_exception\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     yield\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2687, in rebuild_instance\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     bdms, recreate, on_shared_storage, preserve_ephemeral)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2731, in _do_rebuild_instance_with_claim\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     self._do_rebuild_instance(*args, **kwargs)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2846, in _do_rebuild_instance\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     self._rebuild_default_impl(**kwargs)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2612, in _rebuild_default_impl\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     block_device_info=new_block_device_info)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2574, in spawn\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     self._ensure_console_log_for_instance(instance)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2835, in _ensure_console_log_for_instance\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     libvirt_utils.file_open(console_file, 'a').close()\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/utils.py\", line 313, in file_open\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     return open(*args, **kwargs)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9] IOError: [Errno 13] Permission denied: '/var/lib/nova/instances/a7ba9743-b425-4e47-aeb0-d545e66fffe9/console.log'\n\nThe problem is that the console file is left on host A with qemu:qemu ownership set by libvirt after first evacuation (the host A was taken down ungracefully) and once nova tries to open that file with append permission under nova user during second evacution from host B to host A It fails due to permissions. This try of nova to open the console.log file was introduce in:\nhttps://github.com/openstack/nova/commit/ec6ed24cb844dcdf834d283d496c9b920ff1db83\n\nSince I believe that in default installations usually dynamic_ownership=0 is not set and qemu is not started by the same user as Nova I would consider this as a regression.\n\nSteps to reproduce:\n1. Boot a VM on host A\n2. Disrupt host A and trigger evacuation to host B\n3. Wait for host A to be online again\n4. Disrupt host B and trigger evacuation to host A\n\nExpected result:\nSuccessful 2nd host evacuation\n\nActual result:\nNova does not have permission to open console.log file and fails the evacuation.\n\nNewton release used", 
    "tags": [
        "in-stable-newton"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1634282", 
    "owner": "None", 
    "id": 1634282, 
    "index": 7755, 
    "openned": "2016-10-17 21:55:40.735343+00:00", 
    "created": "2016-10-17 21:55:40.735343+00:00", 
    "title": "Nova fails to open console.log file at repeated host evacuation", 
    "comments": [
        {
            "content": "I am trying to perform \"ping-pong\" host evacuation - take down ungracefully host A, evacuate host A to host B, take down ungracefull host B and evacuate to host B. The second evacuation fails at following error:\n[Errno 13] Permission denied: '/var/lib/nova/instances/e17a325c-f0da-4f2f-aad3-4b1c098f295f/console.log'\n\nTraceback:\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9] Traceback (most recent call last):\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 6566, in _error_out_instance_on_exception\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     yield\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2687, in rebuild_instance\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     bdms, recreate, on_shared_storage, preserve_ephemeral)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2731, in _do_rebuild_instance_with_claim\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     self._do_rebuild_instance(*args, **kwargs)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2846, in _do_rebuild_instance\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     self._rebuild_default_impl(**kwargs)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2612, in _rebuild_default_impl\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     block_device_info=new_block_device_info)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2574, in spawn\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     self._ensure_console_log_for_instance(instance)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2835, in _ensure_console_log_for_instance\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     libvirt_utils.file_open(console_file, 'a').close()\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/utils.py\", line 313, in file_open\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9]     return open(*args, **kwargs)\n2016-10-17 11:36:56.023 3433 ERROR nova.compute.manager [instance: a7ba9743-b425-4e47-aeb0-d545e66fffe9] IOError: [Errno 13] Permission denied: '/var/lib/nova/instances/a7ba9743-b425-4e47-aeb0-d545e66fffe9/console.log'\n\nThe problem is that the console file is left on host A with qemu:qemu ownership set by libvirt after first evacuation (the host A was taken down ungracefully) and once nova tries to open that file with append permission under nova user during second evacution from host B to host A It fails due to permissions. This try of nova to open the console.log file was introduce in:\nhttps://github.com/openstack/nova/commit/ec6ed24cb844dcdf834d283d496c9b920ff1db83\n\nSince I believe that in default installations usually dynamic_ownership=0 is not set and qemu is not started by the same user as Nova I would consider this as a regression.\n\nSteps to reproduce:\n1. Boot a VM on host A\n2. Disrupt host A and trigger evacuation to host B\n3. Wait for host A to be online again\n4. Disrupt host B and trigger evacuation to host A\n\nExpected result:\nSuccessful 2nd host evacuation\n\nActual result:\nNova does not have permission to open console.log file and fails the evacuation.\n\nNewton release used", 
            "date_created": "2016-10-17 21:55:40.735343+00:00", 
            "author": "https://api.launchpad.net/1.0/~mkrcmari"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/392643", 
            "date_created": "2016-11-02 13:10:02.105620+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/392643\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=1848860fd4fb6dfb2ead1f8271050d36df592205\nSubmitter: Jenkins\nBranch:    master\n\ncommit 1848860fd4fb6dfb2ead1f8271050d36df592205\nAuthor: Stephen Finucane <email address hidden>\nDate:   Wed Nov 2 12:43:35 2016 +0000\n\n    Ignore IOError when creating 'console.log'\n    \n    In 'd4e6bd8', and later refined in 'ec6ed24c', an issue with the the\n    Quobyte CI was resolved by ensuring that the 'console.log' file is\n    always created, even when libvirt's 'dynamic_ownership' config option\n    is set to '0'. However, attempting to take ownership of this file can\n    cause issues when 'dynamic_ownership' is set to '1' and a user attempts\n    to reschedule an instance to a host where it was previously located. In\n    this case, the permissions on the file have already been co-opted by\n    libvirt, and attempting to change them results in an IOError.\n    \n    The easiest fix for this is to simply ignore the IOError, as the file\n    already exists and libvirt has set correct permissions already. This is\n    what do here. A longer term fix would be to avoid changing the\n    permissions only for the offending Quobytes block devices, but this is\n    likely not backportable and will be done in a follow-up fix.\n    \n    Change-Id: I353afd57be207330757580447a1b606c7b9b7c09\n    Partial-bug: #1634282\n    Related-bug: #1597644\n    Related-bug: #1609298\n", 
            "date_created": "2017-02-01 18:04:12.432879+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/454593", 
            "date_created": "2017-04-07 08:20:28.890957+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/454593\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=a96092d0e48fef62d257acf0428ddb6daf07d3a4\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit a96092d0e48fef62d257acf0428ddb6daf07d3a4\nAuthor: Stephen Finucane <email address hidden>\nDate:   Wed Nov 2 12:43:35 2016 +0000\n\n    Ignore IOError when creating 'console.log'\n    \n    In 'd4e6bd8', and later refined in 'ec6ed24c', an issue with the the\n    Quobyte CI was resolved by ensuring that the 'console.log' file is\n    always created, even when libvirt's 'dynamic_ownership' config option\n    is set to '0'. However, attempting to take ownership of this file can\n    cause issues when 'dynamic_ownership' is set to '1' and a user attempts\n    to reschedule an instance to a host where it was previously located. In\n    this case, the permissions on the file have already been co-opted by\n    libvirt, and attempting to change them results in an IOError.\n    \n    The easiest fix for this is to simply ignore the IOError, as the file\n    already exists and libvirt has set correct permissions already. This is\n    what do here. A longer term fix would be to avoid changing the\n    permissions only for the offending Quobytes block devices, but this is\n    likely not backportable and will be done in a follow-up fix.\n    \n    Change-Id: I353afd57be207330757580447a1b606c7b9b7c09\n    Partial-bug: #1634282\n    Related-bug: #1597644\n    Related-bug: #1609298\n    (cherry picked from commit 1848860fd4fb6dfb2ead1f8271050d36df592205)\n", 
            "date_created": "2017-04-07 18:28:24.290626+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "\nThere are no currently open reviews on this bug, changing\nthe status back to the previous state and unassigning. If\nthere are active reviews related to this bug, please include\nlinks in comments.\n", 
            "date_created": "2017-06-23 12:53:28.925726+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ], 
    "closed": "2017-06-26 08:35:52.358596+00:00"
}