{
    "status": "Fix Released", 
    "last_updated": "2016-06-02 19:33:58.648164+00:00", 
    "description": "Cinder volumes are stuck in attaching/detaching state when non admin user executes nova swap volume API.\nBecause cinder 'migrate_volume_completion' API can be executed by admin only in default settings of cinder policy.json.\nSo the default settings of cinder policy.json should be fixed.\n\n[How to reproduce]\nstack@devstack-master:/opt/devstack$ env | grep OS\n(snipped...)\nOS_USERNAME=demo\nOS_TENANT_NAME=demo\n(snipped...)\nstack@devstack-master:/opt/devstack$ nova list\n+--------------------------------------+---------+--------+------------+-------------+---------------------------------------------------------+\n| ID                                   | Name    | Status | Task State | Power State | Networks                                                |\n+--------------------------------------+---------+--------+------------+-------------+---------------------------------------------------------+\n| 5a4102cd-9e36-480c-a148-d2a127ff704e | server1 | ACTIVE | -          | Running     | private=10.0.10.3, fd61:9f1e:73ec:0:f816:3eff:fe34:8b61 |\n+--------------------------------------+---------+--------+------------+-------------+---------------------------------------------------------+\nstack@devstack-master:/opt/devstack$ cinder list\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\n|                  ID                  |   Status  |  Name | Size | Volume Type | Bootable | Multiattach |             Attached to              |\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\n| 1c768de0-949f-485f-b914-c430752e2984 | available | TEST2 |  1   | lvmdriver-1 |  false   |    False    |                                      |\n| 999a256e-aadf-41b6-88f3-1412e3462cbe |   in-use  | TEST1 |  1   | lvmdriver-1 |  false   |    False    | 5a4102cd-9e36-480c-a148-d2a127ff704e |\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\nstack@devstack-master:/opt/devstack$ nova volume-update server1 999a256e-aadf-41b6-88f3-1412e3462cbe 1c768de0-949f-485f-b914-c430752e2984\nstack@devstack-master:/opt/devstack$ cinder list\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\n|                  ID                  |   Status  |  Name | Size | Volume Type | Bootable | Multiattach |             Attached to              |\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\n| 1c768de0-949f-485f-b914-c430752e2984 | attaching | TEST2 |  1   | lvmdriver-1 |  false   |    False    |                                      |\n| 999a256e-aadf-41b6-88f3-1412e3462cbe | detaching | TEST1 |  1   | lvmdriver-1 |  false   |    False    | 5a4102cd-9e36-480c-a148-d2a127ff704e |\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\n\n[cinder-api.log]\n2015-12-04 15:41:51.986 INFO cinder.api.openstack.wsgi [req-44d81e36-299f-4e14-9419-996a2239b1ca 181cd8bc1c004030aec893fc7de79618 722380ff5288483191cd2712cbc99c5d] POST http://10.0.2.15:8776/v2/722380ff5288483191cd2712cbc99c5d/volumes/999a256e-aadf-41b6-88f3-1412e3462cbe/action\n2015-12-04 15:41:51.986 DEBUG cinder.api.openstack.wsgi [req-44d81e36-299f-4e14-9419-996a2239b1ca 181cd8bc1c004030aec893fc7de79618 722380ff5288483191cd2712cbc99c5d] Action body: {\"os-migrate_volume_completion\": {\"new_volume\": \"1c768de0-949f-485f-b914-c430752e2984\", \"error\": false}} from (pid=18203) get_method /opt/stack/cinder/cinder/api/openstack/wsgi.py:1093\n2015-12-04 15:41:51.987 INFO cinder.api.openstack.wsgi [req-44d81e36-299f-4e14-9419-996a2239b1ca 181cd8bc1c004030aec893fc7de79618 722380ff5288483191cd2712cbc99c5d] http://10.0.2.15:8776/v2/722380ff5288483191cd2712cbc99c5d/volumes/999a256e-aadf-41b6-88f3-1412e3462cbe/action returned with HTTP 403\n2015-12-04 15:41:51.989 INFO eventlet.wsgi.server [req-44d81e36-299f-4e14-9419-996a2239b1ca 181cd8bc1c004030aec893fc7de79618 722380ff5288483191cd2712cbc99c5d] 10.0.2.15 - - [04/Dec/2015 15:41:51] \"POST /v2/722380ff5288483191cd2712cbc99c5d/volumes/999a256e-aadf-41b6-88f3-1412e3462cbe/action HTTP/1.1\" 403 429 0.005410\n\n[policy.json(cinder)]\nThe follwong line defines that 'migrate_volume_completion' can be executed by admin only.\n\n\"volume_extension:volume_admin_actions:migrate_volume_completion\": \"rule:admin_api\",\n\n[Environment]\nnova: commit 7df427fdb4d7a314b79b1e3977aeb86f019b5186(master)\ncinder: commit 707902ca482d1653072c2cf419c566cd5fee1f96(master)\nOS: Ubuntu 14.04\n\nstack@devstack-master:/opt/devstack$ keystone user-role-list --user demo --tenant demo\n+----------------------------------+-------------+----------------------------------+----------------------------------+\n|                id                |     name    |             user_id              |            tenant_id             |\n+----------------------------------+-------------+----------------------------------+----------------------------------+\n| dec5e6b197d6424bbfb3854f6718cef0 |    Member   | 181cd8bc1c004030aec893fc7de79618 | 722380ff5288483191cd2712cbc99c5d |\n| de75e50dec2e48b4a4c66feef8f53432 | anotherrole | 181cd8bc1c004030aec893fc7de79618 | 722380ff5288483191cd2712cbc99c5d |\n+----------------------------------+-------------+----------------------------------+----------------------------------+", 
    "tags": [
        "volumes"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1522705", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1522705, 
    "index": 4403, 
    "openned": "2015-12-04 07:23:28.857789+00:00", 
    "created": "2015-12-04 07:20:15.995487+00:00", 
    "title": "Cinder volumes are stuck when non admin user executes nova swap volume API", 
    "comments": [
        {
            "content": "Cinder volumes are stuck in attaching/detaching state when non admin user executes nova swap volume API.\nBecause cinder 'migrate_volume_completion' API can be executed by admin only in default settings of cinder policy.json.\nSo the default settings of cinder policy.json should be fixed.\n\n[How to reproduce]\nstack@devstack-master:/opt/devstack$ env | grep OS\n(snipped...)\nOS_USERNAME=demo\nOS_TENANT_NAME=demo\n(snipped...)\nstack@devstack-master:/opt/devstack$ nova list\n+--------------------------------------+---------+--------+------------+-------------+---------------------------------------------------------+\n| ID                                   | Name    | Status | Task State | Power State | Networks                                                |\n+--------------------------------------+---------+--------+------------+-------------+---------------------------------------------------------+\n| 5a4102cd-9e36-480c-a148-d2a127ff704e | server1 | ACTIVE | -          | Running     | private=10.0.10.3, fd61:9f1e:73ec:0:f816:3eff:fe34:8b61 |\n+--------------------------------------+---------+--------+------------+-------------+---------------------------------------------------------+\nstack@devstack-master:/opt/devstack$ cinder list\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\n|                  ID                  |   Status  |  Name | Size | Volume Type | Bootable | Multiattach |             Attached to              |\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\n| 1c768de0-949f-485f-b914-c430752e2984 | available | TEST2 |  1   | lvmdriver-1 |  false   |    False    |                                      |\n| 999a256e-aadf-41b6-88f3-1412e3462cbe |   in-use  | TEST1 |  1   | lvmdriver-1 |  false   |    False    | 5a4102cd-9e36-480c-a148-d2a127ff704e |\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\nstack@devstack-master:/opt/devstack$ nova volume-update server1 999a256e-aadf-41b6-88f3-1412e3462cbe 1c768de0-949f-485f-b914-c430752e2984\nstack@devstack-master:/opt/devstack$ cinder list\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\n|                  ID                  |   Status  |  Name | Size | Volume Type | Bootable | Multiattach |             Attached to              |\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\n| 1c768de0-949f-485f-b914-c430752e2984 | attaching | TEST2 |  1   | lvmdriver-1 |  false   |    False    |                                      |\n| 999a256e-aadf-41b6-88f3-1412e3462cbe | detaching | TEST1 |  1   | lvmdriver-1 |  false   |    False    | 5a4102cd-9e36-480c-a148-d2a127ff704e |\n+--------------------------------------+-----------+-------+------+-------------+----------+-------------+--------------------------------------+\n\n[cinder-api.log]\n2015-12-04 15:41:51.986 INFO cinder.api.openstack.wsgi [req-44d81e36-299f-4e14-9419-996a2239b1ca 181cd8bc1c004030aec893fc7de79618 722380ff5288483191cd2712cbc99c5d] POST http://10.0.2.15:8776/v2/722380ff5288483191cd2712cbc99c5d/volumes/999a256e-aadf-41b6-88f3-1412e3462cbe/action\n2015-12-04 15:41:51.986 DEBUG cinder.api.openstack.wsgi [req-44d81e36-299f-4e14-9419-996a2239b1ca 181cd8bc1c004030aec893fc7de79618 722380ff5288483191cd2712cbc99c5d] Action body: {\"os-migrate_volume_completion\": {\"new_volume\": \"1c768de0-949f-485f-b914-c430752e2984\", \"error\": false}} from (pid=18203) get_method /opt/stack/cinder/cinder/api/openstack/wsgi.py:1093\n2015-12-04 15:41:51.987 INFO cinder.api.openstack.wsgi [req-44d81e36-299f-4e14-9419-996a2239b1ca 181cd8bc1c004030aec893fc7de79618 722380ff5288483191cd2712cbc99c5d] http://10.0.2.15:8776/v2/722380ff5288483191cd2712cbc99c5d/volumes/999a256e-aadf-41b6-88f3-1412e3462cbe/action returned with HTTP 403\n2015-12-04 15:41:51.989 INFO eventlet.wsgi.server [req-44d81e36-299f-4e14-9419-996a2239b1ca 181cd8bc1c004030aec893fc7de79618 722380ff5288483191cd2712cbc99c5d] 10.0.2.15 - - [04/Dec/2015 15:41:51] \"POST /v2/722380ff5288483191cd2712cbc99c5d/volumes/999a256e-aadf-41b6-88f3-1412e3462cbe/action HTTP/1.1\" 403 429 0.005410\n\n[policy.json(cinder)]\nThe follwong line defines that 'migrate_volume_completion' can be executed by admin only.\n\n\"volume_extension:volume_admin_actions:migrate_volume_completion\": \"rule:admin_api\",\n\n[Environment]\nnova: commit 7df427fdb4d7a314b79b1e3977aeb86f019b5186(master)\ncinder: commit 707902ca482d1653072c2cf419c566cd5fee1f96(master)\nOS: Ubuntu 14.04\n\nstack@devstack-master:/opt/devstack$ keystone user-role-list --user demo --tenant demo\n+----------------------------------+-------------+----------------------------------+----------------------------------+\n|                id                |     name    |             user_id              |            tenant_id             |\n+----------------------------------+-------------+----------------------------------+----------------------------------+\n| dec5e6b197d6424bbfb3854f6718cef0 |    Member   | 181cd8bc1c004030aec893fc7de79618 | 722380ff5288483191cd2712cbc99c5d |\n| de75e50dec2e48b4a4c66feef8f53432 | anotherrole | 181cd8bc1c004030aec893fc7de79618 | 722380ff5288483191cd2712cbc99c5d |\n+----------------------------------+-------------+----------------------------------+----------------------------------+", 
            "date_created": "2015-12-04 07:20:15.995487+00:00", 
            "author": "https://api.launchpad.net/1.0/~natsume-takashi"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/253363", 
            "date_created": "2015-12-04 07:46:14.498926+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Is there anything to do in Nova?", 
            "date_created": "2016-03-04 02:16:15.312221+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "ML thread on this issue:\n\nhttp://lists.openstack.org/pipermail/openstack-dev/2016-March/090957.html", 
            "date_created": "2016-03-31 00:57:31.945214+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/299715", 
            "date_created": "2016-03-31 02:14:06.638746+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Takashi NATSUME (<email address hidden>) on branch: master\nReview: https://review.openstack.org/253363", 
            "date_created": "2016-03-31 02:31:47.980800+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/299715\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=f738483e843fc27379b85c5401859ccc854adc5e\nSubmitter: Jenkins\nBranch:    master\n\ncommit f738483e843fc27379b85c5401859ccc854adc5e\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Mar 30 22:07:47 2016 -0400\n\n    Make swap-volume an admin-only API by default\n    \n    Cinder's volume migration API is, by default, an admin-only operation.\n    This includes the migrate_volume_completion API.\n    \n    When Cinder is doing a volume migration, it calls Nova's swap-volume\n    API to detach the old volume that we're migrating from and attach\n    the volume that we're migrating to. Then Nova calls Cinder's\n    migrate_volume_completion API to signal Nova is done and Cinder\n    can finish the volume migration.\n    \n    The problem is that swap-volume is not an admin-only API in Nova\n    per the default policy. So if a non-admin user tries to perform\n    a swap-volume operation, it will fail with a 403 when calling\n    Cinder's migrate_volume_completion API, since that requires an\n    admin user.\n    \n    Also, because of 98739761f17b5e0b32abd8cd262f5beda030f886 we can't\n    simply avoid calling migrate_volume_completion for non-migration\n    cases because that API handles the actual detach/attach for the old\n    and new volumes, swap-volume is broken without calling that.\n    \n    So given swap-volume relies on an admin-only Cinder API, and is called\n    from an admin-only Cinder operation (volume migration), we should\n    just make it default to admin-only also.\n    \n    Change-Id: Iac03258735f3d856a474ab96fe9b0a087e32906f\n    Closes-Bug: #1522705\n", 
            "date_created": "2016-04-11 02:18:51.984357+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b1 development milestone.", 
            "date_created": "2016-06-02 19:33:57.517211+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }
    ], 
    "closed": "2016-04-11 02:18:48.801670+00:00"
}