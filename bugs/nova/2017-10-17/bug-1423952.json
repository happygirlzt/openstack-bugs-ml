{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:21:00.828800+00:00", 
    "description": "If you attempt to boot a nova instance without Neutron properly configured for neutron/nova notifications, the instance will eventually fail to spawn:\n\n  [-] [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] Instance failed to spawn\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] Traceback (most recent call last):\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2243, in _build_resources\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]     yield resources\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2113, in _build_and_run_instance\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]     block_device_info=block_device_info)\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2622, in spawn\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]     block_device_info, disk_info=disk_info)\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4439, in _create_domain_and_network\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]     raise exception.VirtualInterfaceCreateException()\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] VirtualInterfaceCreateException: Virtual Interface creation failed\n\nIf you try to delete this instance, the delete operation will fail. In the logs, you see:\n\n  AUDIT nova.compute.manager [req-a4b30d0b-e6d3-429f-8f7a-b7788b79c86c None] [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] Terminating instance\n  WARNING nova.virt.libvirt.driver [-] [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] During wait destroy, instance disappeared.\n  INFO nova.virt.libvirt.driver [req-a4b30d0b-e6d3-429f-8f7a-b7788b79c86c None] [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] Deletion of /var/lib/nova/instances/1541a197-9f80-4ee5-a7d6-08e591aa83fd_del complete\n  INFO nova.compute.manager [req-a4b30d0b-e6d3-429f-8f7a-b7788b79c86c None] [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] Instance disappeared during terminate\n\nAt this point, `nova list` will show:\n\n  | 1541a197-9f80-4ee5-a7d6-08e591aa83fd | test0    | ERROR   | deleting   | NOSTATE     |                                  |\n\nAnd it appears to be impossible to delete this instance.  Running \"nova reset-state <instance>\"  has no effect (with or without --active), nor does correctly configuring neutron.\n\nThe only way to get rid of this instance appears to be directly editing the database.", 
    "tags": [
        "compute"
    ], 
    "importance": "Critical", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1423952", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1423952, 
    "index": 234, 
    "openned": "2015-02-20 15:57:48.619174+00:00", 
    "created": "2015-02-20 15:57:48.619174+00:00", 
    "title": "It is impossible to delete an instance that has failed due to neutron/nova notification problems", 
    "comments": [
        {
            "content": "If you attempt to boot a nova instance without Neutron properly configured for neutron/nova notifications, the instance will eventually fail to spawn:\n\n  [-] [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] Instance failed to spawn\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] Traceback (most recent call last):\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2243, in _build_resources\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]     yield resources\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 2113, in _build_and_run_instance\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]     block_device_info=block_device_info)\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 2622, in spawn\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]     block_device_info, disk_info=disk_info)\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 4439, in _create_domain_and_network\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd]     raise exception.VirtualInterfaceCreateException()\n  [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] VirtualInterfaceCreateException: Virtual Interface creation failed\n\nIf you try to delete this instance, the delete operation will fail. In the logs, you see:\n\n  AUDIT nova.compute.manager [req-a4b30d0b-e6d3-429f-8f7a-b7788b79c86c None] [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] Terminating instance\n  WARNING nova.virt.libvirt.driver [-] [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] During wait destroy, instance disappeared.\n  INFO nova.virt.libvirt.driver [req-a4b30d0b-e6d3-429f-8f7a-b7788b79c86c None] [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] Deletion of /var/lib/nova/instances/1541a197-9f80-4ee5-a7d6-08e591aa83fd_del complete\n  INFO nova.compute.manager [req-a4b30d0b-e6d3-429f-8f7a-b7788b79c86c None] [instance: 1541a197-9f80-4ee5-a7d6-08e591aa83fd] Instance disappeared during terminate\n\nAt this point, `nova list` will show:\n\n  | 1541a197-9f80-4ee5-a7d6-08e591aa83fd | test0    | ERROR   | deleting   | NOSTATE     |                                  |\n\nAnd it appears to be impossible to delete this instance.  Running \"nova reset-state <instance>\"  has no effect (with or without --active), nor does correctly configuring neutron.\n\nThe only way to get rid of this instance appears to be directly editing the database.", 
            "date_created": "2015-02-20 15:57:48.619174+00:00", 
            "author": "https://api.launchpad.net/1.0/~larsks"
        }, 
        {
            "content": "This was actually 'fixed' with bug 1308342 in that you can do a force-delete call on the instance and that will clean it up.  However, the fix for bug 1308342 introduced a regression in the cells RPC API, so we have bug 1430822 to fix that.\n\nOnce we revert https://review.openstack.org/#/c/121800/ then we'll make the fix for this in the compute API to allow force-delete of an instance stuck in 'deleting' task_state to resolve this bug.\n\nNote that we should also have a @revert_task_state decorator in whatever compute manager call failed on spawn so we don't get stuck in this state to begin with.", 
            "date_created": "2015-03-11 14:28:42.388500+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Actually, what level of code was this bug reported against?  Juno?  Or Kilo?  Because build_and_run_instance in the compute manager already has the @reverts_task_state decorator:\n\nhttp://git.openstack.org/cgit/openstack/nova/tree/nova/compute/manager.py?id=2015.1.0b2#n2007", 
            "date_created": "2015-03-11 14:58:58.033753+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I'm not really seeing how this is happening on master level code, but I'll write a unit test to try and recreate.", 
            "date_created": "2015-03-11 15:11:11.074807+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This was originally reported against Icehouse, but I believe the behavior can be reproduced with Juno code as well.  I have not tried to reproduce it with anything more recent.", 
            "date_created": "2015-03-11 15:16:09.619766+00:00", 
            "author": "https://api.launchpad.net/1.0/~larsks"
        }, 
        {
            "content": "Note that since Juno you can force-delete an instance in any vm_state but the task_state must be None:\n\nhttps://review.openstack.org/#/c/111157/\n\nSo if the vm_state is 'ERROR' and the task_state is 'deleting', you have to reset the task state using the reset-state admin actions API first to reset the task_state to None and then you can force-delete it.", 
            "date_created": "2015-03-11 15:43:21.145178+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I think a see a possible bug in the @reverts_task_state decorator in the compute manager code, it assumes there is an 'instance' key in kwargs to the method and it gets the uuid from that for the state update.  However, if kwargs['instance'] raises a KeyError, we swallow it and continue on our merry way.\n\nThere are other decorators that use utilities to get all of the args into kwargs dict and then we can be sure we're getting the right thing.  I'm going to play with some patches to see how often we hit this in a normal Jenkins run and were ignoring it.", 
            "date_created": "2015-03-11 16:04:51.105467+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Confirmed, we can't even pass unit tests with that KeyError:\n\nnova.tests.unit.compute.test_compute_mgr.ComputeManagerUnitTestCase.test_set_admin_password_bad_state\n-----------------------------------------------------------------------------------------------------\n\nCaptured traceback:\n~~~~~~~~~~~~~~~~~~~\n    Traceback (most recent call last):\n      File \"/home/mriedem/git/nova/.tox/py27/local/lib/python2.7/site-packages/mock.py\", line 1201, in patched\n        return func(*args, **keywargs)\n      File \"nova/tests/unit/compute/test_compute_mgr.py\", line 1889, in test_set_admin_password_bad_state\n        self.context, instance, None)\n      File \"/home/mriedem/git/nova/.tox/py27/local/lib/python2.7/site-packages/testtools/testcase.py\", line 422, in assertRaises\n        self.assertThat(our_callable, matcher)\n      File \"/home/mriedem/git/nova/.tox/py27/local/lib/python2.7/site-packages/testtools/testcase.py\", line 433, in assertThat\n        mismatch_error = self._matchHelper(matchee, matcher, message, verbose)\n      File \"/home/mriedem/git/nova/.tox/py27/local/lib/python2.7/site-packages/testtools/testcase.py\", line 483, in _matchHelper\n        mismatch = matcher.match(matchee)\n      File \"/home/mriedem/git/nova/.tox/py27/local/lib/python2.7/site-packages/testtools/matchers/_exception.py\", line 108, in match\n        mismatch = self.exception_matcher.match(exc_info)\n      File \"/home/mriedem/git/nova/.tox/py27/local/lib/python2.7/site-packages/testtools/matchers/_higherorder.py\", line 62, in match\n        mismatch = matcher.match(matchee)\n      File \"/home/mriedem/git/nova/.tox/py27/local/lib/python2.7/site-packages/testtools/testcase.py\", line 414, in match\n        reraise(*matchee)\n      File \"/home/mriedem/git/nova/.tox/py27/local/lib/python2.7/site-packages/testtools/matchers/_exception.py\", line 101, in match\n        result = matchee()\n      File \"/home/mriedem/git/nova/.tox/py27/local/lib/python2.7/site-packages/testtools/testcase.py\", line 969, in __call__\n        return self._callable_object(*self._args, **self._kwargs)\n      File \"nova/compute/manager.py\", line 420, in decorated_function\n        return function(self, context, *args, **kwargs)\n      File \"nova/exception.py\", line 88, in wrapped\n        payload)\n      File \"/home/mriedem/git/nova/.tox/py27/local/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 85, in __exit__\n        six.reraise(self.type_, self.value, self.tb)\n      File \"nova/exception.py\", line 71, in wrapped\n        return f(self, context, *args, **kw)\n      File \"nova/compute/manager.py\", line 296, in decorated_function\n        instance_uuid = kwargs['instance']['uuid']\n    KeyError: 'instance'\n", 
            "date_created": "2015-03-11 16:06:14.741987+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/163515", 
            "date_created": "2015-03-11 16:40:42.197601+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The thinking is https://review.openstack.org/#/c/130601/ introduced the bug since _do_build_and_run_instance is passed args rather than kwargs and since that's in a separate thread we lose the error.\n\nNote that change was backported to stable/juno and stable/icehouse, so it's also there:\n\nhttps://review.openstack.org/#/q/Ife712c43c5a61424bc68b2f5ab47cefdb46ac168,n,z\n\nAnd we need to backport the fix.", 
            "date_created": "2015-03-11 17:07:01.699435+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/163515\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c43f2b0d708f0f4b37850d2917c0abcc13b8789b\nSubmitter: Jenkins\nBranch:    master\n\ncommit c43f2b0d708f0f4b37850d2917c0abcc13b8789b\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Mar 11 09:21:29 2015 -0700\n\n    Fix kwargs['instance'] KeyError in @reverts_task_state decorator\n    \n    We use @reverts_task_state everywhere in the compute manager and we\n    ensure that 'instance' is a parameter to the decorator method via\n    @utils.expects_func_args('instance'), however, that only ensures there\n    is an instance argument, not that it's in args or kwargs (either is fine\n    for what expects_func_args checks).\n    \n    The reverts_task_state decorator can get a KeyError when checking\n    kwargs['instance'] and fail to revert the task_state on the instance,\n    which can leave us in a bad state where non-admins can't delete the\n    instance if the task_state is not None (and the reset-state API is\n    admin-only).\n    \n    This fixes the KeyError in the decorator by normalizing the args/kwargs\n    list into a single dict that we can pull the instance from.\n    \n    Also adds a warning log if we fail the instance update since it\n    shouldn't happen and we want to know if it does because of the\n    aforementioned problems with deleting orphaned instances.\n    \n    There isn't a specific unit test added for this since moving\n    kwargs['instance'] above the try/except in reverts_task_state makes a\n    lot of tests fail already if you don't have the normalize code.\n    \n    Closes-Bug: #1423952\n    \n    Change-Id: I70f464120c798422f9a3d601b7cdf3b0a8320690\n", 
            "date_created": "2015-03-11 21:48:04.078706+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/163623", 
            "date_created": "2015-03-11 21:48:23.978776+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/163633", 
            "date_created": "2015-03-11 22:35:42.631031+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/163623\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8c377b2f50345107c96636ce903409b741801c86\nSubmitter: Jenkins\nBranch:    stable/juno\n\ncommit 8c377b2f50345107c96636ce903409b741801c86\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Mar 11 09:21:29 2015 -0700\n\n    Fix kwargs['instance'] KeyError in @reverts_task_state decorator\n    \n    We use @reverts_task_state everywhere in the compute manager and we\n    ensure that 'instance' is a parameter to the decorator method via\n    @utils.expects_func_args('instance'), however, that only ensures there\n    is an instance argument, not that it's in args or kwargs (either is fine\n    for what expects_func_args checks).\n    \n    The reverts_task_state decorator can get a KeyError when checking\n    kwargs['instance'] and fail to revert the task_state on the instance,\n    which can leave us in a bad state where non-admins can't delete the\n    instance if the task_state is not None (and the reset-state API is\n    admin-only).\n    \n    This fixes the KeyError in the decorator by normalizing the args/kwargs\n    list into a single dict that we can pull the instance from.\n    \n    Also adds a warning log if we fail the instance update since it\n    shouldn't happen and we want to know if it does because of the\n    aforementioned problems with deleting orphaned instances.\n    \n    There isn't a specific unit test added for this since moving\n    kwargs['instance'] above the try/except in reverts_task_state makes a\n    lot of tests fail already if you don't have the normalize code.\n    \n    Closes-Bug: #1423952\n    \n    Change-Id: I70f464120c798422f9a3d601b7cdf3b0a8320690\n    (cherry picked from commit c43f2b0d708f0f4b37850d2917c0abcc13b8789b)\n", 
            "date_created": "2015-03-12 14:33:48.639543+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/163633\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c70e1fbebf5488ca9f6c0ce3658f7583df3bbea5\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit c70e1fbebf5488ca9f6c0ce3658f7583df3bbea5\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Mar 11 09:21:29 2015 -0700\n\n    Fix kwargs['instance'] KeyError in @reverts_task_state decorator\n    \n    We use @reverts_task_state everywhere in the compute manager and we\n    ensure that 'instance' is a parameter to the decorator method via\n    @utils.expects_func_args('instance'), however, that only ensures there\n    is an instance argument, not that it's in args or kwargs (either is fine\n    for what expects_func_args checks).\n    \n    The reverts_task_state decorator can get a KeyError when checking\n    kwargs['instance'] and fail to revert the task_state on the instance,\n    which can leave us in a bad state where non-admins can't delete the\n    instance if the task_state is not None (and the reset-state API is\n    admin-only).\n    \n    This fixes the KeyError in the decorator by normalizing the args/kwargs\n    list into a single dict that we can pull the instance from.\n    \n    Also adds a warning log if we fail the instance update since it\n    shouldn't happen and we want to know if it does because of the\n    aforementioned problems with deleting orphaned instances.\n    \n    There isn't a specific unit test added for this since moving\n    kwargs['instance'] above the try/except in reverts_task_state makes a\n    lot of tests fail already if you don't have the normalize code.\n    \n    Closes-Bug: #1423952\n    \n    Change-Id: I70f464120c798422f9a3d601b7cdf3b0a8320690\n    (cherry picked from commit c43f2b0d708f0f4b37850d2917c0abcc13b8789b)\n", 
            "date_created": "2015-03-12 14:34:54.713157+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-03-20 07:36:19.383406+00:00"
}