{
    "status": "Fix Released", 
    "last_updated": "2016-12-01 22:30:55.772545+00:00", 
    "description": "Environment:\nTwo NUMA nodes on compute host (node-0 and node-1).\nOne SR-IOV PCI device associated with NUMA node-1.\n\nSteps to reproduce:\n\nSteps to reproduce:\n\u00a01) Deploy env with SR-IOV and CPU pinning enable\n\u00a02) Create new flavor with cpu pinning:\nnova flavor-show m1.small.performance\n+----------------------------+-------------------------------------------------------------------------------------------------------+\n| Property | Value |\n+----------------------------+-------------------------------------------------------------------------------------------------------+\n| OS-FLV-DISABLED:disabled | False |\n| OS-FLV-EXT-DATA:ephemeral | 0 |\n| disk | 20 |\n| extra_specs | {\"hw:cpu_policy\": \"dedicated\", \"hw:numa_nodes\": \"1\"} |\n| id | 7b0e5ee0-0bf7-4a46-9653-9279a947c650 |\n| name | m1.small.performance |\n| os-flavor-access:is_public | True |\n| ram | 2048 |\n| rxtx_factor | 1.0 |\n| swap | |\n| vcpus | 1 |\n+----------------------------+--------------------------------------------------------------------------------\n\u00a03) download ubuntu image\n\u00a04) create sr-iov port and boot vm on this port with m1.small.performance flavor:\nNODE_1='node-4.test.domain.local'\nNODE_2='node-5.test.domain.local'\nNET_ID_1=$(neutron net-list | grep net_EW_2 | awk '{print$2}')\nneutron port-create $NET_ID_1 --binding:vnic-type direct --device_owner nova-compute --name sriov_23\nport_id=$(neutron port-list | grep 'sriov_23' | awk '{print$2}')\nnova boot vm23 --flavor m1.small.performance --image ubuntu_image --availability-zone nova:$NODE_1 --nic port-id=$port_id --key-name vm_key\n\nExpected results:\n\u00a0VM is an ACTIVE state\nActual result:\n\u00a0In most cases the state is ERROR with following logs:\n\n2016-05-13 08:25:56.598 29097 ERROR nova.pci.stats [req-26138c0b-fa55-4ff8-8f3a-aad980e3c815 d864c4308b104454b7b46fb652f4f377 9322dead0b5d440986b12596d9cbff5b - - -] Failed to allocate PCI devices for instance. Unassigning devices back to pools. This should not happen, since the scheduler should have accurate information, and allocation during claims is controlled via a hold on the compute node semaphore\n2016-05-13 08:25:57.502 29097 INFO nova.virt.libvirt.driver [req-26138c0b-fa55-4ff8-8f3a-aad980e3c815 d864c4308b104454b7b46fb652f4f377 9322dead0b5d440986b12596d9cbff5b - - -] [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] Creating image\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager [req-26138c0b-fa55-4ff8-8f3a-aad980e3c815 d864c4308b104454b7b46fb652f4f377 9322dead0b5d440986b12596d9cbff5b - - -] Instance failed network setup after 1 attempt(s)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager Traceback (most recent call last):\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1570, in _allocate_network_async\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     bind_host_id=bind_host_id)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 666, in allocate_for_instance\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     self._delete_ports(neutron, instance, created_port_ids)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     self.force_reraise()\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     six.reraise(self.type_, self.value, self.tb)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 645, in allocate_for_instance\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     bind_host_id=bind_host_id)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 738, in _populate_neutron_extension_values\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     port_req_body)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 709, in _populate_neutron_binding_profile\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     instance, pci_request_id).pop()\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager IndexError: pop from empty list\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [req-26138c0b-fa55-4ff8-8f3a-aad980e3c815 d864c4308b104454b7b46fb652f4f377 9322dead0b5d440986b12596d9cbff5b - - -] [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] Instance failed to spawn\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] Traceback (most recent call last):\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2218, in _build_resources\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     yield resources\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2064, in _build_and_run_instance\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     block_device_info=block_device_info)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2761, in spawn\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     admin_pass=admin_password)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 3287, in _create_image\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     instance, network_info, admin_pass, files, suffix)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 3066, in _inject_data\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     network_info, libvirt_virt_type=CONF.libvirt.virt_type)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/virt/netutils.py\", line 78, in get_injected_network_template\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     if not (network_info and template):\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/model.py\", line 517, in __len__\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     return self._sync_wrapper(fn, *args, **kwargs)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/model.py\", line 504, in _sync_wrapper\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     self.wait()\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/model.py\", line 536, in wait\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     self[:] = self._gt.wait()\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 175, in wait\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     return self._exit_event.wait()\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/eventlet/event.py\", line 125, in wait\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     current.throw(*self._exc)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     result = function(*args, **kwargs)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 1145, in context_wrapper\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     return func(*args, **kwargs)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1587, in _allocate_network_async\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     six.reraise(*exc_info)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1570, in _allocate_network_async\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     bind_host_id=bind_host_id)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 666, in allocate_for_instance\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     self._delete_ports(neutron, instance, created_port_ids)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     self.force_reraise()\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     six.reraise(self.type_, self.value, self.tb)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 645, in allocate_for_instance\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     bind_host_id=bind_host_id)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 738, in _populate_neutron_extension_values\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     port_req_body)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 709, in _populate_neutron_binding_profile\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     instance, pci_request_id).pop()\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] IndexError: pop from empty list\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]\n2016-05-13 08:25:57.939 29097 INFO nova.compute.manager [req-26138c0b-fa55-4ff8-8f3a-aad980e3c815 d864c4308b104454b7b46fb652f4f377 9322dead0b5d440986b12596d9cbff5b - - -] [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] Terminating instance\n\nThe problem is in nova/compute/resource_tracker.py. In method instance_claim():\n\nclaim = claims.Claim(context, instance_ref, self, self.compute_node,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0overhead=overhead, limits=limits)\nif self.pci_tracker:\n\u00a0\u00a0self.pci_tracker.claim_instance(context, instance_ref)\n\n \u00a0instance_ref.numa_topology = claim.claimed_numa_topology\n\u00a0\u00a0self._set_instance_host_and_node(instance_ref)\n\n1) here nova create a claim with correct NUMA node with CPU pinning and PCI devices (in our case it is node-1)\n2) nova call pci_tracker.claim_instance() with instance_ref BUT instance_ref does not contain information about needed NUMA node. That is why in claim_instance we choose node-0. In this case we can't associate requested PCI devices with the instance because these devices are associated with node-1.\n3) nova put to the instance_ref correct numa node-1 from step 1.\n4) we got an instance without PCI devices.", 
    "tags": [
        "canonical-bootstack", 
        "in-stable-mitaka", 
        "mitaka-backport-potential"
    ], 
    "importance": "Medium", 
    "heat": 32, 
    "link": "https://bugs.launchpad.net/nova/+bug/1582278", 
    "owner": "https://api.launchpad.net/1.0/~snikitin", 
    "id": 1582278, 
    "index": 4536, 
    "openned": "2016-05-16 15:25:03.162212+00:00", 
    "created": "2016-05-16 15:25:03.162212+00:00", 
    "title": "[SR-IOV][CPU Pinning] nova compute can try to boot VM with CPUs from one NUMA node and PCI device from another NUMA node.", 
    "comments": [
        {
            "content": "Environment:\nTwo NUMA nodes on compute host (node-0 and node-1).\nOne SR-IOV PCI device associated with NUMA node-1.\n\nSteps to reproduce:\n\nSteps to reproduce:\n 1) Deploy env with SR-IOV and CPU pinning enable\n 2) Create new flavor with cpu pinning:\nnova flavor-show m1.small.performance\n+----------------------------+-------------------------------------------------------------------------------------------------------+\n| Property | Value |\n+----------------------------+-------------------------------------------------------------------------------------------------------+\n| OS-FLV-DISABLED:disabled | False |\n| OS-FLV-EXT-DATA:ephemeral | 0 |\n| disk | 20 |\n| extra_specs | {\"hw:cpu_policy\": \"dedicated\", \"hw:numa_nodes\": \"1\"} |\n| id | 7b0e5ee0-0bf7-4a46-9653-9279a947c650 |\n| name | m1.small.performance |\n| os-flavor-access:is_public | True |\n| ram | 2048 |\n| rxtx_factor | 1.0 |\n| swap | |\n| vcpus | 1 |\n+----------------------------+--------------------------------------------------------------------------------\n 4) download ubuntu image\n 5) create sr-iov port and boot vm on this port with m1.small.performance flavor:\nNODE_1='node-4.test.domain.local'\nNODE_2='node-5.test.domain.local'\nNET_ID_1=$(neutron net-list | grep net_EW_2 | awk '{print$2}')\nneutron port-create $NET_ID_1 --binding:vnic-type direct --device_owner nova-compute --name sriov_23\nport_id=$(neutron port-list | grep 'sriov_23' | awk '{print$2}')\nnova boot vm23 --flavor m1.small.performance --image ubuntu_image --availability-zone nova:$NODE_1 --nic port-id=$port_id --key-name vm_key\n\nExpected results:\n VM is an ACTIVE state\nActual result:\n In most cases the state is ERROR with following logs:\n\n\n\n\n2016-05-13 08:25:56.598 29097 ERROR nova.pci.stats [req-26138c0b-fa55-4ff8-8f3a-aad980e3c815 d864c4308b104454b7b46fb652f4f377 9322dead0b5d440986b12596d9cbff5b - - -] Failed to allocate PCI devices for instance. Unassigning devices back to pools. This should not happen, since the scheduler should have accurate information, and allocation during claims is controlled via a hold on the compute node semaphore\n2016-05-13 08:25:57.502 29097 INFO nova.virt.libvirt.driver [req-26138c0b-fa55-4ff8-8f3a-aad980e3c815 d864c4308b104454b7b46fb652f4f377 9322dead0b5d440986b12596d9cbff5b - - -] [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] Creating image\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager [req-26138c0b-fa55-4ff8-8f3a-aad980e3c815 d864c4308b104454b7b46fb652f4f377 9322dead0b5d440986b12596d9cbff5b - - -] Instance failed network setup after 1 attempt(s)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager Traceback (most recent call last):\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1570, in _allocate_network_async\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     bind_host_id=bind_host_id)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 666, in allocate_for_instance\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     self._delete_ports(neutron, instance, created_port_ids)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     self.force_reraise()\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     six.reraise(self.type_, self.value, self.tb)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 645, in allocate_for_instance\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     bind_host_id=bind_host_id)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 738, in _populate_neutron_extension_values\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     port_req_body)\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 709, in _populate_neutron_binding_profile\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager     instance, pci_request_id).pop()\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager IndexError: pop from empty list\n2016-05-13 08:25:57.664 29097 ERROR nova.compute.manager \n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [req-26138c0b-fa55-4ff8-8f3a-aad980e3c815 d864c4308b104454b7b46fb652f4f377 9322dead0b5d440986b12596d9cbff5b - - -] [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] Instance failed to spawn\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] Traceback (most recent call last):\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2218, in _build_resources\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     yield resources\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2064, in _build_and_run_instance\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     block_device_info=block_device_info)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 2761, in spawn\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     admin_pass=admin_password)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 3287, in _create_image\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     instance, network_info, admin_pass, files, suffix)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 3066, in _inject_data\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     network_info, libvirt_virt_type=CONF.libvirt.virt_type)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/virt/netutils.py\", line 78, in get_injected_network_template\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     if not (network_info and template):\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/model.py\", line 517, in __len__\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     return self._sync_wrapper(fn, *args, **kwargs)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/model.py\", line 504, in _sync_wrapper\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     self.wait()\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/model.py\", line 536, in wait\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     self[:] = self._gt.wait()\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 175, in wait\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     return self._exit_event.wait()\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/eventlet/event.py\", line 125, in wait\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     current.throw(*self._exc)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     result = function(*args, **kwargs)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 1145, in context_wrapper\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     return func(*args, **kwargs)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1587, in _allocate_network_async\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     six.reraise(*exc_info)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 1570, in _allocate_network_async\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     bind_host_id=bind_host_id)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 666, in allocate_for_instance\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     self._delete_ports(neutron, instance, created_port_ids)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     self.force_reraise()\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     six.reraise(self.type_, self.value, self.tb)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 645, in allocate_for_instance\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     bind_host_id=bind_host_id)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 738, in _populate_neutron_extension_values\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     port_req_body)\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]   File \"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\", line 709, in _populate_neutron_binding_profile\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566]     instance, pci_request_id).pop()\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] IndexError: pop from empty list\n2016-05-13 08:25:57.937 29097 ERROR nova.compute.manager [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] \n2016-05-13 08:25:57.939 29097 INFO nova.compute.manager [req-26138c0b-fa55-4ff8-8f3a-aad980e3c815 d864c4308b104454b7b46fb652f4f377 9322dead0b5d440986b12596d9cbff5b - - -] [instance: 4e691469-893d-4b24-a0a8-00bbee0fa566] Terminating instance\n\n\n\n\n\n\nThe problem is in nova/compute/resource_tracker.py. In method instance_claim():\n\n        claim = claims.Claim(context, instance_ref, self, self.compute_node,\n                             overhead=overhead, limits=limits)\n        if self.pci_tracker:\n            self.pci_tracker.claim_instance(context, instance_ref)\n\n        instance_ref.numa_topology = claim.claimed_numa_topology\n        self._set_instance_host_and_node(instance_ref)\n\n1) here nova create a claim with correct NUMA node with CPU pinning and PCI devices (in our case it is node-1)\n2) nova call pci_tracker.claim_instance() with instance_ref BUT instance_ref does not contain information about needed NUMA node. That is why in claim_instance we choose node-0. In this case we can't associate requested PCI devices with the instance because these devices are associated with node-1. \n3) nova put to the instance_ref correct numa node-1 from step 1.\n4) we got an instance without PCI devices.", 
            "date_created": "2016-05-16 15:25:03.162212+00:00", 
            "author": "https://api.launchpad.net/1.0/~snikitin"
        }, 
        {
            "content": "Fixed by https://review.openstack.org/#/c/301308", 
            "date_created": "2016-05-16 15:46:34.481882+00:00", 
            "author": "https://api.launchpad.net/1.0/~snikitin"
        }, 
        {
            "content": "Related fix proposed to branch: stable/mitaka\nReview: https://review.openstack.org/317064", 
            "date_created": "2016-05-16 19:43:30.686100+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/mitaka\nReview: https://review.openstack.org/317065", 
            "date_created": "2016-05-16 19:43:42.042017+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "As we use the \"direct-release\" model in Nova we don't use the\n\"Fix Comitted\" status for merged bug fixes anymore. I'm setting\nthis manually to \"Fix Released\" to be consistent.\n\n[1] \"[openstack-dev] [release][all] bugs will now close automatically\n    when patches merge\"; Doug Hellmann; 2015-12-07;\n    http://lists.openstack.org/pipermail/openstack-dev/2015-December/081612.html\n", 
            "date_created": "2016-05-25 08:21:38.343651+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/317064\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=257cfb7e6f2f3414640c632909f78db6b71f40b3\nSubmitter: Jenkins\nBranch:    stable/mitaka\n\ncommit 257cfb7e6f2f3414640c632909f78db6b71f40b3\nAuthor: Jay Pipes <email address hidden>\nDate:   Fri Apr 1 16:03:47 2016 -0700\n\n    pci: pass in instance PCI requests to claim\n    \n    Removes the calls to InstancePCIRequests.get_XXX() from within the\n    claims.Claim and claims.MoveClaim constructors and instead has the\n    resource tracker construct the PCI requests and pass them into the\n    constructor.\n    \n    This allows us to remove the needlessly duplicative _test_pci() method\n    in claims.MoveClaim and will allow the next patch in the series to\n    remove the call in nova.pci.manager.PciDevTracker.claim_instance() that\n    re-fetches PCI requests for the supplied instance.\n    \n    Related-Bug: #1368201\n    Related-Bug: #1582278\n    \n    Change-Id: Ib2cc7c985839fbf88b5e6e437c4b395ab484b1b6\n    (cherry picked from commit 74fbff88639891269f6a0752e70b78340cf87e9a)\n", 
            "date_created": "2016-10-04 01:44:03.175285+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/317065\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=2150d5d8e17323bc9fce11903da3afffda211d26\nSubmitter: Jenkins\nBranch:    stable/mitaka\n\ncommit 2150d5d8e17323bc9fce11903da3afffda211d26\nAuthor: Jay Pipes <email address hidden>\nDate:   Mon Apr 4 12:32:56 2016 -0700\n\n    pci: eliminate DB lookup PCI requests during claim\n    \n    The nova.pci.manager.PciDevTracker.claim_instance() accepted an Instance\n    object and called nova.objects.InstancePCIRequests.get_by_instance() to\n    retrieve the PCI requests for the instance. This caused a DB lookup of\n    the PCI requests for that instance, even though in all situations other\n    than for migration/resize, the instance's PCI requests were already\n    retrieved by the resource tracker.\n    \n    This change removes that additional DB lookup during claim_instance() by\n    changing the instance parameter to instead be an InstancePCIRequests\n    object and an InstanceNUMATopology object.\n    \n    Also in this patch is a change to nova.objects.PciDevice.claim() that\n    changes the single parameter to an instance UUID instead of an Instance\n    object, since nothing other than the instance's UUID was used in the\n    method.\n    \n    Closes-Bug: #1582278\n    Related-Bug: #1368201\n    \n    Change-Id: I9ab10c3035628f083233114b47b43a9b9ecdd166\n    (cherry picked from commit 1f259e2a9423a4777f79ca561d5e6a74747a5019)\n", 
            "date_created": "2016-10-04 01:46:33.386106+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.1.2 release.", 
            "date_created": "2016-10-10 13:19:07.102854+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.1.2 release.", 
            "date_created": "2016-11-10 02:05:43.197889+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Marking as fix released for xenial/mitaka since 13.1.2 is now in xenial-updates and mitaka-updates.", 
            "date_created": "2016-12-01 22:30:54.462639+00:00", 
            "author": "https://api.launchpad.net/1.0/~corey.bryant"
        }
    ], 
    "closed": "2016-05-25 08:21:30.088990+00:00"
}