{
    "status": "Invalid", 
    "last_updated": "2013-07-15 13:01:04.888707+00:00", 
    "description": "Hi, I have 2 XCP nodes (1.6) in the resource pool and try to migrate instances (2013.1 version):\n\n\n2013-04-01 19:26:45.132 ERROR nova.openstack.common.rpc.amqp [req-b6bfe432-fdb1-4799-9ea1-331bdc95b9a6 admin admin] Exception during message handling\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 430, in _process_data\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/scheduler/manager.py\", line 116, in live_migration\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     context, ex, {})\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/scheduler/manager.py\", line 96, in live_migration\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     block_migration, disk_over_commit)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/scheduler/driver.py\", line 214, in schedule_live_migration\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     disk_over_commit)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/rpcapi.py\", line 240, in check_can_live_migrate_destination\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     ctxt, destination, None))\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/proxy.py\", line 80, in call\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return rpc.call(context, self._get_topic(topic), msg, timeout)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/__init__.py\", line 140, in call\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return _get_impl().call(CONF, context, topic, msg, timeout)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 798, in call\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     rpc_amqp.get_connection_pool(conf, Connection))\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 613, in call\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     rv = list(rv)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 562, in __iter__\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     raise result\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp AttributeError: 'dict' object has no attribute 'metadetails'\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 430, in _process_data\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 94, in wrapped\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 3026, in check_can_live_migrate_destination\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     block_migration, disk_over_commit)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 433, in check_can_live_migrate_destination\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     disk_over_commit)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 1679, in check_can_live_migrate_destination\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     self._ensure_host_in_aggregate(ctxt, src)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 1628, in _ensure_host_in_aggregate\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     self._get_host_uuid_from_aggregate(context, hostname)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 1621, in _get_host_uuid_from_aggregate\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return current_aggregate.metadetails[hostname]\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp AttributeError: 'dict' object has no attribute 'metadetails'\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n\nIf it will help  - as a shared storage I have NFS share", 
    "tags": [
        "xenserver"
    ], 
    "importance": "Medium", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1162973", 
    "owner": "None", 
    "id": 1162973, 
    "index": 3334, 
    "openned": "2013-04-01 19:46:54.010100+00:00", 
    "created": "2013-04-01 19:46:54.010100+00:00", 
    "title": "XCP resource pool - unable to migrate instances", 
    "comments": [
        {
            "content": "Hi, I have 2 XCP nodes (1.6) in the resource pool and try to migrate instances (2013.1 version):\n\n\n2013-04-01 19:26:45.132 ERROR nova.openstack.common.rpc.amqp [req-b6bfe432-fdb1-4799-9ea1-331bdc95b9a6 admin admin] Exception during message handling\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 430, in _process_data\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/scheduler/manager.py\", line 116, in live_migration\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     context, ex, {})\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/scheduler/manager.py\", line 96, in live_migration\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     block_migration, disk_over_commit)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/scheduler/driver.py\", line 214, in schedule_live_migration\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     disk_over_commit)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/rpcapi.py\", line 240, in check_can_live_migrate_destination\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     ctxt, destination, None))\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/proxy.py\", line 80, in call\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return rpc.call(context, self._get_topic(topic), msg, timeout)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/__init__.py\", line 140, in call\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return _get_impl().call(CONF, context, topic, msg, timeout)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 798, in call\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     rpc_amqp.get_connection_pool(conf, Connection))\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 613, in call\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     rv = list(rv)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 562, in __iter__\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     raise result\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp AttributeError: 'dict' object has no attribute 'metadetails'\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 430, in _process_data\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     rval = self.proxy.dispatch(ctxt, version, method, **args)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 133, in dispatch\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return getattr(proxyobj, method)(ctxt, **kwargs)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 117, in wrapped\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 94, in wrapped\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 3026, in check_can_live_migrate_destination\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     block_migration, disk_over_commit)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/driver.py\", line 433, in check_can_live_migrate_destination\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     disk_over_commit)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 1679, in check_can_live_migrate_destination\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     self._ensure_host_in_aggregate(ctxt, src)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 1628, in _ensure_host_in_aggregate\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     self._get_host_uuid_from_aggregate(context, hostname)\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/virt/xenapi/vmops.py\", line 1621, in _get_host_uuid_from_aggregate\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp     return current_aggregate.metadetails[hostname]\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp AttributeError: 'dict' object has no attribute 'metadetails'\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n2013-04-01 19:26:45.132 TRACE nova.openstack.common.rpc.amqp\n\nIf it will help  - as a shared storage I have NFS share", 
            "date_created": "2013-04-01 19:46:54.010100+00:00", 
            "author": "https://api.launchpad.net/1.0/~nikita-gubenko"
        }, 
        {
            "content": "What does \"nova aggregate-list\" show?", 
            "date_created": "2013-04-02 22:05:53.268403+00:00", 
            "author": "https://api.launchpad.net/1.0/~danms"
        }, 
        {
            "content": "root@DevStackOSDomU:~/nova/nova# nova aggregate-list\n+----+-----------+-------------------+\n| Id | Name      | Availability Zone |\n+----+-----------+-------------------+\n| 4  | TestPool3 | nova              |\n+----+-----------+-------------------+\n\nroot@DevStackOSDomU:~/nova/nova# nova aggregate-details 4\n+----+-----------+-------------------+-----------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Id | Name      | Availability Zone | Hosts                                   | Metadata                                                                                                                                                                                        |\n+----+-----------+-------------------+-----------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| 4  | TestPool3 | nova              | [u'DevStackOSDomU', u'DevStackOSDomU4'] | {u'operational_state': u'active', u'master_compute': u'DevStackOSDomU', u'hypervisor_pool': u'true', u'DevStackOSDomU': u'cd91634f-f1d2-40aa-a601-1d08ed50011a', u'availability_zone': u'nova'} |\n+----+-----------+-------------------+-----------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n", 
            "date_created": "2013-04-02 22:17:35.547042+00:00", 
            "author": "https://api.launchpad.net/1.0/~nikita-gubenko"
        }, 
        {
            "content": "Just checking, did you create the resource pool using the aggregate system?\n\nIf you just added a pool into an aggregate it will not quite work, but we could document it.", 
            "date_created": "2013-05-15 15:18:29.668828+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "John, your question may be answered by https://bugs.launchpad.net/nova/+bug/1161619", 
            "date_created": "2013-05-15 16:26:42.159927+00:00", 
            "author": "https://api.launchpad.net/1.0/~bob-ball"
        }, 
        {
            "content": "It seems this is invalid, and should be fixed by 1161619", 
            "date_created": "2013-05-22 11:09:48.081903+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "I fixed this issue with this code change:\n\ndiff -ru nova-orig/virt/xenapi/driver.py nova/virt/xenapi/driver.py\n--- nova-orig/virt/xenapi/driver.py     2013-07-15 14:21:05.532868954 +0200\n+++ nova/virt/xenapi/driver.py  2013-07-15 13:37:42.197213477 +0200\n@@ -628,10 +628,10 @@\n                                           \"(is the Dom0 disk full?)\"))\n         url = self._create_first_session(url, user, pw, exception)\n         self._populate_session_pool(url, user, pw, exception)\n+        self._virtapi = virtapi\n         self.host_uuid = self._get_host_uuid()\n         self.product_version, self.product_brand = \\\n             self._get_product_version_and_brand()\n-        self._virtapi = virtapi\n \n     def _create_first_session(self, url, user, pw, exception):\n         try:\n@@ -667,7 +667,7 @@\n                 LOG.error(_('Host is member of a pool, but DB '\n                                 'says otherwise'))\n                 raise exception.AggregateHostNotFound()\n-            return aggr.metadetails[CONF.host]\n+            return aggr['metadetails'][CONF.host]\n         else:\n             with self._get_session() as session:\n                 host_ref = session.xenapi.session.get_this_host(session.handle)\ndiff -ru nova-orig/virt/xenapi/vmops.py nova/virt/xenapi/vmops.py\n--- nova-orig/virt/xenapi/vmops.py      2013-07-15 14:21:05.532868954 +0200\n+++ nova/virt/xenapi/vmops.py   2013-07-15 14:29:41.575834454 +0200\n@@ -1603,7 +1603,7 @@\n         if not current_aggregate:\n             raise exception.AggregateHostNotFound(host=CONF.host)\n         try:\n-            return current_aggregate.metadetails[hostname]\n+            return current_aggregate['metadetails'][hostname]\n         except KeyError:\n             reason = _('Destination host:%(hostname)s must be in the same '\n                        'aggregate as the source server')", 
            "date_created": "2013-07-15 12:59:25.373292+00:00", 
            "author": "https://api.launchpad.net/1.0/~cyberang3l"
        }, 
        {
            "content": "", 
            "date_created": "2013-07-15 13:01:03.531327+00:00", 
            "author": "https://api.launchpad.net/1.0/~cyberang3l"
        }
    ], 
    "closed": "2013-05-22 11:10:07.747658+00:00"
}