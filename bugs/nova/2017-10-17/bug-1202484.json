{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 12:13:26.765258+00:00", 
    "description": "Reproduce steps with latest master branch of nova(but I believe grizzly, folsom also have this bug, and this occurs on our folsom stable product env):\n\n1.hack the nova-compute code as follow:\ndiff --git a/nova/compute/manager.py b/nova/compute/manager.py\nindex e1302bf..5a82f0b 100755\n--- a/nova/compute/manager.py\n+++ b/nova/compute/manager.py\n@@ -2399,7 +2399,7 @@ class ComputeManager(manager.SchedulerDependentManager):\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self._notify_about_instance_usage(context, instance,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"resize.confirm.start\")\n-\n+        LOG.debug(_(\"--------------------sleep 60s now------------------\"))\n+        time.sleep(60)   # sleep here and wait for the instance to be deleted\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0with self._error_out_instance_on_exception(context, instance['uuid'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0reservations):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0# NOTE(danms): delete stashed migration information\n2. create an instance under devstack env\n3. resize it\n4. confirm the resize operation\n5. delete the confirming instance when you saw the hacked log message 'sleep 60s now'\n6. then the instance will be deleted and the instance backup dir 'ddb764e6-c07a-4e81-8347-283213b84a98_resize' will not be deleted.\n\nthe error log is:\n2013-07-18 03:19:14.714 DEBUG nova.compute.manager [req-067c64aa-313f-49fc-b47b-2e83391f72ad admin admin] [instance: ddb764e6-c07a-4e81-8347-283213b84a98] Instance has been destroyed from under us while trying to set it to ERROR from (pid=7552) _set_instance_error_state /opt/stack/nova/nova/compute/manager.py:430\n2013-07-18 03:19:14.717 DEBUG nova.openstack.common.rpc.amqp [req-067c64aa-313f-49fc-b47b-2e83391f72ad admin admin] Making synchronous call on conductor ... from (pid=7552) multicall /opt/stack/nova/nova/openstack/common/rpc/amqp.py:518\n2013-07-18 03:19:14.718 DEBUG nova.openstack.common.rpc.amqp [req-067c64aa-313f-49fc-b47b-2e83391f72ad admin admin] MSG_ID is c57691619c834285bbbf786f16e01a5a from (pid=7552) multicall /opt/stack/nova/nova/openstack/common/rpc/amqp.py:521\n2013-07-18 03:19:14.718 DEBUG nova.openstack.common.rpc.amqp [req-067c64aa-313f-49fc-b47b-2e83391f72ad admin admin] UNIQUE_ID is a1e36d387f0045e5bc9c67bfe4dbdf6a. from (pid=7552) _add_unique_id /opt/stack/nova/nova/openstack/common/rpc/amqp.py:327\n2013-07-18 03:19:14.751 ERROR nova.openstack.common.rpc.amqp [req-067c64aa-313f-49fc-b47b-2e83391f72ad admin admin] Exception during message handling\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 426, in _process_data\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 99, in wrapped\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 76, in wrapped\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 279, in decorated_function\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     function(self, context, *args, **kwargs)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 243, in decorated_function\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 2410, in confirm_resize\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     system_metadata=sys_meta)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 414, in _instance_update\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     **kwargs)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/conductor/api.py\", line 414, in instance_update\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     updates, 'conductor')\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 134, in instance_update\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     version='1.38')\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/proxy.py\", line 126, in call\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     result = rpc.call(context, real_topic, msg, timeout)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/__init__.py\", line 140, in call\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     return _get_impl().call(CONF, context, topic, msg, timeout)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 824, in call\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     rpc_amqp.get_connection_pool(conf, Connection))\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 539, in call\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     rv = list(rv)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 504, in __iter__\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     raise result\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp InstanceNotFound_Remote: Instance ddb764e6-c07a-4e81-8347-283213b84a98 could not be found.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1202484", 
    "owner": "https://api.launchpad.net/1.0/~hzwangpan", 
    "id": 1202484, 
    "index": 5124, 
    "openned": "2013-07-18 03:34:36.174504+00:00", 
    "created": "2013-07-18 03:34:36.174504+00:00", 
    "title": "Instance backup dir isn't deleted if instance is deleted during confirming resize", 
    "comments": [
        {
            "content": "Reproduce steps:\n\n1.hack the nova-compute code as follow:\ndiff --git a/nova/compute/manager.py b/nova/compute/manager.py\nindex e1302bf..5a82f0b 100755\n--- a/nova/compute/manager.py\n+++ b/nova/compute/manager.py\n@@ -2399,7 +2399,7 @@ class ComputeManager(manager.SchedulerDependentManager):\n \n         self._notify_about_instance_usage(context, instance,\n                                           \"resize.confirm.start\")\n-\n+        LOG.debug(_(\"--------------------sleep 60s now------------------\"))\n+        time.sleep(60)   # sleep here and wait for the instance to be deleted\n         with self._error_out_instance_on_exception(context, instance['uuid'],\n                                                    reservations):\n             # NOTE(danms): delete stashed migration information\n2. create an instance under devstack env\n3. resize it\n4. confirm the resize operation\n5. delete the confirming instance when you saw the hacked log message 'sleep 60s now'\n6. then the instance will be deleted and the instance backup dir 'ddb764e6-c07a-4e81-8347-283213b84a98_resize' will not be deleted.\n\nthe error log is:\n2013-07-18 03:19:14.714 DEBUG nova.compute.manager [req-067c64aa-313f-49fc-b47b-2e83391f72ad admin admin] [instance: ddb764e6-c07a-4e81-8347-283213b84a98] Instance has been destroyed from under us while trying to set it to ERROR from (pid=7552) _set_instance_error_state /opt/stack/nova/nova/compute/manager.py:430\n2013-07-18 03:19:14.717 DEBUG nova.openstack.common.rpc.amqp [req-067c64aa-313f-49fc-b47b-2e83391f72ad admin admin] Making synchronous call on conductor ... from (pid=7552) multicall /opt/stack/nova/nova/openstack/common/rpc/amqp.py:518\n2013-07-18 03:19:14.718 DEBUG nova.openstack.common.rpc.amqp [req-067c64aa-313f-49fc-b47b-2e83391f72ad admin admin] MSG_ID is c57691619c834285bbbf786f16e01a5a from (pid=7552) multicall /opt/stack/nova/nova/openstack/common/rpc/amqp.py:521\n2013-07-18 03:19:14.718 DEBUG nova.openstack.common.rpc.amqp [req-067c64aa-313f-49fc-b47b-2e83391f72ad admin admin] UNIQUE_ID is a1e36d387f0045e5bc9c67bfe4dbdf6a. from (pid=7552) _add_unique_id /opt/stack/nova/nova/openstack/common/rpc/amqp.py:327\n2013-07-18 03:19:14.751 ERROR nova.openstack.common.rpc.amqp [req-067c64aa-313f-49fc-b47b-2e83391f72ad admin admin] Exception during message handling\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 426, in _process_data\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     **args)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     result = getattr(proxyobj, method)(ctxt, **kwargs)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 99, in wrapped\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     temp_level, payload)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     self.gen.next()\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/exception.py\", line 76, in wrapped\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     return f(self, context, *args, **kw)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 279, in decorated_function\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     function(self, context, *args, **kwargs)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 243, in decorated_function\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     return function(self, context, *args, **kwargs)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 2410, in confirm_resize\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     system_metadata=sys_meta)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/compute/manager.py\", line 414, in _instance_update\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     **kwargs)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/conductor/api.py\", line 414, in instance_update\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     updates, 'conductor')\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 134, in instance_update\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     version='1.38')\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/proxy.py\", line 126, in call\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     result = rpc.call(context, real_topic, msg, timeout)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/__init__.py\", line 140, in call\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     return _get_impl().call(CONF, context, topic, msg, timeout)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/impl_kombu.py\", line 824, in call\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     rpc_amqp.get_connection_pool(conf, Connection))\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 539, in call\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     rv = list(rv)\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp   File \"/opt/stack/nova/nova/openstack/common/rpc/amqp.py\", line 504, in __iter__\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp     raise result\n2013-07-18 03:19:14.751 TRACE nova.openstack.common.rpc.amqp InstanceNotFound_Remote: Instance ddb764e6-c07a-4e81-8347-283213b84a98 could not be found.", 
            "date_created": "2013-07-18 03:34:36.174504+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "if this bug occurs, the network rules on the source host will not be clean, too.\nbecause the clean up operation in _cleanup_resize() is not run:\n            self.unplug_vifs(instance, network_info)\n            self.firewall_driver.unfilter_instance(instance, network_info)", 
            "date_created": "2013-07-18 07:44:15.805607+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/37836", 
            "date_created": "2013-07-19 03:58:11.569790+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/44639", 
            "date_created": "2013-09-02 07:26:23.659112+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "https://review.openstack.org/37836 was abandoned, and https://review.openstack.org/44639 is the new commit.", 
            "date_created": "2013-09-06 02:11:48.218342+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/44639\nCommitted: http://github.com/openstack/nova/commit/8db14390d418561f7c372902a4a383dc9047603c\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8db14390d418561f7c372902a4a383dc9047603c\nAuthor: Wangpan <email address hidden>\nDate:   Mon Sep 2 15:24:16 2013 +0800\n\n    Fixes race cond between delete and confirm resize\n    \n    If we delete an instance after a confirming resize operation,\n    and if the instance is deleted firstly at the dest compute node,\n    then the *_resize dir and network info of this instance will be\n    left alone on the source compute node, never be cleaned up.\n    Please refer the bug page to get the reproduce steps\n    \n    Fixes bug 1202484\n    \n    Change-Id: Ib1e3d976373bd7f4d086d4f9716b0bca4b383bab\n", 
            "date_created": "2013-09-23 01:35:31.315446+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-10-03 07:59:20.284982+00:00"
}