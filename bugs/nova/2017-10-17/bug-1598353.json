{
    "status": "In Progress", 
    "last_updated": "2017-06-29 11:46:35.057132+00:00", 
    "description": "Description\n===========\nI did live-migration for an instance, error occured by libvirt process.\nThen I found field of 'cleaned' was '1' in instances table, but this instance was not deleted.\n\nSteps to reproduce\n==================\n* I did live-migrate instance:\n  $ nova live-migration --block fa0b2b1e-4e00-43bf-bb5d-13ba86277846\n\n* then I found this instance's vm_state was active and instance's host was still on source compute node.\nlog is as follow:\n2016-07-02 12:06:19.656 4078 ERROR nova.virt.libvirt.driver [req-29a088d7-e52c-43bf-b872-92c34175b8d4 0b78e7b5c15c49769d4f5af63628164c e948821962cd4509a6c687c7b7dcb96f - - -] [instance: fa0b2b1e-4e00-43bf-bb5d-13ba86277846] Live Migration failure: failed to connect to monitor socket: No such process\n2016-07-02 12:06:20.044 4078 ERROR nova.virt.libvirt.driver [req-29a088d7-e52c-43bf-b872-92c34175b8d4 0b78e7b5c15c49769d4f5af63628164c e948821962cd4509a6c687c7b7dcb96f - - -] [instance: fa0b2b1e-4e00-43bf-bb5d-13ba86277846] Migration operation has aborted\n\n* then I query database\nMariaDB [nova]> select uuid,updated_at,deleted,cleaned from instances where deleted=0 and cleaned=1;\n+--------------------------------------+---------------------+---------+---------+\n| uuid                                 | updated_at          | deleted | cleaned |\n+--------------------------------------+---------------------+---------+---------+\n| fa0b2b1e-4e00-43bf-bb5d-13ba86277846 | 2016-07-02 04:06:22 |       0 |       1 |\n+--------------------------------------+---------------------+---------+---------+\n1 row in set (0.00 sec)\n\nMariaDB [nova]> select * from migrations where instance_uuid='fa0b2b1e-4e00-43bf-bb5d-13ba86277846';\n+---------------------+---------------------+------------+------+----------------+---------------------+-------------+---------------+--------------------------------------+----------------------+----------------------+-------------+---------------------+---------+----------------+--------+\n| created_at          | updated_at          | deleted_at | id   | source_compute | dest_compute        | dest_host   | status        | instance_uuid                        | old_instance_type_id | new_instance_type_id | source_node | dest_node           | deleted | migration_type | hidden |\n+---------------------+---------------------+------------+------+----------------+---------------------+-------------+---------------+--------------------------------------+----------------------+----------------------+-------------+---------------------+---------+----------------+--------+\n| 2016-07-02 04:06:02 | 2016-07-02 04:06:20 | NULL       | 1912 | SBCRslot2      | SBCR-chenling-slot4 | 10.43.239.3 | error         | fa0b2b1e-4e00-43bf-bb5d-13ba86277846 |                  207 |                  207 | NULL        | SBCR-chenling-slot4 |       0 | live-migration |      0 |\n+---------------------+---------------------+------------+------+----------------+---------------------+-------------+---------------+--------------------------------------+----------------------+----------------------+-------------+---------------------+---------+----------------+--------+\n1 row in set (0.00 sec)\n\nExpected result\n===============\nI hope instance's cleaned is 0.\n\nActual result\n=============\n+--------------------------------------+---------------------+---------+---------+\n| uuid                                 | updated_at          | deleted | cleaned |\n+--------------------------------------+---------------------+---------+---------+\n| fa0b2b1e-4e00-43bf-bb5d-13ba86277846 | 2016-07-02 04:06:22 |       0 |       1 |\n+--------------------------------------+---------------------+---------+---------+\n\ndeleted == 0 and cleaned == 1, which is not consistent.\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n  Mitaka\n\n2. Which hypervisor did you use?\n   Libvirt + KVM\n\n3. Which storage type did you use?\n   Local storage\n\n3. Which networking type did you use?\n   Neutron with OpenVSwitch", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1598353", 
    "owner": "https://api.launchpad.net/1.0/~hanrong", 
    "id": 1598353, 
    "index": 4568, 
    "openned": "2016-07-02 03:58:16.736180+00:00", 
    "created": "2016-07-02 03:58:16.736180+00:00", 
    "title": "Instance's cleaned filed was set 1 after rollback at destination when do live-migration failed", 
    "comments": [
        {
            "content": "Description\n===========\nI did live-migration for an instance, error occured by libvirt process.\nThen I found field of 'cleaned' was '1' in instances table, but this instance was not deleted.\n\nSteps to reproduce\n==================\n* I did live-migrate instance:\n  $ nova live-migration --block fa0b2b1e-4e00-43bf-bb5d-13ba86277846\n\n* then I found this instance's vm_state was active and instance's host was still on source compute node.\nlog is as follow:\n2016-07-02 12:06:19.656 4078 ERROR nova.virt.libvirt.driver [req-29a088d7-e52c-43bf-b872-92c34175b8d4 0b78e7b5c15c49769d4f5af63628164c e948821962cd4509a6c687c7b7dcb96f - - -] [instance: fa0b2b1e-4e00-43bf-bb5d-13ba86277846] Live Migration failure: failed to connect to monitor socket: No such process\n2016-07-02 12:06:20.044 4078 ERROR nova.virt.libvirt.driver [req-29a088d7-e52c-43bf-b872-92c34175b8d4 0b78e7b5c15c49769d4f5af63628164c e948821962cd4509a6c687c7b7dcb96f - - -] [instance: fa0b2b1e-4e00-43bf-bb5d-13ba86277846] Migration operation has aborted\n\n* then I query database\nMariaDB [nova]> select uuid,updated_at,deleted,cleaned from instances where deleted=0 and cleaned=1;\n+--------------------------------------+---------------------+---------+---------+\n| uuid                                 | updated_at          | deleted | cleaned |\n+--------------------------------------+---------------------+---------+---------+\n| fa0b2b1e-4e00-43bf-bb5d-13ba86277846 | 2016-07-02 04:06:22 |       0 |       1 |\n+--------------------------------------+---------------------+---------+---------+\n1 row in set (0.00 sec)\n\nMariaDB [nova]> select * from migrations where instance_uuid='fa0b2b1e-4e00-43bf-bb5d-13ba86277846';\n+---------------------+---------------------+------------+------+----------------+---------------------+-------------+---------------+--------------------------------------+----------------------+----------------------+-------------+---------------------+---------+----------------+--------+\n| created_at          | updated_at          | deleted_at | id   | source_compute | dest_compute        | dest_host   | status        | instance_uuid                        | old_instance_type_id | new_instance_type_id | source_node | dest_node           | deleted | migration_type | hidden |\n+---------------------+---------------------+------------+------+----------------+---------------------+-------------+---------------+--------------------------------------+----------------------+----------------------+-------------+---------------------+---------+----------------+--------+\n| 2016-07-02 04:06:02 | 2016-07-02 04:06:20 | NULL       | 1912 | SBCRslot2      | SBCR-chenling-slot4 | 10.43.239.3 | error         | fa0b2b1e-4e00-43bf-bb5d-13ba86277846 |                  207 |                  207 | NULL        | SBCR-chenling-slot4 |       0 | live-migration |      0 |\n+---------------------+---------------------+------------+------+----------------+---------------------+-------------+---------------+--------------------------------------+----------------------+----------------------+-------------+---------------------+---------+----------------+--------+\n1 row in set (0.00 sec)\n\nExpected result\n===============\nI hope instance's cleaned is 0.\n\nActual result\n=============\n+--------------------------------------+---------------------+---------+---------+\n| uuid                                 | updated_at          | deleted | cleaned |\n+--------------------------------------+---------------------+---------+---------+\n| fa0b2b1e-4e00-43bf-bb5d-13ba86277846 | 2016-07-02 04:06:22 |       0 |       1 |\n+--------------------------------------+---------------------+---------+---------+\n\ndeleted == 0 and cleaned == 1, which is not consistent.\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n  Mitaka\n\n2. Which hypervisor did you use?\n   Libvirt + KVM\n\n3. Which storage type did you use?\n   Local storage\n\n3. Which networking type did you use?\n   Neutron with OpenVSwitch", 
            "date_created": "2016-07-02 03:58:16.736180+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "I found when live-migration successfully, the value of field 'cleaned' of migrated instance was correct too.\n\ndeleted == 0 and cleaned == 1, which is not consistent.", 
            "date_created": "2016-07-02 06:25:51.888444+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "There are no currently open reviews on this bug, changing the status back to the previous state and unassigning. If there are active reviews related to this bug, please include links in comments. ", 
            "date_created": "2017-06-27 19:23:14.398977+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Found open reviews for this bug in gerrit, setting to In Progress. \n\nreview: https://review.openstack.org/336771 in branch: master\n", 
            "date_created": "2017-06-29 11:46:34.527477+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}