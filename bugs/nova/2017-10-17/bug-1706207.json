{
    "status": "Fix Released", 
    "last_updated": "2017-07-28 07:40:05.825998+00:00", 
    "description": "Seen here:\n\nhttp://logs.openstack.org/02/485602/6/check/gate-nova-tox-functional-ubuntu-xenial/edf4c41/console.html#_2017-07-24_18_52_05_651293\n\n2017-07-24 18:52:05.638101 | nova.tests.functional.api.openstack.placement.test_placement_api.resource-class-in-use_delete_resource_class.test_request\n2017-07-24 18:52:05.638130 | -------------------------------------------------------------------------------------------------------------------------\n2017-07-24 18:52:05.638135 | \n2017-07-24 18:52:05.638143 | Captured traceback:\n2017-07-24 18:52:05.638152 | ~~~~~~~~~~~~~~~~~~~\n2017-07-24 18:52:05.638164 |     Traceback (most recent call last):\n2017-07-24 18:52:05.638201 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 93, in wrapper\n2017-07-24 18:52:05.638209 |         func(self)\n2017-07-24 18:52:05.638246 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 141, in test_request\n2017-07-24 18:52:05.638256 |         self._run_test()\n2017-07-24 18:52:05.638293 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 499, in _run_test\n2017-07-24 18:52:05.638304 |         self._assert_response()\n2017-07-24 18:52:05.638342 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 183, in _assert_response\n2017-07-24 18:52:05.638362 |         self._test_status(self.test_data['status'], self.response['status'])\n2017-07-24 18:52:05.638399 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 539, in _test_status\n2017-07-24 18:52:05.638419 |         self.assert_in_or_print_output(observed_status, statii)\n2017-07-24 18:52:05.638459 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 600, in assert_in_or_print_output\n2017-07-24 18:52:05.638469 |         self.fail(msg)\n2017-07-24 18:52:05.651245 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/unittest2/case.py\", line 690, in fail\n2017-07-24 18:52:05.651275 |         raise self.failureException(msg)\n2017-07-24 18:52:05.651293 |     AssertionError: '404' not found in ['204'], response:\n2017-07-24 18:52:05.651299 |     {\n2017-07-24 18:52:05.651308 |       \"errors\": [\n2017-07-24 18:52:05.651315 |         {\n2017-07-24 18:52:05.651325 |           \"status\": 404,\n2017-07-24 18:52:05.651336 |           \"title\": \"Not Found\",\n2017-07-24 18:52:05.651358 |           \"detail\": \"The resource could not be found.\\n\\n Resource could not be found.  \",\n2017-07-24 18:52:05.651377 |           \"request_id\": \"req-15235c69-224a-4030-bf4e-5b16c3922fbd\"\n2017-07-24 18:52:05.651383 |         }\n2017-07-24 18:52:05.651390 |       ]\n2017-07-24 18:52:05.651396 |     }\n2017-07-24 18:52:05.651402 |     \n2017-07-24 18:52:05.651407 | \n2017-07-24 18:52:05.651416 | Captured pythonlogging:\n2017-07-24 18:52:05.651425 | ~~~~~~~~~~~~~~~~~~~~~~~\n2017-07-24 18:52:05.651462 |     2017-07-24 18:30:03,444 INFO [nova.api.openstack.placement.requestlog] 127.0.0.1 \"DELETE /resource_classes/CUSTOM_GOLD\" status: 404 len: 190 microversion: 1.10\n\nThis fails when nova.tests.functional.api.openstack.placement.test_placement_api.resource-class-in-use_create_a_resource_class.test_request fails with:\n\ntesttools.matchers._impl.MismatchError: '204' not in ['201']\n2017-07-24 18:52:05.638002 |     \n2017-07-24 18:52:05.638007 | \n2017-07-24 18:52:05.638016 | Captured pythonlogging:\n2017-07-24 18:52:05.638026 | ~~~~~~~~~~~~~~~~~~~~~~~\n2017-07-24 18:52:05.638061 |     2017-07-24 18:30:03,314 INFO [nova.api.openstack.placement.requestlog] 127.0.0.1 \"PUT /resource_classes/CUSTOM_GOLD\" status: 204 len: 0 microversion: 1.10\n\nSo the PUT is expecting a 201 but it's getting a 204, and then the DELETE fails with a 404 when it's expecting a 204.\n\nLooks like the failures would correlate with this change being merged on 7/23:\n\nhttps://review.openstack.org/#/c/484154/\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22INFO%20%5Bnova.api.openstack.placement.requestlog%5D%20127.0.0.1%20%5C%5C%5C%22PUT%20%2Fresource_classes%2FCUSTOM_GOLD%5C%5C%5C%22%20status%3A%20204%20len%3A%200%20microversion%3A%201.10%5C%22%20AND%20tags%3A%5C%22console%5C%22&from=7d\n\n19 hits in 7/22, check and gate, all failures.", 
    "tags": [
        "placement", 
        "testing"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1706207", 
    "owner": "https://api.launchpad.net/1.0/~cdent", 
    "id": 1706207, 
    "index": 2113, 
    "openned": "2017-07-24 21:53:46.632293+00:00", 
    "created": "2017-07-24 21:53:46.632293+00:00", 
    "title": "resource-class-in-use_create_a_resource_class fails with 'MismatchError: '204' not in ['201']' since 7/22", 
    "comments": [
        {
            "content": "Seen here:\n\nhttp://logs.openstack.org/02/485602/6/check/gate-nova-tox-functional-ubuntu-xenial/edf4c41/console.html#_2017-07-24_18_52_05_651293\n\n2017-07-24 18:52:05.638101 | nova.tests.functional.api.openstack.placement.test_placement_api.resource-class-in-use_delete_resource_class.test_request\n2017-07-24 18:52:05.638130 | -------------------------------------------------------------------------------------------------------------------------\n2017-07-24 18:52:05.638135 | \n2017-07-24 18:52:05.638143 | Captured traceback:\n2017-07-24 18:52:05.638152 | ~~~~~~~~~~~~~~~~~~~\n2017-07-24 18:52:05.638164 |     Traceback (most recent call last):\n2017-07-24 18:52:05.638201 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 93, in wrapper\n2017-07-24 18:52:05.638209 |         func(self)\n2017-07-24 18:52:05.638246 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 141, in test_request\n2017-07-24 18:52:05.638256 |         self._run_test()\n2017-07-24 18:52:05.638293 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 499, in _run_test\n2017-07-24 18:52:05.638304 |         self._assert_response()\n2017-07-24 18:52:05.638342 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 183, in _assert_response\n2017-07-24 18:52:05.638362 |         self._test_status(self.test_data['status'], self.response['status'])\n2017-07-24 18:52:05.638399 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 539, in _test_status\n2017-07-24 18:52:05.638419 |         self.assert_in_or_print_output(observed_status, statii)\n2017-07-24 18:52:05.638459 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/gabbi/case.py\", line 600, in assert_in_or_print_output\n2017-07-24 18:52:05.638469 |         self.fail(msg)\n2017-07-24 18:52:05.651245 |       File \"/home/jenkins/workspace/gate-nova-tox-functional-ubuntu-xenial/.tox/functional/local/lib/python2.7/site-packages/unittest2/case.py\", line 690, in fail\n2017-07-24 18:52:05.651275 |         raise self.failureException(msg)\n2017-07-24 18:52:05.651293 |     AssertionError: '404' not found in ['204'], response:\n2017-07-24 18:52:05.651299 |     {\n2017-07-24 18:52:05.651308 |       \"errors\": [\n2017-07-24 18:52:05.651315 |         {\n2017-07-24 18:52:05.651325 |           \"status\": 404,\n2017-07-24 18:52:05.651336 |           \"title\": \"Not Found\",\n2017-07-24 18:52:05.651358 |           \"detail\": \"The resource could not be found.\\n\\n Resource could not be found.  \",\n2017-07-24 18:52:05.651377 |           \"request_id\": \"req-15235c69-224a-4030-bf4e-5b16c3922fbd\"\n2017-07-24 18:52:05.651383 |         }\n2017-07-24 18:52:05.651390 |       ]\n2017-07-24 18:52:05.651396 |     }\n2017-07-24 18:52:05.651402 |     \n2017-07-24 18:52:05.651407 | \n2017-07-24 18:52:05.651416 | Captured pythonlogging:\n2017-07-24 18:52:05.651425 | ~~~~~~~~~~~~~~~~~~~~~~~\n2017-07-24 18:52:05.651462 |     2017-07-24 18:30:03,444 INFO [nova.api.openstack.placement.requestlog] 127.0.0.1 \"DELETE /resource_classes/CUSTOM_GOLD\" status: 404 len: 190 microversion: 1.10\n\nThis fails when nova.tests.functional.api.openstack.placement.test_placement_api.resource-class-in-use_create_a_resource_class.test_request fails with:\n\ntesttools.matchers._impl.MismatchError: '204' not in ['201']\n2017-07-24 18:52:05.638002 |     \n2017-07-24 18:52:05.638007 | \n2017-07-24 18:52:05.638016 | Captured pythonlogging:\n2017-07-24 18:52:05.638026 | ~~~~~~~~~~~~~~~~~~~~~~~\n2017-07-24 18:52:05.638061 |     2017-07-24 18:30:03,314 INFO [nova.api.openstack.placement.requestlog] 127.0.0.1 \"PUT /resource_classes/CUSTOM_GOLD\" status: 204 len: 0 microversion: 1.10\n\nSo the PUT is expecting a 201 but it's getting a 204, and then the DELETE fails with a 404 when it's expecting a 204.\n\nLooks like the failures would correlate with this change being merged on 7/23:\n\nhttps://review.openstack.org/#/c/484154/\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22INFO%20%5Bnova.api.openstack.placement.requestlog%5D%20127.0.0.1%20%5C%5C%5C%22PUT%20%2Fresource_classes%2FCUSTOM_GOLD%5C%5C%5C%22%20status%3A%20204%20len%3A%200%20microversion%3A%201.10%5C%22%20AND%20tags%3A%5C%22console%5C%22&from=7d\n\n19 hits in 7/22, check and gate, all failures.", 
            "date_created": "2017-07-24 21:53:46.632293+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "In the failed run, this class creates the same custom resource class:\n\n2017-07-24 18:30:02.936984 | {3} nova.tests.functional.api.openstack.placement.test_placement_api.allocation-bad-class_create_a_resource_class.test_request [0.010374s] ... ok\n\nAnd they are running on the same process. They should be separate databases in sqlite given the APIFixture used in the tests, but maybe eventlet thread goofiness messed up the responses.", 
            "date_created": "2017-07-24 22:19:33.465869+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/486782", 
            "date_created": "2017-07-24 22:22:20.377307+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/486805", 
            "date_created": "2017-07-25 01:06:07.678637+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The second fix (in comment #3) is probably better: the root of the problem is re-use of the RC_CACHE.", 
            "date_created": "2017-07-25 01:09:37.922661+00:00", 
            "author": "https://api.launchpad.net/1.0/~cdent"
        }, 
        {
            "content": "Change abandoned by Matt Riedemann (<email address hidden>) on branch: master\nReview: https://review.openstack.org/486782\nReason: Functional tests passed on https://review.openstack.org/#/c/486805/ and that's a cleaner solution so let's just go with that.", 
            "date_created": "2017-07-25 01:44:00.073010+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/486805\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=997ba03094062799349e8275026462c549d3989a\nSubmitter: Jenkins\nBranch:    master\n\ncommit 997ba03094062799349e8275026462c549d3989a\nAuthor: Chris Dent <email address hidden>\nDate:   Tue Jul 25 01:59:52 2017 +0100\n\n    [placement] Flush RC_CACHE after each gabbit sequence\n    \n    Each gabbi yaml file is supposed to be an isolated sequence. The\n    fixtures were already making sure that the database was wiped, and the\n    traits sync was reset, but not making sure the _RC_CACHE used to cache\n    mappings between resource class strings and ids was flushed.\n    \n    This change clears the _RC_CACHE in the APIFixture stop_fixture method.\n    \n    For sake of information:\n    Before fixing the issue it was confirmed by running the two gabbi files\n    indicated in the bug report, in sequence, in a single process:\n    \n        .tox/functional/bin/python -m subunit.run discover \\\n            nova.tests.functional.api.openstack.placement \\\n            --load-list /tmp/runthese |subunit-trace\n    \n    Where runthese contains (with fully qualified package name prefixes):\n    \n    test_placement_api.allocation-bad-class_allocate_some_of_it_standard.test_request\n    test_placement_api.resource-class-in-use_delete_resource_class.test_request\n    \n    Change-Id: Icb3beef7964887f29bf8cca95ac7dbae1511876d\n    Closes-Bug: #1706207\n", 
            "date_created": "2017-07-25 12:19:20.931849+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b3 development milestone.", 
            "date_created": "2017-07-28 07:40:04.344658+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-07-25 12:19:19.298896+00:00"
}