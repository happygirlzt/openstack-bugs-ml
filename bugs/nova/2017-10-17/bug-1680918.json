{
    "status": "Fix Released", 
    "last_updated": "2017-06-08 21:53:10.210173+00:00", 
    "description": "Description\n===========\nIf a Nova DB is upgraded (migrated) while containing PCI devices with device type 'type-PF' or 'type-PCI',\na validation error similar to this will be thrown:\n\n\"ValidationError: There are still 2 unmigrated records in the pci_devices table. Migration cannot continue until all records have been migrated.\"\n\nThe error is generated by the 330_enforce_mitaka_online_migrations.py upgrade script.\n\nThe PCI device migration validation will fail if any PCI device entries without a populated parent_addr are found.  However, the parent_addr really only applies to PCI device entries of 'type-VF' (ie. SRIOV virtual functions)\n\nThis is an example of what the pci_devices table looks like with SRIOV enabled PCI devices if the appropriate entries are whitelisted in nova.conf:\n\nMariaDB [nova]> select * from pci_devices;\n+---------------------+---------------------+------------+---------+----+-----------------+--------------+------------+-----------+----------+------------------+-----------------+-----------+------------+---------------+------------+-----------+--------------+\n| created_at          | updated_at          | deleted_at | deleted | id | compute_node_id | address      | product_id | vendor_id | dev_type | dev_id           | label           | status    | extra_info | instance_uuid | request_id | numa_node | parent_addr  |\n+---------------------+---------------------+------------+---------+----+-----------------+--------------+------------+-----------+----------+------------------+-----------------+-----------+------------+---------------+------------+-----------+--------------+\n| 2017-04-06 21:01:21 | 2017-04-06 21:53:13 | NULL       |       0 |  1 |               1 | 0000:05:10.1 | 10ed       | 8086      | type-VF  | pci_0000_05_10_1 | label_8086_10ed | available | {}         | NULL          | NULL       |         0 | 0000:05:00.1 |\n| 2017-04-06 21:01:21 | 2017-04-06 21:53:13 | NULL       |       0 |  2 |               1 | 0000:05:10.3 | 10ed       | 8086      | type-VF  | pci_0000_05_10_3 | label_8086_10ed | available | {}         | NULL          | NULL       |         0 | 0000:05:00.1 |\n| 2017-04-06 21:01:21 | 2017-04-06 21:53:13 | NULL       |       0 |  3 |               1 | 0000:05:10.5 | 10ed       | 8086      | type-VF  | pci_0000_05_10_5 | label_8086_10ed | available | {}         | NULL          | NULL       |         0 | 0000:05:00.1 |\n| 2017-04-06 21:01:21 | 2017-04-06 21:53:13 | NULL       |       0 |  4 |               1 | 0000:05:10.7 | 10ed       | 8086      | type-VF  | pci_0000_05_10_7 | label_8086_10ed | available | {}         | NULL          | NULL       |         0 | 0000:05:00.1 |\n| 2017-04-06 21:53:13 | NULL                | NULL       |       0 |  5 |               1 | 0000:05:00.0 | 10fb       | 8086      | type-PF  | pci_0000_05_00_0 | label_8086_10fb | available | {}         | NULL          | NULL       |         0 | NULL         |\n| 2017-04-06 21:53:13 | NULL                | NULL       |       0 |  6 |               1 | 0000:05:00.1 | 10fb       | 8086      | type-PF  | pci_0000_05_00_1 | label_8086_10fb | available | {}         | NULL          | NULL       |         0 | NULL         |\n+---------------------+---------------------+------------+---------+----+-----------------+--------------+------------+-----------+----------+------------------+-----------------+-----------+------------+---------------+------------+-----------+--------------+\n6 rows in set (0.00 sec)\n\n\nI think the upgrade script should be checking the PciDevice dev_type field for 'type-VF' when validating the parent_addr.\n\n\nSteps to reproduce\n==================\n\n1. Install a Mitaka control node and edit the nova.conf file to include 1 or more PCI devices in the pci_passthrough_whitelist.  ie:\n\npci_passthrough_whitelist = {\"vendor_id\": \"8086\", \"product_id\":\"10fb\"}\n\n2. Install a second Newton or newer control node and edit the nova.conf to point to the SQL database of the Mitaka node. ie:\n\n[database]\nconnection = mysql+pymysql://root:supersecret@<MITAKA CONTROLLER NODE>/nova?charset=utf8\n \n[api_database]\nconnection = mysql+pymysql://root:supersecret@<MITAKA CONTROLLER NODE>/nova_api?charset=utf8\n\n3. From the new control node, issue the following command:\n\nnova-manage db sync\n\nExpected result\n===============\nDatabase migration/upgrade should succeed\n\nActual result\n=============\nA ValidationError, similar to:\n\n\"ValidationError: There are still <N> unmigrated records in the pci_devices table. Migration cannot continue until all records have been migrated.\"\n\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n   Mitaka (old node) Newton, Ocata (new node)\n\n2. Which hypervisor did you use?\n   libvirt + kvm\n\n2. Which storage type did you use?\n   lvm\n\n3. Which networking type did you use?\n   Neutron, OVS\n\nLogs & Configs\n==============\nSee attached", 
    "tags": [
        "pci"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1680918", 
    "owner": "https://api.launchpad.net/1.0/~swebster-wr", 
    "id": 1680918, 
    "index": 2062, 
    "openned": "2017-04-07 17:38:38.775157+00:00", 
    "created": "2017-04-07 17:38:38.775157+00:00", 
    "title": "Nova upgrade fails if PCI devices of type-PF or type-PCI are present in the database", 
    "comments": [
        {
            "content": "Description\n===========\nIf a Nova DB is upgraded (migrated) while containing PCI devices with device type 'type-PF' or 'type-PCI',\na validation error similar to this will be thrown:\n\n\"ValidationError: There are still 2 unmigrated records in the pci_devices table. Migration cannot continue until all records have been migrated.\"\n\nThe error is generated by the 330_enforce_mitaka_online_migrations.py upgrade script.\n\nThe PCI device migration validation will fail if any PCI device entries without a populated parent_addr are found.  However, the parent_addr really only applies to PCI device entries of 'type-VF' (ie. SRIOV virtual functions)\n\nThis is an example of what the pci_devices table looks like with SRIOV enabled PCI devices if the appropriate entries are whitelisted in nova.conf:\n\nMariaDB [nova]> select * from pci_devices;\n+---------------------+---------------------+------------+---------+----+-----------------+--------------+------------+-----------+----------+------------------+-----------------+-----------+------------+---------------+------------+-----------+--------------+\n| created_at          | updated_at          | deleted_at | deleted | id | compute_node_id | address      | product_id | vendor_id | dev_type | dev_id           | label           | status    | extra_info | instance_uuid | request_id | numa_node | parent_addr  |\n+---------------------+---------------------+------------+---------+----+-----------------+--------------+------------+-----------+----------+------------------+-----------------+-----------+------------+---------------+------------+-----------+--------------+\n| 2017-04-06 21:01:21 | 2017-04-06 21:53:13 | NULL       |       0 |  1 |               1 | 0000:05:10.1 | 10ed       | 8086      | type-VF  | pci_0000_05_10_1 | label_8086_10ed | available | {}         | NULL          | NULL       |         0 | 0000:05:00.1 |\n| 2017-04-06 21:01:21 | 2017-04-06 21:53:13 | NULL       |       0 |  2 |               1 | 0000:05:10.3 | 10ed       | 8086      | type-VF  | pci_0000_05_10_3 | label_8086_10ed | available | {}         | NULL          | NULL       |         0 | 0000:05:00.1 |\n| 2017-04-06 21:01:21 | 2017-04-06 21:53:13 | NULL       |       0 |  3 |               1 | 0000:05:10.5 | 10ed       | 8086      | type-VF  | pci_0000_05_10_5 | label_8086_10ed | available | {}         | NULL          | NULL       |         0 | 0000:05:00.1 |\n| 2017-04-06 21:01:21 | 2017-04-06 21:53:13 | NULL       |       0 |  4 |               1 | 0000:05:10.7 | 10ed       | 8086      | type-VF  | pci_0000_05_10_7 | label_8086_10ed | available | {}         | NULL          | NULL       |         0 | 0000:05:00.1 |\n| 2017-04-06 21:53:13 | NULL                | NULL       |       0 |  5 |               1 | 0000:05:00.0 | 10fb       | 8086      | type-PF  | pci_0000_05_00_0 | label_8086_10fb | available | {}         | NULL          | NULL       |         0 | NULL         |\n| 2017-04-06 21:53:13 | NULL                | NULL       |       0 |  6 |               1 | 0000:05:00.1 | 10fb       | 8086      | type-PF  | pci_0000_05_00_1 | label_8086_10fb | available | {}         | NULL          | NULL       |         0 | NULL         |\n+---------------------+---------------------+------------+---------+----+-----------------+--------------+------------+-----------+----------+------------------+-----------------+-----------+------------+---------------+------------+-----------+--------------+\n6 rows in set (0.00 sec)\n\n\nI think the upgrade script should be checking the PciDevice dev_type field for 'type-VF' when validating the parent_addr.\n\n\nSteps to reproduce\n==================\n\n1. Install a Mitaka control node and edit the nova.conf file to include 1 or more PCI devices in the pci_passthrough_whitelist.  ie:\n\npci_passthrough_whitelist = {\"vendor_id\": \"8086\", \"product_id\":\"10fb\"}\n\n2. Install a second Newton or newer control node and edit the nova.conf to point to the SQL database of the Mitaka node. ie:\n\n[database]\nconnection = mysql+pymysql://root:supersecret@<MITAKA CONTROLLER NODE>/nova?charset=utf8\n \n[api_database]\nconnection = mysql+pymysql://root:supersecret@<MITAKA CONTROLLER NODE>/nova_api?charset=utf8\n\n3. From the new control node, issue the following command:\n\nnova-manage db sync\n\nExpected result\n===============\nDatabase migration/upgrade should succeed\n\nActual result\n=============\nA ValidationError, similar to:\n\n\"ValidationError: There are still <N> unmigrated records in the pci_devices table. Migration cannot continue until all records have been migrated.\"\n\n\nEnvironment\n===========\n1. Exact version of OpenStack you are running. See the following\n   Mitaka (old node) Newton, Ocata (new node)\n\n2. Which hypervisor did you use?\n   libvirt + kvm\n\n2. Which storage type did you use?\n   lvm\n\n3. Which networking type did you use?\n   Neutron, OVS\n\nLogs & Configs\n==============\nSee attached", 
            "date_created": "2017-04-07 17:38:38.775157+00:00", 
            "author": "https://api.launchpad.net/1.0/~swebster-wr"
        }, 
        {
            "content": "", 
            "date_created": "2017-04-07 17:38:38.775157+00:00", 
            "author": "https://api.launchpad.net/1.0/~swebster-wr"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/456397", 
            "date_created": "2017-04-12 21:23:58.456513+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/456397\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7f3f0ef1fbb51f6f17d2c13840e0f98d17fa9093\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7f3f0ef1fbb51f6f17d2c13840e0f98d17fa9093\nAuthor: Steven Webster <email address hidden>\nDate:   Wed Apr 5 09:05:07 2017 -0400\n\n    Fix mitaka online migration for PCI devices\n    \n    Currently, a validation error is thrown if we find any PCI device\n    records which have not populated the parent_addr column on a nova\n    upgrade. However, the only PCI records for which a parent_addr\n    makes sense for are those with a device type of 'type-VF' (ie. an\n    SRIOV virtual function).  PCI records with a device type of 'type-PF'\n    or 'type-PCI' will not have a parent_addr.  If any of those records\n    are present on upgrade, the validation will fail.\n    \n    This change checks that the device type of the PCI record is\n    'type-VF' when making sure the parent_addr has been correctly\n    populated\n    \n    Closes-Bug: #1680918\n    Change-Id: Ia7e773674a4976fc03deee3f08a6ddb45568ec11\n", 
            "date_created": "2017-04-20 18:49:56.386599+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/458667", 
            "date_created": "2017-04-20 21:48:37.456773+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/458668", 
            "date_created": "2017-04-20 21:49:38.160537+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/458668\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ad12fa65f5cc06bdee52be49b7370d703855d618\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit ad12fa65f5cc06bdee52be49b7370d703855d618\nAuthor: Steven Webster <email address hidden>\nDate:   Wed Apr 5 09:05:07 2017 -0400\n\n    Fix mitaka online migration for PCI devices\n    \n    Currently, a validation error is thrown if we find any PCI device\n    records which have not populated the parent_addr column on a nova\n    upgrade. However, the only PCI records for which a parent_addr\n    makes sense for are those with a device type of 'type-VF' (ie. an\n    SRIOV virtual function).  PCI records with a device type of 'type-PF'\n    or 'type-PCI' will not have a parent_addr.  If any of those records\n    are present on upgrade, the validation will fail.\n    \n    This change checks that the device type of the PCI record is\n    'type-VF' when making sure the parent_addr has been correctly\n    populated\n    \n    Closes-Bug: #1680918\n    Change-Id: Ia7e773674a4976fc03deee3f08a6ddb45568ec11\n    (cherry picked from commit 7f3f0ef1fbb51f6f17d2c13840e0f98d17fa9093)\n    (cherry picked from commit c23c5e9f747e7127497dfd77ca0b33df2be74a2d)\n", 
            "date_created": "2017-04-21 17:41:30.834795+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/458667\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c23c5e9f747e7127497dfd77ca0b33df2be74a2d\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit c23c5e9f747e7127497dfd77ca0b33df2be74a2d\nAuthor: Steven Webster <email address hidden>\nDate:   Wed Apr 5 09:05:07 2017 -0400\n\n    Fix mitaka online migration for PCI devices\n    \n    Currently, a validation error is thrown if we find any PCI device\n    records which have not populated the parent_addr column on a nova\n    upgrade. However, the only PCI records for which a parent_addr\n    makes sense for are those with a device type of 'type-VF' (ie. an\n    SRIOV virtual function).  PCI records with a device type of 'type-PF'\n    or 'type-PCI' will not have a parent_addr.  If any of those records\n    are present on upgrade, the validation will fail.\n    \n    This change checks that the device type of the PCI record is\n    'type-VF' when making sure the parent_addr has been correctly\n    populated\n    \n    Closes-Bug: #1680918\n    Change-Id: Ia7e773674a4976fc03deee3f08a6ddb45568ec11\n    (cherry picked from commit 7f3f0ef1fbb51f6f17d2c13840e0f98d17fa9093)\n", 
            "date_created": "2017-04-25 19:33:39.648576+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.4 release.", 
            "date_created": "2017-05-08 22:10:14.979805+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.6 release.", 
            "date_created": "2017-05-08 22:25:45.976877+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b2 development milestone.", 
            "date_created": "2017-06-08 21:53:09.755756+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-04-20 18:49:54.066066+00:00"
}