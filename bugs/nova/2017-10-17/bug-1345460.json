{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:10:38.742893+00:00", 
    "description": "Doing a nova resize on an instance when using the vsphere driver will cause the instance to go in to error state.\n\nThe problem is that the scheduler will pick another host to spin up a new resized instance and when the user confirms nova will fail because its looking for the instance on the old compute.\n\nHere is the traceback.\n\n2014-07-16 18:14:55.271 13228 DEBUG amqp [-] Closed channel #1 _do_close /usr/lib/python2.7/dist-packages/amqp/channel.py:88\n2014-07-16 18:14:55.271 13228 DEBUG amqp [-] using channel_id: 1 __init__ /usr/lib/python2.7/dist-packages/amqp/channel.py:70\n2014-07-16 18:14:55.273 13228 DEBUG amqp [-] Channel open _open_ok /usr/lib/python2.7/dist-packages/amqp/channel.py:420\n2014-07-16 18:14:55.299 13228 ERROR nova.openstack.common.rpc.amqp [req-3cae0e1d-2cf4-4da7-9aac-0ea5279b829d cherkasj 37af63b6867d4fe38ac312ca626ce186] Exception during message handling\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp **args)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp result = getattr(proxyobj, method)(ctxt, **kwargs)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 353, in decorated_function\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 90, in wrapped\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp payload)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 73, in wrapped\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp return f(self, context, *args, **kw)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 294, in decorated_function\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp function(self, context, *args, **kwargs)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 271, in decorated_function\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp e, sys.exc_info())\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 258, in decorated_function\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2683, in confirm_resize\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp do_confirm_resize(context, instance, migration_id)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/lockutils.py\", line 246, in inner\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp return f(*args, **kwargs)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2680, in do_confirm_resize\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp migration=migration)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2707, in _confirm_resize\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp network_info)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/virt/vmwareapi/driver.py\", line 465, in confirm_migration\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp _vmops = self._get_vmops_for_compute_node(instance['node'])\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/virt/vmwareapi/driver.py\", line 567, in _get_vmops_for_compute_node\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp resource = self._get_resource_for_node(nodename)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/virt/vmwareapi/driver.py\", line 559, in _get_resource_for_node\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp raise exception.NotFound(msg)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp NotFound: The resource domain-c1122(compute02) does not exist\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp\n2014-07-16 18:14:57.595 13228 DEBUG nova.openstack.common.vmware.api [-] Waiting for function _invoke_api to return. func /usr/lib/python2.7/dist-packages/nova/openstack/common/vmware/api.py:120\n2014-07-16 18:14:57.598 13228 DEBUG nova.openstack.common.vmware.api [-] Invoking _invoke_api; retry count is 0. _func /usr/lib/python2.7/dist-packages/nova/openstack/common/vmware/api.py:83\n2014-07-16 18:14:57.598 13228 DEBUG nova.openstack.common.vmware.api [-] Invoking method <module 'nova.virt.vmwareapi.vim_util' from '/usr/lib/python2.7/dist-packages/nova/virt/vmwareap", 
    "tags": [
        "icehouse-backport-potential", 
        "in-stable-juno", 
        "vmware"
    ], 
    "importance": "High", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1345460", 
    "owner": "https://api.launchpad.net/1.0/~garyk", 
    "id": 1345460, 
    "index": 1540, 
    "openned": "2014-07-20 06:23:49.620965+00:00", 
    "created": "2014-07-20 06:23:49.620965+00:00", 
    "title": "VMware: resize fails when there is more than one compute node", 
    "comments": [
        {
            "content": "Doing a nova resize on an instance when using the vsphere driver will cause the instance to go in to error state.\n\nThe problem is that the scheduler will pick another host to spin up a new resized instance and when the user confirms nova will fail because its looking for the instance on the old compute.\n\nHere is the traceback.\n\n2014-07-16 18:14:55.271 13228 DEBUG amqp [-] Closed channel #1 _do_close /usr/lib/python2.7/dist-packages/amqp/channel.py:88\n2014-07-16 18:14:55.271 13228 DEBUG amqp [-] using channel_id: 1 __init__ /usr/lib/python2.7/dist-packages/amqp/channel.py:70\n2014-07-16 18:14:55.273 13228 DEBUG amqp [-] Channel open _open_ok /usr/lib/python2.7/dist-packages/amqp/channel.py:420\n2014-07-16 18:14:55.299 13228 ERROR nova.openstack.common.rpc.amqp [req-3cae0e1d-2cf4-4da7-9aac-0ea5279b829d cherkasj 37af63b6867d4fe38ac312ca626ce186] Exception during message handling\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp Traceback (most recent call last):\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/amqp.py\", line 461, in _process_data\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp **args)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/rpc/dispatcher.py\", line 172, in dispatch\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp result = getattr(proxyobj, method)(ctxt, **kwargs)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 353, in decorated_function\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 90, in wrapped\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp payload)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 73, in wrapped\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp return f(self, context, *args, **kw)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 294, in decorated_function\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp function(self, context, *args, **kwargs)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 271, in decorated_function\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp e, sys.exc_info())\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 258, in decorated_function\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp return function(self, context, *args, **kwargs)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2683, in confirm_resize\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp do_confirm_resize(context, instance, migration_id)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/lockutils.py\", line 246, in inner\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp return f(*args, **kwargs)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2680, in do_confirm_resize\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp migration=migration)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2707, in _confirm_resize\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp network_info)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/virt/vmwareapi/driver.py\", line 465, in confirm_migration\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp _vmops = self._get_vmops_for_compute_node(instance['node'])\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/virt/vmwareapi/driver.py\", line 567, in _get_vmops_for_compute_node\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp resource = self._get_resource_for_node(nodename)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp File \"/usr/lib/python2.7/dist-packages/nova/virt/vmwareapi/driver.py\", line 559, in _get_resource_for_node\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp raise exception.NotFound(msg)\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp NotFound: The resource domain-c1122(compute02) does not exist\n2014-07-16 18:14:55.299 13228 TRACE nova.openstack.common.rpc.amqp\n2014-07-16 18:14:57.595 13228 DEBUG nova.openstack.common.vmware.api [-] Waiting for function _invoke_api to return. func /usr/lib/python2.7/dist-packages/nova/openstack/common/vmware/api.py:120\n2014-07-16 18:14:57.598 13228 DEBUG nova.openstack.common.vmware.api [-] Invoking _invoke_api; retry count is 0. _func /usr/lib/python2.7/dist-packages/nova/openstack/common/vmware/api.py:83\n2014-07-16 18:14:57.598 13228 DEBUG nova.openstack.common.vmware.api [-] Invoking method <module 'nova.virt.vmwareapi.vim_util' from '/usr/lib/python2.7/dist-packages/nova/virt/vmwareap", 
            "date_created": "2014-07-20 06:23:49.620965+00:00", 
            "author": "https://api.launchpad.net/1.0/~garyk"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/108225", 
            "date_created": "2014-07-20 06:34:32.443122+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "The problem is that certain operations update the instance node. This is validated to check that it matched the cluster configuration on the compute node. This is wrong as the compute node just needs to perform a VC opertaion.", 
            "date_created": "2014-07-20 06:35:52.325278+00:00", 
            "author": "https://api.launchpad.net/1.0/~garyk"
        }, 
        {
            "content": "This only affects VMware, so downgrading to High. Please see:\nhttps://wiki.openstack.org/wiki/Bugs#Importance", 
            "date_created": "2014-07-21 12:25:20.023442+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "Doesn't seem like this should block J-2, so remove J-2 target for now, please shout on IRC if this is the wrong call.", 
            "date_created": "2014-07-21 12:27:11.142698+00:00", 
            "author": "https://api.launchpad.net/1.0/~johngarbutt"
        }, 
        {
            "content": "Hi Gary,\n\nI have investigated this issue and found an different solution here:\n\nin nova.compute.api, on resize() method, by using resize_allow_on_same_host = True, following code could help to solve the issue:\n\n       if not CONF.allow_resize_to_same_host:\n            filter_properties['ignore_hosts'].append(instance['host'])\n        else:\n            if instance['host'] != instance['node']:\n                filter_properties['force_nodes'] = [instance['node']]\n\n", 
            "date_created": "2014-08-13 11:32:19.234922+00:00", 
            "author": "https://api.launchpad.net/1.0/~kanagaraj-manickam"
        }, 
        {
            "content": "as this only affects 1 hypervisor by definition it cannot be critical", 
            "date_created": "2014-08-14 21:29:36.092610+00:00", 
            "author": "https://api.launchpad.net/1.0/~tjones-i"
        }, 
        {
            "content": "Is anyone working on this bug? If not we might need to untarget it from rc1.", 
            "date_created": "2014-09-24 01:46:30.964795+00:00", 
            "author": "https://api.launchpad.net/1.0/~mikal"
        }, 
        {
            "content": "A patch has been in review - https://review.openstack.org/108225. ", 
            "date_created": "2014-10-02 06:33:07.127342+00:00", 
            "author": "https://api.launchpad.net/1.0/~garyk"
        }, 
        {
            "content": "Hopefully we can have this for RC2. ", 
            "date_created": "2014-10-02 06:38:10.596596+00:00", 
            "author": "https://api.launchpad.net/1.0/~garyk"
        }, 
        {
            "content": "please stop marking this is critical.", 
            "date_created": "2014-11-20 21:11:55.963401+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/108225\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8e4a9156f4dccf003970848c28b8a9d15c55212d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8e4a9156f4dccf003970848c28b8a9d15c55212d\nAuthor: Gary Kotton <email address hidden>\nDate:   Sat Jul 19 23:24:54 2014 -0700\n\n    VMware: fix exception when multiple compute nodes are running\n    \n    A number of operations in the VMwareVCDriver class first validate\n    that instances node is the cluster that is mapped to the compute\n    node. This is problematic when the compute nodes have different\n    configurations, for example, each compute node is mapped to a\n    different cluster.\n    \n    In this case many operations that are just performing instance operations\n    will fail. This patch ensure that all instance operations that do not\n    require a cluster or volume will make use of the base _vmops class.\n    This is due to the fact that it only requires the instance details\n    to interface with the VC and there are no specific cluster operations.\n    \n    Change-Id: I2bc38a480f2feb12ea41e7d28f80b29dd49a79b8\n    Closes-bug: #1345460\n", 
            "date_created": "2014-11-26 15:42:48.370908+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/137386", 
            "date_created": "2014-11-26 15:54:47.943311+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/137386\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=acefbcb20408ec6ee1fe666524a2a20449969f1f\nSubmitter: Jenkins\nBranch:    stable/juno\n\ncommit acefbcb20408ec6ee1fe666524a2a20449969f1f\nAuthor: Gary Kotton <email address hidden>\nDate:   Sat Jul 19 23:24:54 2014 -0700\n\n    VMware: fix exception when multiple compute nodes are running\n    \n    A number of operations in the VMwareVCDriver class first validate\n    that instances node is the cluster that is mapped to the compute\n    node. This is problematic when the compute nodes have different\n    configurations, for example, each compute node is mapped to a\n    different cluster.\n    \n    In this case many operations that are just performing instance operations\n    will fail. This patch ensure that all instance operations that do not\n    require a cluster or volume will make use of the base _vmops class.\n    This is due to the fact that it only requires the instance details\n    to interface with the VC and there are no specific cluster operations.\n    \n    Change-Id: I2bc38a480f2feb12ea41e7d28f80b29dd49a79b8\n    Closes-bug: #1345460\n    (cherry picked from commit 8e4a9156f4dccf003970848c28b8a9d15c55212d)\n", 
            "date_created": "2015-03-10 17:42:33.765593+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-12-18 19:58:12.804595+00:00"
}