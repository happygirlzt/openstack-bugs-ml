{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:21:10.297946+00:00", 
    "description": "When I tried to use kilo controller to conduct juno compute nodes,  the juno nova-compute service start with the following two errors:\n\n1. 2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     return self._update_available_resource(context, resources)\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 272, in inner\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     return f(*args, **kwargs)\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib64/python2.6/contextlib.py\", line 34, in __exit__\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     self.gen.throw(type, value, traceback)\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 236, in lock\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     yield int_lock\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 272, in inner\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     return f(*args, **kwargs)\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.6/site-packages/nova/compute/resource_tracker.py\", line 377, in _update_available_resource\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     self._sync_compute_node(context, resources)\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.6/site-packages/nova/compute/resource_tracker.py\", line 388, in _sync_compute_node\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     compute_node_refs = service['compute_node']\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup KeyError: 'compute_node'\n\n\nWe can revert this commit to fix this error: \nhttps://github.com/openstack/nova/commit/83b64ceb871b1553b1bb1e0bb9270816db892552\n\n2.  2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/nova/rpc.py\", line 111, in deserialize_entity\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver     return self._base.deserialize_entity(context, entity)\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/nova/objects/base.py\", line 649, in deserialize_entity\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver     entity = self._process_object(context, entity)\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/nova/objects/base.py\", line 615, in _process_object\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver     e.kwargs['supported'])\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/nova/conductor/api.py\", line 217, in object_backport\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver     return self._manager.object_backport(context, objinst, target_version)\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/nova/conductor/rpcapi.py\", line 358, in object_backport\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver     target_version=target_version)\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/oslo/messaging/rpc/client.py\", line 152, in call\n\nWe can revert this commit to fix this error:\nhttps://github.com/openstack/nova/commit/f287b75138129542436b2085d52d6fe201ca7e14\n\n\nAndbody  know is there  something like gate keeper to make kilo controller can keep conducting the juno compute nodes ? Thanks!", 
    "tags": [
        "compute"
    ], 
    "importance": "Critical", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1431201", 
    "owner": "https://api.launchpad.net/1.0/~danms", 
    "id": 1431201, 
    "index": 239, 
    "openned": "2015-03-12 07:51:48.575659+00:00", 
    "created": "2015-03-12 07:51:48.575659+00:00", 
    "title": "kilo controller can't conduct juno compute nodes", 
    "comments": [
        {
            "content": "When I tried to use kilo controller to conduct juno compute nodes,  the juno nova-compute service start with the following two errors:\n\n1. 2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     return self._update_available_resource(context, resources)\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 272, in inner\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     return f(*args, **kwargs)\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib64/python2.6/contextlib.py\", line 34, in __exit__\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     self.gen.throw(type, value, traceback)\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 236, in lock\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     yield int_lock\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.6/site-packages/nova/openstack/common/lockutils.py\", line 272, in inner\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     return f(*args, **kwargs)\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.6/site-packages/nova/compute/resource_tracker.py\", line 377, in _update_available_resource\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     self._sync_compute_node(context, resources)\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.6/site-packages/nova/compute/resource_tracker.py\", line 388, in _sync_compute_node\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup     compute_node_refs = service['compute_node']\n2015-03-10 06:37:18.525 18900 TRACE nova.openstack.common.threadgroup KeyError: 'compute_node'\n\n\nWe can revert this commit to fix this error: \nhttps://github.com/openstack/nova/commit/83b64ceb871b1553b1bb1e0bb9270816db892552\n\n2.  2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/nova/rpc.py\", line 111, in deserialize_entity\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver     return self._base.deserialize_entity(context, entity)\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/nova/objects/base.py\", line 649, in deserialize_entity\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver     entity = self._process_object(context, entity)\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/nova/objects/base.py\", line 615, in _process_object\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver     e.kwargs['supported'])\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/nova/conductor/api.py\", line 217, in object_backport\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver     return self._manager.object_backport(context, objinst, target_version)\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/nova/conductor/rpcapi.py\", line 358, in object_backport\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver     target_version=target_version)\n2015-03-10 06:41:29.388 19336 TRACE nova.virt.libvirt.driver   File \"/usr/lib/python2.6/site-packages/oslo/messaging/rpc/client.py\", line 152, in call\n\nWe can revert this commit to fix this error:\nhttps://github.com/openstack/nova/commit/f287b75138129542436b2085d52d6fe201ca7e14\n\n\nAndbody  know is there  something like gate keeper to make kilo controller can keep conducting the juno compute nodes ? Thanks!", 
            "date_created": "2015-03-12 07:51:48.575659+00:00", 
            "author": "https://api.launchpad.net/1.0/~lqslan"
        }, 
        {
            "content": "So,  there are 2 problems :\n - old Juno RT is using the conductor API  instead of using Objects, so that's directly proxying on top of DB API. Instead of reverting https://github.com/openstack/nova/commit/83b64ceb871b1553b1bb1e0bb9270816db892552 I'm in favor of adding a logic in the conductor manager method which would check if the compute_node field is present, and if not re-add it. That way, it would allow to go on and keep removed the nested compute_node field for Kilo nodes while Juno nodes would still work\n\n - the second stack is a little bit weird for me, could you please give me a better stacktrace so I could understand what's wrong with the second commit you mentioned ?\n\n", 
            "date_created": "2015-03-12 09:42:02.891470+00:00", 
            "author": "https://api.launchpad.net/1.0/~sylvain-bauza"
        }, 
        {
            "content": "The full stack is a loop of what I paste in the description of this issue.  I think it's happend when juno compute node tried to check the compatible with conductor node, but it failed.\n\nI think maybe this line led to the problem :\nhttps://github.com/openstack/nova/blob/master/nova/objects/service.py#L81\n\nI tried to set the target_version='1.10'  to  target_version='1.5'(juno compute_node object version),  the problem gone. \n\n", 
            "date_created": "2015-03-12 09:55:26.665570+00:00", 
            "author": "https://api.launchpad.net/1.0/~lqslan"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/163797", 
            "date_created": "2015-03-12 12:38:21.957514+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/163867", 
            "date_created": "2015-03-12 15:17:44.241478+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/163797\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=cb7977466833df01c6ed7e8405bb1f7b6b5ea523\nSubmitter: Jenkins\nBranch:    master\n\ncommit cb7977466833df01c6ed7e8405bb1f7b6b5ea523\nAuthor: Sylvain Bauza <email address hidden>\nDate:   Thu Mar 12 12:15:45 2015 +0100\n\n    Fix Juno nodes checking service.compute_node\n    \n    Old Juno ResourceTracker is calling the conductor instead of calling the\n    Service object, so it can't benefit from the backwards compatibility.\n    As conductor_api.service_get_by_compute_node is only called by old Juno\n    computes (thru a RT method), we can safely backport the compute_node field\n    into what the DB method provides so it doesn't break old RTs.\n    \n    Related-Bug: #1431201\n    \n    Change-Id: I9afd3c65a088d218cb9c452b18881e94e888950b\n", 
            "date_created": "2015-03-12 18:17:21.343498+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/164206", 
            "date_created": "2015-03-13 14:52:24.395665+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/164206\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=dddd37d091d89a813fcb97a726c2bf932d6b69ae\nSubmitter: Jenkins\nBranch:    master\n\ncommit dddd37d091d89a813fcb97a726c2bf932d6b69ae\nAuthor: Dan Smith <email address hidden>\nDate:   Fri Mar 13 07:51:57 2015 -0700\n\n    Break out the child version calculation logic from obj_make_compatible()\n    \n    This pulls out the child version logic from the compatibility routine,\n    so that it can be used in other contexts. I left the tests that verify\n    the versions pointing at the caller to show that this doesn't break\n    anything. Moving them to actually test the core function would be good.\n    \n    However, now the inner version calculation logic is a little more\n    precise, which changed one of the test cases simply because it was\n    not considering the actual child version properly. That same issue\n    plagued other cases because we were not properly calling each case on\n    a clean copy of the primitive (which didn't matter before).\n    \n    Change-Id: Id4071b6bc6e9d4419e9142fa339095f04b182d92\n    Related-Bug: #1431201\n", 
            "date_created": "2015-03-14 00:09:41.169961+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/163867\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=708b576ee9c585394f7b309bb70784c63061027d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 708b576ee9c585394f7b309bb70784c63061027d\nAuthor: Sylvain Bauza <email address hidden>\nDate:   Thu Mar 12 16:15:23 2015 +0100\n\n    Fix ComputeNode backport for Service.obj_make_compatible\n    \n    The previous implementation was setting anyway the ComputeNode object version\n    to 1.10. It consequently breaks compatiblity with Juno compute nodes that can\n    only understand ComputeNode <1.6\n    \n    Change-Id: Ib2b63d0fb482410233ee42b1ff1c697229c77958\n    Closes-Bug: #1431201\n", 
            "date_created": "2015-03-16 21:09:28.457951+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-03-20 07:36:33.076143+00:00"
}