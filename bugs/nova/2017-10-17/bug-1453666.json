{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:49:40.478844+00:00", 
    "description": "Latest Kilo code.\n\nIn inspect_capabilities() of nova/virt/disk/vfs/guestfs.py, guestfs api, which is C-extension, will hang nova-compute process when it is invoked. This problem will result in message queue time out error and instance booting failure.\n\nAnd example of this problem is:\n\n2015-05-09 17:07:08.393 4449 DEBUG nova.virt.disk.vfs.api [req-1f7c1104-2679-43a5-bbcb-f73114ce9103 - - - - -] Using primary VFSGuestFS instance_for_image /usr/lib/python2.7/site-packages/nova/virt/disk/vfs/api.py:50\n2015-05-09 17:08:35.443 4449 DEBUG nova.virt.disk.vfs.guestfs [req-1f7c1104-2679-43a5-bbcb-f73114ce9103 - - - - -] Setting up appliance for /var/lib/nova/instances/0517e2a9-469c-43f4-a129-f489fc1c8356/disk qcow2 setup /usr/lib/python2.7/site-packages/nova/virt/disk/vfs/guestfs.py:169\n2015-05-09 17:08:35.457 4449 DEBUG nova.openstack.common.periodic_task [req-bb78b74b-bed7-450f-bd40-19686aab2c3e - - - - -] Running periodic task ComputeManager._instance_usage_audit run_periodic_tasks /usr/lib/python2.7/site-packages/nova/openstack/common/periodic_task.py:219\n2015-05-09 17:08:35.461 4449 INFO oslo_messaging._drivers.impl_rabbit [req-bb78b74b-bed7-450f-bd40-19686aab2c3e - - - - -] Connecting to AMQP server on 127.0.0.1:5671\n2015-05-09 17:08:35.472 4449 ERROR nova.compute.manager [-] Instance failed network setup after 1 attempt(s)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager Traceback (most recent call last):\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 1783, in _allocate_network_async\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     system_metadata=sys_meta)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 739, in _instance_update\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     **kwargs)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/api.py\", line 308, in instance_update\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     updates, 'conductor')\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/rpcapi.py\", line 194, in instance_update\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     service=service)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/client.py\", line 156, in call\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     retry=self.retry)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/transport.py\", line 90, in _send\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     timeout=timeout, retry=retry)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 350, in send\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     retry=retry)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 339, in _send\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     result = self._waiter.wait(msg_id, timeout)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 243, in wait\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     message = self.waiters.get(msg_id, timeout=timeout)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 149, in get\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     'to message ID %s' % msg_id)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager MessagingTimeout: Timed out waiting for a reply to message ID 8ff07520ea8743c997b5017f6638a0df\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager", 
    "tags": [
        "in-stable-kilo", 
        "libvirt"
    ], 
    "importance": "High", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1453666", 
    "owner": "https://api.launchpad.net/1.0/~zhaoqin", 
    "id": 1453666, 
    "index": 1744, 
    "openned": "2015-05-11 06:25:37.411627+00:00", 
    "created": "2015-05-11 06:25:37.411627+00:00", 
    "title": "libvirt: guestfs api makes nova-compute hang", 
    "comments": [
        {
            "content": "Latest Kilo code.\n\nIn inspect_capabilities() of nova/virt/disk/vfs/guestfs.py, guestfs api, which is C-extension, will hang nova-compute process when it is invoked. This problem will result in message queue time out error and instance booting failure.\n\nAnd example of this problem is:\n\n2015-05-09 17:07:08.393 4449 DEBUG nova.virt.disk.vfs.api [req-1f7c1104-2679-43a5-bbcb-f73114ce9103 - - - - -] Using primary VFSGuestFS instance_for_image /usr/lib/python2.7/site-packages/nova/virt/disk/vfs/api.py:50\n2015-05-09 17:08:35.443 4449 DEBUG nova.virt.disk.vfs.guestfs [req-1f7c1104-2679-43a5-bbcb-f73114ce9103 - - - - -] Setting up appliance for /var/lib/nova/instances/0517e2a9-469c-43f4-a129-f489fc1c8356/disk qcow2 setup /usr/lib/python2.7/site-packages/nova/virt/disk/vfs/guestfs.py:169\n2015-05-09 17:08:35.457 4449 DEBUG nova.openstack.common.periodic_task [req-bb78b74b-bed7-450f-bd40-19686aab2c3e - - - - -] Running periodic task ComputeManager._instance_usage_audit run_periodic_tasks /usr/lib/python2.7/site-packages/nova/openstack/common/periodic_task.py:219\n2015-05-09 17:08:35.461 4449 INFO oslo_messaging._drivers.impl_rabbit [req-bb78b74b-bed7-450f-bd40-19686aab2c3e - - - - -] Connecting to AMQP server on 127.0.0.1:5671\n2015-05-09 17:08:35.472 4449 ERROR nova.compute.manager [-] Instance failed network setup after 1 attempt(s)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager Traceback (most recent call last):\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 1783, in _allocate_network_async\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     system_metadata=sys_meta)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 739, in _instance_update\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     **kwargs)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/api.py\", line 308, in instance_update\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     updates, 'conductor')\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/rpcapi.py\", line 194, in instance_update\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     service=service)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/client.py\", line 156, in call\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     retry=self.retry)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/transport.py\", line 90, in _send\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     timeout=timeout, retry=retry)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 350, in send\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     retry=retry)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 339, in _send\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     result = self._waiter.wait(msg_id, timeout)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 243, in wait\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     message = self.waiters.get(msg_id, timeout=timeout)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager   File \"/usr/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 149, in get\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager     'to message ID %s' % msg_id)\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager MessagingTimeout: Timed out waiting for a reply to message ID 8ff07520ea8743c997b5017f6638a0df\n2015-05-09 17:08:35.472 4449 TRACE nova.compute.manager", 
            "date_created": "2015-05-11 06:25:37.411627+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhaoqin"
        }, 
        {
            "content": "From the first two lines of log, we can know that launch() of guestfs api in inspect_capabilities() takes nearly 90 seconds to complete. And during this time frame, nova-compute cannot switch to other green threads. Since rpc_response_timeout=60, rabbitmq client immediately encounters a timeout error, when it resumes to run.\n\n2015-05-09 17:07:08.393 4449 DEBUG nova.virt.disk.vfs.api [req-1f7c1104-2679-43a5-bbcb-f73114ce9103 - - - - -] Using primary VFSGuestFS instance_for_image /usr/lib/python2.7/site-packages/nova/virt/disk/vfs/api.py:50\n2015-05-09 17:08:35.443 4449 DEBUG nova.virt.disk.vfs.guestfs [req-1f7c1104-2679-43a5-bbcb-f73114ce9103 - - - - -] Setting up appliance for /var/lib/nova/instances/0517e2a9-469c-43f4-a129-f489fc1c8356/disk qcow2 setup /usr/lib/python2.7/site-packages/nova/virt/disk/vfs/guestfs.py:169\n\n\nDuring my investigation, launch() of guestfs api always takes more than 10 seconds to complete, and will take very long time, if server is busy or its cache file has not been created. Anyway, it does not make sense to invoke a long blocking call in a green thread.", 
            "date_created": "2015-05-11 06:36:05.231961+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhaoqin"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/181808", 
            "date_created": "2015-05-11 07:07:31.682038+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/181808\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=da9671aa7f597d3dd2cd6d09bb06998b209c962a\nSubmitter: Jenkins\nBranch:    master\n\ncommit da9671aa7f597d3dd2cd6d09bb06998b209c962a\nAuthor: Qin Zhao <email address hidden>\nDate:   Mon May 11 15:01:38 2015 +0800\n\n    Libvirt: Use tpool to invoke guestfs api\n    \n    In inspect_capabilities() of nova/virt/disk/vfs/guestfs.py, guestfs api, which\n    is C-extension, will hang nova-compute process when it is invoked. This problem\n    will result in message queue timeout error and instance booting failure. Need\n    to use tpool to invoke guestfs api, in order to make nova-compute switch to\n    other green threads before guestfs api returns.\n    \n    Change-Id: I24187ba01965fb886351b78eee605bc052a94e21\n    Closes-Bug: 1453666\n", 
            "date_created": "2015-05-11 16:26:03.152943+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/182044", 
            "date_created": "2015-05-11 19:49:24.681225+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/182044\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8e9ecf74c918273033d86342ec2aba419e86f998\nSubmitter: Jenkins\nBranch:    stable/kilo\n\ncommit 8e9ecf74c918273033d86342ec2aba419e86f998\nAuthor: Qin Zhao <email address hidden>\nDate:   Mon May 11 15:01:38 2015 +0800\n\n    Libvirt: Use tpool to invoke guestfs api\n    \n    In inspect_capabilities() of nova/virt/disk/vfs/guestfs.py, guestfs api, which\n    is C-extension, will hang nova-compute process when it is invoked. This problem\n    will result in message queue timeout error and instance booting failure. Need\n    to use tpool to invoke guestfs api, in order to make nova-compute switch to\n    other green threads before guestfs api returns.\n    \n    Change-Id: I24187ba01965fb886351b78eee605bc052a94e21\n    Closes-Bug: 1453666\n    (cherry picked from commit da9671aa7f597d3dd2cd6d09bb06998b209c962a)\n", 
            "date_created": "2015-05-15 16:16:07.650063+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-06-24 12:15:48.261572+00:00"
}