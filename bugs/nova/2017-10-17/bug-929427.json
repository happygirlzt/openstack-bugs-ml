{
    "status": "Fix Released", 
    "last_updated": "2013-11-21 09:30:36.369549+00:00", 
    "description": "Hi there.\n\nIn nova/virt/libvirt/connection.py, the get_instance_disk_info method from LibvirtConnection parses the XML returned by virt_dom.XMLDesc. In this XML document, the devices are as follow:\n\n     <devices>\n        <disk type='file' device='disk'>\n          <driver name='file'/>\n          <source file='/srv/nova/instances/instance-00000019/disk'/>\n          <target dev='sda' bus='scsi'/>\n        </disk>\n\nbut the code expects that driver_name has a \"type\" attribute, containing the type of the driver used (i.e. qcow2, raw). Therefore, if somebody is using raw images instead of cow nova-compute throws an exception, because get_instance_disk_info assumes that the image is qcow and tries to get the backing file (that indeed does not exist for raw images):\n\n    2012-02-09 11:06:51,407 CRITICAL nova [-] list index out of range\n    (nova): TRACE: Traceback (most recent call last):\n    (nova): TRACE:   File \"/usr/bin/nova-compute\", line 49, in <module>\n    (nova): TRACE:     service.wait()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 414, in wait\n    (nova): TRACE:     _launcher.wait()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 134, in wait\n    (nova): TRACE:     service.wait()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 166, in wait\n    (nova): TRACE:     return self._exit_event.wait()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/event.py\", line 116, in wait\n    (nova): TRACE:     return hubs.get_hub().switch()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n    (nova): TRACE:     return self.greenlet.switch()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n    (nova): TRACE:     result = function(*args, **kwargs)\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 104, in run_server\n    (nova): TRACE:     server.start()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 176, in start\n    (nova): TRACE:     self.manager.update_available_resource(ctxt)\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2187, in update_available_resour\nce\n    (nova): TRACE:     self.driver.update_available_resource(context, self.host)\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1642, in update_availabl\ne_resource\n    (nova): TRACE:     'disk_available_least': self.get_disk_available_least()}\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 2002, in get_disk_availa\nble_least\n    (nova): TRACE:     disk_infos = utils.loads(self.get_instance_disk_info(i_name))\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1976, in get_instance_di\nsk_info\n    (nova): TRACE:     backing_file = libvirt_utils.get_disk_backing_file(path)\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/utils.py\", line 106, in get_disk_backing_file\n    (nova): TRACE:     backing_file = os.path.basename(backing_file[0])\n    (nova): TRACE: IndexError: list index out of range\n\nI've tested it using libvirt + Xen and using cow and raw images. I do now know if this is the case for other hypervisors, since I do not know the format of the XML returned by libvirt in such cases, but I assume that this should be the\nsame.", 
    "tags": [
        "libvirt", 
        "xen"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/929427", 
    "owner": "https://api.launchpad.net/1.0/~aloga", 
    "id": 929427, 
    "index": 3813, 
    "openned": "2012-02-09 10:27:01.503034+00:00", 
    "created": "2012-02-09 10:27:01.503034+00:00", 
    "title": "get_instance_disk_info uses wrong XML to get disk information", 
    "comments": [
        {
            "content": "Hi there.\n\nIn nova/virt/libvirt/connection.py, the get_instance_disk_info method from LibvirtConnection parses the XML returned by virt_dom.XMLDesc. In this XML document, the devices are as follow:\n\n     <devices>\n        <disk type='file' device='disk'>\n          <driver name='file'/>\n          <source file='/srv/nova/instances/instance-00000019/disk'/>\n          <target dev='sda' bus='scsi'/>\n        </disk>\n\nbut the code expects that driver_name has a \"type\" attribute, containing the type of the driver used (i.e. qcow2, raw). Therefore, if somebody is using raw images instead of cow nova-compute throws an exception, because get_instance_disk_info assumes that the image is qcow and tries to get the backing file (that indeed does not exist for raw images):\n\n    2012-02-09 11:06:51,407 CRITICAL nova [-] list index out of range\n    (nova): TRACE: Traceback (most recent call last):\n    (nova): TRACE:   File \"/usr/bin/nova-compute\", line 49, in <module>\n    (nova): TRACE:     service.wait()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 414, in wait\n    (nova): TRACE:     _launcher.wait()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 134, in wait\n    (nova): TRACE:     service.wait()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 166, in wait\n    (nova): TRACE:     return self._exit_event.wait()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/event.py\", line 116, in wait\n    (nova): TRACE:     return hubs.get_hub().switch()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n    (nova): TRACE:     return self.greenlet.switch()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n    (nova): TRACE:     result = function(*args, **kwargs)\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 104, in run_server\n    (nova): TRACE:     server.start()\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 176, in start\n    (nova): TRACE:     self.manager.update_available_resource(ctxt)\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 2187, in update_available_resour\nce\n    (nova): TRACE:     self.driver.update_available_resource(context, self.host)\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1642, in update_availabl\ne_resource\n    (nova): TRACE:     'disk_available_least': self.get_disk_available_least()}\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 2002, in get_disk_availa\nble_least\n    (nova): TRACE:     disk_infos = utils.loads(self.get_instance_disk_info(i_name))\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1976, in get_instance_di\nsk_info\n    (nova): TRACE:     backing_file = libvirt_utils.get_disk_backing_file(path)\n    (nova): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/utils.py\", line 106, in get_disk_backing_file\n    (nova): TRACE:     backing_file = os.path.basename(backing_file[0])\n    (nova): TRACE: IndexError: list index out of range\n\nI've tested it using libvirt + Xen and using cow and raw images. I do now know if this is the case for other hypervisors, since I do not know the format of the XML returned by libvirt in such cases, but I assume that this should be the\nsame.", 
            "date_created": "2012-02-09 10:27:01.503034+00:00", 
            "author": "https://api.launchpad.net/1.0/~aloga"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/4189\nCommitted: http://github.com/openstack/nova/commit/d1bc92fdbd3aa42b15beeb5eaf2987365247cfa2\nSubmitter: Jenkins\nBranch:    master\n\ncommit d1bc92fdbd3aa42b15beeb5eaf2987365247cfa2\nAuthor: Alvaro Lopez Garcia <email address hidden>\nDate:   Wed Feb 15 11:47:28 2012 +0100\n\n    Fix bug 929427\n    \n    We ensure that we are getting the info from a QCOW2 image, not anything\n    else.\n    \n    Change-Id: I8b6bd504da8d52bb9902c917360f0465f9002551\n", 
            "date_created": "2012-02-17 20:40:24.113359+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-02-29 10:26:38.253471+00:00"
}