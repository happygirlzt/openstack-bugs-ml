{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 11:10:49.641369+00:00", 
    "description": "Hi there.\n\nI'm using network.VlanManager.\n\nI'm trying to get all the cloudpipes that are running on a system as an admin. If there's only one cloudpipe and it is associated to the admin tenant, it works perfectly. However, every time I get another cloudpipe, not associated with the admin's tenant I get the following error in nova-network:\n\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE: Traceback (most recent call last):\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 250, in _process_data\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:     rval = node_func(context=ctxt, **node_args)\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 239, in wrapped\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:     return func(self, context, *args, **kwargs)\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1475, in get_network\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:     networks = self._get_networks_by_uuids(context, [network_uuid])\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1748, in _get_networks_by_uuids\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 825, in network_get_all_by_uuids\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:     return IMPL.network_get_all_by_uuids(context, network_uuids, project_id)\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 101, in wrapper\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:     return f(*args, **kwargs)\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 2063, in network_get_all_by_uuids\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE:     raise exception.NoNetworksFound()\n\u00a0\u00a0\u00a0\u00a0(nova.rpc.common): TRACE: NoNetworksFound: No networks defined.\n\nAnd the following in nova-api:\n\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE: Traceback (most recent call last):\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/__init__.py\", line 41, in __call__\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     return req.get_response(self.application)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1086, in get_response\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     application, catch_exc_info=False)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1055, in call_application\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     app_iter = application(self.environ, start_response)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 166, in __call__\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     return self.app(env, start_response)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     return resp(environ, start_response)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     return resp(environ, start_response)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     return resp(environ, start_response)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     response = self.app(environ, start_response)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     return resp(environ, start_response)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 147, in __call__\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 210, in call_func\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     return self.func(req, *args, **kwargs)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 800, in __call__\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     content_type, body, accept)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 848, in _process_stack\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     action_result = self.dispatch(meth, request, action_args)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 924, in dispatch\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     return method(req=request, **action_args)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/cloudpipe.py\", line 152, in index\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     for x in self._get_all_cloudpipes(context)]\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/cloudpipe.py\", line 103, in _vpn_dict\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     network = self.network_api.get(elevated, vif['network']['id'])\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/api.py\", line 45, in get\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     'args': {'network_uuid': network_uuid}})\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/__init__.py\", line 69, in call\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     return _get_impl().call(context, topic, msg, timeout)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 671, in call\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     return rpc_amqp.call(context, topic, msg, timeout, Connection.pool)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 336, in call\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     rv = list(rv)\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 304, in __iter__\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE:     raise result\n\u00a0\u00a0\u00a0\u00a0(nova.api.openstack): TRACE: RemoteError: Remote error: NoNetworksFound No networks defined.\n\nThis is due to the filter in network_get_all_by_uuids in nova/db/sqlalchemy/api.py that filters the networks by the project_id received as a parameter, which is filled in the appropriate calls with the context project (that's the reason of the above exceptions when I have a cloudpipe not in the admin tenant).\n\nIf I look at network_get_all or network_get code, there is no such filter. What is the purpose of this filter? Can it be removed or is it really needed?", 
    "tags": [], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/972583", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 972583, 
    "index": 513, 
    "openned": "2012-04-03 16:12:28.868836+00:00", 
    "created": "2012-04-03 16:12:28.868836+00:00", 
    "title": "network_get_all_by_uuids fails when requesting a network as admin", 
    "comments": [
        {
            "content": "Hi there.\n\nI'm using network.VlanManager.\n\nI'm trying to get all the cloudpipes that are running on a system as an admin. If there's only one cloudpipe and it is associated to the admin tenant, it works perfectly. However, every time I get another cloudpipe, not associated with the admin's tenant I get the following error in nova-network:\n\n    (nova.rpc.common): TRACE: Traceback (most recent call last):\n    (nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 250, in _process_data\n    (nova.rpc.common): TRACE:     rval = node_func(context=ctxt, **node_args)\n    (nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 239, in wrapped\n    (nova.rpc.common): TRACE:     return func(self, context, *args, **kwargs)\n    (nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1475, in get_network\n    (nova.rpc.common): TRACE:     networks = self._get_networks_by_uuids(context, [network_uuid])\n    (nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1748, in _get_networks_by_uuids\n    (nova.rpc.common): TRACE:     \n    (nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/api.py\", line 825, in network_get_all_by_uuids\n    (nova.rpc.common): TRACE:     return IMPL.network_get_all_by_uuids(context, network_uuids, project_id)\n    (nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 101, in wrapper\n    (nova.rpc.common): TRACE:     return f(*args, **kwargs)\n    (nova.rpc.common): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/db/sqlalchemy/api.py\", line 2063, in network_get_all_by_uuids\n    (nova.rpc.common): TRACE:     raise exception.NoNetworksFound()\n    (nova.rpc.common): TRACE: NoNetworksFound: No networks defined.\n\nAnd the following in nova-api:\n\n    (nova.api.openstack): TRACE: Traceback (most recent call last):\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/__init__.py\", line 41, in __call__\n    (nova.api.openstack): TRACE:     return req.get_response(self.application)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1086, in get_response\n    (nova.api.openstack): TRACE:     application, catch_exc_info=False)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1055, in call_application\n    (nova.api.openstack): TRACE:     app_iter = application(self.environ, start_response)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/keystone/middleware/auth_token.py\", line 166, in __call__\n    (nova.api.openstack): TRACE:     return self.app(env, start_response)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n    (nova.api.openstack): TRACE:     return resp(environ, start_response)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n    (nova.api.openstack): TRACE:     return resp(environ, start_response)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n    (nova.api.openstack): TRACE:     return resp(environ, start_response)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n    (nova.api.openstack): TRACE:     response = self.app(environ, start_response)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 159, in __call__\n    (nova.api.openstack): TRACE:     return resp(environ, start_response)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 147, in __call__\n    (nova.api.openstack): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 210, in call_func\n    (nova.api.openstack): TRACE:     return self.func(req, *args, **kwargs)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 800, in __call__\n    (nova.api.openstack): TRACE:     content_type, body, accept)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 848, in _process_stack\n    (nova.api.openstack): TRACE:     action_result = self.dispatch(meth, request, action_args)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 924, in dispatch\n    (nova.api.openstack): TRACE:     return method(req=request, **action_args)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/cloudpipe.py\", line 152, in index\n    (nova.api.openstack): TRACE:     for x in self._get_all_cloudpipes(context)]\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/cloudpipe.py\", line 103, in _vpn_dict     \n    (nova.api.openstack): TRACE:     network = self.network_api.get(elevated, vif['network']['id'])\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/network/api.py\", line 45, in get\n    (nova.api.openstack): TRACE:     'args': {'network_uuid': network_uuid}})\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/__init__.py\", line 69, in call\n    (nova.api.openstack): TRACE:     return _get_impl().call(context, topic, msg, timeout)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 671, in call\n    (nova.api.openstack): TRACE:     return rpc_amqp.call(context, topic, msg, timeout, Connection.pool)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 336, in call\n    (nova.api.openstack): TRACE:     rv = list(rv)\n    (nova.api.openstack): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 304, in __iter__\n    (nova.api.openstack): TRACE:     raise result\n    (nova.api.openstack): TRACE: RemoteError: Remote error: NoNetworksFound No networks defined.\n\nThis is due to the filter in network_get_all_by_uuids in nova/db/sqlalchemy/api.py that filters the networks by the project_id received a parameter (which is filled in the appropriate calls with the context project (that's the reason of the above exceptions when I have a cloudpipe not in the admin tenant)). However, if I look at network_get_all or network_get code, there is no such filter. What is the purpose of this filter? Can it be removed or is it really needed?", 
            "date_created": "2012-04-03 16:12:28.868836+00:00", 
            "author": "https://api.launchpad.net/1.0/~aloga"
        }, 
        {
            "content": "ugh, nasty little bug.  We were using project checking in the db as an added level of access control, but it does lead to problems when we are trying to do administrative commands across tenants.\n\nCan you see if the following change fixes the issue?\n\ndiff --git a/nova/api/openstack/compute/contrib/cloudpipe.py b/nova/api/openstack/compute/contrib/cloudpipe.py\nindex b5d8747..115dc70 100644\n--- a/nova/api/openstack/compute/contrib/cloudpipe.py\n+++ b/nova/api/openstack/compute/contrib/cloudpipe.py\n@@ -85,6 +85,7 @@ class CloudpipeController(object):\n \n     def _vpn_dict(self, context, project_id, instance):\n         elevated = context.elevated()\n+        elevated.project_id = project_id\n         rv = {'project_id': project_id}\n         if not instance:\n             rv['state'] = 'pending'\n\nThis fakes the context to be for the project. should only need to make the change on the api host.", 
            "date_created": "2012-04-03 17:38:18.331373+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "it messed up the spaces but essentially it is to add a line that sets the elevated contexts project_id to the project_id that owns the vpn. ", 
            "date_created": "2012-04-03 17:39:07.319315+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/6189", 
            "date_created": "2012-04-03 20:50:06.290563+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/6189\nCommitted: http://github.com/openstack/nova/commit/12d9a5a38b9968f488b26822dc082ecbc484bbe9\nSubmitter: Jenkins\nBranch:    master\n\ncommit 12d9a5a38b9968f488b26822dc082ecbc484bbe9\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Tue Apr 3 13:47:40 2012 -0700\n\n    Make sure cloudpipe extension can retrieve network\n    \n     * includes failing test\n     * fixes bug 972583\n    \n    Change-Id: Idadac82c6a0fda8a1b912fb974e5754a1e82df39\n", 
            "date_created": "2012-04-03 22:48:14.507999+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: milestone-proposed\nReview: https://review.openstack.org/6204", 
            "date_created": "2012-04-03 22:56:04.244497+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/6204\nCommitted: http://github.com/openstack/nova/commit/e36a1381e25b19200a2a0cf23ffc0212d09d0984\nSubmitter: Jenkins\nBranch:    milestone-proposed\n\ncommit e36a1381e25b19200a2a0cf23ffc0212d09d0984\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Tue Apr 3 13:47:40 2012 -0700\n\n    Make sure cloudpipe extension can retrieve network\n    \n     * includes failing test\n     * fixes bug 972583\n    \n    Change-Id: Idadac82c6a0fda8a1b912fb974e5754a1e82df39\n", 
            "date_created": "2012-04-04 00:04:24.297928+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi Vish.\n\nSorry for the delay in answering. Just for the record, that patch solved the problem.\n\nCheers,\nAlvaro.", 
            "date_created": "2012-04-04 07:25:24.290806+00:00", 
            "author": "https://api.launchpad.net/1.0/~aloga"
        }
    ], 
    "closed": "2012-04-04 00:04:22.852654+00:00"
}