{
    "status": "Invalid", 
    "last_updated": "2015-10-02 15:06:29.146672+00:00", 
    "description": "1- In Precise nova-network crashes because it cannot apply iptables rules when trying to apply vpn rules. nova-network tries to set VPN iptables rules for openvpn access:\n\n2012-12-17 07:17:24 TRACE nova Stderr: \"iptables-restore v1.4.12: host/network `None' not found\\nError occurred at line: 23\\nTry `iptables-restore -h' or 'iptables-restore --help' for more information.\\n\"\n\n2- How reproducible?\n\nNot clear. The configuration I used with juju seems to create an environment that causes this problem. When this problem is present the issue reproduces every time.\n\n3- How to reproduce:\n\nWhen the issue is present just starting up nova-network causes the problem to reproduce. Nova-network exits in the end and dies because of the error on iptables-restore\n\n4- I added debugging in nova.conf with --debug=true and added extra debugging in \n\n/usr/lib/python2.7/dist-packages/nova/utils.py\n\nwhich showed the full iptables rules that were to be restored by iptables-restore:\n\n2012-12-17 07:17:24 DEBUG nova.utils [req-391688fd-3b99-4b1c-8b46-fb4f64e64246 None None] process input: \n# Generated by iptables-save v1.4.12 on Mon Dec 17 07:17:21 2012\n*filter\n:INPUT ACCEPT [0:0]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [0:0]\n:nova-api-FORWARD - [0:0]\n:nova-api-INPUT - [0:0]\n:nova-api-OUTPUT - [0:0]\n:nova-api-local - [0:0]\n:nova-network-FORWARD - [0:0]\n:nova-network-INPUT - [0:0]\n:nova-network-local - [0:0]\n:nova-network-OUTPUT - [0:0]\n:nova-filter-top - [0:0]\n-A FORWARD -j nova-filter-top\n-A OUTPUT -j nova-filter-top\n-A nova-filter-top -j nova-network-local\n-A INPUT -j nova-network-INPUT\n-A OUTPUT -j nova-network-OUTPUT\n-A FORWARD -j nova-network-FORWARD\n-A nova-network-FORWARD --in-interface br100 -j ACCEPT\n-A nova-network-FORWARD --out-interface br100 -j ACCEPT\n-A nova-network-FORWARD -d None -p udp --dport 1194 -j ACCEPT\n-A INPUT -j nova-api-INPUT\n-A INPUT -i virbr0 -p udp -m udp --dport 53 -j ACCEPT\n-A INPUT -i virbr0 -p tcp -m tcp --dport 53 -j ACCEPT\n-A INPUT -i virbr0 -p udp -m udp --dport 67 -j ACCEPT\n-A INPUT -i virbr0 -p tcp -m tcp --dport 67 -j ACCEPT\n-A FORWARD -j nova-api-FORWARD\n-A FORWARD -d 192.168.122.0/24 -o virbr0 -m state --state RELATED,ESTABLISHED -j ACCEPT\n-A FORWARD -s 192.168.122.0/24 -i virbr0 -j ACCEPT\n-A FORWARD -i virbr0 -o virbr0 -j ACCEPT\n-A FORWARD -o virbr0 -j REJECT --reject-with icmp-port-unreachable\n-A FORWARD -i virbr0 -j REJECT --reject-with icmp-port-unreachable\n-A OUTPUT -j nova-api-OUTPUT\n-A nova-api-INPUT -d 192.168.124.150/32 -p tcp -m tcp --dport 8775 -j ACCEPT\n-A nova-filter-top -j nova-api-local\nCOMMIT\n\n\n4.1- Among the rules above we have:\n\n-A nova-network-FORWARD -d None -p udp --dport 1194 -j ACCEPT\n\nwhich is responsible for the fault in iptables-restore.\n\n5- These are the error messages:\n\n2012-12-17 07:17:24 DEBUG nova.utils [req-391688fd-3b99-4b1c-8b46-fb4f64e64246 None None] Result was 2 from (pid=14699) execute /usr/lib/python2.7/dist-packages/nova/utils.py:237\n2012-12-17 07:17:24 CRITICAL nova [-] Unexpected error while running command.\nCommand: sudo nova-rootwrap iptables-restore\nExit code: 2\nStdout: ''\n\nStderr: \"iptables-restore v1.4.12: host/network `None' not found\\nError occurred at line: 23\\nTry `iptables-restore -h' or 'iptables-restore --help' for more information.\\n\"\n2012-12-17 07:17:24 TRACE nova Traceback (most recent call last):\n2012-12-17 07:17:24 TRACE nova   File \"/usr/bin/nova-network\", line 49, in <module>\n2012-12-17 07:17:24 TRACE nova     service.wait()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 413, in wait\n2012-12-17 07:17:24 TRACE nova     _launcher.wait()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 131, in wait\n2012-12-17 07:17:24 TRACE nova     service.wait()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 166, in wait\n2012-12-17 07:17:24 TRACE nova     return self._exit_event.wait()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/eventlet/event.py\", line 116, in wait\n2012-12-17 07:17:24 TRACE nova     return hubs.get_hub().switch()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n2012-12-17 07:17:24 TRACE nova     return self.greenlet.switch()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n2012-12-17 07:17:24 TRACE nova     result = function(*args, **kwargs)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 101, in run_server\n2012-12-17 07:17:24 TRACE nova     server.start()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 162, in start\n2012-12-17 07:17:24 TRACE nova     self.manager.init_host()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1766, in init_host\n2012-12-17 07:17:24 TRACE nova     NetworkManager.init_host(self)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 758, in init_host\n2012-12-17 07:17:24 TRACE nova     self._setup_network_on_host(ctxt, network)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1853, in _setup_network_on_host\n2012-12-17 07:17:24 TRACE nova     network['vpn_private_address'])\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/l3.py\", line 113, in add_vpn\n2012-12-17 07:17:24 TRACE nova     linux_net.ensure_vpn_forward(public_ip, port, private_ip)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 499, in ensure_vpn_forward\n2012-12-17 07:17:24 TRACE nova     iptables_manager.apply()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 945, in inner\n2012-12-17 07:17:24 TRACE nova     retval = f(*args, **kwargs)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 334, in apply\n2012-12-17 07:17:24 TRACE nova     attempts=5)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 813, in _execute\n2012-12-17 07:17:24 TRACE nova     return utils.execute(*cmd, **kwargs)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 244, in execute\n2012-12-17 07:17:24 TRACE nova     cmd=' '.join(cmd))\n2012-12-17 07:17:24 TRACE nova ProcessExecutionError: Unexpected error while running command.\n2012-12-17 07:17:24 TRACE nova Command: sudo nova-rootwrap iptables-restore\n2012-12-17 07:17:24 TRACE nova Exit code: 2\n2012-12-17 07:17:24 TRACE nova Stdout: ''\n2012-12-17 07:17:24 TRACE nova Stderr: \"iptables-restore v1.4.12: host/network `None' not found\\nError occurred at line: 23\\nTry `iptables-restore -h' or 'iptables-restore --help' for more information.\\n\"\n\n6- The issue happens within:\n\nnetwork/l3.py:\n\n    def add_vpn(self, public_ip, port, private_ip):\n        linux_net.ensure_vpn_forward(public_ip, port, private_ip)\n\n6.1- which calls, and ensure_vpn_forward, which doesn't do input check to see if private_ip or public_ip are actual IP addresses.\n\nnetwork/linux_net.py:\n\ndef ensure_vpn_forward(public_ip, port, private_ip):\n    \"\"\"Sets up forwarding rules for vlan.\"\"\"\n\n    iptables_manager.ipv4['filter'].add_rule('FORWARD',\n                                             '-d %s -p udp '\n                                             '--dport 1194 '\n                                             '-j ACCEPT' % private_ip)\n    iptables_manager.ipv4['nat'].add_rule('PREROUTING',\n                                          '-d %s -p udp '\n                                          '--dport %s -j DNAT --to %s:1194' %\n                                          (public_ip, port, private_ip))\n    iptables_manager.ipv4['nat'].add_rule(\"OUTPUT\",\n                                          \"-d %s -p udp \"\n                                          \"--dport %s -j DNAT --to %s:1194\" %\n                                          (public_ip, port, private_ip))\n    iptables_manager.apply()", 
    "tags": [
        "kernel-da-key"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1091780", 
    "owner": "None", 
    "id": 1091780, 
    "index": 4544, 
    "openned": "2014-01-09 14:06:00.428907+00:00", 
    "created": "2012-12-18 17:50:09.256826+00:00", 
    "title": "nova-network - 'iptables-restore v1.4.12: host/network `None' not found", 
    "comments": [
        {
            "content": "1- In Precise nova-network crashes because it cannot apply iptables rules when trying to apply vpn rules. nova-network tries to set VPN iptables rules for openvpn access:\n\n2012-12-17 07:17:24 TRACE nova Stderr: \"iptables-restore v1.4.12: host/network `None' not found\\nError occurred at line: 23\\nTry `iptables-restore -h' or 'iptables-restore --help' for more information.\\n\"\n\n2- How reproducible?\n\nNot clear. The configuration I used with juju seems to create an environment that causes this problem. When this problem is present the issue reproduces every time.\n\n3- How to reproduce:\n\nWhen the issue is present just starting up nova-network causes the problem to reproduce. Nova-network exits in the end and dies because of the error on iptables-restore\n\n4- I added debugging in nova.conf with --debug=true and added extra debugging in \n\n/usr/lib/python2.7/dist-packages/nova/utils.py\n\nwhich showed the full iptables rules that were to be restored by iptables-restore:\n\n2012-12-17 07:17:24 DEBUG nova.utils [req-391688fd-3b99-4b1c-8b46-fb4f64e64246 None None] process input: \n# Generated by iptables-save v1.4.12 on Mon Dec 17 07:17:21 2012\n*filter\n:INPUT ACCEPT [0:0]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [0:0]\n:nova-api-FORWARD - [0:0]\n:nova-api-INPUT - [0:0]\n:nova-api-OUTPUT - [0:0]\n:nova-api-local - [0:0]\n:nova-network-FORWARD - [0:0]\n:nova-network-INPUT - [0:0]\n:nova-network-local - [0:0]\n:nova-network-OUTPUT - [0:0]\n:nova-filter-top - [0:0]\n-A FORWARD -j nova-filter-top\n-A OUTPUT -j nova-filter-top\n-A nova-filter-top -j nova-network-local\n-A INPUT -j nova-network-INPUT\n-A OUTPUT -j nova-network-OUTPUT\n-A FORWARD -j nova-network-FORWARD\n-A nova-network-FORWARD --in-interface br100 -j ACCEPT\n-A nova-network-FORWARD --out-interface br100 -j ACCEPT\n-A nova-network-FORWARD -d None -p udp --dport 1194 -j ACCEPT\n-A INPUT -j nova-api-INPUT\n-A INPUT -i virbr0 -p udp -m udp --dport 53 -j ACCEPT\n-A INPUT -i virbr0 -p tcp -m tcp --dport 53 -j ACCEPT\n-A INPUT -i virbr0 -p udp -m udp --dport 67 -j ACCEPT\n-A INPUT -i virbr0 -p tcp -m tcp --dport 67 -j ACCEPT\n-A FORWARD -j nova-api-FORWARD\n-A FORWARD -d 192.168.122.0/24 -o virbr0 -m state --state RELATED,ESTABLISHED -j ACCEPT\n-A FORWARD -s 192.168.122.0/24 -i virbr0 -j ACCEPT\n-A FORWARD -i virbr0 -o virbr0 -j ACCEPT\n-A FORWARD -o virbr0 -j REJECT --reject-with icmp-port-unreachable\n-A FORWARD -i virbr0 -j REJECT --reject-with icmp-port-unreachable\n-A OUTPUT -j nova-api-OUTPUT\n-A nova-api-INPUT -d 192.168.124.150/32 -p tcp -m tcp --dport 8775 -j ACCEPT\n-A nova-filter-top -j nova-api-local\nCOMMIT\n\n\n4.1- Among the rules above we have:\n\n-A nova-network-FORWARD -d None -p udp --dport 1194 -j ACCEPT\n\nwhich is responsible for the fault in iptables-restore.\n\n5- These are the error messages:\n\n2012-12-17 07:17:24 DEBUG nova.utils [req-391688fd-3b99-4b1c-8b46-fb4f64e64246 None None] Result was 2 from (pid=14699) execute /usr/lib/python2.7/dist-packages/nova/utils.py:237\n2012-12-17 07:17:24 CRITICAL nova [-] Unexpected error while running command.\nCommand: sudo nova-rootwrap iptables-restore\nExit code: 2\nStdout: ''\n\nStderr: \"iptables-restore v1.4.12: host/network `None' not found\\nError occurred at line: 23\\nTry `iptables-restore -h' or 'iptables-restore --help' for more information.\\n\"\n2012-12-17 07:17:24 TRACE nova Traceback (most recent call last):\n2012-12-17 07:17:24 TRACE nova   File \"/usr/bin/nova-network\", line 49, in <module>\n2012-12-17 07:17:24 TRACE nova     service.wait()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 413, in wait\n2012-12-17 07:17:24 TRACE nova     _launcher.wait()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 131, in wait\n2012-12-17 07:17:24 TRACE nova     service.wait()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 166, in wait\n2012-12-17 07:17:24 TRACE nova     return self._exit_event.wait()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/eventlet/event.py\", line 116, in wait\n2012-12-17 07:17:24 TRACE nova     return hubs.get_hub().switch()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 177, in switch\n2012-12-17 07:17:24 TRACE nova     return self.greenlet.switch()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n2012-12-17 07:17:24 TRACE nova     result = function(*args, **kwargs)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 101, in run_server\n2012-12-17 07:17:24 TRACE nova     server.start()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 162, in start\n2012-12-17 07:17:24 TRACE nova     self.manager.init_host()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1766, in init_host\n2012-12-17 07:17:24 TRACE nova     NetworkManager.init_host(self)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 758, in init_host\n2012-12-17 07:17:24 TRACE nova     self._setup_network_on_host(ctxt, network)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/manager.py\", line 1853, in _setup_network_on_host\n2012-12-17 07:17:24 TRACE nova     network['vpn_private_address'])\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/l3.py\", line 113, in add_vpn\n2012-12-17 07:17:24 TRACE nova     linux_net.ensure_vpn_forward(public_ip, port, private_ip)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 499, in ensure_vpn_forward\n2012-12-17 07:17:24 TRACE nova     iptables_manager.apply()\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 945, in inner\n2012-12-17 07:17:24 TRACE nova     retval = f(*args, **kwargs)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 334, in apply\n2012-12-17 07:17:24 TRACE nova     attempts=5)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 813, in _execute\n2012-12-17 07:17:24 TRACE nova     return utils.execute(*cmd, **kwargs)\n2012-12-17 07:17:24 TRACE nova   File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 244, in execute\n2012-12-17 07:17:24 TRACE nova     cmd=' '.join(cmd))\n2012-12-17 07:17:24 TRACE nova ProcessExecutionError: Unexpected error while running command.\n2012-12-17 07:17:24 TRACE nova Command: sudo nova-rootwrap iptables-restore\n2012-12-17 07:17:24 TRACE nova Exit code: 2\n2012-12-17 07:17:24 TRACE nova Stdout: ''\n2012-12-17 07:17:24 TRACE nova Stderr: \"iptables-restore v1.4.12: host/network `None' not found\\nError occurred at line: 23\\nTry `iptables-restore -h' or 'iptables-restore --help' for more information.\\n\"\n\n6- The issue happens within:\n\nnetwork/l3.py:\n\n    def add_vpn(self, public_ip, port, private_ip):\n        linux_net.ensure_vpn_forward(public_ip, port, private_ip)\n\n6.1- which calls, and ensure_vpn_forward, which doesn't do input check to see if private_ip or public_ip are actual IP addresses.\n\nnetwork/linux_net.py:\n\ndef ensure_vpn_forward(public_ip, port, private_ip):\n    \"\"\"Sets up forwarding rules for vlan.\"\"\"\n\n    iptables_manager.ipv4['filter'].add_rule('FORWARD',\n                                             '-d %s -p udp '\n                                             '--dport 1194 '\n                                             '-j ACCEPT' % private_ip)\n    iptables_manager.ipv4['nat'].add_rule('PREROUTING',\n                                          '-d %s -p udp '\n                                          '--dport %s -j DNAT --to %s:1194' %\n                                          (public_ip, port, private_ip))\n    iptables_manager.ipv4['nat'].add_rule(\"OUTPUT\",\n                                          \"-d %s -p udp \"\n                                          \"--dport %s -j DNAT --to %s:1194\" %\n                                          (public_ip, port, private_ip))\n    iptables_manager.apply()", 
            "date_created": "2012-12-18 17:50:09.256826+00:00", 
            "author": "https://api.launchpad.net/1.0/~edamato"
        }, 
        {
            "content": "This bug is missing log files that will aid in diagnosing the problem. From a terminal window please run:\n\napport-collect 1091780\n\nand then change the status of the bug to 'Confirmed'.\n\nIf, due to the nature of the issue you have encountered, you are unable to run this command, please add a comment stating that fact and change the bug status to 'Confirmed'.\n\nThis change has been made by an automated script, maintained by the Ubuntu Kernel Team.", 
            "date_created": "2012-12-18 18:00:08.982103+00:00", 
            "author": "https://api.launchpad.net/1.0/~brad-figg"
        }, 
        {
            "content": "Please run the command mentioned in comment #1, so we can see if this is a kernel bug or not. \n\nThanks in advance!", 
            "date_created": "2012-12-18 18:11:40.097173+00:00", 
            "author": "https://api.launchpad.net/1.0/~jsalisbury"
        }, 
        {
            "content": "Hi Joseph,\n\nThis is not a kernel bug, it's simply because nova is building an iptables rule that is broken. The problem happens on:\n\n\nnetwork/manager.py\n\n    def _setup_network_on_host(self, context, network):\n\n...\n\n        if address == FLAGS.vpn_ip and hasattr(self.driver,\n                                               \"ensure_vpn_forward\"):\n            LOG.warn(_('call add_vpn %s %s %s\\n'), FLAGS.vpn_ip,network['vpn_public_port'], network['vpn_private_address'])\n\n            self.l3driver.add_vpn(FLAGS.vpn_ip,\n                    network['vpn_public_port'],\n                    network['vpn_private_address'])\n\nWe can then see:\n\n2012-12-18 13:23:12 WARNING nova.network.manager [req-f9747e6d-e438-4801-992f-5e11324488aa None None] call add_vpn 192.168.124.150 None None\n\nthe network object is a <nova.db.sqlalchemy.models.Network object> which is obtaining the info via MySQL in this case. The question is whether there should be checking on the format of the variables in the network object, or if this should be done on the DB level.\n\n", 
            "date_created": "2012-12-18 18:39:27.986836+00:00", 
            "author": "https://api.launchpad.net/1.0/~edamato"
        }, 
        {
            "content": "Which version of nova-network?", 
            "date_created": "2014-01-09 14:06:24.192729+00:00", 
            "author": "https://api.launchpad.net/1.0/~zulcss"
        }, 
        {
            "content": "How can I reproduce this?  It sounds like a bad configuration somewhere, but without further information I am not sure.", 
            "date_created": "2014-01-10 23:08:59.575043+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "[Expired for nova (Ubuntu) because there has been no activity for 60 days.]", 
            "date_created": "2014-03-12 04:20:38.071882+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }, 
        {
            "content": "Hi All,\n\nI am facing the same issue during devtsack installation.\n\nKindly suggest the owkr around.\n\nThanks in advance\nSachi", 
            "date_created": "2014-12-04 06:02:01.319828+00:00", 
            "author": "https://api.launchpad.net/1.0/~sachi-gupta"
        }, 
        {
            "content": "Hi All,\nI am facing the same issue during Configuring VLAN Manager networking following instruction from book 'OpenStack Cloud Computing Cookbook'.\nPls suggest the walk around.\nThanks in advance\nJason", 
            "date_created": "2015-10-02 15:06:28.534387+00:00", 
            "author": "https://api.launchpad.net/1.0/~ywssxt"
        }
    ], 
    "closed": "2014-11-19 19:03:09.791186+00:00"
}