{
    "status": "Fix Released", 
    "last_updated": "2016-07-14 13:01:21.665950+00:00", 
    "description": "This failed in a python-novaclient functional CI run for newton (current master):\n\nhttp://logs.openstack.org/11/328211/5/gate/gate-novaclient-dsvm-functional/cd6a3d2/logs/screen-n-api.txt.gz?level=TRACE\n\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions [req-7b05c7c9-153d-4571-9d56-5a421159af1a admin admin] Unexpected exception in API method\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions Traceback (most recent call last):\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/extensions.py\", line 453, in wrapped\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/servers.py\", line 543, in show\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return self._view_builder.show(req, instance)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/views/servers.py\", line 317, in show\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     server[\"server\"][\"tags\"] = [t.tag for t in instance.tags]\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 67, in getter\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     self.obj_load_attr(name)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 985, in obj_load_attr\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     self._load_generic(attrname)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 765, in _load_generic\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     expected_attrs=[attrname])\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 181, in wrapper\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 416, in get_by_uuid\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     use_slave=use_slave)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 225, in wrapper\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 408, in _db_instance_get_by_uuid\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     columns_to_join=columns_to_join)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/api.py\", line 692, in instance_get_by_uuid\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return IMPL.instance_get_by_uuid(context, uuid, columns_to_join)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 169, in wrapper\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 270, in wrapped\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return f(context, *args, **kwargs)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1814, in instance_get_by_uuid\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     columns_to_join=columns_to_join)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1823, in _instance_get_by_uuid\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     raise exception.InstanceNotFound(instance_id=uuid)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions InstanceNotFound: Instance a7c3ed25-c0dd-47a9-8eb5-b268dd0c3ad4 could not be found.\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions \n\nThe test is waiting for the server to be deleted. It blows up here because we didn't lazy-load the instance tags:\n\nhttps://github.com/openstack/nova/blob/537df23d85e0f7c461643efe6b6501d267ae99d0/nova/api/openstack/compute/views/servers.py#L316\n\nAnd because we don't handle lazy-loading 'tags' specifically it does the load-generic with a join on the tags table, but the instance is deleted so it blows up with InstanceNotFound:\n\nhttps://github.com/openstack/nova/blob/537df23d85e0f7c461643efe6b6501d267ae99d0/nova/objects/instance.py#L753\n\nWe should just treat it like we do for instance.services:\n\nhttps://github.com/openstack/nova/blob/537df23d85e0f7c461643efe6b6501d267ae99d0/nova/objects/instance.py#L921\n\nEspecially because instance tags are deleted when the instance is deleted:\n\nhttps://github.com/openstack/nova/blob/537df23d85e0f7c461643efe6b6501d267ae99d0/nova/db/sqlalchemy/api.py#L2037", 
    "tags": [
        "api", 
        "tags"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1592963", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1592963, 
    "index": 1935, 
    "openned": "2016-06-15 20:04:07.122178+00:00", 
    "created": "2016-06-15 20:04:07.122178+00:00", 
    "title": "Showing server details on a deleted instance fails for >=v2.26", 
    "comments": [
        {
            "content": "This failed in a python-novaclient functional CI run for newton (current master):\n\nhttp://logs.openstack.org/11/328211/5/gate/gate-novaclient-dsvm-functional/cd6a3d2/logs/screen-n-api.txt.gz?level=TRACE\n\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions [req-7b05c7c9-153d-4571-9d56-5a421159af1a admin admin] Unexpected exception in API method\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions Traceback (most recent call last):\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/extensions.py\", line 453, in wrapped\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/servers.py\", line 543, in show\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return self._view_builder.show(req, instance)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/views/servers.py\", line 317, in show\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     server[\"server\"][\"tags\"] = [t.tag for t in instance.tags]\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 67, in getter\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     self.obj_load_attr(name)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 985, in obj_load_attr\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     self._load_generic(attrname)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 765, in _load_generic\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     expected_attrs=[attrname])\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 181, in wrapper\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 416, in get_by_uuid\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     use_slave=use_slave)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 225, in wrapper\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/instance.py\", line 408, in _db_instance_get_by_uuid\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     columns_to_join=columns_to_join)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/api.py\", line 692, in instance_get_by_uuid\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return IMPL.instance_get_by_uuid(context, uuid, columns_to_join)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 169, in wrapper\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 270, in wrapped\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     return f(context, *args, **kwargs)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1814, in instance_get_by_uuid\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     columns_to_join=columns_to_join)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 1823, in _instance_get_by_uuid\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions     raise exception.InstanceNotFound(instance_id=uuid)\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions InstanceNotFound: Instance a7c3ed25-c0dd-47a9-8eb5-b268dd0c3ad4 could not be found.\n2016-06-15 19:42:01.313 12360 ERROR nova.api.openstack.extensions \n\nThe test is waiting for the server to be deleted. It blows up here because we didn't lazy-load the instance tags:\n\nhttps://github.com/openstack/nova/blob/537df23d85e0f7c461643efe6b6501d267ae99d0/nova/api/openstack/compute/views/servers.py#L316\n\nAnd because we don't handle lazy-loading 'tags' specifically it does the load-generic with a join on the tags table, but the instance is deleted so it blows up with InstanceNotFound:\n\nhttps://github.com/openstack/nova/blob/537df23d85e0f7c461643efe6b6501d267ae99d0/nova/objects/instance.py#L753\n\nWe should just treat it like we do for instance.services:\n\nhttps://github.com/openstack/nova/blob/537df23d85e0f7c461643efe6b6501d267ae99d0/nova/objects/instance.py#L921\n\nEspecially because instance tags are deleted when the instance is deleted:\n\nhttps://github.com/openstack/nova/blob/537df23d85e0f7c461643efe6b6501d267ae99d0/nova/db/sqlalchemy/api.py#L2037", 
            "date_created": "2016-06-15 20:04:07.122178+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Actually I'm not really sure how this failed because when listing instances and the microversion is >=2.26 it lazy-loads the tags, which should give it an empty list:\n\nhttps://github.com/openstack/nova/blob/537df23d85e0f7c461643efe6b6501d267ae99d0/nova/api/openstack/compute/servers.py#L407", 
            "date_created": "2016-06-15 20:43:34.358680+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "OK, listing instances would be OK, it's the show that fails...", 
            "date_created": "2016-06-15 20:47:44.860287+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "So this is the failure in this case:\n\nhttps://github.com/openstack/nova/blob/537df23d85e0f7c461643efe6b6501d267ae99d0/nova/api/openstack/compute/servers.py#L446\n\nWe don't lazy-load the tags when showing details on the server, and if between the time we got the instance and it was deleted we lazy-load the tags in the view builder it will fail.", 
            "date_created": "2016-06-15 20:51:14.015109+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/330229", 
            "date_created": "2016-06-15 21:25:23.123502+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/330232", 
            "date_created": "2016-06-15 21:41:45.146119+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/330229\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ffe2487cf60e91659b6cb8a09b10de5455d9a3ed\nSubmitter: Jenkins\nBranch:    master\n\ncommit ffe2487cf60e91659b6cb8a09b10de5455d9a3ed\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Jun 15 17:21:23 2016 -0400\n\n    Pre-load tags when showing server details\n    \n    When microversion>=2.26 is requested to show server details\n    we should pre-load 'tags' when getting the instance from the\n    database. Listing server details already does this, but show\n    didn't.\n    \n    Failing to do this can also result in a 500 response from the\n    server. The scenario is you delete a server and then poll for\n    it to be gone using 'nova show'. In between the time that the\n    server is retrieved from the database and the view builder\n    creates the response, the instance is deleted and since\n    instance.tags is not set it will attempt to lazy-load the tags\n    which will fail with an InstanceNotFound.\n    \n    We need to also fix the lazy-load issue in the instance object\n    but that will come in a follow-on change.\n    \n    Change-Id: Iae6551028179e31699c06d06284ca4c1660be240\n    Closes-Bug: #1592963\n", 
            "date_created": "2016-06-16 14:53:41.536201+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/330232\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=e74b5b75de8ad58263dc253a48668626485b3f36\nSubmitter: Jenkins\nBranch:    master\n\ncommit e74b5b75de8ad58263dc253a48668626485b3f36\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Jun 15 17:39:52 2016 -0400\n\n    Don't attempt to lazy-load tags on a deleted instance\n    \n    Since we don't have a specific handler for lazy-loading\n    tags on an Instance object it loads generically but\n    that will fail with an InstanceNotFound on a deleted\n    instance, so just handle this in obj_load_attr like we\n    do for 'services'. Note we can't call the TagList object\n    to load the tags for us since the DB API will fail if\n    the instance is deleted too.\n    \n    Change-Id: If3580dcc3e83f612b96a2c3ad893a5045ee6100a\n    Related-Bug: #1592963\n", 
            "date_created": "2016-06-23 11:47:56.442546+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b2 development milestone.", 
            "date_created": "2016-07-14 13:01:21.037193+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }
    ], 
    "closed": "2016-06-16 14:53:38.804731+00:00"
}