{
    "status": "Invalid", 
    "last_updated": "2014-09-18 23:13:23.839681+00:00", 
    "description": "I saw instance creation failed when nova-network attempted create duplicated MAC address for vif.\nIn nova code, there are exception code exists but It looks doesn't catch exception Integrity error.\n\nThis is my test code.\n\n#!/usr/bin/python\nfrom nova import utils\nfrom nova import flags\nimport nova.context\nimport sys\nfrom nova import db\n\ndef main(sys):\n    context = nova.context.RequestContext('<email address hidden>','prj-test',True,False)\n    vif = {'address': '02:16:3e:63:c9:39',\n               'instance_id': 1,\n               'network_id': 1,\n               'uuid': str(utils.gen_uuid())}\n\n    db.virtual_interface_create(context, vif)\n\nif __name__ == '__main__':\n    utils.default_flagfile()\n    FLAGS = flags.FLAGS(sys.argv)\n\n'02:16:3e:63:c9:39' is already exists db table. So I expected exception.VirtualInterfaceCreateException() because In db/sqlalchemy/api.py,\n\n @require_context\n def virtual_interface_create(context, values):\n     \"\"\"Create a new virtual interface record in teh database.\n\n     :param values: = dict containing column values\n     \"\"\"\n     try:\n         vif_ref = models.VirtualInterface()\n        vif_ref.update(values)\n         vif_ref.save()\n     except IntegrityError:\n        raise exception.VirtualInterfaceCreateException()\n\n     return vif_ref\n\nBut next error is occured when I tested.\nTraceback (most recent call last):\n  File \"./test_create_vif.sh\", line 23, in <module>\n    main(sys)\n  File \"./test_create_vif.sh\", line 17, in main\n    db.virtual_interface_create(context, vif)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/api.py\", line 448, in virtual_interface_create\n    return IMPL.virtual_interface_create(context, values)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/sqlalchemy/api.py\", line 120, in wrapper\n    return f(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/sqlalchemy/api.py\", line 1002, in virtual_interface_create\n    vif_ref.save()\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/sqlalchemy/models.py\", line 59, in save\n    session.flush()\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/exception.py\", line 98, in _wrap\n    raise DBError(e)\nnova.exception.DBError: (IntegrityError) (1062, \"Duplicate entry '02:16:3e:63:c9:39' for key 'address'\") 'INSERT INTO virtual_interfaces (created_at, updated_at, deleted_at, deleted, address, network_id, instance_id, uuid) VALUES (%s, %s, %s, %s, %s, %s, %s, %s)' (datetime.datetime(2012, 10, 5, 8, 7, 30, 868674), None, None, 0, '02:16:3e:63:c9:39', 1, 1, '9452abe3-3fea-4706-94e3-876753e8bcb1')\n\nFor this reason, When VIF's mac address is duplicated, maybe instance creation is failed.\n\nWhen Instance is created, below code is executed.\n\nnova/network/manager.py\n\n    def add_virtual_interface(self, context, instance_uuid, network_id):\n        vif = {'address': utils.generate_mac_address(),\n               'instance_uuid': instance_uuid,\n               'network_id': network_id,\n               'uuid': str(utils.gen_uuid())}\n        # try FLAG times to create a vif record with a unique mac_address\n        for i in xrange(FLAGS.create_unique_mac_address_attempts):\n            try:\n                return self.db.virtual_interface_create(context, vif)\n            except exception.VirtualInterfaceCreateException:\n                vif['address'] = utils.generate_mac_address()\n        else:\n            self.db.virtual_interface_delete_by_instance(context,\n                                                         instance_uuid)\n            raise exception.VirtualInterfaceMacAddressException()", 
    "tags": [], 
    "importance": "Low", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1062097", 
    "owner": "None", 
    "id": 1062097, 
    "index": 667, 
    "openned": "2012-10-05 08:11:19.711326+00:00", 
    "created": "2012-10-05 08:11:19.711326+00:00", 
    "title": "virtual interface create error", 
    "comments": [
        {
            "content": "I saw instance creation failed when nova-network attempted create duplicated MAC address for vif.\nIn nova code, there are exception code exists but It looks doesn't catch exception Integrity error.\n\nThis is my test code.\n\n#!/usr/bin/python\nfrom nova import utils\nfrom nova import flags\nimport nova.context\nimport sys\nfrom nova import db\n\ndef main(sys):\n    context = nova.context.RequestContext('<email address hidden>','prj-test',True,False)\n    vif = {'address': '02:16:3e:63:c9:39',\n               'instance_id': 1,\n               'network_id': 1,\n               'uuid': str(utils.gen_uuid())}\n\n    db.virtual_interface_create(context, vif)\n\nif __name__ == '__main__':\n    utils.default_flagfile()\n    FLAGS = flags.FLAGS(sys.argv)\n\n'02:16:3e:63:c9:39' is already exists db table. So I expected exception.VirtualInterfaceCreateException() because In db/sqlalchemy/api.py,\n\n @require_context\n def virtual_interface_create(context, values):\n     \"\"\"Create a new virtual interface record in teh database.\n\n     :param values: = dict containing column values\n     \"\"\"\n     try:\n         vif_ref = models.VirtualInterface()\n        vif_ref.update(values)\n         vif_ref.save()\n     except IntegrityError:\n        raise exception.VirtualInterfaceCreateException()\n\n     return vif_ref\n\nBut next error is occured when I tested.\nTraceback (most recent call last):\n  File \"./test_create_vif.sh\", line 23, in <module>\n    main(sys)\n  File \"./test_create_vif.sh\", line 17, in main\n    db.virtual_interface_create(context, vif)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/api.py\", line 448, in virtual_interface_create\n    return IMPL.virtual_interface_create(context, values)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/sqlalchemy/api.py\", line 120, in wrapper\n    return f(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/sqlalchemy/api.py\", line 1002, in virtual_interface_create\n    vif_ref.save()\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/sqlalchemy/models.py\", line 59, in save\n    session.flush()\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/exception.py\", line 98, in _wrap\n    raise DBError(e)\nnova.exception.DBError: (IntegrityError) (1062, \"Duplicate entry '02:16:3e:63:c9:39' for key 'address'\") 'INSERT INTO virtual_interfaces (created_at, updated_at, deleted_at, deleted, address, network_id, instance_id, uuid) VALUES (%s, %s, %s, %s, %s, %s, %s, %s)' (datetime.datetime(2012, 10, 5, 8, 7, 30, 868674), None, None, 0, '02:16:3e:63:c9:39', 1, 1, '9452abe3-3fea-4706-94e3-876753e8bcb1')\n\nFor this reason, When VIF's mac address is duplicated, maybe instance creation is failed.\n\nWhen Instance is created, below code is executed.\n\nnova/network/manager.py\n\n    def add_virtual_interface(self, context, instance_uuid, network_id):\n        vif = {'address': utils.generate_mac_address(),\n               'instance_uuid': instance_uuid,\n               'network_id': network_id,\n               'uuid': str(utils.gen_uuid())}\n        # try FLAG times to create a vif record with a unique mac_address\n        for i in xrange(FLAGS.create_unique_mac_address_attempts):\n            try:\n                return self.db.virtual_interface_create(context, vif)\n            except exception.VirtualInterfaceCreateException:\n                vif['address'] = utils.generate_mac_address()\n        else:\n            self.db.virtual_interface_delete_by_instance(context,\n                                                         instance_uuid)\n            raise exception.VirtualInterfaceMacAddressException()", 
            "date_created": "2012-10-05 08:11:19.711326+00:00", 
            "author": "https://api.launchpad.net/1.0/~hyangii"
        }, 
        {
            "content": "When I modify exception.py, exception.VirtualInterfaceMacAddressException() is occured.\n\nFrom:\ndef wrap_db_error(f):\n    def _wrap(*args, **kwargs):\n        try:\n            return f(*args, **kwargs)\n        except UnicodeEncodeError:\n            raise InvalidUnicodeParameter()\n        except Exception, e:\n            LOG.exception(_('DB exception wrapped.'))\n            raise DBError(e)\n    _wrap.func_name = f.func_name\n    return _wrap\n\nTo:\ndef wrap_db_error(f):\n    def _wrap(*args, **kwargs):\n        try:\n            return f(*args, **kwargs)\n        except UnicodeEncodeError:\n            raise InvalidUnicodeParameter()\n        except Exception, e:\n            LOG.exception(_('DB exception wrapped.'))\n            raise e\n    _wrap.func_name = f.func_name\n    return _wrap\n\nThis is error trace when changed code.\nTraceback (most recent call last):\n  File \"./test_create_vif.sh\", line 23, in <module>\n    main(sys)\n  File \"./test_create_vif.sh\", line 17, in main\n    db.virtual_interface_create(context, vif)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/api.py\", line 448, in virtual_interface_create\n    return IMPL.virtual_interface_create(context, values)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/sqlalchemy/api.py\", line 120, in wrapper\n    return f(*args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/nova-2012.1-py2.7.egg/nova/db/sqlalchemy/api.py\", line 1004, in virtual_interface_create\n    raise exception.VirtualInterfaceCreateException()\nnova.exception.VirtualInterfaceCreateException: Virtual Interface creation failed\n", 
            "date_created": "2012-10-05 08:16:24.179451+00:00", 
            "author": "https://api.launchpad.net/1.0/~hyangii"
        }, 
        {
            "content": "this is obviously not being worked on.", 
            "date_created": "2013-01-18 20:47:01.231444+00:00", 
            "author": "https://api.launchpad.net/1.0/~zulcss"
        }, 
        {
            "content": "This should be handled by the unique keys blueprint", 
            "date_created": "2013-02-26 20:57:08.552704+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Going to assume the unique keys blueprint addressed this", 
            "date_created": "2014-09-18 23:13:23.149247+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ], 
    "closed": "2014-09-18 23:13:09.929306+00:00"
}