{
    "status": "Fix Released", 
    "last_updated": "2015-09-24 00:14:28.381612+00:00", 
    "description": "Boot from image and creation of a new volume does not pass instance  availability zone to cinder when creating volume.\n\nHere is a fail scenario.\n\nConfigure cinder to run volume service in different availability zones.\nCross zone volume usage should be disabled (in nova conf cinder_cross_az_attach=false ).\n\n[root@node-7 ~]# cinder service-list\n+------------------+--------------------+----------+---------+-------+----------------------------+\n|      Binary      |        Host        |   Zone   |  Status | State |         Updated_at         |\n+------------------+--------------------+----------+---------+-------+----------------------------+\n| cinder-scheduler | node-10.domain.tld | internal | enabled |   up  | 2014-10-13T20:12:18.000000 |\n| cinder-scheduler | node-7.domain.tld  | internal | enabled |   up  | 2014-10-13T20:12:15.000000 |\n| cinder-scheduler | node-8.domain.tld  | internal | enabled |   up  | 2014-10-13T20:12:18.000000 |\n|  cinder-volume   |   node-10.reg1a    |  reg1a   | enabled |   up  | 2014-10-13T20:12:14.000000 |\n|  cinder-volume   |   node-10.reg1b    |  reg1b   | enabled |   up  | 2014-10-13T20:12:14.000000 |\n|  cinder-volume   |    node-7.reg1a    |  reg1a   | enabled |   up  | 2014-10-13T20:12:18.000000 |\n|  cinder-volume   |    node-7.reg1b    |  reg1b   | enabled |   up  | 2014-10-13T20:12:14.000000 |\n|  cinder-volume   |    node-8.reg1a    |  reg1a   | enabled |   up  | 2014-10-13T20:12:21.000000 |\n|  cinder-volume   |    node-8.reg1b    |  reg1b   | enabled |   up  | 2014-10-13T20:12:21.000000 |\n+------------------+--------------------+----------+---------+-------+----------------------------+\n\nRun CLI as below to create a volume from an existing image and using it to boot an instance.\n\nnova boot test --flavor 1 --image 32705323-4bfb-4cd7-9711-f5459fd236d8 --nic net-id=ca3b4232-405c-4225-9724-0f0dde69c1d5  --availability-zone=reg1a  --block-device \"source=image,id=32705323-4bfb-4cd7-9711-f5459fd236d8,dest=volume,size=10,bootindex=1\"\n\nThis will attempt to create volume in internal (default) availability zone. But creation will fail because there are no volume service in internal  availability zone.\n\n+--------------------------------+--------------------------------------+\n|            Property            |                Value                 |\n+--------------------------------+--------------------------------------+\n|          attachments           |                  []                  |\n|       availability_zone        |               internal               |\n|            bootable            |                false                 |\n|           created_at           |      2014-10-13T19:45:24.000000      |\n|      display_description       |                                      |\n|          display_name          |                                      |\n|           encrypted            |                False                 |\n|               id               | e358b519-4287-45a5-85cc-1e6a0d371fb1 |\n|            metadata            |                  {}                  |\n|     os-vol-host-attr:host      |                 None                 |\n| os-vol-mig-status-attr:migstat |                 None                 |\n| os-vol-mig-status-attr:name_id |                 None                 |\n|  os-vol-tenant-attr:tenant_id  |   1cd2c85585ed42dcaf266b57c22c86ef   |\n|              size              |                  10                  |\n|          snapshot_id           |                 None                 |\n|          source_volid          |                 None                 |\n|             status             |                error                 |\n|          volume_type           |                 None                 |\n+--------------------------------+--------------------------------------+\n\nThe instance boot fail with error: \"InvalidVolume: Invalid volume: status must be 'available'\".", 
    "tags": [
        "volumes"
    ], 
    "importance": "Low", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1380780", 
    "owner": "https://api.launchpad.net/1.0/~andreykurilin", 
    "id": 1380780, 
    "index": 1423, 
    "openned": "2014-10-13 20:22:36.343437+00:00", 
    "created": "2014-10-13 20:22:36.343437+00:00", 
    "title": "Boot from image and create a new volume ignores availability zone", 
    "comments": [
        {
            "content": "Boot from image and creation of a new volume does not pass instance  availability zone to cinder when creating volume.\n\nHere is a fail scenario.\n\nConfigure cinder to run volume service in different availability zones.\n\n[root@node-7 ~]# cinder service-list\n+------------------+--------------------+----------+---------+-------+----------------------------+\n|      Binary      |        Host        |   Zone   |  Status | State |         Updated_at         |\n+------------------+--------------------+----------+---------+-------+----------------------------+\n| cinder-scheduler | node-10.domain.tld | internal | enabled |   up  | 2014-10-13T20:12:18.000000 |\n| cinder-scheduler | node-7.domain.tld  | internal | enabled |   up  | 2014-10-13T20:12:15.000000 |\n| cinder-scheduler | node-8.domain.tld  | internal | enabled |   up  | 2014-10-13T20:12:18.000000 |\n|  cinder-volume   |   node-10.reg1a    |  reg1a   | enabled |   up  | 2014-10-13T20:12:14.000000 |\n|  cinder-volume   |   node-10.reg1b    |  reg1b   | enabled |   up  | 2014-10-13T20:12:14.000000 |\n|  cinder-volume   |    node-7.reg1a    |  reg1a   | enabled |   up  | 2014-10-13T20:12:18.000000 |\n|  cinder-volume   |    node-7.reg1b    |  reg1b   | enabled |   up  | 2014-10-13T20:12:14.000000 |\n|  cinder-volume   |    node-8.reg1a    |  reg1a   | enabled |   up  | 2014-10-13T20:12:21.000000 |\n|  cinder-volume   |    node-8.reg1b    |  reg1b   | enabled |   up  | 2014-10-13T20:12:21.000000 |\n+------------------+--------------------+----------+---------+-------+----------------------------+\n\n \nRun CLI as below to create a volume from an existing image and using it to boot an instance.\n\nnova boot test --flavor 1 --image 32705323-4bfb-4cd7-9711-f5459fd236d8 --nic net-id=ca3b4232-405c-4225-9724-0f0dde69c1d5  --availability-zone=reg1a  --block-device \"source=image,id=32705323-4bfb-4cd7-9711-f5459fd236d8,dest=volume,size=10,bootindex=1\"\n\nThis will attempt to create volume in internal (default) availability zone. But creation will fail because there are no volume service in internal  availability zone.\n\n+--------------------------------+--------------------------------------+\n|            Property            |                Value                 |\n+--------------------------------+--------------------------------------+\n|          attachments           |                  []                  |\n|       availability_zone        |               internal               |\n|            bootable            |                false                 |\n|           created_at           |      2014-10-13T19:45:24.000000      |\n|      display_description       |                                      |\n|          display_name          |                                      |\n|           encrypted            |                False                 |\n|               id               | e358b519-4287-45a5-85cc-1e6a0d371fb1 |\n|            metadata            |                  {}                  |\n|     os-vol-host-attr:host      |                 None                 |\n| os-vol-mig-status-attr:migstat |                 None                 |\n| os-vol-mig-status-attr:name_id |                 None                 |\n|  os-vol-tenant-attr:tenant_id  |   1cd2c85585ed42dcaf266b57c22c86ef   |\n|              size              |                  10                  |\n|          snapshot_id           |                 None                 |\n|          source_volid          |                 None                 |\n|             status             |                error                 |\n|          volume_type           |                 None                 |\n+--------------------------------+--------------------------------------+\n\nThe instance boot fail with error: \"InvalidVolume: Invalid volume: status must be 'available'\".", 
            "date_created": "2014-10-13 20:22:36.343437+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexzzman"
        }, 
        {
            "content": "What version of nova is this using?", 
            "date_created": "2014-10-13 20:52:19.963523+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "i'm using 2014.1.1", 
            "date_created": "2014-10-14 01:59:46.369654+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexzzman"
        }, 
        {
            "content": "Hi all,\r\nI'd like to join fixing this bug.\r\nIf possible, please kindly input more available info for debugging.\r\nThanks", 
            "date_created": "2014-10-27 06:24:36.174927+00:00", 
            "author": "https://api.launchpad.net/1.0/~trung-t-trinh"
        }, 
        {
            "content": "I can re-produce this bug as follows:\n1.  Create some new availability zones (using cmd \"nova aggregate-create\"):\nnova$ nova aggregate-list\n+----+-----------------+-------------------+\n| Id | Name            | Availability Zone |\n+----+-----------------+-------------------+\n| 3  | test-aggregate1 | test_az1          |\n| 4  | test-aggregate2 | test_az2          |\n+----+-----------------+-------------------+\n\n2.  Create a volume  from an existing img and use it to boot a VM:\nnova$ nova boot test --flavor 1 --image a015dd92-7e7e-4f39-93b9-28dc07a85a69 --nic net-id=9a69dc24-15d3-4fe4-873f-a585c58de5a0 --availability-zone=test_az1 --block-device \"source=image,id=a015dd92-7e7e-4f39-93b9-28dc07a85a69,dest=volume,size=10,bootindex=1\"\n\nResult:\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-SRV-ATTR:host                 | -                                                              |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                              |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000001                                              |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | scheduling                                                     |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| adminPass                            | GFUo3XmY34uL                                                   |\n| config_drive                         |                                                                |\n| created                              | 2014-10-27T10:53:31Z                                           |\n| flavor                               | m1.tiny (1)                                                    |\n| hostId                               |                                                                |\n| id                                   | 356486df-b22b-4f85-b887-1e633fea7597                           |\n| image                                | cirros-0.3.1-x86_64-uec (a015dd92-7e7e-4f39-93b9-28dc07a85a69) |\n| key_name                             | -                                                              |\n| metadata                             | {}                                                             |\n| name                                 | test                                                           |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | default                                                        |\n| status                               | BUILD                                                          |\n| tenant_id                            | 182861365d6a4c5782fd614591b2d17b                               |\n| updated                              | 2014-10-27T10:53:32Z                                           |\n| user_id                              | 595d6bc25f0c46e9a8f622538dff38c2                               |\n+--------------------------------------+----------------------------------------------------------------+\nxtrutri@ubuntu:/opt/stack_juno/nova$ cinder service-list\n+------------------+--------+------+---------+-------+----------------------------+-----------------+\n|      Binary      |  Host  | Zone |  Status | State |         Updated_at         | Disabled Reason |\n+------------------+--------+------+---------+-------+----------------------------+-----------------+\n| cinder-scheduler | ubuntu | nova | enabled |   up  | 2014-10-27T10:55:25.000000 |       None      |\n|  cinder-volume   | ubuntu | nova | enabled |   up  | 2014-10-27T10:55:25.000000 |       None      |\n+------------------+--------+------+---------+-------+----------------------------+-----------------+\n\n3. Observed: \n -- The created volume has status of \"Error\":  seemingly that the volume is created in the availability zone of \"nova\" that's the default one. It should have been created in the availability zone of \"test_az1\"\n -- The created VM also has status of \"Error\". It belongs to the availability zone of \"test_az1\" as specified on cmd-line.\n -- Another strange thing is that the default availability zone \"nova\" disappears (from Horizon dashboard) after creating the new availability zone of \"test_az1\". Is this also a bug? Why does the \"nova\" az disappear?\n", 
            "date_created": "2014-10-27 11:10:59.535551+00:00", 
            "author": "https://api.launchpad.net/1.0/~trung-t-trinh"
        }, 
        {
            "content": "I think that the root cause is not due to \"nova boot\". Instead, it is due to the fact that the created volume is in erroneous status and consequently, no VM can be booted from it.\n\nDo you also agree? ", 
            "date_created": "2014-10-27 11:14:37.418984+00:00", 
            "author": "https://api.launchpad.net/1.0/~trung-t-trinh"
        }, 
        {
            "content": "Now, on my system, there are 2 availability zones that are the \"nova\" (the default one) and the \"test_az1\" (the newly-created one).\nIt is strange that on Horizon dashboard, in the process of launching new VM, only \"test_az1\" is displayed and \"nova\" is disappeared. However, also on Horizon dashboard, in the process of creating new volume, only \"nova\" is displayed and \"test_az1\" is disappeared.\n\nThis can imply that it's only possible to launch a new VM in the availability zone of \"test_az1\" and to create a volume in another availability zone of \"nova\".  Conflict!", 
            "date_created": "2014-10-27 11:22:25.327129+00:00", 
            "author": "https://api.launchpad.net/1.0/~trung-t-trinh"
        }, 
        {
            "content": "I use DevStack to deploy OpenStack on a VM (i.e. single-node deployment). \nOn my local OpenStack, I can create a new VM instance (booted from volume) in an availability zone that is different from the availability zone of the volume used for booting.\nI also try using provided CLI (above) and it also works fine.\n\nMy local OpenStack version is: stable/juno\n\nTherefore, I doubt that whether or not this problem occurs only on multi-node deployment?\n", 
            "date_created": "2014-11-05 06:56:28.349548+00:00", 
            "author": "https://api.launchpad.net/1.0/~trung-t-trinh"
        }, 
        {
            "content": "Steps to reproduce this bug:\n1. Set \"cinder_cross_az_attach=false\" in nova.conf\n2. Set \"storage_availability_zone=test-az\" in cinder.conf\n3. Restart nova and cinder services\n4. Create a host aggregate that is exposed as \"test-az\" availability zone\n5. Add a host to a host aggregate\n6. Try to boot instance in non-default availability zone\n(more details about 4-6 steps you can found at\nhttp://blog.russellbryant.net/2013/05/21/availability-zones-and-host-aggregates-in-openstack-compute-nova/)", 
            "date_created": "2015-02-18 16:52:39.359357+00:00", 
            "author": "https://api.launchpad.net/1.0/~andreykurilin"
        }, 
        {
            "content": "Proposed bug-fix: https://review.openstack.org/#/c/157041", 
            "date_created": "2015-02-18 16:53:01.319965+00:00", 
            "author": "https://api.launchpad.net/1.0/~andreykurilin"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/157041\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=6060888b58db42eea826939852838f9e1c204d2c\nSubmitter: Jenkins\nBranch:    master\n\ncommit 6060888b58db42eea826939852838f9e1c204d2c\nAuthor: Andrey Kurilin <email address hidden>\nDate:   Wed Feb 18 17:33:22 2015 +0200\n\n    Create volume in the same availability zone as instance\n    \n    Volume should be created in the same availability zone as an instance to\n    prevent:\n     > InvalidVolume: Instance and volume not in same availability_zone\n    \n    Change-Id: I121cbdb68ec06d9b358a12c857dc24b75d7973e4\n    Closes-Bug: #1380780\n", 
            "date_created": "2015-02-24 01:08:26.481832+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Here is a patch to apply for stable/juno\n\nhttps://github.com/mmnelemane/nova/commit/172e491af742113ae0d1cd0084824eb3b958b560", 
            "date_created": "2015-08-21 09:52:58.736562+00:00", 
            "author": "https://api.launchpad.net/1.0/~mmohan-9"
        }, 
        {
            "content": "Here is a patch for backport to stable/juno\n\nhttps://github.com/mmnelemane/nova/commit/172e491af742113ae0d1cd0084824eb3b958b560\n\n", 
            "date_created": "2015-08-21 13:10:12.872447+00:00", 
            "author": "https://api.launchpad.net/1.0/~mmohan-9"
        }, 
        {
            "content": "Change abandoned by Madhu Mohan (<email address hidden>) on branch: stable/juno\nReview: https://review.openstack.org/216666\nReason: Another person is working on this change.", 
            "date_created": "2015-09-09 11:30:23.109249+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/226977", 
            "date_created": "2015-09-23 20:25:23.151701+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/226977\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d8d2f02f3014e8d7e0ef9a61723f5a10f050cc81\nSubmitter: Jenkins\nBranch:    master\n\ncommit d8d2f02f3014e8d7e0ef9a61723f5a10f050cc81\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Sep 23 13:21:06 2015 -0700\n\n    Deprecate cinder.cross_az_attach option\n    \n    Introduced in 1504cbc5d4a27695fa663f0b0f3f7b48745bdb45 in Grizzly, the\n    use cases around this option are unclear but there have been several\n    bugs related to it.\n    \n    For example, 6060888b58db42eea826939852838f9e1c204d2c changed boot from\n    volume to pass the server instance availability zone to cinder when\n    creating the volume.  However, if that same AZ does not exist in Cinder,\n    the volume create request will fail - which is bug 1496235.\n    \n    Cinder works around this with b85d2812a8256ff82934d150dbc4909e041d8b31\n    using a config option to allow falling back to a default Cinder AZ if\n    the one requested does not exist.  By default this fallback is disabled\n    though.\n    \n    It also sounds like availability zones in Cinder were an artifact from\n    when Cinder was split out from the nova-volume service, but Cinder AZ\n    use cases are also unclear.  And it's also unclear what the relationship\n    is between AZs in Nova and Cinder.\n    \n    So given the problems here and the lack of a clear use case to justify\n    having this configuration option in tree, along with it's added\n    complexity, deprecate the option for removal.\n    \n    Related-Bug: #1496235\n    Related-Bug: #1380780\n    Related-Bug: #1489575\n    Related-Bug: #1497253\n    \n    Change-Id: I52cd3d8867d3b35f5caba377302bfc52c112f1d6\n", 
            "date_created": "2015-09-24 00:14:27.685629+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-03-20 07:39:51.969378+00:00"
}