{
    "status": "In Progress", 
    "last_updated": "2017-09-12 13:12:40.542838+00:00", 
    "description": "As of now on current master the simple tenant usage api is calculating disk usages information incorrectly in case in instance is booted from volume.\n\nIf user boots the instance from volume then the disk usages should not be considered but it's taking the flavor.root_gb as local_gb used.\n\nSteps to reproduce:\n\n1. Create bootable volume\n\n$ cinder create 1 --name bootable_volume --image 33a7f2aa-5e48-4545-a484-b598abdee1e3\n\n+--------------------------------------+-----------+-----------------+------+-------------+----------+-------------+\n| ID                                   | Status    | Name            | Size | Volume Type | Bootable | Attached to |\n+--------------------------------------+-----------+-----------------+------+-------------+----------+-------------+\n| 0399f203-5f36-4b9a-b76f-bada8b9afdc6 | available | bootable_volume | 1    | lvmdriver-1 | true     |             |\n+--------------------------------------+-----------+-----------------+------+-------------+----------+-------------+\n\n2. Flavor details:\n\n$ nova flavor-show 1\n+----------------------------+---------+\n| Property                   | Value   |\n+----------------------------+---------+\n| OS-FLV-DISABLED:disabled   | False   |\n| OS-FLV-EXT-DATA:ephemeral  | 0       |\n| disk                       | 1       |\n| extra_specs                | {}      |\n| id                         | 1       |\n| name                       | m1.tiny |\n| os-flavor-access:is_public | True    |\n| ram                        | 512     |\n| rxtx_factor                | 1.0     |\n| swap                       |         |\n| vcpus                      | 1       |\n+----------------------------+---------+\n\n3. Create instance from volume:\n\n$ nova boot --flavor 1 --boot-volume 0399f203-5f36-4b9a-b76f-bada8b9afdc6 boot-from-volume\n\n+--------------------------------------+------------------+--------+------------+-------------+---------------------------------+\n| ID                                   | Name             | Status | Task State | Power State | Networks                        |\n+--------------------------------------+------------------+--------+------------+-------------+---------------------------------+\n| c46243b7-9034-4847-a9c5-480f5e60f59f | boot-from-volume | ACTIVE | -          | Running     | public=172.24.4.11, 2001:db8::8 |\n+--------------------------------------+------------------+--------+------------+-------------+---------------------------------+\n\n4. Check the simple tenant usage:\n\n$ nova usage --tenant f77f8f0f6f1b46fe8a43b27a5372f427 --start 2017-09-07\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   \nUsage from 2017-09-07 to 2017-09-08:\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 2       | 3602.99      | 7.04      | 7.04          |\n+---------+--------------+-----------+---------------+\n\nNote: You can see the more details of resource usage below for individual instances under tenant:\nSee the second indtsnce usages there it's showing local_gb as 1 that means flavor.root_gb is used\neven if the instance is booted from volume.\n\n$ curl -g -i -X GET \"http://10.232.48.200/compute/v2.1/os-simple-tenant-usage/f77f8f0f6f1b46fe8a43b27a5372f427?start=2017-09-07T00:00:00&end=2017-09-08T06:58:01.961267\" -H \"OpenStack-API-Version: compute 2.53\" -H \"User-Agent: python-novaclient\" -H \"Accept: application/json\" -H \"X-OpenStack-Nova-API-Version: 2.53\" -H \"X-Auth-Token: 51a6cb7d32b14bb7b22827f517e3d544\"\n\nHTTP/1.1 200 OK\nDate: Thu, 07 Sep 2017 07:00:29 GMT\nServer: Apache/2.4.18 (Ubuntu)\nContent-Length: 993\nContent-Type: application/json\nOpenStack-API-Version: compute 2.53\nX-OpenStack-Nova-API-Version: 2.53\nVary: OpenStack-API-Version,X-OpenStack-Nova-API-Version\nx-openstack-request-id: req-b5f88549-1908-47ad-ba02-f3b174e6ca22\nx-compute-request-id: req-b5f88549-1908-47ad-ba02-f3b174e6ca22\nConnection: close\n\n{\n\"tenant_usage\": {\"total_memory_mb_usage\": 3591.7622866488887, \"total_vcpus_usage\": 7.015160716111111, \"start\": \"2017-09-07T00:00:00.000000\", \"tenant_id\": \"f77f8f0f6f1b46fe8a43b27a5372f427\", \"stop\": \"2017-09-07T07:00:29.578578\", \"server_usages\": [\n\n{\"instance_id\": \"0280c4ff-6401-477d-93d6-c22077c9f8f1\", \"uptime\": 64741, \"started_at\": \"2017-09-06T12:56:09.000000\", \"ended_at\": \"2017-09-07T06:55:10.000000\", \"memory_mb\": 512, \"tenant_id\": \"f77f8f0f6f1b46fe8a43b27a5372f427\", \"state\": \"terminated\", \"hours\": 6.919444444444444, \"vcpus\": 1, \"flavor\": \"m1.tiny\", \"local_gb\": 1, \"name\": \"test\"},\n\n{\"instance_id\": \"c46243b7-9034-4847-a9c5-480f5e60f59f\", \"uptime\": 344, \"started_at\": \"2017-09-07T06:54:45.000000\", \"ended_at\": null, \"memory_mb\": 512, \"tenant_id\": \"f77f8f0f6f1b46fe8a43b27a5372f427\", \"state\": \"active\", \"hours\": 0.09571627166666666, \"vcpus\": 1, \"flavor\": \"m1.tiny\", \"local_gb\": 1, \"name\": \"boot-from-volume\"}], \"total_hours\": 7.015160716111111, \"total_local_gb_usage\": 7.015160716111111}\n}", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1715570", 
    "owner": "https://api.launchpad.net/1.0/~bhagyashri-shewale", 
    "id": 1715570, 
    "index": 8290, 
    "openned": "2017-09-07 07:27:23.531414+00:00", 
    "created": "2017-09-07 07:27:23.531414+00:00", 
    "title": "simple tenant usage api calculating disk usages incorrectly", 
    "comments": [
        {
            "content": "As of now on current master the simple tenant usage api is calculating disk usages information incorrectly in case in instance is booted from volume.\n\nIf user boots the instance from volume then the disk usages should not be considered but it's taking the flavor.root_gb as local_gb used.\n\nSteps to reproduce:\n\n1. Create bootable volume\n\n$ cinder create 1 --name bootable_volume --image 33a7f2aa-5e48-4545-a484-b598abdee1e3\n\n+--------------------------------------+-----------+-----------------+------+-------------+----------+-------------+\n| ID                                   | Status    | Name            | Size | Volume Type | Bootable | Attached to |\n+--------------------------------------+-----------+-----------------+------+-------------+----------+-------------+\n| 0399f203-5f36-4b9a-b76f-bada8b9afdc6 | available | bootable_volume | 1    | lvmdriver-1 | true     |             |\n+--------------------------------------+-----------+-----------------+------+-------------+----------+-------------+\n\n2. Flavor details:\n\n$ nova flavor-show 1\n+----------------------------+---------+\n| Property                   | Value   |\n+----------------------------+---------+\n| OS-FLV-DISABLED:disabled   | False   |\n| OS-FLV-EXT-DATA:ephemeral  | 0       |\n| disk                       | 1       |\n| extra_specs                | {}      |\n| id                         | 1       |\n| name                       | m1.tiny |\n| os-flavor-access:is_public | True    |\n| ram                        | 512     |\n| rxtx_factor                | 1.0     |\n| swap                       |         |\n| vcpus                      | 1       |\n+----------------------------+---------+\n\n3. Create instance from volume:\n\n$ nova boot --flavor 1 --boot-volume 0399f203-5f36-4b9a-b76f-bada8b9afdc6 boot-from-volume\n\n+--------------------------------------+------------------+--------+------------+-------------+---------------------------------+\n| ID                                   | Name             | Status | Task State | Power State | Networks                        |\n+--------------------------------------+------------------+--------+------------+-------------+---------------------------------+\n| c46243b7-9034-4847-a9c5-480f5e60f59f | boot-from-volume | ACTIVE | -          | Running     | public=172.24.4.11, 2001:db8::8 |\n+--------------------------------------+------------------+--------+------------+-------------+---------------------------------+\n\n4. Check the simple tenant usage:\n\n$ nova usage --tenant f77f8f0f6f1b46fe8a43b27a5372f427 --start 2017-09-07\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   \nUsage from 2017-09-07 to 2017-09-08:\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 2       | 3602.99      | 7.04      | 7.04          |\n+---------+--------------+-----------+---------------+\n\nNote: You can see the more details of resource usage below for individual instances under tenant:\nSee the second indtsnce usages there it's showing local_gb as 1 that means flavor.root_gb is used\neven if the instance is booted from volume.\n\n$ curl -g -i -X GET \"http://10.232.48.200/compute/v2.1/os-simple-tenant-usage/f77f8f0f6f1b46fe8a43b27a5372f427?start=2017-09-07T00:00:00&end=2017-09-08T06:58:01.961267\" -H \"OpenStack-API-Version: compute 2.53\" -H \"User-Agent: python-novaclient\" -H \"Accept: application/json\" -H \"X-OpenStack-Nova-API-Version: 2.53\" -H \"X-Auth-Token: 51a6cb7d32b14bb7b22827f517e3d544\"\n\nHTTP/1.1 200 OK\nDate: Thu, 07 Sep 2017 07:00:29 GMT\nServer: Apache/2.4.18 (Ubuntu)\nContent-Length: 993\nContent-Type: application/json\nOpenStack-API-Version: compute 2.53\nX-OpenStack-Nova-API-Version: 2.53\nVary: OpenStack-API-Version,X-OpenStack-Nova-API-Version\nx-openstack-request-id: req-b5f88549-1908-47ad-ba02-f3b174e6ca22\nx-compute-request-id: req-b5f88549-1908-47ad-ba02-f3b174e6ca22\nConnection: close\n\n{\n\"tenant_usage\": {\"total_memory_mb_usage\": 3591.7622866488887, \"total_vcpus_usage\": 7.015160716111111, \"start\": \"2017-09-07T00:00:00.000000\", \"tenant_id\": \"f77f8f0f6f1b46fe8a43b27a5372f427\", \"stop\": \"2017-09-07T07:00:29.578578\", \"server_usages\": [\n\n{\"instance_id\": \"0280c4ff-6401-477d-93d6-c22077c9f8f1\", \"uptime\": 64741, \"started_at\": \"2017-09-06T12:56:09.000000\", \"ended_at\": \"2017-09-07T06:55:10.000000\", \"memory_mb\": 512, \"tenant_id\": \"f77f8f0f6f1b46fe8a43b27a5372f427\", \"state\": \"terminated\", \"hours\": 6.919444444444444, \"vcpus\": 1, \"flavor\": \"m1.tiny\", \"local_gb\": 1, \"name\": \"test\"},\n\n{\"instance_id\": \"c46243b7-9034-4847-a9c5-480f5e60f59f\", \"uptime\": 344, \"started_at\": \"2017-09-07T06:54:45.000000\", \"ended_at\": null, \"memory_mb\": 512, \"tenant_id\": \"f77f8f0f6f1b46fe8a43b27a5372f427\", \"state\": \"active\", \"hours\": 0.09571627166666666, \"vcpus\": 1, \"flavor\": \"m1.tiny\", \"local_gb\": 1, \"name\": \"boot-from-volume\"}], \"total_hours\": 7.015160716111111, \"total_local_gb_usage\": 7.015160716111111}\n}", 
            "date_created": "2017-09-07 07:27:23.531414+00:00", 
            "author": "https://api.launchpad.net/1.0/~bhagyashri-shewale"
        }, 
        {
            "content": "Set the status 'In-progress' because this report has an assignee.", 
            "date_created": "2017-09-08 01:11:19.067173+00:00", 
            "author": "https://api.launchpad.net/1.0/~natsume-takashi"
        }, 
        {
            "content": "Hi all,\n\nTo fix this issues they are three solutions which are mentioned below:\n\nSolution 1:\n\nCheck the instance is booted from volume or not by calling the dp api and if it's booted from volume then set the flavor.root_gb as 0.\n\nDrawback:\n\nThis causes the perfomance issue while getting usages.\n\nChecked the time required to get 1000 instance usages using simple tenant usage api on solution 1 and on current master but seems that it's taking double time to get usages on Solution 1.\n\nYou can see the time difference below:\n\nTime taken to take instance usage on master:\n\n1. $ time nova usage --tenant b844ea0d94cb41d289f70e02bf555d15\n\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 662.61       | 1.29      | 1.29          |\n+---------+--------------+-----------+---------------+\n\nreal 0m3.325s\nuser 0m1.660s\nsys 0m0.128s\n\n2. $ time nova usage --tenant b844ea0d94cb41d289f70e02bf555d15\n\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 662.61       | 1.29      | 1.29          |\n+---------+--------------+-----------+---------------+\n\nreal 0m3.298s\nuser 0m1.676s\nsys 0m0.120s\n\n3. $ time nova usage --tenant b844ea0d94cb41d289f70e02bf555d15\n\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 662.61       | 1.29      | 1.29          |\n+---------+--------------+-----------+---------------+\n\nreal 0m3.372s\nuser 0m1.672s\nsys 0m0.108s\n\nAverage time: 3 sec\n\nTime taken to take instances usage on Solution 1:\n\n1. $ time nova usage --tenant b844ea0d94cb41d289f70e02bf555d15\n\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 662.61       | 1.29      | 0.00          |\n+---------+--------------+-----------+---------------+\nreal 0m7.762s\nuser 0m1.680s\nsys 0m0.128s\n\n2. $ time nova usage --tenant b844ea0d94cb41d289f70e02bf555d15\n\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 662.61       | 1.29      | 0.00          |\n+---------+--------------+-----------+---------------+\n\nreal 0m6.922s\nuser 0m1.644s\nsys 0m0.160s\n\n3. $ time nova usage --tenant b844ea0d94cb41d289f70e02bf555d15\n\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 662.61       | 1.29      | 0.00          |\n+---------+--------------+-----------+---------------+\n\nreal 0m6.839s\nuser 0m1.672s\nsys 0m0.092s\n\nAverage time: 7 sec\n\n\nSolution 2:\n\nTried to get the usages information from the placement api: There are two placement api we can get the usages info which are mentioned below:\n\n1. get allocations for instance using the placement api GET /allocations/{instance_uuid}\n2. get total usages for specific tenant/project_id using GET /usages?project_id=\n\nDrawback:\n\nOnce the instance get deleted the allocations records from placement db get deleted, so usages will be shown as 0 because of this user will not get deleted instance usages So it\u2019s not possible to use placement api's to fix this issue. \n\n\nSo from above two solutions drawback I have thought about solution 3which is mentioned below:\n\nSolution 3:\n\nChecked if instance.image_ref then consider info[disk_gb] as(instance.flavor.root_gb + instance.flavor.ephemeral_gb) aelse consider 0 that means if instance is booted from image then local_gb will be taken as instance.flavor.root_gb else take it as 0.\n\n\nThis solution is not causing any perfomance issue.\n\nTime taken on current master:\n\n$ time nova usage --tenant afe3257305514254a4ae6c451bb23804\n\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 632.89       | 1.24      | 1.24          |\n+---------+--------------+-----------+---------------+\n\nreal    0m3.937s\nuser    0m1.732s\nsys     0m0.096s\n\n$ time nova usage --tenant afe3257305514254a4ae6c451bb23804\n\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 632.89       | 1.24      | 1.24          |\n+---------+--------------+-----------+---------------+\n\nreal    0m3.369s\nuser    0m1.660s\nsys     0m0.112s\n\n$ time nova usage --tenant afe3257305514254a4ae6c451bb23804\n\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 632.89       | 1.24      | 1.24          |\n+---------+--------------+-----------+---------------+\n\nreal    0m3.272s\nuser    0m1.668s\nsys     0m0.136s\n\nAverage time: 3 sec\n\nTime taken on solution 3:\n\n\n\n$ time nova usage --tenant afe3257305514254a4ae6c451bb23804\nUsage from 2017-08-15 to 2017-09-13:\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 632.89       | 1.24      | 0.00          |\n+---------+--------------+-----------+---------------+\n\nreal    0m3.324s\nuser    0m1.680s\nsys     0m0.092s\n\n$ time nova usage --tenant afe3257305514254a4ae6c451bb23804\nUsage from 2017-08-15 to 2017-09-13:\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 632.89       | 1.24      | 0.00          |\n+---------+--------------+-----------+---------------+\n\nreal    0m3.276s\nuser    0m1.612s\nsys     0m0.164s\n\n$ time nova usage --tenant afe3257305514254a4ae6c451bb23804\nUsage from 2017-08-15 to 2017-09-13:\n+---------+--------------+-----------+---------------+\n| Servers | RAM MB-Hours | CPU Hours | Disk GB-Hours |\n+---------+--------------+-----------+---------------+\n| 1000    | 632.89       | 1.24      | 0.00          |\n+---------+--------------+-----------+---------------+\n\nreal    0m3.394s\nuser    0m1.688s\nsys     0m0.120s\n\nAverage time: 3 sec\n\n\nSo from above results it seems that same time is required to get instances usages on both current master and solution 3.\n\nNeeds others opinion about this.", 
            "date_created": "2017-09-12 13:12:39.943585+00:00", 
            "author": "https://api.launchpad.net/1.0/~bhagyashri-shewale"
        }
    ]
}