{
    "status": "Fix Released", 
    "last_updated": "2012-03-11 16:12:53.297636+00:00", 
    "description": "Version: Austin\nDeployment: multi-machine, 1 controller (api/network/scheduler/objectstore/db), 3 compute/volume nodes\nDetail:  Tests using the ec2 api run fine all day, but then first thing the next morning we always get a 500 on the first test.  The error logging is captured below.  A quick search on the SQLAlchemy site shows documentation identifying one likely cause for the issue.  See http://www.sqlalchemy.org/trac/wiki/FAQ#MySQLserverhasgoneawaypsycopg.InterfaceError:connectionalreadyclosed for more info.\n\n\nOutput of nova-api.log\n\nnova-api(routes.middleware): DEBUG Matched GET /services/Cloud/\nnova-api(routes.middleware): DEBUG Route path: 'services/{path_info:.*}', defaults: {'action': u'index', 'controller': <nova.api.ec2.API object at 0x26e2310>}\nnova-api(routes.middleware): DEBUG Match dict: {'action': u'index', 'controller': <nova.api.ec2.API object at 0x26e2310>, 'sub_domain': None, 'path_info': 'Cloud/'}\nnova-api(root): INFO Looking up user: 'e6e82914-4a00-4e9f-a403-8b1bb01447ad'\n\n\n\nStack trace (returned in the ec2 api response):\n\nGET http://box3:8773/services/Cloud/?AWSAccessKeyId=e6e82914-4a00-4e9f-a403-8b1bb01447ad%3Adefault-project&Action=DescribeImages&SignatureMethod=HmacSHA256&SignatureVersion=2&Timestamp=2010-12-014T16%3A27%3A59Z&Version=2010-06-15&Signature=zwRn4O0susOcnxHptRRYbV3tDps9tUngJWRHtSCv7Y4%3D returned a response status of 500) Msg (Traceback (most recent call last):\n  File \"/usr/lib/pymodules/python2.6/eventlet/wsgi.py\", line 336, in handle_one_response\n    result = self.application(self.environ, start_response)\n  File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 159, in __call__\n    return resp(environ, start_response)\n  File \"/usr/lib/pymodules/python2.6/routes/middleware.py\", line 130, in __call__\n    response = self.app(environ, start_response)\n  File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 159, in __call__\n    return resp(environ, start_response)\n  File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 159, in __call__\n    return resp(environ, start_response)\n  File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 147, in __call__\n    resp = self.call_func(req, *args, **self.kwargs)\n  File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 208, in call_func\n    return self.func(req, *args, **kwargs)\n  File \"/usr/lib/pymodules/python2.6/nova/api/ec2/__init__.py\", line 74, in __call__\n    req.path)\n  File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 262, in authenticate\n    user = self.get_user_from_access_key(access_key)\n  File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 569, in get_user_from_access_key\n    user_dict = drv.get_user_from_access_key(access_key)\n  File \"/usr/lib/pymodules/python2.6/nova/auth/dbdriver.py\", line 54, in get_user_from_access_key\n    return self._db_user_to_auth_user(db.user_get_by_access_key(context.get_admin_context(), access))\n  File \"/usr/lib/pymodules/python2.6/nova/db/api.py\", line 669, in user_get_by_access_key\n    return IMPL.user_get_by_access_key(context, access_key)\n  File \"/usr/lib/pymodules/python2.6/nova/db/sqlalchemy/api.py\", line 98, in wrapper\n    return f(*args, **kwargs)\n  File \"/usr/lib/pymodules/python2.6/nova/db/sqlalchemy/api.py\", line 1491, in user_get_by_access_key\n    ).filter_by(deleted=can_read_deleted(context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/orm/query.py\", line 1496, in first\n    ret = list(self[0:1])\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/orm/query.py\", line 1405, in __getitem__\n    return list(res)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/orm/query.py\", line 1565, in __iter__\n    return self._execute_and_instances(context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/orm/query.py\", line 1570, in _execute_and_instances\n    mapper=self._mapper_zero_or_none())\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/orm/session.py\", line 735, in execute\n    clause, params or {})\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/base.py\", line 1157, in execute\n    params)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n    return self.__execute_context(context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n    context.parameters[0], context=context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n    context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n    context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/default.py\", line 288, in do_execute\n    cursor.execute(statement, parameters)\n  File \"/usr/lib/pymodules/python2.6/MySQLdb/cursors.py\", line 166, in execute\n    self.errorhandler(self, exc, value)\n  File \"/usr/lib/pymodules/python2.6/MySQLdb/connections.py\", line 35, in defaulterrorhandler\n    raise errorclass, errorvalue\nOperationalError: (OperationalError) (2006, 'MySQL server has gone away') 'SELECT users.created_at AS users_created_at, users.updated_at AS users_updated_at, users.deleted_at AS users_deleted_at, users.deleted AS users_deleted, users.id AS users_id, users.name AS users_name, users.access_key AS users_access_key, users.secret_key AS users_secret_key, users.is_admin AS users_is_admin \\nFROM users \\nWHERE users.access_key = %s AND users.deleted = %s \\n LIMIT 0, 1' ('e6e82914-4a00-4e9f-a403-8b1bb01447ad', False)\n) returned from server}", 
    "tags": [
        "austin", 
        "nova-api", 
        "sql"
    ], 
    "importance": "Low", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/690314", 
    "owner": "https://api.launchpad.net/1.0/~rlucio", 
    "id": 690314, 
    "index": 55, 
    "openned": "2010-12-14 19:29:10.800257+00:00", 
    "created": "2010-12-14 19:29:10.800257+00:00", 
    "title": "Nova sqlalchemy mysql db connection timeout causes a 500 error", 
    "comments": [
        {
            "content": "Version: Austin\nDeployment: multi-machine, 1 controller (api/network/scheduler/objectstore/db), 3 compute/volume nodes\nDetail:  Tests using the ec2 api run fine all day, but then first thing the next morning we always get a 500 on the first test.  The error logging is captured below.  A quick search on the SQLAlchemy site shows documentation identifying one likely cause for the issue.  See http://www.sqlalchemy.org/trac/wiki/FAQ#MySQLserverhasgoneawaypsycopg.InterfaceError:connectionalreadyclosed for more info.\n\n\nOutput of nova-api.log\n\nnova-api(routes.middleware): DEBUG Matched GET /services/Cloud/\nnova-api(routes.middleware): DEBUG Route path: 'services/{path_info:.*}', defaults: {'action': u'index', 'controller': <nova.api.ec2.API object at 0x26e2310>}\nnova-api(routes.middleware): DEBUG Match dict: {'action': u'index', 'controller': <nova.api.ec2.API object at 0x26e2310>, 'sub_domain': None, 'path_info': 'Cloud/'}\nnova-api(root): INFO Looking up user: 'e6e82914-4a00-4e9f-a403-8b1bb01447ad'\n\n\n\nStack trace (returned in the ec2 api response):\n\nGET http://box3:8773/services/Cloud/?AWSAccessKeyId=e6e82914-4a00-4e9f-a403-8b1bb01447ad%3Adefault-project&Action=DescribeImages&SignatureMethod=HmacSHA256&SignatureVersion=2&Timestamp=2010-12-014T16%3A27%3A59Z&Version=2010-06-15&Signature=zwRn4O0susOcnxHptRRYbV3tDps9tUngJWRHtSCv7Y4%3D returned a response status of 500) Msg (Traceback (most recent call last):\n  File \"/usr/lib/pymodules/python2.6/eventlet/wsgi.py\", line 336, in handle_one_response\n    result = self.application(self.environ, start_response)\n  File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 159, in __call__\n    return resp(environ, start_response)\n  File \"/usr/lib/pymodules/python2.6/routes/middleware.py\", line 130, in __call__\n    response = self.app(environ, start_response)\n  File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 159, in __call__\n    return resp(environ, start_response)\n  File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 159, in __call__\n    return resp(environ, start_response)\n  File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 147, in __call__\n    resp = self.call_func(req, *args, **self.kwargs)\n  File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 208, in call_func\n    return self.func(req, *args, **kwargs)\n  File \"/usr/lib/pymodules/python2.6/nova/api/ec2/__init__.py\", line 74, in __call__\n    req.path)\n  File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 262, in authenticate\n    user = self.get_user_from_access_key(access_key)\n  File \"/usr/lib/pymodules/python2.6/nova/auth/manager.py\", line 569, in get_user_from_access_key\n    user_dict = drv.get_user_from_access_key(access_key)\n  File \"/usr/lib/pymodules/python2.6/nova/auth/dbdriver.py\", line 54, in get_user_from_access_key\n    return self._db_user_to_auth_user(db.user_get_by_access_key(context.get_admin_context(), access))\n  File \"/usr/lib/pymodules/python2.6/nova/db/api.py\", line 669, in user_get_by_access_key\n    return IMPL.user_get_by_access_key(context, access_key)\n  File \"/usr/lib/pymodules/python2.6/nova/db/sqlalchemy/api.py\", line 98, in wrapper\n    return f(*args, **kwargs)\n  File \"/usr/lib/pymodules/python2.6/nova/db/sqlalchemy/api.py\", line 1491, in user_get_by_access_key\n    ).filter_by(deleted=can_read_deleted(context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/orm/query.py\", line 1496, in first\n    ret = list(self[0:1])\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/orm/query.py\", line 1405, in __getitem__\n    return list(res)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/orm/query.py\", line 1565, in __iter__\n    return self._execute_and_instances(context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/orm/query.py\", line 1570, in _execute_and_instances\n    mapper=self._mapper_zero_or_none())\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/orm/session.py\", line 735, in execute\n    clause, params or {})\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/base.py\", line 1157, in execute\n    params)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n    return self.__execute_context(context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n    context.parameters[0], context=context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n    context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n    context)\n  File \"/usr/lib/pymodules/python2.6/sqlalchemy/engine/default.py\", line 288, in do_execute\n    cursor.execute(statement, parameters)\n  File \"/usr/lib/pymodules/python2.6/MySQLdb/cursors.py\", line 166, in execute\n    self.errorhandler(self, exc, value)\n  File \"/usr/lib/pymodules/python2.6/MySQLdb/connections.py\", line 35, in defaulterrorhandler\n    raise errorclass, errorvalue\nOperationalError: (OperationalError) (2006, 'MySQL server has gone away') 'SELECT users.created_at AS users_created_at, users.updated_at AS users_updated_at, users.deleted_at AS users_deleted_at, users.deleted AS users_deleted, users.id AS users_id, users.name AS users_name, users.access_key AS users_access_key, users.secret_key AS users_secret_key, users.is_admin AS users_is_admin \\nFROM users \\nWHERE users.access_key = %s AND users.deleted = %s \\n LIMIT 0, 1' ('e6e82914-4a00-4e9f-a403-8b1bb01447ad', False)\n) returned from server}", 
            "date_created": "2010-12-14 19:29:10.800257+00:00", 
            "author": "https://api.launchpad.net/1.0/~rlucio"
        }, 
        {
            "content": "I guess Bexar is also affected by this, given that we don't pass pool_recycle= to create_engine.\r\n\r\n@Ryan: I see you assigned yourself, are you working on this ? If yes, please set bug to \"In progress\". If not, please unassign yourself to give someone else a chance to fix it.", 
            "date_created": "2010-12-23 16:27:28.739203+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Ran into this running trunk from yesterday.  After testing the previous day, I attempted to spin up an instance and received a similar error.  Attempting one more time afterwards created the instance without the error.\n\nnova-api.log\n\n2011-02-05 09:14:30,653 ERROR nova.api.openstack [-] Caught error: (OperationalError) (2006, 'MySQL server has gone away') 'SELECT users.created_at AS users_created_at, users.updated_at AS users_updated_a\nt, users.deleted_at AS users_deleted_at, users.deleted AS users_deleted, users.id AS users_id, users.name AS users_name, users.access_key AS users_access_key, users.secret_key AS users_secret_key, users.i\ns_admin AS users_is_admin \\nFROM users \\nWHERE users.access_key = %s AND users.deleted = %s \\n LIMIT 0, 1' ('6a0a9f51-2674-40bf-a60e-6b1b2580f47b', False)\n(nova.api.openstack): TRACE: Traceback (most recent call last):\n(nova.api.openstack): TRACE:   File \"/root/openstack/nova/nova/api/openstack/__init__.py\", line 52, in __call__\n(nova.api.openstack): TRACE:     return req.get_response(self.application)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/request.py\", line 919, in get_response\n(nova.api.openstack): TRACE:     application, catch_exc_info=False)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/request.py\", line 887, in call_application\n(nova.api.openstack): TRACE:     app_iter = application(self.environ, start_response)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 147, in __call__\n(nova.api.openstack): TRACE:     resp = self.call_func(req, *args, **self.kwargs)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/webob/dec.py\", line 208, in call_func\n(nova.api.openstack): TRACE:     return self.func(req, *args, **kwargs)\n(nova.api.openstack): TRACE:   File \"/root/openstack/nova/nova/api/openstack/auth.py\", line 51, in __call__\n(nova.api.openstack): TRACE:     return self.authenticate(req)\n(nova.api.openstack): TRACE:   File \"/root/openstack/nova/nova/api/openstack/auth.py\", line 81, in authenticate\n(nova.api.openstack): TRACE:     token, user = self._authorize_user(username, key, req)\n(nova.api.openstack): TRACE:   File \"/root/openstack/nova/nova/api/openstack/auth.py\", line 123, in _authorize_user\n(nova.api.openstack): TRACE:     user = self.auth.get_user_from_access_key(key)\n(nova.api.openstack): TRACE:   File \"/root/openstack/nova/nova/auth/manager.py\", line 606, in get_user_from_access_key\n(nova.api.openstack): TRACE:     user_dict = drv.get_user_from_access_key(access_key)\n(nova.api.openstack): TRACE:   File \"/root/openstack/nova/nova/auth/dbdriver.py\", line 53, in get_user_from_access_key\n(nova.api.openstack): TRACE:     user = db.user_get_by_access_key(context.get_admin_context(), access)\n(nova.api.openstack): TRACE:   File \"/root/openstack/nova/nova/db/api.py\", line 827, in user_get_by_access_key\n(nova.api.openstack): TRACE:     return IMPL.user_get_by_access_key(context, access_key)\n(nova.api.openstack): TRACE:   File \"/root/openstack/nova/nova/db/sqlalchemy/api.py\", line 97, in wrapper\n(nova.api.openstack): TRACE:     return f(*args, **kwargs)\n(nova.api.openstack): TRACE:   File \"/root/openstack/nova/nova/db/sqlalchemy/api.py\", line 1718, in user_get_by_access_key\n(nova.api.openstack): TRACE:     filter_by(deleted=can_read_deleted(context)).\\\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1496, in first\n(nova.api.openstack): TRACE:     ret = list(self[0:1])\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1405, in __getitem__\n(nova.api.openstack): TRACE:     return list(res)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1565, in __iter__\n(nova.api.openstack): TRACE:     return self._execute_and_instances(context)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/query.py\", line 1570, in _execute_and_instances\n(nova.api.openstack): TRACE:     mapper=self._mapper_zero_or_none())\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/orm/session.py\", line 735, in execute\n(nova.api.openstack): TRACE:     clause, params or {})\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1157, in execute\n(nova.api.openstack): TRACE:     params)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1237, in _execute_clauseelement\n(nova.api.openstack): TRACE:     return self.__execute_context(context)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1268, in __execute_context\n(nova.api.openstack): TRACE:     context.parameters[0], context=context)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1367, in _cursor_execute\n(nova.api.openstack): TRACE:     context)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/base.py\", line 1360, in _cursor_execute\n(nova.api.openstack): TRACE:     context)\n(nova.api.openstack): TRACE:   File \"/usr/lib/python2.6/dist-packages/sqlalchemy/engine/default.py\", line 288, in do_execute\n(nova.api.openstack): TRACE:     cursor.execute(statement, parameters)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/MySQLdb/cursors.py\", line 166, in execute\n(nova.api.openstack): TRACE:     self.errorhandler(self, exc, value)\n(nova.api.openstack): TRACE:   File \"/usr/lib/pymodules/python2.6/MySQLdb/connections.py\", line 35, in defaulterrorhandler\n(nova.api.openstack): TRACE:     raise errorclass, errorvalue\n(nova.api.openstack): TRACE: OperationalError: (OperationalError) (2006, 'MySQL server has gone away') 'SELECT users.created_at AS users_created_at, users.updated_at AS users_updated_at, users.deleted_at AS users_deleted_at, users.deleted AS users_deleted, users.id AS users_id, users.name AS users_name, users.access_key AS users_access_key, users.secret_key AS users_secret_key, users.is_admin AS users_is_admin \\nFROM users \\nWHERE users.access_key = %s AND users.deleted = %s \\n LIMIT 0, 1' ('6a0a9f51-2674-40bf-a60e-6b1b2580f47b', False)\n\ncloudservers output:\n\n~/openstack/nova# cloudservers boot --flavor=1 --image=3 blah\nTraceback (most recent call last):\n  File \"/usr/local/bin/cloudservers\", line 9, in <module>\n    load_entry_point('python-cloudservers==1.2', 'console_scripts', 'cloudservers')()\n  File \"/usr/local/lib/python2.6/dist-packages/python_cloudservers-1.2-py2.6.egg/cloudservers/shell.py\", line 551, in main\n    CloudserversShell().main(sys.argv[1:])\n  File \"/usr/local/lib/python2.6/dist-packages/python_cloudservers-1.2-py2.6.egg/cloudservers/shell.py\", line 140, in main\n    self.cs.authenticate()\n  File \"/usr/local/lib/python2.6/dist-packages/python_cloudservers-1.2-py2.6.egg/cloudservers/__init__.py\", line 62, in authenticate\n    self.client.authenticate()\n  File \"/usr/local/lib/python2.6/dist-packages/python_cloudservers-1.2-py2.6.egg/cloudservers/client.py\", line 96, in authenticate\n    resp, body = self.request(self.auth_url, 'GET', headers=headers)\n  File \"/usr/local/lib/python2.6/dist-packages/python_cloudservers-1.2-py2.6.egg/cloudservers/client.py\", line 56, in request\n    raise exceptions.from_response(resp, body)\ncloudservers.exceptions.CloudServersException: (OperationalError) (2006, 'MySQL server has gone away') 'SELECT users.created_at AS users_created_at, users.updated_at AS users_updated_at, users.deleted_at AS users_deleted_at, users.deleted AS users_deleted, users.id AS users_id, users.name AS users_name, users.access_key AS users_access_key, users.secret_key AS users_secret_key, users.is_admin AS users_is_admin \\nFROM users \\nWHERE users.access_key = %s AND users.deleted = %s \\n LIMIT 0, 1' ('6a0a9f51-2674-40bf-a60e-6b1b2580f47b', False) (HTTP 500)", 
            "date_created": "2011-02-05 16:24:52.991915+00:00", 
            "author": "https://api.launchpad.net/1.0/~antonym"
        }
    ], 
    "closed": "2011-02-07 14:01:06.058197+00:00"
}