{
    "status": "Fix Released", 
    "last_updated": "2016-09-02 01:16:46.149593+00:00", 
    "description": "When running with the Ubuntu Xenial Mitaka packages, I'm seeing the following behaviour:\n\nFollowing the release notes at http://docs.openstack.org/releasenotes/nova/mitaka.html I remove the old option \"memcached_servers\" and set up a cache section with\n\n[cache]\nenabled = true\nmemcache_servers = host1:11211,host2:11211,host3:11211\n\nThe result is that there are errors logged when creating a token:\n\n2016-04-19 10:17:33.501 15952 WARNING nova.consoleauth.manager [req-ad043de9-616d-4cbb-a93f-fc5e345f1f53 1b0106d4f339406bb7012a83162ba5f2 e3c253d3e8344a8796e70bc4f96b6166 - - -] Token: dd0e7bbc-c593-421f-a56b-52578aaec20e failed to save into memcached.\n2016-04-19 10:17:33.503 15952 WARNING nova.consoleauth.manager [req-ad043de9-616d-4cbb-a93f-fc5e345f1f53 1b0106d4f339406bb7012a83162ba5f2 e3c253d3e8344a8796e70bc4f96b6166 - - -] Instance: d3267abb-258d-4b5d-a22e-8e3b0a39905c failed to save into memcached\n\nOnly after a lot of debugging it turns out that the default backend for oslo_cache is dogpile.cache.null, implying that no values get cached and token validation always fails. Only after adding\n\n[cache]\nbackend = oslo_cache.memcache_pool\n\ndoes console authentication start working. Strangely though, the above warning messages are still being logged in the working setup, which made debugging this even more difficult.\n\nSo I suggest the following fixes:\n\n1. Change the text of the warnings from \"failed to save into memcached\" to \"failed to save into cache\", as with the change to using oslo_cache, there may be other backends in use instead of memcached.\n2. Either override the default of using the null backend or refuse to run with it or at the very least give a big fat warning that the configuration can not work.\n3. Stop generating the warning messages when the data got in fact saved into cache properly.\n\nPackage versions for reference:\n# dpkg -l | grep nova\nii  nova-api-metadata                    2:13.0.0-0ubuntu2               all          OpenStack Compute - metadata API frontend\nii  nova-api-os-compute                  2:13.0.0-0ubuntu2               all          OpenStack Compute - OpenStack Compute API frontend\nii  nova-cert                            2:13.0.0-0ubuntu2               all          OpenStack Compute - certificate management\nii  nova-common                          2:13.0.0-0ubuntu2               all          OpenStack Compute - common files\nii  nova-conductor                       2:13.0.0-0ubuntu2               all          OpenStack Compute - conductor service\nii  nova-consoleauth                     2:13.0.0-0ubuntu2               all          OpenStack Compute - Console Authenticator\nii  nova-scheduler                       2:13.0.0-0ubuntu2               all          OpenStack Compute - virtual machine scheduler\nii  nova-spiceproxy                      2:13.0.0-0ubuntu2               all          OpenStack Compute - spice html5 proxy\nii  python-nova                          2:13.0.0-0ubuntu2               all          OpenStack Compute Python libraries\nii  python-novaclient                    2:3.3.1-2                       all          client library for OpenStack Compute API - Python 2.7\n# dpkg -l | grep oslo\nii  python-oslo.cache                    1.6.0-2                         all          cache storage for Openstack projects - Python 2.7\nii  python-oslo.concurrency              3.7.0-2                         all          concurrency and locks for OpenStack projects - Python 2.x\nii  python-oslo.config                   1:3.9.0-3                       all          Common code for Openstack Projects (configuration API) - Python 2.x\nii  python-oslo.context                  2.2.0-2                         all          WSGI context helpers for OpenStack - Python 2.x\nii  python-oslo.db                       4.7.0-2ubuntu1                  all          database connectivity to the different backends and helper utils - Python 2.x\nii  python-oslo.i18n                     3.5.0-2                         all          Oslo Internationalization Utilities - Python 2.x\nii  python-oslo.log                      3.2.0-2                         all          OpenStack logging configuration library - Python 2.x\nii  python-oslo.messaging                4.6.1-2ubuntu1                  all          oslo messaging library - Python 2.x\nii  python-oslo.middleware               3.8.0-2                         all          various WSGI middleware components for OpenStack - Python 2.x\nii  python-oslo.policy                   1.6.0-2                         all          RBAC policy enforcement library for OpenStack - Python 2.x\nii  python-oslo.reports                  1.7.0-2                         all          reports serialized in various data types - Python 2.7\nii  python-oslo.rootwrap                 4.1.0-2                         all          allows fine filtering of shell commands to run as root - Python 2.x\nii  python-oslo.serialization            2.4.0-2                         all          utilities for serialization , especially JSON - Python 2.x\nii  python-oslo.service                  1.8.0-1ubuntu1                  all          library for running OpenStack services - Python 2.x\nii  python-oslo.utils                    3.8.0-2                         all          set of utility functions for OpenStack - Python 2.x\nii  python-oslo.versionedobjects         1.8.0-1                         all          deals with DB schema versions and code expectations - Python 2.x\nii  python-oslo.vmware                   2.5.0-2                         all          VMware library for OpenStack projects - Python 2.7", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1572062", 
    "owner": "https://api.launchpad.net/1.0/~j-harbott", 
    "id": 1572062, 
    "index": 7431, 
    "openned": "2016-04-19 10:33:25.093921+00:00", 
    "created": "2016-04-19 10:33:25.093921+00:00", 
    "title": "nova-consoleauth doesn't play well with memcached", 
    "comments": [
        {
            "content": "When running with the Ubuntu Xenial Mitaka packages, I'm seeing the following behaviour:\n\nFollowing the release notes at http://docs.openstack.org/releasenotes/nova/mitaka.html I remove the old option \"memcached_servers\" and set up a cache section with\n\n[cache]\nenabled = true\nmemcache_servers = host1:11211,host2:11211,host3:11211\n\nThe result is that there are errors logged when creating a token:\n\n2016-04-19 10:17:33.501 15952 WARNING nova.consoleauth.manager [req-ad043de9-616d-4cbb-a93f-fc5e345f1f53 1b0106d4f339406bb7012a83162ba5f2 e3c253d3e8344a8796e70bc4f96b6166 - - -] Token: dd0e7bbc-c593-421f-a56b-52578aaec20e failed to save into memcached.\n2016-04-19 10:17:33.503 15952 WARNING nova.consoleauth.manager [req-ad043de9-616d-4cbb-a93f-fc5e345f1f53 1b0106d4f339406bb7012a83162ba5f2 e3c253d3e8344a8796e70bc4f96b6166 - - -] Instance: d3267abb-258d-4b5d-a22e-8e3b0a39905c failed to save into memcached\n\nOnly after a lot of debugging it turns out that the default backend for oslo_cache is dogpile.cache.null, implying that no values get cached and token validation always fails. Only after adding\n\n[cache]\nbackend = oslo_cache.memcache_pool\n\ndoes console authentication start working. Strangely though, the above warning messages are still being logged in the working setup, which made debugging this even more difficult.\n\nSo I suggest the following fixes:\n\n1. Change the text of the warnings from \"failed to save into memcached\" to \"failed to save into cache\", as with the change to using oslo_cache, there may be other backends in use instead of memcached.\n2. Either override the default of using the null backend or refuse to run with it or at the very least give a big fat warning that the configuration can not work.\n3. Stop generating the warning messages when the data got in fact saved into cache properly.\n\nPackage versions for reference:\n# dpkg -l | grep nova\nii  nova-api-metadata                    2:13.0.0-0ubuntu2               all          OpenStack Compute - metadata API frontend\nii  nova-api-os-compute                  2:13.0.0-0ubuntu2               all          OpenStack Compute - OpenStack Compute API frontend\nii  nova-cert                            2:13.0.0-0ubuntu2               all          OpenStack Compute - certificate management\nii  nova-common                          2:13.0.0-0ubuntu2               all          OpenStack Compute - common files\nii  nova-conductor                       2:13.0.0-0ubuntu2               all          OpenStack Compute - conductor service\nii  nova-consoleauth                     2:13.0.0-0ubuntu2               all          OpenStack Compute - Console Authenticator\nii  nova-scheduler                       2:13.0.0-0ubuntu2               all          OpenStack Compute - virtual machine scheduler\nii  nova-spiceproxy                      2:13.0.0-0ubuntu2               all          OpenStack Compute - spice html5 proxy\nii  python-nova                          2:13.0.0-0ubuntu2               all          OpenStack Compute Python libraries\nii  python-novaclient                    2:3.3.1-2                       all          client library for OpenStack Compute API - Python 2.7\n# dpkg -l | grep oslo\nii  python-oslo.cache                    1.6.0-2                         all          cache storage for Openstack projects - Python 2.7\nii  python-oslo.concurrency              3.7.0-2                         all          concurrency and locks for OpenStack projects - Python 2.x\nii  python-oslo.config                   1:3.9.0-3                       all          Common code for Openstack Projects (configuration API) - Python 2.x\nii  python-oslo.context                  2.2.0-2                         all          WSGI context helpers for OpenStack - Python 2.x\nii  python-oslo.db                       4.7.0-2ubuntu1                  all          database connectivity to the different backends and helper utils - Python 2.x\nii  python-oslo.i18n                     3.5.0-2                         all          Oslo Internationalization Utilities - Python 2.x\nii  python-oslo.log                      3.2.0-2                         all          OpenStack logging configuration library - Python 2.x\nii  python-oslo.messaging                4.6.1-2ubuntu1                  all          oslo messaging library - Python 2.x\nii  python-oslo.middleware               3.8.0-2                         all          various WSGI middleware components for OpenStack - Python 2.x\nii  python-oslo.policy                   1.6.0-2                         all          RBAC policy enforcement library for OpenStack - Python 2.x\nii  python-oslo.reports                  1.7.0-2                         all          reports serialized in various data types - Python 2.7\nii  python-oslo.rootwrap                 4.1.0-2                         all          allows fine filtering of shell commands to run as root - Python 2.x\nii  python-oslo.serialization            2.4.0-2                         all          utilities for serialization , especially JSON - Python 2.x\nii  python-oslo.service                  1.8.0-1ubuntu1                  all          library for running OpenStack services - Python 2.x\nii  python-oslo.utils                    3.8.0-2                         all          set of utility functions for OpenStack - Python 2.x\nii  python-oslo.versionedobjects         1.8.0-1                         all          deals with DB schema versions and code expectations - Python 2.x\nii  python-oslo.vmware                   2.5.0-2                         all          VMware library for OpenStack projects - Python 2.7", 
            "date_created": "2016-04-19 10:33:25.093921+00:00", 
            "author": "https://api.launchpad.net/1.0/~j-harbott"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/307698", 
            "date_created": "2016-04-19 10:38:07.879550+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/307718", 
            "date_created": "2016-04-19 11:24:07.833958+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hmm, even after setting everything up properly, I am seeing warnings like this:\n\n2016-04-26 19:49:01.731 30404 DEBUG oslo.cache.core [req-e1c84b09-256e-4a50-b6b2-2961626ab954 013fadbb4e0c42669ac9e34643b09b5f 4a0a30294e954953a41a9791d4e7f437 - - -] CACHE_SET: Key: \"'eee2cd7c98a7757eb08b8c1c9be32dcf15e4b4fc'\" Value: \"('[\"c2e6cb39-439c-48ed-840e-2c9609325717\", \"f6dfd635-534b-4ee4-95dc-38d33defcd6f\"]', {'v': 1, 'ct': 1461700141.731355})\" set /usr/lib/python2.7/dist-packages/oslo_cache/core.py:94\n2016-04-26 19:49:01.731 30404 WARNING nova.consoleauth.manager [req-e1c84b09-256e-4a50-b6b2-2961626ab954 013fadbb4e0c42669ac9e34643b09b5f 4a0a30294e954953a41a9791d4e7f437 - - -] Instance: cce6cbe3-e6c7-43d4-b2a6-f4bc2d1e7dfb failed to save into memcached\n\nThough the CACHE_SET has succeeded, as I can read that value from memcached:\n\n# nc 10.250.1.11 11211\nget eee2cd7c98a7757eb08b8c1c9be32dcf15e4b4fc\nVALUE eee2cd7c98a7757eb08b8c1c9be32dcf15e4b4fc 1 177\ncdogpile.cache.api\nCachedValue\n...\n.\nEND\n\nIf I interpret the dogpile.cache docs properly, the set function will never have a return value, so checking for that in nova/consoleauth/manager.py L94+L106 seems outdated.", 
            "date_created": "2016-04-26 20:03:55.227968+00:00", 
            "author": "https://api.launchpad.net/1.0/~j-harbott"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/307698\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=dcd14adb61b018501f3c0525ecfd7c13535cf386\nSubmitter: Jenkins\nBranch:    master\n\ncommit dcd14adb61b018501f3c0525ecfd7c13535cf386\nAuthor: Jens Rosenboom <email address hidden>\nDate:   Tue Apr 19 12:35:17 2016 +0200\n\n    Avoid unconditional warnings in nova-consoleauth\n    \n    With the introduction of oslo_cache, there is no feedback anymore about\n    whether set()ting a cache item was successful, so we stop generating\n    warnings about this all the time.\n    \n    Change-Id: I2ca0cdd3dd30498a23da2ef4f352afd199496862\n    Partial-Bug: 1572062\n", 
            "date_created": "2016-05-10 14:16:35.464469+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/307718\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=59192cfbf9482fe3798cdcd4c2044d8c85f66e95\nSubmitter: Jenkins\nBranch:    master\n\ncommit 59192cfbf9482fe3798cdcd4c2044d8c85f66e95\nAuthor: Jens Rosenboom <email address hidden>\nDate:   Tue Apr 19 13:18:52 2016 +0200\n\n    Warn when using null cache backend\n    \n    The default backend for oslo_cache is dogpile.cache.null, leading to a\n    broken setup when following the current release notes or the deprecation\n    message verbatim. So we should at least emit a warning when the config\n    does not specify a different backend.\n    \n    Note: I'm not sure whether it is possible to amend the release note like\n    this or whether there needs a new note to be added, please advise.\n    \n    Change-Id: I16647e424d8382dae98f13cb1f73a7e0c0aebaf5\n    Closes-Bug: 1572062\n", 
            "date_created": "2016-07-25 16:26:58.457556+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b3 development milestone.", 
            "date_created": "2016-09-02 01:16:45.568781+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-07-25 16:26:54.087132+00:00"
}