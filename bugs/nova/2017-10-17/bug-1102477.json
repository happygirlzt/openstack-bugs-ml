{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:10:37.896537+00:00", 
    "description": "branch: master\ntesting commit: cd4093e0f2a7d07fa81915dc4866f4ac7324a028\n\nThe sql database is postgresql 9.1. The driver is psycopg2.\n\nYou can  easily reproduce it by enabling instance_usage_audit in nova.conf and run nova-compute.\n\n\nThis bug should influence released version too if it is there for a long time.\n\nThe trace is here:\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager Traceback (most recent call last):\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/manager.py\", line 230, in periodic_tasks\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     task(self, context)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/compute/manager.py\", line 3086, in _instance_usage_audit\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     if not compute_utils.has_audit_been_run(context, self.host):\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/compute/utils.py\", line 219, in has_audit_been_run\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     begin, end, host)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/db/api.py\", line 1746, in task_log_get\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     period_ending, host, state, session)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/db/sqlalchemy/api.py\", line 115, in wrapper\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     return f(*args, **kwargs)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/db/sqlalchemy/api.py\", line 4727, in task_log_get\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     return query.first()\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/orm/query.py\", line 2156, in first\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     ret = list(self[0:1])\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/orm/query.py\", line 2023, in __getitem__\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     return list(res)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/orm/query.py\", line 2227, in __iter__\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     return self._execute_and_instances(context)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/orm/query.py\", line 2242, in _execute_and_instances\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     result = conn.execute(querycontext.statement, self._params)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/engine/base.py\", line 1449, in execute\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     params)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/engine/base.py\", line 1584, in _execute_clauseelement\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     compiled_sql, distilled_params\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/engine/base.py\", line 1698, in _execute_context\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     context)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/engine/base.py\", line 1850, in _handle_dbapi_exception\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     None, sys.exc_info()[2]\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager ProgrammingError: (ProgrammingError) operator does not exist: character varying = timestamp without time zone\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager LINE 3: ...stance_usage_audit' AND task_log.period_beginning = '2013-01...\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager                                                              ^\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager  'SELECT task_log.created_at AS task_log_created_at, task_log.updated_at AS task_log_updated_at, task_log.deleted_at AS task_log_deleted_at, task_log.deleted AS task_log_deleted, task_log.id AS task_log_id, task_log.task_name AS task_log_task_name, task_log.state AS task_log_state, task_log.host AS task_log_host, task_log.period_beginning AS task_log_period_beginning, task_log.period_ending AS task_log_period_ending, task_log.message AS task_log_message, task_log.task_items AS task_log_task_items, task_log.errors AS task_log_errors \\nFROM task_log \\nWHERE task_log.deleted = %(deleted_1)s AND task_log.task_name = %(task_name_1)s AND task_log.period_beginning = %(period_beginning_1)s AND task_log.period_ending = %(period_ending_1)s AND task_log.host = %(host_1)s \\n LIMIT %(param_1)s' {'host_1': 'localhost', 'param_1': 1, 'deleted_1': False, 'period_ending_1': datetime.datetime(2013, 1, 21, 16, 0), 'task_name_1': 'instance_usage_audit', 'period_beginning_1': datetime.datetime(2013, 1, 21, 15, 0)}", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1102477", 
    "owner": "https://api.launchpad.net/1.0/~wenhao-x", 
    "id": 1102477, 
    "index": 4603, 
    "openned": "2013-01-21 16:42:31.666184+00:00", 
    "created": "2013-01-21 16:42:31.666184+00:00", 
    "title": "datetime used for string column query crashed postgresql driver", 
    "comments": [
        {
            "content": "branch: master\ntesting commit: cd4093e0f2a7d07fa81915dc4866f4ac7324a028\n\nYou can  easily reproduce it by enabling instance_usage_audit in nova.conf and run nova-compute. \n\nThis bug should influence released version too if it is there for a long time.  \n\nThe trace is here: \n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager Traceback (most recent call last):\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/manager.py\", line 230, in periodic_tasks\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     task(self, context)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/compute/manager.py\", line 3086, in _instance_usage_audit\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     if not compute_utils.has_audit_been_run(context, self.host):\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/compute/utils.py\", line 219, in has_audit_been_run\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     begin, end, host)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/db/api.py\", line 1746, in task_log_get\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     period_ending, host, state, session)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/db/sqlalchemy/api.py\", line 115, in wrapper\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     return f(*args, **kwargs)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"/home/wenhao/workspace/openstack/nova/nova/db/sqlalchemy/api.py\", line 4727, in task_log_get\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     return query.first()\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/orm/query.py\", line 2156, in first\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     ret = list(self[0:1])\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/orm/query.py\", line 2023, in __getitem__\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     return list(res)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/orm/query.py\", line 2227, in __iter__\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     return self._execute_and_instances(context)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/orm/query.py\", line 2242, in _execute_and_instances\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     result = conn.execute(querycontext.statement, self._params)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/engine/base.py\", line 1449, in execute\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     params)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/engine/base.py\", line 1584, in _execute_clauseelement\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     compiled_sql, distilled_params\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/engine/base.py\", line 1698, in _execute_context\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     context)\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager   File \"build/bdist.linux-x86_64/egg/sqlalchemy/engine/base.py\", line 1850, in _handle_dbapi_exception\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager     None, sys.exc_info()[2]\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager ProgrammingError: (ProgrammingError) operator does not exist: character varying = timestamp without time zone\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager LINE 3: ...stance_usage_audit' AND task_log.period_beginning = '2013-01...\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager                                                              ^\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.\n2013-01-22 00:39:54,100.100 30323 TRACE nova.manager  'SELECT task_log.created_at AS task_log_created_at, task_log.updated_at AS task_log_updated_at, task_log.deleted_at AS task_log_deleted_at, task_log.deleted AS task_log_deleted, task_log.id AS task_log_id, task_log.task_name AS task_log_task_name, task_log.state AS task_log_state, task_log.host AS task_log_host, task_log.period_beginning AS task_log_period_beginning, task_log.period_ending AS task_log_period_ending, task_log.message AS task_log_message, task_log.task_items AS task_log_task_items, task_log.errors AS task_log_errors \\nFROM task_log \\nWHERE task_log.deleted = %(deleted_1)s AND task_log.task_name = %(task_name_1)s AND task_log.period_beginning = %(period_beginning_1)s AND task_log.period_ending = %(period_ending_1)s AND task_log.host = %(host_1)s \\n LIMIT %(param_1)s' {'host_1': 'localhost', 'param_1': 1, 'deleted_1': False, 'period_ending_1': datetime.datetime(2013, 1, 21, 16, 0), 'task_name_1': 'instance_usage_audit', 'period_beginning_1': datetime.datetime(2013, 1, 21, 15, 0)}", 
            "date_created": "2013-01-21 16:42:31.666184+00:00", 
            "author": "https://api.launchpad.net/1.0/~wenhao-x"
        }, 
        {
            "content": "The period_beginning and period_ending is string type defined in the model. But the query passing in is datetime. So postgresql is confused about this type mismatch, I guess. \n\nclass TaskLog(BASE, NovaBase):\n    \"\"\"Audit log for background periodic tasks.\"\"\"\n    __tablename__ = 'task_log'\n    id = Column(Integer, primary_key=True, nullable=False, autoincrement=True)\n    task_name = Column(String(255), nullable=False)\n    state = Column(String(255), nullable=False)\n    host = Column(String(255))\n    period_beginning = Column(String(255), default=timeutils.utcnow)\n    period_ending = Column(String(255), default=timeutils.utcnow)\n    message = Column(String(255), nullable=False)\n    task_items = Column(Integer(), default=0)\n    errors = Column(Integer(), default=0)\n\nBy converting the datetime to str before the SQLAlchemy query should fix the problem. ", 
            "date_created": "2013-01-21 16:49:52.684912+00:00", 
            "author": "https://api.launchpad.net/1.0/~wenhao-x"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/20156", 
            "date_created": "2013-01-21 17:37:18.109639+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/20156\nCommitted: http://github.com/openstack/nova/commit/84e5e69e5b19272fe32aa587bc5d8552dbc4797e\nSubmitter: Jenkins\nBranch:    master\n\ncommit 84e5e69e5b19272fe32aa587bc5d8552dbc4797e\nAuthor: Wenhao Xu <email address hidden>\nDate:   Tue Jan 22 01:34:44 2013 +0800\n\n    Fix the wrong datatype in task_log table.\n    \n        Change period_begining and period_ending to Datetime type.\n        Add the migration script.\n    \n    Change-Id: Ic5d61d6e7e847a1943825a0cb342b0b015bc0b70\n    Fixes: bug #1102477\n", 
            "date_created": "2013-01-23 12:51:50.148678+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-02-21 08:53:23.125516+00:00"
}