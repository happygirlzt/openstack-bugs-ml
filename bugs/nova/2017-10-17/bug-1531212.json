{
    "status": "Invalid", 
    "last_updated": "2017-07-25 14:12:24.070917+00:00", 
    "description": "While running Kilo in a scale test, my colleague observed a stack trace on a compute host which boils down to:\n\n    Cannot find device \"qvbcdc5cf8d-ad\"\n\nChecking the log, I found:\n\n    CMD \"sudo nova-rootwrap /opt/stack/service/nova-compute/etc/nova/rootwrap.conf ip link add qvb59fd2beb-0c type veth peer name qvo59fd2beb-0c\" returned: 0 in 0.091s\n    CMD \"sudo nova-rootwrap /opt/stack/service/nova-compute/etc/nova/rootwrap.conf ip link set qvb59fd2beb-0c up\" returned: 1 in 0.092s\n\nThere was also a stack trace pointing to line 1357 of nova/network/linux_net.py, which is in _create_veth_pair. The code here is very simple: it deletes the devices if they exist, runs `ip link add ...` then `ip link set ...`. The code has not changed since Kilo.\n\nSo it seems like either `ip link add ...` should have returned nonzero and didn't; or another thread (maybe of another process) managed to delete the devices in between the two commands. Neither seem particularly likely, 'ip' is presumably pretty robust and the device names are randomly generated so a collision seems curious.\n\n\nFull stack trace:\n\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup Traceback (most recent call last):\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/openstack/common/threadgroup.py\", line 145, in wait\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     x.wait()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/openstack/common/threadgroup.py\", line 47, in wait\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     return self.thread.wait()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"eventlet/greenthread.py\", line 175, in wait\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     return self._exit_event.wait()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"eventlet/event.py\", line 121, in wait\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     return hubs.get_hub().switch()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"eventlet/hubs/hub.py\", line 294, in switch\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     return self.greenlet.switch()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"eventlet/greenthread.py\", line 214, in main\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     result = function(*args, **kwargs)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/openstack/common/service.py\", line 502, in run_service\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     service.start()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/service.py\", line 164, in start\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self.manager.init_host()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/compute/manager.py\", line 1298, in init_host\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self._init_instance(context, instance)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/compute/manager.py\", line 1133, in _init_instance\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self.driver.plug_vifs(instance, net_info)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/virt/libvirt/driver.py\", line 604, in plug_vifs\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self.vif_driver.plug(instance, vif)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/virt/libvirt/vif.py\", line 609, in plug\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     func(instance, vif)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/virt/libvirt/vif.py\", line 447, in plug_ovs\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self.plug_ovs_hybrid(instance, vif)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/virt/libvirt/vif.py\", line 443, in plug_ovs_hybrid\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self._plug_bridge_with_port(instance, vif, port='ovs')\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/virt/libvirt/vif.py\", line 424, in _plug_bridge_with_port\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     linux_net._create_veth_pair(v1_name, v2_name)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/network/linux_net.py\", line 1352, in _create_veth_pair\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     utils.execute('ip', 'link', 'set', dev, 'up', run_as_root=True)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/utils.py\", line 207, in execute\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     return processutils.execute(*cmd, **kwargs)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"oslo_concurrency/processutils.py\", line 266, in execute\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     cmd=sanitized_cmd)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup ProcessExecutionError: Unexpected error while running command.\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup Command: sudo nova-rootwrap /etc/nova/rootwrap.conf ip link set qvb59fd2beb-0c up\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup Exit code: 1\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup Stdout: u''\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup Stderr: u'Cannot find device \"qvb59fd2beb-0c\"\\n'", 
    "tags": [
        "kilo-backport-potential", 
        "liberty-backport-potential", 
        "libvirt", 
        "network", 
        "openstack-version.kilo"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1531212", 
    "owner": "None", 
    "id": 1531212, 
    "index": 7211, 
    "openned": "2016-01-05 16:58:39.907120+00:00", 
    "created": "2016-01-05 16:58:39.907120+00:00", 
    "title": "'Cannot find device' during _create_veth_pair", 
    "comments": [
        {
            "content": "While running Kilo in a scale test, my colleague observed a stack trace on a compute host which boils down to:\n\n    Cannot find device \"qvbcdc5cf8d-ad\"\n\nChecking the log, I found:\n\n    CMD \"sudo nova-rootwrap /opt/stack/service/nova-compute/etc/nova/rootwrap.conf ip link add qvb59fd2beb-0c type veth peer name qvo59fd2beb-0c\" returned: 0 in 0.091s\n    CMD \"sudo nova-rootwrap /opt/stack/service/nova-compute/etc/nova/rootwrap.conf ip link set qvb59fd2beb-0c up\" returned: 1 in 0.092s\n\nThere was also a stack trace pointing to line 1357 of nova/network/linux_net.py, which is in _create_veth_pair. The code here is very simple: it deletes the devices if they exist, runs `ip link add ...` then `ip link set ...`. The code has not changed since Kilo.\n\nSo it seems like either `ip link add ...` should have returned nonzero and didn't; or another thread (maybe of another process) managed to delete the devices in between the two commands. Neither seem particularly likely, 'ip' is presumably pretty robust and the device names are randomly generated so a collision seems curious.\n\n\nFull stack trace:\n\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup Traceback (most recent call last):\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/openstack/common/threadgroup.py\", line 145, in wait\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     x.wait()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/openstack/common/threadgroup.py\", line 47, in wait\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     return self.thread.wait()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"eventlet/greenthread.py\", line 175, in wait\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     return self._exit_event.wait()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"eventlet/event.py\", line 121, in wait\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     return hubs.get_hub().switch()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"eventlet/hubs/hub.py\", line 294, in switch\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     return self.greenlet.switch()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"eventlet/greenthread.py\", line 214, in main\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     result = function(*args, **kwargs)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/openstack/common/service.py\", line 502, in run_service\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     service.start()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/service.py\", line 164, in start\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self.manager.init_host()\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/compute/manager.py\", line 1298, in init_host\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self._init_instance(context, instance)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/compute/manager.py\", line 1133, in _init_instance\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self.driver.plug_vifs(instance, net_info)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/virt/libvirt/driver.py\", line 604, in plug_vifs\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self.vif_driver.plug(instance, vif)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/virt/libvirt/vif.py\", line 609, in plug\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     func(instance, vif)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/virt/libvirt/vif.py\", line 447, in plug_ovs\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self.plug_ovs_hybrid(instance, vif)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/virt/libvirt/vif.py\", line 443, in plug_ovs_hybrid\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     self._plug_bridge_with_port(instance, vif, port='ovs')\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/virt/libvirt/vif.py\", line 424, in _plug_bridge_with_port\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     linux_net._create_veth_pair(v1_name, v2_name)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/network/linux_net.py\", line 1352, in _create_veth_pair\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     utils.execute('ip', 'link', 'set', dev, 'up', run_as_root=True)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"nova/utils.py\", line 207, in execute\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     return processutils.execute(*cmd, **kwargs)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup   File \"oslo_concurrency/processutils.py\", line 266, in execute\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup     cmd=sanitized_cmd)\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup ProcessExecutionError: Unexpected error while running command.\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup Command: sudo nova-rootwrap /etc/nova/rootwrap.conf ip link set qvb59fd2beb-0c up\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup Exit code: 1\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup Stdout: u''\n2015-12-13 18:34:58.876 1069 TRACE nova.openstack.common.threadgroup Stderr: u'Cannot find device \"qvb59fd2beb-0c\"\\n'", 
            "date_created": "2016-01-05 16:58:39.907120+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexisl"
        }, 
        {
            "content": "Running this all night yielded no problems:\n\nwhile true; do\nsudo ip link add aaa type veth peer name bbb\nsudo ip link set aaa up\nsudo ip link delete aaa\nsudo ip link delete bbb > /dev/null 2>&1\necho -n \".\"\ndone\n", 
            "date_created": "2016-01-06 09:45:38.617371+00:00", 
            "author": "https://api.launchpad.net/1.0/~alexisl"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/264146", 
            "date_created": "2016-01-06 12:09:16.869400+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Alexis Lee (<email address hidden>) on branch: master\nReview: https://review.openstack.org/264146", 
            "date_created": "2016-09-29 11:05:39.186653+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "\nThere are no currently open reviews on this bug, changing\nthe status back to the previous state and unassigning. If\nthere are active reviews related to this bug, please include\nlinks in comments.\n", 
            "date_created": "2017-06-23 12:42:50.362171+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Automatically discovered version kilo in description. If this is incorrect, please update the description to include 'nova version: ...'", 
            "date_created": "2017-06-27 16:02:02.260172+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "This is a kilo era bug from a long time ago. Marking as Invalid. Please reopen if this is seen again.", 
            "date_created": "2017-07-25 14:12:23.472779+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ], 
    "closed": "2017-07-25 14:11:58.187060+00:00"
}