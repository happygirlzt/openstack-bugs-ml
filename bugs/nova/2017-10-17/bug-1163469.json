{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:11:41.251481+00:00", 
    "description": "Try to add an incorrect security rules, like\n  1] adding an icmp rule without providing cidr to the default nova security group\n    - also, ICMP doesn't run on ports (so providing arbitrary ports for ICMP should be disabled ?)\n  2] add an ssh rule, without cidr\n\nAnd there appears to be no way to delete these  incorrect rules\n\nA small test:\n\n=======\n(~(keystone_admin)$ nova secgroup-list\n+---------+-------------+\n| Name    | Description |\n+---------+-------------+\n| default | default     |\n+---------+-------------+\n\n(~(keystone_admin)$  nova secgroup-list-rules default\n\n(~(keystone_admin)$ \n\n\n(~(keystone_user1)]$ nova secgroup-add-group-rule default default icmp -1 -1\n+-------------+-----------+---------+----------+--------------+\n| IP Protocol | From Port | To Port | IP Range | Source Group |\n+-------------+-----------+---------+----------+--------------+\n| icmp        | -1        | -1      |          | default      |\n+-------------+-----------+---------+----------+--------------+\n\n(~(keystone_user1)]$ nova secgroup-add-group-rule default default icmp 22 22\n+-------------+-----------+---------+----------+--------------+\n| IP Protocol | From Port | To Port | IP Range | Source Group |\n+-------------+-----------+---------+----------+--------------+\n| icmp        | 22        | 22      |          | default      |\n+-------------+-----------+---------+----------+--------------+\n\n(~(keystone_user1)]$ nova secgroup-list-rules default\n+-------------+-----------+---------+----------+--------------+\n| IP Protocol | From Port | To Port | IP Range | Source Group |\n+-------------+-----------+---------+----------+--------------+\n| icmp        | -1        | -1      |          | default      |\n| icmp        | 22        | 22      |          | default      |\n+-------------+-----------+---------+----------+--------------+\n=======\n\n-> Now attempt to delete:\n=======\n(~(keystone_user1)]$ nova secgroup-delete-rule default icmp 22 22 \nusage: nova secgroup-delete-rule <secgroup> <ip-proto> <from-port> <to-port>\n                                 <cidr>\nerror: too few arguments\n=======\n(~(keystone_user1)]$ nova secgroup-delete-rule default icmp 22 22 0.0.0.0/0\nERROR: 'cidr'\n=======\n\n\n-> For reference, correct way to add rules:\n=========================================\n(~(keystone_user1)]$ nova secgroup-add-rule default tcp 22 22 0.0.0.0/0\n+-------------+-----------+---------+-----------+--------------+\n| IP Protocol | From Port | To Port | IP Range  | Source Group |\n+-------------+-----------+---------+-----------+--------------+\n| tcp         | 22        | 22      | 0.0.0.0/0 |              |\n+-------------+-----------+---------+-----------+--------------+\n(~(keystone_user1)]$ nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0\n+-------------+-----------+---------+-----------+--------------+\n| IP Protocol | From Port | To Port | IP Range  | Source Group |\n+-------------+-----------+---------+-----------+--------------+\n| icmp        | -1        | -1      | 0.0.0.0/0 |              |\n+-------------+-----------+---------+-----------+--------------+\n(~(keystone_user1)]$ \n\n\n-> Now, I end up with an inconsistent set of rules:\n=============\n(~(keystone_user1)]$ nova secgroup-list-rules default\n+-------------+-----------+---------+-----------+--------------+\n| IP Protocol | From Port | To Port | IP Range  | Source Group |\n+-------------+-----------+---------+-----------+--------------+\n| icmp        | -1        | -1      |           | default      |\n| icmp        | -1        | -1      | 0.0.0.0/0 |              |\n| icmp        | 22        | 22      |           | default      |\n| tcp         | 22        | 22      | 0.0.0.0/0 |              |\n+-------------+-----------+---------+-----------+--------------+\n(~(keystone_user1)]$\n=============\n\n\nActual results:\nIncorrect/invalid rules can be created.\n\nExpected results:\nIncorrect/invalid rules should be sanitized. In case they're allowed, there should be a way to delete them.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1163469", 
    "owner": "https://api.launchpad.net/1.0/~rattenpal-amandeep", 
    "id": 1163469, 
    "index": 3337, 
    "openned": "2013-04-02 17:25:21.428703+00:00", 
    "created": "2013-04-02 17:25:21.428703+00:00", 
    "title": "no obvious way to delete incorrect security rules (added to the default nova security group)", 
    "comments": [
        {
            "content": "Try to add an incorrect security rules, like\n  1] adding an icmp rule without providing cidr to the default nova security group\n    - also, ICMP doesn't run on ports (so providing arbitrary ports for ICMP should be disabled ?)\n  2] add an ssh rule, without cidr\n\nAnd there appears to be no way to delete these  incorrect rules\n\nA small test:\n\n=======\n(~(keystone_admin)$ nova secgroup-list\n+---------+-------------+\n| Name    | Description |\n+---------+-------------+\n| default | default     |\n+---------+-------------+\n\n(~(keystone_admin)$  nova secgroup-list-rules default\n\n(~(keystone_admin)$ \n\n\n(~(keystone_user1)]$ nova secgroup-add-group-rule default default icmp -1 -1\n+-------------+-----------+---------+----------+--------------+\n| IP Protocol | From Port | To Port | IP Range | Source Group |\n+-------------+-----------+---------+----------+--------------+\n| icmp        | -1        | -1      |          | default      |\n+-------------+-----------+---------+----------+--------------+\n\n(~(keystone_user1)]$ nova secgroup-add-group-rule default default icmp 22 22\n+-------------+-----------+---------+----------+--------------+\n| IP Protocol | From Port | To Port | IP Range | Source Group |\n+-------------+-----------+---------+----------+--------------+\n| icmp        | 22        | 22      |          | default      |\n+-------------+-----------+---------+----------+--------------+\n\n(~(keystone_user1)]$ nova secgroup-list-rules default\n+-------------+-----------+---------+----------+--------------+\n| IP Protocol | From Port | To Port | IP Range | Source Group |\n+-------------+-----------+---------+----------+--------------+\n| icmp        | -1        | -1      |          | default      |\n| icmp        | 22        | 22      |          | default      |\n+-------------+-----------+---------+----------+--------------+\n=======\n\n-> Now attempt to delete:\n=======\n(~(keystone_user1)]$ nova secgroup-delete-rule default icmp 22 22 \nusage: nova secgroup-delete-rule <secgroup> <ip-proto> <from-port> <to-port>\n                                 <cidr>\nerror: too few arguments\n=======\n(~(keystone_user1)]$ nova secgroup-delete-rule default icmp 22 22 0.0.0.0/0\nERROR: 'cidr'\n=======\n\n\n-> For reference, correct way to add rules:\n=========================================\n(~(keystone_user1)]$ nova secgroup-add-rule default tcp 22 22 0.0.0.0/0\n+-------------+-----------+---------+-----------+--------------+\n| IP Protocol | From Port | To Port | IP Range  | Source Group |\n+-------------+-----------+---------+-----------+--------------+\n| tcp         | 22        | 22      | 0.0.0.0/0 |              |\n+-------------+-----------+---------+-----------+--------------+\n(~(keystone_user1)]$ nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0\n+-------------+-----------+---------+-----------+--------------+\n| IP Protocol | From Port | To Port | IP Range  | Source Group |\n+-------------+-----------+---------+-----------+--------------+\n| icmp        | -1        | -1      | 0.0.0.0/0 |              |\n+-------------+-----------+---------+-----------+--------------+\n(~(keystone_user1)]$ \n\n\n-> Now, I end up with an inconsistent set of rules:\n=============\n(~(keystone_user1)]$ nova secgroup-list-rules default\n+-------------+-----------+---------+-----------+--------------+\n| IP Protocol | From Port | To Port | IP Range  | Source Group |\n+-------------+-----------+---------+-----------+--------------+\n| icmp        | -1        | -1      |           | default      |\n| icmp        | -1        | -1      | 0.0.0.0/0 |              |\n| icmp        | 22        | 22      |           | default      |\n| tcp         | 22        | 22      | 0.0.0.0/0 |              |\n+-------------+-----------+---------+-----------+--------------+\n(~(keystone_user1)]$\n=============\n\n\nActual results:\nIncorrect/invalid rules can be created.\n\nExpected results:\nIncorrect/invalid rules should be sanitized. In case they're allowed, there should be a way to delete them.", 
            "date_created": "2013-04-02 17:25:21.428703+00:00", 
            "author": "https://api.launchpad.net/1.0/~kashyapc"
        }, 
        {
            "content": "What version of nova is this? I get a different error when I try:\r\n\r\ndan@guaranine:/opt/stack/tempest$ nova secgroup-delete-rule default icmp -1 -1 1.1.1.1/8\r\nERROR: 'NoneType' object has no attribute 'upper'\r\n", 
            "date_created": "2013-04-02 21:51:08.568941+00:00", 
            "author": "https://api.launchpad.net/1.0/~danms"
        }, 
        {
            "content": "According to the following link there are two types of rules - one type specify an IP range the other a source group.\n\nhttp://docs.openstack.org/developer/nova/nova.concepts.html#concept-security-groups\n\nYou are creating rules with a source group, they can be deleted using nova secgroup-delete-group-rule not nova secgroup-delete-rule\n\n# nova secgroup-list-rules default\n+-------------+-----------+---------+----------+--------------+\n| IP Protocol | From Port | To Port | IP Range | Source Group |\n+-------------+-----------+---------+----------+--------------+\n| icmp        | -1        | -1      |          | default      |\n| icmp        | 22        | 22      |          | default      |\n+-------------+-----------+---------+----------+--------------+\n\n# nova secgroup-delete-group-rule default default icmp 22 22\n\n# nova secgroup-list-rules default\n+-------------+-----------+---------+----------+--------------+\n| IP Protocol | From Port | To Port | IP Range | Source Group |\n+-------------+-----------+---------+----------+--------------+\n| icmp        | -1        | -1      |          | default      |\n+-------------+-----------+---------+----------+--------------+\n\nWhen specifying ICMP the two arguments are not ports but ICMP code and type - http://docs.openstack.org/cli/quick-start/content/nova_client.html#nova_cli_security_groups", 
            "date_created": "2013-05-08 13:17:52.868286+00:00", 
            "author": "https://api.launchpad.net/1.0/~git-harry"
        }, 
        {
            "content": "Shouldn't this be closed? The usage described in the bug isn't valid.", 
            "date_created": "2013-06-11 16:18:39.738472+00:00", 
            "author": "https://api.launchpad.net/1.0/~beagles"
        }, 
        {
            "content": "@Dan Smith: Sorry for such a late reply. I missed this.  And I didn't mention the original version :( . It was with Folsom, I'm sure, but can't recall the exact package versions.\n\n@Brent: Just curious, shouldn't adding dubious security rules be disallowed ?  If you still think this usage invalid/trivial, it can be closed, if others agree.\n\nI can test this w/ Grizzly and check if it still persists.\n\nThanks.", 
            "date_created": "2013-06-11 16:34:03.964297+00:00", 
            "author": "https://api.launchpad.net/1.0/~kashyapc"
        }, 
        {
            "content": "In icmp protocol -1 port is user defined. Check conditions are given for tcp, udp, icmp protocol in nova.network.security_group.security_group_base.py  where we can see that for icmp protocol -1 to 255 are valid port (user defined) . So accordingly  in icmp protocol if we are using -1 port to add security group rule  then it is a valid rule not a invalid rule and we are not able to add invalid rule, only valid rules are accepted to be add.  \nMoreover, we are unable to delete correct/valid rule also. So, i  worked on this problem and now i am having a fix ready for this problem.", 
            "date_created": "2014-09-25 07:10:19.428260+00:00", 
            "author": "https://api.launchpad.net/1.0/~rattenpal-amandeep"
        }, 
        {
            "content": "In nova/network/security_group/security_group_base.py the conditions are given below :\n\n# Verify valid TCP, UDP port ranges\n            if (ip_protocol.upper() in ['TCP', 'UDP'] and\n                    (from_port < 1 or to_port > 65535)):\n                raise exception.InvalidPortRange(from_port=from_port,\n                      to_port=to_port, msg=\"Valid TCP ports should\"\n                                           \" be between 1-65535\")\n\n# Verify ICMP type and code\n            if (ip_protocol.upper() == \"ICMP\" and\n                (from_port < -1 or from_port > 255 or\n                 to_port < -1 or to_port > 255)):\n                raise exception.InvalidPortRange(from_port=from_port,\n                      to_port=to_port, msg=\"For ICMP, the\"\n                                           \" type:code must be valid\")\n\nAccording to these condition -1 to 255 port are valid ports.\nSo these given rules are valid not invalid.\n\nMoreover, In Icehouse/stable version :\nnova secgroup-delete-group-rule default default icmp 22 22 also throwing AttributeError.\nWhich means only valid rules are throwing the error and invalid rules are not able to add.\n", 
            "date_created": "2014-09-26 10:18:57.680575+00:00", 
            "author": "https://api.launchpad.net/1.0/~rattenpal-amandeep"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/125015", 
            "date_created": "2014-10-10 03:52:43.288815+00:00", 
            "author": "https://api.launchpad.net/1.0/~rattenpal-amandeep"
        }
    ], 
    "closed": "2014-12-18 20:00:08.901060+00:00"
}