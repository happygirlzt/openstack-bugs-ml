{
    "status": "Fix Released", 
    "last_updated": "2016-06-02 19:33:21.076110+00:00", 
    "description": "1. root@cling-SBCJ-slot2 ~(keystone_admin)]# nova keypair-list\n+---------+-------------------------------------------------+\n| Name    | Fingerprint                                     |\n+---------+-------------------------------------------------+\n| hanrong | 57:96:f9:94:56:b9:e9:b5:86:66:c7:9d:7e:bc:57:e3 |\n+---------+-------------------------------------------------+\n\n2. modify nova.conf\ninject_partition=-1\ninject_key=true\n\n3. boot a instance with parameter --key-name\nnova boot --image e39e0859-1a7d-4e36-8e7d-84db2306bfea --flavor 3 --key-name hanrong  --nic net-id=fa752978-d3b9-4369-870d-b0fb8d4e0fae hanrong\n\n4. vm is active, but the end of file /root/.ssh/authrized_keys is without inserting this pub key.\n\n5. nova-compute.log is show that:\n2015-09-02 10:11:00.058 8474 WARNING nova.virt.disk.vfs.guestfs [req-f8e65cdf-5242-4b16-ad61-adb3c8224139 032d0561ca1e42bda4710eada6148bce 3c1f187a3acf4268aa8f24e6d82d5bad] Failed to close augeas aug_close: call launch before using this function\\n(in guestfish, don't forget to use the 'run' command)\n2015-09-02 10:11:00.068 8474 WARNING nova.virt.disk.api [req-f8e65cdf-5242-4b16-ad61-adb3c8224139 032d0561ca1e42bda4710eada6148bce 3c1f187a3acf4268aa8f24e6d82d5bad] Ignoring error injecting data into image (Error mounting /var/lib/nova/instances/c14e01b8-93f8-4f5d-b952-1e05ed73e29b/disk with libguestfs (/usr/libexec/qemu-kvm exited with error status 1.\n\n6. fs.setup() throw exception ,log write in this code:\ndef inject_data(image, key=None, net=None, metadata=None, admin_password=None,\n                files=None, partition=None, use_cow=False, mandatory=()):\n    \"\"\"Inject the specified items into a disk image.\n\n    If an item name is not specified in the MANDATORY iterable, then a warning\n    is logged on failure to inject that item, rather than raising an exception.\n\n    it will mount the image as a fully partitioned disk and attempt to inject\n    into the specified partition number.\n\n    If PARTITION is not specified the image is mounted as a single partition.\n\n    Returns True if all requested operations completed without issue.\n    Raises an exception if a mandatory item can't be injected.\n    \"\"\"\n    LOG.debug(\"Inject data image=%(image)s key=%(key)s net=%(net)s \"\n              \"metadata=%(metadata)s admin_password=<SANITIZED> \"\n              \"files=%(files)s partition=%(partition)s use_cow=%(use_cow)s\",\n              {'image': image, 'key': key, 'net': net, 'metadata': metadata,\n               'files': files, 'partition': partition, 'use_cow': use_cow})\n    fmt = \"raw\"\n    if use_cow:\n        fmt = \"qcow2\"\n    try:\n        fs = vfs.VFS.instance_for_image(image, fmt, partition)\n        fs.setup()\n    except Exception as e:\n        # If a mandatory item is passed to this function,\n        # then reraise the exception to indicate the error.\n        for inject in mandatory:\n            inject_val = locals()[inject]\n            if inject_val:\n                raise\n        LOG.warning(_LW('Ignoring error injecting data into image %(image)s '\n                        '(%(e)s)'), {'image': image, 'e': e})\n        return False\n\n    try:\n        return inject_data_into_fs(fs, key, net, metadata, admin_password,\n                                   files, mandatory)\n    finally:\n        fs.teardown() the exception code is :", 
    "tags": [
        "libvirt", 
        "rootwrap"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1491216", 
    "owner": "https://api.launchpad.net/1.0/~lyanchih", 
    "id": 1491216, 
    "index": 7005, 
    "openned": "2015-09-02 02:50:40.478689+00:00", 
    "created": "2015-09-02 02:50:40.478689+00:00", 
    "title": "Inject an ssh key failed when booting a instance by using direct image injection.", 
    "comments": [
        {
            "content": "1. root@cling-SBCJ-slot2 ~(keystone_admin)]# nova keypair-list\n+---------+-------------------------------------------------+\n| Name    | Fingerprint                                     |\n+---------+-------------------------------------------------+\n| hanrong | 57:96:f9:94:56:b9:e9:b5:86:66:c7:9d:7e:bc:57:e3 |\n+---------+-------------------------------------------------+\n\n2. modify nova.conf\ninject_partition=-1\ninject_key=true\n\n3. boot a instance with parameter --key-name\nnova boot --image e39e0859-1a7d-4e36-8e7d-84db2306bfea --flavor 3 --key-name hanrong  --nic net-id=fa752978-d3b9-4369-870d-b0fb8d4e0fae hanrong\n\n4. vm is active, but the end of file /root/.ssh/authrized_keys is without inserting this pub key.\n\n5. nova-compute.log is show that:\n2015-09-02 10:11:00.058 8474 WARNING nova.virt.disk.vfs.guestfs [req-f8e65cdf-5242-4b16-ad61-adb3c8224139 032d0561ca1e42bda4710eada6148bce 3c1f187a3acf4268aa8f24e6d82d5bad] Failed to close augeas aug_close: call launch before using this function\\n(in guestfish, don't forget to use the 'run' command)\n2015-09-02 10:11:00.068 8474 WARNING nova.virt.disk.api [req-f8e65cdf-5242-4b16-ad61-adb3c8224139 032d0561ca1e42bda4710eada6148bce 3c1f187a3acf4268aa8f24e6d82d5bad] Ignoring error injecting data into image (Error mounting /var/lib/nova/instances/c14e01b8-93f8-4f5d-b952-1e05ed73e29b/disk with libguestfs (/usr/libexec/qemu-kvm exited with error status 1.\n\n6. fs.setup() throw exception ,log write in this code:\ndef inject_data(image, key=None, net=None, metadata=None, admin_password=None,\n                files=None, partition=None, use_cow=False, mandatory=()):\n    \"\"\"Inject the specified items into a disk image.\n\n    If an item name is not specified in the MANDATORY iterable, then a warning\n    is logged on failure to inject that item, rather than raising an exception.\n\n    it will mount the image as a fully partitioned disk and attempt to inject\n    into the specified partition number.\n\n    If PARTITION is not specified the image is mounted as a single partition.\n\n    Returns True if all requested operations completed without issue.\n    Raises an exception if a mandatory item can't be injected.\n    \"\"\"\n    LOG.debug(\"Inject data image=%(image)s key=%(key)s net=%(net)s \"\n              \"metadata=%(metadata)s admin_password=<SANITIZED> \"\n              \"files=%(files)s partition=%(partition)s use_cow=%(use_cow)s\",\n              {'image': image, 'key': key, 'net': net, 'metadata': metadata,\n               'files': files, 'partition': partition, 'use_cow': use_cow})\n    fmt = \"raw\"\n    if use_cow:\n        fmt = \"qcow2\"\n    try:\n        fs = vfs.VFS.instance_for_image(image, fmt, partition)\n        fs.setup()\n    except Exception as e:\n        # If a mandatory item is passed to this function,\n        # then reraise the exception to indicate the error.\n        for inject in mandatory:\n            inject_val = locals()[inject]\n            if inject_val:\n                raise\n        LOG.warning(_LW('Ignoring error injecting data into image %(image)s '\n                        '(%(e)s)'), {'image': image, 'e': e})\n        return False\n\n    try:\n        return inject_data_into_fs(fs, key, net, metadata, admin_password,\n                                   files, mandatory)\n    finally:\n        fs.teardown() the exception code is :", 
            "date_created": "2015-09-02 02:50:40.478689+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "I did an experiment, if the service of nova-compute as root permission to start, we can inject the SSH key into instance success.\n\nstop nova-compute:\nsystemctl stop openstack-nova-compute\n\nstart nova-compute as root permission\n/usr/bin/python /usr/bin/nova-compute\n\n", 
            "date_created": "2015-09-02 02:57:26.141508+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "I removed tags which don't have a subteam which watches for them.", 
            "date_created": "2015-11-26 16:04:09.113022+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "Sorry, I didn't notice review not been post here.\n\nFix proposed to branch: master\nReview: https://review.openstack.org/#/c/237547/", 
            "date_created": "2016-03-04 02:33:16.684760+00:00", 
            "author": "https://api.launchpad.net/1.0/~lyanchih"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/237547\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=92ae0f1077e4c5916d99777b032aaf0840e7ab93\nSubmitter: Jenkins\nBranch:    master\n\ncommit 92ae0f1077e4c5916d99777b032aaf0840e7ab93\nAuthor: Chung Chih, Hung <email address hidden>\nDate:   Tue Oct 20 12:41:46 2015 +0000\n\n    libvirt - Add log if libguestfs can't read host kernel\n    \n    Host's kernel only allows a root user to have read/write permission in\n    ubuntu. If compute-service didn't have read permission then libguestfs\n    will launch image fail.\n    \n    In libguestfs offical FAQ site had point out this issue, following is\n    the link\n    http://libguestfs.org/guestfs-faq.1.html#binaries\n    It had suggested users to change host's kernel permission. But this\n    action should be handled by other patch. Here only give a hint what's\n    going wrong.\n    \n    Change-Id: I36c93610831e2935d46f7ee37f95619fe6dc1481\n    Related-Bug: 1413142\n    Closes-Bug: 1491216\n", 
            "date_created": "2016-05-09 10:53:32.409081+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b1 development milestone.", 
            "date_created": "2016-06-02 19:33:20.309107+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }
    ], 
    "closed": "2016-05-09 10:53:29.506386+00:00"
}