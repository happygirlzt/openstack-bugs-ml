{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:28:47.760309+00:00", 
    "description": "Instance moves to ERROR state after deleting this instance\nConfiguration:\n  1. network_manager = nova.network.manager.VlanManager\n  2. teardown_unused_network_gateway = true\nSteps to reproduce:\n  1. launch instance\n  2. remove instance\nExpected result:\ninstance is removed without error\nActual result:\ninstance is not removed, instance' state become ERROR:\nroot@node-1:~# nova list\n+--------------------------------------+-----------------+--------+------------+-------------+----------------------+\n| ID                                   | Name            | Status | Task State | Power State | Networks             |\n+--------------------------------------+-----------------+--------+------------+-------------+----------------------+\n| fd581745-8ecd-4fa2-af80-82493d083b97 | test_del_bridge | ERROR  | deleting   | Running     | novanetwork=10.0.0.3 |\n+--------------------------------------+-----------------+--------+------------+-------------+----------------------+\nroot@node-1:~# nova show fd581745-8ecd-4fa2-af80-82493d083b97\n+--------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+\n| Property                             | Value                                                                                                                                  |\n+--------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                                                                                                 |\n| OS-EXT-AZ:availability_zone          | nova                                                                                                                                   |\n| OS-EXT-SRV-ATTR:host                 | node-2                                                                                                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | node-2                                                                                                                                 |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000002                                                                                                                      |\n| OS-EXT-STS:power_state               | 1                                                                                                                                      |\n| OS-EXT-STS:task_state                | deleting                                                                                                                               |\n| OS-EXT-STS:vm_state                  | error                                                                                                                                  |\n| OS-SRV-USG:launched_at               | 2015-03-04T15:14:44.000000                                                                                                             |\n| OS-SRV-USG:terminated_at             | -                                                                                                                                      |\n| accessIPv4                           |                                                                                                                                        |\n| accessIPv6                           |                                                                                                                                        |\n| config_drive                         |                                                                                                                                        |\n| created                              | 2015-03-04T15:14:40Z                                                                                                                   |\n| fault                                | {\"message\": \"Remote error: ProcessExecutionError Unexpected error while running command.                                               |\n|                                      | Command: sudo nova-rootwrap /etc/nova/rootwrap.conf dhcp_release br103 10.0.0.3 fa:16:3e:d2:1c:9a                                      |\n|                                      | Exit code: 1                                                                                                                           |\n|                                      | Stdout: ''                                                                                                                             |\n|                                      | Stderr: 'cannot setup interface: No such device\\                                                                                       |\n|                                      | '                                                                                                                                      |\n|                                      | [u'Tra\", \"code\": 500, \"details\": \"  File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 296, in decorated_function |\n|                                      |     return function(self, context, *args, **kwargs)                                                                                    |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2262, in terminate_instance                                  |\n|                                      |     do_terminate_instance(instance, bdms)                                                                                              |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/openstack/common/lockutils.py\\\", line 249, in inner                                     |\n|                                      |     return f(*args, **kwargs)                                                                                                          |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2260, in do_terminate_instance                               |\n|                                      |     self._set_instance_error_state(context, instance['uuid'])                                                                          |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\\\", line 68, in __exit__                                    |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                       |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2250, in do_terminate_instance                               |\n|                                      |     reservations=reservations)                                                                                                         |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/hooks.py\\\", line 103, in inner                                                          |\n|                                      |     rv = f(*args, **kwargs)                                                                                                            |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2220, in _delete_instance                                    |\n|                                      |     user_id=user_id)                                                                                                                   |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\\\", line 68, in __exit__                                    |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                       |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2190, in _delete_instance                                    |\n|                                      |     self._shutdown_instance(context, db_inst, bdms)                                                                                    |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2127, in _shutdown_instance                                  |\n|                                      |     self._try_deallocate_network(context, instance, requested_networks)                                                                |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2086, in _try_deallocate_network                             |\n|                                      |     self._set_instance_error_state(context, instance['uuid'])                                                                          |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\\\", line 68, in __exit__                                    |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                       |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2081, in _try_deallocate_network                             |\n|                                      |     self._deallocate_network(context, instance, requested_networks)                                                                    |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 1775, in _deallocate_network                                 |\n|                                      |     context, instance, requested_networks=requested_networks)                                                                          |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/network/api.py\\\", line 94, in wrapped                                                   |\n|                                      |     return func(self, context, *args, **kwargs)                                                                                        |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/network/api.py\\\", line 318, in deallocate_for_instance                                  |\n|                                      |     requested_networks=requested_networks)                                                                                             |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/network/rpcapi.py\\\", line 190, in deallocate_for_instance                               |\n|                                      |     return cctxt.call(ctxt, 'deallocate_for_instance', **kwargs)                                                                       |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\\\", line 150, in call                                            |\n|                                      |     wait_for_reply=True, timeout=timeout)                                                                                              |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/oslo/messaging/transport.py\\\", line 90, in _send                                             |\n|                                      |     timeout=timeout)                                                                                                                   |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\\\", line 409, in send                                   |\n|                                      |     return self._send(target, ctxt, message, wait_for_reply, timeout)                                                                  |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\\\", line 402, in _send                                  |\n|                                      |     raise result                                                                                                                       |\n|                                      | \", \"created\": \"2015-03-04T15:14:48Z\"}                                                                                                  |\n| flavor                               | m1.tiny (1)                                                                                                                            |\n| hostId                               | 8a17e6dfb8afa7a82fa5964edc54bb5355cc46fb73e000bc2b310623                                                                               |\n| id                                   | fd581745-8ecd-4fa2-af80-82493d083b97                                                                                                   |\n| image                                | TestVM (a671fa04-d19c-49d1-888d-9a43412e13ac)                                                                                          |\n| key_name                             | KEY_PAIR                                                                                                                               |\n| metadata                             | {}                                                                                                                                     |\n| name                                 | test_del_bridge                                                                                                                        |\n| novanetwork network                  | 10.0.0.3                                                                                                                               |\n| os-extended-volumes:volumes_attached | []                                                                                                                                     |\n| security_groups                      | default                                                                                                                                |\n| status                               | ERROR                                                                                                                                  |\n| tenant_id                            | dc669bf633ae4bd7b995c885e0428fec                                                                                                       |\n| updated                              | 2015-03-04T15:14:48Z                                                                                                                   |\n| user_id                              | bd2a2c6487484a24937c39740a76e501                                                                                                       |\n+--------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+", 
    "tags": [], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1428182", 
    "owner": "https://api.launchpad.net/1.0/~mhorban", 
    "id": 1428182, 
    "index": 1579, 
    "openned": "2015-03-04 15:29:38.694682+00:00", 
    "created": "2015-03-04 15:29:38.694682+00:00", 
    "title": "Removing network bridge cause ERROR state of instance during deletion", 
    "comments": [
        {
            "content": "Instance moves to ERROR state after deleting this instance\nConfiguration:\n  1. network_manager = nova.network.manager.VlanManager\n  2. teardown_unused_network_gateway = true\nSteps to reproduce:\n  1. launch instance\n  2. remove instance\nExpected result:\ninstance is removed without error\nActual result:\ninstance is not removed, instance' state become ERROR:\nroot@node-1:~# nova list\n+--------------------------------------+-----------------+--------+------------+-------------+----------------------+\n| ID                                   | Name            | Status | Task State | Power State | Networks             |\n+--------------------------------------+-----------------+--------+------------+-------------+----------------------+\n| fd581745-8ecd-4fa2-af80-82493d083b97 | test_del_bridge | ERROR  | deleting   | Running     | novanetwork=10.0.0.3 |\n+--------------------------------------+-----------------+--------+------------+-------------+----------------------+\nroot@node-1:~# nova show fd581745-8ecd-4fa2-af80-82493d083b97\n+--------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+\n| Property                             | Value                                                                                                                                  |\n+--------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                                                                                                 |\n| OS-EXT-AZ:availability_zone          | nova                                                                                                                                   |\n| OS-EXT-SRV-ATTR:host                 | node-2                                                                                                                                 |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | node-2                                                                                                                                 |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000002                                                                                                                      |\n| OS-EXT-STS:power_state               | 1                                                                                                                                      |\n| OS-EXT-STS:task_state                | deleting                                                                                                                               |\n| OS-EXT-STS:vm_state                  | error                                                                                                                                  |\n| OS-SRV-USG:launched_at               | 2015-03-04T15:14:44.000000                                                                                                             |\n| OS-SRV-USG:terminated_at             | -                                                                                                                                      |\n| accessIPv4                           |                                                                                                                                        |\n| accessIPv6                           |                                                                                                                                        |\n| config_drive                         |                                                                                                                                        |\n| created                              | 2015-03-04T15:14:40Z                                                                                                                   |\n| fault                                | {\"message\": \"Remote error: ProcessExecutionError Unexpected error while running command.                                               |\n|                                      | Command: sudo nova-rootwrap /etc/nova/rootwrap.conf dhcp_release br103 10.0.0.3 fa:16:3e:d2:1c:9a                                      |\n|                                      | Exit code: 1                                                                                                                           |\n|                                      | Stdout: ''                                                                                                                             |\n|                                      | Stderr: 'cannot setup interface: No such device\\                                                                                       |\n|                                      | '                                                                                                                                      |\n|                                      | [u'Tra\", \"code\": 500, \"details\": \"  File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 296, in decorated_function |\n|                                      |     return function(self, context, *args, **kwargs)                                                                                    |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2262, in terminate_instance                                  |\n|                                      |     do_terminate_instance(instance, bdms)                                                                                              |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/openstack/common/lockutils.py\\\", line 249, in inner                                     |\n|                                      |     return f(*args, **kwargs)                                                                                                          |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2260, in do_terminate_instance                               |\n|                                      |     self._set_instance_error_state(context, instance['uuid'])                                                                          |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\\\", line 68, in __exit__                                    |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                       |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2250, in do_terminate_instance                               |\n|                                      |     reservations=reservations)                                                                                                         |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/hooks.py\\\", line 103, in inner                                                          |\n|                                      |     rv = f(*args, **kwargs)                                                                                                            |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2220, in _delete_instance                                    |\n|                                      |     user_id=user_id)                                                                                                                   |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\\\", line 68, in __exit__                                    |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                       |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2190, in _delete_instance                                    |\n|                                      |     self._shutdown_instance(context, db_inst, bdms)                                                                                    |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2127, in _shutdown_instance                                  |\n|                                      |     self._try_deallocate_network(context, instance, requested_networks)                                                                |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2086, in _try_deallocate_network                             |\n|                                      |     self._set_instance_error_state(context, instance['uuid'])                                                                          |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/openstack/common/excutils.py\\\", line 68, in __exit__                                    |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                       |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2081, in _try_deallocate_network                             |\n|                                      |     self._deallocate_network(context, instance, requested_networks)                                                                    |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 1775, in _deallocate_network                                 |\n|                                      |     context, instance, requested_networks=requested_networks)                                                                          |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/network/api.py\\\", line 94, in wrapped                                                   |\n|                                      |     return func(self, context, *args, **kwargs)                                                                                        |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/network/api.py\\\", line 318, in deallocate_for_instance                                  |\n|                                      |     requested_networks=requested_networks)                                                                                             |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/network/rpcapi.py\\\", line 190, in deallocate_for_instance                               |\n|                                      |     return cctxt.call(ctxt, 'deallocate_for_instance', **kwargs)                                                                       |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\\\", line 150, in call                                            |\n|                                      |     wait_for_reply=True, timeout=timeout)                                                                                              |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/oslo/messaging/transport.py\\\", line 90, in _send                                             |\n|                                      |     timeout=timeout)                                                                                                                   |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\\\", line 409, in send                                   |\n|                                      |     return self._send(target, ctxt, message, wait_for_reply, timeout)                                                                  |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\\\", line 402, in _send                                  |\n|                                      |     raise result                                                                                                                       |\n|                                      | \", \"created\": \"2015-03-04T15:14:48Z\"}                                                                                                  |\n| flavor                               | m1.tiny (1)                                                                                                                            |\n| hostId                               | 8a17e6dfb8afa7a82fa5964edc54bb5355cc46fb73e000bc2b310623                                                                               |\n| id                                   | fd581745-8ecd-4fa2-af80-82493d083b97                                                                                                   |\n| image                                | TestVM (a671fa04-d19c-49d1-888d-9a43412e13ac)                                                                                          |\n| key_name                             | KEY_PAIR                                                                                                                               |\n| metadata                             | {}                                                                                                                                     |\n| name                                 | test_del_bridge                                                                                                                        |\n| novanetwork network                  | 10.0.0.3                                                                                                                               |\n| os-extended-volumes:volumes_attached | []                                                                                                                                     |\n| security_groups                      | default                                                                                                                                |\n| status                               | ERROR                                                                                                                                  |\n| tenant_id                            | dc669bf633ae4bd7b995c885e0428fec                                                                                                       |\n| updated                              | 2015-03-04T15:14:48Z                                                                                                                   |\n| user_id                              | bd2a2c6487484a24937c39740a76e501                                                                                                       |\n+--------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+", 
            "date_created": "2015-03-04 15:29:38.694682+00:00", 
            "author": "https://api.launchpad.net/1.0/~mhorban"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/161289", 
            "date_created": "2015-03-04 16:10:32.938472+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "There is a second bug here, that the fault field contains a traceback. Users should never see Python tracebacks in the fault field in `nova show <UUID>`...", 
            "date_created": "2015-03-25 18:34:40.450582+00:00", 
            "author": "https://api.launchpad.net/1.0/~jaypipes"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/161289\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ba08070540431828fb3c741b499b1d3db7f873ed\nSubmitter: Jenkins\nBranch:    master\n\ncommit ba08070540431828fb3c741b499b1d3db7f873ed\nAuthor: Marian Horban <email address hidden>\nDate:   Wed Mar 4 10:58:19 2015 -0500\n\n    Releasing DHCP in nova-network fixed\n    \n    Added checking if device exists before executing\n    `dhcp_release dev` command.\n    \n    Change-Id: I1fcd6f817121fb63608e166043ae37f185f2d4b6\n    Closes-Bug: #1428182\n", 
            "date_created": "2015-03-25 20:45:17.493145+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-04-10 09:22:23.675872+00:00"
}