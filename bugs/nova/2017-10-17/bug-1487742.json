{
    "status": "Fix Released", 
    "last_updated": "2017-06-16 12:13:41.147309+00:00", 
    "description": "Glance does not accept 'None' as a valid value for the 'size' property [1].  However, in certain situations Nova is sending a 'size' property with a 'None' value.  This results in a 400 response from Glance to Nova, and the following backtrace in Glance:\n\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images Traceback (most recent call last):\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images   File \"/usr/lib/python2.7/site-packages/glance/api/v1/images.py\", line 1144, in _deserialize\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images     result['image_meta'] = utils.get_image_meta_from_headers(request)\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images   File \"/usr/lib/python2.7/site-packages/glance/common/utils.py\", line 322, in get_image_meta_from_headers\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images     extra_msg=extra)\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images InvalidParameterValue: Invalid value 'None' for parameter 'size': Cannot convert image size 'None' to an integer.\n\nI believe what's happening is Nova tries to enforce certain required properties when creating or updating an image, and in the process reconciling those with the properties that Glance already has (through the _translate_from_glance() [2] and _extract_attributes() [3] methods in nova/image/glance.py)\n\nNova is enforcing the 'size' property being in place [4], but if Glance does not already have a 'size' property on the image (like if the image has been queued but not uploaded yet), the value gets set to 'None' on the Nova side [5].  This gets sent to Glance in subsequent calls, and it fails because 'None' cannot be converted to an integer (see backtrace above.)\n\n\nSteps to Reproduce:\n\nNova and Glance 2015.1.1\n\n1.  Queue a new image in Glance\n2.  Attempt to set a metadata attribute on that image (this will fail with 400 error from Glance)\n3.  Actually upload the image data sometime later\n\n\nPotential Solution:\n\nI've patched this locally to simply check that the 'size' property gets set to 0 instead of 'None' on the Nova side.  I am not familiar enough with all the internals here to understand if that's the \"right\" solution, but I can confirm it's working for us and this bug is no longer triggered.\n\n\n[1] https://github.com/openstack/glance/blob/2015.1.1/glance/common/utils.py#L305-L319\n[2] https://github.com/openstack/nova/blob/2015.1.1/nova/image/glance.py#L482\n[3] https://github.com/openstack/nova/blob/2015.1.1/nova/image/glance.py#L533\n[4] https://github.com/openstack/nova/blob/2015.1.1/nova/image/glance.py#L539\n[5] https://github.com/openstack/nova/blob/2015.1.1/nova/image/glance.py#L571", 
    "tags": [], 
    "importance": "High", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1487742", 
    "owner": "https://api.launchpad.net/1.0/~zhengzhenyu", 
    "id": 1487742, 
    "index": 1800, 
    "openned": "2015-08-22 16:52:47.530610+00:00", 
    "created": "2015-08-22 16:52:47.530610+00:00", 
    "title": "Nova passing bad 'size' property value 'None' to Glance for images", 
    "comments": [
        {
            "content": "Glance does not accept 'None' as a valid value for the 'size' property [1].  However, in certain situations Nova is sending a 'size' property with a 'None' value.  This results in a 400 response from Glance to Nova, and the following backtrace in Glance:\n\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images Traceback (most recent call last):\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images   File \"/usr/lib/python2.7/site-packages/glance/api/v1/images.py\", line 1144, in _deserialize\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images     result['image_meta'] = utils.get_image_meta_from_headers(request)\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images   File \"/usr/lib/python2.7/site-packages/glance/common/utils.py\", line 322, in get_image_meta_from_headers\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images     extra_msg=extra)\n2015-08-21 14:54:17.916 10446 TRACE glance.api.v1.images InvalidParameterValue: Invalid value 'None' for parameter 'size': Cannot convert image size 'None' to an integer.\n\nI believe what's happening is Nova tries to enforce certain required properties when creating or updating an image, and in the process reconciling those with the properties that Glance already has (through the _translate_from_glance() [2] and _extract_attributes() [3] methods in nova/image/glance.py)\n\nNova is enforcing the 'size' property being in place [4], but if Glance does not already have a 'size' property on the image (like if the image has been queued but not uploaded yet), the value gets set to 'None' on the Nova side [5].  This gets sent to Glance in subsequent calls, and it fails because 'None' cannot be converted to an integer (see backtrace above.)\n\n\nSteps to Reproduce:\n\nNova and Glance 2015.1.1\n\n1.  Queue a new image in Glance\n2.  Attempt to set a metadata attribute on that image (this will fail with 400 error from Glance)\n3.  Actually upload the image data sometime later\n\n\nPotential Solution:\n\nI've patched this locally to simply check that the 'size' property gets set to 0 instead of 'None' on the Nova side.  I am not familiar enough with all the internals here to understand if that's the \"right\" solution, but I can confirm it's working for us and this bug is no longer triggered.\n\n\n[1] https://github.com/openstack/glance/blob/2015.1.1/glance/common/utils.py#L305-L319\n[2] https://github.com/openstack/nova/blob/2015.1.1/nova/image/glance.py#L482\n[3] https://github.com/openstack/nova/blob/2015.1.1/nova/image/glance.py#L533\n[4] https://github.com/openstack/nova/blob/2015.1.1/nova/image/glance.py#L539\n[5] https://github.com/openstack/nova/blob/2015.1.1/nova/image/glance.py#L571", 
            "date_created": "2015-08-22 16:52:47.530610+00:00", 
            "author": "https://api.launchpad.net/1.0/~mdorman-m"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/215947", 
            "date_created": "2015-08-22 17:04:36.368122+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/215947\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=cc7f0bc038915c2a765bcdd17342ad12ac92e43c\nSubmitter: Jenkins\nBranch:    master\n\ncommit cc7f0bc038915c2a765bcdd17342ad12ac92e43c\nAuthor: Mike Dorman <email address hidden>\nDate:   Sat Aug 22 10:00:16 2015 -0700\n\n    Ensure Glance image 'size' attribute is 0, not 'None'\n    \n    Make sure that if the 'size' attribute for an image does not\n    exist in Glance, that we set the value to 0 and not 'None'.\n    Glance does not accept 'None' as a valid value for the 'size'\n    attribute.\n    \n    Co-Authored-By:Kevin_Zheng<email address hidden>\n    \n    Change-Id: I8c6a8749d86a22eb2d2e1e84ce6a2b9a4a4992ee\n    Closes-bug: 1487742\n", 
            "date_created": "2015-12-18 16:05:28.652228+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/liberty\nReview: https://review.openstack.org/272536", 
            "date_created": "2016-01-26 13:34:33.030804+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/272536\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=14440aabf49c7169366166dc347070e38a211c2d\nSubmitter: Jenkins\nBranch:    stable/liberty\n\ncommit 14440aabf49c7169366166dc347070e38a211c2d\nAuthor: Mike Dorman <email address hidden>\nDate:   Sat Aug 22 10:00:16 2015 -0700\n\n    Ensure Glance image 'size' attribute is 0, not 'None'\n    \n    Make sure that if the 'size' attribute for an image does not\n    exist in Glance, that we set the value to 0 and not 'None'.\n    Glance does not accept 'None' as a valid value for the 'size'\n    attribute.\n    \n    Co-Authored-By:Kevin_Zheng<email address hidden>\n    \n    Change-Id: I8c6a8749d86a22eb2d2e1e84ce6a2b9a4a4992ee\n    Closes-bug: 1487742\n    (cherry picked from commit cc7f0bc038915c2a765bcdd17342ad12ac92e43c)\n", 
            "date_created": "2016-02-16 03:22:38.100884+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-12-18 16:05:26.831260+00:00"
}