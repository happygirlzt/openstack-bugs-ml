{
    "status": "Invalid", 
    "last_updated": "2016-05-06 11:25:53.399935+00:00", 
    "description": "According to description of cpu_thread_policy:\n\n ``isolate``: The host must not have an SMT architecture or must emulate\n    a non-SMT architecture. If the host does not have an SMT architecture,\n    each vCPU is placed on a different core as expected. If the host does\n   have an SMT architecture - that is, one or more cores have thread\n   siblings - then each vCPU is placed on a different physical core. No\n   vCPUs from other guests are placed on the same core. All but one thread\n    sibling on each utilized core is therefore guaranteed to be unusable.\n\nHaving 20 threads available to allocate 10 isolated vCPUs:\n\nnova flavor-create isolated auto 1024 10 5\nnova flavor-key isolated set hw:cpu_policy=dedicated\nnova flavor-key isolated set hw:cpu_thread_policy=isolate\nnova flavor-key isolated set hw:numa_nodes=1\nnova boot testIso1 --flavor isolated --image cirros --nic net-id=$NET_ID\nnova boot testIso2 --flavor isolated --image cirros --nic net-id=$NET_ID\n\n\n# virsh vcpupin 2\nVCPU: CPU Affinity\n----------------------------------\n   0: 10\n   1: 16\n   2: 8\n   3: 18\n   4: 2\n\n\n# virsh vcpupin 3\nVCPU: CPU Affinity\n----------------------------------\n   0: 17\n   1: 3\n   2: 11\n   3: 9\n   4: 19\n\n\nCheking CPU topology:\n\nNUMANode L#0 (P#0 32GB)\n    Socket L#0 + L3 L#0 (15MB)\n      L2 L#0 (256KB) + L1d L#0 (32KB) + L1i L#0 (32KB) + Core L#0\n        PU L#0 (P#0)\n        PU L#1 (P#12)\n      L2 L#1 (256KB) + L1d L#1 (32KB) + L1i L#1 (32KB) + Core L#1\n        PU L#2 (P#2)\n        PU L#3 (P#14)\n      L2 L#2 (256KB) + L1d L#2 (32KB) + L1i L#2 (32KB) + Core L#2\n        PU L#4 (P#4)\n        PU L#5 (P#16)\n      L2 L#3 (256KB) + L1d L#3 (32KB) + L1i L#3 (32KB) + Core L#3\n        PU L#6 (P#6)\n        PU L#7 (P#18)\n      L2 L#4 (256KB) + L1d L#4 (32KB) + L1i L#4 (32KB) + Core L#4\n        PU L#8 (P#8)\n        PU L#9 (P#20)\n      L2 L#5 (256KB) + L1d L#5 (32KB) + L1i L#5 (32KB) + Core L#5\n        PU L#10 (P#10)\n        PU L#11 (P#22)\n\n  NUMANode L#1 (P#1 32GB) + Socket L#1 + L3 L#1 (15MB)\n    L2 L#6 (256KB) + L1d L#6 (32KB) + L1i L#6 (32KB) + Core L#6\n      PU L#12 (P#1)\n      PU L#13 (P#13)\n    L2 L#7 (256KB) + L1d L#7 (32KB) + L1i L#7 (32KB) + Core L#7\n      PU L#14 (P#3)\n      PU L#15 (P#15)\n    L2 L#8 (256KB) + L1d L#8 (32KB) + L1i L#8 (32KB) + Core L#8\n      PU L#16 (P#5)\n      PU L#17 (P#17)\n    L2 L#9 (256KB) + L1d L#9 (32KB) + L1i L#9 (32KB) + Core L#9\n      PU L#18 (P#7)\n      PU L#19 (P#19)\n    L2 L#10 (256KB) + L1d L#10 (32KB) + L1i L#10 (32KB) + Core L#10\n      PU L#20 (P#9)\n      PU L#21 (P#21)\n    L2 L#11 (256KB) + L1d L#11 (32KB) + L1i L#11 (32KB) + Core L#11\n      PU L#22 (P#11)\n      PU L#23 (P#23)\n\nNow, we have allocated 10 vCPUs in an isolated way (take into account that threads number 1,13 and 0,12 are not available)\n\nIf we boot a VM with only one vCPU in an isolated way, it will give an error (so expected behaviour):\n\nnova flavor-create iso auto 1024 10 1\nnova flavor-key iso set hw:cpu_policy=dedicated\nnova flavor-key iso set hw:cpu_thread_policy=isolate\nnova flavor-key iso set hw:numa_nodes=1\nnova boot testI --flavor iso --image cirros --nic net-id=$NET_ID\n\nIf we boot a VM with one vCPU with m1.tiny flavor, it will be allowed:\n\nnova boot test --flavor 1 --image cirros --nic net-id=$NET_ID\n\n# nova list\n+--------------------------------------+----------+--------+------------+-------------+-----------------+\n| ID                                   | Name     | Status | Task State | Power State | Networks        |\n+--------------------------------------+----------+--------+------------+-------------+-----------------+\n| a669fbca-0607-44b5-b167-da49edf0276b | test     | ACTIVE | -          | Running     | om=192.168.1.17 |\n| 783a013c-78b8-4b66-89d9-eaab4e4d0ade | testI    | ERROR  | -          | NOSTATE     |                 |\n| 66e4a64d-b55e-4b37-94b9-c7330118467e | testIso1 | ACTIVE | -          | Running     | om=192.168.1.15 |\n| cd5e51b3-de30-4765-b407-a707385cb45c | testIso2 | ACTIVE | -          | Running     | om=192.168.1.16 |\n+--------------------------------------+----------+--------+------------+-------------+-----------------+\n\n# virsh vcpupin 4\nVCPU: CPU Affinity\n----------------------------------\n   0: 2-11,14-23\n\nSo vCPUs are not properly isolated", 
    "tags": [
        "cpu", 
        "pinning", 
        "policy", 
        "thread"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1578150", 
    "owner": "None", 
    "id": 1578150, 
    "index": 7458, 
    "openned": "2016-05-04 11:07:03.710563+00:00", 
    "created": "2016-05-04 10:40:51.339439+00:00", 
    "title": "hw:cpu_thread_policy=isolated allows allocation of siblings", 
    "comments": [
        {
            "content": "According to description of cpu_thread_policy:\n\n ``isolate``: The host must not have an SMT architecture or must emulate\n    a non-SMT architecture. If the host does not have an SMT architecture,\n    each vCPU is placed on a different core as expected. If the host does\n   have an SMT architecture - that is, one or more cores have thread\n   siblings - then each vCPU is placed on a different physical core. No\n   vCPUs from other guests are placed on the same core. All but one thread\n    sibling on each utilized core is therefore guaranteed to be unusable.\n\nHaving 20 threads available to allocate 10 isolated vCPUs:\n\nnova flavor-create isolated auto 1024 10 5\nnova flavor-key isolated set hw:cpu_policy=dedicated\nnova flavor-key isolated set hw:cpu_thread_policy=isolate\nnova flavor-key isolated set hw:numa_nodes=1\nnova boot testIso1 --flavor isolated --image cirros --nic net-id=$NET_ID\nnova boot testIso2 --flavor isolated --image cirros --nic net-id=$NET_ID\n\n\n# virsh vcpupin 2\nVCPU: CPU Affinity\n----------------------------------\n   0: 10\n   1: 16\n   2: 8\n   3: 18\n   4: 2\n\n\n# virsh vcpupin 3\nVCPU: CPU Affinity\n----------------------------------\n   0: 17\n   1: 3\n   2: 11\n   3: 9\n   4: 19\n\n\nCheking CPU topology:\n\nNUMANode L#0 (P#0 32GB)\n    Socket L#0 + L3 L#0 (15MB)\n      L2 L#0 (256KB) + L1d L#0 (32KB) + L1i L#0 (32KB) + Core L#0\n        PU L#0 (P#0)\n        PU L#1 (P#12)\n      L2 L#1 (256KB) + L1d L#1 (32KB) + L1i L#1 (32KB) + Core L#1\n        PU L#2 (P#2)\n        PU L#3 (P#14)\n      L2 L#2 (256KB) + L1d L#2 (32KB) + L1i L#2 (32KB) + Core L#2\n        PU L#4 (P#4)\n        PU L#5 (P#16)\n      L2 L#3 (256KB) + L1d L#3 (32KB) + L1i L#3 (32KB) + Core L#3\n        PU L#6 (P#6)\n        PU L#7 (P#18)\n      L2 L#4 (256KB) + L1d L#4 (32KB) + L1i L#4 (32KB) + Core L#4\n        PU L#8 (P#8)\n        PU L#9 (P#20)\n      L2 L#5 (256KB) + L1d L#5 (32KB) + L1i L#5 (32KB) + Core L#5\n        PU L#10 (P#10)\n        PU L#11 (P#22)\n\n  NUMANode L#1 (P#1 32GB) + Socket L#1 + L3 L#1 (15MB)\n    L2 L#6 (256KB) + L1d L#6 (32KB) + L1i L#6 (32KB) + Core L#6\n      PU L#12 (P#1)\n      PU L#13 (P#13)\n    L2 L#7 (256KB) + L1d L#7 (32KB) + L1i L#7 (32KB) + Core L#7\n      PU L#14 (P#3)\n      PU L#15 (P#15)\n    L2 L#8 (256KB) + L1d L#8 (32KB) + L1i L#8 (32KB) + Core L#8\n      PU L#16 (P#5)\n      PU L#17 (P#17)\n    L2 L#9 (256KB) + L1d L#9 (32KB) + L1i L#9 (32KB) + Core L#9\n      PU L#18 (P#7)\n      PU L#19 (P#19)\n    L2 L#10 (256KB) + L1d L#10 (32KB) + L1i L#10 (32KB) + Core L#10\n      PU L#20 (P#9)\n      PU L#21 (P#21)\n    L2 L#11 (256KB) + L1d L#11 (32KB) + L1i L#11 (32KB) + Core L#11\n      PU L#22 (P#11)\n      PU L#23 (P#23)\n\nNow, we have allocated 10 vCPUs in an isolated way (take into account that threads number 1,13 and 0,12 are not available)\n\nIf we boot a VM with only one vCPU in an isolated way, it will give an error (so expected behaviour):\n\nnova flavor-create iso auto 1024 10 1\nnova flavor-key iso set hw:cpu_policy=dedicated\nnova flavor-key iso set hw:cpu_thread_policy=isolate\nnova flavor-key iso set hw:numa_nodes=1\nnova boot testI --flavor iso --image cirros --nic net-id=$NET_ID\n\nIf we boot a VM with one vCPU with m1.tiny flavor, it will be allowed:\n\nnova boot test --flavor 1 --image cirros --nic net-id=$NET_ID\n\n# nova list\n+--------------------------------------+----------+--------+------------+-------------+-----------------+\n| ID                                   | Name     | Status | Task State | Power State | Networks        |\n+--------------------------------------+----------+--------+------------+-------------+-----------------+\n| a669fbca-0607-44b5-b167-da49edf0276b | test     | ACTIVE | -          | Running     | om=192.168.1.17 |\n| 783a013c-78b8-4b66-89d9-eaab4e4d0ade | testI    | ERROR  | -          | NOSTATE     |                 |\n| 66e4a64d-b55e-4b37-94b9-c7330118467e | testIso1 | ACTIVE | -          | Running     | om=192.168.1.15 |\n| cd5e51b3-de30-4765-b407-a707385cb45c | testIso2 | ACTIVE | -          | Running     | om=192.168.1.16 |\n+--------------------------------------+----------+--------+------------+-------------+-----------------+\n\n# virsh vcpupin 4\nVCPU: CPU Affinity\n----------------------------------\n   0: 2-11,14-23\n\nSo vCPUs are not properly isolated", 
            "date_created": "2016-05-04 10:40:51.339439+00:00", 
            "author": "https://api.launchpad.net/1.0/~rnoriega-b"
        }, 
        {
            "content": "> If we boot a VM with one vCPU with m1.tiny flavor, it will be allowed:\n> \n> nova boot test --flavor 1 --image cirros --nic net-id=$NET_ID\n\nThis is invalid test scenario. When using strict CPU pinning, you are *required* to setup host-aggregates to split your compute hosts into 2 groups. One aggregate is for hosts which have regular floating & over commit CPUs, one aggregrate is for hosts which have dedicated pinned CPUs.\n\nYou do not appear to have setup any such aggregrates so you are trying to run guests with dedicated CPUs on the same host as suggests with over commit floating CPUs. This is not a supported configuration scenario.", 
            "date_created": "2016-05-06 11:25:44.557424+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }
    ], 
    "closed": "2016-05-06 11:25:51.543124+00:00"
}