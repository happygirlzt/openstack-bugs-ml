{
    "status": "Invalid", 
    "last_updated": "2017-09-27 14:12:07.402826+00:00", 
    "description": "It seems the number of attempts to detach interfaces in not enough in some cases.\n\nheat_integrationtests.functional.test_create_update.UpdateStackTest.test_stack_update_with_replacing_userdata\n2016-05-25 10:37:16.151 | 2016-05-25 10:37:16.020 | -------------------------------------------------------------------------------------------------------------\n2016-05-25 10:37:16.151 | 2016-05-25 10:37:16.022 | \n2016-05-25 10:37:16.152 | 2016-05-25 10:37:16.025 | Captured traceback:\n2016-05-25 10:37:16.152 | 2016-05-25 10:37:16.031 | ~~~~~~~~~~~~~~~~~~~\n2016-05-25 10:37:16.152 | 2016-05-25 10:37:16.034 |     Traceback (most recent call last):\n2016-05-25 10:37:16.152 | 2016-05-25 10:37:16.038 |       File \"/opt/stack/new/heat/heat_integrationtests/functional/test_create_update.py\", line 534, in test_stack_update_with_replacing_userdata\n2016-05-25 10:37:16.152 | 2016-05-25 10:37:16.040 |         parameters=parms_updated)\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.044 |       File \"/opt/stack/new/heat/heat_integrationtests/common/test.py\", line 402, in update_stack\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.046 |         self._wait_for_stack_status(**kwargs)\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.048 |       File \"/opt/stack/new/heat/heat_integrationtests/common/test.py\", line 334, in _wait_for_stack_status\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.051 |         fail_regexp):\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.054 |       File \"/opt/stack/new/heat/heat_integrationtests/common/test.py\", line 295, in _verify_status\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.056 |         stack_status_reason=stack.stack_status_reason)\n2016-05-25 10:37:16.154 | 2016-05-25 10:37:16.058 |     heat_integrationtests.common.exceptions.StackBuildErrorException: Stack UpdateStackTest-2129656241/3c284793-623d-47bd-901a-6d71e75bdbca is in UPDATE_FAILED status due to 'InterfaceDetachFailed: resources.server: Failed to detach interface (bdbc4a8c-114b-42c0-a49a-a27311f5f2e2) from server (259f3fff-6e38-4722-9a51-7c7166d78812)'", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1585858", 
    "owner": "None", 
    "id": 1585858, 
    "index": 7506, 
    "openned": "2017-06-06 06:08:52.500841+00:00", 
    "created": "2016-05-26 03:32:48.670692+00:00", 
    "title": "InterfaceDetachFailed: resources.server: Failed to detach interface", 
    "comments": [
        {
            "content": "It seems the number of attempts to detach interfaces in not enough in some cases.\n\nheat_integrationtests.functional.test_create_update.UpdateStackTest.test_stack_update_with_replacing_userdata\n2016-05-25 10:37:16.151 | 2016-05-25 10:37:16.020 | -------------------------------------------------------------------------------------------------------------\n2016-05-25 10:37:16.151 | 2016-05-25 10:37:16.022 | \n2016-05-25 10:37:16.152 | 2016-05-25 10:37:16.025 | Captured traceback:\n2016-05-25 10:37:16.152 | 2016-05-25 10:37:16.031 | ~~~~~~~~~~~~~~~~~~~\n2016-05-25 10:37:16.152 | 2016-05-25 10:37:16.034 |     Traceback (most recent call last):\n2016-05-25 10:37:16.152 | 2016-05-25 10:37:16.038 |       File \"/opt/stack/new/heat/heat_integrationtests/functional/test_create_update.py\", line 534, in test_stack_update_with_replacing_userdata\n2016-05-25 10:37:16.152 | 2016-05-25 10:37:16.040 |         parameters=parms_updated)\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.044 |       File \"/opt/stack/new/heat/heat_integrationtests/common/test.py\", line 402, in update_stack\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.046 |         self._wait_for_stack_status(**kwargs)\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.048 |       File \"/opt/stack/new/heat/heat_integrationtests/common/test.py\", line 334, in _wait_for_stack_status\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.051 |         fail_regexp):\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.054 |       File \"/opt/stack/new/heat/heat_integrationtests/common/test.py\", line 295, in _verify_status\n2016-05-25 10:37:16.153 | 2016-05-25 10:37:16.056 |         stack_status_reason=stack.stack_status_reason)\n2016-05-25 10:37:16.154 | 2016-05-25 10:37:16.058 |     heat_integrationtests.common.exceptions.StackBuildErrorException: Stack UpdateStackTest-2129656241/3c284793-623d-47bd-901a-6d71e75bdbca is in UPDATE_FAILED status due to 'InterfaceDetachFailed: resources.server: Failed to detach interface (bdbc4a8c-114b-42c0-a49a-a27311f5f2e2) from server (259f3fff-6e38-4722-9a51-7c7166d78812)'", 
            "date_created": "2016-05-26 03:32:48.670692+00:00", 
            "author": "https://api.launchpad.net/1.0/~rabi"
        }, 
        {
            "content": "I can't find this happening in the gate. Can you paste the error from the nova logs when the detach fails?", 
            "date_created": "2016-08-02 23:53:01.702333+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-stevebaker"
        }, 
        {
            "content": "This backtrace is from one of the gate failures. I had seen it a few times though not seen it latey.  Don't remember seeing anything wrong in the nova logs. ", 
            "date_created": "2016-08-03 01:09:50.240683+00:00", 
            "author": "https://api.launchpad.net/1.0/~rabi"
        }, 
        {
            "content": "[Expired for heat because there has been no activity for 60 days.]", 
            "date_created": "2016-10-02 04:18:32.460610+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }, 
        {
            "content": "I can see this happening at the gate. Few instances in the last few days.\n\nhttp://logs.openstack.org/67/435667/3/check/gate-heat-dsvm-functional-convg-mysql-lbaasv2-non-apache-ubuntu-xenial/222b75a/console.html#_2017-06-02_06_27_24_605978\n\nn-cpu.log taceback:\n\nJun 02 06:04:26.077784 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]: ERROR oslo_messaging.rpc.server [None req-1a11865d-b2b1-49a1-871b-49f344268002 demo demo] Exception during message handling: InstanceInfoCacheNotFound_Remote: Info cache for instance c1825e65-99fc-4a37-9d36-26f52a0699ea could not be found.\nJun 02 06:04:26.077900 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]: Traceback (most recent call last):\nJun 02 06:04:26.077987 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]:   File \"/opt/stack/new/nova/nova/conductor/manager.py\", line 123, in _object_dispatch\nJun 02 06:04:26.078070 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]:     return getattr(target, method)(*args, **kwargs)\nJun 02 06:04:26.078154 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]:   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 226, in wrapper\nJun 02 06:04:26.078244 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]:     return fn(self, *args, **kwargs)\nJun 02 06:04:26.078323 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]:   File \"/opt/stack/new/nova/nova/objects/instance_info_cache.py\", line 111, in refresh\nJun 02 06:04:26.078406 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]:     self.instance_uuid)\nJun 02 06:04:26.078488 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]:   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 184, in wrapper\nJun 02 06:04:26.078664 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]:     result = fn(cls, context, *args, **kwargs)\nJun 02 06:04:26.078743 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]:   File \"/opt/stack/new/nova/nova/objects/instance_info_cache.py\", line 72, in get_by_instance_uuid\nJun 02 06:04:26.078820 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]:     instance_uuid=instance_uuid)\nJun 02 06:04:26.078928 ubuntu-xenial-osic-cloud1-s3500-9097966 nova-compute[2919]: InstanceInfoCacheNotFound: Info cache for instance c1825e65-99fc-4a37-9d36-26f52a0699ea could not be found.\n\nhttp://logs.openstack.org/67/435667/3/check/gate-heat-dsvm-functional-convg-mysql-lbaasv2-non-apache-ubuntu-xenial/222b75a/logs/screen-n-cpu.txt.gz?level=ERROR#_Jun_02_06_04_26_078928\n\nLooks like something weird is happening. Server is destoyed and interfaces gone before even we prepare_for_replace (detach interfaces).", 
            "date_created": "2017-06-02 07:25:46.699714+00:00", 
            "author": "https://api.launchpad.net/1.0/~rabi"
        }, 
        {
            "content": "This is happening very frequently now. Every time with a different libvirt error. \n\nLike the one below:\n\nhttp://logs.openstack.org/93/462293/3/gate/gate-heat-dsvm-functional-convg-mysql-lbaasv2-non-apache-ubuntu-xenial/ea8c446/logs/screen-n-cpu.txt.gz?level=ERROR\n\n\nJun 06 05:25:27.340500 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall [-] Dynamic interval looping call 'oslo_service.loopingcall._func' failed: libvirtError: internal error: End of file from qemu monitor\nJun 06 05:25:27.340614 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall Traceback (most recent call last):\nJun 06 05:25:27.340696 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/usr/local/lib/python2.7/dist-packages/oslo_service/loopingcall.py\", line 137, in _run_loop\nJun 06 05:25:27.340773 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     result = func(*self.args, **self.kw)\nJun 06 05:25:27.340850 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/usr/local/lib/python2.7/dist-packages/oslo_service/loopingcall.py\", line 394, in _func\nJun 06 05:25:27.340927 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     result = f(*args, **kwargs)\nJun 06 05:25:27.341001 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/opt/stack/new/nova/nova/virt/libvirt/guest.py\", line 446, in _do_wait_and_retry_detach\nJun 06 05:25:27.341091 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     _try_detach_device(config, persistent=False, live=live)\nJun 06 05:25:27.341172 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/opt/stack/new/nova/nova/virt/libvirt/guest.py\", line 427, in _try_detach_device\nJun 06 05:25:27.341257 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     device=alternative_device_name)\nJun 06 05:25:27.341347 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 220, in __exit__\nJun 06 05:25:27.341424 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     self.force_reraise()\nJun 06 05:25:27.341509 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 196, in force_reraise\nJun 06 05:25:27.341602 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     six.reraise(self.type_, self.value, self.tb)\nJun 06 05:25:27.341688 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/opt/stack/new/nova/nova/virt/libvirt/guest.py\", line 407, in _try_detach_device\nJun 06 05:25:27.341766 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     self.detach_device(conf, persistent=persistent, live=live)\nJun 06 05:25:27.341843 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/opt/stack/new/nova/nova/virt/libvirt/guest.py\", line 471, in detach_device\nJun 06 05:25:27.341930 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     self._domain.detachDeviceFlags(device_xml, flags=flags)\nJun 06 05:25:27.342391 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\nJun 06 05:25:27.342483 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     result = proxy_call(self._autowrap, f, *args, **kwargs)\nJun 06 05:25:27.342570 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\nJun 06 05:25:27.342661 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     rv = execute(f, *args, **kwargs)\nJun 06 05:25:27.342738 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\nJun 06 05:25:27.342814 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     six.reraise(c, e, tb)\nJun 06 05:25:27.342897 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\nJun 06 05:25:27.342985 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     rv = meth(*args, **kwargs)\nJun 06 05:25:27.343068 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall   File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 1215, in detachDeviceFlags\nJun 06 05:25:27.343149 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall     if ret == -1: raise libvirtError ('virDomainDetachDeviceFlags() failed', dom=self)\nJun 06 05:25:27.343224 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall libvirtError: internal error: End of file from qemu monitor\nJun 06 05:25:27.343298 ubuntu-xenial-osic-cloud1-s3500-9151671 nova-compute[4359]: ERROR oslo.service.loopingcall \n", 
            "date_created": "2017-06-06 06:08:33.172401+00:00", 
            "author": "https://api.launchpad.net/1.0/~rabi"
        }, 
        {
            "content": "This bug might be related to this one: \n\nhttps://bugs.launchpad.net/neutron/+bug/1696006", 
            "date_created": "2017-06-06 15:51:56.885257+00:00", 
            "author": "https://api.launchpad.net/1.0/~minsel"
        }, 
        {
            "content": "\"libvirtError: internal error: End of file from qemu monitor\" is different from bug 1696006. Also, I assume this job is using neutron + ovs rather than linuxbridge, which was the issue in bug 1696006.\n\nIs libvirt crashing? Is the instance being deleted while the interface is being detached? i.e. is the test running those concurrently?", 
            "date_created": "2017-06-14 01:47:52.601730+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Yes this job is using OVS. We start unplugging the vif here:\n\nhttp://logs.openstack.org/93/462293/3/gate/gate-heat-dsvm-functional-convg-mysql-lbaasv2-non-apache-ubuntu-xenial/ea8c446/logs/screen-n-cpu.txt.gz?level=DEBUG#_Jun_06_05_25_10_121414\n\nThen we start detaching the interface device from the guest here:\n\nhttp://logs.openstack.org/93/462293/3/gate/gate-heat-dsvm-functional-convg-mysql-lbaasv2-non-apache-ubuntu-xenial/ea8c446/logs/screen-n-cpu.txt.gz?level=DEBUG#_Jun_06_05_25_10_249230\n\nThen that fails eventually because the guest is gone:\n\nhttp://logs.openstack.org/93/462293/3/gate/gate-heat-dsvm-functional-convg-mysql-lbaasv2-non-apache-ubuntu-xenial/ea8c446/logs/screen-n-cpu.txt.gz?level=DEBUG#_Jun_06_05_25_27_345226\n\nYou can see the instance being terminated at the same time:\n\nhttp://logs.openstack.org/93/462293/3/gate/gate-heat-dsvm-functional-convg-mysql-lbaasv2-non-apache-ubuntu-xenial/ea8c446/logs/screen-n-cpu.txt.gz?level=DEBUG#_Jun_06_05_25_22_366871\n\nSo you get an ugly stacktrace in the logs but it should cause things to fail, unless the test is expecting something it shouldn't.", 
            "date_created": "2017-06-14 01:52:29.747421+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I'm marking this as invalid for nova for the time being since I'm not sure what your testing is doing, or how it expects to behave, but it certainly looks like it's deleting the instance at the same time as detaching the interfaces, which is fine, but I'm not sure what it's polling to check to see when the interface is detached - is it polling the neutron port status?", 
            "date_created": "2017-06-14 01:54:04.848258+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Well the test is very simple where you replace the user_data and the server gets replaced. \n\nSo the steps heat is doing:\n\n1. Detach the ports from the existing server\n2. Create the new server\n3. Attach the already detached ports to the new server\n4. Delete the old server\n\nI assume this should work with nova, no? \n\nSo I think the issue is, we  create a server  in the test and then replace it immediately. It seems after heat assumes the server is created and then goes ahead with the replace flow, nova finds some issue in with the server(still in the create flow) and then goes ahead and destroys it.\n\nI'm sure there is some nova/libvirt issue here.\n\nFYI, this test has been around for years and we see this issue from time to time. ", 
            "date_created": "2017-06-14 02:41:50.230161+00:00", 
            "author": "https://api.launchpad.net/1.0/~rabi"
        }, 
        {
            "content": "This issue has returned with a vengeance since yesterday, to the point where it's basically blocking the heat gate:\n\nhttp://logstash.openstack.org/#dashboard/file/logstash.json?query=message%3A%5C%22InterfaceDetachFailed%3A%20resources.server%3A%20Failed%20to%20detach%20interface%5C%22", 
            "date_created": "2017-09-26 16:42:11.935223+00:00", 
            "author": "https://api.launchpad.net/1.0/~zaneb"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/507635", 
            "date_created": "2017-09-26 17:35:03.781613+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/507635\nCommitted: https://git.openstack.org/cgit/openstack/heat/commit/?id=166ac7869fbef4bc88ee5d26e72c7e01d5e581e2\nSubmitter: Jenkins\nBranch:    master\n\ncommit 166ac7869fbef4bc88ee5d26e72c7e01d5e581e2\nAuthor: Zane Bitter <email address hidden>\nDate:   Tue Sep 26 13:26:13 2017 -0400\n\n    Increase interface detach polling period\n    \n    The gate has started failing due to interface detaches timing out.\n    Examining the logs, it looks like Nova's interface detach retry takes about\n    6s to run one attempt. Heat, on the other hand, does 10 retries at 0.5s\n    intervals. So if Nova has to retry then Heat will fail.\n    \n    Increase Heat's polling interval to make it more likely that if Nova\n    succeeds, Heat will see it.\n    \n    Change-Id: Ie74980a3f806b8c17e4e494ae979725b0078f135\n    Closes-Bug: #1585858\n", 
            "date_created": "2017-09-27 01:36:08.881979+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/507869", 
            "date_created": "2017-09-27 14:12:06.280025+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-06-14 01:53:11.301469+00:00"
}