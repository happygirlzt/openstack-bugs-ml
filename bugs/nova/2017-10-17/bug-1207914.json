{
    "status": "Fix Released", 
    "last_updated": "2015-12-03 20:38:53.454596+00:00", 
    "description": "From nova-compute log when exceeding a quota.\n\n/json; charset=UTF-8'} {\"NeutronError\": \"Quota exceeded for resources: ['port']\"}\n http_log_resp /opt/stack/python-neutronclient/neutronclient/common/utils.py:179\n2013-08-02 21:30:38.115 30306 DEBUG neutronclient.v2_0.client [-] Error message: {\"NeutronError\": \"Quota exceeded for resources: ['port']\"} _handle_fault_response /opt/stack/python-neutronclient/neutronclient/v2_0/client.py:756\n2013-08-02 21:30:38.115 30306 ERROR nova.compute.manager [-] Instance failed network setup after 1 attempt(s)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager Traceback (most recent call last):\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 1280, in _allocate_network_async\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     security_groups=security_groups)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/network/api.py\", line 49, in wrapper\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     res = f(self, context, *args, **kwargs)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 310, in allocate_for_instance\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     LOG.exception(msg, port_id)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 287, in allocate_for_instance\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     port_client.create_port(port_req_body)['port']['id'])\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 108, in with_params\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     ret = self.function(instance, *args, **kwargs)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 276, in create_port\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     return self.post(self.ports_path, body=body)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 872, in post\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     headers=headers, params=params)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 795, in do_request\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     self._handle_fault_response(status_code, replybody)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 765, in _handle_fault_response\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     exception_handler_v20(status_code, des_error_body)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 81, in exception_handler_v20\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     message=error_dict)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager NeutronClientException: Quota exceeded for resources: ['port']\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/poll.py\", line 97, in wait\n    readers.get(fileno, noop).cb(fileno)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n\n\nFurthermore nova doesn't show its a quota issue but instead says:\n\n| fault                                | {u'message': u'NoValidHost', u'code': 500, u'created': u'2013-08-02T21:31:04Z'} |", 
    "tags": [
        "network"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1207914", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1207914, 
    "index": 3518, 
    "openned": "2013-08-02 22:28:48.544863+00:00", 
    "created": "2013-08-02 22:28:48.544863+00:00", 
    "title": "nova stacktraces when neutron throws a quota error", 
    "comments": [
        {
            "content": "From nova-compute log when exceeding a quota.\n\n/json; charset=UTF-8'} {\"NeutronError\": \"Quota exceeded for resources: ['port']\"}\n http_log_resp /opt/stack/python-neutronclient/neutronclient/common/utils.py:179\n2013-08-02 21:30:38.115 30306 DEBUG neutronclient.v2_0.client [-] Error message: {\"NeutronError\": \"Quota exceeded for resources: ['port']\"} _handle_fault_response /opt/stack/python-neutronclient/neutronclient/v2_0/client.py:756\n2013-08-02 21:30:38.115 30306 ERROR nova.compute.manager [-] Instance failed network setup after 1 attempt(s)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager Traceback (most recent call last):\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/compute/manager.py\", line 1280, in _allocate_network_async\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     security_groups=security_groups)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/network/api.py\", line 49, in wrapper\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     res = f(self, context, *args, **kwargs)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 310, in allocate_for_instance\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     LOG.exception(msg, port_id)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/nova/nova/network/neutronv2/api.py\", line 287, in allocate_for_instance\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     port_client.create_port(port_req_body)['port']['id'])\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 108, in with_params\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     ret = self.function(instance, *args, **kwargs)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 276, in create_port\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     return self.post(self.ports_path, body=body)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 872, in post\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     headers=headers, params=params)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 795, in do_request\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     self._handle_fault_response(status_code, replybody)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 765, in _handle_fault_response\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     exception_handler_v20(status_code, des_error_body)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager   File \"/opt/stack/python-neutronclient/neutronclient/v2_0/client.py\", line 81, in exception_handler_v20\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager     message=error_dict)\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager NeutronClientException: Quota exceeded for resources: ['port']\n2013-08-02 21:30:38.115 30306 TRACE nova.compute.manager\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/poll.py\", line 97, in wait\n    readers.get(fileno, noop).cb(fileno)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n\n\nFurthermore nova doesn't show its a quota issue but instead says:\n\n| fault                                | {u'message': u'NoValidHost', u'code': 500, u'created': u'2013-08-02T21:31:04Z'} |", 
            "date_created": "2013-08-02 22:28:48.544863+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Looks like part of the problem here, and I think this is a basic theme now, but the neutronclient doesn't seem to have a granular enough exception class for over-quota errors so it just gives you back a generic NeutronError as an internal server error (status 500).  These are the mappings in the neutronclient that I see when this happens:\n\nhttps://github.com/openstack/python-neutronclient/blob/master/neutronclient/v2_0/client.py#L46\n\nThere is nothing in there for over-quota. This is what you should be seeing in the neutron server log:\n\nhttps://github.com/openstack/neutron/blob/master/neutron/common/exceptions.py#L239\n\nI've seen patch reviews in nova where things are like this are trying to be handled by parsing the error message string for keywords and then mapping that to a more granular error in nova, but the problem there is if the error message changes in neutron your nova code that does the error mapping is regressed.\n\nSo the net is, I think we just need more granular exception mappings in neutron client and then handle those in nova.", 
            "date_created": "2013-08-03 19:10:57.505307+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Here is the review I was thinking of: https://review.openstack.org/#/c/39006/", 
            "date_created": "2013-08-03 19:23:27.939832+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/41177", 
            "date_created": "2013-08-09 19:28:30.450879+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/41177\nCommitted: http://github.com/openstack/nova/commit/2d20b87aef5a7d00cb36826b8907032912fb17fc\nSubmitter: Jenkins\nBranch:    master\n\ncommit 2d20b87aef5a7d00cb36826b8907032912fb17fc\nAuthor: Matt Riedemann <email address hidden>\nDate:   Fri Aug 9 11:15:26 2013 -0700\n\n    Handle port over-quota when allocating network for instance\n    \n    This patch adds a check in the neutron API for a port create failure due\n    to over-quota in neutron and raises the new exception PortLimitExceeded.\n    \n    Also moves the port-create block of code into it's own method to\n    try and clean up some of the large allocate_for_instance method.\n    \n    Closes-Bug: #1207914\n    Related-Bug: #1209446\n    \n    Change-Id: I4000c8ab550e032363f138a86e1b87f6ab2f5ff2\n", 
            "date_created": "2013-09-05 16:13:40.981837+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "When the bug was reported, there was no action in neutronclient side.\nAfter that, neutron exception handling was improved and now neutronclient raises OverQuotaClient exception and nova catches it.", 
            "date_created": "2015-12-03 20:38:45.354059+00:00", 
            "author": "https://api.launchpad.net/1.0/~amotoki"
        }
    ], 
    "closed": "2013-09-05 16:21:44.950366+00:00"
}