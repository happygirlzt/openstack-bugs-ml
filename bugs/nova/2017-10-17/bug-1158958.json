{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:33:55.532928+00:00", 
    "description": "I am trying to use memcached with Nova Grizzly and I get the following error in nova-api log:\n\n2013-03-22 19:22:03.921 ERROR nova.api.openstack [req-3b839f39-ebe5-460a-9499-736323132e43 cd9a6b253278436eb3fcbe4f92a96694 3eccdb2a9331419c96ac9ff336110b65] Caught error: Keys must be str()'s, not unicode.  Convert your unicode strings using mystring.encode(charset)!\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack Traceback (most recent call last):\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/__init__.py\", line 81, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return req.get_response(self.application)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     application, catch_exc_info=False)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/keystoneclient/middleware/auth_token.py\", line 451, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return self.app(env, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 895, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     content_type, body, accept)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 982, in _process_stack\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     request, action_args)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 867, in post_process_extensions\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     **action_args)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/extended_availability_zone.py\", line 72, in detail\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     self._extend_server(context, server, db_instance)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/extended_availability_zone.py\", line 53, in _extend_server\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     server[key] = self._get_host_az(context, instance)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/extended_availability_zone.py\", line 44, in _get_host_az\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     az = self.mc.get(cache_key)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 862, in get\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return self._get('get', key)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 813, in _get\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     self.check_key(key)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 1014, in check_key\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     \"Keys must be str()'s, not unicode.  Convert your unicode \"\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack MemcachedStringEncodingError: Keys must be str()'s, not unicode.  Convert your unicode strings using mystring.encode(charset)!\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack \n\n\nI have set the memcached_servers flag in nova.conf:\n\nmemcached_servers=192.168.220.41:11211,192.168.220.42:11211,192.168.220.43:11211\n\nI receive the same error even when I front-end the memcached servers using a load-balancer vitual IP:\n\nmemcached_servers=192.168.220.40:11211\n\nI have yet to test, but I recall seeing a similar problem in Folsom with consoleauth/manager.py", 
    "tags": [], 
    "importance": "Critical", 
    "heat": 30, 
    "link": "https://bugs.launchpad.net/nova/+bug/1158958", 
    "owner": "https://api.launchpad.net/1.0/~dflorea", 
    "id": 1158958, 
    "index": 123, 
    "openned": "2013-03-26 15:59:51.410775+00:00", 
    "created": "2013-03-22 19:40:26.266537+00:00", 
    "title": "Nova API Memcached Encoding Error", 
    "comments": [
        {
            "content": "I am trying to use memcached with Nova Grizzly and I get the following error in nova-api log:\n\n2013-03-22 19:22:03.921 ERROR nova.api.openstack [req-3b839f39-ebe5-460a-9499-736323132e43 cd9a6b253278436eb3fcbe4f92a96694 3eccdb2a9331419c96ac9ff336110b65] Caught error: Keys must be str()'s, not unicode.  Convert your unicode strings using mystring.encode(charset)!\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack Traceback (most recent call last):\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/__init__.py\", line 81, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return req.get_response(self.application)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1296, in send\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     application, catch_exc_info=False)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/request.py\", line 1260, in call_application\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     app_iter = application(self.environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/keystoneclient/middleware/auth_token.py\", line 451, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return self.app(env, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/routes/middleware.py\", line 131, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     response = self.app(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 144, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return resp(environ, start_response)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 130, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     resp = self.call_func(req, *args, **self.kwargs)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/webob/dec.py\", line 195, in call_func\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return self.func(req, *args, **kwargs)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 895, in __call__\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     content_type, body, accept)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 982, in _process_stack\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     request, action_args)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/wsgi.py\", line 867, in post_process_extensions\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     **action_args)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/extended_availability_zone.py\", line 72, in detail\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     self._extend_server(context, server, db_instance)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/extended_availability_zone.py\", line 53, in _extend_server\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     server[key] = self._get_host_az(context, instance)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/nova/api/openstack/compute/contrib/extended_availability_zone.py\", line 44, in _get_host_az\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     az = self.mc.get(cache_key)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 862, in get\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     return self._get('get', key)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 813, in _get\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     self.check_key(key)\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack   File \"/usr/lib/python2.7/dist-packages/memcache.py\", line 1014, in check_key\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack     \"Keys must be str()'s, not unicode.  Convert your unicode \"\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack MemcachedStringEncodingError: Keys must be str()'s, not unicode.  Convert your unicode strings using mystring.encode(charset)!\n2013-03-22 19:22:03.921 10563 TRACE nova.api.openstack \n\n\nI have set the memcached_servers flag in nova.conf:\n\nmemcached_servers=192.168.220.41:11211,192.168.220.42:11211,192.168.220.43:11211\n\nI receive the same error even when I front-end the memcached servers using a load-balancer vitual IP:\n\nmemcached_servers=192.168.220.40:11211\n\nI have yet to test, but I recall seeing a similar problem in Folsom with consoleauth/manager.py", 
            "date_created": "2013-03-22 19:40:26.266537+00:00", 
            "author": "https://api.launchpad.net/1.0/~danehans"
        }, 
        {
            "content": "Also, everything works fine when I remove the memcached_servers flag.", 
            "date_created": "2013-03-22 19:42:13.038308+00:00", 
            "author": "https://api.launchpad.net/1.0/~danehans"
        }, 
        {
            "content": "If memcached_servers is set, Nova is basically using memcache.Client directly rather than any oslo code\n\nIt looks to me like Nova is passing a unicode key and memcache.Client doesn't allow it\n\nI'd be happy enough with Oslo's memcache client using memcache.Client.check_key() to enforce the same requirements", 
            "date_created": "2013-03-26 16:09:03.275839+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/25496", 
            "date_created": "2013-03-27 06:02:04.646842+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Mark,\n\nFor Oslo, what should be done? add a check_key() method which makes checks similar to that in memcache.Client.check_key()? \n\nthanks,\ndims", 
            "date_created": "2013-03-27 20:27:58.072975+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/25496\nCommitted: http://github.com/openstack/nova/commit/a11c41b48dff83a91eaa65630cc6aeb0e51e6461\nSubmitter: Jenkins\nBranch:    master\n\ncommit a11c41b48dff83a91eaa65630cc6aeb0e51e6461\nAuthor: Dan Florea <email address hidden>\nDate:   Tue Mar 26 23:00:32 2013 -0700\n\n    Convert host value from unicode to a string.\n    \n    The memcached API expects string format, not unicode.\n    Convert the host value to a string before creating\n    the cache_key and passing it to memcached.\n    \n    Fixes: bug #1158958\n    Change-Id: I26e86b7fb61b4b3380a14686bd2faa9f58017999\n", 
            "date_created": "2013-04-01 19:43:48.109462+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/grizzly\nReview: https://review.openstack.org/26867", 
            "date_created": "2013-04-12 17:10:12.454482+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/26867\nCommitted: http://github.com/openstack/nova/commit/232f874d3663248f2a82eb138c0e7bd142593746\nSubmitter: Jenkins\nBranch:    stable/grizzly\n\ncommit 232f874d3663248f2a82eb138c0e7bd142593746\nAuthor: Dan Florea <email address hidden>\nDate:   Tue Mar 26 23:00:32 2013 -0700\n\n    Convert host value from unicode to a string.\n    \n    The memcached API expects string format, not unicode.\n    Convert the host value to a string before creating\n    the cache_key and passing it to memcached.\n    \n    Fixes: bug #1158958\n    Change-Id: I26e86b7fb61b4b3380a14686bd2faa9f58017999\n    (cherry picked from commit a11c41b48dff83a91eaa65630cc6aeb0e51e6461)\n", 
            "date_created": "2013-04-27 14:27:08.245879+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-05-29 10:15:38.521315+00:00"
}