{
    "status": "Fix Released", 
    "last_updated": "2016-07-14 13:02:06.419511+00:00", 
    "description": "When booting a server with ephemeral disks without specifying the size it defaults to the flavor ephemeral disk size for all  of them. \n\nSteps:\n\n\t1. Create custom flavor with ephemeral disk > 0\n\nubuntu@ubuntu:~$ nova flavor-list\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| 1  | m1.tiny   | 512       | 1    | 0         |      | 1     | 1.0         | True      |\n| 11 | m1.custom | 512       | 5    | 10        |      | 1     | 1.0         | True      |\n| 2  | m1.small  | 2048      | 20   | 0         |      | 1     | 1.0         | True      |\n| 3  | m1.medium | 4096      | 40   | 0         |      | 2     | 1.0         | True      |\n| 4  | m1.large  | 8192      | 80   | 0         |      | 4     | 1.0         | True      |\n| 5  | m1.xlarge | 16384     | 160  | 0         |      | 8     | 1.0         | True      |\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n\n        2.  Boot instance with ephemerals without specifying their size\n\nubuntu@ubuntu:~$ nova boot --image  3ec2603b-9113-4ca1-92cf-690e573985bd --flavor 11 --block-device source=blank,dest=local --block-device source=blank,dest=local test\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-SRV-ATTR:host                 | -                                                              |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                              |\n| OS-EXT-SRV-ATTR:instance_name        | instance-0000005e                                              |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | scheduling                                                     |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| adminPass                            | RgeEPJp5fLYL                                                   |\n| config_drive                         |                                                                |\n| created                              | 2015-08-11T09:35:31Z                                           |\n| flavor                               | m1.custom (11)                                                 |\n| hostId                               |                                                                |\n| id                                   | 8b1659bf-5ffe-4855-aebe-a63991ce12cc                           |\n| image                                | cirros-0.3.4-x86_64-uec (3ec2603b-9113-4ca1-92cf-690e573985bd) |\n| key_name                             | -                                                              |\n| metadata                             | {}                                                             |\n| name                                 | test                                                           |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | default                                                        |\n| status                               | BUILD                                                          |\n| tenant_id                            | 0b2075b7a28440078e8f50a75eaa9066                               |\n| updated                              | 2015-08-11T09:35:31Z                                           |\n| user_id                              | 30a0b1adc4b94fefbf938568fe349910                               |\n+--------------------------------------+----------------------------------------------------------------+\n\n We see the ephemerals there:\n\nubuntu@ubuntu:/opt/stack/data/nova/instances/8b1659bf-5ffe-4855-aebe-a63991ce12cc$ ls\nconsole.log  disk  disk.config  disk.eph0  disk.eph1  disk.info  kernel  libvirt.xml  ramdisk\n\nubuntu@ubuntu:/opt/stack/data/nova/instances/8b1659bf-5ffe-4855-aebe-a63991ce12cc$ qemu-img info disk.eph0\nimage: disk.eph0\nfile format: qcow2\nvirtual size: 10G (10737418240 bytes)\ndisk size: 324K\ncluster_size: 65536\nbacking file: /opt/stack/data/nova/instances/_base/ephemeral_10_40d1d2c\nFormat specific information:\n    compat: 1.1\n    lazy refcounts: false\nubuntu@ubuntu:/opt/stack/data/nova/instances/8b1659bf-5ffe-4855-aebe-a63991ce12cc$ qemu-img info disk.eph1\nimage: disk.eph1\nfile format: qcow2\nvirtual size: 10G (10737418240 bytes)\ndisk size: 196K\ncluster_size: 65536\nbacking file: /opt/stack/data/nova/instances/_base/ephemeral_10_40d1d2c\nFormat specific information:\n    compat: 1.1\n    lazy refcounts: false\n\n\nThey are both defaulted to the size from the flavor (10 G) for a total of 20 G.  Normally, the total size of the ephemeral disks should not be greater than the size from the flavor, otherwise it will raise InvalidBDMEphemeralSize exception.", 
    "tags": [
        "compute", 
        "ephemeral-disk", 
        "flavor", 
        "liberty-backport-potential"
    ], 
    "importance": "High", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1483645", 
    "owner": "https://api.launchpad.net/1.0/~jichenjc", 
    "id": 1483645, 
    "index": 1792, 
    "openned": "2015-08-11 10:50:26.838779+00:00", 
    "created": "2015-08-11 10:50:26.838779+00:00", 
    "title": "Ephemeral disk size in volume can be bypassed when booting instance", 
    "comments": [
        {
            "content": "When booting a server with ephemeral disks without specifying the size it defaults to the flavor ephemeral disk size for all  of them. \n\nSteps:\n\n\t1. Create custom flavor with ephemeral disk > 0\n\nubuntu@ubuntu:~$ nova flavor-list\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| 1  | m1.tiny   | 512       | 1    | 0         |      | 1     | 1.0         | True      |\n| 11 | m1.custom | 512       | 5    | 10        |      | 1     | 1.0         | True      |\n| 2  | m1.small  | 2048      | 20   | 0         |      | 1     | 1.0         | True      |\n| 3  | m1.medium | 4096      | 40   | 0         |      | 2     | 1.0         | True      |\n| 4  | m1.large  | 8192      | 80   | 0         |      | 4     | 1.0         | True      |\n| 5  | m1.xlarge | 16384     | 160  | 0         |      | 8     | 1.0         | True      |\n+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n\n        2.  Boot instance with ephemerals without specifying their size\n\nubuntu@ubuntu:~$ nova boot --image  3ec2603b-9113-4ca1-92cf-690e573985bd --flavor 11 --block-device source=blank,dest=local --block-device source=blank,dest=local test\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-SRV-ATTR:host                 | -                                                              |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                              |\n| OS-EXT-SRV-ATTR:instance_name        | instance-0000005e                                              |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | scheduling                                                     |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| adminPass                            | RgeEPJp5fLYL                                                   |\n| config_drive                         |                                                                |\n| created                              | 2015-08-11T09:35:31Z                                           |\n| flavor                               | m1.custom (11)                                                 |\n| hostId                               |                                                                |\n| id                                   | 8b1659bf-5ffe-4855-aebe-a63991ce12cc                           |\n| image                                | cirros-0.3.4-x86_64-uec (3ec2603b-9113-4ca1-92cf-690e573985bd) |\n| key_name                             | -                                                              |\n| metadata                             | {}                                                             |\n| name                                 | test                                                           |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | default                                                        |\n| status                               | BUILD                                                          |\n| tenant_id                            | 0b2075b7a28440078e8f50a75eaa9066                               |\n| updated                              | 2015-08-11T09:35:31Z                                           |\n| user_id                              | 30a0b1adc4b94fefbf938568fe349910                               |\n+--------------------------------------+----------------------------------------------------------------+\n\n We see the ephemerals there:\n\nubuntu@ubuntu:/opt/stack/data/nova/instances/8b1659bf-5ffe-4855-aebe-a63991ce12cc$ ls\nconsole.log  disk  disk.config  disk.eph0  disk.eph1  disk.info  kernel  libvirt.xml  ramdisk\n\nubuntu@ubuntu:/opt/stack/data/nova/instances/8b1659bf-5ffe-4855-aebe-a63991ce12cc$ qemu-img info disk.eph0\nimage: disk.eph0\nfile format: qcow2\nvirtual size: 10G (10737418240 bytes)\ndisk size: 324K\ncluster_size: 65536\nbacking file: /opt/stack/data/nova/instances/_base/ephemeral_10_40d1d2c\nFormat specific information:\n    compat: 1.1\n    lazy refcounts: false\nubuntu@ubuntu:/opt/stack/data/nova/instances/8b1659bf-5ffe-4855-aebe-a63991ce12cc$ qemu-img info disk.eph1\nimage: disk.eph1\nfile format: qcow2\nvirtual size: 10G (10737418240 bytes)\ndisk size: 196K\ncluster_size: 65536\nbacking file: /opt/stack/data/nova/instances/_base/ephemeral_10_40d1d2c\nFormat specific information:\n    compat: 1.1\n    lazy refcounts: false\n\n\nThey are both defaulted to the size from the flavor (10 G) for a total of 20 G.  Normally, the total size of the ephemeral disks should not be greater than the size from the flavor, otherwise it will raise InvalidBDMEphemeralSize exception.", 
            "date_created": "2015-08-11 10:50:26.838779+00:00", 
            "author": "https://api.launchpad.net/1.0/~atuvenie"
        }, 
        {
            "content": "Flavor's ephemeral had defined at following doc:\nhttp://docs.openstack.org/openstack-ops/content/flavors.html#table-flavor-params\nIt is not mean total ephemeral space of flavor.\nIf you really felt this definition was not adaptive.\nMaybe we can discuss in irc.", 
            "date_created": "2015-08-11 14:37:00.372257+00:00", 
            "author": "https://api.launchpad.net/1.0/~lyanchih"
        }, 
        {
            "content": "@lyanchih\n\nBut if the flavor ephemeral is not meant to represent the total ephemeral space of flavor then we have contradicting behavior.\n\nIf we use this command:\n\nubuntu@ubuntu:~$ nova boot --image  3ec2603b-9113-4ca1-92cf-690e573985bd --flavor 11 --block-device source=blank,dest=local,size=5 --block-device source=blank,dest=local,size=9 test\n\nERROR (BadRequest): Ephemeral disks requested are larger than the instance type allows. (HTTP 400) (Request-ID: req-266b4660-1618-4fcf-a03e-6e89117535ce)\n\nSo in this case, we have two block devices with total size larger than the instance flavor allows. In this case, flavor ephemeral size is interpreted as total ephemeral size.", 
            "date_created": "2015-08-13 18:07:21.986731+00:00", 
            "author": "https://api.launchpad.net/1.0/~atuvenie"
        }, 
        {
            "content": "yes, There are some logic to check it and the logic shows this is not allowed  (the ephemeral disk size in total > flavor ephemeral size)\nI believe it's a bug ", 
            "date_created": "2015-08-17 14:05:51.152424+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "the bdm.volume_size will be None if it's not given, and it will be interpreted as ephemeral size later\nso we should add this check here ", 
            "date_created": "2015-08-17 14:36:32.095029+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/213762", 
            "date_created": "2015-08-17 15:51:44.863830+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "@John\nClaudiu Belu made a good suggestion that this need string change \nshould I avoid string change this timeframe to merge the code and change the string during the M release? Thanks", 
            "date_created": "2015-09-15 15:07:20.215143+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "I'm assuming this is not a regression in liberty, it was just reported in liberty.  I'm marking this as liberty-backport-potential so it doesn't block liberty rc1.", 
            "date_created": "2015-09-23 15:56:59.819844+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/232505", 
            "date_created": "2015-10-08 12:31:13.620091+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/232506", 
            "date_created": "2015-10-08 12:31:23.166998+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/232505\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d8ca59cd04faa7f57d2abb8fe2e004c266386312\nSubmitter: Jenkins\nBranch:    master\n\ncommit d8ca59cd04faa7f57d2abb8fe2e004c266386312\nAuthor: jichenjc <email address hidden>\nDate:   Tue Oct 6 00:57:46 2015 +0800\n\n    Catch 3 InvalidBDM related exc when boot instance\n    \n    InvalidBDMEphemeralSize ,InvalidBDMFormat and\n    InvalidBDMSwapSize exception might be raised during\n    boot process while we didn't catch this exception at API\n    layer so 500 will be returned. This patch makes it return\n    HTTPBadRequest.\n    \n    Note this didn't require microversion bump per microversion\n    dev mentioned and legacy v2 code already have Invalid exception\n    catched and handled.\n    \n    Change-Id: I98bd8edab3a2801c876d53c0336ea2f8da5396aa\n    Related-Bug: 1483645\n    Closes-Bug: 1504264\n", 
            "date_created": "2015-10-28 08:27:48.953360+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/232506\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=4c34d7c3288fd90993808ce146c22c2994add9d3\nSubmitter: Jenkins\nBranch:    master\n\ncommit 4c34d7c3288fd90993808ce146c22c2994add9d3\nAuthor: jichenjc <email address hidden>\nDate:   Tue Oct 6 01:03:32 2015 +0800\n\n    Change Invalid exception to a specified exception\n    \n    Compute API will call function\n    https://github.com/openstack/nova/blob/master/nova/compute/api.py#L544\n    this in turn will call\n    https://github.com/openstack/nova/blob/master/nova/image/api.py#L91\n    which will call\n    https://github.com/openstack/nova/blob/master/nova/image/glance.py#L290\n    then finally\n    https://github.com/openstack/nova/blob/master/nova/image/glance.py#L621\n    may raise exception.Invalid\n    \n    so nova need to catch that exception and handle it, instead of using\n    Invalid exception to catch unexpected exception, use a new exception\n    for this kind of error case and catch it at API layer.\n    \n    Change-Id: Ia6ec5c561706c75e06b356993f8bc722109ed9e7\n    Related-bug: 1483645\n", 
            "date_created": "2015-11-19 14:55:00.993057+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/213762\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c7de85445ad2c153710e066df7eba23d68d32010\nSubmitter: Jenkins\nBranch:    master\n\ncommit c7de85445ad2c153710e066df7eba23d68d32010\nAuthor: jichenjc <email address hidden>\nDate:   Fri Aug 14 02:42:58 2015 +0800\n\n    Prevent boot if ephemeral disk size > flavor value\n    \n    Nova allows following command\n    nova boot --image 3ec2603b-9113-4ca1-92cf-690e573985bd --flavor 11\n    --block-device source=blank,dest=local\n    --block-device source=blank,dest=local test\n    \n    which in turn translate the ephemeral disk mappings into 2\n    default ephemeral disk and makes the total spanwed ephemeral\n    disk size greater than flavor ephemeral disk.\n    \n    This patch add checks to this kind of situation and prevents it.\n    \n    Change-Id: I1952eeb04bf3835182e575e418632a6d611c84e9\n    Closes-Bug: 1483645\n", 
            "date_created": "2016-07-07 04:08:44.913967+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.0.0b2 development milestone.", 
            "date_created": "2016-07-14 13:02:03.866758+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }
    ], 
    "closed": "2016-07-07 04:08:41.189295+00:00"
}