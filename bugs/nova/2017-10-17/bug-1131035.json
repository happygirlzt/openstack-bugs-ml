{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:19:12.797619+00:00", 
    "description": "Qpid does not support encoding for set data structure, see qpid/codec010.py. Powervm driver returns a set for macs_for_instance implementation braking deploy flow. Suggest changing to return list instead of a set. It seems to work on my dev env. I can provide a fix if assigned to me.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1131035", 
    "owner": "https://api.launchpad.net/1.0/~russellb", 
    "id": 1131035, 
    "index": 4698, 
    "openned": "2013-02-21 04:58:47.936476+00:00", 
    "created": "2013-02-21 04:58:47.936476+00:00", 
    "title": "Powervm driver implementation of macs_for_instance fails when qpid used as amqp provider", 
    "comments": [
        {
            "content": "Qpid does not support encoding for set data structure, see qpid/codec010.py. Powervm driver returns a set for macs_for_instance implementation braking deploy flow. Suggest changing to return list instead of a set. It seems to work on my dev env. I can provide a fix if assigned to me.", 
            "date_created": "2013-02-21 04:58:47.936476+00:00", 
            "author": "https://api.launchpad.net/1.0/~dperaza"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/22717", 
            "date_created": "2013-02-22 17:58:50.380188+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/22723", 
            "date_created": "2013-02-22 18:22:59.295701+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This is the trace we get with the encoding issue:\n\n2013-02-18 13:28:38.708 ERROR nova.scheduler.filter_scheduler [req-6b579a08-f2a5-447d-a881-9eec0d6ecce9 7e9ee04cf6fa40bf8ef3f78757356483 9b2c4c250aba4fb8b7387b74d60c6802] [instance: 7b9c4be0-c207-45d8-af6a-8ff8b4a1479e] Error from last host: vs347.rch.kstart.ibm.com (node olyblade01.rch.stglabs.ibm.com): [u'Traceback (most recent call last):\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 710, in _run_instance\\n    requested_networks, macs)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/compute/manager.py\", line 957, in _allocate_network\\n    macs=macs, conductor_api=self.conductor_api)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/network/api.py\", line 88, in wrapped\\n    return func(self, context, *args, **kwargs)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/network/api.py\", line 45, in wrapper\\n    res = f(self, context, *args, **kwargs)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/network/api.py\", line 269, in allocate_for_instance\\n    nw_info = self.network_rpcapi.allocate_for_instance(context, **args)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/network/rpcapi.py\", line 168, in allocate_for_instance\\n    topic=topic, version=\\'1.8\\')\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/proxy.py\", line 80, in call\\n    return rpc.call(context, self._get_topic(topic), msg, timeout)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/__init__.py\", line 139, in call\\n    return _get_impl().call(CONF, context, topic, msg, timeout)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/impl_qpid.py\", line 582, in call\\n    rpc_amqp.get_connection_pool(conf, Connection))\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py\", line 377, in call\\n    rv = multicall(conf, context, topic, msg, timeout, connection_pool)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/amqp.py\", line 371, in multicall\\n    conn.topic_send(topic, rpc_common.serialize_msg(msg), timeout)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/impl_qpid.py\", line 503, in topic_send\\n    self.publisher_send(TopicPublisher, topic, qpid_message)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/impl_qpid.py\", line 464, in publisher_send\\n    return self.ensure(_connect_error, _publisher_send)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/impl_qpid.py\", line 375, in ensure\\n    return method(*args, **kwargs)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/impl_qpid.py\", line 462, in _publisher_send\\n    publisher.send(msg)\\n', u'  File \"/usr/lib/python2.6/site-packages/nova/openstack/common/rpc/impl_qpid.py\", line 233, in send\\n    self.sender.send(msg)\\n', u'  File \"<string>\", line 6, in send\\n', u'  File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 874, in send\\n    self.sync()\\n', u'  File \"<string>\", line 6, in sync\\n', u'  File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 885, in sync\\n    if not self._ewait(lambda: self.acked >= mno, timeout=timeout):\\n', u'  File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 799, in _ewait\\n    result = self.session._ewait(lambda: self.error or predicate(), timeout)\\n', u'  File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 566, in _ewait\\n    result = self.connection._ewait(lambda: self.error or predicate(), timeout)\\n', u'  File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 209, in _ewait\\n    self.check_error()\\n', u'  File \"/usr/lib/python2.6/site-packages/qpid/messaging/endpoints.py\", line 202, in check_error\\n    raise self.error\\n', u'InternalError: Traceback (most recent call last):\\n  File \"/usr/lib/python2.6/site-packages/qpid/messaging/driver.py\", line 511, in dispatch\\n    self.engine.dispatch()\\n  File \"/usr/lib/python2.6/site-packages/qpid/messaging/driver.py\", line 817, in dispatch\\n    self.process(ssn)\\n  File \"/usr/lib/python2.6/site-packages/qpid/messaging/driver.py\", line 1052, in process\\n    self.send(snd, msg)\\n  File \"/usr/lib/python2.6/site-packages/qpid/messaging/driver.py\", line 1263, in send\\n    body = enc(msg.content)\\n  File \"/usr/lib/python2.6/site-packages/qpid/messaging/message.py\", line 28, in encode\\n    sc.write_primitive(type, x)\\n  File \"/usr/lib/python2.6/site-packages/qpid/codec010.py\", line 73, in write_primitive\\n    getattr(self, \"write_%s\" % type.NAME)(v)\\n  File \"/usr/lib/python2.6/site-packages/qpid/codec010.py\", line 257, in write_map\\n    sc.write(string.joinfields(map(self._write_map_elem, m.keys(), m.values()), \"\"))\\n  File \"/usr/lib/python2.6/site-packages/qpid/codec010.py\", line 250, in _write_map_elem\\n    sc.write_primitive(type, v)\\n  File \"/usr/lib/python2.6/site-packages/qpid/codec010.py\", line 73, in write_primitive\\n    getattr(self, \"write_%s\" % type.NAME)(v)\\n  File \"/usr/lib/python2.6/site-packages/qpid/codec010.py\", line 257, in write_map\\n    sc.write(string.joinfields(map(self._write_map_elem, m.keys(), m.values()), \"\"))\\n  File \"/usr/lib/python2.6/site-packages/qpid/codec010.py\", line 246, in _write_map_elem\\n    type = self.encoding(v)\\n  File \"/usr/lib/python2.6/site-packages/qpid/codec010.py\", line 59, in encoding\\n    raise CodecException(\"no encoding for %r\" % obj)\\nCodecException: no encoding for set([\\'fa:c2:84:e7:60:38\\', \\'fa:c2:84:e7:60:39\\', \\'fa:c2:84:e7:60:32\\', \\'fa:c2:84:e7:60:33\\', \\'fa:c2:84:e7:60:30\\', \\'fa:c2:84:e7:60:31\\', \\'fa:c2:84:e7:60:36\\', \\'fa:c2:84:e7:60:37\\', \\'fa:c2:84:e7:60:34\\', \\'fa:c2:84:e7:60:35\\', \\'fa:c2:84:e7:60:2a\\', \\'fa:c2:84:e7:60:2c\\', \\'fa:c2:84:e7:60:2b\\', \\'fa:c2:84:e7:60:2e\\', \\'fa:c2:84:e7:60:2d\\', \\'fa:c2:84:e7:60:2f\\', \\'fa:c2:84:e7:60:29\\', \\'fa:c2:84:e7:60:28\\', \\'fa:c2:84:e7:60:21\\', \\'fa:c2:84:e7:60:20\\', \\'fa:c2:84:e7:60:23\\', \\'fa:c2:84:e7:60:22\\', \\'fa:c2:84:e7:60:25\\', \\'fa:c2:84:e7:60:24\\', \\'fa:c2:84:e7:60:27\\', \\'fa:c2:84:e7:60:26\\', \\'fa:c2:84:e7:60:3b\\', \\'fa:c2:84:e7:60:3c\\', \\'fa:c2:84:e7:60:3a\\', \\'fa:c2:84:e7:60:3f\\', \\'fa:c2:84:e7:60:3d\\', \\'fa:c2:84:e7:60:3e\\'])\\n\\n']", 
            "date_created": "2013-02-22 18:24:29.480486+00:00", 
            "author": "https://api.launchpad.net/1.0/~dperaza"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/22723\nCommitted: http://github.com/openstack/nova/commit/f4f6464f58482fe0c1193cadddb2db56dc4a2434\nSubmitter: Jenkins\nBranch:    master\n\ncommit f4f6464f58482fe0c1193cadddb2db56dc4a2434\nAuthor: Russell Bryant <email address hidden>\nDate:   Fri Feb 22 13:19:42 2013 -0500\n\n    Ensure macs can be serialized.\n    \n    This patch uses to_primitive() to ensure that the macs argument to the\n    rpcapi method allocate_for_instance() can be serialized by rpc drivers.\n    Specifically, the powervm driver uses a set() here, and that will cause\n    breakage in non-kombu drivers.\n    \n    Fix bug 1131035.\n    \n    Change-Id: I5729c5854799e49c6598e4dd2a4da487598307f1\n", 
            "date_created": "2013-02-23 16:01:20.615094+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-03-20 16:09:23.060098+00:00"
}