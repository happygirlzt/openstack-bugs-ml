{
    "status": "Fix Released", 
    "last_updated": "2016-11-10 00:55:45.834004+00:00", 
    "description": "My envirement ,Nova has 2 availability_zone and Cinder has no availability_zone.\nWhen I run two command \"cinder create\" and \"nova boot\" separately ,  it is finished normally.\nBut run at one time, and an error occurs as below.(It is the same on the dashboard)\n\n----\n$ nova boot --flavor m1.small --block-device source=image,id=4014a3f7-507b-4692-86c8-8224bbcc7102,dest=volume,size=10,shutdown=delete,bootindex=0 --nic net-id=4d9e9847-80b5-46ca-8439-344930a59825 --availability_zone az2 test1\n\n$ nova list\n+--------------------------------------+-------+--------+----------------------+-------------+-----------------------+\n| ID                                   | Name  | Status | Task State           | Power State | Networks              |\n+--------------------------------------+-------+--------+----------------------+-------------+-----------------------+\n| a0dc0f03-155c-422b-b0ac-996fc17e0989 | test1 | ERROR  | block_device_mapping | NOSTATE     |                       |\n+--------------------------------------+-------+--------+----------------------+-------------+-----------------------+\n\n$ nova show\n+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Property                             | Value                                                                                                                                                                                                                                                |\n+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                                                                                                                                                                                                               |\n| OS-EXT-AZ:availability_zone          | az1                                                                                                                                                                                                                                                  |\n| OS-EXT-SRV-ATTR:host                 | compute011-az1                                                                                                                                                                                                                              |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | compute011-az1.maas                                                                                                                                                                                                                         |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000514                                                                                                                                                                                                                                    |\n| OS-EXT-STS:power_state               | 0                                                                                                                                                                                                                                                    |\n| OS-EXT-STS:task_state                | block_device_mapping                                                                                                                                                                                                                                 |\n| OS-EXT-STS:vm_state                  | error                                                                                                                                                                                                                                                |\n| OS-SRV-USG:launched_at               | -                                                                                                                                                                                                                                                    |\n| OS-SRV-USG:terminated_at             | -                                                                                                                                                                                                                                                    |\n| accessIPv4                           |                                                                                                                                                                                                                                                      |\n| accessIPv6                           |                                                                                                                                                                                                                                                      |\n| config_drive                         |                                                                                                                                                                                                                                                      |\n| created                              | 2015-09-16T02:47:04Z                                                                                                                                                                                                                                 |\n| fault                                | {\"message\": \"Build of instance a0dc0f03-155c-422b-b0ac-996fc17e0989 aborted: Failure prepping block device.\", \"code\": 500, \"details\": \"  File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2219, in _do_build_and_run_instance |\n|                                      |     filter_properties)                                                                                                                                                                                                                               |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2330, in _build_and_run_instance                                                                                                                                           |\n|                                      |     'create.error', fault=e)                                                                                                                                                                                                                         |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 85, in __exit__                                                                                                                                                             |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                                                                                                                                     |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2303, in _build_and_run_instance                                                                                                                                           |\n|                                      |     block_device_mapping) as resources:                                                                                                                                                                                                              |\n|                                      |   File \\\"/usr/lib/python2.7/contextlib.py\\\", line 17, in __enter__                                                                                                                                                                                   |\n|                                      |     return self.gen.next()                                                                                                                                                                                                                           |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2439, in _build_resources                                                                                                                                                  |\n|                                      |     reason=msg)                                                                                                                                                                                                                                      |\n|                                      | \", \"created\": \"2015-09-16T02:47:08Z\"}                                                                                                                                                                                                                |\n| flavor                               | m1.small (090955df-7dbe-4102-bcfb-4d64d0cc5105)                                                                                                                                                                                                      |\n| hostId                               | bf381a5d2d9136fe4669218bcda1467156b71227023610e0311f9e86                                                                                                                                                                                             |\n| id                                   | a0dc0f03-155c-422b-b0ac-996fc17e0989                                                                                                                                                                                                                 |\n| image                                | Attempt to boot from volume - no image supplied                                                                                                                                                                                                      |\n| key_name                             | -                                                                                                                                                                                                                                                    |\n| metadata                             | {}                                                                                                                                                                                                                                                   |\n| name                                 | test1                                                                                                                                                                                                                                                |\n| os-extended-volumes:volumes_attached | []                                                                                                                                                                                                                                                   |\n| status                               | ERROR                                                                                                                                                                                                                                                |\n| tenant_id                            | 3296a2ca68a04a139258927447956d95                                                                                                                                                                                                                     |\n| updated                              | 2015-09-16T02:47:09Z                                                                                                                                                                                                                                 |\n| user_id                              | ab2a6867991f4cd785c75935ea80f0fb                                                                                                                                                                                                                     |\n+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\nVersion : Kilo", 
    "tags": [
        "availability-zones", 
        "spawn", 
        "volumes"
    ], 
    "importance": "Medium", 
    "heat": 30, 
    "link": "https://bugs.launchpad.net/nova/+bug/1496235", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1496235, 
    "index": 4353, 
    "openned": "2015-09-16 04:47:48.197879+00:00", 
    "created": "2015-09-16 04:47:48.197879+00:00", 
    "title": "Boot from volume faild with availability_zone option, in case of cinder do not have availability_zone", 
    "comments": [
        {
            "content": "\nMy envirement ,Nova has 2 availability_zone and Cinder has no availability_zone.\nWhen I run two command \"cinder create\" and \"nova boot\" separately ,  it is finished normally.\nBut run at one time, and an error error occurs as below.(It is the same on the dashboard)\n\n\n----\n$ nova boot --flavor m1.small --block-device source=image,id=4014a3f7-507b-4692-86c8-8224bbcc7102,dest=volume,size=10,shutdown=delete,bootindex=0 --nic net-id=4d9e9847-80b5-46ca-8439-344930a59825 --availability_zone az2 test1\n\n$ nova list\n+--------------------------------------+-------+--------+----------------------+-------------+-----------------------+\n| ID                                   | Name  | Status | Task State           | Power State | Networks              |\n+--------------------------------------+-------+--------+----------------------+-------------+-----------------------+\n| a0dc0f03-155c-422b-b0ac-996fc17e0989 | test1 | ERROR  | block_device_mapping | NOSTATE     |                       |\n+--------------------------------------+-------+--------+----------------------+-------------+-----------------------+\n\n$ nova show\n+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Property                             | Value                                                                                                                                                                                                                                                |\n+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                                                                                                                                                                                                               |\n| OS-EXT-AZ:availability_zone          | az1                                                                                                                                                                                                                                                  |\n| OS-EXT-SRV-ATTR:host                 | anlk-compute011-sc1-az1                                                                                                                                                                                                                              |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | anlk-compute011-sc1-az1.maas                                                                                                                                                                                                                         |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000514                                                                                                                                                                                                                                    |\n| OS-EXT-STS:power_state               | 0                                                                                                                                                                                                                                                    |\n| OS-EXT-STS:task_state                | block_device_mapping                                                                                                                                                                                                                                 |\n| OS-EXT-STS:vm_state                  | error                                                                                                                                                                                                                                                |\n| OS-SRV-USG:launched_at               | -                                                                                                                                                                                                                                                    |\n| OS-SRV-USG:terminated_at             | -                                                                                                                                                                                                                                                    |\n| accessIPv4                           |                                                                                                                                                                                                                                                      |\n| accessIPv6                           |                                                                                                                                                                                                                                                      |\n| config_drive                         |                                                                                                                                                                                                                                                      |\n| created                              | 2015-09-16T02:47:04Z                                                                                                                                                                                                                                 |\n| fault                                | {\"message\": \"Build of instance a0dc0f03-155c-422b-b0ac-996fc17e0989 aborted: Failure prepping block device.\", \"code\": 500, \"details\": \"  File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2219, in _do_build_and_run_instance |\n|                                      |     filter_properties)                                                                                                                                                                                                                               |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2330, in _build_and_run_instance                                                                                                                                           |\n|                                      |     'create.error', fault=e)                                                                                                                                                                                                                         |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 85, in __exit__                                                                                                                                                             |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                                                                                                                                     |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2303, in _build_and_run_instance                                                                                                                                           |\n|                                      |     block_device_mapping) as resources:                                                                                                                                                                                                              |\n|                                      |   File \\\"/usr/lib/python2.7/contextlib.py\\\", line 17, in __enter__                                                                                                                                                                                   |\n|                                      |     return self.gen.next()                                                                                                                                                                                                                           |\n|                                      |   File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 2439, in _build_resources                                                                                                                                                  |\n|                                      |     reason=msg)                                                                                                                                                                                                                                      |\n|                                      | \", \"created\": \"2015-09-16T02:47:08Z\"}                                                                                                                                                                                                                |\n| flavor                               | m1.small (090955df-7dbe-4102-bcfb-4d64d0cc5105)                                                                                                                                                                                                      |\n| hostId                               | bf381a5d2d9136fe4669218bcda1467156b71227023610e0311f9e86                                                                                                                                                                                             |\n| id                                   | a0dc0f03-155c-422b-b0ac-996fc17e0989                                                                                                                                                                                                                 |\n| image                                | Attempt to boot from volume - no image supplied                                                                                                                                                                                                      |\n| key_name                             | -                                                                                                                                                                                                                                                    |\n| metadata                             | {}                                                                                                                                                                                                                                                   |\n| name                                 | test1                                                                                                                                                                                                                                                |\n| os-extended-volumes:volumes_attached | []                                                                                                                                                                                                                                                   |\n| status                               | ERROR                                                                                                                                                                                                                                                |\n| tenant_id                            | 3296a2ca68a04a139258927447956d95                                                                                                                                                                                                                     |\n| updated                              | 2015-09-16T02:47:09Z                                                                                                                                                                                                                                 |\n| user_id                              | ab2a6867991f4cd785c75935ea80f0fb                                                                                                                                                                                                                     |\n+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\n\n\n\nVersion : Kilo", 
            "date_created": "2015-09-16 04:47:48.197879+00:00", 
            "author": "https://api.launchpad.net/1.0/~i-kumagai"
        }, 
        {
            "content": "Is there more stacktrace to that error?  I'd expect to see something failing down in the nova.virt.block_device attach code somewhere, or maybe an error in the cinder logs?", 
            "date_created": "2015-09-23 17:18:45.994531+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I assume this is the call that fails, right?\n\nhttps://github.com/openstack/nova/blob/master/nova/virt/block_device.py#L381\n\n            vol = volume_api.create(context, self.volume_size,\n                                    '', '', image_id=self.image_id,\n                                    availability_zone=av_zone)\n\nAnd since that az2 doesn't exist in cinder, the volume create request fails.  I guess I wouldn't consider this a bug.\n\nWe could probably determine from the az list in cinder if the volume we're about to create with the given AZ exists, but if it doesn't, then what do we do?  We can either fail (which we're already doing), or not send in the AZ to cinder, but I'm not sure if that's what should happen - although in talking with the cinder devs it sounds like AZs aren't really used in cinder anyway.", 
            "date_created": "2015-09-23 17:33:21.014188+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "The alternative here is you create the volume in cinder first, then just provide that as the source when booting from volume on the nova side.", 
            "date_created": "2015-09-23 17:39:15.372427+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/226977", 
            "date_created": "2015-09-23 20:25:26.896563+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/226977\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=d8d2f02f3014e8d7e0ef9a61723f5a10f050cc81\nSubmitter: Jenkins\nBranch:    master\n\ncommit d8d2f02f3014e8d7e0ef9a61723f5a10f050cc81\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Sep 23 13:21:06 2015 -0700\n\n    Deprecate cinder.cross_az_attach option\n    \n    Introduced in 1504cbc5d4a27695fa663f0b0f3f7b48745bdb45 in Grizzly, the\n    use cases around this option are unclear but there have been several\n    bugs related to it.\n    \n    For example, 6060888b58db42eea826939852838f9e1c204d2c changed boot from\n    volume to pass the server instance availability zone to cinder when\n    creating the volume.  However, if that same AZ does not exist in Cinder,\n    the volume create request will fail - which is bug 1496235.\n    \n    Cinder works around this with b85d2812a8256ff82934d150dbc4909e041d8b31\n    using a config option to allow falling back to a default Cinder AZ if\n    the one requested does not exist.  By default this fallback is disabled\n    though.\n    \n    It also sounds like availability zones in Cinder were an artifact from\n    when Cinder was split out from the nova-volume service, but Cinder AZ\n    use cases are also unclear.  And it's also unclear what the relationship\n    is between AZs in Nova and Cinder.\n    \n    So given the problems here and the lack of a clear use case to justify\n    having this configuration option in tree, along with it's added\n    complexity, deprecate the option for removal.\n    \n    Related-Bug: #1496235\n    Related-Bug: #1380780\n    Related-Bug: #1489575\n    Related-Bug: #1497253\n    \n    Change-Id: I52cd3d8867d3b35f5caba377302bfc52c112f1d6\n", 
            "date_created": "2015-09-24 00:14:31.038288+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi Matt.\n\nThank you for introduce that information.\n\nAt first point,  I wanted  that I can select the sync and async az between nova and cinder .\nThe case of async , cinder uses default az , in spite of designation of Nova. \n\n", 
            "date_created": "2015-09-24 01:13:16.595365+00:00", 
            "author": "https://api.launchpad.net/1.0/~i-kumagai"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/227483", 
            "date_created": "2015-09-24 19:11:21.909377+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/227564", 
            "date_created": "2015-09-24 21:48:28.465947+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/227483\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0b737f24bef9d00e266202af94ff402a503b52fb\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0b737f24bef9d00e266202af94ff402a503b52fb\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu Sep 24 12:10:47 2015 -0700\n\n    Add more help text to the cinder.cross_az_attach option\n    \n    Try to provide some more detail on how the cross_az_attach option is\n    used and what setting it to False implies.\n    \n    Related-Bug: #1496235\n    \n    Change-Id: I588a058711154b7857375bcf166ac8a74f8af448\n", 
            "date_created": "2015-09-28 15:56:13.029016+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/227564\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=f9a51b970f688b90baf0ae3ef31d79b3fec02ed1\nSubmitter: Jenkins\nBranch:    master\n\ncommit f9a51b970f688b90baf0ae3ef31d79b3fec02ed1\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu Sep 24 14:47:49 2015 -0700\n\n    Only create volumes with instance.az if cinder.cross_az_attach is False\n    \n    Commit 6060888b58db42eea826939852838f9e1c204d2c changed the boot from\n    volume flow where source != 'volume' (where Nova creates the volume and\n    then attaches it to the instance during the server create operation)\n    such that the instance.availability_zone is always passed to the volume\n    create API.  That was done because if the cinder.cross_az_attach config\n    option is False then Nova requires the instance and volume AZs to be the\n    same when attaching the volume.\n    \n    However, telling Cinder to create a volume based on the instance AZ can\n    fail if that AZ doesn't exist in Cinder.\n    \n    Cinder commit b85d2812a8256ff82934d150dbc4909e041d8b31 works around this\n    by allowing Cinder to be configured to basically not fail if the\n    requested AZ does not exist. This is not a great solution though if you\n    have cinder.cross_az_attach=False in Nova because Cinder ignored your\n    request.  It's also terrible UX for the end user because they get a\n    NoValidHost when boot from volume fails.  There is a TODO in this change\n    to address that later (because exactly how cross-service AZs should work\n    is still being discussed).\n    \n    This change addresses the gap introduced by always telling Cinder to\n    create the volume with the instance AZ.  We should only do that when\n    cinder.cross_az_attach is False, because that's the strict case where\n    Nova expects them to match.  If cross_az_attach is True, Nova doesn't\n    care what AZ the volume is in so we shouldn't try and force\n    Cinder to accommodate the Nova AZ when creating the volume.\n    \n    Closes-Bug: #1496235\n    \n    Change-Id: I3d60c084fd71162a0d4835394f8e819723c1b8a7\n", 
            "date_created": "2015-10-06 20:45:46.807229+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.0.0.0b1 development milestone.", 
            "date_created": "2015-12-02 16:18:09.120019+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/253082", 
            "date_created": "2015-12-03 17:09:03.758646+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/253082\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ec146e0d75b7c907082227221835dad8291134b6\nSubmitter: Jenkins\nBranch:    stable/kilo\n\ncommit ec146e0d75b7c907082227221835dad8291134b6\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu Sep 24 14:47:49 2015 -0700\n\n    Only create volumes with instance.az if cinder.cross_az_attach is False\n    \n    Commit 6060888b58db42eea826939852838f9e1c204d2c changed the boot from\n    volume flow where source != 'volume' (where Nova creates the volume and\n    then attaches it to the instance during the server create operation)\n    such that the instance.availability_zone is always passed to the volume\n    create API.  That was done because if the cinder.cross_az_attach config\n    option is False then Nova requires the instance and volume AZs to be the\n    same when attaching the volume.\n    \n    However, telling Cinder to create a volume based on the instance AZ can\n    fail if that AZ doesn't exist in Cinder.\n    \n    Cinder commit b85d2812a8256ff82934d150dbc4909e041d8b31 works around this\n    by allowing Cinder to be configured to basically not fail if the\n    requested AZ does not exist. This is not a great solution though if you\n    have cinder.cross_az_attach=False in Nova because Cinder ignored your\n    request.  It's also terrible UX for the end user because they get a\n    NoValidHost when boot from volume fails.  There is a TODO in this change\n    to address that later (because exactly how cross-service AZs should work\n    is still being discussed).\n    \n    This change addresses the gap introduced by always telling Cinder to\n    create the volume with the instance AZ.  We should only do that when\n    cinder.cross_az_attach is False, because that's the strict case where\n    Nova expects them to match.  If cross_az_attach is True, Nova doesn't\n    care what AZ the volume is in so we shouldn't try and force\n    Cinder to accommodate the Nova AZ when creating the volume.\n    \n    Closes-Bug: #1496235\n    \n    Change-Id: I3d60c084fd71162a0d4835394f8e819723c1b8a7\n    (cherry picked from commit f9a51b970f688b90baf0ae3ef31d79b3fec02ed1)\n", 
            "date_created": "2016-05-04 01:30:27.475582+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 2015.1.4 release.", 
            "date_created": "2016-05-10 13:37:40.008398+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 2015.1.4 release.", 
            "date_created": "2016-11-10 00:55:45.162882+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-12-03 21:34:26.138606+00:00"
}