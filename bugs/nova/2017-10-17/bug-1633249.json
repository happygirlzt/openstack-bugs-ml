{
    "status": "Confirmed", 
    "last_updated": "2017-06-23 12:48:40.904260+00:00", 
    "description": "Attempt to boot a server with a block device mapping that includes a boot volume created from an image, plus an existing data volume. If the boot-volume creation fails, the data volume is left in state \"in-use\", attached to the server which is now in \"error\" state\". The user can't detach the volume because of the server's error state. They can delete the server, which then leaves the volume apparently attached to a server that no longer exists. The only way out of this is to ask an administrator to reset the state of the data volume (this option is not available to regular users by default policy).\n\nThe easiest way to reproduce this is to attempt to create the boot volume from qcow2 image where the volume size is less than the image (virtual) size.\n\n ~$ cinder list\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+\n| ID                                   | Status    | Name | Size | Volume Type | Bootable | Attached to |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+\n| 2e733722-8b19-4bff-bd8d-bb770554582a | available | data | 1    | -           | false    |             |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+\n\n~$ nova boot --flavor m1.large --availability-zone=imot04-1 --block-device 'id=9e122d18-d7a4-406d-b8f2-446cfddaa7c7,source=image,dest=volume,device=vda,size=5,bootindex=0' --block-device 'id=2e733722-8b19-4bff-bd8d-bb770554582a,source=volume,dest=volume,device=vdb,size=1,bootindex=1' ol4\n+--------------------------------------+--------------------------------------------------+\n| Property                             | Value                                            |\n+--------------------------------------+--------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                           |\n| OS-EXT-AZ:availability_zone          | imot04-1                                         |\n| OS-EXT-SRV-ATTR:host                 | -                                                |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                |\n| OS-EXT-SRV-ATTR:instance_name        |                                                  |\n| OS-EXT-STS:power_state               | 0                                                |\n| OS-EXT-STS:task_state                | scheduling                                       |\n| OS-EXT-STS:vm_state                  | building                                         |\n| OS-SRV-USG:launched_at               | -                                                |\n| OS-SRV-USG:terminated_at             | -                                                |\n| accessIPv4                           |                                                  |\n| accessIPv6                           |                                                  |\n| adminPass                            | DNTr8MG3kVmC                                     |\n| config_drive                         |                                                  |\n| created                              | 2016-10-13T21:54:08Z                             |\n| flavor                               | m1.large (4)                                     |\n| hostId                               |                                                  |\n| id                                   | 9541b63c-e003-4bcc-bcb8-5c0461522387             |\n| image                                | Attempt to boot from volume - no image supplied  |\n| key_name                             | -                                                |\n| metadata                             | {}                                               |\n| name                                 | ol4                                              |\n| os-extended-volumes:volumes_attached | [{\"id\": \"2e733722-8b19-4bff-bd8d-bb770554582a\"}] |\n| progress                             | 0                                                |\n| security_groups                      | default                                          |\n| status                               | BUILD                                            |\n| tenant_id                            | 66234fea2ccc42398a1ae5300c594d49                 |\n| updated                              | 2016-10-13T21:54:08Z                             |\n| user_id                              | b2ae6b7bdac142ddb708a3550f61d998                 |\n+--------------------------------------+--------------------------------------------------+\n\n~$ cinder list\n+--------------------------------------+----------+------+------+-------------+----------+--------------------------------------+\n| ID                                   | Status   | Name | Size | Volume Type | Bootable | Attached to                          |\n+--------------------------------------+----------+------+------+-------------+----------+--------------------------------------+\n| 2e733722-8b19-4bff-bd8d-bb770554582a | in-use   | data | 1    | -           | false    | 9541b63c-e003-4bcc-bcb8-5c0461522387 |\n| a5a9f27b-8c8b-4cd5-bda8-998cc4cc6f32 | creating |      | 5    | -           | false    |                                      |\n+--------------------------------------+----------+------+------+-------------+----------+--------------------------------------+\n\n~$ cinder list\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n| ID                                   | Status | Name | Size | Volume Type | Bootable | Attached to                          |\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n| 2e733722-8b19-4bff-bd8d-bb770554582a | in-use | data | 1    | -           | false    | 9541b63c-e003-4bcc-bcb8-5c0461522387 |\n| a5a9f27b-8c8b-4cd5-bda8-998cc4cc6f32 | error  |      | 5    | -           | false    |                                      |\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n\n~$ nova volume-detach 9541b63c-e003-4bcc-bcb8-5c0461522387 2e733722-8b19-4bff-bd8d-bb770554582a\nERROR (Conflict): Cannot 'detach_volume' instance 9541b63c-e003-4bcc-bcb8-5c0461522387 while it is in vm_state error (HTTP 409) (Request-ID: req-c2855350-f06b-4c17-b429-87a068eddfb1)\n\n~$ nova delete 9541b63c-e003-4bcc-bcb8-5c0461522387\nRequest to delete server 9541b63c-e003-4bcc-bcb8-5c0461522387 has been accepted.\n\n~$ nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n\n~$ cinder list\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n| ID                                   | Status | Name | Size | Volume Type | Bootable | Attached to                          |\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n| 2e733722-8b19-4bff-bd8d-bb770554582a | in-use | data | 1    | -           | false    | 9541b63c-e003-4bcc-bcb8-5c0461522387 |\n| a5a9f27b-8c8b-4cd5-bda8-998cc4cc6f32 | error  |      | 5    | -           | false    |                                      |\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n\n~$ nova show 9541b63c-e003-4bcc-bcb8-5c0461522387\nERROR (CommandError): No server with a name or ID of '9541b63c-e003-4bcc-bcb8-5c0461522387' exists.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1633249", 
    "owner": "None", 
    "id": 1633249, 
    "index": 4653, 
    "openned": "2016-10-13 23:09:34.457403+00:00", 
    "created": "2016-10-13 23:04:42.521074+00:00", 
    "title": "Boot volume creation failure leaves secondary volume attached to broken server", 
    "comments": [
        {
            "content": "Attempt to boot a server with a block device mapping that includes a boot volume created from an image, plus an existing data volume. If the boot-volume creation fails, the data volume is left in state \"in-use\", attached to the server which is now in \"error\" state\". The user can't detach the volume because of the server's error state. They can delete the server, which then leaves the volume apparently attached to a server that no longer exists. The only way out of this is to ask an administrator to reset the state of the data volume (this option is not available to regular users by default policy).\n\nThe easiest way to reproduce this is to attempt to create the boot volume from qcow2 image where the volume size is less than the image (virtual) size.\n\n ~$ cinder list\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+\n| ID                                   | Status    | Name | Size | Volume Type | Bootable | Attached to |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+\n| 2e733722-8b19-4bff-bd8d-bb770554582a | available | data | 1    | -           | false    |             |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+\n\n~$ nova boot --flavor m1.large --availability-zone=imot04-1 --block-device 'id=9e122d18-d7a4-406d-b8f2-446cfddaa7c7,source=image,dest=volume,device=vda,size=5,bootindex=0' --block-device 'id=2e733722-8b19-4bff-bd8d-bb770554582a,source=volume,dest=volume,device=vdb,size=1,bootindex=1' ol4\n+--------------------------------------+--------------------------------------------------+\n| Property                             | Value                                            |\n+--------------------------------------+--------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                           |\n| OS-EXT-AZ:availability_zone          | imot04-1                                         |\n| OS-EXT-SRV-ATTR:host                 | -                                                |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                |\n| OS-EXT-SRV-ATTR:instance_name        |                                                  |\n| OS-EXT-STS:power_state               | 0                                                |\n| OS-EXT-STS:task_state                | scheduling                                       |\n| OS-EXT-STS:vm_state                  | building                                         |\n| OS-SRV-USG:launched_at               | -                                                |\n| OS-SRV-USG:terminated_at             | -                                                |\n| accessIPv4                           |                                                  |\n| accessIPv6                           |                                                  |\n| adminPass                            | DNTr8MG3kVmC                                     |\n| config_drive                         |                                                  |\n| created                              | 2016-10-13T21:54:08Z                             |\n| flavor                               | m1.large (4)                                     |\n| hostId                               |                                                  |\n| id                                   | 9541b63c-e003-4bcc-bcb8-5c0461522387             |\n| image                                | Attempt to boot from volume - no image supplied  |\n| key_name                             | -                                                |\n| metadata                             | {}                                               |\n| name                                 | ol4                                              |\n| os-extended-volumes:volumes_attached | [{\"id\": \"2e733722-8b19-4bff-bd8d-bb770554582a\"}] |\n| progress                             | 0                                                |\n| security_groups                      | default                                          |\n| status                               | BUILD                                            |\n| tenant_id                            | 66234fea2ccc42398a1ae5300c594d49                 |\n| updated                              | 2016-10-13T21:54:08Z                             |\n| user_id                              | b2ae6b7bdac142ddb708a3550f61d998                 |\n+--------------------------------------+--------------------------------------------------+\n\n~$ cinder list\n+--------------------------------------+----------+------+------+-------------+----------+--------------------------------------+\n| ID                                   | Status   | Name | Size | Volume Type | Bootable | Attached to                          |\n+--------------------------------------+----------+------+------+-------------+----------+--------------------------------------+\n| 2e733722-8b19-4bff-bd8d-bb770554582a | in-use   | data | 1    | -           | false    | 9541b63c-e003-4bcc-bcb8-5c0461522387 |\n| a5a9f27b-8c8b-4cd5-bda8-998cc4cc6f32 | creating |      | 5    | -           | false    |                                      |\n+--------------------------------------+----------+------+------+-------------+----------+--------------------------------------+\n\n~$ cinder list\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n| ID                                   | Status | Name | Size | Volume Type | Bootable | Attached to                          |\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n| 2e733722-8b19-4bff-bd8d-bb770554582a | in-use | data | 1    | -           | false    | 9541b63c-e003-4bcc-bcb8-5c0461522387 |\n| a5a9f27b-8c8b-4cd5-bda8-998cc4cc6f32 | error  |      | 5    | -           | false    |                                      |\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n\n~$ nova volume-detach 9541b63c-e003-4bcc-bcb8-5c0461522387 2e733722-8b19-4bff-bd8d-bb770554582a\nERROR (Conflict): Cannot 'detach_volume' instance 9541b63c-e003-4bcc-bcb8-5c0461522387 while it is in vm_state error (HTTP 409) (Request-ID: req-c2855350-f06b-4c17-b429-87a068eddfb1)\n\n~$ nova delete 9541b63c-e003-4bcc-bcb8-5c0461522387\nRequest to delete server 9541b63c-e003-4bcc-bcb8-5c0461522387 has been accepted.\n\n~$ nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n\n~$ cinder list\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n| ID                                   | Status | Name | Size | Volume Type | Bootable | Attached to                          |\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n| 2e733722-8b19-4bff-bd8d-bb770554582a | in-use | data | 1    | -           | false    | 9541b63c-e003-4bcc-bcb8-5c0461522387 |\n| a5a9f27b-8c8b-4cd5-bda8-998cc4cc6f32 | error  |      | 5    | -           | false    |                                      |\n+--------------------------------------+--------+------+------+-------------+----------+--------------------------------------+\n\n~$ nova show 9541b63c-e003-4bcc-bcb8-5c0461522387\nERROR (CommandError): No server with a name or ID of '9541b63c-e003-4bcc-bcb8-5c0461522387' exists.", 
            "date_created": "2016-10-13 23:04:42.521074+00:00", 
            "author": "https://api.launchpad.net/1.0/~imacdonn"
        }, 
        {
            "content": "Just ran into this while looking at another bug.  Specifying a pysical_block_size doesn't seem to work any longer so you end up with a boot failure.  The annoying things are that first off even though boot failed the Instance is listed as Active and Up, and then after deteting the failure, and deleting the Instance as reported in this bug the volume is never detached.\n\nLooking at the logs it appears that the cleanup never issues any of the Cinder calls to clean things up.", 
            "date_created": "2016-10-19 16:06:35.515284+00:00", 
            "author": "https://api.launchpad.net/1.0/~john-griffith"
        }, 
        {
            "content": "removing Cinder as Nova never even made the terminate/detach calls to Cinder in this case.", 
            "date_created": "2016-10-19 16:07:22.803191+00:00", 
            "author": "https://api.launchpad.net/1.0/~john-griffith"
        }, 
        {
            "content": "Lee, are you working on this? If not, please change status accordingly. ", 
            "date_created": "2017-01-05 19:17:33.117222+00:00", 
            "author": "https://api.launchpad.net/1.0/~mszankin"
        }, 
        {
            "content": "\nThere are no currently open reviews on this bug, changing\nthe status back to the previous state and unassigning. If\nthere are active reviews related to this bug, please include\nlinks in comments.\n", 
            "date_created": "2017-06-23 12:48:34.909383+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}