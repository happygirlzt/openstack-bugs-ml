{
    "status": "Fix Released", 
    "last_updated": "2016-02-19 20:18:03.274024+00:00", 
    "description": "If the instance of a normal user is resized by admin, the user_id for quota usage will be changed to admin.\n\nReproduce:\nWe have two user 'admin' and 'test1' which is a normal user. \n1. Create an instance by 'test1', the quota_usage table should be like:\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource  | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  7 | 6a47816024ef4860b1a218510a1658a9 | instances |      1 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  8 | 6a47816024ef4860b1a218510a1658a9 | ram       |    512 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  9 | 6a47816024ef4860b1a218510a1658a9 | cores     |      1 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+\n\n\n2. Resize the instance by admin:\n# nova list --all-tenants\n+--------------------------------------+------+--------+------------+-------------+-----------------+\n| ID                                   | Name | Status | Task State | Power State | Networks        |\n+--------------------------------------+------+--------+------------+-------------+-----------------+\n| a05f62b8-3f14-473c-9d64-b950b4dbfc9e | test | ACTIVE | None       | Running     | test=10.10.10.2 |\n+--------------------------------------+------+--------+------------+-------------+-----------------+\n\n# nova flavor-list\n+--------------------------------------+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| ID                                   | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |\n+--------------------------------------+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| 1                                    | m1.tiny   | 512       | 1    | 0         |      | 1     | 1.0         | True      |\n| 2                                    | m1.small  | 2048      | 20   | 0         |      | 1     | 1.0         | True      |\n| 2ee75e0f-37e1-4561-a5e2-43b8fd677547 | m2.tiny   | 512       | 0    | 0         |      | 2     | 1.0         | True      |\n| 3                                    | m1.medium | 4096      | 40   | 0         |      | 2     | 1.0         | True      |\n| 4                                    | m1.large  | 8192      | 80   | 0         |      | 4     | 1.0         | True      |\n| 5                                    | m1.xlarge | 16384     | 160  | 0         |      | 8     | 1.0         | True      |\n+--------------------------------------+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n\n# nova resize a05f62b8-3f14-473c-9d64-b950b4dbfc9e 2ee75e0f-37e1-4561-a5e2-43b8fd677547\n\nquota_usage table would create new records with the user_id for the admin.\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource  | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  7 | 6a47816024ef4860b1a218510a1658a9 | instances |      1 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  8 | 6a47816024ef4860b1a218510a1658a9 | ram       |    512 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  9 | 6a47816024ef4860b1a218510a1658a9 | cores     |      1 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n| 2014-01-13 08:39:28 | 2014-01-13 08:39:28 | NULL       | 10 | 6a47816024ef4860b1a218510a1658a9 | cores     |      0 |        1 |          NULL |       0 | ad99c3d4311b4940b083b52fbf73789c |\n| 2014-01-13 08:39:28 | 2014-01-13 08:39:28 | NULL       | 11 | 6a47816024ef4860b1a218510a1658a9 | instances |      0 |        0 |          NULL |       0 | ad99c3d4311b4940b083b52fbf73789c |\n| 2014-01-13 08:39:28 | 2014-01-13 08:39:28 | NULL       | 12 | 6a47816024ef4860b1a218510a1658a9 | ram       |      0 |        0 |          NULL |       0 | ad99c3d4311b4940b083b52fbf73789c |\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+", 
    "tags": [
        "in-stable-icehouse"
    ], 
    "importance": "High", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1271541", 
    "owner": "https://api.launchpad.net/1.0/~liyingjun", 
    "id": 1271541, 
    "index": 1374, 
    "openned": "2014-01-22 13:31:28.120757+00:00", 
    "created": "2014-01-22 13:31:28.120757+00:00", 
    "title": "Quota usage data wrong after instance resized by admin", 
    "comments": [
        {
            "content": "If the instance of a normal user is resized by admin, the user_id for quota usage will be changed to admin.\n\nReproduce:\nWe have two user 'admin' and 'test1' which is a normal user. \n1. Create an instance by 'test1', the quota_usage table should be like:\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource  | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  7 | 6a47816024ef4860b1a218510a1658a9 | instances |      1 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  8 | 6a47816024ef4860b1a218510a1658a9 | ram       |    512 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  9 | 6a47816024ef4860b1a218510a1658a9 | cores     |      1 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+\n\n\n2. Resize the instance by admin:\n# nova list --all-tenants\n+--------------------------------------+------+--------+------------+-------------+-----------------+\n| ID                                   | Name | Status | Task State | Power State | Networks        |\n+--------------------------------------+------+--------+------------+-------------+-----------------+\n| a05f62b8-3f14-473c-9d64-b950b4dbfc9e | test | ACTIVE | None       | Running     | test=10.10.10.2 |\n+--------------------------------------+------+--------+------------+-------------+-----------------+\n\n# nova flavor-list\n+--------------------------------------+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| ID                                   | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |\n+--------------------------------------+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n| 1                                    | m1.tiny   | 512       | 1    | 0         |      | 1     | 1.0         | True      |\n| 2                                    | m1.small  | 2048      | 20   | 0         |      | 1     | 1.0         | True      |\n| 2ee75e0f-37e1-4561-a5e2-43b8fd677547 | m2.tiny   | 512       | 0    | 0         |      | 2     | 1.0         | True      |\n| 3                                    | m1.medium | 4096      | 40   | 0         |      | 2     | 1.0         | True      |\n| 4                                    | m1.large  | 8192      | 80   | 0         |      | 4     | 1.0         | True      |\n| 5                                    | m1.xlarge | 16384     | 160  | 0         |      | 8     | 1.0         | True      |\n+--------------------------------------+-----------+-----------+------+-----------+------+-------+-------------+-----------+\n\n# nova resize a05f62b8-3f14-473c-9d64-b950b4dbfc9e 2ee75e0f-37e1-4561-a5e2-43b8fd677547\n\nquota_usage table would create new records with the user_id for the admin.\nmysql> select * from quota_usages;\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+\n| created_at          | updated_at          | deleted_at | id | project_id                       | resource  | in_use | reserved | until_refresh | deleted | user_id                          |\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  7 | 6a47816024ef4860b1a218510a1658a9 | instances |      1 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  8 | 6a47816024ef4860b1a218510a1658a9 | ram       |    512 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n| 2014-01-13 08:31:28 | 2014-01-13 08:31:28 | NULL       |  9 | 6a47816024ef4860b1a218510a1658a9 | cores     |      1 |        0 |          NULL |       0 | ea75fd9954244be9b92c2aec99305f63 |\n| 2014-01-13 08:39:28 | 2014-01-13 08:39:28 | NULL       | 10 | 6a47816024ef4860b1a218510a1658a9 | cores     |      0 |        1 |          NULL |       0 | ad99c3d4311b4940b083b52fbf73789c |\n| 2014-01-13 08:39:28 | 2014-01-13 08:39:28 | NULL       | 11 | 6a47816024ef4860b1a218510a1658a9 | instances |      0 |        0 |          NULL |       0 | ad99c3d4311b4940b083b52fbf73789c |\n| 2014-01-13 08:39:28 | 2014-01-13 08:39:28 | NULL       | 12 | 6a47816024ef4860b1a218510a1658a9 | ram       |      0 |        0 |          NULL |       0 | ad99c3d4311b4940b083b52fbf73789c |\n+---------------------+---------------------+------------+----+----------------------------------+-----------+--------+----------+---------------+---------+----------------------------------+", 
            "date_created": "2014-01-22 13:31:28.120757+00:00", 
            "author": "https://api.launchpad.net/1.0/~liyingjun"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/68391", 
            "date_created": "2014-01-22 14:14:52.262929+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/82376\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0a717d7085bd2bca7e5408a5c20e8ae7cd055756\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0a717d7085bd2bca7e5408a5c20e8ae7cd055756\nAuthor: Chris Behrens <email address hidden>\nDate:   Fri Mar 21 19:11:00 2014 +0000\n\n    Use correct project/user for quotas\n    \n    This fixes the compute manager to ensure the proper project_id/user_id\n    is used when making quota calls by converting most of the compute\n    manager code to use the new objects. This does not change the RPC\n    messages to the manager, yet.\n    \n    Change-Id: I50601d12edef735f3c01ad73445e0826d05efc51\n    Closes-bug: 1271541\n", 
            "date_created": "2014-04-02 18:36:48.992365+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/icehouse\nReview: https://review.openstack.org/99215", 
            "date_created": "2014-06-10 21:41:30.954025+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/99215\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0994254867c0ee7bab7fc5ca9176c588f926fe00\nSubmitter: Jenkins\nBranch:    stable/icehouse\n\ncommit 0994254867c0ee7bab7fc5ca9176c588f926fe00\nAuthor: Chris Behrens <email address hidden>\nDate:   Fri Mar 21 19:11:00 2014 +0000\n\n    Use correct project/user for quotas\n    \n    This fixes the compute manager to ensure the proper project_id/user_id\n    is used when making quota calls by converting most of the compute\n    manager code to use the new objects. This does not change the RPC\n    messages to the manager, yet.\n    \n    Change-Id: I50601d12edef735f3c01ad73445e0826d05efc51\n    Closes-bug: 1271541\n    (cherry picked from commit 0a717d7085bd2bca7e5408a5c20e8ae7cd055756)\n", 
            "date_created": "2014-07-23 12:19:47.070588+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-06-11 13:40:32.154996+00:00"
}