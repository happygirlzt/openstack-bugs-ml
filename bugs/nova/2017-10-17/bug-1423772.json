{
    "status": "Fix Released", 
    "last_updated": "2016-01-21 23:19:40.774298+00:00", 
    "description": "When attempting to do a live-migration on an instance with one or more attached volumes, Nova expects that the IQN will be exactly the same as it's attaching the volume(s) to the new host. This conflicts with the Cinder settings such as \"hp3par_iscsi_ips\" which allows for multiple IPs for the purpose of load balancing.\n\nExample:\nAn instance on Host A has a volume attached at \"/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2\"\nAn attempt is made to migrate the instance to Host B.\nCinder sends the request to attach the volume to the new host.\nCinder gives the new host \"/dev/disk/by-path/ip-10.10.120.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2\"\nNova looks for the volume on the new host at the old location \"/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2\"\n\nThe following error appears in n-cpu in this case:\n\n2015-02-19 17:09:05.574 ERROR nova.virt.libvirt.driver [-] [instance: b6fa616f-4e78-42b1-a747-9d081a4701df] Live Migration failure: Failed to open file '/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2': No such file or directory\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/poll.py\", line 115, in wait\n    listener.cb(fileno)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 212, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5426, in _live_migration\n    recover_method(context, instance, dest, block_migration)\n  File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 82, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5393, in _live_migration\n    CONF.libvirt.live_migration_bandwidth)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 1582, in migrateToURI2\n    if ret == -1: raise libvirtError ('virDomainMigrateToURI2() failed', dom=self)\nlibvirtError: Failed to open file '/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2': No such file or directory\nRemoving descriptor: 3\n\n\nWhen looking at the nova DB, this is the state of block_device_mapping prior to the migration attempt:\n\nmysql> select * from block_device_mapping where instance_uuid='b6fa616f-4e78-42b1-a747-9d081a4701df' and deleted=0;\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n| created_at          | updated_at          | deleted_at | id | device_name | delete_on_termination | snapshot_id | volume_id                            | volume_size | no_device | connection_info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | instance_uuid                        | deleted | source_type | destination_type | guest_format | device_type | disk_bus | boot_index | image_id |\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n| 2015-02-20 00:57:01 | 2015-02-20 01:03:06 | NULL       |  3 | /dev/vda    |                     0 | NULL        | e031b804-f824-45f1-a9fa-b9330ba061e0 |        NULL |      NULL | {\"driver_volume_type\": \"iscsi\", \"serial\": \"e031b804-f824-45f1-a9fa-b9330ba061e0\", \"data\": {\"host_device\": \"/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-1\", \"target_discovered\": true, \"qos_specs\": null, \"target_iqn\": \"iqn.2000-05.com.3pardata:22210002ac002a13\", \"target_portal\": \"10.10.220.244:3260\", \"target_lun\": 1, \"access_mode\": \"rw\"}}                                                                                                                 | b6fa616f-4e78-42b1-a747-9d081a4701df |       0 | volume      | volume           | NULL         | disk        | virtio   |          0 | NULL     |\n| 2015-02-20 01:07:11 | 2015-02-20 01:07:19 | NULL       |  5 | /dev/vdb    |                     0 | NULL        | c3009a3d-549d-4ee5-b7a6-b0eac6382beb |        NULL |      NULL | {\"driver_volume_type\": \"iscsi\", \"serial\": \"c3009a3d-549d-4ee5-b7a6-b0eac6382beb\", \"data\": {\"device_path\": \"/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2\", \"host_device\": \"/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2\", \"target_discovered\": true, \"qos_specs\": null, \"target_iqn\": \"iqn.2000-05.com.3pardata:22210002ac002a13\", \"target_portal\": \"10.10.220.244:3260\", \"target_lun\": 2, \"access_mode\": \"rw\"}} | b6fa616f-4e78-42b1-a747-9d081a4701df |       0 | volume      | volume           | NULL         | NULL        | NULL     |       NULL | NULL     |\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n2 rows in set (0.00 sec)\n\n\n\n\n\n\nThen after the error message comes up in n-cpu:\n\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n| created_at          | updated_at          | deleted_at | id | device_name | delete_on_termination | snapshot_id | volume_id                            | volume_size | no_device | connection_info                                                                                                                                                                                                                                                                   | instance_uuid                        | deleted | source_type | destination_type | guest_format | device_type | disk_bus | boot_index | image_id |\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n| 2015-02-20 00:57:01 | 2015-02-20 01:08:55 | NULL       |  3 | /dev/vda    |                     0 | NULL        | e031b804-f824-45f1-a9fa-b9330ba061e0 |        NULL |      NULL | {\"driver_volume_type\": \"iscsi\", \"serial\": \"e031b804-f824-45f1-a9fa-b9330ba061e0\", \"data\": {\"target_discovered\": true, \"qos_specs\": null, \"target_iqn\": \"iqn.2000-05.com.3pardata:22210002ac002a13\", \"target_portal\": \"10.10.220.244:3260\", \"target_lun\": 0, \"access_mode\": \"rw\"}} | b6fa616f-4e78-42b1-a747-9d081a4701df |       0 | volume      | volume           | NULL         | disk        | virtio   |          0 | NULL     |\n| 2015-02-20 01:07:11 | 2015-02-20 01:08:57 | NULL       |  5 | /dev/vdb    |                     0 | NULL        | c3009a3d-549d-4ee5-b7a6-b0eac6382beb |        NULL |      NULL | {\"driver_volume_type\": \"iscsi\", \"serial\": \"c3009a3d-549d-4ee5-b7a6-b0eac6382beb\", \"data\": {\"target_discovered\": true, \"qos_specs\": null, \"target_iqn\": \"iqn.2000-05.com.3pardata:22210002ac002a13\", \"target_portal\": \"10.10.220.244:3260\", \"target_lun\": 1, \"access_mode\": \"rw\"}} | b6fa616f-4e78-42b1-a747-9d081a4701df |       0 | volume      | volume           | NULL         | NULL        | NULL     |       NULL | NULL     |\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n2 rows in set (0.00 sec)", 
    "tags": [
        "in-stable-juno", 
        "in-stable-kilo", 
        "live-migrate"
    ], 
    "importance": "Medium", 
    "heat": 18, 
    "link": "https://bugs.launchpad.net/nova/+bug/1423772", 
    "owner": "https://api.launchpad.net/1.0/~anthony-mic-lee", 
    "id": 1423772, 
    "index": 4158, 
    "openned": "2015-02-20 01:48:29.393979+00:00", 
    "created": "2015-02-20 01:48:29.393979+00:00", 
    "title": "During live-migration Nova expects identical IQN from attached volume(s)", 
    "comments": [
        {
            "content": "When attempting to do a live-migration on an instance with one or more attached volumes, Nova expects that the IQN will be exactly the same as it's attaching the volume(s) to the new host. This conflicts with the Cinder settings such as \"hp3par_iscsi_ips\" which allows for multiple IPs for the purpose of load balancing.\n\nExample:\nAn instance on Host A has a volume attached at \"/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2\"\nAn attempt is made to migrate the instance to Host B.\nCinder sends the request to attach the volume to the new host.\nCinder gives the new host \"/dev/disk/by-path/ip-10.10.120.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2\"\nNova looks for the volume on the new host at the old location \"/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2\"\n\nThe following error appears in n-cpu in this case:\n\n2015-02-19 17:09:05.574 ERROR nova.virt.libvirt.driver [-] [instance: b6fa616f-4e78-42b1-a747-9d081a4701df] Live Migration failure: Failed to open file '/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2': No such file or directory\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/poll.py\", line 115, in wait\n    listener.cb(fileno)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 212, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5426, in _live_migration\n    recover_method(context, instance, dest, block_migration)\n  File \"/opt/stack/nova/nova/openstack/common/excutils.py\", line 82, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5393, in _live_migration\n    CONF.libvirt.live_migration_bandwidth)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\n    rv = execute(f, *args, **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\n    six.reraise(c, e, tb)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\n    rv = meth(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/libvirt.py\", line 1582, in migrateToURI2\n    if ret == -1: raise libvirtError ('virDomainMigrateToURI2() failed', dom=self)\nlibvirtError: Failed to open file '/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2': No such file or directory\nRemoving descriptor: 3\n\n\nWhen looking at the nova DB, this is the state of block_device_mapping prior to the migration attempt:\n\nmysql> select * from block_device_mapping where instance_uuid='b6fa616f-4e78-42b1-a747-9d081a4701df' and deleted=0;\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n| created_at          | updated_at          | deleted_at | id | device_name | delete_on_termination | snapshot_id | volume_id                            | volume_size | no_device | connection_info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | instance_uuid                        | deleted | source_type | destination_type | guest_format | device_type | disk_bus | boot_index | image_id |\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n| 2015-02-20 00:57:01 | 2015-02-20 01:03:06 | NULL       |  3 | /dev/vda    |                     0 | NULL        | e031b804-f824-45f1-a9fa-b9330ba061e0 |        NULL |      NULL | {\"driver_volume_type\": \"iscsi\", \"serial\": \"e031b804-f824-45f1-a9fa-b9330ba061e0\", \"data\": {\"host_device\": \"/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-1\", \"target_discovered\": true, \"qos_specs\": null, \"target_iqn\": \"iqn.2000-05.com.3pardata:22210002ac002a13\", \"target_portal\": \"10.10.220.244:3260\", \"target_lun\": 1, \"access_mode\": \"rw\"}}                                                                                                                 | b6fa616f-4e78-42b1-a747-9d081a4701df |       0 | volume      | volume           | NULL         | disk        | virtio   |          0 | NULL     |\n| 2015-02-20 01:07:11 | 2015-02-20 01:07:19 | NULL       |  5 | /dev/vdb    |                     0 | NULL        | c3009a3d-549d-4ee5-b7a6-b0eac6382beb |        NULL |      NULL | {\"driver_volume_type\": \"iscsi\", \"serial\": \"c3009a3d-549d-4ee5-b7a6-b0eac6382beb\", \"data\": {\"device_path\": \"/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2\", \"host_device\": \"/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-2\", \"target_discovered\": true, \"qos_specs\": null, \"target_iqn\": \"iqn.2000-05.com.3pardata:22210002ac002a13\", \"target_portal\": \"10.10.220.244:3260\", \"target_lun\": 2, \"access_mode\": \"rw\"}} | b6fa616f-4e78-42b1-a747-9d081a4701df |       0 | volume      | volume           | NULL         | NULL        | NULL     |       NULL | NULL     |\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n2 rows in set (0.00 sec)\n\n\n\n\n\n\nThen after the error message comes up in n-cpu:\n\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n| created_at          | updated_at          | deleted_at | id | device_name | delete_on_termination | snapshot_id | volume_id                            | volume_size | no_device | connection_info                                                                                                                                                                                                                                                                   | instance_uuid                        | deleted | source_type | destination_type | guest_format | device_type | disk_bus | boot_index | image_id |\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n| 2015-02-20 00:57:01 | 2015-02-20 01:08:55 | NULL       |  3 | /dev/vda    |                     0 | NULL        | e031b804-f824-45f1-a9fa-b9330ba061e0 |        NULL |      NULL | {\"driver_volume_type\": \"iscsi\", \"serial\": \"e031b804-f824-45f1-a9fa-b9330ba061e0\", \"data\": {\"target_discovered\": true, \"qos_specs\": null, \"target_iqn\": \"iqn.2000-05.com.3pardata:22210002ac002a13\", \"target_portal\": \"10.10.220.244:3260\", \"target_lun\": 0, \"access_mode\": \"rw\"}} | b6fa616f-4e78-42b1-a747-9d081a4701df |       0 | volume      | volume           | NULL         | disk        | virtio   |          0 | NULL     |\n| 2015-02-20 01:07:11 | 2015-02-20 01:08:57 | NULL       |  5 | /dev/vdb    |                     0 | NULL        | c3009a3d-549d-4ee5-b7a6-b0eac6382beb |        NULL |      NULL | {\"driver_volume_type\": \"iscsi\", \"serial\": \"c3009a3d-549d-4ee5-b7a6-b0eac6382beb\", \"data\": {\"target_discovered\": true, \"qos_specs\": null, \"target_iqn\": \"iqn.2000-05.com.3pardata:22210002ac002a13\", \"target_portal\": \"10.10.220.244:3260\", \"target_lun\": 1, \"access_mode\": \"rw\"}} | b6fa616f-4e78-42b1-a747-9d081a4701df |       0 | volume      | volume           | NULL         | NULL        | NULL     |       NULL | NULL     |\n+---------------------+---------------------+------------+----+-------------+-----------------------+-------------+--------------------------------------+-------------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+------------------+--------------+-------------+----------+------------+----------+\n2 rows in set (0.00 sec)", 
            "date_created": "2015-02-20 01:48:29.393979+00:00", 
            "author": "https://api.launchpad.net/1.0/~sseverson"
        }, 
        {
            "content": "I was able to reproduce this in Kilo (the original discovery was in Juno), with the same error:\n\n2015-02-20 16:12:52.802 ERROR nova.virt.libvirt.driver [-] [instance: 93ba0373-15cd-4e83-845d-4cfaf7c11416] Live Migration failure: Failed to open file '/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-1': No such file or directory\n2015-02-20 16:12:54.381 ERROR root [-] Original exception being dropped: ['Traceback (most recent call last):\\n', '  File \"/opt/stack/n          ova/nova/virt/libvirt/driver.py\", line 5249, in _live_migration\\n    CONF.libvirt.live_migration_bandwidth)\\n', '  File \"/usr/local/lib          /python2.7/dist-packages/eventlet/tpool.py\", line 183, in doit\\n    result = proxy_call(self._autowrap, f, *args, **kwargs)\\n', '  File           \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 141, in proxy_call\\n    rv = execute(f, *args, **kwargs)\\n', '  File           \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 122, in execute\\n    six.reraise(c, e, tb)\\n', '  File \"/usr/local/lib          /python2.7/dist-packages/eventlet/tpool.py\", line 80, in tworker\\n    rv = meth(*args, **kwargs)\\n', '  File \"/usr/lib/python2.7/dist-p          ackages/libvirt.py\", line 1582, in migrateToURI2\\n    if ret == -1: raise libvirtError (\\'virDomainMigrateToURI2() failed\\', dom=self)\\          n', \"libvirtError: Failed to open file '/dev/disk/by-path/ip-10.10.220.244:3260-iscsi-iqn.2000-05.com.3pardata:22210002ac002a13-lun-1':           No such file or directory\\n\"]\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/poll.py\", line 115, in wait\n    listener.cb(fileno)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 5282, in _live_migration\n    recover_method(context, instance, dest, block_migration)\n  File \"/opt/stack/nova/nova/exception.py\", line 88, in wrapped\n    payload)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 82, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/exception.py\", line 71, in wrapped\n    return f(self, context, *args, **kw)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 324, in decorated_function\n    kwargs['instance'], e, sys.exc_info())\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 82, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 312, in decorated_function\n    return function(self, context, *args, **kwargs)\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 5297, in _rollback_live_migration\n    context, instance, bdm.volume_id, dest)\n  File \"/opt/stack/nova/nova/compute/rpcapi.py\", line 677, in remove_volume_connection\n    instance=instance, volume_id=volume_id)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 156, in call\n    retry=self.retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n    timeout=timeout, retry=retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 417, in send\n    retry=retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 408, in _send\n    raise result\nTypeError: argument of type 'NoneType' is not iterable\nTraceback (most recent call last):\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n    executor_callback))\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n    executor_callback)\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/dispatcher.py\", line 130, in _do_dispatch\n    result = func(ctxt, **new_args)\n\n  File \"/opt/stack/nova/nova/exception.py\", line 88, in wrapped\n    payload)\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 82, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n\n  File \"/opt/stack/nova/nova/exception.py\", line 71, in wrapped\n    return f(self, context, *args, **kw)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 4847, in remove_volume_connection\n    self._detach_volume(context, instance, bdm)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 4692, in _detach_volume\n    self.volume_api.roll_detaching(context, volume_id)\n\n  File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 82, in __exit__\n    six.reraise(self.type_, self.value, self.tb)\n\n  File \"/opt/stack/nova/nova/compute/manager.py\", line 4675, in _detach_volume\n    context, self.volume_api, volume_id, connection_info)\n\n  File \"/opt/stack/nova/nova/volume/encryptors/__init__.py\", line 52, in get_encryption_metadata\n    if ('data' in connection_info and\n\nTypeError: argument of type 'NoneType' is not iterable\n\nRemoving descriptor: 3\n", 
            "date_created": "2015-02-21 00:14:39.465485+00:00", 
            "author": "https://api.launchpad.net/1.0/~sseverson"
        }, 
        {
            "content": "We're running into this same issue on Icehouse. We have a central storage appliance that is attaching volumes over iSCSI. I'm happy to provide further information or logs.", 
            "date_created": "2015-03-09 19:42:39.871310+00:00", 
            "author": "https://api.launchpad.net/1.0/~joe-topjian-v"
        }, 
        {
            "content": "This patch fixed the issue for us:\n\nhttps://review.openstack.org/#/c/137466/\n\nWe're running Icehouse, but it was fairly trivial to make the changes.", 
            "date_created": "2015-03-19 21:56:45.358226+00:00", 
            "author": "https://api.launchpad.net/1.0/~joe-topjian-v"
        }, 
        {
            "content": "Fix proposed to branch: stable/kilo\nReview: https://review.openstack.org/211051", 
            "date_created": "2015-08-10 09:03:30.830170+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/202770\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8b649aa86fb26e998d66e75e5cebfd19c396942d\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8b649aa86fb26e998d66e75e5cebfd19c396942d\nAuthor: Anthony Lee <email address hidden>\nDate:   Thu Jul 16 13:02:00 2015 -0700\n\n    Fix live-migrations usage of the wrong connector information\n    \n    During the post_live_migration step for the Nova libvirt driver\n    an incorrect assumption is being made about the connector\n    information being sent to _disconnect_volume. It is assumed that\n    the connection information on the source and destination is the\n    same but that is not always the case. The BDM, where the\n    connector information is being retrieved from only contains the\n    connection information for the destination. This will not work\n    when trying to disconnect volumes from the source during live\n    migration as the properties such as the target_lun and\n    initiator_target_map could be different. This ends up leaving\n    behind dangling LUNs and possibly removing the incorrect\n    volume's LUNs.\n    \n    The solution proposed here utilizes the connection_info that\n    can be retrieved for a host from Cinder's initialize_connection\n    API. This connection information contains the correct data for\n    the source host and allows volume LUNs to be removed properly.\n    \n    Change-Id: I3dfb75eb58dfbc66b218bcee473af4c2ac282eb6\n    Closes-Bug: #1475411\n    Closes-Bug: #1288039\n    Closes-Bug: #1423772\n", 
            "date_created": "2015-08-10 11:30:24.534815+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/211051\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=587092c909e15e983f7aef31d7bc0862271a32c7\nSubmitter: Jenkins\nBranch:    stable/kilo\n\ncommit 587092c909e15e983f7aef31d7bc0862271a32c7\nAuthor: Anthony Lee <email address hidden>\nDate:   Thu Jul 16 13:02:00 2015 -0700\n\n    Fix live-migrations usage of the wrong connector information\n    \n    During the post_live_migration step for the Nova libvirt driver\n    an incorrect assumption is being made about the connector\n    information being sent to _disconnect_volume. It is assumed that\n    the connection information on the source and destination is the\n    same but that is not always the case. The BDM, where the\n    connector information is being retrieved from only contains the\n    connection information for the destination. This will not work\n    when trying to disconnect volumes from the source during live\n    migration as the properties such as the target_lun and\n    initiator_target_map could be different. This ends up leaving\n    behind dangling LUNs and possibly removing the incorrect\n    volume's LUNs.\n    \n    The solution proposed here utilizes the connection_info that\n    can be retrieved for a host from Cinder's initialize_connection\n    API. This connection information contains the correct data for\n    the source host and allows volume LUNs to be removed properly.\n    \n    --\n    \n    NOTE(sahid): The TODO comment in the original change on master is\n    omitted here since os-brick wasn't used by nova in kilo so leaving\n    it in the backport would be confusing.\n    \n    Change-Id: I3dfb75eb58dfbc66b218bcee473af4c2ac282eb6\n    Closes-Bug: #1475411\n    Closes-Bug: #1288039\n    Closes-Bug: #1423772\n", 
            "date_created": "2015-08-19 00:44:27.734109+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/juno\nReview: https://review.openstack.org/228517", 
            "date_created": "2015-09-28 16:06:07.002392+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/228517\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=9d2abbd9ab60ca873650759feaba98b4d8d35566\nSubmitter: Jenkins\nBranch:    stable/juno\n\ncommit 9d2abbd9ab60ca873650759feaba98b4d8d35566\nAuthor: Anthony Lee <email address hidden>\nDate:   Thu Jul 16 13:02:00 2015 -0700\n\n    Fix live-migrations usage of the wrong connector information\n    \n    During the post_live_migration step for the Nova libvirt driver\n    an incorrect assumption is being made about the connector\n    information being sent to _disconnect_volume. It is assumed that\n    the connection information on the source and destination is the\n    same but that is not always the case. The BDM, where the\n    connector information is being retrieved from only contains the\n    connection information for the destination. This will not work\n    when trying to disconnect volumes from the source during live\n    migration as the properties such as the target_lun and\n    initiator_target_map could be different. This ends up leaving\n    behind dangling LUNs and possibly removing the incorrect\n    volume's LUNs.\n    \n    The solution proposed here utilizes the connection_info that\n    can be retrieved for a host from Cinder's initialize_connection\n    API. This connection information contains the correct data for\n    the source host and allows volume LUNs to be removed properly.\n    \n    Conflicts:\n            nova/tests/unit/virt/libvirt/test_driver.py\n    \n    NOTE(mriedem): The conflicts are due to the tests being moved\n    in Kilo and 41f80226e0a1f73af76c7968617ebfda0aeb40b1 not being\n    in stable/juno (renamed conn var to drvr in libvirt tests).\n    \n    Change-Id: I3dfb75eb58dfbc66b218bcee473af4c2ac282eb6\n    Closes-Bug: #1475411\n    Closes-Bug: #1288039\n    Closes-Bug: #1423772\n    (cherry picked from commit 587092c909e15e983f7aef31d7bc0862271a32c7)\n", 
            "date_created": "2015-09-28 19:20:07.610736+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-09-03 11:44:43.039426+00:00"
}