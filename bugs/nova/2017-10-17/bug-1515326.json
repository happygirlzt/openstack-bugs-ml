{
    "status": "Fix Released", 
    "last_updated": "2016-01-07 08:02:44.460016+00:00", 
    "description": "full log:\nhttp://52.27.155.124/240218/5/\nhttp://52.27.155.124/240218/5/screen-logs/n-api.log.gz\n\n\npip freeze:\nhttp://52.27.155.124/240218/5/pip-freeze.txt.gz\n\n\nF.Y.I a bug seems same but it's not:  https://bugs.launchpad.net/oslo.db/+bug/1477080\n\n\nrelated exception for your convenient: \n\nopt/stack/nova/nova/api/openstack/wsgi.py:792\n2015-11-11 22:02:42.644 ERROR nova.api.openstack.extensions [req-3e331369-71d7-448f-bb06-6ef34762bb73 tempest-InputScenarioUtils-640491222 tempest-InputScenarioUtils-1686267846] Unexpected exception in API method\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions Traceback (most recent call last):\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/flavors.py\", line 39, in index\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     limited_flavors = self._get_flavors(req)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/flavors.py\", line 110, in _get_flavors\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     limit=limit, marker=marker)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/flavors.py\", line 200, in get_all_flavors_sorted_list\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     marker=marker)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 171, in wrapper\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/flavor.py\", line 269, in get_all\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     marker=marker)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/api.py\", line 1442, in flavor_get_all\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     sort_dir=sort_dir, limit=limit, marker=marker)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 204, in wrapper\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 4698, in flavor_get_all\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     query = _flavor_get_query(context, read_deleted=read_deleted)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 4673, in _flavor_get_query\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     read_deleted=read_deleted).\\\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 266, in model_query\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     session = get_session(use_slave=use_slave)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 172, in get_session\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     use_slave=use_slave, **kwargs)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/enginefacade.py\", line 977, in get_session\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     return self._factory._writer_maker(**kwargs)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions AttributeError: '_TransactionFactory' object has no attribute '_writer_maker'\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions", 
    "tags": [], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1515326", 
    "owner": "https://api.launchpad.net/1.0/~snikitin", 
    "id": 1515326, 
    "index": 1836, 
    "openned": "2015-11-11 17:01:26.839990+00:00", 
    "created": "2015-11-11 17:01:26.839990+00:00", 
    "title": " nova.api.openstack.extensions AttributeError: '_TransactionFactory' object has no attribute '_writer_maker'", 
    "comments": [
        {
            "content": "full log:\nhttp://52.27.155.124/240218/5/\nhttp://52.27.155.124/240218/5/screen-logs/n-api.log.gz\n\n\npip freeze:\nhttp://52.27.155.124/240218/5/pip-freeze.txt.gz\n\n\nF.Y.I a bug seems same but it's not:  https://bugs.launchpad.net/oslo.db/+bug/1477080\n\n\nrelated exception for your convenient: \n\nopt/stack/nova/nova/api/openstack/wsgi.py:792\n2015-11-11 22:02:42.644 ERROR nova.api.openstack.extensions [req-3e331369-71d7-448f-bb06-6ef34762bb73 tempest-InputScenarioUtils-640491222 tempest-InputScenarioUtils-1686267846] Unexpected exception in API method\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions Traceback (most recent call last):\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/flavors.py\", line 39, in index\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     limited_flavors = self._get_flavors(req)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/flavors.py\", line 110, in _get_flavors\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     limit=limit, marker=marker)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/compute/flavors.py\", line 200, in get_all_flavors_sorted_list\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     marker=marker)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 171, in wrapper\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/flavor.py\", line 269, in get_all\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     marker=marker)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/api.py\", line 1442, in flavor_get_all\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     sort_dir=sort_dir, limit=limit, marker=marker)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 204, in wrapper\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 4698, in flavor_get_all\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     query = _flavor_get_query(context, read_deleted=read_deleted)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 4673, in _flavor_get_query\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     read_deleted=read_deleted).\\\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 266, in model_query\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     session = get_session(use_slave=use_slave)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 172, in get_session\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     use_slave=use_slave, **kwargs)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/enginefacade.py\", line 977, in get_session\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions     return self._factory._writer_maker(**kwargs)\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions AttributeError: '_TransactionFactory' object has no attribute '_writer_maker'\n2015-11-11 22:02:42.644 36750 ERROR nova.api.openstack.extensions", 
            "date_created": "2015-11-11 17:01:26.839990+00:00", 
            "author": "https://api.launchpad.net/1.0/~yongli-he"
        }, 
        {
            "content": "We've been seeing this in our regular CI as well:\nhttp://logstash.openstack.org/#/dashboard/file/logstash.json?query=message:%5C%22AttributeError:%20'_TransactionFactory'%20object%20has%20no%20attribute%20'_writer_maker'%5C%22&from=864000s", 
            "date_created": "2015-11-11 19:40:42.408251+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "davanum -\n\nis the fix in https://review.openstack.org/#/c/205646/ released?  it prevents this specific exception from occurring.   the issue is that when the connection fails due to mis-configuration or other issue, then the enginefacade is called a second time, it fails to go through the whole process again and assumes its initialized.", 
            "date_created": "2015-11-11 20:32:21.956630+00:00", 
            "author": "https://api.launchpad.net/1.0/~zzzeek"
        }, 
        {
            "content": "OK, this is a different codepath, so in that case if the enginefacade started improperly this path can still be hit.\n\nHowever it is still a secondary error to something else not being done correctly in the first place - the _TransactionFactory will have a _writer_maker if the database config was established.", 
            "date_created": "2015-11-11 20:37:32.095790+00:00", 
            "author": "https://api.launchpad.net/1.0/~zzzeek"
        }, 
        {
            "content": "so, this is not a configuration error, is should be a defect in some code in nova i think.  leading to occasionally hit this path.", 
            "date_created": "2015-11-11 20:41:22.666622+00:00", 
            "author": "https://api.launchpad.net/1.0/~yongli-he"
        }, 
        {
            "content": "Here's the bug in Nova. \n\nFirst, they are calling upon the private _factory member inappropriately:\n\ndef get_engine(use_slave=False):\n    return main_context_manager._factory.get_legacy_facade().get_engine(\n        use_slave=use_slave)\n\n\ndef get_api_engine():\n    return api_context_manager._factory.get_legacy_facade().get_engine()\n\n\ndef get_session(use_slave=False, **kwargs):\n    return main_context_manager._factory.get_legacy_facade().get_session(\n        use_slave=use_slave, **kwargs)\n\n\nSo that a LegacyEngineFacade is created without actually initializing the factory.  Then, the code that's failing here fails to call the configure() function, which would establish the factory with engine parameters.   \n\nIn oslo.db I can add a more descriptive exception message but you'd still get an error, and this error doesn't know about Nova having a function called \"configure()\" either.", 
            "date_created": "2015-11-11 20:56:24.225245+00:00", 
            "author": "https://api.launchpad.net/1.0/~zzzeek"
        }, 
        {
            "content": "I am hoping the stuff in the pipeline will fix some of these:\nhttps://review.openstack.org/#/q/project:openstack/nova+topic:bp/new-oslodb-enginefacade,n,z", 
            "date_created": "2015-11-11 21:00:39.887424+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "I'm actually not quite sure how they're getting to this point but a fix so that the same descriptive error is raised consistently is in https://review.openstack.org/#/c/244323/", 
            "date_created": "2015-11-11 21:35:25.110956+00:00", 
            "author": "https://api.launchpad.net/1.0/~zzzeek"
        }, 
        {
            "content": "Seen here in an openstackclient job:\n\nhttp://logs.openstack.org/04/240804/3/gate/gate-osc-dsvm-functional/9a34c38/logs/screen-n-api.txt.gz?level=TRACE#_2015-11-11_22_52_34_533\n\n2015-11-11 22:52:34.533 ERROR nova.api.openstack.extensions [req-4895a748-50ec-4d45-bfaa-28c170f6dee3 admin admin] Unexpected exception in API method\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions Traceback (most recent call last):\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/validation/__init__.py\", line 73, in wrapper\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     return func(*args, **kwargs)\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/validation/__init__.py\", line 73, in wrapper\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     return func(*args, **kwargs)\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/api/openstack/compute/flavor_manage.py\", line 80, in _create\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     is_public=is_public)\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/compute/flavors.py\", line 175, in create\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     flavor.create()\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 213, in wrapper\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     return fn(self, *args, **kwargs)\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/objects/flavor.py\", line 177, in create\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     db_flavor = db.flavor_create(self._context, updates, projects=projects)\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/api.py\", line 1434, in flavor_create\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     return IMPL.flavor_create(context, values, projects=projects)\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 4638, in flavor_create\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     session = get_session()\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/opt/stack/new/nova/nova/db/sqlalchemy/api.py\", line 172, in get_session\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     use_slave=use_slave, **kwargs)\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_db/sqlalchemy/enginefacade.py\", line 977, in get_session\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions     return self._factory._writer_maker(**kwargs)\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions AttributeError: '_TransactionFactory' object has no attribute '_writer_maker'\n2015-11-11 22:52:34.533 22634 ERROR nova.api.openstack.extensions ", 
            "date_created": "2015-11-12 20:15:07.322919+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "fixed in https://review.openstack.org/#/c/244323/", 
            "date_created": "2015-11-13 15:20:04.550039+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/246337", 
            "date_created": "2015-11-17 11:18:04.755497+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "this problem begin to affect SRIOV testing for Neutron,  example log:\nhttp://52.27.155.124/sriov/206033/10/screen-logs/n-api.log.gz", 
            "date_created": "2015-11-17 17:37:09.942674+00:00", 
            "author": "https://api.launchpad.net/1.0/~yongli-he"
        }, 
        {
            "content": "Openstack bot updated oslo.db version in Nova https://review.openstack.org/#/c/247118/ .\nAccording to Dims report the problem fixed in Nova:\n\nhttp://logstash.openstack.org/#/dashboard/file/logstash.json?query=message:%5C%22AttributeError:%20'_TransactionFactory'%20object%20has%20no%20attribute%20'_writer_maker'%5C%22&from=864000s ", 
            "date_created": "2015-11-19 10:07:16.444136+00:00", 
            "author": "https://api.launchpad.net/1.0/~snikitin"
        }
    ], 
    "closed": "2015-12-03 21:33:39.761666+00:00"
}