{
    "status": "Fix Released", 
    "last_updated": "2017-09-05 10:53:08.515244+00:00", 
    "description": "The admin context is used when nova-compute init host, the instance with task_states.POWERING_OFF would been stopped, but the method decorators @wrap_instance_event would try to query the InstanceAction record by request_id in admin context and instance_uuid, because the request_id was generated when init host, it was different with the stopping action request_id, the InstanceAction record couldn't been found, exception was raised, the instance can't been stopped.\n\nunpausing, rebooting, starting instance in init-host have same issue.\n\n\n2015-03-23 16:17:49.394 ERROR nova.compute.manager [req-7f5d1a87-475a-4403-88eb-01843f744125 None None] [instance: b9aadd79-e8f4-486f-8980-114b54a87d4d] Failed to stop instance\n Traceback (most recent call last):\n   File \"/opt/stack/nova/nova/compute/manager.py\", line 1050, in _init_instance\n     self.stop_instance(context, instance)\n   File \"/opt/stack/nova/nova/exception.py\", line 88, in wrapped\n     payload)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 85, in __exit__\n     six.reraise(self.type_, self.value, self.tb)\n   File \"/opt/stack/nova/nova/exception.py\", line 71, in wrapped\n     return f(self, context, *args, **kw)\n   File \"/opt/stack/nova/nova/compute/manager.py\", line 324, in decorated_function\n     LOG.warning(msg, e, instance_uuid=instance_uuid)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 85, in __exit__\n     six.reraise(self.type_, self.value, self.tb)\n   File \"/opt/stack/nova/nova/compute/manager.py\", line 295, in decorated_function\n     return function(self, context, *args, **kwargs)\n   File \"/opt/stack/nova/nova/compute/manager.py\", line 373, in decorated_function\n     with compute_utils.EventReporter(context, event_name, instance_uuid):\n   File \"/opt/stack/nova/nova/compute/utils.py\", line 477, in __enter__\n     self.context, uuid, self.event_name, want_result=False)\n   File \"/opt/stack/nova/nova/objects/base.py\", line 161, in wrapper\n     args, kwargs)\n   File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 334, in object_class_action\n     objver=objver, args=args, kwargs=kwargs)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 156, in call\n     retry=self.retry)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n     timeout=timeout, retry=retry)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 417, in send\n     retry=retry)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 408, in _send\n     raise result\n InstanceActionNotFound_Remote: Action for request_id req-5e38756f-d29f-4865-af22-68a44ccd83cb on instance b9aadd79-e8f4-486f-8980-114b54a87d4d not found\n Traceback (most recent call last):\n\n   File \"/opt/stack/nova/nova/conductor/manager.py\", line 422, in _object_dispatch\n     return getattr(target, method)(*args, **kwargs)\n\n   File \"/opt/stack/nova/nova/objects/base.py\", line 163, in wrapper\n     result = fn(cls, context, *args, **kwargs)\n\n   File \"/opt/stack/nova/nova/objects/instance_action.py\", line 170, in event_start\n     db_event = db.action_event_start(context, values)\n\n   File \"/opt/stack/nova/nova/db/api.py\", line 1850, in action_event_start\n     return IMPL.action_event_start(context, values)\n\n   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 5697, in action_event_start\n     instance_uuid=values['instance_uuid'])\n\n InstanceActionNotFound: Action for request_id req-5e38756f-d29f-4865-af22-68a44ccd83cb on instance b9aadd79-e8f4-486f-8980-114b54a87d4d not found", 
    "tags": [
        "compute"
    ], 
    "importance": "Low", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1435198", 
    "owner": "https://api.launchpad.net/1.0/~kiwik-chenrui", 
    "id": 1435198, 
    "index": 1628, 
    "openned": "2015-03-23 08:40:29.853311+00:00", 
    "created": "2015-03-23 08:40:29.853311+00:00", 
    "title": "Failed to stop intance when nova-compute init host", 
    "comments": [
        {
            "content": "The admin context is used when nova-compute init host, the instance with task_states.POWERING_OFF would been stopped, but the method decorators @wrap_instance_event would try to query the InstanceAction record by request_id in admin context and instance_uuid, because the request_id was generated when init host, it was different with the stopping action request_id, the InstanceAction record couldn't been found, exception was raised, the instance can't been stopped.\n\nunpausing, rebooting, starting instance in init-host have same issue.\n\n\n2015-03-23 16:17:49.394 ERROR nova.compute.manager [req-7f5d1a87-475a-4403-88eb-01843f744125 None None] [instance: b9aadd79-e8f4-486f-8980-114b54a87d4d] Failed to stop instance\n Traceback (most recent call last):\n   File \"/opt/stack/nova/nova/compute/manager.py\", line 1050, in _init_instance\n     self.stop_instance(context, instance)\n   File \"/opt/stack/nova/nova/exception.py\", line 88, in wrapped\n     payload)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 85, in __exit__\n     six.reraise(self.type_, self.value, self.tb)\n   File \"/opt/stack/nova/nova/exception.py\", line 71, in wrapped\n     return f(self, context, *args, **kw)\n   File \"/opt/stack/nova/nova/compute/manager.py\", line 324, in decorated_function\n     LOG.warning(msg, e, instance_uuid=instance_uuid)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\", line 85, in __exit__\n     six.reraise(self.type_, self.value, self.tb)\n   File \"/opt/stack/nova/nova/compute/manager.py\", line 295, in decorated_function\n     return function(self, context, *args, **kwargs)\n   File \"/opt/stack/nova/nova/compute/manager.py\", line 373, in decorated_function\n     with compute_utils.EventReporter(context, event_name, instance_uuid):\n   File \"/opt/stack/nova/nova/compute/utils.py\", line 477, in __enter__\n     self.context, uuid, self.event_name, want_result=False)\n   File \"/opt/stack/nova/nova/objects/base.py\", line 161, in wrapper\n     args, kwargs)\n   File \"/opt/stack/nova/nova/conductor/rpcapi.py\", line 334, in object_class_action\n     objver=objver, args=args, kwargs=kwargs)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py\", line 156, in call\n     retry=self.retry)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/transport.py\", line 90, in _send\n     timeout=timeout, retry=retry)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 417, in send\n     retry=retry)\n   File \"/usr/local/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py\", line 408, in _send\n     raise result\n InstanceActionNotFound_Remote: Action for request_id req-5e38756f-d29f-4865-af22-68a44ccd83cb on instance b9aadd79-e8f4-486f-8980-114b54a87d4d not found\n Traceback (most recent call last):\n\n   File \"/opt/stack/nova/nova/conductor/manager.py\", line 422, in _object_dispatch\n     return getattr(target, method)(*args, **kwargs)\n\n   File \"/opt/stack/nova/nova/objects/base.py\", line 163, in wrapper\n     result = fn(cls, context, *args, **kwargs)\n\n   File \"/opt/stack/nova/nova/objects/instance_action.py\", line 170, in event_start\n     db_event = db.action_event_start(context, values)\n\n   File \"/opt/stack/nova/nova/db/api.py\", line 1850, in action_event_start\n     return IMPL.action_event_start(context, values)\n\n   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 5697, in action_event_start\n     instance_uuid=values['instance_uuid'])\n\n InstanceActionNotFound: Action for request_id req-5e38756f-d29f-4865-af22-68a44ccd83cb on instance b9aadd79-e8f4-486f-8980-114b54a87d4d not found", 
            "date_created": "2015-03-23 08:40:29.853311+00:00", 
            "author": "https://api.launchpad.net/1.0/~kiwik-chenrui"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/167926", 
            "date_created": "2015-03-26 09:30:14.310548+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/167926\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=8fd7e1fe0ffcc0c0396dedbc02e7c6c3d78940e9\nSubmitter: Jenkins\nBranch:    master\n\ncommit 8fd7e1fe0ffcc0c0396dedbc02e7c6c3d78940e9\nAuthor: Rui Chen <email address hidden>\nDate:   Thu Mar 26 16:54:16 2015 +0800\n\n    Fix failure of stopping instances during init host\n    \n    When nova-compute restart, the context was generated again in\n    init_host workflow, the request_id was different with the request_id\n    recorded in InstanceAction, so we can't get the original record\n    according to request_id. Try to get the last one so that\n    init_instance can continue to finish the recovery action, like:\n    powering_off, unpausing, and so on.\n    \n    The instance fails in powering_off task state, because the nova-compute\n    shutdown or reboot when the instance execute a long-duration action,\n    like: graceful shutdown, at that time the action record should be ready.\n    \n    Change-Id: Ib84bd7419eac57da56c1a9a1c44cc63d2600f1ba\n    Closes-Bug: #1435198\n", 
            "date_created": "2015-06-04 06:01:09.488955+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "nova 12.0.0.1-1 also has the same problem.\n\n1) shutdown compute node(node2)\n2) power on node2\n3) nova boot 10 servers(ok)\n4) nova delete 10 servers, the problem arise, but not every time", 
            "date_created": "2017-09-05 10:53:07.630997+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhangqian"
        }
    ], 
    "closed": "2015-06-24 12:20:46.111156+00:00"
}