{
    "status": "Expired", 
    "last_updated": "2017-09-12 04:17:51.112719+00:00", 
    "description": "Calling get_diagnostics on an instance that is shutdown either via CLI or API generates an exception, and adds an row to the nova.instance_fault table\n\nReproduce:\ncreate an instance\npower it off\nrun `nova diagnostics instance`\n\nExpected result:\na simple error message returned to the user\n\nactual result:\na new row in the nova.instance_faults table.\n\na lot of text in nova-compute.log:\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher [req-1c775f02-887d-42b6-974d-129dbe73c7ce ffa01db44dc4435dbb613f50da552315 b1744f8baaa44d4f9762b9a7eaffc61f - - -] Exception during message handling: Instance 6ab6cc05-bebf-4bc2-95ac-7daf317125d6 in power_state 4. Cannot get_diagnostics while the instance is in this state.\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     executor_callback))\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     executor_callback)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 129, in _do_dispatch\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 89, in wrapped\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     payload)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 195, in __exit__\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 72, in wrapped\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 378, in decorated_function\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 195, in __exit__\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 366, in decorated_function\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4089, in get_diagnostics\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     method='get_diagnostics')\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher InstanceInvalidState: Instance 6ab6cc05-bebf-4bc2-95ac-7daf317125d6 in power_state 4. Cannot get_diagnostics while the instance is in this state.\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher\n2017-07-07 19:00:12.305 23077 ERROR oslo_messaging._drivers.common [req-1c775f02-887d-42b6-974d-129dbe73c7ce ffa01db44dc4435dbb613f50da552315 b1744f8baaa44d4f9762b9a7eaffc61f - - -] Returning exception Instance 6ab6cc05-bebf-4bc2-95ac-7daf317125d6 in power_state 4. Cannot get_diagnostics while the instance is in this state. to caller\n2017-07-07 19:00:12.306 23077 ERROR oslo_messaging._drivers.common [req-1c775f02-887d-42b6-974d-129dbe73c7ce ffa01db44dc4435dbb613f50da552315 b1744f8baaa44d4f9762b9a7eaffc61f - - -] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\\n    executor_callback))\\n', '  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\\n    executor_callback)\\n', '  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 129, in _do_dispatch\\n    result = func(ctxt, **new_args)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 89, in wrapped\\n    payload)\\n', '  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 195, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 72, in wrapped\\n    return f(self, context, *args, **kw)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 378, in decorated_function\\n    kwargs[\\'instance\\'], e, sys.exc_info())\\n', '  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 195, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 366, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4089, in get_diagnostics\\n    method=\\'get_diagnostics\\')\\n', 'InstanceInvalidState: Instance 6ab6cc05-bebf-4bc2-95ac-7daf317125d6 in power_state 4. Cannot get_diagnostics while the instance is in this state.\\n']\n\n\nEnvironment:\nLiberty w/ libvirt+kvm\n\n# rpm -qa |grep nova\npython-nova-12.0.4-1.el7.noarch\nopenstack-nova-common-12.0.4-1.el7.noarch\nopenstack-nova-network-12.0.4-1.el7.noarch\nopenstack-nova-compute-12.0.4-1.el7.noarch\npython-novaclient-2.30.1-1.el7.noarch\nopenstack-nova-api-12.0.4-1.el7.noarch", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1702992", 
    "owner": "None", 
    "id": 1702992, 
    "index": 8205, 
    "openned": "2017-07-07 19:22:38.273489+00:00", 
    "created": "2017-07-07 19:22:38.273489+00:00", 
    "title": "get_diagnostics on a non-running instance raises unnecessary exception", 
    "comments": [
        {
            "content": "Calling get_diagnostics on an instance that is shutdown either via CLI or API generates an exception, and adds an row to the nova.instance_fault table\n\nReproduce:\ncreate an instance\npower it off\nrun `nova diagnostics instance`\n\nExpected result:\na simple error message returned to the user\n\nactual result:\na new row in the nova.instance_faults table.\n\na lot of text in nova-compute.log:\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher [req-1c775f02-887d-42b6-974d-129dbe73c7ce ffa01db44dc4435dbb613f50da552315 b1744f8baaa44d4f9762b9a7eaffc61f - - -] Exception during message handling: Instance 6ab6cc05-bebf-4bc2-95ac-7daf317125d6 in power_state 4. Cannot get_diagnostics while the instance is in this state.\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher Traceback (most recent call last):\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     executor_callback))\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     executor_callback)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 129, in _do_dispatch\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     result = func(ctxt, **new_args)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 89, in wrapped\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     payload)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 195, in __exit__\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 72, in wrapped\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     return f(self, context, *args, **kw)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 378, in decorated_function\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     kwargs['instance'], e, sys.exc_info())\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 195, in __exit__\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     six.reraise(self.type_, self.value, self.tb)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 366, in decorated_function\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     return function(self, context, *args, **kwargs)\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4089, in get_diagnostics\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher     method='get_diagnostics')\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher InstanceInvalidState: Instance 6ab6cc05-bebf-4bc2-95ac-7daf317125d6 in power_state 4. Cannot get_diagnostics while the instance is in this state.\n2017-07-07 19:00:12.301 23077 ERROR oslo_messaging.rpc.dispatcher\n2017-07-07 19:00:12.305 23077 ERROR oslo_messaging._drivers.common [req-1c775f02-887d-42b6-974d-129dbe73c7ce ffa01db44dc4435dbb613f50da552315 b1744f8baaa44d4f9762b9a7eaffc61f - - -] Returning exception Instance 6ab6cc05-bebf-4bc2-95ac-7daf317125d6 in power_state 4. Cannot get_diagnostics while the instance is in this state. to caller\n2017-07-07 19:00:12.306 23077 ERROR oslo_messaging._drivers.common [req-1c775f02-887d-42b6-974d-129dbe73c7ce ffa01db44dc4435dbb613f50da552315 b1744f8baaa44d4f9762b9a7eaffc61f - - -] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 142, in _dispatch_and_reply\\n    executor_callback))\\n', '  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 186, in _dispatch\\n    executor_callback)\\n', '  File \"/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py\", line 129, in _do_dispatch\\n    result = func(ctxt, **new_args)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 89, in wrapped\\n    payload)\\n', '  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 195, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/exception.py\", line 72, in wrapped\\n    return f(self, context, *args, **kw)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 378, in decorated_function\\n    kwargs[\\'instance\\'], e, sys.exc_info())\\n', '  File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 195, in __exit__\\n    six.reraise(self.type_, self.value, self.tb)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 366, in decorated_function\\n    return function(self, context, *args, **kwargs)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 4089, in get_diagnostics\\n    method=\\'get_diagnostics\\')\\n', 'InstanceInvalidState: Instance 6ab6cc05-bebf-4bc2-95ac-7daf317125d6 in power_state 4. Cannot get_diagnostics while the instance is in this state.\\n']\n\n\nEnvironment:\nLiberty w/ libvirt+kvm\n\n# rpm -qa |grep nova\npython-nova-12.0.4-1.el7.noarch\nopenstack-nova-common-12.0.4-1.el7.noarch\nopenstack-nova-network-12.0.4-1.el7.noarch\nopenstack-nova-compute-12.0.4-1.el7.noarch\npython-novaclient-2.30.1-1.el7.noarch\nopenstack-nova-api-12.0.4-1.el7.noarch", 
            "date_created": "2017-07-07 19:22:38.273489+00:00", 
            "author": "https://api.launchpad.net/1.0/~peterd-w"
        }, 
        {
            "content": "nova 12 is too old , are you able to reproduce in master or O or N version?\n\n", 
            "date_created": "2017-07-13 06:13:44.225485+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "take a look at the code and all actions like attach_volume /detach etc has wrap_instance_fault which will create a server fault ,so get_diag might be consistent to add a fault if failed in its action?", 
            "date_created": "2017-07-13 06:15:06.147060+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "I don't have a newer version to test with, but the code looks the same in the newer versions, so I was advised to fill the report anyhow, based on my conversation on the mailing list.\nhttp://lists.openstack.org/pipermail/openstack/2017-July/045171.html\n\nattach_volume is an action, so it makes more sense that it would generate an error on failure.\nget_diag is a read operation, and trying to get_diag on a powered off instance may not make sense to do, but shouldn't be considered a fatal error.  It's basically a no-op, so any error could be discarded, IMHO.", 
            "date_created": "2017-07-14 01:09:10.893347+00:00", 
            "author": "https://api.launchpad.net/1.0/~peterd-w"
        }, 
        {
            "content": "[Expired for OpenStack Compute (nova) because there has been no activity for 60 days.]", 
            "date_created": "2017-09-12 04:17:49.109890+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ], 
    "closed": "2017-09-12 04:17:49.509378+00:00"
}