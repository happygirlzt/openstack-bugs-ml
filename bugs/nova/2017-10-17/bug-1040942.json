{
    "status": "Fix Released", 
    "last_updated": "2012-09-27 15:31:28.485974+00:00", 
    "description": "I am periodically seeing this error in my nova.log file. Not sure what's causing this.\n\n\n2012-08-23 17:12:55 INFO nova.compute.manager [-] Updating host status\n2012-08-23 17:13:00 ERROR nova.manager [-] Error during SchedulerManager._expire_reservations: 'Reservation' object has no attribute 'usage'\n2012-08-23 17:13:00 TRACE nova.manager Traceback (most recent call last):\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/manager.py\", line 173, in periodic_tasks\n2012-08-23 17:13:00 TRACE nova.manager     task(self, context)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/scheduler/manager.py\", line 288, in _expire_reservations\n2012-08-23 17:13:00 TRACE nova.manager     QUOTAS.expire(context)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/quota.py\", line 757, in expire\n2012-08-23 17:13:00 TRACE nova.manager     self._driver.expire(context)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/quota.py\", line 380, in expire\n2012-08-23 17:13:00 TRACE nova.manager     db.reservation_expire(context)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/db/api.py\", line 1066, in reservation_expire\n2012-08-23 17:13:00 TRACE nova.manager     return IMPL.reservation_expire(context)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/db/sqlalchemy/api.py\", line 112, in wrapper\n2012-08-23 17:13:00 TRACE nova.manager     return f(*args, **kwargs)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/db/sqlalchemy/api.py\", line 2864, in reservation_expire\n2012-08-23 17:13:00 TRACE nova.manager     reservation.usage.reserved -= reservation.delta\n2012-08-23 17:13:00 TRACE nova.manager AttributeError: 'Reservation' object has no attribute 'usage'\n2012-08-23 17:13:00 TRACE nova.manager", 
    "tags": [], 
    "importance": "High", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1040942", 
    "owner": "https://api.launchpad.net/1.0/~markmc", 
    "id": 1040942, 
    "index": 771, 
    "openned": "2012-08-24 00:23:06.779026+00:00", 
    "created": "2012-08-24 00:23:06.779026+00:00", 
    "title": "Error during scheduler Manager expire reservations", 
    "comments": [
        {
            "content": "I am periodically seeing this error in my nova.log file. Not sure what's causing this.\n\n\n2012-08-23 17:12:55 INFO nova.compute.manager [-] Updating host status\n2012-08-23 17:13:00 ERROR nova.manager [-] Error during SchedulerManager._expire_reservations: 'Reservation' object has no attribute 'usage'\n2012-08-23 17:13:00 TRACE nova.manager Traceback (most recent call last):\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/manager.py\", line 173, in periodic_tasks\n2012-08-23 17:13:00 TRACE nova.manager     task(self, context)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/scheduler/manager.py\", line 288, in _expire_reservations\n2012-08-23 17:13:00 TRACE nova.manager     QUOTAS.expire(context)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/quota.py\", line 757, in expire\n2012-08-23 17:13:00 TRACE nova.manager     self._driver.expire(context)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/quota.py\", line 380, in expire\n2012-08-23 17:13:00 TRACE nova.manager     db.reservation_expire(context)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/db/api.py\", line 1066, in reservation_expire\n2012-08-23 17:13:00 TRACE nova.manager     return IMPL.reservation_expire(context)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/db/sqlalchemy/api.py\", line 112, in wrapper\n2012-08-23 17:13:00 TRACE nova.manager     return f(*args, **kwargs)\n2012-08-23 17:13:00 TRACE nova.manager   File \"/usr/local/lib/python2.7/dist-packages/nova-2012.2-py2.7.egg/nova/db/sqlalchemy/api.py\", line 2864, in reservation_expire\n2012-08-23 17:13:00 TRACE nova.manager     reservation.usage.reserved -= reservation.delta\n2012-08-23 17:13:00 TRACE nova.manager AttributeError: 'Reservation' object has no attribute 'usage'\n2012-08-23 17:13:00 TRACE nova.manager", 
            "date_created": "2012-08-24 00:23:06.779026+00:00", 
            "author": "https://api.launchpad.net/1.0/~najoy"
        }, 
        {
            "content": "Thanks for the report!\n\nI've just reproduced this by:\n\n  1) Set reservation_expire=10 and periodic_interval=20 in nova.conf\n\n  2) Do 'nova secgroup-create foo bar' twice (see #1043765)\n\n  3) Confirm that we have a lingering reservation from that failure by running 'select * from reservations where deleted=0;' against the nova DB\n\nWait a while and, sure enough, I see the same exception you do.\n\nBy the way, whatever caused the quota reservation to leak is a bug too. It would be good to track that bug down. A good start is to look at the 'resource' column of the leaked reservations.", 
            "date_created": "2012-08-30 11:20:49.565328+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/12263", 
            "date_created": "2012-08-31 15:20:56.312119+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/12263\nCommitted: http://github.com/openstack/nova/commit/22f0e324f3d3172b563aa67e513fe4d9318de2e5\nSubmitter: Jenkins\nBranch:    master\n\ncommit 22f0e324f3d3172b563aa67e513fe4d9318de2e5\nAuthor: Mark McLoughlin <email address hidden>\nDate:   Sat Sep 1 09:37:15 2012 +0100\n\n    Fix quota reservation expiration\n    \n    Fixes bug #1040942\n    \n    The db.reservation_expire() function assumes a 'usage' attribute on\n    Reservation objects, but we don't actually define that relationship.\n    \n    The end result is that reservation_expire() currently traceback if\n    it actually needs to expire any reservations. This happens pretty\n    rarely since reservations should only need expiring if they are\n    leaked because of another bug.\n    \n    Also define a test case to actually excercise the expiration code\n    path.\n    \n    Add a missing chain-up to tearDown in test_limits which was causing\n    the get_project_quotas() stub not to be unset and, in turn, the\n    reservation expiration test to fail.\n    \n    Change-Id: Ib61dbf9fd5dfb5badaf05f20c423a69925d83754\n", 
            "date_created": "2012-09-03 00:04:04.521755+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-09-19 06:34:13.858140+00:00"
}