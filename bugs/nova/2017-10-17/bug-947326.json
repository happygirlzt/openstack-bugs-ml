{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 10:55:52.144534+00:00", 
    "description": "I'm testing the live migration feature in Essex milestone 4. I can sucessfully migrate an instance, but after the migration the instance can not be migrated again.\n\n----------------------------------------------------------------------------------------------------------------------------------------\nroot@unic-prd-os-controller:~# nova-manage vm live_migration instance-00000007 unic-prd-os-compute6\n2012-03-05 18:40:41 INFO nova.rpc.common [req-38c187eb-ca3e-4d4c-b576-0fed30a74e40 None None] Connected to AMQP server on 10.2.30.2:5672\nMigration of instance-00000007 initiated.Check its progress using euca-describe-instances.\n----------------------------------------------------------------------------------------------------------------------------------------\n\nInitial migration, after the instance is running (ps aux on unic-prd-os-compute6) and I can ping it.\n\n----------------------------------------------------------------------------------------------------------------------------------------\nroot@unic-prd-os-controller:~# nova show 41dedf0f-9a46-4593-9ae7-15e0f73973ce \n+-------------------------------+----------------------------------------------------------+\n|            Property           |                          Value                           |\n+-------------------------------+----------------------------------------------------------+\n| OS-DCF:diskConfig             | MANUAL                                                   |\n| OS-EXT-SRV-ATTR:host          | unic-prd-os-compute6                                     |\n| OS-EXT-SRV-ATTR:instance_name | instance-00000007                                        |\n| OS-EXT-STS:power_state        | 8                                                        |\n| OS-EXT-STS:task_state         | None                                                     |\n| OS-EXT-STS:vm_state           | active                                                   |\n| PrivateCloud network          | 10.2.20.34                                               |\n| accessIPv4                    |                                                          |\n| accessIPv6                    |                                                          |\n| config_drive                  |                                                          |\n| created                       | 2012-03-05T16:37:46Z                                     |\n| flavor                        | m1.small                                                 |\n| hostId                        | a24295a0fd51ae996ff8af9835bb03b83d10681885b54492fa3e2cf4 |\n| id                            | 41dedf0f-9a46-4593-9ae7-15e0f73973ce                     |\n| image                         | Centos5x64_v1                                            |\n| key_name                      |                                                          |\n| metadata                      | {}                                                       |\n| name                          | testvm5                                                  |\n| progress                      | None                                                     |\n| status                        | ACTIVE                                                   |\n| tenant_id                     | e552d533c8fc43c1b759d79cb356c15d                         |\n| updated                       | 2012-03-05T17:40:58Z                                     |\n| user_id                       | f400a2b6e60745f6b704d4aa51969d1b                         |\n+-------------------------------+----------------------------------------------------------+\n----------------------------------------------------------------------------------------------------------------------------------------\n\nThe state of the instance is active.\n\n----------------------------------------------------------------------------------------------------------------------------------------\nroot@unic-prd-os-controller:~# nova-manage vm live_migration instance-00000007 unic-prd-os-compute5\n2012-03-05 18:46:57 INFO nova.rpc.common [req-d6779fb1-bb74-4d16-a750-9658d207461e None None] Connected to AMQP server on 10.2.30.2:5672\nCommand failed, please check log for more info\n2012-03-05 18:46:57 CRITICAL nova [req-d6779fb1-bb74-4d16-a750-9658d207461e None None] Remote error: InstanceNotRunning Instance i-00000007 is not running.\n[u'Traceback (most recent call last):\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 250, in _process_data\\n    rval = node_func(context=ctxt, **node_args)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/scheduler/manager.py\", line 98, in _schedule\\n    self._set_instance_error(method, context, ex, *args, **kwargs)\\n', u'  File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\\n    self.gen.next()\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/scheduler/manager.py\", line 93, in _schedule\\n    return real_meth(*args, **kwargs)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/scheduler/driver.py\", line 202, in schedule_live_migration\\n    self._live_migration_src_check(context, instance_ref)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/scheduler/driver.py\", line 241, in _live_migration_src_check\\n    raise exception.InstanceNotRunning(instance_id=instance_id)\\n', u'InstanceNotRunning: Instance i-00000007 is not running.\\n'].\n----------------------------------------------------------------------------------------------------------------------------------------\n\nThe migration breaks because the instance is not running, which is not true.", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/947326", 
    "owner": "https://api.launchpad.net/1.0/~vishvananda", 
    "id": 947326, 
    "index": 2788, 
    "openned": "2012-03-05 17:47:49.831336+00:00", 
    "created": "2012-03-05 17:47:49.831336+00:00", 
    "title": "Instance in state not running after live migration", 
    "comments": [
        {
            "content": "I'm testing the live migration feature in Essex milestone 4. I can sucessfully migrate an instance, but after the migration the instance can not be migrated again.\n\n----------------------------------------------------------------------------------------------------------------------------------------\nroot@unic-prd-os-controller:~# nova-manage vm live_migration instance-00000007 unic-prd-os-compute6\n2012-03-05 18:40:41 INFO nova.rpc.common [req-38c187eb-ca3e-4d4c-b576-0fed30a74e40 None None] Connected to AMQP server on 10.2.30.2:5672\nMigration of instance-00000007 initiated.Check its progress using euca-describe-instances.\n----------------------------------------------------------------------------------------------------------------------------------------\n\nInitial migration, after the instance is running (ps aux on unic-prd-os-compute6) and I can ping it.\n\n----------------------------------------------------------------------------------------------------------------------------------------\nroot@unic-prd-os-controller:~# nova show 41dedf0f-9a46-4593-9ae7-15e0f73973ce \n+-------------------------------+----------------------------------------------------------+\n|            Property           |                          Value                           |\n+-------------------------------+----------------------------------------------------------+\n| OS-DCF:diskConfig             | MANUAL                                                   |\n| OS-EXT-SRV-ATTR:host          | unic-prd-os-compute6                                     |\n| OS-EXT-SRV-ATTR:instance_name | instance-00000007                                        |\n| OS-EXT-STS:power_state        | 8                                                        |\n| OS-EXT-STS:task_state         | None                                                     |\n| OS-EXT-STS:vm_state           | active                                                   |\n| PrivateCloud network          | 10.2.20.34                                               |\n| accessIPv4                    |                                                          |\n| accessIPv6                    |                                                          |\n| config_drive                  |                                                          |\n| created                       | 2012-03-05T16:37:46Z                                     |\n| flavor                        | m1.small                                                 |\n| hostId                        | a24295a0fd51ae996ff8af9835bb03b83d10681885b54492fa3e2cf4 |\n| id                            | 41dedf0f-9a46-4593-9ae7-15e0f73973ce                     |\n| image                         | Centos5x64_v1                                            |\n| key_name                      |                                                          |\n| metadata                      | {}                                                       |\n| name                          | testvm5                                                  |\n| progress                      | None                                                     |\n| status                        | ACTIVE                                                   |\n| tenant_id                     | e552d533c8fc43c1b759d79cb356c15d                         |\n| updated                       | 2012-03-05T17:40:58Z                                     |\n| user_id                       | f400a2b6e60745f6b704d4aa51969d1b                         |\n+-------------------------------+----------------------------------------------------------+\n----------------------------------------------------------------------------------------------------------------------------------------\n\nThe state of the instance is active.\n\n----------------------------------------------------------------------------------------------------------------------------------------\nroot@unic-prd-os-controller:~# nova-manage vm live_migration instance-00000007 unic-prd-os-compute5\n2012-03-05 18:46:57 INFO nova.rpc.common [req-d6779fb1-bb74-4d16-a750-9658d207461e None None] Connected to AMQP server on 10.2.30.2:5672\nCommand failed, please check log for more info\n2012-03-05 18:46:57 CRITICAL nova [req-d6779fb1-bb74-4d16-a750-9658d207461e None None] Remote error: InstanceNotRunning Instance i-00000007 is not running.\n[u'Traceback (most recent call last):\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/rpc/amqp.py\", line 250, in _process_data\\n    rval = node_func(context=ctxt, **node_args)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/scheduler/manager.py\", line 98, in _schedule\\n    self._set_instance_error(method, context, ex, *args, **kwargs)\\n', u'  File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\\n    self.gen.next()\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/scheduler/manager.py\", line 93, in _schedule\\n    return real_meth(*args, **kwargs)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/scheduler/driver.py\", line 202, in schedule_live_migration\\n    self._live_migration_src_check(context, instance_ref)\\n', u'  File \"/usr/lib/python2.7/dist-packages/nova/scheduler/driver.py\", line 241, in _live_migration_src_check\\n    raise exception.InstanceNotRunning(instance_id=instance_id)\\n', u'InstanceNotRunning: Instance i-00000007 is not running.\\n'].\n----------------------------------------------------------------------------------------------------------------------------------------\n\nThe migration breaks because the instance is not running, which is not true.", 
            "date_created": "2012-03-05 17:47:49.831336+00:00", 
            "author": "https://api.launchpad.net/1.0/~wittwerch"
        }, 
        {
            "content": "It is showing power_state=8 which means libvirt is reporting it as failed, so it doesn't look like the power state is being reported properly.  Perhaps the old host is updating the power state in the db somewhere and overwriting the power state reported by the new host?", 
            "date_created": "2012-03-05 19:17:40.436758+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "I will handle on this matter.\r\n\r\nIt seems like you have to wait next periodic_tasks() begins iin existing implementation.\r\nBut it might be a problem for some cases, so lets change power_state of migrated vm right after live migration finishes.\r\n\r\n> Vish\r\nCan you assign this bug to me if it is convinent to anyone?\r\n", 
            "date_created": "2012-03-06 07:37:27.073459+00:00", 
            "author": "https://api.launchpad.net/1.0/~masumotok"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/5038", 
            "date_created": "2012-03-07 20:21:26.327676+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/5038\nCommitted: http://github.com/openstack/nova/commit/33def9e714fbd13a6dc4b755ade4841c971f7ae5\nSubmitter: Jenkins\nBranch:    master\n\ncommit 33def9e714fbd13a6dc4b755ade4841c971f7ae5\nAuthor: Vishvananda Ishaya <email address hidden>\nDate:   Thu Mar 8 12:53:44 2012 -0800\n\n    Fix live-migration in multi_host network\n    \n     * call teardown after live migration\n     * call update a second time after migration for dhcp\n     * moves the instance state update into post_live_migrate\n     * completes the fix for bug 939060\n     * fixes bug 947326\n    \n    Change-Id: I042567573b9bb46381c5447aa08e83cd1916b225\n", 
            "date_created": "2012-03-12 17:58:37.894620+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-03-20 08:43:59.050932+00:00"
}