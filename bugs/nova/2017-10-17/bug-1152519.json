{
    "status": "Fix Released", 
    "last_updated": "2013-04-04 11:20:39.398625+00:00", 
    "description": "I got this issue with stable folsom when I wanted to run a windows8 instance, but I believe this issue still exists in grizzly.\nMy host distro is debian wheezy, and the version of 'mount' is mount_2.20.1-5.3_amd64.deb.\nerror logs:\n2013-03-07 17:52:50 DEBUG nova.utils [-] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf kpartx -a /dev/nbd14 from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:192\n2013-03-07 17:52:50 DEBUG nova.utils [-] Result was 0 from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:207\n2013-03-07 17:52:50 DEBUG nova.utils [-] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf mount /dev/mapper/nbd14p1 /tmp/openstack-disk-mount-tmp9Plrpc from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:192\n2013-03-07 17:52:51 DEBUG nova.utils [-] Result was 0 from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:207\n=============here we can see that the 'umount' operation isn't executed=============\n2013-03-07 17:52:51 DEBUG nova.utils [-] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf kpartx -d /dev/nbd14 from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:192\n2013-03-07 17:52:51 DEBUG nova.utils [-] Result was 1 from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:207\n2013-03-07 17:52:51 WARNING nova.virt.libvirt.driver [-] [instance: 172195e0-7074-450e-9840-937e9173c20b] Ignoring error injecting data into image 4bd31030-7410-4dc4-8c01-71bdc06b7f86 ([Errno 16] Device or resource busy: '/tmp/openstack-disk-mount-tmp9Plrpc')\n\nI have debug this issue inline, and find that error occurs in the 'mount' operation, (===but the nbd device has been mounted!===):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0_out, err = utils.trycmd('mount', self.mapped_device, self.mount_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0run_as_root=True)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if err:  ######### err is set by the utils.trycmd() method.\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.error = _('Failed to mount filesystem: %s') % err\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return False   #### return here\nso the do_umount method will not call the unmnt_dev method because self.mounted is False:\ndef do_umount(self):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\"\"Call the unmnt, unmap and unget operations.\"\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if self.mounted:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.unmnt_dev()\nand then the 'kpartx -d' operation will fail(raise ProcessExecutionError), the 'qemu-nbd -d' operation will not be executed.\nFinally, the nbd device used by qemu-nbd isn't released!", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1152519", 
    "owner": "https://api.launchpad.net/1.0/~hzwangpan", 
    "id": 1152519, 
    "index": 4760, 
    "openned": "2013-03-08 09:44:27.309457+00:00", 
    "created": "2013-03-08 09:44:27.309457+00:00", 
    "title": "nbd device can not be released after injecting files into image if mount operation failed", 
    "comments": [
        {
            "content": "I got this issue with stable folsom when I wanted to run a windows8 instance, but I believe this issue still exists in grizzly.\nMy host distro is debian wheezy, and the version of 'mount' is mount_2.20.1-5.3_amd64.deb.\nerror logs:\n2013-03-07 17:52:50 DEBUG nova.utils [-] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf kpartx -a /dev/nbd14 from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:192\n2013-03-07 17:52:50 DEBUG nova.utils [-] Result was 0 from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:207\n2013-03-07 17:52:50 DEBUG nova.utils [-] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf mount /dev/mapper/nbd14p1 /tmp/openstack-disk-mount-tmp9Plrpc from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:192\n2013-03-07 17:52:51 DEBUG nova.utils [-] Result was 0 from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:207\n=============here we can see that the 'umount' operation isn't executed=============\n2013-03-07 17:52:51 DEBUG nova.utils [-] Running cmd (subprocess): sudo nova-rootwrap /etc/nova/rootwrap.conf kpartx -d /dev/nbd14 from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:192\n2013-03-07 17:52:51 DEBUG nova.utils [-] Result was 1 from (pid=19455) execute /usr/local/lib/python2.7/dist-packages/nova/utils.py:207\n2013-03-07 17:52:51 WARNING nova.virt.libvirt.driver [-] [instance: 172195e0-7074-450e-9840-937e9173c20b] Ignoring error injecting data into image 4bd31030-7410-4dc4-8c01-71bdc06b7f86 ([Errno 16] Device or resource busy: '/tmp/openstack-disk-mount-tmp9Plrpc')\n\nI have debug this issue inline, and find that error occurs in the 'mount' operation:\n        _out, err = utils.trycmd('mount', self.mapped_device, self.mount_dir,\n                                 run_as_root=True)\n        if err:  ######### err is set by the utils.trycmd() method.\n            self.error = _('Failed to mount filesystem: %s') % err\n            return False   #### return here\nso the do_umount method will not call the unmnt_dev method because self.mounted is False:\ndef do_umount(self):\n        \"\"\"Call the unmnt, unmap and unget operations.\"\"\"\n        if self.mounted:\n            self.unmnt_dev()\nand then the 'kpartx -d' operation will fail(raise ProcessExecutionError), the 'qemu-nbd -d' operation will not be executed.\nFinally, the nbd device used by qemu-nbd isn't released!", 
            "date_created": "2013-03-08 09:44:27.309457+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "And I have try this with mount_2.20.1-4_amd64.deb installed in host, the 'mount' operation is failed with nbd device has NOT been mounted, so the nbd device is released successfully.\nI guess this is a bug of 'mount', but it's better that we fix it by changing our nova codes.", 
            "date_created": "2013-03-08 09:51:27.643263+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/23903", 
            "date_created": "2013-03-08 10:11:32.386990+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "    if err:\n            self.error = _('Failed to mount filesystem: %s') % err\n            LOG.error(self.error) ### I add error log here\nThe error message is like this while 'mount':\n2013-03-08 17:04:31 ERROR nova.virt.disk.mount [-] Failed to mount filesystem: $LogFile version 2.0 is not supported.  (This driver supports version 1.1 only.)                        \n$LogFile version 2.0 is not supported.  (This driver supports version 1.1 only.)\nDid not find any restart pages in $LogFile and it was not empty.                \nThe file system wasn't safely closed on Windows. Fixing. \nand the error code is 0, mount successfully.", 
            "date_created": "2013-03-11 01:50:39.826246+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/23903\nCommitted: http://github.com/openstack/nova/commit/786424b4561df6408128e2cd1b79b00c8b638cdc\nSubmitter: Jenkins\nBranch:    master\n\ncommit 786424b4561df6408128e2cd1b79b00c8b638cdc\nAuthor: Wangpan <email address hidden>\nDate:   Fri Mar 8 18:05:02 2013 +0800\n\n    Fixes nbd device can't be released error\n    \n    When the 'mount' operation is successful but stderr is not empty during\n    injecting key/file into image, there may be some warning messages output to\n    stderr, so we need to discard them and continue to inject files into image.\n    \n    Fixes bug #1152519\n    \n    Change-Id: Icc7d15196f3ee67674f9d815ddeef4378f363e2c\n", 
            "date_created": "2013-03-12 18:50:42.365377+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-03-20 16:11:29.515292+00:00"
}