{
    "status": "Fix Released", 
    "last_updated": "2017-06-16 12:17:54.278439+00:00", 
    "description": "ImageCacheManager raises Permission denied error on nova compute in race condition\n\nWhile creating an instance snapshot nova calls guest.launch method from libvirt driver which changes the base file permissions and updates base file user from openstack to libvirt-qemu (in case of qcow2 image backend). In race condition when ImageCacheManager is trying to update last access time of this base file and guest.launch is called by instance snapshot just before updating the access time, ImageCacheManager raise Permission denied error in nova compute for os.utime().\n\nSteps to reproduce:\n1. Configure image_cache_manager_interval=120 in nova.conf and use qcow2 image backend.\n2. Add a sleep for 60 sec in _handle_base_image method of libvirt.imagecache just before calling os.utime().\n3. Restart nova services.\n4. Create an instance using image.\n$ nova boot --image 5e1659aa-6d38-44e8-aaa3-4217337436c0 --flavor 1 instance-1\n5. Check that instance is in active state.\n6. Go to the n-cpu screen and check imagecache manager logs at the point it waits to execute sleep statement added in step #2.\n7. Send instance snapshot request when imagecache manger is waiting to execute sleep.\n$ nova image-create 19c7900b-73d5-4c2e-b129-5e2a6b13f396 instance-1-snap\n8. instance snapshot request updates the base file owner to libvirt-qemu by calling guest.launch method from libvirt driver.\n9. Now when imagecache manger comes out from sleep and executes os.utime it raise following Permission denied error in nova compute.\n\n2015-07-01 01:51:46.794 ERROR nova.openstack.common.periodic_task [req-a03fa45f-ffb9-48dd-8937-5b0414c6864b None None] Error during ComputeManager._run_image_cache_manager_pass\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task Traceback(most recent call last):\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/openstack/common/periodic_task.py\", line 224, in run_periodic_tasks\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task     task(self, context)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/compute/manager.py\", line 6177, in _run_image_cache_manager_pass\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task     self.driver.manage_image_cache(context, filtered_instances)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 6252, in manage_image_cache\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task     self.image_cache_manager.update(context, all_instances)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/virt/libvirt/imagecache.py\", line 668, in update\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task\nself._age_and_verify_cached_images(context, all_instances, base_dir)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/virt/libvirt/imagecache.py\", line 598, in _age_and_verify_cached_images\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task     self._handle_base_image(img, base_file)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/virt/libvirt/imagecache.py\", line 570, in _handle_base_image\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task     os.utime(base_file, None)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task OSError:[Errno 13] Permission denied: '/opt/stack/data/nova/instances/_base/8d2c340dcce68e48a75457b1e91457feed27aef5'\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task\n\nExpected result: guest.launch should not update the base file permissions and owner to libvirt-qemu.  Base file owner should remain unchanged.\n\nActual result: Libvirt is updating the base file owner which causes permission issues in nova.", 
    "tags": [
        "libvirt", 
        "snapshot"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1470437", 
    "owner": "https://api.launchpad.net/1.0/~ankitagrawal", 
    "id": 1470437, 
    "index": 4287, 
    "openned": "2015-07-01 09:54:04.176594+00:00", 
    "created": "2015-07-01 09:54:04.176594+00:00", 
    "title": "ImageCacheManager raises Permission denied error on nova compute in race condition", 
    "comments": [
        {
            "content": "ImageCacheManager raises Permission denied error on nova compute in race condition\n\nWhile creating an instance snapshot nova calls guest.launch method from libvirt driver which changes the base file permissions and updates base file user from openstack to libvirt-qemu (in case of qcow2 image backend). In race condition when ImageCacheManager is trying to update last access time of this base file and guest.launch is called by instance snapshot just before updating the access time, ImageCacheManager raise Permission denied error in nova compute for os.utime().\n\nSteps to reproduce:\n1. Configure image_cache_manager_interval=120 in nova.conf and use qcow2 image backend.\n2. Add a sleep for 60 sec in _handle_base_image method of libvirt.imagecache just before calling os.utime().\n3. Restart nova services.\n4. Create an instance using image.\n$ nova boot --image 5e1659aa-6d38-44e8-aaa3-4217337436c0 --flavor 1 instance-1\n5. Check that instance is in active state.\n6. Go to the n-cpu screen and check imagecache manager logs at the point it waits to execute sleep statement added in step #2.\n7. Send instance snapshot request when imagecache manger is waiting to execute sleep.\n$ nova image-create 19c7900b-73d5-4c2e-b129-5e2a6b13f396 instance-1-snap\n8. instance snapshot request updates the base file owner to libvirt-qemu by calling guest.launch method from libvirt driver.\n9. Now when imagecache manger comes out from sleep and executes os.utime it raise following Permission denied error in nova compute.\n\n2015-07-01 01:51:46.794 ERROR nova.openstack.common.periodic_task [req-a03fa45f-ffb9-48dd-8937-5b0414c6864b None None] Error during ComputeManager._run_image_cache_manager_pass\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task Traceback(most recent call last):\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/openstack/common/periodic_task.py\", line 224, in run_periodic_tasks\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task     task(self, context)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/compute/manager.py\", line 6177, in _run_image_cache_manager_pass\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task     self.driver.manage_image_cache(context, filtered_instances)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 6252, in manage_image_cache\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task     self.image_cache_manager.update(context, all_instances)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/virt/libvirt/imagecache.py\", line 668, in update\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task\nself._age_and_verify_cached_images(context, all_instances, base_dir)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/virt/libvirt/imagecache.py\", line 598, in _age_and_verify_cached_images\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task     self._handle_base_image(img, base_file)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task   File \"/opt/stack/nova/nova/virt/libvirt/imagecache.py\", line 570, in _handle_base_image\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task     os.utime(base_file, None)\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task OSError:[Errno 13] Permission denied: '/opt/stack/data/nova/instances/_base/8d2c340dcce68e48a75457b1e91457feed27aef5'\n2015-07-01 01:51:46.794 TRACE nova.openstack.common.periodic_task\n\nExpected result: guest.launch should not update the base file permissions and owner to libvirt-qemu.  Base file owner should remain unchanged.\n\nActual result: Libvirt is updating the base file owner which causes permission issues in nova.", 
            "date_created": "2015-07-01 09:54:04.176594+00:00", 
            "author": "https://api.launchpad.net/1.0/~ankitagrawal"
        }, 
        {
            "content": "I see this error intermittently in compute logs. When I was analyzing the source  code to fix this issue I found that there is a provision in /etc/libvirt/qemu.conf to configure user and group via the user=$USERNAME and group=$GROUPNAME parameters.\nIf I change libvirt user to same as nova user I do not see this Permission issue any more in imagecache manager for updating the base/backing file access time.\n\nIs this a valid way to fix this issue by making changes in libvirt configuration? Please suggest.", 
            "date_created": "2015-07-02 07:34:55.787634+00:00", 
            "author": "https://api.launchpad.net/1.0/~ankitagrawal"
        }, 
        {
            "content": "@Ankit Agrawal:\n\nSince you are set as assignee, I switch the status to 'In Progress'.", 
            "date_created": "2015-07-03 08:36:12.922722+00:00", 
            "author": "https://api.launchpad.net/1.0/~mzoeller"
        }, 
        {
            "content": "I am little bit concern about the security issue with the solution mentioned in note #1 by configuring the user and group to a non root user in libvirt..\n\nAlternatively we can either check write access on the base file just before calling os.utime or can put this in try except block, where in case of exception we'll catch this exception and will log a message base file permissions has been updated by another api or guest.launch.\n\nWith this approach when exception is caught last modified time of base file will not be updated but last access time of the file has been updated by guest.launch method which has changed the file ownership. So we can calculate base file age based on last access time instead of last modified time before  deleting it from cache.\n\nThis will solve our problem completely and IMO will also reduce the chances of deleting unwanted base files from imagecache manager by calculating age based on last access time instead of last modified time.\n\nPlease provide your opinion about these approaches. Thanks !", 
            "date_created": "2015-07-09 09:14:56.348008+00:00", 
            "author": "https://api.launchpad.net/1.0/~ankitagrawal"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/185549\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ec9d5e375e208686d33b9259b039cc009bded42e\nSubmitter: Jenkins\nBranch:    master\n\ncommit ec9d5e375e208686d33b9259b039cc009bded42e\nAuthor: Ankit Agrawal <email address hidden>\nDate:   Mon Aug 10 16:27:57 2015 +1000\n\n    libvirt: Race condition leads to instance in error\n    \n    ImageCacheManager deletes base image while image backend is copying\n    image to the instance path leading instance to go in the error state.\n    \n    Acquired lock before removing image from cache. If libvirt is copying\n    image to the instance path, image cache manager won't be able to remove\n    it until libvirt finishes copying image completely.\n    \n    Closes-Bug: 1256838\n    Closes-Bug: 1470437\n    Co-Authored-By: Michael Still <email address hidden>\n    Depends-On: I337ce28e2fc516c91bec61ca3639ebff0029ad49\n    Change-Id: I376cc951922c338669fdf3f83da83e0d3cea1532\n", 
            "date_created": "2016-02-10 09:16:11.234793+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/liberty\nReview: https://review.openstack.org/278928", 
            "date_created": "2016-02-11 08:34:27.847726+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.0.0.0b3 development milestone.", 
            "date_created": "2016-03-03 16:20:19.916336+00:00", 
            "author": "https://api.launchpad.net/1.0/~doug-hellmann"
        }, 
        {
            "content": "Change abandoned by Ankit Agrawal (<email address hidden>) on branch: stable/liberty\nReview: https://review.openstack.org/278928", 
            "date_created": "2016-03-24 07:36:50.165704+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-02-10 09:16:09.250369+00:00"
}