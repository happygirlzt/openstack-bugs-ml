{
    "status": "Fix Released", 
    "last_updated": "2017-04-14 09:23:38.527622+00:00", 
    "description": "Description\n===========\nIn openstack kilo release(I know it's somekind of out of date, howerver I noticed that the code cause this issue still exists in the latest nova.git repo), if you use spice as the default console, the type of a spice channel(used by apice agent) is 'pyt', which should be 'spicevmc'.\n\nSteps to reproduce\n==================\n1. Modify the nova.conf to use spice as default console.\nEdit /etc/nova/nova.conf, add the following lines:\n[default]\nvnc_enabled=false\n[spice]\nhtml5proxy_base_url=http://192.168.209.11:6082/spice_auto.html\nserver_listen=0.0.0.0\nserver_proxyclient_address=192.168.209.31\nenabled=true\nkeymap=en-us\n\n2. Modify the nova-compute log level to debug(For convenience, I just edit the log code from LOG.debug to LOG.error.)\nThe log code is in:\n/usr/lib/python2.7/site-packages/nova/virt/libvirt/config.py\n\u00a0\u00a0\u00a0\u00a0def to_xml(self, pretty_print=True):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0root = self.format_dom()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0xml_str = etree.tostring(root, pretty_print=pretty_print)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0LOG.debug(\"Generated XML %s \", (xml_str,))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return xml_str\nRestart the openstack-nova-compute.service: systemctl restart openstack-nova-compute.service\n\n3. Start an instance.\n\n4. Check the printed xml in /var/log/nova/nova-compute.log, you will see the generated xml:\n2016-10-18 16:54:36.848 7061 ERROR nova.virt.libvirt.config [req-76070e65-4c92-41eb-9ee6-a124fefae4d2 03a011159e8d464bafc89a88823a7403 92de23d236a6461f96c43e71ac7c60ae - - -] Generated XML ('<domain type=\"kvm\">\\n  <uuid>38181e25-df56-4594-97e6-f1da2bfe1579</uuid>\\n  <name>instance-00000044</name>\\n  <memory>4194304</memory>\\n  <vcpu>2</vcpu>\\n  <metadata>\\n    <nova:instance xmlns:nova=\"http://openstack.org/xmlns/libvirt/nova/1.0\">\\n      <nova:package version=\"2015.1.2-1.el7\"/>\\n      <nova:name>test</nova:name>\\n      <nova:creationTime>2016-10-18 08:54:36</nova:creationTime>\\n      <nova:flavor name=\"win7\">\\n        <nova:memory>4096</nova:memory>\\n        <nova:disk>40</nova:disk>\\n        <nova:swap>0</nova:swap>\\n        <nova:ephemeral>0</nova:ephemeral>\\n        <nova:vcpus>2</nova:vcpus>\\n      </nova:flavor>\\n      <nova:owner>\\n        <nova:user uuid=\"03a011159e8d464bafc89a88823a7403\">admin</nova:user>\\n        <nova:project uuid=\"92de23d236a6461f96c43e71ac7c60ae\">admin</nova:project>\\n      </nova:owner>\\n      <nova:root type=\"image\" uuid=\"2d8a12f8-556a-4459-bb76-c10b398269a0\"/>\\n    </nova:instance>\\n  </metadata>\\n  <sysinfo type=\"smbios\">\\n    <system>\\n      <entry name=\"manufacturer\">Fedora Project</entry>\\n      <entry name=\"product\">OpenStack Nova</entry>\\n      <entry name=\"version\">2015.1.2-1.el7</entry>\\n      <entry name=\"serial\">4d6ca91a-f38e-4329-95cc-0ff79326bd37</entry>\\n      <entry name=\"uuid\">38181e25-df56-4594-97e6-f1da2bfe1579</entry>\\n    </system>\\n  </sysinfo>\\n  <os>\\n    <type>hvm</type>\\n    <boot dev=\"hd\"/>\\n    <smbios mode=\"sysinfo\"/>\\n  </os>\\n  <features>\\n    <acpi/>\\n    <apic/>\\n  </features>\\n  <cputune>\\n    <shares>2048</shares>\\n  </cputune>\\n  <clock offset=\"utc\">\\n    <timer name=\"pit\" tickpolicy=\"delay\"/>\\n    <timer name=\"rtc\" tickpolicy=\"catchup\"/>\\n    <timer name=\"hpet\" present=\"no\"/>\\n  </clock>\\n  <cpu mode=\"host-model\" match=\"exact\">\\n    <topology sockets=\"2\" cores=\"1\" threads=\"1\"/>\\n  </cpu>\\n  <devices>\\n    <disk type=\"network\" device=\"disk\">\\n      <driver type=\"raw\" cache=\"none\"/>\\n      <source protocol=\"rbd\" name=\"vms/38181e25-df56-4594-97e6-f1da2bfe1579_disk\">\\n        <host name=\"192.168.30.208\" port=\"6789\"/>\\n      </source>\\n      <auth username=\"cinder\">\\n        <secret type=\"ceph\" uuid=\"812cdf8a-e932-4c03-84ed-d30ee2847fa2\"/>\\n      </auth>\\n      <target bus=\"virtio\" dev=\"vda\"/>\\n    </disk>\\n    <interface type=\"bridge\">\\n      <mac address=\"fa:16:3e:38:b4:6e\"/>\\n      <model type=\"virtio\"/>\\n      <source bridge=\"qbr313aad30-aa\"/>\\n      <target dev=\"tap313aad30-aa\"/>\\n    </interface>\\n    <serial type=\"file\">\\n      <source path=\"/var/lib/nova/instances/38181e25-df56-4594-97e6-f1da2bfe1579/console.log\"/>\\n    </serial>\\n    <serial type=\"pty\"/>\\n    <channel type=\"pty\">\\n      <target type=\"virtio\" name=\"com.redhat.spice.0\"/>\\n    </channel>\\n    <graphics type=\"spice\" autoport=\"yes\" keymap=\"en-us\" listen=\"0.0.0.0\"/>\\n    <video>\\n      <model type=\"qxl\"/>\\n    </video>\\n    <memballoon model=\"virtio\">\\n      <stats period=\"10\"/>\\n    </memballoon>\\n  </devices>\\n</domain>\\n',)\n\nExpected result\n===============\nThe channel type should be 'spicevmc', like this:\n\u00a0\u00a0\u00a0\u00a0<channel type='spicevmc'>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<target type='virtio' name='com.redhat.spice.0'/>\n\u00a0\u00a0\u00a0\u00a0</channel>\n\nI confirmed the expect result from the following aspects:\n1. Firstly, the test code in nova/tests/unit/virt/libvirt/test_config.py(latest nova.git repo)\n1411 class LibvirtConfigGuestChannelTest(LibvirtConfigBaseTest):\n1412     def test_config_spice_minimal(self):\n1413         obj = config.LibvirtConfigGuestChannel()\n1414         obj.type = \"spicevmc\"\n1415\n1416         xml = obj.to_xml()\n1417         self.assertXmlEqual(xml, \"\"\"\n1418             <channel type=\"spicevmc\">\n1419               <target type='virtio'/>\n1420             </channel>\"\"\")\n1421\n1422     def test_config_spice_full(self):\n1423         obj = config.LibvirtConfigGuestChannel()\n1424         obj.type = \"spicevmc\"\n1425         obj.target_name = \"com.redhat.spice.0\"\n1426\n1427         xml = obj.to_xml()\n1428         self.assertXmlEqual(xml, \"\"\"\n1429             <channel type=\"spicevmc\">\n1430               <target type='virtio' name='com.redhat.spice.0'/>\n1431             </channel>\"\"\")\n\n2. Secondly, if we use the channel whose type is 'pty', and install vdagent or spice-guest-tools-0.100.exe in windows 7 guest os, the CPU utilization of vdagent.exe is very high(I noticed both %50 and 99%, in two instances), and the error log is printed:\n(C:\\Windows\\Temp\\vdagent.log)\n1724::INFO::2016-10-18 0613:21,821::VDAgent::run::***Agent started in session 1***\n1724::INFO::2016-10-18 0613:21,821::log_version::0.5.1.0\n1724::INFO::2016-10-18 0613:21,821::DesktopLayout::consistent_displays::#qxls 1 #others 0\n1724::INFO::2016-10-18 0613:21,821::VDAgent::send_announce_capabilities::Sending capabilities:\n1724::INFO::2016-10-18 0613:21,821::VDAgent::send_announce_capabilities::6B7\n1724::INFO::2016-10-18 0613:21,821::VDAgent::run::Connected to server\n1724::INFO::2016-10-18 0613:21,821::VDAgent::input_desktop_message_loop::Desktop: Winlogon\n1724::INFO::2016-10-18 0613:21,821::VDAgent::write_completion:vio_serial write completion error 554\n\nThe mouse cursor moves slowly, you also cannot use clipboard between the guest os and the client.\nIf I modify the channel type to 'spicevmc', all the problems disappeared. And the mouse is released automatically if you move it out of the spice window, there is no need to press Ctrl+Alt.\n\nActual result\n=============\nThe channel type for spice agent is 'pty':\n\u00a0\u00a0\u00a0\u00a0<channel type='pty'>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<target type='virtio' name='com.redhat.spice.0'/>\n\u00a0\u00a0\u00a0\u00a0</channel>\n\nEnvironment\n===========\n1. OS and openstack release\n[root@node3 ~]# cat /etc/redhat-release\nCentOS Linux release 7.2.1511 (Core)\n[root@node3 ~]# uname -a\nLinux node3 3.10.0-327.el7.x86_64 #1 SMP Thu Nov 19 22:10:57 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n[root@node3 ~]# rpm -qa | grep nova\nopenstack-nova-common-2015.1.2-1.el7.noarch\nopenstack-nova-compute-2015.1.2-1.el7.noarch\npython-nova-2015.1.2-1.el7.noarch\npython-novaclient-2.23.0-1.el7.noarch\n\n2. Hypervisor\nLibvirt + QEMU + KVM\n[root@node3 ~]# rpm -qa | grep libvirt\nlibvirt-client-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-nodedev-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-storage-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-nwfilter-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-secret-1.2.17-13.el7_2.5.x86_64\nlibvirt-python-1.2.17-2.el7.x86_64\nlibvirt-daemon-driver-qemu-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-kvm-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-network-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-interface-1.2.17-13.el7_2.5.x86_64\n[root@node3 ~]# rpm -qa | grep qemu\nlibvirt-daemon-driver-qemu-1.2.17-13.el7_2.5.x86_64\nqemu-kvm-common-1.5.3-105.el7_2.7.x86_64\nipxe-roms-qemu-20160127-1.git6366fa7a.el7.noarch\nqemu-img-1.5.3-105.el7_2.7.x86_64\nqemu-kvm-1.5.3-105.el7_2.7.x86_64\n\nLogs & Configs\n==============\nNormal vdagent log if I use the 'spicevmc' channel type:\n1284::INFO::2016-10-18 06:39:43,000::VDAgent::run::***Agent started in session 1***\n1284::INFO::2016-10-18 06:39:43,000::log_version::0.5.1.0\n1284::INFO::2016-10-18 06:39:43,000::DesktopLayout::consistent_displays::#qxls 1 #others 0\n1284::INFO::2016-10-18 06:39:43,000::VDAgent::send_announce_capabilities::Sending capabilities:\n1284::INFO::2016-10-18 06:39:43,000::VDAgent::send_announce_capabilities::6B7\n1284::INFO::2016-10-18 06:39:43,000::VDAgent::run::Connected to server\n1284::INFO::2016-10-18 06:39:43,000::VDAgent::input_desktop_message_loop::Desktop: Winlogon\n1284::INFO::2016-10-18 06:39:43,031::VDAgent::handle_announce_capabilities::Got capabilities (1)\n1284::INFO::2016-10-18 06:39:43,031::VDAgent::handle_announce_capabilities::1077\n1284::INFO::2016-10-18 06:39:43,031::VDAgent::send_announce_capabilities::Sending capabilities:\n1284::INFO::2016-10-18 06:39:43,031::VDAgent::send_announce_capabilities::6B7\n1284::INFO::2016-10-18 06:39:43,046::DisplaySetting::set::setting display options\n1284::INFO::2016-10-18 06:39:43,046::DisplaySetting::get_user_process_id::explorer.exe not found\n1284::INFO::2016-10-18 06:39:43,046::DisplaySetting::reload_from_registry::get_user_process_id failed\n1284::INFO::2016-10-18 06:39:43,046::VDAgent::handle_max_clipboard::Set max clipboard size: 104857600\n1284::INFO::2016-10-18 06:39:43,046::VDAgent::handle_mon_config::0. 1024*768*32 (0,0) 1\n1284::INFO::2016-10-18 06:39:43,046::DesktopLayout::consistent_displays::#qxls 1 #others 0\n1284::INFO::2016-10-18 06:39:43,046::DesktopLayout::set_displays::Set display mode 1024x768\n1284::INFO::2016-10-18 06:39:43,078::VDAgent::wnd_proc::Display change\n1284::INFO::2016-10-18 06:39:43,078::DesktopLayout::consistent_displays::#qxls 1 #others 0\n1284::INFO::2016-10-18 06:39:48,625::VDAgent::handle_control_event::Control command 2\n1284::INFO::2016-10-18 06:39:48,625::VDAgent::handle_control_event::session logon\n1284::INFO::2016-10-18 06:39:54,046::VDAgent::handle_control_event::Control command 1\n1284::INFO::2016-10-18 06:39:54,062::VDAgent::input_desktop_message_loop::Desktop: Default\n1284::INFO::2016-10-18 06:39:54,062::VDAgent::input_desktop_message_loop::First display setting\n1284::INFO::2016-10-18 06:39:54,062::DisplaySetting::load::loading display setting\n1284::INFO::2016-10-18 06:39:54,062::DisplaySetting::get_user_process_id::explorer.exe not found\n1284::INFO::2016-10-18 06:39:54,062::DisplaySetting::reload_from_registry::get_user_process_id failed\n1284::INFO::2016-10-18 06:40:25,187::VDAgent::handle_clipboard_grab::grab type 1\n1284::INFO::2016-10-18 06:40:29,937::VDAgent::handle_control_event::Control command 3\n1284::INFO::2016-10-18 06:40:29,937::VDAgent::handle_clipboard_grab::grab type 1\n1284::INFO::2016-10-18 06:40:35,578::VDAgent::handle_control_event::Control command 3\n1284::INFO::2016-10-18 06:40:35,578::VDAgent::handle_clipboard_grab::grab type 1\n\nPatch\n==============\nFrom 2309f146f08c0d0c541ba3e8b392ee9ca072bd64 Mon Sep 17 00:00:00 2001\nFrom: m4cr0v <email address hidden>\nDate: Tue, 18 Oct 2016 20:55:22 +0800\nSubject: [PATCH] Fix type of the channel for spice agent.\n\nThe type of the channel for spice agent should be 'spicevmc' instead of 'pty'.\n---\n\u00a0nova/virt/libvirt/driver.py | 1 +\n\u00a01 file changed, 1 insertion(+)\n\ndiff --git a/nova/virt/libvirt/driver.py b/nova/virt/libvirt/driver.py\nindex b0bba46..6ddf65e 100644\n--- a/nova/virt/libvirt/driver.py\n+++ b/nova/virt/libvirt/driver.py\n@@ -4491,6 +4491,7 @@ class LibvirtDriver(driver.ComputeDriver):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if (CONF.spice.enabled and CONF.spice.agent_enabled and\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0virt_type not in ('lxc', 'uml', 'xen')):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0channel = vconfig.LibvirtConfigGuestChannel()\n+            channel.type = 'spicevmc'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0channel.target_name = \"com.redhat.spice.0\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0guest.add_device(channel)\n\n--\n1.8.3.1", 
    "tags": [
        "libvirt", 
        "newton-backport-potential", 
        "ocata-backport-potential", 
        "spice"
    ], 
    "importance": "Medium", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1634495", 
    "owner": "https://api.launchpad.net/1.0/~m4cr0v", 
    "id": 1634495, 
    "index": 4658, 
    "openned": "2016-10-18 13:03:07.281584+00:00", 
    "created": "2016-10-18 13:03:07.281584+00:00", 
    "title": "nova generate wrong spice channel type 'pty', which should be 'spicevmc'", 
    "comments": [
        {
            "content": "Description\n===========\nIn openstack kilo release(I know it's somekind of out of date, howerver I noticed that the code cause this issue still exists in the latest nova.git repo), if you use spice as the default console, the type of a spice channel(used by apice agent) is 'pyt', which should be 'spicevmc'.\n\n\nSteps to reproduce\n==================\n1. Modify the nova.conf to use spice as default console.\nEdit /etc/nova/nova.conf, add the following lines:\n[default]\nvnc_enabled=false\n[spice]\nhtml5proxy_base_url=http://192.168.209.11:6082/spice_auto.html\nserver_listen=0.0.0.0\nserver_proxyclient_address=192.168.209.31\nenabled=true\nkeymap=en-us\n\n2. Modify the nova-compute log level to debug(For convenience, I just edit the log code from LOG.debug to LOG.error.)\nThe log code is in:\n/usr/lib/python2.7/site-packages/nova/virt/libvirt/config.py\n    def to_xml(self, pretty_print=True):\n        root = self.format_dom()\n        xml_str = etree.tostring(root, pretty_print=pretty_print)\n        LOG.debug(\"Generated XML %s \", (xml_str,))\n        return xml_str\nRestart the openstack-nova-compute.service: systemctl restart openstack-nova-compute.service\n\n3. Start an instance.\n\n4. Check the printed xml in /var/log/nova/nova-compute.log, you will see the generated xml:\n2016-10-18 16:54:36.848 7061 ERROR nova.virt.libvirt.config [req-76070e65-4c92-41eb-9ee6-a124fefae4d2 03a011159e8d464bafc89a88823a7403 92de23d236a6461f96c43e71ac7c60ae - - -] Generated XML ('<domain type=\"kvm\">\\n  <uuid>38181e25-df56-4594-97e6-f1da2bfe1579</uuid>\\n  <name>instance-00000044</name>\\n  <memory>4194304</memory>\\n  <vcpu>2</vcpu>\\n  <metadata>\\n    <nova:instance xmlns:nova=\"http://openstack.org/xmlns/libvirt/nova/1.0\">\\n      <nova:package version=\"2015.1.2-1.el7\"/>\\n      <nova:name>test</nova:name>\\n      <nova:creationTime>2016-10-18 08:54:36</nova:creationTime>\\n      <nova:flavor name=\"win7\">\\n        <nova:memory>4096</nova:memory>\\n        <nova:disk>40</nova:disk>\\n        <nova:swap>0</nova:swap>\\n        <nova:ephemeral>0</nova:ephemeral>\\n        <nova:vcpus>2</nova:vcpus>\\n      </nova:flavor>\\n      <nova:owner>\\n        <nova:user uuid=\"03a011159e8d464bafc89a88823a7403\">admin</nova:user>\\n        <nova:project uuid=\"92de23d236a6461f96c43e71ac7c60ae\">admin</nova:project>\\n      </nova:owner>\\n      <nova:root type=\"image\" uuid=\"2d8a12f8-556a-4459-bb76-c10b398269a0\"/>\\n    </nova:instance>\\n  </metadata>\\n  <sysinfo type=\"smbios\">\\n    <system>\\n      <entry name=\"manufacturer\">Fedora Project</entry>\\n      <entry name=\"product\">OpenStack Nova</entry>\\n      <entry name=\"version\">2015.1.2-1.el7</entry>\\n      <entry name=\"serial\">4d6ca91a-f38e-4329-95cc-0ff79326bd37</entry>\\n      <entry name=\"uuid\">38181e25-df56-4594-97e6-f1da2bfe1579</entry>\\n    </system>\\n  </sysinfo>\\n  <os>\\n    <type>hvm</type>\\n    <boot dev=\"hd\"/>\\n    <smbios mode=\"sysinfo\"/>\\n  </os>\\n  <features>\\n    <acpi/>\\n    <apic/>\\n  </features>\\n  <cputune>\\n    <shares>2048</shares>\\n  </cputune>\\n  <clock offset=\"utc\">\\n    <timer name=\"pit\" tickpolicy=\"delay\"/>\\n    <timer name=\"rtc\" tickpolicy=\"catchup\"/>\\n    <timer name=\"hpet\" present=\"no\"/>\\n  </clock>\\n  <cpu mode=\"host-model\" match=\"exact\">\\n    <topology sockets=\"2\" cores=\"1\" threads=\"1\"/>\\n  </cpu>\\n  <devices>\\n    <disk type=\"network\" device=\"disk\">\\n      <driver type=\"raw\" cache=\"none\"/>\\n      <source protocol=\"rbd\" name=\"vms/38181e25-df56-4594-97e6-f1da2bfe1579_disk\">\\n        <host name=\"192.168.30.208\" port=\"6789\"/>\\n      </source>\\n      <auth username=\"cinder\">\\n        <secret type=\"ceph\" uuid=\"812cdf8a-e932-4c03-84ed-d30ee2847fa2\"/>\\n      </auth>\\n      <target bus=\"virtio\" dev=\"vda\"/>\\n    </disk>\\n    <interface type=\"bridge\">\\n      <mac address=\"fa:16:3e:38:b4:6e\"/>\\n      <model type=\"virtio\"/>\\n      <source bridge=\"qbr313aad30-aa\"/>\\n      <target dev=\"tap313aad30-aa\"/>\\n    </interface>\\n    <serial type=\"file\">\\n      <source path=\"/var/lib/nova/instances/38181e25-df56-4594-97e6-f1da2bfe1579/console.log\"/>\\n    </serial>\\n    <serial type=\"pty\"/>\\n    <channel type=\"spicevmc\">\\n      <target type=\"virtio\" name=\"com.redhat.spice.0\"/>\\n    </channel>\\n    <graphics type=\"spice\" autoport=\"yes\" keymap=\"en-us\" listen=\"0.0.0.0\"/>\\n    <video>\\n      <model type=\"qxl\"/>\\n    </video>\\n    <memballoon model=\"virtio\">\\n      <stats period=\"10\"/>\\n    </memballoon>\\n  </devices>\\n</domain>\\n',)\n\n\nExpected result\n===============\nThe channel type should be 'spicevmc', like this:\n    <channel type='spicevmc'>\n        <target type='virtio' name='com.redhat.spice.0'/>\n    </channel>\n\nI confirmed the expect result from the following aspects:\n1. Firstly, the test code in nova/tests/unit/virt/libvirt/test_config.py(latest nova.git repo)\n1411 class LibvirtConfigGuestChannelTest(LibvirtConfigBaseTest):\n1412     def test_config_spice_minimal(self):\n1413         obj = config.LibvirtConfigGuestChannel()\n1414         obj.type = \"spicevmc\"\n1415\n1416         xml = obj.to_xml()\n1417         self.assertXmlEqual(xml, \"\"\"\n1418             <channel type=\"spicevmc\">\n1419               <target type='virtio'/>\n1420             </channel>\"\"\")\n1421\n1422     def test_config_spice_full(self):\n1423         obj = config.LibvirtConfigGuestChannel()\n1424         obj.type = \"spicevmc\"\n1425         obj.target_name = \"com.redhat.spice.0\"\n1426\n1427         xml = obj.to_xml()\n1428         self.assertXmlEqual(xml, \"\"\"\n1429             <channel type=\"spicevmc\">\n1430               <target type='virtio' name='com.redhat.spice.0'/>\n1431             </channel>\"\"\")\n\n2. Secondly, if we use the channel whose type is 'pty', and install vdagent or spice-guest-tools-0.100.exe in windows 7 guest os, the CPU utilization of vdagent.exe is very high(I noticed both %50 and 99%, in two instances), and the error log is printed:\n(C:\\Windows\\Temp\\vdagent.log)\n1724::INFO::2016-10-18 0613:21,821::VDAgent::run::***Agent started in session 1***\n1724::INFO::2016-10-18 0613:21,821::log_version::0.5.1.0\n1724::INFO::2016-10-18 0613:21,821::DesktopLayout::consistent_displays::#qxls 1 #others 0\n1724::INFO::2016-10-18 0613:21,821::VDAgent::send_announce_capabilities::Sending capabilities:\n1724::INFO::2016-10-18 0613:21,821::VDAgent::send_announce_capabilities::6B7\n1724::INFO::2016-10-18 0613:21,821::VDAgent::run::Connected to server\n1724::INFO::2016-10-18 0613:21,821::VDAgent::input_desktop_message_loop::Desktop: Winlogon\n1724::INFO::2016-10-18 0613:21,821::VDAgent::write_completion:vio_serial write completion error 554\n \nThe mouse cursor moves slowly, you also cannot use clipboard between the guest os and the client.\nIf I modify the channel type to 'spicevmc', all the problems disappeared.\n\n\nActual result\n=============\nThe channel type for spice agent is 'pty':\n    <channel type='pty'>\n        <target type='virtio' name='com.redhat.spice.0'/>\n    </channel>\n\nEnvironment\n===========\n1. OS and openstack release\n[root@node3 ~]# cat /etc/redhat-release\nCentOS Linux release 7.2.1511 (Core)\n[root@node3 ~]# uname -a\nLinux node3 3.10.0-327.el7.x86_64 #1 SMP Thu Nov 19 22:10:57 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n[root@node3 ~]# rpm -qa | grep nova\nopenstack-nova-common-2015.1.2-1.el7.noarch\nopenstack-nova-compute-2015.1.2-1.el7.noarch\npython-nova-2015.1.2-1.el7.noarch\npython-novaclient-2.23.0-1.el7.noarch\n\n2. Hypervisor\nLibvirt + QEMU + KVM\n[root@node3 ~]# rpm -qa | grep libvirt\nlibvirt-client-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-nodedev-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-storage-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-nwfilter-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-secret-1.2.17-13.el7_2.5.x86_64\nlibvirt-python-1.2.17-2.el7.x86_64\nlibvirt-daemon-driver-qemu-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-kvm-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-network-1.2.17-13.el7_2.5.x86_64\nlibvirt-daemon-driver-interface-1.2.17-13.el7_2.5.x86_64\n[root@node3 ~]# rpm -qa | grep qemu\nlibvirt-daemon-driver-qemu-1.2.17-13.el7_2.5.x86_64\nqemu-kvm-common-1.5.3-105.el7_2.7.x86_64\nipxe-roms-qemu-20160127-1.git6366fa7a.el7.noarch\nqemu-img-1.5.3-105.el7_2.7.x86_64\nqemu-kvm-1.5.3-105.el7_2.7.x86_64\n\n\nLogs & Configs\n==============\nNormal vdagent log if I use the 'spicevmc' channel type:\n1284::INFO::2016-10-18 06:39:43,000::VDAgent::run::***Agent started in session 1***\n1284::INFO::2016-10-18 06:39:43,000::log_version::0.5.1.0\n1284::INFO::2016-10-18 06:39:43,000::DesktopLayout::consistent_displays::#qxls 1 #others 0\n1284::INFO::2016-10-18 06:39:43,000::VDAgent::send_announce_capabilities::Sending capabilities:\n1284::INFO::2016-10-18 06:39:43,000::VDAgent::send_announce_capabilities::6B7\n1284::INFO::2016-10-18 06:39:43,000::VDAgent::run::Connected to server\n1284::INFO::2016-10-18 06:39:43,000::VDAgent::input_desktop_message_loop::Desktop: Winlogon\n1284::INFO::2016-10-18 06:39:43,031::VDAgent::handle_announce_capabilities::Got capabilities (1)\n1284::INFO::2016-10-18 06:39:43,031::VDAgent::handle_announce_capabilities::1077\n1284::INFO::2016-10-18 06:39:43,031::VDAgent::send_announce_capabilities::Sending capabilities:\n1284::INFO::2016-10-18 06:39:43,031::VDAgent::send_announce_capabilities::6B7\n1284::INFO::2016-10-18 06:39:43,046::DisplaySetting::set::setting display options\n1284::INFO::2016-10-18 06:39:43,046::DisplaySetting::get_user_process_id::explorer.exe not found\n1284::INFO::2016-10-18 06:39:43,046::DisplaySetting::reload_from_registry::get_user_process_id failed\n1284::INFO::2016-10-18 06:39:43,046::VDAgent::handle_max_clipboard::Set max clipboard size: 104857600\n1284::INFO::2016-10-18 06:39:43,046::VDAgent::handle_mon_config::0. 1024*768*32 (0,0) 1\n1284::INFO::2016-10-18 06:39:43,046::DesktopLayout::consistent_displays::#qxls 1 #others 0\n1284::INFO::2016-10-18 06:39:43,046::DesktopLayout::set_displays::Set display mode 1024x768\n1284::INFO::2016-10-18 06:39:43,078::VDAgent::wnd_proc::Display change\n1284::INFO::2016-10-18 06:39:43,078::DesktopLayout::consistent_displays::#qxls 1 #others 0\n1284::INFO::2016-10-18 06:39:48,625::VDAgent::handle_control_event::Control command 2\n1284::INFO::2016-10-18 06:39:48,625::VDAgent::handle_control_event::session logon\n1284::INFO::2016-10-18 06:39:54,046::VDAgent::handle_control_event::Control command 1\n1284::INFO::2016-10-18 06:39:54,062::VDAgent::input_desktop_message_loop::Desktop: Default\n1284::INFO::2016-10-18 06:39:54,062::VDAgent::input_desktop_message_loop::First display setting\n1284::INFO::2016-10-18 06:39:54,062::DisplaySetting::load::loading display setting\n1284::INFO::2016-10-18 06:39:54,062::DisplaySetting::get_user_process_id::explorer.exe not found\n1284::INFO::2016-10-18 06:39:54,062::DisplaySetting::reload_from_registry::get_user_process_id failed\n1284::INFO::2016-10-18 06:40:25,187::VDAgent::handle_clipboard_grab::grab type 1\n1284::INFO::2016-10-18 06:40:29,937::VDAgent::handle_control_event::Control command 3\n1284::INFO::2016-10-18 06:40:29,937::VDAgent::handle_clipboard_grab::grab type 1\n1284::INFO::2016-10-18 06:40:35,578::VDAgent::handle_control_event::Control command 3\n1284::INFO::2016-10-18 06:40:35,578::VDAgent::handle_clipboard_grab::grab type 1\n\nPatch\n==============\nFrom 2309f146f08c0d0c541ba3e8b392ee9ca072bd64 Mon Sep 17 00:00:00 2001\nFrom: m4cr0v <email address hidden>\nDate: Tue, 18 Oct 2016 20:55:22 +0800\nSubject: [PATCH] Fix type of the channel for spice agent.\n\nThe type of the channel for spice agent should be 'spicevmc' instead of 'pty'.\n---\n nova/virt/libvirt/driver.py | 1 +\n 1 file changed, 1 insertion(+)\n\ndiff --git a/nova/virt/libvirt/driver.py b/nova/virt/libvirt/driver.py\nindex b0bba46..6ddf65e 100644\n--- a/nova/virt/libvirt/driver.py\n+++ b/nova/virt/libvirt/driver.py\n@@ -4491,6 +4491,7 @@ class LibvirtDriver(driver.ComputeDriver):\n         if (CONF.spice.enabled and CONF.spice.agent_enabled and\n                 virt_type not in ('lxc', 'uml', 'xen')):\n             channel = vconfig.LibvirtConfigGuestChannel()\n+            channel.type = 'spicevmc'\n             channel.target_name = \"com.redhat.spice.0\"\n             guest.add_device(channel)\n \n-- \n1.8.3.1", 
            "date_created": "2016-10-18 13:03:07.281584+00:00", 
            "author": "https://api.launchpad.net/1.0/~m4cr0v"
        }, 
        {
            "content": "", 
            "date_created": "2016-10-18 13:03:07.281584+00:00", 
            "author": "https://api.launchpad.net/1.0/~m4cr0v"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/389262", 
            "date_created": "2016-10-20 15:54:57.938636+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Hi, I checked the link you posted, it seems not related to this bug.", 
            "date_created": "2016-10-24 02:17:31.971829+00:00", 
            "author": "https://api.launchpad.net/1.0/~m4cr0v"
        }, 
        {
            "content": "Please submit the patch to gerrit. We don't do patches out of launchpad.", 
            "date_created": "2016-12-09 15:11:54.198093+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }, 
        {
            "content": "Change abandoned by Sean Dague (<email address hidden>) on branch: master\nReview: https://review.openstack.org/389262\nReason: This review is > 6 weeks without comment, and failed Jenkins the last time it was checked. We are abandoning this for now. Feel free to reactivate the review by pressing the restore button and leaving a 'recheck' comment to get fresh test results.", 
            "date_created": "2016-12-09 21:00:54.790931+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/410076", 
            "date_created": "2016-12-13 08:05:31.475150+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/410076\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=f4be97d8cf8811a64a2d9f7d990e79d45cdf0d62\nSubmitter: Jenkins\nBranch:    master\n\ncommit f4be97d8cf8811a64a2d9f7d990e79d45cdf0d62\nAuthor: m4cr0v <email address hidden>\nDate:   Tue Dec 13 16:17:34 2016 +0800\n\n    Fix spice channel type\n    \n    nova generate wrong spice channel type 'pty', which should be 'spicevmc'\n    Closes-Bug: #1634495\n    Change-Id: I58e9a8df9f40f900eeabd9d40429663cbbedb8d6\n", 
            "date_created": "2017-03-03 17:46:28.982504+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/441456", 
            "date_created": "2017-03-03 20:26:53.545807+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/441457", 
            "date_created": "2017-03-03 20:27:10.220296+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/441457\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=725f500d5e8e2058b8b2649b1908b13ab15a7a7b\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 725f500d5e8e2058b8b2649b1908b13ab15a7a7b\nAuthor: m4cr0v <email address hidden>\nDate:   Tue Dec 13 16:17:34 2016 +0800\n\n    Fix spice channel type\n    \n    nova generate wrong spice channel type 'pty', which should be 'spicevmc'\n    Closes-Bug: #1634495\n    Change-Id: I58e9a8df9f40f900eeabd9d40429663cbbedb8d6\n    (cherry picked from commit f4be97d8cf8811a64a2d9f7d990e79d45cdf0d62)\n", 
            "date_created": "2017-03-07 12:45:02.480979+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/441456\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c0fd42738819712e66336cf6f5f386f61cf26bda\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit c0fd42738819712e66336cf6f5f386f61cf26bda\nAuthor: m4cr0v <email address hidden>\nDate:   Tue Dec 13 16:17:34 2016 +0800\n\n    Fix spice channel type\n    \n    nova generate wrong spice channel type 'pty', which should be 'spicevmc'\n    Closes-Bug: #1634495\n    Change-Id: I58e9a8df9f40f900eeabd9d40429663cbbedb8d6\n    (cherry picked from commit f4be97d8cf8811a64a2d9f7d990e79d45cdf0d62)\n", 
            "date_created": "2017-03-07 17:20:36.776542+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.1 release.", 
            "date_created": "2017-03-15 11:15:44.903052+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.5 release.", 
            "date_created": "2017-03-22 10:13:12.233544+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b1 development milestone.", 
            "date_created": "2017-04-14 09:23:37.864276+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-03-03 17:46:26.430911+00:00"
}