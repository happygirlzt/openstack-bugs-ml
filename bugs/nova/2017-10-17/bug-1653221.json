{
    "status": "Fix Released", 
    "last_updated": "2017-04-14 09:23:23.533612+00:00", 
    "description": "Description\n===========\n\nThe payload of the service.update notification is defined to contain the availability_zone of the service however if there is no availability zone is associated to the service the field was missing from the notification payload. \n\nSteps to reproduce\n==================\n1) set up a devstack with log notification driver\n2) disable the state of one of the nova service with\nnova service disable\n3) check the log to see the content of the emitted service.update notification\n\nExpected result\n===============\n{\n    \"priority\": \"INFO\",\n    \"payload\": {\n        \"nova_object.namespace\": \"nova\",\n        \"nova_object.name\": \"ServiceStatusPayload\",\n        \"nova_object.version\": \"1.0\",\n        \"nova_object.data\": {\n            \"host\": \"host1\",\n            \"disabled\": false,\n            \"last_seen_up\": \"2012-10-29T13:42:05Z\",\n            \"binary\": \"nova-compute\",\n            \"topic\": \"compute\",\n            \"disabled_reason\": null,\n            \"report_count\": 1,\n            \"forced_down\": false,\n            \"version\": 15\n            \"availability_zone\": null\n        }\n    },\n    \"event_type\": \"service.update\",\n    \"publisher_id\": \"nova-compute:host1\"\n}\n\n\nActual result\n=============\n{\n    \"priority\": \"INFO\",\n    \"payload\": {\n        \"nova_object.namespace\": \"nova\",\n        \"nova_object.name\": \"ServiceStatusPayload\",\n        \"nova_object.version\": \"1.0\",\n        \"nova_object.data\": {\n            \"host\": \"host1\",\n            \"disabled\": false,\n            \"last_seen_up\": \"2012-10-29T13:42:05Z\",\n            \"binary\": \"nova-compute\",\n            \"topic\": \"compute\",\n            \"disabled_reason\": null,\n            \"report_count\": 1,\n            \"forced_down\": false,\n            \"version\": 15\n        }\n    },\n    \"event_type\": \"service.update\",\n    \"publisher_id\": \"nova-compute:host1\"\n}\n\nEnvironment\n===========\ndevstack with nova master a74d3ae4e815e3727961ef67bd801dada0267a0b", 
    "tags": [], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1653221", 
    "owner": "https://api.launchpad.net/1.0/~balazs-gibizer", 
    "id": 1653221, 
    "index": 4721, 
    "openned": "2016-12-30 10:33:53.702446+00:00", 
    "created": "2016-12-30 10:33:53.702446+00:00", 
    "title": "availability_zone field is missing from the service.update notification payload", 
    "comments": [
        {
            "content": "Description\n===========\n\nThe payload of the service.update notification is defined to contain the availability_zone of the service however if there is no availability zone is associated to the service the field was missing from the notification payload. \n\nSteps to reproduce\n==================\n1) set up a devstack with log notification driver\n2) disable the state of one of the nova service with\nnova service disable\n3) check the log to see the content of the emitted service.update notification\n\nExpected result\n===============\n{\n    \"priority\": \"INFO\",\n    \"payload\": {\n        \"nova_object.namespace\": \"nova\",\n        \"nova_object.name\": \"ServiceStatusPayload\",\n        \"nova_object.version\": \"1.0\",\n        \"nova_object.data\": {\n            \"host\": \"host1\",\n            \"disabled\": false,\n            \"last_seen_up\": \"2012-10-29T13:42:05Z\",\n            \"binary\": \"nova-compute\",\n            \"topic\": \"compute\",\n            \"disabled_reason\": null,\n            \"report_count\": 1,\n            \"forced_down\": false,\n            \"version\": 15\n            \"availability_zone\": null\n        }\n    },\n    \"event_type\": \"service.update\",\n    \"publisher_id\": \"nova-compute:host1\"\n}\n\n\nActual result\n=============\n{\n    \"priority\": \"INFO\",\n    \"payload\": {\n        \"nova_object.namespace\": \"nova\",\n        \"nova_object.name\": \"ServiceStatusPayload\",\n        \"nova_object.version\": \"1.0\",\n        \"nova_object.data\": {\n            \"host\": \"host1\",\n            \"disabled\": false,\n            \"last_seen_up\": \"2012-10-29T13:42:05Z\",\n            \"binary\": \"nova-compute\",\n            \"topic\": \"compute\",\n            \"disabled_reason\": null,\n            \"report_count\": 1,\n            \"forced_down\": false,\n            \"version\": 15\n        }\n    },\n    \"event_type\": \"service.update\",\n    \"publisher_id\": \"nova-compute:host1\"\n}\n\nEnvironment\n===========\ndevstack with nova master a74d3ae4e815e3727961ef67bd801dada0267a0b", 
            "date_created": "2016-12-30 10:33:53.702446+00:00", 
            "author": "https://api.launchpad.net/1.0/~balazs-gibizer"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/415857", 
            "date_created": "2016-12-30 10:35:56.089682+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/440347", 
            "date_created": "2017-03-02 11:06:49.073215+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/440347\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0082c47896475e968840a5f6c4e0f194523e10e8\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0082c47896475e968840a5f6c4e0f194523e10e8\nAuthor: Balazs Gibizer <email address hidden>\nDate:   Wed Mar 1 17:44:50 2017 +0100\n\n    re-orphan flavor after rpc deserialization\n    \n    The flavor objects stored in the instance object should not be used\n    to lazy load any data from the db as they are not connected to real\n    flavors in the db. These flavor objects are orphaned when created\n    but durin rpc deserialization every deserialized nova object\n    automatically gets a valid context. This can lead to unintended\n    lazy loading of the projects field of such flavor objects during\n    notification payload generation.\n    \n    This patch orphans the flavor objects stored in the instance object\n    after every deserialization.\n    \n    Change-Id: I458f81931bad7874e951e1c0fd464d149f61b244\n    Related-Bug: #1653221\n", 
            "date_created": "2017-03-10 19:01:47.794391+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/415857\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=655942069aa77abad90a742cd47690a81987e9d7\nSubmitter: Jenkins\nBranch:    master\n\ncommit 655942069aa77abad90a742cd47690a81987e9d7\nAuthor: Balazs Gibizer <email address hidden>\nDate:   Fri Jan 13 11:00:25 2017 +0100\n\n    handle uninited fields in notification payload\n    \n    Due to the not strict handling of uninitialized fields during\n    notification payload population it is possible that the emitted\n    notification missing some of the fields defined in the schema.\n    \n    There are two problematic cases:\n    1) no load tirggered for lazy loaded fields. If the field was not\n       loaded it is not added to the payload.\n    2) uninitialized, not lazy loadable fields are not added to the\n       payload.\n    \n    This patch makes sure that lazy load is triggered. If the field is\n    not lazy loadable and also not initialized then related payload\n    field will be set to None. If the payload field is not nullable\n    the code will fail to make sure that the inconsistency is detected.\n    \n    The following changes cannot be split to different commits because\n    as soon as the generic schema population code is fixed every listed\n    notification starts behaving differently.\n    \n    In some cases the availability_zone field of the Service object is left\n    unitialized by both the constructor and the obj_load_attr function this\n    caused that the availability_zone field of the service.update\n    notification was missing from the emitted notification payload.\n    \n    The extra_specs field of the Flavor object is not lazy loadable and not\n    initialized in the Flavor destroy case. So the extra_specs field of the\n    FlavorPayload needed to be made nullable.\n    \n    The projects field of the Flavor object is lazy loaded but when the\n    Flavor object is loaded as part of an Instance object Flavor is\n    orphaned and no lazy load is allowed on that Flavor object. In this\n    case the projects field of the FlavorPayload will be set to None to\n    signal that the information is not available. This also means that\n    the projects field of the FlavorPayload needed to be changed to\n    nullable.\n    \n    The hosts and id fields of the Aggregate object is not initialized\n    during the create of the Aggregate before the aggregate.create.start\n    needs to be sent. Therefore these fields needs to be nullable.\n    \n    Closes-Bug: #1653221\n    Change-Id: Ib122cd98ee0cc31938d5ff1d5c753053267a3bd4\n", 
            "date_created": "2017-03-11 02:20:35.156348+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b1 development milestone.", 
            "date_created": "2017-04-14 09:23:22.469310+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-03-11 02:20:33.002315+00:00"
}