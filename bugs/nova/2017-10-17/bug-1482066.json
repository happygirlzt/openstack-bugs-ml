{
    "status": "Fix Released", 
    "last_updated": "2017-06-16 12:13:36.436265+00:00", 
    "description": "I booted from an encrypted volume, when try to delete it, it failed\n\n'Device ip-10.238.157.47:3260-iscsi-iqn.2010-10.org.openstack:volume-d167a0ac-fab5-484a-865d-667f1583c2ab-lun-1 is not active.\\n'\n\n| fault                                | {\"message\": \"Unexpected error while running command.                                                                                                                             |\n|                                      | Command: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup luksClose ip-10.238.157.47:3260-iscsi-iqn.2010-10.org.openstack:volume-d167a0ac-fab5-484a-865d-667f1583c2ab-lun-1 |\n|                                      | Exit code: 4                                                                                                                                                                     |\n|                                      | Stdout: u''                                                                                                                                                                      |\n|                                      | Stderr: u'Dev\", \"code\": 500, \"details\": \"  File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 351, in decorated_function                                                     |\n|                                      |     return function(self, context, *args, **kwargs)                                                                                                                              |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2370, in terminate_instance                                                                                             |\n|                                      |     do_terminate_instance(instance, bdms)                                                                                                                                        |\n|                                      |   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py\\\", line 252, in inner                                                                              |\n|                                      |     return f(*args, **kwargs)                                                                                                                                                    |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2368, in do_terminate_instance                                                                                          |\n|                                      |     self._set_instance_error_state(context, instance)                                                                                                                            |\n|                                      |   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 119, in __exit__                                                                                  |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                                                                 |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2358, in do_terminate_instance                                                                                          |\n|                                      |     self._delete_instance(context, instance, bdms, quotas)                                                                                                                       |\n|                                      |   File \\\"/opt/stack/nova/nova/hooks.py\\\", line 149, in inner                                                                                                                     |\n|                                      |     rv = f(*args, **kwargs)                                                                                                                                                      |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2337, in _delete_instance                                                                                               |\n|                                      |     quotas.rollback()                                                                                                                                                            |\n|                                      |   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 119, in __exit__                                                                                  |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                                                                 |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2307, in _delete_instance                                                                                               |\n|                                      |     self._shutdown_instance(context, instance, bdms)                                                                                                                             |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2234, in _shutdown_instance                                                                                             |\n|                                      |     requested_networks)                                                                                                                                                          |\n|                                      |   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 119, in __exit__                                                                                  |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                                                                 |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2223, in _shutdown_instance                                                                                             |\n|                                      |     block_device_info)                                                                                                                                                           |\n|                                      |   File \\\"/opt/stack/nova/nova/virt/libvirt/driver.py\\\", line 768, in destroy                                                                                                     |\n|                                      |     destroy_disks, migrate_data)                                                                                                                                                 |\n|                                      |   File \\\"/opt/stack/nova/nova/virt/libvirt/driver.py\\\", line 844, in cleanup                                                                                                     |\n|                                      |     encryptor.detach_volume(**encryption)                                                                                                                                        |\n|                                      |   File \\\"/opt/stack/nova/nova/volume/encryptors/cryptsetup.py\\\", line 101, in detach_volume                                                                                      |\n|                                      |     self._close_volume(**kwargs)                                                                                                                                                 |\n|                                      |   File \\\"/opt/stack/nova/nova/volume/encryptors/luks.py\\\", line 128, in _close_volume                                                                                            |\n|                                      |     attempts=3)                                                                                                                                                                  |\n|                                      |   File \\\"/opt/stack/nova/nova/utils.py\\\", line 229, in execute                                                                                                                   |\n|                                      |     return processutils.execute(*cmd, **kwargs)                                                                                                                                  |\n|                                      |   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\\\", line 275, in execute                                                                         |\n|                                      |     cmd=sanitized_cmd)                                                                                                                                                           |\n|                                      | \", \"created\": \"2015-08-06T03:30:52Z\"}                                                                                                                                            |", 
    "tags": [
        "libvirt", 
        "volumes"
    ], 
    "importance": "High", 
    "heat": 10, 
    "link": "https://bugs.launchpad.net/nova/+bug/1482066", 
    "owner": "https://api.launchpad.net/1.0/~taget-9", 
    "id": 1482066, 
    "index": 1787, 
    "openned": "2015-08-06 06:05:03.200753+00:00", 
    "created": "2015-08-06 06:05:03.200753+00:00", 
    "title": "cannot delete nova instance if volume is not active", 
    "comments": [
        {
            "content": "I booted from an encrypted volume, when try to delete it, it failed\n\n'Device ip-10.238.157.47:3260-iscsi-iqn.2010-10.org.openstack:volume-d167a0ac-fab5-484a-865d-667f1583c2ab-lun-1 is not active.\\n'\n\n| fault                                | {\"message\": \"Unexpected error while running command.                                                                                                                             |\n|                                      | Command: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup luksClose ip-10.238.157.47:3260-iscsi-iqn.2010-10.org.openstack:volume-d167a0ac-fab5-484a-865d-667f1583c2ab-lun-1 |\n|                                      | Exit code: 4                                                                                                                                                                     |\n|                                      | Stdout: u''                                                                                                                                                                      |\n|                                      | Stderr: u'Dev\", \"code\": 500, \"details\": \"  File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 351, in decorated_function                                                     |\n|                                      |     return function(self, context, *args, **kwargs)                                                                                                                              |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2370, in terminate_instance                                                                                             |\n|                                      |     do_terminate_instance(instance, bdms)                                                                                                                                        |\n|                                      |   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py\\\", line 252, in inner                                                                              |\n|                                      |     return f(*args, **kwargs)                                                                                                                                                    |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2368, in do_terminate_instance                                                                                          |\n|                                      |     self._set_instance_error_state(context, instance)                                                                                                                            |\n|                                      |   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 119, in __exit__                                                                                  |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                                                                 |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2358, in do_terminate_instance                                                                                          |\n|                                      |     self._delete_instance(context, instance, bdms, quotas)                                                                                                                       |\n|                                      |   File \\\"/opt/stack/nova/nova/hooks.py\\\", line 149, in inner                                                                                                                     |\n|                                      |     rv = f(*args, **kwargs)                                                                                                                                                      |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2337, in _delete_instance                                                                                               |\n|                                      |     quotas.rollback()                                                                                                                                                            |\n|                                      |   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 119, in __exit__                                                                                  |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                                                                 |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2307, in _delete_instance                                                                                               |\n|                                      |     self._shutdown_instance(context, instance, bdms)                                                                                                                             |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2234, in _shutdown_instance                                                                                             |\n|                                      |     requested_networks)                                                                                                                                                          |\n|                                      |   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 119, in __exit__                                                                                  |\n|                                      |     six.reraise(self.type_, self.value, self.tb)                                                                                                                                 |\n|                                      |   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2223, in _shutdown_instance                                                                                             |\n|                                      |     block_device_info)                                                                                                                                                           |\n|                                      |   File \\\"/opt/stack/nova/nova/virt/libvirt/driver.py\\\", line 768, in destroy                                                                                                     |\n|                                      |     destroy_disks, migrate_data)                                                                                                                                                 |\n|                                      |   File \\\"/opt/stack/nova/nova/virt/libvirt/driver.py\\\", line 844, in cleanup                                                                                                     |\n|                                      |     encryptor.detach_volume(**encryption)                                                                                                                                        |\n|                                      |   File \\\"/opt/stack/nova/nova/volume/encryptors/cryptsetup.py\\\", line 101, in detach_volume                                                                                      |\n|                                      |     self._close_volume(**kwargs)                                                                                                                                                 |\n|                                      |   File \\\"/opt/stack/nova/nova/volume/encryptors/luks.py\\\", line 128, in _close_volume                                                                                            |\n|                                      |     attempts=3)                                                                                                                                                                  |\n|                                      |   File \\\"/opt/stack/nova/nova/utils.py\\\", line 229, in execute                                                                                                                   |\n|                                      |     return processutils.execute(*cmd, **kwargs)                                                                                                                                  |\n|                                      |   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\\\", line 275, in execute                                                                         |\n|                                      |     cmd=sanitized_cmd)                                                                                                                                                           |\n|                                      | \", \"created\": \"2015-08-06T03:30:52Z\"}                                                                                                                                            |", 
            "date_created": "2015-08-06 06:05:03.200753+00:00", 
            "author": "https://api.launchpad.net/1.0/~taget-9"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/215252", 
            "date_created": "2015-08-20 17:17:54.652605+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I don't think this is a regression in liberty, so marking as liberty-backport-potential so it's not blocking the liberty rc1.", 
            "date_created": "2015-09-23 15:48:44.983221+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/215252\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=11e20dd6f91d2417e45b44d8c9008b07ebdcec28\nSubmitter: Jenkins\nBranch:    master\n\ncommit 11e20dd6f91d2417e45b44d8c9008b07ebdcec28\nAuthor: Eli Qiao <email address hidden>\nDate:   Tue Oct 13 14:08:31 2015 +0800\n\n    Ignore errorcode=4 when executing `cryptsetup remove` command\n    \n    If an attached encrypted volume is failed to detach from the instance\n    when deleting that instance, user can not delete that instance at all.\n    \n    This patch adds 4 in check_exit_code when executing `cryptsetup remove`\n    command to eat that exception.\n    \n    PS: exit_code = 4 indicate ENODEV error which means no device(also includes\n    the crypt device inactive).\n    \n    Closes-Bug: #1482066\n    Change-Id: I12e2a52068850528a4bd68486344b74eb9b82c88\n", 
            "date_created": "2015-10-14 08:51:08.732213+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 13.0.0.0b1 development milestone.", 
            "date_created": "2015-12-02 16:17:40.669976+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Fix proposed to branch: stable/liberty\nReview: https://review.openstack.org/288480", 
            "date_created": "2016-03-04 14:33:12.456743+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/288480\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=20c3335478de9495c55ce63a3a21fab97de1642f\nSubmitter: Jenkins\nBranch:    stable/liberty\n\ncommit 20c3335478de9495c55ce63a3a21fab97de1642f\nAuthor: Eli Qiao <email address hidden>\nDate:   Tue Oct 13 14:08:31 2015 +0800\n\n    Ignore errorcode=4 when executing `cryptsetup remove` command\n    \n    If an attached encrypted volume is failed to detach from the instance\n    when deleting that instance, user can not delete that instance at all.\n    \n    This patch adds 4 in check_exit_code when executing `cryptsetup remove`\n    command to eat that exception.\n    \n    PS: exit_code = 4 indicate ENODEV error which means no device(also includes\n    the crypt device inactive).\n    \n    Closes-Bug: #1482066\n    Change-Id: I12e2a52068850528a4bd68486344b74eb9b82c88\n    (cherry picked from commit 11e20dd6f91d2417e45b44d8c9008b07ebdcec28)\n", 
            "date_created": "2016-03-24 03:06:41.256155+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 12.0.3 release.", 
            "date_created": "2016-04-14 12:29:31.283488+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }
    ], 
    "closed": "2015-12-03 21:33:10.791057+00:00"
}