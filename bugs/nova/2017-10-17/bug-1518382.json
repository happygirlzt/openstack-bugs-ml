{
    "status": "Invalid", 
    "last_updated": "2015-11-20 19:07:03.130086+00:00", 
    "description": "Nova version (mitaka):\n\nstack@archive:/opt/stack/nova$ git log -1\ncommit f6a5a43e06c2af6325d7a3552c71e968565684fc\nMerge: f268cf5 0df6fba\nAuthor: Jenkins <email address hidden>\nDate:   Mon Nov 16 18:01:40 2015 +0000\n\n    Merge \"Remove duplicate server.kill on test shutdown\"\nstack@archive:/opt/stack/nova$\n\n\n\npython-novaclient version:\n\nstack@archive:/opt/stack/nova$ pip show python-novaclient\n---\nMetadata-Version: 2.0\nName: python-novaclient\nVersion: 2.35.0\nSummary: Client library for OpenStack Compute API\nHome-page: https://www.openstack.org\nAuthor: OpenStack\nAuthor-email: <email address hidden>\nLicense: Apache License, Version 2.0\nLocation: /usr/local/lib/python2.7/dist-packages\nRequires: oslo.i18n, oslo.serialization, python-keystoneclient, argparse, Babel, oslo.utils, iso8601, requests, pbr, six, PrettyTable, simplejson\nstack@archive:/opt/stack/nova$\n\n\nAs a non-admin user, I created some servers and deleted them:\n\nmysql> select display_name,uuid,deleted from nova.instances;\n+--------------+--------------------------------------+---------+\n| display_name | uuid                                 | deleted |\n+--------------+--------------------------------------+---------+\n| test         | ca3e57c0-cf37-40ab-9322-4cde6fe242d9 |       1 |\n| test2        | 8d555e3b-41db-495d-8d03-4918a011472c |       2 |\n| test3        | ef4c5911-958a-47e7-b836-42da9d32c209 |       3 |\n+--------------+--------------------------------------+---------+\n3 rows in set (0.00 sec)\n\nAs the admin user, I should be able to list them using 'nova list --deleted', but that fails with a 500 because an InstanceNotFound is not handled in the API code:\n\n2015-11-20 16:26:11.033 ERROR nova.api.openstack.extensions [req-aaea6f78-bf6d-4c35-ad46-decba714767b admin demo] Unexpected exception in API method\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions Traceback (most recent call last):\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/servers.py\", line 280, in detail\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     servers = self._get_servers(req, is_detail=True)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/servers.py\", line 406, in _get_servers\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     response = self._view_builder.detail(req, instance_list)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/views/servers.py\", line 151, in detail\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     return self._list_view(self.show, request, instances, coll_name)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/views/servers.py\", line 163, in _list_view\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     server_list = [func(request, server)[\"server\"] for server in servers]\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/views/servers.py\", line 291, in show\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     \"flavor\": self._get_flavor(request, instance),\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/views/servers.py\", line 223, in _get_flavor\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     instance_type = instance.get_flavor()\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/instance.py\", line 863, in get_flavor\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     return getattr(self, attr)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 66, in getter\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     self.obj_load_attr(name)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/instance.py\", line 853, in obj_load_attr\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     self._load_flavor()\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/instance.py\", line 744, in _load_flavor\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     expected_attrs=['flavor', 'system_metadata'])\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 171, in wrapper\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/instance.py\", line 373, in get_by_uuid\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     use_slave=use_slave)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/api.py\", line 651, in instance_get_by_uuid\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     columns_to_join, use_slave=use_slave)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 204, in wrapper\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 1719, in instance_get_by_uuid\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     columns_to_join=columns_to_join, use_slave=use_slave)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 1731, in _instance_get_by_uuid\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     raise exception.InstanceNotFound(instance_id=uuid)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions InstanceNotFound: Instance ef4c5911-958a-47e7-b836-42da9d32c209 could not be found.\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions\n\n\nIt looks like it's trying to lazy load a flavor on the instance object which fails because it's not reading the deleted instance at that point.", 
    "tags": [
        "api", 
        "db", 
        "unified-objects"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1518382", 
    "owner": "None", 
    "id": 1518382, 
    "index": 4392, 
    "openned": "2015-11-20 16:33:35.401809+00:00", 
    "created": "2015-11-20 16:33:35.401809+00:00", 
    "title": "nova list --deleted fails with a 500 response", 
    "comments": [
        {
            "content": "Nova version (mitaka):\n\nstack@archive:/opt/stack/nova$ git log -1\ncommit f6a5a43e06c2af6325d7a3552c71e968565684fc\nMerge: f268cf5 0df6fba\nAuthor: Jenkins <email address hidden>\nDate:   Mon Nov 16 18:01:40 2015 +0000\n\n    Merge \"Remove duplicate server.kill on test shutdown\"\nstack@archive:/opt/stack/nova$\n\n\n\npython-novaclient version:\n\nstack@archive:/opt/stack/nova$ pip show python-novaclient\n---\nMetadata-Version: 2.0\nName: python-novaclient\nVersion: 2.35.0\nSummary: Client library for OpenStack Compute API\nHome-page: https://www.openstack.org\nAuthor: OpenStack\nAuthor-email: <email address hidden>\nLicense: Apache License, Version 2.0\nLocation: /usr/local/lib/python2.7/dist-packages\nRequires: oslo.i18n, oslo.serialization, python-keystoneclient, argparse, Babel, oslo.utils, iso8601, requests, pbr, six, PrettyTable, simplejson\nstack@archive:/opt/stack/nova$\n\n\nAs a non-admin user, I created some servers and deleted them:\n\nmysql> select display_name,uuid,deleted from nova.instances;\n+--------------+--------------------------------------+---------+\n| display_name | uuid                                 | deleted |\n+--------------+--------------------------------------+---------+\n| test         | ca3e57c0-cf37-40ab-9322-4cde6fe242d9 |       1 |\n| test2        | 8d555e3b-41db-495d-8d03-4918a011472c |       2 |\n| test3        | ef4c5911-958a-47e7-b836-42da9d32c209 |       3 |\n+--------------+--------------------------------------+---------+\n3 rows in set (0.00 sec)\n\nAs the admin user, I should be able to list them using 'nova list --deleted', but that fails with a 500 because an InstanceNotFound is not handled in the API code:\n\n2015-11-20 16:26:11.033 ERROR nova.api.openstack.extensions [req-aaea6f78-bf6d-4c35-ad46-decba714767b admin demo] Unexpected exception in API method\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions Traceback (most recent call last):\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/extensions.py\", line 478, in wrapped\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/servers.py\", line 280, in detail\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     servers = self._get_servers(req, is_detail=True)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/servers.py\", line 406, in _get_servers\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     response = self._view_builder.detail(req, instance_list)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/views/servers.py\", line 151, in detail\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     return self._list_view(self.show, request, instances, coll_name)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/views/servers.py\", line 163, in _list_view\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     server_list = [func(request, server)[\"server\"] for server in servers]\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/views/servers.py\", line 291, in show\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     \"flavor\": self._get_flavor(request, instance),\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/api/openstack/compute/views/servers.py\", line 223, in _get_flavor\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     instance_type = instance.get_flavor()\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/instance.py\", line 863, in get_flavor\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     return getattr(self, attr)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 66, in getter\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     self.obj_load_attr(name)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/instance.py\", line 853, in obj_load_attr\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     self._load_flavor()\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/instance.py\", line 744, in _load_flavor\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     expected_attrs=['flavor', 'system_metadata'])\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/usr/local/lib/python2.7/dist-packages/oslo_versionedobjects/base.py\", line 171, in wrapper\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     result = fn(cls, context, *args, **kwargs)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/objects/instance.py\", line 373, in get_by_uuid\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     use_slave=use_slave)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/api.py\", line 651, in instance_get_by_uuid\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     columns_to_join, use_slave=use_slave)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 204, in wrapper\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     return f(*args, **kwargs)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 1719, in instance_get_by_uuid\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     columns_to_join=columns_to_join, use_slave=use_slave)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions   File \"/opt/stack/nova/nova/db/sqlalchemy/api.py\", line 1731, in _instance_get_by_uuid\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions     raise exception.InstanceNotFound(instance_id=uuid)\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions InstanceNotFound: Instance ef4c5911-958a-47e7-b836-42da9d32c209 could not be found.\n2015-11-20 16:26:11.033 TRACE nova.api.openstack.extensions\n\n\nIt looks like it's trying to lazy load a flavor on the instance object which fails because it's not reading the deleted instance at that point.", 
            "date_created": "2015-11-20 16:33:35.401809+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I should note that before running `nova list --deleted` here I was also doing some archiving, so the DB might be in a weird state if there are half-missing dependent resources for loading the instance to work, i.e. running:\n\nnova-manage db archive_deleted_rows 5000", 
            "date_created": "2015-11-20 16:42:21.549729+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This is invalid, it's a side effect of bug 1183523 where archive_deleted_rows deletes some things but not others (like instances) because of foreign key constraints.\n\nSo the problem I was having was the instance_extra table was empty, and that's where the flavor information is stored for the instance.\n\nWhen I cleaned my DB and re-did the scenario:\n\n1. boot instance\n2. delete instance\n3. nova list --deleted\n\nThat works (as admin for #3).  So marking this invalid.", 
            "date_created": "2015-11-20 19:06:56.417203+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }
    ], 
    "closed": "2015-11-20 19:07:01.224733+00:00"
}