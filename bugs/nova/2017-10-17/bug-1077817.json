{
    "status": "Fix Released", 
    "last_updated": "2013-10-17 11:45:41.951971+00:00", 
    "description": "When mounting a RBD volume to an instance, nova-volume/cinder doesn't pass Ceph  monitor(MON) addresses to libvirt.Whithout the MON address, libvirt failed to tal with MON and then cannot plug in the disk into volume.\nThis bug also affect cinder.\n\nHere is the error log from nova-compute:\n\n2012-11-12 12:12:36 ERROR nova.compute.manager [req-0bb59b29-5d0a-4e1d-8f90-b3ceffb41ddb 94baac25958a4400a95535b95fad6012 4b2e53cca0\n3245d0ac58041f1b6489d1] [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20] Failed to attach volume a69b76be-ce01-4ede-bfac-8230d5e4c48\nf at /dev/vdb\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20] Traceback (most recent call last):\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]   File \"/usr/lib/python2.7/dist-pack\nages/nova/compute/manager.py\", line 1971, in _attach_volume\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]     mountpoint)\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]   File \"/usr/lib/python2.7/dist-pack\nages/nova/exception.py\", line 117, in wrapped\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]     temp_level, payload)\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]   File \"/usr/lib/python2.7/contextli\nb.py\", line 24, in __exit__\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]     self.gen.next()\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]   File \"/usr/lib/python2.7/dist-pack\nages/nova/exception.py\", line 92, in wrapped\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]     return f(*args, **kw)\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]   File \"/usr/lib/python2.7/dist-pack\nages/nova/virt/libvirt/driver.py\", line 649, in attach_volume\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]     raise exception.DeviceIsBusy(dev\nice=mount_device)\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20] DeviceIsBusy: The supplied device (v\ndb) is busy.\n\nWhen looking into libvirt's log,the following error presents:\n\nunable to find any monitors in conf. please specify monitors via -m monaddr or -c ceph.conf\n\nHere is the XML generated by libvirt,\n<disk type=\"network\" device=\"disk\">\n\u00a0\u00a0<driver name=\"qemu\" type=\"raw\" cache=\"none\"/>\n\u00a0\u00a0<source protocol=\"rbd\" name=\"nova/volume-a69b76be-ce01-4ede-bfac-8230d5e4c48f\"/>\n\u00a0\u00a0<target bus=\"virtio\" dev=\"vdb\"/>\n\u00a0\u00a0<serial>a69b76be-ce01-4ede-bfac-8230d5e4c48f</serial>\n</disk>\nBut from the link (http://libvirt.org/storage.html#StorageBackendRBD), we can know that monitor's ips can be specified in XML rather than a extra ceph.conf\n     <pool type=\"rbd\">\n        <name>myrbdpool</name>\n        <source>\n          <name>rbdpool</name>\n            <host name='1.2.3.4' port='6789'/>\n            <host name='my.ceph.monitor' port='6789'/>\n            <host name='third.ceph.monitor' port='6789'/>\n            <auth username='admin' type='ceph'>\n              <secret uuid='2ec115d7-3a88-3ceb-bc12-0ac909a6fd87'/>\n            </auth>\n        </source>\n      </pool>", 
    "tags": [], 
    "importance": "High", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1077817", 
    "owner": "https://api.launchpad.net/1.0/~jdurgin", 
    "id": 1077817, 
    "index": 876, 
    "openned": "2012-11-12 06:55:48.142605+00:00", 
    "created": "2012-11-12 06:55:48.142605+00:00", 
    "title": "Nova failed to mount a RBD volume without extra ceph.conf", 
    "comments": [
        {
            "content": "When mounting a RBD volume to an instance, nova-volume/cinder doesn't pass Ceph  monitor(MON) addresses to libvirt.Whithout the MON address, libvirt failed to tal with MON and then cannot plug in the disk into volume.\nThis bug also affect cinder.\n\nHere is the error log from nova-compute:\n\n2012-11-12 12:12:36 ERROR nova.compute.manager [req-0bb59b29-5d0a-4e1d-8f90-b3ceffb41ddb 94baac25958a4400a95535b95fad6012 4b2e53cca0\n3245d0ac58041f1b6489d1] [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20] Failed to attach volume a69b76be-ce01-4ede-bfac-8230d5e4c48\nf at /dev/vdb\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20] Traceback (most recent call last):\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]   File \"/usr/lib/python2.7/dist-pack\nages/nova/compute/manager.py\", line 1971, in _attach_volume\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]     mountpoint)\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]   File \"/usr/lib/python2.7/dist-pack\nages/nova/exception.py\", line 117, in wrapped\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]     temp_level, payload)\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]   File \"/usr/lib/python2.7/contextli\nb.py\", line 24, in __exit__\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]     self.gen.next()\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]   File \"/usr/lib/python2.7/dist-pack\nages/nova/exception.py\", line 92, in wrapped\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]     return f(*args, **kw)\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]   File \"/usr/lib/python2.7/dist-pack\nages/nova/virt/libvirt/driver.py\", line 649, in attach_volume\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20]     raise exception.DeviceIsBusy(dev\nice=mount_device)\n2012-11-12 12:12:36 TRACE nova.compute.manager [instance: 5b919282-6e93-4b16-9bb5-9cb95d25bc20] DeviceIsBusy: The supplied device (v\ndb) is busy.\n\nWhen looking into libvirt's log,the following error presents:\n\nunable to find any monitors in conf. please specify monitors via -m monaddr or -c ceph.conf\n\n\nHere is the XML generated by libvirt,\n<disk type=\"network\" device=\"disk\">\n  <driver name=\"qemu\" type=\"raw\" cache=\"none\"/>\n  <source protocol=\"rbd\" name=\"nova/volume-a69b76be-ce01-4ede-bfac-8230d5e4c48f\"/>\n  <target bus=\"virtio\" dev=\"vdb\"/>\n  <serial>a69b76be-ce01-4ede-bfac-8230d5e4c48f</serial>\n</disk>\nBut from the link (http://libvirt.org/storage.html#StorageBackendRBD), we can know that monitor's ips can be specified in XML rather than a extra ceph.conf", 
            "date_created": "2012-11-12 06:55:48.142605+00:00", 
            "author": "https://api.launchpad.net/1.0/~xiaoxichen"
        }, 
        {
            "content": "This is how it's designed to work right now. See my response to the question https://answers.launchpad.net/nova/+question/201366.\n\nAs I noted there, this should be changed in the future, but that's more of a cleanup/feature than a bug.\nNote that http://ceph.com/docs/master/rbd/rbd-openstack/#configure-openstack-ceph-clients includes adding a ceph.conf with\nmonitor addresses to the compute host.", 
            "date_created": "2012-11-13 16:30:47.313781+00:00", 
            "author": "https://api.launchpad.net/1.0/~jdurgin"
        }, 
        {
            "content": "But as long as ceph.conf can only exist one,it seems hard to have several ceph clusters as backends.\nIn some scenarios, service provider would like to have  ceph cluster A with SSDs but ceph cluster B with SATA disks, to meet different criteria .Something like Amazon's 'standard EBS' and 'Provisioned EBS'.", 
            "date_created": "2012-11-14 00:31:20.419315+00:00", 
            "author": "https://api.launchpad.net/1.0/~xiaoxichen"
        }, 
        {
            "content": "You can use different pools within a single ceph cluster to do that. Pools may share any number of osds, from 0, some, to all, depending on your crush rules (see http://ceph.com/docs/master/cluster-ops/crush-map/). So you could have one pool with ssds, and another with sata disks. Currently this would require two instances of nova-volume or cinder-volume, one for each pool.", 
            "date_created": "2012-11-14 01:15:30.041352+00:00", 
            "author": "https://api.launchpad.net/1.0/~jdurgin"
        }, 
        {
            "content": "Well,we have to admit that there exist some scenarios which require several ceph clusters as backends-although Ceph is power enough to properly combine 2 clusters into 1 by clush rules ,but it require much more effort than just starting several cinder-volume instance and config proper monitor addresses for them.  \n\nI am not sure if sheepdog face the same situation since sheepdog need gateway address for data accessing.As a framework,Nova and Cinder should work together to support passing more informations from cinder configuration to libvirt.", 
            "date_created": "2012-11-14 02:45:44.277695+00:00", 
            "author": "https://api.launchpad.net/1.0/~xiaoxichen"
        }, 
        {
            "content": "It's certainly useful, and passing the full connection info from cinder makes sense in the future, I just wouldn't call it a high priority bug. There's a blueprint and a patch for partial support on the nova side https://blueprints.launchpad.net/nova/+spec/better-libvirt-network-volume-support", 
            "date_created": "2012-11-14 16:22:20.186014+00:00", 
            "author": "https://api.launchpad.net/1.0/~jdurgin"
        }, 
        {
            "content": "Can we please reduce the importance for Nova to Medium as well?", 
            "date_created": "2013-03-18 18:16:38.795063+00:00", 
            "author": "https://api.launchpad.net/1.0/~dims-v"
        }, 
        {
            "content": "I had the same issue, thank you Josh for your answer - at the moment - if people are still facing the issue, they need to create a /etc/ceph/ceph.conf on every compute node that contains the mon addresses - enven if not any ceph component is installed on the nodes", 
            "date_created": "2013-05-10 07:37:54.209763+00:00", 
            "author": "https://api.launchpad.net/1.0/~razique"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/30790", 
            "date_created": "2013-05-28 20:35:19.536043+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/30791", 
            "date_created": "2013-05-28 20:35:32.149000+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/30791\nCommitted: http://github.com/openstack/cinder/commit/483b84e42b90f2ffe0a09f5e38b85eb64cf8f7d9\nSubmitter: Jenkins\nBranch:    master\n\ncommit 483b84e42b90f2ffe0a09f5e38b85eb64cf8f7d9\nAuthor: Josh Durgin <email address hidden>\nDate:   Fri May 24 18:18:30 2013 -0700\n\n    rbd: send ceph monitor addresses with connection info\n    \n    Previously we relied on a ceph configuration file on the compute host\n    for this information. Sending the info directly from cinder makes more\n    complex setups with multiple ceph clusters talking to the same compute\n    hosts possible.\n    \n    Refresh the monitor addresses for each initialize_connection() call,\n    since monitors may be added or removed while cinder-volume is\n    running.\n    \n    Fixes: bug 1077817\n    Signed-off-by: Josh Durgin <email address hidden>\n    \n    Change-Id: I34a1fa16ce1f4524ba25832faf3129303e755100\n", 
            "date_created": "2013-05-29 18:17:15.550774+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/30790\nCommitted: http://github.com/openstack/nova/commit/4d99a3486911badc39be4e089bd4106c03a8a671\nSubmitter: Jenkins\nBranch:    master\n\ncommit 4d99a3486911badc39be4e089bd4106c03a8a671\nAuthor: Josh Durgin <email address hidden>\nDate:   Fri May 24 17:31:17 2013 -0700\n\n    libvirt: improve the specification of network disks\n    \n    Allow zero or more hosts, and make the name optional, since only a\n    host is needed to use nbd. This allows cinder to fully specify the\n    location of a sheepdog or rbd volume without depending on extra\n    configuration files, and lays the groundwork for supporting nbd.\n    \n    Rename the internal attribute source_host to source_name to reflect\n    its usage in the libvirt xml, and add source_hosts and source_ports\n    attributes to store the new information.\n    \n    Fixes: bug 1077817\n    blueprint better-libvirt-network-volume-support\n    Signed-off-by: Josh Durgin <email address hidden>\n    \n    Change-Id: I8ac431751692e52ba0786768cea996388962922d\n", 
            "date_created": "2013-06-12 07:57:23.872315+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2013-07-17 12:11:31.306978+00:00"
}