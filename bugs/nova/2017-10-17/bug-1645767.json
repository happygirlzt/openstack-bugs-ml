{
    "status": "Invalid", 
    "last_updated": "2016-12-19 13:38:10.500186+00:00", 
    "description": "Description\n===========\nIf instance has encrypted volume connected to it and mounted during the host failure, 'nova evacuate' would result in instance entering the error state.\n\nSteps to reproduce\n==================\n1. Boot a VM\na) nova boot --image 2c60a713-bbba-4696-adff-c80a12cab7d8 --flavor 42 --nic net-id=eb6c7f6b-100f-41bb-9c5d-11975a2cdba6 --availability-zone nova:compute1 test\nb) nova floating-ip-associate test 192.168.57.50\n\n2. Create an encrypted volume\na) cinder type-create LUKS\nb) cinder encryption-type-create --cipher aes-xts-plain64 --key_size 512 \\                 \n  --control_location front-end LUKS nova.volume.encryptors.luks.LuksEncryptor\nc) openstack volume create --size 1 --type 58931c06-1431-45cf-9b4c-4e998594447d test-volume\n\n3. Attach the volume to instance\na) openstack server add volume test d06b7b7c-641d-4086-a3b1-4eee898b5c2a\n\n4. SSH to instance, create file system on volume and mount it\na) ssh cirros@192.168.57.50\nb) sudo mkfs.ext3 /dev/vdb\nc) sudo mount /dev/vdb /mnt\nd) sudo touch /mtn/test\n\n5. Kill the compute node (In my case it was powering of the compute1)\n\n6. Try to evacuate instance using `nova evacuate`\n\nExpected result\n===============\nInstance rebuilded on another host, with volume attached to it.\n\nActual result\n=============\nInstance entered the error state. Output from `nova show test`:\n\nUnexpected error while running command.           \nCommand: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup luksOpen --key-file=- /dev/sdc crypt-ip-192.168.57.2:3260-iscsi-iqn.2010-10.org.openstack:volume-d06b7b7c-641d-4086-a3b1-4eee898b5c2a-lun-1 \n Exit code: 2\", \"code\": 500, \"details\": \"  File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 204, in decorated_function                                        \n     return function(self, context, *args, **kwargs)                                        \n   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2703, in rebuild_instance                                        \n     bdms, recreate, on_shared_storage, preserve_ephemeral)                                        \n   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2747, in _do_rebuild_instance_with_claim                                        \n     self._do_rebuild_instance(*args, **kwargs)                                        \n   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2862, in _do_rebuild_instance                                        \n     self._rebuild_default_impl(**kwargs)                                        \n   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2626, in _rebuild_default_impl                                        \n     block_device_info=new_block_device_info)                                        \n   File \\\"/opt/stack/nova/nova/virt/libvirt/driver.py\\\", line 2622, in spawn                                        \n     post_xml_callback=gen_confdrive)                                        \n   File \\\"/opt/stack/nova/nova/virt/libvirt/driver.py\\\", line 4845, in _create_domain_and_network                                        \n     encryptor.attach_volume(context, **encryption)                                        \n   File \\\"/opt/stack/nova/nova/volume/encryptors/luks.py\\\", line 102, in attach_volume                                        \n     self._open_volume(passphrase, **kwargs)                                        \n   File \\\"/opt/stack/nova/nova/volume/encryptors/luks.py\\\", line 86, in _open_volume                                        \n     run_as_root=True, check_exit_code=True)                                        \n   File \\\"/opt/stack/nova/nova/utils.py\\\", line 295, in execute                                        \n     return RootwrapProcessHelper().execute(*cmd, **kwargs)                                        \n   File \\\"/opt/stack/nova/nova/utils.py\\\", line 178, in execute                                        \n     return processutils.execute(*cmd, **kwargs)                                        \n   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\\\", line 394, in execute                                        \n     cmd=sanitized_cmd)      \n\nEnvironment\n===========\n\n* Multinode devstack on VMs running Ubuntu 16.04\n* Networking: Neutron with OVS\n* Cinder backend - LVM", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1645767", 
    "owner": "None", 
    "id": 1645767, 
    "index": 7828, 
    "openned": "2016-11-29 15:46:34.269538+00:00", 
    "created": "2016-11-29 15:46:34.269538+00:00", 
    "title": "nova evacuate fails when encrypted volume is connected to instance", 
    "comments": [
        {
            "content": "Description\n===========\nIf instance has encrypted volume connected to it and mounted during the host failure, 'nova evacuate' would result in instance entering the error state.\n\nSteps to reproduce\n==================\n1. Boot a VM\na) nova boot --image 2c60a713-bbba-4696-adff-c80a12cab7d8 --flavor 42 --nic net-id=eb6c7f6b-100f-41bb-9c5d-11975a2cdba6 --availability-zone nova:compute1 test\nb) nova floating-ip-associate test 192.168.57.50\n\n2. Create an encrypted volume\na) cinder type-create LUKS\nb) cinder encryption-type-create --cipher aes-xts-plain64 --key_size 512 \\                 \n  --control_location front-end LUKS nova.volume.encryptors.luks.LuksEncryptor\nc) openstack volume create --size 1 --type 58931c06-1431-45cf-9b4c-4e998594447d test-volume\n\n3. Attach the volume to instance\na) openstack server add volume test d06b7b7c-641d-4086-a3b1-4eee898b5c2a\n\n4. SSH to instance, create file system on volume and mount it\na) ssh cirros@192.168.57.50\nb) sudo mkfs.ext3 /dev/vdb\nc) sudo mount /dev/vdb /mnt\nd) sudo touch /mtn/test\n\n5. Kill the compute node (In my case it was powering of the compute1)\n\n6. Try to evacuate instance using `nova evacuate`\n\nExpected result\n===============\nInstance rebuilded on another host, with volume attached to it.\n\nActual result\n=============\nInstance entered the error state. Output from `nova show test`:\n\nUnexpected error while running command.           \nCommand: sudo nova-rootwrap /etc/nova/rootwrap.conf cryptsetup luksOpen --key-file=- /dev/sdc crypt-ip-192.168.57.2:3260-iscsi-iqn.2010-10.org.openstack:volume-d06b7b7c-641d-4086-a3b1-4eee898b5c2a-lun-1 \n Exit code: 2\", \"code\": 500, \"details\": \"  File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 204, in decorated_function                                        \n     return function(self, context, *args, **kwargs)                                        \n   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2703, in rebuild_instance                                        \n     bdms, recreate, on_shared_storage, preserve_ephemeral)                                        \n   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2747, in _do_rebuild_instance_with_claim                                        \n     self._do_rebuild_instance(*args, **kwargs)                                        \n   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2862, in _do_rebuild_instance                                        \n     self._rebuild_default_impl(**kwargs)                                        \n   File \\\"/opt/stack/nova/nova/compute/manager.py\\\", line 2626, in _rebuild_default_impl                                        \n     block_device_info=new_block_device_info)                                        \n   File \\\"/opt/stack/nova/nova/virt/libvirt/driver.py\\\", line 2622, in spawn                                        \n     post_xml_callback=gen_confdrive)                                        \n   File \\\"/opt/stack/nova/nova/virt/libvirt/driver.py\\\", line 4845, in _create_domain_and_network                                        \n     encryptor.attach_volume(context, **encryption)                                        \n   File \\\"/opt/stack/nova/nova/volume/encryptors/luks.py\\\", line 102, in attach_volume                                        \n     self._open_volume(passphrase, **kwargs)                                        \n   File \\\"/opt/stack/nova/nova/volume/encryptors/luks.py\\\", line 86, in _open_volume                                        \n     run_as_root=True, check_exit_code=True)                                        \n   File \\\"/opt/stack/nova/nova/utils.py\\\", line 295, in execute                                        \n     return RootwrapProcessHelper().execute(*cmd, **kwargs)                                        \n   File \\\"/opt/stack/nova/nova/utils.py\\\", line 178, in execute                                        \n     return processutils.execute(*cmd, **kwargs)                                        \n   File \\\"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/processutils.py\\\", line 394, in execute                                        \n     cmd=sanitized_cmd)      \n\nEnvironment\n===========\n\n* Multinode devstack on VMs running Ubuntu 16.04\n* Networking: Neutron with OVS\n* Cinder backend - LVM", 
            "date_created": "2016-11-29 15:46:34.269538+00:00", 
            "author": "https://api.launchpad.net/1.0/~dawid-deja-0"
        }, 
        {
            "content": "Which version of Nova is this and what key manager is being used?\n\nI ask as the trace doesn't appear to line up with master where the following recently landed :\n\nencryptors: Workaround mangled passphrases\nhttps://review.openstack.org/#/c/386670/\n\nThe error code of 2 is suggesting that the passphrase is bad so I wouldn't be surprised if the above has something to do with this.", 
            "date_created": "2016-11-30 22:21:07.690048+00:00", 
            "author": "https://api.launchpad.net/1.0/~lyarwood"
        }, 
        {
            "content": "Lee,\n\nMy version of Nova is master branch from 9 November and your patch was merge the day after. I'll try with the newest code and come back to this bug report if I'll be still unavailable to evacuate instances with connected volumes.", 
            "date_created": "2016-12-01 09:27:19.510390+00:00", 
            "author": "https://api.launchpad.net/1.0/~dawid-deja-0"
        }, 
        {
            "content": "If it was from the 9th then there may be another issue here.\n\nIf you are able to reproduce can you attach your n-cpu.log and document your fixed_key (assuming that's the key manager your using) here also?", 
            "date_created": "2016-12-01 14:09:04.477666+00:00", 
            "author": "https://api.launchpad.net/1.0/~lyarwood"
        }, 
        {
            "content": "It took me a while, but I checked with the new version of nova on new devstack env and it looks like it is working. Also, I'm not sure if the fixed_key was matching in a first place, but I can't check now.\n\nAll in all, it is working and a bug can be closed.", 
            "date_created": "2016-12-19 13:37:42.500473+00:00", 
            "author": "https://api.launchpad.net/1.0/~dawid-deja-0"
        }
    ], 
    "closed": "2016-12-19 13:38:07.963116+00:00"
}