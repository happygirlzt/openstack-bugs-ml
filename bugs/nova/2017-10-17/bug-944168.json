{
    "status": "Fix Released", 
    "last_updated": "2012-04-05 11:07:07.345214+00:00", 
    "description": "When I try reboot a VM, the nova-compute fails and the daemon stop.\nIt fails on unpluging VIF interface of the rebooted VM. I use Nova\nwith Quantum and OVS.\n\n2012-03-01 18:12:31 DEBUG nova.rpc.common [-] Making asynchronous call\non network ... from (pid=21485) multicall\n/usr/local/src/nova/nova/rpc/amqp.py:318\n2012-03-01 18:12:31 DEBUG nova.rpc.common [-] MSG_ID is\nb77f0f284af045f396b90fddd16f724e from (pid=21485) multicall\n/usr/local/src/nova/nova/rpc/amqp.py:321\n2012-03-01 18:12:33 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap ovs-vsctl del-port br-int tap9f5ef54c-38 from\n(pid=21485) execute /usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:33 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap ip link delete tap9f5ef54c-38 from (pid=21485)\nexecute /usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:34 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap ovs-vsctl del-port br-int tap285c8465-dd from\n(pid=21485) execute /usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:34 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap ip link delete tap285c8465-dd from (pid=21485)\nexecute /usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:34 DEBUG nova.utils [-] Attempting to grab semaphore\n\"iptables\" for method \"apply\"... from (pid=21485) inner\n/usr/local/src/nova/nova/utils.py:824\n2012-03-01 18:12:34 DEBUG nova.utils [-] Got semaphore \"iptables\" for\nmethod \"apply\"... from (pid=21485) inner\n/usr/local/src/nova/nova/utils.py:828\n2012-03-01 18:12:34 DEBUG nova.utils [-] Attempting to grab file lock\n\"iptables\" for method \"apply\"... from (pid=21485) inner\n/usr/local/src/nova/nova/utils.py:832\n2012-03-01 18:12:34 DEBUG nova.utils [-] Got file lock \"iptables\" for\nmethod \"apply\"... from (pid=21485) inner\n/usr/local/src/nova/nova/utils.py:839\n2012-03-01 18:12:34 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap iptables-save -t filter from (pid=21485) execute\n/usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:35 INFO nova.virt.libvirt.connection [-] [instance:\n9300df8d-1a47-40ce-b90e-28f1a84f064d] Instance destroyed successfully.\n2012-03-01 18:12:35 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap iptables-restore from (pid=21485) execute\n/usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:35 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap iptables-save -t nat from (pid=21485) execute\n/usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:35 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap iptables-restore from (pid=21485) execute\n/usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:35 DEBUG nova.network.linux_net [-]\nIPTablesManager.apply completed with success from (pid=21485) apply\n/usr/local/src/nova/nova/network/linux_net.py:336\n2012-03-01 18:12:37 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap ovs-vsctl del-port br-int tap9f5ef54c-38 from\n(pid=21485) execute /usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:37 DEBUG nova.utils [-] Result was 1 from (pid=21485)\nexecute /usr/local/src/nova/nova/utils.py:224\n2012-03-01 18:12:37 WARNING nova.virt.libvirt.vif [-] Failed while\nunplugging vif of instance 'instance-00000002'", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/944168", 
    "owner": "https://api.launchpad.net/1.0/~danwent", 
    "id": 944168, 
    "index": 3904, 
    "openned": "2012-03-01 17:36:50.586112+00:00", 
    "created": "2012-03-01 17:36:50.586112+00:00", 
    "title": "VIFs unplugged twice during VM restart?", 
    "comments": [
        {
            "content": "When I try reboot a VM, the nova-compute fails and the daemon stop.\nIt fails on unpluging VIF interface of the rebooted VM. I use Nova\nwith Quantum and OVS.\n\n2012-03-01 18:12:31 DEBUG nova.rpc.common [-] Making asynchronous call\non network ... from (pid=21485) multicall\n/usr/local/src/nova/nova/rpc/amqp.py:318\n2012-03-01 18:12:31 DEBUG nova.rpc.common [-] MSG_ID is\nb77f0f284af045f396b90fddd16f724e from (pid=21485) multicall\n/usr/local/src/nova/nova/rpc/amqp.py:321\n2012-03-01 18:12:33 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap ovs-vsctl del-port br-int tap9f5ef54c-38 from\n(pid=21485) execute /usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:33 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap ip link delete tap9f5ef54c-38 from (pid=21485)\nexecute /usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:34 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap ovs-vsctl del-port br-int tap285c8465-dd from\n(pid=21485) execute /usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:34 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap ip link delete tap285c8465-dd from (pid=21485)\nexecute /usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:34 DEBUG nova.utils [-] Attempting to grab semaphore\n\"iptables\" for method \"apply\"... from (pid=21485) inner\n/usr/local/src/nova/nova/utils.py:824\n2012-03-01 18:12:34 DEBUG nova.utils [-] Got semaphore \"iptables\" for\nmethod \"apply\"... from (pid=21485) inner\n/usr/local/src/nova/nova/utils.py:828\n2012-03-01 18:12:34 DEBUG nova.utils [-] Attempting to grab file lock\n\"iptables\" for method \"apply\"... from (pid=21485) inner\n/usr/local/src/nova/nova/utils.py:832\n2012-03-01 18:12:34 DEBUG nova.utils [-] Got file lock \"iptables\" for\nmethod \"apply\"... from (pid=21485) inner\n/usr/local/src/nova/nova/utils.py:839\n2012-03-01 18:12:34 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap iptables-save -t filter from (pid=21485) execute\n/usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:35 INFO nova.virt.libvirt.connection [-] [instance:\n9300df8d-1a47-40ce-b90e-28f1a84f064d] Instance destroyed successfully.\n2012-03-01 18:12:35 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap iptables-restore from (pid=21485) execute\n/usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:35 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap iptables-save -t nat from (pid=21485) execute\n/usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:35 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap iptables-restore from (pid=21485) execute\n/usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:35 DEBUG nova.network.linux_net [-]\nIPTablesManager.apply completed with success from (pid=21485) apply\n/usr/local/src/nova/nova/network/linux_net.py:336\n2012-03-01 18:12:37 DEBUG nova.utils [-] Running cmd (subprocess):\nsudo nova-rootwrap ovs-vsctl del-port br-int tap9f5ef54c-38 from\n(pid=21485) execute /usr/local/src/nova/nova/utils.py:208\n2012-03-01 18:12:37 DEBUG nova.utils [-] Result was 1 from (pid=21485)\nexecute /usr/local/src/nova/nova/utils.py:224\n2012-03-01 18:12:37 WARNING nova.virt.libvirt.vif [-] Failed while\nunplugging vif of instance 'instance-00000002'", 
            "date_created": "2012-03-01 17:36:50.586112+00:00", 
            "author": "https://api.launchpad.net/1.0/~danwent"
        }, 
        {
            "content": "At a glance, it seems that unplug() being called twice, with the second call failing because the first call successfully unplugged the vif already.  \n\nThe unplug() action on the bridge does nothing, so there's no harm in calling it twice, which may explain why this is only seen with OVS.  \n\nA quick workaround would be to remove the \"raise\" line at the end of the unplug() method for LibvirtOpenVswitchDriver, in which case you will see the log message still, but it should not disrupt the reboot (this is probably better behavior as well, regardless of the true cause of the bug).  \n", 
            "date_created": "2012-03-01 17:41:53.682452+00:00", 
            "author": "https://api.launchpad.net/1.0/~danwent"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/4754", 
            "date_created": "2012-03-01 17:50:34.355329+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/4754\nCommitted: http://github.com/openstack/nova/commit/04e57f169646dff5309177ce5dfa444f668bf8a1\nSubmitter: Jenkins\nBranch:    master\n\ncommit 04e57f169646dff5309177ce5dfa444f668bf8a1\nAuthor: Dan Wendlandt <email address hidden>\nDate:   Thu Mar 1 11:52:33 2012 -0800\n\n    libvirt driver calls unplug() twice on vm reboot.\n    \n    bug 944168\n    \n    Also prevents OVS vif plugging driver from raising an exception\n    if deleting the OVS port fails.  We already log an error and\n    print the exception, and there's\n    no reason that failing to delete the OVS port should cause the whole operation\n    to fail.\n    \n    Change-Id: I01c22ab8627762831a106b407f758f6592363f33\n", 
            "date_created": "2012-03-01 20:41:52.631830+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2012-03-20 08:48:56.338034+00:00"
}