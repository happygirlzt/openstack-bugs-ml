{
    "status": "Invalid", 
    "last_updated": "2017-08-25 21:25:13.673955+00:00", 
    "description": "For more than a year, i have deployed  multiple clusters using openstack-ansible.\nThis particular case is using FQDN for the internal and external endpoint.\n\n[DEFAULT]\n...\n\n# Metadata\nmetadata_host = my-int.XXX.com\nmetadata_port = 8775\nmetadata_workers = 3\n...\n\nRecently, this breaks nova-metadata.\n\n2017-08-25 21:19:02.928 18130 WARNING oslo_reports.guru_meditation_report [-] Guru meditation now registers SIGUSR1 and SIGUSR2 by default for backward compatibility. SIGUSR1 will no longer be registered in a future release, so please use SIGUSR2 to generate reports.\n2017-08-25 21:19:02.931 18130 INFO nova.network.driver [-] Loading network driver 'nova.network.linux_net'\n2017-08-25 21:19:03.078 18130 CRITICAL nova [-] AddrFormatError: failed to detect a valid IP address from 'my-int.XXX.com'\n2017-08-25 21:19:03.078 18130 ERROR nova Traceback (most recent call last):\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/bin/nova-api-metadata\", line 11, in <module>\n2017-08-25 21:19:03.078 18130 ERROR nova     sys.exit(main())\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/cmd/api_metadata.py\", line 48, in main\n2017-08-25 21:19:03.078 18130 ERROR nova     server = service.WSGIService('metadata', use_ssl=should_use_ssl)\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/service.py\", line 309, in __init__\n2017-08-25 21:19:03.078 18130 ERROR nova     self.manager = self._get_manager()\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/service.py\", line 364, in _get_manager\n2017-08-25 21:19:03.078 18130 ERROR nova     return manager_class()\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/api/manager.py\", line 30, in __init__\n2017-08-25 21:19:03.078 18130 ERROR nova     self.network_driver.metadata_accept()\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/network/linux_net.py\", line 599, in metadata_accept\n2017-08-25 21:19:03.078 18130 ERROR nova     (CONF.metadata_port, _iptables_dest(CONF.metadata_host)))\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/network/linux_net.py\", line 588, in _iptables_dest\n2017-08-25 21:19:03.078 18130 ERROR nova     if ((netaddr.IPAddress(ip).version == 4 and ip == '127.0.0.1')\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/netaddr/ip/__init__.py\", line 306, in __init__\n2017-08-25 21:19:03.078 18130 ERROR nova     'address from %r' % addr)\n2017-08-25 21:19:03.078 18130 ERROR nova AddrFormatError: failed to detect a valid IP address from 'my-int.XXX.com'\n2017-08-25 21:19:03.078 18130 ERROR nova\n2017-08-25 21:19:09.833 18137 WARNING oslo_reports.guru_meditation_report [-] Guru meditation now registers SIGUSR1 and SIGUSR2 by default for backward compatibility. SIGUSR1 will no longer be registered in a future release, so please use SIGUSR2 to generate reports.\n2017-08-25 21:19:09.836 18137 INFO nova.network.driver [-] Loading network driver 'nova.network.linux_net'\n2017-08-25 21:19:10.040 18137 CRITICAL nova [-] AddrFormatError: failed to detect a valid IP address from 'my-int.XXX.com'\n2017-08-25 21:19:10.040 18137 ERROR nova Traceback (most recent call last):\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/bin/nova-api-metadata\", line 11, in <module>\n2017-08-25 21:19:10.040 18137 ERROR nova     sys.exit(main())\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/cmd/api_metadata.py\", line 48, in main\n2017-08-25 21:19:10.040 18137 ERROR nova     server = service.WSGIService('metadata', use_ssl=should_use_ssl)\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/service.py\", line 309, in __init__\n2017-08-25 21:19:10.040 18137 ERROR nova     self.manager = self._get_manager()\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/service.py\", line 364, in _get_manager\n2017-08-25 21:19:10.040 18137 ERROR nova     return manager_class()\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/api/manager.py\", line 30, in __init__\n2017-08-25 21:19:10.040 18137 ERROR nova     self.network_driver.metadata_accept()\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/network/linux_net.py\", line 599, in metadata_accept\n2017-08-25 21:19:10.040 18137 ERROR nova     (CONF.metadata_port, _iptables_dest(CONF.metadata_host)))\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/network/linux_net.py\", line 588, in _iptables_dest\n2017-08-25 21:19:10.040 18137 ERROR nova     if ((netaddr.IPAddress(ip).version == 4 and ip == '127.0.0.1')\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/netaddr/ip/__init__.py\", line 306, in __init__\n2017-08-25 21:19:10.040 18137 ERROR nova     'address from %r' % addr)\n2017-08-25 21:19:10.040 18137 ERROR nova AddrFormatError: failed to detect a valid IP address from 'my-int.XXX.com'\n2017-08-25 21:19:10.040 18137 ERROR nova\n\nChanging hostname to IP address fixes it.\n\n# Metadata\nmetadata_host = 172.16.236.2\nmetadata_port = 8775\nmetadata_workers = 3\n...\n\nIs this a bug? or a new change? or should we now should not use FQDN in host ?\n\nThanks,\nShashi", 
    "tags": [
        "metadata"
    ], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1713144", 
    "owner": "None", 
    "id": 1713144, 
    "index": 8270, 
    "openned": "2017-08-25 20:31:20.428058+00:00", 
    "created": "2017-08-25 20:31:20.428058+00:00", 
    "title": "nova metadata service breaks on hostname", 
    "comments": [
        {
            "content": "For more than a year, i have deployed  multiple clusters using openstack-ansible. \nThis particular case is using FQDN for the internal and external endpoint.\n\n[DEFAULT]\n...\n\n# Metadata\nmetadata_host = my-int.XXX.com\nmetadata_port = 8775\nmetadata_workers = 3\n...\n\n\nRecently, this breaks nova-console. \n\n2017-08-25 21:19:02.928 18130 WARNING oslo_reports.guru_meditation_report [-] Guru meditation now registers SIGUSR1 and SIGUSR2 by default for backward compatibility. SIGUSR1 will no longer be registered in a future release, so please use SIGUSR2 to generate reports.\n2017-08-25 21:19:02.931 18130 INFO nova.network.driver [-] Loading network driver 'nova.network.linux_net'\n2017-08-25 21:19:03.078 18130 CRITICAL nova [-] AddrFormatError: failed to detect a valid IP address from 'my-int.XXX.com'\n2017-08-25 21:19:03.078 18130 ERROR nova Traceback (most recent call last):\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/bin/nova-api-metadata\", line 11, in <module>\n2017-08-25 21:19:03.078 18130 ERROR nova     sys.exit(main())\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/cmd/api_metadata.py\", line 48, in main\n2017-08-25 21:19:03.078 18130 ERROR nova     server = service.WSGIService('metadata', use_ssl=should_use_ssl)\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/service.py\", line 309, in __init__\n2017-08-25 21:19:03.078 18130 ERROR nova     self.manager = self._get_manager()\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/service.py\", line 364, in _get_manager\n2017-08-25 21:19:03.078 18130 ERROR nova     return manager_class()\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/api/manager.py\", line 30, in __init__\n2017-08-25 21:19:03.078 18130 ERROR nova     self.network_driver.metadata_accept()\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/network/linux_net.py\", line 599, in metadata_accept\n2017-08-25 21:19:03.078 18130 ERROR nova     (CONF.metadata_port, _iptables_dest(CONF.metadata_host)))\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/network/linux_net.py\", line 588, in _iptables_dest\n2017-08-25 21:19:03.078 18130 ERROR nova     if ((netaddr.IPAddress(ip).version == 4 and ip == '127.0.0.1')\n2017-08-25 21:19:03.078 18130 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/netaddr/ip/__init__.py\", line 306, in __init__\n2017-08-25 21:19:03.078 18130 ERROR nova     'address from %r' % addr)\n2017-08-25 21:19:03.078 18130 ERROR nova AddrFormatError: failed to detect a valid IP address from 'my-int.XXX.com'\n2017-08-25 21:19:03.078 18130 ERROR nova\n2017-08-25 21:19:09.833 18137 WARNING oslo_reports.guru_meditation_report [-] Guru meditation now registers SIGUSR1 and SIGUSR2 by default for backward compatibility. SIGUSR1 will no longer be registered in a future release, so please use SIGUSR2 to generate reports.\n2017-08-25 21:19:09.836 18137 INFO nova.network.driver [-] Loading network driver 'nova.network.linux_net'\n2017-08-25 21:19:10.040 18137 CRITICAL nova [-] AddrFormatError: failed to detect a valid IP address from 'my-int.XXX.com'\n2017-08-25 21:19:10.040 18137 ERROR nova Traceback (most recent call last):\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/bin/nova-api-metadata\", line 11, in <module>\n2017-08-25 21:19:10.040 18137 ERROR nova     sys.exit(main())\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/cmd/api_metadata.py\", line 48, in main\n2017-08-25 21:19:10.040 18137 ERROR nova     server = service.WSGIService('metadata', use_ssl=should_use_ssl)\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/service.py\", line 309, in __init__\n2017-08-25 21:19:10.040 18137 ERROR nova     self.manager = self._get_manager()\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/service.py\", line 364, in _get_manager\n2017-08-25 21:19:10.040 18137 ERROR nova     return manager_class()\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/api/manager.py\", line 30, in __init__\n2017-08-25 21:19:10.040 18137 ERROR nova     self.network_driver.metadata_accept()\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/network/linux_net.py\", line 599, in metadata_accept\n2017-08-25 21:19:10.040 18137 ERROR nova     (CONF.metadata_port, _iptables_dest(CONF.metadata_host)))\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/nova/network/linux_net.py\", line 588, in _iptables_dest\n2017-08-25 21:19:10.040 18137 ERROR nova     if ((netaddr.IPAddress(ip).version == 4 and ip == '127.0.0.1')\n2017-08-25 21:19:10.040 18137 ERROR nova   File \"/openstack/venvs/nova-15.1.8/lib/python2.7/site-packages/netaddr/ip/__init__.py\", line 306, in __init__\n2017-08-25 21:19:10.040 18137 ERROR nova     'address from %r' % addr)\n2017-08-25 21:19:10.040 18137 ERROR nova AddrFormatError: failed to detect a valid IP address from 'my-int.XXX.com'\n2017-08-25 21:19:10.040 18137 ERROR nova \n\n\n\nChanging hostname to IP address fixes it. \n\n# Metadata\nmetadata_host = 172.16.236.2 \nmetadata_port = 8775\nmetadata_workers = 3\n...\n\n\nIs this a bug? or a new change? or should we now should not use FQDN in host ? \n\n\n\nThanks,\nShashi", 
            "date_created": "2017-08-25 20:31:20.428058+00:00", 
            "author": "https://api.launchpad.net/1.0/~shashi-eu"
        }, 
        {
            "content": "Which release were you using when this worked, and which release did you upgrade to where it no longer works?", 
            "date_created": "2017-08-25 20:35:34.101734+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Are you using nova-network or neutron?", 
            "date_created": "2017-08-25 20:36:39.548094+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "nova 15.1.8\ndeployed via openstack-ansible stable/ocata ", 
            "date_created": "2017-08-25 20:36:40.339917+00:00", 
            "author": "https://api.launchpad.net/1.0/~shashi-eu"
        }, 
        {
            "content": "Looks like this code hasn't changed in a long time:\n\nnetaddr.IPAddress(ip)\n\nSo it's probably a change in the netaddr library. Compare the versions where it works and where it doesn't and check the change log / release notes for netaddr between those versions.", 
            "date_created": "2017-08-25 20:41:20.569786+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Looks like netaddr.IPAddress has always expected this to be a IP rather than a FQDN:\n\nhttps://github.com/drkjam/netaddr/blob/netaddr-0.7.19/netaddr/ip/__init__.py#L244\n\nI'm not sure how it was working before.", 
            "date_created": "2017-08-25 20:46:42.569918+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Also, metadata_host by default is CONF.my_ip, which is an IP address, not a hostname. These options should both be IPOpts instead of StrOpts probably, but metadata_host is deprecated since 16.0.0 (pike) so we probably won't bother changing the type on that one now.", 
            "date_created": "2017-08-25 20:49:13.831577+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/498095", 
            "date_created": "2017-08-25 21:25:13.129814+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-08-25 20:46:51.299593+00:00"
}