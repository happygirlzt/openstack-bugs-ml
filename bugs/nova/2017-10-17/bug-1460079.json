{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:51:33.566961+00:00", 
    "description": "When an instance is first created, a copy of the metadata from the image/volume is saved into the instance system metadata. This provides an accurate point in time record of the metadata used to configure & operate instance, even if the metadata on the image is later changed.\n\nFor a long while though, much of the code would not use this instance system metadata, instead just fetching metadata from the image each time. This had an obvious problem in that if the image was deleted, those operations would not be able to get image metadata, even though it was recorded for posterity in the system metadata.\n\nSo 2 commits were made to update Nova to fetch system metadata\n\ncommit 8e575be75c80ea71a6ad8fb73e6ace1ed708938f\nAuthor: Xavier Queralt <email address hidden>\nDate: Mon Aug 26 22:53:03 2013 +0200\n\n    Add methods to get image metadata from instance\n\n    This patch adds a couple of utility functions that enclose all the logic\n    for getting and parsing the image metadata stored in the instance's\n    system metadata.\n\n    First, this will try to fetch the metadata from the real image and will\n    prevent it from failing if it is not available. It will be then merged\n    with the image metadata stored during the instance creation.\n\n    Related to bug #1039662\n\n    Change-Id: I2130caf19858585571b1199e27f0a98ad5f08701\n\ncommit 4389f2292a0177c8eedc0a398ceb3c5535a9ef82\nAuthor: Xavier Queralt <email address hidden>\nDate: Mon Aug 26 22:55:46 2013 +0200\n\n    Avoid errors on some actions when image not usable\n\n    Using the metadata saved on instance creation, we can now get all the\n    image related metadata we need from the instance itself.\n\n    This patch replace the logic for getting the image metadata on some\n    actions that shouldn't fail when the image is not accessible (create\n    an snapshot, resize, migrate, rescue an instance or attach an\n    interface).\n\n    Fixes bug 1039662\n\n\nUnfortunately the way the compute utils get_image_metadata method was designed, it first fetches the instance system metadata and then fetches the current metadata from the image (if it still exists). The system metadata fields are overwritten by those from the image.\n\nSo, there remains a problem that many operations are going to be performing actions based on the metadata currently associated with the image, and not that associated with the instance.\n\nBy good luck, this does not currently have too many serious ill effects, but with ever increasing use of image metadata for tuning instance hardware configuration this is becoming a more pressing problem.\n\nFor example, if the hw_disk_bus=virtio when the instance was first booted, and then the image was later changed to use hw_disk_bus=scsi, then logic which hotplugs disks may mistakenly end up attempting to hotplug a SCSI disk instead of a virtio disk which the instance was initially booted with.\n\nThe only code which should look at the image properties should be the initial boot operation. There after all code should be using the recorded instance system metadata, so it is making decisions that are consistent with those made when the instance was first booted.\n\nThere is an exception for the rescue operation, which by its very nature should be using the metadata from the rescue image, not the original instance system meta, since the hardware configuration needs to match that of the rescue image requirements.", 
    "tags": [
        "compute"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1460079", 
    "owner": "https://api.launchpad.net/1.0/~berrange", 
    "id": 1460079, 
    "index": 4259, 
    "openned": "2015-05-29 13:47:47.361284+00:00", 
    "created": "2015-05-29 13:47:47.361284+00:00", 
    "title": "Instance system metadata is sometimes overwritten by image metadata", 
    "comments": [
        {
            "content": "When an instance is first created, a copy of the metadata from the image/volume is saved into the instance system metadata. This provides an accurate point in time record of the metadata used to configure & operate instance, even if the metadata on the image is later changed.\n\nFor a long while though, much of the code would not use this instance system metadata, instead just fetching metadata from the image each time. This had an obvious problem in that if the image was deleted, those operations would not be able to get image metadata, even though it was recorded for posterity in the system metadata.\n\nSo 2 commits were made to update Nova to fetch system metadata\n\ncommit 8e575be75c80ea71a6ad8fb73e6ace1ed708938f\nAuthor: Xavier Queralt <email address hidden>\nDate: Mon Aug 26 22:53:03 2013 +0200\n\n    Add methods to get image metadata from instance\n\n    This patch adds a couple of utility functions that enclose all the logic\n    for getting and parsing the image metadata stored in the instance's\n    system metadata.\n\n    First, this will try to fetch the metadata from the real image and will\n    prevent it from failing if it is not available. It will be then merged\n    with the image metadata stored during the instance creation.\n\n    Related to bug #1039662\n\n    Change-Id: I2130caf19858585571b1199e27f0a98ad5f08701\n\ncommit 4389f2292a0177c8eedc0a398ceb3c5535a9ef82\nAuthor: Xavier Queralt <email address hidden>\nDate: Mon Aug 26 22:55:46 2013 +0200\n\n    Avoid errors on some actions when image not usable\n\n    Using the metadata saved on instance creation, we can now get all the\n    image related metadata we need from the instance itself.\n\n    This patch replace the logic for getting the image metadata on some\n    actions that shouldn't fail when the image is not accessible (create\n    an snapshot, resize, migrate, rescue an instance or attach an\n    interface).\n\n    Fixes bug 1039662\n\n\nUnfortunately the way the compute utils get_image_metadata method was designed, it first fetches the instance system metadata and then fetches the current metadata from the image (if it still exists). The system metadata fields are overwritten by those from the image.\n\nSo, there remains a problem that many operations are going to be performing actions based on the metadata currently associated with the image, and not that associated with the instance.\n\nBy good luck, this does not currently have too many serious ill effects, but with ever increasing use of image metadata for tuning instance hardware configuration this is becoming a more pressing problem.\n\nFor example, if the hw_disk_bus=virtio when the instance was first booted, and then the image was later changed to use hw_disk_bus=scsi, then logic which hotplugs disks may mistakenly end up attempting to hotplug a SCSI disk instead of a virtio disk which the instance was initially booted with.\n\nThe only code which should look at the image properties should be the initial boot operation. There after all code should be using the recorded instance system metadata, so it is making decisions that are consistent with those made when the instance was first booted.\n\nThere is an exception for the rescue operation, which by its very nature should be using the metadata from the rescue image, not the original instance system meta, since the hardware configuration needs to match that of the rescue image requirements.", 
            "date_created": "2015-05-29 13:47:47.361284+00:00", 
            "author": "https://api.launchpad.net/1.0/~berrange"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/187251", 
            "date_created": "2015-06-01 16:38:08.763707+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/187251\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=77ecc3d8c5853f5498bc6ed2d22d6ff0dd75a075\nSubmitter: Jenkins\nBranch:    master\n\ncommit 77ecc3d8c5853f5498bc6ed2d22d6ff0dd75a075\nAuthor: Daniel P. Berrange <email address hidden>\nDate:   Mon Jun 1 16:18:30 2015 +0100\n\n    compute: remove get_image_metadata method\n    \n    The get_image_metadata method has some unhelpful semantics\n    where it takes the image metadata from the instance's\n    system metadata record, and then overwrites it with the\n    current metadata associated with the original image.\n    \n    The result is that, if the image metadata in glance was\n    changed after the instance was first booted, Nova will\n    end up making decisions based on image metadata that does\n    not correspond to that which the instance was booted with.\n    Since the image metadata controls many aspects of hardware\n    configuration, this could lead to incorrect behaviour when\n    modifying hardware later, eg disk/vif/pci hotplug.\n    \n    What is worse, is that some of the nova operations will\n    update the instance system metadata when completed, thus\n    permanently overwriting the original image metadata with\n    the new data.\n    \n    Almost all code which operates against an existing instance\n    is updated to use nova.utils.get_image_from_system_metadata.\n    The exception is the rescue codepath, which must use the\n    metadata associated with the new rescue image.\n    \n    The nova.compute.utils.get_image_metadata method can thus\n    be removed from use, avoiding the problematic logic.\n    \n    Closes-bug: #1460079\n    Change-Id: I35c9d26e3967e93a2c368c3f9fdc807a69816dd2\n", 
            "date_created": "2015-06-09 20:08:37.084603+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-06-24 12:19:06.032945+00:00"
}