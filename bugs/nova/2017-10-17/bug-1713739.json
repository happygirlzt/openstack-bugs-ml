{
    "status": "Confirmed", 
    "last_updated": "2017-08-31 14:12:01.549395+00:00", 
    "description": "VM resize and confirm on the same host fails with custom resources, as the old resources are not deallocated after 'confirmResize'.\nSteps to reproduce:\n- boot a VM with old_flavor\n- resize to new_flavor to the same host\n- send confirmResize\n- check usages and compare with new_flavor, and there will be double allocations (old_flavor + new_flavor)\n\nRelated Nova log:\n2017-08-29 16:22:22,666 INFO [nova.api.openstack.placement.requestlog] 127.0.0.1 \"GET /placement/allocations/8d989deb-860e-4ade-a581-a01b819b6297\" status: 200 len: 326 microversion: 1.0\n    2017-08-29 16:22:22,666 DEBUG [nova.scheduler.client.report] Current allocations for instance: {u'5f7fdb12-9866-4534-b0ce-ba60b14f37cb': {u'resources': {u'CUSTOM_MAGIC': 256}, u'generation': 4}, u'\n60b3f076-ebd9-499e-a9d0-83013320505c': {u'resources': {u'MEMORY_MB': 3072, u'DISK_GB': 60, u'VCPU': 2}, u'generation': 3}, u'c522247d-e8ee-4f6c-848d-367eb99885d6': {u'resources': {u'CUSTOM_MAGIC': 256}\n, u'generation': 4}}\n    2017-08-29 16:22:22,666 DEBUG [nova.scheduler.client.report] Instance 8d989deb-860e-4ade-a581-a01b819b6297 has resources on 1 compute nodes\n    2017-08-29 16:22:22,666 DEBUG [nova.scheduler.client.report] Original resources from same-host allocation: {u'MEMORY_MB': 3072, u'DISK_GB': 60, u'VCPU': 2}\n    2017-08-29 16:22:22,667 DEBUG [nova.scheduler.client.report] Subtracting old resources from same-host allocation: {u'MEMORY_MB': 1024, u'DISK_GB': 40, u'VCPU': 1, u'CUSTOM_MAGIC': -256}\n    2017-08-29 16:22:22,667 DEBUG [nova.scheduler.client.report] Sending updated allocation [{'resource_provider': {'uuid': u'5f7fdb12-9866-4534-b0ce-ba60b14f37cb'}, 'resources': {u'CUSTOM_MAGIC': 256}\n}, {'resource_provider': {'uuid': u'c522247d-e8ee-4f6c-848d-367eb99885d6'}, 'resources': {u'CUSTOM_MAGIC': 256}}, {'resource_provider': {'uuid': '60b3f076-ebd9-499e-a9d0-83013320505c'}, 'resources': {u\n'MEMORY_MB': 1024, u'DISK_GB': 40, u'VCPU': 1, u'CUSTOM_MAGIC': -256}}] for instance 8d989deb-860e-4ade-a581-a01b819b6297 after removing resources for 60b3f076-ebd9-499e-a9d0-83013320505c.\n    2017-08-29 16:22:22,667 DEBUG [nova.api.openstack.placement.requestlog] Starting request: 127.0.0.1 \"PUT /placement/allocations/8d989deb-860e-4ade-a581-a01b819b6297\"\n    2017-08-29 16:22:22,670 DEBUG [nova.api.openstack.placement.wsgi_wrapper] Placement API returning an error response: JSON does not validate: -256 is less than the minimum of 1\n    \n    Failed validating 'minimum' in schema['properties']['allocations']['items']['properties']['resources']['patternProperties']['^[0-9A-Z_]+$']:\n        {'minimum': 1, 'type': 'integer'}\n    \n    On instance['allocations'][2]['resources'][u'CUSTOM_MAGIC']:\n        -256\n    2017-08-29 16:22:22,671 INFO [nova.api.openstack.placement.requestlog] 127.0.0.1 \"PUT /placement/allocations/8d989deb-860e-4ade-a581-a01b819b6297\" status: 400 len: 532 microversion: 1.10\n    2017-08-29 16:22:22,671 WARNING [nova.scheduler.client.report] Failed to save allocation for 8d989deb-860e-4ade-a581-a01b819b6297. Got HTTP 400: <html>\n     <head>\n      <title>400 Bad Request</title>\n     </head>\n     <body>\n      <h1>400 Bad Request</h1>\n      The server could not comply with the request since it is either malformed or otherwise incorrect.<br /><br />\n    JSON does not validate: -256 is less than the minimum of 1\n    \n    Failed validating 'minimum' in schema['properties']['allocations']['items']['properties']['resources']['patternProperties']['^[0-9A-Z_]+$']:\n        {'minimum': 1, 'type': 'integer'}\n    \n    On instance['allocations'][2]['resources'][u'CUSTOM_MAGIC']:\n        -256\n    \n     </body>\n    </html>", 
    "tags": [
        "custom-resource-class", 
        "placement", 
        "resize", 
        "resource-tracker", 
        "scheduler"
    ], 
    "importance": "High", 
    "heat": 12, 
    "link": "https://bugs.launchpad.net/nova/+bug/1713739", 
    "owner": "None", 
    "id": 1713739, 
    "index": 2137, 
    "openned": "2017-08-29 14:29:41.105011+00:00", 
    "created": "2017-08-29 14:29:41.105011+00:00", 
    "title": "VM resize and confirm on  the same host fails with custom resources", 
    "comments": [
        {
            "content": "VM resize and confirm on the same host fails with custom resources, as the old resources are not deallocated after 'confirmResize'.\nSteps to reproduce:\n- boot a VM with old_flavor\n- resize to new_flavor to the same host\n- send confirmResize\n- check usages and compare with new_flavor, and there will be double allocations (old_flavor + new_flavor)\n\nRelated Nova log:\n2017-08-29 16:22:22,666 INFO [nova.api.openstack.placement.requestlog] 127.0.0.1 \"GET /placement/allocations/8d989deb-860e-4ade-a581-a01b819b6297\" status: 200 len: 326 microversion: 1.0\n    2017-08-29 16:22:22,666 DEBUG [nova.scheduler.client.report] Current allocations for instance: {u'5f7fdb12-9866-4534-b0ce-ba60b14f37cb': {u'resources': {u'CUSTOM_MAGIC': 256}, u'generation': 4}, u'\n60b3f076-ebd9-499e-a9d0-83013320505c': {u'resources': {u'MEMORY_MB': 3072, u'DISK_GB': 60, u'VCPU': 2}, u'generation': 3}, u'c522247d-e8ee-4f6c-848d-367eb99885d6': {u'resources': {u'CUSTOM_MAGIC': 256}\n, u'generation': 4}}\n    2017-08-29 16:22:22,666 DEBUG [nova.scheduler.client.report] Instance 8d989deb-860e-4ade-a581-a01b819b6297 has resources on 1 compute nodes\n    2017-08-29 16:22:22,666 DEBUG [nova.scheduler.client.report] Original resources from same-host allocation: {u'MEMORY_MB': 3072, u'DISK_GB': 60, u'VCPU': 2}\n    2017-08-29 16:22:22,667 DEBUG [nova.scheduler.client.report] Subtracting old resources from same-host allocation: {u'MEMORY_MB': 1024, u'DISK_GB': 40, u'VCPU': 1, u'CUSTOM_MAGIC': -256}\n    2017-08-29 16:22:22,667 DEBUG [nova.scheduler.client.report] Sending updated allocation [{'resource_provider': {'uuid': u'5f7fdb12-9866-4534-b0ce-ba60b14f37cb'}, 'resources': {u'CUSTOM_MAGIC': 256}\n}, {'resource_provider': {'uuid': u'c522247d-e8ee-4f6c-848d-367eb99885d6'}, 'resources': {u'CUSTOM_MAGIC': 256}}, {'resource_provider': {'uuid': '60b3f076-ebd9-499e-a9d0-83013320505c'}, 'resources': {u\n'MEMORY_MB': 1024, u'DISK_GB': 40, u'VCPU': 1, u'CUSTOM_MAGIC': -256}}] for instance 8d989deb-860e-4ade-a581-a01b819b6297 after removing resources for 60b3f076-ebd9-499e-a9d0-83013320505c.\n    2017-08-29 16:22:22,667 DEBUG [nova.api.openstack.placement.requestlog] Starting request: 127.0.0.1 \"PUT /placement/allocations/8d989deb-860e-4ade-a581-a01b819b6297\"\n    2017-08-29 16:22:22,670 DEBUG [nova.api.openstack.placement.wsgi_wrapper] Placement API returning an error response: JSON does not validate: -256 is less than the minimum of 1\n    \n    Failed validating 'minimum' in schema['properties']['allocations']['items']['properties']['resources']['patternProperties']['^[0-9A-Z_]+$']:\n        {'minimum': 1, 'type': 'integer'}\n    \n    On instance['allocations'][2]['resources'][u'CUSTOM_MAGIC']:\n        -256\n    2017-08-29 16:22:22,671 INFO [nova.api.openstack.placement.requestlog] 127.0.0.1 \"PUT /placement/allocations/8d989deb-860e-4ade-a581-a01b819b6297\" status: 400 len: 532 microversion: 1.10\n    2017-08-29 16:22:22,671 WARNING [nova.scheduler.client.report] Failed to save allocation for 8d989deb-860e-4ade-a581-a01b819b6297. Got HTTP 400: <html>\n     <head>\n      <title>400 Bad Request</title>\n     </head>\n     <body>\n      <h1>400 Bad Request</h1>\n      The server could not comply with the request since it is either malformed or otherwise incorrect.<br /><br />\n    JSON does not validate: -256 is less than the minimum of 1\n    \n    Failed validating 'minimum' in schema['properties']['allocations']['items']['properties']['resources']['patternProperties']['^[0-9A-Z_]+$']:\n        {'minimum': 1, 'type': 'integer'}\n    \n    On instance['allocations'][2]['resources'][u'CUSTOM_MAGIC']:\n        -256\n    \n     </body>\n    </html>", 
            "date_created": "2017-08-29 14:29:41.105011+00:00", 
            "author": "https://api.launchpad.net/1.0/~lajos-katona"
        }, 
        {
            "content": "Lajos has a regression test for it as well and he will push that up soon.", 
            "date_created": "2017-08-29 14:52:59.729336+00:00", 
            "author": "https://api.launchpad.net/1.0/~balazs-gibizer"
        }, 
        {
            "content": "I uploaded the patch, which extends the server moving testcase class with custom resources (WIP actually, but good enough for reproduction now):\nhttps://review.openstack.org/497399", 
            "date_created": "2017-08-29 16:39:27.175638+00:00", 
            "author": "https://api.launchpad.net/1.0/~lajos-katona"
        }, 
        {
            "content": "Yeah, and the test  actually which shows the trouble:\nnova.tests.functional.test_servers.ServerMovingTestsWithCustomResources.test_resize_confirm_same_host", 
            "date_created": "2017-08-29 16:40:24.150407+00:00", 
            "author": "https://api.launchpad.net/1.0/~lajos-katona"
        }
    ]
}