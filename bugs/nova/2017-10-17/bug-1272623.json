{
    "status": "Fix Released", 
    "last_updated": "2016-03-23 19:32:05.100124+00:00", 
    "description": "This can happen if a deployment is interrupted at just the wrong time.\n\n2014-01-25 06:53:38,781.781 14556 DEBUG nova.compute.manager [req-e1958f79-b0c0-4c80-b284-85bb56f1541d None None] [instance: e21e6bca-b528-4922-9f59-7a1a6534ec8d] Current state is 1, state in DB is 1. _init_instance /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py:720\nTraceback (most recent call last):\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 346, in fire_timers\n\u00a0\u00a0\u00a0\u00a0timer()\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n\u00a0\u00a0\u00a0\u00a0cb(*args, **kw)\n\u00a0\u00a0File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n\u00a0\u00a0\u00a0\u00a0result = function(*args, **kwargs)\n\u00a0\u00a0File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/openstack/common/service.py\", line 480, in run_service\n\u00a0\u00a0\u00a0\u00a0service.start()\n\u00a0\u00a0File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/service.py\", line 172, in start\n\u00a0\u00a0\u00a0\u00a0self.manager.init_host()\n\u00a0\u00a0File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 805, in init_host\n\u00a0\u00a0\u00a0\u00a0self._init_instance(context, instance)\n\u00a0\u00a0File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 684, in _init_instance\n\u00a0\u00a0\u00a0\u00a0self.driver.plug_vifs(instance, net_info)\n\u00a0\u00a0File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/driver.py\", line 538, in plug_vifs\n\u00a0\u00a0\u00a0\u00a0self._plug_vifs(instance, network_info)\n\u00a0\u00a0File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/driver.py\", line 543, in _plug_vifs\n\u00a0\u00a0\u00a0\u00a0node = _get_baremetal_node_by_instance_uuid(instance['uuid'])\n\u00a0\u00a0File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/driver.py\", line 85, in _get_baremetal_node_by_instance_uuid\n\u00a0\u00a0\u00a0\u00a0node = db.bm_node_get_by_instance_uuid(ctx, instance_uuid)\n\u00a0\u00a0File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/db/api.py\", line 101, in bm_node_get_by_instance_uuid\n\u00a0\u00a0\u00a0\u00a0instance_uuid)\n\u00a0\u00a0File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 112, in wrapper\n\u00a0\u00a0\u00a0\u00a0return f(*args, **kwargs)\n\u00a0\u00a0File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/db/sqlalchemy/api.py\", line 152, in bm_node_get_by_instance_uuid\n\u00a0\u00a0\u00a0\u00a0raise exception.InstanceNotFound(instance_id=instance_uuid)\nInstanceNotFound: Instance 84c6090b-bf42-4c6a-b2ff-afb22b5ff156 could not be found.\n\nIf there is no allocated node, we can just skip that part of delete.", 
    "tags": [
        "baremetal"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1272623", 
    "owner": "None", 
    "id": 1272623, 
    "index": 1379, 
    "openned": "2014-01-25 06:54:24.786415+00:00", 
    "created": "2014-01-25 06:54:24.786415+00:00", 
    "title": "nova refuses to start if there are baremetal instances with no associated node", 
    "comments": [
        {
            "content": "2014-01-25 06:53:38,781.781 14556 DEBUG nova.compute.manager [req-e1958f79-b0c0-4c80-b284-85bb56f1541d None None] [instance: e21e6bca-b528-4922-9f59-7a1a6534ec8d] Current state is 1, state in DB is 1. _init_instance /opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py:720\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 346, in fire_timers\n    timer()\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n    cb(*args, **kw)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/openstack/common/service.py\", line 480, in run_service\n    service.start()\n  File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/service.py\", line 172, in start\n    self.manager.init_host()\n  File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 805, in init_host\n    self._init_instance(context, instance)\n  File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/compute/manager.py\", line 684, in _init_instance\n    self.driver.plug_vifs(instance, net_info)\n  File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/driver.py\", line 538, in plug_vifs\n    self._plug_vifs(instance, network_info)\n  File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/driver.py\", line 543, in _plug_vifs\n    node = _get_baremetal_node_by_instance_uuid(instance['uuid'])\n  File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/driver.py\", line 85, in _get_baremetal_node_by_instance_uuid\n    node = db.bm_node_get_by_instance_uuid(ctx, instance_uuid)\n  File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/db/api.py\", line 101, in bm_node_get_by_instance_uuid\n    instance_uuid)\n  File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/db/sqlalchemy/api.py\", line 112, in wrapper\n    return f(*args, **kwargs)\n  File \"/opt/stack/venvs/nova/local/lib/python2.7/site-packages/nova/virt/baremetal/db/sqlalchemy/api.py\", line 152, in bm_node_get_by_instance_uuid\n    raise exception.InstanceNotFound(instance_id=instance_uuid)\nInstanceNotFound: Instance 84c6090b-bf42-4c6a-b2ff-afb22b5ff156 could not be found.\n\n\nIf there is no allocated node, we can just skip that part of delete.", 
            "date_created": "2014-01-25 06:54:24.786415+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "We're running a monkeypatch to avoid this at the moment", 
            "date_created": "2014-01-25 07:28:44.438104+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "questions from jog:\n - how does this happen\n - is this only nova-bm ?", 
            "date_created": "2014-02-03 18:55:11.639746+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "On startup nova-compute attempts to restore the state of the node to it's internal model. E.g. start vms that are meant to be running, fully delete vms that are means to be purged from disk etc.\n\nWe also try to start VMs in state 'ERROR' here, which AFAICT doesn't happen in any other circumstance. This is conceptually problematic because ERROR is used to indicate that nova has given up on the VM, rather than  it being in the middle of an operation which needs resuming.\n\nOne particular thing that can happen is that once a VM is in state ERROR,  there is no guarantee that the axioms for it are maintained - it might not have had networking allocated, for instance.\n\nThe thing that caused this particular backtrace here was an instance of that: nova-compute error the VM before writing the instance id to the bm_nodes table (which is what captures the association of instance to node). This happened quite legitimately - the scheduler was trying to schedule to an already used node (due to a different issue - but the scheduler is intrinsically racy, so this should be expected in general). Then when restarted nova-compute attempted to restart the ERROR state VM, and threw an exception (rightly so, attempting to power on nothing is an error)", 
            "date_created": "2014-02-03 19:02:36.621235+00:00", 
            "author": "https://api.launchpad.net/1.0/~lifeless"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/69108\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=6534a89de9cabc274cbdb7d2ecee3d851c456a87\nSubmitter: Jenkins\nBranch:    master\n\ncommit 6534a89de9cabc274cbdb7d2ecee3d851c456a87\nAuthor: Steve Kowalik <email address hidden>\nDate:   Sat Jan 25 20:00:19 2014 +1300\n\n    Don't try to restore VM's in state ERROR.\n    \n    We don't try to restore VM's that are in a failed BUILDING state, so\n    attempting to start ERROR VMs is more than a little weird. The one\n    exception to this rule are VMs that are in RESIZE_MIGRATING, since\n    recovery is already attempted. It's also a problem, because many ERROR\n    states aren't recoverable from (at the moment anyhow).\n    \n    Closes-Bug: #1272623\n    Change-Id: I0599b83a82ad3ee67a92126d3b57df5b02e20539\n    Co-Authored-By: Robert Collins <email address hidden>\n", 
            "date_created": "2014-02-07 02:59:31.051860+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/havana\nReview: https://review.openstack.org/81690", 
            "date_created": "2014-03-20 02:37:37.352599+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "I believe this bug also affects libvirt driver(qemu hypervisor) in havana, so I cherry picked it to havana.\nplease see the trace as below, nova-compute tried to restore an error instance, and it failed to start at end.\n\n2014-03-19 23:02:57.783 24757 DEBUG nova.virt.libvirt.vif [req-d5ae9690-179e-4661-928f-9c3febaeda5f None None] vif_type=binding_failed instance=<nova.objects.instance.Instance object at 0x3f38750> vif=VIF({'ovs_interfaceid': None, 'network': Network({'bridge': None, 'subnets': [Subnet({'ips': [FixedIP({'meta': {}, 'version': 4, 'type': u'fixed', 'floating_ips': [], 'address': u'10.0.17.4'})], 'version': 4, 'meta': {u'dhcp_server': u'10.0.17.3'}, 'dns': [], 'routes': [], 'cidr': u'10.0.17.0/24', 'gateway': IP({'meta': {}, 'version': 4, 'type': u'gateway', 'address': u'10.0.17.1'})})], 'meta': {u'injected': False, u'tenant_id': u'e1caab985d1e4418a8b0e4d869afdd25'}, 'id': u'001361ce-ebbf-44de-aa7a-2943682bfa3a', 'label': u'admin-test'}), 'devname': u'tapa13b662a-24', 'qbh_params': None, 'meta': {}, 'address': u'fa:16:3e:15:ac:a5', 'type': u'binding_failed', 'id': u'a13b662a-24d3-4ccd-8788-f59151376e6f', 'qbg_params': None}) plug /usr/lib/python2.7/dist-packages/nova/virt/libvirt/vif.py:544\n2014-03-19 23:02:57.786 24757 ERROR nova.openstack.common.threadgroup [-] Unexpected vif_type=binding_failed\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup Traceback (most recent call last):\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/threadgroup.py\", line 117, in wait\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup x.wait()\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/threadgroup.py\", line 49, in wait\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup return self.thread.wait()\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 168, in wait\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup return self._exit_event.wait()\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/eventlet/event.py\", line 116, in wait\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup return hubs.get_hub().switch()\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 187, in switch\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup return self.greenlet.switch()\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 194, in main\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup result = function(*args, **kwargs)\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/nova/openstack/common/service.py\", line 65, in run_service\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup service.start()\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 154, in start\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup self.manager.init_host()\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 967, in init_host\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup wait_ticks=wait_ticks)\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 776, in _init_instance\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup self.driver.plug_vifs(instance, net_info)\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/driver.py\", line 794, in plug_vifs\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup self.vif_driver.plug(instance, vif)\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/vif.py\", line 566, in plug\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup _(\"Unexpected vif_type=%s\") % vif_type)\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup NovaException: Unexpected vif_type=binding_failed\n2014-03-19 23:02:57.786 24757 TRACE nova.openstack.common.threadgroup", 
            "date_created": "2014-03-20 02:38:36.980718+00:00", 
            "author": "https://api.launchpad.net/1.0/~hzwangpan"
        }, 
        {
            "content": "Change abandoned by Wangpan (<email address hidden>) on branch: stable/havana\nReview: https://review.openstack.org/81690", 
            "date_created": "2014-07-31 07:37:56.977414+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "It appears this has been fixed in Nova for a long time.", 
            "date_created": "2016-03-23 19:32:04.549423+00:00", 
            "author": "https://api.launchpad.net/1.0/~bnemec"
        }
    ], 
    "closed": "2014-03-05 13:08:48.185462+00:00"
}