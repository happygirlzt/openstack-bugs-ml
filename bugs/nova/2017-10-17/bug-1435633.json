{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:59:27.568009+00:00", 
    "description": "I have two compute node, host lxlconductor1 and host lxlcompute1.\nA migration failed at function of \"_call_livem_checks_on_host\" because check_can_live_migrate_destination rpc call's MessagingTimeout Exception, but the status of this instance is still migrating.\n\n2015-05-23 09:11:53.456 26651 ERROR nova.conductor.manager [req-b836290d-93d7-4bee-b974-433d067fc287 fdfd8f6a96ed4a1a9d60dbb4be1e0cf7 7f6c0898a35d4de9b53642ae984d3cf3] Migration of instance 8f50c28d-0caf-43df-b154-97f56cea7d2d to host None unexpectedly failed.\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager Traceback (most recent call last):\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 768, in _live_migrate\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     block_migration, disk_over_commit)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/tasks/live_migrate.py\", line 201, in execute\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     return task.execute()\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/tasks/live_migrate.py\", line 62, in execute\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     self.destination = self._find_destination()\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/tasks/live_migrate.py\", line 173, in _find_destination\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     self._call_livem_checks_on_host(host)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/tasks/live_migrate.py\", line 144, in _call_livem_checks_on_host\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     destination, self.block_migration, self.disk_over_commit)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/compute/rpcapi.py\", line 360, in check_can_live_migrate_destination\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     disk_over_commit=disk_over_commit)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/client.py\", line 150, in call\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     wait_for_reply=True, timeout=timeout)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/transport.py\", line 90, in _send\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     timeout=timeout)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/_drivers/amqpdriver.py\", line 412, in send\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/_drivers/amqpdriver.py\", line 403, in _send\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     result = self._waiter.wait(msg_id, timeout)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/_drivers/amqpdriver.py\", line 267, in wait\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     reply, ending = self._poll_connection(msg_id, timeout)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/_drivers/amqpdriver.py\", line 217, in _poll_connection\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     % msg_id)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager MessagingTimeout: Timed out waiting for a reply to message ID ff504056d4cd462a9fca96d3cfa8183a\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager \n2015-05-23 09:11:53.483 26651 ERROR oslo.messaging.rpc.dispatcher [-] Exception during message handling: Migration error: Timed out waiting for a reply to message ID ff504056d4cd462a9fca96d3cfa8183a\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/server.py\", line 139, in inner\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     return func(*args, **kwargs)\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 685, in migrate_server\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     block_migration, disk_over_commit)\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 796, in _live_migrate\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     raise exception.MigrationError(reason=ex)\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher MigrationError: Migration error: Timed out waiting for a reply to message ID ff504056d4cd462a9fca96d3cfa8183a\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher \n2015-05-23 09:11:53.484 26651 ERROR oslo.messaging._drivers.common [-] Returning exception Migration error: Timed out waiting for a reply to message ID ff504056d4cd462a9fca96d3cfa8183a to caller\n2015-05-23 09:11:53.484 26651 ERROR oslo.messaging._drivers.common [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\\n    incoming.message))\\n', '  File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n', '  File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n', '  File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/server.py\", line 139, in inner\\n    return func(*args, **kwargs)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 685, in migrate_server\\n    block_migration, disk_over_commit)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 796, in _live_migrate\\n    raise exception.MigrationError(reason=ex)\\n', 'MigrationError: Migration error: Timed out waiting for a reply to message ID ff504056d4cd462a9fca96d3cfa8183a\\n']", 
    "tags": [
        "live-migrate"
    ], 
    "importance": "Low", 
    "heat": 14, 
    "link": "https://bugs.launchpad.net/nova/+bug/1435633", 
    "owner": "https://api.launchpad.net/1.0/~jichenjc", 
    "id": 1435633, 
    "index": 1634, 
    "openned": "2015-03-24 01:43:12.619083+00:00", 
    "created": "2015-03-24 01:43:12.619083+00:00", 
    "title": " live migration fails at check_can_live_migrate_destination, but the status of this instance is still 'migrating'.", 
    "comments": [
        {
            "content": "I have two compute node, host lxlconductor1 and host lxlcompute1.\nA migration failed at function of \"_call_livem_checks_on_host\" because check_can_live_migrate_destination rpc call's MessagingTimeout Exception, but the status of this instance is still migrating.\n\n2015-05-23 09:11:53.456 26651 ERROR nova.conductor.manager [req-b836290d-93d7-4bee-b974-433d067fc287 fdfd8f6a96ed4a1a9d60dbb4be1e0cf7 7f6c0898a35d4de9b53642ae984d3cf3] Migration of instance 8f50c28d-0caf-43df-b154-97f56cea7d2d to host None unexpectedly failed.\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager Traceback (most recent call last):\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 768, in _live_migrate\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     block_migration, disk_over_commit)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/tasks/live_migrate.py\", line 201, in execute\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     return task.execute()\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/tasks/live_migrate.py\", line 62, in execute\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     self.destination = self._find_destination()\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/tasks/live_migrate.py\", line 173, in _find_destination\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     self._call_livem_checks_on_host(host)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/conductor/tasks/live_migrate.py\", line 144, in _call_livem_checks_on_host\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     destination, self.block_migration, self.disk_over_commit)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/nova/compute/rpcapi.py\", line 360, in check_can_live_migrate_destination\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     disk_over_commit=disk_over_commit)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/client.py\", line 150, in call\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     wait_for_reply=True, timeout=timeout)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/transport.py\", line 90, in _send\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     timeout=timeout)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/_drivers/amqpdriver.py\", line 412, in send\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     return self._send(target, ctxt, message, wait_for_reply, timeout)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/_drivers/amqpdriver.py\", line 403, in _send\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     result = self._waiter.wait(msg_id, timeout)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/_drivers/amqpdriver.py\", line 267, in wait\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     reply, ending = self._poll_connection(msg_id, timeout)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager   File \"/usr/lib/python2.7/site-packages/oslo/messaging/_drivers/amqpdriver.py\", line 217, in _poll_connection\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager     % msg_id)\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager MessagingTimeout: Timed out waiting for a reply to message ID ff504056d4cd462a9fca96d3cfa8183a\n2015-05-23 09:11:53.456 26651 TRACE nova.conductor.manager \n2015-05-23 09:11:53.483 26651 ERROR oslo.messaging.rpc.dispatcher [-] Exception during message handling: Migration error: Timed out waiting for a reply to message ID ff504056d4cd462a9fca96d3cfa8183a\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher Traceback (most recent call last):\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     incoming.message))\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     return self._do_dispatch(endpoint, method, ctxt, args)\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     result = getattr(endpoint, method)(ctxt, **new_args)\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/server.py\", line 139, in inner\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     return func(*args, **kwargs)\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 685, in migrate_server\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     block_migration, disk_over_commit)\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher   File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 796, in _live_migrate\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher     raise exception.MigrationError(reason=ex)\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher MigrationError: Migration error: Timed out waiting for a reply to message ID ff504056d4cd462a9fca96d3cfa8183a\n2015-05-23 09:11:53.483 26651 TRACE oslo.messaging.rpc.dispatcher \n2015-05-23 09:11:53.484 26651 ERROR oslo.messaging._drivers.common [-] Returning exception Migration error: Timed out waiting for a reply to message ID ff504056d4cd462a9fca96d3cfa8183a to caller\n2015-05-23 09:11:53.484 26651 ERROR oslo.messaging._drivers.common [-] ['Traceback (most recent call last):\\n', '  File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 133, in _dispatch_and_reply\\n    incoming.message))\\n', '  File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 176, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n', '  File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/dispatcher.py\", line 122, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n', '  File \"/usr/lib/python2.7/site-packages/oslo/messaging/rpc/server.py\", line 139, in inner\\n    return func(*args, **kwargs)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 685, in migrate_server\\n    block_migration, disk_over_commit)\\n', '  File \"/usr/lib/python2.7/site-packages/nova/conductor/manager.py\", line 796, in _live_migrate\\n    raise exception.MigrationError(reason=ex)\\n', 'MigrationError: Migration error: Timed out waiting for a reply to message ID ff504056d4cd462a9fca96d3cfa8183a\\n']", 
            "date_created": "2015-03-24 01:43:12.619083+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "Which version are you using ? master ? \n\nif the migration failed, what's expection of task_state? None ?\ngit log 40a37269 may show you the changes related \nI am wondering whether you want to make the task_state to None and keep the vm_state to ERROR", 
            "date_created": "2015-03-27 13:33:12.336154+00:00", 
            "author": "https://api.launchpad.net/1.0/~jichenjc"
        }, 
        {
            "content": "icehouse.\n\nI hope the task_state can back to None,  and vm_state is active.", 
            "date_created": "2015-03-28 07:25:18.963904+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/168635", 
            "date_created": "2015-03-28 21:40:07.844617+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/179048", 
            "date_created": "2015-04-30 12:44:34.796358+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "We can reserve this timeout exception in _call_livem_checks_on_host.\nWe only need to resolve bug 1276214. \nBecause if nova-api revert instance's task_state when nova-api receive messaging timeout exception, this resolution can  resolve live_migration's timeout questions which contains this bug appearance.\n\nhttps://bugs.launchpad.net/nova/+bug/1276214", 
            "date_created": "2015-06-02 08:23:57.136642+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "Rong, solution to bug 1276214 will set VM state to ERROR when timeout occurs (because at API level we have no idea what happened). And bug 1435633 allows us to set instance back to ACTIVE state because we know that LM failed during prechecks so VM state is still consistent.", 
            "date_created": "2015-06-02 08:39:31.438014+00:00", 
            "author": "https://api.launchpad.net/1.0/~pawel-koniszewski"
        }, 
        {
            "content": "we call let bug 1276214 set VM state to ACTIVE and give a error message to user.\n\nBecause if messaging timeout exception occurs at nova-conductor, it should be nova-scheduler or nova-compute had no response to nova-conductor. This occurs when nova-api first receive message timeout exception, because all rpc call's timeout is 60s.", 
            "date_created": "2015-06-02 09:07:17.769148+00:00", 
            "author": "https://api.launchpad.net/1.0/~hanrong"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/168635\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=c0d0e5ccf62f45498f084ed59e776c3b370e9137\nSubmitter: Jenkins\nBranch:    master\n\ncommit c0d0e5ccf62f45498f084ed59e776c3b370e9137\nAuthor: jichenjc <email address hidden>\nDate:   Mon Mar 23 00:36:43 2015 +0800\n\n    Handle MessageTimeout to MigrationPreCheckError\n    \n    There are a few checks before live-migration, if any of the\n    check failed, the live-migration can't be done. However\n    during _call_livem_checks_on_host check, because it's a\n    RPC call ,so it might result in a MessageTimeout exception.\n    If this occurs, we should safely revert its state,\n    since no real opperation occured.\n    \n    This patch translates the MessageTimeout to\n    MigrationPreCheckError and leverage existing MigrationPreCheckError\n    processing to revert instance to normal state instead of error\n    \n    Closes-Bug: 1435633\n    \n    Change-Id: I8b484abb6650e14e2d225ca5e476d1fa7a6ee990\n", 
            "date_created": "2015-08-21 12:51:27.285553+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/179048\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3fecf182d896d0e56b09055659a2db32da7e5f25\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3fecf182d896d0e56b09055659a2db32da7e5f25\nAuthor: jichenjc <email address hidden>\nDate:   Thu Apr 16 09:15:36 2015 +0800\n\n    Refactor test cases for live-migrate error case\n    \n    There are a few of exceptions can be raised from live-migrate\n    function in conductor, this patch added some cases for\n    more exceptions handling and refactors the util function\n    with mock.\n    \n    Change-Id: I6b225756efcc17bdcd6402606287c35464a3c1d0\n    Related-Bug: 1435633\n", 
            "date_created": "2015-08-28 23:26:11.735840+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-09-03 11:46:58.175078+00:00"
}