{
    "status": "Fix Released", 
    "last_updated": "2012-08-31 12:55:41.853622+00:00", 
    "description": "On the Diablo release, trying to run 'nova rebuild' on an instance running on libvirt results in a failure with:\n\n2011-10-04 16:57:15,543 DEBUG nova.virt.libvirt_conn [-] instance instance-00000001: starting toXML method from (pid=18743) to_xml /usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py:1162\n2011-10-04 16:57:15,543 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 98, in wrapped\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 597, in spawn\n(nova.exception): TRACE:     block_device_info=block_device_info)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1164, in to_xml\n(nova.exception): TRACE:     block_device_info)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1058, in _prepare_xml_info\n(nova.exception): TRACE:     block_device_info)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/driver.py\", line 58, in block_device_info_get_mapping\n(nova.exception): TRACE:     block_device_mapping = block_device_info.get('block_device_mapping') or []\n(nova.exception): TRACE: AttributeError: 'tuple' object has no attribute 'get'\n(nova.exception): TRACE: \n2011-10-04 16:57:15,575 DEBUG nova.rpc [-] Making asynchronous cast on notifications.error... from (pid=18743) cast /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:747\n[...]\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/notifier/api.py\", line 122, in notify\n(nova.exception): TRACE:     driver.notify(msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/notifier/rabbit_notifier.py\", line 36, in notify\n(nova.exception): TRACE:     rpc.cast(context, topic, message)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/__init__.py\", line 49, in cast\n(nova.exception): TRACE:     return get_impl().cast(context, topic, msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 750, in cast\n(nova.exception): TRACE:     conn.topic_send(topic, msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 465, in topic_send\n(nova.exception): TRACE:     self.publisher_send(TopicPublisher, topic, msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 433, in publisher_send\n(nova.exception): TRACE:     publisher.send(msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 234, in send\n(nova.exception): TRACE:     self.producer.publish(msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/messaging.py\", line 121, in publish\n(nova.exception): TRACE:     compression, headers)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/messaging.py\", line 144, in _prepare\n(nova.exception): TRACE:     body) = encode(body, serializer=serializer)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/serialization.py\", line 119, in encode\n(nova.exception): TRACE:     payload = encoder(data)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/anyjson/__init__.py\", line 123, in <lambda>\n(nova.exception): TRACE:     serialize = lambda value: implementation.serialize(value)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/anyjson/__init__.py\", line 85, in serialize\n(nova.exception): TRACE:     raise TypeError(*exc.args)\n(nova.exception): TRACE: TypeError: <capsule object \"virConnectPtr\" at 0x434fe70> is not JSON serializable\n(nova.exception): TRACE: \n2011-10-04 16:57:15,584 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 98, in wrapped\n(nova.rpc): TRACE:     return f(*args, **kw)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 117, in decorated_function\n(nova.rpc): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 574, in rebuild_instance\n(nova.rpc): TRACE:     self.driver.spawn(context, instance_ref, network_info, bd_mapping)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 129, in wrapped\n(nova.rpc): TRACE:     raise Error(str(e))\n(nova.rpc): TRACE: Error: 'tuple' object has no attribute 'get'\n(nova.rpc): TRACE:", 
    "tags": [
        "low-hanging-fruit"
    ], 
    "importance": "High", 
    "heat": 22, 
    "link": "https://bugs.launchpad.net/nova/+bug/867627", 
    "owner": "https://api.launchpad.net/1.0/~ironcamel", 
    "id": 867627, 
    "index": 501, 
    "openned": "2011-10-04 16:05:42.735194+00:00", 
    "created": "2011-10-04 16:05:42.735194+00:00", 
    "title": "Failure while rebuilding an instance with libvirt", 
    "comments": [
        {
            "content": "On the Diablo release, trying to run 'nova rebuild' on an instance running on libvirt results in a failure with:\n\n2011-10-04 16:57:15,543 DEBUG nova.virt.libvirt_conn [-] instance instance-00000001: starting toXML method from (pid=18743) to_xml /usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py:1162\n2011-10-04 16:57:15,543 ERROR nova.exception [-] Uncaught exception\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 98, in wrapped\n(nova.exception): TRACE:     return f(*args, **kw)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 597, in spawn\n(nova.exception): TRACE:     block_device_info=block_device_info)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1164, in to_xml\n(nova.exception): TRACE:     block_device_info)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/libvirt/connection.py\", line 1058, in _prepare_xml_info\n(nova.exception): TRACE:     block_device_info)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/virt/driver.py\", line 58, in block_device_info_get_mapping\n(nova.exception): TRACE:     block_device_mapping = block_device_info.get('block_device_mapping') or []\n(nova.exception): TRACE: AttributeError: 'tuple' object has no attribute 'get'\n(nova.exception): TRACE: \n2011-10-04 16:57:15,575 DEBUG nova.rpc [-] Making asynchronous cast on notifications.error... from (pid=18743) cast /usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py:747\n[...]\n(nova.exception): TRACE: Traceback (most recent call last):\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/notifier/api.py\", line 122, in notify\n(nova.exception): TRACE:     driver.notify(msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/notifier/rabbit_notifier.py\", line 36, in notify\n(nova.exception): TRACE:     rpc.cast(context, topic, message)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/__init__.py\", line 49, in cast\n(nova.exception): TRACE:     return get_impl().cast(context, topic, msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 750, in cast\n(nova.exception): TRACE:     conn.topic_send(topic, msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 465, in topic_send\n(nova.exception): TRACE:     self.publisher_send(TopicPublisher, topic, msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 433, in publisher_send\n(nova.exception): TRACE:     publisher.send(msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 234, in send\n(nova.exception): TRACE:     self.producer.publish(msg)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/messaging.py\", line 121, in publish\n(nova.exception): TRACE:     compression, headers)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/messaging.py\", line 144, in _prepare\n(nova.exception): TRACE:     body) = encode(body, serializer=serializer)\n(nova.exception): TRACE:   File \"/usr/lib/python2.7/dist-packages/kombu/serialization.py\", line 119, in encode\n(nova.exception): TRACE:     payload = encoder(data)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/anyjson/__init__.py\", line 123, in <lambda>\n(nova.exception): TRACE:     serialize = lambda value: implementation.serialize(value)\n(nova.exception): TRACE:   File \"/usr/lib/pymodules/python2.7/anyjson/__init__.py\", line 85, in serialize\n(nova.exception): TRACE:     raise TypeError(*exc.args)\n(nova.exception): TRACE: TypeError: <capsule object \"virConnectPtr\" at 0x434fe70> is not JSON serializable\n(nova.exception): TRACE: \n2011-10-04 16:57:15,584 ERROR nova.rpc [-] Exception during message handling\n(nova.rpc): TRACE: Traceback (most recent call last):\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/rpc/impl_kombu.py\", line 620, in _process_data\n(nova.rpc): TRACE:     rval = node_func(context=ctxt, **node_args)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 98, in wrapped\n(nova.rpc): TRACE:     return f(*args, **kw)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 117, in decorated_function\n(nova.rpc): TRACE:     function(self, context, instance_id, *args, **kwargs)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\", line 574, in rebuild_instance\n(nova.rpc): TRACE:     self.driver.spawn(context, instance_ref, network_info, bd_mapping)\n(nova.rpc): TRACE:   File \"/usr/lib/python2.7/dist-packages/nova/exception.py\", line 129, in wrapped\n(nova.rpc): TRACE:     raise Error(str(e))\n(nova.rpc): TRACE: Error: 'tuple' object has no attribute 'get'\n(nova.rpc): TRACE:", 
            "date_created": "2011-10-04 16:05:42.735194+00:00", 
            "author": "https://api.launchpad.net/1.0/~stanislaw-pitucha"
        }, 
        {
            "content": "\nI fixed that one. I made a change in rebuild_instance method and fixed the bug. I will the changes for review.\n\nThanks.\n\n--Ahmad\nHP Cloud services", 
            "date_created": "2011-10-17 15:42:11.822132+00:00", 
            "author": "https://api.launchpad.net/1.0/~ahmad-hassan-q"
        }, 
        {
            "content": "One of our users just reported this. It seems the same as bug 904724, which is currently marked as invalid. Has this actually been fixed anywhere? It seems like it would be a candidate for diablo stable.", 
            "date_created": "2012-01-16 18:34:12.088080+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "\nHi David,\n\nWe have fixed it in our local repositories but I think we haven't pushed it upstream yet.\n\n--Ahmad", 
            "date_created": "2012-01-16 18:48:53.102828+00:00", 
            "author": "https://api.launchpad.net/1.0/~ahmad-hassan-q"
        }, 
        {
            "content": "Apparently this is already fixed in essex. See https://review.openstack.org/2414\n\nI'm not sure I buy that, though\n\n\nhttps://github.com/openstack/nova/blob/a5e73ffe/nova/compute/manager.py#L724\n\n        bd_mapping = self._setup_block_device_mapping(context, instance)\n        ....\n        self.driver.spawn(context, instance, image_meta,\n                          network_info, bd_mapping)\n\nhttps://github.com/openstack/nova/blob/a5e73ffe/nova/compute/manager.py#L275\n\n    def _setup_block_device_mapping(self, context, instance):\n        ...\n        return (swap, ephemerals, block_device_mapping)\n\nhttps://github.com/openstack/nova/blob/a5e73ffe/nova/virt/libvirt/connection.py#L670\n\n    def spawn(self, context, instance, image_meta, network_info,\n              block_device_info=None):\n        xml = self.to_xml(instance, network_info, image_meta, False,\n                          block_device_info=block_device_info)\n\nhttps://github.com/openstack/nova/blob/a5e73ffe/nova/virt/libvirt/connection.py#L1201\n\n    def to_xml(self, instance, network_info, image_meta=None, rescue=False,\n               block_device_info=None):\n        ...\n        xml_info = self._prepare_xml_info(instance, network_info, image_meta,\n                                          rescue, block_device_info)\n\nhttps://github.com/openstack/nova/blob/a5e73ffe/nova/virt/libvirt/connection.py#L1087\n\n    def _prepare_xml_info(self, instance, network_info, image_meta, rescue,\n                          block_device_info=None):\n        block_device_mapping = driver.block_device_info_get_mapping(\n            block_device_info)\n\nhttps://github.com/openstack/nova/blob/a5e73ffe/nova/virt/driver.py#L56\n\n    def block_device_info_get_mapping(block_device_info):\n        block_device_info = block_device_info or {}\n        block_device_mapping = block_device_info.get('block_device_mapping') or []\n        return block_device_mapping\n\n\n\nLooks obvious to me that the bug is still there. But https://review.openstack.org/2414 didn't fix the issue either", 
            "date_created": "2012-01-17 12:15:39.562430+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "This fix looks more correct: http://github.com/griddynamics/osc-robot-nova/commit/1273ed19", 
            "date_created": "2012-01-17 12:27:40.588571+00:00", 
            "author": "https://api.launchpad.net/1.0/~markmc"
        }, 
        {
            "content": "@markmc: care to repropose it for master ?", 
            "date_created": "2012-01-23 16:11:38.080799+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/3420", 
            "date_created": "2012-01-25 18:49:33.219627+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/3420\nCommitted: http://github.com/openstack/nova/commit/f7346b6ce8a945499d9f2f3eb0d531f9da0705dc\nSubmitter: Jenkins\nBranch:    master\n\ncommit f7346b6ce8a945499d9f2f3eb0d531f9da0705dc\nAuthor: Naveed Massjouni <email address hidden>\nDate:   Wed Jan 25 18:48:58 2012 +0000\n\n    Fixing rebuilds on libvirt.\n    \n    bug: 867627\n    Change-Id: I663fd4004a2198c15d576de33b5aa35188a6e74a\n", 
            "date_created": "2012-01-25 19:47:57.191475+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/3427", 
            "date_created": "2012-01-25 20:15:48.492249+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/3427\nCommitted: http://github.com/openstack/nova/commit/a27dd1b24ca67de28cced3d8d2eec98f86cbb958\nSubmitter: Jenkins\nBranch:    master\n\ncommit a27dd1b24ca67de28cced3d8d2eec98f86cbb958\nAuthor: Naveed Massjouni <email address hidden>\nDate:   Wed Jan 25 20:15:28 2012 +0000\n\n    Fixing rebuilds on libvirt, seriously.\n    \n    bug: 867627\n    Change-Id: I497b18a56997e347995ad8869855127bd31cb974\n", 
            "date_created": "2012-01-26 20:51:08.103019+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "looks like this just needs a backport", 
            "date_created": "2012-02-01 15:27:44.381299+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }
    ], 
    "closed": "2012-02-29 10:20:10.185909+00:00"
}