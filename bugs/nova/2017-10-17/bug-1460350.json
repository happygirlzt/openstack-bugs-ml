{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:53:30.910659+00:00", 
    "description": "Seen in check-tempest-dsvm-cells job failure, example trace from [1]:\n\nTraceback (most recent call last):\n  File \"tempest/api/compute/servers/test_list_servers_negative.py\", line 153, in test_list_servers_detail_server_is_deleted\n    self.assertEqual([], actual)\n  File \"/opt/stack/new/tempest/.tox/all/local/lib/python2.7/site-packages/testtools/testcase.py\", line 350, in assertEqual\n    self.assertThat(observed, matcher, message)\n  File \"/opt/stack/new/tempest/.tox/all/local/lib/python2.7/site-packages/testtools/testcase.py\", line 435, in assertThat\n    raise mismatch_error\ntesttools.matchers._impl.MismatchError: !=:\nreference = []\nactual    = [{u'OS-DCF:diskConfig': u'MANUAL',\n  u'OS-EXT-AZ:availability_zone': u'nova',\n  u'OS-EXT-STS:power_state': 0,\n  u'OS-EXT-STS:task_state': None,\n  u'OS-EXT-STS:vm_state': u'deleted',\n  u'OS-SRV-USG:launched_at': None,\n  u'OS-SRV-USG:terminated_at': u'2015-05-17T15:46:15.000000',\n  u'accessIPv4': u'',\n  u'accessIPv6': u'',\n  u'addresses': {},\n  u'config_drive': u'',\n  u'created': u'2015-05-17T15:46:15Z',\n  u'flavor': {u'id': u'42',\n              u'links': [{u'href': u'http://127.0.0.1:8774/82eeb74985844a9daa71b162f663e981/flavors/42',\n                          u'rel': u'bookmark'}]},\n  u'hostId': u'',\n  u'id': u'45b1decf-8f52-4075-8869-acb9f48de159',\n  u'image': {u'id': u'990c6a37-da73-4a74-be3d-eff98dcf7727',\n             u'links': [{u'href': u'http://127.0.0.1:8774/82eeb74985844a9daa71b162f663e981/images/990c6a37-da73-4a74-be3d-eff98dcf7727',\n                         u'rel': u'bookmark'}]},\n  u'key_name': None,\n  u'links': [{u'href': u'http://127.0.0.1:8774/v2/82eeb74985844a9daa71b162f663e981/servers/45b1decf-8f52-4075-8869-acb9f48de159',\n              u'rel': u'self'},\n             {u'href': u'http://127.0.0.1:8774/82eeb74985844a9daa71b162f663e981/servers/45b1decf-8f52-4075-8869-acb9f48de159',\n              u'rel': u'bookmark'}],\n  u'metadata': {},\n  u'name': u'ListServersNegativeTestJSON-instance-1205034409',\n  u'os-extended-volumes:volumes_attached': [],\n  u'status': u'DELETED',\n  u'tenant_id': u'82eeb74985844a9daa71b162f663e981',\n  u'updated': u'2015-05-17T15:46:15Z',\n  u'user_id': u'aac5bd38fc264166b9b365426557b4d2'}]\n\nThe test creates an instance and immediately deletes it before it's scheduled. After the delete has happened at the top via local delete, updates from the child cells can arrive and \"undelete\" the instance. This is possible because the code in nova/cells/messaging.py does read_deleted='yes' and db.instance_update() will update all fields provided (unlike objects). I also tried removing the local delete logic in nova/compute/cells_api.py and it didn't help -- the destroy in the child will trigger a instance_destroy_at_top() but it's still possible for the instance.save() update to occur after the destroy, resulting again in \"undeleted\" instance.\n\nThis issue should go away when instance_update_at_top() is converted to use objects, as the \"deleted\" etc fields won't ever be in what_changed.\n\n[1] http://logs.openstack.org/09/183909/2/check/check-tempest-dsvm-cells/9799bb0", 
    "tags": [
        "cells"
    ], 
    "importance": "Low", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1460350", 
    "owner": "https://api.launchpad.net/1.0/~melwitt", 
    "id": 1460350, 
    "index": 1747, 
    "openned": "2015-05-30 22:32:31.983195+00:00", 
    "created": "2015-05-30 22:32:31.983195+00:00", 
    "title": "Cells: Race deleting instance can lead to instances 'undeleted' at the top", 
    "comments": [
        {
            "content": "Seen in check-tempest-dsvm-cells job failure, example trace from [1]:\n\nTraceback (most recent call last):\n  File \"tempest/api/compute/servers/test_list_servers_negative.py\", line 153, in test_list_servers_detail_server_is_deleted\n    self.assertEqual([], actual)\n  File \"/opt/stack/new/tempest/.tox/all/local/lib/python2.7/site-packages/testtools/testcase.py\", line 350, in assertEqual\n    self.assertThat(observed, matcher, message)\n  File \"/opt/stack/new/tempest/.tox/all/local/lib/python2.7/site-packages/testtools/testcase.py\", line 435, in assertThat\n    raise mismatch_error\ntesttools.matchers._impl.MismatchError: !=:\nreference = []\nactual    = [{u'OS-DCF:diskConfig': u'MANUAL',\n  u'OS-EXT-AZ:availability_zone': u'nova',\n  u'OS-EXT-STS:power_state': 0,\n  u'OS-EXT-STS:task_state': None,\n  u'OS-EXT-STS:vm_state': u'deleted',\n  u'OS-SRV-USG:launched_at': None,\n  u'OS-SRV-USG:terminated_at': u'2015-05-17T15:46:15.000000',\n  u'accessIPv4': u'',\n  u'accessIPv6': u'',\n  u'addresses': {},\n  u'config_drive': u'',\n  u'created': u'2015-05-17T15:46:15Z',\n  u'flavor': {u'id': u'42',\n              u'links': [{u'href': u'http://127.0.0.1:8774/82eeb74985844a9daa71b162f663e981/flavors/42',\n                          u'rel': u'bookmark'}]},\n  u'hostId': u'',\n  u'id': u'45b1decf-8f52-4075-8869-acb9f48de159',\n  u'image': {u'id': u'990c6a37-da73-4a74-be3d-eff98dcf7727',\n             u'links': [{u'href': u'http://127.0.0.1:8774/82eeb74985844a9daa71b162f663e981/images/990c6a37-da73-4a74-be3d-eff98dcf7727',\n                         u'rel': u'bookmark'}]},\n  u'key_name': None,\n  u'links': [{u'href': u'http://127.0.0.1:8774/v2/82eeb74985844a9daa71b162f663e981/servers/45b1decf-8f52-4075-8869-acb9f48de159',\n              u'rel': u'self'},\n             {u'href': u'http://127.0.0.1:8774/82eeb74985844a9daa71b162f663e981/servers/45b1decf-8f52-4075-8869-acb9f48de159',\n              u'rel': u'bookmark'}],\n  u'metadata': {},\n  u'name': u'ListServersNegativeTestJSON-instance-1205034409',\n  u'os-extended-volumes:volumes_attached': [],\n  u'status': u'DELETED',\n  u'tenant_id': u'82eeb74985844a9daa71b162f663e981',\n  u'updated': u'2015-05-17T15:46:15Z',\n  u'user_id': u'aac5bd38fc264166b9b365426557b4d2'}]\n\nThe test creates an instance and immediately deletes it before it's scheduled. After the delete has happened at the top via local delete, updates from the child cells can arrive and \"undelete\" the instance. This is possible because the code in nova/cells/messaging.py does read_deleted='yes' and db.instance_update() will update all fields provided (unlike objects). I also tried removing the local delete logic in nova/compute/cells_api.py and it didn't help -- the destroy in the child will trigger a instance_destroy_at_top() but it's still possible for the instance.save() update to occur after the destroy, resulting again in \"undeleted\" instance.\n\nThis issue should go away when instance_update_at_top() is converted to use objects, as the \"deleted\" etc fields won't ever be in what_changed.\n\n[1] http://logs.openstack.org/09/183909/2/check/check-tempest-dsvm-cells/9799bb0", 
            "date_created": "2015-05-30 22:32:31.983195+00:00", 
            "author": "https://api.launchpad.net/1.0/~melwitt"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/176518\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=eaaa659333c7586a71155c065dfb0f7b7e3758fc\nSubmitter: Jenkins\nBranch:    master\n\ncommit eaaa659333c7586a71155c065dfb0f7b7e3758fc\nAuthor: melanie witt <email address hidden>\nDate:   Wed Mar 11 03:28:36 2015 +0000\n\n    Send Instance object to cells instance_update_at_top\n    \n    Currently, a primitivized object is sent to sync to the API cell\n    in Instance.save because instance_update_at_top has not yet been\n    converted to handle objects. This change does the conversion and\n    makes Instance.save send an object for the sync.\n    \n    This change should also address a race where deleting an instance\n    can result in an \"undeleted\" instance if an update from a child\n    occurs after the instance has been destroyed at the top, because\n    in instance_update_at_top() it uses read_deleted='yes' and\n    db.instance_update() will update all fields provided, unlike\n    objects which only update fields that have changed.\n    \n    Closes-Bug: #1460350\n    \n    Change-Id: I4e8c1a82a3c9c86038faa7f528b9dfb835f82ee6\n", 
            "date_created": "2015-06-12 01:33:21.554832+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-06-24 12:22:45.320261+00:00"
}