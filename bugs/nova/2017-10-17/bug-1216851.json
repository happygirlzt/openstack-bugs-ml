{
    "status": "Fix Released", 
    "last_updated": "2016-09-15 18:13:03.383871+00:00", 
    "description": "http://logs.openstack.org/80/43580/1/check/gate-nova-python27/ae0cd74/console.html\n\n013-08-26 09:18:25.324 | ======================================================================\n2013-08-26 09:18:25.324 | FAIL: nova.tests.db.test_migrations.TestNovaMigrations.test_postgresql_opportunistically\n2013-08-26 09:18:25.325 | tags: worker-0\n2013-08-26 09:18:25.325 | ----------------------------------------------------------------------\n...\n2013-08-26 09:18:25.338 | 172 -> 173... \n2013-08-26 09:18:25.339 | Deleted duplicated row with id: 2 from table: key_pairs\n2013-08-26 09:18:25.339 | Deleted duplicated row with id: 1 from table: key_pairs\n2013-08-26 09:18:25.339 | done\n2013-08-26 09:18:25.339 | Failed to migrate to version 173 on engine Engine(postgresql+psycopg2://openstack_citest:openstack_citest@localhost/openstack_citest)\n2013-08-26 09:18:25.339 | }}}\n2013-08-26 09:18:25.339 | \n2013-08-26 09:18:25.340 | Traceback (most recent call last):\n2013-08-26 09:18:25.340 |   File \"/home/jenkins/workspace/gate-nova-python27/nova/tests/db/test_migrations.py\", line 175, in test_postgresql_opportunistically\n2013-08-26 09:18:25.340 |     self._test_postgresql_opportunistically()\n2013-08-26 09:18:25.340 |   File \"/home/jenkins/workspace/gate-nova-python27/nova/tests/db/test_migrations.py\", line 358, in _test_postgresql_opportunistically\n2013-08-26 09:18:25.340 |     self._walk_versions(engine, False, False)\n2013-08-26 09:18:25.340 |   File \"/home/jenkins/workspace/gate-nova-python27/nova/tests/db/test_migrations.py\", line 379, in _walk_versions\n2013-08-26 09:18:25.341 |     self._migrate_up(engine, version, with_data=True)\n2013-08-26 09:18:25.341 |   File \"/home/jenkins/workspace/gate-nova-python27/nova/tests/db/test_migrations.py\", line 444, in _migrate_up\n2013-08-26 09:18:25.341 |     check(engine, data)\n2013-08-26 09:18:25.341 |   File \"/home/jenkins/workspace/gate-nova-python27/nova/tests/db/test_migrations.py\", line 1233, in _check_173\n2013-08-26 09:18:25.341 |     insert.execute(duplicate_keypair)\n2013-08-26 09:18:25.341 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/sql/expression.py\", line 2841, in execute\n2013-08-26 09:18:25.341 |     return e._execute_clauseelement(self, multiparams, params)\n2013-08-26 09:18:25.342 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 2453, in _execute_clauseelement\n2013-08-26 09:18:25.342 |     return connection._execute_clauseelement(elem, multiparams, params)\n2013-08-26 09:23:49.057 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1584, in _execute_clauseelement\n2013-08-26 09:23:49.057 |     compiled_sql, distilled_params\n2013-08-26 09:23:49.057 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1732, in _execute_context\n2013-08-26 09:23:49.057 |     self._commit_impl()\n2013-08-26 09:23:49.057 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1280, in _commit_impl\n2013-08-26 09:23:49.057 |     self._handle_dbapi_exception(e, None, None, None, None)\n2013-08-26 09:23:49.058 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1828, in _handle_dbapi_exception\n2013-08-26 09:23:49.058 |     self._autorollback()\n2013-08-26 09:23:49.058 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1345, in _autorollback\n2013-08-26 09:23:49.058 |     self._rollback_impl()\n2013-08-26 09:23:49.058 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1265, in _rollback_impl\n2013-08-26 09:23:49.058 |     self._handle_dbapi_exception(e, None, None, None, None)\n2013-08-26 09:23:49.058 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1262, in _rollback_impl\n2013-08-26 09:23:49.059 |     self.engine.dialect.do_rollback(self.connection)\n2013-08-26 09:23:49.059 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 300, in do_rollback\n2013-08-26 09:23:49.059 |     connection.rollback()\n2013-08-26 09:23:49.059 | InterfaceError: (InterfaceError) connection already closed None None", 
    "tags": [
        "db"
    ], 
    "importance": "High", 
    "heat": 28, 
    "link": "https://bugs.launchpad.net/nova/+bug/1216851", 
    "owner": "https://api.launchpad.net/1.0/~rpodolyaka", 
    "id": 1216851, 
    "index": 1194, 
    "openned": "2013-10-22 18:54:03.502836+00:00", 
    "created": "2013-08-26 10:38:02.228584+00:00", 
    "title": "nova unit tests occasionally fail migration tests for mysql and postgres", 
    "comments": [
        {
            "content": "http://logs.openstack.org/80/43580/1/check/gate-nova-python27/ae0cd74/console.html\n\n013-08-26 09:18:25.324 | ======================================================================\n2013-08-26 09:18:25.324 | FAIL: nova.tests.db.test_migrations.TestNovaMigrations.test_postgresql_opportunistically\n2013-08-26 09:18:25.325 | tags: worker-0\n2013-08-26 09:18:25.325 | ----------------------------------------------------------------------\n...\n2013-08-26 09:18:25.338 | 172 -> 173... \n2013-08-26 09:18:25.339 | Deleted duplicated row with id: 2 from table: key_pairs\n2013-08-26 09:18:25.339 | Deleted duplicated row with id: 1 from table: key_pairs\n2013-08-26 09:18:25.339 | done\n2013-08-26 09:18:25.339 | Failed to migrate to version 173 on engine Engine(postgresql+psycopg2://openstack_citest:openstack_citest@localhost/openstack_citest)\n2013-08-26 09:18:25.339 | }}}\n2013-08-26 09:18:25.339 | \n2013-08-26 09:18:25.340 | Traceback (most recent call last):\n2013-08-26 09:18:25.340 |   File \"/home/jenkins/workspace/gate-nova-python27/nova/tests/db/test_migrations.py\", line 175, in test_postgresql_opportunistically\n2013-08-26 09:18:25.340 |     self._test_postgresql_opportunistically()\n2013-08-26 09:18:25.340 |   File \"/home/jenkins/workspace/gate-nova-python27/nova/tests/db/test_migrations.py\", line 358, in _test_postgresql_opportunistically\n2013-08-26 09:18:25.340 |     self._walk_versions(engine, False, False)\n2013-08-26 09:18:25.340 |   File \"/home/jenkins/workspace/gate-nova-python27/nova/tests/db/test_migrations.py\", line 379, in _walk_versions\n2013-08-26 09:18:25.341 |     self._migrate_up(engine, version, with_data=True)\n2013-08-26 09:18:25.341 |   File \"/home/jenkins/workspace/gate-nova-python27/nova/tests/db/test_migrations.py\", line 444, in _migrate_up\n2013-08-26 09:18:25.341 |     check(engine, data)\n2013-08-26 09:18:25.341 |   File \"/home/jenkins/workspace/gate-nova-python27/nova/tests/db/test_migrations.py\", line 1233, in _check_173\n2013-08-26 09:18:25.341 |     insert.execute(duplicate_keypair)\n2013-08-26 09:18:25.341 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/sql/expression.py\", line 2841, in execute\n2013-08-26 09:18:25.341 |     return e._execute_clauseelement(self, multiparams, params)\n2013-08-26 09:18:25.342 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 2453, in _execute_clauseelement\n2013-08-26 09:18:25.342 |     return connection._execute_clauseelement(elem, multiparams, params)\n2013-08-26 09:23:49.057 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1584, in _execute_clauseelement\n2013-08-26 09:23:49.057 |     compiled_sql, distilled_params\n2013-08-26 09:23:49.057 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1732, in _execute_context\n2013-08-26 09:23:49.057 |     self._commit_impl()\n2013-08-26 09:23:49.057 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1280, in _commit_impl\n2013-08-26 09:23:49.057 |     self._handle_dbapi_exception(e, None, None, None, None)\n2013-08-26 09:23:49.058 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1828, in _handle_dbapi_exception\n2013-08-26 09:23:49.058 |     self._autorollback()\n2013-08-26 09:23:49.058 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1345, in _autorollback\n2013-08-26 09:23:49.058 |     self._rollback_impl()\n2013-08-26 09:23:49.058 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1265, in _rollback_impl\n2013-08-26 09:23:49.058 |     self._handle_dbapi_exception(e, None, None, None, None)\n2013-08-26 09:23:49.058 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1262, in _rollback_impl\n2013-08-26 09:23:49.059 |     self.engine.dialect.do_rollback(self.connection)\n2013-08-26 09:23:49.059 |   File \"/home/jenkins/workspace/gate-nova-python27/.tox/py27/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 300, in do_rollback\n2013-08-26 09:23:49.059 |     connection.rollback()\n2013-08-26 09:23:49.059 | InterfaceError: (InterfaceError) connection already closed None None", 
            "date_created": "2013-08-26 10:38:02.228584+00:00", 
            "author": "https://api.launchpad.net/1.0/~mate-lakat"
        }, 
        {
            "content": "Without more info about what this test was trying to accomplish and whether or not the change that caused the failure could be at fault it is hard to debug this further. It looks like during a database migration test the connection to postgres was closed prematurely. Is it possible that one of the migrations was flawed causing this to stop early or is it more likely that there was a network hickup on the test slave? In any case more info necessary. I have also added nova to the bug to hopefully get eyes on this from people that understand the database migration tests.", 
            "date_created": "2013-10-22 18:55:59.980933+00:00", 
            "author": "https://api.launchpad.net/1.0/~cboylan"
        }, 
        {
            "content": "Seeing this again in the gate now.\n\nhttp://logs.openstack.org/84/58384/3/check/gate-nova-python27/fa7c704/console.html\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJtZXNzYWdlOlwiRmFpbGVkIHRvIG1pZ3JhdGUgdG8gdmVyc2lvblwiIEFORCBmaWxlbmFtZTpcImNvbnNvbGUuaHRtbFwiIiwiZmllbGRzIjpbXSwib2Zmc2V0IjowLCJ0aW1lZnJhbWUiOiJjdXN0b20iLCJncmFwaG1vZGUiOiJjb3VudCIsInRpbWUiOnsiZnJvbSI6IjIwMTMtMTEtMDVUMjE6MDE6MjQrMDA6MDAiLCJ0byI6IjIwMTMtMTItMDNUMjE6MDE6MjQrMDA6MDAiLCJ1c2VyX2ludGVydmFsIjoiMCJ9LCJzdGFtcCI6MTM4NjEwNDUzMzA5M30=", 
            "date_created": "2013-12-03 21:09:49.330319+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Although we are definitely seeing this, the logstash query for this is a bit misleading, because some of the failures are in checks  where the unit tests are working as expected.", 
            "date_created": "2013-12-03 21:34:05.902786+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Some investigation was performed to rule out issues with the machines where these tests run. One machine where a failure had been witnessed for the nova py27 tests in the gate pipeline (timing out both mysql and postgres migrations) showed nothing out of the ordinary with the system. When running a subsequent instance of the same job, it succeeded and system load was less than the number of vCPUs on that VM. The database logs are littered with all manner of critical/fatal errors, but I have no idea which ones are considered \"normal\" for these tests and which could indicate the test accidentally doing something wrong (rather than purposefully).", 
            "date_created": "2013-12-03 21:49:59.645332+00:00", 
            "author": "https://api.launchpad.net/1.0/~fungi"
        }, 
        {
            "content": "We are seeing this in the stable branch of nova as well http://logs.openstack.org/02/56202/1/gate/gate-nova-python27/648edba/console.html", 
            "date_created": "2013-12-04 12:52:49.335612+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Hmm, this seems to be an ordinary timeout exception that is raised if a test is executed for more than OS_TEST_TIMEOUT seconds (https://github.com/openstack/nova/blob/master/.testr.conf). And in case of migrations tests error messages can be very-very misleading. E.g. I can't run migrations tests in Nova on my machine without specifying OS_TEST_TIMEOUT=0, because it takes more than 160 seconds to tun test_walk_versions() for MySQL.\n\nThe more migrations we put to Nova, the more often we face this issue (depending on the load of CI nodes of course).\n\nSo I would suggest to increase the OS_TEST_TIMEOUT value (or turn it off for migrations tests, if it's possible)", 
            "date_created": "2013-12-04 14:03:19.075780+00:00", 
            "author": "https://api.launchpad.net/1.0/~rpodolyaka"
        }, 
        {
            "content": "The migration timeout problems appear to be intermittent, I have had this problem but it went away with a different configuration.\n\nIf so, this may be similar to:\nhttps://bugs.launchpad.net/nova/+bug/1105284\nand\nhttps://bugs.launchpad.net/nova/+bug/1200289", 
            "date_created": "2013-12-04 14:52:59.598327+00:00", 
            "author": "https://api.launchpad.net/1.0/~krtaylor"
        }, 
        {
            "content": "If the test timeout is causing the problems my suggestion would be to bump the timeout in nova's testr.conf then work on having different timeouts for different tests (maybe use multiples of some base timeout?). This should buy enough time to sort out the problem more properly.\n\nThe timeouts are important particularly when running on jenkins so that we can fail individual tests as quickly as possibly without waiting for the much longer Jenkins job timeouts.", 
            "date_created": "2013-12-04 18:15:51.093770+00:00", 
            "author": "https://api.launchpad.net/1.0/~cboylan"
        }, 
        {
            "content": "Proposed fix: https://review.openstack.org/#/c/60021/", 
            "date_created": "2013-12-05 19:33:09.380964+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/60020\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=0be2ee14211766dc50d504935e198d3f0a6527a8\nSubmitter: Jenkins\nBranch:    master\n\ncommit 0be2ee14211766dc50d504935e198d3f0a6527a8\nAuthor: Roman Podoliaka <email address hidden>\nDate:   Wed Dec 4 18:13:50 2013 +0200\n\n    Make it possible to override test timeout value\n    \n    Currently, we are setting the test timeout value globally\n    in .testr.conf. It could be useful to be able to override\n    it per test case (e.g. for migrations tests which usually\n    take much longer to run than any other tests).\n    \n    Related-Bug: #1216851\n    \n    Change-Id: Icee09609f76f4439f6d981641be521d8d695a77e\n", 
            "date_created": "2013-12-16 20:16:35.752120+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/60021\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=b73c64dbe41881096873f040df1e2e4da3227580\nSubmitter: Jenkins\nBranch:    master\n\ncommit b73c64dbe41881096873f040df1e2e4da3227580\nAuthor: Roman Podoliaka <email address hidden>\nDate:   Wed Dec 4 18:14:08 2013 +0200\n\n    Give migrations tests more time to run\n    \n    Migrations tests usually take longer to run that most other\n    tests. Increase the time out value just for migrations tests,\n    so that we don't hit various time out errors running unit tests\n    when CI test nodes slow down a bit.\n    \n    Closes-Bug: #1216851\n    \n    Change-Id: I48d7c125397cd282d52eb8e1a1ccb699188d8f14\n", 
            "date_created": "2013-12-16 20:17:25.302007+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/370805", 
            "date_created": "2016-09-15 13:12:28.836558+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/370805\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=71d6333f855e139894f497fc120487895a1d66ce\nSubmitter: Jenkins\nBranch:    master\n\ncommit 71d6333f855e139894f497fc120487895a1d66ce\nAuthor: Roman Podoliaka <email address hidden>\nDate:   Thu Sep 15 16:10:25 2016 +0300\n\n    Set a bigger TIMEOUT_SCALING_FACTOR value for migration tests\n    \n    This should help avoid timeouts on CI.\n    \n    Related-Bug: #1216851\n    \n    Change-Id: Ic5b2b75e1d8bc73e49b8e7944ae802a64041cb7c\n", 
            "date_created": "2016-09-15 18:13:01.634001+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2014-01-22 16:10:58.786468+00:00"
}