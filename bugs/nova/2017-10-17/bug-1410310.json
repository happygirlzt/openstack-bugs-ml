{
    "status": "Fix Released", 
    "last_updated": "2015-04-30 09:17:32.141848+00:00", 
    "description": "A gate job failed with this error in the n-cpu log. The job is http://logs.openstack.org/13/145713/7/gate/gate-tempest-dsvm-full/71a2280/\n\nFrom http://logs.openstack.org/13/145713/7/gate/gate-tempest-dsvm-full/71a2280/logs/screen-n-cpu.txt.gz\n\n2015-01-13 12:24:35.148 29194 ERROR nova.compute.manager [-] Instance failed network setup after 1 attempt(s)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager Traceback (most recent call last):\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1676, in _allocate_network_async\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     dhcp_options=dhcp_options)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/opt/stack/new/nova/nova/network/api.py\", line 47, in wrapped\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     return func(self, context, *args, **kwargs)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/opt/stack/new/nova/nova/network/base_api.py\", line 64, in wrapper\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     res = f(self, context, *args, **kwargs)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/opt/stack/new/nova/nova/network/api.py\", line 276, in allocate_for_instance\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     nw_info = self.network_rpcapi.allocate_for_instance(context, **args)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/opt/stack/new/nova/nova/network/rpcapi.py\", line 189, in allocate_for_instance\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     macs=jsonutils.to_primitive(macs))\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 152, in call\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     retry=self.retry)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     timeout=timeout, retry=retry)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 436, in send\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     retry=retry)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 427, in _send\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     raise result\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager KeyError: u'\\'headroom\\'\\nTraceback (most recent call last):\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 137, in _dispatch_and_reply\\n    incoming.message))\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 180, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 126, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n\\n  File \"/opt/stack/new/nova/nova/network/floating_ips.py\", line 113, in allocate_for_instance\\n    **kwargs)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 501, in allocate_for_instance\\n    requested_networks=requested_networks)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 193, in _allocate_fixed_ips\\n    vpn=vpn, address=address)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 857, in allocate_fixed_ip\\n    headroom = exc.kwargs[\\'headroom\\']\\n\\nKeyError: \\'headroom\\'\\n'\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager \nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/queue.py\", line 117, in switch\n    self.greenlet.switch(value)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1676, in _allocate_network_async\n    dhcp_options=dhcp_options)\n  File \"/opt/stack/new/nova/nova/network/api.py\", line 47, in wrapped\n    return func(self, context, *args, **kwargs)\n  File \"/opt/stack/new/nova/nova/network/base_api.py\", line 64, in wrapper\n    res = f(self, context, *args, **kwargs)\n  File \"/opt/stack/new/nova/nova/network/api.py\", line 276, in allocate_for_instance\n    nw_info = self.network_rpcapi.allocate_for_instance(context, **args)\n  File \"/opt/stack/new/nova/nova/network/rpcapi.py\", line 189, in allocate_for_instance\n    macs=jsonutils.to_primitive(macs))\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 152, in call\n    retry=self.retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n    timeout=timeout, retry=retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 436, in send\n    retry=retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 427, in _send\n    raise result\nKeyError: u'\\'headroom\\'\\nTraceback (most recent call last):\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 137, in _dispatch_and_reply\\n    incoming.message))\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 180, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 126, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n\\n  File \"/opt/stack/new/nova/nova/network/floating_ips.py\", line 113, in allocate_for_instance\\n    **kwargs)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 501, in allocate_for_instance\\n    requested_networks=requested_networks)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 193, in _allocate_fixed_ips\\n    vpn=vpn, address=address)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 857, in allocate_fixed_ip\\n    headroom = exc.kwargs[\\'headroom\\']\\n\\nKeyError: \\'headroom\\'\\n'\n\n\n\nThe console output of the failed test is:\n\nsetUpClass (tempest.api.compute.images.test_list_image_filters.ListImageFiltersTestJSON)\n2015-01-13 12:41:58.677 | ----------------------------------------------------------------------------------------\n2015-01-13 12:41:58.677 | \n2015-01-13 12:41:58.677 | Captured traceback:\n2015-01-13 12:41:58.677 | ~~~~~~~~~~~~~~~~~~~\n2015-01-13 12:41:58.678 |     Traceback (most recent call last):\n2015-01-13 12:41:58.678 |       File \"tempest/test.py\", line 273, in setUpClass\n2015-01-13 12:41:58.678 |         cls.resource_setup()\n2015-01-13 12:41:58.678 |       File \"tempest/api/compute/images/test_list_image_filters.py\", line 73, in resource_setup\n2015-01-13 12:41:58.678 |         resp, cls.server2 = cls.create_test_server(wait_until='ACTIVE')\n2015-01-13 12:41:58.678 |       File \"tempest/api/compute/base.py\", line 226, in create_test_server\n2015-01-13 12:41:58.678 |         pass\n2015-01-13 12:41:58.678 |       File \"tempest/openstack/common/excutils.py\", line 68, in __exit__\n2015-01-13 12:41:58.678 |         six.reraise(self.type_, self.value, self.tb)\n2015-01-13 12:41:58.678 |       File \"tempest/api/compute/base.py\", line 216, in create_test_server\n2015-01-13 12:41:58.679 |         server['id'], kwargs['wait_until'])\n2015-01-13 12:41:58.679 |       File \"tempest/services/compute/json/servers_client.py\", line 178, in wait_for_server_status\n2015-01-13 12:41:58.679 |         ready_wait=ready_wait)\n2015-01-13 12:41:58.679 |       File \"tempest/common/waiters.py\", line 73, in wait_for_server_status\n2015-01-13 12:41:58.679 |         server_id=server_id)\n2015-01-13 12:41:58.679 |     BuildErrorException: Server 8ea4c502-c5b0-4aa7-8a09-17fac3e226f5 failed to build and is in ERROR status\n2015-01-13 12:41:58.679 |     Details: {u'code': 500, u'message': u'No valid host was found. There are not enough hosts available.', u'created': u'2015-01-13T12:24:36Z'}\n2015-01-13 12:41:58.679 |", 
    "tags": [], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1410310", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1410310, 
    "index": 1669, 
    "openned": "2015-01-13 15:25:09.245217+00:00", 
    "created": "2015-01-13 15:25:09.245217+00:00", 
    "title": "'headroom' KeyError while creating instance", 
    "comments": [
        {
            "content": "A gate job failed with this error in the n-cpu log. The job is http://logs.openstack.org/13/145713/7/gate/gate-tempest-dsvm-full/71a2280/\n\nFrom http://logs.openstack.org/13/145713/7/gate/gate-tempest-dsvm-full/71a2280/logs/screen-n-cpu.txt.gz\n\n2015-01-13 12:24:35.148 29194 ERROR nova.compute.manager [-] Instance failed network setup after 1 attempt(s)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager Traceback (most recent call last):\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1676, in _allocate_network_async\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     dhcp_options=dhcp_options)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/opt/stack/new/nova/nova/network/api.py\", line 47, in wrapped\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     return func(self, context, *args, **kwargs)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/opt/stack/new/nova/nova/network/base_api.py\", line 64, in wrapper\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     res = f(self, context, *args, **kwargs)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/opt/stack/new/nova/nova/network/api.py\", line 276, in allocate_for_instance\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     nw_info = self.network_rpcapi.allocate_for_instance(context, **args)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/opt/stack/new/nova/nova/network/rpcapi.py\", line 189, in allocate_for_instance\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     macs=jsonutils.to_primitive(macs))\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 152, in call\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     retry=self.retry)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     timeout=timeout, retry=retry)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 436, in send\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     retry=retry)\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 427, in _send\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager     raise result\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager KeyError: u'\\'headroom\\'\\nTraceback (most recent call last):\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 137, in _dispatch_and_reply\\n    incoming.message))\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 180, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 126, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n\\n  File \"/opt/stack/new/nova/nova/network/floating_ips.py\", line 113, in allocate_for_instance\\n    **kwargs)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 501, in allocate_for_instance\\n    requested_networks=requested_networks)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 193, in _allocate_fixed_ips\\n    vpn=vpn, address=address)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 857, in allocate_fixed_ip\\n    headroom = exc.kwargs[\\'headroom\\']\\n\\nKeyError: \\'headroom\\'\\n'\n2015-01-13 12:24:35.148 29194 TRACE nova.compute.manager \nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/queue.py\", line 117, in switch\n    self.greenlet.switch(value)\n  File \"/usr/local/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 214, in main\n    result = function(*args, **kwargs)\n  File \"/opt/stack/new/nova/nova/compute/manager.py\", line 1676, in _allocate_network_async\n    dhcp_options=dhcp_options)\n  File \"/opt/stack/new/nova/nova/network/api.py\", line 47, in wrapped\n    return func(self, context, *args, **kwargs)\n  File \"/opt/stack/new/nova/nova/network/base_api.py\", line 64, in wrapper\n    res = f(self, context, *args, **kwargs)\n  File \"/opt/stack/new/nova/nova/network/api.py\", line 276, in allocate_for_instance\n    nw_info = self.network_rpcapi.allocate_for_instance(context, **args)\n  File \"/opt/stack/new/nova/nova/network/rpcapi.py\", line 189, in allocate_for_instance\n    macs=jsonutils.to_primitive(macs))\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/client.py\", line 152, in call\n    retry=self.retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/transport.py\", line 90, in _send\n    timeout=timeout, retry=retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 436, in send\n    retry=retry)\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/_drivers/amqpdriver.py\", line 427, in _send\n    raise result\nKeyError: u'\\'headroom\\'\\nTraceback (most recent call last):\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 137, in _dispatch_and_reply\\n    incoming.message))\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 180, in _dispatch\\n    return self._do_dispatch(endpoint, method, ctxt, args)\\n\\n  File \"/usr/local/lib/python2.7/dist-packages/oslo/messaging/rpc/dispatcher.py\", line 126, in _do_dispatch\\n    result = getattr(endpoint, method)(ctxt, **new_args)\\n\\n  File \"/opt/stack/new/nova/nova/network/floating_ips.py\", line 113, in allocate_for_instance\\n    **kwargs)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 501, in allocate_for_instance\\n    requested_networks=requested_networks)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 193, in _allocate_fixed_ips\\n    vpn=vpn, address=address)\\n\\n  File \"/opt/stack/new/nova/nova/network/manager.py\", line 857, in allocate_fixed_ip\\n    headroom = exc.kwargs[\\'headroom\\']\\n\\nKeyError: \\'headroom\\'\\n'\n\n\n\nThe console output of the failed test is:\n\nsetUpClass (tempest.api.compute.images.test_list_image_filters.ListImageFiltersTestJSON)\n2015-01-13 12:41:58.677 | ----------------------------------------------------------------------------------------\n2015-01-13 12:41:58.677 | \n2015-01-13 12:41:58.677 | Captured traceback:\n2015-01-13 12:41:58.677 | ~~~~~~~~~~~~~~~~~~~\n2015-01-13 12:41:58.678 |     Traceback (most recent call last):\n2015-01-13 12:41:58.678 |       File \"tempest/test.py\", line 273, in setUpClass\n2015-01-13 12:41:58.678 |         cls.resource_setup()\n2015-01-13 12:41:58.678 |       File \"tempest/api/compute/images/test_list_image_filters.py\", line 73, in resource_setup\n2015-01-13 12:41:58.678 |         resp, cls.server2 = cls.create_test_server(wait_until='ACTIVE')\n2015-01-13 12:41:58.678 |       File \"tempest/api/compute/base.py\", line 226, in create_test_server\n2015-01-13 12:41:58.678 |         pass\n2015-01-13 12:41:58.678 |       File \"tempest/openstack/common/excutils.py\", line 68, in __exit__\n2015-01-13 12:41:58.678 |         six.reraise(self.type_, self.value, self.tb)\n2015-01-13 12:41:58.678 |       File \"tempest/api/compute/base.py\", line 216, in create_test_server\n2015-01-13 12:41:58.679 |         server['id'], kwargs['wait_until'])\n2015-01-13 12:41:58.679 |       File \"tempest/services/compute/json/servers_client.py\", line 178, in wait_for_server_status\n2015-01-13 12:41:58.679 |         ready_wait=ready_wait)\n2015-01-13 12:41:58.679 |       File \"tempest/common/waiters.py\", line 73, in wait_for_server_status\n2015-01-13 12:41:58.679 |         server_id=server_id)\n2015-01-13 12:41:58.679 |     BuildErrorException: Server 8ea4c502-c5b0-4aa7-8a09-17fac3e226f5 failed to build and is in ERROR status\n2015-01-13 12:41:58.679 |     Details: {u'code': 500, u'message': u'No valid host was found. There are not enough hosts available.', u'created': u'2015-01-13T12:24:36Z'}\n2015-01-13 12:41:58.679 |", 
            "date_created": "2015-01-13 15:25:09.245217+00:00", 
            "author": "https://api.launchpad.net/1.0/~david-kranz"
        }, 
        {
            "content": "12 hits in 7 days, check and gate, all failures:\n\nhttp://logstash.openstack.org/#eyJzZWFyY2giOiJtZXNzYWdlOlwiYWxsb2NhdGVfZm9yX2luc3RhbmNlXCIgQU5EIG1lc3NhZ2U6XCJLZXlFcnJvclxcOiB1J1xcJ2hlYWRyb29tXFwnXCIgQU5EIHRhZ3M6XCJzY3JlZW4tbi1jcHUudHh0XCIgQU5EIG1vZHVsZTpcIm5vdmEuY29tcHV0ZS5tYW5hZ2VyXCIiLCJmaWVsZHMiOltdLCJvZmZzZXQiOjAsInRpbWVmcmFtZSI6IjYwNDgwMCIsImdyYXBobW9kZSI6ImNvdW50IiwidGltZSI6eyJ1c2VyX2ludGVydmFsIjowfSwic3RhbXAiOjE0MjExOTY3NjYzODEsIm1vZGUiOiIiLCJhbmFseXplX2ZpZWxkIjoiIn0=", 
            "date_created": "2015-01-14 00:54:09.425342+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This goes back to at least 1/5 but logstash only retains 10 days worth of history.  Nothing is jumping out at me for changes to nova-network since then.", 
            "date_created": "2015-01-14 01:02:25.451641+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "This looks like a prime suspect:\n\nhttps://github.com/openstack/nova/commit/0045f7d50cad345c26ae02394ad57716b270d268", 
            "date_created": "2015-01-14 01:09:11.500019+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/147055", 
            "date_created": "2015-01-14 02:57:46.882897+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/147055\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=5d924c8a175b9f13cf0c0e3721903fdb19e8f0dc\nSubmitter: Jenkins\nBranch:    master\n\ncommit 5d924c8a175b9f13cf0c0e3721903fdb19e8f0dc\nAuthor: Matt Riedemann <email address hidden>\nDate:   Tue Jan 13 18:32:03 2015 -0800\n\n    Fix OverQuota headroom KeyError in nova-network allocate_fixed_ip\n    \n    Commit 0045f7d50cad345c26ae02394ad57716b270d268 moved the headroom\n    calculation out of the DB API and into the compute API for when\n    instances go over quota (more specifically flavor information for an\n    instance create), but didn't update the nova-network manager code to\n    remove the usage of the headroom kwarg from the OverQuota exception\n    for logging.\n    \n    This removes the usage of 'headroom' and also fixes the logging a bit so\n    the 'used' value makes more sense, where used = in_use + reserved.\n    \n    Closes-Bug: #1410310\n    \n    Change-Id: I24802e8b5dfe7741b505696c885871a04f769b12\n", 
            "date_created": "2015-01-15 22:52:02.065742+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-02-05 20:15:05.949420+00:00"
}