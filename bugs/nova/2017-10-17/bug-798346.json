{
    "status": "Fix Released", 
    "last_updated": "2011-09-22 13:09:36.103023+00:00", 
    "description": "When modifying a security group with running instances, the nova-compute-local chain is incorrectly updated.\n\nIPTables output before adding/revoking a rule:\n\n\nChain nova-compute-inst-89 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3002 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-inst-93 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3002 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-local (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 nova-compute-inst-89  all  --  *      *       0.0.0.0/0            10.16.1.3           \n    0     0 nova-compute-inst-93  all  --  *      *       0.0.0.0/0            10.16.1.7           \n\niptables output after revoking a rule (specifically tcp dpt 3002):\n\n\nChain nova-compute-inst-89 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-inst-93 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-local (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 nova-compute-inst-89  all  --  *      *       0.0.0.0/0            10.16.1.3           \n    0     0 nova-compute-inst-93  all  --  *      *       0.0.0.0/0            10.16.1.3           \n\nNotice that the nova-compute-local chain has been updated to set destination to the first destination IP in the chain for all of them. I have tested that this happens with any number of instances > 1.\n\nThis incorrect state can be resolved by flushing the iptables rules and restarting compute, causing it to rebuild the chains:\n\n\nChain nova-compute-inst-89 (0 references)\n pkts bytes target     prot opt in     out     source               destination         \n\nChain nova-compute-inst-93 (0 references)\n pkts bytes target     prot opt in     out     source               destination         \n\nChain nova-compute-local (0 references)\n pkts bytes target     prot opt in     out     source               destination         \n\n\nservice nova-compute restart\nnova-compute start/running, process 2797\n\n\nChain nova-compute-inst-89 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-inst-93 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-local (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 nova-compute-inst-89  all  --  *      *       0.0.0.0/0            10.16.1.3           \n    0     0 nova-compute-inst-93  all  --  *      *       0.0.0.0/0            10.16.1.7           \n\nThis causes all other local chains to be moot and allows all traffic to every other instance. It only appears to effect instances in the same project (which makes sense).", 
    "tags": [
        "security-group"
    ], 
    "importance": "High", 
    "heat": 26, 
    "link": "https://bugs.launchpad.net/nova/+bug/798346", 
    "owner": "None", 
    "id": 798346, 
    "index": 416, 
    "openned": "2011-06-16 17:38:42.701014+00:00", 
    "created": "2011-06-16 17:38:42.701014+00:00", 
    "title": "euca-authorize messes up nova-compute-local chains on nodes with more than 1 running instance", 
    "comments": [
        {
            "content": "When modifying a security group with running instances, the nova-compute-local chain is incorrectly updated.\n\nIPTables output before adding/revoking a rule:\n\n\nChain nova-compute-inst-89 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3002 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-inst-93 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3002 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-local (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 nova-compute-inst-89  all  --  *      *       0.0.0.0/0            10.16.1.3           \n    0     0 nova-compute-inst-93  all  --  *      *       0.0.0.0/0            10.16.1.7           \n\niptables output after revoking a rule (specifically tcp dpt 3002):\n\n\nChain nova-compute-inst-89 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-inst-93 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-local (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 nova-compute-inst-89  all  --  *      *       0.0.0.0/0            10.16.1.3           \n    0     0 nova-compute-inst-93  all  --  *      *       0.0.0.0/0            10.16.1.3           \n\nNotice that the nova-compute-local chain has been updated to set destination to the first destination IP in the chain for all of them. I have tested that this happens with any number of instances > 1.\n\nThis incorrect state can be resolved by flushing the iptables rules and restarting compute, causing it to rebuild the chains:\n\n\nChain nova-compute-inst-89 (0 references)\n pkts bytes target     prot opt in     out     source               destination         \n\nChain nova-compute-inst-93 (0 references)\n pkts bytes target     prot opt in     out     source               destination         \n\nChain nova-compute-local (0 references)\n pkts bytes target     prot opt in     out     source               destination         \n\n\nservice nova-compute restart\nnova-compute start/running, process 2797\n\n\nChain nova-compute-inst-89 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-inst-93 (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED \n    0     0 ACCEPT     udp  --  *      *       10.16.1.1            0.0.0.0/0           udp spt:67 dpt:68 \n    0     0 ACCEPT     tcp  --  *      *       192.168.100.0/24     0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       192.168.100.0/24     0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       10.16.1.0/24         0.0.0.0/0           tcp dpt:22 \n    0     0 ACCEPT     icmp --  *      *       10.16.1.0/24         0.0.0.0/0           \n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3000 \n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:3001 \n    0     0 nova-compute-sg-fallback  all  --  *      *       0.0.0.0/0            0.0.0.0/0           \n\nChain nova-compute-local (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 nova-compute-inst-89  all  --  *      *       0.0.0.0/0            10.16.1.3           \n    0     0 nova-compute-inst-93  all  --  *      *       0.0.0.0/0            10.16.1.7           \n\nThis causes all other local chains to be moot and allows all traffic to every other instance. It only appears to effect instances in the same project (which makes sense).", 
            "date_created": "2011-06-16 17:38:42.701014+00:00", 
            "author": "https://api.launchpad.net/1.0/~kbringard"
        }, 
        {
            "content": "This is due to do_refresh_security_group sets network_info only on the first iteration of its loop and then recycles that for subsequent iterations.\n\nnetwork_info is a per-instance thing. It makes no sense to pass it to methods that act on more than one instance, so lets stop doing that. Ever again. :)", 
            "date_created": "2011-06-17 22:23:09.312595+00:00", 
            "author": "https://api.launchpad.net/1.0/~soren"
        }, 
        {
            "content": "This appears to have been fixed. Can anyone else confirm?", 
            "date_created": "2011-08-25 16:11:23.321038+00:00", 
            "author": "https://api.launchpad.net/1.0/~kbringard"
        }, 
        {
            "content": "Yup, Vish (accidentally?) fixed this in r1435. Yay.", 
            "date_created": "2011-09-02 12:10:06.874689+00:00", 
            "author": "https://api.launchpad.net/1.0/~soren"
        }
    ], 
    "closed": "2011-09-22 13:09:34.712891+00:00"
}