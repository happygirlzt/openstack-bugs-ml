{
    "status": "In Progress", 
    "last_updated": "2017-08-22 05:57:07.223955+00:00", 
    "description": "Using either the cli or API, if you attempt to swap disks (nova volume-update, compute.api.swap_volume) on a stopped instance, the command appears to succeed, but the swap is not performed. The way you can tell what didn't happen is that the volume status's of the 2 volumes remain as they were before the operation.\n\nIt would be better to throw an exception when a swap is attempted on a stopped instance. (this can get tricky since an instance can stop at any time during the swap operation. btw, it seems odd that attach and detach are supported on a stopped instance but swap is not. would it be better to support swap on a stopped instance?)\n\nIn the compute log is this exception:\n\n2017-03-15 09:20:13.729 ERROR nova.compute.manager [^[[01;36mreq-e978c2af-d537-4855-ba5f-58ec1976ad2f ^[[00;36mtempest-SwapVolumeTestJSON-1034316961 tempest-SwapVolumeTestJSON-1034316961] ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] Failed to swap volume 11cda3f1-15c3-4195-b404-a7e912f4c517 for 8b6a1904-3e54-43f4-b498-0fa153d7cf17^[[00m\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00mTraceback (most recent call last):\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 4988, in _swap_volume\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    resize_to)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1300, in swap_volume\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    self._swap_volume(guest, disk_dev, conf.source_path, resize_to)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1257, in _swap_volume\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    dev.rebase(new_path, copy=True, reuse_ext=True)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 748, in rebase\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    self._disk, base, self.REBASE_DEFAULT_BANDWIDTH, flags=flags)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    result = proxy_call(self._autowrap, f, *args, **kwargs)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    rv = execute(f, *args, **kwargs)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    six.reraise(c, e, tb)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    rv = meth(*args, **kwargs)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 930, in blockRebase\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    if ret == -1: raise libvirtError ('virDomainBlockRebase() failed', dom=self)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00mlibvirtError: Domain not found: no domain with matching uuid '26fe837e-d72c-4969-8934-09dc92b61897' (instance-00000022)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897]\n\nMy setup is devstack, libvirt+kvm, the volume is a cinder iscsi volume, instance is cirros, \n\nnova$ git log -1\ncommit a3655c311454c09312f12f413535d83302e1fba4\nMerge: 1ef9cbd 3c7b73b\nAuthor: Jenkins <email address hidden>\nDate:   Tue Feb 28 19:21:35 2017 +0000\n\nA somewhat related bug:\n\nhttps://bugs.launchpad.net/nova/+bug/1635657", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1673090", 
    "owner": "https://api.launchpad.net/1.0/~jichenjc", 
    "id": 1673090, 
    "index": 8000, 
    "openned": "2017-03-15 14:28:47.489804+00:00", 
    "created": "2017-03-15 14:28:47.489804+00:00", 
    "title": "Swap disk on stopped instance fails silently", 
    "comments": [
        {
            "content": "Using either the cli or API, if you attempt to swap disks (nova volume-update, compute.api.swap_volume) on a stopped instance, the command appears to succeed, but the swap is not performed. The way you can tell what didn't happen is that the volume status's of the 2 volumes remain as they were before the operation.\n\nIt would be better to throw an exception when a swap is attempted on a stopped instance. (this can get tricky since an instance can stop at any time during the swap operation. btw, it seems odd that attach and detach are supported on a stopped instance but swap is not. would it be better to support swap on a stopped instance?)\n\nIn the compute log is this exception:\n\n2017-03-15 09:20:13.729 ERROR nova.compute.manager [^[[01;36mreq-e978c2af-d537-4855-ba5f-58ec1976ad2f ^[[00;36mtempest-SwapVolumeTestJSON-1034316961 tempest-SwapVolumeTestJSON-1034316961] ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] Failed to swap volume 11cda3f1-15c3-4195-b404-a7e912f4c517 for 8b6a1904-3e54-43f4-b498-0fa153d7cf17^[[00m\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00mTraceback (most recent call last):\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/opt/stack/nova/nova/compute/manager.py\", line 4988, in _swap_volume\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    resize_to)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1300, in swap_volume\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    self._swap_volume(guest, disk_dev, conf.source_path, resize_to)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 1257, in _swap_volume\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    dev.rebase(new_path, copy=True, reuse_ext=True)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/opt/stack/nova/nova/virt/libvirt/guest.py\", line 748, in rebase\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    self._disk, base, self.REBASE_DEFAULT_BANDWIDTH, flags=flags)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    result = proxy_call(self._autowrap, f, *args, **kwargs)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    rv = execute(f, *args, **kwargs)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    six.reraise(c, e, tb)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    rv = meth(*args, **kwargs)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m  File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 930, in blockRebase\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00m    if ret == -1: raise libvirtError ('virDomainBlockRebase() failed', dom=self)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897] ^[[00mlibvirtError: Domain not found: no domain with matching uuid '26fe837e-d72c-4969-8934-09dc92b61897' (instance-00000022)\n2017-03-15 09:20:13.729 TRACE nova.compute.manager ^[[01;35m[instance: 26fe837e-d72c-4969-8934-09dc92b61897]\n\nMy setup is devstack, libvirt+kvm, the volume is a cinder iscsi volume, instance is cirros, \n\nnova$ git log -1\ncommit a3655c311454c09312f12f413535d83302e1fba4\nMerge: 1ef9cbd 3c7b73b\nAuthor: Jenkins <email address hidden>\nDate:   Tue Feb 28 19:21:35 2017 +0000\n\nA somewhat related bug:\n\nhttps://bugs.launchpad.net/nova/+bug/1635657", 
            "date_created": "2017-03-15 14:28:47.489804+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-noyes"
        }, 
        {
            "content": "Swap works ok when instance is:\n- running\n- paused\n- verify resize\n\nSwap fails silently when instance is:\n- stopped\n- suspended\n", 
            "date_created": "2017-03-15 17:13:08.120744+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-noyes"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/446708", 
            "date_created": "2017-03-16 19:31:09.310649+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Change abandoned by Steve Noyes (<email address hidden>) on branch: master\nReview: https://review.openstack.org/446708", 
            "date_created": "2017-03-17 14:04:41.866317+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Steve is it safe to mark this one as a duplicate? You mentioned in your comment under https://review.openstack.org/#/c/389798 that there is already a patch that most likely will fix this issue. Can you verify and mark this bug as a duplicate if it turns out that it is?\n", 
            "date_created": "2017-03-21 15:28:34.045621+00:00", 
            "author": "https://api.launchpad.net/1.0/~mszankin"
        }, 
        {
            "content": "Hi, bug 1635657 is no longer happening in the latest version in git, so I think it would be better to close that bug, and have this be the bug that review https://review.openstack.org/#/c/389798 is fixing.", 
            "date_created": "2017-03-27 17:57:31.908109+00:00", 
            "author": "https://api.launchpad.net/1.0/~steve-noyes"
        }, 
        {
            "content": "\nThere are no currently open reviews on this bug, changing\nthe status back to the previous state and unassigning. If\nthere are active reviews related to this bug, please include\nlinks in comments.\n", 
            "date_created": "2017-06-23 12:56:46.905073+00:00", 
            "author": "https://api.launchpad.net/1.0/~sdague"
        }
    ]
}