{
    "status": "Fix Released", 
    "last_updated": "2016-12-15 17:35:54.742636+00:00", 
    "description": "Alpine linux runs qemu-img version 2.5.1-r4, where you cannot put parameter \"-f qcow2\" in the end of the line, because it expects location. Parameter must be included before source and destination.\n\nStep to reproduce\n==================\n\nyou can try it in container\n\n1) docker run -it gliderlabs/alpine:3.4 sh\n2) apk update; apk add qemu-img wget\n3) wget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-i386-disk.img\n4) mkdir /var/lib/nova/instances/_base/\n5) qemu-img convert -O raw cirros-0.3.4-i386-disk.img /var/lib/nova/instances/_base/sample -f qcow2\nqemu-img: Could not open '/var/lib/nova/instances/_base/sample': Could not open '/var/lib/nova/instances/_base/hovno': No such file or directory\n\ncorrect way\n\nqemu-img convert -f qcow2 -O raw cirros-0.3.4-i386-disk.img /var/lib/nova/instances/_base/sample\n\nI verified this on Ubuntu and Centos as well.\n\nProposed change\n=================\n\ndiff --git a/nova/virt/images.py b/nova/virt/images.py\nindex 8242d2f..4e676b4 100644\n--- a/nova/virt/images.py\n+++ b/nova/virt/images.py\n@@ -96,7 +96,7 @@ def convert_image_unsafe(source, dest, out_format, run_as_root=False):\n def _convert_image(source, dest, in_format, out_format, run_as_root):\n     cmd = ('qemu-img', 'convert', '-O', out_format, source, dest)\n     if in_format is not None:\n-        cmd = cmd + ('-f', in_format)\n+        cmd = cmd[:-2] + ('-f', in_format) + cmd[-2:]\n     try:\n         utils.execute(*cmd, run_as_root=run_as_root)\n     except processutils.ProcessExecutionError as exp:\n\n\nLogs error\n==============\n\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [req-2d77222d-766c-41f9-86b3-57f0319ae6e9 573e69f9429749fc84d1c89d56e7ee4f cbf99832c4ca4feb8a17adbab21f78e7 - - -] [instance: 568c6af\na-d164-43fb-bd95-97f9dd48fa26] Instance failed to spawn\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] Traceback (most recent call last):\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/compute/manager.py\", line 2218, i\nn _build_resources\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     yield resources\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/compute/manager.py\", line 2064, i\nn _build_and_run_instance\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     block_device_info=block_device_info)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 277\n2, in spawn\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     admin_pass=admin_password)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 319\n0, in _create_image\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     instance, size, fallback_from_host)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 678\n7, in _try_fetch_image_cache\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     size=size)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", li\nne 251, in cache\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     *args, **kwargs)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", li\nne 593, in create_image\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     prepare_template(target=base, max_size=size, *args, **kwargs)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/oslo_concurrency/lockutils.py\", line 2\n71, in inner\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     return f(*args, **kwargs)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", li\nne 241, in fetch_func_sync\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     fetch_func(target=target, *args, **kwargs)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/utils.py\", line 429,\n in fetch_image\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     max_size=max_size)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/images.py\", line 165, in fet\nch_to_raw\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     % {'exp': exp})\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] ImageUnacceptable: Image 4c7d8a04-fcb6-4c25-bd18-749361d47637 is unacceptable: Unabl\ne to convert image to raw: Image /var/lib/nova/instances/_base/594054a605f6d769702d6ab0d13ac7537a86b174.part is unacceptable: Unable to convert image to raw: Unexpected error while running c\nommand.\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] Command: qemu-img convert -O raw /var/lib/nova/instances/_base/594054a605f6d769702d6\nab0d13ac7537a86b174.part /var/lib/nova/instances/_base/594054a605f6d769702d6ab0d13ac7537a86b174.converted -f qcow2\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] Exit code: 1\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] Stdout: u''\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] Stderr: u\"qemu-img: Could not open '/var/lib/nova/instances/_base/594054a605f6d76970\n2d6ab0d13ac7537a86b174.converted': Could not open '/var/lib/nova/instances/_base/594054a605f6d769702d6ab0d13ac7537a86b174.converted': No such file or directory\\n\"\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]", 
    "tags": [
        "libvirt"
    ], 
    "importance": "Medium", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1634156", 
    "owner": "https://api.launchpad.net/1.0/~pavlk-jakub", 
    "id": 1634156, 
    "index": 4657, 
    "openned": "2016-10-17 14:07:56.813673+00:00", 
    "created": "2016-10-17 14:07:56.813673+00:00", 
    "title": "qemu-img convert image incompatability in alpine linux", 
    "comments": [
        {
            "content": "Alpine linux runs qemu-img version 2.5.1-r4, where you cannot put parameter \"-f qcow2\" in the end of the line, because it expects location. Parameter must be included before source and destination.\n\nStep to reproduce\n==================\n\nyou can try it in container\n\n1) docker run -it gliderlabs/alpine:3.4 sh\n2) apk update; apk add qemu-img wget\n3) wget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-i386-disk.img\n4) mkdir /var/lib/nova/instances/_base/\n5) qemu-img convert -O raw cirros-0.3.4-i386-disk.img /var/lib/nova/instances/_base/sample -f qcow2\nqemu-img: Could not open '/var/lib/nova/instances/_base/sample': Could not open '/var/lib/nova/instances/_base/hovno': No such file or directory\n\ncorrect way\n\nqemu-img convert -f qcow2 -O raw cirros-0.3.4-i386-disk.img /var/lib/nova/instances/_base/sample\n\nI verified this on Ubuntu and Centos as well.\n\nProposed change\n=================\n\ndiff --git a/nova/virt/images.py b/nova/virt/images.py\nindex 8242d2f..4e676b4 100644\n--- a/nova/virt/images.py\n+++ b/nova/virt/images.py\n@@ -96,7 +96,7 @@ def convert_image_unsafe(source, dest, out_format, run_as_root=False):\n def _convert_image(source, dest, in_format, out_format, run_as_root):\n     cmd = ('qemu-img', 'convert', '-O', out_format, source, dest)\n     if in_format is not None:\n-        cmd = cmd + ('-f', in_format)\n+        cmd = cmd[:-2] + ('-f', in_format) + cmd[-2:]\n     try:\n         utils.execute(*cmd, run_as_root=run_as_root)\n     except processutils.ProcessExecutionError as exp:\n\n\nLogs error\n==============\n\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [req-2d77222d-766c-41f9-86b3-57f0319ae6e9 573e69f9429749fc84d1c89d56e7ee4f cbf99832c4ca4feb8a17adbab21f78e7 - - -] [instance: 568c6af\na-d164-43fb-bd95-97f9dd48fa26] Instance failed to spawn\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] Traceback (most recent call last):\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/compute/manager.py\", line 2218, i\nn _build_resources\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     yield resources\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/compute/manager.py\", line 2064, i\nn _build_and_run_instance\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     block_device_info=block_device_info)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 277\n2, in spawn\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     admin_pass=admin_password)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 319\n0, in _create_image\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     instance, size, fallback_from_host)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 678\n7, in _try_fetch_image_cache\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     size=size)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", li\nne 251, in cache\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     *args, **kwargs)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", li\nne 593, in create_image\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     prepare_template(target=base, max_size=size, *args, **kwargs)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/oslo_concurrency/lockutils.py\", line 2\n71, in inner\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     return f(*args, **kwargs)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py\", li\nne 241, in fetch_func_sync\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     fetch_func(target=target, *args, **kwargs)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/libvirt/utils.py\", line 429,\n in fetch_image\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     max_size=max_size)\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]   File \"/opt/nova/lib/python2.7/site-packages/nova/virt/images.py\", line 165, in fet\nch_to_raw\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]     % {'exp': exp})\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] ImageUnacceptable: Image 4c7d8a04-fcb6-4c25-bd18-749361d47637 is unacceptable: Unabl\ne to convert image to raw: Image /var/lib/nova/instances/_base/594054a605f6d769702d6ab0d13ac7537a86b174.part is unacceptable: Unable to convert image to raw: Unexpected error while running c\nommand.\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] Command: qemu-img convert -O raw /var/lib/nova/instances/_base/594054a605f6d769702d6\nab0d13ac7537a86b174.part /var/lib/nova/instances/_base/594054a605f6d769702d6ab0d13ac7537a86b174.converted -f qcow2\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] Exit code: 1\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] Stdout: u''\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26] Stderr: u\"qemu-img: Could not open '/var/lib/nova/instances/_base/594054a605f6d76970\n2d6ab0d13ac7537a86b174.converted': Could not open '/var/lib/nova/instances/_base/594054a605f6d769702d6ab0d13ac7537a86b174.converted': No such file or directory\\n\"\n2016-10-14 13:27:20.678 63743 ERROR nova.compute.manager [instance: 568c6afa-d164-43fb-bd95-97f9dd48fa26]", 
            "date_created": "2016-10-17 14:07:56.813673+00:00", 
            "author": "https://api.launchpad.net/1.0/~pavlk-jakub"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/387485", 
            "date_created": "2016-10-17 14:31:37.552914+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Tested on ubuntu 16.10 with latest qemu-version, where this remains same. So it only affects version on Alpine linux.", 
            "date_created": "2016-11-07 09:06:14.676553+00:00", 
            "author": "https://api.launchpad.net/1.0/~pavlk-jakub"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/387485\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=ce257366438e09ed8e6be53f01ee00552fa94da3\nSubmitter: Jenkins\nBranch:    master\n\ncommit ce257366438e09ed8e6be53f01ee00552fa94da3\nAuthor: Jakub Pavlik <email address hidden>\nDate:   Mon Oct 17 16:28:01 2016 +0200\n\n    Fix qemu-img convert image incompatability in alpine linux\n    \n    Alpine linux runs qemu-img version, where you cannot put\n    parameter for convert \"-f qcow2\" in the end of the line,\n    because it expects location. Parameter must be included\n    before source and destination.\n    \n    Change-Id: I7f75eb62c19190c0d523b49dd371d603cafd753f\n    Closes-Bug: 1634156\n", 
            "date_created": "2016-12-02 08:00:39.739040+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b2 development milestone.", 
            "date_created": "2016-12-15 17:35:53.380748+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2016-12-02 08:00:37.483769+00:00"
}