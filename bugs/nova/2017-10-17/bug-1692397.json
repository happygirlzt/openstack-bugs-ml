{
    "status": "Fix Released", 
    "last_updated": "2017-08-28 09:55:23.996090+00:00", 
    "description": "Hypervisor statistics could be incorrect:\n\nWhen we killed a nova-compute service and deleted the service from nova DB, and then\nstart the nova-compute service again, the result of Hypervisor/statistics API (nova hypervisor-stats) will be\nincorrect;\n\nHow to reproduce:\n\nStep1. Check the correct statistics before we do anything:\nroot@SZX1000291919:/opt/stack/nova# nova  hypervisor-stats\n+----------------------+-------+\n| Property             | Value |\n+----------------------+-------+\n| count                | 1     |\n| current_workload     | 0     |\n| disk_available_least | 14    |\n| free_disk_gb         | 34    |\n| free_ram_mb          | 6936  |\n| local_gb             | 35    |\n| local_gb_used        | 1     |\n| memory_mb            | 7960  |\n| memory_mb_used       | 1024  |\n| running_vms          | 1     |\n| vcpus                | 8     |\n| vcpus_used           | 1     |\n+----------------------+-------+\n\nStep2. Kill the compute service:\nroot@SZX1000291919:/var/log/nova# ps -ef | grep nova-com\nroot     120419 120411  0 11:06 pts/27   00:00:00 sg libvirtd /usr/local/bin/nova-compute --config-file /etc/nova/nova.conf --log-file /var/log/nova/nova-compute.log\nroot     120420 120419  0 11:06 pts/27   00:00:07 /usr/bin/python /usr/local/bin/nova-compute --config-file /etc/nova/nova.conf --log-file /var/log/nova/nova-compute.log\n\nroot@SZX1000291919:/var/log/nova# kill -9 120419\nroot@SZX1000291919:/var/log/nova# /usr/local/bin/stack: line 19: 120419 Killed                  sg libvirtd '/usr/local/bin/nova-compute --config-file /etc/nova/nova.conf --log-file /var/log/nova/nova-compute.log' > /dev/null 2>&1\n\nroot@SZX1000291919:/var/log/nova# nova service-list\n+----+------------------+---------------+----------+---------+-------+----------------------------+-----------------+\n| Id | Binary           | Host          | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----+------------------+---------------+----------+---------+-------+----------------------------+-----------------+\n| 4  | nova-conductor   | SZX1000291919 | internal | enabled | up    | 2017-05-22T03:24:36.000000 | -               |\n| 6  | nova-scheduler   | SZX1000291919 | internal | enabled | up    | 2017-05-22T03:24:36.000000 | -               |\n| 7  | nova-consoleauth | SZX1000291919 | internal | enabled | up    | 2017-05-22T03:24:37.000000 | -               |\n| 8  | nova-compute     | SZX1000291919 | nova     | enabled | down  | 2017-05-22T03:23:38.000000 | -               |\n| 9  | nova-cert        | SZX1000291919 | internal | enabled | down  | 2017-05-17T02:50:13.000000 | -               |\n+----+------------------+---------------+----------+---------+-------+----------------------------+-----------------+\n\nStep3. Delete the service from DB:\n\nroot@SZX1000291919:/var/log/nova# nova service-delete 8\nroot@SZX1000291919:/var/log/nova# nova service-list\n+----+------------------+---------------+----------+---------+-------+----------------------------+-----------------+\n| Id | Binary           | Host          | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----+------------------+---------------+----------+---------+-------+----------------------------+-----------------+\n| 4  | nova-conductor   | SZX1000291919 | internal | enabled | up    | 2017-05-22T03:25:16.000000 | -               |\n| 6  | nova-scheduler   | SZX1000291919 | internal | enabled | up    | 2017-05-22T03:25:16.000000 | -               |\n| 7  | nova-consoleauth | SZX1000291919 | internal | enabled | up    | 2017-05-22T03:25:17.000000 | -               |\n| 9  | nova-cert        | SZX1000291919 | internal | enabled | down  | 2017-05-17T02:50:13.000000 | -               |\n+----+------------------+---------------+----------+---------+-------+----------------------------+-----------------+\n\nStep4. Start the compute service again:\nroot@SZX1000291919:/var/log/nova# nova service-list\n+----+------------------+---------------+----------+---------+-------+----------------------------+-----------------+\n| Id | Binary           | Host          | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n+----+------------------+---------------+----------+---------+-------+----------------------------+-----------------+\n| 4  | nova-conductor   | SZX1000291919 | internal | enabled | up    | 2017-05-22T03:48:55.000000 | -               |\n| 6  | nova-scheduler   | SZX1000291919 | internal | enabled | up    | 2017-05-22T03:48:56.000000 | -               |\n| 7  | nova-consoleauth | SZX1000291919 | internal | enabled | up    | 2017-05-22T03:48:56.000000 | -               |\n| 9  | nova-cert        | SZX1000291919 | internal | enabled | down  | 2017-05-17T02:50:13.000000 | -               |\n| 10 | nova-compute     | SZX1000291919 | nova     | enabled | up    | 2017-05-22T03:48:57.000000 | -               |\n+----+------------------+---------------+----------+---------+-------+----------------------------+-----------------+\n\nStep5. Check again the hyervisor statistics, the result is incorrect:\n\nroot@SZX1000291919:/var/log/nova# nova  hypervisor-stats\n+----------------------+-------+\n| Property             | Value |\n+----------------------+-------+\n| count                | 2     |\n| current_workload     | 0     |\n| disk_available_least | 28    |\n| free_disk_gb         | 68    |\n| free_ram_mb          | 13872 |\n| local_gb             | 70    |\n| local_gb_used        | 2     |\n| memory_mb            | 15920 |\n| memory_mb_used       | 2048  |\n| running_vms          | 2     |\n| vcpus                | 16    |\n| vcpus_used           | 2     |\n+----------------------+-------+", 
    "tags": [], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1692397", 
    "owner": "https://api.launchpad.net/1.0/~zhengzhenyu", 
    "id": 1692397, 
    "index": 2185, 
    "openned": "2017-05-22 03:29:31.433859+00:00", 
    "created": "2017-05-22 03:29:31.433859+00:00", 
    "title": "hypervisor statistics could be incorrect", 
    "comments": [
        {
            "content": "TBA", 
            "date_created": "2017-05-22 03:29:31.433859+00:00", 
            "author": "https://api.launchpad.net/1.0/~zhengzhenyu"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/467220", 
            "date_created": "2017-05-23 12:50:58.427158+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Looks like it doubled everything when you restarted the compute service, is it reporting 2 compute nodes records instead of one for that single service (or vice-versa)?", 
            "date_created": "2017-05-25 02:01:31.504572+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/467220\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=3d3e9cdd774efe96f468f2bcba6c09a40f5e71d3\nSubmitter: Jenkins\nBranch:    master\n\ncommit 3d3e9cdd774efe96f468f2bcba6c09a40f5e71d3\nAuthor: Kevin_Zheng <email address hidden>\nDate:   Tue May 23 20:28:28 2017 +0800\n\n    Exclude deleted service records when calling hypervisor statistics\n    \n    Hypervisor statistics could be incorrect if not\n    exclude deleted service records from DB.\n    \n    User may stop 'nova-compute' service on some\n    compute nodes and delete the service from nova.\n    When delete 'nova-compute' service, it performs\n    'soft-delete' to the corresponding db records in\n    both 'service' table and 'compute_nodes' table if\n    the compute_nodes record is old, i.e. it is linked\n    to the service record. For modern compute_nodes\n    records, they aren't linked to the services table\n    so deleting the services record will not delete\n    the compute_nodes record, and the ResourceTracker\n    won't recreate the compute_nodes record if the host\n    and hypervisor_hostname still match the existing\n    record, but restarting the process after deleting\n    the service will create a new services table record\n    with the same host/binary/topic.\n    \n    If the 'nova-compute' service on that server\n    re-starts, it will automatically add a record\n    in 'compute_nodes' table (assuming it was deleted\n    because it was an old-style record) and also a correspoding\n    record in 'service' table, and if the host name\n    of the compute node did not change, the newly\n    created records in 'service' and 'compute_nodes'\n    table will be identical to the priously soft-deleted\n    records except the deleted row.\n    \n    When calling Hypervisor-statistics, the DB layer\n    joined records across the whole deployment by\n    comparing records' host field selected from\n    serivce table and records' host field selected\n    from compute_nodes table, and the calculated\n    results could be multiplied if multiple records\n    from service table have the same host field,\n    and this scenario could happen if user perform\n    the above actions.\n    \n    Co-Authored-By: Matt Riedemann <email address hidden>\n    \n    Change-Id: I9dfa15f69f8ef9c6cb36b2734a8601bd73e9d6b3\n    Closes-Bug: #1692397\n", 
            "date_created": "2017-05-26 19:04:49.332587+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/ocata\nReview: https://review.openstack.org/468526", 
            "date_created": "2017-05-26 19:48:05.779859+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/468528", 
            "date_created": "2017-05-26 19:59:08.674918+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/468526\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=74e2a400b2ea3b011f88a7dbd8bb0fa3547b3bfa\nSubmitter: Jenkins\nBranch:    stable/ocata\n\ncommit 74e2a400b2ea3b011f88a7dbd8bb0fa3547b3bfa\nAuthor: Kevin_Zheng <email address hidden>\nDate:   Tue May 23 20:28:28 2017 +0800\n\n    Exclude deleted service records when calling hypervisor statistics\n    \n    Hypervisor statistics could be incorrect if not\n    exclude deleted service records from DB.\n    \n    User may stop 'nova-compute' service on some\n    compute nodes and delete the service from nova.\n    When delete 'nova-compute' service, it performs\n    'soft-delete' to the corresponding db records in\n    both 'service' table and 'compute_nodes' table if\n    the compute_nodes record is old, i.e. it is linked\n    to the service record. For modern compute_nodes\n    records, they aren't linked to the services table\n    so deleting the services record will not delete\n    the compute_nodes record, and the ResourceTracker\n    won't recreate the compute_nodes record if the host\n    and hypervisor_hostname still match the existing\n    record, but restarting the process after deleting\n    the service will create a new services table record\n    with the same host/binary/topic.\n    \n    If the 'nova-compute' service on that server\n    re-starts, it will automatically add a record\n    in 'compute_nodes' table (assuming it was deleted\n    because it was an old-style record) and also a correspoding\n    record in 'service' table, and if the host name\n    of the compute node did not change, the newly\n    created records in 'service' and 'compute_nodes'\n    table will be identical to the priously soft-deleted\n    records except the deleted row.\n    \n    When calling Hypervisor-statistics, the DB layer\n    joined records across the whole deployment by\n    comparing records' host field selected from\n    serivce table and records' host field selected\n    from compute_nodes table, and the calculated\n    results could be multiplied if multiple records\n    from service table have the same host field,\n    and this scenario could happen if user perform\n    the above actions.\n    \n    Co-Authored-By: Matt Riedemann <email address hidden>\n    \n    Change-Id: I9dfa15f69f8ef9c6cb36b2734a8601bd73e9d6b3\n    Closes-Bug: #1692397\n    (cherry picked from commit 3d3e9cdd774efe96f468f2bcba6c09a40f5e71d3)\n", 
            "date_created": "2017-05-27 02:59:55.682186+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b2 development milestone.", 
            "date_created": "2017-06-08 21:52:00.923112+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.6 release.", 
            "date_created": "2017-06-19 12:45:59.493232+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/468528\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=6dc2a0ec1cfe70bbf0f50a36bca5d2794e34e1b1\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 6dc2a0ec1cfe70bbf0f50a36bca5d2794e34e1b1\nAuthor: Kevin_Zheng <email address hidden>\nDate:   Tue May 23 20:28:28 2017 +0800\n\n    Exclude deleted service records when calling hypervisor statistics\n    \n    Hypervisor statistics could be incorrect if not\n    exclude deleted service records from DB.\n    \n    User may stop 'nova-compute' service on some\n    compute nodes and delete the service from nova.\n    When delete 'nova-compute' service, it performs\n    'soft-delete' to the corresponding db records in\n    both 'service' table and 'compute_nodes' table if\n    the compute_nodes record is old, i.e. it is linked\n    to the service record. For modern compute_nodes\n    records, they aren't linked to the services table\n    so deleting the services record will not delete\n    the compute_nodes record, and the ResourceTracker\n    won't recreate the compute_nodes record if the host\n    and hypervisor_hostname still match the existing\n    record, but restarting the process after deleting\n    the service will create a new services table record\n    with the same host/binary/topic.\n    \n    If the 'nova-compute' service on that server\n    re-starts, it will automatically add a record\n    in 'compute_nodes' table (assuming it was deleted\n    because it was an old-style record) and also a correspoding\n    record in 'service' table, and if the host name\n    of the compute node did not change, the newly\n    created records in 'service' and 'compute_nodes'\n    table will be identical to the priously soft-deleted\n    records except the deleted row.\n    \n    When calling Hypervisor-statistics, the DB layer\n    joined records across the whole deployment by\n    comparing records' host field selected from\n    serivce table and records' host field selected\n    from compute_nodes table, and the calculated\n    results could be multiplied if multiple records\n    from service table have the same host field,\n    and this scenario could happen if user perform\n    the above actions.\n    \n    Co-Authored-By: Matt Riedemann <email address hidden>\n    \n    Change-Id: I9dfa15f69f8ef9c6cb36b2734a8601bd73e9d6b3\n    Closes-Bug: #1692397\n    (cherry picked from commit 3d3e9cdd774efe96f468f2bcba6c09a40f5e71d3)\n    (cherry picked from commit 74e2a400b2ea3b011f88a7dbd8bb0fa3547b3bfa)\n", 
            "date_created": "2017-08-21 18:49:20.404182+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.8 release.", 
            "date_created": "2017-08-28 09:55:23.486813+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-05-26 19:04:46.667255+00:00"
}