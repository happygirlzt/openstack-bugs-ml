{
    "status": "Invalid", 
    "last_updated": "2017-06-02 19:04:42.061451+00:00", 
    "description": "Description\n===========\nIf the network fails during post live-migration tasks, the host/hypervisor property of the instance isn't updated to reflect the *new* compute host.\n\nThe migrated instance appears to function properly, but issuing 'nova show <instance_id>' still shows the origin compute node along with a stack trace.\n\nPer the trace below, a failure occurs inside post_live_migration_at_destination() during a call to network_api.migrate_instance_finish() which attempts to update the neutron port mappings. This code exists outside the try/except/finally block that will update the database regardless of failure. Should network connectivity be lost, or the neutron api  doesn't answer, the instance properties aren't saved.\n\n\nSteps to reproduce\n==================\n$ nova live-migration 0386d6cf-edf8-42b8-998f-54103ba675fe node1\n$ nova show 0386d6cf-edf8-42b8-998f-54103ba675fe\n+--------------------------------------+----------------------------------------------------------+\n| Property                             | Value                                                    |\n+--------------------------------------+----------------------------------------------------------+\n| OS-DCF:diskConfig                    | AUTO                                                     |\n| OS-EXT-AZ:availability_zone          | nova                                                     |\n| OS-EXT-SRV-ATTR:host                 | node1                                                    |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | node1.example.org                                        |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000034                                        |\n| OS-EXT-STS:power_state               | 1                                                        |\n| OS-EXT-STS:task_state                | migrating                                                |\n| OS-EXT-STS:vm_state                  | active                                                  \n\n\nA Few minutes later, vm_state is in 'error' and a stack trace can be seen\n$ nova show 0386d6cf-edf8-42b8-998f-54103ba675fe\n...\n...SNIP\n........\n fault  {\"message\": \"Unable to establish connection to http://192.168.1.34:9696/v2.0/ports/dd042ee1-77c0-4c52-b5ea-9b5fbdd02860.json\", \"code\": 500, \"details\": \"  File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 375, in decorated_function \n            return function(self, context, *args, **kwargs)\n          File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 5571, in post_live_migration_at_destination             \n            migration)      \n          File \\\"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\\\", line 1577, in migrate_instance_finish \n            migration['dest_compute'])       \n          File \\\"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\\\", line 1886, in _update_port_binding_for_instance        \n            p['id'], instance=instance)      \n          File \\\"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 220, in __exit__          \n            self.force_reraise()             \n          File \\\"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 196, in force_reraise     \n            six.reraise(self.type_, self.value, self.tb)   \n          File \\\"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\\\", line 1882, in _update_port_binding_for_instance        \n            {'port': {'binding:host_id': host}})           \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\\\", line 97, in with_params  \n            ret = self.function(instance, *args, **kwargs) \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\\\", line 659, in update_port \n            return self.put(self.port_path % (port), body=body)             \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\\\", line 367, in put         \n            headers=headers, params=params)  \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\\\", line 335, in retry_request             \n            headers=headers, params=params)  \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\\\", line 286, in do_request  \n            resp, replybody = self.httpclient.do_request(action, method, body=body)       \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/client.py\\\", line 306, in do_request       \n            return self.request(url, method, **kwargs)     \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/client.py\\\", line 294, in request          \n            resp = super(SessionClient, self).request(*args, **kwargs)      \n          File \\\"/usr/lib/python2.7/dist-packages/keystoneauth1/adapter.py\\\", line 98, in request          \n            return self.session.request(url, method, **kwargs)              \n          File \\\"/usr/lib/python2.7/dist-packages/positional/__init__.py\\\", line 94, in inner              \n            return func(*args, **kwargs)     \n          File \\\"/usr/lib/python2.7/dist-packages/keystoneauth1/session.py\\\", line 452, in request         \n            resp = send(**kwargs)            \n          File \\\"/usr/lib/python2.7/dist-packages/keystoneauth1/session.py\\\", line 496, in _send_request   \n            raise exceptions.ConnectFailure(msg)           \n        \", \"created\": \"2016-10-26T22:54:10Z\"}                    \n\n\nExpected result\n===============\n'host' and 'hypervisor_hostname' should be updated to the destination compute node.\n\n\nEnvironment\n===========\nUbuntu 16.04\nOpenstack Mitaka\n  Nova 13.1.1\n  Neutron 8.1.2\n    + Calico driver 1.3.0", 
    "tags": [
        "live-migration", 
        "sts"
    ], 
    "importance": "Undecided", 
    "heat": 16, 
    "link": "https://bugs.launchpad.net/nova/+bug/1638582", 
    "owner": "None", 
    "id": 1638582, 
    "index": 7778, 
    "openned": "2016-11-02 14:31:54.434813+00:00", 
    "created": "2016-11-02 14:31:54.434813+00:00", 
    "title": "network failure during post live-migrate fails to update hypervisor host", 
    "comments": [
        {
            "content": "Description\n===========\nIf the network fails during post live-migration tasks, the host/hypervisor property of the instance isn't updated to reflect the *new* compute host.\n\nThe migrated instance appears to function properly, but issuing 'nova show <instance_id>' still shows the origin compute node along with a stack trace.\n\nPer the trace below, a failure occurs inside post_live_migration_at_destination() during a call to network_api.migrate_instance_finish() which attempts to update the neutron port mappings. This code exists outside the try/except/finally block that will update the database regardless of failure. Should network connectivity be lost, or the neutron api  doesn't answer, the instance properties aren't saved.\n\n\nSteps to reproduce\n==================\n$ nova live-migration 0386d6cf-edf8-42b8-998f-54103ba675fe node1\n$ nova show 0386d6cf-edf8-42b8-998f-54103ba675fe\n+--------------------------------------+----------------------------------------------------------+\n| Property                             | Value                                                    |\n+--------------------------------------+----------------------------------------------------------+\n| OS-DCF:diskConfig                    | AUTO                                                     |\n| OS-EXT-AZ:availability_zone          | nova                                                     |\n| OS-EXT-SRV-ATTR:host                 | node1                                                    |\n| OS-EXT-SRV-ATTR:hypervisor_hostname  | node1.example.org                                        |\n| OS-EXT-SRV-ATTR:instance_name        | instance-00000034                                        |\n| OS-EXT-STS:power_state               | 1                                                        |\n| OS-EXT-STS:task_state                | migrating                                                |\n| OS-EXT-STS:vm_state                  | active                                                  \n\n\nA Few minutes later, vm_state is in 'error' and a stack trace can be seen\n$ nova show 0386d6cf-edf8-42b8-998f-54103ba675fe\n...\n...SNIP\n........\n fault  {\"message\": \"Unable to establish connection to http://192.168.1.34:9696/v2.0/ports/dd042ee1-77c0-4c52-b5ea-9b5fbdd02860.json\", \"code\": 500, \"details\": \"  File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 375, in decorated_function \n            return function(self, context, *args, **kwargs)\n          File \\\"/usr/lib/python2.7/dist-packages/nova/compute/manager.py\\\", line 5571, in post_live_migration_at_destination             \n            migration)      \n          File \\\"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\\\", line 1577, in migrate_instance_finish \n            migration['dest_compute'])       \n          File \\\"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\\\", line 1886, in _update_port_binding_for_instance        \n            p['id'], instance=instance)      \n          File \\\"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 220, in __exit__          \n            self.force_reraise()             \n          File \\\"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py\\\", line 196, in force_reraise     \n            six.reraise(self.type_, self.value, self.tb)   \n          File \\\"/usr/lib/python2.7/dist-packages/nova/network/neutronv2/api.py\\\", line 1882, in _update_port_binding_for_instance        \n            {'port': {'binding:host_id': host}})           \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\\\", line 97, in with_params  \n            ret = self.function(instance, *args, **kwargs) \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\\\", line 659, in update_port \n            return self.put(self.port_path % (port), body=body)             \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\\\", line 367, in put         \n            headers=headers, params=params)  \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\\\", line 335, in retry_request             \n            headers=headers, params=params)  \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/v2_0/client.py\\\", line 286, in do_request  \n            resp, replybody = self.httpclient.do_request(action, method, body=body)       \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/client.py\\\", line 306, in do_request       \n            return self.request(url, method, **kwargs)     \n          File \\\"/usr/lib/python2.7/dist-packages/neutronclient/client.py\\\", line 294, in request          \n            resp = super(SessionClient, self).request(*args, **kwargs)      \n          File \\\"/usr/lib/python2.7/dist-packages/keystoneauth1/adapter.py\\\", line 98, in request          \n            return self.session.request(url, method, **kwargs)              \n          File \\\"/usr/lib/python2.7/dist-packages/positional/__init__.py\\\", line 94, in inner              \n            return func(*args, **kwargs)     \n          File \\\"/usr/lib/python2.7/dist-packages/keystoneauth1/session.py\\\", line 452, in request         \n            resp = send(**kwargs)            \n          File \\\"/usr/lib/python2.7/dist-packages/keystoneauth1/session.py\\\", line 496, in _send_request   \n            raise exceptions.ConnectFailure(msg)           \n        \", \"created\": \"2016-10-26T22:54:10Z\"}                    \n\n\nExpected result\n===============\n'host' and 'hypervisor_hostname' should be updated to the destination compute node.\n\n\nEnvironment\n===========\nUbuntu 16.04\nOpenstack Mitaka\n  Nova 13.1.1\n  Neutron 8.1.2\n    + Calico driver 1.3.0", 
            "date_created": "2016-11-02 14:31:54.434813+00:00", 
            "author": "https://api.launchpad.net/1.0/~shaner"
        }, 
        {
            "content": "I feel this bug might be related to this https://bugs.launchpad.net/nova/+bug/1628606.", 
            "date_created": "2017-01-19 17:51:37.384875+00:00", 
            "author": "https://api.launchpad.net/1.0/~siva-radhakrishnan"
        }, 
        {
            "content": "Marking this bug as invalid in favor of bugs #1685340 and #1662626 with respective commits https://review.openstack.org/#/c/458958/ and https://review.openstack.org/#/c/457023/ .\n\nThe most we can hope for in a situation such as this is that the true state is reflected to the user/operator which the referenced bugs/commits achieve.", 
            "date_created": "2017-06-02 19:04:21.857790+00:00", 
            "author": "https://api.launchpad.net/1.0/~shaner"
        }
    ], 
    "closed": "2017-06-02 19:04:39.396171+00:00"
}