{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:54:15.497716+00:00", 
    "description": "#1438226 reported that CPU pinning was broken in select versions of libvirt. Further investigation has highlighted issues with NUMA tuning in general on these versions. On some versions of libvirt, the same error messages seen when configuring CPU pinning are seen when configuring NUMA tuning (e.g. with use of the 'hw:numa-nodes' flavor key). This would suggest that the entire NUMA tuning feature is broken on these versions, rather than just CPU pinning. The results from testing, mostly duplicated from the aforementioned bug report, are given below.\n\nThis is somewhat related to #1422775 (\"nova libvirt driver assumes qemu support for NUMA pinning\").\n\n---\n\n# Testing Configuration\n\nTesting was conducted in a container which provided a single-node, Fedora 21-based (3.17.8-300.fc21.x86_64) OpenStack instance (built with devstack). The yum-provided libvirt and its dependencies were removed and libvirt and libvirt-python were built and installed from source.\n\n# Results\n\nThe results are as follows (currently incomplete):\n\n\u00a0\u00a0\u00a0\u00a0versions  status\n\u00a0\u00a0\u00a0\u00a0--------  ------\n\u00a0\u00a0\u00a0\u00a01.2.9     ok\n\u00a0\u00a0\u00a0\u00a01.2.9.1   ok\n\u00a0\u00a0\u00a0\u00a01.2.9.2   fail\n    1.2.9.3   ok\n\u00a0\u00a0\u00a0\u00a01.2.10    ok\n\u00a0\u00a0\u00a0\u00a01.2.11    ok\n\u00a0\u00a0\u00a0\u00a01.2.12    ok\n\nv1.2.9.2 is broken by this (backported) patch:\n\n\u00a0\u00a0\u00a0\u00a0https://www.redhat.com/archives/libvir-list/2014-November/msg00275.html\n\nThis can be seen as commit\n\n\u00a0\u00a0\u00a0\u00a0e226772 (qemu: fix domain startup failing with 'strict' mode in numatune)\n\n# Error logs\n\nv1.2.9.2 produces the following exception:\n\n\u00a0\u00a0\u00a0\u00a0Traceback (most recent call last):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 2301, in _build_resources\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0yield resources\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 2171, in _build_and_run_instance\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0flavor=flavor)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2357, in spawn\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0block_device_info=block_device_info)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4376, in _create_domain_and_network\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0power_on=power_on)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4307, in _create_domain\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0LOG.error(err)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 82, in __exit__\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0six.reraise(self.type_, self.value, self.tb)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4297, in _create_domain\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0domain.createWithFlags(launch_flags)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0result = proxy_call(self._autowrap, f, *args, **kwargs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0rv = execute(f, *args, **kwargs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0six.reraise(c, e, tb)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0rv = meth(*args, **kwargs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1029, in createWithFlags\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\n\u00a0\u00a0\u00a0\u00a0libvirtError: Failed to create controller cpu for group: No such file or directory", 
    "tags": [
        "libvirt"
    ], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1449028", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1449028, 
    "index": 6786, 
    "openned": "2015-04-27 13:15:59.278538+00:00", 
    "created": "2015-04-27 13:15:59.278538+00:00", 
    "title": "NUMA tuning broken in select libvirt versions", 
    "comments": [
        {
            "content": "#1438226 reported that CPU pinning was broken in select versions of libvirt. Further investigation has highlighted issues with NUMA tuning in general on these versions. The same error messages seen with when configuring CPU pinning are seen when configuring NUMA tuning. The results from testing, mostly duplicated from the aforementioned bug report, are given below. Note that v1.2.10 is still being tested at this time.\n\nThis is somewhat related to #1422775 (\"nova libvirt driver assumes qemu support for NUMA pinning\").\n\n---\n\n# Testing Configuration\n\nTesting was conducted in a container which provided a single-node, Fedora 21-based (3.17.8-300.fc21.x86_64) OpenStack instance (built with devstack). The yum-provided libvirt and its dependencies were removed and libvirt and libvirt-python were built and installed from source.\n\n# Results\n\nThe results are as follows (currently incomplete):\n\n\u00a0\u00a0\u00a0\u00a0versions  status\n\u00a0\u00a0\u00a0\u00a0--------  ------\n\u00a0\u00a0\u00a0\u00a01.2.9     ok\n\u00a0\u00a0\u00a0\u00a01.2.9.1   ok\n\u00a0\u00a0\u00a0\u00a01.2.9.2   fail\n\u00a0\u00a0\u00a0\u00a01.2.10    ???\n\u00a0\u00a0\u00a0\u00a01.2.11    ok\n\u00a0\u00a0\u00a0\u00a01.2.12    ok\n\nv1.2.9.2 is broken by this (backported) patch:\n\n\u00a0\u00a0\u00a0\u00a0https://www.redhat.com/archives/libvir-list/2014-November/msg00275.html\n\nThis can be seen as commit\n\n\u00a0\u00a0\u00a0\u00a0e226772 (qemu: fix domain startup failing with 'strict' mode in numatune)\n\n# Error logs\n\nv1.2.9.2 produces the following exception:\n\n\u00a0\u00a0\u00a0\u00a0Traceback (most recent call last):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 2301, in _build_resources\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0yield resources\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/compute/manager.py\", line 2171, in _build_and_run_instance\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0flavor=flavor)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 2357, in spawn\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0block_device_info=block_device_info)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4376, in _create_domain_and_network\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0power_on=power_on)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4307, in _create_domain\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0LOG.error(err)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/oslo_utils/excutils.py\", line 82, in __exit__\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0six.reraise(self.type_, self.value, self.tb)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/opt/stack/nova/nova/virt/libvirt/driver.py\", line 4297, in _create_domain\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0domain.createWithFlags(launch_flags)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 183, in doit\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0result = proxy_call(self._autowrap, f, *args, **kwargs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 141, in proxy_call\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0rv = execute(f, *args, **kwargs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 122, in execute\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0six.reraise(c, e, tb)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib/python2.7/site-packages/eventlet/tpool.py\", line 80, in tworker\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0rv = meth(*args, **kwargs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0File \"/usr/lib64/python2.7/site-packages/libvirt.py\", line 1029, in createWithFlags\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if ret == -1: raise libvirtError ('virDomainCreateWithFlags() failed', dom=self)\n\u00a0\u00a0\u00a0\u00a0libvirtError: Failed to create controller cpu for group: No such file or directory", 
            "date_created": "2015-04-27 13:15:59.278538+00:00", 
            "author": "https://api.launchpad.net/1.0/~stephenfinucane"
        }, 
        {
            "content": "You currently have this open as a security bug, indicating you believe it represents an exploitable vulnerability in the software. Can you elaborate on the circumstances under which this bug might be exploited by a malicious actor, and the risks it implies?", 
            "date_created": "2015-04-27 18:12:30.522782+00:00", 
            "author": "https://api.launchpad.net/1.0/~tristan-cacqueray"
        }, 
        {
            "content": "As far as i can tell this bug has no security implications.\n I must have mis clicked something.\nSorry about that.", 
            "date_created": "2015-04-28 08:53:23.458339+00:00", 
            "author": "https://api.launchpad.net/1.0/~pczesno"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/178188", 
            "date_created": "2015-04-28 13:29:10.823239+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Related fix proposed to branch: master\nReview: https://review.openstack.org/188427", 
            "date_created": "2015-06-04 14:53:37.609430+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/178188\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=7ca56106def7950aceecacf40b2ae8de7c846cb2\nSubmitter: Jenkins\nBranch:    master\n\ncommit 7ca56106def7950aceecacf40b2ae8de7c846cb2\nAuthor: Stephen Finucane <email address hidden>\nDate:   Thu Apr 23 14:01:10 2015 +0100\n\n    libvirt: Disable NUMA for broken libvirt\n    \n    Ensure versions of libvirt with broken NUMA tuning support are not used\n    for said feature.\n    \n    Change-Id: I6de388f1ca98c1ae16f2968f59881e3b0dba5f8d\n    Closes-Bug: #1449028\n    Related-Bug: #1438226\n", 
            "date_created": "2015-06-05 00:12:58.692417+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/188427\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=9efd47018dffc4c0f1f8f4d1b667b7b6744b01f5\nSubmitter: Jenkins\nBranch:    master\n\ncommit 9efd47018dffc4c0f1f8f4d1b667b7b6744b01f5\nAuthor: Matt Riedemann <email address hidden>\nDate:   Thu Jun 4 07:21:49 2015 -0700\n\n    libvirt: log when BAD_LIBVIRT_NUMA_VERSIONS detected\n    \n    This addresses a comment from the review on change\n    I6de388f1ca98c1ae16f2968f59881e3b0dba5f8d where we should log something\n    when a bad version of libvirt is detected for NUMA support.\n    \n    Since the method is called from periodic tasks and when new instances\n    are created, we only want to log the warning once.\n    \n    Related-Bug: #1449028\n    \n    Change-Id: I6d3526ac892532a7b15e994391b1e86a619aa9c3\n", 
            "date_created": "2015-08-12 05:42:43.276637+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-06-24 12:18:19.396439+00:00"
}