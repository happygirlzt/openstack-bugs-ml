{
    "status": "Invalid", 
    "last_updated": "2014-07-10 01:17:03.667440+00:00", 
    "description": "We have a openstack cluster which run  with nova-network in mulit-host mode  and the version is Folsom.\n\nYesterday, our server shutdown cause of power failure  and  boot  after the power recovered.\n\nThen we find one compute node ymy-r1-9 didn't bring up the bridge br100 and /var/lib/nova/networks/br100.conf is blank. Then I reboot the nova-network and find the br100's ip has changed from 192.168.2.14 to 192.168.2.29.\nIn ordinary,it should not be changed.\n\nWe look up in the nova/db/sqlalchemy/api.py:network_get_associated_fixed_ips, it has a param named host, if it's not None, then the function will return all the fix_ip of the vm on that  host. We have 8 vm running on that host, but actually it return None.\n\nAfter we look up the database,we find  the hostname has changed:\n\nmysql> select * from services;\n+---------------------+---------------------+------------+---------+----+---------------------+------------------+-------------+--------------+----------+-------------------+\n| created_at          | updated_at          | deleted_at | deleted | id | host                | binary           | topic       | report_count | disabled | availability_zone |\n+---------------------+---------------------+------------+---------+----+---------------------+------------------+-------------+--------------+----------+-------------------+\n| 2013-04-22 11:43:13 | 2013-04-29 09:14:59 | NULL       |       0 |  1 | ymy-r1-9            | nova-consoleauth | consoleauth |        62059 |        0 | nova              |\n| 2013-04-22 11:43:15 | 2013-04-29 09:14:59 | NULL       |       0 |  2 | ymy-r1-9            | nova-scheduler   | scheduler   |        62058 |        0 | nova              |\n| 2013-04-22 11:43:21 | 2013-04-29 09:14:59 | NULL       |       0 |  3 | ymy-r1-9            | nova-network     | network     |        61926 |        0 | nova              |\n| 2013-04-22 11:43:26 | 2013-04-29 09:14:59 | NULL       |       0 |  4 | ymy-r1-9            | nova-cert        | cert        |        62060 |        0 | nova              |\n| 2013-04-22 06:26:08 | 2013-05-02 07:11:14 | NULL       |       0 |  5 | ymy-r1-7.production.com | nova-compute     | compute     |        86015 |        0 | nova              |\n| 2013-04-22 06:26:09 | 2013-05-02 07:11:12 | NULL       |       0 |  6 | ymy-r1-7.production.com | nova-network     | network     |        86009 |        0 | nova              |\n| 2013-04-22 06:32:44 | 2013-05-02 07:11:18 | NULL       |       0 |  7 | ymy-r1-8            | nova-compute     | compute     |        85855 |        0 | nova              |\n| 2013-04-22 06:32:46 | 2013-05-02 07:11:14 | NULL       |       0 |  8 | ymy-r1-8            | nova-network     | network     |        85856 |        0 | nova              |\n| 2013-04-22 06:55:25 | 2013-04-29 09:14:59 | NULL       |       0 |  9 | ymy-r1-9            | nova-console     | console     |        60956 |        0 | nova              |\n| 2013-04-23 07:07:42 | 2013-04-29 09:15:00 | NULL       |       0 | 10 | ymy-r1-9            | nova-compute     | compute     |        52116 |        0 | nova              |\n| 2013-04-29 09:28:57 | 2013-05-02 07:11:12 | NULL       |       0 | 11 | ymy-r1-9.production.com   | nova-consoleauth | consoleauth |        24905 |        0 | nova              |\n| 2013-04-29 09:28:57 | 2013-05-02 07:11:14 | NULL       |       0 | 12 | ymy-r1-9.production.com | nova-cert        | cert        |        24906 |        0 | nova              |\n| 2013-04-29 09:28:57 | 2013-05-02 07:11:13 | NULL       |       0 | 13 | ymy-r1-9.production.com | nova-scheduler   | scheduler   |        24907 |        0 | nova              |\n| 2013-04-29 09:28:57 | 2013-05-02 07:11:12 | NULL       |       0 | 14 | ymy-r1-9.production.com | nova-compute     | compute     |        24886 |        0 | nova              |\n| 2013-04-29 09:28:59 | 2013-05-02 07:11:13 | NULL       |       0 | 15 | ymy-r1-9.production.com | nova-network     | network     |        24863 |        0 | nova              |\n+---------------------+---------------------+------------+---------+----+---------------------+------------------+-------------+--------------+----------+-------------------+\n\n\nThe hostname has changed from  ymy-r1-9 to ymy-r1-9.production.com.\n\nNow if we search the host by name 'ymy-r1-9':\nmysql> select * from instances where host='ymy-r1-9';\n....\n37 rows in set (0.00 sec)\n\nBut if we search the host by name 'ymy-r1-9.production.com':\n\nselect * from instances where host='ymy-r1-9.ustack.com';\nEmpty set (0.00 sec)\n\n\nSo that's the reason to lead nova-network doesn't work.\n\nAfter we find the reason, we feel puzzled why the host value  would change. This param is defined in the flags.py:\n\ncfg.StrOpt('host',\n               default=socket.gethostname(),\n               help='Name of this node.  This can be an opaque identifier.  '\n                    'It is not necessarily a hostname, FQDN, or IP address. '\n                    'However, the node name must be valid within '\n                    'an AMQP key, and if using ZeroMQ, a valid '\n                    'hostname, FQDN, or IP address'),\n\n\nIt use  socket.gethostname() method to get the hostname .\nI read the docs  on the http://docs.python.org/2/library/socket.html, it says:\n    Note: gethostname() doesn\u2019t always return the fully qualified domain name; use getfqdn()\n\nI try this in three servers,one value is hostname,and others are fqdn.\n\nSo I think it should use socket.getfqdn() to avoid this problem.", 
    "tags": [], 
    "importance": "Undecided", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1175483", 
    "owner": "https://api.launchpad.net/1.0/~yuxcer", 
    "id": 1175483, 
    "index": 4888, 
    "openned": "2013-05-02 07:28:08.470414+00:00", 
    "created": "2013-05-02 07:28:08.470414+00:00", 
    "title": "use socket.getfqdn()  to replace gethostname() for param host ", 
    "comments": [
        {
            "content": "We have a openstack cluster which run  with nova-network in mulit-host mode  and the version is Folsom.\n\nYesterday, our server shutdown cause of power failure  and  boot  after the power recovered.\n\nThen we find one compute node ymy-r1-9 didn't bring up the bridge br100 and /var/lib/nova/networks/br100.conf is blank. Then I reboot the nova-network and find the br100's ip has changed from 192.168.2.14 to 192.168.2.29.\nIn ordinary,it should not be changed.\n\nWe look up in the nova/db/sqlalchemy/api.py:network_get_associated_fixed_ips, it has a param named host, if it's not None, then the function will return all the fix_ip of the vm on that  host. We have 8 vm running on that host, but actually it return None.\n\nAfter we look up the database,we find  the hostname has changed:\n\nmysql> select * from services;\n+---------------------+---------------------+------------+---------+----+---------------------+------------------+-------------+--------------+----------+-------------------+\n| created_at          | updated_at          | deleted_at | deleted | id | host                | binary           | topic       | report_count | disabled | availability_zone |\n+---------------------+---------------------+------------+---------+----+---------------------+------------------+-------------+--------------+----------+-------------------+\n| 2013-04-22 11:43:13 | 2013-04-29 09:14:59 | NULL       |       0 |  1 | ymy-r1-9            | nova-consoleauth | consoleauth |        62059 |        0 | nova              |\n| 2013-04-22 11:43:15 | 2013-04-29 09:14:59 | NULL       |       0 |  2 | ymy-r1-9            | nova-scheduler   | scheduler   |        62058 |        0 | nova              |\n| 2013-04-22 11:43:21 | 2013-04-29 09:14:59 | NULL       |       0 |  3 | ymy-r1-9            | nova-network     | network     |        61926 |        0 | nova              |\n| 2013-04-22 11:43:26 | 2013-04-29 09:14:59 | NULL       |       0 |  4 | ymy-r1-9            | nova-cert        | cert        |        62060 |        0 | nova              |\n| 2013-04-22 06:26:08 | 2013-05-02 07:11:14 | NULL       |       0 |  5 | ymy-r1-7.production.com | nova-compute     | compute     |        86015 |        0 | nova              |\n| 2013-04-22 06:26:09 | 2013-05-02 07:11:12 | NULL       |       0 |  6 | ymy-r1-7.production.com | nova-network     | network     |        86009 |        0 | nova              |\n| 2013-04-22 06:32:44 | 2013-05-02 07:11:18 | NULL       |       0 |  7 | ymy-r1-8            | nova-compute     | compute     |        85855 |        0 | nova              |\n| 2013-04-22 06:32:46 | 2013-05-02 07:11:14 | NULL       |       0 |  8 | ymy-r1-8            | nova-network     | network     |        85856 |        0 | nova              |\n| 2013-04-22 06:55:25 | 2013-04-29 09:14:59 | NULL       |       0 |  9 | ymy-r1-9            | nova-console     | console     |        60956 |        0 | nova              |\n| 2013-04-23 07:07:42 | 2013-04-29 09:15:00 | NULL       |       0 | 10 | ymy-r1-9            | nova-compute     | compute     |        52116 |        0 | nova              |\n| 2013-04-29 09:28:57 | 2013-05-02 07:11:12 | NULL       |       0 | 11 | ymy-r1-9.production.com   | nova-consoleauth | consoleauth |        24905 |        0 | nova              |\n| 2013-04-29 09:28:57 | 2013-05-02 07:11:14 | NULL       |       0 | 12 | ymy-r1-9.production.com | nova-cert        | cert        |        24906 |        0 | nova              |\n| 2013-04-29 09:28:57 | 2013-05-02 07:11:13 | NULL       |       0 | 13 | ymy-r1-9.production.com | nova-scheduler   | scheduler   |        24907 |        0 | nova              |\n| 2013-04-29 09:28:57 | 2013-05-02 07:11:12 | NULL       |       0 | 14 | ymy-r1-9.production.com | nova-compute     | compute     |        24886 |        0 | nova              |\n| 2013-04-29 09:28:59 | 2013-05-02 07:11:13 | NULL       |       0 | 15 | ymy-r1-9.production.com | nova-network     | network     |        24863 |        0 | nova              |\n+---------------------+---------------------+------------+---------+----+---------------------+------------------+-------------+--------------+----------+-------------------+\n\n\nThe hostname has changed from  ymy-r1-9 to ymy-r1-9.production.com.\n\nNow if we search the host by name 'ymy-r1-9':\nmysql> select * from instances where host='ymy-r1-9';\n....\n37 rows in set (0.00 sec)\n\nBut if we search the host by name 'ymy-r1-9.production.com':\n\nselect * from instances where host='ymy-r1-9.ustack.com';\nEmpty set (0.00 sec)\n\n\nSo that's the reason to lead nova-network doesn't work.\n\nAfter we find the reason, we feel puzzled why the host value  would change. This param is defined in the flags.py:\n\ncfg.StrOpt('host',\n               default=socket.gethostname(),\n               help='Name of this node.  This can be an opaque identifier.  '\n                    'It is not necessarily a hostname, FQDN, or IP address. '\n                    'However, the node name must be valid within '\n                    'an AMQP key, and if using ZeroMQ, a valid '\n                    'hostname, FQDN, or IP address'),\n\n\nIt use  socket.gethostname() method to get the hostname .\nI read the docs  on the http://docs.python.org/2/library/socket.html, it says:\n    Note: gethostname() doesn\u2019t always return the fully qualified domain name; use getfqdn()\n\nI try this in three servers,one value is hostname,and others are fqdn.\n\nSo I think it should use socket.getfqdn() to avoid this problem.", 
            "date_created": "2013-05-02 07:28:08.470414+00:00", 
            "author": "https://api.launchpad.net/1.0/~yuxcer"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/28015", 
            "date_created": "2013-05-02 08:18:15.996035+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Workaround:\n    1. Setting a hostname which is persistent before install nova.\n    2. Remove any automated network-management tools(like NetworkManager, some DHCP clients)\n        that are able to reset the hostname.", 
            "date_created": "2014-04-23 05:15:01.671195+00:00", 
            "author": "https://api.launchpad.net/1.0/~wenjianhn"
        }, 
        {
            "content": "See discussion at https://review.openstack.org/#/c/28015/", 
            "date_created": "2014-07-10 01:16:52.405260+00:00", 
            "author": "https://api.launchpad.net/1.0/~jogo"
        }
    ], 
    "closed": "2014-07-10 01:17:00.953639+00:00"
}