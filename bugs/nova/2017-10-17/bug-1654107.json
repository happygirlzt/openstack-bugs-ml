{
    "status": "Fix Released", 
    "last_updated": "2017-02-27 20:29:29.119103+00:00", 
    "description": "Seen here:\n\nhttp://logs.openstack.org/65/416765/1/check/gate-tempest-dsvm-neutron-identity-v3-only-full-ubuntu-xenial-nv/faf1363/logs/screen-n-cpu.txt.gz#_2017-01-04_23_15_06_674\n\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager [req-832f822c-02b3-453b-b80b-61ad7f06f401 - -] Error updating resources for node ubuntu-xenial-osic-cloud1-disk-6483179.\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager Traceback (most recent call last):\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 6537, in update_available_resource_for_node\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     rt.update_available_resource(context, nodename)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/compute/resource_tracker.py\", line 540, in update_available_resource\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     self._update_available_resource(context, resources)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py\", line 271, in inner\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return f(*args, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/compute/resource_tracker.py\", line 564, in _update_available_resource\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     self._init_compute_node(context, resources)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/compute/resource_tracker.py\", line 451, in _init_compute_node\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     self.scheduler_client.update_resource_stats(self.compute_node)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/__init__.py\", line 60, in update_resource_stats\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     self.reportclient.update_resource_stats(compute_node)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/__init__.py\", line 37, in __run_method\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return getattr(self.instance, __name)(*args, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/report.py\", line 462, in update_resource_stats\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     compute_node.hypervisor_hostname)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/report.py\", line 282, in _ensure_resource_provider\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     rp = self._get_resource_provider(uuid)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/report.py\", line 47, in wrapper\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return f(self, *a, **k)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/report.py\", line 195, in _get_resource_provider\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     resp = self.get(\"/resource_providers/%s\" % uuid)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/report.py\", line 160, in get\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     endpoint_filter=self.ks_filter, raise_exc=False)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py\", line 710, in get\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return self.request(url, 'GET', **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/positional/__init__.py\", line 101, in inner\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return wrapped(*args, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py\", line 467, in request\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     auth_headers = self.get_auth_headers(auth)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py\", line 770, in get_auth_headers\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return auth.get_headers(self, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/plugin.py\", line 90, in get_headers\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     token = self.get_token(session)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/identity/base.py\", line 90, in get_token\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return self.get_access(session).auth_token\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/identity/base.py\", line 136, in get_access\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     self.auth_ref = self.get_auth_ref(session)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/identity/generic/base.py\", line 198, in get_auth_ref\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return self._plugin.get_auth_ref(session, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/identity/v3/base.py\", line 167, in get_auth_ref\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     authenticated=False, log=False, **rkwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py\", line 718, in post\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return self.request(url, 'POST', **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/positional/__init__.py\", line 101, in inner\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return wrapped(*args, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py\", line 607, in request\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     raise exceptions.from_response(resp, method, url)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager Unauthorized: The request you have made requires authentication. (HTTP 401) (Request-ID: req-38ce6df3-1dca-4b66-a680-d2691bb4955f)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager \n\nThe scheduler report client's safe_connect method isn't handle Unauthorized exceptions, which are happening in the keystone v3 jobs now with the placement API, at least until this devstack patch is merged:\n\nhttps://review.openstack.org/#/c/416599/\n\nWe handle Unauthorized in the new nova-status upgrade check command but not the safe_connect() decorator, which we need to do.", 
    "tags": [
        "compute", 
        "placement", 
        "scheduler"
    ], 
    "importance": "High", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1654107", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1654107, 
    "index": 2017, 
    "openned": "2017-01-05 00:36:29.688168+00:00", 
    "created": "2017-01-05 00:36:29.688168+00:00", 
    "title": "resource tracking fails with Unauthorized from placement API (keystone v3)", 
    "comments": [
        {
            "content": "Seen here:\n\nhttp://logs.openstack.org/65/416765/1/check/gate-tempest-dsvm-neutron-identity-v3-only-full-ubuntu-xenial-nv/faf1363/logs/screen-n-cpu.txt.gz#_2017-01-04_23_15_06_674\n\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager [req-832f822c-02b3-453b-b80b-61ad7f06f401 - -] Error updating resources for node ubuntu-xenial-osic-cloud1-disk-6483179.\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager Traceback (most recent call last):\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/compute/manager.py\", line 6537, in update_available_resource_for_node\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     rt.update_available_resource(context, nodename)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/compute/resource_tracker.py\", line 540, in update_available_resource\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     self._update_available_resource(context, resources)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/oslo_concurrency/lockutils.py\", line 271, in inner\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return f(*args, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/compute/resource_tracker.py\", line 564, in _update_available_resource\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     self._init_compute_node(context, resources)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/compute/resource_tracker.py\", line 451, in _init_compute_node\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     self.scheduler_client.update_resource_stats(self.compute_node)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/__init__.py\", line 60, in update_resource_stats\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     self.reportclient.update_resource_stats(compute_node)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/__init__.py\", line 37, in __run_method\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return getattr(self.instance, __name)(*args, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/report.py\", line 462, in update_resource_stats\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     compute_node.hypervisor_hostname)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/report.py\", line 282, in _ensure_resource_provider\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     rp = self._get_resource_provider(uuid)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/report.py\", line 47, in wrapper\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return f(self, *a, **k)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/report.py\", line 195, in _get_resource_provider\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     resp = self.get(\"/resource_providers/%s\" % uuid)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/opt/stack/new/nova/nova/scheduler/client/report.py\", line 160, in get\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     endpoint_filter=self.ks_filter, raise_exc=False)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py\", line 710, in get\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return self.request(url, 'GET', **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/positional/__init__.py\", line 101, in inner\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return wrapped(*args, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py\", line 467, in request\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     auth_headers = self.get_auth_headers(auth)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py\", line 770, in get_auth_headers\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return auth.get_headers(self, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/plugin.py\", line 90, in get_headers\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     token = self.get_token(session)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/identity/base.py\", line 90, in get_token\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return self.get_access(session).auth_token\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/identity/base.py\", line 136, in get_access\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     self.auth_ref = self.get_auth_ref(session)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/identity/generic/base.py\", line 198, in get_auth_ref\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return self._plugin.get_auth_ref(session, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/identity/v3/base.py\", line 167, in get_auth_ref\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     authenticated=False, log=False, **rkwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py\", line 718, in post\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return self.request(url, 'POST', **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/positional/__init__.py\", line 101, in inner\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     return wrapped(*args, **kwargs)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager   File \"/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py\", line 607, in request\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager     raise exceptions.from_response(resp, method, url)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager Unauthorized: The request you have made requires authentication. (HTTP 401) (Request-ID: req-38ce6df3-1dca-4b66-a680-d2691bb4955f)\n2017-01-04 23:15:06.674 7096 ERROR nova.compute.manager \n\nThe scheduler report client's safe_connect method isn't handle Unauthorized exceptions, which are happening in the keystone v3 jobs now with the placement API, at least until this devstack patch is merged:\n\nhttps://review.openstack.org/#/c/416599/\n\nWe handle Unauthorized in the new nova-status upgrade check command but not the safe_connect() decorator, which we need to do.", 
            "date_created": "2017-01-05 00:36:29.688168+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "I've marked this high severity because what happens when we create the compute node record but fail to set free_disk_gb is the scheduler fails to update the HostState object and then we can't schedule anything.", 
            "date_created": "2017-01-05 00:38:45.317010+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/416810", 
            "date_created": "2017-01-05 02:13:40.274183+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/416810\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=180e6340a595ec047c59365465f36fed7a669ec3\nSubmitter: Jenkins\nBranch:    master\n\ncommit 180e6340a595ec047c59365465f36fed7a669ec3\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Jan 4 21:11:10 2017 -0500\n\n    Handle Unauthorized exception in report client's safe_connect()\n    \n    If nova is misconfigured for placement auth, as seen in:\n    \n    I6351c1b2ca7ea4448e13eb87455bff4058df4fa7\n    \n    Keystone returns an Unauthorized 401 exception which the\n    scheduler report client's safe_connect() method wasn't handling\n    and disabling future attempts to talk to the placement service.\n    \n    This patch adds that check to the report client. Note also that\n    we already check for this in the \"nova-status upgrade check\"\n    command.\n    \n    Change-Id: Id52de64528383de70fc5a8951dde764ba34e369d\n    Closes-Bug: #1654107\n", 
            "date_created": "2017-01-05 22:28:10.701192+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Fix proposed to branch: stable/newton\nReview: https://review.openstack.org/419216", 
            "date_created": "2017-01-12 00:32:19.426373+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/419216\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=9fb203f17e358760e9e40ef55ee79965343581f8\nSubmitter: Jenkins\nBranch:    stable/newton\n\ncommit 9fb203f17e358760e9e40ef55ee79965343581f8\nAuthor: Matt Riedemann <email address hidden>\nDate:   Wed Jan 4 21:11:10 2017 -0500\n\n    Handle Unauthorized exception in report client's safe_connect()\n    \n    If nova is misconfigured for placement auth, as seen in:\n    \n    I6351c1b2ca7ea4448e13eb87455bff4058df4fa7\n    \n    Keystone returns an Unauthorized 401 exception which the\n    scheduler report client's safe_connect() method wasn't handling\n    and disabling future attempts to talk to the placement service.\n    \n    This patch adds that check to the report client. Note also that\n    we already check for this in the \"nova-status upgrade check\"\n    command.\n    \n    Change-Id: Id52de64528383de70fc5a8951dde764ba34e369d\n    Closes-Bug: #1654107\n    (cherry picked from commit 180e6340a595ec047c59365465f36fed7a669ec3)\n", 
            "date_created": "2017-01-13 22:16:52.394494+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 15.0.0.0b3 development milestone.", 
            "date_created": "2017-01-27 00:51:51.676589+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 14.0.4 release.", 
            "date_created": "2017-02-27 20:29:28.535735+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-01-05 22:28:08.348242+00:00"
}