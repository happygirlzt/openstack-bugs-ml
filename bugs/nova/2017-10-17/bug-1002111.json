{
    "status": "Fix Released", 
    "last_updated": "2012-11-07 20:17:19.444038+00:00", 
    "description": "When starting nova-api I get the below error in nova-api.log\n\nI'm running the latest packages in Ubuntu 12.04. \n\nThe server is running the following nova services:\nnova-api\nnova-cert\nnova-scheduler\nnova-consoleauth\n\nNot sure why it is trying to do iptables commands?\n\nCheers,\nSam\n\n\n2012-05-21 12:22:58 DEBUG nova.utils [-] Attempting to grab semaphore \"iptables\" for method \"apply\"... from (pid=27739) inner /usr/lib/python2.7/dist-packages/nova/utils.py:927\n2012-05-21 12:22:58 DEBUG nova.utils [-] Got semaphore \"iptables\" for method \"apply\"... from (pid=27739) inner /usr/lib/python2.7/dist-packages/nova/utils.py:931\n2012-05-21 12:22:58 DEBUG nova.utils [-] Attempting to grab file lock \"iptables\" for method \"apply\"... from (pid=27739) inner /usr/lib/python2.7/dist-packages/nova/utils.py:935\n2012-05-21 12:22:58 DEBUG nova.utils [-] Got file lock \"iptables\" for method \"apply\"... from (pid=27739) inner /usr/lib/python2.7/dist-packages/nova/utils.py:942\n2012-05-21 12:22:58 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/bin/nova-rootwrap iptables-save -t filter from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:219\nException AssertionError: AssertionError() in <module 'threading' from '/usr/lib/python2.7/threading.pyc'> ignored\n2012-05-21 12:22:58 DEBUG nova.utils [-] Result was 99 from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:235\n2012-05-21 12:22:58 DEBUG nova.utils [-] ['sudo', '/usr/bin/nova-rootwrap', 'iptables-save', '-t', 'filter'] failed. Retrying. from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:248\n2012-05-21 12:22:59 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/bin/nova-rootwrap iptables-save -t filter from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:219\nException AssertionError: AssertionError() in <module 'threading' from '/usr/lib/python2.7/threading.pyc'> ignored\n2012-05-21 12:22:59 DEBUG nova.utils [-] Result was 99 from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:235\n2012-05-21 12:22:59 DEBUG nova.utils [-] ['sudo', '/usr/bin/nova-rootwrap', 'iptables-save', '-t', 'filter'] failed. Retrying. from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:248\n2012-05-21 12:23:01 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/bin/nova-rootwrap iptables-save -t filter from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:219\nException AssertionError: AssertionError() in <module 'threading' from '/usr/lib/python2.7/threading.pyc'> ignored\n2012-05-21 12:23:01 DEBUG nova.utils [-] Result was 99 from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:235\n2012-05-21 12:23:01 DEBUG nova.utils [-] ['sudo', '/usr/bin/nova-rootwrap', 'iptables-save', '-t', 'filter'] failed. Retrying. from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:248\n2012-05-21 12:23:03 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/bin/nova-rootwrap iptables-save -t filter from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:219\nException AssertionError: AssertionError() in <module 'threading' from '/usr/lib/python2.7/threading.pyc'> ignored\n2012-05-21 12:23:03 DEBUG nova.utils [-] Result was 99 from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:235\n2012-05-21 12:23:03 DEBUG nova.utils [-] ['sudo', '/usr/bin/nova-rootwrap', 'iptables-save', '-t', 'filter'] failed. Retrying. from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:248\n2012-05-21 12:23:04 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/bin/nova-rootwrap iptables-save -t filter from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:219\nException AssertionError: AssertionError() in <module 'threading' from '/usr/lib/python2.7/threading.pyc'> ignored\n2012-05-21 12:23:04 DEBUG nova.utils [-] Result was 99 from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:235\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 336, in fire_timers\n    timer()\n  File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n    cb(*args, **kw)\n  File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n    result = function(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 101, in run_server\n    server.start()\n  File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 366, in start\n    self.manager.init_host()\n  File \"/usr/lib/python2.7/dist-packages/nova/api/manager.py\", line 42, in init_host\n    self.network_driver.metadata_accept()\n  File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 424, in metadata_accept\n    iptables_manager.apply()\n  File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 943, in inner\n    retval = f(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 328, in apply\n    attempts=5)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 812, in _execute\n    return utils.execute(*cmd, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 242, in execute\n    cmd=' '.join(cmd))\nProcessExecutionError: Unexpected error while running command.\nCommand: sudo /usr/bin/nova-rootwrap iptables-save -t filter\nExit code: 99\nStdout: 'Unauthorized command: iptables-save -t filter\\n'\nStderr: 'sudo: unable to resolve host server-3093\\n'", 
    "tags": [
        "rootwrap"
    ], 
    "importance": "High", 
    "heat": 36, 
    "link": "https://bugs.launchpad.net/nova/+bug/1002111", 
    "owner": "https://api.launchpad.net/1.0/~ttx", 
    "id": 1002111, 
    "index": 687, 
    "openned": "2012-05-21 02:28:14.824221+00:00", 
    "created": "2012-05-21 02:28:14.824221+00:00", 
    "title": "iptables being run on a nova-api server", 
    "comments": [
        {
            "content": "When starting nova-api I get the below error in nova-api.log\n\nI'm running the latest packages in Ubuntu 12.04. \n\nThe server is running the following nova services:\nnova-api\nnova-cert\nnova-scheduler\nnova-consoleauth\n\nNot sure why it is trying to do iptables commands?\n\nCheers,\nSam\n\n\n2012-05-21 12:22:58 DEBUG nova.utils [-] Attempting to grab semaphore \"iptables\" for method \"apply\"... from (pid=27739) inner /usr/lib/python2.7/dist-packages/nova/utils.py:927\n2012-05-21 12:22:58 DEBUG nova.utils [-] Got semaphore \"iptables\" for method \"apply\"... from (pid=27739) inner /usr/lib/python2.7/dist-packages/nova/utils.py:931\n2012-05-21 12:22:58 DEBUG nova.utils [-] Attempting to grab file lock \"iptables\" for method \"apply\"... from (pid=27739) inner /usr/lib/python2.7/dist-packages/nova/utils.py:935\n2012-05-21 12:22:58 DEBUG nova.utils [-] Got file lock \"iptables\" for method \"apply\"... from (pid=27739) inner /usr/lib/python2.7/dist-packages/nova/utils.py:942\n2012-05-21 12:22:58 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/bin/nova-rootwrap iptables-save -t filter from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:219\nException AssertionError: AssertionError() in <module 'threading' from '/usr/lib/python2.7/threading.pyc'> ignored\n2012-05-21 12:22:58 DEBUG nova.utils [-] Result was 99 from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:235\n2012-05-21 12:22:58 DEBUG nova.utils [-] ['sudo', '/usr/bin/nova-rootwrap', 'iptables-save', '-t', 'filter'] failed. Retrying. from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:248\n2012-05-21 12:22:59 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/bin/nova-rootwrap iptables-save -t filter from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:219\nException AssertionError: AssertionError() in <module 'threading' from '/usr/lib/python2.7/threading.pyc'> ignored\n2012-05-21 12:22:59 DEBUG nova.utils [-] Result was 99 from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:235\n2012-05-21 12:22:59 DEBUG nova.utils [-] ['sudo', '/usr/bin/nova-rootwrap', 'iptables-save', '-t', 'filter'] failed. Retrying. from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:248\n2012-05-21 12:23:01 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/bin/nova-rootwrap iptables-save -t filter from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:219\nException AssertionError: AssertionError() in <module 'threading' from '/usr/lib/python2.7/threading.pyc'> ignored\n2012-05-21 12:23:01 DEBUG nova.utils [-] Result was 99 from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:235\n2012-05-21 12:23:01 DEBUG nova.utils [-] ['sudo', '/usr/bin/nova-rootwrap', 'iptables-save', '-t', 'filter'] failed. Retrying. from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:248\n2012-05-21 12:23:03 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/bin/nova-rootwrap iptables-save -t filter from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:219\nException AssertionError: AssertionError() in <module 'threading' from '/usr/lib/python2.7/threading.pyc'> ignored\n2012-05-21 12:23:03 DEBUG nova.utils [-] Result was 99 from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:235\n2012-05-21 12:23:03 DEBUG nova.utils [-] ['sudo', '/usr/bin/nova-rootwrap', 'iptables-save', '-t', 'filter'] failed. Retrying. from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:248\n2012-05-21 12:23:04 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/bin/nova-rootwrap iptables-save -t filter from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:219\nException AssertionError: AssertionError() in <module 'threading' from '/usr/lib/python2.7/threading.pyc'> ignored\n2012-05-21 12:23:04 DEBUG nova.utils [-] Result was 99 from (pid=27739) execute /usr/lib/python2.7/dist-packages/nova/utils.py:235\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py\", line 336, in fire_timers\n    timer()\n  File \"/usr/lib/python2.7/dist-packages/eventlet/hubs/timer.py\", line 56, in __call__\n    cb(*args, **kw)\n  File \"/usr/lib/python2.7/dist-packages/eventlet/greenthread.py\", line 192, in main\n    result = function(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 101, in run_server\n    server.start()\n  File \"/usr/lib/python2.7/dist-packages/nova/service.py\", line 366, in start\n    self.manager.init_host()\n  File \"/usr/lib/python2.7/dist-packages/nova/api/manager.py\", line 42, in init_host\n    self.network_driver.metadata_accept()\n  File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 424, in metadata_accept\n    iptables_manager.apply()\n  File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 943, in inner\n    retval = f(*args, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 328, in apply\n    attempts=5)\n  File \"/usr/lib/python2.7/dist-packages/nova/network/linux_net.py\", line 812, in _execute\n    return utils.execute(*cmd, **kwargs)\n  File \"/usr/lib/python2.7/dist-packages/nova/utils.py\", line 242, in execute\n    cmd=' '.join(cmd))\nProcessExecutionError: Unexpected error while running command.\nCommand: sudo /usr/bin/nova-rootwrap iptables-save -t filter\nExit code: 99\nStdout: 'Unauthorized command: iptables-save -t filter\\n'\nStderr: 'sudo: unable to resolve host server-3093\\n'", 
            "date_created": "2012-05-21 02:28:14.824221+00:00", 
            "author": "https://api.launchpad.net/1.0/~sorrison"
        }, 
        {
            "content": "It's setting up iptables rules for the metadata service, which is considered to be a part of nova-api. I put some debugging code into the function metadata_accept and here's the rule which is set up by nova-api upon restart:\n\nDEBUG nova.network.linux_net [-] INPUT -s 0.0.0.0/0 -d 10.0.2.15 -p tcp -m tcp --dport 8775 -j ACCEPT from (pid=18013) metadata_accept /opt/stack/nova/nova/network/linux_net.py:426\n\nBut the bug is definitely there. It refers to nova-rootwrap script.\n\nFrom the log you posted, it can be seen that this script fails in case of applying \"iptables-save\" commands. This is because nova-rootwrap uses internal filters for commands ran as root. The filters for iptables are defined here:\n/usr/lib/python2.7/dist-packages/nova/rootwrap/network.py\n\nIf you copy this file over to your nova-api server, the iptables should succeed.\n\nBut in general - it should not work this way - one should have a separate policy file called: \n\n/usr/lib/python2.7/dist-packages/nova/rootwrap/api.py\n\nThere's no such file - so I guess it's reasonable to vote for a bug here!", 
            "date_created": "2012-06-06 22:59:00.632321+00:00", 
            "author": "https://api.launchpad.net/1.0/~psiwczak"
        }, 
        {
            "content": "Just to add some clarification: \n\nrootwrap/network.py normally resides on nova-network node", 
            "date_created": "2012-06-06 23:03:10.146118+00:00", 
            "author": "https://api.launchpad.net/1.0/~psiwczak"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/8293", 
            "date_created": "2012-06-07 19:07:23.920748+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "So does this mean that nova controls iptables on an api host? If so is it possible to disable? \n\nWe run our own firewall on our infrastructure nodes and would rather not have nova touching them.\n\n", 
            "date_created": "2012-06-07 23:17:56.966503+00:00", 
            "author": "https://api.launchpad.net/1.0/~sorrison"
        }, 
        {
            "content": "Sam,\n\nIt seems to be controlling only entry for local metadata service:\nINPUT -s 0.0.0.0/0 -d 10.0.2.15 -p tcp -m tcp --dport 8775 -j ACCEPT\n\n", 
            "date_created": "2012-06-07 23:31:14.392783+00:00", 
            "author": "https://api.launchpad.net/1.0/~psiwczak"
        }, 
        {
            "content": "It is actually only used to create an input allow rule for the metadata server.\n\nIf you run nova-api without metadata in enabled apis (the default) it does not do anything\n\nit is needed for nova-api if you enable the metdata server in enabled_apis or when running nova-api-metadata", 
            "date_created": "2012-06-07 23:31:54.769312+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "Vish: It was kinda good that nova-api was not able to run *any* command as root. For the future could it be a better solution to completely separate nova-api from nova-metadata and allow only the latter to run commands as root ?", 
            "date_created": "2012-06-08 07:54:07.655207+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Thierry, they already run separately by default, perhaps it makes more sense to rename rootwrap/api.py to rootwrap/metadata.py or rootwrap/api-metadata.py to make it clear that it needs to be installed with nova-api-metadata ? ", 
            "date_created": "2012-06-10 19:57:29.161858+00:00", 
            "author": "https://api.launchpad.net/1.0/~vishvananda"
        }, 
        {
            "content": "It's a bit of a packaging issue, actually.\n\nIf nova-api could only specify a single API and was always installed as a nova-api-ec2, nova-api-osapi or nova-api-metadata package, then we could ship api-metadata.py only with nova-api-metadata...\n\nBut as long as you allow a single nova-api to run with \"metadata\" as one of its enabled api you kinda need to ship api-metadata.py within the \"nova-api\" package, just in case...\n\nThis is all packaging though, so we should just have a \"api-metadata.py\" and leave it to distros to deploy it only with nova-api--metadata packages.\n\nThe only question left on our side is... should we actually really support multiple enabled APIs on a single nova-api... or should we force them (or strongle encourage them) to run as separate nova-api-ec2/nova-api-osapi/nova-api-metadata, which means support only one enabled API at a time. From a security standpoint, that would definitely be a win if we encouraged those to be separate, if -metadata needs root access whereas -osapi and -ec2 do not.\n\n", 
            "date_created": "2012-06-11 09:13:55.675478+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/10222", 
            "date_created": "2012-07-24 15:07:58.659184+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "When the change hits Nova, it needs to be packaged: api-metadata.filters needs to be deployed with nova-api binary.", 
            "date_created": "2012-07-24 15:08:35.773797+00:00", 
            "author": "https://api.launchpad.net/1.0/~ttx"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/10222\nCommitted: http://github.com/openstack/nova/commit/6c888001f15fba44aaaaaf367757dd81b8512f65\nSubmitter: Jenkins\nBranch:    master\n\ncommit 6c888001f15fba44aaaaaf367757dd81b8512f65\nAuthor: Thierry Carrez <email address hidden>\nDate:   Tue Jul 24 17:03:13 2012 +0200\n\n    Provide rootwrap filters for nova-api-metadata\n    \n    The metadata service in nova-api needs access to\n    ip[6]tables-{save-restore} to accept connections to the\n    metadata service. This change adds an api-metadata.filters file\n    that needs to be deployed on setups running nova-api-metadata\n    or nova-api with \"metadata\" in enabled_apis.\n    \n    Fixes bug 1002111.\n    \n    Change-Id: I5aecb223876e12550394f31dbc7df893868baa8b\n", 
            "date_created": "2012-07-24 16:21:53.096536+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "FYI-\n\nAccording to flags.py, the metadata endpoint is enabled by default:\n\n    cfg.ListOpt('enabled_apis',\n                default=['ec2', 'osapi_compute', 'osapi_volume', 'metadata'],\n                help='a list of APIs to enable by default'),\n\nSo, on the packaging side we need to ship the filters with both nova-api and nova-api-metadata (the packages Conflict already due to port conflicts, anyway). ", 
            "date_created": "2012-07-25 23:27:07.499967+00:00", 
            "author": "https://api.launchpad.net/1.0/~gandelman-a"
        }, 
        {
            "content": "This bug was fixed in the package nova - 2012.2~f3-0ubuntu1\n\n---------------\nnova (2012.2~f3-0ubuntu1) quantal; urgency=low\n\n  [ Chuck Short ]\n  * New upstream version.\n  * debian/rules: Re-enable testsuite.\n  * debian/control:\n    - Add python-quantumclient as a build depends.\n    - Bump standards to 3.9.3\n    - Fix lintian warnings.\n    - Recommend python-glanceclient and python-keystoneclient.\n    - Add dependency of iptables for nova-network.\n  * debian/watch: Update\n  * debian/rules: Do not run pep8 tests since upstream is still using an\n    older pep8.\n  * debian/patches/0001-Update-tools-hacking-for-pep8-1.2-and-\n    beyond.patch: Get the testsuite running again.\n  * debian/nova-volume.install, debian/nova_tgt: Add support for\n    persistent volumes.\n\n  [ Adam Gandelman ]\n  * debian/{nova-api.install, nova-api-metadata.install}: Install\n    api-metadata.filters. (LP: #1002111)\n  * debian/control: Added python-glanceclient.\n -- Chuck Short <email address hidden>   Thu, 16 Aug 2012 14:04:11 -0500", 
            "date_created": "2012-08-17 16:00:37.765289+00:00", 
            "author": "https://api.launchpad.net/1.0/~janitor"
        }
    ], 
    "closed": "2012-08-16 07:32:15.172363+00:00"
}