{
    "status": "Fix Released", 
    "last_updated": "2017-04-14 09:24:15.523302+00:00", 
    "description": "The libvirt driver attempts to quiece the filesystem when doing a volume snapshot and will stacktrace if the qemu guest agent is not available:\n\nhttp://logs.openstack.org/86/147186/41/experimental/gate-tempest-dsvm-full-devstack-plugin-nfs-nv/fe58d89/logs/screen-n-cpu.txt.gz?level=TRACE#_2016-09-30_10_36_32_039\n\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [req-93930c3c-4482-4c30-97ad-4dbcd251a9ba nova service] [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08] Unable to create quiesced VM snapshot, attempting again with quiescing disabled.\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08] Traceback (most recent call last):\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 1827, in _volume_snapshot_create\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     reuse_ext=True, quiesce=True)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/opt/stack/new/nova/nova/virt/libvirt/guest.py\", line 508, in snapshot\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     self._domain.snapshotCreateXML(conf.to_xml(), flags=flags)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     rv = execute(f, *args, **kwargs)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     six.reraise(c, e, tb)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     rv = meth(*args, **kwargs)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 2592, in snapshotCreateXML\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     if ret is None:raise libvirtError('virDomainSnapshotCreateXML() failed', dom=self)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08] libvirtError: \n\nThe volume snapshot method then goes on to snapshot the guest without quiescing first.\n\nWe shouldn't stacktrace an error on this, we should dump a warning in the logs at most.", 
    "tags": [
        "libvirt", 
        "snapshot"
    ], 
    "importance": "Medium", 
    "heat": 8, 
    "link": "https://bugs.launchpad.net/nova/+bug/1629371", 
    "owner": "https://api.launchpad.net/1.0/~mriedem", 
    "id": 1629371, 
    "index": 4639, 
    "openned": "2016-09-30 15:43:50.116824+00:00", 
    "created": "2016-09-30 15:43:50.116824+00:00", 
    "title": "libvirt: volume snapshot stacktraces if the qemu guest agent is not available", 
    "comments": [
        {
            "content": "The libvirt driver attempts to quiece the filesystem when doing a volume snapshot and will stacktrace if the qemu guest agent is not available:\n\nhttp://logs.openstack.org/86/147186/41/experimental/gate-tempest-dsvm-full-devstack-plugin-nfs-nv/fe58d89/logs/screen-n-cpu.txt.gz?level=TRACE#_2016-09-30_10_36_32_039\n\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [req-93930c3c-4482-4c30-97ad-4dbcd251a9ba nova service] [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08] Unable to create quiesced VM snapshot, attempting again with quiescing disabled.\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08] Traceback (most recent call last):\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/opt/stack/new/nova/nova/virt/libvirt/driver.py\", line 1827, in _volume_snapshot_create\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     reuse_ext=True, quiesce=True)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/opt/stack/new/nova/nova/virt/libvirt/guest.py\", line 508, in snapshot\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     self._domain.snapshotCreateXML(conf.to_xml(), flags=flags)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 186, in doit\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     result = proxy_call(self._autowrap, f, *args, **kwargs)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 144, in proxy_call\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     rv = execute(f, *args, **kwargs)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 125, in execute\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     six.reraise(c, e, tb)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/usr/local/lib/python2.7/dist-packages/eventlet/tpool.py\", line 83, in tworker\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     rv = meth(*args, **kwargs)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]   File \"/usr/local/lib/python2.7/dist-packages/libvirt.py\", line 2592, in snapshotCreateXML\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08]     if ret is None:raise libvirtError('virDomainSnapshotCreateXML() failed', dom=self)\n2016-09-30 10:36:32.039 10790 ERROR nova.virt.libvirt.driver [instance: 01211c7e-b3ac-4d17-80bb-30fbe8494c08] libvirtError: \n\nThe volume snapshot method then goes on to snapshot the guest without quiescing first.\n\nWe shouldn't stacktrace an error on this, we should dump a warning in the logs at most.", 
            "date_created": "2016-09-30 15:43:50.116824+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Furthermore, it looks like there is an optional os_require_quiesce image metadata property and we don't check that, so if the image the instance was booted with says it requires quiesce, and we can't do it, we shouldn't try to snapshot w/o quiescing first.", 
            "date_created": "2016-09-30 15:49:09.156498+00:00", 
            "author": "https://api.launchpad.net/1.0/~mriedem"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/380433", 
            "date_created": "2016-09-30 16:21:48.552430+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/380433\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=e659a6e7cbb3078b47c0860465530eab05acf73e\nSubmitter: Jenkins\nBranch:    master\n\ncommit e659a6e7cbb3078b47c0860465530eab05acf73e\nAuthor: Matt Riedemann <email address hidden>\nDate:   Fri Sep 30 12:16:41 2016 -0400\n\n    libvirt: check if we can quiesce before volume-backed snapshot\n    \n    The NFS job in the experimental queue is stacktracing when taking\n    a volume-backed snapshot because the image used in the job does\n    not have the qemu guest agent in it. This is not fatal because the\n    code just continues to snapshot without quiesce.\n    \n    Since we have code that can tell if we can even attempt a quiesce\n    we should use that here before attempting the snapshot with quiesce,\n    else don't even attempt it so we don't stacktrace.\n    \n    Note that this also adds a check such that if the image requires\n    quiesce as part of a snapshot and we can't honor that, we fail.\n    \n    The stacktrace is intentionally left in here in case the snapshot\n    with quiesce fails because we checked if we could and only get to\n    that point if we should be able to quiesce but it failed, which\n    is an error that should be investigated.\n    \n    Also, the unused quiesce parameter is removed from the\n    test_volume_snapshot_create_libgfapi test while in this code.\n    \n    Change-Id: I685c592340dc8a3b7d32834a0114f2925dc4305c\n    Closes-Bug: #1629371\n", 
            "date_created": "2017-03-07 18:53:45.192002+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "This issue was fixed in the openstack/nova 16.0.0.0b1 development milestone.", 
            "date_created": "2017-04-14 09:24:14.706359+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2017-03-07 18:53:38.114921+00:00"
}