{
    "status": "Fix Released", 
    "last_updated": "2015-10-15 08:52:14.730726+00:00", 
    "description": "disconnect_volume in class LibvirtFibreChannelVolumeDriver calls  linuxscsi.find_multipath_device but does not handle the potential return of None (eg if the multipath device does not exist)\n\nhttps://git.openstack.org/cgit/openstack/nova/tree/nova/virt/libvirt/volume.py?id=1469c8e14267e27ecc6ced29c91dc1506ce26633#n992\n\nhttps://git.openstack.org/cgit/openstack/nova/tree/nova/storage/linuxscsi.py?id=1469c8e14267e27ecc6ced29c91dc1506ce26633#n91\n\n\nAdding the following to disconnect_volume resolved the issue for me:\n\n         if 'multipath_id' in connection_info['data']:\n             multipath_id = connection_info['data']['multipath_id']\n             mdev_info = linuxscsi.find_multipath_device(multipath_id)\n+            if mdev_info is None:\n+                return\n             devices = mdev_info['devices']\n             LOG.debug(\"devices to remove = %s\", devices)\n\n\nNova Logs from Juno \n\n2015-02-24 17:48:01.140 32199 AUDIT nova.service [-] Starting compute node (version 2014.2.1-1.el7.centos)\n2015-02-24 17:48:01.264 32199 INFO nova.compute.manager [-] [instance: 210f6191-a646-4bba-96ef-80df63d2df01] Deleting instance as its host (Compute-02.domain) is not equal to our host (Compute-01.domain).\n2015-02-24 17:48:01.826 32199 INFO nova.virt.libvirt.driver [-] [instance: 210f6191-a646-4bba-96ef-80df63d2df01] Instance destroyed successfully.\n2015-02-24 17:48:01.928 32199 ERROR nova.openstack.common.threadgroup [-] 'NoneType' object has no attribute '__getitem__'\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup Traceback (most recent call last):\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/threadgroup.py\", line 125, in wait\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     x.wait()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/threadgroup.py\", line 47, in wait\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return self.thread.wait()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 173, in wait\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return self._exit_event.wait()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/event.py\", line 121, in wait\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return hubs.get_hub().switch()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/hubs/hub.py\", line 293, in switch\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return self.greenlet.switch()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 212, in main\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     result = function(*args, **kwargs)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/service.py\", line 492, in run_service\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     service.start()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/service.py\", line 164, in start\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     self.manager.init_host()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 1137, in init_host\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     self._destroy_evacuated_instances(context)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 768, in _destroy_evacuated_instances\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     bdi, destroy_disks)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1056, in destroy\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     destroy_disks, migrate_data)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1164, in cleanup\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     instance=instance)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 82, in __exit__\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     six.reraise(self.type_, self.value, self.tb)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1153, in cleanup\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     self._disconnect_volume(connection_info, disk_dev)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1334, in _disconnect_volume\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return driver.disconnect_volume(connection_info, disk_dev)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/lockutils.py\", line 272, in inner\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return f(*args, **kwargs)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/volume.py\", line 1043, in disconnect_volume\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     devices = mdev_info['devices']\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup TypeError: 'NoneType' object has no attribute '__getitem__'", 
    "tags": [], 
    "importance": "Low", 
    "heat": 6, 
    "link": "https://bugs.launchpad.net/nova/+bug/1424968", 
    "owner": "https://api.launchpad.net/1.0/~dims-v", 
    "id": 1424968, 
    "index": 1548, 
    "openned": "2015-02-24 08:52:06.275168+00:00", 
    "created": "2015-02-24 08:52:06.275168+00:00", 
    "title": "unhandled return from linuxscsi.find_multipath_device in disconnect_volume", 
    "comments": [
        {
            "content": "disconnect_volume in class LibvirtFibreChannelVolumeDriver calls  linuxscsi.find_multipath_device but does not handle the potential return of None (eg if the multipath device does not exist)\n\nhttps://git.openstack.org/cgit/openstack/nova/tree/nova/virt/libvirt/volume.py?id=1469c8e14267e27ecc6ced29c91dc1506ce26633#n992\n\nhttps://git.openstack.org/cgit/openstack/nova/tree/nova/storage/linuxscsi.py?id=1469c8e14267e27ecc6ced29c91dc1506ce26633#n91\n\n\nAdding the following to disconnect_volume resolved the issue for me:\n\n         if 'multipath_id' in connection_info['data']:\n             multipath_id = connection_info['data']['multipath_id']\n             mdev_info = linuxscsi.find_multipath_device(multipath_id)\n+            if mdev_info is None:\n+                return\n             devices = mdev_info['devices']\n             LOG.debug(\"devices to remove = %s\", devices)\n\n\nNova Logs from Juno \n\n2015-02-24 17:48:01.140 32199 AUDIT nova.service [-] Starting compute node (version 2014.2.1-1.el7.centos)\n2015-02-24 17:48:01.264 32199 INFO nova.compute.manager [-] [instance: 210f6191-a646-4bba-96ef-80df63d2df01] Deleting instance as its host (Compute-02.domain) is not equal to our host (Compute-01.domain).\n2015-02-24 17:48:01.826 32199 INFO nova.virt.libvirt.driver [-] [instance: 210f6191-a646-4bba-96ef-80df63d2df01] Instance destroyed successfully.\n2015-02-24 17:48:01.928 32199 ERROR nova.openstack.common.threadgroup [-] 'NoneType' object has no attribute '__getitem__'\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup Traceback (most recent call last):\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/threadgroup.py\", line 125, in wait\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     x.wait()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/threadgroup.py\", line 47, in wait\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return self.thread.wait()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 173, in wait\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return self._exit_event.wait()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/event.py\", line 121, in wait\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return hubs.get_hub().switch()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/hubs/hub.py\", line 293, in switch\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return self.greenlet.switch()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/eventlet/greenthread.py\", line 212, in main\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     result = function(*args, **kwargs)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/service.py\", line 492, in run_service\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     service.start()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/service.py\", line 164, in start\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     self.manager.init_host()\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 1137, in init_host\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     self._destroy_evacuated_instances(context)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/compute/manager.py\", line 768, in _destroy_evacuated_instances\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     bdi, destroy_disks)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1056, in destroy\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     destroy_disks, migrate_data)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1164, in cleanup\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     instance=instance)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/excutils.py\", line 82, in __exit__\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     six.reraise(self.type_, self.value, self.tb)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1153, in cleanup\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     self._disconnect_volume(connection_info, disk_dev)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py\", line 1334, in _disconnect_volume\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return driver.disconnect_volume(connection_info, disk_dev)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/openstack/common/lockutils.py\", line 272, in inner\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     return f(*args, **kwargs)\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup   File \"/usr/lib/python2.7/site-packages/nova/virt/libvirt/volume.py\", line 1043, in disconnect_volume\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup     devices = mdev_info['devices']\n2015-02-24 17:48:01.928 32199 TRACE nova.openstack.common.threadgroup TypeError: 'NoneType' object has no attribute '__getitem__'", 
            "date_created": "2015-02-24 08:52:06.275168+00:00", 
            "author": "https://api.launchpad.net/1.0/~1-ubuntuone-0"
        }, 
        {
            "content": "Fix proposed to branch: master\nReview: https://review.openstack.org/159626", 
            "date_created": "2015-02-26 22:12:33.698585+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }, 
        {
            "content": "Reviewed:  https://review.openstack.org/159626\nCommitted: https://git.openstack.org/cgit/openstack/nova/commit/?id=144dd4f02b3ee9b79e64de830c31984f86ec3001\nSubmitter: Jenkins\nBranch:    master\n\ncommit 144dd4f02b3ee9b79e64de830c31984f86ec3001\nAuthor: Davanum Srinivas <email address hidden>\nDate:   Fri Feb 27 08:21:50 2015 -0500\n\n    Fix disconnect_volume issue when find_multipath_device returns None\n    \n    During disconnect_volume in LibvirtFibreChannelVolumeDriver there is\n    a chance that find_multipath_device behaves badly and returns None.\n    When this happens we end up with a failure as we don't check the\n    return value from find_multipath_device.\n    \n    Co-Authored-By: Melanie Witt <email address hidden>\n    Closes-Bug: #1424968\n    Change-Id: I5a5c7e26b70df237c7446efe8f99ce2304c41ab4\n", 
            "date_created": "2015-05-08 19:54:02.797376+00:00", 
            "author": "https://api.launchpad.net/1.0/~hudson-openstack"
        }
    ], 
    "closed": "2015-06-24 12:20:10.728961+00:00"
}